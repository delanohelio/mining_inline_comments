{"pr_number": 8334, "pr_title": "New panache-mock module for mocking Panache static methods", "pr_createdAt": "2020-04-01T15:15:23Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/8334", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjMwOTI5NA==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r402309294", "bodyText": "I don't see a panache-mock module in what you pushed. Is that expected?", "author": "gsmet", "createdAt": "2020-04-02T13:24:40Z", "path": "bom/runtime/pom.xml", "diffHunk": "@@ -409,6 +409,11 @@\n                 <artifactId>quarkus-panache-common</artifactId>\n                 <version>${project.version}</version>\n             </dependency>\n+            <dependency>\n+                <groupId>io.quarkus</groupId>\n+                <artifactId>quarkus-panache-mock</artifactId>", "originalCommit": "1171736a348a41736b3792d7f854cd7af3efb195", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bebf746e804899437c71533727cb4531284e3574", "url": "https://github.com/quarkusio/quarkus/commit/bebf746e804899437c71533727cb4531284e3574", "message": "New panache-mock module for mocking Panache static methods", "committedDate": "2020-04-03T09:25:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg4MzIwMA==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r402883200", "bodyText": "Maybe use a ConcurentHashMap in case tests are run in parallel ?", "author": "loicmathieu", "createdAt": "2020-04-03T09:38:37Z", "path": "extensions/panache/panache-mock/runtime/src/main/java/io/quarkus/panache/mock/PanacheMock.java", "diffHunk": "@@ -0,0 +1,81 @@\n+package io.quarkus.panache.mock;\n+\n+import java.lang.reflect.Method;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import org.mockito.Mockito;\n+import org.mockito.internal.invocation.DefaultInvocationFactory;\n+import org.mockito.internal.invocation.InterceptedInvocation;\n+import org.mockito.internal.invocation.RealMethod;\n+import org.mockito.internal.util.MockUtil;\n+import org.mockito.invocation.MockHandler;\n+import org.mockito.mock.MockCreationSettings;\n+\n+public class PanacheMock {\n+\n+    public static boolean IsMockEnabled = false;\n+\n+    private final static Map<Class<?>, Object> mocks = new HashMap<>();", "originalCommit": "bebf746e804899437c71533727cb4531284e3574", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg4NDUzOA==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r402884538", "bodyText": "That would not help: tests can't run in parallel with that setup, because the set of classes to mock and the methods mocked is test-specific. So we'd have to make this a thread-local, which would mean that reactive code would likely fail or require context propagation.", "author": "FroMage", "createdAt": "2020-04-03T09:40:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg4MzIwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg4OTc0OA==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r402889748", "bodyText": "I think it's OK for a first implementation as soon as it is clearly documented that test with panache mock should not be run in parallel.", "author": "loicmathieu", "createdAt": "2020-04-03T09:50:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg4MzIwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk4OTI1MA==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r405989250", "bodyText": "Is it possible that running user code will access this? e.g. If I mock a request then send a HTTP request will the HTTP request handler code access this map? If so it should be a CHM anyway to make sure that any modifications are visible to the other thread.", "author": "stuartwdouglas", "createdAt": "2020-04-09T06:46:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg4MzIwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODkyNzEzMw==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r408927133", "bodyText": "Fixed", "author": "FroMage", "createdAt": "2020-04-15T15:21:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg4MzIwMA=="}], "type": "inlineReview"}, {"oid": "e67615a2c2dd57cc35e8342e1c14eb02a0411053", "url": "https://github.com/quarkusio/quarkus/commit/e67615a2c2dd57cc35e8342e1c14eb02a0411053", "message": "New panache-mock module for mocking Panache static methods", "committedDate": "2020-04-06T14:19:29Z", "type": "forcePushed"}, {"oid": "674e73cb43f013567b66deac99e5a0d2a6935101", "url": "https://github.com/quarkusio/quarkus/commit/674e73cb43f013567b66deac99e5a0d2a6935101", "message": "New panache-mock module for mocking Panache static methods", "committedDate": "2020-04-06T14:40:47Z", "type": "forcePushed"}, {"oid": "e1aafb5941699b0caf6693808df32259f6fadb28", "url": "https://github.com/quarkusio/quarkus/commit/e1aafb5941699b0caf6693808df32259f6fadb28", "message": "New panache-mock module for mocking Panache static methods", "committedDate": "2020-04-07T13:18:26Z", "type": "forcePushed"}, {"oid": "f9f8e7fd477abccabb87ff0cbb237acf90a538b3", "url": "https://github.com/quarkusio/quarkus/commit/f9f8e7fd477abccabb87ff0cbb237acf90a538b3", "message": "New panache-mock module for mocking Panache static methods", "committedDate": "2020-04-08T09:40:00Z", "type": "forcePushed"}, {"oid": "c35571bf41b03c9fa328171c1207cd1a5f4f6f67", "url": "https://github.com/quarkusio/quarkus/commit/c35571bf41b03c9fa328171c1207cd1a5f4f6f67", "message": "Added panche-mock module and docs", "committedDate": "2020-04-08T14:46:33Z", "type": "forcePushed"}, {"oid": "0685cfdc28f88f5721bfe3ab5f01397277baa9a4", "url": "https://github.com/quarkusio/quarkus/commit/0685cfdc28f88f5721bfe3ab5f01397277baa9a4", "message": "Added panche-mock module and docs", "committedDate": "2020-04-08T15:09:14Z", "type": "forcePushed"}, {"oid": "bee47cb641aea00966c64861ef201857747e5eda", "url": "https://github.com/quarkusio/quarkus/commit/bee47cb641aea00966c64861ef201857747e5eda", "message": "Added panche-mock module and docs", "committedDate": "2020-04-08T15:45:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk4NzM2MA==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r405987360", "bodyText": "Double and long take up two local variable slots. Have you tested this methods methods that take double and long as params? Whenever you are doing anything with bytecode that involves primitives it is always a good idea to write explicit checks for long and double as they are a pain.", "author": "stuartwdouglas", "createdAt": "2020-04-09T06:41:45Z", "path": "extensions/panache/panache-mock/deployment/src/main/java/io/quarkus/panache/mock/deployment/PanacheMockMethodCustomizer.java", "diffHunk": "@@ -0,0 +1,123 @@\n+package io.quarkus.panache.mock.deployment;\n+\n+import org.jboss.jandex.MethodInfo;\n+import org.jboss.jandex.Type.Kind;\n+import org.objectweb.asm.Label;\n+import org.objectweb.asm.MethodVisitor;\n+import org.objectweb.asm.Opcodes;\n+import org.objectweb.asm.Type;\n+\n+import io.quarkus.panache.common.deployment.JandexUtil;\n+import io.quarkus.panache.common.deployment.PanacheMethodCustomizer;\n+import io.quarkus.panache.mock.PanacheMock;\n+\n+public class PanacheMockMethodCustomizer implements PanacheMethodCustomizer {\n+\n+    private final static String PANACHE_MOCK_BINARY_NAME = PanacheMock.class.getName().replace('.', '/');\n+    private final static String PANACHE_MOCK_INVOKE_REAL_METHOD_EXCEPTION_BINARY_NAME = PanacheMock.InvokeRealMethodException.class\n+            .getName().replace('.', '/');\n+\n+    @Override\n+    public void customize(Type entityClassSignature, MethodInfo method, MethodVisitor mv) {\n+        /*\n+         * Generated code:\n+         * \n+         * if(PanacheMock.IsMockEnabled && PanacheMock.isMocked(TestClass.class)) {\n+         * try {\n+         * return (int)PanacheMock.mockMethod(TestClass.class, \"foo\", new Class<?>[] {int.class}, new Object[] {arg});\n+         * } catch (PanacheMock.InvokeRealMethodException e) {\n+         * // fall-through\n+         * }\n+         * }\n+         * \n+         * Bytecode approx:\n+         * \n+         * 0: getstatic #16 // Field PanacheMock.IsMockEnabled:Z\n+         * 3: ifeq 50\n+         * 6: ldc #1 // class MyTestMockito$TestClass\n+         * 8: invokestatic #22 // Method PanacheMock.isMocked:(Ljava/lang/Class;)Z\n+         * 11: ifeq 50\n+         * 14: ldc #1 // class MyTestMockito$TestClass\n+         * 16: ldc #26 // String foo\n+         * \n+         * 18: iconst_1\n+         * 19: anewarray #27 // class java/lang/Class\n+         * 22: dup\n+         * 23: iconst_0\n+         * 24: getstatic #29 // Field java/lang/Integer.TYPE:Ljava/lang/Class;\n+         * 27: aastore\n+         *\n+         * 28: iconst_1\n+         * 29: anewarray #3 // class java/lang/Object\n+         * 32: dup\n+         * 33: iconst_0\n+         * 34: iload_0\n+         * 35: invokestatic #35 // Method java/lang/Integer.valueOf:(I)Ljava/lang/Integer;\n+         * 38: aastore\n+         * \n+         * 39: invokestatic #39 // Method\n+         * PanacheMock.mockMethod:(Ljava/lang/Class;Ljava/lang/String;[Ljava/lang/Class;[Ljava/lang/Object;)Ljava/lang/Object;\n+         * 42: checkcast #30 // class java/lang/Integer\n+         * 45: invokevirtual #43 // Method java/lang/Integer.intValue:()I\n+         * 48: ireturn\n+         * 49: astore_1\n+         */\n+        Label realMethodLabel = new Label();\n+\n+        mv.visitFieldInsn(Opcodes.GETSTATIC, PANACHE_MOCK_BINARY_NAME, \"IsMockEnabled\", \"Z\");\n+        mv.visitJumpInsn(Opcodes.IFEQ, realMethodLabel);\n+\n+        mv.visitLdcInsn(entityClassSignature);\n+        mv.visitMethodInsn(Opcodes.INVOKESTATIC, PANACHE_MOCK_BINARY_NAME, \"isMocked\", \"(Ljava/lang/Class;)Z\", false);\n+        mv.visitJumpInsn(Opcodes.IFEQ, realMethodLabel);\n+\n+        Label tryStart = new Label();\n+        Label tryEnd = new Label();\n+        Label tryHandler = new Label();\n+        mv.visitTryCatchBlock(tryStart, tryEnd, tryHandler, PANACHE_MOCK_INVOKE_REAL_METHOD_EXCEPTION_BINARY_NAME);\n+        mv.visitLabel(tryStart);\n+\n+        mv.visitLdcInsn(entityClassSignature);\n+        mv.visitLdcInsn(method.name());\n+\n+        mv.visitLdcInsn(method.parameters().size());\n+        mv.visitTypeInsn(Opcodes.ANEWARRAY, \"java/lang/Class\");\n+\n+        int i = 0;\n+        for (org.jboss.jandex.Type paramType : method.parameters()) {\n+            mv.visitInsn(Opcodes.DUP);\n+            mv.visitLdcInsn(i);\n+            JandexUtil.visitLdc(mv, paramType);\n+            mv.visitInsn(Opcodes.AASTORE);\n+            i++;\n+        }\n+\n+        mv.visitLdcInsn(method.parameters().size());\n+        mv.visitTypeInsn(Opcodes.ANEWARRAY, \"java/lang/Object\");\n+\n+        i = 0;\n+        for (org.jboss.jandex.Type paramType : method.parameters()) {\n+            mv.visitInsn(Opcodes.DUP);\n+            mv.visitLdcInsn(i);", "originalCommit": "bee47cb641aea00966c64861ef201857747e5eda", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjczMzQ2OQ==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r406733469", "bodyText": "So, we don't have any method in the superclasses in question that we generate bridges for (PanacheEntityBase and PanacheRepositoryBase) so it doesn't happen. And I can't test this by adding a method to these classes, and no other classes have bridge methods generated.\nSo in general, sure, but I couldn't test this if I supported it. I could add a guard to make sure we never add such methods.", "author": "FroMage", "createdAt": "2020-04-10T12:21:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk4NzM2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc3OTAwMw==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r406779003", "bodyText": "You were right, I've implemented and tested it.", "author": "FroMage", "createdAt": "2020-04-10T14:20:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk4NzM2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk5MDMzNg==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r405990336", "bodyText": "Can you add some tests with multiple long/double method parameters? It should show up the issue I brought up above. These tests don't show it because there is only a single parameter.", "author": "stuartwdouglas", "createdAt": "2020-04-09T06:49:21Z", "path": "integration-tests/hibernate-orm-panache/src/test/java/io/quarkus/it/panache/PanacheMockingTest.java", "diffHunk": "@@ -0,0 +1,134 @@\n+package io.quarkus.it.panache;\n+\n+import java.util.Collections;\n+import java.util.Optional;\n+\n+import javax.inject.Inject;\n+import javax.persistence.LockModeType;\n+import javax.ws.rs.WebApplicationException;\n+\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.Order;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.Mockito;\n+\n+import io.quarkus.hibernate.orm.panache.PanacheRepositoryBase;\n+import io.quarkus.panache.mock.PanacheMock;\n+import io.quarkus.test.junit.QuarkusTest;\n+import io.quarkus.test.junit.mockito.InjectMock;\n+\n+@QuarkusTest\n+public class PanacheMockingTest {\n+\n+    @Test\n+    @Order(1)\n+    public void testPanacheMocking() {\n+        PanacheMock.mock(Person.class);\n+\n+        Assertions.assertEquals(0, Person.count());\n+\n+        Mockito.when(Person.count()).thenReturn(23l);\n+        Assertions.assertEquals(23, Person.count());\n+\n+        Mockito.when(Person.count()).thenReturn(42l);\n+        Assertions.assertEquals(42, Person.count());\n+\n+        Mockito.when(Person.count()).thenCallRealMethod();\n+        Assertions.assertEquals(0, Person.count());\n+\n+        PanacheMock.verify(Person.class, Mockito.times(4)).count();\n+\n+        Person p = new Person();\n+        Mockito.when(Person.findById(12l)).thenReturn(p);", "originalCommit": "bee47cb641aea00966c64861ef201857747e5eda", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjczNDU5OA==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r406734598", "bodyText": "I can't, see above.", "author": "FroMage", "createdAt": "2020-04-10T12:24:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk5MDMzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjczNTY0Ng==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r406735646", "bodyText": "Actually I can make user methods do this. Sorry.", "author": "FroMage", "createdAt": "2020-04-10T12:27:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk5MDMzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk5MzAwMA==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r405993000", "bodyText": "I don't really understand the context here, but are you sure there will never be primitive params?", "author": "stuartwdouglas", "createdAt": "2020-04-09T06:55:34Z", "path": "extensions/panache/panache-common/deployment/src/main/java/io/quarkus/panache/common/deployment/PanacheRepositoryEnhancer.java", "diffHunk": "@@ -101,26 +117,102 @@ private String recursivelyFindEntityTypeFromClass(DotName clazz, DotName reposit\n                 throw new IllegalStateException(\n                         \"Failed to find supertype \" + repositoryDotName + \" from entity class \" + clazz);\n             org.jboss.jandex.Type entityType = typeParameters.get(0);\n-            return entityType.name().toString().replace('.', '/');\n+            org.jboss.jandex.Type idType = typeParameters.get(1);\n+            return new String[] {\n+                    entityType.name().toString().replace('.', '/'),\n+                    idType.name().toString().replace('.', '/')\n+            };\n         }\n \n         @Override\n         public void visitEnd() {\n             for (MethodInfo method : panacheRepositoryBaseClassInfo.methods()) {\n                 // Do not generate a method that already exists\n-                if (!JandexUtil.containsMethod(daoClassInfo, method)) {\n+                String descriptor = JandexUtil.getDescriptor(method, name -> typeArguments.get(name));\n+                if (!userMethods.contains(method.name() + \"/\" + descriptor)) {\n                     AnnotationInstance bridge = method.annotation(JandexUtil.DOTNAME_GENERATE_BRIDGE);\n                     if (bridge != null) {\n-                        generateMethod(method, bridge.value(\"targetReturnTypeErased\"));\n+                        generateModelBridge(method, bridge.value(\"targetReturnTypeErased\"));\n+                        if (needsJvmBridge(method)) {\n+                            generateJvmBridge(method);\n+                        }\n                     }\n                 }\n             }\n             super.visitEnd();\n         }\n \n-        private void generateMethod(MethodInfo method, AnnotationValue targetReturnTypeErased) {\n-            String descriptor = JandexUtil.getDescriptor(method, name -> name.equals(\"Entity\") ? entitySignature : null);\n-            String signature = JandexUtil.getSignature(method, name -> name.equals(\"Entity\") ? entitySignature : null);\n+        private boolean needsJvmBridge(MethodInfo method) {\n+            if (needsJvmBridge(method.returnType()))\n+                return true;\n+            for (org.jboss.jandex.Type paramType : method.parameters()) {\n+                if (needsJvmBridge(paramType))\n+                    return true;\n+            }\n+            return false;\n+        }\n+\n+        private boolean needsJvmBridge(org.jboss.jandex.Type type) {\n+            if (type.kind() == Kind.TYPE_VARIABLE) {\n+                String typeParamName = type.asTypeVariable().identifier();\n+                return typeArguments.containsKey(typeParamName);\n+            }\n+            return false;\n+        }\n+\n+        private void generateJvmBridge(MethodInfo method) {\n+            // get a bounds-erased descriptor\n+            String descriptor = JandexUtil.getDescriptor(method, name -> null);\n+            // make sure we need a bridge\n+            if (!userMethods.contains(method.name() + \"/\" + descriptor)) {\n+                MethodVisitor mv = super.visitMethod(Opcodes.ACC_PUBLIC | Opcodes.ACC_SYNTHETIC | Opcodes.ACC_BRIDGE,\n+                        method.name(),\n+                        descriptor,\n+                        null,\n+                        null);\n+                List<org.jboss.jandex.Type> parameters = method.parameters();\n+                for (int i = 0; i < parameters.size(); i++) {\n+                    mv.visitParameter(method.parameterName(i), 0 /* modifiers */);\n+                }\n+                mv.visitCode();\n+                // this\n+                mv.visitIntInsn(Opcodes.ALOAD, 0);\n+                // each param\n+                for (int i = 0; i < parameters.size(); i++) {\n+                    org.jboss.jandex.Type paramType = parameters.get(i);\n+                    mv.visitIntInsn(Opcodes.ALOAD, i + 1);", "originalCommit": "bee47cb641aea00966c64861ef201857747e5eda", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc3ODY3Mw==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r406778673", "bodyText": "ATM there are none. I've added a check if it ever happens.", "author": "FroMage", "createdAt": "2020-04-10T14:20:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk5MzAwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk5NTg4Nw==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r405995887", "bodyText": "I wonder if we could / should ditch the full blown extension approach here, and just introduce a test module that utilizes the TestBuildChainCustomizerProducer we are introducing in #8491", "author": "geoand", "createdAt": "2020-04-09T07:02:13Z", "path": "extensions/panache/panache-mock/deployment/src/main/java/io/quarkus/panache/mock/deployment/PanacheMockResourceProcessor.java", "diffHunk": "@@ -0,0 +1,17 @@\n+package io.quarkus.panache.mock.deployment;\n+\n+import io.quarkus.deployment.annotations.BuildProducer;\n+import io.quarkus.deployment.annotations.BuildStep;\n+import io.quarkus.deployment.builditem.LaunchModeBuildItem;\n+import io.quarkus.panache.common.deployment.PanacheMethodCustomizerBuildItem;\n+import io.quarkus.runtime.LaunchMode;\n+\n+public final class PanacheMockResourceProcessor {", "originalCommit": "bee47cb641aea00966c64861ef201857747e5eda", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc3ODUwMA==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r406778500", "bodyText": "Good idea, done.", "author": "FroMage", "createdAt": "2020-04-10T14:19:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk5NTg4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODkzMTc4NA==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r408931784", "bodyText": "Excellent", "author": "geoand", "createdAt": "2020-04-15T15:27:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk5NTg4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAwNjU4Mw==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r406006583", "bodyText": "The documentation now refers to it as the \"active record pattern\". And I didn't put quote in it so if you want your quote please update the other titles ;)", "author": "loicmathieu", "createdAt": "2020-04-09T07:25:22Z", "path": "docs/src/main/asciidoc/hibernate-orm-panache.adoc", "diffHunk": "@@ -661,6 +661,169 @@ public class PersonRepository implements PanacheRepositoryBase<Person,Integer> {\n }\n ----\n \n+== Mocking\n+\n+=== Using the \u201centity pattern\u201d", "originalCommit": "bee47cb641aea00966c64861ef201857747e5eda", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc3Mjg4Mw==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r406772883", "bodyText": "Grr, I much prefer \"entity pattern\" over \"active record pattern\" because those are not active records.", "author": "FroMage", "createdAt": "2020-04-10T14:06:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAwNjU4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAwNjkyNw==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r406006927", "bodyText": "We usually include the imports inside the doc.", "author": "loicmathieu", "createdAt": "2020-04-09T07:26:07Z", "path": "docs/src/main/asciidoc/hibernate-orm-panache.adoc", "diffHunk": "@@ -661,6 +661,169 @@ public class PersonRepository implements PanacheRepositoryBase<Person,Integer> {\n }\n ----\n \n+== Mocking\n+\n+=== Using the \u201centity pattern\u201d\n+\n+If you are using the \u201centity pattern\u201d you cannot use Mockito directly as it does not support mocking static methods,\n+but you can use the `quarkus-panache-mock` module which allows you to use Mockito to mock all provided static\n+methods, including your own.\n+\n+Given this simple entity:\n+\n+[source,java]\n+----\n+@Entity\n+public class Person extends PanacheEntity {\n+\n+    public String name;\n+\n+    public static List<Person> findOrdered() {\n+        return find(\"ORDER BY name\").list();\n+    }\n+}\n+----\n+\n+You can write your mocking test like this:\n+\n+[source,java]\n+----\n+@QuarkusTest", "originalCommit": "bee47cb641aea00966c64861ef201857747e5eda", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc3MjY1NA==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r406772654", "bodyText": "We don't in any other example in this guide.", "author": "FroMage", "createdAt": "2020-04-10T14:06:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAwNjkyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzM1MjI4OQ==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r407352289", "bodyText": "Yes, but other guides do.\nAnd I was advised to always include the imports inside the guide.\nAnd here it is helpful to see what comes from Mockito and what comes from PanacheMock", "author": "loicmathieu", "createdAt": "2020-04-13T07:14:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAwNjkyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAwNzQ5NA==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r406007494", "bodyText": "Maybe add a not that explain that Mockito.verify() will not works and all verification must be done via PanacheMock.", "author": "loicmathieu", "createdAt": "2020-04-09T07:27:15Z", "path": "docs/src/main/asciidoc/hibernate-orm-panache.adoc", "diffHunk": "@@ -661,6 +661,169 @@ public class PersonRepository implements PanacheRepositoryBase<Person,Integer> {\n }\n ----\n \n+== Mocking\n+\n+=== Using the \u201centity pattern\u201d\n+\n+If you are using the \u201centity pattern\u201d you cannot use Mockito directly as it does not support mocking static methods,\n+but you can use the `quarkus-panache-mock` module which allows you to use Mockito to mock all provided static\n+methods, including your own.\n+\n+Given this simple entity:\n+\n+[source,java]\n+----\n+@Entity\n+public class Person extends PanacheEntity {\n+\n+    public String name;\n+\n+    public static List<Person> findOrdered() {\n+        return find(\"ORDER BY name\").list();\n+    }\n+}\n+----\n+\n+You can write your mocking test like this:\n+\n+[source,java]\n+----\n+@QuarkusTest\n+public class PanacheFunctionalityTest {\n+\n+    @Test\n+    public void testPanacheMocking() {\n+        PanacheMock.mock(Person.class);\n+\n+        // Mocked classes always return a default value\n+        Assertions.assertEquals(0, Person.count());\n+\n+        // Now let's specify the return value\n+        Mockito.when(Person.count()).thenReturn(23l);\n+        Assertions.assertEquals(23, Person.count());\n+\n+        // Now let's change the return value\n+        Mockito.when(Person.count()).thenReturn(42l);\n+        Assertions.assertEquals(42, Person.count());\n+\n+        // Now let's call the original method\n+        Mockito.when(Person.count()).thenCallRealMethod();\n+        Assertions.assertEquals(0, Person.count());\n+\n+        // Check that we called it 4 times\n+        PanacheMock.verify(Person.class, Mockito.times(4)).count();", "originalCommit": "bee47cb641aea00966c64861ef201857747e5eda", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc3NDI1OA==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r406774258", "bodyText": "ok", "author": "FroMage", "createdAt": "2020-04-10T14:10:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAwNzQ5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAwNzkxMg==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r406007912", "bodyText": "Is using quarkus-junit5-mockito mandatory ?\nIf so, maybe explain why in a few words.", "author": "loicmathieu", "createdAt": "2020-04-09T07:28:05Z", "path": "docs/src/main/asciidoc/hibernate-orm-panache.adoc", "diffHunk": "@@ -661,6 +661,169 @@ public class PersonRepository implements PanacheRepositoryBase<Person,Integer> {\n }\n ----\n \n+== Mocking\n+\n+=== Using the \u201centity pattern\u201d\n+\n+If you are using the \u201centity pattern\u201d you cannot use Mockito directly as it does not support mocking static methods,\n+but you can use the `quarkus-panache-mock` module which allows you to use Mockito to mock all provided static\n+methods, including your own.\n+\n+Given this simple entity:\n+\n+[source,java]\n+----\n+@Entity\n+public class Person extends PanacheEntity {\n+\n+    public String name;\n+\n+    public static List<Person> findOrdered() {\n+        return find(\"ORDER BY name\").list();\n+    }\n+}\n+----\n+\n+You can write your mocking test like this:\n+\n+[source,java]\n+----\n+@QuarkusTest\n+public class PanacheFunctionalityTest {\n+\n+    @Test\n+    public void testPanacheMocking() {\n+        PanacheMock.mock(Person.class);\n+\n+        // Mocked classes always return a default value\n+        Assertions.assertEquals(0, Person.count());\n+\n+        // Now let's specify the return value\n+        Mockito.when(Person.count()).thenReturn(23l);\n+        Assertions.assertEquals(23, Person.count());\n+\n+        // Now let's change the return value\n+        Mockito.when(Person.count()).thenReturn(42l);\n+        Assertions.assertEquals(42, Person.count());\n+\n+        // Now let's call the original method\n+        Mockito.when(Person.count()).thenCallRealMethod();\n+        Assertions.assertEquals(0, Person.count());\n+\n+        // Check that we called it 4 times\n+        PanacheMock.verify(Person.class, Mockito.times(4)).count();\n+\n+        // Mock only with specific parameters\n+        Person p = new Person();\n+        Mockito.when(Person.findById(12l)).thenReturn(p);\n+        Assertions.assertSame(p, Person.findById(12l));\n+        Assertions.assertNull(Person.findById(42l));\n+\n+        // Mock throwing\n+        Mockito.when(Person.findById(12l)).thenThrow(new WebApplicationException());\n+        try {\n+            Person.findById(12l);\n+            Assertions.fail();\n+        } catch (WebApplicationException x) {\n+        }\n+\n+        // We can even mock your custom methods\n+        Mockito.when(Person.findOrdered()).thenReturn(Collections.emptyList());\n+        Assertions.assertTrue(Person.findOrdered().isEmpty());\n+\n+        PanacheMock.verify(Person.class).findOrdered();\n+        PanacheMock.verify(Person.class, Mockito.atLeastOnce()).findById(Mockito.any());\n+        PanacheMock.verifyNoMoreInteractions(Person.class);\n+    }\n+}\n+----\n+\n+=== Using the \u201crepository pattern\u201d\n+\n+If you are using the \u201crepository pattern\u201d you can use Mockito directly, using the `quarkus-junit5-mockito` module.", "originalCommit": "bee47cb641aea00966c64861ef201857747e5eda", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAwODY0Mg==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r406008642", "bodyText": "And add the pom.xml snippet.", "author": "loicmathieu", "createdAt": "2020-04-09T07:29:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAwNzkxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc3NTE2Nw==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r406775167", "bodyText": "ok", "author": "FroMage", "createdAt": "2020-04-10T14:12:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAwNzkxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAwODQzMg==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r406008432", "bodyText": "Maybe add the needed pom.xml lines.", "author": "loicmathieu", "createdAt": "2020-04-09T07:29:06Z", "path": "docs/src/main/asciidoc/hibernate-orm-panache.adoc", "diffHunk": "@@ -661,6 +661,169 @@ public class PersonRepository implements PanacheRepositoryBase<Person,Integer> {\n }\n ----\n \n+== Mocking\n+\n+=== Using the \u201centity pattern\u201d\n+\n+If you are using the \u201centity pattern\u201d you cannot use Mockito directly as it does not support mocking static methods,\n+but you can use the `quarkus-panache-mock` module which allows you to use Mockito to mock all provided static\n+methods, including your own.\n+", "originalCommit": "bee47cb641aea00966c64861ef201857747e5eda", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc3NTI3Nw==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r406775277", "bodyText": "ok", "author": "FroMage", "createdAt": "2020-04-10T14:12:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAwODQzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAwOTI4NQ==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r406009285", "bodyText": "We usually include the imports inside the doc.", "author": "loicmathieu", "createdAt": "2020-04-09T07:30:50Z", "path": "docs/src/main/asciidoc/hibernate-orm-panache.adoc", "diffHunk": "@@ -661,6 +661,169 @@ public class PersonRepository implements PanacheRepositoryBase<Person,Integer> {\n }\n ----\n \n+== Mocking\n+\n+=== Using the \u201centity pattern\u201d\n+\n+If you are using the \u201centity pattern\u201d you cannot use Mockito directly as it does not support mocking static methods,\n+but you can use the `quarkus-panache-mock` module which allows you to use Mockito to mock all provided static\n+methods, including your own.\n+\n+Given this simple entity:\n+\n+[source,java]\n+----\n+@Entity\n+public class Person extends PanacheEntity {\n+\n+    public String name;\n+\n+    public static List<Person> findOrdered() {\n+        return find(\"ORDER BY name\").list();\n+    }\n+}\n+----\n+\n+You can write your mocking test like this:\n+\n+[source,java]\n+----\n+@QuarkusTest\n+public class PanacheFunctionalityTest {\n+\n+    @Test\n+    public void testPanacheMocking() {\n+        PanacheMock.mock(Person.class);\n+\n+        // Mocked classes always return a default value\n+        Assertions.assertEquals(0, Person.count());\n+\n+        // Now let's specify the return value\n+        Mockito.when(Person.count()).thenReturn(23l);\n+        Assertions.assertEquals(23, Person.count());\n+\n+        // Now let's change the return value\n+        Mockito.when(Person.count()).thenReturn(42l);\n+        Assertions.assertEquals(42, Person.count());\n+\n+        // Now let's call the original method\n+        Mockito.when(Person.count()).thenCallRealMethod();\n+        Assertions.assertEquals(0, Person.count());\n+\n+        // Check that we called it 4 times\n+        PanacheMock.verify(Person.class, Mockito.times(4)).count();\n+\n+        // Mock only with specific parameters\n+        Person p = new Person();\n+        Mockito.when(Person.findById(12l)).thenReturn(p);\n+        Assertions.assertSame(p, Person.findById(12l));\n+        Assertions.assertNull(Person.findById(42l));\n+\n+        // Mock throwing\n+        Mockito.when(Person.findById(12l)).thenThrow(new WebApplicationException());\n+        try {\n+            Person.findById(12l);\n+            Assertions.fail();\n+        } catch (WebApplicationException x) {\n+        }\n+\n+        // We can even mock your custom methods\n+        Mockito.when(Person.findOrdered()).thenReturn(Collections.emptyList());\n+        Assertions.assertTrue(Person.findOrdered().isEmpty());\n+\n+        PanacheMock.verify(Person.class).findOrdered();\n+        PanacheMock.verify(Person.class, Mockito.atLeastOnce()).findById(Mockito.any());\n+        PanacheMock.verifyNoMoreInteractions(Person.class);\n+    }\n+}\n+----\n+\n+=== Using the \u201crepository pattern\u201d\n+\n+If you are using the \u201crepository pattern\u201d you can use Mockito directly, using the `quarkus-junit5-mockito` module.\n+\n+Given this simple entity:\n+\n+[source,java]\n+----\n+@Entity\n+public class Person {\n+\n+    @Id\n+    @GeneratedValue\n+    public Long id;\n+\n+    public String name;\n+}\n+----\n+\n+And this repository:\n+\n+[source,java]\n+----\n+@ApplicationScoped\n+public class PersonRepository implements PanacheRepository<Person> {\n+    public List<Person> findOrdered() {\n+        return find(\"ORDER BY name\").list();\n+    }\n+}\n+----\n+\n+You can write your mocking test like this:\n+\n+[source,java]\n+----\n+@QuarkusTest", "originalCommit": "bee47cb641aea00966c64861ef201857747e5eda", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAwOTc2Mw==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r406009763", "bodyText": "This one is not disabled on native but the repository variant is ?\nAs injection didn't works in native mode you should add a note that explain it", "author": "loicmathieu", "createdAt": "2020-04-09T07:31:54Z", "path": "docs/src/main/asciidoc/hibernate-orm-panache.adoc", "diffHunk": "@@ -661,6 +661,169 @@ public class PersonRepository implements PanacheRepositoryBase<Person,Integer> {\n }\n ----\n \n+== Mocking\n+\n+=== Using the \u201centity pattern\u201d\n+\n+If you are using the \u201centity pattern\u201d you cannot use Mockito directly as it does not support mocking static methods,\n+but you can use the `quarkus-panache-mock` module which allows you to use Mockito to mock all provided static\n+methods, including your own.\n+\n+Given this simple entity:\n+\n+[source,java]\n+----\n+@Entity\n+public class Person extends PanacheEntity {\n+\n+    public String name;\n+\n+    public static List<Person> findOrdered() {\n+        return find(\"ORDER BY name\").list();\n+    }\n+}\n+----\n+\n+You can write your mocking test like this:\n+\n+[source,java]\n+----\n+@QuarkusTest\n+public class PanacheFunctionalityTest {\n+\n+    @Test", "originalCommit": "bee47cb641aea00966c64861ef201857747e5eda", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc3NTY0Mg==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r406775642", "bodyText": "this is not a native test, I've removed that annotation", "author": "FroMage", "createdAt": "2020-04-10T14:13:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAwOTc2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAxMDQ4OQ==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r406010489", "bodyText": "I usually use this construct that is clearer :\nassertThrows(WebApplicationException.class, () -> Person.findById(12l));", "author": "loicmathieu", "createdAt": "2020-04-09T07:33:28Z", "path": "docs/src/main/asciidoc/hibernate-orm-panache.adoc", "diffHunk": "@@ -661,6 +661,169 @@ public class PersonRepository implements PanacheRepositoryBase<Person,Integer> {\n }\n ----\n \n+== Mocking\n+\n+=== Using the \u201centity pattern\u201d\n+\n+If you are using the \u201centity pattern\u201d you cannot use Mockito directly as it does not support mocking static methods,\n+but you can use the `quarkus-panache-mock` module which allows you to use Mockito to mock all provided static\n+methods, including your own.\n+\n+Given this simple entity:\n+\n+[source,java]\n+----\n+@Entity\n+public class Person extends PanacheEntity {\n+\n+    public String name;\n+\n+    public static List<Person> findOrdered() {\n+        return find(\"ORDER BY name\").list();\n+    }\n+}\n+----\n+\n+You can write your mocking test like this:\n+\n+[source,java]\n+----\n+@QuarkusTest\n+public class PanacheFunctionalityTest {\n+\n+    @Test\n+    public void testPanacheMocking() {\n+        PanacheMock.mock(Person.class);\n+\n+        // Mocked classes always return a default value\n+        Assertions.assertEquals(0, Person.count());\n+\n+        // Now let's specify the return value\n+        Mockito.when(Person.count()).thenReturn(23l);\n+        Assertions.assertEquals(23, Person.count());\n+\n+        // Now let's change the return value\n+        Mockito.when(Person.count()).thenReturn(42l);\n+        Assertions.assertEquals(42, Person.count());\n+\n+        // Now let's call the original method\n+        Mockito.when(Person.count()).thenCallRealMethod();\n+        Assertions.assertEquals(0, Person.count());\n+\n+        // Check that we called it 4 times\n+        PanacheMock.verify(Person.class, Mockito.times(4)).count();\n+\n+        // Mock only with specific parameters\n+        Person p = new Person();\n+        Mockito.when(Person.findById(12l)).thenReturn(p);\n+        Assertions.assertSame(p, Person.findById(12l));\n+        Assertions.assertNull(Person.findById(42l));\n+\n+        // Mock throwing\n+        Mockito.when(Person.findById(12l)).thenThrow(new WebApplicationException());\n+        try {\n+            Person.findById(12l);\n+            Assertions.fail();\n+        } catch (WebApplicationException x) {\n+        }", "originalCommit": "bee47cb641aea00966c64861ef201857747e5eda", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc3NjA3Ng==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r406776076", "bodyText": "good point.", "author": "FroMage", "createdAt": "2020-04-10T14:14:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAxMDQ4OQ=="}], "type": "inlineReview"}, {"oid": "3e1a9b4cc44c2bd010fcce20aa8faa2e653f6eb6", "url": "https://github.com/quarkusio/quarkus/commit/3e1a9b4cc44c2bd010fcce20aa8faa2e653f6eb6", "message": "Added panche-mock module and docs", "committedDate": "2020-04-10T14:18:34Z", "type": "forcePushed"}, {"oid": "ccbb69eab1b1822b76c4e399c839fdbdda23a860", "url": "https://github.com/quarkusio/quarkus/commit/ccbb69eab1b1822b76c4e399c839fdbdda23a860", "message": "Added panche-mock module and docs", "committedDate": "2020-04-10T14:40:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzM1MjUzNQ==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r407352535", "bodyText": "Sorry, I missed this one:\nentity pattern -> active record pattern", "author": "loicmathieu", "createdAt": "2020-04-13T07:15:02Z", "path": "docs/src/main/asciidoc/getting-started-testing.adoc", "diffHunk": "@@ -525,6 +525,10 @@ public class MockGreetingServiceTest {\n ----\n <1> Since we configured `greetingService` as a mock, the `GreetingResource` which uses the `GreetingService` bean, we get the mocked response instead of the response of the regular `GreetingService` bean\n \n+=== Mocking with Panache\n+\n+If you are using the `quarkus-hibernate-orm-panache` or `quarkus-mongodb-panache` extensions with the \u201centity pattern\u201d you can use the `quarkus-panache-mock` extension as documented in the link:hibernate-orm-panache#mocking[Hibernate ORM with Panache Mocking] and link:mongodb-panache#mocking[MongoDB with Panache Mocking] documentation.", "originalCommit": "ccbb69eab1b1822b76c4e399c839fdbdda23a860", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzM1Mjg5OA==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r407352898", "bodyText": "Should be [source,xml]", "author": "loicmathieu", "createdAt": "2020-04-13T07:16:07Z", "path": "docs/src/main/asciidoc/hibernate-orm-panache.adoc", "diffHunk": "@@ -686,6 +686,184 @@ public class PersonRepository implements PanacheRepositoryBase<Person,Integer> {\n }\n ----\n \n+== Mocking\n+\n+=== Using the active record pattern\n+\n+If you are using the active record pattern you cannot use Mockito directly as it does not support mocking static methods,\n+but you can use the `quarkus-panache-mock` module which allows you to use Mockito to mock all provided static\n+methods, including your own.\n+\n+Add this dependency to your `pom.xml`:\n+\n+[source,java]", "originalCommit": "ccbb69eab1b1822b76c4e399c839fdbdda23a860", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzM1MzIyNA==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r407353224", "bodyText": "Should be [source,xml]", "author": "loicmathieu", "createdAt": "2020-04-13T07:17:13Z", "path": "docs/src/main/asciidoc/mongodb-panache.adoc", "diffHunk": "@@ -867,6 +867,181 @@ public Multi<ReactivePerson> streamPersons() {\n \n TIP: `@SseElementType(MediaType.APPLICATION_JSON)` tells RESTEasy to serialize the object in JSON.\n \n+== Mocking\n+\n+=== Using the active-record pattern\n+\n+If you are using the active-record pattern you cannot use Mockito directly as it does not support mocking static methods,\n+but you can use the `quarkus-panache-mock` module which allows you to use Mockito to mock all provided static\n+methods, including your own.\n+\n+Add this dependency to your `pom.xml`:\n+\n+[source,java]", "originalCommit": "ccbb69eab1b1822b76c4e399c839fdbdda23a860", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7c66ef94703c3b8d203997404dd0b2ca6fbd14b7", "url": "https://github.com/quarkusio/quarkus/commit/7c66ef94703c3b8d203997404dd0b2ca6fbd14b7", "message": "Added panche-mock module and docs", "committedDate": "2020-04-15T15:22:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODkzMzE4MA==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r408933180", "bodyText": "This probably need to be updated :)", "author": "geoand", "createdAt": "2020-04-15T15:28:56Z", "path": "extensions/panache/panache-mock/pom.xml", "diffHunk": "@@ -0,0 +1,37 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+    xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <parent>\n+        <artifactId>quarkus-build-parent</artifactId>\n+        <groupId>io.quarkus</groupId>\n+        <version>999-SNAPSHOT</version>\n+        <relativePath>../../../build-parent/pom.xml</relativePath>\n+    </parent>\n+    <modelVersion>4.0.0</modelVersion>\n+\n+    <artifactId>quarkus-panache-mock</artifactId>\n+    <name>Quarkus - Panache - Mock - Runtime</name>\n+    <description>An opinionated approach to make Hibernate as easy as possible</description>", "originalCommit": "7c66ef94703c3b8d203997404dd0b2ca6fbd14b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTUxNzUyOA==", "url": "https://github.com/quarkusio/quarkus/pull/8334#discussion_r409517528", "bodyText": "Good point, fixed, thanks!", "author": "FroMage", "createdAt": "2020-04-16T12:31:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODkzMzE4MA=="}], "type": "inlineReview"}, {"oid": "01e64dad7aa87f02a46b0f57ce08c3f5af4cd9fb", "url": "https://github.com/quarkusio/quarkus/commit/01e64dad7aa87f02a46b0f57ce08c3f5af4cd9fb", "message": "Added panche-mock module and docs", "committedDate": "2020-04-16T12:31:04Z", "type": "forcePushed"}, {"oid": "ff96dbf502562c024c1e8d741efa32bc1588fe2d", "url": "https://github.com/quarkusio/quarkus/commit/ff96dbf502562c024c1e8d741efa32bc1588fe2d", "message": "Added panche-mock module and docs", "committedDate": "2020-04-17T13:19:08Z", "type": "forcePushed"}, {"oid": "5cd37f67c2e3fa5e1094a6d0c22194bfff1dc084", "url": "https://github.com/quarkusio/quarkus/commit/5cd37f67c2e3fa5e1094a6d0c22194bfff1dc084", "message": "Panache ORM/Mongo: fixed bridge generation\n\nNow it's all automated, no more forgetting methods to bridge", "committedDate": "2020-04-20T08:47:06Z", "type": "commit"}, {"oid": "3a5680ea367c5dad60655dcef0ca9765f14d5efe", "url": "https://github.com/quarkusio/quarkus/commit/3a5680ea367c5dad60655dcef0ca9765f14d5efe", "message": "Added panche-mock module and docs", "committedDate": "2020-04-20T08:47:06Z", "type": "commit"}, {"oid": "3a5680ea367c5dad60655dcef0ca9765f14d5efe", "url": "https://github.com/quarkusio/quarkus/commit/3a5680ea367c5dad60655dcef0ca9765f14d5efe", "message": "Added panche-mock module and docs", "committedDate": "2020-04-20T08:47:06Z", "type": "forcePushed"}]}