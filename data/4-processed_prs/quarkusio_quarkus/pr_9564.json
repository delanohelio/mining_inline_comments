{"pr_number": 9564, "pr_title": "Add documentation for Spring Cache extension", "pr_createdAt": "2020-05-25T06:29:18Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/9564", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTgzNjUyMA==", "url": "https://github.com/quarkusio/quarkus/pull/9564#discussion_r429836520", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            This command generates a Maven project with a REST endpoint and imports the `spring-cache` and `spring-di` extension.\n          \n          \n            \n            This command generates a Maven project with a REST endpoint and imports the `spring-cache` and `spring-di` extensions.", "author": "gsmet", "createdAt": "2020-05-25T09:34:13Z", "path": "docs/src/main/asciidoc/spring-cache.adoc", "diffHunk": "@@ -0,0 +1,281 @@\n+////\n+This guide is maintained in the main Quarkus repository\n+and pull requests should be submitted there:\n+https://github.com/quarkusio/quarkus/tree/master/docs/src/main/asciidoc\n+////\n+= Quarkus - Quarkus Extension for Spring Cache API\n+\n+include::./attributes.adoc[]\n+:extension-status: preview\n+\n+While users are encouraged to use link:cache[Quarkus annotations for caching], Quarkus nevertheless provides a compatibility layer for Spring Cache annotations in the form of the `spring-cache` extension.\n+\n+This guide explains how a Quarkus application can leverage the well known Spring Cache annotations to enable application data caching for their Spring beans.\n+\n+include::./status-include.adoc[]\n+\n+== Prerequisites\n+\n+To complete this guide, you need:\n+\n+* less than 15 minutes\n+* an IDE\n+* JDK 1.8+ installed with `JAVA_HOME` configured appropriately\n+* Apache Maven {maven-version}\n+* Some familiarity with the Spring DI extension\n+\n+\n+== Creating the Maven project\n+\n+First, we need a new project. Create a new project with the following command:\n+\n+[source,shell,subs=attributes+]\n+----\n+mvn io.quarkus:quarkus-maven-plugin:{quarkus-version}:create \\\n+    -DprojectGroupId=org.acme \\\n+    -DprojectArtifactId=spring-cache-quickstart \\\n+    -DclassName=\"org.acme.spring.cache.GreeterResource\" \\\n+    -Dpath=\"/greeting\" \\\n+    -Dextensions=\"spring-di,spring-cache\"\n+cd spring-cache-quickstart\n+----\n+\n+This command generates a Maven project with a REST endpoint and imports the `spring-cache` and `spring-di` extension.", "originalCommit": "35d7c96c6aeaf1f64154c7898de140280b7f1cdb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTgzNjcwNQ==", "url": "https://github.com/quarkusio/quarkus/pull/9564#discussion_r429836705", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Let's start by creating a service which will simulate an extremely slow call to the external meteorological service.\n          \n          \n            \n            Let's start by creating a service which will simulate an extremely slow call to an external meteorological service.", "author": "gsmet", "createdAt": "2020-05-25T09:34:36Z", "path": "docs/src/main/asciidoc/spring-cache.adoc", "diffHunk": "@@ -0,0 +1,281 @@\n+////\n+This guide is maintained in the main Quarkus repository\n+and pull requests should be submitted there:\n+https://github.com/quarkusio/quarkus/tree/master/docs/src/main/asciidoc\n+////\n+= Quarkus - Quarkus Extension for Spring Cache API\n+\n+include::./attributes.adoc[]\n+:extension-status: preview\n+\n+While users are encouraged to use link:cache[Quarkus annotations for caching], Quarkus nevertheless provides a compatibility layer for Spring Cache annotations in the form of the `spring-cache` extension.\n+\n+This guide explains how a Quarkus application can leverage the well known Spring Cache annotations to enable application data caching for their Spring beans.\n+\n+include::./status-include.adoc[]\n+\n+== Prerequisites\n+\n+To complete this guide, you need:\n+\n+* less than 15 minutes\n+* an IDE\n+* JDK 1.8+ installed with `JAVA_HOME` configured appropriately\n+* Apache Maven {maven-version}\n+* Some familiarity with the Spring DI extension\n+\n+\n+== Creating the Maven project\n+\n+First, we need a new project. Create a new project with the following command:\n+\n+[source,shell,subs=attributes+]\n+----\n+mvn io.quarkus:quarkus-maven-plugin:{quarkus-version}:create \\\n+    -DprojectGroupId=org.acme \\\n+    -DprojectArtifactId=spring-cache-quickstart \\\n+    -DclassName=\"org.acme.spring.cache.GreeterResource\" \\\n+    -Dpath=\"/greeting\" \\\n+    -Dextensions=\"spring-di,spring-cache\"\n+cd spring-cache-quickstart\n+----\n+\n+This command generates a Maven project with a REST endpoint and imports the `spring-cache` and `spring-di` extension.\n+\n+If you already have your Quarkus project configured, you can add the `spring-cache` extension\n+to your project by running the following command in your project base directory:\n+\n+[source,bash]\n+----\n+./mvnw quarkus:add-extension -Dextensions=\"spring-cache\"\n+----\n+\n+This will add the following to your `pom.xml`:\n+\n+[source,xml]\n+----\n+<dependency>\n+    <groupId>io.quarkus</groupId>\n+    <artifactId>quarkus-spring-cache</artifactId>\n+</dependency>\n+----\n+\n+== Creating the REST API\n+\n+Let's start by creating a service which will simulate an extremely slow call to the external meteorological service.", "originalCommit": "35d7c96c6aeaf1f64154c7898de140280b7f1cdb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTgzNzY4Mg==", "url": "https://github.com/quarkusio/quarkus/pull/9564#discussion_r429837682", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Note that in this first version of the Spring cache annotations extension, not all features of these annotations are supported\n          \n          \n            \n            Note that in this first version of the Spring Cache annotations extension, not all features of these annotations are supported", "author": "gsmet", "createdAt": "2020-05-25T09:36:32Z", "path": "docs/src/main/asciidoc/spring-cache.adoc", "diffHunk": "@@ -0,0 +1,281 @@\n+////\n+This guide is maintained in the main Quarkus repository\n+and pull requests should be submitted there:\n+https://github.com/quarkusio/quarkus/tree/master/docs/src/main/asciidoc\n+////\n+= Quarkus - Quarkus Extension for Spring Cache API\n+\n+include::./attributes.adoc[]\n+:extension-status: preview\n+\n+While users are encouraged to use link:cache[Quarkus annotations for caching], Quarkus nevertheless provides a compatibility layer for Spring Cache annotations in the form of the `spring-cache` extension.\n+\n+This guide explains how a Quarkus application can leverage the well known Spring Cache annotations to enable application data caching for their Spring beans.\n+\n+include::./status-include.adoc[]\n+\n+== Prerequisites\n+\n+To complete this guide, you need:\n+\n+* less than 15 minutes\n+* an IDE\n+* JDK 1.8+ installed with `JAVA_HOME` configured appropriately\n+* Apache Maven {maven-version}\n+* Some familiarity with the Spring DI extension\n+\n+\n+== Creating the Maven project\n+\n+First, we need a new project. Create a new project with the following command:\n+\n+[source,shell,subs=attributes+]\n+----\n+mvn io.quarkus:quarkus-maven-plugin:{quarkus-version}:create \\\n+    -DprojectGroupId=org.acme \\\n+    -DprojectArtifactId=spring-cache-quickstart \\\n+    -DclassName=\"org.acme.spring.cache.GreeterResource\" \\\n+    -Dpath=\"/greeting\" \\\n+    -Dextensions=\"spring-di,spring-cache\"\n+cd spring-cache-quickstart\n+----\n+\n+This command generates a Maven project with a REST endpoint and imports the `spring-cache` and `spring-di` extension.\n+\n+If you already have your Quarkus project configured, you can add the `spring-cache` extension\n+to your project by running the following command in your project base directory:\n+\n+[source,bash]\n+----\n+./mvnw quarkus:add-extension -Dextensions=\"spring-cache\"\n+----\n+\n+This will add the following to your `pom.xml`:\n+\n+[source,xml]\n+----\n+<dependency>\n+    <groupId>io.quarkus</groupId>\n+    <artifactId>quarkus-spring-cache</artifactId>\n+</dependency>\n+----\n+\n+== Creating the REST API\n+\n+Let's start by creating a service which will simulate an extremely slow call to the external meteorological service.\n+Create `src/main/java/org/acme/spring/cache/WeatherForecastService.java` with the following content:\n+\n+[source,java]\n+----\n+package org.acme.spring.cache;\n+\n+import java.time.LocalDate;\n+\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+public class WeatherForecastService {\n+\n+    public String getDailyForecast(LocalDate date, String city) {\n+        try {\n+            Thread.sleep(2000L); // <1>\n+        } catch (InterruptedException e) {\n+            Thread.currentThread().interrupt();\n+        }\n+        return date.getDayOfWeek() + \" will be \" + getDailyResult(date.getDayOfMonth() % 4) + \" in \" + city;\n+    }\n+\n+    private String getDailyResult(int dayOfMonthModuloFour) {\n+        switch (dayOfMonthModuloFour) {\n+            case 0:\n+                return \"sunny\";\n+            case 1:\n+                return \"cloudy\";\n+            case 2:\n+                return \"chilly\";\n+            case 3:\n+                return \"rainy\";\n+            default:\n+                throw new IllegalArgumentException();\n+        }\n+    }\n+}\n+----\n+<1> This is where the slowness comes from.\n+\n+We also need a class which contains the response sent to the users when they ask for the next three days weather forecast.\n+Create `src/main/java/org/acme/spring/cache/WeatherForecast.java` this way:\n+\n+[source,java]\n+----\n+package org.acme.spring.cache;\n+\n+import java.util.List;\n+\n+public class WeatherForecast {\n+\n+    private List<String> dailyForecasts;\n+\n+    private long executionTimeInMs;\n+\n+    public WeatherForecast(List<String> dailyForecasts, long executionTimeInMs) {\n+        this.dailyForecasts = dailyForecasts;\n+        this.executionTimeInMs = executionTimeInMs;\n+    }\n+\n+    public List<String> getDailyForecasts() {\n+        return dailyForecasts;\n+    }\n+\n+    public long getExecutionTimeInMs() {\n+        return executionTimeInMs;\n+    }\n+}\n+----\n+\n+Now, we just need to update the generated `WeatherForecastResource` class to use the service and response:\n+\n+[source,java]\n+----\n+package org.acme.spring.cache;\n+\n+import java.time.LocalDate;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+import javax.inject.Inject;\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.core.MediaType;\n+\n+import org.jboss.resteasy.annotations.jaxrs.QueryParam;\n+\n+@Path(\"/weather\")\n+public class WeatherForecastResource {\n+\n+    @Inject\n+    WeatherForecastService service;\n+\n+    @GET\n+    @Produces(MediaType.APPLICATION_JSON)\n+    public WeatherForecast getForecast(@QueryParam String city, @QueryParam long daysInFuture) { // <1>\n+        long executionStart = System.currentTimeMillis();\n+        List<String> dailyForecasts = Arrays.asList(\n+                service.getDailyForecast(LocalDate.now().plusDays(daysInFuture), city),\n+                service.getDailyForecast(LocalDate.now().plusDays(daysInFuture + 1L), city),\n+                service.getDailyForecast(LocalDate.now().plusDays(daysInFuture + 2L), city)\n+        );\n+        long executionEnd = System.currentTimeMillis();\n+        return new WeatherForecast(dailyForecasts, executionEnd - executionStart);\n+    }\n+}\n+----\n+<1> If the `daysInFuture` query parameter is omitted, the three days weather forecast will start from the current day.\n+Otherwise, it will start from the current day plus the `daysInFuture` value.\n+\n+We're all done! Let's check if everything's working.\n+\n+First, run the application using `./mvnw compile quarkus:dev` from the project directory.\n+\n+Then, call `http://localhost:8080/weather?city=Raleigh` from a browser.\n+After six long seconds, the application will answer something like this:\n+\n+[source]\n+----\n+{\"dailyForecasts\":[\"MONDAY will be cloudy in Raleigh\",\"TUESDAY will be chilly in Raleigh\",\"WEDNESDAY will be rainy in Raleigh\"],\"executionTimeInMs\":6001}\n+----\n+\n+[TIP]\n+====\n+The response content may vary depending on the day you run the code.\n+====\n+\n+You can try calling the same URL again and again, it will always take six seconds to answer.\n+\n+== Enabling the cache\n+\n+Now that your Quarkus application is up and running, let's tremendously improve its response time by caching the external meteorological service responses.\n+Update the `WeatherForecastService` class as follows:\n+\n+[source,java]\n+----\n+package org.acme.cache;\n+\n+import java.time.LocalDate;\n+\n+import org.springframework.cache.annotation.Cacheable;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+public class WeatherForecastService {\n+\n+    @Cacheable(\"weather-cache\") // <1>\n+    public String getDailyForecast(LocalDate date, String city) {\n+        try {\n+            Thread.sleep(2000L);\n+        } catch (InterruptedException e) {\n+            Thread.currentThread().interrupt();\n+        }\n+        return date.getDayOfWeek() + \" will be \" + getDailyResult(date.getDayOfMonth() % 4) + \" in \" + city;\n+    }\n+\n+    private String getDailyResult(int dayOfMonthModuloFour) {\n+        switch (dayOfMonthModuloFour) {\n+            case 0:\n+                return \"sunny\";\n+            case 1:\n+                return \"cloudy\";\n+            case 2:\n+                return \"chilly\";\n+            case 3:\n+                return \"rainy\";\n+            default:\n+                throw new IllegalArgumentException();\n+        }\n+    }\n+}\n+----\n+<1> We only added this annotation (and the associated import of course).\n+\n+Let's try to call `http://localhost:8080/weather?city=Raleigh` again.\n+You're still waiting a long time before receiving an answer.\n+This is normal since the server just restarted and the cache was empty.\n+\n+Wait a second! The server restarted by itself after the `WeatherForecastService` update?\n+Yes, this is one of Quarkus amazing features for developers called `live coding`.\n+\n+Now that the cache was loaded during the previous call, try calling the same URL.\n+This time, you should get a super fast answer with an `executionTimeInMs` value close to 0.\n+\n+Let's see what happens if we start from one day in the future using the `http://localhost:8080/weather?city=Raleigh&daysInFuture=1` URL.\n+You should get an answer two seconds later since two of the requested days were already loaded in the cache.\n+\n+You can also try calling the same URL with a different city and see the cache in action again.\n+The first call will take six seconds and the following ones will be answered immediately.\n+\n+Congratulations! You just added application data caching to your Quarkus application with a single line of code!\n+\n+== Supported features\n+\n+Quarkus provides compatibility with the following Spring Cache annotations:\n+\n+* `@Cacheable`\n+* `@CachePut`\n+* `@CacheEvict`\n+\n+Note that in this first version of the Spring cache annotations extension, not all features of these annotations are supported", "originalCommit": "35d7c96c6aeaf1f64154c7898de140280b7f1cdb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "795c9f0fde07909642550a2fe98b73563ed6d13e", "url": "https://github.com/quarkusio/quarkus/commit/795c9f0fde07909642550a2fe98b73563ed6d13e", "message": "Add documentation for Spring Cache extension\n\nCo-authored-by: Guillaume Smet <guillaume.smet@gmail.com>", "committedDate": "2020-05-25T09:41:26Z", "type": "commit"}, {"oid": "795c9f0fde07909642550a2fe98b73563ed6d13e", "url": "https://github.com/quarkusio/quarkus/commit/795c9f0fde07909642550a2fe98b73563ed6d13e", "message": "Add documentation for Spring Cache extension\n\nCo-authored-by: Guillaume Smet <guillaume.smet@gmail.com>", "committedDate": "2020-05-25T09:41:26Z", "type": "forcePushed"}]}