{"pr_number": 9907, "pr_title": "Correctly register metrics for inherited default methods", "pr_createdAt": "2020-06-10T10:48:01Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/9907", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA2NDc4Mw==", "url": "https://github.com/quarkusio/quarkus/pull/9907#discussion_r438064783", "bodyText": "Is that true? It seems that you call findNonOverriddenDefaultMethods when you traverse the inheritance hierachy, so not all superclasses are processed yet when you call this method. Would it be better to traverse the inheritance hierarchy twice, first to process superclasses, and second to process interfaces?", "author": "Ladicek", "createdAt": "2020-06-10T11:55:01Z", "path": "extensions/smallrye-metrics/deployment/src/main/java/io/quarkus/smallrye/metrics/deployment/SmallRyeMetricsProcessor.java", "diffHunk": "@@ -396,6 +407,35 @@ void registerMetricsFromAnnotatedMethods(SmallRyeMetricsRecorder metrics,\n         }\n     }\n \n+    private void findNonOverriddenDefaultMethods(ClassInfo interfaceInfo, List<ClassInfo> subClasses,\n+            SmallRyeMetricsRecorder recorder,\n+            BeanArchiveIndexBuildItem beanArchiveIndex, JandexMemberInfoAdapter memberInfoAdapter, BeanInfo beanInfo) {\n+        // Check for default methods which are NOT overridden by the bean that we are registering metrics for\n+        // or any of its superclasses. Register a metric for each of them.\n+        interfaceInfo.methods().forEach(method -> {\n+            if (!Modifier.isAbstract(method.flags())) { // only take default methods\n+                // Here we check that the default method is not overridden by the bean of any of its superclasses,\n+                // because in such case it was already picked up while scanning through superclasses and their methods", "originalCommit": "6660b1185ae60577cd098b17627df8b75d831209", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA3NDM3NQ==", "url": "https://github.com/quarkusio/quarkus/pull/9907#discussion_r438074375", "bodyText": "Hmm I guess it should then say \"already scanned superclasses\", because some of them are not processed yet... \"Already scanned superclasses  and implemented interfaces\" == the subClasses list, yeah the naming is very fortunate, perhaps a alreadyScanned would be a better name. Would it make more sense to you then?\nI nearly burst my brain writing this algorithm, so it's also possible that there's a mistake. If you can come up with a scenario that breaks it...", "author": "jmartisk", "createdAt": "2020-06-10T12:13:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA2NDc4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE2MzM0OA==", "url": "https://github.com/quarkusio/quarkus/pull/9907#discussion_r438163348", "bodyText": "I don't know, didn't try, but I was thinking something like:\nclass A extends B implements I {\n}\n\nclass B extends C {\n}\n\nclass C {\n  @Timed\n  public void doSomething() { ... }\n}\n\ninterface I {\n  @Timed\n  default void doSomething() { ... }\n}\nPer Java rules, A.doSomething() runs the C.doSomething method, but the algorithm here, in my understanding, will select I.doSomething. Or am I wrong about that?", "author": "Ladicek", "createdAt": "2020-06-10T14:24:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA2NDc4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU5NDcxMg==", "url": "https://github.com/quarkusio/quarkus/pull/9907#discussion_r438594712", "bodyText": "It does not actually matter what exact method the algorithm registered the metric from, the only thing that matters is the name, because here we're only registering the metric, not binding the registration to any interceptor or so.\nAlso we're talking about the case when the metric annotation is on the concrete bean (and meaning on the class level, not method level), not in the interface, because we don't support that case yet.\nAnyway if i take your scenario and move the @Timed annotations to the class-level of A, then it indeed breaks, because it attempts to register A.doSomething twice. Guess we'll need to track \"already registered method names\" rather than \"already visited classes\", I'll come up with something...", "author": "jmartisk", "createdAt": "2020-06-11T07:29:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA2NDc4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODYwODI2Nw==", "url": "https://github.com/quarkusio/quarkus/pull/9907#discussion_r438608267", "bodyText": "Changed the tracking of \"already visited classes\" to tracking of \"already registered method names\".\nIt does not matter where exactly the method is taken from (which superclass or interface) if there are multiple options - the metric name is computed from the (concrete) bean name and method name. We just need to see each method at least once.", "author": "jmartisk", "createdAt": "2020-06-11T07:56:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA2NDc4Mw=="}], "type": "inlineReview"}, {"oid": "9291c70db048eb268fe5595e7c544a127239ebc7", "url": "https://github.com/quarkusio/quarkus/commit/9291c70db048eb268fe5595e7c544a127239ebc7", "message": "Correctly register metrics for inherited default methods", "committedDate": "2020-06-11T07:53:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODYwOTY3Mw==", "url": "https://github.com/quarkusio/quarkus/pull/9907#discussion_r438609673", "bodyText": "Should it be a Set?", "author": "Ladicek", "createdAt": "2020-06-11T07:58:44Z", "path": "extensions/smallrye-metrics/deployment/src/main/java/io/quarkus/smallrye/metrics/deployment/SmallRyeMetricsProcessor.java", "diffHunk": "@@ -370,17 +371,22 @@ void registerMetricsFromAnnotatedMethods(SmallRyeMetricsRecorder metrics,\n         for (ClassInfo clazz : collectedMetricsClasses.values()) {\n             BeanInfo beanInfo = beanInfoAdapter.convert(clazz);\n             ClassInfo superclass = clazz;\n+            List<String> alreadyRegisteredNames = new ArrayList<>();", "originalCommit": "9291c70db048eb268fe5595e7c544a127239ebc7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODYxNTA3MA==", "url": "https://github.com/quarkusio/quarkus/pull/9907#discussion_r438615070", "bodyText": "Oh.. yeah. Fixed", "author": "jmartisk", "createdAt": "2020-06-11T08:09:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODYwOTY3Mw=="}], "type": "inlineReview"}, {"oid": "fe5e3122d5d784c6b9ca0df602d2ea2244609a72", "url": "https://github.com/quarkusio/quarkus/commit/fe5e3122d5d784c6b9ca0df602d2ea2244609a72", "message": "Correctly register metrics for inherited default methods", "committedDate": "2020-06-11T08:09:24Z", "type": "forcePushed"}, {"oid": "fe5e3122d5d784c6b9ca0df602d2ea2244609a72", "url": "https://github.com/quarkusio/quarkus/commit/fe5e3122d5d784c6b9ca0df602d2ea2244609a72", "message": "Correctly register metrics for inherited default methods", "committedDate": "2020-06-11T08:09:24Z", "type": "commit"}]}