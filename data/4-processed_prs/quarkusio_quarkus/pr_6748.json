{"pr_number": 6748, "pr_title": "quarkus:create-extension fixes and enhancements", "pr_createdAt": "2020-01-23T15:50:45Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/6748", "timeline": [{"oid": "4d99b2e523e25e83aaa6c2f040f5e1e850ea3d54", "url": "https://github.com/quarkusio/quarkus/commit/4d99b2e523e25e83aaa6c2f040f5e1e850ea3d54", "message": "Make sure the generated extension project can be actually be built, support creating an extension project in an empty dir with a single command, e.g. mvn io.quarkus:quarkus-maven-plugin:999-SNAPSHOT:create-extension -DgroupId=org.acme -DartifactId=my-ext -Dversion=1.0-SNAPSHOT", "committedDate": "2020-01-30T09:14:00Z", "type": "commit"}, {"oid": "4d99b2e523e25e83aaa6c2f040f5e1e850ea3d54", "url": "https://github.com/quarkusio/quarkus/commit/4d99b2e523e25e83aaa6c2f040f5e1e850ea3d54", "message": "Make sure the generated extension project can be actually be built, support creating an extension project in an empty dir with a single command, e.g. mvn io.quarkus:quarkus-maven-plugin:999-SNAPSHOT:create-extension -DgroupId=org.acme -DartifactId=my-ext -Dversion=1.0-SNAPSHOT", "committedDate": "2020-01-30T09:14:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg2OTk5Nw==", "url": "https://github.com/quarkusio/quarkus/pull/6748#discussion_r372869997", "bodyText": "I am also not sure about this... Can we be sure it will work? If not, I think we should focus on the simple use case for now that we know will work.", "author": "geoand", "createdAt": "2020-01-30T10:29:39Z", "path": "devtools/maven/src/main/java/io/quarkus/maven/CreateExtensionMojo.java", "diffHunk": "@@ -411,123 +558,318 @@ public void execute() throws MojoExecutionException, MojoFailureException {\n         }\n \n         if (runtimeBomPath != null) {\n-            runtimeBomPath = basedir.resolve(runtimeBomPath);\n+            runtimeBomPath = basedir.toPath().resolve(runtimeBomPath);\n             if (!Files.exists(runtimeBomPath)) {\n                 throw new MojoFailureException(\"runtimeBomPath does not exist: \" + runtimeBomPath);\n             }\n         }\n         if (deploymentBomPath != null) {\n-            deploymentBomPath = basedir.resolve(deploymentBomPath);\n+            deploymentBomPath = basedir.toPath().resolve(deploymentBomPath);\n             if (!Files.exists(deploymentBomPath)) {\n                 throw new MojoFailureException(\"deploymentBomPath does not exist: \" + deploymentBomPath);\n             }\n         }\n \n-        final Charset charset = Charset.forName(encoding);\n-\n-        final Path basePomXml = basedir.resolve(\"pom.xml\");\n-        if (Files.exists(basePomXml)) {\n-            try (Reader r = Files.newBufferedReader(basePomXml, charset)) {\n-                Model basePom = new MavenXpp3Reader().read(r);\n-                if (!\"pom\".equals(basePom.getPackaging())) {\n+        charset = Charset.forName(encoding);\n+\n+        try {\n+            File rootPom = null;\n+            Model rootModel = null;\n+            boolean importDeploymentBom = true;\n+            boolean setCompilerPluginVersion = true;\n+            boolean setQuarkusVersionProp = true;\n+            if (isCurrentProjectExists()) {\n+                rootPom = getCurrentProjectPom();\n+                rootModel = MojoUtils.readPom(rootPom);\n+                if (!\"pom\".equals(rootModel.getPackaging())) {\n                     throw new MojoFailureException(\n                             \"Can add extension modules only under a project with packaging 'pom'; found: \"\n-                                    + basePom.getPackaging() + \"\");\n+                                    + rootModel.getPackaging() + \"\");\n+                }\n+\n+                if (rootPom.equals(project.getFile())) {\n+                    importDeploymentBom = !hasQuarkusDeploymentBom();\n+                    setCompilerPluginVersion = !project.getPluginManagement().getPluginsAsMap()\n+                            .containsKey(COMPILER_PLUGIN_KEY);\n+                    setQuarkusVersionProp = !project.getProperties().containsKey(QUARKUS_VERSION_PROP);\n+                } else {\n+                    // aloubyansky: not sure we should support this case and not sure it ever worked properly", "originalCommit": "4d99b2e523e25e83aaa6c2f040f5e1e850ea3d54", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg3MDA5OQ==", "url": "https://github.com/quarkusio/quarkus/pull/6748#discussion_r372870099", "bodyText": "Same as above as well :)", "author": "geoand", "createdAt": "2020-01-30T10:29:53Z", "path": "devtools/maven/src/main/java/io/quarkus/maven/CreateExtensionMojo.java", "diffHunk": "@@ -411,123 +558,318 @@ public void execute() throws MojoExecutionException, MojoFailureException {\n         }\n \n         if (runtimeBomPath != null) {\n-            runtimeBomPath = basedir.resolve(runtimeBomPath);\n+            runtimeBomPath = basedir.toPath().resolve(runtimeBomPath);\n             if (!Files.exists(runtimeBomPath)) {\n                 throw new MojoFailureException(\"runtimeBomPath does not exist: \" + runtimeBomPath);\n             }\n         }\n         if (deploymentBomPath != null) {\n-            deploymentBomPath = basedir.resolve(deploymentBomPath);\n+            deploymentBomPath = basedir.toPath().resolve(deploymentBomPath);\n             if (!Files.exists(deploymentBomPath)) {\n                 throw new MojoFailureException(\"deploymentBomPath does not exist: \" + deploymentBomPath);\n             }\n         }\n \n-        final Charset charset = Charset.forName(encoding);\n-\n-        final Path basePomXml = basedir.resolve(\"pom.xml\");\n-        if (Files.exists(basePomXml)) {\n-            try (Reader r = Files.newBufferedReader(basePomXml, charset)) {\n-                Model basePom = new MavenXpp3Reader().read(r);\n-                if (!\"pom\".equals(basePom.getPackaging())) {\n+        charset = Charset.forName(encoding);\n+\n+        try {\n+            File rootPom = null;\n+            Model rootModel = null;\n+            boolean importDeploymentBom = true;\n+            boolean setCompilerPluginVersion = true;\n+            boolean setQuarkusVersionProp = true;\n+            if (isCurrentProjectExists()) {\n+                rootPom = getCurrentProjectPom();\n+                rootModel = MojoUtils.readPom(rootPom);\n+                if (!\"pom\".equals(rootModel.getPackaging())) {\n                     throw new MojoFailureException(\n                             \"Can add extension modules only under a project with packaging 'pom'; found: \"\n-                                    + basePom.getPackaging() + \"\");\n+                                    + rootModel.getPackaging() + \"\");\n+                }\n+\n+                if (rootPom.equals(project.getFile())) {\n+                    importDeploymentBom = !hasQuarkusDeploymentBom();\n+                    setCompilerPluginVersion = !project.getPluginManagement().getPluginsAsMap()\n+                            .containsKey(COMPILER_PLUGIN_KEY);\n+                    setQuarkusVersionProp = !project.getProperties().containsKey(QUARKUS_VERSION_PROP);\n+                } else {\n+                    // aloubyansky: not sure we should support this case and not sure it ever worked properly\n+                    // this is about creating an extension project not in the context of the current project from the Maven's plugin perspective\n+                    // kind of a pathological use-case from the Maven's perspective, imo\n+                    final DefaultArtifact rootArtifact = new DefaultArtifact(getGroupId(rootModel),\n+                            rootModel.getArtifactId(), null, rootModel.getPackaging(), getVersion(rootModel));\n+                    try {\n+                        final LocalWorkspace ws = LocalProject.loadWorkspace(rootPom.getParentFile().toPath()).getWorkspace();\n+                        final MavenArtifactResolver mvn = MavenArtifactResolver.builder()\n+                                .setRepositorySystem(MavenRepoInitializer.getRepositorySystem(repoSession.isOffline(), ws))\n+                                .setRepositorySystemSession(repoSession)\n+                                .setRemoteRepositories(repos)\n+                                .setWorkspace(LocalProject.loadWorkspace(rootPom.getParentFile().toPath()).getWorkspace())\n+                                .build();\n+                        final ArtifactDescriptorResult rootDescr = mvn.resolveDescriptor(rootArtifact);\n+                        importDeploymentBom = !hasQuarkusDeploymentBom(rootDescr.getManagedDependencies());\n+                        // TODO determine whether the compiler plugin is configured for the project\n+                        setQuarkusVersionProp = !rootDescr.getProperties().containsKey(QUARKUS_VERSION_PROP);\n+                    } catch (Exception e) {\n+                        throw new MojoExecutionException(\"Failed to resolve \" + rootArtifact + \" descriptor\", e);\n+                    }\n+                }\n+            } else if (this.grandParentRelativePath != null) {\n+                // aloubyansky: not sure we should support this case, same as above", "originalCommit": "4d99b2e523e25e83aaa6c2f040f5e1e850ea3d54", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg3NjM4Ng==", "url": "https://github.com/quarkusio/quarkus/pull/6748#discussion_r372876386", "bodyText": "This does work on Windows too, right?\nI see it's also used in one other place in Quarkus so I guess it's OK. But I would like to know why this is prefered instead of what the previous incarnation of the code did.", "author": "geoand", "createdAt": "2020-01-30T10:43:33Z", "path": "devtools/maven/src/main/java/io/quarkus/maven/CreateExtensionMojo.java", "diffHunk": "@@ -370,18 +446,89 @@\n     @Parameter(defaultValue = \"${project}\", readonly = true)\n     MavenProject project;\n \n+    /**\n+     * The entry point to Aether, i.e. the component doing all the work.\n+     *\n+     * @component\n+     */\n+    @Component\n+    private RepositorySystem repoSystem;\n+\n+    /**\n+     * The current repository/network configuration of Maven.\n+     *\n+     * @parameter default-value=\"${repositorySystemSession}\"\n+     * @readonly\n+     */\n+    @Parameter(defaultValue = \"${repositorySystemSession}\", readonly = true)\n+    private RepositorySystemSession repoSession;\n+\n+    /**\n+     * The project's remote repositories to use for the resolution of artifacts and their dependencies.\n+     *\n+     * @parameter default-value=\"${project.remoteProjectRepositories}\"\n+     * @readonly\n+     */\n+    @Parameter(defaultValue = \"${project.remoteProjectRepositories}\", readonly = true, required = true)\n+    private List<RemoteRepository> repos;\n+\n+    /**\n+     * The version of {@code org.apache.maven.plugins:maven-compiler-plugin} that should be used for\n+     * the extension project.\n+     */\n+    @Parameter(defaultValue = COMPILER_PLUGIN_DEFAULT_VERSION, required = true, property = \"quarkus.mavenCompilerPluginVersion\")\n+    String compilerPluginVersion;\n+\n+    boolean currentProjectIsBaseDir;\n+\n+    Charset charset;\n+\n     @Override\n     public void execute() throws MojoExecutionException, MojoFailureException {\n \n         if (this.basedir == null) {\n-            this.basedir = Paths.get(\".\").toAbsolutePath().normalize();\n+            currentProjectIsBaseDir = true;\n+            this.basedir = new File(\".\").getAbsoluteFile();", "originalCommit": "4d99b2e523e25e83aaa6c2f040f5e1e850ea3d54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg3ODc3Ng==", "url": "https://github.com/quarkusio/quarkus/pull/6748#discussion_r372878776", "bodyText": "I haven't tested it on Windows actually. But I remember I had issues initializing it as Path, switching to File seemed to have fixed them. I'll try again now to be sure.", "author": "aloubyansky", "createdAt": "2020-01-30T10:48:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg3NjM4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg4NTQ3OA==", "url": "https://github.com/quarkusio/quarkus/pull/6748#discussion_r372885478", "bodyText": "Here is what I get by simply changing the type of basedir from File to Path:\n[aloubyansky@lenora newdir]$ mvn io.quarkus:quarkus-maven-plugin:999-SNAPSHOT:create-extension -DartifactId=my-ext -Dquarkus.basedir=../my-ext -e\n[INFO] Error stacktraces are turned on.\n[INFO] Scanning for projects...\n[INFO] \n[INFO] ------------------< org.apache.maven:standalone-pom >-------------------\n[INFO] Building Maven Stub Project (No POM) 1\n[INFO] --------------------------------[ pom ]---------------------------------\n[INFO] \n[INFO] --- quarkus-maven-plugin:999-SNAPSHOT:create-extension (default-cli) @ standalone-pom ---\n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD FAILURE\n[INFO] ------------------------------------------------------------------------\n[INFO] Total time:  1.139 s\n[INFO] Finished at: 2020-01-30T12:01:07+01:00\n[INFO] ------------------------------------------------------------------------\n[ERROR] Failed to execute goal io.quarkus:quarkus-maven-plugin:999-SNAPSHOT:create-extension (default-cli) on project standalone-pom: Unable to parse configuration of mojo io.quarkus:quarkus-maven-plugin:999-SNAPSHOT:create-extension for parameter basedir: Cannot create instance of interface java.nio.file.Path: java.nio.file.Path.<init>() -> [Help 1]\norg.apache.maven.lifecycle.LifecycleExecutionException: Failed to execute goal io.quarkus:quarkus-maven-plugin:999-SNAPSHOT:create-extension (default-cli) on project standalone-pom: Unable to parse configuration of mojo io.quarkus:quarkus-maven-plugin:999-SNAPSHOT:create-extension for parameter basedir: Cannot create instance of interface java.nio.file.Path\n    at org.apache.maven.lifecycle.internal.MojoExecutor.execute (MojoExecutor.java:215)\n    at org.apache.maven.lifecycle.internal.MojoExecutor.execute (MojoExecutor.java:156)\n    at org.apache.maven.lifecycle.internal.MojoExecutor.execute (MojoExecutor.java:148)\n    at org.apache.maven.lifecycle.internal.LifecycleModuleBuilder.buildProject (LifecycleModuleBuilder.java:117)\n    at org.apache.maven.lifecycle.internal.LifecycleModuleBuilder.buildProject (LifecycleModuleBuilder.java:81)\n    at org.apache.maven.lifecycle.internal.builder.singlethreaded.SingleThreadedBuilder.build (SingleThreadedBuilder.java:56)\n    at org.apache.maven.lifecycle.internal.LifecycleStarter.execute (LifecycleStarter.java:128)\n    at org.apache.maven.DefaultMaven.doExecute (DefaultMaven.java:305)\n    at org.apache.maven.DefaultMaven.doExecute (DefaultMaven.java:192)\n    at org.apache.maven.DefaultMaven.execute (DefaultMaven.java:105)\n    at org.apache.maven.cli.MavenCli.execute (MavenCli.java:957)\n    at org.apache.maven.cli.MavenCli.doMain (MavenCli.java:289)\n    at org.apache.maven.cli.MavenCli.main (MavenCli.java:193)\n    at sun.reflect.NativeMethodAccessorImpl.invoke0 (Native Method)\n    at sun.reflect.NativeMethodAccessorImpl.invoke (NativeMethodAccessorImpl.java:62)\n    at sun.reflect.DelegatingMethodAccessorImpl.invoke (DelegatingMethodAccessorImpl.java:43)\n    at java.lang.reflect.Method.invoke (Method.java:498)\n    at org.codehaus.plexus.classworlds.launcher.Launcher.launchEnhanced (Launcher.java:282)\n    at org.codehaus.plexus.classworlds.launcher.Launcher.launch (Launcher.java:225)\n    at org.codehaus.plexus.classworlds.launcher.Launcher.mainWithExitCode (Launcher.java:406)\n    at org.codehaus.plexus.classworlds.launcher.Launcher.main (Launcher.java:347)\nCaused by: org.apache.maven.plugin.PluginConfigurationException: Unable to parse configuration of mojo io.quarkus:quarkus-maven-plugin:999-SNAPSHOT:create-extension for parameter basedir: Cannot create instance of interface java.nio.file.Path\n    at org.apache.maven.plugin.internal.DefaultMavenPluginManager.populatePluginFields (DefaultMavenPluginManager.java:665)\n    at org.apache.maven.plugin.internal.DefaultMavenPluginManager.getConfiguredMojo (DefaultMavenPluginManager.java:597)\n    at org.apache.maven.plugin.DefaultBuildPluginManager.executeMojo (DefaultBuildPluginManager.java:124)\n    at org.apache.maven.lifecycle.internal.MojoExecutor.execute (MojoExecutor.java:210)\n    at org.apache.maven.lifecycle.internal.MojoExecutor.execute (MojoExecutor.java:156)\n    at org.apache.maven.lifecycle.internal.MojoExecutor.execute (MojoExecutor.java:148)\n    at org.apache.maven.lifecycle.internal.LifecycleModuleBuilder.buildProject (LifecycleModuleBuilder.java:117)\n    at org.apache.maven.lifecycle.internal.LifecycleModuleBuilder.buildProject (LifecycleModuleBuilder.java:81)\n    at org.apache.maven.lifecycle.internal.builder.singlethreaded.SingleThreadedBuilder.build (SingleThreadedBuilder.java:56)\n    at org.apache.maven.lifecycle.internal.LifecycleStarter.execute (LifecycleStarter.java:128)\n    at org.apache.maven.DefaultMaven.doExecute (DefaultMaven.java:305)\n    at org.apache.maven.DefaultMaven.doExecute (DefaultMaven.java:192)\n    at org.apache.maven.DefaultMaven.execute (DefaultMaven.java:105)\n    at org.apache.maven.cli.MavenCli.execute (MavenCli.java:957)\n    at org.apache.maven.cli.MavenCli.doMain (MavenCli.java:289)\n    at org.apache.maven.cli.MavenCli.main (MavenCli.java:193)\n    at sun.reflect.NativeMethodAccessorImpl.invoke0 (Native Method)\n    at sun.reflect.NativeMethodAccessorImpl.invoke (NativeMethodAccessorImpl.java:62)\n    at sun.reflect.DelegatingMethodAccessorImpl.invoke (DelegatingMethodAccessorImpl.java:43)\n    at java.lang.reflect.Method.invoke (Method.java:498)\n    at org.codehaus.plexus.classworlds.launcher.Launcher.launchEnhanced (Launcher.java:282)\n    at org.codehaus.plexus.classworlds.launcher.Launcher.launch (Launcher.java:225)\n    at org.codehaus.plexus.classworlds.launcher.Launcher.mainWithExitCode (Launcher.java:406)\n    at org.codehaus.plexus.classworlds.launcher.Launcher.main (Launcher.java:347)\nCaused by: org.codehaus.plexus.component.configurator.ComponentConfigurationException: Cannot create instance of interface java.nio.file.Path\n    at org.codehaus.plexus.component.configurator.converters.AbstractConfigurationConverter.instantiateObject (AbstractConfigurationConverter.java:147)\n    at org.codehaus.plexus.component.configurator.converters.composite.ObjectWithFieldsConverter.fromConfiguration (ObjectWithFieldsConverter.java:54)\n    at org.eclipse.sisu.plexus.CompositeBeanHelper.convertProperty (CompositeBeanHelper.java:273)\n    at org.eclipse.sisu.plexus.CompositeBeanHelper.setProperty (CompositeBeanHelper.java:210)\n    at org.codehaus.plexus.component.configurator.converters.composite.ObjectWithFieldsConverter.processConfiguration (ObjectWithFieldsConverter.java:101)\n    at org.codehaus.plexus.component.configurator.BasicComponentConfigurator.configureComponent (BasicComponentConfigurator.java:34)\n    at org.apache.maven.plugin.internal.DefaultMavenPluginManager.populatePluginFields (DefaultMavenPluginManager.java:635)\n    at org.apache.maven.plugin.internal.DefaultMavenPluginManager.getConfiguredMojo (DefaultMavenPluginManager.java:597)\n    at org.apache.maven.plugin.DefaultBuildPluginManager.executeMojo (DefaultBuildPluginManager.java:124)\n    at org.apache.maven.lifecycle.internal.MojoExecutor.execute (MojoExecutor.java:210)\n    at org.apache.maven.lifecycle.internal.MojoExecutor.execute (MojoExecutor.java:156)\n    at org.apache.maven.lifecycle.internal.MojoExecutor.execute (MojoExecutor.java:148)\n    at org.apache.maven.lifecycle.internal.LifecycleModuleBuilder.buildProject (LifecycleModuleBuilder.java:117)\n    at org.apache.maven.lifecycle.internal.LifecycleModuleBuilder.buildProject (LifecycleModuleBuilder.java:81)\n    at org.apache.maven.lifecycle.internal.builder.singlethreaded.SingleThreadedBuilder.build (SingleThreadedBuilder.java:56)\n    at org.apache.maven.lifecycle.internal.LifecycleStarter.execute (LifecycleStarter.java:128)\n    at org.apache.maven.DefaultMaven.doExecute (DefaultMaven.java:305)\n    at org.apache.maven.DefaultMaven.doExecute (DefaultMaven.java:192)\n    at org.apache.maven.DefaultMaven.execute (DefaultMaven.java:105)\n    at org.apache.maven.cli.MavenCli.execute (MavenCli.java:957)\n    at org.apache.maven.cli.MavenCli.doMain (MavenCli.java:289)\n    at org.apache.maven.cli.MavenCli.main (MavenCli.java:193)\n    at sun.reflect.NativeMethodAccessorImpl.invoke0 (Native Method)\n    at sun.reflect.NativeMethodAccessorImpl.invoke (NativeMethodAccessorImpl.java:62)\n    at sun.reflect.DelegatingMethodAccessorImpl.invoke (DelegatingMethodAccessorImpl.java:43)\n    at java.lang.reflect.Method.invoke (Method.java:498)\n    at org.codehaus.plexus.classworlds.launcher.Launcher.launchEnhanced (Launcher.java:282)\n    at org.codehaus.plexus.classworlds.launcher.Launcher.launch (Launcher.java:225)\n    at org.codehaus.plexus.classworlds.launcher.Launcher.mainWithExitCode (Launcher.java:406)\n    at org.codehaus.plexus.classworlds.launcher.Launcher.main (Launcher.java:347)\nCaused by: java.lang.InstantiationException: java.nio.file.Path\n    at java.lang.Class.newInstance (Class.java:427)\n    at org.codehaus.plexus.component.configurator.converters.AbstractConfigurationConverter.instantiateObject (AbstractConfigurationConverter.java:143)\n    at org.codehaus.plexus.component.configurator.converters.composite.ObjectWithFieldsConverter.fromConfiguration (ObjectWithFieldsConverter.java:54)\n    at org.eclipse.sisu.plexus.CompositeBeanHelper.convertProperty (CompositeBeanHelper.java:273)\n    at org.eclipse.sisu.plexus.CompositeBeanHelper.setProperty (CompositeBeanHelper.java:210)\n    at org.codehaus.plexus.component.configurator.converters.composite.ObjectWithFieldsConverter.processConfiguration (ObjectWithFieldsConverter.java:101)\n    at org.codehaus.plexus.component.configurator.BasicComponentConfigurator.configureComponent (BasicComponentConfigurator.java:34)\n    at org.apache.maven.plugin.internal.DefaultMavenPluginManager.populatePluginFields (DefaultMavenPluginManager.java:635)\n    at org.apache.maven.plugin.internal.DefaultMavenPluginManager.getConfiguredMojo (DefaultMavenPluginManager.java:597)\n    at org.apache.maven.plugin.DefaultBuildPluginManager.executeMojo (DefaultBuildPluginManager.java:124)\n    at org.apache.maven.lifecycle.internal.MojoExecutor.execute (MojoExecutor.java:210)\n    at org.apache.maven.lifecycle.internal.MojoExecutor.execute (MojoExecutor.java:156)\n    at org.apache.maven.lifecycle.internal.MojoExecutor.execute (MojoExecutor.java:148)\n    at org.apache.maven.lifecycle.internal.LifecycleModuleBuilder.buildProject (LifecycleModuleBuilder.java:117)\n    at org.apache.maven.lifecycle.internal.LifecycleModuleBuilder.buildProject (LifecycleModuleBuilder.java:81)\n    at org.apache.maven.lifecycle.internal.builder.singlethreaded.SingleThreadedBuilder.build (SingleThreadedBuilder.java:56)\n    at org.apache.maven.lifecycle.internal.LifecycleStarter.execute (LifecycleStarter.java:128)\n    at org.apache.maven.DefaultMaven.doExecute (DefaultMaven.java:305)\n    at org.apache.maven.DefaultMaven.doExecute (DefaultMaven.java:192)\n    at org.apache.maven.DefaultMaven.execute (DefaultMaven.java:105)\n    at org.apache.maven.cli.MavenCli.execute (MavenCli.java:957)\n    at org.apache.maven.cli.MavenCli.doMain (MavenCli.java:289)\n    at org.apache.maven.cli.MavenCli.main (MavenCli.java:193)\n    at sun.reflect.NativeMethodAccessorImpl.invoke0 (Native Method)\n    at sun.reflect.NativeMethodAccessorImpl.invoke (NativeMethodAccessorImpl.java:62)\n    at sun.reflect.DelegatingMethodAccessorImpl.invoke (DelegatingMethodAccessorImpl.java:43)\n    at java.lang.reflect.Method.invoke (Method.java:498)\n    at org.codehaus.plexus.classworlds.launcher.Launcher.launchEnhanced (Launcher.java:282)\n    at org.codehaus.plexus.classworlds.launcher.Launcher.launch (Launcher.java:225)\n    at org.codehaus.plexus.classworlds.launcher.Launcher.mainWithExitCode (Launcher.java:406)\n    at org.codehaus.plexus.classworlds.launcher.Launcher.main (Launcher.java:347)\nCaused by: java.lang.NoSuchMethodException: java.nio.file.Path.<init>()\n    at java.lang.Class.getConstructor0 (Class.java:3082)\n    at java.lang.Class.newInstance (Class.java:412)\n    at org.codehaus.plexus.component.configurator.converters.AbstractConfigurationConverter.instantiateObject (AbstractConfigurationConverter.java:143)\n    at org.codehaus.plexus.component.configurator.converters.composite.ObjectWithFieldsConverter.fromConfiguration (ObjectWithFieldsConverter.java:54)\n    at org.eclipse.sisu.plexus.CompositeBeanHelper.convertProperty (CompositeBeanHelper.java:273)\n    at org.eclipse.sisu.plexus.CompositeBeanHelper.setProperty (CompositeBeanHelper.java:210)\n    at org.codehaus.plexus.component.configurator.converters.composite.ObjectWithFieldsConverter.processConfiguration (ObjectWithFieldsConverter.java:101)\n    at org.codehaus.plexus.component.configurator.BasicComponentConfigurator.configureComponent (BasicComponentConfigurator.java:34)\n    at org.apache.maven.plugin.internal.DefaultMavenPluginManager.populatePluginFields (DefaultMavenPluginManager.java:635)\n    at org.apache.maven.plugin.internal.DefaultMavenPluginManager.getConfiguredMojo (DefaultMavenPluginManager.java:597)\n    at org.apache.maven.plugin.DefaultBuildPluginManager.executeMojo (DefaultBuildPluginManager.java:124)\n    at org.apache.maven.lifecycle.internal.MojoExecutor.execute (MojoExecutor.java:210)\n    at org.apache.maven.lifecycle.internal.MojoExecutor.execute (MojoExecutor.java:156)\n    at org.apache.maven.lifecycle.internal.MojoExecutor.execute (MojoExecutor.java:148)\n    at org.apache.maven.lifecycle.internal.LifecycleModuleBuilder.buildProject (LifecycleModuleBuilder.java:117)\n    at org.apache.maven.lifecycle.internal.LifecycleModuleBuilder.buildProject (LifecycleModuleBuilder.java:81)\n    at org.apache.maven.lifecycle.internal.builder.singlethreaded.SingleThreadedBuilder.build (SingleThreadedBuilder.java:56)\n    at org.apache.maven.lifecycle.internal.LifecycleStarter.execute (LifecycleStarter.java:128)\n    at org.apache.maven.DefaultMaven.doExecute (DefaultMaven.java:305)\n    at org.apache.maven.DefaultMaven.doExecute (DefaultMaven.java:192)\n    at org.apache.maven.DefaultMaven.execute (DefaultMaven.java:105)\n    at org.apache.maven.cli.MavenCli.execute (MavenCli.java:957)\n    at org.apache.maven.cli.MavenCli.doMain (MavenCli.java:289)\n    at org.apache.maven.cli.MavenCli.main (MavenCli.java:193)\n    at sun.reflect.NativeMethodAccessorImpl.invoke0 (Native Method)\n    at sun.reflect.NativeMethodAccessorImpl.invoke (NativeMethodAccessorImpl.java:62)\n    at sun.reflect.DelegatingMethodAccessorImpl.invoke (DelegatingMethodAccessorImpl.java:43)\n    at java.lang.reflect.Method.invoke (Method.java:498)\n    at org.codehaus.plexus.classworlds.launcher.Launcher.launchEnhanced (Launcher.java:282)\n    at org.codehaus.plexus.classworlds.launcher.Launcher.launch (Launcher.java:225)\n    at org.codehaus.plexus.classworlds.launcher.Launcher.mainWithExitCode (Launcher.java:406)\n    at org.codehaus.plexus.classworlds.launcher.Launcher.main (Launcher.java:347)", "author": "aloubyansky", "createdAt": "2020-01-30T11:02:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg3NjM4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg4NTgzOQ==", "url": "https://github.com/quarkusio/quarkus/pull/6748#discussion_r372885839", "bodyText": "This same command works if basedir is a File.", "author": "aloubyansky", "createdAt": "2020-01-30T11:03:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg3NjM4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg4NjAwMQ==", "url": "https://github.com/quarkusio/quarkus/pull/6748#discussion_r372886001", "bodyText": "OK, thanks for checking!", "author": "geoand", "createdAt": "2020-01-30T11:03:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg3NjM4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg4Njc0OA==", "url": "https://github.com/quarkusio/quarkus/pull/6748#discussion_r372886748", "bodyText": "I also want to see if this work on Windows, but CI should give us an answer soon enough :)", "author": "geoand", "createdAt": "2020-01-30T11:05:26Z", "path": "devtools/maven/src/main/java/io/quarkus/maven/CreateExtensionMojo.java", "diffHunk": "@@ -411,123 +558,318 @@ public void execute() throws MojoExecutionException, MojoFailureException {\n         }\n \n         if (runtimeBomPath != null) {\n-            runtimeBomPath = basedir.resolve(runtimeBomPath);\n+            runtimeBomPath = basedir.toPath().resolve(runtimeBomPath);\n             if (!Files.exists(runtimeBomPath)) {\n                 throw new MojoFailureException(\"runtimeBomPath does not exist: \" + runtimeBomPath);\n             }\n         }\n         if (deploymentBomPath != null) {\n-            deploymentBomPath = basedir.resolve(deploymentBomPath);\n+            deploymentBomPath = basedir.toPath().resolve(deploymentBomPath);\n             if (!Files.exists(deploymentBomPath)) {\n                 throw new MojoFailureException(\"deploymentBomPath does not exist: \" + deploymentBomPath);\n             }\n         }\n \n-        final Charset charset = Charset.forName(encoding);\n-\n-        final Path basePomXml = basedir.resolve(\"pom.xml\");\n-        if (Files.exists(basePomXml)) {\n-            try (Reader r = Files.newBufferedReader(basePomXml, charset)) {\n-                Model basePom = new MavenXpp3Reader().read(r);\n-                if (!\"pom\".equals(basePom.getPackaging())) {\n+        charset = Charset.forName(encoding);\n+\n+        try {\n+            File rootPom = null;\n+            Model rootModel = null;\n+            boolean importDeploymentBom = true;\n+            boolean setCompilerPluginVersion = true;\n+            boolean setQuarkusVersionProp = true;\n+            if (isCurrentProjectExists()) {\n+                rootPom = getCurrentProjectPom();\n+                rootModel = MojoUtils.readPom(rootPom);\n+                if (!\"pom\".equals(rootModel.getPackaging())) {\n                     throw new MojoFailureException(\n                             \"Can add extension modules only under a project with packaging 'pom'; found: \"\n-                                    + basePom.getPackaging() + \"\");\n+                                    + rootModel.getPackaging() + \"\");\n+                }\n+\n+                if (rootPom.equals(project.getFile())) {\n+                    importDeploymentBom = !hasQuarkusDeploymentBom();\n+                    setCompilerPluginVersion = !project.getPluginManagement().getPluginsAsMap()\n+                            .containsKey(COMPILER_PLUGIN_KEY);\n+                    setQuarkusVersionProp = !project.getProperties().containsKey(QUARKUS_VERSION_PROP);\n+                } else {\n+                    // aloubyansky: not sure we should support this case and not sure it ever worked properly\n+                    // this is about creating an extension project not in the context of the current project from the Maven's plugin perspective\n+                    // kind of a pathological use-case from the Maven's perspective, imo\n+                    final DefaultArtifact rootArtifact = new DefaultArtifact(getGroupId(rootModel),\n+                            rootModel.getArtifactId(), null, rootModel.getPackaging(), getVersion(rootModel));\n+                    try {\n+                        final LocalWorkspace ws = LocalProject.loadWorkspace(rootPom.getParentFile().toPath()).getWorkspace();\n+                        final MavenArtifactResolver mvn = MavenArtifactResolver.builder()\n+                                .setRepositorySystem(MavenRepoInitializer.getRepositorySystem(repoSession.isOffline(), ws))\n+                                .setRepositorySystemSession(repoSession)\n+                                .setRemoteRepositories(repos)\n+                                .setWorkspace(LocalProject.loadWorkspace(rootPom.getParentFile().toPath()).getWorkspace())\n+                                .build();\n+                        final ArtifactDescriptorResult rootDescr = mvn.resolveDescriptor(rootArtifact);\n+                        importDeploymentBom = !hasQuarkusDeploymentBom(rootDescr.getManagedDependencies());\n+                        // TODO determine whether the compiler plugin is configured for the project\n+                        setQuarkusVersionProp = !rootDescr.getProperties().containsKey(QUARKUS_VERSION_PROP);\n+                    } catch (Exception e) {\n+                        throw new MojoExecutionException(\"Failed to resolve \" + rootArtifact + \" descriptor\", e);\n+                    }\n+                }\n+            } else if (this.grandParentRelativePath != null) {\n+                // aloubyansky: not sure we should support this case, same as above\n+                final File gpPom = getExtensionProjectBaseDir().resolve(this.grandParentRelativePath).normalize()\n+                        .toAbsolutePath().toFile();\n+                if (gpPom.exists()) {\n+                    rootPom = gpPom;\n+                    rootModel = MojoUtils.readPom(gpPom);\n+                    final DefaultArtifact rootArtifact = new DefaultArtifact(getGroupId(rootModel),\n+                            rootModel.getArtifactId(), null, rootModel.getPackaging(), getVersion(rootModel));\n+                    try {\n+                        final LocalWorkspace ws = LocalProject.loadWorkspace(rootPom.getParentFile().toPath()).getWorkspace();\n+                        final MavenArtifactResolver mvn = MavenArtifactResolver.builder()\n+                                .setRepositorySystem(MavenRepoInitializer.getRepositorySystem(repoSession.isOffline(), ws))\n+                                .setRepositorySystemSession(repoSession)\n+                                .setRemoteRepositories(repos)\n+                                .setWorkspace(ws)\n+                                .build();\n+                        final ArtifactDescriptorResult rootDescr = mvn.resolveDescriptor(rootArtifact);\n+                        importDeploymentBom = !hasQuarkusDeploymentBom(rootDescr.getManagedDependencies());\n+                        // TODO determine whether the compiler plugin is configured for the project\n+                        setQuarkusVersionProp = !rootDescr.getProperties().containsKey(QUARKUS_VERSION_PROP);\n+                    } catch (Exception e) {\n+                        throw new MojoExecutionException(\"Failed to resolve \" + rootArtifact + \" descriptor\", e);\n+                    }\n                 }\n-                addModules(basePomXml, basePom, charset);\n-            } catch (IOException e) {\n-                throw new MojoExecutionException(String.format(\"Could not read %s\", basePomXml), e);\n-            } catch (XmlPullParserException e) {\n-                throw new MojoExecutionException(String.format(\"Could not parse %s\", basePomXml), e);\n-            } catch (TemplateException e) {\n-                throw new MojoExecutionException(String.format(\"Could not process a FreeMarker template\"), e);\n             }\n-        } else {\n-            newParent(basedir);\n+\n+            final TemplateParams templateParams = getTemplateParams(rootModel);\n+            final Configuration cfg = getTemplateConfig();\n+\n+            generateExtensionProjects(cfg, templateParams);\n+            if (setQuarkusVersionProp) {\n+                setQuarkusVersionProp(getExtensionProjectBaseDir().resolve(\"pom.xml\").toFile());\n+            }\n+            if (importDeploymentBom) {\n+                addQuarkusDeploymentBom(getExtensionProjectBaseDir().resolve(\"pom.xml\").toFile());\n+            }\n+            if (setCompilerPluginVersion) {\n+                setCompilerPluginVersion(getExtensionProjectBaseDir().resolve(\"pom.xml\").toFile());\n+            }\n+            if (rootModel != null) {\n+                addModules(rootPom.toPath(), templateParams, rootModel);\n+            }\n+\n+            if (runtimeBomPath != null) {\n+                getLog().info(\n+                        String.format(\"Adding [%s] to dependencyManagement in [%s]\", templateParams.artifactId,\n+                                runtimeBomPath));\n+                List<PomTransformer.Transformation> transformations = new ArrayList<PomTransformer.Transformation>();\n+                transformations\n+                        .add(Transformation.addManagedDependency(templateParams.groupId, templateParams.artifactId,\n+                                templateParams.bomEntryVersion));\n+                for (Gavtcs gavtcs : templateParams.additionalRuntimeDependencies) {\n+                    getLog().info(String.format(\"Adding [%s] to dependencyManagement in [%s]\", gavtcs, runtimeBomPath));\n+                    transformations.add(Transformation.addManagedDependency(gavtcs));\n+                }\n+                pomTransformer(runtimeBomPath).transform(transformations);\n+            }\n+            if (deploymentBomPath != null) {\n+                final String aId = templateParams.artifactId + \"-deployment\";\n+                getLog().info(String.format(\"Adding [%s] to dependencyManagement in [%s]\", aId, deploymentBomPath));\n+                pomTransformer(deploymentBomPath)\n+                        .transform(Transformation.addManagedDependency(templateParams.groupId, aId,\n+                                templateParams.bomEntryVersion));\n+            }\n+            if (itestParentPath != null) {\n+                generateItest(cfg, templateParams);\n+            }\n+        } catch (IOException e) {\n+            throw new MojoExecutionException(String.format(\"Could not read %s\", project.getFile()), e);\n+        } catch (TemplateException e) {\n+            throw new MojoExecutionException(String.format(\"Could not process a FreeMarker template\"), e);\n         }\n     }\n \n-    void addModules(Path basePomXml, Model basePom, Charset charset)\n-            throws IOException, TemplateException, MojoFailureException, MojoExecutionException {\n+    private void setQuarkusVersionProp(File pom) throws IOException, MojoExecutionException {\n+        pomTransformer(pom.toPath()).transform(Transformation.addProperty(QUARKUS_VERSION_PROP,\n+                quarkusVersion.equals(DEFAULT_QUARKUS_VERSION) ? getPluginVersion() : quarkusVersion));\n+    }\n+\n+    private void setCompilerPluginVersion(File pom) throws IOException {\n+        pomTransformer(pom.toPath()).transform(Transformation.addProperty(COMPILER_PLUGIN_VERSION_PROP, compilerPluginVersion));\n+        pomTransformer(pom.toPath())\n+                .transform(Transformation.addManagedPlugin(\n+                        MojoUtils.plugin(COMPILER_PLUGIN_GROUP_ID, COMPILER_PLUGIN_ARTIFACT_ID,\n+                                COMPILER_PLUGIN_VERSION_POM_EXPR)));\n+    }\n+\n+    private void addQuarkusDeploymentBom(File pom) throws IOException, MojoExecutionException {\n+        addQuarkusDeploymentBom(MojoUtils.readPom(pom), pom);\n+    }\n+\n+    private void addQuarkusDeploymentBom(Model model, File file) throws IOException, MojoExecutionException {\n+        pomTransformer(file.toPath())\n+                .transform(Transformation.addManagedDependency(\n+                        new Gavtcs(platformGroupId, platformArtifactId, QUARKUS_VERSION_POM_EXPR, \"pom\", null, \"import\")));\n+    }\n \n-        final Configuration cfg = new Configuration(Configuration.VERSION_2_3_28);\n-        cfg.setTemplateExceptionHandler(TemplateExceptionHandler.RETHROW_HANDLER);\n-        cfg.setTemplateLoader(createTemplateLoader(basedir, templatesUriBase));\n-        cfg.setDefaultEncoding(charset.name());\n-        cfg.setInterpolationSyntax(Configuration.SQUARE_BRACKET_INTERPOLATION_SYNTAX);\n-        cfg.setTagSyntax(Configuration.SQUARE_BRACKET_TAG_SYNTAX);\n-\n-        TemplateParams model = new TemplateParams();\n-\n-        model.artifactId = artifactId;\n-        model.artifactIdPrefix = artifactIdPrefix;\n-        model.artifactIdBase = artifactIdBase;\n-        model.artifactIdBaseCamelCase = toCapCamelCase(model.artifactIdBase);\n-\n-        model.groupId = this.groupId != null ? this.groupId : getGroupId(basePom);\n-        model.version = this.version != null ? this.version : getVersion(basePom);\n-\n-        model.namePrefix = namePrefix;\n-        model.nameBase = nameBase;\n-        model.nameSegmentDelimiter = nameSegmentDelimiter;\n-        model.assumeManaged = detectAssumeManaged();\n-        model.quarkusVersion = quarkusVersion.replace('@', '$');\n-        model.bomEntryVersion = bomEntryVersion.replace('@', '$');\n-\n-        model.grandParentGroupId = grandParentGroupId != null ? grandParentGroupId : getGroupId(basePom);\n-        model.grandParentArtifactId = grandParentArtifactId != null ? grandParentArtifactId : basePom.getArtifactId();\n-        model.grandParentVersion = grandParentVersion != null ? grandParentVersion : getVersion(basePom);\n-        model.grandParentRelativePath = grandParentRelativePath != null ? grandParentRelativePath : \"../pom.xml\";\n-        model.javaPackageBase = javaPackageBase != null ? javaPackageBase\n-                : getJavaPackage(model.groupId, javaPackageInfix, artifactId);\n-        model.additionalRuntimeDependencies = getAdditionalRuntimeDependencies();\n-        model.runtimeBomPathSet = runtimeBomPath != null;\n-\n-        evalTemplate(cfg, \"parent-pom.xml\", basedir.resolve(model.artifactIdBase + \"/pom.xml\"), charset, model);\n-\n-        Files.createDirectories(basedir\n-                .resolve(model.artifactIdBase + \"/runtime/src/main/java/\" + model.javaPackageBase.replace('.', '/')));\n-        evalTemplate(cfg, \"runtime-pom.xml\", basedir.resolve(model.artifactIdBase + \"/runtime/pom.xml\"), charset,\n-                model);\n-\n-        evalTemplate(cfg, \"deployment-pom.xml\", basedir.resolve(model.artifactIdBase + \"/deployment/pom.xml\"), charset,\n-                model);\n-        final Path processorPath = basedir\n-                .resolve(model.artifactIdBase + \"/deployment/src/main/java/\" + model.javaPackageBase.replace('.', '/')\n-                        + \"/deployment/\" + model.artifactIdBaseCamelCase + \"Processor.java\");\n-        evalTemplate(cfg, \"Processor.java\", processorPath, charset, model);\n-\n-        if (!basePom.getModules().contains(model.artifactIdBase)) {\n-            getLog().info(String.format(\"Adding module [%s] to [%s]\", model.artifactIdBase, basePomXml));\n-            new PomTransformer(basePomXml, charset).transform(Transformation.addModule(model.artifactIdBase));\n+    private String getPluginVersion() throws MojoExecutionException {\n+        return CreateUtils.resolvePluginInfo(CreateExtensionMojo.class).getVersion();\n+    }\n+\n+    private boolean hasQuarkusDeploymentBom() {\n+        if (project.getDependencyManagement() == null) {\n+            return false;\n         }\n-        if (runtimeBomPath != null) {\n-            getLog().info(\n-                    String.format(\"Adding [%s] to dependencyManagement in [%s]\", model.artifactId, runtimeBomPath));\n-            List<PomTransformer.Transformation> transformations = new ArrayList<PomTransformer.Transformation>();\n-            transformations\n-                    .add(Transformation.addManagedDependency(model.groupId, model.artifactId, model.bomEntryVersion));\n-            for (Gavtcs gavtcs : model.additionalRuntimeDependencies) {\n-                getLog().info(String.format(\"Adding [%s] to dependencyManagement in [%s]\", gavtcs, runtimeBomPath));\n-                transformations.add(Transformation.addManagedDependency(gavtcs));\n+        for (org.apache.maven.model.Dependency dep : project.getDependencyManagement().getDependencies()) {\n+            if (dep.getArtifactId().equals(\"quarkus-core-deployment\")\n+                    && dep.getGroupId().equals(\"io.quarkus\")) {\n+                // this is not a 100% accurate check but practically valid\n+                return true;\n             }\n-            new PomTransformer(runtimeBomPath, charset).transform(transformations);\n         }\n-        if (deploymentBomPath != null) {\n-            final String aId = model.artifactId + \"-deployment\";\n-            getLog().info(String.format(\"Adding [%s] to dependencyManagement in [%s]\", aId, deploymentBomPath));\n-            new PomTransformer(deploymentBomPath, charset)\n-                    .transform(Transformation.addManagedDependency(model.groupId, aId, model.bomEntryVersion));\n+        return false;\n+    }\n+\n+    private boolean hasQuarkusDeploymentBom(List<Dependency> deps) {\n+        if (deps == null) {\n+            return false;\n+        }\n+        for (Dependency dep : deps) {\n+            if (dep.getArtifact().getArtifactId().equals(\"quarkus-core-deployment\")\n+                    && dep.getArtifact().getGroupId().equals(\"io.quarkus\")) {\n+                // this is not a 100% accurate check but practically valid\n+                return true;\n+            }\n+        }\n+        return false;\n+    }\n+\n+    /**\n+     * @return true if the goal is executed in an existing project\n+     */\n+    private boolean isCurrentProjectExists() {\n+        return currentProjectIsBaseDir ? project.getFile() != null\n+                : Files.exists(basedir.toPath().resolve(\"pom.xml\"));\n+    }\n+\n+    private File getCurrentProjectPom() {\n+        if (currentProjectIsBaseDir) {\n+            return project.getFile() == null ? new File(project.getBasedir(), \"pom.xml\") : project.getFile();\n         }\n-        if (itestParentPath != null) {\n-            generateItest(cfg, charset, model);\n+        return new File(basedir, \"pom.xml\");\n+    }\n+\n+    private Path getExtensionProjectBaseDir() {\n+        if (currentProjectIsBaseDir) {\n+            return project.getBasedir() == null ? basedir.toPath().resolve(artifactIdBase)\n+                    : project.getBasedir().toPath().resolve(artifactIdBase);\n         }\n+        return new File(basedir, artifactIdBase).toPath();\n+    }\n+\n+    private Path getExtensionRuntimeBaseDir() {\n+        return getExtensionProjectBaseDir().resolve(\"runtime\");\n+    }\n \n+    private Path getExtensionDeploymentBaseDir() {\n+        return getExtensionProjectBaseDir().resolve(\"deployment\");\n     }\n \n-    void generateItest(Configuration cfg, Charset charset, TemplateParams model)\n-            throws MojoFailureException, MojoExecutionException, TemplateException {\n-        final Path itestParentAbsPath = basedir.resolve(itestParentPath).toAbsolutePath();\n+    void addModules(Path basePomXml, TemplateParams templateParams, Model basePom)\n+            throws IOException, TemplateException, MojoFailureException, MojoExecutionException {\n+        if (!basePom.getModules().contains(templateParams.artifactIdBase)) {\n+            getLog().info(String.format(\"Adding module [%s] to [%s]\", templateParams.artifactIdBase, basePomXml));\n+            pomTransformer(basePomXml).transform(Transformation.addModule(templateParams.artifactIdBase));\n+        }\n+    }\n+\n+    private void generateExtensionProjects(Configuration cfg, TemplateParams templateParams)\n+            throws IOException, TemplateException, MojoExecutionException {\n+        evalTemplate(cfg, \"parent-pom.xml\", getExtensionProjectBaseDir().resolve(\"pom.xml\"), templateParams);\n+\n+        Files.createDirectories(\n+                getExtensionRuntimeBaseDir().resolve(\"src/main/java\")", "originalCommit": "4d99b2e523e25e83aaa6c2f040f5e1e850ea3d54", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}