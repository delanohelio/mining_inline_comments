{"pr_number": 12986, "pr_title": "Implemented opaque/binary token integration test", "pr_createdAt": "2020-10-27T19:03:34Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/12986", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM3OTE0NQ==", "url": "https://github.com/quarkusio/quarkus/pull/12986#discussion_r513379145", "bodyText": "@cemnura We need to return a different token value (say 456) here and differentiate an introspection response, see more on it below", "author": "sberyozkin", "createdAt": "2020-10-28T11:46:25Z", "path": "integration-tests/oidc-mock/src/test/java/io/quarkus/it/keycloak/BearerOpaqueTokenAuthorizationTest.java", "diffHunk": "@@ -0,0 +1,80 @@\n+package io.quarkus.it.keycloak;\n+\n+import static org.hamcrest.Matchers.equalTo;\n+\n+import java.time.Instant;\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+import org.hamcrest.Matchers;\n+import org.junit.jupiter.api.Disabled;\n+import org.junit.jupiter.api.Test;\n+\n+import io.quarkus.test.common.QuarkusTestResource;\n+import io.quarkus.test.junit.QuarkusTest;\n+import io.restassured.RestAssured;\n+import io.smallrye.jwt.build.Jwt;\n+\n+/**\n+ * @author <a href=\"mailto:psilva@redhat.com\">Pedro Igor</a>\n+ */\n+@QuarkusTest\n+@QuarkusTestResource(KeycloakTestResource.class)\n+public class BearerOpaqueTokenAuthorizationTest {\n+\n+    @Test\n+    public void testSecureAccessSuccessPreferredUsername() {\n+        for (String username : Arrays.asList(\"alice\", \"jdoe\", \"admin\")) {\n+            RestAssured.given().auth().oauth2(getAccessToken(username, new HashSet<>(Arrays.asList(\"user\", \"admin\"))))\n+                    .when().get(\"/api/users/preferredUserName\")\n+                    .then()\n+                    .statusCode(200)\n+                    .body(\"userName\", equalTo(username));\n+        }\n+    }\n+\n+    @Test\n+    public void testAccessAdminResource() {\n+        RestAssured.given().auth().oauth2(getAccessToken(\"admin\", new HashSet<>(Arrays.asList(\"admin\"))))\n+                .when().get(\"/api/admin\")\n+                .then()\n+                .statusCode(200)\n+                .body(Matchers.containsString(\"granted:admin\"));\n+    }\n+\n+    @Test\n+    public void testDeniedAccessAdminResource() {\n+        RestAssured.given().auth().oauth2(getAccessToken(\"alice\", new HashSet<>(Arrays.asList(\"user\"))))\n+                .when().get(\"/api/admin\")\n+                .then()\n+                .statusCode(403);\n+    }\n+\n+    @Test\n+    public void testDeniedNoBearerToken() {\n+        RestAssured.given()\n+                .when().get(\"/api/users/me\").then()\n+                .statusCode(401);\n+    }\n+\n+    @Test", "originalCommit": "e92b75f997cb5c3fc07923d9dd092d204f6e259b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM4MjA5MQ==", "url": "https://github.com/quarkusio/quarkus/pull/12986#discussion_r513382091", "bodyText": "@cemnura what should be done here is to check if the incoming token is equal to 123 and if yes then return this response, it should be done anyway, without the expired token check, as it has to be tested that it is indeed a 123 token which is being introspected.\nOnce it works then it will be easy to check if this token is equal to 456 and if yes then return the response with the expired value set to some low value, less than the issued at time etc :-)", "author": "sberyozkin", "createdAt": "2020-10-28T11:51:47Z", "path": "integration-tests/oidc-mock/src/test/java/io/quarkus/it/keycloak/KeycloakTestResource.java", "diffHunk": "@@ -0,0 +1,59 @@\n+package io.quarkus.it.keycloak;\n+\n+import static com.github.tomakehurst.wiremock.client.WireMock.aResponse;\n+import static com.github.tomakehurst.wiremock.client.WireMock.get;\n+import static com.github.tomakehurst.wiremock.client.WireMock.urlEqualTo;\n+\n+import java.util.Collections;\n+import java.util.Map;\n+\n+import javax.ws.rs.core.MediaType;\n+\n+import org.jboss.logging.Logger;\n+\n+import com.github.tomakehurst.wiremock.WireMockServer;\n+import com.github.tomakehurst.wiremock.client.WireMock;\n+\n+import io.quarkus.test.common.QuarkusTestResourceLifecycleManager;\n+\n+public class KeycloakTestResource implements QuarkusTestResourceLifecycleManager {\n+\n+    private static final Logger LOG = Logger.getLogger(KeycloakTestResource.class);\n+\n+    private WireMockServer server;\n+\n+    @Override\n+    public Map<String, String> start() {\n+\n+        server = new WireMockServer();\n+        server.start();\n+\n+        WireMock.stubFor(\n+                get(urlEqualTo(\"/auth/realms/quarkus/.well-known/openid-configuration\"))\n+                        .willReturn(aResponse()\n+                                .withHeader(\"Content-Type\", MediaType.APPLICATION_JSON)\n+                                .withBody(\"{\\n\" +\n+                                        \"    \\\"introspection_path\\\": \\\"\" + server.baseUrl()\n+                                        + \"/auth/realms/quarkus/protocol/openid-connect/token/introspect\\\"\\n\" +\n+                                        \"}\")));\n+\n+        // define the mock for the introspect endpoint\n+        WireMock.stubFor(WireMock.post(\"/auth/realms/quarkus/protocol/openid-connect/token/introspect\").willReturn(WireMock", "originalCommit": "e92b75f997cb5c3fc07923d9dd092d204f6e259b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAyMTA1Nw==", "url": "https://github.com/quarkusio/quarkus/pull/12986#discussion_r517021057", "bodyText": "I think I got it.\nWhen there is a Authorization header with a value equal to 123 is sent then the current valid response is returned. In other cases then the response returns the response with the expired value set to some low value.", "author": "cemnura", "createdAt": "2020-11-03T23:48:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM4MjA5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQzNjc4Ng==", "url": "https://github.com/quarkusio/quarkus/pull/12986#discussion_r517436786", "bodyText": "Hi @cemnura it will be in a POST body: token=123 etc", "author": "sberyozkin", "createdAt": "2020-11-04T15:41:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM4MjA5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk1ODQxNw==", "url": "https://github.com/quarkusio/quarkus/pull/12986#discussion_r512958417", "bodyText": "Introspection mock similar to what @loicmathieu did.\nThis introspection url is learned from /auth/realms/quarkus/.well-known/openid-configuration discovery", "author": "cemnura", "createdAt": "2020-10-27T19:11:51Z", "path": "integration-tests/oidc-mock/src/test/java/io/quarkus/it/keycloak/KeycloakTestResource.java", "diffHunk": "@@ -0,0 +1,59 @@\n+package io.quarkus.it.keycloak;\n+\n+import static com.github.tomakehurst.wiremock.client.WireMock.aResponse;\n+import static com.github.tomakehurst.wiremock.client.WireMock.get;\n+import static com.github.tomakehurst.wiremock.client.WireMock.urlEqualTo;\n+\n+import java.util.Collections;\n+import java.util.Map;\n+\n+import javax.ws.rs.core.MediaType;\n+\n+import org.jboss.logging.Logger;\n+\n+import com.github.tomakehurst.wiremock.WireMockServer;\n+import com.github.tomakehurst.wiremock.client.WireMock;\n+\n+import io.quarkus.test.common.QuarkusTestResourceLifecycleManager;\n+\n+public class KeycloakTestResource implements QuarkusTestResourceLifecycleManager {\n+\n+    private static final Logger LOG = Logger.getLogger(KeycloakTestResource.class);\n+\n+    private WireMockServer server;\n+\n+    @Override\n+    public Map<String, String> start() {\n+\n+        server = new WireMockServer();\n+        server.start();\n+\n+        WireMock.stubFor(\n+                get(urlEqualTo(\"/auth/realms/quarkus/.well-known/openid-configuration\"))\n+                        .willReturn(aResponse()\n+                                .withHeader(\"Content-Type\", MediaType.APPLICATION_JSON)\n+                                .withBody(\"{\\n\" +\n+                                        \"    \\\"introspection_path\\\": \\\"\" + server.baseUrl()\n+                                        + \"/auth/realms/quarkus/protocol/openid-connect/token/introspect\\\"\\n\" +\n+                                        \"}\")));\n+\n+        // define the mock for the introspect endpoint\n+        WireMock.stubFor(WireMock.post(\"/auth/realms/quarkus/protocol/openid-connect/token/introspect\").willReturn(WireMock\n+                .aResponse()\n+                .withBody(\n+                        \"{\\\"active\\\":true,\\\"scope\\\":\\\"user admin\\\",\\\"username\\\":\\\"alice\\\",\\\"iat\\\":1562315654,\\\"exp\\\":1562317454,\\\"expires_in\\\":1458,\\\"client_id\\\":\\\"my_client_id\\\"}\")));", "originalCommit": "e92b75f997cb5c3fc07923d9dd092d204f6e259b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk1ODcwNw==", "url": "https://github.com/quarkusio/quarkus/pull/12986#discussion_r512958707", "bodyText": "Discovery mock that notifies quarkus the introspection_path", "author": "cemnura", "createdAt": "2020-10-27T19:12:20Z", "path": "integration-tests/oidc-mock/src/test/java/io/quarkus/it/keycloak/KeycloakTestResource.java", "diffHunk": "@@ -0,0 +1,59 @@\n+package io.quarkus.it.keycloak;\n+\n+import static com.github.tomakehurst.wiremock.client.WireMock.aResponse;\n+import static com.github.tomakehurst.wiremock.client.WireMock.get;\n+import static com.github.tomakehurst.wiremock.client.WireMock.urlEqualTo;\n+\n+import java.util.Collections;\n+import java.util.Map;\n+\n+import javax.ws.rs.core.MediaType;\n+\n+import org.jboss.logging.Logger;\n+\n+import com.github.tomakehurst.wiremock.WireMockServer;\n+import com.github.tomakehurst.wiremock.client.WireMock;\n+\n+import io.quarkus.test.common.QuarkusTestResourceLifecycleManager;\n+\n+public class KeycloakTestResource implements QuarkusTestResourceLifecycleManager {\n+\n+    private static final Logger LOG = Logger.getLogger(KeycloakTestResource.class);\n+\n+    private WireMockServer server;\n+\n+    @Override\n+    public Map<String, String> start() {\n+\n+        server = new WireMockServer();\n+        server.start();\n+\n+        WireMock.stubFor(\n+                get(urlEqualTo(\"/auth/realms/quarkus/.well-known/openid-configuration\"))\n+                        .willReturn(aResponse()\n+                                .withHeader(\"Content-Type\", MediaType.APPLICATION_JSON)\n+                                .withBody(\"{\\n\" +\n+                                        \"    \\\"introspection_path\\\": \\\"\" + server.baseUrl()\n+                                        + \"/auth/realms/quarkus/protocol/openid-connect/token/introspect\\\"\\n\" +\n+                                        \"}\")));", "originalCommit": "e92b75f997cb5c3fc07923d9dd092d204f6e259b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b8b8e70e5a9e6c8efff1b9f30b85b927dd9949a3", "url": "https://github.com/quarkusio/quarkus/commit/b8b8e70e5a9e6c8efff1b9f30b85b927dd9949a3", "message": "[WIP] Implemented opaque/binary token integration test\n\nSigned-off-by: Cem Nura <cem.nura@gmail.com>", "committedDate": "2020-11-03T23:46:06Z", "type": "forcePushed"}, {"oid": "0c6d698826761f26c0a2f667c8581c014a3195d1", "url": "https://github.com/quarkusio/quarkus/commit/0c6d698826761f26c0a2f667c8581c014a3195d1", "message": "[WIP] Implemented opaque/binary token integration test\n\nSigned-off-by: Cem Nura <cem.nura@gmail.com>", "committedDate": "2020-11-04T00:02:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ0MDQ0Mw==", "url": "https://github.com/quarkusio/quarkus/pull/12986#discussion_r517440443", "bodyText": "@cemnura Can we have a different KeycloakTestResource for the introspection endpoint, we need to keep it simple for the users :-), i.e, if the users want to test JWT, they don't need to set the introspection path (in most cases) and likewise for the opaque tokens. Please add KeycloakOpaqueTokenTestResource instead", "author": "sberyozkin", "createdAt": "2020-11-04T15:46:07Z", "path": "integration-tests/oidc-wiremock/src/test/java/io/quarkus/it/keycloak/KeycloakTestResource.java", "diffHunk": "@@ -34,8 +36,9 @@\n                                 .withHeader(\"Content-Type\", MediaType.APPLICATION_JSON)\n                                 .withBody(\"{\\n\" +\n                                         \"    \\\"jwks_uri\\\": \\\"\" + server.baseUrl()\n-                                        + \"/auth/realms/quarkus/protocol/openid-connect/certs\\\"\\n\"\n-                                        +\n+                                        + \"/auth/realms/quarkus/protocol/openid-connect/certs\\\",\\n\" +\n+                                        \"    \\\"introspection_path\\\": \\\"\" + server.baseUrl()\n+                                        + \"/auth/realms/quarkus/protocol/openid-connect/token/introspect\\\"\\n\" +", "originalCommit": "0c6d698826761f26c0a2f667c8581c014a3195d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY4MTgzMg==", "url": "https://github.com/quarkusio/quarkus/pull/12986#discussion_r517681832", "bodyText": "Sounds great. Added KeycloakOpaqueTokenTestResource.", "author": "cemnura", "createdAt": "2020-11-04T23:00:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ0MDQ0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ0MTEyNw==", "url": "https://github.com/quarkusio/quarkus/pull/12986#discussion_r517441127", "bodyText": "It is not in the header, but in the POST payload", "author": "sberyozkin", "createdAt": "2020-11-04T15:47:03Z", "path": "integration-tests/oidc-wiremock/src/test/java/io/quarkus/it/keycloak/KeycloakTestResource.java", "diffHunk": "@@ -54,6 +57,21 @@\n                                         \"  ]\\n\" +\n                                         \"}\")));\n \n+        // define the mock for the introspect endpoint\n+        WireMock.stubFor(WireMock.post(\"/auth/realms/quarkus/protocol/openid-connect/token/introspect\")", "originalCommit": "0c6d698826761f26c0a2f667c8581c014a3195d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY4MjEzOQ==", "url": "https://github.com/quarkusio/quarkus/pull/12986#discussion_r517682139", "bodyText": "My bad. Converted to body payload.", "author": "cemnura", "createdAt": "2020-11-04T23:01:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ0MTEyNw=="}], "type": "inlineReview"}, {"oid": "f59ca687ee0bb02010fa0a69161fdca11172f0dd", "url": "https://github.com/quarkusio/quarkus/commit/f59ca687ee0bb02010fa0a69161fdca11172f0dd", "message": "[WIP] Implemented opaque/binary token integration test\n\nSigned-off-by: Cem Nura <cem.nura@gmail.com>", "committedDate": "2020-11-05T23:25:08Z", "type": "forcePushed"}, {"oid": "979da8a3ca93512fa8a591dfaefd1aed34533be2", "url": "https://github.com/quarkusio/quarkus/commit/979da8a3ca93512fa8a591dfaefd1aed34533be2", "message": "Implemented opaque/binary token integration test\n\nSigned-off-by: Cem Nura <cem.nura@gmail.com>", "committedDate": "2020-11-10T22:31:49Z", "type": "forcePushed"}, {"oid": "3041f5c2b0162000d23e2963a2cbe4dd7b96227e", "url": "https://github.com/quarkusio/quarkus/commit/3041f5c2b0162000d23e2963a2cbe4dd7b96227e", "message": "Changed OIDC discovery doc property\n\nSigned-off-by: Cem Nura <cem.nura@gmail.com>", "committedDate": "2020-12-10T23:11:54Z", "type": "forcePushed"}, {"oid": "57f44f4a8f1c2551fb415c8558bb0fc8fab83236", "url": "https://github.com/quarkusio/quarkus/commit/57f44f4a8f1c2551fb415c8558bb0fc8fab83236", "message": "Added Opaque endpoint to be able to test opaque test\n\nSigned-off-by: Cem Nura <cem.nura@gmail.com>", "committedDate": "2020-12-22T22:17:02Z", "type": "forcePushed"}, {"oid": "142f617e48811ce49a0aa15eef82e9ae77de6f93", "url": "https://github.com/quarkusio/quarkus/commit/142f617e48811ce49a0aa15eef82e9ae77de6f93", "message": "Added Opaque endpoint to be able to test opaque test\n\nSigned-off-by: Cem Nura <cem.nura@gmail.com>", "committedDate": "2020-12-22T22:21:51Z", "type": "forcePushed"}, {"oid": "a978bb9c564a375841b8e183fd102426fb115e67", "url": "https://github.com/quarkusio/quarkus/commit/a978bb9c564a375841b8e183fd102426fb115e67", "message": "Added Opaque endpoint to be able to test opaque test\n\nSigned-off-by: Cem Nura <cem.nura@gmail.com>", "committedDate": "2020-12-22T23:41:58Z", "type": "forcePushed"}, {"oid": "05254a700c4cffed4be01758fd10c8688bd6e1e4", "url": "https://github.com/quarkusio/quarkus/commit/05254a700c4cffed4be01758fd10c8688bd6e1e4", "message": "Implemented opaque/binary token integration test\n\nSigned-off-by: Cem Nura <cem.nura@gmail.com>", "committedDate": "2020-12-23T00:06:14Z", "type": "commit"}, {"oid": "05254a700c4cffed4be01758fd10c8688bd6e1e4", "url": "https://github.com/quarkusio/quarkus/commit/05254a700c4cffed4be01758fd10c8688bd6e1e4", "message": "Implemented opaque/binary token integration test\n\nSigned-off-by: Cem Nura <cem.nura@gmail.com>", "committedDate": "2020-12-23T00:06:14Z", "type": "forcePushed"}]}