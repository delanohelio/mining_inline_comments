{"pr_number": 10428, "pr_title": "Add a doc workflow", "pr_createdAt": "2020-07-02T12:29:35Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/10428", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk2OTM3MQ==", "url": "https://github.com/quarkusio/quarkus/pull/10428#discussion_r448969371", "bodyText": "Why a specific mvn settings?", "author": "gsmet", "createdAt": "2020-07-02T12:37:00Z", "path": ".github/workflows/doc-build.yml", "diffHunk": "@@ -0,0 +1,61 @@\n+name: Quarkus Documentation CI\n+\n+on:\n+  push:\n+    paths:\n+      - 'docs/src/main/asciidoc/**'\n+  pull_request:\n+    paths:\n+      - 'docs/src/main/asciidoc/**'\n+\n+\n+jobs:\n+  build-doc:\n+    name: \"Documentation Build\"\n+    runs-on: ubuntu-latest\n+    # Skip draft PRs and those with WIP in the subject, rerun as soon as its removed\n+    if: \"github.event_name != 'pull_request' || ( \\\n+             github.event.pull_request.draft == false && \\\n+             github.event.pull_request.state != 'closed' && \\\n+             contains(github.event.pull_request.title, 'wip ') == false && \\\n+             contains(github.event.pull_request.title, '[wip]') == false && \\\n+             (\n+               github.event.action != 'edited' || \\\n+               contains(github.event.changes.title.from, 'wip ') || \\\n+               contains(github.event.changes.title.from, '[wip]') \\\n+             ) \\\n+           )\"\n+    steps:\n+      - uses: actions/checkout@v2\n+      - uses: n1hility/cancel-previous-runs@v2\n+        with:\n+          token: ${{ secrets.GITHUB_TOKEN }}\n+      - name: Set up JDK 11\n+        # Uses sha for added security since tags can be updated\n+        uses: joschi/setup-jdk@b9cc6eabf7e7e3889766b5cee486f874c9e1bd2d\n+        with:\n+          java-version: 11\n+      - name: Compute cache restore key\n+        # Always recompute on a push so that the maven repo doesnt grow indefinitely with old versions\n+        run: |\n+          if ${{ github.event_name == 'pull_request' }}; then echo \"::set-env name=COMPUTED_RESTORE_KEY::q2maven-\"; fi\n+      - name: Cache Maven Repository\n+        id: cache-maven\n+        uses: n1hility/cache@v2\n+        with:\n+          path: ~/.m2/repository\n+          # Improves the reusability of the cache to limit key changes\n+          key: q2maven-${{ hashFiles('bom/runtime/pom.xml') }}\n+          restore-keys: ${{ env.COMPUTED_RESTORE_KEY }}\n+          restore-only: ${{ github.event_name == 'pull_request' }}\n+      - name: Build\n+        run: |\n+          mvn -e -B --settings .github/doc-mvn-settings.xml clean package -pl docs", "originalCommit": "a87d807bd574f1ac429dcad3cb49c710c60a3e00", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk3MTgzMw==", "url": "https://github.com/quarkusio/quarkus/pull/10428#discussion_r448971833", "bodyText": "To include the Sonatype repo to download Quarkus snapshots instead of building the full platform", "author": "loicmathieu", "createdAt": "2020-07-02T12:41:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk2OTM3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk3NjczMw==", "url": "https://github.com/quarkusio/quarkus/pull/10428#discussion_r448976733", "bodyText": "Why would you need the snapshots to build the doc?", "author": "gsmet", "createdAt": "2020-07-02T12:49:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk2OTM3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk3NzcwNQ==", "url": "https://github.com/quarkusio/quarkus/pull/10428#discussion_r448977705", "bodyText": "if it's about the AllConfigGenerator, I think I would just run the Asciidoctor plugin for this step.", "author": "gsmet", "createdAt": "2020-07-02T12:51:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk2OTM3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAwNzIwNQ==", "url": "https://github.com/quarkusio/quarkus/pull/10428#discussion_r449007205", "bodyText": "It also needs some quarkus plugin. I'll have a look, if I direclty use the asciidoctor plugin maybe it's not needed", "author": "loicmathieu", "createdAt": "2020-07-02T13:37:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk2OTM3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAxMDAzNg==", "url": "https://github.com/quarkusio/quarkus/pull/10428#discussion_r449010036", "bodyText": "The doc project uses the extension processor so we need the snapshot repo or the pom.xml will not be usable.\nFailed to collect dependencies at io.quarkus:quarkus-extension-processor:jar:999-SNAPSHOT", "author": "loicmathieu", "createdAt": "2020-07-02T13:41:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk2OTM3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAxMjY1Mw==", "url": "https://github.com/quarkusio/quarkus/pull/10428#discussion_r449012653", "bodyText": "As there is two Quarkus depedencies inside the doc pom.xml there is no choice. Even if I launch the asciidoc plugin manually there will be some dependency resolution so I will need a repository to fetch the snapshots.", "author": "loicmathieu", "createdAt": "2020-07-02T13:45:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk2OTM3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAyODY4Mg==", "url": "https://github.com/quarkusio/quarkus/pull/10428#discussion_r449028682", "bodyText": "I just tested and using directly the plugin skip the dependencies downloading so it works without a dedicated Maven settings.\nAnd the Job is now executed in less than a minute, see https://github.com/quarkusio/quarkus/pull/10428/checks?check_run_id=830891662.\nIf it's OK, I'll remove the fake doc upgrade and finalize this PR.", "author": "loicmathieu", "createdAt": "2020-07-02T14:08:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk2OTM3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk2OTY1MA==", "url": "https://github.com/quarkusio/quarkus/pull/10428#discussion_r448969650", "bodyText": "I wonder if we should avoid storing the cache, given there's a good chance it won't bring anything useful.", "author": "gsmet", "createdAt": "2020-07-02T12:37:32Z", "path": ".github/workflows/doc-build.yml", "diffHunk": "@@ -0,0 +1,61 @@\n+name: Quarkus Documentation CI\n+\n+on:\n+  push:\n+    paths:\n+      - 'docs/src/main/asciidoc/**'\n+  pull_request:\n+    paths:\n+      - 'docs/src/main/asciidoc/**'\n+\n+\n+jobs:\n+  build-doc:\n+    name: \"Documentation Build\"\n+    runs-on: ubuntu-latest\n+    # Skip draft PRs and those with WIP in the subject, rerun as soon as its removed\n+    if: \"github.event_name != 'pull_request' || ( \\\n+             github.event.pull_request.draft == false && \\\n+             github.event.pull_request.state != 'closed' && \\\n+             contains(github.event.pull_request.title, 'wip ') == false && \\\n+             contains(github.event.pull_request.title, '[wip]') == false && \\\n+             (\n+               github.event.action != 'edited' || \\\n+               contains(github.event.changes.title.from, 'wip ') || \\\n+               contains(github.event.changes.title.from, '[wip]') \\\n+             ) \\\n+           )\"\n+    steps:\n+      - uses: actions/checkout@v2\n+      - uses: n1hility/cancel-previous-runs@v2\n+        with:\n+          token: ${{ secrets.GITHUB_TOKEN }}\n+      - name: Set up JDK 11\n+        # Uses sha for added security since tags can be updated\n+        uses: joschi/setup-jdk@b9cc6eabf7e7e3889766b5cee486f874c9e1bd2d\n+        with:\n+          java-version: 11\n+      - name: Compute cache restore key\n+        # Always recompute on a push so that the maven repo doesnt grow indefinitely with old versions\n+        run: |\n+          if ${{ github.event_name == 'pull_request' }}; then echo \"::set-env name=COMPUTED_RESTORE_KEY::q2maven-\"; fi\n+      - name: Cache Maven Repository\n+        id: cache-maven\n+        uses: n1hility/cache@v2\n+        with:\n+          path: ~/.m2/repository\n+          # Improves the reusability of the cache to limit key changes\n+          key: q2maven-${{ hashFiles('bom/runtime/pom.xml') }}\n+          restore-keys: ${{ env.COMPUTED_RESTORE_KEY }}\n+          restore-only: ${{ github.event_name == 'pull_request' }}\n+      - name: Build\n+        run: |\n+          mvn -e -B --settings .github/doc-mvn-settings.xml clean package -pl docs\n+      - name: Tar Maven Repo\n+        shell: bash\n+        run: tar -czf maven-repo.tgz -C ~ .m2/repository\n+      - name: Persist Maven Repo\n+        uses: actions/upload-artifact@v1\n+        with:\n+          name: maven-repo\n+          path: maven-repo.tgz", "originalCommit": "a87d807bd574f1ac429dcad3cb49c710c60a3e00", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk3MjM3NA==", "url": "https://github.com/quarkusio/quarkus/pull/10428#discussion_r448972374", "bodyText": "Without cache, the downloading of all the JARs needed for the plugins took multiple minutes", "author": "loicmathieu", "createdAt": "2020-07-02T12:42:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk2OTY1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk3ODMxNw==", "url": "https://github.com/quarkusio/quarkus/pull/10428#discussion_r448978317", "bodyText": "I'm not saying to not use the cache. I'm saying to not push it. We can reuse the one we usually have around but not push it.\nAlso I think just executing the Asciidoctor plugin might help.", "author": "gsmet", "createdAt": "2020-07-02T12:52:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk2OTY1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk3ODU4Ng==", "url": "https://github.com/quarkusio/quarkus/pull/10428#discussion_r448978586", "bodyText": "Also, we definitely don't want to pollute the cache with snapshots.", "author": "gsmet", "createdAt": "2020-07-02T12:52:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk2OTY1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAyNzEyNQ==", "url": "https://github.com/quarkusio/quarkus/pull/10428#discussion_r449027125", "bodyText": "Removed the upload of the cache", "author": "loicmathieu", "createdAt": "2020-07-02T14:05:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk2OTY1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk3MDA5MA==", "url": "https://github.com/quarkusio/quarkus/pull/10428#discussion_r448970090", "bodyText": "I think I would run it anyway in this case so that we can have early feedback on the doc. Usually, that's not the doc that is the issue.", "author": "gsmet", "createdAt": "2020-07-02T12:38:16Z", "path": ".github/workflows/doc-build.yml", "diffHunk": "@@ -0,0 +1,61 @@\n+name: Quarkus Documentation CI\n+\n+on:\n+  push:\n+    paths:\n+      - 'docs/src/main/asciidoc/**'\n+  pull_request:\n+    paths:\n+      - 'docs/src/main/asciidoc/**'\n+\n+\n+jobs:\n+  build-doc:\n+    name: \"Documentation Build\"\n+    runs-on: ubuntu-latest\n+    # Skip draft PRs and those with WIP in the subject, rerun as soon as its removed\n+    if: \"github.event_name != 'pull_request' || ( \\\n+             github.event.pull_request.draft == false && \\\n+             github.event.pull_request.state != 'closed' && \\\n+             contains(github.event.pull_request.title, 'wip ') == false && \\\n+             contains(github.event.pull_request.title, '[wip]') == false && \\\n+             (\n+               github.event.action != 'edited' || \\\n+               contains(github.event.changes.title.from, 'wip ') || \\\n+               contains(github.event.changes.title.from, '[wip]') \\\n+             ) \\\n+           )\"", "originalCommit": "a87d807bd574f1ac429dcad3cb49c710c60a3e00", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk3MzM5Ng==", "url": "https://github.com/quarkusio/quarkus/pull/10428#discussion_r448973396", "bodyText": "Yes, this could be a good thing as it could catch Maven mis-configuration earlier. As I launch a build from the root directory it still reads all pom even if it only launch the build on the doc thanks to -pl docs.", "author": "loicmathieu", "createdAt": "2020-07-02T12:44:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk3MDA5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAyNzI0NQ==", "url": "https://github.com/quarkusio/quarkus/pull/10428#discussion_r449027245", "bodyText": "Done", "author": "loicmathieu", "createdAt": "2020-07-02T14:06:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk3MDA5MA=="}], "type": "inlineReview"}, {"oid": "89de645a66efbef726cef23b3b6e4877945c7216", "url": "https://github.com/quarkusio/quarkus/commit/89de645a66efbef726cef23b3b6e4877945c7216", "message": "WIP : fake FAQ", "committedDate": "2020-07-02T13:55:15Z", "type": "forcePushed"}, {"oid": "92288ca5cae2f097059a87b79e7cb2c414591be9", "url": "https://github.com/quarkusio/quarkus/commit/92288ca5cae2f097059a87b79e7cb2c414591be9", "message": "Add a doc workflow", "committedDate": "2020-07-02T14:44:10Z", "type": "commit"}, {"oid": "92288ca5cae2f097059a87b79e7cb2c414591be9", "url": "https://github.com/quarkusio/quarkus/commit/92288ca5cae2f097059a87b79e7cb2c414591be9", "message": "Add a doc workflow", "committedDate": "2020-07-02T14:44:10Z", "type": "forcePushed"}]}