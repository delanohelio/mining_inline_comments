{"pr_number": 12030, "pr_title": "Multi project codestart", "pr_createdAt": "2020-09-10T13:42:29Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/12030", "timeline": [{"oid": "d89f949c4b133590d9e5f57008aa83124f1ed28e", "url": "https://github.com/quarkusio/quarkus/commit/d89f949c4b133590d9e5f57008aa83124f1ed28e", "message": "Activate IT tests in devtools integration-tests\n\nand rename Generate and Prepare to Test since they are closer to unit test than IT", "committedDate": "2020-09-10T13:45:27Z", "type": "forcePushed"}, {"oid": "0ce84c932ae33879007e4420bd5b89450363f2b2", "url": "https://github.com/quarkusio/quarkus/commit/0ce84c932ae33879007e4420bd5b89450363f2b2", "message": "Activate IT tests in devtools integration-tests\n\nand rename Generate and Prepare to Test since they are closer to unit test than IT", "committedDate": "2020-09-10T16:39:08Z", "type": "forcePushed"}, {"oid": "b83daa4698c129c6a0fada791cacaebc3cb21ad7", "url": "https://github.com/quarkusio/quarkus/commit/b83daa4698c129c6a0fada791cacaebc3cb21ad7", "message": "Activate IT tests in devtools integration-tests\n\nand rename Generate and Prepare to Test since they are closer to unit test than IT", "committedDate": "2020-09-11T08:42:20Z", "type": "forcePushed"}, {"oid": "18ab386bc5890ab99c0e545c2062b8ff005ab4d7", "url": "https://github.com/quarkusio/quarkus/commit/18ab386bc5890ab99c0e545c2062b8ff005ab4d7", "message": "Activate IT tests in devtools integration-tests\n\nand rename Generate and Prepare to Test since they are closer to unit test than IT", "committedDate": "2020-09-11T11:19:01Z", "type": "forcePushed"}, {"oid": "d13ba4dd2e7eafe26df5db183d593c1d518f40c6", "url": "https://github.com/quarkusio/quarkus/commit/d13ba4dd2e7eafe26df5db183d593c1d518f40c6", "message": "Multiproject codestarts", "committedDate": "2020-09-14T15:58:05Z", "type": "commit"}, {"oid": "5f92cc5a675f3bf0a35d6afa5d6a2046085eaa10", "url": "https://github.com/quarkusio/quarkus/commit/5f92cc5a675f3bf0a35d6afa5d6a2046085eaa10", "message": "Activate IT tests in devtools integration-tests\n\nand rename Generate and Prepare to Test since they are closer to unit test than IT", "committedDate": "2020-09-14T15:58:05Z", "type": "commit"}, {"oid": "c08cf129de900b271d5be137353e37cc65fc291e", "url": "https://github.com/quarkusio/quarkus/commit/c08cf129de900b271d5be137353e37cc65fc291e", "message": "Refactor Codestart API to reduce coupling", "committedDate": "2020-09-14T15:58:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODEwODIwNw==", "url": "https://github.com/quarkusio/quarkus/pull/12030#discussion_r488108207", "bodyText": "Some javadoc would be nice", "author": "gastaldi", "createdAt": "2020-09-14T17:36:50Z", "path": "independent-projects/tools/codestarts/src/main/java/io/quarkus/devtools/codestarts/CodestartProjectDefinition.java", "diffHunk": "@@ -0,0 +1,36 @@\n+package io.quarkus.devtools.codestarts;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+public interface CodestartProjectDefinition {", "originalCommit": "c08cf129de900b271d5be137353e37cc65fc291e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQ4NzQxMw==", "url": "https://github.com/quarkusio/quarkus/pull/12030#discussion_r488487413", "bodyText": "Yeah I plan to do it all at once: #12106", "author": "ia3andy", "createdAt": "2020-09-15T08:34:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODEwODIwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODEwOTM5NA==", "url": "https://github.com/quarkusio/quarkus/pull/12030#discussion_r488109394", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                .map(c -> c.getName() + \"codestart has not been applied (doesn't implement language '\" + languageName\n          \n          \n            \n                                .map(c -> c.getName() + \" codestart has not been applied (doesn't implement language '\" + languageName", "author": "gastaldi", "createdAt": "2020-09-14T17:39:13Z", "path": "independent-projects/tools/codestarts/src/main/java/io/quarkus/devtools/codestarts/core/CodestartProjectGeneration.java", "diffHunk": "@@ -0,0 +1,69 @@\n+package io.quarkus.devtools.codestarts.core;\n+\n+import static io.quarkus.devtools.codestarts.core.CodestartProcessor.buildStrategies;\n+\n+import io.quarkus.devtools.codestarts.Codestart;\n+import io.quarkus.devtools.codestarts.CodestartProjectDefinition;\n+import io.quarkus.devtools.codestarts.CodestartType;\n+import io.quarkus.devtools.codestarts.core.strategy.CodestartFileStrategy;\n+import io.quarkus.devtools.codestarts.utils.NestedMaps;\n+import io.quarkus.devtools.messagewriter.MessageWriter;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+final class CodestartProjectGeneration {\n+\n+    private CodestartProjectGeneration() {\n+    }\n+\n+    static void generateProject(final CodestartProjectDefinition projectDefinition, final Path targetDirectory)\n+            throws IOException {\n+        final MessageWriter log = projectDefinition.getProjectInput().log();\n+\n+        final String languageName = projectDefinition.getLanguageName();\n+\n+        // Processing data\n+        final Map<String, Object> data = NestedMaps.deepMerge(Stream.of(\n+                projectDefinition.getSharedData(),\n+                projectDefinition.getDepsData(),\n+                projectDefinition.getCodestartProjectData()));\n+\n+        log.debug(\"processed shared-data: %s\" + data);\n+\n+        final Codestart projectCodestart = projectDefinition.getRequiredCodestart(CodestartType.PROJECT);\n+\n+        final List<CodestartFileStrategy> strategies = buildStrategies(mergeStrategies(projectDefinition));\n+\n+        log.debug(\"file strategies: %s\", strategies);\n+\n+        CodestartProcessor processor = new CodestartProcessor(log, projectDefinition.getResourceLoader(),\n+                languageName, targetDirectory, strategies, data);\n+        processor.checkTargetDir();\n+        for (Codestart codestart : projectDefinition.getImplementedCodestarts()) {\n+            processor.process(codestart);\n+        }\n+        processor.writeFiles();\n+        log.info(\"\\napplying codestarts...\");\n+        log.info(projectDefinition.getImplementedCodestarts().stream()\n+                .map(c -> c.getType().getIcon() + \" \"\n+                        + c.getName())\n+                .collect(Collectors.joining(\"\\n\")));\n+        if (!projectDefinition.getUnimplementedCodestarts().isEmpty()) {\n+            log.warn(projectDefinition.getUnimplementedCodestarts().stream()\n+                    .map(c -> c.getName() + \"codestart has not been applied (doesn't implement language '\" + languageName", "originalCommit": "c08cf129de900b271d5be137353e37cc65fc291e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODExMDI2NA==", "url": "https://github.com/quarkusio/quarkus/pull/12030#discussion_r488110264", "bodyText": "Return CodestartCatalog? Or is there something particular in this implementation that I am missing?", "author": "gastaldi", "createdAt": "2020-09-14T17:40:46Z", "path": "independent-projects/tools/codestarts/src/main/java/io/quarkus/devtools/codestarts/CodestartCatalogLoader.java", "diffHunk": "@@ -6,57 +6,47 @@\n import com.fasterxml.jackson.databind.MapperFeature;\n import com.fasterxml.jackson.databind.ObjectMapper;\n import com.fasterxml.jackson.dataformat.yaml.YAMLFactory;\n+import io.quarkus.devtools.codestarts.core.CodestartSpec;\n+import io.quarkus.devtools.codestarts.core.DefaultCodestartCatalog;\n import java.io.IOException;\n import java.nio.file.Files;\n import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n import java.util.Collection;\n import java.util.List;\n import java.util.Objects;\n import java.util.Set;\n import java.util.stream.Collectors;\n import java.util.stream.Stream;\n-import org.apache.commons.io.FilenameUtils;\n \n-final class CodestartLoader {\n+public final class CodestartCatalogLoader {\n+\n     private static final ObjectMapper YAML_MAPPER = new ObjectMapper(new YAMLFactory())\n             .disable(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES)\n             .enable(DeserializationFeature.ACCEPT_SINGLE_VALUE_AS_ARRAY)\n             .enable(DeserializationFeature.READ_ENUMS_USING_TO_STRING)\n             .enable(MapperFeature.ACCEPT_CASE_INSENSITIVE_ENUMS);\n \n-    private static final String CODESTARTS_DIR_BUNDLED = \"bundled-codestarts\";\n-    private static final String CODESTARTS_DIR_FROM_EXTENSIONS = \"codestarts\";\n-\n-    private CodestartLoader() {\n-    }\n-\n-    public static List<Codestart> loadAllCodestarts(CodestartInput input) throws IOException {\n-        return loadAllCodestarts(input.getResourceLoader());\n-    }\n-\n-    public static List<Codestart> loadAllCodestarts(CodestartResourceLoader resourceLoader) throws IOException {\n-        return Stream.concat(loadBundledCodestarts(resourceLoader).stream(),\n-                loadCodestartsFromExtensions(resourceLoader).stream()).collect(Collectors.toList());\n-    }\n-\n-    public static Collection<Codestart> loadBundledCodestarts(CodestartInput input) throws IOException {\n-        return loadBundledCodestarts(input.getResourceLoader());\n-    }\n-\n-    public static Collection<Codestart> loadBundledCodestarts(CodestartResourceLoader resourceLoader) throws IOException {\n-        return loadCodestarts(resourceLoader, CODESTARTS_DIR_BUNDLED);\n+    private CodestartCatalogLoader() {\n     }\n \n-    public static Collection<Codestart> loadCodestartsFromExtensions(CodestartInput input)\n+    public static DefaultCodestartCatalog loadDefaultCatalog(CodestartResourceLoader resourceLoader, String first,", "originalCommit": "c08cf129de900b271d5be137353e37cc65fc291e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQ4OTIzNQ==", "url": "https://github.com/quarkusio/quarkus/pull/12030#discussion_r488489235", "bodyText": "@gastaldi I just wanted to avoid having the generic type everywhere. It really sucks that in Java you can't override a method parameter type with a subtype \ud83d\ude13", "author": "ia3andy", "createdAt": "2020-09-15T08:37:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODExMDI2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQ5MDMyMA==", "url": "https://github.com/quarkusio/quarkus/pull/12030#discussion_r488490320", "bodyText": "@gastaldi any better idea?", "author": "ia3andy", "createdAt": "2020-09-15T08:39:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODExMDI2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODYwODIzMQ==", "url": "https://github.com/quarkusio/quarkus/pull/12030#discussion_r488608231", "bodyText": "@gastaldi ok I removed DefaultCodestartCatalog and used CodestartCatalog<CodestartProjectInput>", "author": "ia3andy", "createdAt": "2020-09-15T11:58:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODExMDI2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODY0NTg1OQ==", "url": "https://github.com/quarkusio/quarkus/pull/12030#discussion_r488645859", "bodyText": "The solution is simple: don't use generics \ud83d\ude01. But that's OK", "author": "gastaldi", "createdAt": "2020-09-15T12:59:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODExMDI2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODY0NzQwMw==", "url": "https://github.com/quarkusio/quarkus/pull/12030#discussion_r488647403", "bodyText": "@gastaldi how?", "author": "ia3andy", "createdAt": "2020-09-15T13:01:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODExMDI2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODExMTYyNw==", "url": "https://github.com/quarkusio/quarkus/pull/12030#discussion_r488111627", "bodyText": "Where is extensionsToAdd used?", "author": "gastaldi", "createdAt": "2020-09-14T17:43:12Z", "path": "independent-projects/tools/devtools-common/src/main/java/io/quarkus/devtools/commands/handlers/CreateProjectCommandHandler.java", "diffHunk": "@@ -87,14 +86,19 @@ public QuarkusCommandOutcome execute(QuarkusCommandInvocation invocation) throws\n                         .messageWriter(invocation.log())\n                         .build();\n                 invocation.log().info(\"-----------\");\n-                invocation.log().info(\"selected extensions: \\n\"\n-                        + extensionsToAdd.stream().map(e -> \"- \" + e.getGroupId() + \":\" + e.getArtifactId() + \"\\n\")\n-                                .collect(Collectors.joining()));\n-                final CodestartProject codestartProject = prepareProject(input);\n-                Codestarts.generateProject(codestartProject, invocation.getQuarkusProject().getProjectDirPath());\n+                if (!extensionsToAdd.isEmpty()) {\n+                    invocation.log().info(\"selected extensions: \\n\"\n+                            + extensionsToAdd.stream().map(e -> \"- \" + e.getGroupId() + \":\" + e.getArtifactId() + \"\\n\")\n+                                    .collect(Collectors.joining()));\n+                }\n+\n+                final QuarkusCodestartCatalog catalog = QuarkusCodestartCatalog\n+                        .fromQuarkusPlatformDescriptor(invocation.getPlatformDescriptor());\n+                final CodestartProjectDefinition projectDefinition = catalog.createProject(input);\n+                projectDefinition.generate(invocation.getQuarkusProject().getProjectDirPath());", "originalCommit": "c08cf129de900b271d5be137353e37cc65fc291e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQ5MDE5MA==", "url": "https://github.com/quarkusio/quarkus/pull/12030#discussion_r488490190", "bodyText": "@gastaldi https://github.com/ia3andy/quarkus/blob/multi-project-codestart/independent-projects/tools/devtools-common/src/main/java/io/quarkus/devtools/commands/handlers/CreateProjectCommandHandler.java#L79", "author": "ia3andy", "createdAt": "2020-09-15T08:39:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODExMTYyNw=="}], "type": "inlineReview"}, {"oid": "6bf180540eb4eef35adaebf7d3a5f7b8c95b454e", "url": "https://github.com/quarkusio/quarkus/commit/6bf180540eb4eef35adaebf7d3a5f7b8c95b454e", "message": "Refactor Codestart API to reduce coupling", "committedDate": "2020-09-15T08:36:14Z", "type": "commit"}, {"oid": "ef03ea164f2e4f6af770f7024188ee3f2f0d1829", "url": "https://github.com/quarkusio/quarkus/commit/ef03ea164f2e4f6af770f7024188ee3f2f0d1829", "message": "Add quarkus-arc as a project dependency in Quarkus Codestarts", "committedDate": "2020-09-15T08:36:19Z", "type": "commit"}, {"oid": "ef03ea164f2e4f6af770f7024188ee3f2f0d1829", "url": "https://github.com/quarkusio/quarkus/commit/ef03ea164f2e4f6af770f7024188ee3f2f0d1829", "message": "Add quarkus-arc as a project dependency in Quarkus Codestarts", "committedDate": "2020-09-15T08:36:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQ5OTU1NQ==", "url": "https://github.com/quarkusio/quarkus/pull/12030#discussion_r488499555", "bodyText": "Is this a leftover?", "author": "aloubyansky", "createdAt": "2020-09-15T08:53:53Z", "path": "independent-projects/tools/codestarts/src/main/java/io/quarkus/devtools/codestarts/Codestart.java", "diffHunk": "@@ -1,6 +1,7 @@\n package io.quarkus.devtools.codestarts;\n \n-import java.util.Comparator;\n+import io.quarkus.devtools.codestarts.core.CodestartSpec;\n+import io.quarkus.devtools.codestarts.utils.NestedMaps;", "originalCommit": "ef03ea164f2e4f6af770f7024188ee3f2f0d1829", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUwMTM0NA==", "url": "https://github.com/quarkusio/quarkus/pull/12030#discussion_r488501344", "bodyText": "@aloubyansky what do you mean?", "author": "ia3andy", "createdAt": "2020-09-15T08:56:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQ5OTU1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUwMTkwMQ==", "url": "https://github.com/quarkusio/quarkus/pull/12030#discussion_r488501901", "bodyText": "the comparators are now in DefaultCodestartProjectDefinition", "author": "ia3andy", "createdAt": "2020-09-15T08:57:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQ5OTU1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUwNzIzOQ==", "url": "https://github.com/quarkusio/quarkus/pull/12030#discussion_r488507239", "bodyText": "Are these imports necessary?", "author": "aloubyansky", "createdAt": "2020-09-15T09:05:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQ5OTU1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUyODc4OQ==", "url": "https://github.com/quarkusio/quarkus/pull/12030#discussion_r488528789", "bodyText": "Ah ok @aloubyansky , they were in the same package :)", "author": "ia3andy", "createdAt": "2020-09-15T09:40:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQ5OTU1NQ=="}], "type": "inlineReview"}, {"oid": "1174327d21fd62893dd18482fbcf7eb66fedf8ba", "url": "https://github.com/quarkusio/quarkus/commit/1174327d21fd62893dd18482fbcf7eb66fedf8ba", "message": "Fix generic and fix a bug with languages processing", "committedDate": "2020-09-15T11:51:31Z", "type": "forcePushed"}, {"oid": "3bb194f17ea305d83023a291ec6b746613f783f0", "url": "https://github.com/quarkusio/quarkus/commit/3bb194f17ea305d83023a291ec6b746613f783f0", "message": "Fix generic and fix a bug with languages processing", "committedDate": "2020-09-15T12:16:34Z", "type": "forcePushed"}, {"oid": "4b71fbc4490fba006b012733349bf4b54ef4952a", "url": "https://github.com/quarkusio/quarkus/commit/4b71fbc4490fba006b012733349bf4b54ef4952a", "message": "Fix generic and fix a bug with languages processing", "committedDate": "2020-09-15T12:23:52Z", "type": "commit"}, {"oid": "4b71fbc4490fba006b012733349bf4b54ef4952a", "url": "https://github.com/quarkusio/quarkus/commit/4b71fbc4490fba006b012733349bf4b54ef4952a", "message": "Fix generic and fix a bug with languages processing", "committedDate": "2020-09-15T12:23:52Z", "type": "forcePushed"}]}