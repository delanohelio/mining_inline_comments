{"pr_number": 9924, "pr_title": "ArC - support @TransientReference", "pr_createdAt": "2020-06-10T19:04:43Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/9924", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUxODgwOA==", "url": "https://github.com/quarkusio/quarkus/pull/9924#discussion_r438518808", "bodyText": "Maybe extract to a util method? The same destroy logic appears four times in this class.", "author": "manovotn", "createdAt": "2020-06-11T03:13:28Z", "path": "independent-projects/arc/processor/src/main/java/io/quarkus/arc/processor/BeanGenerator.java", "diffHunk": "@@ -1414,6 +1462,12 @@ void implementCreateForClassBean(ClassOutput classOutput, ClassCreator beanCreat\n                 create.invokeVirtualMethod(MethodDescriptor.of(methodInjection.target.asMethod()), instanceHandle,\n                         referenceHandles);\n             }\n+\n+            // Destroy injected transient references\n+            for (TransientReference transientReference : transientReferences) {", "originalCommit": "abc82d8cf937f50df47476d530e80230b5cd3534", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU2NzIxMg==", "url": "https://github.com/quarkusio/quarkus/pull/9924#discussion_r438567212", "bodyText": "Well, it's just a very simple iteration and  the util method would have to accept three params. But you're probably right ;-)", "author": "mkouba", "createdAt": "2020-06-11T06:24:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUxODgwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUyMjA1Mg==", "url": "https://github.com/quarkusio/quarkus/pull/9924#discussion_r438522052", "bodyText": "Nice, I didn't even know we actually have Annotated impls just for InjectionPoint :)", "author": "manovotn", "createdAt": "2020-06-11T03:26:42Z", "path": "independent-projects/arc/tests/src/test/java/io/quarkus/arc/test/transientreference/TransientReferenceDestroyedTest.java", "diffHunk": "@@ -0,0 +1,136 @@\n+package io.quarkus.arc.test.transientreference;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+import io.quarkus.arc.Arc;\n+import io.quarkus.arc.test.ArcTestContainer;\n+import java.util.List;\n+import java.util.concurrent.CopyOnWriteArrayList;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import javax.enterprise.context.ApplicationScoped;\n+import javax.enterprise.context.Dependent;\n+import javax.enterprise.context.control.ActivateRequestContext;\n+import javax.enterprise.inject.Disposes;\n+import javax.enterprise.inject.Produces;\n+import javax.enterprise.inject.TransientReference;\n+import javax.enterprise.inject.spi.AnnotatedField;\n+import javax.enterprise.inject.spi.InjectionPoint;\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.RegisterExtension;\n+\n+public class TransientReferenceDestroyedTest {\n+\n+    @RegisterExtension\n+    public ArcTestContainer container = new ArcTestContainer(Controller.class, InterceptedController.class, BeerProducer.class,\n+            Beer.class);\n+\n+    @Test\n+    public void testTransientReferences() {\n+        Controller controller = Arc.container().instance(Controller.class).get();\n+        assertNotNull(controller.theBeer);\n+        assertTrue(Arc.container().instance(Integer.class).get() > 0);\n+        assertEquals(3, BeerProducer.DESTROYED.size(), \"Destroyed beers: \" + BeerProducer.DESTROYED);\n+        assertTrue(BeerProducer.DESTROYED.contains(1));\n+        assertTrue(BeerProducer.DESTROYED.contains(2));\n+        assertTrue(BeerProducer.DESTROYED.contains(3));\n+\n+        BeerProducer.COUNTER.set(0);\n+        BeerProducer.DESTROYED.clear();\n+\n+        InterceptedController interceptedController = Arc.container().instance(InterceptedController.class).get();\n+        assertNotNull(interceptedController.getTheBeer());\n+        assertTrue(Arc.container().instance(Long.class).get() > 0);\n+        assertEquals(3, BeerProducer.DESTROYED.size(), \"Destroyed beers: \" + BeerProducer.DESTROYED);\n+        assertTrue(BeerProducer.DESTROYED.contains(1));\n+        assertTrue(BeerProducer.DESTROYED.contains(2));\n+        assertTrue(BeerProducer.DESTROYED.contains(3));\n+    }\n+\n+    @Singleton\n+    static class Controller {\n+\n+        @Inject\n+        Beer theBeer;\n+\n+        Controller(@TransientReference Beer beer) {\n+        }\n+\n+        @Inject\n+        void setBeer(@TransientReference Beer beer) {\n+        }\n+\n+        @Produces\n+        int produceInt(@TransientReference Beer beer) {\n+            return beer.id;\n+        }\n+\n+    }\n+\n+    @ActivateRequestContext\n+    @ApplicationScoped\n+    static class InterceptedController {\n+\n+        @Inject\n+        Beer theBeer;\n+\n+        InterceptedController() {\n+        }\n+\n+        @Inject\n+        InterceptedController(@TransientReference Beer beer) {\n+        }\n+\n+        public Beer getTheBeer() {\n+            return theBeer;\n+        }\n+\n+        @Inject\n+        void setBeer(@TransientReference Beer beer) {\n+        }\n+\n+        @Produces\n+        long produceLong(@TransientReference Beer beer) {\n+            return beer.id;\n+        }\n+\n+    }\n+\n+    @Singleton\n+    static class BeerProducer {\n+\n+        static final AtomicInteger COUNTER = new AtomicInteger();\n+        static final List<Integer> DESTROYED = new CopyOnWriteArrayList<>();\n+\n+        @Dependent\n+        @Produces\n+        Beer newBeer(InjectionPoint injectionPoint) {\n+            int id;\n+            if (injectionPoint.getAnnotated() instanceof AnnotatedField) {", "originalCommit": "abc82d8cf937f50df47476d530e80230b5cd3534", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU2NTM0MA==", "url": "https://github.com/quarkusio/quarkus/pull/9924#discussion_r438565340", "bodyText": "Yeah, it's ugly I know but we need to support some old stuff ;-)", "author": "mkouba", "createdAt": "2020-06-11T06:18:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUyMjA1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUyMzMwNA==", "url": "https://github.com/quarkusio/quarkus/pull/9924#discussion_r438523304", "bodyText": "Should we also test injection of transient reference bean into observer method?", "author": "manovotn", "createdAt": "2020-06-11T03:31:58Z", "path": "independent-projects/arc/tests/src/test/java/io/quarkus/arc/test/transientreference/TransientReferenceDestroyedTest.java", "diffHunk": "@@ -0,0 +1,136 @@\n+package io.quarkus.arc.test.transientreference;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+import io.quarkus.arc.Arc;\n+import io.quarkus.arc.test.ArcTestContainer;\n+import java.util.List;\n+import java.util.concurrent.CopyOnWriteArrayList;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import javax.enterprise.context.ApplicationScoped;\n+import javax.enterprise.context.Dependent;\n+import javax.enterprise.context.control.ActivateRequestContext;\n+import javax.enterprise.inject.Disposes;\n+import javax.enterprise.inject.Produces;\n+import javax.enterprise.inject.TransientReference;\n+import javax.enterprise.inject.spi.AnnotatedField;\n+import javax.enterprise.inject.spi.InjectionPoint;\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.RegisterExtension;\n+\n+public class TransientReferenceDestroyedTest {", "originalCommit": "abc82d8cf937f50df47476d530e80230b5cd3534", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU2NTczMA==", "url": "https://github.com/quarkusio/quarkus/pull/9924#discussion_r438565730", "bodyText": "That's a good point. In fact, we don't support them ATM ;-). I'll do that.", "author": "mkouba", "createdAt": "2020-06-11T06:19:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUyMzMwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU3MzY4MA==", "url": "https://github.com/quarkusio/quarkus/pull/9924#discussion_r438573680", "bodyText": "Wait a minute, for observers the injected dependent beans are destroyed even without @TransientReference...", "author": "mkouba", "createdAt": "2020-06-11T06:41:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUyMzMwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU3Nzg3NQ==", "url": "https://github.com/quarkusio/quarkus/pull/9924#discussion_r438577875", "bodyText": "Hah, a morning intelligence test (in which I apparently failed) :-D", "author": "manovotn", "createdAt": "2020-06-11T06:52:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODUyMzMwNA=="}], "type": "inlineReview"}, {"oid": "c8acd8af344ed03d37d2f6bfaa666ea40e36b026", "url": "https://github.com/quarkusio/quarkus/commit/c8acd8af344ed03d37d2f6bfaa666ea40e36b026", "message": "ArC - support @TransientReference\n\n- resolves #6858", "committedDate": "2020-06-11T06:49:28Z", "type": "commit"}, {"oid": "c8acd8af344ed03d37d2f6bfaa666ea40e36b026", "url": "https://github.com/quarkusio/quarkus/commit/c8acd8af344ed03d37d2f6bfaa666ea40e36b026", "message": "ArC - support @TransientReference\n\n- resolves #6858", "committedDate": "2020-06-11T06:49:28Z", "type": "forcePushed"}]}