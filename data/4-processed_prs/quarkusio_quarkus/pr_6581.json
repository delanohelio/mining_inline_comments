{"pr_number": 6581, "pr_title": "Introduce transactional observer support", "pr_createdAt": "2020-01-16T10:04:37Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/6581", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzMzMDI5OA==", "url": "https://github.com/quarkusio/quarkus/pull/6581#discussion_r367330298", "bodyText": "Not sure if we should log this somehow - we know there are tx observers but either Narayna isn't present (no access to SyncRegistry) or no tx is in progress ATM.", "author": "manovotn", "createdAt": "2020-01-16T10:05:42Z", "path": "independent-projects/arc/runtime/src/main/java/io/quarkus/arc/impl/EventImpl.java", "diffHunk": "@@ -209,8 +228,42 @@ void notify(T event) {\n         }\n \n         void notify(T event, ObserverExceptionHandler exceptionHandler, boolean async) {\n-            if (!isEmpty()) {\n+            if (!transactionalObserverMethodsEmpty()) {\n+                InstanceHandle<TransactionSynchronizationRegistry> registryInstance = Arc.container()\n+                        .instance(TransactionSynchronizationRegistry.class);\n+                if (registryInstance.isAvailable() && registryInstance.get().getTransactionStatus() == 0) {\n+                    // we have one or more transactional OM, and TransactionSynchronizationRegistry is available\n+                    // we attempts to register JTA synchronization\n+                    List<DeferredEventNotification<?>> deferredEvents = new ArrayList<>();\n+                    EventContext eventContext = new EventContextImpl<>(event, eventMetadata);\n+                    for (ObserverMethod<? super T> om : transactionalObserverMethods) {\n+                        deferredEvents\n+                                .add(new DeferredEventNotification(om, eventContext, Status.valueOf(om.getTransactionPhase())));\n+                    }\n+                    Synchronization sync = new ArcSynchronization(deferredEvents);\n+                    TransactionSynchronizationRegistry registry = registryInstance.get();\n+                    try {\n+                        registry.registerInterposedSynchronization(sync);\n+                    } catch (Exception e) {\n+                        if (e.getCause() instanceof RollbackException || e.getCause() instanceof IllegalStateException) {\n+                            // registration failed, merge back with non-transactional methods\n+                            // AFTER_SUCCESS are accordingly to CDI spec left out\n+                            observerMethods.addAll(transactionalObserverMethods.stream()\n+                                    .filter(observerMethod -> !observerMethod.getTransactionPhase()\n+                                            .equals(TransactionPhase.AFTER_SUCCESS))\n+                                    .collect(Collectors.toList()));\n+                        }\n+                    }\n+                } else {\n+                    // no JTA available, we will have to notify transactional OM along with all other OM\n+                    observerMethods.addAll(transactionalObserverMethods);\n+                    // TODO log this somehow?", "originalCommit": "0fb3e1b7b256ebc6e3266d3a60201d4a55bc32ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM0NjUyNA==", "url": "https://github.com/quarkusio/quarkus/pull/6581#discussion_r367346524", "bodyText": "I don't think we should log anything here...", "author": "mkouba", "createdAt": "2020-01-16T10:39:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzMzMDI5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM0NjgyOA==", "url": "https://github.com/quarkusio/quarkus/pull/6581#discussion_r367346828", "bodyText": "I'd keep this warning (with a modified message) when JTA is not available...", "author": "mkouba", "createdAt": "2020-01-16T10:39:52Z", "path": "independent-projects/arc/processor/src/main/java/io/quarkus/arc/processor/ObserverInfo.java", "diffHunk": "@@ -73,12 +72,6 @@ static ObserverInfo create(BeanInfo declaringBean, MethodInfo observerMethod, In\n             isAsync = context.isAsync();\n         }\n \n-        if (!TransactionPhase.IN_PROGRESS.equals(transactionPhase)) {", "originalCommit": "0fb3e1b7b256ebc6e3266d3a60201d4a55bc32ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM3MDA2Mw==", "url": "https://github.com/quarkusio/quarkus/pull/6581#discussion_r367370063", "bodyText": "This is done in processor - at deployment time we don't really know if we will have access to TransactionSynchronizationRegistry, right?", "author": "manovotn", "createdAt": "2020-01-16T11:35:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM0NjgyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM5ODM1MQ==", "url": "https://github.com/quarkusio/quarkus/pull/6581#discussion_r367398351", "bodyText": "JTA extension registers Capabilities.TRANSACTIONS and so it's really easy to verify if it's available - just inject the Capabilities build item and then Capabilities.isCapabilityPresent(String).", "author": "mkouba", "createdAt": "2020-01-16T12:47:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM0NjgyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM2MDYzOA==", "url": "https://github.com/quarkusio/quarkus/pull/6581#discussion_r367360638", "bodyText": "Why do you remove this line? We can sort them once and then it's not necessary to sort them every time a notifier is executed, or?", "author": "mkouba", "createdAt": "2020-01-16T11:12:08Z", "path": "independent-projects/arc/runtime/src/main/java/io/quarkus/arc/impl/ArcContainerImpl.java", "diffHunk": "@@ -541,8 +541,6 @@ private static int compareAlternativeBeans(InjectableBean<?> bean1, InjectableBe\n                 }\n             }\n         }\n-        // Observers with smaller priority values are called first\n-        Collections.sort(resolvedObservers, InjectableObserverMethod::compare);", "originalCommit": "0fb3e1b7b256ebc6e3266d3a60201d4a55bc32ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM2Mjc4OA==", "url": "https://github.com/quarkusio/quarkus/pull/6581#discussion_r367362788", "bodyText": "Because I split them into tx and standard ones and then, when JTA is not available, I need to merge them together again, which means I need to sort them again anyway so this just avoids double sort.", "author": "manovotn", "createdAt": "2020-01-16T11:17:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM2MDYzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM2MzUzNA==", "url": "https://github.com/quarkusio/quarkus/pull/6581#discussion_r367363534", "bodyText": "Hm, you mean when a transaction is not available? We could probably optimize this a little bit...", "author": "mkouba", "createdAt": "2020-01-16T11:19:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM2MDYzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM3MjkxMw==", "url": "https://github.com/quarkusio/quarkus/pull/6581#discussion_r367372913", "bodyText": "In what way? We cannot really know before hand if a tx will be active (e.g. if we will need to merge them together).", "author": "manovotn", "createdAt": "2020-01-16T11:42:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM2MDYzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQwMTA4NQ==", "url": "https://github.com/quarkusio/quarkus/pull/6581#discussion_r367401085", "bodyText": "Well, you could only have one sorted list List<InjectableObserverMethod<? super T>> and when a TX is not active (or no TX observers) just use the list or when a TX is active simply filter the list and add only TX observers to the synchronization...", "author": "mkouba", "createdAt": "2020-01-16T12:54:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM2MDYzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM2MDk2Mw==", "url": "https://github.com/quarkusio/quarkus/pull/6581#discussion_r367360963", "bodyText": "\"We attempt to...\" ;-)", "author": "mkouba", "createdAt": "2020-01-16T11:12:56Z", "path": "independent-projects/arc/runtime/src/main/java/io/quarkus/arc/impl/EventImpl.java", "diffHunk": "@@ -209,8 +228,42 @@ void notify(T event) {\n         }\n \n         void notify(T event, ObserverExceptionHandler exceptionHandler, boolean async) {\n-            if (!isEmpty()) {\n+            if (!transactionalObserverMethodsEmpty()) {\n+                InstanceHandle<TransactionSynchronizationRegistry> registryInstance = Arc.container()\n+                        .instance(TransactionSynchronizationRegistry.class);\n+                if (registryInstance.isAvailable() && registryInstance.get().getTransactionStatus() == 0) {\n+                    // we have one or more transactional OM, and TransactionSynchronizationRegistry is available\n+                    // we attempts to register JTA synchronization", "originalCommit": "0fb3e1b7b256ebc6e3266d3a60201d4a55bc32ec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM2MTUyMA==", "url": "https://github.com/quarkusio/quarkus/pull/6581#discussion_r367361520", "bodyText": "We should use the constant from javax.transaction.Status...", "author": "mkouba", "createdAt": "2020-01-16T11:14:15Z", "path": "independent-projects/arc/runtime/src/main/java/io/quarkus/arc/impl/EventImpl.java", "diffHunk": "@@ -209,8 +228,42 @@ void notify(T event) {\n         }\n \n         void notify(T event, ObserverExceptionHandler exceptionHandler, boolean async) {\n-            if (!isEmpty()) {\n+            if (!transactionalObserverMethodsEmpty()) {\n+                InstanceHandle<TransactionSynchronizationRegistry> registryInstance = Arc.container()\n+                        .instance(TransactionSynchronizationRegistry.class);\n+                if (registryInstance.isAvailable() && registryInstance.get().getTransactionStatus() == 0) {", "originalCommit": "0fb3e1b7b256ebc6e3266d3a60201d4a55bc32ec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b90efea297c54ac27e37b303a9912b6db93dd1b7", "url": "https://github.com/quarkusio/quarkus/commit/b90efea297c54ac27e37b303a9912b6db93dd1b7", "message": "Introduce transactional observer support.", "committedDate": "2020-01-16T11:44:55Z", "type": "forcePushed"}, {"oid": "18e8c99aac1c9794ee06f19085d73367c0dad071", "url": "https://github.com/quarkusio/quarkus/commit/18e8c99aac1c9794ee06f19085d73367c0dad071", "message": "Introduce transactional observer support.", "committedDate": "2020-01-16T15:53:19Z", "type": "forcePushed"}, {"oid": "1edde52adb347b446f7bfbcdc1e2bbbec7509359", "url": "https://github.com/quarkusio/quarkus/commit/1edde52adb347b446f7bfbcdc1e2bbbec7509359", "message": "Introduce transactional observer support.", "committedDate": "2020-01-16T15:59:03Z", "type": "forcePushed"}, {"oid": "925948c9462435ad1a3ee46530e72d9233bdc4dd", "url": "https://github.com/quarkusio/quarkus/commit/925948c9462435ad1a3ee46530e72d9233bdc4dd", "message": "Tx observers - minor cleanup plus reduce the number of lamdas", "committedDate": "2020-01-17T08:04:44Z", "type": "forcePushed"}, {"oid": "e854d2d119065861f01c4376d280b1cecc6cba7b", "url": "https://github.com/quarkusio/quarkus/commit/e854d2d119065861f01c4376d280b1cecc6cba7b", "message": "Tx observers - minor cleanup plus reduce the number of lamdas", "committedDate": "2020-01-17T09:07:30Z", "type": "forcePushed"}, {"oid": "b19802ce1d65894c794398fa6b6b46c781ff2a46", "url": "https://github.com/quarkusio/quarkus/commit/b19802ce1d65894c794398fa6b6b46c781ff2a46", "message": "Introduce transactional observer support.", "committedDate": "2020-01-17T15:46:19Z", "type": "commit"}, {"oid": "62e08deaca47f485d695b61cb8e6d9c770d198e5", "url": "https://github.com/quarkusio/quarkus/commit/62e08deaca47f485d695b61cb8e6d9c770d198e5", "message": "Tx observers - minor cleanup plus reduce the number of lamdas", "committedDate": "2020-01-17T15:46:19Z", "type": "commit"}, {"oid": "62e08deaca47f485d695b61cb8e6d9c770d198e5", "url": "https://github.com/quarkusio/quarkus/commit/62e08deaca47f485d695b61cb8e6d9c770d198e5", "message": "Tx observers - minor cleanup plus reduce the number of lamdas", "committedDate": "2020-01-17T15:46:19Z", "type": "forcePushed"}, {"oid": "c190f5ded7924152a74d3ee44d23a7d239809f98", "url": "https://github.com/quarkusio/quarkus/commit/c190f5ded7924152a74d3ee44d23a7d239809f98", "message": "Update CDI ref guide", "committedDate": "2020-01-17T19:01:33Z", "type": "commit"}]}