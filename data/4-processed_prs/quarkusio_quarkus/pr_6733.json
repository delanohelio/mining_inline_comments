{"pr_number": 6733, "pr_title": "Add support for proxy address forwarding", "pr_createdAt": "2020-01-22T23:49:48Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/6733", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDAwMDY4Nw==", "url": "https://github.com/quarkusio/quarkus/pull/6733#discussion_r370000687", "bodyText": "Why isn't it the default to use those values if present? Security reasons because any user could use them?", "author": "FroMage", "createdAt": "2020-01-23T09:10:33Z", "path": "extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/HttpConfiguration.java", "diffHunk": "@@ -49,6 +49,20 @@\n     @ConfigItem(defaultValue = \"8444\")\n     public int testSslPort;\n \n+    /**\n+     * If this is true then the address, scheme etc will be set from headers forwarded by the proxy server, such as\n+     * {@code X-Forwarded-For}. This should only be set if you are behind a proxy that sets these headers.\n+     */\n+    @ConfigItem(defaultValue = \"false\")\n+    public boolean proxyAddressForwarding;", "originalCommit": "176a1838b61c5759adbf678140a425c4308cfd85", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDAyNDkwOA==", "url": "https://github.com/quarkusio/quarkus/pull/6733#discussion_r370024908", "bodyText": "Yea, any client can add them if this is not configured and spoof their address etc.", "author": "stuartwdouglas", "createdAt": "2020-01-23T09:59:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDAwMDY4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDAzMzU4Ng==", "url": "https://github.com/quarkusio/quarkus/pull/6733#discussion_r370033586", "bodyText": "OK thanks.", "author": "FroMage", "createdAt": "2020-01-23T10:17:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDAwMDY4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDAwMTAwMg==", "url": "https://github.com/quarkusio/quarkus/pull/6733#discussion_r370001002", "bodyText": "Why not use Forwarded if present (since it's the new preferred header) and fall-back to X-Forwarded otherwise? Why do we need a config?", "author": "FroMage", "createdAt": "2020-01-23T09:11:10Z", "path": "extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/HttpConfiguration.java", "diffHunk": "@@ -49,6 +49,20 @@\n     @ConfigItem(defaultValue = \"8444\")\n     public int testSslPort;\n \n+    /**\n+     * If this is true then the address, scheme etc will be set from headers forwarded by the proxy server, such as\n+     * {@code X-Forwarded-For}. This should only be set if you are behind a proxy that sets these headers.\n+     */\n+    @ConfigItem(defaultValue = \"false\")\n+    public boolean proxyAddressForwarding;\n+\n+    /**\n+     * If this is true and proxy address forwarding is enabled then the standard {@code Forwarded} header will be used,\n+     * rather than the more common but not standard {@code X-Forwarded-For}.\n+     */\n+    @ConfigItem(defaultValue = \"false\")\n+    public boolean allowForwarded;", "originalCommit": "176a1838b61c5759adbf678140a425c4308cfd85", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDAyNTU5NQ==", "url": "https://github.com/quarkusio/quarkus/pull/6733#discussion_r370025595", "bodyText": "Because an old proxy that is using X-Forwarded likely does not understand Forwarded, and will just pass it through to the backend, allowing any remote client to spoof their address. The code I copied this from actually does this, and I think it is wrong: vert-x3/vertx-web#1519", "author": "stuartwdouglas", "createdAt": "2020-01-23T10:01:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDAwMTAwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDAzMzUyNA==", "url": "https://github.com/quarkusio/quarkus/pull/6733#discussion_r370033524", "bodyText": "Oh damn, that's subtle. OK.", "author": "FroMage", "createdAt": "2020-01-23T10:16:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDAwMTAwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM2NTI0Nw==", "url": "https://github.com/quarkusio/quarkus/pull/6733#discussion_r370365247", "bodyText": "@stuartwdouglas Hi Stuart, can it be of some help if the request info being replaced with this wrapper be contained as HttpServerRequest attribute ? So that it can be logged if needed etc ? Not really sure, just checking.\nAll looks good", "author": "sberyozkin", "createdAt": "2020-01-23T21:31:26Z", "path": "extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/ForwardedServerRequestWrapper.java", "diffHunk": "@@ -0,0 +1,314 @@\n+package io.quarkus.vertx.http.runtime;\n+\n+import java.util.Map;\n+\n+import javax.net.ssl.SSLPeerUnverifiedException;\n+import javax.net.ssl.SSLSession;\n+import javax.security.cert.X509Certificate;\n+\n+import io.vertx.core.Handler;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.buffer.Buffer;\n+import io.vertx.core.http.*;\n+import io.vertx.core.net.NetSocket;\n+import io.vertx.core.net.SocketAddress;\n+\n+class ForwardedServerRequestWrapper implements HttpServerRequest {", "originalCommit": "176a1838b61c5759adbf678140a425c4308cfd85", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQwMTEwMQ==", "url": "https://github.com/quarkusio/quarkus/pull/6733#discussion_r370401101", "bodyText": "I don't really know if it is needed, generally you know what your proxies are. Maybe wait and see if anyone asks for it?", "author": "stuartwdouglas", "createdAt": "2020-01-23T23:03:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM2NTI0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTczMDMxMg==", "url": "https://github.com/quarkusio/quarkus/pull/6733#discussion_r371730312", "bodyText": "@stuartwdouglas sorry, I keep missing the comments from Github...yes, makes sense", "author": "sberyozkin", "createdAt": "2020-01-28T10:48:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM2NTI0Nw=="}], "type": "inlineReview"}, {"oid": "47de644518173ee6dc4d43cb40d69b6861334c98", "url": "https://github.com/quarkusio/quarkus/commit/47de644518173ee6dc4d43cb40d69b6861334c98", "message": "Fix vert.x resuming handling if security performs a blocking operation\n\nFixes #5809", "committedDate": "2020-01-27T05:18:42Z", "type": "forcePushed"}, {"oid": "56477f2c1537c58bb3ddc61382a8a35b6438f063", "url": "https://github.com/quarkusio/quarkus/commit/56477f2c1537c58bb3ddc61382a8a35b6438f063", "message": "Fix vert.x resuming handling if security performs a blocking operation\n\nFixes #5809", "committedDate": "2020-01-28T05:20:47Z", "type": "forcePushed"}, {"oid": "64ad71f4eadb201465de414a177d25dd00cb3cf5", "url": "https://github.com/quarkusio/quarkus/commit/64ad71f4eadb201465de414a177d25dd00cb3cf5", "message": "Add support for proxy address forwarding", "committedDate": "2020-01-28T22:37:21Z", "type": "commit"}, {"oid": "ab10d2e5990354901bc745b3ac2c9d15299c8be2", "url": "https://github.com/quarkusio/quarkus/commit/ab10d2e5990354901bc745b3ac2c9d15299c8be2", "message": "Fix vert.x resuming handling if security performs a blocking operation\n\nFixes #5809", "committedDate": "2020-01-28T22:37:21Z", "type": "commit"}, {"oid": "ab10d2e5990354901bc745b3ac2c9d15299c8be2", "url": "https://github.com/quarkusio/quarkus/commit/ab10d2e5990354901bc745b3ac2c9d15299c8be2", "message": "Fix vert.x resuming handling if security performs a blocking operation\n\nFixes #5809", "committedDate": "2020-01-28T22:37:21Z", "type": "forcePushed"}]}