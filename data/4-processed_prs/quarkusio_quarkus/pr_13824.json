{"pr_number": 13824, "pr_title": "MongoDB read preferences by query", "pr_createdAt": "2020-12-10T18:28:30Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/13824", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQxMTU3MA==", "url": "https://github.com/quarkusio/quarkus/pull/13824#discussion_r540411570", "bodyText": "The collection should be updated/reassigned here rather than lazily.  Save some headaches down the line.", "author": "evanchooly", "createdAt": "2020-12-10T18:46:05Z", "path": "extensions/panache/mongodb-panache-common/runtime/src/main/java/io/quarkus/mongodb/panache/runtime/CommonPanacheQueryImpl.java", "diffHunk": "@@ -139,12 +142,21 @@ private void checkPagination() {\n         return (CommonPanacheQueryImpl<T>) this;\n     }\n \n+    public <T extends Entity> CommonPanacheQueryImpl<T> withReadPreference(ReadPreference readPreference) {\n+        this.readPreference = readPreference;\n+        return (CommonPanacheQueryImpl<T>) this;", "originalCommit": "a0954ec06c4c6d5bb3fa19bc118d99f3bac6fa85", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc2MzY5NA==", "url": "https://github.com/quarkusio/quarkus/pull/13824#discussion_r540763694", "bodyText": "Ah yes, this is so simple to do it this way ;)\nI'll update my impl then.", "author": "loicmathieu", "createdAt": "2020-12-11T08:12:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQxMTU3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQxMjAxMw==", "url": "https://github.com/quarkusio/quarkus/pull/13824#discussion_r540412013", "bodyText": "This can all but ignore the ReadPreference but updating as above.", "author": "evanchooly", "createdAt": "2020-12-10T18:46:45Z", "path": "extensions/panache/mongodb-panache-common/runtime/src/main/java/io/quarkus/mongodb/panache/runtime/CommonPanacheQueryImpl.java", "diffHunk": "@@ -139,12 +142,21 @@ private void checkPagination() {\n         return (CommonPanacheQueryImpl<T>) this;\n     }\n \n+    public <T extends Entity> CommonPanacheQueryImpl<T> withReadPreference(ReadPreference readPreference) {\n+        this.readPreference = readPreference;\n+        return (CommonPanacheQueryImpl<T>) this;\n+    }\n+\n     // Results\n \n     @SuppressWarnings(\"unchecked\")\n     public long count() {\n         if (count == null) {\n-            count = collection.countDocuments(mongoQuery);\n+            MongoCollection theCollection = collection;\n+            if (this.readPreference != null) {\n+                theCollection = theCollection.withReadPreference(this.readPreference);\n+            }\n+            count = theCollection.countDocuments(mongoQuery);", "originalCommit": "a0954ec06c4c6d5bb3fa19bc118d99f3bac6fa85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQxMjY5Ng==", "url": "https://github.com/quarkusio/quarkus/pull/13824#discussion_r540412696", "bodyText": "Same here.", "author": "evanchooly", "createdAt": "2020-12-10T18:47:49Z", "path": "extensions/panache/mongodb-panache-common/runtime/src/main/java/io/quarkus/mongodb/panache/runtime/CommonPanacheQueryImpl.java", "diffHunk": "@@ -156,7 +168,11 @@ public long count() {\n     @SuppressWarnings(\"unchecked\")\n     private <T extends Entity> List<T> list(Integer limit) {\n         List<T> list = new ArrayList<>();\n-        FindIterable find = mongoQuery == null ? collection.find() : collection.find(mongoQuery);\n+        MongoCollection theCollection = collection;\n+        if (this.readPreference != null) {\n+            theCollection = theCollection.withReadPreference(this.readPreference);\n+        }\n+        FindIterable find = mongoQuery == null ? theCollection.find() : theCollection.find(mongoQuery);", "originalCommit": "a0954ec06c4c6d5bb3fa19bc118d99f3bac6fa85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "63e8de2683b3e3b2f67f596fae8964a2fae68a52", "url": "https://github.com/quarkusio/quarkus/commit/63e8de2683b3e3b2f67f596fae8964a2fae68a52", "message": "feat: mongdb read preferences by query", "committedDate": "2020-12-11T12:19:12Z", "type": "forcePushed"}, {"oid": "fb21fdf2ebbcd93f9f132ae092174968c4d4e344", "url": "https://github.com/quarkusio/quarkus/commit/fb21fdf2ebbcd93f9f132ae092174968c4d4e344", "message": "feat: mongdb read preferences by query", "committedDate": "2020-12-11T12:26:41Z", "type": "forcePushed"}, {"oid": "b2c6b4c75ba3b27fffc4aa908654af538ebddf7d", "url": "https://github.com/quarkusio/quarkus/commit/b2c6b4c75ba3b27fffc4aa908654af538ebddf7d", "message": "feat: mongdb read preferences by query", "committedDate": "2020-12-11T15:16:13Z", "type": "commit"}, {"oid": "b2c6b4c75ba3b27fffc4aa908654af538ebddf7d", "url": "https://github.com/quarkusio/quarkus/commit/b2c6b4c75ba3b27fffc4aa908654af538ebddf7d", "message": "feat: mongdb read preferences by query", "committedDate": "2020-12-11T15:16:13Z", "type": "forcePushed"}]}