{"pr_number": 11864, "pr_title": "Bean Validation support in reactive routes", "pr_createdAt": "2020-09-03T17:23:12Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/11864", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ2ODUzMQ==", "url": "https://github.com/quarkusio/quarkus/pull/11864#discussion_r483468531", "bodyText": "This should probably be avoided :)", "author": "geoand", "createdAt": "2020-09-04T08:27:37Z", "path": "extensions/vertx-web/deployment/src/main/java/io/quarkus/vertx/web/deployment/VertxWebProcessor.java", "diffHunk": "@@ -4,21 +4,10 @@\n import static io.quarkus.vertx.web.deployment.DotNames.PARAM;\n import static org.objectweb.asm.Opcodes.ACC_FINAL;\n import static org.objectweb.asm.Opcodes.ACC_PRIVATE;\n+import static org.objectweb.asm.Opcodes.ACC_PUBLIC;\n \n-import java.io.IOException;\n-import java.util.ArrayList;\n-import java.util.Arrays;\n-import java.util.Collections;\n-import java.util.HashMap;\n-import java.util.HashSet;\n-import java.util.Iterator;\n-import java.util.LinkedHashSet;\n-import java.util.LinkedList;\n-import java.util.List;\n-import java.util.Map;\n+import java.util.*;", "originalCommit": "2d8d0282b51f7b7ef9bc54114a01d569ed018eea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU3NzQwMA==", "url": "https://github.com/quarkusio/quarkus/pull/11864#discussion_r483577400", "bodyText": "Fixed.", "author": "cescoffier", "createdAt": "2020-09-04T12:13:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ2ODUzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUwMTcxMQ==", "url": "https://github.com/quarkusio/quarkus/pull/11864#discussion_r483501711", "bodyText": "Hmmm, no, that won't work :). We have org.hibernate specific constraints and users develop custom constraints.\nMaybe I should add a build item that can send you the list of constraints?", "author": "gsmet", "createdAt": "2020-09-04T09:28:06Z", "path": "extensions/vertx-web/deployment/src/main/java/io/quarkus/vertx/web/deployment/HandlerDescriptor.java", "diffHunk": "@@ -31,6 +35,34 @@ boolean isReturningMulti() {\n         return method.returnType().name().equals(DotNames.MULTI);\n     }\n \n+    /**\n+     * @return {@code true} if the method is annotated with a constraint or {@code @Valid} or any parameter has such kind of\n+     *         annotation.\n+     */\n+    boolean requireValidation() {\n+        return method.annotations().stream()\n+                .anyMatch(new Predicate<AnnotationInstance>() {\n+                    @Override\n+                    public boolean test(AnnotationInstance ai) {\n+                        return ai.name().toString().startsWith(\"javax.validation\");", "originalCommit": "2d8d0282b51f7b7ef9bc54114a01d569ed018eea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUxODczNA==", "url": "https://github.com/quarkusio/quarkus/pull/11864#discussion_r483518734", "bodyText": "BTW I also like streams but a loop returning true once a constraint annotation is found would be more readable ;-)", "author": "mkouba", "createdAt": "2020-09-04T10:01:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUwMTcxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU3NzY5OQ==", "url": "https://github.com/quarkusio/quarkus/pull/11864#discussion_r483577699", "bodyText": "I've changed the code to use regular loops.\nAbout the name, I've done a temporary fix until we get the built item.", "author": "cescoffier", "createdAt": "2020-09-04T12:14:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUwMTcxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUwMjU0OQ==", "url": "https://github.com/quarkusio/quarkus/pull/11864#discussion_r483502549", "bodyText": "All this makes me a bit nervous?", "author": "gsmet", "createdAt": "2020-09-04T09:29:43Z", "path": "extensions/vertx-web/deployment/src/test/java/io/quarkus/vertx/web/mutiny/JsonMultiRouteTest.java", "diffHunk": "@@ -27,37 +25,38 @@\n \n     @Test\n     public void testMultiRoute() {\n-        when().get(\"/hello\").then().statusCode(200)\n-                .body(is(\"[\\\"Hello world!\\\"]\"))\n-                .header(\"content-type\", \"application/json\");\n-        when().get(\"/hellos\").then().statusCode(200)\n-                .body(is(\"[\\\"hello\\\",\\\"world\\\",\\\"!\\\"]\"))\n-                .header(\"content-type\", \"application/json\");\n-        when().get(\"/no-hello\").then().statusCode(200).body(is(\"[]\"))\n-                .header(\"content-type\", \"application/json\");\n-        // status already sent, but not the end of the array\n-        when().get(\"/hello-and-fail\").then().statusCode(200)\n-                .body(containsString(\"[\\\"Hello\\\"\"))\n-                .body(not(containsString(\"]\")));\n-\n-        when().get(\"/buffers\").then().statusCode(500);\n-\n-        when().get(\"/void\").then().statusCode(200).body(is(\"[]\"));\n-\n-        when().get(\"/people\").then().statusCode(200)\n-                .body(\"size()\", is(3))\n-                .body(\"[0].name\", is(\"superman\"))\n-                .body(\"[1].name\", is(\"batman\"))\n-                .body(\"[2].name\", is(\"spiderman\"))\n-                .header(\"content-type\", \"application/json\");\n-\n-        when().get(\"/people-content-type\").then().statusCode(200)\n-                .body(\"size()\", is(3))\n-                .body(\"[0].name\", is(\"superman\"))\n-                .body(\"[1].name\", is(\"batman\"))\n-                .body(\"[2].name\", is(\"spiderman\"))\n-                .header(\"content-type\", \"application/json;charset=utf-8\");\n-\n+        //        when().get(\"/hello\").then().statusCode(200)\n+        //                .body(is(\"[\\\"Hello world!\\\"]\"))\n+        //                .header(\"content-type\", \"application/json\");\n+        //        when().get(\"/hellos\").then().statusCode(200)\n+        //                .body(is(\"[\\\"hello\\\",\\\"world\\\",\\\"!\\\"]\"))\n+        //                .header(\"content-type\", \"application/json\");\n+        //        when().get(\"/no-hello\").then().statusCode(200).body(is(\"[]\"))\n+        //                .header(\"content-type\", \"application/json\");\n+        //        // status already sent, but not the end of the array\n+        //        when().get(\"/hello-and-fail\").then().statusCode(200)\n+        //                .body(containsString(\"[\\\"Hello\\\"\"))\n+        //                .body(not(containsString(\"]\")));\n+        //\n+        //        when().get(\"/buffers\").then().statusCode(500);\n+        //\n+        //        when().get(\"/void\").then().statusCode(200).body(is(\"[]\"));\n+        //\n+        //        when().get(\"/people\").then().statusCode(200)\n+        //                .body(\"size()\", is(3))\n+        //                .body(\"[0].name\", is(\"superman\"))\n+        //                .body(\"[1].name\", is(\"batman\"))\n+        //                .body(\"[2].name\", is(\"spiderman\"))\n+        //                .header(\"content-type\", \"application/json\");\n+        //\n+        //        when().get(\"/people-content-type\").then().statusCode(200)\n+        //                .body(\"size()\", is(3))\n+        //                .body(\"[0].name\", is(\"superman\"))\n+        //                .body(\"[1].name\", is(\"batman\"))\n+        //                .body(\"[2].name\", is(\"spiderman\"))\n+        //                .header(\"content-type\", \"application/json;charset=utf-8\");\n+\n+        System.out.println(when().get(\"/failure\").asString());", "originalCommit": "2d8d0282b51f7b7ef9bc54114a01d569ed018eea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU2MTA1Ng==", "url": "https://github.com/quarkusio/quarkus/pull/11864#discussion_r483561056", "bodyText": "forgot to uncomment after debugging", "author": "cescoffier", "createdAt": "2020-09-04T11:36:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUwMjU0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU3Nzc2OA==", "url": "https://github.com/quarkusio/quarkus/pull/11864#discussion_r483577768", "bodyText": "Fixed.", "author": "cescoffier", "createdAt": "2020-09-04T12:14:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUwMjU0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUxNjUyMw==", "url": "https://github.com/quarkusio/quarkus/pull/11864#discussion_r483516523", "bodyText": "a HTTP response -> an HTTP response", "author": "mkouba", "createdAt": "2020-09-04T09:56:42Z", "path": "docs/src/main/asciidoc/reactive-routes.adoc", "diffHunk": "@@ -475,6 +475,40 @@ id: 3\n \n ----\n \n+=== Using Bean Validation\n+\n+You can combine reactive routes and Bean Validation.\n+First, don't forget to add the `quarkus-hibernate-validator` extension to your project.\n+Then, you can add constraints to your route parameter (annotated with `@Param` or `@Body`):\n+\n+[source,java]\n+----\n+@Route(produces = \"application/json\")\n+Person createPerson(@Body @Valid Person person, @NonNull @Param(\"id\") String primaryKey) {\n+  // ...\n+}\n+----\n+\n+If the parameters do not pass the tests, it returns a HTTP 400 response.", "originalCommit": "2d8d0282b51f7b7ef9bc54114a01d569ed018eea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUyMDk0NQ==", "url": "https://github.com/quarkusio/quarkus/pull/11864#discussion_r483520945", "bodyText": "I'd suggest to use constants for repeating strings...", "author": "mkouba", "createdAt": "2020-09-04T10:05:51Z", "path": "extensions/vertx-web/deployment/src/main/java/io/quarkus/vertx/web/deployment/VertxWebProcessor.java", "diffHunk": "@@ -574,7 +602,32 @@ void implementInvoke(HandlerDescriptor descriptor, BeanInfo bean, MethodInfo met\n                 defaultProduces == null ? invoke.loadNull() : invoke.load(defaultProduces));\n \n         // Invoke the business method handler\n-        ResultHandle res = invoke.invokeVirtualMethod(methodDescriptor, beanInstanceHandle, paramHandles);\n+        AssignableResultHandle res;\n+        if (descriptor.isReturningUni()) {\n+            res = invoke.createVariable(Uni.class);\n+        } else if (descriptor.isReturningMulti()) {\n+            res = invoke.createVariable(Multi.class);\n+        } else {\n+            res = invoke.createVariable(Object.class);\n+        }\n+        invoke.assign(res, invoke.loadNull());\n+        if (!descriptor.requireValidation()) {\n+            ResultHandle value = invoke.invokeVirtualMethod(methodDescriptor, beanInstanceHandle, paramHandles);\n+            if (value != null) {\n+                invoke.assign(res, value);\n+            }\n+        } else {\n+            TryBlock block = invoke.tryBlock();\n+            ResultHandle value = block.invokeVirtualMethod(methodDescriptor, beanInstanceHandle, paramHandles);\n+            if (value != null) {\n+                block.assign(res, value);\n+            }\n+            CatchBlockCreator caught = block.addCatch(\"javax.validation.ConstraintViolationException\");", "originalCommit": "2d8d0282b51f7b7ef9bc54114a01d569ed018eea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU3ODAwNw==", "url": "https://github.com/quarkusio/quarkus/pull/11864#discussion_r483578007", "bodyText": "Fixed", "author": "cescoffier", "createdAt": "2020-09-04T12:15:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUyMDk0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUyMTk1MQ==", "url": "https://github.com/quarkusio/quarkus/pull/11864#discussion_r483521951", "bodyText": "Why public? private final is probably better...", "author": "mkouba", "createdAt": "2020-09-04T10:08:05Z", "path": "extensions/vertx-web/deployment/src/main/java/io/quarkus/vertx/web/deployment/VertxWebProcessor.java", "diffHunk": "@@ -468,8 +479,16 @@ private String generateHandler(HandlerDescriptor desc, BeanInfo bean, MethodInfo\n                     .setModifiers(ACC_PRIVATE | ACC_FINAL);\n         }\n \n-        implementConstructor(bean, invokerCreator, beanField, contextField, containerField);\n-        implementInvoke(desc, bean, method, invokerCreator, beanField, contextField, containerField, transformedAnnotations,\n+        FieldCreator validatorField = null;\n+        if (desc.isProducedResponseValidated()) {\n+            // Is the produced item needs to be validated, we inject the Validator\n+            validatorField = invokerCreator.getFieldCreator(\"validator\", \"javax.validation.Validator\")\n+                    .setModifiers(ACC_PUBLIC);", "originalCommit": "2d8d0282b51f7b7ef9bc54114a01d569ed018eea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU3ODE3OA==", "url": "https://github.com/quarkusio/quarkus/pull/11864#discussion_r483578178", "bodyText": "Switch to public final as the field is used from a different class (a callback class).", "author": "cescoffier", "createdAt": "2020-09-04T12:15:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUyMTk1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUyNDgzMw==", "url": "https://github.com/quarkusio/quarkus/pull/11864#discussion_r483524833", "bodyText": "Hmmm, should we really use System.out.println here and below?", "author": "gsmet", "createdAt": "2020-09-04T10:13:53Z", "path": "extensions/vertx-web/runtime/src/main/java/io/quarkus/vertx/web/runtime/ValidationSupport.java", "diffHunk": "@@ -0,0 +1,96 @@\n+package io.quarkus.vertx.web.runtime;\n+\n+import java.util.Set;\n+\n+import javax.validation.ConstraintViolation;\n+import javax.validation.ConstraintViolationException;\n+import javax.validation.Validator;\n+\n+import io.quarkus.arc.ArcContainer;\n+import io.vertx.core.http.HttpServerResponse;\n+import io.vertx.core.json.JsonArray;\n+import io.vertx.core.json.JsonObject;\n+import io.vertx.ext.web.RoutingContext;\n+\n+public class ValidationSupport {\n+\n+    public static final String APPLICATION_JSON = \"application/json\";\n+    public static final String ACCEPT_HEADER = \"Accept\";\n+    public static final String PROBLEM_TITLE = \"title\";\n+    public static final String PROBLEM_DETAIL = \"details\";\n+    public static final String PROBLEM_FIELD = \"field\";\n+    public static final String PROBLEM_MESSAGE = \"message\";\n+    public static final String PROBLEM_STATUS = \"status\";\n+    public static final String PROBLEM_VIOLATIONS = \"violations\";\n+\n+    private ValidationSupport() {\n+        // Avoid direct instantiation\n+    }\n+\n+    public static Validator getValidator(ArcContainer container) {\n+        return container.instance(Validator.class).get();\n+    }\n+\n+    public static String mapViolationsToJson(Set<ConstraintViolation<?>> violations, HttpServerResponse response) {\n+        response.setStatusCode(500);\n+        JsonObject json = generateJsonResponse(violations, true);\n+        return json.encode();\n+    }\n+\n+    /**\n+     * Generates a JSON response following https://opensource.zalando.com/problem/constraint-violation/\n+     * \n+     * @param violations the violations\n+     * @return the json object\n+     */\n+    private static JsonObject generateJsonResponse(Set<ConstraintViolation<?>> violations, boolean violationInProducedItem) {\n+        JsonObject json = new JsonObject()\n+                .put(PROBLEM_TITLE, \"Constraint Violation\")\n+                .put(PROBLEM_DETAIL, \"validation constraint violations\");\n+\n+        JsonArray array = new JsonArray();\n+        boolean isProduced = false;\n+        for (ConstraintViolation<?> cv : violations) {\n+            if (cv.getExecutableReturnValue() != null) {\n+                isProduced = true;\n+            }\n+            JsonObject violation = new JsonObject();\n+            violation.put(PROBLEM_FIELD, cv.getPropertyPath().toString());\n+            violation.put(PROBLEM_MESSAGE, cv.getMessage());\n+            array.add(violation);\n+        }\n+        json.put(PROBLEM_STATUS, isProduced || violationInProducedItem ? 500 : 400);\n+        json.put(PROBLEM_VIOLATIONS, array);\n+        return json;\n+    }\n+\n+    public static void handleViolationException(ConstraintViolationException ex, RoutingContext rc) {\n+        String accept = rc.request().getHeader(ACCEPT_HEADER);\n+        if (accept != null && accept.contains(APPLICATION_JSON)) {\n+            rc.response().putHeader(RouteHandlers.CONTENT_TYPE, APPLICATION_JSON);\n+            JsonObject json = generateJsonResponse(ex.getConstraintViolations(), false);\n+            rc.response().setStatusCode(json.getInteger(PROBLEM_STATUS));\n+            rc.response().end(json.encode());\n+        } else {\n+            // Check status\n+            int status = 400;\n+            for (ConstraintViolation<?> constraintViolation : ex.getConstraintViolations()) {\n+                if (constraintViolation.getExecutableReturnValue() != null) {\n+                    status = 500;\n+                    break;\n+                }\n+            }\n+            // If not JSON just fails.\n+            rc.fail(status, ex);\n+        }\n+    }\n+\n+    public static void log(String s) {\n+        System.out.println(\"[LOG] - \" + s);", "originalCommit": "2d8d0282b51f7b7ef9bc54114a01d569ed018eea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUyODkxNQ==", "url": "https://github.com/quarkusio/quarkus/pull/11864#discussion_r483528915", "bodyText": "Are the log methods even used somewhere?", "author": "mkouba", "createdAt": "2020-09-04T10:22:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUyNDgzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU2MTMwOA==", "url": "https://github.com/quarkusio/quarkus/pull/11864#discussion_r483561308", "bodyText": "unused, was only there for debugging", "author": "cescoffier", "createdAt": "2020-09-04T11:36:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUyNDgzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU3ODI1Nw==", "url": "https://github.com/quarkusio/quarkus/pull/11864#discussion_r483578257", "bodyText": "Removed", "author": "cescoffier", "createdAt": "2020-09-04T12:15:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUyNDgzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUyNjY3NQ==", "url": "https://github.com/quarkusio/quarkus/pull/11864#discussion_r483526675", "bodyText": "\"Is the produced item\" -> \"If the produced item\"", "author": "mkouba", "createdAt": "2020-09-04T10:17:40Z", "path": "extensions/vertx-web/deployment/src/main/java/io/quarkus/vertx/web/deployment/VertxWebProcessor.java", "diffHunk": "@@ -468,8 +479,16 @@ private String generateHandler(HandlerDescriptor desc, BeanInfo bean, MethodInfo\n                     .setModifiers(ACC_PRIVATE | ACC_FINAL);\n         }\n \n-        implementConstructor(bean, invokerCreator, beanField, contextField, containerField);\n-        implementInvoke(desc, bean, method, invokerCreator, beanField, contextField, containerField, transformedAnnotations,\n+        FieldCreator validatorField = null;\n+        if (desc.isProducedResponseValidated()) {\n+            // Is the produced item needs to be validated, we inject the Validator", "originalCommit": "2d8d0282b51f7b7ef9bc54114a01d569ed018eea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU3ODM5NA==", "url": "https://github.com/quarkusio/quarkus/pull/11864#discussion_r483578394", "bodyText": "Fixed.", "author": "cescoffier", "createdAt": "2020-09-04T12:16:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUyNjY3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUyODI4Mw==", "url": "https://github.com/quarkusio/quarkus/pull/11864#discussion_r483528283", "bodyText": "It's good to start the name of a constant with the class/domain name, e.g. VALIDATION_GET_VALIDATOR, SET_IS_EMPTY...", "author": "mkouba", "createdAt": "2020-09-04T10:20:57Z", "path": "extensions/vertx-web/deployment/src/main/java/io/quarkus/vertx/web/deployment/Methods.java", "diffHunk": "@@ -168,6 +173,17 @@\n     static final MethodDescriptor OPTIONAL_OF_NULLABLE = MethodDescriptor\n             .ofMethod(Optional.class, \"ofNullable\", Optional.class, Object.class);\n \n+    static final MethodDescriptor GET_VALIDATOR = MethodDescriptor.ofMethod(ValidationSupport.class, \"getValidator\",", "originalCommit": "2d8d0282b51f7b7ef9bc54114a01d569ed018eea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU3ODMyNw==", "url": "https://github.com/quarkusio/quarkus/pull/11864#discussion_r483578327", "bodyText": "Fixed.", "author": "cescoffier", "createdAt": "2020-09-04T12:15:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUyODI4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUzNDI0MA==", "url": "https://github.com/quarkusio/quarkus/pull/11864#discussion_r483534240", "bodyText": "These tests will fail on systems with non-EN locale...", "author": "mkouba", "createdAt": "2020-09-04T10:33:53Z", "path": "extensions/vertx-web/deployment/src/test/java/io/quarkus/vertx/web/validation/SyncValidationTest.java", "diffHunk": "@@ -0,0 +1,147 @@\n+package io.quarkus.vertx.web.validation;\n+\n+import static io.restassured.RestAssured.get;\n+import static io.restassured.RestAssured.given;\n+import static org.hamcrest.CoreMatchers.anyOf;\n+import static org.hamcrest.CoreMatchers.containsString;\n+import static org.hamcrest.CoreMatchers.is;\n+\n+import javax.enterprise.context.ApplicationScoped;\n+import javax.validation.Valid;\n+import javax.validation.constraints.NotNull;\n+import javax.validation.constraints.Pattern;\n+\n+import org.hibernate.validator.constraints.Length;\n+import org.jboss.shrinkwrap.api.ShrinkWrap;\n+import org.jboss.shrinkwrap.api.spec.JavaArchive;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.RegisterExtension;\n+\n+import io.quarkus.test.QuarkusUnitTest;\n+import io.quarkus.vertx.web.Param;\n+import io.quarkus.vertx.web.Route;\n+import io.vertx.core.http.HttpMethod;\n+\n+public class SyncValidationTest {\n+\n+    @RegisterExtension\n+    static final QuarkusUnitTest config = new QuarkusUnitTest()\n+            .setArchiveProducer(() -> ShrinkWrap.create(JavaArchive.class)\n+                    .addClasses(MyRoutes.class));\n+\n+    @Test\n+    public void test() {\n+        // Valid result\n+        get(\"/valid\").then().statusCode(200)\n+                .body(\"name\", is(\"luke\"))\n+                .body(\"welcome\", is(\"hello\"));\n+\n+        // Valid parameter\n+        given()\n+                .queryParam(\"name\", \"neo\")\n+                .when()\n+                .get(\"/query\")\n+                .then().statusCode(200);\n+\n+        // JSON output\n+        given()\n+                .header(\"Accept\", \"application/json\")\n+                .when()\n+                .get(\"/invalid\")\n+                .then()\n+                .statusCode(500)\n+                .body(\"title\", containsString(\"Constraint Violation\"))\n+                .body(\"status\", is(500))\n+                .body(\"details\", containsString(\"validation constraint violations\"))\n+                .body(\"violations[0].field\", containsString(\"name\"))\n+                .body(\"violations[0].message\", containsString(\"length\"));", "originalCommit": "2d8d0282b51f7b7ef9bc54114a01d569ed018eea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU2MTg0NA==", "url": "https://github.com/quarkusio/quarkus/pull/11864#discussion_r483561844", "bodyText": "you mean if internationalization is used?", "author": "cescoffier", "createdAt": "2020-09-04T11:38:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUzNDI0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU2MzEzOA==", "url": "https://github.com/quarkusio/quarkus/pull/11864#discussion_r483563138", "bodyText": "I think the default locale for a JVM is derived from the OS and in my case, it's cs_CZ.UTF-8. So I get czech messages for the constraints violations...", "author": "mkouba", "createdAt": "2020-09-04T11:41:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUzNDI0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU2NTUxMw==", "url": "https://github.com/quarkusio/quarkus/pull/11864#discussion_r483565513", "bodyText": "Oh, I see...\nSo I can only check for non-nullity.", "author": "cescoffier", "createdAt": "2020-09-04T11:46:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUzNDI0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU3ODUzNQ==", "url": "https://github.com/quarkusio/quarkus/pull/11864#discussion_r483578535", "bodyText": "Checking for nonblank.", "author": "cescoffier", "createdAt": "2020-09-04T12:16:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUzNDI0MA=="}], "type": "inlineReview"}, {"oid": "a3841d4780f993a43a2c62dae4b6bcd1d1cf96c6", "url": "https://github.com/quarkusio/quarkus/commit/a3841d4780f993a43a2c62dae4b6bcd1d1cf96c6", "message": "Fix #10990\n\nAdd support for bean validation to reactive routes", "committedDate": "2020-09-04T12:11:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU3NjY2Mw==", "url": "https://github.com/quarkusio/quarkus/pull/11864#discussion_r483576663", "bodyText": "@gsmet @mkouba Not great, but a temporary approach until we get the build item.", "author": "cescoffier", "createdAt": "2020-09-04T12:12:19Z", "path": "extensions/vertx-web/deployment/src/main/java/io/quarkus/vertx/web/deployment/HandlerDescriptor.java", "diffHunk": "@@ -31,6 +33,34 @@ boolean isReturningMulti() {\n         return method.returnType().name().equals(DotNames.MULTI);\n     }\n \n+    /**\n+     * @return {@code true} if the method is annotated with a constraint or {@code @Valid} or any parameter has such kind of\n+     *         annotation.\n+     */\n+    boolean requireValidation() {\n+        for (AnnotationInstance annotation : method.annotations()) {\n+            String name = annotation.name().toString();\n+            if (name.startsWith(\"javax.validation\") || name.startsWith(\"org.hibernate.validator.constraints\")) {", "originalCommit": "a3841d4780f993a43a2c62dae4b6bcd1d1cf96c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY3NDYyNQ==", "url": "https://github.com/quarkusio/quarkus/pull/11864#discussion_r484674625", "bodyText": "This has been fixed with the new Build Items provided by Hibernate Validator.", "author": "cescoffier", "createdAt": "2020-09-08T06:17:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU3NjY2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU3Njk2Mw==", "url": "https://github.com/quarkusio/quarkus/pull/11864#discussion_r483576963", "bodyText": "The field is accessed from another class (a callback). Made it public final after discussion with @mkouba", "author": "cescoffier", "createdAt": "2020-09-04T12:12:58Z", "path": "extensions/vertx-web/deployment/src/main/java/io/quarkus/vertx/web/deployment/VertxWebProcessor.java", "diffHunk": "@@ -468,8 +489,16 @@ private String generateHandler(HandlerDescriptor desc, BeanInfo bean, MethodInfo\n                     .setModifiers(ACC_PRIVATE | ACC_FINAL);\n         }\n \n-        implementConstructor(bean, invokerCreator, beanField, contextField, containerField);\n-        implementInvoke(desc, bean, method, invokerCreator, beanField, contextField, containerField, transformedAnnotations,\n+        FieldCreator validatorField = null;\n+        if (desc.isProducedResponseValidated()) {\n+            // If the produced item needs to be validated, we inject the Validator\n+            validatorField = invokerCreator.getFieldCreator(\"validator\", Methods.VALIDATION_VALIDATOR)\n+                    .setModifiers(ACC_PUBLIC | ACC_FINAL);", "originalCommit": "a3841d4780f993a43a2c62dae4b6bcd1d1cf96c6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzY1MDE4Mw==", "url": "https://github.com/quarkusio/quarkus/pull/11864#discussion_r483650183", "bodyText": "If the item producesd by the route...", "author": "mkouba", "createdAt": "2020-09-04T14:27:48Z", "path": "docs/src/main/asciidoc/reactive-routes.adoc", "diffHunk": "@@ -475,6 +475,40 @@ id: 3\n \n ----\n \n+=== Using Bean Validation\n+\n+You can combine reactive routes and Bean Validation.\n+First, don't forget to add the `quarkus-hibernate-validator` extension to your project.\n+Then, you can add constraints to your route parameter (annotated with `@Param` or `@Body`):\n+\n+[source,java]\n+----\n+@Route(produces = \"application/json\")\n+Person createPerson(@Body @Valid Person person, @NonNull @Param(\"id\") String primaryKey) {\n+  // ...\n+}\n+----\n+\n+If the parameters do not pass the tests, it returns an HTTP 400 response.\n+If the request accepts JSON payload, the response follows the https://opensource.zalando.com/problem/constraint-violation/[Problem] format.\n+\n+When returning an object or a `Uni`, you can also use the `@Valid` annotation:\n+\n+[source,java]\n+----\n+@Route(...)\n+@Valid Uni<Person> createPerson(@Body @Valid Person person, @NonNull @Param(\"id\") String primaryKey) {\n+  // ...\n+}\n+----\n+\n+If the item produces by the route does not pass the validation, it returns a HTTP 500 response.", "originalCommit": "a3841d4780f993a43a2c62dae4b6bcd1d1cf96c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY3NDQyNw==", "url": "https://github.com/quarkusio/quarkus/pull/11864#discussion_r484674427", "bodyText": "Fixed.", "author": "cescoffier", "createdAt": "2020-09-08T06:17:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzY1MDE4Mw=="}], "type": "inlineReview"}, {"oid": "3ded1804bf748ccc28e12ccaa3b35b88e3d17434", "url": "https://github.com/quarkusio/quarkus/commit/3ded1804bf748ccc28e12ccaa3b35b88e3d17434", "message": "The Quarkus Error Handler was not enforcing the status code that could have been configured in the context.\n\nWhen the application uses routingContext.fail(xxx, exception) the xxx (status) was ignored. This commits uses that status if configured.", "committedDate": "2020-09-05T16:26:38Z", "type": "commit"}, {"oid": "84af783ab5926baf36231fbe917ec66d1fc904fa", "url": "https://github.com/quarkusio/quarkus/commit/84af783ab5926baf36231fbe917ec66d1fc904fa", "message": "Fix #10990\n\nAdd support for bean validation to reactive routes\nUse the newly provided Build Item to retrieve the set of supported constraints.", "committedDate": "2020-09-05T16:37:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU1ODgzOA==", "url": "https://github.com/quarkusio/quarkus/pull/11864#discussion_r484558838", "bodyText": "This is incorrect, you only test for Valid.", "author": "gsmet", "createdAt": "2020-09-07T20:14:31Z", "path": "extensions/vertx-web/deployment/src/main/java/io/quarkus/vertx/web/deployment/HandlerDescriptor.java", "diffHunk": "@@ -31,6 +36,39 @@ boolean isReturningMulti() {\n         return method.returnType().name().equals(DotNames.MULTI);\n     }\n \n+    /**\n+     * @return {@code true} if the method is annotated with a constraint or {@code @Valid} or any parameter has such kind of\n+     *         annotation.\n+     */\n+    boolean requireValidation() {\n+        if (validationAnnotations == null) {\n+            return false;\n+        }\n+        for (AnnotationInstance annotation : method.annotations()) {\n+            String name = annotation.name().toString();\n+            if (validationAnnotations.getAllAnnotations().contains(name)) {\n+                return true;\n+            }\n+        }\n+        return false;\n+    }\n+\n+    /**\n+     * @return {@code true} if the method is annotated with a constraint or {@code @Valid}.", "originalCommit": "84af783ab5926baf36231fbe917ec66d1fc904fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY3NDM2NA==", "url": "https://github.com/quarkusio/quarkus/pull/11864#discussion_r484674364", "bodyText": "Fixed", "author": "cescoffier", "createdAt": "2020-09-08T06:17:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU1ODgzOA=="}], "type": "inlineReview"}, {"oid": "e330f5226d6f311fbd9705821251137ffb123d38", "url": "https://github.com/quarkusio/quarkus/commit/e330f5226d6f311fbd9705821251137ffb123d38", "message": "Fix #10990\n\nAdd support for bean validation to reactive routes\nUse the newly provided Build Item to retrieve the set of supported constraints.", "committedDate": "2020-09-08T06:16:07Z", "type": "commit"}, {"oid": "e330f5226d6f311fbd9705821251137ffb123d38", "url": "https://github.com/quarkusio/quarkus/commit/e330f5226d6f311fbd9705821251137ffb123d38", "message": "Fix #10990\n\nAdd support for bean validation to reactive routes\nUse the newly provided Build Item to retrieve the set of supported constraints.", "committedDate": "2020-09-08T06:16:07Z", "type": "forcePushed"}]}