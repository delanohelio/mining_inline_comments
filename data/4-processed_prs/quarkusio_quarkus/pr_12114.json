{"pr_number": 12114, "pr_title": "fix: use own AddEnvVarDecorator to prevent it from being skipped", "pr_createdAt": "2020-09-15T14:35:49Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/12114", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2NjEzNw==", "url": "https://github.com/quarkusio/quarkus/pull/12114#discussion_r488766137", "bodyText": "LOL - This really through me off regarding where your AddEnvVarDecorator was being used :)", "author": "geoand", "createdAt": "2020-09-15T15:36:59Z", "path": "extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/ContainerAdapter.java", "diffHunk": "@@ -5,7 +5,6 @@\n import io.dekorate.kubernetes.config.Env;\n import io.dekorate.kubernetes.config.Mount;\n import io.dekorate.kubernetes.config.Port;\n-import io.dekorate.kubernetes.decorator.AddEnvVarDecorator;", "originalCommit": "d3ff3534346eb63b83431095e71ba04f59f7edde", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2Njc0OQ==", "url": "https://github.com/quarkusio/quarkus/pull/12114#discussion_r488766749", "bodyText": "Can we also assert that the env vars are not added to the application container?", "author": "geoand", "createdAt": "2020-09-15T15:37:49Z", "path": "integration-tests/kubernetes/quarkus-standard-way/src/test/java/io/quarkus/it/kubernetes/KubernetesWithSidecarAndJibTest.java", "diffHunk": "@@ -91,6 +91,10 @@ private void assertSidecar(io.fabric8.kubernetes.api.model.PodSpec podSpec) {\n                     assertThat(c.getPorts()).singleElement().satisfies(p -> {\n                         assertThat(p.getContainerPort()).isEqualTo(3000);\n                     });\n+                    assertThat(c.getEnv()).singleElement().satisfies(e -> {", "originalCommit": "d3ff3534346eb63b83431095e71ba04f59f7edde", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg5ODcxOQ==", "url": "https://github.com/quarkusio/quarkus/pull/12114#discussion_r488898719", "bodyText": "Done.", "author": "metacosm", "createdAt": "2020-09-15T19:00:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2Njc0OQ=="}], "type": "inlineReview"}, {"oid": "069dff91ad85060059a4288bce491d50f7bf77e7", "url": "https://github.com/quarkusio/quarkus/commit/069dff91ad85060059a4288bce491d50f7bf77e7", "message": "fix: use own AddEnvVarDecorator to prevent it from being skipped\n\nFixes #12063. This occurs because the dekorate version of\nAddEnvVarDecorator inherits from ApplicationContainerDecorator\nwhich expects metadata to be present, which doesn't happen in our\ncontext. We sidestep the issue by wrapping the original behavior and\ncalling its andThenVisit method, which does the work when not skipped.", "committedDate": "2020-09-15T18:56:04Z", "type": "forcePushed"}, {"oid": "473683d9df862183ee5d1f02257bee0920f49734", "url": "https://github.com/quarkusio/quarkus/commit/473683d9df862183ee5d1f02257bee0920f49734", "message": "fix: use own AddEnvVarDecorator to prevent it from being skipped\n\nFixes #12063. This occurs because the dekorate version of\nAddEnvVarDecorator inherits from ApplicationContainerDecorator\nwhich expects metadata to be present, which doesn't happen in our\ncontext. We sidestep the issue by wrapping the original behavior and\ncalling its andThenVisit method, which does the work when not skipped.", "committedDate": "2020-09-16T08:18:01Z", "type": "commit"}, {"oid": "473683d9df862183ee5d1f02257bee0920f49734", "url": "https://github.com/quarkusio/quarkus/commit/473683d9df862183ee5d1f02257bee0920f49734", "message": "fix: use own AddEnvVarDecorator to prevent it from being skipped\n\nFixes #12063. This occurs because the dekorate version of\nAddEnvVarDecorator inherits from ApplicationContainerDecorator\nwhich expects metadata to be present, which doesn't happen in our\ncontext. We sidestep the issue by wrapping the original behavior and\ncalling its andThenVisit method, which does the work when not skipped.", "committedDate": "2020-09-16T08:18:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQyMjU4Mg==", "url": "https://github.com/quarkusio/quarkus/pull/12114#discussion_r489422582", "bodyText": "I like it!", "author": "iocanel", "createdAt": "2020-09-16T13:08:26Z", "path": "extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/AddEnvVarDecorator.java", "diffHunk": "@@ -0,0 +1,30 @@\n+package io.quarkus.kubernetes.deployment;\n+\n+import io.dekorate.deps.kubernetes.api.model.ContainerBuilder;\n+import io.dekorate.kubernetes.config.Env;\n+import io.dekorate.kubernetes.decorator.AddSidecarDecorator;\n+import io.dekorate.kubernetes.decorator.ContainerDecorator;\n+import io.dekorate.kubernetes.decorator.Decorator;\n+import io.dekorate.kubernetes.decorator.ResourceProvidingDecorator;\n+\n+/**\n+ * Delegate to dekorate's version to sidestep the fact that the dekorate version of AddEnvVarDecorator inherits from\n+ * ApplicationContainerDecorator which expects metadata to be present, which doesn't happen in our context. We sidestep the\n+ * issue by wrapping the original behavior and calling its andThenVisit method, which does the work when not skipped.\n+ */\n+public class AddEnvVarDecorator extends Decorator<ContainerBuilder> {\n+    private final io.dekorate.kubernetes.decorator.AddEnvVarDecorator delegate;\n+\n+    public AddEnvVarDecorator(Env env) {\n+        delegate = new io.dekorate.kubernetes.decorator.AddEnvVarDecorator(env);", "originalCommit": "473683d9df862183ee5d1f02257bee0920f49734", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}