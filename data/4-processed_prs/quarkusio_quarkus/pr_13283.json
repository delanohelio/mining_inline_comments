{"pr_number": 13283, "pr_title": "Qute: introduce switch/when section", "pr_createdAt": "2020-11-13T15:43:20Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/13283", "timeline": [{"oid": "72cfe3f74b355ad30eb966162b82e7ec5f9f136b", "url": "https://github.com/quarkusio/quarkus/commit/72cfe3f74b355ad30eb966162b82e7ec5f9f136b", "message": "Qute: introduce switch/when section\n\n- also fix validation of expressions related to an inject: expression", "committedDate": "2020-11-19T07:21:08Z", "type": "forcePushed"}, {"oid": "c4266e572318f779ca11a811f395345752a346a3", "url": "https://github.com/quarkusio/quarkus/commit/c4266e572318f779ca11a811f395345752a346a3", "message": "Qute: introduce switch/when section\n\n- also fix validation of expressions related to an inject: expression", "committedDate": "2020-11-19T15:07:42Z", "type": "forcePushed"}, {"oid": "73cfed1ea347450b638858774e42feb3b820046d", "url": "https://github.com/quarkusio/quarkus/commit/73cfed1ea347450b638858774e42feb3b820046d", "message": "Qute: introduce switch/when section\n\n- also fix validation of expressions related to an inject: expression", "committedDate": "2020-11-20T13:50:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc3MjM4OA==", "url": "https://github.com/quarkusio/quarkus/pull/13283#discussion_r527772388", "bodyText": "In general I don't like when there's two names for the same thing and I think swich/case should be enough. But if you say that's what Kotlin uses, then perhaps that's a good justification for having both.", "author": "FroMage", "createdAt": "2020-11-20T15:35:04Z", "path": "docs/src/main/asciidoc/qute-reference.adoc", "diffHunk": "@@ -619,6 +619,97 @@ You can also add any number of `else` blocks:\n {/if}\n ----\n \n+[[when_section]]\n+==== When/Switch Section\n+\n+This section is similar to Java's `switch` or Kotlin's `when` constructs.", "originalCommit": "73cfed1ea347450b638858774e42feb3b820046d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc3NDczOA==", "url": "https://github.com/quarkusio/quarkus/pull/13283#discussion_r527774738", "bodyText": "I get why you have special operators, because the LHS is implicit, but we should really fix expressions so that they're not tag-dependent. For example I expect people will want to write {#is 2 || > 20} and {#is (other.fu + stuff.bar)} and I'm not sure there's a good reason to prevent that. Besides the implicit LHS.\nHell, I wonder if we shouldn't also allow non-implitic operators like {#case 2 || something == fu}.", "author": "FroMage", "createdAt": "2020-11-20T15:38:42Z", "path": "docs/src/main/asciidoc/qute-reference.adoc", "diffHunk": "@@ -619,6 +619,97 @@ You can also add any number of `else` blocks:\n {/if}\n ----\n \n+[[when_section]]\n+==== When/Switch Section\n+\n+This section is similar to Java's `switch` or Kotlin's `when` constructs.\n+It matches a _tested value_ against all blocks sequentially until a condition is satisfied.\n+The first matching block is executed.\n+All other blocks are ignored (this behavior differs to the Java `switch` where a `break` statement is necessary).\n+\n+.Example using the `when`/`is` name aliases\n+[source]\n+----\n+{#when items.size}\n+  {#is 1} <1>\n+    There is exactly one item!\n+  {#is > 10} <2>\n+    There are more than 10 items!\n+  {#else} <3>\n+    There are 2 -10 items!\n+{/when}\n+----\n+<1> If there is exactly one parameter it's tested for equality.\n+<2> It's possible to use <<when_operators,an operator>> to specify the matching logic. Unlike in the <<if_section>> nested operators are not supported.\n+<3> `else` is block is executed if no other block matches the value.\n+\n+.Example using the `switch`/`case` name aliases\n+[source]\n+----\n+{#switch person.name}\n+  {#case 'John'} <1>\n+    Hey John!\n+  {#case 'Mary'} <1>\n+    Hey Mary!\n+{/switch}\n+----\n+<1> `case` is an alias for `is`.\n+\n+A tested value that resolves to an enum is handled specifically.\n+The parameters of an `is`/`case` block are not evaluated as expressions but compared with the result of `toString()` invocation upon the tested value.\n+\n+[source]\n+----\n+{#when machine.status}\n+  {#is ON} \n+    It's running. <1>\n+  {#is in OFF BROKEN}\n+    It's broken or OFF. <2>\n+{/when}\n+----\n+<1> This block is executed if `machine.status.toString().equals(\"ON\")`.\n+<2> This block is executed if  `machine.status.toString().equals(\"OFF\")` or `machine.status.toString().equals(\"BROKEN\")`.\n+\n+NOTE: The enum constants are validated if there is a parameter declaration mapped to a tested value and the declared type is an enum.\n+\n+The following operators are supported in `is`/`case` block conditions:", "originalCommit": "73cfed1ea347450b638858774e42feb3b820046d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUxODA4NQ==", "url": "https://github.com/quarkusio/quarkus/pull/13283#discussion_r528518085", "bodyText": "Yes, we could do a lot of things but the current API is probably not the best fit. I'm all for continuous refactoring and improvements though!", "author": "mkouba", "createdAt": "2020-11-23T07:55:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc3NDczOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc3NTQzNA==", "url": "https://github.com/quarkusio/quarkus/pull/13283#discussion_r527775434", "bodyText": "I guess that works.", "author": "FroMage", "createdAt": "2020-11-20T15:39:45Z", "path": "docs/src/main/asciidoc/qute-reference.adoc", "diffHunk": "@@ -619,6 +619,97 @@ You can also add any number of `else` blocks:\n {/if}\n ----\n \n+[[when_section]]\n+==== When/Switch Section\n+\n+This section is similar to Java's `switch` or Kotlin's `when` constructs.\n+It matches a _tested value_ against all blocks sequentially until a condition is satisfied.\n+The first matching block is executed.\n+All other blocks are ignored (this behavior differs to the Java `switch` where a `break` statement is necessary).\n+\n+.Example using the `when`/`is` name aliases\n+[source]\n+----\n+{#when items.size}\n+  {#is 1} <1>\n+    There is exactly one item!\n+  {#is > 10} <2>\n+    There are more than 10 items!\n+  {#else} <3>\n+    There are 2 -10 items!\n+{/when}\n+----\n+<1> If there is exactly one parameter it's tested for equality.\n+<2> It's possible to use <<when_operators,an operator>> to specify the matching logic. Unlike in the <<if_section>> nested operators are not supported.\n+<3> `else` is block is executed if no other block matches the value.\n+\n+.Example using the `switch`/`case` name aliases\n+[source]\n+----\n+{#switch person.name}\n+  {#case 'John'} <1>\n+    Hey John!\n+  {#case 'Mary'} <1>\n+    Hey Mary!\n+{/switch}\n+----\n+<1> `case` is an alias for `is`.\n+\n+A tested value that resolves to an enum is handled specifically.\n+The parameters of an `is`/`case` block are not evaluated as expressions but compared with the result of `toString()` invocation upon the tested value.", "originalCommit": "73cfed1ea347450b638858774e42feb3b820046d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc3NjY1NA==", "url": "https://github.com/quarkusio/quarkus/pull/13283#discussion_r527776654", "bodyText": "But if you make this generic and say that \"if a comparison operator operand (including implicit operands such as in case/is) is an enum then both operands are compared using toString on both operands\" then this works for every operator in every expression context.", "author": "FroMage", "createdAt": "2020-11-20T15:41:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc3NTQzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUyMjMxNQ==", "url": "https://github.com/quarkusio/quarkus/pull/13283#discussion_r528522315", "bodyText": "Well, currently there is no such thing like \"expression context\".\nWe have \"expressions\" that are used to output a single value, i.e. {foo}. These expressions basically follow the object.property (dot notation) or object[property_name] (bracket notation) syntax, plus the property can be replaced with a virtual method, e.g. {foo.bar(1)} and we also support \"infix notation\" for virtual methods with single parameter, i.e. {name or 'John'}.\nAnd then we have sections, e.g. {#if} which can have any number of parameters (with optional names) and it's completely up to the section to decide what to do with these params. For example {#for item in foo.items} has 3 params, item, in and foo.items... first is used as an alias, second is ignored and third is used to resolve an iterable object...", "author": "mkouba", "createdAt": "2020-11-23T08:05:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc3NTQzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc3ODcxNg==", "url": "https://github.com/quarkusio/quarkus/pull/13283#discussion_r527778716", "bodyText": "Why not validate it even if it doesn't come directly from a parameter? It can come from any typed expression, after all, no?", "author": "FroMage", "createdAt": "2020-11-20T15:44:19Z", "path": "docs/src/main/asciidoc/qute-reference.adoc", "diffHunk": "@@ -619,6 +619,97 @@ You can also add any number of `else` blocks:\n {/if}\n ----\n \n+[[when_section]]\n+==== When/Switch Section\n+\n+This section is similar to Java's `switch` or Kotlin's `when` constructs.\n+It matches a _tested value_ against all blocks sequentially until a condition is satisfied.\n+The first matching block is executed.\n+All other blocks are ignored (this behavior differs to the Java `switch` where a `break` statement is necessary).\n+\n+.Example using the `when`/`is` name aliases\n+[source]\n+----\n+{#when items.size}\n+  {#is 1} <1>\n+    There is exactly one item!\n+  {#is > 10} <2>\n+    There are more than 10 items!\n+  {#else} <3>\n+    There are 2 -10 items!\n+{/when}\n+----\n+<1> If there is exactly one parameter it's tested for equality.\n+<2> It's possible to use <<when_operators,an operator>> to specify the matching logic. Unlike in the <<if_section>> nested operators are not supported.\n+<3> `else` is block is executed if no other block matches the value.\n+\n+.Example using the `switch`/`case` name aliases\n+[source]\n+----\n+{#switch person.name}\n+  {#case 'John'} <1>\n+    Hey John!\n+  {#case 'Mary'} <1>\n+    Hey Mary!\n+{/switch}\n+----\n+<1> `case` is an alias for `is`.\n+\n+A tested value that resolves to an enum is handled specifically.\n+The parameters of an `is`/`case` block are not evaluated as expressions but compared with the result of `toString()` invocation upon the tested value.\n+\n+[source]\n+----\n+{#when machine.status}\n+  {#is ON} \n+    It's running. <1>\n+  {#is in OFF BROKEN}\n+    It's broken or OFF. <2>\n+{/when}\n+----\n+<1> This block is executed if `machine.status.toString().equals(\"ON\")`.\n+<2> This block is executed if  `machine.status.toString().equals(\"OFF\")` or `machine.status.toString().equals(\"BROKEN\")`.\n+\n+NOTE: The enum constants are validated if there is a parameter declaration mapped to a tested value and the declared type is an enum.", "originalCommit": "73cfed1ea347450b638858774e42feb3b820046d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUyNDg4NA==", "url": "https://github.com/quarkusio/quarkus/pull/13283#discussion_r528524884", "bodyText": "Ah, sorry. Wrong wording... we do validate the enum constants in a {#when foo.whatever} iff foo.whatever has a type info and resolves to an enum (which means that it maps to some implicit/explicit parameter declaration under the hood...). I'll try to change the wording...", "author": "mkouba", "createdAt": "2020-11-23T08:10:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc3ODcxNg=="}], "type": "inlineReview"}, {"oid": "e0baa265776d7faea04e96b3b7ef2f23c98714f8", "url": "https://github.com/quarkusio/quarkus/commit/e0baa265776d7faea04e96b3b7ef2f23c98714f8", "message": "Qute: introduce switch/when section\n\n- also fix validation of expressions related to an inject: expression", "committedDate": "2020-11-23T08:15:40Z", "type": "commit"}, {"oid": "e0baa265776d7faea04e96b3b7ef2f23c98714f8", "url": "https://github.com/quarkusio/quarkus/commit/e0baa265776d7faea04e96b3b7ef2f23c98714f8", "message": "Qute: introduce switch/when section\n\n- also fix validation of expressions related to an inject: expression", "committedDate": "2020-11-23T08:15:40Z", "type": "forcePushed"}]}