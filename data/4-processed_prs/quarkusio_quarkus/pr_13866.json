{"pr_number": 13866, "pr_title": "Issue with the SecurityIdentity on the IO Thread", "pr_createdAt": "2020-12-14T07:08:23Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/13866", "timeline": [{"oid": "2dd60646693355d66b3c79fb8c6dd7a509859230", "url": "https://github.com/quarkusio/quarkus/commit/2dd60646693355d66b3c79fb8c6dd7a509859230", "message": "Issue with the SecurityIdentity on the IO Thread\n\nThis will no longer wrap the Identity in a Uni if\nproactive auth is in use.\n\nThis also resolves a problem with setting the current\nSecurityIdentity via a CDI event, which is not\ncompatible with lazy authentication.\n\nNote that the problem can still occur if using lazy\nauth from the IO thread, which is expected. To get\nthe identity in this situation you need to use\nCurrentIdentityAssociation#getDeferredIdentity\nand subscribe to the result.\n\nFixes #13835", "committedDate": "2020-12-14T07:20:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjI2MzkyMw==", "url": "https://github.com/quarkusio/quarkus/pull/13866#discussion_r542263923", "bodyText": "Hi Stuart @stuartwdouglas Can you please add a small subsection with an example to https://quarkus.io/guides/security-built-in-authentication#proactive-authentication, we've been trying to accumulate all the hints like this one in our security docs.", "author": "sberyozkin", "createdAt": "2020-12-14T10:12:19Z", "path": "extensions/security/runtime/src/main/java/io/quarkus/security/runtime/SecurityIdentityAssociation.java", "diffHunk": "@@ -55,7 +55,14 @@ public void setIdentity(Uni<SecurityIdentity> identity) {\n     public SecurityIdentity getIdentity() {\n         if (identity == null) {\n             if (deferredIdentity != null) {\n-                identity = deferredIdentity.await().indefinitely();\n+                if (BlockingOperationControl.isBlockingAllowed()) {\n+                    identity = deferredIdentity.await().indefinitely();\n+                } else {\n+                    throw new RuntimeException(\"Cannot call getIdentity() from the IO thread when lazy authentication \" +", "originalCommit": "2dd60646693355d66b3c79fb8c6dd7a509859230", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ3ODAzOQ==", "url": "https://github.com/quarkusio/quarkus/pull/13866#discussion_r543478039", "bodyText": "Thanks @stuartwdouglas :-)", "author": "sberyozkin", "createdAt": "2020-12-15T16:08:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjI2MzkyMw=="}], "type": "inlineReview"}, {"oid": "f17b0b9e0e740af332ed9cec3f14a959de5eeda5", "url": "https://github.com/quarkusio/quarkus/commit/f17b0b9e0e740af332ed9cec3f14a959de5eeda5", "message": "Issue with the SecurityIdentity on the IO Thread\n\nThis will no longer wrap the Identity in a Uni if\nproactive auth is in use.\n\nThis also resolves a problem with setting the current\nSecurityIdentity via a CDI event, which is not\ncompatible with lazy authentication.\n\nNote that the problem can still occur if using lazy\nauth from the IO thread, which is expected. To get\nthe identity in this situation you need to use\nCurrentIdentityAssociation#getDeferredIdentity\nand subscribe to the result.\n\nFixes #13835", "committedDate": "2020-12-15T00:11:02Z", "type": "forcePushed"}, {"oid": "3190f23402ba27f4f31a519a42837732252a7346", "url": "https://github.com/quarkusio/quarkus/commit/3190f23402ba27f4f31a519a42837732252a7346", "message": "Issue with the SecurityIdentity on the IO Thread\n\nThis will no longer wrap the Identity in a Uni if\nproactive auth is in use.\n\nThis also resolves a problem with setting the current\nSecurityIdentity via a CDI event, which is not\ncompatible with lazy authentication.\n\nNote that the problem can still occur if using lazy\nauth from the IO thread, which is expected. To get\nthe identity in this situation you need to use\nCurrentIdentityAssociation#getDeferredIdentity\nand subscribe to the result.\n\nFixes #13835", "committedDate": "2020-12-16T00:29:26Z", "type": "forcePushed"}, {"oid": "b0246e2244796979e3052982ea94ab28e2ee2f20", "url": "https://github.com/quarkusio/quarkus/commit/b0246e2244796979e3052982ea94ab28e2ee2f20", "message": "Issue with the SecurityIdentity on the IO Thread\n\nThis will no longer wrap the Identity in a Uni if\nproactive auth is in use.\n\nThis also resolves a problem with setting the current\nSecurityIdentity via a CDI event, which is not\ncompatible with lazy authentication.\n\nNote that the problem can still occur if using lazy\nauth from the IO thread, which is expected. To get\nthe identity in this situation you need to use\nCurrentIdentityAssociation#getDeferredIdentity\nand subscribe to the result.\n\nFixes #13835", "committedDate": "2020-12-16T02:19:26Z", "type": "commit"}, {"oid": "b0246e2244796979e3052982ea94ab28e2ee2f20", "url": "https://github.com/quarkusio/quarkus/commit/b0246e2244796979e3052982ea94ab28e2ee2f20", "message": "Issue with the SecurityIdentity on the IO Thread\n\nThis will no longer wrap the Identity in a Uni if\nproactive auth is in use.\n\nThis also resolves a problem with setting the current\nSecurityIdentity via a CDI event, which is not\ncompatible with lazy authentication.\n\nNote that the problem can still occur if using lazy\nauth from the IO thread, which is expected. To get\nthe identity in this situation you need to use\nCurrentIdentityAssociation#getDeferredIdentity\nand subscribe to the result.\n\nFixes #13835", "committedDate": "2020-12-16T02:19:26Z", "type": "forcePushed"}]}