{"pr_number": 9531, "pr_title": "Speed up Flyway by preventing it from doing classpath scanning", "pr_createdAt": "2020-05-22T09:51:11Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/9531", "timeline": [{"oid": "88b49530f67051b02c1696ebb71ba1ad3568534d", "url": "https://github.com/quarkusio/quarkus/commit/88b49530f67051b02c1696ebb71ba1ad3568534d", "message": "Speedup Flyway by preventing it from doing classpath scanning\n\nThis PR essentially takes the substitution we had for native mode\nand turns it into a class transformer.\nThis way even in JVM mode our Flyway integration take advantage of\nthe fact that the migration script locations are known at build time,\nthus no classpath scanning is needed.\n\nThis solution isn't great from a maintenance perspective, but the\ntransformation is relatively straightforward and our test suite for\nFlyway pretty extensive, so we should easily be able to adapt to future\nFlyway updates (ideally we would be able to remove this if /when\nhttps://github.com/flyway/flyway/issues/2822 is done)\n\nRelates to: #9428", "committedDate": "2020-05-22T09:53:50Z", "type": "forcePushed"}, {"oid": "937cb4dc7ced008bbfe51c2ebf1cee1766d41f92", "url": "https://github.com/quarkusio/quarkus/commit/937cb4dc7ced008bbfe51c2ebf1cee1766d41f92", "message": "Speedup Flyway by preventing it from doing classpath scanning\n\nThis PR essentially takes the substitution we had for native mode\nand turns it into a class transformer.\nThis way even in JVM mode our Flyway integration take advantage of\nthe fact that the migration script locations are known at build time,\nthus no classpath scanning is needed.\n\nThis solution isn't ideal from a maintenance perspective, but the\ntransformation is relatively straightforward and our test suite for\nFlyway pretty extensive, so we should easily be able to adapt to future\nFlyway updates (ideally we would be able to remove this if /when\nhttps://github.com/flyway/flyway/issues/2822 is done)\n\nRelates to: #9428", "committedDate": "2020-05-22T11:58:32Z", "type": "forcePushed"}, {"oid": "ba96126798d0b12c887518551b730b5c023fa476", "url": "https://github.com/quarkusio/quarkus/commit/ba96126798d0b12c887518551b730b5c023fa476", "message": "Speedup Flyway by preventing it from doing classpath scanning\n\nThis PR essentially takes the substitution we had for native mode\nand turns it into a class transformer.\nThis way even in JVM mode our Flyway integration take advantage of\nthe fact that the migration script locations are known at build time,\nthus no classpath scanning is needed.\n\nThis solution isn't ideal from a maintenance perspective, but the\ntransformation is relatively straightforward and our test suite for\nFlyway pretty extensive, so we should easily be able to adapt to future\nFlyway updates (ideally we would be able to remove this if /when\nhttps://github.com/flyway/flyway/issues/2822 is done)\n\nRelates to: #9428", "committedDate": "2020-05-22T12:20:10Z", "type": "forcePushed"}, {"oid": "a5e9bdc7f58a92789b3f8d3f005ae2b67d17e1a0", "url": "https://github.com/quarkusio/quarkus/commit/a5e9bdc7f58a92789b3f8d3f005ae2b67d17e1a0", "message": "Speedup Flyway by preventing it from doing classpath scanning\n\nThis PR essentially takes the substitution we had for native mode\nand turns it into a class transformer.\nThis way even in JVM mode our Flyway integration take advantage of\nthe fact that the migration script locations are known at build time,\nthus no classpath scanning is needed.\n\nThis solution isn't ideal from a maintenance perspective, but the\ntransformation is relatively straightforward and our test suite for\nFlyway pretty extensive, so we should easily be able to adapt to future\nFlyway updates (ideally we would be able to remove this if /when\nhttps://github.com/flyway/flyway/issues/2822 is done)\n\nRelates to: #9428", "committedDate": "2020-05-22T12:25:21Z", "type": "forcePushed"}, {"oid": "9b359404ffb7f57320148a2800c080e243edde90", "url": "https://github.com/quarkusio/quarkus/commit/9b359404ffb7f57320148a2800c080e243edde90", "message": "Speedup Flyway by preventing it from doing classpath scanning\n\nThis PR essentially takes the substitution we had for native mode\nand turns it into a class transformer.\nThis way even in JVM mode our Flyway integration take advantage of\nthe fact that the migration script locations are known at build time,\nthus no classpath scanning is needed.\n\nThis solution isn't ideal from a maintenance perspective, but the\ntransformation is relatively straightforward and our test suite for\nFlyway pretty extensive, so we should easily be able to adapt to future\nFlyway updates (ideally we would be able to remove this if /when\nhttps://github.com/flyway/flyway/issues/2822 is done)\n\nRelates to: #9428", "committedDate": "2020-05-22T12:28:58Z", "type": "forcePushed"}, {"oid": "e08dd3ea6439f7e1ecf9bafa018a585e5f78c0c1", "url": "https://github.com/quarkusio/quarkus/commit/e08dd3ea6439f7e1ecf9bafa018a585e5f78c0c1", "message": "Temporarily remove other tests to get faster CI feedback", "committedDate": "2020-05-22T12:40:58Z", "type": "forcePushed"}, {"oid": "5b4eaf9e93432fb70ab9e24bd0fe56a865dfd7da", "url": "https://github.com/quarkusio/quarkus/commit/5b4eaf9e93432fb70ab9e24bd0fe56a865dfd7da", "message": "Temporarily remove other tests to get faster CI feedback", "committedDate": "2020-05-22T12:52:41Z", "type": "forcePushed"}, {"oid": "4742e3982cf1ec4ea766e4e7a63a54f14b116dc1", "url": "https://github.com/quarkusio/quarkus/commit/4742e3982cf1ec4ea766e4e7a63a54f14b116dc1", "message": "Temporarily remove other tests to get faster CI feedback", "committedDate": "2020-05-22T12:53:30Z", "type": "forcePushed"}, {"oid": "b2416d33197b99d5902de09e643087d9bc29ad7e", "url": "https://github.com/quarkusio/quarkus/commit/b2416d33197b99d5902de09e643087d9bc29ad7e", "message": "Temporarily remove other tests to get faster CI feedback", "committedDate": "2020-05-22T13:30:27Z", "type": "forcePushed"}, {"oid": "5a1c57aa50a4390a0b86f7d242e10d11711ef91a", "url": "https://github.com/quarkusio/quarkus/commit/5a1c57aa50a4390a0b86f7d242e10d11711ef91a", "message": "Speedup Flyway by preventing it from doing classpath scanning\n\nThis PR essentially takes the substitution we had for native mode\nand turns it into a class transformer.\nThis way even in JVM mode our Flyway integration take advantage of\nthe fact that the migration script locations are known at build time,\nthus no classpath scanning is needed.\n\nThis solution isn't ideal from a maintenance perspective, but the\ntransformation is relatively straightforward and our test suite for\nFlyway pretty extensive, so we should easily be able to adapt to future\nFlyway updates (ideally we would be able to remove this if /when\nhttps://github.com/flyway/flyway/issues/2822 is done)\n\nRelates to: #9428", "committedDate": "2020-05-22T13:58:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM3MTk3MQ==", "url": "https://github.com/quarkusio/quarkus/pull/9531#discussion_r429371971", "bodyText": "Can we add a link to the issue we created in Flyway with just a note explaining why need this class. This way we can easily track the issue once it is merged, we can get rid of this class. WDYT?", "author": "machi1990", "createdAt": "2020-05-22T17:33:01Z", "path": "extensions/flyway/deployment/src/main/java/io/quarkus/flyway/ScannerTransformer.java", "diffHunk": "@@ -0,0 +1,116 @@\n+package io.quarkus.flyway;\n+\n+import static org.objectweb.asm.Opcodes.ALOAD;\n+import static org.objectweb.asm.Opcodes.ASTORE;\n+import static org.objectweb.asm.Opcodes.DUP;\n+import static org.objectweb.asm.Opcodes.GETFIELD;\n+import static org.objectweb.asm.Opcodes.INVOKEINTERFACE;\n+import static org.objectweb.asm.Opcodes.INVOKESPECIAL;\n+import static org.objectweb.asm.Opcodes.NEW;\n+import static org.objectweb.asm.Opcodes.POP;\n+import static org.objectweb.asm.Opcodes.PUTFIELD;\n+import static org.objectweb.asm.Opcodes.RETURN;\n+\n+import java.util.function.BiFunction;\n+\n+import org.flywaydb.core.internal.scanner.Scanner;\n+import org.flywaydb.core.internal.scanner.classpath.ResourceAndClassScanner;\n+import org.objectweb.asm.ClassVisitor;\n+import org.objectweb.asm.MethodVisitor;\n+\n+import io.quarkus.flyway.runtime.QuarkusPathLocationScanner;\n+import io.quarkus.gizmo.Gizmo;\n+\n+class ScannerTransformer implements BiFunction<String, ClassVisitor, ClassVisitor> {", "originalCommit": "5a1c57aa50a4390a0b86f7d242e10d11711ef91a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM3NjM2NQ==", "url": "https://github.com/quarkusio/quarkus/pull/9531#discussion_r429376365", "bodyText": "I was thinking that the extensive commit message would be enough, no?", "author": "geoand", "createdAt": "2020-05-22T17:43:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM3MTk3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM3ODYxNA==", "url": "https://github.com/quarkusio/quarkus/pull/9531#discussion_r429378614", "bodyText": "Yes, it helps to have it there too in the commit message. I think having it in the class will make quick when someone stumble through the class in the future to just copy the issue and check if it fixed upstream or especially during reviews of Flyway's auto upgrades by the bot.", "author": "machi1990", "createdAt": "2020-05-22T17:48:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM3MTk3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM3OTY0Mg==", "url": "https://github.com/quarkusio/quarkus/pull/9531#discussion_r429379642", "bodyText": "Well, since I'm the one that opened the issue, I'll obviously keep an eye for updates to it.\nBut I'll add the comment just in case", "author": "geoand", "createdAt": "2020-05-22T17:50:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM3MTk3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM4MDUyNA==", "url": "https://github.com/quarkusio/quarkus/pull/9531#discussion_r429380524", "bodyText": "Otherwise, I had the same concern as @Sanne but after following your discussions on this PR I suppose we can live with this for a while till the issue is fixed hence my suggestion for tracking it explicitly in the code.", "author": "machi1990", "createdAt": "2020-05-22T17:52:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM3MTk3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM4MDgzMw==", "url": "https://github.com/quarkusio/quarkus/pull/9531#discussion_r429380833", "bodyText": "Well, since I'm the one that opened the issue, I'll obviously keep an eye for updates to it.\nBut I'll add the comment just in case\n\nNice, thanks.", "author": "machi1990", "createdAt": "2020-05-22T17:52:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM3MTk3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM4MTUzMA==", "url": "https://github.com/quarkusio/quarkus/pull/9531#discussion_r429381530", "bodyText": "Added", "author": "geoand", "createdAt": "2020-05-22T17:54:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM3MTk3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM4Mzg0Ng==", "url": "https://github.com/quarkusio/quarkus/pull/9531#discussion_r429383846", "bodyText": "Great. All good for me.", "author": "machi1990", "createdAt": "2020-05-22T17:59:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM3MTk3MQ=="}], "type": "inlineReview"}, {"oid": "b1a64d0ae4e2342de479149b36935b4346f5b3dd", "url": "https://github.com/quarkusio/quarkus/commit/b1a64d0ae4e2342de479149b36935b4346f5b3dd", "message": "Speedup Flyway by preventing it from doing classpath scanning\n\nThis PR essentially takes the substitution we had for native mode\nand turns it into a class transformer.\nThis way even in JVM mode our Flyway integration take advantage of\nthe fact that the migration script locations are known at build time,\nthus no classpath scanning is needed.\n\nThis solution isn't ideal from a maintenance perspective, but the\ntransformation is relatively straightforward and our test suite for\nFlyway pretty extensive, so we should easily be able to adapt to future\nFlyway updates (ideally we would be able to remove this if /when\nhttps://github.com/flyway/flyway/issues/2822 is done)\n\nRelates to: #9428", "committedDate": "2020-05-22T17:54:03Z", "type": "forcePushed"}, {"oid": "20f42f9d3abd49a591ab3a8045f77f7d21bb1d86", "url": "https://github.com/quarkusio/quarkus/commit/20f42f9d3abd49a591ab3a8045f77f7d21bb1d86", "message": "Speedup Flyway by preventing it from doing classpath scanning\n\nThis PR essentially takes the substitution we had for native mode\nand turns it into a class transformer.\nThis way even in JVM mode our Flyway integration take advantage of\nthe fact that the migration script locations are known at build time,\nthus no classpath scanning is needed.\n\nThis solution isn't ideal from a maintenance perspective, but the\ntransformation is relatively straightforward and our test suite for\nFlyway pretty extensive, so we should easily be able to adapt to future\nFlyway updates (ideally we would be able to remove this if /when\nhttps://github.com/flyway/flyway/issues/2822 is done)\n\nRelates to: #9428", "committedDate": "2020-05-24T11:00:18Z", "type": "commit"}, {"oid": "20f42f9d3abd49a591ab3a8045f77f7d21bb1d86", "url": "https://github.com/quarkusio/quarkus/commit/20f42f9d3abd49a591ab3a8045f77f7d21bb1d86", "message": "Speedup Flyway by preventing it from doing classpath scanning\n\nThis PR essentially takes the substitution we had for native mode\nand turns it into a class transformer.\nThis way even in JVM mode our Flyway integration take advantage of\nthe fact that the migration script locations are known at build time,\nthus no classpath scanning is needed.\n\nThis solution isn't ideal from a maintenance perspective, but the\ntransformation is relatively straightforward and our test suite for\nFlyway pretty extensive, so we should easily be able to adapt to future\nFlyway updates (ideally we would be able to remove this if /when\nhttps://github.com/flyway/flyway/issues/2822 is done)\n\nRelates to: #9428", "committedDate": "2020-05-24T11:00:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY5MDU3Ng==", "url": "https://github.com/quarkusio/quarkus/pull/9531#discussion_r429690576", "bodyText": "I really should look at a 'Gizmo for transformers'...", "author": "stuartwdouglas", "createdAt": "2020-05-25T00:21:26Z", "path": "extensions/flyway/deployment/src/main/java/io/quarkus/flyway/ScannerTransformer.java", "diffHunk": "@@ -0,0 +1,121 @@\n+package io.quarkus.flyway;\n+\n+import static org.objectweb.asm.Opcodes.ALOAD;\n+import static org.objectweb.asm.Opcodes.ASTORE;\n+import static org.objectweb.asm.Opcodes.DUP;\n+import static org.objectweb.asm.Opcodes.GETFIELD;\n+import static org.objectweb.asm.Opcodes.INVOKEINTERFACE;\n+import static org.objectweb.asm.Opcodes.INVOKESPECIAL;\n+import static org.objectweb.asm.Opcodes.NEW;\n+import static org.objectweb.asm.Opcodes.POP;\n+import static org.objectweb.asm.Opcodes.PUTFIELD;\n+import static org.objectweb.asm.Opcodes.RETURN;\n+\n+import java.util.function.BiFunction;\n+\n+import org.flywaydb.core.internal.scanner.Scanner;\n+import org.flywaydb.core.internal.scanner.classpath.ResourceAndClassScanner;\n+import org.objectweb.asm.ClassVisitor;\n+import org.objectweb.asm.MethodVisitor;\n+\n+import io.quarkus.flyway.runtime.QuarkusPathLocationScanner;\n+import io.quarkus.gizmo.Gizmo;\n+\n+/**\n+ * Transforms {@link Scanner} in a way to take advantage of our build time knowledge\n+ * This should be removed completely if https://github.com/flyway/flyway/issues/2822\n+ * is implemented\n+ */\n+class ScannerTransformer implements BiFunction<String, ClassVisitor, ClassVisitor> {\n+\n+    static final String FLYWAY_SCANNER_CLASS_NAME = Scanner.class.getName();\n+    private static final String FLYWAY_SCANNER_INTERNAL_CLASS_NAME = FLYWAY_SCANNER_CLASS_NAME.replace('.', '/');\n+\n+    private static final String FLYWAY_RESOURCE_AND_CLASS_SCANNER_CLASS_NAME = ResourceAndClassScanner.class.getName();\n+    private static final String FLYWAY_RESOURCE_AND_CLASS_SCANNER_INTERNAL_CLASS_NAME = FLYWAY_RESOURCE_AND_CLASS_SCANNER_CLASS_NAME\n+            .replace('.', '/');\n+\n+    private static final String QUARKUS_RESOURCE_AND_CLASS_SCANNER_CLASS_NAME = QuarkusPathLocationScanner.class.getName();\n+    private static final String QUARKUS_RESOURCE_AND_CLASS_SCANNER_INTERNAL_CLASS_NAME = QUARKUS_RESOURCE_AND_CLASS_SCANNER_CLASS_NAME\n+            .replace('.', '/');\n+\n+    private static final String CTOR_METHOD_NAME = \"<init>\";\n+\n+    @Override\n+    public ClassVisitor apply(String s, ClassVisitor cv) {\n+        return new ScannerVisitor(cv);\n+    }\n+\n+    private static final class ScannerVisitor extends ClassVisitor {\n+\n+        public ScannerVisitor(ClassVisitor cv) {\n+            super(Gizmo.ASM_API_VERSION, cv);\n+        }\n+\n+        @Override\n+        public MethodVisitor visitMethod(int access, String name, String descriptor, String signature, String[] exceptions) {\n+            MethodVisitor mv = super.visitMethod(access, name, descriptor, signature, exceptions);\n+            if (name.equals(CTOR_METHOD_NAME)) {\n+                return new ConstructorTransformer(mv);\n+            }\n+            return mv;\n+        }\n+\n+        /**\n+         * Replaces the constructor of the {@link Scanner} with:\n+         *\n+         * <pre>\n+         * public ScannerSubstitutions(Class<?> implementedInterface, Collection<Location> locations, ClassLoader classLoader,\n+         *         Charset encoding, ResourceNameCache resourceNameCache, LocationScannerCache locationScannerCache) {\n+         *     ResourceAndClassScanner quarkusScanner = new QuarkusPathLocationScanner(locations);\n+         *     resources.addAll(quarkusScanner.scanForResources());\n+         *     classes.addAll(quarkusScanner.scanForClasses());\n+         * }\n+         * </pre>\n+         */\n+        private static class ConstructorTransformer extends MethodVisitor {\n+\n+            public ConstructorTransformer(MethodVisitor mv) {\n+                super(Gizmo.ASM_API_VERSION, mv);\n+            }\n+\n+            @Override\n+            public void visitCode() {\n+                super.visitVarInsn(ALOAD, 0);", "originalCommit": "20f42f9d3abd49a591ab3a8045f77f7d21bb1d86", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTcyNTEyNQ==", "url": "https://github.com/quarkusio/quarkus/pull/9531#discussion_r429725125", "bodyText": "Yeah, that would make things a lot easier :)", "author": "geoand", "createdAt": "2020-05-25T04:18:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY5MDU3Ng=="}], "type": "inlineReview"}]}