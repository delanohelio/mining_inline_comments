{"pr_number": 13863, "pr_title": "Add OpenTracing Command Listener to MongoDB client", "pr_createdAt": "2020-12-13T22:52:54Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/13863", "timeline": [{"oid": "03a721763a90cc3401198631f4c299a504be5a05", "url": "https://github.com/quarkusio/quarkus/commit/03a721763a90cc3401198631f4c299a504be5a05", "message": "Add OpenTracing command listener to Mongo client.", "committedDate": "2020-12-14T07:21:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwNDgzMg==", "url": "https://github.com/quarkusio/quarkus/pull/13863#discussion_r542304832", "bodyText": "You also need to add the opentracing mongo client.\nTo avoid duplicating configuration, better add a link to the related section on the OpenTracing guide", "author": "loicmathieu", "createdAt": "2020-12-14T11:15:29Z", "path": "docs/src/main/asciidoc/mongodb.adoc", "diffHunk": "@@ -596,6 +596,12 @@ This behavior must first be enabled by setting the `quarkus.mongodb.metrics.enab\n So when you access the `/q/metrics` endpoint of your application you will have information about the connection pool status.\n When using link:microprofile-metrics[SmallRye Metrics], connection pool metrics will be available under the `vendor` scope.\n \n+== Tracing\n+\n+If you are using the `quarkus-smallrye-opentracing` extension, `quarkus-mongodb-client` can register traces about the commands executed.\n+This behavior must first be enabled by setting the `quarkus.mongodb.tracing.enabled` property to `true` in your `application.properties`.", "originalCommit": "03a721763a90cc3401198631f4c299a504be5a05", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzEzNTQ1Ng==", "url": "https://github.com/quarkusio/quarkus/pull/13863#discussion_r573135456", "bodyText": "Added the info about the requirement and the link to the OpenTracing guide specific section.", "author": "juazugas", "createdAt": "2021-02-09T18:35:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwNDgzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwNzYxMw==", "url": "https://github.com/quarkusio/quarkus/pull/13863#discussion_r542307613", "bodyText": "Don't index it if you don't want to include it automatically later !", "author": "loicmathieu", "createdAt": "2020-12-14T11:20:04Z", "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/MongoClientProcessor.java", "diffHunk": "@@ -66,6 +72,20 @@\n     private static final DotName MONGO_CLIENT = DotName.createSimple(MongoClient.class.getName());\n     private static final DotName REACTIVE_MONGO_CLIENT = DotName.createSimple(ReactiveMongoClient.class.getName());\n \n+    static class MongoClientTracingEnabled implements BooleanSupplier {\n+        MongoClientBuildTimeConfig mConfig;\n+\n+        @Override\n+        public boolean getAsBoolean() {\n+            return mConfig.tracingEnabled;\n+        }\n+    }\n+\n+    @BuildStep(onlyIf = MongoClientTracingEnabled.class)\n+    IndexDependencyBuildItem addMongoTracingDependencies() {\n+        return new IndexDependencyBuildItem(\"io.opentracing.contrib\", \"opentracing-mongo-common\");\n+    }\n+", "originalCommit": "03a721763a90cc3401198631f4c299a504be5a05", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzEzNTkxNQ==", "url": "https://github.com/quarkusio/quarkus/pull/13863#discussion_r573135915", "bodyText": "Removed", "author": "juazugas", "createdAt": "2021-02-09T18:35:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwNzYxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwODI2MA==", "url": "https://github.com/quarkusio/quarkus/pull/13863#discussion_r542308260", "bodyText": "You should index your MongoTracingCommandListener if tracing is enabled and the capability is present in a dedicated step. By this you will not have to remove the TracingCommandListene and add your own", "author": "loicmathieu", "createdAt": "2020-12-14T11:21:05Z", "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/MongoClientProcessor.java", "diffHunk": "@@ -93,10 +113,20 @@ BsonDiscriminatorBuildItem collectBsonDiscriminators(CombinedIndexBuildItem inde\n     }\n \n     @BuildStep\n-    CommandListenerBuildItem collectCommandListeners(CombinedIndexBuildItem indexBuildItem) {\n+    CommandListenerBuildItem collectCommandListeners(CombinedIndexBuildItem indexBuildItem, Capabilities capabilities,\n+            MongoClientBuildTimeConfig buildTimeConfig) {\n+        Predicate<String> isTracingCommandListenerPredicate = name -> name\n+                .equalsIgnoreCase(\"io.opentracing.contrib.mongo.common.TracingCommandListener\");\n         Collection<ClassInfo> commandListenerClasses = indexBuildItem.getIndex()\n                 .getAllKnownImplementors(DotName.createSimple(CommandListener.class.getName()));\n-        List<String> names = commandListenerClasses.stream().map(ci -> ci.name().toString()).collect(Collectors.toList());\n+        List<String> names = commandListenerClasses.stream()\n+                .map(ci -> ci.name().toString())\n+                // filter the TracingCommandListener to avoid the non-default constructor class.\n+                .filter(isTracingCommandListenerPredicate.negate())\n+                .collect(Collectors.toList());\n+        if (buildTimeConfig.tracingEnabled && capabilities.isPresent(Capability.OPENTRACING)) {\n+            names.add(MongoTracingCommandListener.class.getName());", "originalCommit": "03a721763a90cc3401198631f4c299a504be5a05", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzE0NjAzNQ==", "url": "https://github.com/quarkusio/quarkus/pull/13863#discussion_r573146035", "bodyText": "After removing the indexing, the filtering was no more necessary.\nBut I was not able (didn't know how) to extract the indexing of the MongoTracingCommandListener in a separate BuildStep. I did it but I got a cycle detection error when including the Jackson extension (between the capabilities and the combined index due to the JacksonProcessor.register). So finally I decide to keep the manually adding part but if the dedicated step is required I will need some hints about how to do it.", "author": "juazugas", "createdAt": "2021-02-09T18:50:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwODI2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwOTY5MQ==", "url": "https://github.com/quarkusio/quarkus/pull/13863#discussion_r542309691", "bodyText": "If this is the only reason why we cannot directly use the TracingCommandListener maybe open an issue upstream (and propose a PR) to avoid maintaining this MongoTracingCommandListener that only build the TracingCommandListener with the GlobalTracer.\nYou can keep this class while waiting for the fix upstream as a workaround", "author": "loicmathieu", "createdAt": "2020-12-14T11:23:26Z", "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/tracing/MongoTracingCommandListener.java", "diffHunk": "@@ -0,0 +1,46 @@\n+package io.quarkus.mongodb.tracing;\n+\n+import com.mongodb.event.CommandFailedEvent;\n+import com.mongodb.event.CommandListener;\n+import com.mongodb.event.CommandStartedEvent;\n+import com.mongodb.event.CommandSucceededEvent;\n+\n+import io.opentracing.contrib.mongo.common.TracingCommandListener;\n+import io.opentracing.util.GlobalTracer;\n+import io.vertx.core.logging.Logger;\n+import io.vertx.core.logging.LoggerFactory;\n+\n+/**\n+ * Command Listener for Mongo client delegated to {@link TracingCommandListener}.\n+ * \n+ */\n+public class MongoTracingCommandListener implements CommandListener {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(MongoTracingCommandListener.class);\n+\n+    private TracingCommandListener delegate;\n+\n+    public MongoTracingCommandListener() {\n+        this.delegate = new TracingCommandListener.Builder(GlobalTracer.get()).build();", "originalCommit": "03a721763a90cc3401198631f4c299a504be5a05", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "754517b0b7c45253568bf732739b05b94fa74410", "url": "https://github.com/quarkusio/quarkus/commit/754517b0b7c45253568bf732739b05b94fa74410", "message": "Add OpenTracing command listener to Mongo client.", "committedDate": "2021-02-09T18:32:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzU1Njk1NA==", "url": "https://github.com/quarkusio/quarkus/pull/13863#discussion_r573556954", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            This behavior must be enabled by setting the `quarkus.mongodb.tracing.enabled` property to `true` in your `application.properties` and adding the dependency `io.opentracing.contrib:opentracing-mongo-common` to your pom.xml (for more info read the link:opentracing#mongodb-client[MongoDB client])\n          \n          \n            \n            This behavior must be enabled by setting the `quarkus.mongodb.tracing.enabled` property to `true` in your `application.properties` and adding the dependency `io.opentracing.contrib:opentracing-mongo-common` to your pom.xml (for more info read the link:opentracing#mongodb-client[OpenTracing - MongoDB client] section)", "author": "loicmathieu", "createdAt": "2021-02-10T09:07:06Z", "path": "docs/src/main/asciidoc/mongodb.adoc", "diffHunk": "@@ -596,6 +596,12 @@ This behavior must first be enabled by setting the `quarkus.mongodb.metrics.enab\n So when you access the `/q/metrics` endpoint of your application you will have information about the connection pool status.\n When using link:microprofile-metrics[SmallRye Metrics], connection pool metrics will be available under the `vendor` scope.\n \n+== Tracing\n+\n+If you are using the `quarkus-smallrye-opentracing` extension, `quarkus-mongodb-client` can register traces about the commands executed.\n+This behavior must be enabled by setting the `quarkus.mongodb.tracing.enabled` property to `true` in your `application.properties` and adding the dependency `io.opentracing.contrib:opentracing-mongo-common` to your pom.xml (for more info read the link:opentracing#mongodb-client[MongoDB client])", "originalCommit": "754517b0b7c45253568bf732739b05b94fa74410", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzU1NzI5MA==", "url": "https://github.com/quarkusio/quarkus/pull/13863#discussion_r573557290", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Read the link:opentracing[OpenTracing] guide, to configure and how to use the jaeger tracer.\n          \n          \n            \n            Read the link:opentracing[OpenTracing] guide, for how to configure OpenTracing and use the Jaeger tracer.", "author": "loicmathieu", "createdAt": "2021-02-10T09:07:39Z", "path": "docs/src/main/asciidoc/mongodb.adoc", "diffHunk": "@@ -596,6 +596,12 @@ This behavior must first be enabled by setting the `quarkus.mongodb.metrics.enab\n So when you access the `/q/metrics` endpoint of your application you will have information about the connection pool status.\n When using link:microprofile-metrics[SmallRye Metrics], connection pool metrics will be available under the `vendor` scope.\n \n+== Tracing\n+\n+If you are using the `quarkus-smallrye-opentracing` extension, `quarkus-mongodb-client` can register traces about the commands executed.\n+This behavior must be enabled by setting the `quarkus.mongodb.tracing.enabled` property to `true` in your `application.properties` and adding the dependency `io.opentracing.contrib:opentracing-mongo-common` to your pom.xml (for more info read the link:opentracing#mongodb-client[MongoDB client])\n+\n+Read the link:opentracing[OpenTracing] guide, to configure and how to use the jaeger tracer.", "originalCommit": "754517b0b7c45253568bf732739b05b94fa74410", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzU2MzMwNw==", "url": "https://github.com/quarkusio/quarkus/pull/13863#discussion_r573563307", "bodyText": "Can you use a String here to avoid loading the class inside the deployment module ?", "author": "loicmathieu", "createdAt": "2021-02-10T09:16:51Z", "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/MongoClientProcessor.java", "diffHunk": "@@ -93,10 +106,16 @@ BsonDiscriminatorBuildItem collectBsonDiscriminators(CombinedIndexBuildItem inde\n     }\n \n     @BuildStep\n-    CommandListenerBuildItem collectCommandListeners(CombinedIndexBuildItem indexBuildItem) {\n+    CommandListenerBuildItem collectCommandListeners(CombinedIndexBuildItem indexBuildItem,\n+            MongoClientBuildTimeConfig buildTimeConfig, Capabilities capabilities) {\n         Collection<ClassInfo> commandListenerClasses = indexBuildItem.getIndex()\n                 .getAllKnownImplementors(DotName.createSimple(CommandListener.class.getName()));\n-        List<String> names = commandListenerClasses.stream().map(ci -> ci.name().toString()).collect(Collectors.toList());\n+        List<String> names = commandListenerClasses.stream()\n+                .map(ci -> ci.name().toString())\n+                .collect(Collectors.toList());\n+        if (buildTimeConfig.tracingEnabled && capabilities.isPresent(Capability.OPENTRACING)) {\n+            names.add(MongoTracingCommandListener.class.getName());", "originalCommit": "754517b0b7c45253568bf732739b05b94fa74410", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzU2NDIwMA==", "url": "https://github.com/quarkusio/quarkus/pull/13863#discussion_r573564200", "bodyText": "I don't see this being used anywhere ?", "author": "loicmathieu", "createdAt": "2021-02-10T09:18:06Z", "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/MongoClientProcessor.java", "diffHunk": "@@ -66,6 +70,15 @@\n     private static final DotName MONGO_CLIENT = DotName.createSimple(MongoClient.class.getName());\n     private static final DotName REACTIVE_MONGO_CLIENT = DotName.createSimple(ReactiveMongoClient.class.getName());\n \n+    static class MongoClientTracingEnabled implements BooleanSupplier {\n+        MongoClientBuildTimeConfig mConfig;\n+\n+        @Override\n+        public boolean getAsBoolean() {\n+            return mConfig.tracingEnabled;\n+        }\n+    }\n+", "originalCommit": "754517b0b7c45253568bf732739b05b94fa74410", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3Mzk4OTM0Mg==", "url": "https://github.com/quarkusio/quarkus/pull/13863#discussion_r573989342", "bodyText": "No, it is not. Remove it in the new push. Left the class in case we wanted the build step. But it makes no sense to keep it. Thanks", "author": "juazugas", "createdAt": "2021-02-10T18:52:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzU2NDIwMA=="}], "type": "inlineReview"}, {"oid": "6bf459cd22fb4b3ac0436a0277841c13fa9dea96", "url": "https://github.com/quarkusio/quarkus/commit/6bf459cd22fb4b3ac0436a0277841c13fa9dea96", "message": "Add OpenTracing command listener to Mongo client.", "committedDate": "2021-02-10T18:44:09Z", "type": "forcePushed"}, {"oid": "9439c6c00f69fa32a32dd4a904a93dd112dd1b5c", "url": "https://github.com/quarkusio/quarkus/commit/9439c6c00f69fa32a32dd4a904a93dd112dd1b5c", "message": "Add OpenTracing command listener to Mongo client.", "committedDate": "2021-03-17T12:22:48Z", "type": "forcePushed"}, {"oid": "b2c5349b111c83ad452df6fd7a063ccd3bfdae4d", "url": "https://github.com/quarkusio/quarkus/commit/b2c5349b111c83ad452df6fd7a063ccd3bfdae4d", "message": "Add OpenTracing command listener to Mongo client.", "committedDate": "2021-04-01T12:28:44Z", "type": "commit"}, {"oid": "b2c5349b111c83ad452df6fd7a063ccd3bfdae4d", "url": "https://github.com/quarkusio/quarkus/commit/b2c5349b111c83ad452df6fd7a063ccd3bfdae4d", "message": "Add OpenTracing command listener to Mongo client.", "committedDate": "2021-04-01T12:28:44Z", "type": "forcePushed"}]}