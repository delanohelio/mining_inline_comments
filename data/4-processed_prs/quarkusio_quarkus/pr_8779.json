{"pr_number": 8779, "pr_title": "Add first version of Spring Cache annotations", "pr_createdAt": "2020-04-23T08:57:36Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/8779", "timeline": [{"oid": "b30bf2c18c8874f54c5d63de4a7398e01cd71b71", "url": "https://github.com/quarkusio/quarkus/commit/b30bf2c18c8874f54c5d63de4a7398e01cd71b71", "message": "Add first version of Spring Cache annotations", "committedDate": "2020-04-24T06:07:31Z", "type": "forcePushed"}, {"oid": "d8fd2c9aa5ccd3bb7c2fd06ef5b067fe50111889", "url": "https://github.com/quarkusio/quarkus/commit/d8fd2c9aa5ccd3bb7c2fd06ef5b067fe50111889", "message": "Add first version of Spring Cache annotations", "committedDate": "2020-05-01T17:45:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk5MzY1Ng==", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r418993656", "bodyText": "SPRING_CACHE should come before SPRING_CLOUD_CONFIG_CLIENT if alphabetical order matters :)", "author": "gwenneg", "createdAt": "2020-05-02T18:46:59Z", "path": "core/deployment/src/main/java/io/quarkus/deployment/builditem/FeatureBuildItem.java", "diffHunk": "@@ -93,6 +93,7 @@\n     public static final String SPRING_SECURITY = \"spring-security\";\n     public static final String SPRING_BOOT_PROPERTIES = \"spring-boot-properties\";\n     public static final String SPRING_CLOUD_CONFIG_CLIENT = \"spring-cloud-config-client\";\n+    public static final String SPRING_CACHE = \"spring-cache\";", "originalCommit": "d8fd2c9aa5ccd3bb7c2fd06ef5b067fe50111889", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA2OTM3NQ==", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r419069375", "bodyText": "It does, so I'll fix it", "author": "geoand", "createdAt": "2020-05-03T08:36:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk5MzY1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwMTUxNg==", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r419001516", "bodyText": "Is this file used somewhere?", "author": "gwenneg", "createdAt": "2020-05-02T20:03:26Z", "path": "extensions/spring-cache/deployment/src/test/resources/cache-config-test.properties", "diffHunk": "@@ -0,0 +1,4 @@\n+quarkus.cache.caffeine.\"test-cache\".initial-capacity=10\n+quarkus.cache.caffeine.\"test-cache\".maximum-size=100\n+quarkus.cache.caffeine.\"test-cache\".expire-after-write=30\n+quarkus.cache.caffeine.\"test-cache\".expire-after-access=P2D", "originalCommit": "d8fd2c9aa5ccd3bb7c2fd06ef5b067fe50111889", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA2OTM0Mw==", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r419069343", "bodyText": "Nope, it got carried over from me copy-pasting test code. Thanks for spotting", "author": "geoand", "createdAt": "2020-05-03T08:36:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwMTUxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwMjQ5OA==", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r419002498", "bodyText": "This message is not consistent with the test.", "author": "gwenneg", "createdAt": "2020-05-02T20:13:32Z", "path": "extensions/spring-cache/deployment/src/test/java/io/quarkus/cache/test/runtime/UnsupportedAnnotationValueTest.java", "diffHunk": "@@ -0,0 +1,37 @@\n+package io.quarkus.cache.test.runtime;\n+\n+import static org.junit.jupiter.api.Assertions.fail;\n+\n+import javax.inject.Singleton;\n+\n+import org.jboss.shrinkwrap.api.ShrinkWrap;\n+import org.jboss.shrinkwrap.api.spec.JavaArchive;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.RegisterExtension;\n+import org.springframework.cache.annotation.Cacheable;\n+\n+import io.quarkus.test.QuarkusUnitTest;\n+\n+public class UnsupportedAnnotationValueTest {\n+\n+    @RegisterExtension\n+    static final QuarkusUnitTest TEST = new QuarkusUnitTest().setArchiveProducer(\n+            () -> ShrinkWrap.create(JavaArchive.class).addClass(CachedService.class))\n+            .setExpectedException(IllegalArgumentException.class);\n+\n+    @Test\n+    public void testApplicationShouldNotStart() {\n+        fail(\"Application should not start when Spring caching annotations are used on a class instead of a method\");", "originalCommit": "d8fd2c9aa5ccd3bb7c2fd06ef5b067fe50111889", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA3MDc3Mg==", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r419070772", "bodyText": "Fixed", "author": "geoand", "createdAt": "2020-05-03T08:49:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwMjQ5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwMzIzNQ==", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r419003235", "bodyText": "Is it OK to put the link here while the guide isn't part of the PR?", "author": "gwenneg", "createdAt": "2020-05-02T20:20:31Z", "path": "extensions/spring-cache/runtime/src/main/resources/META-INF/quarkus-extension.yaml", "diffHunk": "@@ -0,0 +1,10 @@\n+---\n+name: \"Quarkus Extension for Spring Cache API\"\n+metadata:\n+  keywords:\n+  - \"spring-cache\"\n+  - \"spring\"\n+  guide: \"https://quarkus.io/guides/spring-cache\"", "originalCommit": "d8fd2c9aa5ccd3bb7c2fd06ef5b067fe50111889", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA2OTUxNA==", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r419069514", "bodyText": "Yeah, it's fine since I'll be getting the guide in before the next release.", "author": "geoand", "createdAt": "2020-05-03T08:38:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwMzIzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwMzYwOQ==", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r419003609", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        AnnotationInstance cacheResult = methodInfo.annotation(CACHEABLE);\n          \n          \n            \n                        AnnotationInstance cacheable = methodInfo.annotation(CACHEABLE);", "author": "gwenneg", "createdAt": "2020-05-02T20:24:08Z", "path": "extensions/spring-cache/deployment/src/main/java/io/quarkus/spring/cache/SpringCacheAnnotationsTransformer.java", "diffHunk": "@@ -0,0 +1,82 @@\n+package io.quarkus.spring.cache;\n+\n+import static io.quarkus.spring.cache.SpringCacheProcessor.CACHEABLE;\n+import static io.quarkus.spring.cache.SpringCacheProcessor.CACHE_EVICT;\n+import static io.quarkus.spring.cache.SpringCacheProcessor.CACHE_PUT;\n+import static io.quarkus.spring.cache.SpringCacheUtil.getSpringCacheName;\n+\n+import org.jboss.jandex.AnnotationInstance;\n+import org.jboss.jandex.AnnotationTarget;\n+import org.jboss.jandex.AnnotationValue;\n+import org.jboss.jandex.DotName;\n+import org.jboss.jandex.MethodInfo;\n+\n+import io.quarkus.arc.processor.AnnotationsTransformer;\n+import io.quarkus.cache.deployment.CacheDeploymentConstants;\n+import io.quarkus.cache.runtime.CacheInvalidateAllInterceptorBinding;\n+import io.quarkus.cache.runtime.CacheInvalidateInterceptorBinding;\n+import io.quarkus.cache.runtime.CacheResultInterceptorBinding;\n+\n+public class SpringCacheAnnotationsTransformer implements AnnotationsTransformer {\n+\n+    private static final DotName CACHE_RESULT_INTERCEPTOR_BINDING = DotName\n+            .createSimple(CacheResultInterceptorBinding.class.getName());\n+    private static final DotName CACHE_INVALIDATE_INTERCEPTOR_BINDING = DotName\n+            .createSimple(CacheInvalidateInterceptorBinding.class.getName());\n+    private static final DotName CACHE_INVALIDATE_ALL_INTERCEPTOR_BINDING = DotName\n+            .createSimple(CacheInvalidateAllInterceptorBinding.class.getName());\n+\n+    @Override\n+    public boolean appliesTo(AnnotationTarget.Kind kind) {\n+        return kind == AnnotationTarget.Kind.METHOD;\n+    }\n+\n+    @Override\n+    public void transform(TransformationContext transformationContext) {\n+        AnnotationTarget target = transformationContext.getTarget();\n+        if (target.kind() != AnnotationTarget.Kind.METHOD) {\n+            return;\n+        }\n+        MethodInfo methodInfo = target.asMethod();\n+        if (methodInfo.hasAnnotation(CACHEABLE)) {\n+            AnnotationInstance cacheResult = methodInfo.annotation(CACHEABLE);", "originalCommit": "d8fd2c9aa5ccd3bb7c2fd06ef5b067fe50111889", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE1ODgxNg==", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r419158816", "bodyText": "This one doesn't look resolved.", "author": "gwenneg", "createdAt": "2020-05-03T20:54:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwMzYwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE2MDQzNw==", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r419160437", "bodyText": "Fixed", "author": "geoand", "createdAt": "2020-05-03T21:08:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwMzYwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwMzYzNw==", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r419003637", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        AnnotationInstance cacheResult = methodInfo.annotation(CACHE_PUT);\n          \n          \n            \n                        AnnotationInstance cachePut = methodInfo.annotation(CACHE_PUT);", "author": "gwenneg", "createdAt": "2020-05-02T20:24:28Z", "path": "extensions/spring-cache/deployment/src/main/java/io/quarkus/spring/cache/SpringCacheAnnotationsTransformer.java", "diffHunk": "@@ -0,0 +1,82 @@\n+package io.quarkus.spring.cache;\n+\n+import static io.quarkus.spring.cache.SpringCacheProcessor.CACHEABLE;\n+import static io.quarkus.spring.cache.SpringCacheProcessor.CACHE_EVICT;\n+import static io.quarkus.spring.cache.SpringCacheProcessor.CACHE_PUT;\n+import static io.quarkus.spring.cache.SpringCacheUtil.getSpringCacheName;\n+\n+import org.jboss.jandex.AnnotationInstance;\n+import org.jboss.jandex.AnnotationTarget;\n+import org.jboss.jandex.AnnotationValue;\n+import org.jboss.jandex.DotName;\n+import org.jboss.jandex.MethodInfo;\n+\n+import io.quarkus.arc.processor.AnnotationsTransformer;\n+import io.quarkus.cache.deployment.CacheDeploymentConstants;\n+import io.quarkus.cache.runtime.CacheInvalidateAllInterceptorBinding;\n+import io.quarkus.cache.runtime.CacheInvalidateInterceptorBinding;\n+import io.quarkus.cache.runtime.CacheResultInterceptorBinding;\n+\n+public class SpringCacheAnnotationsTransformer implements AnnotationsTransformer {\n+\n+    private static final DotName CACHE_RESULT_INTERCEPTOR_BINDING = DotName\n+            .createSimple(CacheResultInterceptorBinding.class.getName());\n+    private static final DotName CACHE_INVALIDATE_INTERCEPTOR_BINDING = DotName\n+            .createSimple(CacheInvalidateInterceptorBinding.class.getName());\n+    private static final DotName CACHE_INVALIDATE_ALL_INTERCEPTOR_BINDING = DotName\n+            .createSimple(CacheInvalidateAllInterceptorBinding.class.getName());\n+\n+    @Override\n+    public boolean appliesTo(AnnotationTarget.Kind kind) {\n+        return kind == AnnotationTarget.Kind.METHOD;\n+    }\n+\n+    @Override\n+    public void transform(TransformationContext transformationContext) {\n+        AnnotationTarget target = transformationContext.getTarget();\n+        if (target.kind() != AnnotationTarget.Kind.METHOD) {\n+            return;\n+        }\n+        MethodInfo methodInfo = target.asMethod();\n+        if (methodInfo.hasAnnotation(CACHEABLE)) {\n+            AnnotationInstance cacheResult = methodInfo.annotation(CACHEABLE);\n+            String cacheName = getSpringCacheName(cacheResult);\n+            if ((cacheName != null) && !cacheName.isEmpty()) {\n+                transformationContext.transform().add(CACHE_RESULT_INTERCEPTOR_BINDING,\n+                        AnnotationValue.createStringValue(CacheDeploymentConstants.CACHE_NAME_PARAM, cacheName)).done();\n+            }\n+        } else if (methodInfo.hasAnnotation(CACHE_EVICT)) {\n+            AnnotationInstance cacheEvict = methodInfo.annotation(CACHE_EVICT);\n+            String cacheName = getSpringCacheName(cacheEvict);\n+            if ((cacheName == null) || cacheName.isEmpty()) {\n+                return;\n+            }\n+            AnnotationValue allEntriesValue = cacheEvict.value(\"allEntries\");\n+            boolean allEntries = false;\n+            if (allEntriesValue != null) {\n+                allEntries = allEntriesValue.asBoolean();\n+            }\n+            transformationContext.transform()\n+                    .add(allEntries ? CACHE_INVALIDATE_ALL_INTERCEPTOR_BINDING\n+                            : CACHE_INVALIDATE_INTERCEPTOR_BINDING,\n+                            AnnotationValue.createStringValue(CacheDeploymentConstants.CACHE_NAME_PARAM, cacheName))\n+                    .done();\n+        } else if (methodInfo.hasAnnotation(CACHE_PUT)) {\n+            /*\n+             * @CachePut is just an operation that overrides the cache entry with the new result so it is\n+             * equivalent of first invalidating the cache entry and then adding the new result\n+             */\n+            AnnotationInstance cacheResult = methodInfo.annotation(CACHE_PUT);", "originalCommit": "d8fd2c9aa5ccd3bb7c2fd06ef5b067fe50111889", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwNTIwNA==", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r419005204", "bodyText": "Out of curiosity, will key be supported in the future?", "author": "gwenneg", "createdAt": "2020-05-02T20:39:03Z", "path": "extensions/spring-cache/deployment/src/main/java/io/quarkus/spring/cache/SpringCacheProcessor.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package io.quarkus.spring.cache;\n+\n+import static io.quarkus.spring.cache.SpringCacheUtil.*;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+import org.jboss.jandex.AnnotationInstance;\n+import org.jboss.jandex.AnnotationTarget;\n+import org.jboss.jandex.AnnotationValue;\n+import org.jboss.jandex.DotName;\n+import org.springframework.cache.annotation.CacheEvict;\n+import org.springframework.cache.annotation.CachePut;\n+import org.springframework.cache.annotation.Cacheable;\n+\n+import io.quarkus.arc.deployment.AnnotationsTransformerBuildItem;\n+import io.quarkus.cache.deployment.AdditionalCacheNameBuildItem;\n+import io.quarkus.deployment.annotations.BuildProducer;\n+import io.quarkus.deployment.annotations.BuildStep;\n+import io.quarkus.deployment.builditem.CombinedIndexBuildItem;\n+import io.quarkus.deployment.builditem.FeatureBuildItem;\n+\n+public class SpringCacheProcessor {\n+\n+    static final DotName CACHEABLE = DotName.createSimple(Cacheable.class.getName());\n+    static final DotName CACHE_PUT = DotName.createSimple(CachePut.class.getName());\n+    static final DotName CACHE_EVICT = DotName.createSimple(CacheEvict.class.getName());\n+\n+    private static final List<DotName> CACHE_ANNOTATIONS = Collections\n+            .unmodifiableList(Arrays.asList(CACHEABLE, CACHE_PUT, CACHE_EVICT));\n+\n+    // some of these restrictions can probably lifted by us doing additional work on caching after https://github.com/quarkusio/quarkus/pull/8631 lands\n+    private static final Set<String> CURRENTLY_UNSUPPORTED_ANNOTATION_VALUES = Collections\n+            .unmodifiableSet(new HashSet<>(Arrays.asList(\"key\", \"keyGenerator\", \"cacheManager\", \"cacheResolver\", \"condition\",\n+                    \"unless\", \"sync\", \"beforeInvocation\")));", "originalCommit": "d8fd2c9aa5ccd3bb7c2fd06ef5b067fe50111889", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAxMjk2OQ==", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r419012969", "bodyText": "Yes, I plan to add support for it. It shouldn't be too tough, but it will require more control over the interceptors than we currently have. We'll need something akin to what Spring Security uses.", "author": "geoand", "createdAt": "2020-05-02T21:57:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwNTIwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwNTgyMQ==", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r419005821", "bodyText": "Is it OK to silently ignore at build time a @Cacheable annotation because of the absence of cache name?\nSame question for the other cases below.", "author": "gwenneg", "createdAt": "2020-05-02T20:44:51Z", "path": "extensions/spring-cache/deployment/src/main/java/io/quarkus/spring/cache/SpringCacheAnnotationsTransformer.java", "diffHunk": "@@ -0,0 +1,82 @@\n+package io.quarkus.spring.cache;\n+\n+import static io.quarkus.spring.cache.SpringCacheProcessor.CACHEABLE;\n+import static io.quarkus.spring.cache.SpringCacheProcessor.CACHE_EVICT;\n+import static io.quarkus.spring.cache.SpringCacheProcessor.CACHE_PUT;\n+import static io.quarkus.spring.cache.SpringCacheUtil.getSpringCacheName;\n+\n+import org.jboss.jandex.AnnotationInstance;\n+import org.jboss.jandex.AnnotationTarget;\n+import org.jboss.jandex.AnnotationValue;\n+import org.jboss.jandex.DotName;\n+import org.jboss.jandex.MethodInfo;\n+\n+import io.quarkus.arc.processor.AnnotationsTransformer;\n+import io.quarkus.cache.deployment.CacheDeploymentConstants;\n+import io.quarkus.cache.runtime.CacheInvalidateAllInterceptorBinding;\n+import io.quarkus.cache.runtime.CacheInvalidateInterceptorBinding;\n+import io.quarkus.cache.runtime.CacheResultInterceptorBinding;\n+\n+public class SpringCacheAnnotationsTransformer implements AnnotationsTransformer {\n+\n+    private static final DotName CACHE_RESULT_INTERCEPTOR_BINDING = DotName\n+            .createSimple(CacheResultInterceptorBinding.class.getName());\n+    private static final DotName CACHE_INVALIDATE_INTERCEPTOR_BINDING = DotName\n+            .createSimple(CacheInvalidateInterceptorBinding.class.getName());\n+    private static final DotName CACHE_INVALIDATE_ALL_INTERCEPTOR_BINDING = DotName\n+            .createSimple(CacheInvalidateAllInterceptorBinding.class.getName());\n+\n+    @Override\n+    public boolean appliesTo(AnnotationTarget.Kind kind) {\n+        return kind == AnnotationTarget.Kind.METHOD;\n+    }\n+\n+    @Override\n+    public void transform(TransformationContext transformationContext) {\n+        AnnotationTarget target = transformationContext.getTarget();\n+        if (target.kind() != AnnotationTarget.Kind.METHOD) {\n+            return;\n+        }\n+        MethodInfo methodInfo = target.asMethod();\n+        if (methodInfo.hasAnnotation(CACHEABLE)) {\n+            AnnotationInstance cacheResult = methodInfo.annotation(CACHEABLE);\n+            String cacheName = getSpringCacheName(cacheResult);\n+            if ((cacheName != null) && !cacheName.isEmpty()) {\n+                transformationContext.transform().add(CACHE_RESULT_INTERCEPTOR_BINDING,\n+                        AnnotationValue.createStringValue(CacheDeploymentConstants.CACHE_NAME_PARAM, cacheName)).done();\n+            }", "originalCommit": "d8fd2c9aa5ccd3bb7c2fd06ef5b067fe50111889", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA3MDcyMw==", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r419070723", "bodyText": "Good idea, I'll add a warning", "author": "geoand", "createdAt": "2020-05-03T08:49:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwNTgyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwNjE2Ng==", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r419006166", "bodyText": "The code would be easier to read if this test was like the other ones :)\nEdit: See this comment first.", "author": "gwenneg", "createdAt": "2020-05-02T20:48:33Z", "path": "extensions/spring-cache/deployment/src/main/java/io/quarkus/spring/cache/SpringCacheAnnotationsTransformer.java", "diffHunk": "@@ -0,0 +1,82 @@\n+package io.quarkus.spring.cache;\n+\n+import static io.quarkus.spring.cache.SpringCacheProcessor.CACHEABLE;\n+import static io.quarkus.spring.cache.SpringCacheProcessor.CACHE_EVICT;\n+import static io.quarkus.spring.cache.SpringCacheProcessor.CACHE_PUT;\n+import static io.quarkus.spring.cache.SpringCacheUtil.getSpringCacheName;\n+\n+import org.jboss.jandex.AnnotationInstance;\n+import org.jboss.jandex.AnnotationTarget;\n+import org.jboss.jandex.AnnotationValue;\n+import org.jboss.jandex.DotName;\n+import org.jboss.jandex.MethodInfo;\n+\n+import io.quarkus.arc.processor.AnnotationsTransformer;\n+import io.quarkus.cache.deployment.CacheDeploymentConstants;\n+import io.quarkus.cache.runtime.CacheInvalidateAllInterceptorBinding;\n+import io.quarkus.cache.runtime.CacheInvalidateInterceptorBinding;\n+import io.quarkus.cache.runtime.CacheResultInterceptorBinding;\n+\n+public class SpringCacheAnnotationsTransformer implements AnnotationsTransformer {\n+\n+    private static final DotName CACHE_RESULT_INTERCEPTOR_BINDING = DotName\n+            .createSimple(CacheResultInterceptorBinding.class.getName());\n+    private static final DotName CACHE_INVALIDATE_INTERCEPTOR_BINDING = DotName\n+            .createSimple(CacheInvalidateInterceptorBinding.class.getName());\n+    private static final DotName CACHE_INVALIDATE_ALL_INTERCEPTOR_BINDING = DotName\n+            .createSimple(CacheInvalidateAllInterceptorBinding.class.getName());\n+\n+    @Override\n+    public boolean appliesTo(AnnotationTarget.Kind kind) {\n+        return kind == AnnotationTarget.Kind.METHOD;\n+    }\n+\n+    @Override\n+    public void transform(TransformationContext transformationContext) {\n+        AnnotationTarget target = transformationContext.getTarget();\n+        if (target.kind() != AnnotationTarget.Kind.METHOD) {\n+            return;\n+        }\n+        MethodInfo methodInfo = target.asMethod();\n+        if (methodInfo.hasAnnotation(CACHEABLE)) {\n+            AnnotationInstance cacheResult = methodInfo.annotation(CACHEABLE);\n+            String cacheName = getSpringCacheName(cacheResult);\n+            if ((cacheName != null) && !cacheName.isEmpty()) {\n+                transformationContext.transform().add(CACHE_RESULT_INTERCEPTOR_BINDING,\n+                        AnnotationValue.createStringValue(CacheDeploymentConstants.CACHE_NAME_PARAM, cacheName)).done();\n+            }\n+        } else if (methodInfo.hasAnnotation(CACHE_EVICT)) {\n+            AnnotationInstance cacheEvict = methodInfo.annotation(CACHE_EVICT);\n+            String cacheName = getSpringCacheName(cacheEvict);\n+            if ((cacheName == null) || cacheName.isEmpty()) {", "originalCommit": "d8fd2c9aa5ccd3bb7c2fd06ef5b067fe50111889", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwNjM3NA==", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r419006374", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    feature.produce(new FeatureBuildItem(FeatureBuildItem.SPRING_CLOUD_CONFIG_CLIENT));\n          \n          \n            \n                    feature.produce(new FeatureBuildItem(FeatureBuildItem.SPRING_CACHE));", "author": "gwenneg", "createdAt": "2020-05-02T20:50:20Z", "path": "extensions/spring-cache/deployment/src/main/java/io/quarkus/spring/cache/SpringCacheProcessor.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package io.quarkus.spring.cache;\n+\n+import static io.quarkus.spring.cache.SpringCacheUtil.*;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+import org.jboss.jandex.AnnotationInstance;\n+import org.jboss.jandex.AnnotationTarget;\n+import org.jboss.jandex.AnnotationValue;\n+import org.jboss.jandex.DotName;\n+import org.springframework.cache.annotation.CacheEvict;\n+import org.springframework.cache.annotation.CachePut;\n+import org.springframework.cache.annotation.Cacheable;\n+\n+import io.quarkus.arc.deployment.AnnotationsTransformerBuildItem;\n+import io.quarkus.cache.deployment.AdditionalCacheNameBuildItem;\n+import io.quarkus.deployment.annotations.BuildProducer;\n+import io.quarkus.deployment.annotations.BuildStep;\n+import io.quarkus.deployment.builditem.CombinedIndexBuildItem;\n+import io.quarkus.deployment.builditem.FeatureBuildItem;\n+\n+public class SpringCacheProcessor {\n+\n+    static final DotName CACHEABLE = DotName.createSimple(Cacheable.class.getName());\n+    static final DotName CACHE_PUT = DotName.createSimple(CachePut.class.getName());\n+    static final DotName CACHE_EVICT = DotName.createSimple(CacheEvict.class.getName());\n+\n+    private static final List<DotName> CACHE_ANNOTATIONS = Collections\n+            .unmodifiableList(Arrays.asList(CACHEABLE, CACHE_PUT, CACHE_EVICT));\n+\n+    // some of these restrictions can probably lifted by us doing additional work on caching after https://github.com/quarkusio/quarkus/pull/8631 lands\n+    private static final Set<String> CURRENTLY_UNSUPPORTED_ANNOTATION_VALUES = Collections\n+            .unmodifiableSet(new HashSet<>(Arrays.asList(\"key\", \"keyGenerator\", \"cacheManager\", \"cacheResolver\", \"condition\",\n+                    \"unless\", \"sync\", \"beforeInvocation\")));\n+\n+    @BuildStep\n+    void feature(BuildProducer<FeatureBuildItem> feature) {\n+        feature.produce(new FeatureBuildItem(FeatureBuildItem.SPRING_CLOUD_CONFIG_CLIENT));", "originalCommit": "d8fd2c9aa5ccd3bb7c2fd06ef5b067fe50111889", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwNjUzNg==", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r419006536", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                + String.join(\",\", unsupportedValues));\n          \n          \n            \n                                + String.join(\", \", unsupportedValues));", "author": "gwenneg", "createdAt": "2020-05-02T20:51:54Z", "path": "extensions/spring-cache/deployment/src/main/java/io/quarkus/spring/cache/SpringCacheProcessor.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package io.quarkus.spring.cache;\n+\n+import static io.quarkus.spring.cache.SpringCacheUtil.*;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+import org.jboss.jandex.AnnotationInstance;\n+import org.jboss.jandex.AnnotationTarget;\n+import org.jboss.jandex.AnnotationValue;\n+import org.jboss.jandex.DotName;\n+import org.springframework.cache.annotation.CacheEvict;\n+import org.springframework.cache.annotation.CachePut;\n+import org.springframework.cache.annotation.Cacheable;\n+\n+import io.quarkus.arc.deployment.AnnotationsTransformerBuildItem;\n+import io.quarkus.cache.deployment.AdditionalCacheNameBuildItem;\n+import io.quarkus.deployment.annotations.BuildProducer;\n+import io.quarkus.deployment.annotations.BuildStep;\n+import io.quarkus.deployment.builditem.CombinedIndexBuildItem;\n+import io.quarkus.deployment.builditem.FeatureBuildItem;\n+\n+public class SpringCacheProcessor {\n+\n+    static final DotName CACHEABLE = DotName.createSimple(Cacheable.class.getName());\n+    static final DotName CACHE_PUT = DotName.createSimple(CachePut.class.getName());\n+    static final DotName CACHE_EVICT = DotName.createSimple(CacheEvict.class.getName());\n+\n+    private static final List<DotName> CACHE_ANNOTATIONS = Collections\n+            .unmodifiableList(Arrays.asList(CACHEABLE, CACHE_PUT, CACHE_EVICT));\n+\n+    // some of these restrictions can probably lifted by us doing additional work on caching after https://github.com/quarkusio/quarkus/pull/8631 lands\n+    private static final Set<String> CURRENTLY_UNSUPPORTED_ANNOTATION_VALUES = Collections\n+            .unmodifiableSet(new HashSet<>(Arrays.asList(\"key\", \"keyGenerator\", \"cacheManager\", \"cacheResolver\", \"condition\",\n+                    \"unless\", \"sync\", \"beforeInvocation\")));\n+\n+    @BuildStep\n+    void feature(BuildProducer<FeatureBuildItem> feature) {\n+        feature.produce(new FeatureBuildItem(FeatureBuildItem.SPRING_CLOUD_CONFIG_CLIENT));\n+    }\n+\n+    @BuildStep\n+    AnnotationsTransformerBuildItem transform() {\n+        return new AnnotationsTransformerBuildItem(new SpringCacheAnnotationsTransformer());\n+    }\n+\n+    @BuildStep\n+    List<AdditionalCacheNameBuildItem> cacheNames(CombinedIndexBuildItem combinedIndex) {\n+        Set<String> cacheNames = new HashSet<>();\n+        for (DotName cacheAnnotation : CACHE_ANNOTATIONS) {\n+            Collection<AnnotationInstance> instances = combinedIndex.getIndex().getAnnotations(cacheAnnotation);\n+            for (AnnotationInstance instance : instances) {\n+                validateUsage(instance);\n+                String cacheName = getSpringCacheName(instance);\n+                if ((cacheName != null) && !cacheName.isEmpty()) {\n+                    cacheNames.add(cacheName);\n+                }\n+            }\n+        }\n+        List<AdditionalCacheNameBuildItem> result = new ArrayList<>(cacheNames.size());\n+        for (String cacheName : cacheNames) {\n+            result.add(new AdditionalCacheNameBuildItem(cacheName));\n+        }\n+        return result;\n+    }\n+\n+    private void validateUsage(AnnotationInstance instance) {\n+        if (instance.target().kind() != AnnotationTarget.Kind.METHOD) {\n+            throw new IllegalArgumentException(\n+                    \"Currently Spring Caching annotations can only be added to methods. Offending instance is annotation '\"\n+                            + instance + \"' on \" + instance.target() + \"'\");\n+        }\n+        List<AnnotationValue> values = instance.values();\n+        List<String> unsupportedValues = new ArrayList<>();\n+        for (AnnotationValue value : values) {\n+            if (CURRENTLY_UNSUPPORTED_ANNOTATION_VALUES.contains(value.name())) {\n+                unsupportedValues.add(value.name());\n+            }\n+        }\n+        if (!unsupportedValues.isEmpty()) {\n+            throw new IllegalArgumentException(\"Annotation '\" +\n+                    instance + \"' on '\" + instance.target()\n+                    + \"' contains the following currently unsupported annotation values: \"\n+                    + String.join(\",\", unsupportedValues));", "originalCommit": "d8fd2c9aa5ccd3bb7c2fd06ef5b067fe50111889", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwNzA2Mg==", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r419007062", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                static String getSpringCacheName(AnnotationInstance annotationInstance) {\n          \n          \n            \n                static Optional<String> getSpringCacheName(AnnotationInstance annotationInstance) {\n          \n      \n    \n    \n  \n\nReturning an Optional here that would be empty when cacheName == null || cacheName.isEmpty() could help reducing the number of tests conditions in SpringCacheAnnotationsTransformer.", "author": "gwenneg", "createdAt": "2020-05-02T20:56:42Z", "path": "extensions/spring-cache/deployment/src/main/java/io/quarkus/spring/cache/SpringCacheUtil.java", "diffHunk": "@@ -0,0 +1,46 @@\n+package io.quarkus.spring.cache;\n+\n+import org.jboss.jandex.AnnotationInstance;\n+import org.jboss.jandex.AnnotationTarget;\n+import org.jboss.jandex.AnnotationValue;\n+\n+final class SpringCacheUtil {\n+\n+    private SpringCacheUtil() {\n+    }\n+\n+    /**\n+     * Meant to be called for instances of {@code @Cacheable}, {@code @CacheEvict} or {@code @CachePut}\n+     * Returns the single name of the cache to use\n+     */\n+    static String getSpringCacheName(AnnotationInstance annotationInstance) {", "originalCommit": "d8fd2c9aa5ccd3bb7c2fd06ef5b067fe50111889", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA3MDAzNA==", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r419070034", "bodyText": "Makes sense.", "author": "geoand", "createdAt": "2020-05-03T08:42:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwNzA2Mg=="}], "type": "inlineReview"}, {"oid": "0f8a9aec176aa5066dbbd9ed309aa6a734da0b58", "url": "https://github.com/quarkusio/quarkus/commit/0f8a9aec176aa5066dbbd9ed309aa6a734da0b58", "message": "Add first version of Spring Cache annotations\n\nCo-authored-by: Gwenneg Lepage <gwenneg@users.noreply.github.com>", "committedDate": "2020-05-03T08:48:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE1OTE3Mg==", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r419159172", "bodyText": "You had an empty string check before, it is gone on purpose?\nI expected return cacheName == null || cacheName.isEmpty() ? Optional.empty() : Optional.of(cacheName); here.", "author": "gwenneg", "createdAt": "2020-05-03T20:57:47Z", "path": "extensions/spring-cache/deployment/src/main/java/io/quarkus/spring/cache/SpringCacheUtil.java", "diffHunk": "@@ -0,0 +1,48 @@\n+package io.quarkus.spring.cache;\n+\n+import java.util.Optional;\n+\n+import org.jboss.jandex.AnnotationInstance;\n+import org.jboss.jandex.AnnotationTarget;\n+import org.jboss.jandex.AnnotationValue;\n+\n+final class SpringCacheUtil {\n+\n+    private SpringCacheUtil() {\n+    }\n+\n+    /**\n+     * Meant to be called for instances of {@code @Cacheable}, {@code @CacheEvict} or {@code @CachePut}\n+     * Returns the single name of the cache to use\n+     */\n+    static Optional<String> getSpringCacheName(AnnotationInstance annotationInstance) {\n+        String cacheName = null;\n+        AnnotationValue cacheNameValue = annotationInstance.value(\"cacheNames\");\n+        if (cacheNameValue != null) {\n+            cacheName = singleName(cacheNameValue, annotationInstance.target());\n+        }\n+        if (cacheName == null || cacheName.isEmpty()) {\n+            AnnotationValue value = annotationInstance.value();\n+            if (value != null) {\n+                cacheName = singleName(value, annotationInstance.target());\n+            }\n+        }\n+        return cacheName == null ? Optional.empty() : Optional.of(cacheName);", "originalCommit": "0f8a9aec176aa5066dbbd9ed309aa6a734da0b58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE2MDA0NQ==", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r419160045", "bodyText": "Yeah I guess you are right. I should update it to be on the safe side", "author": "geoand", "createdAt": "2020-05-03T21:04:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE1OTE3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE2MDQ1MQ==", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r419160451", "bodyText": "Fixed", "author": "geoand", "createdAt": "2020-05-03T21:08:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE1OTE3Mg=="}], "type": "inlineReview"}, {"oid": "1c6d725e29087aba3b9104cf72f51a16b6897050", "url": "https://github.com/quarkusio/quarkus/commit/1c6d725e29087aba3b9104cf72f51a16b6897050", "message": "Add first version of Spring Cache annotations\n\nCo-authored-by: Gwenneg Lepage <gwenneg@users.noreply.github.com>", "committedDate": "2020-05-03T21:07:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjcxNzcwMg==", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r422717702", "bodyText": "Isn't that risky to look for geo here while it could match both geo and george?", "author": "gwenneg", "createdAt": "2020-05-10T23:40:25Z", "path": "integration-tests/spring-web/src/test/java/io/quarkus/it/spring/web/SpringCacheControllerTest.java", "diffHunk": "@@ -0,0 +1,30 @@\n+package io.quarkus.it.spring.web;\n+\n+import static org.hamcrest.Matchers.containsString;\n+\n+import org.junit.jupiter.api.Test;\n+\n+import io.quarkus.test.junit.QuarkusTest;\n+import io.restassured.RestAssured;\n+\n+@QuarkusTest\n+public class SpringCacheControllerTest {\n+\n+    @Test\n+    public void testCache() {\n+        // first invocation\n+        RestAssured.when().get(\"/cache/greet/george\").then()\n+                .contentType(\"application/json\")\n+                .body(containsString(\"george\"), containsString(\"0\"));\n+\n+        // second invocation should yield same count\n+        RestAssured.when().get(\"/cache/greet/george\").then()\n+                .contentType(\"application/json\")\n+                .body(containsString(\"george\"), containsString(\"0\"));\n+\n+        // invocation with different key should yield different count\n+        RestAssured.when().get(\"/cache/greet/geo\").then()\n+                .contentType(\"application/json\")\n+                .body(containsString(\"geo\"), containsString(\"1\"));", "originalCommit": "1c6d725e29087aba3b9104cf72f51a16b6897050", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjc3NTY4MA==", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r422775680", "bodyText": "That's a good idea, fixed now", "author": "geoand", "createdAt": "2020-05-11T04:36:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjcxNzcwMg=="}], "type": "inlineReview"}, {"oid": "20747241ffcfb204a09b76b9d981ed9e2e98eea8", "url": "https://github.com/quarkusio/quarkus/commit/20747241ffcfb204a09b76b9d981ed9e2e98eea8", "message": "Add first version of Spring Cache annotations\n\nCo-authored-by: Gwenneg Lepage <gwenneg@users.noreply.github.com>", "committedDate": "2020-05-11T04:35:38Z", "type": "forcePushed"}, {"oid": "eddcbea2900569941fc1610526f97a927b7420cc", "url": "https://github.com/quarkusio/quarkus/commit/eddcbea2900569941fc1610526f97a927b7420cc", "message": "Add first version of Spring Cache annotations\n\nCo-authored-by: Gwenneg Lepage <gwenneg@users.noreply.github.com>", "committedDate": "2020-05-11T17:32:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU1NzQwNw==", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r423557407", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // some of these restrictions can probably lifted by us doing additional work on caching after https://github.com/quarkusio/quarkus/pull/8631 lands\n          \n          \n            \n                // some of these restrictions can probably be lifted by us doing additional work on caching after https://github.com/quarkusio/quarkus/pull/8631 lands", "author": "gsmet", "createdAt": "2020-05-12T08:31:56Z", "path": "extensions/spring-cache/deployment/src/main/java/io/quarkus/spring/cache/SpringCacheProcessor.java", "diffHunk": "@@ -0,0 +1,94 @@\n+package io.quarkus.spring.cache;\n+\n+import static io.quarkus.spring.cache.SpringCacheUtil.*;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.Set;\n+\n+import org.jboss.jandex.AnnotationInstance;\n+import org.jboss.jandex.AnnotationTarget;\n+import org.jboss.jandex.AnnotationValue;\n+import org.jboss.jandex.DotName;\n+import org.springframework.cache.annotation.CacheEvict;\n+import org.springframework.cache.annotation.CachePut;\n+import org.springframework.cache.annotation.Cacheable;\n+\n+import io.quarkus.arc.deployment.AnnotationsTransformerBuildItem;\n+import io.quarkus.cache.deployment.AdditionalCacheNameBuildItem;\n+import io.quarkus.deployment.annotations.BuildProducer;\n+import io.quarkus.deployment.annotations.BuildStep;\n+import io.quarkus.deployment.builditem.CombinedIndexBuildItem;\n+import io.quarkus.deployment.builditem.FeatureBuildItem;\n+\n+public class SpringCacheProcessor {\n+\n+    static final DotName CACHEABLE = DotName.createSimple(Cacheable.class.getName());\n+    static final DotName CACHE_PUT = DotName.createSimple(CachePut.class.getName());\n+    static final DotName CACHE_EVICT = DotName.createSimple(CacheEvict.class.getName());\n+\n+    private static final List<DotName> CACHE_ANNOTATIONS = Collections\n+            .unmodifiableList(Arrays.asList(CACHEABLE, CACHE_PUT, CACHE_EVICT));\n+\n+    // some of these restrictions can probably lifted by us doing additional work on caching after https://github.com/quarkusio/quarkus/pull/8631 lands", "originalCommit": "eddcbea2900569941fc1610526f97a927b7420cc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU1NzcyMw==", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r423557723", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                \"Currently Spring Caching annotations can only be added to methods. Offending instance is annotation '\"\n          \n          \n            \n                                \"Currently Spring Cache annotations can only be added to methods. Offending instance is annotation '\"", "author": "gsmet", "createdAt": "2020-05-12T08:32:30Z", "path": "extensions/spring-cache/deployment/src/main/java/io/quarkus/spring/cache/SpringCacheProcessor.java", "diffHunk": "@@ -0,0 +1,94 @@\n+package io.quarkus.spring.cache;\n+\n+import static io.quarkus.spring.cache.SpringCacheUtil.*;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.Set;\n+\n+import org.jboss.jandex.AnnotationInstance;\n+import org.jboss.jandex.AnnotationTarget;\n+import org.jboss.jandex.AnnotationValue;\n+import org.jboss.jandex.DotName;\n+import org.springframework.cache.annotation.CacheEvict;\n+import org.springframework.cache.annotation.CachePut;\n+import org.springframework.cache.annotation.Cacheable;\n+\n+import io.quarkus.arc.deployment.AnnotationsTransformerBuildItem;\n+import io.quarkus.cache.deployment.AdditionalCacheNameBuildItem;\n+import io.quarkus.deployment.annotations.BuildProducer;\n+import io.quarkus.deployment.annotations.BuildStep;\n+import io.quarkus.deployment.builditem.CombinedIndexBuildItem;\n+import io.quarkus.deployment.builditem.FeatureBuildItem;\n+\n+public class SpringCacheProcessor {\n+\n+    static final DotName CACHEABLE = DotName.createSimple(Cacheable.class.getName());\n+    static final DotName CACHE_PUT = DotName.createSimple(CachePut.class.getName());\n+    static final DotName CACHE_EVICT = DotName.createSimple(CacheEvict.class.getName());\n+\n+    private static final List<DotName> CACHE_ANNOTATIONS = Collections\n+            .unmodifiableList(Arrays.asList(CACHEABLE, CACHE_PUT, CACHE_EVICT));\n+\n+    // some of these restrictions can probably lifted by us doing additional work on caching after https://github.com/quarkusio/quarkus/pull/8631 lands\n+    private static final Set<String> CURRENTLY_UNSUPPORTED_ANNOTATION_VALUES = Collections\n+            .unmodifiableSet(new HashSet<>(Arrays.asList(\"key\", \"keyGenerator\", \"cacheManager\", \"cacheResolver\", \"condition\",\n+                    \"unless\", \"sync\", \"beforeInvocation\")));\n+\n+    @BuildStep\n+    void feature(BuildProducer<FeatureBuildItem> feature) {\n+        feature.produce(new FeatureBuildItem(FeatureBuildItem.SPRING_CACHE));\n+    }\n+\n+    @BuildStep\n+    AnnotationsTransformerBuildItem transform() {\n+        return new AnnotationsTransformerBuildItem(new SpringCacheAnnotationsTransformer());\n+    }\n+\n+    @BuildStep\n+    List<AdditionalCacheNameBuildItem> cacheNames(CombinedIndexBuildItem combinedIndex) {\n+        Set<String> cacheNames = new HashSet<>();\n+        for (DotName cacheAnnotation : CACHE_ANNOTATIONS) {\n+            Collection<AnnotationInstance> instances = combinedIndex.getIndex().getAnnotations(cacheAnnotation);\n+            for (AnnotationInstance instance : instances) {\n+                validateUsage(instance);\n+                Optional<String> cacheName = getSpringCacheName(instance);\n+                if (cacheName.isPresent()) {\n+                    cacheNames.add(cacheName.get());\n+                }\n+            }\n+        }\n+        List<AdditionalCacheNameBuildItem> result = new ArrayList<>(cacheNames.size());\n+        for (String cacheName : cacheNames) {\n+            result.add(new AdditionalCacheNameBuildItem(cacheName));\n+        }\n+        return result;\n+    }\n+\n+    private void validateUsage(AnnotationInstance instance) {\n+        if (instance.target().kind() != AnnotationTarget.Kind.METHOD) {\n+            throw new IllegalArgumentException(\n+                    \"Currently Spring Caching annotations can only be added to methods. Offending instance is annotation '\"", "originalCommit": "eddcbea2900569941fc1610526f97a927b7420cc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU1ODQxMw==", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r423558413", "bodyText": "Not consistent with the deployment name Spring - Cache. Let's try to be consistent with the other Spring extensions whatever they use.", "author": "gsmet", "createdAt": "2020-05-12T08:33:36Z", "path": "extensions/spring-cache/pom.xml", "diffHunk": "@@ -0,0 +1,21 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <parent>\n+        <artifactId>quarkus-build-parent</artifactId>\n+        <groupId>io.quarkus</groupId>\n+        <version>999-SNAPSHOT</version>\n+        <relativePath>../../build-parent/pom.xml</relativePath>\n+    </parent>\n+    <modelVersion>4.0.0</modelVersion>\n+\n+    <artifactId>quarkus-spring-cache-parent</artifactId>\n+    <name>Quarkus - Spring Cache</name>", "originalCommit": "eddcbea2900569941fc1610526f97a927b7420cc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU1ODUzMw==", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r423558533", "bodyText": "Not consistent with the deployment name Spring - Cache.", "author": "gsmet", "createdAt": "2020-05-12T08:33:49Z", "path": "extensions/spring-cache/runtime/pom.xml", "diffHunk": "@@ -0,0 +1,63 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <parent>\n+        <artifactId>quarkus-spring-cache-parent</artifactId>\n+        <groupId>io.quarkus</groupId>\n+        <version>999-SNAPSHOT</version>\n+    </parent>\n+    <modelVersion>4.0.0</modelVersion>\n+\n+    <artifactId>quarkus-spring-cache</artifactId>\n+    <name>Quarkus - Spring Cache - Runtime</name>", "originalCommit": "eddcbea2900569941fc1610526f97a927b7420cc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU1ODkyMA==", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r423558920", "bodyText": "Maybe add cache?", "author": "gsmet", "createdAt": "2020-05-12T08:34:29Z", "path": "extensions/spring-cache/runtime/src/main/resources/META-INF/quarkus-extension.yaml", "diffHunk": "@@ -0,0 +1,10 @@\n+---\n+name: \"Quarkus Extension for Spring Cache API\"\n+metadata:\n+  keywords:\n+  - \"spring-cache\"\n+  - \"spring\"", "originalCommit": "eddcbea2900569941fc1610526f97a927b7420cc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "778ff5196edbfff83faf6eaf926e05c2f0030d6d", "url": "https://github.com/quarkusio/quarkus/commit/778ff5196edbfff83faf6eaf926e05c2f0030d6d", "message": "Add first version of Spring Cache annotations\n\nCo-authored-by: Gwenneg Lepage <gwenneg@users.noreply.github.com>\nCo-authored-by: Guillaume Smet <guillaume.smet@gmail.com>", "committedDate": "2020-05-12T08:38:55Z", "type": "commit"}, {"oid": "778ff5196edbfff83faf6eaf926e05c2f0030d6d", "url": "https://github.com/quarkusio/quarkus/commit/778ff5196edbfff83faf6eaf926e05c2f0030d6d", "message": "Add first version of Spring Cache annotations\n\nCo-authored-by: Gwenneg Lepage <gwenneg@users.noreply.github.com>\nCo-authored-by: Guillaume Smet <guillaume.smet@gmail.com>", "committedDate": "2020-05-12T08:38:55Z", "type": "forcePushed"}]}