{"pr_number": 8866, "pr_title": "Don't generate ArC beans for platform beans that have already been defined", "pr_createdAt": "2020-04-27T06:54:17Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/8866", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU4MjYwNg==", "url": "https://github.com/quarkusio/quarkus/pull/8866#discussion_r415582606", "bodyText": "We can't do this for synthetic beans because they may depend on application classes, either any of the attribute or even the existence could be conditioned. An example - for every class X annotated with @Foo generate a synthetic bean with bean types X and all interfaces it implements.", "author": "mkouba", "createdAt": "2020-04-27T07:40:39Z", "path": "independent-projects/arc/processor/src/main/java/io/quarkus/arc/processor/BeanGenerator.java", "diffHunk": "@@ -96,28 +96,35 @@ public BeanGenerator(AnnotationLiteralProcessor annotationLiterals, Predicate<Do\n     /**\n      *\n      * @param bean\n+     * @param existingClasses\n+     * @param beanToGeneratedName\n      * @return a collection of resources\n      */\n-    Collection<Resource> generate(BeanInfo bean, ReflectionRegistration reflectionRegistration) {\n+    Collection<Resource> generate(BeanInfo bean, ReflectionRegistration reflectionRegistration, Set<String> existingClasses,\n+            Map<BeanInfo, String> beanToGeneratedName) {\n         if (bean.getTarget().isPresent()) {\n             AnnotationTarget target = bean.getTarget().get();\n             switch (target.kind()) {\n                 case CLASS:\n-                    return generateClassBean(bean, target.asClass(), reflectionRegistration);\n+                    return generateClassBean(bean, target.asClass(), reflectionRegistration, existingClasses,\n+                            beanToGeneratedName);\n                 case METHOD:\n-                    return generateProducerMethodBean(bean, target.asMethod(), reflectionRegistration);\n+                    return generateProducerMethodBean(bean, target.asMethod(), reflectionRegistration, existingClasses,\n+                            beanToGeneratedName);\n                 case FIELD:\n-                    return generateProducerFieldBean(bean, target.asField(), reflectionRegistration);\n+                    return generateProducerFieldBean(bean, target.asField(), reflectionRegistration, existingClasses,\n+                            beanToGeneratedName);\n                 default:\n                     throw new IllegalArgumentException(\"Unsupported bean type\");\n             }\n         } else {\n             // Synthetic beans\n-            return generateSyntheticBean(bean, reflectionRegistration);\n+            return generateSyntheticBean(bean, reflectionRegistration, existingClasses, beanToGeneratedName);", "originalCommit": "88bc300b4f51ec0a141ffd48ce1238158823c0b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTYwNzkwNQ==", "url": "https://github.com/quarkusio/quarkus/pull/8866#discussion_r415607905", "bodyText": "If it is loaded by the base CL then then the bean is immutable anyway, even if you generate it again the changes to not take effect.", "author": "stuartwdouglas", "createdAt": "2020-04-27T08:18:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU4MjYwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTYxOTYxOQ==", "url": "https://github.com/quarkusio/quarkus/pull/8866#discussion_r415619619", "bodyText": "But the CL for nonapp classes should be discarded, or?", "author": "mkouba", "createdAt": "2020-04-27T08:35:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU4MjYwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTYyMzgxNQ==", "url": "https://github.com/quarkusio/quarkus/pull/8866#discussion_r415623815", "bodyText": "the CL for non app beans is not discarded, only for app beans", "author": "stuartwdouglas", "createdAt": "2020-04-27T08:41:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU4MjYwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTYyODc1OA==", "url": "https://github.com/quarkusio/quarkus/pull/8866#discussion_r415628758", "bodyText": "I'm pretty sure we already run into this kind of problem. But I cannot find the relevant issue or code... AFAIR we pretended that the synthetic bean is an app class.", "author": "mkouba", "createdAt": "2020-04-27T08:48:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU4MjYwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTYyOTYyMQ==", "url": "https://github.com/quarkusio/quarkus/pull/8866#discussion_r415629621", "bodyText": "the CL for non app beans is not discarded, only for app beans\n\nYep, that was I typo I spotted too late ;-).", "author": "mkouba", "createdAt": "2020-04-27T08:49:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU4MjYwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTgzNzEwMg==", "url": "https://github.com/quarkusio/quarkus/pull/8866#discussion_r415837102", "bodyText": "I've created #8877.", "author": "mkouba", "createdAt": "2020-04-27T13:59:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU4MjYwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTg0NzkxMA==", "url": "https://github.com/quarkusio/quarkus/pull/8866#discussion_r415847910", "bodyText": "So I think that we could set both the existingClasses and the map to the BeanGenerator final fields and avoid passing more arguments in all those methods. The same applies to ReflectionRegistration BTW. @stuartwdouglas I can add a commit to your PR if you don't mind ;-).", "author": "mkouba", "createdAt": "2020-04-27T14:13:16Z", "path": "independent-projects/arc/processor/src/main/java/io/quarkus/arc/processor/BeanGenerator.java", "diffHunk": "@@ -96,28 +96,35 @@ public BeanGenerator(AnnotationLiteralProcessor annotationLiterals, Predicate<Do\n     /**\n      *\n      * @param bean\n+     * @param existingClasses", "originalCommit": "88bc300b4f51ec0a141ffd48ce1238158823c0b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTg2NjQzOQ==", "url": "https://github.com/quarkusio/quarkus/pull/8866#discussion_r415866439", "bodyText": "Done :-)", "author": "mkouba", "createdAt": "2020-04-27T14:35:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTg0NzkxMA=="}], "type": "inlineReview"}, {"oid": "afb31174f712542d92271a53920eeef79f9af6de", "url": "https://github.com/quarkusio/quarkus/commit/afb31174f712542d92271a53920eeef79f9af6de", "message": "ArC - minor refactoring of generators", "committedDate": "2020-04-27T14:34:24Z", "type": "forcePushed"}, {"oid": "19397ed7970bd8299d8e95a76724329206b7329b", "url": "https://github.com/quarkusio/quarkus/commit/19397ed7970bd8299d8e95a76724329206b7329b", "message": "Don't generate ArC beans for platform beans that have already been defined", "committedDate": "2020-04-28T13:48:40Z", "type": "commit"}, {"oid": "758e8237fc64eaf09c15cdb6b004896ddd732a69", "url": "https://github.com/quarkusio/quarkus/commit/758e8237fc64eaf09c15cdb6b004896ddd732a69", "message": "ArC - minor refactoring of generators", "committedDate": "2020-04-28T13:48:40Z", "type": "commit"}, {"oid": "758e8237fc64eaf09c15cdb6b004896ddd732a69", "url": "https://github.com/quarkusio/quarkus/commit/758e8237fc64eaf09c15cdb6b004896ddd732a69", "message": "ArC - minor refactoring of generators", "committedDate": "2020-04-28T13:48:40Z", "type": "forcePushed"}]}