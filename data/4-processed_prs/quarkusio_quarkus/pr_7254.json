{"pr_number": 7254, "pr_title": "Quartz - make it possible to access the underlying scheduler instance", "pr_createdAt": "2020-02-18T12:13:24Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/7254", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDYzNjU1Mg==", "url": "https://github.com/quarkusio/quarkus/pull/7254#discussion_r380636552", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      Arc.container().instance(TaskBean.class).get().perform(); <3>\n          \n          \n            \n                      Arc.container().instance(TaskBean.class).get(). performTask(); <3>", "author": "machi1990", "createdAt": "2020-02-18T12:18:24Z", "path": "docs/src/main/asciidoc/quartz.adoc", "diffHunk": "@@ -124,6 +124,58 @@ public class TaskBean {\n 3. Create a new `Task` with the current start time.\n 4. Persist the task in database using https://quarkus.io/guides/hibernate-orm-panache[Panache].\n \n+=== Scheduling Jobs Programatically\n+\n+It is also possible to leverage the Quartz API directly.\n+You can inject the underlying `org.quartz.Scheduler` in any bean:\n+\n+[source,java]\n+----\n+package org.acme.quartz;\n+\n+@ApplicationScoped\n+public class TaskBean {\n+\n+    @Inject\n+    org.quartz.Scheduler quartz; <1>\n+    \n+    void onStart(@Observes StartupEvent event) {\n+       JobDetail job = JobBuilder.newJob(MyJob.class)\n+                         .withIdentity(\"myJob\", \"myGroup\")\n+                         .build();\n+       Trigger trigger = TriggerBuilder.newTrigger()\n+                            .withIdentity(\"myTrigger\", \"myGroup\")\n+                            .startNow()\n+                            .withSchedule(\n+                               SimpleScheduleBuilder.simpleSchedule()\n+                                  .withIntervalInSeconds(10)\n+                                  .repeatForever())\n+                            .build();\n+       quartz.scheduleJob(job, trigger); <2>\n+    }\n+    \n+    @Transactional\n+    void performTask() {\n+        Task task = new Task();\n+        task.persist();\n+    }\n+    \n+    // A new instance of MyJob is created by Quartz for every job execution\n+    static class MyJob implements Job {\n+    \n+       public void execute(JobExecutionContext context) throws JobExecutionException {\n+          Arc.container().instance(TaskBean.class).get().perform(); <3>", "originalCommit": "0fed604c4f694d373c287c636f4d2c26c9b4a3f8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDYzODg3MA==", "url": "https://github.com/quarkusio/quarkus/pull/7254#discussion_r380638870", "bodyText": "defaultValue is not necessary. boolean config items defaults to false", "author": "machi1990", "createdAt": "2020-02-18T12:23:24Z", "path": "extensions/quartz/runtime/src/main/java/io/quarkus/quartz/runtime/QuartzRuntimeConfig.java", "diffHunk": "@@ -19,4 +19,12 @@\n     @ConfigItem(defaultValue = \"5\")\n     public int threadPriority;\n \n+    /**\n+     * By default, the scheduler is not started unless a {@link io.quarkus.scheduler.Scheduled} business method is found.\n+     * If set to true the scheduler will be started even if no scheduled business methods are found. This is necessary for\n+     * \"pure\" programmatic scheduling.\n+     */\n+    @ConfigItem(defaultValue = \"false\")", "originalCommit": "0fed604c4f694d373c287c636f4d2c26c9b4a3f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY1MDgyMA==", "url": "https://github.com/quarkusio/quarkus/pull/7254#discussion_r380650820", "bodyText": "I prefer explicit values so I'd like to keep it as it is.", "author": "mkouba", "createdAt": "2020-02-18T12:49:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDYzODg3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY0MDkzMQ==", "url": "https://github.com/quarkusio/quarkus/pull/7254#discussion_r380640931", "bodyText": "We should probably update Quartz QS  with this example", "author": "machi1990", "createdAt": "2020-02-18T12:28:01Z", "path": "docs/src/main/asciidoc/quartz.adoc", "diffHunk": "@@ -124,6 +124,58 @@ public class TaskBean {\n 3. Create a new `Task` with the current start time.\n 4. Persist the task in database using https://quarkus.io/guides/hibernate-orm-panache[Panache].\n \n+=== Scheduling Jobs Programatically\n+\n+It is also possible to leverage the Quartz API directly.\n+You can inject the underlying `org.quartz.Scheduler` in any bean:\n+\n+[source,java]\n+----\n+package org.acme.quartz;\n+\n+@ApplicationScoped\n+public class TaskBean {", "originalCommit": "0fed604c4f694d373c287c636f4d2c26c9b4a3f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY1MDU2OQ==", "url": "https://github.com/quarkusio/quarkus/pull/7254#discussion_r380650569", "bodyText": "I don't think so. This is more like a corner case, ie. something we don't want to push...", "author": "mkouba", "createdAt": "2020-02-18T12:48:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY0MDkzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY0MTQ4MA==", "url": "https://github.com/quarkusio/quarkus/pull/7254#discussion_r380641480", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                .addAsResource(new StringAsset(\"quarkus.quartz-runtime.force-start=true\"),\n          \n          \n            \n                                .addAsResource(new StringAsset(\"quarkus.quartz.force-start=true\"),", "author": "machi1990", "createdAt": "2020-02-18T12:29:09Z", "path": "extensions/quartz/deployment/src/test/java/io/quarkus/quartz/test/InjectQuartzSchedulerTest.java", "diffHunk": "@@ -0,0 +1,68 @@\n+package io.quarkus.quartz.test;\n+\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+\n+import javax.enterprise.event.Observes;\n+\n+import org.jboss.shrinkwrap.api.ShrinkWrap;\n+import org.jboss.shrinkwrap.api.asset.StringAsset;\n+import org.jboss.shrinkwrap.api.spec.JavaArchive;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.RegisterExtension;\n+import org.quartz.Job;\n+import org.quartz.JobBuilder;\n+import org.quartz.JobDetail;\n+import org.quartz.JobExecutionContext;\n+import org.quartz.JobExecutionException;\n+import org.quartz.Scheduler;\n+import org.quartz.SchedulerException;\n+import org.quartz.SimpleScheduleBuilder;\n+import org.quartz.Trigger;\n+import org.quartz.TriggerBuilder;\n+\n+import io.quarkus.runtime.StartupEvent;\n+import io.quarkus.test.QuarkusUnitTest;\n+\n+public class InjectQuartzSchedulerTest {\n+\n+    @RegisterExtension\n+    static final QuarkusUnitTest test = new QuarkusUnitTest()\n+            .setArchiveProducer(() -> ShrinkWrap.create(JavaArchive.class)\n+                    .addClasses(Starter.class)\n+                    .addAsResource(new StringAsset(\"quarkus.quartz-runtime.force-start=true\"),", "originalCommit": "0fed604c4f694d373c287c636f4d2c26c9b4a3f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY1MTI2NQ==", "url": "https://github.com/quarkusio/quarkus/pull/7254#discussion_r380651265", "bodyText": "Unfortunately, quarkus.quartz.force-start=true would not work. See https://quarkusio.zulipchat.com/#narrow/stream/187038-dev/topic/.60RuntimeConfig.60.20vs.20.60RunTimeConfig.60", "author": "mkouba", "createdAt": "2020-02-18T12:50:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY0MTQ4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDcwNzA2Nw==", "url": "https://github.com/quarkusio/quarkus/pull/7254#discussion_r380707067", "bodyText": "I'm going to send a PR to fix #7257 - afterwards, it should be possible to switch to quarkus.quartz.force-start=true.", "author": "mkouba", "createdAt": "2020-02-18T14:31:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY0MTQ4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg1NDA4OQ==", "url": "https://github.com/quarkusio/quarkus/pull/7254#discussion_r380854089", "bodyText": "Thanks @mkouba", "author": "machi1990", "createdAt": "2020-02-18T18:26:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY0MTQ4MA=="}], "type": "inlineReview"}, {"oid": "e88272e3b71ed4925446245d26319651920a8769", "url": "https://github.com/quarkusio/quarkus/commit/e88272e3b71ed4925446245d26319651920a8769", "message": "Quartz - make it possible to access the underlying scheduler instance\n\n- resolves #7246", "committedDate": "2020-02-19T10:39:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMwMDE3Ng==", "url": "https://github.com/quarkusio/quarkus/pull/7254#discussion_r381300176", "bodyText": "Should we use @DefaultBean here?", "author": "gastaldi", "createdAt": "2020-02-19T13:48:53Z", "path": "extensions/quartz/runtime/src/main/java/io/quarkus/quartz/runtime/QuartzScheduler.java", "diffHunk": "@@ -56,8 +59,15 @@\n     private final AtomicInteger triggerNameSequence;\n     private final Map<String, ScheduledInvoker> invokers;\n \n+    @Produces\n+    @Singleton", "originalCommit": "e88272e3b71ed4925446245d26319651920a8769", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMwMjI0OQ==", "url": "https://github.com/quarkusio/quarkus/pull/7254#discussion_r381302249", "bodyText": "I don't think so. Why?", "author": "mkouba", "createdAt": "2020-02-19T13:52:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMwMDE3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMwMjg3Mw==", "url": "https://github.com/quarkusio/quarkus/pull/7254#discussion_r381302873", "bodyText": "When the user code @Produces their own org.quartz.Scheduler?", "author": "gastaldi", "createdAt": "2020-02-19T13:53:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMwMDE3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMwNjg2Mw==", "url": "https://github.com/quarkusio/quarkus/pull/7254#discussion_r381306863", "bodyText": "But maybe we shouldn't allow that anyway :)", "author": "gastaldi", "createdAt": "2020-02-19T13:59:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMwMDE3Ng=="}], "type": "inlineReview"}, {"oid": "c37a1bd0292537324155ab5514a0ab431207baad", "url": "https://github.com/quarkusio/quarkus/commit/c37a1bd0292537324155ab5514a0ab431207baad", "message": "Quartz - make it possible to access the underlying scheduler instance\n\n- resolves #7246", "committedDate": "2020-02-20T15:05:22Z", "type": "commit"}, {"oid": "c37a1bd0292537324155ab5514a0ab431207baad", "url": "https://github.com/quarkusio/quarkus/commit/c37a1bd0292537324155ab5514a0ab431207baad", "message": "Quartz - make it possible to access the underlying scheduler instance\n\n- resolves #7246", "committedDate": "2020-02-20T15:05:22Z", "type": "forcePushed"}]}