{"pr_number": 7749, "pr_title": "fix(#7712): S2i build no longer renames artifacts", "pr_createdAt": "2020-03-10T19:03:29Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/7749", "timeline": [{"oid": "8ed7832bb6a836de8fac17e4eb681a4ad84875ae", "url": "https://github.com/quarkusio/quarkus/commit/8ed7832bb6a836de8fac17e4eb681a4ad84875ae", "message": "fix(#7712): S2i build no longer renames artifacts", "committedDate": "2020-03-10T19:05:05Z", "type": "forcePushed"}, {"oid": "2a5afba54012530256689e03015d0cf0219f059e", "url": "https://github.com/quarkusio/quarkus/commit/2a5afba54012530256689e03015d0cf0219f059e", "message": "fix(#7712): S2i build no longer renames artifacts", "committedDate": "2020-03-10T20:11:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDc2NTEwMg==", "url": "https://github.com/quarkusio/quarkus/pull/7749#discussion_r390765102", "bodyText": "wait - so our own native s2i builder goes an rename to something even more different ?", "author": "maxandersen", "createdAt": "2020-03-11T06:21:13Z", "path": "extensions/container-image/container-image-s2i/deployment/src/main/java/io/quarkus/container/image/s2i/deployment/S2iProcessor.java", "diffHunk": "@@ -102,11 +109,30 @@ public void s2iRequirementsNative(S2iConfig s2iConfig,\n             CurateOutcomeBuildItem curateOutcomeBuildItem,\n             OutputTargetBuildItem out,\n             PackageConfig packageConfig,\n+            NativeImageBuildItem nativeImage,\n             BuildProducer<BaseImageInfoBuildItem> builderImageProducer,\n             BuildProducer<KubernetesCommandBuildItem> commandProducer) {\n \n+        boolean usingDefaultBuilder = ImageUtil.getRepository(S2iConfig.DEFAULT_BASE_NATIVE_IMAGE)\n+                .equals(ImageUtil.getRepository(s2iConfig.baseNativeImage));\n+        String outputNativeBinaryFileName = nativeImage.getPath().getFileName().toString();\n+\n+        String nativeBinaryFileName = null;\n+\n+        //The default s2i builder for native builds, renames the native binary.", "originalCommit": "2a5afba54012530256689e03015d0cf0219f059e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDc4NTc2Ng==", "url": "https://github.com/quarkusio/quarkus/pull/7749#discussion_r390785766", "bodyText": "I also think this shouldn't happen. It was probably a shortcut to make the run script easier. If anything, it shouldn't be a rename but a symlink.", "author": "Ladicek", "createdAt": "2020-03-11T07:31:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDc2NTEwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg5NDUzNA==", "url": "https://github.com/quarkusio/quarkus/pull/7749#discussion_r390894534", "bodyText": "I logged an issue: quarkusio/quarkus-images#58\nUntil the issue is address we need this, so I'll mark this discussion as resolved.", "author": "iocanel", "createdAt": "2020-03-11T11:03:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDc2NTEwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg2NzMxNQ==", "url": "https://github.com/quarkusio/quarkus/pull/7749#discussion_r390867315", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * This option may be used of the selected s2i image uses a fixed name for the jar.\n          \n          \n            \n                 * This option may be used if the selected s2i image uses a fixed name for the jar.", "author": "geoand", "createdAt": "2020-03-11T10:14:38Z", "path": "extensions/container-image/container-image-s2i/deployment/src/main/java/io/quarkus/container/image/s2i/deployment/S2iConfig.java", "diffHunk": "@@ -38,18 +40,32 @@\n     public List<String> nativeArguments;\n \n     /**\n-     * The path to where the jar is added during the assemble phase.\n+     * The directory where the jar is added during the assemble phase.\n      * This is dependant on the s2i image and should be supplied if a non default image is used.\n      */\n-    @ConfigItem(defaultValue = \"/deployments/application${quarkus.package.runner-suffix}.jar\")\n-    public String jarPath;\n+    @ConfigItem(defaultValue = \"/deployments/\")\n+    public String jarDirectory;\n \n     /**\n-     * The path to where the native binary is added during the assemble phase.\n+     * The resulting filename of the jar in the s2i image.\n+     * This option may be used of the selected s2i image uses a fixed name for the jar.", "originalCommit": "2a5afba54012530256689e03015d0cf0219f059e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg2NzcyNg==", "url": "https://github.com/quarkusio/quarkus/pull/7749#discussion_r390867726", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * This is dependant on the s2i image and should be supplied if a non default image is used.\n          \n          \n            \n                 * This is dependant on the s2i image and should be supplied if a non-default image is used.", "author": "geoand", "createdAt": "2020-03-11T10:15:24Z", "path": "extensions/container-image/container-image-s2i/deployment/src/main/java/io/quarkus/container/image/s2i/deployment/S2iConfig.java", "diffHunk": "@@ -38,18 +40,32 @@\n     public List<String> nativeArguments;\n \n     /**\n-     * The path to where the jar is added during the assemble phase.\n+     * The directory where the jar is added during the assemble phase.\n      * This is dependant on the s2i image and should be supplied if a non default image is used.\n      */\n-    @ConfigItem(defaultValue = \"/deployments/application${quarkus.package.runner-suffix}.jar\")\n-    public String jarPath;\n+    @ConfigItem(defaultValue = \"/deployments/\")\n+    public String jarDirectory;\n \n     /**\n-     * The path to where the native binary is added during the assemble phase.\n+     * The resulting filename of the jar in the s2i image.\n+     * This option may be used of the selected s2i image uses a fixed name for the jar.\n+     */\n+    @ConfigItem\n+    public Optional<String> jarFileName;\n+\n+    /**\n+     * The directory where the native binary is added during the assemble phase.\n      * This is dependant on the s2i image and should be supplied if a non default image is used.", "originalCommit": "2a5afba54012530256689e03015d0cf0219f059e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg2Nzk0MA==", "url": "https://github.com/quarkusio/quarkus/pull/7749#discussion_r390867940", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * This option may be used of the selected s2i image uses a fixed name for the native binary.\n          \n          \n            \n                 * This option may be used if the selected s2i image uses a fixed name for the native binary.", "author": "geoand", "createdAt": "2020-03-11T10:15:49Z", "path": "extensions/container-image/container-image-s2i/deployment/src/main/java/io/quarkus/container/image/s2i/deployment/S2iConfig.java", "diffHunk": "@@ -38,18 +40,32 @@\n     public List<String> nativeArguments;\n \n     /**\n-     * The path to where the jar is added during the assemble phase.\n+     * The directory where the jar is added during the assemble phase.\n      * This is dependant on the s2i image and should be supplied if a non default image is used.\n      */\n-    @ConfigItem(defaultValue = \"/deployments/application${quarkus.package.runner-suffix}.jar\")\n-    public String jarPath;\n+    @ConfigItem(defaultValue = \"/deployments/\")\n+    public String jarDirectory;\n \n     /**\n-     * The path to where the native binary is added during the assemble phase.\n+     * The resulting filename of the jar in the s2i image.\n+     * This option may be used of the selected s2i image uses a fixed name for the jar.\n+     */\n+    @ConfigItem\n+    public Optional<String> jarFileName;\n+\n+    /**\n+     * The directory where the native binary is added during the assemble phase.\n      * This is dependant on the s2i image and should be supplied if a non default image is used.\n      */\n-    @ConfigItem(defaultValue = \"/home/quarkus/application\")\n-    public String nativeBinaryPath;\n+    @ConfigItem(defaultValue = \"/home/quarkus/\")\n+    public String nativeBinaryDirectory;\n+\n+    /**\n+     * The resulting filename of the native binary in the s2i image.\n+     * This option may be used of the selected s2i image uses a fixed name for the native binary.", "originalCommit": "2a5afba54012530256689e03015d0cf0219f059e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f82472d4bee88fb0754ccb7405a36c4d89511933", "url": "https://github.com/quarkusio/quarkus/commit/f82472d4bee88fb0754ccb7405a36c4d89511933", "message": "fix(#7712): S2i build no longer renames artifacts", "committedDate": "2020-03-11T11:04:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ2ODEwMA==", "url": "https://github.com/quarkusio/quarkus/pull/7749#discussion_r391468100", "bodyText": "I'm not sure if this is a good idea, purely from \"legal\" point of view. This is RHEL, after all. Too bad UBI Java isn't ready yet :-(", "author": "Ladicek", "createdAt": "2020-03-12T08:37:45Z", "path": "extensions/container-image/container-image-s2i/deployment/src/main/java/io/quarkus/container/image/s2i/deployment/S2iConfig.java", "diffHunk": "@@ -11,7 +11,7 @@\n @ConfigRoot(phase = ConfigPhase.BUILD_TIME)\n public class S2iConfig {\n \n-    public static final String DEFAULT_BASE_JVM_IMAGE = \"fabric8/s2i-java:2.3\";\n+    public static final String DEFAULT_BASE_JVM_IMAGE = \"registry.access.redhat.com/openjdk/openjdk-11-rhel7\";", "originalCommit": "a3a666fc002e576443823dc64ea8b3a8848dbd3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ2ODkwNA==", "url": "https://github.com/quarkusio/quarkus/pull/7749#discussion_r391468904", "bodyText": "@maxandersen any idea about this?", "author": "geoand", "createdAt": "2020-03-12T08:39:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ2ODEwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ3MzQxNw==", "url": "https://github.com/quarkusio/quarkus/pull/7749#discussion_r391473417", "bodyText": "There are 4 Red Hat OpenJDK images that I'm aware of (OpenJDK 8 and 11, RHEL 7 and 8), some of them being available from 2 registries (authenticated and unauthenticated).\n\nOpenJDK 8 (I'm not sure if we still support Java 8, but we probably do. Defaulting to 11 is probably good though.)\n\nRHEL 7\n\nregistry.access.redhat.com/redhat-openjdk-18/openjdk18-openshift\nregistry.redhat.io/redhat-openjdk-18/openjdk18-openshift\n\n\nRHEL 8\n\nregistry.redhat.io/openjdk/openjdk-8-rhel8 (registry.access.redhat.com variant not available)\n\n\n\n\nOpenJDK 11\n\nRHEL 7\n\nregistry.access.redhat.com/openjdk/openjdk-11-rhel7\nregistry.redhat.io/openjdk/openjdk-11-rhel7\n\n\nRHEL 8\n\nregistry.redhat.io/openjdk/openjdk-11-rhel8 (registry.access.redhat.com variant not available)\n\n\n\n\n\nThey all have different tags (as does the Fabric8 image), which should all be recognized. (That is, tag should be ignored when searching.)", "author": "Ladicek", "createdAt": "2020-03-12T08:48:43Z", "path": "extensions/container-image/container-image-s2i/deployment/src/main/java/io/quarkus/container/image/s2i/deployment/S2iBaseJavaImage.java", "diffHunk": "@@ -0,0 +1,64 @@\n+\n+package io.quarkus.container.image.s2i.deployment;\n+\n+import java.util.Optional;\n+\n+import io.quarkus.container.image.deployment.util.ImageUtil;\n+\n+public enum S2iBaseJavaImage {\n+\n+    FABRIC8(\"fabric8/s2i-java:2.3\", \"JAVA_MAIN_CLASS\", \"JAVA_APP_JAR\", \"JAVA_LIB_DIR\", \"JAVA_CLASSPATH\", \"JAVA_OPTIONS\"),\n+    OPENJDK(\"registry.access.redhat.com/openjdk/openjdk-11-rhel7\", \"JAVA_MAIN_CLASS\", \"JAVA_APP_JAR\", \"JAVA_LIB_DIR\",", "originalCommit": "135dc61be2b39f45039b1401ad3b822511121050", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUxNDI0NA==", "url": "https://github.com/quarkusio/quarkus/pull/7749#discussion_r391514244", "bodyText": "Added more images. Also cleaned them up a little bit, as the registry is stripped when performing the comparison.", "author": "iocanel", "createdAt": "2020-03-12T10:04:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ3MzQxNw=="}], "type": "inlineReview"}, {"oid": "223fa0bd9a57f24069cd4b60a2d549ff41eded8d", "url": "https://github.com/quarkusio/quarkus/commit/223fa0bd9a57f24069cd4b60a2d549ff41eded8d", "message": "feat: Enrich and cleanup the s2i base images", "committedDate": "2020-03-12T10:02:28Z", "type": "forcePushed"}, {"oid": "7e7d652e4cebf40bd51d69694b571610f5571bbe", "url": "https://github.com/quarkusio/quarkus/commit/7e7d652e4cebf40bd51d69694b571610f5571bbe", "message": "feat: Enrich and cleanup the s2i base images", "committedDate": "2020-03-12T11:32:13Z", "type": "forcePushed"}, {"oid": "c224346e8deee3360253968cc4100ab3f0997f66", "url": "https://github.com/quarkusio/quarkus/commit/c224346e8deee3360253968cc4100ab3f0997f66", "message": "fix(#7712): S2i build no longer renames artifacts", "committedDate": "2020-03-12T15:25:37Z", "type": "commit"}, {"oid": "0f991bd565679adb310a1e0718a18882523f2ac5", "url": "https://github.com/quarkusio/quarkus/commit/0f991bd565679adb310a1e0718a18882523f2ac5", "message": "fix: wrong value passed to working dir decorator", "committedDate": "2020-03-12T15:25:37Z", "type": "commit"}, {"oid": "fccaaebc5bdd249213cd9464567eef12f9dad4b5", "url": "https://github.com/quarkusio/quarkus/commit/fccaaebc5bdd249213cd9464567eef12f9dad4b5", "message": "fix: Work around duplicating environment variables", "committedDate": "2020-03-12T15:25:37Z", "type": "commit"}, {"oid": "55b9d84cffa01d4ac5b59ac4c62a02583c65edcb", "url": "https://github.com/quarkusio/quarkus/commit/55b9d84cffa01d4ac5b59ac4c62a02583c65edcb", "message": "feat: Know s2i base images now leverage env vars.", "committedDate": "2020-03-12T15:25:37Z", "type": "commit"}, {"oid": "66dd28cf8e71f859554566c7646839eacc250132", "url": "https://github.com/quarkusio/quarkus/commit/66dd28cf8e71f859554566c7646839eacc250132", "message": "chore: minor s2i & kubernetes improvements", "committedDate": "2020-03-12T15:25:37Z", "type": "commit"}, {"oid": "66dd28cf8e71f859554566c7646839eacc250132", "url": "https://github.com/quarkusio/quarkus/commit/66dd28cf8e71f859554566c7646839eacc250132", "message": "chore: minor s2i & kubernetes improvements", "committedDate": "2020-03-12T15:25:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc1NDg5MQ==", "url": "https://github.com/quarkusio/quarkus/pull/7749#discussion_r391754891", "bodyText": "I wonder what happens on Windows, would this possibly generate Windows-style paths into the Kubernetes YAML? (Didn't check, just thinking aloud.)", "author": "Ladicek", "createdAt": "2020-03-12T16:49:46Z", "path": "extensions/container-image/container-image-s2i/deployment/src/main/java/io/quarkus/container/image/s2i/deployment/S2iProcessor.java", "diffHunk": "@@ -61,53 +65,100 @@\n import io.quarkus.kubernetes.client.deployment.KubernetesClientErrorHanlder;\n import io.quarkus.kubernetes.client.spi.KubernetesClientBuildItem;\n import io.quarkus.kubernetes.spi.KubernetesCommandBuildItem;\n+import io.quarkus.kubernetes.spi.KubernetesEnvBuildItem;\n \n public class S2iProcessor {\n \n     private static final String S2I = \"s2i\";\n-    private static final String JAR_ARTIFACT_FORMAT = \"%s%s.jar\";\n-    private static final String NATIVE_ARTIFACT_FORMAT = \"%s%s\";\n+    private static final String OPENSHIFT = \"openshift\";\n     private static final String BUILD_CONFIG_NAME = \"openshift.io/build-config.name\";\n     private static final String RUNNING = \"Running\";\n \n     private static final Logger LOG = Logger.getLogger(S2iProcessor.class);\n \n-    @BuildStep(onlyIf = { IsNormal.class, S2iBuild.class }, onlyIfNot = NativeBuild.class)\n+    @BuildStep(onlyIf = IsNormal.class, onlyIfNot = NativeBuild.class)\n     public void s2iRequirementsJvm(S2iConfig s2iConfig,\n             CurateOutcomeBuildItem curateOutcomeBuildItem,\n             OutputTargetBuildItem out,\n             PackageConfig packageConfig,\n+            JarBuildItem jarBuildItem,\n+            BuildProducer<KubernetesEnvBuildItem> envProducer,\n             BuildProducer<BaseImageInfoBuildItem> builderImageProducer,\n             BuildProducer<KubernetesCommandBuildItem> commandProducer) {\n \n         final List<AppDependency> appDeps = curateOutcomeBuildItem.getEffectiveModel().getUserDependencies();\n+        String outputJarFileName = jarBuildItem.getPath().getFileName().toString();\n         String classpath = appDeps.stream()\n-                .map(d -> Paths.get(s2iConfig.jarPath).getParent().resolve(\"lib\")\n-                        .resolve(d.getArtifact().getGroupId() + \".\" + d.getArtifact().getPath().getFileName()).toAbsolutePath()\n+                .map(d -> String.valueOf(d.getArtifact().getGroupId() + \".\" + d.getArtifact().getPath().getFileName()))\n+                .map(s -> Paths.get(s2iConfig.jarDirectory).resolve(\"lib\").resolve(s).toAbsolutePath()", "originalCommit": "66dd28cf8e71f859554566c7646839eacc250132", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}