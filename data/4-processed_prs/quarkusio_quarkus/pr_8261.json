{"pr_number": 8261, "pr_title": "Amazon Alexa extension for Quarkus Native integration with AWS Lambda", "pr_createdAt": "2020-03-30T06:32:01Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/8261", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk4NDI0Nw==", "url": "https://github.com/quarkusio/quarkus/pull/8261#discussion_r399984247", "bodyText": "Can we try and use Jandex to do this?\nThat is pretty much what all the other extensions do.", "author": "geoand", "createdAt": "2020-03-30T07:38:53Z", "path": "extensions/amazon-lambda-alexa/deployment/src/main/java/io/quarkus/amazon/lambda/alexa/AlexaProcessor.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package io.quarkus.amazon.lambda.alexa;\n+\n+import java.util.Set;\n+\n+import org.reflections.Reflections;\n+\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+\n+import io.quarkus.deployment.annotations.BuildProducer;\n+import io.quarkus.deployment.annotations.BuildStep;\n+import io.quarkus.deployment.builditem.nativeimage.NativeImageProxyDefinitionBuildItem;\n+import io.quarkus.deployment.builditem.nativeimage.ReflectiveClassBuildItem;\n+import io.quarkus.deployment.pkg.steps.NativeBuild;\n+\n+public class AlexaProcessor {\n+\n+    @BuildStep(onlyIf = NativeBuild.class)\n+    public void reflection(BuildProducer<ReflectiveClassBuildItem> reflectiveClass) {\n+\n+        Reflections reflections = new Reflections(\"com.amazon.ask\");\n+        Set<Class<?>> types = reflections.getTypesAnnotatedWith(JsonDeserialize.class);\n+\n+        types.forEach(type -> reflectiveClass\n+                .produce(new ReflectiveClassBuildItem(true, true, type.getName(), type.getName() + \"$Builder\")));", "originalCommit": "a7cd7a8d177edcc14eb44f99ab161132c2913225", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA2NDgzMg==", "url": "https://github.com/quarkusio/quarkus/pull/8261#discussion_r400064832", "bodyText": "Also, I think we should do that in the Jackson extension and just have this one depend on the Jackson extension.", "author": "gsmet", "createdAt": "2020-03-30T09:52:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk4NDI0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA5NjcyMw==", "url": "https://github.com/quarkusio/quarkus/pull/8261#discussion_r400096723", "bodyText": "Yes, I was thinking it would be nice to have standard functionality that could automatically scan the class path and identify the JsonDeserialize usage.  The one caveat to this is that the Alexa ASK SDK also has a static Builder inner class, that requires ClassName$Builder to be added.", "author": "oztimpower", "createdAt": "2020-03-30T10:47:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk4NDI0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIxNTk3OA==", "url": "https://github.com/quarkusio/quarkus/pull/8261#discussion_r400215978", "bodyText": "Interestingly the Jackson extension potentially does have code to handle this & the builder already, yet it doesn't seem to pickup the JsonDeserialize annotation.\nThe combinedBuildIndex is small in size.\n  // handle the various @JsonDeserialize cases\n        for (AnnotationInstance deserializeInstance : index.getAnnotations(JSON_DESERIALIZE)) {\n            AnnotationTarget annotationTarget = deserializeInstance.target();\n            if (CLASS.equals(annotationTarget.kind())) {\n                DotName dotName = annotationTarget.asClass().name();\n                if (!ignoredDotNames.contains(dotName)) {\n                    addReflectiveHierarchyClass(dotName);\n                }\n\n                AnnotationValue annotationValue = deserializeInstance.value(\"builder\");\n                if (null != annotationValue && AnnotationValue.Kind.CLASS.equals(annotationValue.kind())) {\n                    DotName builderClassName = annotationValue.asClass().name();\n                    if (!BUILDER_VOID.equals(builderClassName)) {\n                        addReflectiveHierarchyClass(builderClassName);\n                    }\n                }\n            }\n    }", "author": "oztimpower", "createdAt": "2020-03-30T14:02:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk4NDI0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIxODUzOQ==", "url": "https://github.com/quarkusio/quarkus/pull/8261#discussion_r400218539", "bodyText": "You might need to create an IndexDependencyBuildItem in order to get that dependency into the inde (if it's not already in).", "author": "geoand", "createdAt": "2020-03-30T14:05:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk4NDI0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDcwODkyOQ==", "url": "https://github.com/quarkusio/quarkus/pull/8261#discussion_r400708929", "bodyText": "Got this working with Jandex, using the IndexDependencyBuildItem as a BuildStep.\nCode is quite simple now, all it does is draw in the Alexa dependencies, and then it uses the Jackson extension to do the work of identifying the JsonDeserialize & Builder classes.\nThanks to @stuartwdouglas for helping me today.", "author": "oztimpower", "createdAt": "2020-03-31T07:49:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk4NDI0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDcxMDg1NA==", "url": "https://github.com/quarkusio/quarkus/pull/8261#discussion_r400710854", "bodyText": "Excellent!", "author": "geoand", "createdAt": "2020-03-31T07:52:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk4NDI0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA2NTYxOQ==", "url": "https://github.com/quarkusio/quarkus/pull/8261#discussion_r400065619", "bodyText": "Is it specific to Amazon Lambda or could be used to use Alexa in another context?", "author": "gsmet", "createdAt": "2020-03-30T09:53:44Z", "path": "extensions/amazon-lambda-alexa/runtime/pom.xml", "diffHunk": "@@ -0,0 +1,57 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <modelVersion>4.0.0</modelVersion>\n+\n+    <parent>\n+        <groupId>io.quarkus</groupId>\n+        <artifactId>quarkus-amazon-lambda-alexa-parent</artifactId>\n+        <version>999-SNAPSHOT</version>\n+        <relativePath>../pom.xml</relativePath>\n+    </parent>\n+\n+    <artifactId>quarkus-amazon-lambda-alexa</artifactId>\n+    <name>Quarkus - Amazon Lambda Alexa - Runtime</name>\n+    <description>Write AWS Lambda functions for Amazon Alexa</description>", "originalCommit": "a7cd7a8d177edcc14eb44f99ab161132c2913225", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDEwMTM2MQ==", "url": "https://github.com/quarkusio/quarkus/pull/8261#discussion_r400101361", "bodyText": "If I understand the question correctly, no Amazon Alexa would only be used with AWS Lambda in this context.  Alexa is driven by custom AWS Lambda code \"Skills\" that give it functionality (for voice, video et al).", "author": "oztimpower", "createdAt": "2020-03-30T10:55:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA2NTYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIwNjYxMg==", "url": "https://github.com/quarkusio/quarkus/pull/8261#discussion_r400206612", "bodyText": "Oh I should add yes, you can also write Alexa Skills outside of AWS Lambda, any HTTPS interface actually, so containers would be applicable also, I guess that's what you were asking -- in terms of how to name the extension.", "author": "oztimpower", "createdAt": "2020-03-30T13:50:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA2NTYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMxMjIwMQ==", "url": "https://github.com/quarkusio/quarkus/pull/8261#discussion_r400312201", "bodyText": "Yeah, what I was wondering is if this could be a general purpose Alexa extension that we could use for all usage.\nThat would mean a few things:\n\nit wouldn't depend on Amazon Lambda. Does it right now? I saw the dependency but I'm not sure it's strictly needed.\nwe would add the Alexa dependency to the runtime artifact so that just adding it drags the Alexa artifact.\nobviously, we would change the name to be more generic :).", "author": "gsmet", "createdAt": "2020-03-30T16:06:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA2NTYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMxMjU1Ng==", "url": "https://github.com/quarkusio/quarkus/pull/8261#discussion_r400312556", "bodyText": "Note that these are suggestions. I'm not accustomed to the Amazon ecosystem so feel free to push back if these are bad ideas.", "author": "gsmet", "createdAt": "2020-03-30T16:06:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA2NTYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDcwOTMzMw==", "url": "https://github.com/quarkusio/quarkus/pull/8261#discussion_r400709333", "bodyText": "Renamed it to amazon-alexa, makes sense, no need to couple it with the Amazon Lambda extension.", "author": "oztimpower", "createdAt": "2020-03-31T07:50:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA2NTYxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA2NTkwMw==", "url": "https://github.com/quarkusio/quarkus/pull/8261#discussion_r400065903", "bodyText": "I'm surprised we don't have a dependency to some Alexa SDK?", "author": "gsmet", "createdAt": "2020-03-30T09:54:08Z", "path": "extensions/amazon-lambda-alexa/runtime/pom.xml", "diffHunk": "@@ -0,0 +1,57 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <modelVersion>4.0.0</modelVersion>\n+\n+    <parent>\n+        <groupId>io.quarkus</groupId>\n+        <artifactId>quarkus-amazon-lambda-alexa-parent</artifactId>\n+        <version>999-SNAPSHOT</version>\n+        <relativePath>../pom.xml</relativePath>\n+    </parent>\n+\n+    <artifactId>quarkus-amazon-lambda-alexa</artifactId>\n+    <name>Quarkus - Amazon Lambda Alexa - Runtime</name>\n+    <description>Write AWS Lambda functions for Amazon Alexa</description>\n+\n+    <dependencies>\n+        <dependency>\n+            <groupId>io.quarkus</groupId>\n+            <artifactId>quarkus-amazon-lambda</artifactId>\n+        </dependency>\n+    </dependencies>", "originalCommit": "a7cd7a8d177edcc14eb44f99ab161132c2913225", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDEwMjE3OQ==", "url": "https://github.com/quarkusio/quarkus/pull/8261#discussion_r400102179", "bodyText": "The Alexa SDK dependency is in the user project, since they need to subclass the SkillStreamHandler, and leverage other SDK dependencies to use Alexa with AWS Lambda.  Hence no need to include in the Quarkus dependencies.", "author": "oztimpower", "createdAt": "2020-03-30T10:57:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA2NTkwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDcxMDE1MQ==", "url": "https://github.com/quarkusio/quarkus/pull/8261#discussion_r400710151", "bodyText": "Added the dependency to the runtime BOM and also the runtime pom.  It needs to exclude logging, and an internal conflict.  User project doesn't require the explicit dependency now.", "author": "oztimpower", "createdAt": "2020-03-31T07:51:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA2NTkwMw=="}], "type": "inlineReview"}, {"oid": "1da256a4dfab0b4bf23bd02395070dc9e6b1d17f", "url": "https://github.com/quarkusio/quarkus/commit/1da256a4dfab0b4bf23bd02395070dc9e6b1d17f", "message": "Modify to use with Jandex\nRename to Amazon Alexa", "committedDate": "2020-03-31T06:53:22Z", "type": "forcePushed"}, {"oid": "f9553cfcc82054e0f8c1ef99981714be83d4e730", "url": "https://github.com/quarkusio/quarkus/commit/f9553cfcc82054e0f8c1ef99981714be83d4e730", "message": "Modify to use with Jandex, Rename to Amazon Alexa", "committedDate": "2020-03-31T07:43:49Z", "type": "forcePushed"}, {"oid": "1a7dea439e45966da189c4261282c22837321771", "url": "https://github.com/quarkusio/quarkus/commit/1a7dea439e45966da189c4261282c22837321771", "message": "Modify to use with Jandex, Rename to Amazon Alexa", "committedDate": "2020-03-31T12:59:41Z", "type": "commit"}, {"oid": "1a7dea439e45966da189c4261282c22837321771", "url": "https://github.com/quarkusio/quarkus/commit/1a7dea439e45966da189c4261282c22837321771", "message": "Modify to use with Jandex, Rename to Amazon Alexa", "committedDate": "2020-03-31T12:59:41Z", "type": "forcePushed"}]}