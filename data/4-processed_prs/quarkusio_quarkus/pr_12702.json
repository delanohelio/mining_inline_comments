{"pr_number": 12702, "pr_title": "Add integration test for kafka reactive messaging", "pr_createdAt": "2020-10-14T05:28:26Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/12702", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQzNjc4NA==", "url": "https://github.com/quarkusio/quarkus/pull/12702#discussion_r504436784", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void consume(String json) {\n          \n          \n            \n                    Person person = new JsonObject(json).mapTo(Person.class);\n          \n          \n            \n                    list.add(person);\n          \n          \n            \n                }\n          \n          \n            \n                public void consume(Person json) {\n          \n          \n            \n                    list.add(person);\n          \n          \n            \n                }\n          \n      \n    \n    \n  \n\nGood PR. Should we use the value deserializer since we have it in config?", "author": "machi1990", "createdAt": "2020-10-14T06:41:55Z", "path": "integration-tests/reactive-messaging-kafka/src/main/java/io/quarkus/it/kafka/PeopleManager.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package io.quarkus.it.kafka;\n+\n+import java.util.List;\n+import java.util.concurrent.CopyOnWriteArrayList;\n+\n+import org.eclipse.microprofile.reactive.messaging.Incoming;\n+import org.jboss.logging.Logger;\n+\n+import io.vertx.core.json.JsonObject;\n+\n+public class PeopleManager {\n+\n+    private final Logger log = Logger.getLogger(PeopleManager.class);\n+\n+    private final List<Person> list = new CopyOnWriteArrayList<>();\n+\n+    @Incoming(\"people-in\")\n+    public void consume(String json) {\n+        Person person = new JsonObject(json).mapTo(Person.class);\n+        list.add(person);\n+    }", "originalCommit": "fff241d2318b14f8b9c49247e1c11c6ab8fe37f0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg4MDE2MA==", "url": "https://github.com/quarkusio/quarkus/pull/12702#discussion_r504880160", "bodyText": "Yes, you are right.", "author": "geoandri", "createdAt": "2020-10-14T18:19:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQzNjc4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQzNzc5Ng==", "url": "https://github.com/quarkusio/quarkus/pull/12702#discussion_r504437796", "bodyText": "We'll have to add the IT job in the CI too, especially the native part. It can go in this Messaging block https://github.com/quarkusio/quarkus/blob/master/.github/workflows/ci-actions.yml#L476", "author": "machi1990", "createdAt": "2020-10-14T06:44:18Z", "path": "integration-tests/pom.xml", "diffHunk": "@@ -147,6 +147,7 @@\n         <module>grpc-health</module>\n         <module>google-cloud-functions-http</module>\n         <module>google-cloud-functions</module>\n+        <module>reactive-messaging-kafka</module>", "originalCommit": "fff241d2318b14f8b9c49247e1c11c6ab8fe37f0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg4MDQ4OA==", "url": "https://github.com/quarkusio/quarkus/pull/12702#discussion_r504880488", "bodyText": "Added to the latest commit.", "author": "geoandri", "createdAt": "2020-10-14T18:19:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQzNzc5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTAwNDE2MA==", "url": "https://github.com/quarkusio/quarkus/pull/12702#discussion_r505004160", "bodyText": "We can also add name and description following this pattern:\n\n  \n    \n      quarkus/integration-tests/reactive-messaging-amqp/pom.xml\n    \n    \n        Lines 14 to 15\n      in\n      efc6dc8\n    \n    \n    \n    \n\n        \n          \n           <name>Quarkus - Integration Tests - Reactive Messaging - AMQP</name> \n        \n\n        \n          \n           <description>The AMQP integration tests module</description>", "author": "machi1990", "createdAt": "2020-10-14T22:03:02Z", "path": "integration-tests/reactive-messaging-kafka/pom.xml", "diffHunk": "@@ -0,0 +1,297 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <parent>\n+        <artifactId>quarkus-integration-tests-parent</artifactId>\n+        <groupId>io.quarkus</groupId>\n+        <version>999-SNAPSHOT</version>\n+    </parent>\n+    <modelVersion>4.0.0</modelVersion>\n+\n+    <artifactId>quarkus-integration-test-reactive-messaging-kafka</artifactId>", "originalCommit": "efc6dc8e43599d3d574c468fdf70a02e1f226acb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE1MTk5Ng==", "url": "https://github.com/quarkusio/quarkus/pull/12702#discussion_r505151996", "bodyText": "Added to the latest commit.", "author": "geoandri", "createdAt": "2020-10-15T04:07:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTAwNDE2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTAwNTA0Mg==", "url": "https://github.com/quarkusio/quarkus/pull/12702#discussion_r505005042", "bodyText": "I think the incoming sink is missing the topic.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            mp.messaging.incoming.people-in.connector=smallrye-kafka\n          \n          \n            \n            mp.messaging.incoming.people-in.value.deserializer=io.quarkus.it.kafka.PersonDeserializer\n          \n          \n            \n            mp.messaging.incoming.people-in.connector=smallrye-kafka\n          \n          \n            \n            mp.messaging.incoming.people-in.value.deserializer=io.quarkus.it.kafka.PersonDeserializer\n          \n          \n            \n            mp.messaging.incoming.people-in.topic=people", "author": "machi1990", "createdAt": "2020-10-14T22:04:13Z", "path": "integration-tests/reactive-messaging-kafka/src/main/resources/application.properties", "diffHunk": "@@ -0,0 +1,13 @@\n+quarkus.log.category.kafka.level=WARN\n+quarkus.log.category.\\\"org.apache.kafka\\\".level=WARN\n+quarkus.log.category.\\\"org.apache.zookeeper\\\".level=WARN\n+\n+# enable health check\n+quarkus.kafka.health.enabled=true\n+kafka.bootstrap.servers=localhost:19092\n+\n+mp.messaging.outgoing.people-out.connector=smallrye-kafka\n+mp.messaging.outgoing.people-out.topic=people\n+mp.messaging.outgoing.people-out.value.serializer=io.quarkus.kafka.client.serialization.JsonbSerializer\n+mp.messaging.incoming.people-in.connector=smallrye-kafka\n+mp.messaging.incoming.people-in.value.deserializer=io.quarkus.it.kafka.PersonDeserializer", "originalCommit": "efc6dc8e43599d3d574c468fdf70a02e1f226acb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE1MTk0MA==", "url": "https://github.com/quarkusio/quarkus/pull/12702#discussion_r505151940", "bodyText": "Added the topic for the incoming sink. I had used as a guide the example project (https://quarkus.io/guides/kafka#configuring-the-kafka-connector) which does not actually set the topic for the incoming sink.", "author": "geoandri", "createdAt": "2020-10-15T04:07:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTAwNTA0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE1MzM4NA==", "url": "https://github.com/quarkusio/quarkus/pull/12702#discussion_r505153384", "bodyText": "Add @ApplicationScoped", "author": "cescoffier", "createdAt": "2020-10-15T04:14:02Z", "path": "integration-tests/reactive-messaging-kafka/src/main/java/io/quarkus/it/kafka/PeopleManager.java", "diffHunk": "@@ -0,0 +1,24 @@\n+package io.quarkus.it.kafka;\n+\n+import java.util.List;\n+import java.util.concurrent.CopyOnWriteArrayList;\n+\n+import org.eclipse.microprofile.reactive.messaging.Incoming;\n+import org.jboss.logging.Logger;\n+\n+public class PeopleManager {", "originalCommit": "ced77b63f239a728216d01650ca5126b448f6a2c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE4MTcyMg==", "url": "https://github.com/quarkusio/quarkus/pull/12702#discussion_r505181722", "bodyText": "You should add 10 minutes to the timeout.", "author": "cescoffier", "createdAt": "2020-10-15T05:57:08Z", "path": ".github/workflows/ci-actions.yml", "diffHunk": "@@ -481,6 +481,7 @@ jobs:\n               kafka\n               kafka-streams\n               reactive-messaging-amqp\n+              reactive-messaging-kafka", "originalCommit": "ced77b63f239a728216d01650ca5126b448f6a2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY2ODA5OQ==", "url": "https://github.com/quarkusio/quarkus/pull/12702#discussion_r505668099", "bodyText": "Added in the latest commit.", "author": "geoandri", "createdAt": "2020-10-15T16:12:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE4MTcyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE4MjExMw==", "url": "https://github.com/quarkusio/quarkus/pull/12702#discussion_r505182113", "bodyText": "I would use await().untilAsserted", "author": "cescoffier", "createdAt": "2020-10-15T05:58:24Z", "path": "integration-tests/reactive-messaging-kafka/src/test/java/io/quarkus/it/kafka/KafkaConnectorTest.java", "diffHunk": "@@ -0,0 +1,37 @@\n+package io.quarkus.it.kafka;\n+\n+import static io.restassured.RestAssured.get;\n+import static org.awaitility.Awaitility.await;\n+\n+import java.util.List;\n+\n+import org.jboss.logging.Logger;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.Test;\n+\n+import io.quarkus.test.common.QuarkusTestResource;\n+import io.quarkus.test.junit.QuarkusTest;\n+import io.restassured.common.mapper.TypeRef;\n+\n+@QuarkusTest\n+@QuarkusTestResource(KafkaTestResource.class)\n+public class KafkaConnectorTest {\n+    private static final Logger log = Logger.getLogger(KafkaTestResource.class);\n+\n+    protected static final TypeRef<List<Person>> TYPE_REF = new TypeRef<List<Person>>() {\n+    };\n+\n+    @Test\n+    public void test() {\n+        log.info(\"Test run\");\n+        try {\n+            await()", "originalCommit": "ced77b63f239a728216d01650ca5126b448f6a2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTI0NTg1NQ==", "url": "https://github.com/quarkusio/quarkus/pull/12702#discussion_r505245855", "bodyText": "@Test\npublic void test() {\n        await().untilAsserted(() -> \n           Assertions.assertEquals(get(\"/kafka/people\").as(TYPE_REF).size(), 6));\n}", "author": "cescoffier", "createdAt": "2020-10-15T07:12:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE4MjExMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY2NTg4NQ==", "url": "https://github.com/quarkusio/quarkus/pull/12702#discussion_r505665885", "bodyText": "Done in the latest commit.", "author": "geoandri", "createdAt": "2020-10-15T16:09:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE4MjExMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTI0MDI1Ng==", "url": "https://github.com/quarkusio/quarkus/pull/12702#discussion_r505240256", "bodyText": "The tests fail because of a missing property:\nmp.messaging.incoming.people-in.auto.offset.reset=earliest\n\nWithout, it uses Kafka's. default which is latest. Basically, it only receives records sends after the subscription. earliest instructs the consumers to reset its offset to the last processed offset from consumers from its consumer group. Here, it will reset the offset to 0, as there are no other consumers (so obviously none in its group) and no records have been erased due to retention expiration (24h by default).", "author": "cescoffier", "createdAt": "2020-10-15T07:07:28Z", "path": "integration-tests/reactive-messaging-kafka/src/main/resources/application.properties", "diffHunk": "@@ -0,0 +1,14 @@\n+quarkus.log.category.kafka.level=WARN\n+quarkus.log.category.\\\"org.apache.kafka\\\".level=WARN\n+quarkus.log.category.\\\"org.apache.zookeeper\\\".level=WARN\n+\n+# enable health check\n+quarkus.kafka.health.enabled=true\n+kafka.bootstrap.servers=localhost:19092\n+\n+mp.messaging.outgoing.people-out.connector=smallrye-kafka\n+mp.messaging.outgoing.people-out.topic=people\n+mp.messaging.outgoing.people-out.value.serializer=io.quarkus.kafka.client.serialization.JsonbSerializer\n+mp.messaging.incoming.people-in.connector=smallrye-kafka\n+mp.messaging.incoming.people-in.topic=people", "originalCommit": "ced77b63f239a728216d01650ca5126b448f6a2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY2NjYxNg==", "url": "https://github.com/quarkusio/quarkus/pull/12702#discussion_r505666616", "bodyText": "Indeed, many thanks @cescoffier for the help and the detailed explanation as well.", "author": "geoandri", "createdAt": "2020-10-15T16:10:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTI0MDI1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTI0MDkwNA==", "url": "https://github.com/quarkusio/quarkus/pull/12702#discussion_r505240904", "bodyText": "Could you add the associated native tests?\npackage io.quarkus.it.kafka;\n\nimport io.quarkus.test.junit.NativeImageTest;\n\n@NativeImageTest\npublic class KafkaConnectorIT extends KafkaConnectorTest {\n\n}", "author": "cescoffier", "createdAt": "2020-10-15T07:08:00Z", "path": "integration-tests/reactive-messaging-kafka/src/test/java/io/quarkus/it/kafka/KafkaConnectorTest.java", "diffHunk": "@@ -0,0 +1,37 @@\n+package io.quarkus.it.kafka;\n+\n+import static io.restassured.RestAssured.get;\n+import static org.awaitility.Awaitility.await;\n+\n+import java.util.List;\n+\n+import org.jboss.logging.Logger;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.Test;\n+\n+import io.quarkus.test.common.QuarkusTestResource;\n+import io.quarkus.test.junit.QuarkusTest;\n+import io.restassured.common.mapper.TypeRef;\n+\n+@QuarkusTest\n+@QuarkusTestResource(KafkaTestResource.class)\n+public class KafkaConnectorTest {", "originalCommit": "ced77b63f239a728216d01650ca5126b448f6a2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY2NzE2Mg==", "url": "https://github.com/quarkusio/quarkus/pull/12702#discussion_r505667162", "bodyText": "Done", "author": "geoandri", "createdAt": "2020-10-15T16:11:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTI0MDkwNA=="}], "type": "inlineReview"}, {"oid": "2cd7573c133a57b804375deb2d39ee1ad2762543", "url": "https://github.com/quarkusio/quarkus/commit/2cd7573c133a57b804375deb2d39ee1ad2762543", "message": "Add integration test for kafka reactive messaging", "committedDate": "2020-10-15T19:21:06Z", "type": "commit"}, {"oid": "2cd7573c133a57b804375deb2d39ee1ad2762543", "url": "https://github.com/quarkusio/quarkus/commit/2cd7573c133a57b804375deb2d39ee1ad2762543", "message": "Add integration test for kafka reactive messaging", "committedDate": "2020-10-15T19:21:06Z", "type": "forcePushed"}]}