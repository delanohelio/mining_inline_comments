{"pr_number": 11716, "pr_title": "Correctly handle directories in getResourceAsStream of QuarkusClassLoader", "pr_createdAt": "2020-08-28T14:05:14Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/11716", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM0MzY3Nw==", "url": "https://github.com/quarkusio/quarkus/pull/11716#discussion_r479343677", "bodyText": "Do we need to close the stream as well?", "author": "geoand", "createdAt": "2020-08-28T14:30:44Z", "path": "independent-projects/bootstrap/core/src/main/java/io/quarkus/bootstrap/classloading/QuarkusClassLoader.java", "diffHunk": "@@ -323,6 +323,17 @@ public InputStream getResourceAsStream(String unsanitisedName) {\n             for (ClassPathElement i : elements) {\n                 ClassPathResource res = i.getResource(name);\n                 if (res != null) {\n+                    if (res.isDirectory()) {\n+                        try {\n+                            return res.getUrl().openStream();", "originalCommit": "d13527168764f661c69fe7e793979b3384f4e97e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM0NDcwMw==", "url": "https://github.com/quarkusio/quarkus/pull/11716#discussion_r479344703", "bodyText": "No, given that this getResourceAsStream is meant to return a \"live\" stream, we return it live and expect the user/caller to close it whenever they are done using it (just like they would with regular non-directory based streams).", "author": "jaikiran", "createdAt": "2020-08-28T14:32:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM0MzY3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM0NTYwOA==", "url": "https://github.com/quarkusio/quarkus/pull/11716#discussion_r479345608", "bodyText": "Ah right... I didn't see which method this belonged to.", "author": "geoand", "createdAt": "2020-08-28T14:33:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM0MzY3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM1Nzk2MQ==", "url": "https://github.com/quarkusio/quarkus/pull/11716#discussion_r479357961", "bodyText": "Maybe related, but it just occurred to me that this method below may be broken?\n\n  \n    \n      quarkus/independent-projects/bootstrap/core/src/main/java/io/quarkus/bootstrap/classloading/DirectoryClassPathElement.java\n    \n    \n        Lines 97 to 110\n      in\n      8b9c788\n    \n    \n    \n    \n\n        \n          \n           public byte[] getData() { \n        \n\n        \n          \n               try { \n        \n\n        \n          \n                   try { \n        \n\n        \n          \n                       return Files.readAllBytes(file); \n        \n\n        \n          \n                   } catch (InterruptedIOException e) { \n        \n\n        \n          \n                       //if we are interrupted reading data we finish the op, then just re-interrupt the thread state \n        \n\n        \n          \n                       byte[] bytes = Files.readAllBytes(file); \n        \n\n        \n          \n                       Thread.currentThread().interrupt(); \n        \n\n        \n          \n                       return bytes; \n        \n\n        \n          \n                   } \n        \n\n        \n          \n               } catch (IOException e) { \n        \n\n        \n          \n                   throw new RuntimeException(\"Unable to read \" + file, e); \n        \n\n        \n          \n               } \n        \n\n        \n          \n           }", "author": "gastaldi", "createdAt": "2020-08-28T14:53:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM0MzY3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYwNTkwMA==", "url": "https://github.com/quarkusio/quarkus/pull/11716#discussion_r479605900", "bodyText": "Hello @gastaldi, do you mean it's broken because it isn't doing a check to see if the file is a directory, or something else?", "author": "jaikiran", "createdAt": "2020-08-29T04:26:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM0MzY3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYwNjY3OA==", "url": "https://github.com/quarkusio/quarkus/pull/11716#discussion_r479606678", "bodyText": "@jaikiran exactly", "author": "gastaldi", "createdAt": "2020-08-29T04:38:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM0MzY3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYwNjg1OQ==", "url": "https://github.com/quarkusio/quarkus/pull/11716#discussion_r479606859", "bodyText": "The class name is misleading if it handles files too IMHO", "author": "gastaldi", "createdAt": "2020-08-29T04:40:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM0MzY3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYwNzA0Mw==", "url": "https://github.com/quarkusio/quarkus/pull/11716#discussion_r479607043", "bodyText": "I think given that there's already an isDirectory() API on ClassPathResource, I think, it's the caller's responsibility to do that check before calling getData().\nThis getData() could of course do checks for isDirectory but if it does find that it's an directory, then it either has to error out or open a stream on the URL represented by the file and then read from that. All doable, but I don't have the complete background around these classes, so I'm not sure if it should be done here in this method. @stuartwdouglas what are you thoughts?", "author": "jaikiran", "createdAt": "2020-08-29T04:43:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM0MzY3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTU0MTczNA==", "url": "https://github.com/quarkusio/quarkus/pull/11716#discussion_r481541734", "bodyText": "I think this is fine.", "author": "stuartwdouglas", "createdAt": "2020-09-02T01:50:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM0MzY3Nw=="}], "type": "inlineReview"}, {"oid": "96de5bff1b568c1840d0bcb319db7072cb6bba4d", "url": "https://github.com/quarkusio/quarkus/commit/96de5bff1b568c1840d0bcb319db7072cb6bba4d", "message": "issue#11707 Correctly handle directories in QuarkusClassLoader#getResourceAsStream()", "committedDate": "2020-08-29T04:28:08Z", "type": "commit"}, {"oid": "96de5bff1b568c1840d0bcb319db7072cb6bba4d", "url": "https://github.com/quarkusio/quarkus/commit/96de5bff1b568c1840d0bcb319db7072cb6bba4d", "message": "issue#11707 Correctly handle directories in QuarkusClassLoader#getResourceAsStream()", "committedDate": "2020-08-29T04:28:08Z", "type": "forcePushed"}]}