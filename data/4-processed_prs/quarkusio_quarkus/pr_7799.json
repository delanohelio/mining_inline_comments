{"pr_number": 7799, "pr_title": "Fix intermittent windows failures", "pr_createdAt": "2020-03-12T00:26:04Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/7799", "timeline": [{"oid": "9fde13441484357bef80061bc2a691e1da34a94f", "url": "https://github.com/quarkusio/quarkus/commit/9fde13441484357bef80061bc2a691e1da34a94f", "message": "Fix intermittent windows failures\n\nFixes #7643", "committedDate": "2020-03-12T00:27:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQzOTY0OQ==", "url": "https://github.com/quarkusio/quarkus/pull/7799#discussion_r391439649", "bodyText": "I don't really understand this, why sleep when the timeout has been exceeded and not just throw the exception right away?", "author": "geoand", "createdAt": "2020-03-12T07:26:11Z", "path": "test-framework/junit5-internal/src/main/java/io/quarkus/test/QuarkusDevModeTest.java", "diffHunk": "@@ -404,10 +404,27 @@ public void addResourceFile(String path, byte[] data) {\n      */\n     public void deleteResourceFile(String path) {\n         final Path resourceFilePath = deploymentResourcePath.resolve(path);\n-        try {\n-            Files.delete(resourceFilePath);\n-        } catch (IOException e) {\n-            throw new UncheckedIOException(e);\n+        long timeout = System.currentTimeMillis() + 5000;\n+        //in general there is a potential race here\n+        //if you serve a file you will send the data to the client, then close the resource\n+        //this means that by the time the client request is run the file may not \n+        //have been closed yet, as the test sees the response as being complete after the last data is send\n+        //we wait up to 5s for this condition to be resolved\n+        for (;;) {\n+            try {\n+                Files.delete(resourceFilePath);\n+                break;\n+            } catch (IOException e) {\n+                if (System.currentTimeMillis() < timeout) {\n+                    continue;\n+                }\n+                try {\n+                    Thread.sleep(50);\n+                } catch (InterruptedException ex) {\n+                    //ignore\n+                }", "originalCommit": "9fde13441484357bef80061bc2a691e1da34a94f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ0Mzc5NQ==", "url": "https://github.com/quarkusio/quarkus/pull/7799#discussion_r391443795", "bodyText": "Oops, I have them in the wrong order", "author": "stuartwdouglas", "createdAt": "2020-03-12T07:38:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQzOTY0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ1NDY0OA==", "url": "https://github.com/quarkusio/quarkus/pull/7799#discussion_r391454648", "bodyText": "OK :). I'll approve as soon as it's fixed", "author": "geoand", "createdAt": "2020-03-12T08:07:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQzOTY0OQ=="}], "type": "inlineReview"}, {"oid": "5353234275cb6f19c40b60c8483af746acc69fff", "url": "https://github.com/quarkusio/quarkus/commit/5353234275cb6f19c40b60c8483af746acc69fff", "message": "Fix intermittent windows failures\n\nFixes #7643", "committedDate": "2020-03-12T10:02:47Z", "type": "commit"}, {"oid": "5353234275cb6f19c40b60c8483af746acc69fff", "url": "https://github.com/quarkusio/quarkus/commit/5353234275cb6f19c40b60c8483af746acc69fff", "message": "Fix intermittent windows failures\n\nFixes #7643", "committedDate": "2020-03-12T10:02:47Z", "type": "forcePushed"}]}