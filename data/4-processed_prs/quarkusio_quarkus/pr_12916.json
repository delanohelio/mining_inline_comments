{"pr_number": 12916, "pr_title": "Update pom files if create mojo is called inside a parent project", "pr_createdAt": "2020-10-24T14:29:04Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/12916", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc1Njk0NA==", "url": "https://github.com/quarkusio/quarkus/pull/12916#discussion_r511756944", "bodyText": "We could also achieve that part directly in the maven codestart.. @aloubyansky what do you reckon?", "author": "ia3andy", "createdAt": "2020-10-26T07:21:17Z", "path": "devtools/maven/src/main/java/io/quarkus/maven/CreateProjectMojo.java", "diffHunk": "@@ -202,7 +218,18 @@ public void execute() throws MojoExecutionException {\n             }\n \n             success = createProject.execute().isSuccess();\n-\n+            if (success && parentPomModel != null) {", "originalCommit": "c92ac9cf1d76b1cd1466a3476db8cc140857d425", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc2NzE4Mw==", "url": "https://github.com/quarkusio/quarkus/pull/12916#discussion_r511767183", "bodyText": "Probably, yes. This could be accepted until the codestarts provide this feature.", "author": "aloubyansky", "createdAt": "2020-10-26T07:47:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc1Njk0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc3NDM4Ng==", "url": "https://github.com/quarkusio/quarkus/pull/12916#discussion_r511774386", "bodyText": "#12936", "author": "ia3andy", "createdAt": "2020-10-26T08:03:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc1Njk0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc2NzQ0Nw==", "url": "https://github.com/quarkusio/quarkus/pull/12916#discussion_r511767447", "bodyText": "The parent pom should not be update unless the project generation succeeds.", "author": "aloubyansky", "createdAt": "2020-10-26T07:47:56Z", "path": "devtools/maven/src/main/java/io/quarkus/maven/CreateProjectMojo.java", "diffHunk": "@@ -162,16 +165,29 @@ public void execute() throws MojoExecutionException {\n         }\n         File projectRoot = outputDirectory;\n         File pom = new File(projectRoot, \"pom.xml\");\n+        Model parentPomModel = null;\n \n         if (pom.isFile()) {\n-            throw new MojoExecutionException(\"Unable to generate the project in a directory that already contains a pom.xml\");\n+            try {\n+                parentPomModel = MojoUtils.readPom(pom);\n+                if (!\"pom\".equals(parentPomModel.getPackaging())) {\n+                    throw new MojoExecutionException(\"The parent project must have a packaging type of POM. Current packaging: \"\n+                            + parentPomModel.getPackaging());\n+                }\n+                askTheUserForMissingValues();\n+                if (!parentPomModel.getModules().contains(this.projectArtifactId)) {\n+                    parentPomModel.addModule(this.projectArtifactId);", "originalCommit": "c92ac9cf1d76b1cd1466a3476db8cc140857d425", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0MDU5Mg==", "url": "https://github.com/quarkusio/quarkus/pull/12916#discussion_r511940592", "bodyText": "This import isn't really required, correct? The generated module will import whatever it does today. This kind of integration with the parent is the tricky part.", "author": "aloubyansky", "createdAt": "2020-10-26T13:00:44Z", "path": "integration-tests/maven/src/test/resources/projects/parent-pom-it/pom.xml", "diffHunk": "@@ -0,0 +1,26 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<project xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\" xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+    xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">\n+  <modelVersion>4.0.0</modelVersion>\n+  <groupId>io.acme.it</groupId>\n+  <artifactId>acme-parent-pom</artifactId>\n+  <version>0.0.1.BUILD-SNAPSHOT</version>\n+  <packaging>pom</packaging>\n+  <properties>\n+    <quarkus.platform.group-id>io.quarkus</quarkus.platform.group-id>\n+    <quarkus.platform.artifact-id>quarkus-bom</quarkus.platform.artifact-id>\n+    <quarkus.platform.version>@project.version@</quarkus.platform.version>\n+  </properties>\n+  <dependencyManagement>\n+    <dependencies>\n+      <!-- insert managed dependencies here -->\n+      <dependency>\n+        <groupId>${quarkus.platform.group-id}</groupId>\n+        <artifactId>${quarkus.platform.artifact-id}</artifactId>\n+        <version>${quarkus.platform.version}</version>\n+        <type>pom</type>\n+        <scope>import</scope>", "originalCommit": "a4969efbf9eea9ba420209e8238e5aec209702ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0NDczNA==", "url": "https://github.com/quarkusio/quarkus/pull/12916#discussion_r511944734", "bodyText": "I can change the parent pom to a completely empty xml containing only GAV and packaging.", "author": "ghokun", "createdAt": "2020-10-26T13:07:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0MDU5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0NjcyOA==", "url": "https://github.com/quarkusio/quarkus/pull/12916#discussion_r511946728", "bodyText": "yes, that will probably make sense in this case. thanks!", "author": "aloubyansky", "createdAt": "2020-10-26T13:11:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0MDU5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0OTg0Mw==", "url": "https://github.com/quarkusio/quarkus/pull/12916#discussion_r511949843", "bodyText": "Why are we changing the behavior for non pom project?", "author": "ia3andy", "createdAt": "2020-10-26T13:16:04Z", "path": "devtools/maven/src/main/java/io/quarkus/maven/CreateProjectMojo.java", "diffHunk": "@@ -162,16 +165,26 @@ public void execute() throws MojoExecutionException {\n         }\n         File projectRoot = outputDirectory;\n         File pom = new File(projectRoot, \"pom.xml\");\n+        Model parentPomModel = null;\n \n         if (pom.isFile()) {\n-            throw new MojoExecutionException(\"Unable to generate the project in a directory that already contains a pom.xml\");\n+            try {\n+                parentPomModel = MojoUtils.readPom(pom);\n+                if (!\"pom\".equals(parentPomModel.getPackaging())) {\n+                    throw new MojoExecutionException(\"The parent project must have a packaging type of POM. Current packaging: \"\n+                            + parentPomModel.getPackaging());\n+                }\n+                askTheUserForMissingValues();\n+            } catch (IOException e) {\n+                throw new MojoExecutionException(\"Could not access parent pom.\", e);\n+            }\n         } else {\n             askTheUserForMissingValues();\n-            projectRoot = new File(outputDirectory, projectArtifactId);\n-            if (projectRoot.exists()) {\n-                throw new MojoExecutionException(\"Unable to create the project, \" +\n-                        \"the directory \" + projectRoot.getAbsolutePath() + \" already exists\");\n-            }", "originalCommit": "a4969efbf9eea9ba420209e8238e5aec209702ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk1OTExNg==", "url": "https://github.com/quarkusio/quarkus/pull/12916#discussion_r511959116", "bodyText": "Actually the else block is useless and can be re-written as:\nif (pom.isFile()) {\n    try {\n        parentPomModel = MojoUtils.readPom(pom);\n        if (!\"pom\".equals(parentPomModel.getPackaging())) {\n            throw new MojoExecutionException(\"The parent project must have a packaging type of POM. Current packaging: \"\n                    + parentPomModel.getPackaging());\n        }\n    } catch (IOException e) {\n        throw new MojoExecutionException(\"Could not access parent pom.\", e);\n    }\n}\naskTheUserForMissingValues();\nprojectRoot = new File(outputDirectory, projectArtifactId);\nif (projectRoot.exists()) {\n    throw new MojoExecutionException(\"Unable to create the project, \" +\n            \"the directory \" + projectRoot.getAbsolutePath() + \" already exists\");\n}", "author": "ghokun", "createdAt": "2020-10-26T13:29:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0OTg0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk2MzcyMA==", "url": "https://github.com/quarkusio/quarkus/pull/12916#discussion_r511963720", "bodyText": "Right. +1", "author": "aloubyansky", "createdAt": "2020-10-26T13:36:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0OTg0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk2Mzg1OA==", "url": "https://github.com/quarkusio/quarkus/pull/12916#discussion_r511963858", "bodyText": "@ghokun well I think we should still block creation on existing gradle project no?", "author": "ia3andy", "createdAt": "2020-10-26T13:36:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0OTg0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk2OTExMA==", "url": "https://github.com/quarkusio/quarkus/pull/12916#discussion_r511969110", "bodyText": "In my previous comment, I mentioned there are different cases to be considered:\n#12916 (comment)\nThere is also another case: Parent project could containt both maven and gradle files.\n#12829 (comment)\nBased on this comment, I continued with maven-parent, maven-submodule combination.\nWe can extend the scope of this PR to include all cases.", "author": "ghokun", "createdAt": "2020-10-26T13:43:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0OTg0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk3MDQ3Nw==", "url": "https://github.com/quarkusio/quarkus/pull/12916#discussion_r511970477", "bodyText": "@ghokun that's what I mean't, we should keep failing when we don't have a pom until a possible PR to deal with those case..", "author": "ia3andy", "createdAt": "2020-10-26T13:45:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0OTg0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAxMDMzMg==", "url": "https://github.com/quarkusio/quarkus/pull/12916#discussion_r512010332", "bodyText": "@ia3andy\nThis is the matrix I came up with:\nBuild Tool MAVEN:\nno file                                 : Generate\nONLY pom.xml                            : Check packaging of pom.xml -> if packaging is pom, add module and generate else fail\nONLY gradle files                       : Fail with error message (You are trying to create a maven project inside a gradle project etc..)\npom.xml and other possible gradle files : Check packaging of pom.xml -> if packaging is pom, add module and generate else fail\n\nBuild Tool GRADLE/GRADLE_KOTLIN_DSL:\nno file                                 : Generate\nONLY gradle files                       : Fail (Since not implemented)\nONLY pom.xml                            : Fail with error message (You are trying to create a gradle project inside a maven project etc..)\ngradle files and pom.xml                : Fail (Since not implemented)", "author": "ghokun", "createdAt": "2020-10-26T14:38:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0OTg0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAxMTYxNQ==", "url": "https://github.com/quarkusio/quarkus/pull/12916#discussion_r512011615", "bodyText": "@ghokun looks good!", "author": "ia3andy", "createdAt": "2020-10-26T14:39:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0OTg0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM1ODQzMw==", "url": "https://github.com/quarkusio/quarkus/pull/12916#discussion_r513358433", "bodyText": "Here is one thing I noticed which is not necessarily related to your changes but may help anyway.\nChecking whether we are in the context of an existing Maven project could be done with project.getFile() != null, if it's true, the Maven project exists. And that would be the pom above. Which will also support -f custom.xml use-case. Would you like to re-write it using that?\nAnother class that may be helpful is io.quarkus.bootstrap.utils.BuildToolHelper it includes isGradleProject(Path project) method, although it goes all the way up in the FS tree, so, perhaps not the best choice here.\nOtherwise, it looks good to me. Thanks!", "author": "aloubyansky", "createdAt": "2020-10-28T11:09:01Z", "path": "devtools/maven/src/main/java/io/quarkus/maven/CreateProjectMojo.java", "diffHunk": "@@ -160,18 +163,52 @@ public void execute() throws MojoExecutionException {\n         } catch (IOException e) {\n             throw new MojoExecutionException(\"Could not create directory \" + outputDirectory, e);\n         }\n+\n         File projectRoot = outputDirectory;\n         File pom = new File(projectRoot, \"pom.xml\");\n+        Model parentPomModel = null;", "originalCommit": "4e5f51c519e4e6a45e81ebab0ccacda7d9362328", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5a036e4da239c5078b62a611c53eea874697f9b3", "url": "https://github.com/quarkusio/quarkus/commit/5a036e4da239c5078b62a611c53eea874697f9b3", "message": "Update pom files of parent and child if create mojo is called inside a parent project. Fixes: #12829\n\nSigned-off-by: ghokun <gokhun@gmail.com>", "committedDate": "2020-10-30T13:38:28Z", "type": "commit"}]}