{"pr_number": 7510, "pr_title": "feat: Hibernate with Panache ranged query", "pr_createdAt": "2020-03-02T10:39:03Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/7510", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTUyOTM0NQ==", "url": "https://github.com/quarkusio/quarkus/pull/7510#discussion_r389529345", "bodyText": "Let's be thorough and test the rest of the methods that should throw.", "author": "FroMage", "createdAt": "2020-03-09T08:58:40Z", "path": "integration-tests/hibernate-orm-panache/src/main/java/io/quarkus/it/panache/TestEndpoint.java", "diffHunk": "@@ -851,6 +859,47 @@ private void testPaging(PanacheQuery<Person> query) {\n \n         Assertions.assertEquals(7, query.count());\n         Assertions.assertEquals(3, query.pageCount());\n+\n+        // mix page with range\n+        persons = query.page(0, 3).range(0, 1).list();\n+        Assertions.assertEquals(2, persons.size());\n+        Assertions.assertEquals(\"stef0\", persons.get(0).name);\n+        Assertions.assertEquals(\"stef1\", persons.get(1).name);\n+    }\n+\n+    private void testRange(PanacheQuery<Person> query) {\n+        List<Person> persons = query.range(0, 2).list();\n+        Assertions.assertEquals(3, persons.size());\n+        Assertions.assertEquals(\"stef0\", persons.get(0).name);\n+        Assertions.assertEquals(\"stef1\", persons.get(1).name);\n+        Assertions.assertEquals(\"stef2\", persons.get(2).name);\n+\n+        persons = query.range(3, 5).list();\n+        Assertions.assertEquals(3, persons.size());\n+        Assertions.assertEquals(\"stef3\", persons.get(0).name);\n+        Assertions.assertEquals(\"stef4\", persons.get(1).name);\n+        Assertions.assertEquals(\"stef5\", persons.get(2).name);\n+\n+        persons = query.range(6, 8).list();\n+        Assertions.assertEquals(1, persons.size());\n+        Assertions.assertEquals(\"stef6\", persons.get(0).name);\n+\n+        persons = query.range(8, 12).list();\n+        Assertions.assertEquals(0, persons.size());\n+\n+        // mix range with page\n+        try {\n+            // invalid\n+            query.range(0, 2).nextPage();", "originalCommit": "397387847299b79dd9b88b606845e5bb62d6c1ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTY4NTE2NA==", "url": "https://github.com/quarkusio/quarkus/pull/7510#discussion_r389685164", "bodyText": "I added more test, and discover a missing check so worth it ;)", "author": "loicmathieu", "createdAt": "2020-03-09T13:47:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTUyOTM0NQ=="}], "type": "inlineReview"}, {"oid": "611dcd5601d7a09a246e331acb13a3328a8fdcc8", "url": "https://github.com/quarkusio/quarkus/commit/611dcd5601d7a09a246e331acb13a3328a8fdcc8", "message": "feat: MongoDB with Panache ranged query", "committedDate": "2020-03-09T13:40:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTY5ODgzMQ==", "url": "https://github.com/quarkusio/quarkus/pull/7510#discussion_r389698831", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            `PanacheQuery` also allow range based query instead of page based.\n          \n          \n            \n            `PanacheQuery` also allows range-based queries.", "author": "FroMage", "createdAt": "2020-03-09T13:59:24Z", "path": "docs/src/main/asciidoc/hibernate-orm-panache.adoc", "diffHunk": "@@ -440,6 +440,31 @@ return Person.find(\"status\", Status.Alive)\n \n The `PanacheQuery` type has many other methods to deal with paging and returning streams.\n \n+=== Using a range instead of pages\n+\n+`PanacheQuery` also allow range based query instead of page based.", "originalCommit": "611dcd5601d7a09a246e331acb13a3328a8fdcc8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTY5OTU2OQ==", "url": "https://github.com/quarkusio/quarkus/pull/7510#discussion_r389699569", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            // make it use a range or start index 0 and last index 25.\n          \n          \n            \n            // make it use a range: start at index 0 until index 25 (inclusive).", "author": "FroMage", "createdAt": "2020-03-09T14:00:01Z", "path": "docs/src/main/asciidoc/hibernate-orm-panache.adoc", "diffHunk": "@@ -440,6 +440,31 @@ return Person.find(\"status\", Status.Alive)\n \n The `PanacheQuery` type has many other methods to deal with paging and returning streams.\n \n+=== Using a range instead of pages\n+\n+`PanacheQuery` also allow range based query instead of page based.\n+\n+[source,java]\n+----\n+// create a query for all living persons\n+PanacheQuery<Person> livingPersons = Person.find(\"status\", Status.Alive);\n+\n+// make it use a range or start index 0 and last index 25.", "originalCommit": "611dcd5601d7a09a246e331acb13a3328a8fdcc8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcwMDg2NQ==", "url": "https://github.com/quarkusio/quarkus/pull/7510#discussion_r389700865", "bodyText": "Oh hold on, I thought the range was inclusive on the last index? If it is, then you get element 25 for the previous range and this one too, no?", "author": "FroMage", "createdAt": "2020-03-09T14:01:08Z", "path": "docs/src/main/asciidoc/hibernate-orm-panache.adoc", "diffHunk": "@@ -440,6 +440,31 @@ return Person.find(\"status\", Status.Alive)\n \n The `PanacheQuery` type has many other methods to deal with paging and returning streams.\n \n+=== Using a range instead of pages\n+\n+`PanacheQuery` also allow range based query instead of page based.\n+\n+[source,java]\n+----\n+// create a query for all living persons\n+PanacheQuery<Person> livingPersons = Person.find(\"status\", Status.Alive);\n+\n+// make it use a range or start index 0 and last index 25.\n+livingPersons.range(0, 25);\n+\n+// get the range\n+List<Person> firstRange = livingPersons.list();\n+\n+// to get the next range, you need to call range again", "originalCommit": "611dcd5601d7a09a246e331acb13a3328a8fdcc8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcyNjEwNg==", "url": "https://github.com/quarkusio/quarkus/pull/7510#discussion_r389726106", "bodyText": "Yes, the example should be range(0, 24) then range(25, 49) to have two range of 25 items as range starts at 0.\nI'll update the documentation.\nWe can decide to make it start at 1 if needed, but in IT stuff starts at 0 ;)", "author": "loicmathieu", "createdAt": "2020-03-09T14:29:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcwMDg2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTAyMTk3MQ==", "url": "https://github.com/quarkusio/quarkus/pull/7510#discussion_r395021971", "bodyText": "OK fine.", "author": "FroMage", "createdAt": "2020-03-19T13:25:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcwMDg2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcwMjIwMQ==", "url": "https://github.com/quarkusio/quarkus/pull/7510#discussion_r389702201", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            You cannot mix range and page, if you use a range, all page related methods will throw an `UnsupportedOperationException`;\n          \n          \n            \n            You cannot mix ranges and pages: if you use a range, all methods that depend on having a current page will throw an `UnsupportedOperationException`;", "author": "FroMage", "createdAt": "2020-03-09T14:02:20Z", "path": "docs/src/main/asciidoc/hibernate-orm-panache.adoc", "diffHunk": "@@ -440,6 +440,31 @@ return Person.find(\"status\", Status.Alive)\n \n The `PanacheQuery` type has many other methods to deal with paging and returning streams.\n \n+=== Using a range instead of pages\n+\n+`PanacheQuery` also allow range based query instead of page based.\n+\n+[source,java]\n+----\n+// create a query for all living persons\n+PanacheQuery<Person> livingPersons = Person.find(\"status\", Status.Alive);\n+\n+// make it use a range or start index 0 and last index 25.\n+livingPersons.range(0, 25);\n+\n+// get the range\n+List<Person> firstRange = livingPersons.list();\n+\n+// to get the next range, you need to call range again\n+List<Person> secondRange = livingPersons.range(25, 50).list();\n+----\n+\n+[WARNING]\n+----\n+You cannot mix range and page, if you use a range, all page related methods will throw an `UnsupportedOperationException`;", "originalCommit": "611dcd5601d7a09a246e331acb13a3328a8fdcc8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcwMzI2Ng==", "url": "https://github.com/quarkusio/quarkus/pull/7510#discussion_r389703266", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            you must use a method that defines a new page before using them : `page(Page)` or `page(int, int)`.\n          \n          \n            \n            you can switch back to paging using `page(Page)` or `page(int, int)`.", "author": "FroMage", "createdAt": "2020-03-09T14:03:22Z", "path": "docs/src/main/asciidoc/hibernate-orm-panache.adoc", "diffHunk": "@@ -440,6 +440,31 @@ return Person.find(\"status\", Status.Alive)\n \n The `PanacheQuery` type has many other methods to deal with paging and returning streams.\n \n+=== Using a range instead of pages\n+\n+`PanacheQuery` also allow range based query instead of page based.\n+\n+[source,java]\n+----\n+// create a query for all living persons\n+PanacheQuery<Person> livingPersons = Person.find(\"status\", Status.Alive);\n+\n+// make it use a range or start index 0 and last index 25.\n+livingPersons.range(0, 25);\n+\n+// get the range\n+List<Person> firstRange = livingPersons.list();\n+\n+// to get the next range, you need to call range again\n+List<Person> secondRange = livingPersons.range(25, 50).list();\n+----\n+\n+[WARNING]\n+----\n+You cannot mix range and page, if you use a range, all page related methods will throw an `UnsupportedOperationException`;\n+you must use a method that defines a new page before using them : `page(Page)` or `page(int, int)`.", "originalCommit": "611dcd5601d7a09a246e331acb13a3328a8fdcc8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcwMzc5Mg==", "url": "https://github.com/quarkusio/quarkus/pull/7510#discussion_r389703792", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            `PanacheQuery` also allow range based query instead of page based.\n          \n          \n            \n            `PanacheQuery` also allows range-based queries.", "author": "FroMage", "createdAt": "2020-03-09T14:03:44Z", "path": "docs/src/main/asciidoc/mongodb-panache.adoc", "diffHunk": "@@ -437,6 +437,31 @@ return Person.find(\"status\", Status.Alive)\n \n The `PanacheQuery` type has many other methods to deal with paging and returning streams.\n \n+=== Using a range instead of pages\n+\n+`PanacheQuery` also allow range based query instead of page based.", "originalCommit": "611dcd5601d7a09a246e331acb13a3328a8fdcc8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcwNTA0Ng==", "url": "https://github.com/quarkusio/quarkus/pull/7510#discussion_r389705046", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            // make it use a range or start index 0 and last index 25.\n          \n          \n            \n            // make it use a range: start at index 0 until index 25 (inclusive).", "author": "FroMage", "createdAt": "2020-03-09T14:04:55Z", "path": "docs/src/main/asciidoc/mongodb-panache.adoc", "diffHunk": "@@ -437,6 +437,31 @@ return Person.find(\"status\", Status.Alive)\n \n The `PanacheQuery` type has many other methods to deal with paging and returning streams.\n \n+=== Using a range instead of pages\n+\n+`PanacheQuery` also allow range based query instead of page based.\n+\n+[source,java]\n+----\n+// create a query for all living persons\n+PanacheQuery<Person> livingPersons = Person.find(\"status\", Status.Alive);\n+\n+// make it use a range or start index 0 and last index 25.", "originalCommit": "611dcd5601d7a09a246e331acb13a3328a8fdcc8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcwNTMxOA==", "url": "https://github.com/quarkusio/quarkus/pull/7510#discussion_r389705318", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            You cannot mix range and page, if you use a range, all page related methods will throw an `UnsupportedOperationException`;\n          \n          \n            \n            You cannot mix ranges and pages: if you use a range, all methods that depend on having a current page will throw an `UnsupportedOperationException`;", "author": "FroMage", "createdAt": "2020-03-09T14:05:09Z", "path": "docs/src/main/asciidoc/mongodb-panache.adoc", "diffHunk": "@@ -437,6 +437,31 @@ return Person.find(\"status\", Status.Alive)\n \n The `PanacheQuery` type has many other methods to deal with paging and returning streams.\n \n+=== Using a range instead of pages\n+\n+`PanacheQuery` also allow range based query instead of page based.\n+\n+[source,java]\n+----\n+// create a query for all living persons\n+PanacheQuery<Person> livingPersons = Person.find(\"status\", Status.Alive);\n+\n+// make it use a range or start index 0 and last index 25.\n+livingPersons.range(0, 25);\n+\n+// get the range\n+List<Person> firstRange = livingPersons.list();\n+\n+// to get the next range, you need to call range again\n+List<Person> secondRange = livingPersons.range(25, 50).list();\n+----\n+\n+[WARNING]\n+----\n+You cannot mix range and page, if you use a range, all page related methods will throw an `UnsupportedOperationException`;", "originalCommit": "611dcd5601d7a09a246e331acb13a3328a8fdcc8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcwNTUzNA==", "url": "https://github.com/quarkusio/quarkus/pull/7510#discussion_r389705534", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            you must use a method that defines a new page before using them : `page(Page)` or `page(int, int)`.\n          \n          \n            \n            you can switch back to paging using `page(Page)` or `page(int, int)`.", "author": "FroMage", "createdAt": "2020-03-09T14:05:20Z", "path": "docs/src/main/asciidoc/mongodb-panache.adoc", "diffHunk": "@@ -437,6 +437,31 @@ return Person.find(\"status\", Status.Alive)\n \n The `PanacheQuery` type has many other methods to deal with paging and returning streams.\n \n+=== Using a range instead of pages\n+\n+`PanacheQuery` also allow range based query instead of page based.\n+\n+[source,java]\n+----\n+// create a query for all living persons\n+PanacheQuery<Person> livingPersons = Person.find(\"status\", Status.Alive);\n+\n+// make it use a range or start index 0 and last index 25.\n+livingPersons.range(0, 25);\n+\n+// get the range\n+List<Person> firstRange = livingPersons.list();\n+\n+// to get the next range, you need to call range again\n+List<Person> secondRange = livingPersons.range(25, 50).list();\n+----\n+\n+[WARNING]\n+----\n+You cannot mix range and page, if you use a range, all page related methods will throw an `UnsupportedOperationException`;\n+you must use a method that defines a new page before using them : `page(Page)` or `page(int, int)`.", "originalCommit": "611dcd5601d7a09a246e331acb13a3328a8fdcc8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcwNjIxMw==", "url": "https://github.com/quarkusio/quarkus/pull/7510#discussion_r389706213", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public <T extends Entity> PanacheQuery<T> range(int startIdx, int lastIdx);\n          \n          \n            \n                public <T extends Entity> PanacheQuery<T> range(int startIndex, int lastIndex);", "author": "FroMage", "createdAt": "2020-03-09T14:05:55Z", "path": "extensions/panache/hibernate-orm-panache/runtime/src/main/java/io/quarkus/hibernate/orm/panache/PanacheQuery.java", "diffHunk": "@@ -116,6 +116,16 @@\n      */\n     public Page page();\n \n+    /**\n+     * Switch the query to use a fixed range (start index - last index) instead of a page.\n+     * As the range is fixed, subsequent pagination of the query is not possible.\n+     *\n+     * @param startIdx the index of the first element, starting at 0\n+     * @param lastIdx the index of the last element\n+     * @return this query, modified\n+     */\n+    public <T extends Entity> PanacheQuery<T> range(int startIdx, int lastIdx);", "originalCommit": "611dcd5601d7a09a246e331acb13a3328a8fdcc8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcwNzAyMg==", "url": "https://github.com/quarkusio/quarkus/pull/7510#discussion_r389707022", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public <T extends Entity> PanacheQuery<T> range(int startIdx, int lastIdx);\n          \n          \n            \n                public <T extends Entity> PanacheQuery<T> range(int startIndex, int lastIndex);", "author": "FroMage", "createdAt": "2020-03-09T14:06:35Z", "path": "extensions/panache/mongodb-panache/runtime/src/main/java/io/quarkus/mongodb/panache/PanacheQuery.java", "diffHunk": "@@ -116,6 +116,16 @@\n      */\n     public Page page();\n \n+    /**\n+     * Switch the query to use a fixed range (start index - last index) instead of a page.\n+     * As the range is fixed, subsequent pagination of the query is not possible.\n+     *\n+     * @param startIdx the index of the first element, starting at 0\n+     * @param lastIdx the index of the last element\n+     * @return this query, modified\n+     */\n+    public <T extends Entity> PanacheQuery<T> range(int startIdx, int lastIdx);", "originalCommit": "611dcd5601d7a09a246e331acb13a3328a8fdcc8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcwNzI4Ng==", "url": "https://github.com/quarkusio/quarkus/pull/7510#discussion_r389707286", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public <T extends Entity> ReactivePanacheQuery<T> range(int startIdx, int lastIdx);\n          \n          \n            \n                public <T extends Entity> ReactivePanacheQuery<T> range(int startIndex, int lastIndex);", "author": "FroMage", "createdAt": "2020-03-09T14:06:49Z", "path": "extensions/panache/mongodb-panache/runtime/src/main/java/io/quarkus/mongodb/panache/reactive/ReactivePanacheQuery.java", "diffHunk": "@@ -110,6 +110,16 @@\n      */\n     public Page page();\n \n+    /**\n+     * Switch the query to use a fixed range (start index - last index) instead of a page.\n+     * As the range is fixed, subsequent pagination of the query is not possible.\n+     *\n+     * @param startIdx the index of the first element, starting at 0\n+     * @param lastIdx the index of the last element\n+     * @return this query, modified\n+     */\n+    public <T extends Entity> ReactivePanacheQuery<T> range(int startIdx, int lastIdx);", "originalCommit": "611dcd5601d7a09a246e331acb13a3328a8fdcc8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcwODAyNA==", "url": "https://github.com/quarkusio/quarkus/pull/7510#discussion_r389708024", "bodyText": "Please index everywhere here :)", "author": "FroMage", "createdAt": "2020-03-09T14:07:28Z", "path": "extensions/panache/panache-common/runtime/src/main/java/io/quarkus/panache/common/Range.java", "diffHunk": "@@ -0,0 +1,36 @@\n+package io.quarkus.panache.common;\n+\n+/**\n+ * <p>\n+ * Utility class to represent ranging information. Range instances are immutable.\n+ * </p>\n+ *\n+ * <p>\n+ * Usage:\n+ * </p>\n+ *\n+ * <code><pre>\n+ * Range range = Range.of(0, 5);\n+ * </pre></code>\n+ */\n+public class Range {\n+    private final int startIdx;\n+    private final int lastIdx;\n+\n+    public Range(int startIdx, int lastIdx) {", "originalCommit": "611dcd5601d7a09a246e331acb13a3328a8fdcc8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f99b8536e42808ae2b5b8b6490068a2b42ca5144", "url": "https://github.com/quarkusio/quarkus/commit/f99b8536e42808ae2b5b8b6490068a2b42ca5144", "message": "feat: MongoDB with Panache ranged query", "committedDate": "2020-03-09T14:47:25Z", "type": "forcePushed"}, {"oid": "c0e4a19932dee2dfb47d5a2f73a97081d3beefab", "url": "https://github.com/quarkusio/quarkus/commit/c0e4a19932dee2dfb47d5a2f73a97081d3beefab", "message": "feat: Hibernate with Panache ranged query", "committedDate": "2020-03-19T13:32:49Z", "type": "commit"}, {"oid": "52251c8ce47452e7e67bebd3d7cfb1e87ea72bf2", "url": "https://github.com/quarkusio/quarkus/commit/52251c8ce47452e7e67bebd3d7cfb1e87ea72bf2", "message": "feat: MongoDB with Panache ranged query", "committedDate": "2020-03-19T13:32:49Z", "type": "commit"}, {"oid": "52251c8ce47452e7e67bebd3d7cfb1e87ea72bf2", "url": "https://github.com/quarkusio/quarkus/commit/52251c8ce47452e7e67bebd3d7cfb1e87ea72bf2", "message": "feat: MongoDB with Panache ranged query", "committedDate": "2020-03-19T13:32:49Z", "type": "forcePushed"}]}