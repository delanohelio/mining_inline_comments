{"pr_number": 10060, "pr_title": "Make Hibernate Reactive work w/o Narayana and Agroal", "pr_createdAt": "2020-06-16T18:29:22Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/10060", "timeline": [{"oid": "e24cb42e7d2ea0e6e8ce5c100fe0b1a00ddab34d", "url": "https://github.com/quarkusio/quarkus/commit/e24cb42e7d2ea0e6e8ce5c100fe0b1a00ddab34d", "message": "Exclude Agroal and Narayana from Hibernate Reactive dependencies", "committedDate": "2020-06-16T17:14:32Z", "type": "commit"}, {"oid": "96ed095b7e2bf098c648542e7cdfe0cd3485997b", "url": "https://github.com/quarkusio/quarkus/commit/96ed095b7e2bf098c648542e7cdfe0cd3485997b", "message": "No longer need to disable the jdbc extension in integration tests", "committedDate": "2020-06-16T17:27:37Z", "type": "commit"}, {"oid": "22b57e5ff4c0d424ecf124b1a7c94ab0f4ed8b84", "url": "https://github.com/quarkusio/quarkus/commit/22b57e5ff4c0d424ecf124b1a7c94ab0f4ed8b84", "message": "Avoid the TransactionEntityManagers bean to introduce a hard need on the Narayana deployment module", "committedDate": "2020-06-16T17:27:37Z", "type": "commit"}, {"oid": "8ad5448add13f9e93a690ca763f05cf7181a3d50", "url": "https://github.com/quarkusio/quarkus/commit/8ad5448add13f9e93a690ca763f05cf7181a3d50", "message": "Make the JTA integration depend on the presence of the JTA capability", "committedDate": "2020-06-16T17:27:37Z", "type": "commit"}, {"oid": "8ef31272d351128ebd963d0a64e774b175d28318", "url": "https://github.com/quarkusio/quarkus/commit/8ef31272d351128ebd963d0a64e774b175d28318", "message": "Help the native-image compiler with an explicit substitution", "committedDate": "2020-06-16T17:36:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ4NTQ0NA==", "url": "https://github.com/quarkusio/quarkus/pull/10060#discussion_r443485444", "bodyText": "Doesn't this dependency cause the TRANSACTIONS capability to be available at build time, and therefore  QuarkusJtaPlatform used? Does this need to be excluded from the deps?", "author": "johnaohara", "createdAt": "2020-06-22T11:12:26Z", "path": "extensions/hibernate-reactive/deployment/pom.xml", "diffHunk": "@@ -20,6 +20,28 @@\n         <dependency>\n             <groupId>io.quarkus</groupId>\n             <artifactId>quarkus-hibernate-orm-deployment</artifactId>\n+            <exclusions>\n+                <exclusion>\n+                    <groupId>io.quarkus</groupId>\n+                    <artifactId>quarkus-narayana-jta-deployment</artifactId>\n+                </exclusion>\n+                <exclusion>\n+                    <groupId>io.quarkus</groupId>\n+                    <artifactId>quarkus-narayana-jta</artifactId>\n+                </exclusion>\n+                <exclusion>", "originalCommit": "8ef31272d351128ebd963d0a64e774b175d28318", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ5NDQ0Mg==", "url": "https://github.com/quarkusio/quarkus/pull/10060#discussion_r443494442", "bodyText": "Hadn't noticed this was an exclusion!", "author": "johnaohara", "createdAt": "2020-06-22T11:32:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ4NTQ0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ5MjczOQ==", "url": "https://github.com/quarkusio/quarkus/pull/10060#discussion_r443492739", "bodyText": "Could QuarkusJtaPlatformInitiator be resolved from the service registry?", "author": "johnaohara", "createdAt": "2020-06-22T11:28:17Z", "path": "extensions/hibernate-orm/runtime/src/main/java/io/quarkus/hibernate/orm/runtime/boot/FastBootMetadataBuilder.java", "diffHunk": "@@ -379,7 +383,8 @@ private PrevalidatedQuarkusMetadata trimBootstrapMetadata(MetadataImpl fullMeta)\n     }\n \n     private JtaPlatform extractJtaPlatform() {\n-        return QuarkusJtaPlatform.INSTANCE;\n+        final QuarkusJtaPlatformInitiator quarkusJtaPlatformInitiator = new QuarkusJtaPlatformInitiator(jtaPresent);\n+        return quarkusJtaPlatformInitiator.buildJtaPlatformInstance();", "originalCommit": "8ef31272d351128ebd963d0a64e774b175d28318", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzUwNTIzOA==", "url": "https://github.com/quarkusio/quarkus/pull/10060#discussion_r443505238", "bodyText": "Don't you run the risk of those beans being removed by ArC's optimisation, or are they already unremovable if Agroal is present?", "author": "FroMage", "createdAt": "2020-06-22T11:54:49Z", "path": "extensions/hibernate-orm/runtime/src/main/java/io/quarkus/hibernate/orm/runtime/TransactionEntityManagers.java", "diffHunk": "@@ -39,8 +34,18 @@ public EntityManager getEntityManager(String unitName) {\n             return entityManager;\n         }\n         return managers.computeIfAbsent(unitName, (un) -> new TransactionScopedEntityManager(\n-                transactionManager, transactionSynchronizationRegistry, jpaConfig.getEntityManagerFactory(un), un,\n+                getTransactionManager(), getTransactionSynchronizationRegistry(), jpaConfig.getEntityManagerFactory(un), un,\n                 requestScopedEntityManagers));\n     }\n \n+    private TransactionManager getTransactionManager() {", "originalCommit": "8ef31272d351128ebd963d0a64e774b175d28318", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc0MTgxNA==", "url": "https://github.com/quarkusio/quarkus/pull/10060#discussion_r443741814", "bodyText": "Good question, I'm checking. Isn't it weird that no test failed?", "author": "Sanne", "createdAt": "2020-06-22T18:15:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzUwNTIzOA=="}], "type": "inlineReview"}]}