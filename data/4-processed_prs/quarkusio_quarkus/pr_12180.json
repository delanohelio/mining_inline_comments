{"pr_number": 12180, "pr_title": "Micrometer Vert.x HTTP request propagation", "pr_createdAt": "2020-09-18T01:26:10Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/12180", "timeline": [{"oid": "8f7acf09e9278b3dda15c496e6fbf38859735ab1", "url": "https://github.com/quarkusio/quarkus/commit/8f7acf09e9278b3dda15c496e6fbf38859735ab1", "message": "Micrometer Vert.x HTTP request propagation", "committedDate": "2020-09-18T01:26:16Z", "type": "forcePushed"}, {"oid": "84a811860612216c26065db89b1aa115559a9665", "url": "https://github.com/quarkusio/quarkus/commit/84a811860612216c26065db89b1aa115559a9665", "message": "Micrometer Vert.x HTTP request propagation", "committedDate": "2020-09-18T01:34:20Z", "type": "forcePushed"}, {"oid": "0d0943586e0ac74980c7e3f08530203f7f40e3d1", "url": "https://github.com/quarkusio/quarkus/commit/0d0943586e0ac74980c7e3f08530203f7f40e3d1", "message": "Micrometer Vert.x HTTP request propagation", "committedDate": "2020-09-18T01:36:40Z", "type": "forcePushed"}, {"oid": "7f175930bdd315355c5bb5f1529e615ebc453c73", "url": "https://github.com/quarkusio/quarkus/commit/7f175930bdd315355c5bb5f1529e615ebc453c73", "message": "Micrometer Vert.x HTTP request propagation", "committedDate": "2020-09-18T01:37:59Z", "type": "forcePushed"}, {"oid": "114d18ead7ba2c52503f67c61b43045c1ccfa754", "url": "https://github.com/quarkusio/quarkus/commit/114d18ead7ba2c52503f67c61b43045c1ccfa754", "message": "Micrometer Vert.x HTTP request propagation", "committedDate": "2020-09-18T01:45:35Z", "type": "forcePushed"}, {"oid": "d97734f9009b5d0f55c2cf9e7f440876fb93f5d5", "url": "https://github.com/quarkusio/quarkus/commit/d97734f9009b5d0f55c2cf9e7f440876fb93f5d5", "message": "Micrometer Vert.x HTTP request propagation", "committedDate": "2020-09-18T01:54:41Z", "type": "forcePushed"}, {"oid": "dfae5673629e3fea5a9525442499e4a85faa8caf", "url": "https://github.com/quarkusio/quarkus/commit/dfae5673629e3fea5a9525442499e4a85faa8caf", "message": "Micrometer Vert.x HTTP request propagation", "committedDate": "2020-09-18T02:12:54Z", "type": "forcePushed"}, {"oid": "157ca79d5eaf6e09507b70048daec9942b7cd849", "url": "https://github.com/quarkusio/quarkus/commit/157ca79d5eaf6e09507b70048daec9942b7cd849", "message": "Micrometer Vert.x HTTP request propagation", "committedDate": "2020-09-18T12:09:46Z", "type": "forcePushed"}, {"oid": "a6401584475fdaf32b0608db3df35f8b80ef0966", "url": "https://github.com/quarkusio/quarkus/commit/a6401584475fdaf32b0608db3df35f8b80ef0966", "message": "Micrometer Vert.x HTTP request propagation", "committedDate": "2020-09-18T13:23:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAwNzU3Ng==", "url": "https://github.com/quarkusio/quarkus/pull/12180#discussion_r491007576", "bodyText": "minor nit, should the variable name change from metricsContext?", "author": "kenfinnigan", "createdAt": "2020-09-18T14:57:12Z", "path": "extensions/micrometer/runtime/src/main/java/io/quarkus/micrometer/runtime/binder/vertx/VertxHttpServerMetrics.java", "diffHunk": "@@ -68,97 +70,110 @@\n     /**\n      * Called when an http server response is pushed.\n      *\n-     * @param socketMetric a MetricsContext object for socket metric context\n+     * @param socketMetric a Map for socket metric context or null\n      * @param method the pushed response method\n      * @param uri the pushed response uri\n      * @param response the http server response\n-     * @return a MetricsContext object for request metric context or null\n+     * @return a RequestMetricContext\n      */\n     @Override\n-    public MetricsContext responsePushed(MetricsContext socketMetric, HttpMethod method, String uri,\n+    public RequestMetric responsePushed(Map<String, Object> socketMetric, HttpMethod method, String uri,\n             HttpServerResponse response) {\n+        RequestMetric metricContext = new RequestMetric();", "originalCommit": "a6401584475fdaf32b0608db3df35f8b80ef0966", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAxMTgxNw==", "url": "https://github.com/quarkusio/quarkus/pull/12180#discussion_r491011817", "bodyText": "Am I correct in saying metricContext just returns a new RequestMetric that isn't hooked into anything? Could the method just return a new instance?", "author": "kenfinnigan", "createdAt": "2020-09-18T15:04:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAwNzU3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAxMjQyMg==", "url": "https://github.com/quarkusio/quarkus/pull/12180#discussion_r491012422", "bodyText": "Should this be using retrieveRequestMetric ?", "author": "kenfinnigan", "createdAt": "2020-09-18T15:05:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAwNzU3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAyMjQxMA==", "url": "https://github.com/quarkusio/quarkus/pull/12180#discussion_r491022410", "bodyText": "you are correct in that it creates and returns a RequestMetric ... but Vertx uses that returned object for later things. In the case of push, that's HTTP2/Stream, and it is difficult to follow where that is used.\nNote that any of the objects passed to/from these methods aren't interpreted by Vert.x .. it just takes them, and passes them back later. The responsePushed callback is especially weird re: parameters.\nsetRequestMetric/retrieveRequestMetric are specific to synchronous requests that go through handlers to work around a disconnect between the HttpServerRequest and the RoutingContext. HttpServerRequest has no storage in it, and requestBegin is called before the response is created (which is where cookies are stored.. ), so you can't even cheat and use cookies to pass the RequestMetric along to have RoutingContext added to it. As @stuartwdouglas says (quoted in javadoc): YUCK.", "author": "ebullient", "createdAt": "2020-09-18T15:21:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAwNzU3Ng=="}], "type": "inlineReview"}, {"oid": "d902b9400bf93e7ca0ff13a2b5341743e800e210", "url": "https://github.com/quarkusio/quarkus/commit/d902b9400bf93e7ca0ff13a2b5341743e800e210", "message": "Micrometer Vert.x HTTP request propagation", "committedDate": "2020-09-18T15:22:34Z", "type": "commit"}, {"oid": "d902b9400bf93e7ca0ff13a2b5341743e800e210", "url": "https://github.com/quarkusio/quarkus/commit/d902b9400bf93e7ca0ff13a2b5341743e800e210", "message": "Micrometer Vert.x HTTP request propagation", "committedDate": "2020-09-18T15:22:34Z", "type": "forcePushed"}]}