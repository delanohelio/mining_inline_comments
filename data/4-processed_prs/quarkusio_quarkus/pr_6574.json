{"pr_number": 6574, "pr_title": "Support both GraalVM 19.2.1 and 19.3.1", "pr_createdAt": "2020-01-16T01:14:43Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/6574", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE5MzczNg==", "url": "https://github.com/quarkusio/quarkus/pull/6574#discussion_r367193736", "bodyText": "I tried to find a simpler expression to force the exception throw here, but I didn't find anything that worked. I'm sure this expression could be much shorter...", "author": "gwenneg", "createdAt": "2020-01-16T01:39:25Z", "path": "core/deployment/src/main/java/io/quarkus/deployment/steps/NativeImageAutoFeatureStep.java", "diffHunk": "@@ -205,7 +208,26 @@ public void write(String s, byte[] bytes) {\n         }\n \n         if (!resourceBundles.isEmpty()) {\n-            ResultHandle locClass = overallCatch.loadClass(LOCALIZATION_FEATURE);\n+            /*\n+             * Start of a temporary workaround to support both GraalVM 19.2.1 and 19.3.1 at the same time.\n+             * TODO: Delete this workaround when Quarkus no longer supports GraalVM 19.2.1.\n+             */\n+            AssignableResultHandle locClass = overallCatch.createVariable(Class.class);\n+            TryBlock workaroundTryBlock = overallCatch.tryBlock();\n+            workaroundTryBlock.assign(locClass, workaroundTryBlock.loadClass(LOCALIZATION_FEATURE));\n+            // The following line is required to throw an exception and make sure we load the 19.2.1 class when needed.\n+            workaroundTryBlock.invokeVirtualMethod(\n+                    ofMethod(Class.class, \"getDeclaredMethod\", Method.class, String.class, Class[].class), locClass,\n+                    workaroundTryBlock.load(\"addBundleToCache\"),\n+                    workaroundTryBlock.marshalAsArray(Class.class, workaroundTryBlock.loadClass(String.class)));", "originalCommit": "45aa64f8b350a9fa63d2a1cb8f6770124a7b54f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzI1NjYxNQ==", "url": "https://github.com/quarkusio/quarkus/pull/6574#discussion_r367256615", "bodyText": "I think it's just fine. You are just trying to make sure the method exists right? It should be perfectly OK and in any case it should be temporary", "author": "geoand", "createdAt": "2020-01-16T06:54:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE5MzczNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzI3Nzk5OA==", "url": "https://github.com/quarkusio/quarkus/pull/6574#discussion_r367277998", "bodyText": "Actually, I only need to check if the com.oracle.svm.core.jdk.LocalizationFeature class is available, I'm not really interested in the method itself. But invoking a simple getName from LocalizationFeature wasn't enough to force an exception throw. That's not really a problem since this code is only a copy of the original code a few lines below and it is also temporary, but that's still not pretty :)", "author": "gwenneg", "createdAt": "2020-01-16T08:07:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE5MzczNg=="}], "type": "inlineReview"}, {"oid": "dc2ff882ebf5d4a6925c2a6fb051ee35b9dea3f2", "url": "https://github.com/quarkusio/quarkus/commit/dc2ff882ebf5d4a6925c2a6fb051ee35b9dea3f2", "message": "Disable JNI by default with GraalVM 19.2.1", "committedDate": "2020-01-16T11:02:23Z", "type": "forcePushed"}, {"oid": "2621c832511a45be48157652079ae8eaf02d98df", "url": "https://github.com/quarkusio/quarkus/commit/2621c832511a45be48157652079ae8eaf02d98df", "message": "Disable JNI by default with GraalVM 19.2.1", "committedDate": "2020-01-16T14:38:26Z", "type": "forcePushed"}, {"oid": "d68ff6af1983de0368aed05b51cbad00c96322f2", "url": "https://github.com/quarkusio/quarkus/commit/d68ff6af1983de0368aed05b51cbad00c96322f2", "message": "Fix build", "committedDate": "2020-01-16T14:47:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUzOTIxOA==", "url": "https://github.com/quarkusio/quarkus/pull/6574#discussion_r367539218", "bodyText": "Please add parentheses here. And I would have  19.2. as the pattern (with a leading space).", "author": "gsmet", "createdAt": "2020-01-16T17:02:02Z", "path": "core/deployment/src/main/java/io/quarkus/deployment/pkg/steps/NativeImageBuildStep.java", "diffHunk": "@@ -266,7 +266,7 @@ public NativeImageBuildItem build(NativeConfig nativeConfig, NativeImageSourceJa\n             if (!nativeConfig.enableIsolates) {\n                 command.add(\"-H:-SpawnIsolates\");\n             }\n-            if (nativeConfig.enableJni) {\n+            if (nativeConfig.enableJni || graalVMVersion.isPresent() && !graalVMVersion.get().contains(\" 19.2.1 \")) {", "originalCommit": "d68ff6af1983de0368aed05b51cbad00c96322f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU1Mzk1NA==", "url": "https://github.com/quarkusio/quarkus/pull/6574#discussion_r367553954", "bodyText": "Does this mean we officially support GraalVM 19.2.0?", "author": "gwenneg", "createdAt": "2020-01-16T17:31:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUzOTIxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU2NDY3Mw==", "url": "https://github.com/quarkusio/quarkus/pull/6574#discussion_r367564673", "bodyText": "No. But I don't see the point of being too picky about this while we can just enable JNI for all 19.2.", "author": "gsmet", "createdAt": "2020-01-16T17:55:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUzOTIxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUzOTgwMg==", "url": "https://github.com/quarkusio/quarkus/pull/6574#discussion_r367539802", "bodyText": "I don't think this logic should be changed in this patch. This is too restrictive.\nI'm OK for the error message change but I would keep the logic as it was and replace experimental with preview.", "author": "gsmet", "createdAt": "2020-01-16T17:03:11Z", "path": "core/deployment/src/main/java/io/quarkus/deployment/pkg/steps/NativeImageBuildStep.java", "diffHunk": "@@ -322,12 +322,11 @@ public NativeImageBuildItem build(NativeConfig nativeConfig, NativeImageSourceJa\n \n     private void checkGraalVMVersion(String version) {\n         log.info(\"Running Quarkus native-image plugin on \" + version);\n-        final List<String> obsoleteGraalVmVersions = Arrays.asList(\"1.0.0\", \"19.0.\", \"19.1.\", \"19.2.\");\n-        final boolean vmVersionIsObsolete = version.contains(\" 19.3.0 \")\n-                || obsoleteGraalVmVersions.stream().anyMatch(v -> version.contains(\" \" + v));\n-        if (vmVersionIsObsolete) {\n-            throw new IllegalStateException(\n-                    \"Out of date build of GraalVM detected: \" + version + \". Please upgrade to GraalVM 19.3.0.2\");\n+        List<String> supportedGraalVmVersions = Arrays.asList(\" 19.2.1 \", \" 19.3.1 \");\n+        if (supportedGraalVmVersions.stream().noneMatch(version::contains)) {\n+            throw new IllegalStateException(\"Unsupported version of GraalVM detected: \" + version + \".\"\n+                    + \" Quarkus currently offers a stable support of GraalVM 19.2.1 and an experimental support of GraalVM 19.3.1.\"\n+                    + \" Please upgrade GraalVM to one of these versions.\");", "originalCommit": "d68ff6af1983de0368aed05b51cbad00c96322f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU3MjU5OA==", "url": "https://github.com/quarkusio/quarkus/pull/6574#discussion_r367572598", "bodyText": "Ok, I'll get rid of the restrictive part.", "author": "gwenneg", "createdAt": "2020-01-16T18:13:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUzOTgwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU0MDczMw==", "url": "https://github.com/quarkusio/quarkus/pull/6574#discussion_r367540733", "bodyText": "I'm not sure I understand why you are adding all those lines?", "author": "gsmet", "createdAt": "2020-01-16T17:05:03Z", "path": "integration-tests/jpa-without-entity/pom.xml", "diffHunk": "@@ -105,6 +105,7 @@\n                                     <cleanupServer>true</cleanupServer>\n                                     <enableHttpUrlHandler>true</enableHttpUrlHandler>\n                                     <graalvmHome>${graalvmHome}</graalvmHome>\n+                                    <enableJni>false</enableJni>", "originalCommit": "d68ff6af1983de0368aed05b51cbad00c96322f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU0NDMwMA==", "url": "https://github.com/quarkusio/quarkus/pull/6574#discussion_r367544300", "bodyText": "Well, I'm only restoring values that existed before we moved to GraalMV 19.3.0 on our master branch. None of these enableJni is new and maybe most (if not all) of them are irrelevant.", "author": "gwenneg", "createdAt": "2020-01-16T17:11:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU0MDczMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU0MTAzNQ==", "url": "https://github.com/quarkusio/quarkus/pull/6574#discussion_r367541035", "bodyText": "I don't understand that? I mean the extensions themselves should trigger the enablement of JNI, no?", "author": "gsmet", "createdAt": "2020-01-16T17:05:38Z", "path": "integration-tests/vertx-http/pom.xml", "diffHunk": "@@ -103,6 +103,7 @@\n                                         <additionalBuildArg>-H:EnableURLProtocols=http,https</additionalBuildArg>\n                                     </additionalBuildArgs>\n                                     <graalvmHome>${graalvmHome}</graalvmHome>\n+                                    <enableJni>true</enableJni>", "originalCommit": "d68ff6af1983de0368aed05b51cbad00c96322f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU0NTIxMA==", "url": "https://github.com/quarkusio/quarkus/pull/6574#discussion_r367545210", "bodyText": "Same answer as above :)", "author": "gwenneg", "createdAt": "2020-01-16T17:13:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU0MTAzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU0MTk1MA==", "url": "https://github.com/quarkusio/quarkus/pull/6574#discussion_r367541950", "bodyText": "This fixes an exception that appeared with ubi-quarkus-native-image:19.3.1-java8:\nCaused by: com.oracle.svm.hosted.substitute.DeletedElementException: Unsupported method org.h2.engine.Engine.getInstance() is reachable: The declaring class of this element has been substituted, but this element is not present in the substitution class", "author": "gwenneg", "createdAt": "2020-01-16T17:07:20Z", "path": "extensions/jdbc/jdbc-h2/runtime/src/main/java/io/quarkus/jdbc/h2/runtime/graal/Engine.java", "diffHunk": "@@ -3,13 +3,19 @@\n import org.h2.engine.ConnectionInfo;\n import org.h2.engine.Session;\n \n+import com.oracle.svm.core.SubstrateUtil;\n import com.oracle.svm.core.annotate.Substitute;\n import com.oracle.svm.core.annotate.TargetClass;\n \n @TargetClass(className = \"org.h2.engine.Engine\")\n @Substitute\n public final class Engine {\n \n+    @Substitute\n+    public static org.h2.engine.Engine getInstance() {\n+        return SubstrateUtil.cast(new Engine(), org.h2.engine.Engine.class);\n+    }", "originalCommit": "44cc35ee5d8c892bf0860a028338c560321d4686", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU0MjY0NA==", "url": "https://github.com/quarkusio/quarkus/pull/6574#discussion_r367542644", "bodyText": "This looks a lot like a GraalVM bug that was fixed a long time ago.\nAnyway, let's make progress.", "author": "gsmet", "createdAt": "2020-01-16T17:08:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU0MTk1MA=="}], "type": "inlineReview"}, {"oid": "33ea19d16e8b16e470617989577e00d26cb74638", "url": "https://github.com/quarkusio/quarkus/commit/33ea19d16e8b16e470617989577e00d26cb74638", "message": "Support both GraalVM 19.2.1 and 19.3.1", "committedDate": "2020-01-16T19:56:10Z", "type": "commit"}, {"oid": "27af95ccbf1643dfd5ecbb36c18ec3d36747eeef", "url": "https://github.com/quarkusio/quarkus/commit/27af95ccbf1643dfd5ecbb36c18ec3d36747eeef", "message": "Fix quarkus-integration-test-infinispan-embedded in native mode", "committedDate": "2020-01-16T19:56:46Z", "type": "commit"}, {"oid": "9b74e0e327cbdcd7fd87b54a265602c57d5904e9", "url": "https://github.com/quarkusio/quarkus/commit/9b74e0e327cbdcd7fd87b54a265602c57d5904e9", "message": "Disable quarkus-integration-test-jsch in native mode temporarily", "committedDate": "2020-01-16T19:57:02Z", "type": "commit"}, {"oid": "5cbefa6ffcd9fec6a5677ee1b6ab481db9214466", "url": "https://github.com/quarkusio/quarkus/commit/5cbefa6ffcd9fec6a5677ee1b6ab481db9214466", "message": "Remove useless project.version in quarkus-narayana-stm-deployment", "committedDate": "2020-01-16T19:59:41Z", "type": "commit"}, {"oid": "dea977da7c72e6e18f79cf709199ff411ebe9205", "url": "https://github.com/quarkusio/quarkus/commit/dea977da7c72e6e18f79cf709199ff411ebe9205", "message": "Disable JNI by default with GraalVM 19.2.1", "committedDate": "2020-01-16T20:02:44Z", "type": "commit"}, {"oid": "2d68b721bcc3ccba976221c5cc2f32dc02374429", "url": "https://github.com/quarkusio/quarkus/commit/2d68b721bcc3ccba976221c5cc2f32dc02374429", "message": "Fix H2 native DeletedElementException", "committedDate": "2020-01-16T20:02:57Z", "type": "commit"}, {"oid": "2d68b721bcc3ccba976221c5cc2f32dc02374429", "url": "https://github.com/quarkusio/quarkus/commit/2d68b721bcc3ccba976221c5cc2f32dc02374429", "message": "Fix H2 native DeletedElementException", "committedDate": "2020-01-16T20:02:57Z", "type": "forcePushed"}]}