{"pr_number": 239, "pr_title": "Created azure-storage unit tests (excluding TransferManager). Modified public API.", "pr_createdAt": "2020-05-23T01:58:20Z", "pr_url": "https://github.com/Azure/azure-sdk-for-android/pull/239", "timeline": [{"oid": "f7ee342b1f4e1f86221ee79d250d3da3e4c36a88", "url": "https://github.com/Azure/azure-sdk-for-android/commit/f7ee342b1f4e1f86221ee79d250d3da3e4c36a88", "message": "Created tests for SasTokenCredential and SasTokenCredentialInterceptor. Made a couple classes in azure-core public, which will prove useful for other interceptor tests too. Made a correction to SasTokenCredentialInterceptor where it could append 'null' at the beginning of a URL's query if the request URL had no query parameters.", "committedDate": "2020-04-29T00:48:03Z", "type": "commit"}, {"oid": "932a450a7083b1b1ef2f8cc3bf2b27abfe84ddd6", "url": "https://github.com/Azure/azure-sdk-for-android/commit/932a450a7083b1b1ef2f8cc3bf2b27abfe84ddd6", "message": "Created tests for NormalizeEtagInterceptor and ResponseHeadersValidationInterceptor. Made a small change to NormalizeEtagInterceptor to use the ETag header value from HttpHeader instead of a local constant.", "committedDate": "2020-04-30T00:11:41Z", "type": "commit"}, {"oid": "1f0dc6a5abd407776d315ca8f3a9d3433e089551", "url": "https://github.com/Azure/azure-sdk-for-android/commit/1f0dc6a5abd407776d315ca8f3a9d3433e089551", "message": "Merge branch 'dev' into storage-tests", "committedDate": "2020-05-07T20:23:16Z", "type": "commit"}, {"oid": "956ef01caf908109138d42ce5a8146bd4e84ed0b", "url": "https://github.com/Azure/azure-sdk-for-android/commit/956ef01caf908109138d42ce5a8146bd4e84ed0b", "message": "Renamed a couple StorageBlobClient's methods to be clearer and consistent with the rest of the public API.", "committedDate": "2020-05-22T11:31:53Z", "type": "commit"}, {"oid": "ad8653d0480d788ddb2bc17e983b6e80a43bd023", "url": "https://github.com/Azure/azure-sdk-for-android/commit/ad8653d0480d788ddb2bc17e983b6e80a43bd023", "message": "Changed the return types of `getBlobsInPage`, `stageBlock` & `commitBlockList` operations to be consistent with the rest of the public API. Also reformatted some code for better readability.", "committedDate": "2020-05-22T11:42:52Z", "type": "commit"}, {"oid": "01fac2bcada882b18ada4a286509e7f5d6da3efb", "url": "https://github.com/Azure/azure-sdk-for-android/commit/01fac2bcada882b18ada4a286509e7f5d6da3efb", "message": "Created \"happy path\" unit tests for StorageBlobClient.", "committedDate": "2020-05-22T11:43:29Z", "type": "commit"}, {"oid": "c119a599137d9303c2d877e707497becf1cb679a", "url": "https://github.com/Azure/azure-sdk-for-android/commit/c119a599137d9303c2d877e707497becf1cb679a", "message": "Updated the return types of multiple operations in StorageBlobClient and StorageBlobClientImpl to be improve consistency. Created a couple model classes as well.", "committedDate": "2020-05-23T07:58:50Z", "type": "commit"}, {"oid": "ab62c210989e3056c91a5efd3e25def661d18de6", "url": "https://github.com/Azure/azure-sdk-for-android/commit/ab62c210989e3056c91a5efd3e25def661d18de6", "message": "Updated unit tests for StorageBlobClient to reflect the return type changes. Added comments to better explain what each test does in some classes.", "committedDate": "2020-05-23T08:00:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg4Njg5NQ==", "url": "https://github.com/Azure/azure-sdk-for-android/pull/239#discussion_r432886895", "bodyText": "I would suggest to keep the exception message as it is (i.e. whatever service returns), I mean not to prepend any text like \"no message, \"message: \" to it. The reason is, service often return the message in xml format. End user might want to parse it using xml parser, this prefix make it hard, now user has to know about the prefix, apply substring(..) before xml parsing.", "author": "anuchandy", "createdAt": "2020-05-30T20:59:44Z", "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/android/storage/blob/StorageBlobServiceImpl.java", "diffHunk": "@@ -921,15 +1015,19 @@ public void onFailure(@NonNull Call<ResponseBody> call, @NonNull Throwable t) {\n                         headers);\n \n                     return new CallAndOptionalResult<>(call, result);\n-                } else { // Error response\n-                    String strContent = readAsString(response.body());\n+                } else {\n+                    ResponseBody responseBody = response.body();\n+                    String message = responseBody == null ? \"no message\" : \"message: \" + readAsString(responseBody);", "originalCommit": "ab62c210989e3056c91a5efd3e25def661d18de6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg4NzE2Ng==", "url": "https://github.com/Azure/azure-sdk-for-android/pull/239#discussion_r432887166", "bodyText": "Refer above comment i.e. I would suggest keeping the message as it is. Also the HTTP response.code() is often 200 with the actual error-code exists in the response-header, so this extra text additions may not add much value but make it bit difficult to parse like I mentioned above.", "author": "anuchandy", "createdAt": "2020-05-30T21:02:59Z", "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/android/storage/blob/StorageBlobServiceImpl.java", "diffHunk": "@@ -921,15 +1015,19 @@ public void onFailure(@NonNull Call<ResponseBody> call, @NonNull Throwable t) {\n                         headers);\n \n                     return new CallAndOptionalResult<>(call, result);\n-                } else { // Error response\n-                    String strContent = readAsString(response.body());\n+                } else {\n+                    ResponseBody responseBody = response.body();\n+                    String message = responseBody == null ? \"no message\" : \"message: \" + readAsString(responseBody);\n \n-                    throw new BlobStorageException(strContent, response.raw());\n+                    throw new BlobStorageException(\"Response failed with code: \" + response.code() + \" and \" + message,", "originalCommit": "ab62c210989e3056c91a5efd3e25def661d18de6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg4NzIyMA==", "url": "https://github.com/Azure/azure-sdk-for-android/pull/239#discussion_r432887220", "bodyText": "good catch and fix \ud83d\udc4d", "author": "anuchandy", "createdAt": "2020-05-30T21:03:47Z", "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/android/storage/blob/interceptor/SasTokenCredentialInterceptor.java", "diffHunk": "@@ -28,17 +28,20 @@ public SasTokenCredentialInterceptor(SasTokenCredential credential) {\n     public Response intercept(Chain chain) throws IOException {\n         HttpUrl requestURL = chain.request().url();\n \n-        String encodedQuery = requestURL.encodedQuery();\n-        if (!isNullOrEmpty(encodedQuery)) {\n-            encodedQuery += \"&\";\n-        }\n-\n         String sasToken = this.credential.getSasToken();\n-        // SAS token is already encoded so its safe to append it to the encoded query from source request.\n-        encodedQuery += sasToken.startsWith(\"?\")\n+        sasToken = sasToken.startsWith(\"?\")\n             ? sasToken.substring(1)\n             : sasToken;\n \n+        // SAS token is already encoded so its safe to append it to the encoded query from source request.\n+        String encodedQuery = requestURL.encodedQuery();\n+\n+        if (isNullOrEmpty(encodedQuery)) {\n+            encodedQuery = sasToken;\n+        } else {\n+            encodedQuery += \"&\" + sasToken;\n+        }", "originalCommit": "ab62c210989e3056c91a5efd3e25def661d18de6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg4OTQzOQ==", "url": "https://github.com/Azure/azure-sdk-for-android/pull/239#discussion_r432889439", "bodyText": "The methods in this category are those with \"simplest\" signature, which should not return any Response type but instead returns the actual value in the response, in this case it should be void.", "author": "anuchandy", "createdAt": "2020-05-30T21:38:51Z", "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/android/storage/blob/StorageBlobClient.java", "diffHunk": "@@ -392,28 +399,28 @@ public ServiceCall downloadWithHeaders(String containerName,\n             callback);\n     }\n \n-    public void stageBlock(String containerName,\n+    public BlockBlobsStageBlockResponse stageBlock(String containerName,", "originalCommit": "ab62c210989e3056c91a5efd3e25def661d18de6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU4MjQxOQ==", "url": "https://github.com/Azure/azure-sdk-for-android/pull/239#discussion_r433582419", "bodyText": "You are right, I must have missed this for stageBlock.", "author": "vcolin7", "createdAt": "2020-06-02T02:08:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg4OTQzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg4OTU0MQ==", "url": "https://github.com/Azure/azure-sdk-for-android/pull/239#discussion_r432889541", "bodyText": "ref the previous comment, this is the async variant with \"simplest\" signature, and should be producing value in the Response (i.e. void) not the Response.", "author": "anuchandy", "createdAt": "2020-05-30T21:40:42Z", "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/android/storage/blob/StorageBlobClient.java", "diffHunk": "@@ -392,28 +399,28 @@ public ServiceCall downloadWithHeaders(String containerName,\n             callback);\n     }\n \n-    public void stageBlock(String containerName,\n+    public BlockBlobsStageBlockResponse stageBlock(String containerName,\n                            String blobName,\n                            String base64BlockId,\n-                           byte[] content,\n+                           byte[] blockContent,\n                            byte[] contentMd5) {\n-        this.storageBlobServiceClient.stageBlock(containerName,\n+        return this.storageBlobServiceClient.stageBlock(containerName,\n             blobName,\n             base64BlockId,\n-            content,\n+            blockContent,\n             contentMd5);\n     }\n \n     public ServiceCall stageBlock(String containerName,\n                                   String blobName,\n                                   String base64BlockId,\n-                                  byte[] body,\n+                                  byte[] blockContent,\n                                   byte[] contentMd5,\n-                                  Callback<Void> callback) {\n+                                  Callback<BlockBlobsStageBlockResponse> callback) {", "originalCommit": "ab62c210989e3056c91a5efd3e25def661d18de6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU4MjU1Ng==", "url": "https://github.com/Azure/azure-sdk-for-android/pull/239#discussion_r433582556", "bodyText": "So we would make this accept a Callback<Void> instead, right?", "author": "vcolin7", "createdAt": "2020-06-02T02:09:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg4OTU0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA3MTg0MA==", "url": "https://github.com/Azure/azure-sdk-for-android/pull/239#discussion_r434071840", "bodyText": "right, I see you already made this change, sorry for delay.", "author": "anuchandy", "createdAt": "2020-06-02T18:03:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg4OTU0MQ=="}], "type": "inlineReview"}, {"oid": "cf675e9e22ebf2d843a33f131e000ed381de2b9e", "url": "https://github.com/Azure/azure-sdk-for-android/commit/cf675e9e22ebf2d843a33f131e000ed381de2b9e", "message": "Made changes based on comments from @anuchandy: changed the return type of the `stageBlock` operations & changed how service errors are handled by `StorageBlobServiceImpl`.", "committedDate": "2020-06-02T02:49:33Z", "type": "commit"}, {"oid": "8acf093cbbd4b889dfbb2f526db4b14f63967999", "url": "https://github.com/Azure/azure-sdk-for-android/commit/8acf093cbbd4b889dfbb2f526db4b14f63967999", "message": "Merge branch 'dev' into storage-tests", "committedDate": "2020-06-02T02:55:16Z", "type": "commit"}, {"oid": "ea0a56c0107b54df57a136bd59bf8e30eea4d3d1", "url": "https://github.com/Azure/azure-sdk-for-android/commit/ea0a56c0107b54df57a136bd59bf8e30eea4d3d1", "message": "Fixed build issue.", "committedDate": "2020-06-02T06:22:37Z", "type": "commit"}, {"oid": "e6a598723bf65622462b75d5684587e8d99ad570", "url": "https://github.com/Azure/azure-sdk-for-android/commit/e6a598723bf65622462b75d5684587e8d99ad570", "message": "Fixed build issues for tests.", "committedDate": "2020-06-02T07:05:14Z", "type": "commit"}, {"oid": "99af8d4cc3352887211aafb30b1dccb5076e2c20", "url": "https://github.com/Azure/azure-sdk-for-android/commit/99af8d4cc3352887211aafb30b1dccb5076e2c20", "message": "Added a missing dependency in azure-storage-blob for the azure-core test classes.", "committedDate": "2020-06-02T21:44:02Z", "type": "commit"}, {"oid": "86866131dc024de70dfbbb5caa681e85e793b7e1", "url": "https://github.com/Azure/azure-sdk-for-android/commit/86866131dc024de70dfbbb5caa681e85e793b7e1", "message": "Moved TestUtils and EnqueueMockResponse from src/test/java to the src/main/java to make it easier to share them with other modules.", "committedDate": "2020-06-02T21:49:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIzMzk4Nw==", "url": "https://github.com/Azure/azure-sdk-for-android/pull/239#discussion_r434233987", "bodyText": "I guess there are two things in the test project:\n\nUnit tests for types in the core project.\nTest types that we want to share with other \"dependent\" projects (e.g., storage).\n\nFor the second category, does it make sense to keeping these shared types rooted at com.azure.android.core.test, hence consistent with the established namespace in java sdk. Its a shippable package in java SDK, we haven't there yet for android but agreeing on the namespace will be a good start. Thoughts?", "author": "anuchandy", "createdAt": "2020-06-02T23:45:38Z", "path": "sdk/core/azure-core/src/main/java/com/azure/android/core/internal/util/test/EnqueueMockResponse.java", "diffHunk": "@@ -1,4 +1,4 @@\n-package com.azure.android.core.http.interceptor;\n+package com.azure.android.core.internal.util.test;", "originalCommit": "86866131dc024de70dfbbb5caa681e85e793b7e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIzNDgyOA==", "url": "https://github.com/Azure/azure-sdk-for-android/pull/239#discussion_r434234828", "bodyText": "Between why did we move \"shared test\" types from \"src/test\" to \"src/main\"?", "author": "anuchandy", "createdAt": "2020-06-02T23:48:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIzMzk4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIzNTkzMQ==", "url": "https://github.com/Azure/azure-sdk-for-android/pull/239#discussion_r434235931", "bodyText": "If discoverability of types are the reason for \"src/test\" -> \"src/main\" then worth checking this: https://stackoverflow.com/questions/5644011/multi-project-test-dependencies-with-gradle/60138176#60138176", "author": "anuchandy", "createdAt": "2020-06-02T23:53:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIzMzk4Nw=="}], "type": "inlineReview"}, {"oid": "648c8c77264ba97f1da1b0452acd25a7e708a6f5", "url": "https://github.com/Azure/azure-sdk-for-android/commit/648c8c77264ba97f1da1b0452acd25a7e708a6f5", "message": "Tried a different way of including common test classes from azure-core in azure-storage-blob.", "committedDate": "2020-06-03T00:37:13Z", "type": "commit"}, {"oid": "5708f70f50e7bebc237d23413f06a4add65e6164", "url": "https://github.com/Azure/azure-sdk-for-android/commit/5708f70f50e7bebc237d23413f06a4add65e6164", "message": "Don't synthesize dependencies for any setup or help task", "committedDate": "2020-06-03T00:37:54Z", "type": "forcePushed"}, {"oid": "7d365c62d94b148bbf13fb4f6883688e837f50f4", "url": "https://github.com/Azure/azure-sdk-for-android/commit/7d365c62d94b148bbf13fb4f6883688e837f50f4", "message": "Don't synthesize dependencies for any setup or help task", "committedDate": "2020-06-03T00:54:11Z", "type": "commit"}, {"oid": "7d365c62d94b148bbf13fb4f6883688e837f50f4", "url": "https://github.com/Azure/azure-sdk-for-android/commit/7d365c62d94b148bbf13fb4f6883688e837f50f4", "message": "Don't synthesize dependencies for any setup or help task", "committedDate": "2020-06-03T00:54:11Z", "type": "forcePushed"}]}