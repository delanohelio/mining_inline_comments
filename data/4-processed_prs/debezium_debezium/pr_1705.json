{"pr_number": 1705, "pr_title": "DBZ-2362 add configurable restart wait time and connection retries", "pr_createdAt": "2020-07-16T15:39:31Z", "pr_url": "https://github.com/debezium/debezium/pull/1705", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEzNjcxNw==", "url": "https://github.com/debezium/debezium/pull/1705#discussion_r462136717", "bodyText": "Is this one actually needed in the light of the general restartability of connectors?", "author": "gunnarmorling", "createdAt": "2020-07-29T08:41:25Z", "path": "debezium-core/src/main/java/io/debezium/jdbc/JdbcConnection.java", "diffHunk": "@@ -785,7 +787,36 @@ public synchronized Connection connection() throws SQLException {\n \n     public synchronized Connection connection(boolean executeOnConnect) throws SQLException {\n         if (!isConnected()) {\n-            conn = factory.connect(JdbcConfiguration.adapt(config));\n+\n+            int maxConnectionAttempts = config.getInteger(RelationalDatabaseConnectorConfig.CONNECTION_ATTEMPTS);\n+            int connectionRetryBackoff = config.getInteger(RelationalDatabaseConnectorConfig.CONNECTION_BACKOFF_MS);\n+            int attempts = 0;\n+            int count = 0;\n+            while (attempts < maxConnectionAttempts) {\n+                try {\n+                    count++;\n+                    LOGGER.info(\"Attempting to open connection #{} to {}\", count, config.getString(JdbcConfiguration.HOSTNAME));\n+                    conn = factory.connect(JdbcConfiguration.adapt(config));\n+                    break;\n+                }\n+                catch (SQLException sqle) {\n+                    attempts++;\n+                    if (attempts < maxConnectionAttempts) {\n+                        LOGGER.info(\"Unable to connect to database on attempt {}/{}. Will retry in {} ms.\", attempts,\n+                                maxConnectionAttempts, connectionRetryBackoff, sqle);\n+                        try {\n+                            Thread.sleep(connectionRetryBackoff);\n+                        }\n+                        catch (InterruptedException e) {\n+                            // this is ok because just woke up early\n+                        }\n+                    }\n+                    else {\n+                        throw sqle;\n+                    }\n+                }\n+            }", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM4NTQ2Mg==", "url": "https://github.com/debezium/debezium/pull/1705#discussion_r462385462", "bodyText": "This helps solve the scenario where I was failing over Aurora DB twice fast, such that the connector restart was happening during the second fail over and getting connection errors.  We could work around this by watching for the  failed task with a cronjob or something similar and restarting.", "author": "coryharperbind", "createdAt": "2020-07-29T15:24:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEzNjcxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUyNzEzOA==", "url": "https://github.com/debezium/debezium/pull/1705#discussion_r462527138", "bodyText": "I will remove the connection retry code for now.", "author": "coryharperbind", "createdAt": "2020-07-29T19:12:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEzNjcxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE0MDE3NA==", "url": "https://github.com/debezium/debezium/pull/1705#discussion_r462140174", "bodyText": "Should be java.time.Duration.", "author": "gunnarmorling", "createdAt": "2020-07-29T08:47:20Z", "path": "debezium-core/src/main/java/io/debezium/connector/common/BaseSourceTask.java", "diffHunk": "@@ -71,6 +72,8 @@\n      */\n     private volatile Map<String, ?> lastOffset;\n \n+    private int retriableRestartWait = 10;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUyNTY3Mw==", "url": "https://github.com/debezium/debezium/pull/1705#discussion_r462525673", "bodyText": "Will do.", "author": "coryharperbind", "createdAt": "2020-07-29T19:10:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE0MDE3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE0MDM3Nw==", "url": "https://github.com/debezium/debezium/pull/1705#discussion_r462140377", "bodyText": "Can you expose a dedicated accessor on CommonConnectorConfig, please?", "author": "gunnarmorling", "createdAt": "2020-07-29T08:47:40Z", "path": "debezium-core/src/main/java/io/debezium/connector/common/BaseSourceTask.java", "diffHunk": "@@ -87,6 +90,9 @@ public final void start(Map<String, String> props) {\n \n             this.props = props;\n             Configuration config = Configuration.from(props);\n+            retriableRestartWait = config.getInteger(CommonConnectorConfig.RETRIABLE_RESTART_WAIT);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUyNjM1MQ==", "url": "https://github.com/debezium/debezium/pull/1705#discussion_r462526351", "bodyText": "Yep, I'll add an accessor, but it will not be accessible here. Since we don't have an instance of CommonConnectorConfig.", "author": "coryharperbind", "createdAt": "2020-07-29T19:11:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE0MDM3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE0MTU2OQ==", "url": "https://github.com/debezium/debezium/pull/1705#discussion_r462141569", "bodyText": "Could you change sec to ms, please? It's the general pattern used for all duration-typed options. This also should be added to CONFIG_DEFINITION.", "author": "gunnarmorling", "createdAt": "2020-07-29T08:49:42Z", "path": "debezium-core/src/main/java/io/debezium/config/CommonConnectorConfig.java", "diffHunk": "@@ -238,6 +238,17 @@ public static BinaryHandlingMode parse(String value, String defaultValue) {\n     public static final long DEFAULT_POLL_INTERVAL_MILLIS = 500;\n     public static final String DATABASE_CONFIG_PREFIX = \"database.\";\n     private static final String CONVERTER_TYPE_SUFFIX = \".type\";\n+    public static final int DEFAULT_RETRIABLE_RESTART_WAIT = 10;\n+\n+    public static final Field RETRIABLE_RESTART_WAIT = Field.create(\"retriable.restart.connector.wait.sec\")", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUyNjUzNA==", "url": "https://github.com/debezium/debezium/pull/1705#discussion_r462526534", "bodyText": "Yep.", "author": "coryharperbind", "createdAt": "2020-07-29T19:11:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE0MTU2OQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "a722cd1432285b578f0ae73085bfe998e103f2dc", "url": "https://github.com/debezium/debezium/commit/a722cd1432285b578f0ae73085bfe998e103f2dc", "message": "DBZ-2362 add configurable restart wait time", "committedDate": "2020-07-30T15:06:50Z", "type": "commit"}, {"oid": "a722cd1432285b578f0ae73085bfe998e103f2dc", "url": "https://github.com/debezium/debezium/commit/a722cd1432285b578f0ae73085bfe998e103f2dc", "message": "DBZ-2362 add configurable restart wait time", "committedDate": "2020-07-30T15:06:50Z", "type": "forcePushed"}]}