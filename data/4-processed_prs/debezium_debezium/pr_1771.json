{"pr_number": 1771, "pr_title": "DBZ-2396 ByteBufferConverter support converter delegation for unsupported values", "pr_createdAt": "2020-08-31T14:37:25Z", "pr_url": "https://github.com/debezium/debezium/pull/1771", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDc2NDk5NA==", "url": "https://github.com/debezium/debezium/pull/1771#discussion_r480764994", "bodyText": "@Naros I wonder if we should use nested conditions. Would not it be better to introduce new method on SMT manager like isDataChangeMessage? It might make sense in case of other heartbeat sensitive SMTs.", "author": "jpechane", "createdAt": "2020-09-01T04:16:17Z", "path": "debezium-core/src/main/java/io/debezium/transforms/outbox/EventRouter.java", "diffHunk": "@@ -81,6 +81,9 @@ public R apply(R r) {\n         // Ignoring messages which do not adhere to the CDC Envelope, for instance:\n         // Heartbeat and Schema Change messages\n         if (!smtManager.isValidEnvelope(r)) {\n+            if (smtManager.isHeartbeat(r)) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk2MDk4MQ==", "url": "https://github.com/debezium/debezium/pull/1771#discussion_r480960981", "bodyText": "+1, I like that idea.", "author": "gunnarmorling", "createdAt": "2020-09-01T08:23:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDc2NDk5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk1ODgxNA==", "url": "https://github.com/debezium/debezium/pull/1771#discussion_r480958814", "bodyText": "Why is it that heartbeats are skipped? They should be passed on unmodified (i.e. as it was before), as otherwise people would e.g. run into WAL growth issues.", "author": "gunnarmorling", "createdAt": "2020-09-01T08:20:24Z", "path": "debezium-core/src/main/java/io/debezium/transforms/outbox/EventRouter.java", "diffHunk": "@@ -81,6 +81,9 @@ public R apply(R r) {\n         // Ignoring messages which do not adhere to the CDC Envelope, for instance:\n         // Heartbeat and Schema Change messages\n         if (!smtManager.isValidEnvelope(r)) {\n+            if (smtManager.isHeartbeat(r)) {\n+                return null;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM1MTc2OQ==", "url": "https://github.com/debezium/debezium/pull/1771#discussion_r481351769", "bodyText": "Perhaps I misunderstood the issue?  The reporter was using ByteBufferConverter and this was throwing an error when Kafka was applying the converter to the Heartbeat messages after the transformation by the Outbox.  By returning null from the SMT, this would have prevented the converter from being invoked and avoided the failure.  If that's not the right approach, what should I have done instead?  Should the ByteBufferConverter instead have detected the incoming message was a heartbeat and skipped the validation & returned null for the byte[]?", "author": "Naros", "createdAt": "2020-09-01T18:38:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk1ODgxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTgwMTQ2NA==", "url": "https://github.com/debezium/debezium/pull/1771#discussion_r481801464", "bodyText": "You're right, there's more to it than I first thought.\nWe cannot simply filter out any messages, though. While it might be ok-ish for heartbeats, it'd be unexpected e.g. for TX metadata events or schema change events. Instead, we'll likely have to follow a similar approach as we do for the CloudEvents converter: let it delegate to another converter (JSON, Avro). Specifically, if the ByteBufferConverter encounters something other than BYTES, it should delegate conversion of that record to the configured delegate converter. Then, heartbeats (and any other non-CDC events) can be passed on by the outbox routing SMT unmodified. Would that make sense?", "author": "gunnarmorling", "createdAt": "2020-09-02T06:52:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk1ODgxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI2MDAxMA==", "url": "https://github.com/debezium/debezium/pull/1771#discussion_r482260010", "bodyText": "It does, thanks for the clarification.", "author": "Naros", "createdAt": "2020-09-02T17:56:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk1ODgxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk2MTIyMw==", "url": "https://github.com/debezium/debezium/pull/1771#discussion_r480961223", "bodyText": "See above; I don't think this behavioral change should be done.", "author": "gunnarmorling", "createdAt": "2020-09-01T08:24:16Z", "path": "debezium-core/src/test/java/io/debezium/transforms/outbox/EventRouterTest.java", "diffHunk": "@@ -172,7 +172,7 @@ public void canSkipMessagesWithoutDebeziumCdcEnvelopeDueToMissingSchemaNameSuffi\n \n         final SourceRecord eventRouted = router.apply(eventRecord);\n \n-        assertThat(eventRouted).isSameAs(eventRecord);\n+        assertThat(eventRouted).isNull();", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "42729b0ec19dc067e015955556d294b066a55980", "url": "https://github.com/debezium/debezium/commit/42729b0ec19dc067e015955556d294b066a55980", "message": "DBZ-2396 Support Converter delegation in ByteBufferConverter\n\nIn the even that the value supplied to the ByteBufferConverter\nis not supported, e.g. not BYTES, the converter should then\nsupport delegation to a configured converter.", "committedDate": "2020-09-23T14:29:33Z", "type": "commit"}, {"oid": "42729b0ec19dc067e015955556d294b066a55980", "url": "https://github.com/debezium/debezium/commit/42729b0ec19dc067e015955556d294b066a55980", "message": "DBZ-2396 Support Converter delegation in ByteBufferConverter\n\nIn the even that the value supplied to the ByteBufferConverter\nis not supported, e.g. not BYTES, the converter should then\nsupport delegation to a configured converter.", "committedDate": "2020-09-23T14:29:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY4Mzk2OQ==", "url": "https://github.com/debezium/debezium/pull/1771#discussion_r493683969", "bodyText": "Could you add a test for specifying an option, e.g. include.schema set to false for the JSON converter?", "author": "gunnarmorling", "createdAt": "2020-09-23T15:25:01Z", "path": "debezium-core/src/test/java/io/debezium/converters/ByteBufferConverterTest.java", "diffHunk": "@@ -97,4 +101,35 @@ public void shouldConvertToConnectDataForNullValue() {\n         assertThat(schemaAndValue.schema()).isEqualTo(Schema.OPTIONAL_BYTES_SCHEMA);\n         assertThat(schemaAndValue.value()).isNull();\n     }\n+\n+    @Test\n+    public void shouldThrowWhenNoDelegateConverterConfigured() {\n+        try {\n+            converter.fromConnectData(TOPIC, Schema.OPTIONAL_STRING_SCHEMA, \"Hello World\");\n+            fail(\"now expected exception thrown\");\n+        }\n+        catch (Exception e) {\n+            assertThat(e).isExactlyInstanceOf(DataException.class);\n+        }\n+    }\n+\n+    @Test\n+    public void shouldConvertUsingDelegateConverter() {", "originalCommit": "42729b0ec19dc067e015955556d294b066a55980", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY4NDcyNw==", "url": "https://github.com/debezium/debezium/pull/1771#discussion_r493684727", "bodyText": "It's not only about heartbeats, but also TX metadata and schema change history (for those connectors supporting it).\nDocs should also mention how the delegate converter is configured (see my comment on testing above).", "author": "gunnarmorling", "createdAt": "2020-09-23T15:26:00Z", "path": "documentation/modules/ROOT/pages/configuration/outbox-event-router.adoc", "diffHunk": "@@ -205,6 +205,12 @@ transforms.outbox.type=io.debezium.transforms.outbox.EventRouter\n value.converter=io.debezium.converters.ByteBufferConverter\n ----\n \n+[WARNING]\n+====\n+If the connector is configured to emit heartbeat events, an additional configuration option `value.converter.delegate.converter.type` will be required.", "originalCommit": "42729b0ec19dc067e015955556d294b066a55980", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1dbbc348fe10a20f2f507aad192bcc47e4e4e98d", "url": "https://github.com/debezium/debezium/commit/1dbbc348fe10a20f2f507aad192bcc47e4e4e98d", "message": "DBZ-2396 Suggested changes", "committedDate": "2020-09-23T20:25:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA1MDUzNQ==", "url": "https://github.com/debezium/debezium/pull/1771#discussion_r494050535", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The {prodname} connector may be configured to emit heartbeat, transaction metadata, or schena change events (support varies by connector).\n          \n          \n            \n            The {prodname} connectors may be configured to emit heartbeat, transaction metadata, or schema change events (support varies by connector).", "author": "gunnarmorling", "createdAt": "2020-09-24T05:40:13Z", "path": "documentation/modules/ROOT/pages/configuration/outbox-event-router.adoc", "diffHunk": "@@ -208,6 +208,22 @@ value.converter=io.debezium.converters.ByteBufferConverter\n By default, the `payload` column value (the Avro data) is the only message value.\n Configuration of `ByteBufferConverter` as the value converter propagates the `payload` column value as-is into the Kafka message value.\n \n+The {prodname} connector may be configured to emit heartbeat, transaction metadata, or schena change events (support varies by connector).", "originalCommit": "1dbbc348fe10a20f2f507aad192bcc47e4e4e98d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA1MDY4MA==", "url": "https://github.com/debezium/debezium/pull/1771#discussion_r494050680", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            If any extra configuration options are needed by the converter, they can also be specified, such as the disablement of schemas show above using `schemas.enable=false`.\n          \n          \n            \n            If any extra configuration options are needed by the converter, they can also be specified, such as the disablement of schemas shown above using `schemas.enable=false`.", "author": "gunnarmorling", "createdAt": "2020-09-24T05:40:39Z", "path": "documentation/modules/ROOT/pages/configuration/outbox-event-router.adoc", "diffHunk": "@@ -208,6 +208,22 @@ value.converter=io.debezium.converters.ByteBufferConverter\n By default, the `payload` column value (the Avro data) is the only message value.\n Configuration of `ByteBufferConverter` as the value converter propagates the `payload` column value as-is into the Kafka message value.\n \n+The {prodname} connector may be configured to emit heartbeat, transaction metadata, or schena change events (support varies by connector).\n+These events cannot be serialized by the `ByteBufferConverter` so additional configuration must be provided so the converter knows how to serialize these events.\n+As an example, the following configuration illustrates using the Apache Kafka `JsonConverter` with no schemas:\n+\n+[source]\n+----\n+transforms=outbox,...\n+transforms.outbox.type=io.debezium.transforms.outbox.EventRouter\n+value.converter=io.debezium.converters.ByteBufferConverter\n+value.converter.delegate.converter.type=org.apache.kafka.connect.json.JsonConverter\n+value.converter.delegate.converter.type.schemas.enable=false\n+----\n+\n+The delegate `Converter` implementation is specified by the `delegate.converter.type` option.\n+If any extra configuration options are needed by the converter, they can also be specified, such as the disablement of schemas show above using `schemas.enable=false`.", "originalCommit": "1dbbc348fe10a20f2f507aad192bcc47e4e4e98d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d5d5b76ede9626abca1c0b57c0153034811e855d", "url": "https://github.com/debezium/debezium/commit/d5d5b76ede9626abca1c0b57c0153034811e855d", "message": "DBZ-2396 Typo fixes", "committedDate": "2020-09-24T05:41:20Z", "type": "commit"}]}