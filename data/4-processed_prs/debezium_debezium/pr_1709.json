{"pr_number": 1709, "pr_title": "DBZ-137 contribution to the core, Oracle related", "pr_createdAt": "2020-07-22T18:38:03Z", "pr_url": "https://github.com/debezium/debezium/pull/1709", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwNDYyMg==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r459004622", "bodyText": "We should probably consider extracting incremental.fetch.size up and using this across multiple connectors?", "author": "Naros", "createdAt": "2020-07-22T18:40:47Z", "path": "debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java", "diffHunk": "@@ -181,6 +195,10 @@ public void getChangesForTables(SqlServerChangeTable[] changeTables, Lsn interva\n             final Lsn fromLsn = getFromLsn(changeTable, intervalFromLsn);\n             LOGGER.trace(\"Getting changes for table {} in range[{}, {}]\", changeTable, fromLsn, intervalToLsn);\n             preparers[idx] = statement -> {\n+                String fetchSizeStr = config().asProperties().getProperty(\"incremental.fetch.size\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg3ODQ5MA==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r459878490", "bodyText": "What is its meaning? In any case it should be a Field, be documented etc., both when being specific to SQL Server or being more general.", "author": "gunnarmorling", "createdAt": "2020-07-24T06:46:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwNDYyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU1Nzc0Mg==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r462557742", "bodyText": "While conducting performance tests on SQL server connector, we realized it's going with default JDBC ResultSet fetch size for incremental reading but we should give option to user configurable.  Parameterized the fetch size, thought of keeping generic but there is already snapshot.fetch.size Field exists hence introduced new Field", "author": "mallikankati", "createdAt": "2020-07-29T20:08:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwNDYyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYxMDQ3OA==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r476610478", "bodyText": "I have moved this to a field specific to SQL Server called streaming.fetch.size to be consistent with snapshot.fetch.size.  We can look at moving this to common connector configurations in https://issues.redhat.com/browse/DBZ-2448.", "author": "Naros", "createdAt": "2020-08-25T17:18:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwNDYyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzc2MTcwNA==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r487761704", "bodyText": "Thanks!", "author": "gunnarmorling", "createdAt": "2020-09-14T09:05:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwNDYyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwNTEwNg==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r459005106", "bodyText": "I'm not sure I necessarily agree with this configuration option.  What do others think?", "author": "Naros", "createdAt": "2020-07-22T18:41:38Z", "path": "debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnectorConfig.java", "diffHunk": "@@ -313,6 +313,16 @@ public static SnapshotIsolationMode parse(String value, String defaultValue) {\n                     + \"In '\" + SnapshotIsolationMode.READ_UNCOMMITTED.getValue()\n                     + \"' mode neither table nor row-level locks are acquired, but connector does not guarantee snapshot consistency.\");\n \n+    public static final Field SNAPSHOT_SKIP_LOCKS = Field.create(\"snapshot.skip.locks\")", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg4MDYzMg==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r459880632", "bodyText": "Yeah, seems like a great way to shoot into your own's foot. Also in other connectors we have \"snapshot lock modes\" instead of a plain boolean. So this would be good to compare and align with how things are handled there.", "author": "gunnarmorling", "createdAt": "2020-07-24T06:53:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwNTEwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU1OTAyMQ==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r462559021", "bodyText": "But I how can we take metadata locks on production DB. If table has 5M records and it will take it's own sweet time to snapshot but real TX failed because we are taking locks on it.  We introduced this as a configurable parameter", "author": "mallikankati", "createdAt": "2020-07-29T20:10:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwNTEwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYxMzE2NA==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r476613164", "bodyText": "@mallikankati I believe what Gunnar is asking is that we align this with the already existing SnapshotIsolationMode used by SQL Server now.  In fact, SqlServerSnapshotChangeEventSource#lockTablesForSchemaSnapshot already applies the appropriate isolation so I think this option can be completely removed.", "author": "Naros", "createdAt": "2020-08-25T17:22:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwNTEwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYyNTgwNg==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r476625806", "bodyText": "That make sense", "author": "mallikankati", "createdAt": "2020-08-25T17:39:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwNTEwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg3OTA3Mg==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r459879072", "bodyText": "Yes, please :)", "author": "gunnarmorling", "createdAt": "2020-07-24T06:48:47Z", "path": "pom.xml", "diffHunk": "@@ -74,7 +74,8 @@\n         <version.mongo.server>3.6</version.mongo.server>\n         <version.mongo.driver>3.12.3</version.mongo.driver>\n         <version.sqlserver.driver>7.2.2.jre8</version.sqlserver.driver>\n-\n+        <!-- todo: DBZ-137 this should likely be moved to incubator repository? -->", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYyNDI3OA==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r476624278", "bodyText": "Moved", "author": "Naros", "createdAt": "2020-08-25T17:37:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg3OTA3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg3OTMyNg==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r459879326", "bodyText": "Should be Duration, here and elsewhere.", "author": "gunnarmorling", "createdAt": "2020-07-24T06:49:33Z", "path": "debezium-core/src/main/java/io/debezium/jdbc/JdbcConfiguration.java", "diffHunk": "@@ -321,4 +372,31 @@ default String getUser() {\n     default String getPassword() {\n         return getString(PASSWORD);\n     }\n+\n+    /**\n+     * Get the datasource factory property from the configuration.\n+     *\n+     * @return the specified value, or null if there is none.\n+     */\n+    default String getConnectionFactoryClassName() {\n+        return getString(CONNECTION_FACTORY_CLASS);\n+    }\n+\n+    /**\n+     * Get the connection timeout from the configuration.\n+     *\n+     * @return the specified value, or null if there is none.\n+     */\n+    default int getConnectionTimeoutMs() {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg3OTUyMw==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r459879523", "bodyText": "What is \"instance\"?", "author": "gunnarmorling", "createdAt": "2020-07-24T06:50:07Z", "path": "debezium-core/src/main/java/io/debezium/jdbc/JdbcConfiguration.java", "diffHunk": "@@ -44,6 +46,11 @@\n      */\n     public static final Field HOSTNAME = Field.create(\"hostname\", \"IP address of the database\");\n \n+    /**\n+     * A field for the instance name if any. This field has no default value.\n+     */\n+    public static final Field INSTANCE = Field.create(\"instance\", \"Instance name\").withValidation(Field::isOptional);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU2MzQ2OA==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r462563468", "bodyText": "In SQL server JDBC URL looks like this jdbc:sqlserver://dbhostname:port/instanceName=<it's instance of DB>;databaseName=\nHere are the more details on SQL server instance name\nhttps://qualysguard.qualys.com/qwebhelp/fo_portal/authentication/ms_sql/ms_sql_server_instance_name.htm#:~:text=This%20is%20the%20instance%20name,MS%20SQL%20Server%20instance%20name.&text=Go%20to%20Start%20%3E%20Programs%20%3E%20Microsoft,(circled%20below%20in%20red).", "author": "mallikankati", "createdAt": "2020-07-29T20:19:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg3OTUyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU1NjQ2NA==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r485556464", "bodyText": "Ok; should this not rather go into the SQL Server specific sub-class?", "author": "gunnarmorling", "createdAt": "2020-09-09T12:01:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg3OTUyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg4MDE2NQ==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r459880165", "bodyText": "There is https://issues.redhat.com/browse/DBZ-2283 for this very nice improvement. It should be applied at the level of RelationalSnapshotChangeEventSource. Could you extract this one into its own PR, attributed to this issue? There should also be a test, at least for one of the RDBMS connectors.", "author": "gunnarmorling", "createdAt": "2020-07-24T06:52:11Z", "path": "debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerSnapshotChangeEventSource.java", "diffHunk": "@@ -219,9 +223,43 @@ protected void complete(SnapshotContext snapshotContext) {\n      */\n     @Override\n     protected Optional<String> getSnapshotSelect(SnapshotContext snapshotContext, TableId tableId) {\n+        String modifiedColumns = checkBlacklistedColumns(tableId);\n+        if (modifiedColumns != null) {\n+            return Optional.of(String.format(\"SELECT %s FROM [%s].[%s]\", modifiedColumns, tableId.schema(), tableId.table()));\n+        }\n         return Optional.of(String.format(\"SELECT * FROM [%s].[%s]\", tableId.schema(), tableId.table()));\n     }\n \n+    @Override\n+    protected String enhanceOverriddenSelect(SnapshotContext snapshotContext, String overriddenSelect, TableId tableId) {\n+        String modifiedColumns = checkBlacklistedColumns(tableId);\n+        if (modifiedColumns != null) {\n+            overriddenSelect = overriddenSelect.replaceAll(\"\\\\*\", modifiedColumns);\n+        }\n+        return overriddenSelect;\n+    }\n+\n+    private String checkBlacklistedColumns(TableId tableId) {\n+        String modifiedColumns = null;\n+        String blackListColumnStr = connectorConfig.getConfig().getString(connectorConfig.COLUMN_BLACKLIST);\n+        if (blackListColumnStr != null && blackListColumnStr.trim().length() > 0\n+                && blackListColumnStr.contains(tableId.table())) {\n+            Table table = sqlServerDatabaseSchema.tableFor(tableId);\n+            modifiedColumns = table.retrieveColumnNames().stream()\n+                    .map(s -> {\n+                        StringBuilder sb = new StringBuilder();\n+                        if (!s.contains(tableId.table())) {\n+                            sb.append(tableId.table()).append(\".\").append(s);\n+                        }\n+                        else {\n+                            sb.append(s);\n+                        }\n+                        return sb.toString();\n+                    }).collect(Collectors.joining(\",\"));\n+        }\n+        return modifiedColumns;\n+    }", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg4MTM3Mg==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r459881372", "bodyText": "Interesting, where/how is that used? The name of the interface to be implemented should be specified in the description.", "author": "gunnarmorling", "createdAt": "2020-07-24T06:56:00Z", "path": "debezium-core/src/main/java/io/debezium/jdbc/JdbcConfiguration.java", "diffHunk": "@@ -55,11 +62,25 @@\n      */\n     public static final Field ON_CONNECT_STATEMENTS = Field.create(\"initial.statements\", \"A semicolon separated list of statements to be executed on connection\");\n \n+    /**\n+     * An optional field for datasource factory class that will be used to build the datasource connection pool.\n+     */\n+    public static final Field CONNECTION_FACTORY_CLASS = Field.create(\"connection.factory.class\")", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU2ODU1NA==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r462568554", "bodyText": "We introduced how to plugin your own ConnnectorFactory class when you have different PooledDataSources. Ex: We introduced a HikariDataSource pool.\nIf user specify any connection.factory.class it will honor it otherwise it will use default JdbConnection.ConnectionFactory.\nExample implementation of ConnectionFactory\npublic class HikariConnectionFactory implements JdbcConnection.ConnectionFactory {\n\n/**\n     * Create connection pool if not yet done and return a connection from pool\n     * @param inConfig jdbc configuration\n     * @return connection object from pool\n     * @throws SQLException if any sql exception\n     */\n    @Override\n    public Connection connect(JdbcConfiguration inConfig) throws SQLException {\n\n        String vendor = inConfig.asProperties().getProperty(\"vendor\");\n        if (_dataSource == null) {\n            String url;\n            Properties props = inConfig.asProperties();\n            HikariConfig hikariConfig = new HikariConfig();\n            if (\"oracle\".equalsIgnoreCase(vendor)) {\n                url = findAndReplace(ORACLE_URL_PATTERN, props);\n                hikariConfig.setConnectionTestQuery(\"select 1 from dual\");\n            } else {\n                if (inConfig.getInstance() != null &&\n                        inConfig.getInstance().trim().length() > 0){\n                    url = findAndReplace(SQLSERVER_INSTANCE_URL_PATTERN, props);\n                } else {\n                    url = findAndReplace(SQLSERVER_URL_PATTERN, props);\n                }\n            }\n            LOGGER.info(\"jdbc connection url:\" + url);\n            hikariConfig.setJdbcUrl(url);\n            hikariConfig.setUsername(inConfig.getUser());\n            hikariConfig.setPassword(inConfig.getPassword());\n            String maxPoolStr = inConfig.asProperties().getProperty(\"connection.max.poolsize\");\n            hikariConfig.setMaximumPoolSize(Integer.parseInt(maxPoolStr));\n            hikariConfig.setConnectionTimeout(inConfig.getConnectionTimeoutMs());\n            hikariConfig.setAutoCommit(false);\n            hikariConfig.setPoolName(\"Debezium Hikari CP\");\n            hikariConfig.setRegisterMbeans(true);\n            hikariConfig.addDataSourceProperty(\"cachePrepStmts\",  true);\n            hikariConfig.addDataSourceProperty(\"prepStmtCacheSize\", 5);\n            hikariConfig.addDataSourceProperty(\"prepStmtCacheSqlLimit\", 50);\n            hikariConfig.addDataSourceProperty(\"useServerPrepStmts\", true);\n            _dataSource = new HikariDataSource(hikariConfig);\n        }\n        return _dataSource.getConnection();\n    }\n}", "author": "mallikankati", "createdAt": "2020-07-29T20:28:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg4MTM3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg4MTgzNQ==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r459881835", "bodyText": "Why \"close\"?", "author": "gunnarmorling", "createdAt": "2020-07-24T06:57:30Z", "path": "debezium-core/src/main/java/io/debezium/jdbc/JdbcConnection.java", "diffHunk": "@@ -360,14 +409,45 @@ public JdbcConnection execute(String... sqlStatements) throws SQLException {\n      * @throws SQLException if there is an error connecting to the database or executing the statements\n      */\n     public JdbcConnection execute(Operations operations) throws SQLException {\n+        return closeOnExecute((conn) -> {\n+            try (Statement statement = conn.createStatement();) {\n+                operations.apply(statement);\n+                if (!conn.getAutoCommit()) {\n+                    conn.commit();\n+                }\n+            }\n+        });\n+    }\n+\n+    private JdbcConnection closeOnExecute(IExecutable executable) throws SQLException {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYyMDM4NQ==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r462620385", "bodyText": "When you have ConnectionPool, after using connection we need to close it otherwise how do you return connection to pool.\nThis will not really close the connection underneath instead it will return to pool and reuse it for next requests.", "author": "mallikankati", "createdAt": "2020-07-29T22:13:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg4MTgzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg4MjA4NQ==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r459882085", "bodyText": "I don't quite understand the motivation for this one?", "author": "gunnarmorling", "createdAt": "2020-07-24T06:58:14Z", "path": "debezium-core/src/main/java/io/debezium/jdbc/JdbcConnection.java", "diffHunk": "@@ -438,17 +518,18 @@ public JdbcConnection query(String query, ResultSetConsumer resultConsumer) thro\n      * @throws SQLException if anything unexpected fails\n      */\n     public JdbcConnection call(String sql, CallPreparer callPreparer, ResultSetConsumer resultSetConsumer) throws SQLException {\n-        Connection conn = connection();\n-        try (CallableStatement callableStatement = conn.prepareCall(sql)) {\n-            if (callPreparer != null) {\n-                callPreparer.accept(callableStatement);\n-            }\n-            try (ResultSet rs = callableStatement.executeQuery()) {\n-                if (resultSetConsumer != null) {\n-                    resultSetConsumer.accept(rs);\n+        closeOnExecute((conn) -> {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE0NzQ4Mw==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r460147483", "bodyText": "I noticed quite a few of these in the code changes and neither did I.  @AndreyIg can you or perhaps Mallik shed some insight on the reasoning behind these?", "author": "Naros", "createdAt": "2020-07-24T16:05:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg4MjA4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYyMTEzMA==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r462621130", "bodyText": "Please look at my previous comments", "author": "mallikankati", "createdAt": "2020-07-29T22:15:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg4MjA4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg4MjYyNw==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r459882627", "bodyText": "This looks suspicious. We must not mix up ts_ms and source.ts_ms.", "author": "gunnarmorling", "createdAt": "2020-07-24T06:59:36Z", "path": "debezium-core/src/main/java/io/debezium/relational/RelationalChangeRecordEmitter.java", "diffHunk": "@@ -134,7 +139,8 @@ protected void emitDeleteRecord(Receiver receiver, TableSchema tableSchema) thro\n             return;\n         }\n \n-        Struct envelope = tableSchema.getEnvelopeSchema().delete(oldValue, getOffset().getSourceInfo(), getClock().currentTimeAsInstant());\n+        Instant instant = getInstantFrom(getOffset());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE0ODQ4MA==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r460148480", "bodyText": "I'm not entirely sure the relational behind this change either, @AndreyIg can you or Mallik share your reasonings?", "author": "Naros", "createdAt": "2020-07-24T16:07:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg4MjYyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYyNjY4Mw==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r462626683", "bodyText": "This could be suspicious but I couldn't find the place where to add real CDC event time. There are three time measures in SQL server world\n\nRecord created in DB (which will go part of source record payload and need not worried about it)\nWhat time it arrived to CDC  tables (few millis off from real source record created time)\nWhen connector read this event (when connector retrieved this event to process. Usually always System.currentTimeMillis())\n\nBut I want to measure second one meaning when connector is down for 30min and restarted, we can get 1 & 3 but not 2. I realized instead of System.currentTimeMillis() better to measure based on CDC created time.", "author": "mallikankati", "createdAt": "2020-07-29T22:29:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg4MjYyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU3NjQyNQ==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r485576425", "bodyText": "Ok, I see. As you say:\n\nis the top-level ts_ms in change events. That why that change above should be reverted.\nis source.ts_ms\n\nThere could be a new field for 2. under source for SQL Server? How can that info be obtained, though?", "author": "gunnarmorling", "createdAt": "2020-09-09T12:37:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg4MjYyNw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU1MjM5Mg==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r485552392", "bodyText": "Can we extract this into an instance field populated in the constructor? Seems a bit wasteful to do this upon every invocation.", "author": "gunnarmorling", "createdAt": "2020-09-09T11:56:27Z", "path": "debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java", "diffHunk": "@@ -185,6 +198,10 @@ public void getChangesForTables(SqlServerChangeTable[] changeTables, Lsn interva\n             final Lsn fromLsn = getFromLsn(changeTable, intervalFromLsn);\n             LOGGER.trace(\"Getting changes for table {} in range[{}, {}]\", changeTable, fromLsn, intervalToLsn);\n             preparers[idx] = statement -> {\n+                String fetchSizeStr = config().asProperties().getProperty(SqlServerConnectorConfig.STREAMING_FETCH_SIZE.name());", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU1Mzc1OA==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r485553758", "bodyText": "There's a dedicated Jira issue for this nice optimization; can you reference it in the commit message and put it into the 1.3-next bucket?", "author": "gunnarmorling", "createdAt": "2020-09-09T11:58:36Z", "path": "debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerSnapshotChangeEventSource.java", "diffHunk": "@@ -218,10 +221,52 @@ protected void complete(SnapshotContext snapshotContext) {\n      * @return a valid query string\n      */\n     @Override\n-    protected Optional<String> getSnapshotSelect(SnapshotContext snapshotContext, TableId tableId) {\n+    protected Optional<String> getSnapshotSelect(RelationalSnapshotContext snapshotContext, TableId tableId) {\n+        String modifiedColumns = checkExcludedColumns(tableId);\n+        if (modifiedColumns != null) {\n+            return Optional.of(String.format(\"SELECT %s FROM [%s].[%s]\", modifiedColumns, tableId.schema(), tableId.table()));\n+        }\n         return Optional.of(String.format(\"SELECT * FROM [%s].[%s]\", tableId.schema(), tableId.table()));\n     }\n \n+    @Override\n+    protected String enhanceOverriddenSelect(RelationalSnapshotContext snapshotContext, String overriddenSelect, TableId tableId) {\n+        String modifiedColumns = checkExcludedColumns(tableId);\n+        if (modifiedColumns != null) {\n+            overriddenSelect = overriddenSelect.replaceAll(\"\\\\*\", modifiedColumns);\n+        }\n+        return overriddenSelect;\n+    }\n+\n+    private String checkExcludedColumns(TableId tableId) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU1NDM0Mw==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r485554343", "bodyText": "This should be exposed via TableFilters preferably. If that's to much of a stretch for now, let's at least add a dedicated getter on SqlServerConnectorConfig.", "author": "gunnarmorling", "createdAt": "2020-09-09T11:59:18Z", "path": "debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerSnapshotChangeEventSource.java", "diffHunk": "@@ -218,10 +221,52 @@ protected void complete(SnapshotContext snapshotContext) {\n      * @return a valid query string\n      */\n     @Override\n-    protected Optional<String> getSnapshotSelect(SnapshotContext snapshotContext, TableId tableId) {\n+    protected Optional<String> getSnapshotSelect(RelationalSnapshotContext snapshotContext, TableId tableId) {\n+        String modifiedColumns = checkExcludedColumns(tableId);\n+        if (modifiedColumns != null) {\n+            return Optional.of(String.format(\"SELECT %s FROM [%s].[%s]\", modifiedColumns, tableId.schema(), tableId.table()));\n+        }\n         return Optional.of(String.format(\"SELECT * FROM [%s].[%s]\", tableId.schema(), tableId.table()));\n     }\n \n+    @Override\n+    protected String enhanceOverriddenSelect(RelationalSnapshotContext snapshotContext, String overriddenSelect, TableId tableId) {\n+        String modifiedColumns = checkExcludedColumns(tableId);\n+        if (modifiedColumns != null) {\n+            overriddenSelect = overriddenSelect.replaceAll(\"\\\\*\", modifiedColumns);\n+        }\n+        return overriddenSelect;\n+    }\n+\n+    private String checkExcludedColumns(TableId tableId) {\n+        String modifiedColumns = null;\n+        String excludedColumnStr = getExcludedColumnStr();\n+        if (Objects.nonNull(excludedColumnStr)\n+                && excludedColumnStr.trim().length() > 0\n+                && excludedColumnStr.contains(tableId.table())) {\n+            Table table = sqlServerDatabaseSchema.tableFor(tableId);\n+            modifiedColumns = table.retrieveColumnNames().stream()\n+                    .map(s -> {\n+                        StringBuilder sb = new StringBuilder();\n+                        if (!s.contains(tableId.table())) {\n+                            sb.append(tableId.table()).append(\".\").append(s);\n+                        }\n+                        else {\n+                            sb.append(s);\n+                        }\n+                        return sb.toString();\n+                    }).collect(Collectors.joining(\",\"));\n+        }\n+        return modifiedColumns;\n+    }\n+\n+    private String getExcludedColumnStr() {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU3MjQwMw==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r485572403", "bodyText": "withConnectionFactoryClass?", "author": "gunnarmorling", "createdAt": "2020-09-09T12:30:44Z", "path": "debezium-core/src/main/java/io/debezium/jdbc/JdbcConfiguration.java", "diffHunk": "@@ -145,6 +177,26 @@ default Builder withDatabase(String databaseName) {\n         default Builder withPort(int port) {\n             return with(PORT, port);\n         }\n+\n+        /**\n+         * Use the given datasource factory class in the resulting configuration.\n+         *\n+         * @param datasourceFactoryClassName the datasource factory class name\n+         * @return this builder object so methods can be chained together; never null\n+         */\n+        default Builder withDatasourceClass(String datasourceFactoryClassName) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU3MjU2NA==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r485572564", "bodyText": "Ms can be removed here.", "author": "gunnarmorling", "createdAt": "2020-09-09T12:31:02Z", "path": "debezium-core/src/main/java/io/debezium/jdbc/JdbcConfiguration.java", "diffHunk": "@@ -321,4 +373,31 @@ default String getUser() {\n     default String getPassword() {\n         return getString(PASSWORD);\n     }\n+\n+    /**\n+     * Get the datasource factory property from the configuration.\n+     *\n+     * @return the specified value, or null if there is none.\n+     */\n+    default String getConnectionFactoryClassName() {\n+        return getString(CONNECTION_FACTORY_CLASS);\n+    }\n+\n+    /**\n+     * Get the connection timeout from the configuration.\n+     *\n+     * @return the specified value, or null if there is none.\n+     */\n+    default Duration getConnectionTimeoutMs() {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU3MjYyOA==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r485572628", "bodyText": "Should go to SQL Server.", "author": "gunnarmorling", "createdAt": "2020-09-09T12:31:09Z", "path": "debezium-core/src/main/java/io/debezium/jdbc/JdbcConfiguration.java", "diffHunk": "@@ -321,4 +373,31 @@ default String getUser() {\n     default String getPassword() {\n         return getString(PASSWORD);\n     }\n+\n+    /**\n+     * Get the datasource factory property from the configuration.\n+     *\n+     * @return the specified value, or null if there is none.\n+     */\n+    default String getConnectionFactoryClassName() {\n+        return getString(CONNECTION_FACTORY_CLASS);\n+    }\n+\n+    /**\n+     * Get the connection timeout from the configuration.\n+     *\n+     * @return the specified value, or null if there is none.\n+     */\n+    default Duration getConnectionTimeoutMs() {\n+        return Duration.ofMillis(getInteger(CONNECTION_TIMEOUT_MS));\n+    }\n+\n+    /**\n+     * Get the instance from the configuration.\n+     *\n+     * @return the specified value, or null if there is none.\n+     */\n+    default String getInstance() {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU3Mjk1NQ==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r485572955", "bodyText": "Fields can be made final?", "author": "gunnarmorling", "createdAt": "2020-09-09T12:31:37Z", "path": "debezium-core/src/main/java/io/debezium/jdbc/JdbcConnection.java", "diffHunk": "@@ -90,6 +91,29 @@ public void onEntryChosenForEviction(PreparedStatement statement) {\n         Connection connect(JdbcConfiguration config) throws SQLException;\n     }\n \n+    private class ConnectionFactoryDecorator implements ConnectionFactory {\n+        private ConnectionFactory defaultConnectionFactory;", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU3NDk2MQ==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r485574961", "bodyText": "That seems not right? The envelope ts_ms is the time of processing in Debezium, not the time of the change in the soure database.", "author": "gunnarmorling", "createdAt": "2020-09-09T12:34:58Z", "path": "debezium-core/src/main/java/io/debezium/relational/RelationalChangeRecordEmitter.java", "diffHunk": "@@ -64,7 +66,8 @@ protected void emitCreateRecord(Receiver receiver, TableSchema tableSchema)\n         Object[] newColumnValues = getNewColumnValues();\n         Object newKey = tableSchema.keyFromColumnData(newColumnValues);\n         Struct newValue = tableSchema.valueFromColumnData(newColumnValues);\n-        Struct envelope = tableSchema.getEnvelopeSchema().create(newValue, getOffset().getSourceInfo(), getClock().currentTimeAsInstant());\n+        Instant instant = getInstantFrom(getOffset());", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTYwODEzNg==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r485608136", "bodyText": "I also think this could be what is causing the problems with the PostgreSQL connector.  There is one test in particular that seems to hang indefinitely on Travis CI.  I'm going to revert this locally & check if that fixes PostgreSQL.", "author": "Naros", "createdAt": "2020-09-09T13:24:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU3NDk2MQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "12fcb7e3fe4d801112235d9cc2bcaf6339a90a91", "url": "https://github.com/debezium/debezium/commit/12fcb7e3fe4d801112235d9cc2bcaf6339a90a91", "message": "DBZ-137 contribution to the core, Oracle related", "committedDate": "2020-09-10T18:29:26Z", "type": "commit"}, {"oid": "e87cee130fe2e632ab511ed0aaacb5c064643ee2", "url": "https://github.com/debezium/debezium/commit/e87cee130fe2e632ab511ed0aaacb5c064643ee2", "message": "DBZ-137 Fix rebase", "committedDate": "2020-09-10T18:29:26Z", "type": "commit"}, {"oid": "ce62c7417db2c240b382f7301c294139e79b31a1", "url": "https://github.com/debezium/debezium/commit/ce62c7417db2c240b382f7301c294139e79b31a1", "message": "DBZ-137 Introduce streaming.fetch.size for SQL Server.", "committedDate": "2020-09-10T18:29:27Z", "type": "commit"}, {"oid": "9017d8b28304c8f211a5c44ba238706c071db5e0", "url": "https://github.com/debezium/debezium/commit/9017d8b28304c8f211a5c44ba238706c071db5e0", "message": "DBZ-137 Remove snapshot.skip.locks for SQL Server", "committedDate": "2020-09-10T18:29:27Z", "type": "commit"}, {"oid": "d59ebacc51e9b03e15dfdfe43ffa56875b70c0d7", "url": "https://github.com/debezium/debezium/commit/d59ebacc51e9b03e15dfdfe43ffa56875b70c0d7", "message": "DBZ-137 Removed POM property version.oracle.driver", "committedDate": "2020-09-10T18:29:27Z", "type": "commit"}, {"oid": "faa083d3b1985fe574950f1796e79d44c159710c", "url": "https://github.com/debezium/debezium/commit/faa083d3b1985fe574950f1796e79d44c159710c", "message": "DBZ-137 Use Duration for CONNECTION_TIMEOUT_MS", "committedDate": "2020-09-10T18:29:27Z", "type": "commit"}, {"oid": "5f61d32e19324f4ee38ac8efbbd0c6583cc3df0e", "url": "https://github.com/debezium/debezium/commit/5f61d32e19324f4ee38ac8efbbd0c6583cc3df0e", "message": "DBZ-137 Fix compilation problems", "committedDate": "2020-09-10T18:29:27Z", "type": "commit"}, {"oid": "5ea5de8a264abe805af112787a984deba297b6f4", "url": "https://github.com/debezium/debezium/commit/5ea5de8a264abe805af112787a984deba297b6f4", "message": "DBZ-137 Fix SQL Server test failures", "committedDate": "2020-09-10T18:29:27Z", "type": "commit"}, {"oid": "ff90eb0f84233135add6bf5fb33cef5e90aa7b0e", "url": "https://github.com/debezium/debezium/commit/ff90eb0f84233135add6bf5fb33cef5e90aa7b0e", "message": "DBZ-137 Reimagine stream.fetch.size as query.fetch.size", "committedDate": "2020-09-10T18:29:27Z", "type": "commit"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "38436f5dc35465f002f95206ede6d74674955ce9", "url": "https://github.com/debezium/debezium/commit/38436f5dc35465f002f95206ede6d74674955ce9", "message": "DBZ-137 Suggested changes", "committedDate": "2020-09-11T20:03:36Z", "type": "commit"}, {"oid": "30479d0d497543e96164e8915edd30ff8ef81e14", "url": "https://github.com/debezium/debezium/commit/30479d0d497543e96164e8915edd30ff8ef81e14", "message": "DBZ-137 DBZ-2283 Exclude filtered columns in SQL Server snapshot", "committedDate": "2020-09-11T20:03:40Z", "type": "commit"}, {"oid": "929349ea46d44e4d04549288b5625883982ae695", "url": "https://github.com/debezium/debezium/commit/929349ea46d44e4d04549288b5625883982ae695", "message": "DBZ-137 Documentation update", "committedDate": "2020-09-11T20:03:40Z", "type": "commit"}, {"oid": "929349ea46d44e4d04549288b5625883982ae695", "url": "https://github.com/debezium/debezium/commit/929349ea46d44e4d04549288b5625883982ae695", "message": "DBZ-137 Documentation update", "committedDate": "2020-09-11T20:03:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzc2NDc3OQ==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r487764779", "bodyText": "I'm still struggling with this; where is this used? Only in your custom connection factory, @mallikankati?", "author": "gunnarmorling", "createdAt": "2020-09-14T09:10:55Z", "path": "debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnectorConfig.java", "diffHunk": "@@ -391,6 +401,10 @@ public String getDatabaseName() {\n         return databaseName;\n     }\n \n+    public String getInstanceName() {", "originalCommit": "929349ea46d44e4d04549288b5625883982ae695", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzc4ODI5MA==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r487788290", "bodyText": "Ok, I think it's a bit unfortunate that this was done only for SQL Server. I've logged https://issues.redhat.com/browse/DBZ-2525 for pulling this up so that all relational connectors benefit from this.", "author": "gunnarmorling", "createdAt": "2020-09-14T09:50:41Z", "path": "debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerSnapshotChangeEventSource.java", "diffHunk": "@@ -218,10 +221,45 @@ protected void complete(SnapshotContext snapshotContext) {\n      * @return a valid query string\n      */\n     @Override\n-    protected Optional<String> getSnapshotSelect(SnapshotContext snapshotContext, TableId tableId) {\n+    protected Optional<String> getSnapshotSelect(RelationalSnapshotContext snapshotContext, TableId tableId) {\n+        String modifiedColumns = checkExcludedColumns(tableId);", "originalCommit": "929349ea46d44e4d04549288b5625883982ae695", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzc5ODA4Mw==", "url": "https://github.com/debezium/debezium/pull/1709#discussion_r487798083", "bodyText": "I don't understand how this method is supposed to work. The excluded columns are not removed from the statement anywhere. Also note that the exclusion expression doesn't necessarily contain the table name (e.g. could be .*mycolumn). This entire method seems flawed to me.\nThat said, it doesn't seem to to harm either, so I'll for now simply move https://issues.redhat.com/browse/DBZ-2283 onwards to the next iteration.", "author": "gunnarmorling", "createdAt": "2020-09-14T10:06:56Z", "path": "debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerSnapshotChangeEventSource.java", "diffHunk": "@@ -218,10 +221,45 @@ protected void complete(SnapshotContext snapshotContext) {\n      * @return a valid query string\n      */\n     @Override\n-    protected Optional<String> getSnapshotSelect(SnapshotContext snapshotContext, TableId tableId) {\n+    protected Optional<String> getSnapshotSelect(RelationalSnapshotContext snapshotContext, TableId tableId) {\n+        String modifiedColumns = checkExcludedColumns(tableId);\n+        if (modifiedColumns != null) {\n+            return Optional.of(String.format(\"SELECT %s FROM [%s].[%s]\", modifiedColumns, tableId.schema(), tableId.table()));\n+        }\n         return Optional.of(String.format(\"SELECT * FROM [%s].[%s]\", tableId.schema(), tableId.table()));\n     }\n \n+    @Override\n+    protected String enhanceOverriddenSelect(RelationalSnapshotContext snapshotContext, String overriddenSelect, TableId tableId) {\n+        String modifiedColumns = checkExcludedColumns(tableId);\n+        if (modifiedColumns != null) {\n+            overriddenSelect = overriddenSelect.replaceAll(\"\\\\*\", modifiedColumns);\n+        }\n+        return overriddenSelect;\n+    }\n+\n+    private String checkExcludedColumns(TableId tableId) {\n+        String modifiedColumns = null;\n+        String excludedColumnStr = connectorConfig.getTableFilters().getExcludeColumns();", "originalCommit": "929349ea46d44e4d04549288b5625883982ae695", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "53b88e6f47189a69d385aac42ced4455ce573fc7", "url": "https://github.com/debezium/debezium/commit/53b88e6f47189a69d385aac42ced4455ce573fc7", "message": "DBZ-137 Docs update", "committedDate": "2020-09-14T10:28:50Z", "type": "commit"}, {"oid": "53b88e6f47189a69d385aac42ced4455ce573fc7", "url": "https://github.com/debezium/debezium/commit/53b88e6f47189a69d385aac42ced4455ce573fc7", "message": "DBZ-137 Docs update", "committedDate": "2020-09-14T10:28:50Z", "type": "forcePushed"}]}