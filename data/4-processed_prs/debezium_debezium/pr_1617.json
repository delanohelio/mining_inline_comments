{"pr_number": 1617, "pr_title": "DBZ-2216 Fix transaction-id resolution with MongoDB 4.2", "pr_createdAt": "2020-06-17T17:48:29Z", "pr_url": "https://github.com/debezium/debezium/pull/1617", "timeline": [{"oid": "d672dbb5048d8d6140f1e78c22d1df88768d13d6", "url": "https://github.com/debezium/debezium/commit/d672dbb5048d8d6140f1e78c22d1df88768d13d6", "message": "DBZ-2216 Add MongoDB 4.2 to CI", "committedDate": "2020-06-17T17:46:34Z", "type": "commit"}, {"oid": "4166e095567072dbe3758feaadd9e06ca518dbe6", "url": "https://github.com/debezium/debezium/commit/4166e095567072dbe3758feaadd9e06ca518dbe6", "message": "DBZ-2216 Fix transaction-id resolution with MongoDB 4.2", "committedDate": "2020-06-17T17:47:45Z", "type": "commit"}, {"oid": "0a2ea3ccf67cdf7f40a780adc197c06b08854933", "url": "https://github.com/debezium/debezium/commit/0a2ea3ccf67cdf7f40a780adc197c06b08854933", "message": "DBZ-2216 Fix backward compatibility failure with V1 source block", "committedDate": "2020-06-17T19:19:00Z", "type": "commit"}, {"oid": "68480c5d870ed476bd21430015ce4b18c326befe", "url": "https://github.com/debezium/debezium/commit/68480c5d870ed476bd21430015ce4b18c326befe", "message": "DBZ-2216 Fix transaction-id resolution logic", "committedDate": "2020-06-17T21:10:40Z", "type": "commit"}, {"oid": "41efc68a17e5f5affb24ed1ce08f1d67f2eb948b", "url": "https://github.com/debezium/debezium/commit/41efc68a17e5f5affb24ed1ce08f1d67f2eb948b", "message": "DBZ-2216 Formatting", "committedDate": "2020-06-18T04:27:42Z", "type": "commit"}, {"oid": "ca8c8ef2f4f897b9f1fbf83d8277c4357523fa2f", "url": "https://github.com/debezium/debezium/commit/ca8c8ef2f4f897b9f1fbf83d8277c4357523fa2f", "message": "DBZ-2216 Reducing log level to stay below on max output threshold on CI", "committedDate": "2020-06-18T08:25:39Z", "type": "commit"}, {"oid": "7afefa6fe6ba37cc7f5841bc535b24a1bb2916ab", "url": "https://github.com/debezium/debezium/commit/7afefa6fe6ba37cc7f5841bc535b24a1bb2916ab", "message": "DBZ-2216 Doc update", "committedDate": "2020-06-18T09:00:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA4MTYzNQ==", "url": "https://github.com/debezium/debezium/pull/1617#discussion_r442081635", "bodyText": "Above (in getTransactionId()) the new field takes precedence. IIUC, the fields are mutually exclusive, but let's align on one way or the other consistently.\nUpdate: Pushed a commit for this.", "author": "gunnarmorling", "createdAt": "2020-06-18T09:07:44Z", "path": "debezium-connector-mongodb/src/main/java/io/debezium/connector/mongodb/MongoDbStreamingChangeEventSource.java", "diffHunk": "@@ -402,6 +401,15 @@ protected MongoDbOffsetContext initializeOffsets(MongoDbConnectorConfig connecto\n         return new MongoDbOffsetContext(new SourceInfo(connectorConfig), new TransactionContext(), positions);\n     }\n \n+    private static String getTransactionId(Document event) {\n+        final Long operationId = event.getLong(SourceInfo.OPERATION_ID);", "originalCommit": "7afefa6fe6ba37cc7f5841bc535b24a1bb2916ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA4MjcwOA==", "url": "https://github.com/debezium/debezium/pull/1617#discussion_r442082708", "bodyText": "Btw. how does txNumber relate/compare to ord? It seems like it's kinda the same?", "author": "gunnarmorling", "createdAt": "2020-06-18T09:09:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA4MTYzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjI0MzM2OQ==", "url": "https://github.com/debezium/debezium/pull/1617#discussion_r442243369", "bodyText": "I would say that txnNumber more closely related to tord rather than ord because the former represents the position within a transaction in which the entry took place.", "author": "Naros", "createdAt": "2020-06-18T13:53:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA4MTYzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjI1ODcwMA==", "url": "https://github.com/debezium/debezium/pull/1617#discussion_r442258700", "bodyText": "@Naros, so what's the difference between ord and tord then? I didn't even know there'd be those two :)", "author": "gunnarmorling", "createdAt": "2020-06-18T14:14:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA4MTYzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA4MzE2OA==", "url": "https://github.com/debezium/debezium/pull/1617#discussion_r442083168", "bodyText": "Where is the \"session\" term coming from? Isn't this id unique on a global level?", "author": "gunnarmorling", "createdAt": "2020-06-18T09:10:11Z", "path": "debezium-connector-mongodb/src/main/java/io/debezium/connector/mongodb/MongoUtil.java", "diffHunk": "@@ -219,6 +220,21 @@ public static ServerAddress parseAddress(String addressStr) {\n         return null;\n     }\n \n+    /**\n+     * Helper function to extract the session transaction-id from an oplog event.", "originalCommit": "7afefa6fe6ba37cc7f5841bc535b24a1bb2916ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjI0ODQxMg==", "url": "https://github.com/debezium/debezium/pull/1617#discussion_r442248412", "bodyText": "The \"session\" term is what Mongo uses to refer to lsid, aka Logical Session ID.\nThis value is the same across all transactions and operations.  This is why the combination of both the lsid and the txnNumber are important because the txnNumber field merely starts at 1 and increments for every operation/transaction that happens.\nIf the client disconnects & re-connects, it gets a new lsid and txnNumber will start from 1 again and continue to increase per transaction scoped operation.", "author": "Naros", "createdAt": "2020-06-18T13:59:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA4MzE2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjI1OTY0OA==", "url": "https://github.com/debezium/debezium/pull/1617#discussion_r442259648", "bodyText": "What/who is the \"client\" in this context? It's not Debezium, right? I.e. if we crash and don't commit offsets and re-read specific log sections a second time, we'd see the same lsid and txnNumber as before, correct?", "author": "gunnarmorling", "createdAt": "2020-06-18T14:15:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA4MzE2OA=="}], "type": "inlineReview"}, {"oid": "f00e3b95ae86853dcc815fab78bbcecb849f785c", "url": "https://github.com/debezium/debezium/commit/f00e3b95ae86853dcc815fab78bbcecb849f785c", "message": "DBZ-2216 Use real txId in docs", "committedDate": "2020-06-18T15:15:11Z", "type": "commit"}, {"oid": "f00e3b95ae86853dcc815fab78bbcecb849f785c", "url": "https://github.com/debezium/debezium/commit/f00e3b95ae86853dcc815fab78bbcecb849f785c", "message": "DBZ-2216 Use real txId in docs", "committedDate": "2020-06-18T15:15:11Z", "type": "forcePushed"}]}