{"pr_number": 1843, "pr_title": "DBZ-2582 Updating LSN handling", "pr_createdAt": "2020-09-25T12:43:57Z", "pr_url": "https://github.com/debezium/debezium/pull/1843", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM3MzE1MA==", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r497373150", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        LOGGER.trace(\"Current maximum lsn is {}\", ret);\n          \n          \n            \n                        LOGGER.trace(\"Current maximum LSN is {}\", ret);", "author": "gunnarmorling", "createdAt": "2020-09-30T09:32:41Z", "path": "debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java", "diffHunk": "@@ -150,6 +151,26 @@ public Lsn getMaxLsn() throws SQLException {\n         }, \"Maximum LSN query must return exactly one value\"));\n     }\n \n+    public MaxLsnResult getMaxLsnResult(String alternativeMaxTransactionalQuery) throws SQLException {\n+        Lsn maxLsn = queryAndMap(GET_MAX_LSN, singleResultMapper(rs -> {\n+            final Lsn ret = Lsn.valueOf(rs.getBytes(1));\n+            LOGGER.trace(\"Current maximum lsn is {}\", ret);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM3MzI4OQ==", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r497373289", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        LOGGER.trace(\"Current maximum transactional lsn is {}\", ret);\n          \n          \n            \n                        LOGGER.trace(\"Current maximum transactional LSN is {}\", ret);", "author": "gunnarmorling", "createdAt": "2020-09-30T09:32:50Z", "path": "debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java", "diffHunk": "@@ -150,6 +151,26 @@ public Lsn getMaxLsn() throws SQLException {\n         }, \"Maximum LSN query must return exactly one value\"));\n     }\n \n+    public MaxLsnResult getMaxLsnResult(String alternativeMaxTransactionalQuery) throws SQLException {\n+        Lsn maxLsn = queryAndMap(GET_MAX_LSN, singleResultMapper(rs -> {\n+            final Lsn ret = Lsn.valueOf(rs.getBytes(1));\n+            LOGGER.trace(\"Current maximum lsn is {}\", ret);\n+            return ret;\n+        }, \"Maximum LSN query must return exactly one value\"));\n+\n+        if (StringUtils.isEmpty(alternativeMaxTransactionalQuery)) {\n+            // If not alternative query is provided, return the default for both.\n+            return new MaxLsnResult(maxLsn, maxLsn);\n+        }\n+\n+        // Else run the alternative query for getting the largest lsn related to a valid transaction.\n+        return new MaxLsnResult(maxLsn, queryAndMap(alternativeMaxTransactionalQuery, singleResultMapper(rs -> {\n+            final Lsn ret = Lsn.valueOf(rs.getBytes(1));\n+            LOGGER.trace(\"Current maximum transactional lsn is {}\", ret);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM4NDAwMw==", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r497384003", "bodyText": "Would be better to use prepared statements to avoid the repeated parsing (see preparedQueryAndMap()), for that one and similar queries (I suppose this started off not using PS once and then similar methods followed that precedence).", "author": "gunnarmorling", "createdAt": "2020-09-30T09:50:35Z", "path": "debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java", "diffHunk": "@@ -150,6 +151,26 @@ public Lsn getMaxLsn() throws SQLException {\n         }, \"Maximum LSN query must return exactly one value\"));\n     }\n \n+    public MaxLsnResult getMaxLsnResult(String alternativeMaxTransactionalQuery) throws SQLException {\n+        Lsn maxLsn = queryAndMap(GET_MAX_LSN, singleResultMapper(rs -> {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM5MDM0OQ==", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r497390349", "bodyText": "Btw. in the Jira statement you originally suggested a single statement to get both LSN values. Can we actually do this, avoiding one round-trip to the DB?", "author": "gunnarmorling", "createdAt": "2020-09-30T10:00:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM4NDAwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM5MTE3NQ==", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r497391175", "bodyText": "Also, should the existing getMaxLsn() method be removed, and all callers be updated to use this one?", "author": "gunnarmorling", "createdAt": "2020-09-30T10:02:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM4NDAwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ2ODYwOQ==", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r497468609", "bodyText": "I can update to the prepared query.\nI'm not sure how we want to handle these sql statements. @jpechane made a valuable suggestion in that we have this feature defaulted, but still removable incase there are issues with it, so I was trying to minimize changing from the current flow. I could update the code to be more of a split between the current way we handle the lsn and the new way and have the new way utilize the query that contains both lsns.\ngetMaxLsn() still has its uses as the stored procs require a valid lsn, which the max transactional way may not be valid after a long period of inactivity. The idea is that one lsn can be utilize for comparison, and the other should be utilized for any queries", "author": "jgormley6", "createdAt": "2020-09-30T12:28:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM4NDAwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM5MTkzMQ==", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r497391931", "bodyText": "Seems this would only be the case if someone set the statement explicitly to \"\"; is this what you're expecting here?", "author": "gunnarmorling", "createdAt": "2020-09-30T10:03:40Z", "path": "debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java", "diffHunk": "@@ -150,6 +151,26 @@ public Lsn getMaxLsn() throws SQLException {\n         }, \"Maximum LSN query must return exactly one value\"));\n     }\n \n+    public MaxLsnResult getMaxLsnResult(String alternativeMaxTransactionalQuery) throws SQLException {\n+        Lsn maxLsn = queryAndMap(GET_MAX_LSN, singleResultMapper(rs -> {\n+            final Lsn ret = Lsn.valueOf(rs.getBytes(1));\n+            LOGGER.trace(\"Current maximum lsn is {}\", ret);\n+            return ret;\n+        }, \"Maximum LSN query must return exactly one value\"));\n+\n+        if (StringUtils.isEmpty(alternativeMaxTransactionalQuery)) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ2MzA5NA==", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r497463094", "bodyText": "The original idea for the configuration was that if you put nothing, the current flow wouldn't change, but with this second go around where the query is defaulted, but still overridable, I'm not sure what exactly we want to do.\nMaybe we could make this as a sort of feature flag and just have a boolean for determining whether or not we utilize the new lsn handling?", "author": "jgormley6", "createdAt": "2020-09-30T12:18:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM5MTkzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ2OTE0Mw==", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r497469143", "bodyText": "I think the question is whether there's a realistic chance for other statements really being used. If not (which I think is the case tbh.) then yes hard-coding the statement and instead having a feature-toggle for enabling/disabling this optimization seems more reasonable. It could remain an internal (undocumented one) as is right now, defaulting to enable this. Then this could be used to disable the optimization should it prove troublesome in production.", "author": "gunnarmorling", "createdAt": "2020-09-30T12:29:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM5MTkzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM5MzYxOQ==", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r497393619", "bodyText": "Do we actually need to expose both values to calling code? Wouldn't it suffice to expose only the lower of the two?", "author": "gunnarmorling", "createdAt": "2020-09-30T10:06:26Z", "path": "debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/MaxLsnResult.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Copyright Debezium Authors.\n+ *\n+ * Licensed under the Apache Software License version 2.0, available at http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.debezium.connector.sqlserver;\n+\n+/**\n+ * Stores the result from querying the lsn_time_mapping for the highest LSNs.\n+ */\n+public class MaxLsnResult {\n+\n+    /**\n+     * The highest lsn regardless of configuration. This should be utilized when querying the CDC tables as using an LSN that is no longer valid can lead to errors.\n+     */\n+    private final Lsn maxLsn;\n+\n+    /**\n+     * The highest lsn belonging to a valid change transaction as determined by {@link SqlServerConnectorConfig#STREAMING_MAX_LSN_SELECT_STATEMENT} or default to the same as maxLsn.\n+     */\n+    private final Lsn maxTransactionalLsn;\n+\n+    public MaxLsnResult(Lsn maxLsn, Lsn maxTransactionalLsn) {\n+        this.maxLsn = maxLsn;\n+        this.maxTransactionalLsn = maxTransactionalLsn;\n+    }\n+\n+    public Lsn getMaxLsn() {\n+        return maxLsn;\n+    }\n+\n+    public Lsn getMaxTransactionalLsn() {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ2NDcyOA==", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r497464728", "bodyText": "We need both values because the stored proc later used to read the changes will fail if you give it an invalid lsn.\nWhen query the actual tables, we need to always give it the real maximum lsn (and not just the highest one related to changes) otherwise if a server is dormant for a while, you'll run into errors.\nI tried clarifying that through the comments, let me know what changes I can make to them as it's not an obvious thing and should be well documented in the code why.", "author": "jgormley6", "createdAt": "2020-09-30T12:21:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM5MzYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU2MjU1Nw==", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r497562557", "bodyText": "I think I got it overall, thanks for elaborating! One thing still unclear: when does an LSN become invalid exactly?", "author": "gunnarmorling", "createdAt": "2020-09-30T14:37:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM5MzYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzczNzc2Ng==", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r497737766", "bodyText": "From my understanding, LSNs are cleaned up and removed from the lsn_time_mapping table. It happens automatically, but I believe this stored procedure also could trigger it manually if you wanted to see an example\nhttps://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sys-sp-cdc-cleanup-change-table-transact-sql?view=sql-server-ver15", "author": "jgormley6", "createdAt": "2020-09-30T19:07:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzM5MzYxOQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "203e73ab61c4e6a879a20916262516ae589699e0", "url": "https://github.com/debezium/debezium/commit/203e73ab61c4e6a879a20916262516ae589699e0", "message": "DBZ-2582 Updating LSN handling", "committedDate": "2020-10-08T13:01:54Z", "type": "commit"}, {"oid": "6e55c5c016ec0b0beaf7f10225d9f15589b2bf4b", "url": "https://github.com/debezium/debezium/commit/6e55c5c016ec0b0beaf7f10225d9f15589b2bf4b", "message": "DBZ-2582-lsn-changes revert log change", "committedDate": "2020-10-08T13:01:54Z", "type": "commit"}, {"oid": "05497e16cd3c998a8a17b28f67f2d166f197e05a", "url": "https://github.com/debezium/debezium/commit/05497e16cd3c998a8a17b28f67f2d166f197e05a", "message": "DBZ-2582 Fixing tests and adding pause back", "committedDate": "2020-10-08T13:01:54Z", "type": "commit"}, {"oid": "410f2d74b3c4378b065d3ea9464577475de26bb8", "url": "https://github.com/debezium/debezium/commit/410f2d74b3c4378b065d3ea9464577475de26bb8", "message": "DBZ-2582 Adding copyright", "committedDate": "2020-10-08T13:01:54Z", "type": "commit"}, {"oid": "e0339efe1cf12536c545f04f9d9e6f7658c30739", "url": "https://github.com/debezium/debezium/commit/e0339efe1cf12536c545f04f9d9e6f7658c30739", "message": "DBZ-2582 Apply suggestions from code review\n\nCo-authored-by: Gunnar Morling <gunnar.morling@googlemail.com>", "committedDate": "2020-10-08T13:01:54Z", "type": "commit"}, {"oid": "714edc7b4a61340fd5f19ced8dec95c0de96a561", "url": "https://github.com/debezium/debezium/commit/714edc7b4a61340fd5f19ced8dec95c0de96a561", "message": "DBZ-2582 Updating configuration to be feature flag and using prepared statements", "committedDate": "2020-10-08T13:01:55Z", "type": "commit"}, {"oid": "fcd7c5bf5f18eee77511ec7742a37f7282881e7f", "url": "https://github.com/debezium/debezium/commit/fcd7c5bf5f18eee77511ec7742a37f7282881e7f", "message": "DBZ-2582 Updating test for consistency", "committedDate": "2020-10-08T13:01:55Z", "type": "commit"}, {"oid": "38e6cc678169daf3518e6ab2be8c4f275bde4ac2", "url": "https://github.com/debezium/debezium/commit/38e6cc678169daf3518e6ab2be8c4f275bde4ac2", "message": "DBZ-2582 Adding boolean check and removing TODO as no changes are necessary", "committedDate": "2020-10-08T13:01:55Z", "type": "commit"}, {"oid": "38e6cc678169daf3518e6ab2be8c4f275bde4ac2", "url": "https://github.com/debezium/debezium/commit/38e6cc678169daf3518e6ab2be8c4f275bde4ac2", "message": "DBZ-2582 Adding boolean check and removing TODO as no changes are necessary", "committedDate": "2020-10-08T13:01:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI0OTg5MA==", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r502249890", "bodyText": "Tiny nit: \"LSN\" -> \"Lsn\" (this isn't done consistently across the code base yet, but it's the casing we want to converge on eventually for abbreviations in type/method/variable names).", "author": "gunnarmorling", "createdAt": "2020-10-09T07:51:17Z", "path": "debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnectorConfig.java", "diffHunk": "@@ -442,6 +452,10 @@ public boolean isReadOnlyDatabaseConnection() {\n         return readOnlyDatabaseConnection;\n     }\n \n+    public boolean isSkipLowActivityLSNsEnabled() {", "originalCommit": "38e6cc678169daf3518e6ab2be8c4f275bde4ac2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI1MDEwOQ==", "url": "https://github.com/debezium/debezium/pull/1843#discussion_r502250109", "bodyText": "Same comment as below.", "author": "gunnarmorling", "createdAt": "2020-10-09T07:51:39Z", "path": "debezium-connector-sqlserver/src/main/java/io/debezium/connector/sqlserver/SqlServerConnection.java", "diffHunk": "@@ -153,6 +156,24 @@ public Lsn getMaxLsn() throws SQLException {\n         }, \"Maximum LSN query must return exactly one value\"));\n     }\n \n+    public MaxLsnResult getMaxLsnResult(boolean skipLowActivityLSNsEnabled) throws SQLException {\n+        if (skipLowActivityLSNsEnabled) {", "originalCommit": "38e6cc678169daf3518e6ab2be8c4f275bde4ac2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bd8db7979f407681554fcb71bc4fe659cf4da6ca", "url": "https://github.com/debezium/debezium/commit/bd8db7979f407681554fcb71bc4fe659cf4da6ca", "message": "DBZ-2582 Fixing LSN casing", "committedDate": "2020-10-09T18:55:32Z", "type": "commit"}]}