{"pr_number": 1930, "pr_title": "DBZ-2726 Clean MySQL TIMESTAMP default value", "pr_createdAt": "2020-11-05T13:54:37Z", "pr_url": "https://github.com/debezium/debezium/pull/1930", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU3OTEyNQ==", "url": "https://github.com/debezium/debezium/pull/1930#discussion_r519579125", "bodyText": "Could this part be consturcted with a single String.format for all compoents?", "author": "jpechane", "createdAt": "2020-11-09T06:39:04Z", "path": "debezium-connector-mysql/src/main/java/io/debezium/connector/mysql/MySqlDefaultValueConverter.java", "diffHunk": "@@ -259,6 +260,125 @@ private DateTimeFormatter timestampFormat(int length) {\n         return dtf.toFormatter();\n     }\n \n+    /**\n+     * Clean input timestamp to yyyy-mm-dd hh:mm:ss[.fffffffff] format\n+     *\n+     * @param s input timestamp\n+     * @return cleaned timestamp\n+     */\n+    private String cleanTimestamp(String s) {\n+        if (s == null) {\n+            throw new java.lang.IllegalArgumentException(\"null string\");\n+        }\n+\n+        s = s.trim();\n+\n+        final int MAX_MONTH = 12;\n+        final int MAX_DAY = 31;\n+\n+        // Parse the date\n+        int firstDash = s.indexOf('-');\n+        int secondDash = s.indexOf('-', firstDash + 1);\n+\n+        int dividingStart = -1;\n+        int dividingEnd = -1;\n+        boolean hasDividing = false;\n+        for (int i = secondDash + 1; i < s.length(); i++) {\n+            if (!Character.isDigit(s.charAt(i))) {\n+                dividingStart = i;\n+                hasDividing = true;\n+                break;\n+            }\n+        }\n+        if (hasDividing) {\n+            for (int i = dividingStart; i < s.length(); i++) {\n+                if (Character.isDigit(s.charAt(i))) {\n+                    break;\n+                }\n+                dividingEnd = i;\n+            }\n+        }\n+\n+        // Parse the time\n+        int firstColon = s.indexOf(':', dividingEnd + 1);\n+        int secondColon = s.indexOf(':', firstColon + 1);\n+        int period = s.indexOf('.', secondColon + 1);\n+\n+        int year = 0;\n+        int month = 0;\n+        int day = 0;\n+        int hour = 0;\n+        int minute = 0;\n+        int second = 0;\n+\n+        // Get the date\n+        int len = s.length();\n+        boolean parsedDate = false;\n+        if (firstDash > 0 && secondDash > firstDash) {\n+            year = Integer.parseInt(s.substring(0, firstDash));\n+            month = Integer.parseInt(s.substring(firstDash + 1, secondDash));\n+            if (hasDividing) {\n+                day = Integer.parseInt(s.substring(secondDash + 1, dividingStart));\n+            }\n+            else {\n+                day = Integer.parseInt(s.substring(secondDash + 1, len));\n+            }\n+\n+            if ((month >= 1 && month <= MAX_MONTH) && (day >= 1 && day <= MAX_DAY)) {\n+                parsedDate = true;\n+            }\n+        }\n+        if (!parsedDate) {\n+            throw new java.lang.IllegalArgumentException(\"Cannot parse the date from \" + s);\n+        }\n+\n+        // Get the time. Hour, minute, second and colons are all optional\n+        if (hasDividing && dividingEnd < len - 1) {\n+            if (firstColon == -1) {\n+                hour = Integer.parseInt(s.substring(dividingEnd + 1, len));\n+            }\n+            else {\n+                hour = Integer.parseInt(s.substring(dividingEnd + 1, firstColon));\n+                if (firstColon < len - 1) {\n+                    if (secondColon == -1) {\n+                        minute = Integer.parseInt(s.substring(firstColon + 1, len));\n+                    }\n+                    else {\n+                        minute = Integer.parseInt(s.substring(firstColon + 1, secondColon));\n+                        if (secondColon < len - 1) {\n+                            if (period == -1) {\n+                                second = Integer.parseInt(s.substring(secondColon + 1, len));\n+                            }\n+                            else {\n+                                second = Integer.parseInt(s.substring(secondColon + 1, period));\n+                            }\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+\n+        StringBuilder cleanedTimestamp = new StringBuilder();\n+        cleanedTimestamp = cleanedTimestamp", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY0NDk5Ng==", "url": "https://github.com/debezium/debezium/pull/1930#discussion_r519644996", "bodyText": "Absolutely! Addressed.", "author": "keweishang", "createdAt": "2020-11-09T08:57:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU3OTEyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU4NDU1Mw==", "url": "https://github.com/debezium/debezium/pull/1930#discussion_r519584553", "bodyText": "Is also acceptable case when there is the period but no following numbers?", "author": "jpechane", "createdAt": "2020-11-09T06:56:59Z", "path": "debezium-connector-mysql/src/test/java/io/debezium/connector/mysql/MySqlAntlrDdlParserTest.java", "diffHunk": "@@ -2542,6 +2544,87 @@ public void shouldNotNullPositionBeforeOrAfterDefaultValue() {\n         assertThat(table.columnWithName(\"ts_col5\").defaultValue()).isEqualTo(isoEpoch);\n     }\n \n+    @Test\n+    @FixFor(\"DBZ-2726\")\n+    public void shouldParseTimestampDefaultValue() {\n+        // All the following default values for TIMESTAMP can be successfully applied to MySQL\n+        String ddl = \"CREATE TABLE my_table (\" +\n+                \"ts_col01 TIMESTAMP DEFAULT '2020-01-02',\" +\n+                \"ts_col02 TIMESTAMP DEFAULT '2020-01-02 ',\" +\n+                \"ts_col03 TIMESTAMP DEFAULT '2020-01-02:',\" +\n+                \"ts_col04 TIMESTAMP DEFAULT '2020-01-02--',\" +\n+                \"ts_col05 TIMESTAMP DEFAULT '2020-01-02 03',\" +\n+                \"ts_col06 TIMESTAMP DEFAULT '2020-01-02 003',\" +\n+                \"ts_col07 TIMESTAMP DEFAULT '2020-01-02 03:',\" +\n+                \"ts_col08 TIMESTAMP DEFAULT '2020-01-02 03:04',\" +\n+                \"ts_col09 TIMESTAMP DEFAULT '2020-01-02 03:004',\" +\n+                \"ts_col10 TIMESTAMP DEFAULT '2020-01-02 03:04:05',\" +\n+                \"ts_col11 TIMESTAMP DEFAULT '2020-01-02 03:04:05.6',\" +", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY0MjY3NA==", "url": "https://github.com/debezium/debezium/pull/1930#discussion_r519642674", "bodyText": "It is an acceptable case both in MySQL and in Debezium when no numbers follow the period. I just added a test case for it.", "author": "keweishang", "createdAt": "2020-11-09T08:53:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU4NDU1Mw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "f9ca1031f14226998adfc9d9f557794a630dfc1f", "url": "https://github.com/debezium/debezium/commit/f9ca1031f14226998adfc9d9f557794a630dfc1f", "message": "DBZ-2726 Clean MySQL TIMESTAMP default value", "committedDate": "2020-11-09T08:57:20Z", "type": "commit"}, {"oid": "f9ca1031f14226998adfc9d9f557794a630dfc1f", "url": "https://github.com/debezium/debezium/commit/f9ca1031f14226998adfc9d9f557794a630dfc1f", "message": "DBZ-2726 Clean MySQL TIMESTAMP default value", "committedDate": "2020-11-09T08:57:20Z", "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "9dd4331356f1619fd4586eac78395247d46d5388", "url": "https://github.com/debezium/debezium/commit/9dd4331356f1619fd4586eac78395247d46d5388", "message": "DBZ-2726 extend data separator and time separator", "committedDate": "2020-11-09T16:47:32Z", "type": "commit"}, {"oid": "9dd4331356f1619fd4586eac78395247d46d5388", "url": "https://github.com/debezium/debezium/commit/9dd4331356f1619fd4586eac78395247d46d5388", "message": "DBZ-2726 extend data separator and time separator", "committedDate": "2020-11-09T16:47:32Z", "type": "forcePushed"}]}