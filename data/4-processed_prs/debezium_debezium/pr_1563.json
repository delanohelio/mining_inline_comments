{"pr_number": 1563, "pr_title": "DBZ-1989 Avoid returning distorted (Milli)SecondsBehindSource values", "pr_createdAt": "2020-06-05T09:05:57Z", "pr_url": "https://github.com/debezium/debezium/pull/1563", "timeline": [{"oid": "1ded00afce89cf1bed1b8d761c6449b706c26862", "url": "https://github.com/debezium/debezium/commit/1ded00afce89cf1bed1b8d761c6449b706c26862", "message": "DBZ-1989 Avoid returning distorted (Milli)SecondsBehindSource values in jmx mbean of same name", "committedDate": "2020-06-05T09:05:21Z", "type": "commit"}, {"oid": "bb6cceda49e50c2132f1fa7eb72e03eba4eb09d2", "url": "https://github.com/debezium/debezium/commit/bb6cceda49e50c2132f1fa7eb72e03eba4eb09d2", "message": "DBZ-1989 Get (Milli)SecondsBehindSource from event timestamp", "committedDate": "2020-06-09T11:22:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM0NjY4Mw==", "url": "https://github.com/debezium/debezium/pull/1563#discussion_r437346683", "bodyText": "It's not so unexpected then as per the comment above?", "author": "gunnarmorling", "createdAt": "2020-06-09T11:48:26Z", "path": "debezium-connector-mysql/src/main/java/io/debezium/connector/mysql/BinlogReader.java", "diffHunk": "@@ -494,6 +495,33 @@ protected void logEvent(Event event) {\n         logger.trace(\"Received event: {}\", event);\n     }\n \n+    protected void onEvent(Event event) {\n+        long ts = 0;\n+\n+        if (event.getHeader().getEventType() == EventType.HEARTBEAT) {\n+            // HEARTBEAT events have no timestamp but are fired only when\n+            // there is no traffic on the connection which means we are caught-up\n+            // https://dev.mysql.com/doc/internals/en/heartbeat-event.html\n+            metrics.setMilliSecondsBehindSource(ts);\n+            return;\n+        }\n+\n+        // MySQL has seconds resolution but mysql-binlog-connector-java returns\n+        // a value in milliseconds\n+        long eventTs = event.getHeader().getTimestamp();\n+\n+        if (eventTs == 0) {\n+            // A zero-valued timestamp can also happen if case of ROTATE events\n+            // in which case we keep the previous value\n+            logger.trace(\"Received unexpected event with 0 timestamp: {}\", event);", "originalCommit": "bb6cceda49e50c2132f1fa7eb72e03eba4eb09d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM1NDE3Mg==", "url": "https://github.com/debezium/debezium/pull/1563#discussion_r437354172", "bodyText": "Well yes but I don't understand why this happens. What I observed are two ROTATE events sequentially received with one of them with no timestamp (they are identical, this aside). And there are plenty of other events so maybe that's not the only case, maybe I should edit a bit the comment?", "author": "ebrard", "createdAt": "2020-06-09T12:02:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM0NjY4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQyODQ1OQ==", "url": "https://github.com/debezium/debezium/pull/1563#discussion_r437428459", "bodyText": "yes +1; the note to ROTATE is more confusing than anything else then, I think.", "author": "gunnarmorling", "createdAt": "2020-06-09T13:43:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM0NjY4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ0MTE2Ng==", "url": "https://github.com/debezium/debezium/pull/1563#discussion_r437441166", "bodyText": "alright, let me modify it a bit", "author": "ebrard", "createdAt": "2020-06-09T13:55:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM0NjY4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ0Mzc4Mw==", "url": "https://github.com/debezium/debezium/pull/1563#discussion_r437443783", "bodyText": "I removed it.", "author": "ebrard", "createdAt": "2020-06-09T13:58:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM0NjY4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ3Njk0Mw==", "url": "https://github.com/debezium/debezium/pull/1563#discussion_r437476943", "bodyText": "Thx!", "author": "gunnarmorling", "createdAt": "2020-06-09T14:41:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM0NjY4Mw=="}], "type": "inlineReview"}, {"oid": "065ddfaa90745203ba5a3678d0a7d81b9bc888fd", "url": "https://github.com/debezium/debezium/commit/065ddfaa90745203ba5a3678d0a7d81b9bc888fd", "message": "DBZ-1989 Get (Milli)SecondsBehindSource from event timestamp", "committedDate": "2020-06-09T13:57:40Z", "type": "commit"}]}