{"pr_number": 2024, "pr_title": "DBZ-2868 imprt TestDatabase as QuarkusTestResource for debezium-server IT tests", "pr_createdAt": "2020-12-20T16:18:20Z", "pr_url": "https://github.com/debezium/debezium/pull/2024", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU1MzM5MA==", "url": "https://github.com/debezium/debezium/pull/2024#discussion_r546553390", "bodyText": "Where is this used?", "author": "gunnarmorling", "createdAt": "2020-12-21T07:43:32Z", "path": "debezium-server/debezium-server-core/src/test/java/io/debezium/server/DebeziumServerIT.java", "diffHunk": "@@ -26,32 +26,22 @@\n  * @author Jiri Pechanec\n  */\n @QuarkusTest\n+@QuarkusTestResource(TestDatabase.class)\n public class DebeziumServerIT {\n \n     private static final int MESSAGE_COUNT = 4;\n-    protected static TestDatabase db = null;\n+    @Inject\n+    DebeziumServer server;", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY2Nzg5MA==", "url": "https://github.com/debezium/debezium/pull/2024#discussion_r546667890", "bodyText": "not 100% sure but, i believe this needed to start debezium-server and consume events, test that events are generated.\nused in line 56\n        final TestConsumer testConsumer = (TestConsumer) server.getConsumer();", "author": "ismailsimsek", "createdAt": "2020-12-21T12:00:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU1MzM5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU5MTM5Mg==", "url": "https://github.com/debezium/debezium/pull/2024#discussion_r546591392", "bodyText": "@gunnarmorling  Maybe we can move https://github.com/debezium/debezium-ui-poc/blob/master/backend/src/test/java/io/debezium/configserver/util/PostgresInfrastructureTestResourceLifecycleManager.java from the UI PoC to debezium-testing-testcontainers as \"PostgresTestResourceLifecycleManager\" instead? This is related to @ani-sha's current work, isn't it?", "author": "rk3rn3r", "createdAt": "2020-12-21T09:14:10Z", "path": "debezium-server/debezium-server-core/src/test/java/io/debezium/server/TestDatabase.java", "diffHunk": "@@ -6,16 +6,20 @@\n package io.debezium.server;\n \n import java.time.Duration;\n+import java.util.Collections;\n+import java.util.Map;\n \n import org.junit.jupiter.api.Assertions;\n import org.testcontainers.containers.FixedHostPortGenericContainer;\n import org.testcontainers.containers.GenericContainer;\n import org.testcontainers.containers.wait.strategy.Wait;\n \n+import io.quarkus.test.common.QuarkusTestResourceLifecycleManager;\n+\n /**\n  * @author Jiri Pechanec\n  */\n-public class TestDatabase {\n+public class TestDatabase implements QuarkusTestResourceLifecycleManager {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU5MTkyNg==", "url": "https://github.com/debezium/debezium/pull/2024#discussion_r546591926", "bodyText": "This should not be a fixed port. Instead use dynamic port assignment and configure quarkus like shown in the UI PoC implementation: https://github.com/debezium/debezium-ui-poc/blob/master/backend/src/test/java/io/debezium/configserver/util/PostgresInfrastructureTestResourceLifecycleManager.java#L16", "author": "rk3rn3r", "createdAt": "2020-12-21T09:15:12Z", "path": "debezium-server/debezium-server-core/src/test/java/io/debezium/server/TestDatabase.java", "diffHunk": "@@ -26,7 +30,7 @@\n \n     private GenericContainer container;\n \n-    public void start() {\n+    public Map<String, String> start() {\n         try {\n \n             container = new FixedHostPortGenericContainer(POSTGRES_IMAGE)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY3NzU4NA==", "url": "https://github.com/debezium/debezium/pull/2024#discussion_r546677584", "bodyText": "makes sense, also it seems like FixedHostPortGenericContainer deprecated. is it possible to pass the dynamic port to  ConfigSource before the server initializes?\nneed to check how to pas dynamic port to TestConfigSource.java and set property  'debezium.source.database.port'", "author": "ismailsimsek", "createdAt": "2020-12-21T12:24:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU5MTkyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzI5NTY4Mw==", "url": "https://github.com/debezium/debezium/pull/2024#discussion_r547295683", "bodyText": "Instead of FixedHostPortGenericContainer use org.testcontainers.containers.PostgreSQLContainer#PostgreSQLContainer. The default docker behavior is dynamic port mapping anyways, you don't have to do anything. See the linked code in PostgresInfrastructureTestResourceLifecycleManager on how to configure Quarkus with the dynamic port.", "author": "rk3rn3r", "createdAt": "2020-12-22T14:04:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU5MTkyNg=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "e23c7802e0998f277dc4dae368a3b0d5775e3514", "url": "https://github.com/debezium/debezium/commit/e23c7802e0998f277dc4dae368a3b0d5775e3514", "message": "DBZ-2868 change TestDatabase to QuarkusTestResource for debezium-server integration tests", "committedDate": "2021-01-08T12:26:25Z", "type": "commit"}, {"oid": "e23c7802e0998f277dc4dae368a3b0d5775e3514", "url": "https://github.com/debezium/debezium/commit/e23c7802e0998f277dc4dae368a3b0d5775e3514", "message": "DBZ-2868 change TestDatabase to QuarkusTestResource for debezium-server integration tests", "committedDate": "2021-01-08T12:26:25Z", "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "bf6a8c10e33a67049c27dba1ab1e4ee3dc72f20d", "url": "https://github.com/debezium/debezium/commit/bf6a8c10e33a67049c27dba1ab1e4ee3dc72f20d", "message": "DBZ-2868 move TestDatabase to debezium-testing-testcontainers project and rename to PostgresTestResourceLifecycleManager", "committedDate": "2021-01-08T19:07:05Z", "type": "commit"}, {"oid": "bf6a8c10e33a67049c27dba1ab1e4ee3dc72f20d", "url": "https://github.com/debezium/debezium/commit/bf6a8c10e33a67049c27dba1ab1e4ee3dc72f20d", "message": "DBZ-2868 move TestDatabase to debezium-testing-testcontainers project and rename to PostgresTestResourceLifecycleManager", "committedDate": "2021-01-08T19:07:05Z", "type": "forcePushed"}, {"oid": "8969b683e6b3fc5daa91b0ed25d5fc98a6887df7", "url": "https://github.com/debezium/debezium/commit/8969b683e6b3fc5daa91b0ed25d5fc98a6887df7", "message": "DBZ-2868 Removing superfluous property definitions", "committedDate": "2021-01-12T14:02:15Z", "type": "commit"}]}