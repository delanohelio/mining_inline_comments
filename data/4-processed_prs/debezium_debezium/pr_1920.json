{"pr_number": 1920, "pr_title": "DBZ-2699 implement skipped.operation in core", "pr_createdAt": "2020-10-29T13:25:48Z", "pr_url": "https://github.com/debezium/debezium/pull/1920", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE2ODM0Ng==", "url": "https://github.com/debezium/debezium/pull/1920#discussion_r539168346", "bodyText": "I added both dependencies as it looked like sometimes the package for debezium-assembly-descriptors was missing and the build terminated. And later it looked like a cached version of debezium-core (without the applied changes) was used and the changes were not active and tests were failing. I had no time to dig deeper into that but maybe @jpechane have a better idea. It might be maven cache / cache-key related.", "author": "rk3rn3r", "createdAt": "2020-12-09T09:59:52Z", "path": ".github/workflows/testing-workflow.yml", "diffHunk": "@@ -41,4 +41,4 @@ jobs:\n           restore-keys: |\n             ${{ runner.os }}-maven-\n       - name: Check changes in Debezium Testing\n-        run: mvn clean install -B -pl debezium-testing -am -amd -Passembly -Dcheckstyle.skip=true -Dformat.skip=true -Drevapi.skip -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn\n+        run: mvn clean install -B -pl debezium-assembly-descriptors,debezium-core,debezium-testing -am -amd -Passembly -Dcheckstyle.skip=true -Dformat.skip=true -Drevapi.skip -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMwMzU2Mw==", "url": "https://github.com/debezium/debezium/pull/1920#discussion_r539303563", "bodyText": "That was exactly the problem, it has not build/published the core module (and it is hard to guess why) and deps and either were taken from Internet or from cache with result that the code was not aligned.", "author": "jpechane", "createdAt": "2020-12-09T13:26:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE2ODM0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMyMjU2Ng==", "url": "https://github.com/debezium/debezium/pull/1920#discussion_r539322566", "bodyText": "Don't you think we need to change the cache key then in order to not fetch a cache that has assets for, for example,  debezium-core and use outdated code?\n(I don't think there are -SNAPSHOT packages on the Internet ;) )", "author": "rk3rn3r", "createdAt": "2020-12-09T13:52:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE2ODM0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMyNjIwNg==", "url": "https://github.com/debezium/debezium/pull/1920#discussion_r539326206", "bodyText": "Well, you are right, we can exclude io/debezium dir from caching. There was originally plan that there will be a single job that will build the artifacts and then the connector jobs will not do the build but testing but it seems such implementation is not necessary with selective connector building.", "author": "jpechane", "createdAt": "2020-12-09T13:56:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE2ODM0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ3MDk4Nw==", "url": "https://github.com/debezium/debezium/pull/1920#discussion_r545470987", "bodyText": "Guys, can you tell me what is the problem? :))", "author": "blcksrx", "createdAt": "2020-12-17T23:25:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE2ODM0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU5MDM1OA==", "url": "https://github.com/debezium/debezium/pull/1920#discussion_r545590358", "bodyText": "Sorry, the discussion is a litlle bit spread #2018 (comment) :-)", "author": "jpechane", "createdAt": "2020-12-18T06:00:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE2ODM0Ng=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjkyMTMyMQ==", "url": "https://github.com/debezium/debezium/pull/1920#discussion_r576921321", "bodyText": "Is something missing in this test?", "author": "rk3rn3r", "createdAt": "2021-02-16T15:41:13Z", "path": "debezium-connector-sqlserver/src/test/java/io/debezium/connector/sqlserver/SqlServerConnectorIT.java", "diffHunk": "@@ -2452,6 +2452,22 @@ public void testMaxLsnSelectStatementWithFalse() throws Exception {\n         stopConnector();\n     }\n \n+    @Test\n+    @FixFor(\"DBZ-2699\")\n+    public void shouldEmitNoEventsForSkippedUpdateAndDeleteOperations() throws Exception {\n+        final Configuration config = TestHelper.defaultConfig()\n+                .with(SqlServerConnectorConfig.SNAPSHOT_MODE, SnapshotMode.INITIAL)\n+                .with(SqlServerConnectorConfig.SKIPPED_OPERATIONS, \"u,d\")\n+                .build();\n+\n+        start(SqlServerConnector.class, config);\n+        assertConnectorIsRunning();\n+        // Wait for snapshot completion\n+        TestHelper.waitForSnapshotToBeCompleted();\n+        consumeRecordsByTopic(1);", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MTI2Nzc1MQ==", "url": "https://github.com/debezium/debezium/pull/1920#discussion_r591267751", "bodyText": "How is this test removal related?", "author": "rk3rn3r", "createdAt": "2021-03-10T09:30:11Z", "path": "debezium-connector-postgres/src/test/java/io/debezium/connector/postgresql/PostgresConnectorIT.java", "diffHunk": "@@ -2467,26 +2467,6 @@ public void shouldProduceMessagesOnlyForConfiguredTables() throws Exception {\n     }\n \n     @Test\n-    @FixFor(\"DBZ-2885\")\n-    @SkipWhenDecoderPluginNameIsNot(value = SkipWhenDecoderPluginNameIsNot.DecoderPluginName.PGOUTPUT, reason = \"Publication configuration only valid for PGOUTPUT decoder\")\n-    public void shouldThrowWhenTableFiltersIsEmpty() throws Exception {\n-        final LogInterceptor logInterceptor = new LogInterceptor();\n-\n-        TestHelper.dropAllSchemas();\n-        TestHelper.dropPublication(\"cdc\");\n-        TestHelper.executeDDL(\"postgres_create_tables.ddl\");\n-        TestHelper.execute(SETUP_TABLES_STMT);\n-\n-        Configuration.Builder configBuilder = TestHelper.defaultConfig()\n-                .with(PostgresConnectorConfig.PUBLICATION_NAME, \"cdc\")\n-                .with(PostgresConnectorConfig.PUBLICATION_AUTOCREATE_MODE, PostgresConnectorConfig.AutoCreateMode.FILTERED.getValue())\n-                .with(PostgresConnectorConfig.TABLE_INCLUDE_LIST, \"nonexistent.table\");\n-\n-        start(PostgresConnector.class, configBuilder.build());\n-        assertConnectorNotRunning();\n-        assertTrue(logInterceptor.containsStacktraceElement(\"No table filters found for filtered publication cdc\"));\n-    }\n-", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MTI3NDI2Mg==", "url": "https://github.com/debezium/debezium/pull/1920#discussion_r591274262", "bodyText": "I think it's related to some merge conflicts that I have. I will fix it.", "author": "blcksrx", "createdAt": "2021-03-10T09:36:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MTI2Nzc1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MTI3MjA2Nw==", "url": "https://github.com/debezium/debezium/pull/1920#discussion_r591272067", "bodyText": "Would it be possible to add a test (that then will be executed for all connectors \"auto-magically\") in debezium-core? No is a valid answer, but it would be nice if that would be somehow possible.\nI am not sure if it's possible to have a test case there or it always needs coupling to a connector implementation?", "author": "rk3rn3r", "createdAt": "2021-03-10T09:34:37Z", "path": "debezium-connector-sqlserver/src/test/java/io/debezium/connector/sqlserver/SqlServerConnectorIT.java", "diffHunk": "@@ -2452,6 +2452,42 @@ public void testMaxLsnSelectStatementWithFalse() throws Exception {\n         stopConnector();\n     }\n \n+    @Test\n+    @FixFor(\"DBZ-2699\")\n+    public void shouldEmitNoEventsForSkippedUpdateAndDeleteOperations() throws Exception {\n+        final Configuration config = TestHelper.defaultConfig()\n+                .with(SqlServerConnectorConfig.SNAPSHOT_MODE, SnapshotMode.INITIAL)\n+                .with(SqlServerConnectorConfig.SKIPPED_OPERATIONS, \"u,d\")\n+                .build();\n+\n+        start(SqlServerConnector.class, config);\n+        assertConnectorIsRunning();\n+        // Wait for snapshot completion\n+        TestHelper.waitForSnapshotToBeCompleted();\n+        consumeRecordsByTopic(1);\n+\n+        connection.execute(\"INSERT INTO tablea VALUES(201, 'insert201')\");\n+        connection.execute(\"UPDATE tablea SET cola='insert201-update' WHERE id=201\");\n+        connection.execute(\"INSERT INTO tablea VALUES(202, 'insert202')\");\n+        connection.execute(\"DELETE FROM tablea WHERE id=202\");\n+        connection.execute(\"INSERT INTO tablea VALUES(203, 'insert203')\");\n+\n+        final SourceRecords records = consumeRecordsByTopic(3);\n+        final List<SourceRecord> tableA = records.recordsForTopic(\"server1.dbo.tablea\");\n+        Assertions.assertThat(tableA).hasSize(3);\n+        tableA.forEach((SourceRecord record) -> {\n+            Struct value = (Struct) record.value();\n+            assertThat(value.get(\"op\")).isEqualTo(Envelope.Operation.CREATE.code());\n+            assertThat(value.get(\"op\")).isNotEqualTo(Envelope.Operation.UPDATE.code());\n+            assertThat(value.get(\"op\")).isNotEqualTo(Envelope.Operation.DELETE.code());\n+        });\n+\n+        assertInsert(tableA.get(0), \"id\", 201);\n+        assertInsert(tableA.get(1), \"id\", 202);\n+        assertInsert(tableA.get(2), \"id\", 203);\n+\n+    }", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MTI3NTI2NA==", "url": "https://github.com/debezium/debezium/pull/1920#discussion_r591275264", "bodyText": "I will think about it to find a proper way", "author": "blcksrx", "createdAt": "2021-03-10T09:37:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MTI3MjA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MTM0NjY3Mg==", "url": "https://github.com/debezium/debezium/pull/1920#discussion_r591346672", "bodyText": "Don't waste endless time on it. But at least unit test/s would be great. I don't know if it's possible to come up with a functional test here at all. But great you take this final challenge!", "author": "rk3rn3r", "createdAt": "2021-03-10T10:47:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MTI3MjA2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MTI4MzcyNQ==", "url": "https://github.com/debezium/debezium/pull/1920#discussion_r591283725", "bodyText": "@blcksrx Am I right you said we can solve filtering more performant with db internal tools for some databases (like SQL Server for example)?\n@jpechane you suggested a design that for such cases we can use the more performant solution of the datastore instead. what was your idea about we make this possible inside debezium? (like: how to deactivate this global behavior here in core in favor of the more performant implementation in a connector implementation?", "author": "rk3rn3r", "createdAt": "2021-03-10T09:45:40Z", "path": "debezium-core/src/main/java/io/debezium/pipeline/EventDispatcher.java", "diffHunk": "@@ -205,9 +208,11 @@ public void changeRecord(DataCollectionSchema schema,\n                                              OffsetContext offset,\n                                              ConnectHeaders headers)\n                             throws InterruptedException {\n-                        transactionMonitor.dataEvent(dataCollectionId, offset, key, value);\n-                        eventListener.onEvent(dataCollectionId, offset, key, value);\n-                        streamingReceiver.changeRecord(schema, operation, key, value, offset, headers);\n+                        if (!skippedOperations.contains(operation)) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MTMzNDA4NQ==", "url": "https://github.com/debezium/debezium/pull/1920#discussion_r591334085", "bodyText": "Yes, you are right @jpechane suggest first implement it on the core, so this feature will be available for all the connector. after that we can design it for each connector with a better performance.", "author": "blcksrx", "createdAt": "2021-03-10T10:34:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MTI4MzcyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MTM0NDc2Mg==", "url": "https://github.com/debezium/debezium/pull/1920#discussion_r591344762", "bodyText": "I see!\n@jpechane do we need to do anything in this PR to address that flexibility now or do we do this as bigger refactoring with the first connector specific implementation?", "author": "rk3rn3r", "createdAt": "2021-03-10T10:45:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MTI4MzcyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDc4NTM2OA==", "url": "https://github.com/debezium/debezium/pull/1920#discussion_r604785368", "bodyText": "@rk3rn3r Nothing specific needed right now. MySQL is already rewritten to use the new framework and IIRC the skipped ops are already implemente dthere so it might be a good starting point. @blcksrx Could you please raise a follow-up Jira for that?\n@blcksrx Also I've one more tip for micro-optimization.  There should be a boolean flag attribute neverSkip that is set at the start depending on whether the map is empty or not.\nThe condition would then look like\nif (neverSkip ||  !skippedOperations.contains(operation))\n\nThis would be more performant in case skipped ops are not set.", "author": "jpechane", "createdAt": "2021-03-31T10:36:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MTI4MzcyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNTUyNDkwMQ==", "url": "https://github.com/debezium/debezium/pull/1920#discussion_r605524901", "bodyText": "@jpechane thanks for answering. I will do the optimization tonight and about another issue, currently, the MongoDB connectors try to filter that on the OpLog side. I can create tickets for other connectors", "author": "blcksrx", "createdAt": "2021-04-01T09:51:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MTI4MzcyNQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "defde957ae8ff7da20e7b630936a013c05b72d0f", "url": "https://github.com/debezium/debezium/commit/defde957ae8ff7da20e7b630936a013c05b72d0f", "message": "DBZ-2699 implement skipped.operation in core", "committedDate": "2021-04-01T17:29:03Z", "type": "commit"}, {"oid": "defde957ae8ff7da20e7b630936a013c05b72d0f", "url": "https://github.com/debezium/debezium/commit/defde957ae8ff7da20e7b630936a013c05b72d0f", "message": "DBZ-2699 implement skipped.operation in core", "committedDate": "2021-04-01T17:29:03Z", "type": "forcePushed"}]}