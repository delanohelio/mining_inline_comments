{"pr_number": 1281, "pr_title": "DBZ-1824 Restart incomplete Tx for wal2json", "pr_createdAt": "2020-02-25T11:21:21Z", "pr_url": "https://github.com/debezium/debezium/pull/1281", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQzMDQ2NQ==", "url": "https://github.com/debezium/debezium/pull/1281#discussion_r384430465", "bodyText": "That sounds a bit concerning. Are you planning to follow up on this? Anything we should put into the docs?", "author": "gunnarmorling", "createdAt": "2020-02-26T11:19:59Z", "path": "debezium-connector-postgres/src/main/java/io/debezium/connector/postgresql/connection/PostgresReplicationConnection.java", "diffHunk": "@@ -402,6 +402,16 @@ public void read(ReplicationMessageProcessor processor) throws SQLException, Int\n             public boolean readPending(ReplicationMessageProcessor processor) throws SQLException, InterruptedException {\n                 ByteBuffer read = stream.readPending();\n                 final long lastReceiveLsn = stream.getLastReceiveLSN().asLong();\n+                // Conflict between DBZ-1824 and DBZ-800\n+                // PostgreSQL replication stream increases last received LSN even if no message arrives\n+                // Then if data message arrives it will have the same LSN as the updated one.\n+                // For wal2json it means that the transaction in progress will contain last_processed_lsn to the same value\n+                // as transaction LSN and upon restart the incomplete transaction will be skipped instead of being replayed\n+                // Also there is an open question whether this can lead to premature LSN flushing as if empty message and data", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU4OTkzOQ==", "url": "https://github.com/debezium/debezium/pull/1281#discussion_r387589939", "bodyText": "Can you add a comment why only on COMMIT it's skipped?", "author": "gunnarmorling", "createdAt": "2020-03-04T10:53:21Z", "path": "debezium-connector-postgres/src/main/java/io/debezium/connector/postgresql/PostgresStreamingChangeEventSource.java", "diffHunk": "@@ -129,7 +129,9 @@ public void execute(ChangeEventSourceContext context) throws InterruptedExceptio\n                     if (message.isTransactionalMessage() || message.getOperation() == Operation.NOOP) {\n                         if (!connectorConfig.shouldProvideTransactionMetadata()) {\n                             LOGGER.trace(\"Received transactional message {}\", message);\n-                            skipMessage(lsn);\n+                            if (message.getOperation() == Operation.COMMIT) {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "2d9cd7e50ee49cfc7b4f7730c51f4146d6b95cd5", "url": "https://github.com/debezium/debezium/commit/2d9cd7e50ee49cfc7b4f7730c51f4146d6b95cd5", "message": "DBZ-1824 Restart incomplete Tx for wal2json", "committedDate": "2020-03-04T12:30:01Z", "type": "commit"}, {"oid": "2d9cd7e50ee49cfc7b4f7730c51f4146d6b95cd5", "url": "https://github.com/debezium/debezium/commit/2d9cd7e50ee49cfc7b4f7730c51f4146d6b95cd5", "message": "DBZ-1824 Restart incomplete Tx for wal2json", "committedDate": "2020-03-04T12:30:01Z", "type": "forcePushed"}]}