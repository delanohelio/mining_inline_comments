{"pr_number": 1938, "pr_title": "DBZ-2580 Fix \"The primary key cannot reference a non-existant column\" error", "pr_createdAt": "2020-11-10T16:41:55Z", "pr_url": "https://github.com/debezium/debezium/pull/1938", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDcxNTM4Nw==", "url": "https://github.com/debezium/debezium/pull/1938#discussion_r520715387", "bodyText": "I decided to just log an error here. But maybe we can throw the previous IllegalArgumentException here. This should not happen from a proper captured DB schema, the reason can either be a bug in callers or a bug in the DDL parser logic. WDYT?", "author": "rk3rn3r", "createdAt": "2020-11-10T16:52:08Z", "path": "debezium-core/src/main/java/io/debezium/relational/TableEditorImpl.java", "diffHunk": "@@ -92,47 +96,30 @@ public TableEditor setColumns(Column... columns) {\n     public TableEditor setColumns(Iterable<Column> columns) {\n         sortedColumns.clear();\n         addColumns(columns);\n-        updatePrimaryKeys();\n         assert positionsAreValid();\n         return this;\n     }\n \n     protected void updatePrimaryKeys() {\n-        // table does not have any primary key, no need to update\n-        if (uniqueValues) {\n-            return;\n-        }\n-        Iterator<String> nameIter = this.pkColumnNames.iterator();\n-        while (nameIter.hasNext()) {\n-            String pkColumnName = nameIter.next();\n-            if (!hasColumnWithName(pkColumnName)) {\n-                nameIter.remove();\n-            }\n+        if (!uniqueValues) {\n+            // table does have any primary key --> we need to remove it\n+            this.pkColumnNames.removeIf(pkColumnName -> {\n+                boolean pkColumnDoesNotExists = !hasColumnWithName(pkColumnName);\n+                if (pkColumnDoesNotExists) {\n+                    LOGGER.warn(\"The column \\\"\" + pkColumnName + \"\\\" is referenced as PRIMARY KEY, but a matching column is not defined in table \\\"\" + tableId() + \"\\\"!\");", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI0NTEzNQ==", "url": "https://github.com/debezium/debezium/pull/1938#discussion_r521245135", "bodyText": "@rk3rn3r Could we reuse inconsistent.schema.handling.mode for this? If not then I'd vote for the exeception again as we should not mask the bugs.", "author": "jpechane", "createdAt": "2020-11-11T09:59:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDcxNTM4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI1ODc0MA==", "url": "https://github.com/debezium/debezium/pull/1938#discussion_r521258740", "bodyText": "@jpechane I have some updated pov about it today. I'm still not sure if there's any case this can happen with a valid, captured db schema on any of our connectors (I can't imagine any weird case that's causing it, but this might be an edge case)? So imo this can only happen when the parsing logic is broken. The only question I have is, that even if parts of the logic is broken, can we successfully continue? My today's conclusion is that it's not safe to leave the connector running and an exception is the best way to handle it now. It will make DDL parsing errors more visible as well.\nIf you don't have any objections, I will switch to the exception.", "author": "rk3rn3r", "createdAt": "2020-11-11T10:23:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDcxNTM4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI5NzE5NQ==", "url": "https://github.com/debezium/debezium/pull/1938#discussion_r521297195", "bodyText": "I agree, I beleive we are done, the PR can be merged when CI is finished.", "author": "jpechane", "createdAt": "2020-11-11T11:36:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDcxNTM4Nw=="}], "type": "inlineReview"}, {"oid": "c13440e562a2d5cfb6e40d720190860edd295441", "url": "https://github.com/debezium/debezium/commit/c13440e562a2d5cfb6e40d720190860edd295441", "message": "DBZ-2580 Fix \"The primary key cannot reference a non-existant column\" error from MySQL DDL parser when CREATE TABLE statement starts with a primary key definition like \"CREATE TABLE Products (PRIMARY KEY (id), ...\" where the referenced primary key column is not yet defined", "committedDate": "2020-11-10T16:58:04Z", "type": "commit"}, {"oid": "c13440e562a2d5cfb6e40d720190860edd295441", "url": "https://github.com/debezium/debezium/commit/c13440e562a2d5cfb6e40d720190860edd295441", "message": "DBZ-2580 Fix \"The primary key cannot reference a non-existant column\" error from MySQL DDL parser when CREATE TABLE statement starts with a primary key definition like \"CREATE TABLE Products (PRIMARY KEY (id), ...\" where the referenced primary key column is not yet defined", "committedDate": "2020-11-10T16:58:04Z", "type": "forcePushed"}, {"oid": "e4ef608a94b3ceb51ba61a70d6142834ef1b9b73", "url": "https://github.com/debezium/debezium/commit/e4ef608a94b3ceb51ba61a70d6142834ef1b9b73", "message": "DBZ-2580 apply PR feedback", "committedDate": "2020-11-11T10:38:53Z", "type": "commit"}, {"oid": "e4ef608a94b3ceb51ba61a70d6142834ef1b9b73", "url": "https://github.com/debezium/debezium/commit/e4ef608a94b3ceb51ba61a70d6142834ef1b9b73", "message": "DBZ-2580 apply PR feedback", "committedDate": "2020-11-11T10:38:53Z", "type": "forcePushed"}]}