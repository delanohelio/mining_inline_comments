{"pr_number": 1748, "pr_title": "Hive read via HiveCatalog documentation", "pr_createdAt": "2020-11-10T12:31:09Z", "pr_url": "https://github.com/apache/iceberg/pull/1748", "timeline": [{"oid": "625226ee6fb6d167e15b0cae3d5dbedc2fb50e1c", "url": "https://github.com/apache/iceberg/commit/625226ee6fb6d167e15b0cae3d5dbedc2fb50e1c", "message": "initial commit to get comments on changes needed", "committedDate": "2020-11-10T12:26:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDUyODA3NA==", "url": "https://github.com/apache/iceberg/pull/1748#discussion_r520528074", "bodyText": "@pvary What does one need to do in order to get the table set up properly for the Hive read path in this case? What I have tried to do so far is this, first create an Iceberg table using the HiveCatalog like so:\n PartitionSpec spec = PartitionSpec.unpartitioned();\n Schema schema = new Schema(optional(1, \"id\", Types.LongType.get()), optional(2, \"name\", Types.StringType.get()));\n SparkSession spark = SparkSession.builder().appName(\"IcebergTest\").getOrCreate();\n Configuration hadoopConfiguration = spark.sparkContext().hadoopConfiguration();\n Catalog catalog = new HiveCatalog(hadoopConfiguration);\n TableIdentifier tableId = TableIdentifier.of(\"test\", \"iceberg_table_from_hive_catalog\");\n catalog.createTable(tableId, schema, spec);\n\nThe table created in Hive by the above has DDL like so:\nCREATE EXTERNAL TABLE `iceberg_table_from_hive_catalog`(\n  `id` bigint COMMENT '', \n  `name` string COMMENT '')\nROW FORMAT SERDE \n  'org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe' \nSTORED AS INPUTFORMAT \n  'org.apache.hadoop.mapred.FileInputFormat' \nOUTPUTFORMAT \n  'org.apache.hadoop.mapred.FileOutputFormat'\nLOCATION\n  's3://REDACTED/iceberg_table_from_hive_catalog'\nTBLPROPERTIES (\n  'metadata_location'='s3://REDACTED/iceberg_table_from_hive_catalog/metadata/00000-7addbbf2-1836-4973-86af-0511ae7577fb.metadata.json', \n  'table_type'='ICEBERG', \n  'transient_lastDdlTime'='1605007216')\n\nWhich is obviously incorrect as the StorageHandler hasn't been set etc.. I know you worked on a PR that set this all up properly as long as some config/setup was performed at table creation time. Can you please let me know what I need to do and I'll then document it accordingly once I test it working?", "author": "massdosage", "createdAt": "2020-11-10T12:34:57Z", "path": "site/docs/hive.md", "diffHunk": "@@ -50,6 +50,19 @@ You should now be able to issue Hive SQL `SELECT` queries using the above table\n SELECT * from table_a;\n ```\n \n+#### Using Hive Catalog\n+Iceberg tables created using `HiveCatalog` are automatically registered with Hive. \n+\n+##### Create an Iceberg table\n+The first step is to create an Iceberg table using the Spark/Java/Python API and `HiveCatalog`. For the purposes of this documentation we will assume that the table is called `table_b` and that the table location is `s3://some_path/table_b`.\n+TODO: what do we need to set up when we create this table programatically for everything to be registered correctly for read usage in Hive?", "originalCommit": "625226ee6fb6d167e15b0cae3d5dbedc2fb50e1c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU2NzIyMw==", "url": "https://github.com/apache/iceberg/pull/1748#discussion_r520567223", "bodyText": "I think setting engine.hive.enabled=true should help.", "author": "pvary", "createdAt": "2020-11-10T13:38:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDUyODA3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY2MDkwNQ==", "url": "https://github.com/apache/iceberg/pull/1748#discussion_r520660905", "bodyText": "OK, so I tried adding this:\nhadoopConfiguration.set(\"engine.hive.enabled\", \"true\");\n\nbefore passing the hadoopConfiguration on to the\nHiveCatalog catalog = new HiveCatalog(hadoopConfiguration);\n\nbut it doesn't seem to make any difference to the DDL of the table that gets subsequently created.", "author": "massdosage", "createdAt": "2020-11-10T15:40:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDUyODA3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY4MjIzNg==", "url": "https://github.com/apache/iceberg/pull/1748#discussion_r520682236", "bodyText": "Oh wait, iceberg.engine.hive.enabled is what it should be, let me try that...", "author": "massdosage", "createdAt": "2020-11-10T16:07:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDUyODA3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY5MjY4MQ==", "url": "https://github.com/apache/iceberg/pull/1748#discussion_r520692681", "bodyText": "OK, so, with setting that property the DDL looks better:\nCREATE EXTERNAL TABLE `iceberg_table_from_hive_catalog`(\n)\nROW FORMAT SERDE \n  'org.apache.iceberg.mr.hive.HiveIcebergSerDe' \nSTORED BY \n  'org.apache.iceberg.mr.hive.HiveIcebergStorageHandler' \n\nLOCATION\n  's3://REDACTED/iceberg_table_from_hive_catalog'\nTBLPROPERTIES (\n  'metadata_location'='s3://REDACTED/iceberg_table_from_hive_catalog/metadata/00000-95297465-a383-4f0b-b546-dffe7c4ff778.metadata.json', \n  'table_type'='ICEBERG', \n  'transient_lastDdlTime'='1605024789')\n\nNot sure whether it's an issue that the schema information is missing? I also can't successfully query this table from Hive so I'll look into that next and see what the issue is. Thanks for helping me over the first hurdle though, I'll update this PR shortly with that required config setting.", "author": "massdosage", "createdAt": "2020-11-10T16:21:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDUyODA3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU2Njc0Ng==", "url": "https://github.com/apache/iceberg/pull/1748#discussion_r521566746", "bodyText": "I got this working when I tested 0.10.0-rc4. In Hive, I had to set iceberg.mr.catalog=hive so that the correct catalog was used. Unfortunately, that broke the Hadoop table.\nI think we might want to add support for Hadoop tables in our catalogs using an identifier that contains a path to fix this.", "author": "rdblue", "createdAt": "2020-11-11T18:47:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDUyODA3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU2NzI1MQ==", "url": "https://github.com/apache/iceberg/pull/1748#discussion_r521567251", "bodyText": "Also, engine.hive.enabled is the table property. When a table has that property, it will be created with the storage handler. I set the property on my table from Spark and it worked.", "author": "rdblue", "createdAt": "2020-11-11T18:48:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDUyODA3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU3MDEzOA==", "url": "https://github.com/apache/iceberg/pull/1748#discussion_r521570138", "bodyText": "Also, engine.hive.enabled is the table property. When a table has that property, it will be created with the storage handler. I set the property on my table from Spark and it worked.\n\nReally? From what I can see the code uses the value from here \n  \n    \n      iceberg/core/src/main/java/org/apache/iceberg/hadoop/ConfigProperties.java\n    \n    \n         Line 27\n      in\n      b403009\n    \n    \n    \n    \n\n        \n          \n           public static final String ENGINE_HIVE_ENABLED = \"iceberg.engine.hive.enabled\"; \n        \n    \n  \n\n which is prefixed with iceberg as I said above. I tried it both ways and only this way worked but the schema in the Hive table definition is empty so Hive seems to be throwing an error about that when it tries to query it. I haven't tried setting iceberg.mr.catalog=hive in Hive when I do the query, I will try that next and see if it makes any difference and what impact that has on the HadoopTables version of it.", "author": "massdosage", "createdAt": "2020-11-11T18:53:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDUyODA3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTYzNzM0MQ==", "url": "https://github.com/apache/iceberg/pull/1748#discussion_r521637341", "bodyText": "The logic for setting up the storage handler is here: https://github.com/apache/iceberg/blob/master/hive-metastore/src/main/java/org/apache/iceberg/hive/HiveTableOperations.java#L377-L384\nIt uses both the environment config and the table property.", "author": "rdblue", "createdAt": "2020-11-11T21:04:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDUyODA3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTkyMjg3Nw==", "url": "https://github.com/apache/iceberg/pull/1748#discussion_r521922877", "bodyText": "Yes, exactly, so in this case when I'm creating a new table it doesn't find the value in the table metadata so it drops through to line 383 and looks in the Configuration using the ConfigProperties key I mentioned above which is iceberg.engine.hive.enabled. I stepped through this code to figure out why it wasn't working with engine.hive.enabled and saw the property it was looking for in the conf is actually iceberg.engine.hive.enabled. So I guess there are two options here:\n\nyou explicitly create the table with metadata and set engine.hive.enabled as a table property.\n\nor\n\nyou set the value iceberg.engine.hive.enabled explicitly in the conf object (like I'm doing in my example code above) or let this be automatically set by adding it to hive-site.xml.\n\nIf we agree on this I can document the above here ^. I\nI'll then look into what's necessary in order to query the table and add it.", "author": "massdosage", "createdAt": "2020-11-12T08:29:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDUyODA3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTkyNjI0NA==", "url": "https://github.com/apache/iceberg/pull/1748#discussion_r521926244", "bodyText": "CC @lcspinter as he is working on coming up a generic way to handle properties / configuration values wrt Hive.\nWe would like to come up with solution where the user could easily understand how the different properties are used:\n\nIceberg table properties\nHMS table properties\nHMS serde properties\nHiveConf\nDefault values\n\nAlso we should understand how these properties are used when:\n\nReading Hive / Iceberg tables\nWriting Hive / Iceberg tables", "author": "pvary", "createdAt": "2020-11-12T08:34:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDUyODA3NA=="}], "type": "inlineReview"}, {"oid": "2294af096ebd109efd902a4107081d4f85abe524", "url": "https://github.com/apache/iceberg/commit/2294af096ebd109efd902a4107081d4f85abe524", "message": "added details on two different methods for creating the table", "committedDate": "2020-11-12T13:21:08Z", "type": "commit"}, {"oid": "0ce135ca4ceb3cd683893575b61c3cdd8d193f5e", "url": "https://github.com/apache/iceberg/commit/0ce135ca4ceb3cd683893575b61c3cdd8d193f5e", "message": "fix indentation level", "committedDate": "2020-11-12T13:21:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMwMjM5Ng==", "url": "https://github.com/apache/iceberg/pull/1748#discussion_r522302396", "bodyText": "This seems to me contradictory to the following lines. Is this TODO still valid?", "author": "rdsr", "createdAt": "2020-11-12T17:54:09Z", "path": "site/docs/hive.md", "diffHunk": "@@ -50,6 +50,38 @@ You should now be able to issue Hive SQL `SELECT` queries using the above table\n SELECT * from table_a;\n ```\n \n+#### Using Hive Catalog\n+Iceberg tables created using `HiveCatalog` are automatically registered with Hive.\n+\n+##### Create an Iceberg table\n+The first step is to create an Iceberg table using the Spark/Java/Python API and `HiveCatalog`. For the purposes of this documentation we will assume that the table is called `table_b` and that the table location is `s3://some_path/table_b`. In order for Iceberg to correctly set up the Hive table for querying some configuration values need to be set, the two options for this are described below - you can use either or the other depending on your use case.\n+\n+##### Hive Configuration\n+The value `iceberg.engine.hive.enabled` needs to be set to `true` and added to the Hive configuration file on the classpath of the application creating the table. This can be done by modifying the relevant `hive-site.xml`. Alternatively this can done programatically like so:\n+```java\n+Configuration hadoopConfiguration = spark.sparkContext().hadoopConfiguration();\n+hadoopConfiguration.set(ConfigProperties.ENGINE_HIVE_ENABLED, \"true\"); //iceberg.engine.hive.enabled=true\n+HiveCatalog catalog = new HiveCatalog(hadoopConfiguration);\n+...\n+catalog.createTable(tableId, schema, spec);\n+```\n+\n+##### Table Property Configuration\n+The property `engine.hive.enabled` needs to be set to `true` and added to the table properties when creating the Iceberg table. This can be done like so:\n+```java\n+    Map<String, String> tableProperties = new HashMap<String, String>();\n+    tableProperties.put(TableProperties.ENGINE_HIVE_ENABLED, \"true\"); ////engine.hive.enabled=true\n+    catalog.createTable(tableId, schema, spec, tableProperties);\n+```\n+\n+#### Query the Iceberg table via Hive\n+TODO: tables created by the above can't just be read \"as is\", need to document steps needed in order to be able to query them here.", "originalCommit": "0ce135ca4ceb3cd683893575b61c3cdd8d193f5e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM1Mzg4Mw==", "url": "https://github.com/apache/iceberg/pull/1748#discussion_r522353883", "bodyText": "Yes, I'm currently unable to query the tables created by the above from Hive and need to figure out what I need to do in order to get it working. There's either an issue with the generated DDL or some properties need to be set at read time. I haven't had time to look into it properly yet.", "author": "massdosage", "createdAt": "2020-11-12T19:15:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMwMjM5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMwMjkyMA==", "url": "https://github.com/apache/iceberg/pull/1748#discussion_r522302920", "bodyText": "I assume we can query existing Iceberg tables also through Hive by setting the iceberg.engine.hive.enabled flag? Do you think it worth calling that out?", "author": "rdsr", "createdAt": "2020-11-12T17:54:54Z", "path": "site/docs/hive.md", "diffHunk": "@@ -50,6 +50,38 @@ You should now be able to issue Hive SQL `SELECT` queries using the above table\n SELECT * from table_a;\n ```\n \n+#### Using Hive Catalog\n+Iceberg tables created using `HiveCatalog` are automatically registered with Hive.\n+\n+##### Create an Iceberg table\n+The first step is to create an Iceberg table using the Spark/Java/Python API and `HiveCatalog`. For the purposes of this documentation we will assume that the table is called `table_b` and that the table location is `s3://some_path/table_b`. In order for Iceberg to correctly set up the Hive table for querying some configuration values need to be set, the two options for this are described below - you can use either or the other depending on your use case.\n+\n+##### Hive Configuration\n+The value `iceberg.engine.hive.enabled` needs to be set to `true` and added to the Hive configuration file on the classpath of the application creating the table. This can be done by modifying the relevant `hive-site.xml`. Alternatively this can done programatically like so:", "originalCommit": "0ce135ca4ceb3cd683893575b61c3cdd8d193f5e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM1NDIyNw==", "url": "https://github.com/apache/iceberg/pull/1748#discussion_r522354227", "bodyText": "I'll let you know if and when I get it working ;) and yes, that will need to be added to the documentation.", "author": "massdosage", "createdAt": "2020-11-12T19:16:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMwMjkyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjgwOTQwMA==", "url": "https://github.com/apache/iceberg/pull/1748#discussion_r526809400", "bodyText": "Updated docs to describe the property you need to set for Hive read is set iceberg.mr.catalog=hive", "author": "massdosage", "createdAt": "2020-11-19T11:54:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMwMjkyMA=="}], "type": "inlineReview"}, {"oid": "6c2731e5539a265b6de71b76936847c5f7c2392a", "url": "https://github.com/apache/iceberg/commit/6c2731e5539a265b6de71b76936847c5f7c2392a", "message": "added property for querying HiveCatalog table", "committedDate": "2020-11-19T11:52:25Z", "type": "commit"}]}