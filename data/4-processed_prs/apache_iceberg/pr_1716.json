{"pr_number": 1716, "pr_title": "Read all row group metadata only when position column is projected", "pr_createdAt": "2020-11-04T03:28:32Z", "pr_url": "https://github.com/apache/iceberg/pull/1716", "timeline": [{"oid": "f0faa613ae4a6fbc08b9ed901f88a2ef85ffd079", "url": "https://github.com/apache/iceberg/commit/f0faa613ae4a6fbc08b9ed901f88a2ef85ffd079", "message": "Read all row group metadata only when position column is projected", "committedDate": "2020-11-04T03:21:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA3ODg2NA==", "url": "https://github.com/apache/iceberg/pull/1716#discussion_r517078864", "bodyText": "The rowPosition will be ignored if the position column is not projected.", "author": "chenjunjiedada", "createdAt": "2020-11-04T03:30:45Z", "path": "parquet/src/main/java/org/apache/iceberg/parquet/ParquetReader.java", "diffHunk": "@@ -135,11 +135,9 @@ private void advance() {\n         throw new RuntimeIOException(e);\n       }\n \n-      long rowPosition = rowGroupsStartRowPos[nextRowGroup];\n+      model.setPageSource(pages, rowGroupsStartRowPos == null ? 0 : rowGroupsStartRowPos[nextRowGroup]);", "originalCommit": "f0faa613ae4a6fbc08b9ed901f88a2ef85ffd079", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODkyNzQzNA==", "url": "https://github.com/apache/iceberg/pull/1716#discussion_r518927434", "bodyText": "I don't think this file should change. If the determination not to use correct start positions in made in ReadConf, then it should just set the position to 0 there. This can use whatever rowGroupStartRowPos contains.", "author": "rdblue", "createdAt": "2020-11-06T18:24:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA3ODg2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODkyODI2Mg==", "url": "https://github.com/apache/iceberg/pull/1716#discussion_r518928262", "bodyText": "I think this should use offsetToStartPos.getOrDefault(0L).", "author": "rdblue", "createdAt": "2020-11-06T18:25:58Z", "path": "parquet/src/main/java/org/apache/iceberg/parquet/ReadConf.java", "diffHunk": "@@ -102,7 +107,9 @@\n     long computedTotalValues = 0L;\n     for (int i = 0; i < shouldSkip.length; i += 1) {\n       BlockMetaData rowGroup = rowGroups.get(i);\n-      startRowPositions[i] = offsetToStartPos.get(rowGroup.getStartingPos());\n+      if (offsetToStartPos != null) {\n+        startRowPositions[i] = offsetToStartPos.get(rowGroup.getStartingPos());", "originalCommit": "f0faa613ae4a6fbc08b9ed901f88a2ef85ffd079", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODkyOTA4OQ==", "url": "https://github.com/apache/iceberg/pull/1716#discussion_r518929089", "bodyText": "I think this should be defined for all cases so that ParquetReader doesn't need to check whether it is defined. In that case, it should still be a final variable.\nThe only change for this PR should be whether offsetToStartPos is an empty map or the result of generateOffsetToStartPos(). We may also want to do the ROW_POSITION check in that method instead of here, depending on what is cleaner.", "author": "rdblue", "createdAt": "2020-11-06T18:27:35Z", "path": "parquet/src/main/java/org/apache/iceberg/parquet/ReadConf.java", "diffHunk": "@@ -89,8 +91,11 @@\n     this.shouldSkip = new boolean[rowGroups.size()];\n \n     // Fetch all row groups starting positions to compute the row offsets of the filtered row groups\n-    Map<Long, Long> offsetToStartPos = generateOffsetToStartPos();\n-    this.startRowPositions = new long[rowGroups.size()];\n+    Map<Long, Long> offsetToStartPos = null;\n+    if (expectedSchema.findField(MetadataColumns.ROW_POSITION.fieldId()) != null) {\n+      offsetToStartPos = generateOffsetToStartPos();\n+      this.startRowPositions = new long[rowGroups.size()];", "originalCommit": "f0faa613ae4a6fbc08b9ed901f88a2ef85ffd079", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTA2NDEzNQ==", "url": "https://github.com/apache/iceberg/pull/1716#discussion_r519064135", "bodyText": "Make sense to me. Updated.", "author": "chenjunjiedada", "createdAt": "2020-11-07T00:12:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODkyOTA4OQ=="}], "type": "inlineReview"}, {"oid": "55bb184222324fa33fae435477883dc93e74eaa3", "url": "https://github.com/apache/iceberg/commit/55bb184222324fa33fae435477883dc93e74eaa3", "message": "address comments", "committedDate": "2020-11-06T23:49:39Z", "type": "commit"}]}