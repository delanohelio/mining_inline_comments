{"pr_number": 1342, "pr_title": "Static Table Operations", "pr_createdAt": "2020-08-14T18:15:52Z", "pr_url": "https://github.com/apache/iceberg/pull/1342", "timeline": [{"oid": "41ed1f70c5b0d76885f087f3fe3d7aa5f92397ae", "url": "https://github.com/apache/iceberg/commit/41ed1f70c5b0d76885f087f3fe3d7aa5f92397ae", "message": "Static Table Operations\n\nAllows for a Table Operations which references a specfic metadata version\nfile. This operation will not change even if the base table it was derived\nfrom is changed. This enables it to act like a ReadOnly view of the table's\nstate at a given time.", "committedDate": "2020-08-14T18:14:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc4ODcyNw==", "url": "https://github.com/apache/iceberg/pull/1342#discussion_r470788727", "bodyText": "An alternative to this implementation that I considered was modifying findTable itself. The problem with this is that to do that implementation we need to extract the loadMetadataTable from below. I think this is a cleaner solution but we could do something where we make a StaticTables.java which findTables uses to either return a basetable or metadataTable", "author": "RussellSpitzer", "createdAt": "2020-08-14T18:24:03Z", "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTables.java", "diffHunk": "@@ -68,27 +71,26 @@ public HadoopTables(Configuration conf) {\n    */\n   @Override\n   public Table load(String location) {\n-    TableOperations ops = newTableOps(location);", "originalCommit": "41ed1f70c5b0d76885f087f3fe3d7aa5f92397ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgzNTc0Mw==", "url": "https://github.com/apache/iceberg/pull/1342#discussion_r470835743", "bodyText": "I like this. It is more straightforward than the previous implementation.", "author": "rdblue", "createdAt": "2020-08-14T19:51:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc4ODcyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgyOTc0Nw==", "url": "https://github.com/apache/iceberg/pull/1342#discussion_r470829747", "bodyText": "Should this be metadataLocation to be more specific?", "author": "rdblue", "createdAt": "2020-08-14T19:36:40Z", "path": "core/src/main/java/org/apache/iceberg/StaticTableOperations.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ *\n+ */\n+\n+package org.apache.iceberg;\n+\n+import java.nio.file.Paths;\n+import org.apache.iceberg.io.FileIO;\n+import org.apache.iceberg.io.LocationProvider;\n+\n+/**\n+ * Representation of an immutable snapshot of Table State that can be used in\n+ * other Iceberg Functions.\n+ */\n+public class StaticTableOperations implements TableOperations {\n+  private final TableMetadata staticMetadata;\n+  private final FileIO io;\n+\n+  /**\n+   * Creates a StaticTableOperations tied to a specific static version of the TableMetadata\n+   */\n+  public StaticTableOperations(String location, FileIO io) {", "originalCommit": "41ed1f70c5b0d76885f087f3fe3d7aa5f92397ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgzNjQ1MA==", "url": "https://github.com/apache/iceberg/pull/1342#discussion_r470836450", "bodyText": "metadataFileLocation? That would mirror the TableMetadata object", "author": "RussellSpitzer", "createdAt": "2020-08-14T19:53:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgyOTc0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgzMTAzNg==", "url": "https://github.com/apache/iceberg/pull/1342#discussion_r470831036", "bodyText": "I'm not sure that I would say that the TableOperations implementation is a representation, and it is probably a good idea to avoid using \"snapshot\" to mean something other than a Snapshot. How about \"TableOperations  implementation that provides access to metadata for a Table at some point in time, using a table metadata location\"?", "author": "rdblue", "createdAt": "2020-08-14T19:39:41Z", "path": "core/src/main/java/org/apache/iceberg/StaticTableOperations.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ *\n+ */\n+\n+package org.apache.iceberg;\n+\n+import java.nio.file.Paths;\n+import org.apache.iceberg.io.FileIO;\n+import org.apache.iceberg.io.LocationProvider;\n+\n+/**\n+ * Representation of an immutable snapshot of Table State that can be used in\n+ * other Iceberg Functions.", "originalCommit": "41ed1f70c5b0d76885f087f3fe3d7aa5f92397ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgzMjEwNg==", "url": "https://github.com/apache/iceberg/pull/1342#discussion_r470832106", "bodyText": "Sounds good to me, I had a lot of difficulty with verbiage in comments for this", "author": "RussellSpitzer", "createdAt": "2020-08-14T19:42:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgzMTAzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgzMjM3OQ==", "url": "https://github.com/apache/iceberg/pull/1342#discussion_r470832379", "bodyText": "A couple of style nits: There should be a space before the start of the comment text, and we typically use sentence case, unless referring to specific objects, like MetadataTable (no need to capitalize \"Table\" and \"Load\").", "author": "rdblue", "createdAt": "2020-08-14T19:42:52Z", "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTables.java", "diffHunk": "@@ -68,27 +71,26 @@ public HadoopTables(Configuration conf) {\n    */\n   @Override\n   public Table load(String location) {\n-    TableOperations ops = newTableOps(location);\n-    if (ops.current() == null) {\n+    //Possibly Load a Metadata Table\n+    if (location.contains(\"#\") && !location.endsWith(\"#\")) {\n       // try to resolve a metadata table, which we encode as URI fragments\n       // e.g. hdfs:///warehouse/my_table#snapshots\n       int hashIndex = location.lastIndexOf('#');\n-      if (hashIndex != -1 && location.length() - 1 != hashIndex) {\n-        // we found char '#', and it is not the last char of location\n-        String baseTable = location.substring(0, hashIndex);\n-        String metaTable = location.substring(hashIndex + 1);\n-        MetadataTableType type = MetadataTableType.from(metaTable);\n-        if (type != null) {\n-          return loadMetadataTable(baseTable, type);\n-        } else {\n-          throw new NoSuchTableException(\"Table does not exist at location: \" + location);\n-        }\n-      } else {\n-        throw new NoSuchTableException(\"Table does not exist at location: \" + location);\n+      String baseTable = location.substring(0, hashIndex);\n+      String metaTable = location.substring(hashIndex + 1);\n+      MetadataTableType type = MetadataTableType.from(metaTable);\n+      if (type != null) {\n+        return loadMetadataTable(baseTable, type);\n       }\n     }\n \n-    return new BaseTable(ops, location);\n+    //Normal Table Load if we haven't loaded a MetadataTable", "originalCommit": "41ed1f70c5b0d76885f087f3fe3d7aa5f92397ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg1MzU4OQ==", "url": "https://github.com/apache/iceberg/pull/1342#discussion_r470853589", "bodyText": "cleaned up!", "author": "RussellSpitzer", "createdAt": "2020-08-14T20:36:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgzMjM3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg2NDAxNQ==", "url": "https://github.com/apache/iceberg/pull/1342#discussion_r470864015", "bodyText": "Cleaned it up", "author": "RussellSpitzer", "createdAt": "2020-08-14T21:03:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgzMjM3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgzMzM1OA==", "url": "https://github.com/apache/iceberg/pull/1342#discussion_r470833358", "bodyText": "This would be true of any different table instance that refers to the same table because refresh was not called. I think this test should call staticTable.refresh() after the modifications to test what you intend.", "author": "rdblue", "createdAt": "2020-08-14T19:45:14Z", "path": "core/src/test/java/org/apache/iceberg/hadoop/TestStaticTable.java", "diffHunk": "@@ -0,0 +1,79 @@\n+package org.apache.iceberg.hadoop;\n+\n+import com.google.common.collect.Iterables;\n+import com.google.common.collect.Maps;\n+import org.apache.iceberg.HasTableOperations;\n+import org.apache.iceberg.MetadataTableType;\n+import org.apache.iceberg.StaticTableOperations;\n+import org.apache.iceberg.Table;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+public class TestStaticTable extends HadoopTableTestBase {\n+\n+  private Table getStaticTable() {\n+    return TABLES.load(((HasTableOperations) table).operations().current().metadataFileLocation());\n+  }\n+\n+  private Table getStaticTable(MetadataTableType type) {\n+    return TABLES.load(((HasTableOperations) table).operations().current().metadataFileLocation() + \"#\" + type);\n+  }\n+\n+  @Test\n+  public void testLoadFromMetadata() {\n+    Table staticTable = getStaticTable();\n+    Assert.assertTrue(\"Loading a metadata file based table should return StaticTableOperations\",\n+        ((HasTableOperations) staticTable).operations() instanceof StaticTableOperations);\n+  }\n+\n+  @Test(expected = UnsupportedOperationException.class)\n+  public void testCannotBeAddedTo(){\n+    Table staticTable = getStaticTable();\n+    staticTable.newOverwrite().addFile(FILE_A).commit();\n+  }\n+\n+  @Test(expected = UnsupportedOperationException.class)\n+  public void testCannotBeDeletedFrom(){\n+    table.newAppend().appendFile(FILE_A).commit();\n+    Table staticTable = getStaticTable();\n+    staticTable.newDelete().deleteFile(FILE_A).commit();\n+  }\n+\n+  @Test\n+  public void testHasSameProperties(){\n+    table.newAppend().appendFile(FILE_A).commit();\n+    table.newAppend().appendFile(FILE_B).commit();\n+    table.newOverwrite().deleteFile(FILE_B).addFile(FILE_C).commit();\n+    Table staticTable = getStaticTable();\n+    Assert.assertTrue(\"Same history?\",\n+        table.history().containsAll(staticTable.history()));\n+    Assert.assertTrue(\"Same snapshot?\",\n+        table.currentSnapshot().snapshotId() ==  staticTable.currentSnapshot().snapshotId());\n+    Assert.assertTrue(\"Same properties?\",\n+        Maps.difference(table.properties(), staticTable.properties()).areEqual());\n+  }\n+\n+  @Test\n+  public void testImmutable() {\n+    table.newAppend().appendFile(FILE_A).commit();\n+    Table staticTable = getStaticTable();\n+    long originalSnapshot = table.currentSnapshot().snapshotId();\n+\n+    table.newAppend().appendFile(FILE_B).commit();\n+    table.newOverwrite().deleteFile(FILE_B).addFile(FILE_C).commit();\n+\n+    Assert.assertEquals(\"Snapshot unchanged after table modified\",\n+        staticTable.currentSnapshot().snapshotId(), originalSnapshot);", "originalCommit": "41ed1f70c5b0d76885f087f3fe3d7aa5f92397ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg1NDQ0NQ==", "url": "https://github.com/apache/iceberg/pull/1342#discussion_r470854445", "bodyText": "Sgtm", "author": "RussellSpitzer", "createdAt": "2020-08-14T20:38:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgzMzM1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg2MzY0MQ==", "url": "https://github.com/apache/iceberg/pull/1342#discussion_r470863641", "bodyText": "Got it!", "author": "RussellSpitzer", "createdAt": "2020-08-14T21:02:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgzMzM1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgzMzcxNg==", "url": "https://github.com/apache/iceberg/pull/1342#discussion_r470833716", "bodyText": "When is this needed?\nAlso, style nit: no space between arguments to replace.", "author": "rdblue", "createdAt": "2020-08-14T19:46:12Z", "path": "core/src/test/java/org/apache/iceberg/hadoop/TestStaticTable.java", "diffHunk": "@@ -0,0 +1,79 @@\n+package org.apache.iceberg.hadoop;\n+\n+import com.google.common.collect.Iterables;\n+import com.google.common.collect.Maps;\n+import org.apache.iceberg.HasTableOperations;\n+import org.apache.iceberg.MetadataTableType;\n+import org.apache.iceberg.StaticTableOperations;\n+import org.apache.iceberg.Table;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+public class TestStaticTable extends HadoopTableTestBase {\n+\n+  private Table getStaticTable() {\n+    return TABLES.load(((HasTableOperations) table).operations().current().metadataFileLocation());\n+  }\n+\n+  private Table getStaticTable(MetadataTableType type) {\n+    return TABLES.load(((HasTableOperations) table).operations().current().metadataFileLocation() + \"#\" + type);\n+  }\n+\n+  @Test\n+  public void testLoadFromMetadata() {\n+    Table staticTable = getStaticTable();\n+    Assert.assertTrue(\"Loading a metadata file based table should return StaticTableOperations\",\n+        ((HasTableOperations) staticTable).operations() instanceof StaticTableOperations);\n+  }\n+\n+  @Test(expected = UnsupportedOperationException.class)\n+  public void testCannotBeAddedTo(){\n+    Table staticTable = getStaticTable();\n+    staticTable.newOverwrite().addFile(FILE_A).commit();\n+  }\n+\n+  @Test(expected = UnsupportedOperationException.class)\n+  public void testCannotBeDeletedFrom(){\n+    table.newAppend().appendFile(FILE_A).commit();\n+    Table staticTable = getStaticTable();\n+    staticTable.newDelete().deleteFile(FILE_A).commit();\n+  }\n+\n+  @Test\n+  public void testHasSameProperties(){\n+    table.newAppend().appendFile(FILE_A).commit();\n+    table.newAppend().appendFile(FILE_B).commit();\n+    table.newOverwrite().deleteFile(FILE_B).addFile(FILE_C).commit();\n+    Table staticTable = getStaticTable();\n+    Assert.assertTrue(\"Same history?\",\n+        table.history().containsAll(staticTable.history()));\n+    Assert.assertTrue(\"Same snapshot?\",\n+        table.currentSnapshot().snapshotId() ==  staticTable.currentSnapshot().snapshotId());\n+    Assert.assertTrue(\"Same properties?\",\n+        Maps.difference(table.properties(), staticTable.properties()).areEqual());\n+  }\n+\n+  @Test\n+  public void testImmutable() {\n+    table.newAppend().appendFile(FILE_A).commit();\n+    Table staticTable = getStaticTable();\n+    long originalSnapshot = table.currentSnapshot().snapshotId();\n+\n+    table.newAppend().appendFile(FILE_B).commit();\n+    table.newOverwrite().deleteFile(FILE_B).addFile(FILE_C).commit();\n+\n+    Assert.assertEquals(\"Snapshot unchanged after table modified\",\n+        staticTable.currentSnapshot().snapshotId(), originalSnapshot);\n+  }\n+\n+  @Test\n+  public void testMetadataTables() {\n+    for (MetadataTableType type: MetadataTableType.values()) {\n+      String enumName = type.name().replace(\"_\",\"\").toLowerCase();", "originalCommit": "41ed1f70c5b0d76885f087f3fe3d7aa5f92397ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgzNDE1Nw==", "url": "https://github.com/apache/iceberg/pull/1342#discussion_r470834157", "bodyText": "ALL_DATA_FILES, ALL_MANIFESTS, ALL_ENTRIES\nAll the style things just make me want to upgrade the Checkstyle version even more :) I forgot to run in Intellij where I can force the newer version", "author": "RussellSpitzer", "createdAt": "2020-08-14T19:47:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgzMzcxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgzNzMxNQ==", "url": "https://github.com/apache/iceberg/pull/1342#discussion_r470837315", "bodyText": "I thought those were loaded using all_data_files, all_manifests, etc. and not alldatafiles.", "author": "rdblue", "createdAt": "2020-08-14T19:55:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgzMzcxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg0ODI4MA==", "url": "https://github.com/apache/iceberg/pull/1342#discussion_r470848280", "bodyText": "we are just comparing the ClassName here, so we are comparing AllDataFilesTable.class with ALL_DATA_FILES\nI may be misunderstanding your comment here, I'm just making sure that we get back the Class with the right name based on the MetadataType we request.", "author": "RussellSpitzer", "createdAt": "2020-08-14T20:22:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgzMzcxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg1OTcwMA==", "url": "https://github.com/apache/iceberg/pull/1342#discussion_r470859700", "bodyText": "Okay, I see. Nevermind, then.", "author": "rdblue", "createdAt": "2020-08-14T20:52:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgzMzcxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgzNDQ3Ng==", "url": "https://github.com/apache/iceberg/pull/1342#discussion_r470834476", "bodyText": "We typically use AssertHelpers.assertThrows instead of expected because that allows you to validate the exception message and make assertions after the failure. For example, this should assert that the value of table.current() before the commit is the same object as table.refresh() after the failed commit.", "author": "rdblue", "createdAt": "2020-08-14T19:48:16Z", "path": "core/src/test/java/org/apache/iceberg/hadoop/TestStaticTable.java", "diffHunk": "@@ -0,0 +1,79 @@\n+package org.apache.iceberg.hadoop;\n+\n+import com.google.common.collect.Iterables;\n+import com.google.common.collect.Maps;\n+import org.apache.iceberg.HasTableOperations;\n+import org.apache.iceberg.MetadataTableType;\n+import org.apache.iceberg.StaticTableOperations;\n+import org.apache.iceberg.Table;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+public class TestStaticTable extends HadoopTableTestBase {\n+\n+  private Table getStaticTable() {\n+    return TABLES.load(((HasTableOperations) table).operations().current().metadataFileLocation());\n+  }\n+\n+  private Table getStaticTable(MetadataTableType type) {\n+    return TABLES.load(((HasTableOperations) table).operations().current().metadataFileLocation() + \"#\" + type);\n+  }\n+\n+  @Test\n+  public void testLoadFromMetadata() {\n+    Table staticTable = getStaticTable();\n+    Assert.assertTrue(\"Loading a metadata file based table should return StaticTableOperations\",\n+        ((HasTableOperations) staticTable).operations() instanceof StaticTableOperations);\n+  }\n+\n+  @Test(expected = UnsupportedOperationException.class)\n+  public void testCannotBeAddedTo(){\n+    Table staticTable = getStaticTable();\n+    staticTable.newOverwrite().addFile(FILE_A).commit();\n+  }\n+\n+  @Test(expected = UnsupportedOperationException.class)", "originalCommit": "41ed1f70c5b0d76885f087f3fe3d7aa5f92397ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg0NTc0Mw==", "url": "https://github.com/apache/iceberg/pull/1342#discussion_r470845743", "bodyText": "Ah weird, for some reason IntelliJ told me I only had Junit4 on the class path so I didn't use Assert.assertThrows. That's why I only am using Junit4 conventions :/", "author": "RussellSpitzer", "createdAt": "2020-08-14T20:15:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgzNDQ3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg1NzQxMQ==", "url": "https://github.com/apache/iceberg/pull/1342#discussion_r470857411", "bodyText": "Oh I see there is a custom Iceberg version of it! I get things", "author": "RussellSpitzer", "createdAt": "2020-08-14T20:46:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgzNDQ3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgzNDYzOA==", "url": "https://github.com/apache/iceberg/pull/1342#discussion_r470834638", "bodyText": "I'm not sure we need both this and the next test, but it's okay to have them.", "author": "rdblue", "createdAt": "2020-08-14T19:48:43Z", "path": "core/src/test/java/org/apache/iceberg/hadoop/TestStaticTable.java", "diffHunk": "@@ -0,0 +1,79 @@\n+package org.apache.iceberg.hadoop;\n+\n+import com.google.common.collect.Iterables;\n+import com.google.common.collect.Maps;\n+import org.apache.iceberg.HasTableOperations;\n+import org.apache.iceberg.MetadataTableType;\n+import org.apache.iceberg.StaticTableOperations;\n+import org.apache.iceberg.Table;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+public class TestStaticTable extends HadoopTableTestBase {\n+\n+  private Table getStaticTable() {\n+    return TABLES.load(((HasTableOperations) table).operations().current().metadataFileLocation());\n+  }\n+\n+  private Table getStaticTable(MetadataTableType type) {\n+    return TABLES.load(((HasTableOperations) table).operations().current().metadataFileLocation() + \"#\" + type);\n+  }\n+\n+  @Test\n+  public void testLoadFromMetadata() {\n+    Table staticTable = getStaticTable();\n+    Assert.assertTrue(\"Loading a metadata file based table should return StaticTableOperations\",\n+        ((HasTableOperations) staticTable).operations() instanceof StaticTableOperations);\n+  }\n+\n+  @Test(expected = UnsupportedOperationException.class)\n+  public void testCannotBeAddedTo(){", "originalCommit": "41ed1f70c5b0d76885f087f3fe3d7aa5f92397ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgzNTQ2OA==", "url": "https://github.com/apache/iceberg/pull/1342#discussion_r470835468", "bodyText": "How about parse out the metadata table name, if present?", "author": "rdblue", "createdAt": "2020-08-14T19:50:48Z", "path": "core/src/main/java/org/apache/iceberg/hadoop/HadoopTables.java", "diffHunk": "@@ -68,27 +71,26 @@ public HadoopTables(Configuration conf) {\n    */\n   @Override\n   public Table load(String location) {\n-    TableOperations ops = newTableOps(location);\n-    if (ops.current() == null) {\n+    //Possibly Load a Metadata Table", "originalCommit": "41ed1f70c5b0d76885f087f3fe3d7aa5f92397ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg1NzAzMg==", "url": "https://github.com/apache/iceberg/pull/1342#discussion_r470857032", "bodyText": "I made a different implementation here where we will instead do\nName, Type = tryParseMetadataLocation\n\nif (name, type).{\n  loadMetadata\n} else {\n  loadBasic\n}", "author": "RussellSpitzer", "createdAt": "2020-08-14T20:45:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgzNTQ2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgzNjA3MQ==", "url": "https://github.com/apache/iceberg/pull/1342#discussion_r470836071", "bodyText": "Users don't know about TableOperations, so we shouldn't mention it here. How about Cannot modify a static table?", "author": "rdblue", "createdAt": "2020-08-14T19:52:16Z", "path": "core/src/main/java/org/apache/iceberg/StaticTableOperations.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ *\n+ */\n+\n+package org.apache.iceberg;\n+\n+import java.nio.file.Paths;\n+import org.apache.iceberg.io.FileIO;\n+import org.apache.iceberg.io.LocationProvider;\n+\n+/**\n+ * Representation of an immutable snapshot of Table State that can be used in\n+ * other Iceberg Functions.\n+ */\n+public class StaticTableOperations implements TableOperations {\n+  private final TableMetadata staticMetadata;\n+  private final FileIO io;\n+\n+  /**\n+   * Creates a StaticTableOperations tied to a specific static version of the TableMetadata\n+   */\n+  public StaticTableOperations(String location, FileIO io) {\n+    this.io = io;\n+    this.staticMetadata = TableMetadataParser.read(io, location);\n+  }\n+\n+  @Override\n+  public TableMetadata current() {\n+    return staticMetadata;\n+  }\n+\n+  @Override\n+  public TableMetadata refresh() {\n+    return staticMetadata;\n+  }\n+\n+  @Override\n+  public void commit(TableMetadata base, TableMetadata metadata) {\n+    throw new UnsupportedOperationException(\"This TableOperations is static, it cannot be modified\");", "originalCommit": "41ed1f70c5b0d76885f087f3fe3d7aa5f92397ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg0MDY3Ng==", "url": "https://github.com/apache/iceberg/pull/1342#discussion_r470840676", "bodyText": "sounds good to me", "author": "RussellSpitzer", "createdAt": "2020-08-14T20:03:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgzNjA3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgzNjY3OA==", "url": "https://github.com/apache/iceberg/pull/1342#discussion_r470836678", "bodyText": "Same here, we could clean these messages up a bit, \"Cannot create new files for a static table\".\nThe actual message is fine, but we try to structure them as \"Cannot\" + (what you tried) + \": \" reason and context.", "author": "rdblue", "createdAt": "2020-08-14T19:53:31Z", "path": "core/src/main/java/org/apache/iceberg/StaticTableOperations.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ *\n+ */\n+\n+package org.apache.iceberg;\n+\n+import java.nio.file.Paths;\n+import org.apache.iceberg.io.FileIO;\n+import org.apache.iceberg.io.LocationProvider;\n+\n+/**\n+ * Representation of an immutable snapshot of Table State that can be used in\n+ * other Iceberg Functions.\n+ */\n+public class StaticTableOperations implements TableOperations {\n+  private final TableMetadata staticMetadata;\n+  private final FileIO io;\n+\n+  /**\n+   * Creates a StaticTableOperations tied to a specific static version of the TableMetadata\n+   */\n+  public StaticTableOperations(String location, FileIO io) {\n+    this.io = io;\n+    this.staticMetadata = TableMetadataParser.read(io, location);\n+  }\n+\n+  @Override\n+  public TableMetadata current() {\n+    return staticMetadata;\n+  }\n+\n+  @Override\n+  public TableMetadata refresh() {\n+    return staticMetadata;\n+  }\n+\n+  @Override\n+  public void commit(TableMetadata base, TableMetadata metadata) {\n+    throw new UnsupportedOperationException(\"This TableOperations is static, it cannot be modified\");\n+  }\n+\n+  @Override\n+  public FileIO io() {\n+    return this.io;\n+  }\n+\n+  @Override\n+  public String metadataFileLocation(String fileName) {\n+    throw new UnsupportedOperationException(\"New files cannot be created in a Static Table Operations\");", "originalCommit": "41ed1f70c5b0d76885f087f3fe3d7aa5f92397ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg2NDgxMA==", "url": "https://github.com/apache/iceberg/pull/1342#discussion_r470864810", "bodyText": "Gonna just switch them all to \"cannot modify\" since this would come up even when deleting files.", "author": "RussellSpitzer", "createdAt": "2020-08-14T21:05:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgzNjY3OA=="}], "type": "inlineReview"}, {"oid": "c2beab7759f02296a9411f2697b949c076ee3090", "url": "https://github.com/apache/iceberg/commit/c2beab7759f02296a9411f2697b949c076ee3090", "message": "Reviewer Comments\n\nCleanup various style mistakes\nSlightly redo logic around parsing MetadataTableNames\nFix test cases which were missing refreshes", "committedDate": "2020-08-14T21:36:40Z", "type": "commit"}]}