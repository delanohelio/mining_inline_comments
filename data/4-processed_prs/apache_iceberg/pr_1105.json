{"pr_number": 1105, "pr_title": "Support DeleteFile in MergingSnapshotProducer", "pr_createdAt": "2020-06-08T18:45:03Z", "pr_url": "https://github.com/apache/iceberg/pull/1105", "timeline": [{"oid": "80650b9ee9526a7adfc670b98117dc0bdc7b0d10", "url": "https://github.com/apache/iceberg/commit/80650b9ee9526a7adfc670b98117dc0bdc7b0d10", "message": "Support DeleteFile in MergingSnapshotProducer.", "committedDate": "2020-06-08T21:10:41Z", "type": "forcePushed"}, {"oid": "c8c1d68f17f0965194517e79ca84b14c53af5b5c", "url": "https://github.com/apache/iceberg/commit/c8c1d68f17f0965194517e79ca84b14c53af5b5c", "message": "Support DeleteFile in MergingSnapshotProducer.", "committedDate": "2020-06-10T15:53:13Z", "type": "commit"}, {"oid": "64f868fae120c076b0a3162de5200758134da330", "url": "https://github.com/apache/iceberg/commit/64f868fae120c076b0a3162de5200758134da330", "message": "Add RowDelta operation to Tables and Transactions.", "committedDate": "2020-06-10T15:53:13Z", "type": "commit"}, {"oid": "eb25080181da91d195d0e9fd401044ce75382c8f", "url": "https://github.com/apache/iceberg/commit/eb25080181da91d195d0e9fd401044ce75382c8f", "message": "Add tests for DeleteFiles with data file operations.", "committedDate": "2020-06-10T15:53:13Z", "type": "commit"}, {"oid": "eb25080181da91d195d0e9fd401044ce75382c8f", "url": "https://github.com/apache/iceberg/commit/eb25080181da91d195d0e9fd401044ce75382c8f", "message": "Add tests for DeleteFiles with data file operations.", "committedDate": "2020-06-10T15:53:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODIzMjg0Mw==", "url": "https://github.com/apache/iceberg/pull/1105#discussion_r438232843", "bodyText": "This is named FileMetadata because DeleteFiles is the public API for deleting data files.", "author": "rdblue", "createdAt": "2020-06-10T15:55:43Z", "path": "core/src/main/java/org/apache/iceberg/FileMetadata.java", "diffHunk": "@@ -0,0 +1,217 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg;\n+\n+import java.nio.ByteBuffer;\n+import java.util.Locale;\n+import java.util.Map;\n+import org.apache.hadoop.fs.FileStatus;\n+import org.apache.iceberg.encryption.EncryptedOutputFile;\n+import org.apache.iceberg.encryption.EncryptionKeyMetadata;\n+import org.apache.iceberg.hadoop.HadoopInputFile;\n+import org.apache.iceberg.io.InputFile;\n+import org.apache.iceberg.relocated.com.google.common.base.Preconditions;\n+import org.apache.iceberg.util.ByteBuffers;\n+\n+class FileMetadata {", "originalCommit": "eb25080181da91d195d0e9fd401044ce75382c8f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDIzNzA0NA==", "url": "https://github.com/apache/iceberg/pull/1105#discussion_r440237044", "bodyText": "Ideally, we would name it DeleteFiles to be consistent with DataFiles but that's not possible. Do we want to move DataFiles into FileMetadata and deprecate it (not now, in the future)?", "author": "aokolnychyi", "createdAt": "2020-06-15T14:56:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODIzMjg0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDIzODY3Mw==", "url": "https://github.com/apache/iceberg/pull/1105#discussion_r440238673", "bodyText": "Then we won't have to use methods from DataFiles here.", "author": "aokolnychyi", "createdAt": "2020-06-15T14:58:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODIzMjg0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUwNDgxNg==", "url": "https://github.com/apache/iceberg/pull/1105#discussion_r440504816", "bodyText": "I don't want to move anything in DataFiles in this commit because it's large enough already. I'm also thinking that this API may evolve further, so it's probably better to hold off on any compatibility breaking changes for now, until we know more about what this is going to look like.", "author": "rdblue", "createdAt": "2020-06-15T23:40:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODIzMjg0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODIzODAwMA==", "url": "https://github.com/apache/iceberg/pull/1105#discussion_r438238000", "bodyText": "Should we detect whether delete and data files are added and change this to append or delete if there are only delete or only data files?", "author": "rdblue", "createdAt": "2020-06-10T16:03:04Z", "path": "core/src/test/java/org/apache/iceberg/TestRowDelta.java", "diffHunk": "@@ -0,0 +1,306 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg;\n+\n+import org.apache.iceberg.ManifestEntry.Status;\n+import org.apache.iceberg.expressions.Expressions;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+public class TestRowDelta extends V2TableTestBase {\n+  @Test\n+  public void testAddDeleteFile() {\n+    table.newRowDelta()\n+        .addRows(FILE_A)\n+        .addDeletes(FILE_A_DELETES)\n+        .addDeletes(FILE_B_DELETES)\n+        .commit();\n+\n+    Snapshot snap = table.currentSnapshot();\n+    Assert.assertEquals(\"Commit should produce sequence number 1\", 1, snap.sequenceNumber());\n+    Assert.assertEquals(\"Last sequence number should be 1\", 1, table.ops().current().lastSequenceNumber());\n+    Assert.assertEquals(\"Delta commit should use operation 'overwrite'\", DataOperations.OVERWRITE, snap.operation());", "originalCommit": "eb25080181da91d195d0e9fd401044ce75382c8f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI2MzE3Mg==", "url": "https://github.com/apache/iceberg/pull/1105#discussion_r440263172", "bodyText": "Seems like a good idea to me.", "author": "aokolnychyi", "createdAt": "2020-06-15T15:32:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODIzODAwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUwNDk3Mw==", "url": "https://github.com/apache/iceberg/pull/1105#discussion_r440504973", "bodyText": "Will do, possibly in a follow-up.", "author": "rdblue", "createdAt": "2020-06-15T23:40:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODIzODAwMA=="}], "type": "inlineReview"}, {"oid": "effe279998c34e62f54dbbb5d1fb8e8df1bda373", "url": "https://github.com/apache/iceberg/commit/effe279998c34e62f54dbbb5d1fb8e8df1bda373", "message": "Reorder methods to fix checkstyle.", "committedDate": "2020-06-10T16:35:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI1NTA0Ng==", "url": "https://github.com/apache/iceberg/pull/1105#discussion_r440255046", "bodyText": "Does it mean I can use the DeleteFiles API to remove delete files now? Currently, that API accepts only data files and locations. Now, we can give a path and this will remove a delete file too. Removing a delete file means adding data back? If that's what we want, will we also allow passing DeleteFile for performance?", "author": "aokolnychyi", "createdAt": "2020-06-15T15:21:25Z", "path": "core/src/main/java/org/apache/iceberg/MergingSnapshotProducer.java", "diffHunk": "@@ -166,41 +125,66 @@ protected void failMissingDeletePaths() {\n   protected void deleteByRowFilter(Expression expr) {\n     this.deleteExpression = expr;\n     filterManager.deleteByRowFilter(expr);\n+    // if a delete file matches the row filter, then it can be deleted because the rows will also be deleted\n+    deleteFilterManager.deleteByRowFilter(expr);\n   }\n \n   /**\n    * Add a partition tuple to drop from the table during the delete phase.\n    */\n   protected void dropPartition(StructLike partition) {\n+    // dropping the data in a partition also drops all deletes in the partition\n     filterManager.dropPartition(partition);\n+    deleteFilterManager.dropPartition(partition);\n   }\n \n   /**\n-   * Add a specific path to be deleted in the new snapshot.\n+   * Add a specific data file to be deleted in the new snapshot.\n    */\n   protected void delete(DataFile file) {\n     filterManager.delete(file);\n   }\n \n+  /**\n+   * Add a specific delete file to be deleted in the new snapshot.\n+   */\n+  protected void delete(DeleteFile file) {\n+    deleteFilterManager.delete(file);\n+  }\n+\n   /**\n    * Add a specific path to be deleted in the new snapshot.\n    */\n   protected void delete(CharSequence path) {\n+    // because this is a location, it may be a data file or a delete file and must be added to both filter managers\n     filterManager.delete(path);\n+    deleteFilterManager.delete(path);", "originalCommit": "effe279998c34e62f54dbbb5d1fb8e8df1bda373", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUwNTY2MQ==", "url": "https://github.com/apache/iceberg/pull/1105#discussion_r440505661", "bodyText": "Good point. I think we should remove this and make it so the older path-based delete only deletes data files. I haven't exposed delete(DeleteFile) through any of the public APIs on purpose for the reason you cite: it would un-delete data.\nI think it is probably better to automatically delete in most circumstances, like removing all deletes where the data files must also be deleted or removing delete files if there are no data files that could match by sequence number.", "author": "rdblue", "createdAt": "2020-06-15T23:43:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI1NTA0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI1ODAyMA==", "url": "https://github.com/apache/iceberg/pull/1105#discussion_r440258020", "bodyText": "Will it be useful to track the number of delete files separately? I find it extremely useful to look at snapshot summaries on large tables as it gives an overview of the current state. Knowing the number of delete files separately from the number of data files seems reasonable and can guide users to perform compactions.", "author": "aokolnychyi", "createdAt": "2020-06-15T15:25:36Z", "path": "core/src/main/java/org/apache/iceberg/MergingSnapshotProducer.java", "diffHunk": "@@ -166,41 +125,66 @@ protected void failMissingDeletePaths() {\n   protected void deleteByRowFilter(Expression expr) {\n     this.deleteExpression = expr;\n     filterManager.deleteByRowFilter(expr);\n+    // if a delete file matches the row filter, then it can be deleted because the rows will also be deleted\n+    deleteFilterManager.deleteByRowFilter(expr);\n   }\n \n   /**\n    * Add a partition tuple to drop from the table during the delete phase.\n    */\n   protected void dropPartition(StructLike partition) {\n+    // dropping the data in a partition also drops all deletes in the partition\n     filterManager.dropPartition(partition);\n+    deleteFilterManager.dropPartition(partition);\n   }\n \n   /**\n-   * Add a specific path to be deleted in the new snapshot.\n+   * Add a specific data file to be deleted in the new snapshot.\n    */\n   protected void delete(DataFile file) {\n     filterManager.delete(file);\n   }\n \n+  /**\n+   * Add a specific delete file to be deleted in the new snapshot.\n+   */\n+  protected void delete(DeleteFile file) {\n+    deleteFilterManager.delete(file);\n+  }\n+\n   /**\n    * Add a specific path to be deleted in the new snapshot.\n    */\n   protected void delete(CharSequence path) {\n+    // because this is a location, it may be a data file or a delete file and must be added to both filter managers\n     filterManager.delete(path);\n+    deleteFilterManager.delete(path);\n   }\n \n   /**\n-   * Add a file to the new snapshot.\n+   * Add a data file to the new snapshot.\n    */\n   protected void add(DataFile file) {\n+    addedFilesSummary.addedFile(spec, file);\n     hasNewFiles = true;\n     newFiles.add(file);\n   }\n \n+  /**\n+   * Add a delete file to the new snapshot.\n+   */\n+  protected void add(DeleteFile file) {\n+    addedFilesSummary.addedFile(spec, file);", "originalCommit": "effe279998c34e62f54dbbb5d1fb8e8df1bda373", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI2MTMzNw==", "url": "https://github.com/apache/iceberg/pull/1105#discussion_r440261337", "bodyText": "Oh, it is actually already taken care of below. Great!", "author": "aokolnychyi", "createdAt": "2020-06-15T15:30:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI1ODAyMA=="}], "type": "inlineReview"}, {"oid": "489b6b9bdbcac4338fb9dfdcd5a6fc0fd4109218", "url": "https://github.com/apache/iceberg/commit/489b6b9bdbcac4338fb9dfdcd5a6fc0fd4109218", "message": "Update MergingSnapshotProducer.java", "committedDate": "2020-06-15T23:45:13Z", "type": "commit"}]}