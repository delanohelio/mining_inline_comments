{"pr_number": 1261, "pr_title": "Spark: [DOC] guide about structured streaming sink for Iceberg", "pr_createdAt": "2020-07-28T00:39:36Z", "pr_url": "https://github.com/apache/iceberg/pull/1261", "timeline": [{"oid": "5235e378b42920c70239e823d3b548546bc4c110", "url": "https://github.com/apache/iceberg/commit/5235e378b42920c70239e823d3b548546bc4c110", "message": "Spark: [DOC] guide about structured streaming sink for Iceberg", "committedDate": "2020-07-28T00:34:16Z", "type": "commit"}, {"oid": "cba54a086110bc17cc18751ef21b0418d383b0f6", "url": "https://github.com/apache/iceberg/commit/cba54a086110bc17cc18751ef21b0418d383b0f6", "message": "Mention supported modes", "committedDate": "2020-07-28T03:28:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTkwNDU4Ng==", "url": "https://github.com/apache/iceberg/pull/1261#discussion_r461904586", "bodyText": "This looks specific to 2.4. Should we have a 3.0 example and a separate 2.4 example like the other sections?\nAn alternative is to create a new page for Spark Streaming and add the docs there. Then we could have a table like the one at the top of the Spark page that explains what is supported in different versions.", "author": "rdblue", "createdAt": "2020-07-28T21:51:11Z", "path": "site/docs/spark.md", "diffHunk": "@@ -520,6 +520,28 @@ data.writeTo(\"prod.db.table\")\n     .createOrReplace()\n ```\n \n+### Writing from streaming query (Structured Streaming)\n+\n+To write values from streaming query to Iceberg table, use `writeStream`:\n+\n+```scala\n+data.writeStream\n+    .format(\"iceberg\")\n+    .outputMode(\"append\")\n+    .option(\"path\", pathToTable)\n+    .option(\"checkpointLocation\", checkpointPath)\n+    .start()", "originalCommit": "cba54a086110bc17cc18751ef21b0418d383b0f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk3ODY4Mg==", "url": "https://github.com/apache/iceberg/pull/1261#discussion_r461978682", "bodyText": "DSv2 still doesn't have table access for streaming. I see TODO in writeTo, but no one works on that. I'm planning to look into it. As of now, this is the only way across Spark versions.", "author": "HeartSaVioR", "createdAt": "2020-07-29T01:05:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTkwNDU4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTkxMjIyMA==", "url": "https://github.com/apache/iceberg/pull/1261#discussion_r461912220", "bodyText": "I think this is worth a section, not just a note.\n\nStreaming queries can create new table versions quickly, which creates lots of table metadata to track those versions. Maintaining metadata by tuning the rate of commits, expiring old snapshots, and automatically cleaning up metadata files is highly recommended.\n\nThen you could give an overview of those options and links to further docs, like the table property docs for delete-after-commit.", "author": "rdblue", "createdAt": "2020-07-28T22:00:41Z", "path": "site/docs/spark.md", "diffHunk": "@@ -520,6 +520,28 @@ data.writeTo(\"prod.db.table\")\n     .createOrReplace()\n ```\n \n+### Writing from streaming query (Structured Streaming)\n+\n+To write values from streaming query to Iceberg table, use `writeStream`:\n+\n+```scala\n+data.writeStream\n+    .format(\"iceberg\")\n+    .outputMode(\"append\")\n+    .option(\"path\", pathToTable)\n+    .option(\"checkpointLocation\", checkpointPath)\n+    .start()\n+```\n+\n+`append` and `complete` modes are supported. The table should be created in prior to start the streaming query.\n+ \n+!!! Note\n+    To avoid metadata growing too huge, there're several guides you may want to follow: ", "originalCommit": "cba54a086110bc17cc18751ef21b0418d383b0f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7f6f21a8d306df21fec1a925d16f2e6497b933f7", "url": "https://github.com/apache/iceberg/commit/7f6f21a8d306df21fec1a925d16f2e6497b933f7", "message": "Separate doc for Spark Structured Streaming", "committedDate": "2020-07-29T13:02:01Z", "type": "forcePushed"}, {"oid": "ca720ec2cec315f9e766a7b634f7cd92e119d514", "url": "https://github.com/apache/iceberg/commit/ca720ec2cec315f9e766a7b634f7cd92e119d514", "message": "Separate doc for Spark Structured Streaming", "committedDate": "2020-07-29T13:04:22Z", "type": "commit"}, {"oid": "ca720ec2cec315f9e766a7b634f7cd92e119d514", "url": "https://github.com/apache/iceberg/commit/ca720ec2cec315f9e766a7b634f7cd92e119d514", "message": "Separate doc for Spark Structured Streaming", "committedDate": "2020-07-29T13:04:22Z", "type": "forcePushed"}, {"oid": "88ea5b437b51ed16e73e8a40bf6039dc59825fc4", "url": "https://github.com/apache/iceberg/commit/88ea5b437b51ed16e73e8a40bf6039dc59825fc4", "message": "Enriching explanations on rewriting manifests/data files, add section on removing orphan files", "committedDate": "2020-07-30T05:09:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAyMDU5NA==", "url": "https://github.com/apache/iceberg/pull/1261#discussion_r463020594", "bodyText": "I just realized I should provide table identifier instead of path in HiveCatalog. I'll update the same.", "author": "HeartSaVioR", "createdAt": "2020-07-30T14:04:35Z", "path": "site/docs/spark-structured-streaming.md", "diffHunk": "@@ -0,0 +1,184 @@\n+<!--\n+ - Licensed to the Apache Software Foundation (ASF) under one or more\n+ - contributor license agreements.  See the NOTICE file distributed with\n+ - this work for additional information regarding copyright ownership.\n+ - The ASF licenses this file to You under the Apache License, Version 2.0\n+ - (the \"License\"); you may not use this file except in compliance with\n+ - the License.  You may obtain a copy of the License at\n+ -\n+ -   http://www.apache.org/licenses/LICENSE-2.0\n+ -\n+ - Unless required by applicable law or agreed to in writing, software\n+ - distributed under the License is distributed on an \"AS IS\" BASIS,\n+ - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ - See the License for the specific language governing permissions and\n+ - limitations under the License.\n+ -->\n+\n+# Spark Structured Streaming\n+\n+Iceberg uses Apache Spark's DataSourceV2 API for data source and catalog implementations. Spark DSv2 is an evolving API\n+with different levels of support in Spark versions.\n+\n+As of Spark 3.0, the new API on reading/writing table on table identifier is not yet added on streaming query.\n+\n+| Feature support                                  | Spark 3.0| Spark 2.4  | Notes                                          |\n+|--------------------------------------------------|----------|------------|------------------------------------------------|\n+| [DataFrame write](#writing-with-streaming-query) | \u2714        | \u2714          |                                                |\n+\n+## Writing with streaming query\n+\n+To write values from streaming query to Iceberg table, use `DataStreamWriter`:\n+\n+```scala\n+data.writeStream\n+    .format(\"iceberg\")\n+    .outputMode(\"append\")\n+    .trigger(Trigger.ProcessingTime(1, TimeUnit.MINUTES))\n+    .option(\"path\", pathToTable)", "originalCommit": "88ea5b437b51ed16e73e8a40bf6039dc59825fc4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMzNjkyOQ==", "url": "https://github.com/apache/iceberg/pull/1261#discussion_r463336929", "bodyText": "It would be great to document what these do:\n\nappend - appends the output of every micro-batch to the table\ncomplete - replaces the table contents every micro-batch", "author": "rdblue", "createdAt": "2020-07-31T00:06:32Z", "path": "site/docs/spark-structured-streaming.md", "diffHunk": "@@ -0,0 +1,184 @@\n+<!--\n+ - Licensed to the Apache Software Foundation (ASF) under one or more\n+ - contributor license agreements.  See the NOTICE file distributed with\n+ - this work for additional information regarding copyright ownership.\n+ - The ASF licenses this file to You under the Apache License, Version 2.0\n+ - (the \"License\"); you may not use this file except in compliance with\n+ - the License.  You may obtain a copy of the License at\n+ -\n+ -   http://www.apache.org/licenses/LICENSE-2.0\n+ -\n+ - Unless required by applicable law or agreed to in writing, software\n+ - distributed under the License is distributed on an \"AS IS\" BASIS,\n+ - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ - See the License for the specific language governing permissions and\n+ - limitations under the License.\n+ -->\n+\n+# Spark Structured Streaming\n+\n+Iceberg uses Apache Spark's DataSourceV2 API for data source and catalog implementations. Spark DSv2 is an evolving API\n+with different levels of support in Spark versions.\n+\n+As of Spark 3.0, the new API on reading/writing table on table identifier is not yet added on streaming query.\n+\n+| Feature support                                  | Spark 3.0| Spark 2.4  | Notes                                          |\n+|--------------------------------------------------|----------|------------|------------------------------------------------|\n+| [DataFrame write](#writing-with-streaming-query) | \u2714        | \u2714          |                                                |\n+\n+## Writing with streaming query\n+\n+To write values from streaming query to Iceberg table, use `DataStreamWriter`:\n+\n+```scala\n+data.writeStream\n+    .format(\"iceberg\")\n+    .outputMode(\"append\")\n+    .trigger(Trigger.ProcessingTime(1, TimeUnit.MINUTES))\n+    .option(\"path\", pathToTable)\n+    .option(\"checkpointLocation\", checkpointPath)\n+    .start()\n+```\n+\n+Iceberg supports below output modes:\n+\n+* append\n+* complete", "originalCommit": "88ea5b437b51ed16e73e8a40bf6039dc59825fc4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMzNzAwMA==", "url": "https://github.com/apache/iceberg/pull/1261#discussion_r463337000", "bodyText": "Should this link to the CREATE TABLE docs on the Spark page?", "author": "rdblue", "createdAt": "2020-07-31T00:06:47Z", "path": "site/docs/spark-structured-streaming.md", "diffHunk": "@@ -0,0 +1,184 @@\n+<!--\n+ - Licensed to the Apache Software Foundation (ASF) under one or more\n+ - contributor license agreements.  See the NOTICE file distributed with\n+ - this work for additional information regarding copyright ownership.\n+ - The ASF licenses this file to You under the Apache License, Version 2.0\n+ - (the \"License\"); you may not use this file except in compliance with\n+ - the License.  You may obtain a copy of the License at\n+ -\n+ -   http://www.apache.org/licenses/LICENSE-2.0\n+ -\n+ - Unless required by applicable law or agreed to in writing, software\n+ - distributed under the License is distributed on an \"AS IS\" BASIS,\n+ - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ - See the License for the specific language governing permissions and\n+ - limitations under the License.\n+ -->\n+\n+# Spark Structured Streaming\n+\n+Iceberg uses Apache Spark's DataSourceV2 API for data source and catalog implementations. Spark DSv2 is an evolving API\n+with different levels of support in Spark versions.\n+\n+As of Spark 3.0, the new API on reading/writing table on table identifier is not yet added on streaming query.\n+\n+| Feature support                                  | Spark 3.0| Spark 2.4  | Notes                                          |\n+|--------------------------------------------------|----------|------------|------------------------------------------------|\n+| [DataFrame write](#writing-with-streaming-query) | \u2714        | \u2714          |                                                |\n+\n+## Writing with streaming query\n+\n+To write values from streaming query to Iceberg table, use `DataStreamWriter`:\n+\n+```scala\n+data.writeStream\n+    .format(\"iceberg\")\n+    .outputMode(\"append\")\n+    .trigger(Trigger.ProcessingTime(1, TimeUnit.MINUTES))\n+    .option(\"path\", pathToTable)\n+    .option(\"checkpointLocation\", checkpointPath)\n+    .start()\n+```\n+\n+Iceberg supports below output modes:\n+\n+* append\n+* complete\n+\n+The table should be created in prior to start the streaming query.", "originalCommit": "88ea5b437b51ed16e73e8a40bf6039dc59825fc4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMzNzI5OQ==", "url": "https://github.com/apache/iceberg/pull/1261#discussion_r463337299", "bodyText": "How is this configured? A link to the relevant Spark docs and a quick summary would be really useful.", "author": "rdblue", "createdAt": "2020-07-31T00:07:58Z", "path": "site/docs/spark-structured-streaming.md", "diffHunk": "@@ -0,0 +1,184 @@\n+<!--\n+ - Licensed to the Apache Software Foundation (ASF) under one or more\n+ - contributor license agreements.  See the NOTICE file distributed with\n+ - this work for additional information regarding copyright ownership.\n+ - The ASF licenses this file to You under the Apache License, Version 2.0\n+ - (the \"License\"); you may not use this file except in compliance with\n+ - the License.  You may obtain a copy of the License at\n+ -\n+ -   http://www.apache.org/licenses/LICENSE-2.0\n+ -\n+ - Unless required by applicable law or agreed to in writing, software\n+ - distributed under the License is distributed on an \"AS IS\" BASIS,\n+ - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ - See the License for the specific language governing permissions and\n+ - limitations under the License.\n+ -->\n+\n+# Spark Structured Streaming\n+\n+Iceberg uses Apache Spark's DataSourceV2 API for data source and catalog implementations. Spark DSv2 is an evolving API\n+with different levels of support in Spark versions.\n+\n+As of Spark 3.0, the new API on reading/writing table on table identifier is not yet added on streaming query.\n+\n+| Feature support                                  | Spark 3.0| Spark 2.4  | Notes                                          |\n+|--------------------------------------------------|----------|------------|------------------------------------------------|\n+| [DataFrame write](#writing-with-streaming-query) | \u2714        | \u2714          |                                                |\n+\n+## Writing with streaming query\n+\n+To write values from streaming query to Iceberg table, use `DataStreamWriter`:\n+\n+```scala\n+data.writeStream\n+    .format(\"iceberg\")\n+    .outputMode(\"append\")\n+    .trigger(Trigger.ProcessingTime(1, TimeUnit.MINUTES))\n+    .option(\"path\", pathToTable)\n+    .option(\"checkpointLocation\", checkpointPath)\n+    .start()\n+```\n+\n+Iceberg supports below output modes:\n+\n+* append\n+* complete\n+\n+The table should be created in prior to start the streaming query.\n+\n+## Maintenance\n+\n+Streaming queries can create new table versions quickly, which creates lots of table metadata to track those versions.\n+Maintaining metadata by tuning the rate of commits, expiring old snapshots, and automatically cleaning up metadata files\n+is highly recommended.\n+\n+### Tune the rate of commits\n+\n+Having high rate of commits would produce lots of data files, manifests, and snapshots which leads the table hard\n+to maintain. We encourage having trigger interval 1 minute at minimum, and increase the interval if you encounter\n+issues.", "originalCommit": "88ea5b437b51ed16e73e8a40bf6039dc59825fc4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM1NDA0Nw==", "url": "https://github.com/apache/iceberg/pull/1261#discussion_r463354047", "bodyText": "It's already in the code example in above - .trigger(Trigger.ProcessingTime(1, TimeUnit.MINUTES)). It's an essential knowledge on structured streaming (and DStream) so I feel linking structured streaming guide doc would be sufficient. Please let me know if we still would like to provide some example for here as well.", "author": "HeartSaVioR", "createdAt": "2020-07-31T01:11:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMzNzI5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA1MzA4NA==", "url": "https://github.com/apache/iceberg/pull/1261#discussion_r466053084", "bodyText": "I agree with @HeartSaVioR that this is essential knowledge on structured streaming. However, if you wanted to add a link to trigger intervals specifically, the latest (kept up to date) link would likely be https://spark.apache.org/docs/latest/structured-streaming-programming-guide.html#triggers", "author": "kbendick", "createdAt": "2020-08-05T23:09:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMzNzI5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA3ODM2Mg==", "url": "https://github.com/apache/iceberg/pull/1261#discussion_r466078362", "bodyText": "Ah yes probably better to pick up anchor. Thanks :)", "author": "HeartSaVioR", "createdAt": "2020-08-06T00:34:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMzNzI5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMzNzM5NQ==", "url": "https://github.com/apache/iceberg/pull/1261#discussion_r463337395", "bodyText": "This applies to all catalogs, not just Hadoop. I think you can simply remove that clause.", "author": "rdblue", "createdAt": "2020-07-31T00:08:20Z", "path": "site/docs/spark-structured-streaming.md", "diffHunk": "@@ -0,0 +1,184 @@\n+<!--\n+ - Licensed to the Apache Software Foundation (ASF) under one or more\n+ - contributor license agreements.  See the NOTICE file distributed with\n+ - this work for additional information regarding copyright ownership.\n+ - The ASF licenses this file to You under the Apache License, Version 2.0\n+ - (the \"License\"); you may not use this file except in compliance with\n+ - the License.  You may obtain a copy of the License at\n+ -\n+ -   http://www.apache.org/licenses/LICENSE-2.0\n+ -\n+ - Unless required by applicable law or agreed to in writing, software\n+ - distributed under the License is distributed on an \"AS IS\" BASIS,\n+ - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ - See the License for the specific language governing permissions and\n+ - limitations under the License.\n+ -->\n+\n+# Spark Structured Streaming\n+\n+Iceberg uses Apache Spark's DataSourceV2 API for data source and catalog implementations. Spark DSv2 is an evolving API\n+with different levels of support in Spark versions.\n+\n+As of Spark 3.0, the new API on reading/writing table on table identifier is not yet added on streaming query.\n+\n+| Feature support                                  | Spark 3.0| Spark 2.4  | Notes                                          |\n+|--------------------------------------------------|----------|------------|------------------------------------------------|\n+| [DataFrame write](#writing-with-streaming-query) | \u2714        | \u2714          |                                                |\n+\n+## Writing with streaming query\n+\n+To write values from streaming query to Iceberg table, use `DataStreamWriter`:\n+\n+```scala\n+data.writeStream\n+    .format(\"iceberg\")\n+    .outputMode(\"append\")\n+    .trigger(Trigger.ProcessingTime(1, TimeUnit.MINUTES))\n+    .option(\"path\", pathToTable)\n+    .option(\"checkpointLocation\", checkpointPath)\n+    .start()\n+```\n+\n+Iceberg supports below output modes:\n+\n+* append\n+* complete\n+\n+The table should be created in prior to start the streaming query.\n+\n+## Maintenance\n+\n+Streaming queries can create new table versions quickly, which creates lots of table metadata to track those versions.\n+Maintaining metadata by tuning the rate of commits, expiring old snapshots, and automatically cleaning up metadata files\n+is highly recommended.\n+\n+### Tune the rate of commits\n+\n+Having high rate of commits would produce lots of data files, manifests, and snapshots which leads the table hard\n+to maintain. We encourage having trigger interval 1 minute at minimum, and increase the interval if you encounter\n+issues.\n+\n+### Retain recent metadata files in Hadoop catalog\n+\n+If you are using HadoopCatalog, you may want to enable `write.metadata.delete-after-commit.enabled` in the table", "originalCommit": "88ea5b437b51ed16e73e8a40bf6039dc59825fc4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM1MDMxMQ==", "url": "https://github.com/apache/iceberg/pull/1261#discussion_r463350311", "bodyText": "If I understand correctly, this option is cleaning up vXXXXX.metadata.json files, which doesn't seem to be in Hive catalog based metadata directory, because it is not needed - it only retains the latest one in Hive table information. I'm still learning, so please let me know if I'm missing something.", "author": "HeartSaVioR", "createdAt": "2020-07-31T00:56:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMzNzM5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDA2MzQwMQ==", "url": "https://github.com/apache/iceberg/pull/1261#discussion_r464063401", "bodyText": "Somehow I need to look into details on Hive catalog, and realized I was wrong. It still creates the metadata file per version. I'll reflect the comment. Thanks for correcting me.", "author": "HeartSaVioR", "createdAt": "2020-08-02T11:02:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMzNzM5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMzODQ3OA==", "url": "https://github.com/apache/iceberg/pull/1261#discussion_r463338478", "bodyText": "How about \"Removed old metadata files\"? That matches the wording used for \"Expire old snapshots\".\nAlso, we should probably make these recommendations in order of importance, which would mean putting the expire snapshots section first. Those keep a lot more metadata and affect table performance; these don't affect table performance and are smaller if you clean up snapshots.", "author": "rdblue", "createdAt": "2020-07-31T00:12:17Z", "path": "site/docs/spark-structured-streaming.md", "diffHunk": "@@ -0,0 +1,184 @@\n+<!--\n+ - Licensed to the Apache Software Foundation (ASF) under one or more\n+ - contributor license agreements.  See the NOTICE file distributed with\n+ - this work for additional information regarding copyright ownership.\n+ - The ASF licenses this file to You under the Apache License, Version 2.0\n+ - (the \"License\"); you may not use this file except in compliance with\n+ - the License.  You may obtain a copy of the License at\n+ -\n+ -   http://www.apache.org/licenses/LICENSE-2.0\n+ -\n+ - Unless required by applicable law or agreed to in writing, software\n+ - distributed under the License is distributed on an \"AS IS\" BASIS,\n+ - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ - See the License for the specific language governing permissions and\n+ - limitations under the License.\n+ -->\n+\n+# Spark Structured Streaming\n+\n+Iceberg uses Apache Spark's DataSourceV2 API for data source and catalog implementations. Spark DSv2 is an evolving API\n+with different levels of support in Spark versions.\n+\n+As of Spark 3.0, the new API on reading/writing table on table identifier is not yet added on streaming query.\n+\n+| Feature support                                  | Spark 3.0| Spark 2.4  | Notes                                          |\n+|--------------------------------------------------|----------|------------|------------------------------------------------|\n+| [DataFrame write](#writing-with-streaming-query) | \u2714        | \u2714          |                                                |\n+\n+## Writing with streaming query\n+\n+To write values from streaming query to Iceberg table, use `DataStreamWriter`:\n+\n+```scala\n+data.writeStream\n+    .format(\"iceberg\")\n+    .outputMode(\"append\")\n+    .trigger(Trigger.ProcessingTime(1, TimeUnit.MINUTES))\n+    .option(\"path\", pathToTable)\n+    .option(\"checkpointLocation\", checkpointPath)\n+    .start()\n+```\n+\n+Iceberg supports below output modes:\n+\n+* append\n+* complete\n+\n+The table should be created in prior to start the streaming query.\n+\n+## Maintenance\n+\n+Streaming queries can create new table versions quickly, which creates lots of table metadata to track those versions.\n+Maintaining metadata by tuning the rate of commits, expiring old snapshots, and automatically cleaning up metadata files\n+is highly recommended.\n+\n+### Tune the rate of commits\n+\n+Having high rate of commits would produce lots of data files, manifests, and snapshots which leads the table hard\n+to maintain. We encourage having trigger interval 1 minute at minimum, and increase the interval if you encounter\n+issues.\n+\n+### Retain recent metadata files in Hadoop catalog", "originalCommit": "88ea5b437b51ed16e73e8a40bf6039dc59825fc4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMzOTM0MQ==", "url": "https://github.com/apache/iceberg/pull/1261#discussion_r463339341", "bodyText": "How about \"Run expireSnapshots regularly to prune . . .\"?\nThat's more direct and avoids the natural question \"When may I not want to do this?\" Since the answer is you always want to clean snapshots, being direct is more clear.", "author": "rdblue", "createdAt": "2020-07-31T00:15:37Z", "path": "site/docs/spark-structured-streaming.md", "diffHunk": "@@ -0,0 +1,184 @@\n+<!--\n+ - Licensed to the Apache Software Foundation (ASF) under one or more\n+ - contributor license agreements.  See the NOTICE file distributed with\n+ - this work for additional information regarding copyright ownership.\n+ - The ASF licenses this file to You under the Apache License, Version 2.0\n+ - (the \"License\"); you may not use this file except in compliance with\n+ - the License.  You may obtain a copy of the License at\n+ -\n+ -   http://www.apache.org/licenses/LICENSE-2.0\n+ -\n+ - Unless required by applicable law or agreed to in writing, software\n+ - distributed under the License is distributed on an \"AS IS\" BASIS,\n+ - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ - See the License for the specific language governing permissions and\n+ - limitations under the License.\n+ -->\n+\n+# Spark Structured Streaming\n+\n+Iceberg uses Apache Spark's DataSourceV2 API for data source and catalog implementations. Spark DSv2 is an evolving API\n+with different levels of support in Spark versions.\n+\n+As of Spark 3.0, the new API on reading/writing table on table identifier is not yet added on streaming query.\n+\n+| Feature support                                  | Spark 3.0| Spark 2.4  | Notes                                          |\n+|--------------------------------------------------|----------|------------|------------------------------------------------|\n+| [DataFrame write](#writing-with-streaming-query) | \u2714        | \u2714          |                                                |\n+\n+## Writing with streaming query\n+\n+To write values from streaming query to Iceberg table, use `DataStreamWriter`:\n+\n+```scala\n+data.writeStream\n+    .format(\"iceberg\")\n+    .outputMode(\"append\")\n+    .trigger(Trigger.ProcessingTime(1, TimeUnit.MINUTES))\n+    .option(\"path\", pathToTable)\n+    .option(\"checkpointLocation\", checkpointPath)\n+    .start()\n+```\n+\n+Iceberg supports below output modes:\n+\n+* append\n+* complete\n+\n+The table should be created in prior to start the streaming query.\n+\n+## Maintenance\n+\n+Streaming queries can create new table versions quickly, which creates lots of table metadata to track those versions.\n+Maintaining metadata by tuning the rate of commits, expiring old snapshots, and automatically cleaning up metadata files\n+is highly recommended.\n+\n+### Tune the rate of commits\n+\n+Having high rate of commits would produce lots of data files, manifests, and snapshots which leads the table hard\n+to maintain. We encourage having trigger interval 1 minute at minimum, and increase the interval if you encounter\n+issues.\n+\n+### Retain recent metadata files in Hadoop catalog\n+\n+If you are using HadoopCatalog, you may want to enable `write.metadata.delete-after-commit.enabled` in the table\n+properties, and reduce `write.metadata.previous-versions-max` as well (if necessary) to retain only specific number of\n+metadata files.\n+\n+Please refer the [table write properties](/configuration/#write-properties) for more details.\n+\n+### Expire old snapshots\n+\n+You may want to run [expireSnapshots()](/javadoc/master/org/apache/iceberg/Table.html#expireSnapshots--) periodically", "originalCommit": "88ea5b437b51ed16e73e8a40bf6039dc59825fc4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7c4ad10dcbbba129c3f72bfa0529fb28673cbbbf", "url": "https://github.com/apache/iceberg/commit/7c4ad10dcbbba129c3f72bfa0529fb28673cbbbf", "message": "Reflect review comments", "committedDate": "2020-07-31T01:14:07Z", "type": "commit"}, {"oid": "ffb2ca64b5e7b8339abeb1691c816c5180eb4693", "url": "https://github.com/apache/iceberg/commit/ffb2ca64b5e7b8339abeb1691c816c5180eb4693", "message": "Fix for Hive catalog", "committedDate": "2020-07-31T04:47:39Z", "type": "commit"}, {"oid": "bccbd62cfe3649da5a1b73a4c0b04690d7206121", "url": "https://github.com/apache/iceberg/commit/bccbd62cfe3649da5a1b73a4c0b04690d7206121", "message": "Fix", "committedDate": "2020-08-02T11:08:07Z", "type": "commit"}, {"oid": "396530d97fc4f38592f66c307957ce95da374ba7", "url": "https://github.com/apache/iceberg/commit/396530d97fc4f38592f66c307957ce95da374ba7", "message": "Reflect review comment", "committedDate": "2020-08-06T00:55:00Z", "type": "commit"}, {"oid": "1da21c58a52d74e57d79295cab4303c6c473e57a", "url": "https://github.com/apache/iceberg/commit/1da21c58a52d74e57d79295cab4303c6c473e57a", "message": "Separate maintenance content into a maintenance doc.", "committedDate": "2020-08-25T22:40:11Z", "type": "commit"}, {"oid": "39ac0225430a64bb229b96b01bc7013375c694cb", "url": "https://github.com/apache/iceberg/commit/39ac0225430a64bb229b96b01bc7013375c694cb", "message": "Add missing file.", "committedDate": "2020-08-25T23:51:02Z", "type": "commit"}, {"oid": "8a6ae5dd8abaf5cfcbced40871f0859dfe7f41d9", "url": "https://github.com/apache/iceberg/commit/8a6ae5dd8abaf5cfcbced40871f0859dfe7f41d9", "message": "Merge pull request #1 from rdblue/pr-1261-structured-streaming-docs\n\nSeparate maintenance content into a maintenance doc.", "committedDate": "2020-08-26T00:07:39Z", "type": "commit"}, {"oid": "d9f30f6e04cdd0fc9f0bdb7c805eb98bb4614def", "url": "https://github.com/apache/iceberg/commit/d9f30f6e04cdd0fc9f0bdb7c805eb98bb4614def", "message": "fix nit", "committedDate": "2020-08-26T00:22:13Z", "type": "commit"}]}