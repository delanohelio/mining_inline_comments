{"pr_number": 1399, "pr_title": "Spark: Follow name mapping when importing ORC tables", "pr_createdAt": "2020-08-29T00:24:47Z", "pr_url": "https://github.com/apache/iceberg/pull/1399", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU5NjM3Nw==", "url": "https://github.com/apache/iceberg/pull/1399#discussion_r487596377", "bodyText": "I think we should change to use a name mapping by default in a separate PR. For now, let's just support a name mapping when importing ORC data.\nMy rationale is that I think the two are independently useful. Someone might want to change the default, but not cherry-pick ORC changes. Similarly, someone might want to use a name mapping with ORC, but not want to default to name mapping.\nAlso, I think that we would want to default to name mapping slightly differently. It doesn't make sense to me to create a temporary mapping that is used for metrics here, unless that mapping is also used to read the data. So I would prefer to update tables when importing and add a mapping to table metadata by default, if it is not already there.", "author": "rdblue", "createdAt": "2020-09-14T00:10:24Z", "path": "spark/src/main/java/org/apache/iceberg/spark/SparkTableUtil.java", "diffHunk": "@@ -540,7 +541,8 @@ private static void importUnpartitionedSparkTable(\n       Configuration conf = spark.sessionState().newHadoopConf();\n       MetricsConfig metricsConfig = MetricsConfig.fromProperties(targetTable.properties());\n       String nameMappingString = targetTable.properties().get(TableProperties.DEFAULT_NAME_MAPPING);\n-      NameMapping nameMapping = nameMappingString != null ? NameMappingParser.fromJson(nameMappingString) : null;\n+      NameMapping nameMapping = nameMappingString != null ?\n+          NameMappingParser.fromJson(nameMappingString) : MappingUtil.create(targetTable.schema());", "originalCommit": "33433398940c3a60ba36b215b4b4063e8b41741f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzYwMTAwMQ==", "url": "https://github.com/apache/iceberg/pull/1399#discussion_r487601001", "bodyText": "While there are a lot of changes in this test, can you also move this to iceberg-spark instead of iceberg-spark2? I think it is in spark2 by accident, and moving it in IntelliJ produces no warnings. That way this also runs in the Java 11 test profile.", "author": "rdblue", "createdAt": "2020-09-14T00:46:00Z", "path": "spark2/src/test/java/org/apache/iceberg/spark/source/TestSparkTableUtil.java", "diffHunk": "@@ -47,32 +47,31 @@\n import org.junit.After;\n import org.junit.AfterClass;\n import org.junit.Assert;\n+import org.junit.Assume;\n import org.junit.Before;\n import org.junit.BeforeClass;\n import org.junit.Rule;\n import org.junit.Test;\n+import org.junit.experimental.runners.Enclosed;\n import org.junit.rules.TemporaryFolder;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.Parameterized;\n \n import static org.apache.iceberg.TableProperties.DEFAULT_NAME_MAPPING;\n import static org.apache.iceberg.TableProperties.PARQUET_VECTORIZATION_ENABLED;\n import static org.apache.iceberg.types.Types.NestedField.optional;\n \n+@RunWith(Enclosed.class)", "originalCommit": "33433398940c3a60ba36b215b4b4063e8b41741f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYwMDcxMw==", "url": "https://github.com/apache/iceberg/pull/1399#discussion_r494600713", "bodyText": "I agree. I could work on another PR with that change, I was wondering if that'd minimize the diff in this PR and make it more clear. Thanks!", "author": "edgarRd", "createdAt": "2020-09-24T20:46:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzYwMTAwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwODYyMA==", "url": "https://github.com/apache/iceberg/pull/1399#discussion_r495208620", "bodyText": "Yeah, that's fine with me.", "author": "rdblue", "createdAt": "2020-09-25T20:11:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzYwMTAwMQ=="}], "type": "inlineReview"}, {"oid": "573db27f83264bc45ad9ffe359987271a508449b", "url": "https://github.com/apache/iceberg/commit/573db27f83264bc45ad9ffe359987271a508449b", "message": "Parameterize TestSparkTableUtil tests", "committedDate": "2020-09-24T19:27:57Z", "type": "commit"}, {"oid": "09e7ee87665e662d6d476fb9efc4d8be9bc8fe0d", "url": "https://github.com/apache/iceberg/commit/09e7ee87665e662d6d476fb9efc4d8be9bc8fe0d", "message": "ORC: Add name mapping on import", "committedDate": "2020-09-24T19:27:58Z", "type": "commit"}, {"oid": "b9a9c4ec5bca134cdc730655be674d2022664bce", "url": "https://github.com/apache/iceberg/commit/b9a9c4ec5bca134cdc730655be674d2022664bce", "message": "Do not apply default name mapping on table import", "committedDate": "2020-09-24T20:09:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIxMTUxOQ==", "url": "https://github.com/apache/iceberg/pull/1399#discussion_r495211519", "bodyText": "This change needs to be reverted. The import process must create and store a mapping on the table. We should not use an ephemeral mapping that is immediately discarded.", "author": "rdblue", "createdAt": "2020-09-25T20:18:45Z", "path": "spark/src/main/java/org/apache/iceberg/spark/SparkTableUtil.java", "diffHunk": "@@ -573,7 +574,8 @@ public static void importSparkPartitions(\n     int numShufflePartitions = spark.sessionState().conf().numShufflePartitions();\n     MetricsConfig metricsConfig = MetricsConfig.fromProperties(targetTable.properties());\n     String nameMappingString = targetTable.properties().get(TableProperties.DEFAULT_NAME_MAPPING);\n-    NameMapping nameMapping = nameMappingString != null ? NameMappingParser.fromJson(nameMappingString) : null;\n+    NameMapping nameMapping = nameMappingString != null ?\n+        NameMappingParser.fromJson(nameMappingString) : MappingUtil.create(targetTable.schema());", "originalCommit": "b9a9c4ec5bca134cdc730655be674d2022664bce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTI1MTU4Mw==", "url": "https://github.com/apache/iceberg/pull/1399#discussion_r495251583", "bodyText": "Yeah, somehow I missed this one but did it for the method of unpartitioned tables. Thanks for pointing this out. I've reverted the change.", "author": "edgarRd", "createdAt": "2020-09-25T21:38:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIxMTUxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTI2OTQwNQ==", "url": "https://github.com/apache/iceberg/pull/1399#discussion_r495269405", "bodyText": "That explains it. I thought that you were going to, so I was surprised.", "author": "rdblue", "createdAt": "2020-09-25T22:05:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIxMTUxOQ=="}], "type": "inlineReview"}, {"oid": "2b6e369ec14bcae1c3d65a99663c982a8df372d7", "url": "https://github.com/apache/iceberg/commit/2b6e369ec14bcae1c3d65a99663c982a8df372d7", "message": "Do not apply default name mapping on table import", "committedDate": "2020-09-25T21:36:00Z", "type": "forcePushed"}, {"oid": "0304058d8e113c5d41926449203dc83fb24c1e2a", "url": "https://github.com/apache/iceberg/commit/0304058d8e113c5d41926449203dc83fb24c1e2a", "message": "Do not apply default name mapping on table import", "committedDate": "2020-09-25T21:43:28Z", "type": "commit"}, {"oid": "0304058d8e113c5d41926449203dc83fb24c1e2a", "url": "https://github.com/apache/iceberg/commit/0304058d8e113c5d41926449203dc83fb24c1e2a", "message": "Do not apply default name mapping on table import", "committedDate": "2020-09-25T21:43:28Z", "type": "forcePushed"}]}