{"pr_number": 1353, "pr_title": "Core: check that project schema and selected columns cannot be specified at the same time", "pr_createdAt": "2020-08-18T02:29:43Z", "pr_url": "https://github.com/apache/iceberg/pull/1353", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU1MDE4Nw==", "url": "https://github.com/apache/iceberg/pull/1353#discussion_r472550187", "bodyText": "We would normally use a Precondition check here:\nPreconditions.checkState(context.selectedColumns() == null, \"Cannot ...\");\nI was also going to say that I think we should check the reverse as well, in case project is called before select, but it looks like the projection is tracked outside of the context for some reason. I don't think that's quite right. We probably want to move project to the context as well.\n@edgarRd, do you know why project doesn't use the scan context?", "author": "rdblue", "createdAt": "2020-08-18T23:33:14Z", "path": "core/src/main/java/org/apache/iceberg/BaseTableScan.java", "diffHunk": "@@ -159,6 +159,10 @@ public TableScan option(String property, String value) {\n \n   @Override\n   public TableScan project(Schema projectedSchema) {\n+    if (context.selectedColumns() != null) {\n+      throw new IllegalStateException(\"Cannot project schema when selected columns is specified.\");\n+    }", "originalCommit": "ef53511af73cd0cf317658242fc4564e01acbbc8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY2MTcxNg==", "url": "https://github.com/apache/iceberg/pull/1353#discussion_r472661716", "bodyText": "Another thing is: BaseTableScan.lazyColumnProjection looks only work for DataTableScan. Because other table scan like MetadataTableScan, the file/expected scan schema is different from table.schema(). But in BaseTableScan.lazyColumnProjection, it use table.schema() to select. And for rowFilter, it looks only works for DataTableScan selection, should not affect MetadataTableScans selection.\nWe may need to implement different selections for various scans.", "author": "JingsongLi", "createdAt": "2020-08-19T04:03:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU1MDE4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIxNDUwOQ==", "url": "https://github.com/apache/iceberg/pull/1353#discussion_r473214509", "bodyText": "This was the idea on not putting schema in the context: #1115 (comment) - I guess it could be part of the context, it would need to be initialized and in this case another context would need to be created with the new schema from the projection.", "author": "edgarRd", "createdAt": "2020-08-19T17:47:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU1MDE4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ0OTM0MQ==", "url": "https://github.com/apache/iceberg/pull/1353#discussion_r473449341", "bodyText": "Thanks @edgarRd! I think it makes sense to move that into the context and initialize it as null. If the projection is null, then use the column list. If not, then use the projection. And then both methods can validate that the other has not been called.\nI think it would be okay to do this even if it only works for DataTableScan. If the other scans don't support it, then they should throw exceptions instead of allowing the projection to be set.", "author": "rdblue", "createdAt": "2020-08-19T23:54:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU1MDE4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzUxMTkzNg==", "url": "https://github.com/apache/iceberg/pull/1353#discussion_r473511936", "bodyText": "Yeah, that makes sense, @rdblue. Should we have another PR for that change?", "author": "edgarRd", "createdAt": "2020-08-20T01:30:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU1MDE4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU2OTM4Mg==", "url": "https://github.com/apache/iceberg/pull/1353#discussion_r473569382", "bodyText": "Hi @edgarRd , If you don't mind, I think I can finish it in this PR.", "author": "JingsongLi", "createdAt": "2020-08-20T03:42:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU1MDE4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjYxNDgzNA==", "url": "https://github.com/apache/iceberg/pull/1353#discussion_r482614834", "bodyText": "Nit: should be Cannot select columns when projection schema is set, and you can omit the ending .", "author": "rdblue", "createdAt": "2020-09-03T00:25:14Z", "path": "core/src/main/java/org/apache/iceberg/TableScanContext.java", "diffHunk": "@@ -107,16 +112,27 @@ boolean returnColumnStats() {\n \n   TableScanContext shouldReturnColumnStats(boolean returnColumnStats) {\n     return new TableScanContext(snapshotId, rowFilter, ignoreResiduals,\n-        caseSensitive, returnColumnStats, selectedColumns, options, fromSnapshotId, toSnapshotId);\n+        caseSensitive, returnColumnStats, projectedSchema, selectedColumns, options, fromSnapshotId, toSnapshotId);\n   }\n \n   Collection<String> selectedColumns() {\n     return selectedColumns;\n   }\n \n   TableScanContext selectColumns(Collection<String> columns) {\n+    Preconditions.checkState(projectedSchema == null, \"Cannot selected columns when project schema is specified.\");", "originalCommit": "a08cb105f0f9a0d8596ad71480c17643ced5657a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjYxNTAzOA==", "url": "https://github.com/apache/iceberg/pull/1353#discussion_r482615038", "bodyText": "How about Cannot set projection schema when columns are selected", "author": "rdblue", "createdAt": "2020-09-03T00:26:00Z", "path": "core/src/main/java/org/apache/iceberg/TableScanContext.java", "diffHunk": "@@ -107,16 +112,27 @@ boolean returnColumnStats() {\n \n   TableScanContext shouldReturnColumnStats(boolean returnColumnStats) {\n     return new TableScanContext(snapshotId, rowFilter, ignoreResiduals,\n-        caseSensitive, returnColumnStats, selectedColumns, options, fromSnapshotId, toSnapshotId);\n+        caseSensitive, returnColumnStats, projectedSchema, selectedColumns, options, fromSnapshotId, toSnapshotId);\n   }\n \n   Collection<String> selectedColumns() {\n     return selectedColumns;\n   }\n \n   TableScanContext selectColumns(Collection<String> columns) {\n+    Preconditions.checkState(projectedSchema == null, \"Cannot selected columns when project schema is specified.\");\n     return new TableScanContext(snapshotId, rowFilter, ignoreResiduals,\n-        caseSensitive, colStats, columns, options, fromSnapshotId, toSnapshotId);\n+        caseSensitive, colStats, null, columns, options, fromSnapshotId, toSnapshotId);\n+  }\n+\n+  Schema projectedSchema() {\n+    return projectedSchema;\n+  }\n+\n+  TableScanContext project(Schema schema) {\n+    Preconditions.checkState(selectedColumns == null, \"Cannot project schema when selected columns is specified.\");", "originalCommit": "a08cb105f0f9a0d8596ad71480c17643ced5657a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjYxNjA5Mw==", "url": "https://github.com/apache/iceberg/pull/1353#discussion_r482616093", "bodyText": "I don't understand why select only works for data table scans. I updated this method to use the schema that is passed into the constructor and all Iceberg tests pass. By updating this to use the schema passed in instead of the table schema, we can support either project or select, depending on what the caller chooses.\nThen we can remove the overrides that throw UnsupportedOperationException.", "author": "rdblue", "createdAt": "2020-09-03T00:29:43Z", "path": "core/src/main/java/org/apache/iceberg/BaseTableScan.java", "diffHunk": "@@ -284,6 +284,8 @@ public String toString() {\n   private Schema lazyColumnProjection() {\n     Collection<String> selectedColumns = context.selectedColumns();\n     if (selectedColumns != null) {\n+      // select columns only works for data table scans, so it is OK to select on table.schema().\n+", "originalCommit": "a08cb105f0f9a0d8596ad71480c17643ced5657a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY4MjkxNg==", "url": "https://github.com/apache/iceberg/pull/1353#discussion_r482682916", "bodyText": "The problem is on rowFilter.\nIIUC, rowFilter is based on table data for every scans, so:\n\nif it is data table scan, we should add the field ids of rowFilter to requiredFieldIds.\nif it is not data table scan, we should not, because the schema not contains fields of rowFilter.", "author": "JingsongLi", "createdAt": "2020-09-03T03:35:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjYxNjA5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY5MjI5NA==", "url": "https://github.com/apache/iceberg/pull/1353#discussion_r482692294", "bodyText": "I add a isDataTableScan abstract method in BaseTableScan.", "author": "JingsongLi", "createdAt": "2020-09-03T04:12:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjYxNjA5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjYxNjI2NQ==", "url": "https://github.com/apache/iceberg/pull/1353#discussion_r482616265", "bodyText": "Nit: I find this more readable if the blank line is before the else to distinguish between the previous block and the else case.", "author": "rdblue", "createdAt": "2020-09-03T00:30:18Z", "path": "core/src/main/java/org/apache/iceberg/BaseTableScan.java", "diffHunk": "@@ -301,6 +303,9 @@ private Schema lazyColumnProjection() {\n       requiredFieldIds.addAll(selectedIds);\n \n       return TypeUtil.select(table.schema(), requiredFieldIds);\n+    } else if (context.projectedSchema() != null) {\n+\n+      return context.projectedSchema();", "originalCommit": "a08cb105f0f9a0d8596ad71480c17643ced5657a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ceb2c4083dc8c0db6e9e022f344d67cca88b2639", "url": "https://github.com/apache/iceberg/commit/ceb2c4083dc8c0db6e9e022f344d67cca88b2639", "message": "Core: check that cannot project schema when selected columns is specified", "committedDate": "2020-09-03T04:06:48Z", "type": "commit"}, {"oid": "9857a492d9f0d1a72657f4682c31a0700c83ab2d", "url": "https://github.com/apache/iceberg/commit/9857a492d9f0d1a72657f4682c31a0700c83ab2d", "message": "Address comments", "committedDate": "2020-09-03T04:06:48Z", "type": "commit"}, {"oid": "70f76bb73ae362244730e0cbec993d9210c46d1d", "url": "https://github.com/apache/iceberg/commit/70f76bb73ae362244730e0cbec993d9210c46d1d", "message": "Address comments", "committedDate": "2020-09-03T04:06:48Z", "type": "commit"}, {"oid": "70f76bb73ae362244730e0cbec993d9210c46d1d", "url": "https://github.com/apache/iceberg/commit/70f76bb73ae362244730e0cbec993d9210c46d1d", "message": "Address comments", "committedDate": "2020-09-03T04:06:48Z", "type": "forcePushed"}, {"oid": "5011fbf8a1e7586b6a6632f845175597faf429e4", "url": "https://github.com/apache/iceberg/commit/5011fbf8a1e7586b6a6632f845175597faf429e4", "message": "Add comments", "committedDate": "2020-09-03T04:11:53Z", "type": "commit"}, {"oid": "1bc6137db8a1fa7db1d798b7051cf39b48ae90df", "url": "https://github.com/apache/iceberg/commit/1bc6137db8a1fa7db1d798b7051cf39b48ae90df", "message": "Minor", "committedDate": "2020-09-03T05:52:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA1ODQ5Mg==", "url": "https://github.com/apache/iceberg/pull/1353#discussion_r483058492", "bodyText": "I'm not sure I understand why this is added. Shouldn't the filter (which is unbound) be bound to the scan's schema and not the underlying table's schema?", "author": "rdblue", "createdAt": "2020-09-03T15:17:44Z", "path": "core/src/main/java/org/apache/iceberg/BaseTableScan.java", "diffHunk": "@@ -106,6 +106,14 @@ protected abstract TableScan newRefinedScan(\n       TableOperations ops, Snapshot snapshot, Expression rowFilter,\n       boolean ignoreResiduals, boolean caseSensitive, boolean colStats);\n \n+  /**\n+   * The {@link #filter(Expression)} is based on the table records. So the data table scan need select all of the\n+   * filter columns, other scans don't need to.\n+   */\n+  protected boolean isDataTableScan() {", "originalCommit": "1bc6137db8a1fa7db1d798b7051cf39b48ae90df", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA1ODk5MA==", "url": "https://github.com/apache/iceberg/pull/1353#discussion_r483058990", "bodyText": "Why not do this for all table scans?", "author": "rdblue", "createdAt": "2020-09-03T15:18:17Z", "path": "core/src/main/java/org/apache/iceberg/BaseTableScan.java", "diffHunk": "@@ -286,21 +294,26 @@ private Schema lazyColumnProjection() {\n     if (selectedColumns != null) {\n       Set<Integer> requiredFieldIds = Sets.newHashSet();\n \n-      // all of the filter columns are required\n-      requiredFieldIds.addAll(\n-          Binder.boundReferences(table.schema().asStruct(),\n-              Collections.singletonList(context.rowFilter()), context.caseSensitive()));\n+      if (isDataTableScan()) {", "originalCommit": "1bc6137db8a1fa7db1d798b7051cf39b48ae90df", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2407ed78c1b585886a3fdf3d5cdb42e0d8669050", "url": "https://github.com/apache/iceberg/commit/2407ed78c1b585886a3fdf3d5cdb42e0d8669050", "message": "Address comments", "committedDate": "2020-09-04T02:39:18Z", "type": "commit"}]}