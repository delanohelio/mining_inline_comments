{"pr_number": 1742, "pr_title": "Fix decimal scale issue in predicate literals", "pr_createdAt": "2020-11-09T17:21:22Z", "pr_url": "https://github.com/apache/iceberg/pull/1742", "timeline": [{"oid": "fcf2fccafafd27696a8de6dc252d7ed19acfd467", "url": "https://github.com/apache/iceberg/commit/fcf2fccafafd27696a8de6dc252d7ed19acfd467", "message": "Fix decimal scale issue in predicate literals", "committedDate": "2020-11-09T17:13:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE5NzU2OQ==", "url": "https://github.com/apache/iceberg/pull/1742#discussion_r520197569", "bodyText": "Why was this removed?", "author": "rdblue", "createdAt": "2020-11-09T23:58:14Z", "path": "api/src/test/java/org/apache/iceberg/expressions/TestMiscLiteralConversions.java", "diffHunk": "@@ -231,7 +231,6 @@ public void testInvalidDecimalConversions() {\n         Types.TimeType.get(),\n         Types.TimestampType.withZone(),\n         Types.TimestampType.withoutZone(),\n-        Types.DecimalType.of(9, 4),", "originalCommit": "fcf2fccafafd27696a8de6dc252d7ed19acfd467", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQ0OTI3Mw==", "url": "https://github.com/apache/iceberg/pull/1742#discussion_r520449273", "bodyText": "Because it's no longer an invalid conversion to call DecimalLiteral.to() on a decimal which has a scale of 2 to convert to another decimal which has a scale of 4 (i.e. it will no longer give back a null)", "author": "marton-bod", "createdAt": "2020-11-10T10:21:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE5NzU2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk2MzM4NQ==", "url": "https://github.com/apache/iceberg/pull/1742#discussion_r520963385", "bodyText": "Right, it is no longer invalid.", "author": "rdblue", "createdAt": "2020-11-11T00:37:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE5NzU2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE5NzY4NQ==", "url": "https://github.com/apache/iceberg/pull/1742#discussion_r520197685", "bodyText": "Nit: indentation is off. It should be 2 indents (4 spaces) for continuation indents.", "author": "rdblue", "createdAt": "2020-11-09T23:58:38Z", "path": "api/src/test/java/org/apache/iceberg/expressions/TestNumericLiteralConversions.java", "diffHunk": "@@ -153,17 +154,12 @@ public void testDoubleToDecimalConversion() {\n   public void testDecimalToDecimalConversion() {\n     Literal<BigDecimal> lit = Literal.of(new BigDecimal(\"34.11\"));\n \n-    Assert.assertSame(\"Should return identical object when converting to same scale\",\n-        lit, lit.to(Types.DecimalType.of(9, 2)));\n-    Assert.assertSame(\"Should return identical object when converting to same scale\",\n-        lit, lit.to(Types.DecimalType.of(11, 2)));\n-\n-    Assert.assertNull(\"Changing decimal scale is not allowed\",\n-        lit.to(Types.DecimalType.of(9, 0)));\n-    Assert.assertNull(\"Changing decimal scale is not allowed\",\n-        lit.to(Types.DecimalType.of(9, 1)));\n-    Assert.assertNull(\"Changing decimal scale is not allowed\",\n-        lit.to(Types.DecimalType.of(9, 3)));\n+    IntStream.range(0, 10).forEach(scale -> {\n+      Assert.assertSame(\"Should return identical object\",\n+              lit, lit.to(Types.DecimalType.of(9, scale)));", "originalCommit": "fcf2fccafafd27696a8de6dc252d7ed19acfd467", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQ0NzU3MA==", "url": "https://github.com/apache/iceberg/pull/1742#discussion_r520447570", "bodyText": "fixed", "author": "marton-bod", "createdAt": "2020-11-10T10:18:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE5NzY4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE5OTI1MQ==", "url": "https://github.com/apache/iceberg/pull/1742#discussion_r520199251", "bodyText": "I think test values should be created using strings so we know that we know the exact BigDecimal values. Converting from float seems unreliable. The one that uses an integer and a specific scale seems fine.", "author": "rdblue", "createdAt": "2020-11-10T00:03:07Z", "path": "mr/src/test/java/org/apache/iceberg/mr/hive/HiveIcebergStorageHandlerBaseTest.java", "diffHunk": "@@ -176,6 +177,40 @@ public void testScanEmptyTable() throws IOException {\n     Assert.assertEquals(0, rows.size());\n   }\n \n+  @Test\n+  public void testDecimalTableWithPredicateLiterals() throws IOException {\n+    shell.setHiveSessionValue(\"hive.vectorized.execution.enabled\", \"false\");\n+    Schema schema = new Schema(required(1, \"decimal_field\", Types.DecimalType.of(7, 2)));\n+    List<Record> records = TestHelper.RecordsBuilder.newInstance(schema)\n+            .add(BigDecimal.valueOf(8500, 2)) // 85.00\n+            .add(BigDecimal.valueOf(100.56))\n+            .add(BigDecimal.valueOf(100.57))", "originalCommit": "fcf2fccafafd27696a8de6dc252d7ed19acfd467", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQ0Nzc2NQ==", "url": "https://github.com/apache/iceberg/pull/1742#discussion_r520447765", "bodyText": "makes sense, using strings now", "author": "marton-bod", "createdAt": "2020-11-10T10:19:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE5OTI1MQ=="}], "type": "inlineReview"}, {"oid": "7c72a431f73eddb2fd8f45da5d3975926f5f504d", "url": "https://github.com/apache/iceberg/commit/7c72a431f73eddb2fd8f45da5d3975926f5f504d", "message": "create bigdecimals in test using strings", "committedDate": "2020-11-10T10:06:17Z", "type": "commit"}, {"oid": "aa5e897a60e6fe579dac96b89c6f1f279514c622", "url": "https://github.com/apache/iceberg/commit/aa5e897a60e6fe579dac96b89c6f1f279514c622", "message": "Merge branch 'master' into decimal_scale_fix", "committedDate": "2020-11-16T18:55:52Z", "type": "commit"}]}