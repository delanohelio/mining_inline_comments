{"pr_number": 1165, "pr_title": "Make CharSequenceSet thread safe", "pr_createdAt": "2020-07-04T01:13:15Z", "pr_url": "https://github.com/apache/iceberg/pull/1165", "timeline": [{"oid": "293a1d3a56d4fae21fb596e06f6544ef8eecff67", "url": "https://github.com/apache/iceberg/commit/293a1d3a56d4fae21fb596e06f6544ef8eecff67", "message": "Make CharSequenceSet thread safe.", "committedDate": "2020-07-04T01:05:20Z", "type": "commit"}, {"oid": "cf24e2e4e0d162cb86dcdb06ad98bf39f7ed4c66", "url": "https://github.com/apache/iceberg/commit/cf24e2e4e0d162cb86dcdb06ad98bf39f7ed4c66", "message": "Work around ThreadLocal that is not Serializable.", "committedDate": "2020-07-04T01:36:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgyNDgwNA==", "url": "https://github.com/apache/iceberg/pull/1165#discussion_r449824804", "bodyText": "Maybe you can use guava Suppliers.memoize to help lazy-init.", "author": "JingsongLi", "createdAt": "2020-07-05T02:58:48Z", "path": "api/src/main/java/org/apache/iceberg/util/CharSequenceSet.java", "diffHunk": "@@ -54,10 +54,21 @@ public boolean isEmpty() {\n     return wrapperSet.isEmpty();\n   }\n \n+  public CharSequenceWrapper wrapper() {", "originalCommit": "cf24e2e4e0d162cb86dcdb06ad98bf39f7ed4c66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTkxNjIzOQ==", "url": "https://github.com/apache/iceberg/pull/1165#discussion_r449916239", "bodyText": "Thanks for pointing this out. I didn't know about Suppliers.memoize and it looks useful.\nI'm not sure that we want to use it here. We've had quite a few problems with Guava and have finally decided to shade just the classes we use into an Iceberg module. I think it is probably better to avoid adding to the set of Guava classes that we use. Since this is already done and it doesn't look like there is much of a benefit to changing over to Guava, I'm inclined to leave it as it is.\nIf others feel strongly about this, I can use it, but I think we should avoid expanding our use of Guava.", "author": "rdblue", "createdAt": "2020-07-05T20:37:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgyNDgwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTkzOTU0NA==", "url": "https://github.com/apache/iceberg/pull/1165#discussion_r449939544", "bodyText": "Sounds good to me", "author": "rdsr", "createdAt": "2020-07-06T00:52:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgyNDgwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk1MjU3OQ==", "url": "https://github.com/apache/iceberg/pull/1165#discussion_r449952579", "bodyText": "Sounds good to me", "author": "JingsongLi", "createdAt": "2020-07-06T02:13:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgyNDgwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAxNDI5Ng==", "url": "https://github.com/apache/iceberg/pull/1165#discussion_r450014296", "bodyText": "Wondering if making sense to have a static ThreadLocal object shared by all CharSequenceSet?", "author": "jun-he", "createdAt": "2020-07-06T06:45:52Z", "path": "api/src/main/java/org/apache/iceberg/util/CharSequenceSet.java", "diffHunk": "@@ -54,10 +54,21 @@ public boolean isEmpty() {\n     return wrapperSet.isEmpty();\n   }\n \n+  public CharSequenceWrapper wrapper() {\n+    if (containsWrapper == null) {\n+      synchronized (this) {\n+        if (containsWrapper == null) {\n+          this.containsWrapper = ThreadLocal.withInitial(() -> CharSequenceWrapper.wrap(null));", "originalCommit": "cf24e2e4e0d162cb86dcdb06ad98bf39f7ed4c66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM0OTM3Mw==", "url": "https://github.com/apache/iceberg/pull/1165#discussion_r450349373", "bodyText": "Yes, this is a simpler solution. Good point!", "author": "rdblue", "createdAt": "2020-07-06T16:43:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAxNDI5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAxNDc1OA==", "url": "https://github.com/apache/iceberg/pull/1165#discussion_r450014758", "bodyText": "should it be set back to null after the operation?", "author": "jun-he", "createdAt": "2020-07-06T06:47:09Z", "path": "api/src/main/java/org/apache/iceberg/util/CharSequenceSet.java", "diffHunk": "@@ -54,10 +54,21 @@ public boolean isEmpty() {\n     return wrapperSet.isEmpty();\n   }\n \n+  public CharSequenceWrapper wrapper() {\n+    if (containsWrapper == null) {\n+      synchronized (this) {\n+        if (containsWrapper == null) {\n+          this.containsWrapper = ThreadLocal.withInitial(() -> CharSequenceWrapper.wrap(null));\n+        }\n+      }\n+    }\n+    return containsWrapper.get();\n+  }\n+\n   @Override\n   public boolean contains(Object obj) {\n     if (obj instanceof CharSequence) {\n-      return wrapperSet.contains(containsWrapper.set((CharSequence) obj));\n+      return wrapperSet.contains(wrapper().set((CharSequence) obj));", "originalCommit": "cf24e2e4e0d162cb86dcdb06ad98bf39f7ed4c66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMyMjg0NA==", "url": "https://github.com/apache/iceberg/pull/1165#discussion_r450322844", "bodyText": "Yeah, this is probably a good idea.", "author": "rdblue", "createdAt": "2020-07-06T16:00:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAxNDc1OA=="}], "type": "inlineReview"}, {"oid": "46c1114afb3767fe01a6774622b22a7516a1be21", "url": "https://github.com/apache/iceberg/commit/46c1114afb3767fe01a6774622b22a7516a1be21", "message": "Clean up CharSequenceWrapper handling in CharSequenceSet.", "committedDate": "2020-07-06T16:43:34Z", "type": "commit"}]}