{"pr_number": 1459, "pr_title": "Use gitattributes file to detect archive list automatically and simplify release script", "pr_createdAt": "2020-09-14T08:49:49Z", "pr_url": "https://github.com/apache/iceberg/pull/1459", "timeline": [{"oid": "f39def5e9e903ac13eade7fdd9417bcb146cb931", "url": "https://github.com/apache/iceberg/commit/f39def5e9e903ac13eade7fdd9417bcb146cb931", "message": "Add in a gitattributes file for simplifying excluding things from releases", "committedDate": "2020-09-14T08:02:49Z", "type": "commit"}, {"oid": "d7dcc95d4edae880dfccda4779050e8e084227e3", "url": "https://github.com/apache/iceberg/commit/d7dcc95d4edae880dfccda4779050e8e084227e3", "message": "Update the release script to use the gitattributes file for excludes", "committedDate": "2020-09-14T08:35:29Z", "type": "commit"}, {"oid": "fd7fb16419ca89e82c29c4c6161dcf32d8e31748", "url": "https://github.com/apache/iceberg/commit/fd7fb16419ca89e82c29c4c6161dcf32d8e31748", "message": "Use head with the release hash, as the script places HEAD as the current release", "committedDate": "2020-09-14T08:38:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzc1MjcxOQ==", "url": "https://github.com/apache/iceberg/pull/1459#discussion_r487752719", "bodyText": "This file will be merged in from #1457 (which should be merged in before this one) and then will not appear in this PR.", "author": "kbendick", "createdAt": "2020-09-14T08:51:06Z", "path": ".gitattributes", "diffHunk": "@@ -0,0 +1,35 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one\n+# or more contributor license agreements.  See the NOTICE file\n+# distributed with this work for additional information\n+# regarding copyright ownership.  The ASF licenses this file\n+# to you under the Apache License, Version 2.0 (the\n+# \"License\"); you may not use this file except in compliance\n+# with the License.  You may obtain a copy of the License at\n+# \n+#   http://www.apache.org/licenses/LICENSE-2.0\n+# \n+# Unless required by applicable law or agreed to in writing,\n+# software distributed under the License is distributed on an\n+# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+# KIND, either express or implied.  See the License for the\n+# specific language governing permissions and limitations\n+# under the License.\n+#\n+\n+# Files marked as export-ignore will be ignored from the release's\n+# built via `git archive`. This simplifies the release script and \n+# uses an industry standard as opposed to possibly hard to read\n+# shell scripts with many flags. Unfortunately, directories themselves\n+# won't recursively ignore, so we need the top level directories\n+# as well as their files.\n+/build         export-ignore\n+/build/**      export-ignore\n+/examples      export-ignore\n+/examples/**   export-ignore\n+jitpack.yml    export-ignore\n+/python        export-ignore\n+/python/**     export-ignore\n+/site          export-ignore\n+/site/**       export-ignore\n+", "originalCommit": "fd7fb16419ca89e82c29c4c6161dcf32d8e31748", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzc1MzUzNQ==", "url": "https://github.com/apache/iceberg/pull/1459#discussion_r487753535", "bodyText": "I added version-num, as when running the release script, I occasionally found myself passing in ./dev/source-release.sh apache-iceberg-0.10.1 rc2. In the future, we might consider opening an issue to detect whether or not the passed in $1 and $2 are valid floats, but that's beyond the scope of this PR.", "author": "kbendick", "createdAt": "2020-09-14T08:52:19Z", "path": "dev/source-release.sh", "diffHunk": "@@ -21,12 +21,12 @@\n set -e\n \n if [ -z \"$1\" ]; then\n-  echo \"Usage: $0 <version> <rc-num>\"\n+  echo \"Usage: $0 <version-num> <rc-num>\"", "originalCommit": "fd7fb16419ca89e82c29c4c6161dcf32d8e31748", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzc1NTQzMw==", "url": "https://github.com/apache/iceberg/pull/1459#discussion_r487755433", "bodyText": "I don't think that this comment is really necessary now. We are using a release hash still, but we're also using HEAD. However, the results are correct and this isn't any different than the proposed working solution of using git ls-tree --name-only -r HEAD.\nPlease let me know if the above comment can be removed, as to me it no longer makes sense. We also have less need to be conservative as we're using HEAD, and the script even issues and pushes a commit with the version.txt file, so HEAD is absolutely the correct place to be working from in this case.", "author": "kbendick", "createdAt": "2020-09-14T08:55:17Z", "path": "dev/source-release.sh", "diffHunk": "@@ -66,7 +66,7 @@ tarball=$tag.tar.gz\n \n # be conservative and use the release hash, even though git produces the same\n # archive (identical hashes) using the scm tag", "originalCommit": "fd7fb16419ca89e82c29c4c6161dcf32d8e31748", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzc1NjU3MQ==", "url": "https://github.com/apache/iceberg/pull/1459#discussion_r487756571", "bodyText": "The --worktree-attributes is what tells git archive to check (all of) the .gitattribute files. We're keeping it simple and using one top level one, as it suit our needs.\nI tested this and the resulting tarball had none of the files we expected to be ignored in its contents and had all of the files we expected to be there (when comparing the output sorted list from the current script to this script via the uniq shell command.", "author": "kbendick", "createdAt": "2020-09-14T08:57:05Z", "path": "dev/source-release.sh", "diffHunk": "@@ -66,7 +66,7 @@ tarball=$tag.tar.gz\n \n # be conservative and use the release hash, even though git produces the same\n # archive (identical hashes) using the scm tag\n-git archive $release_hash --prefix $tag/ -o $tarball .baseline api arrow bundled-guava common core data dev flink gradle gradlew hive mr orc parquet pig spark spark2 spark-runtime spark3 spark3-runtime LICENSE NOTICE README.md build.gradle baseline.gradle deploy.gradle tasks.gradle jmh.gradle gradle.properties settings.gradle versions.lock versions.props version.txt\n+git archive $release_hash --worktree-attributes --prefix $tag/ -o $tarball HEAD", "originalCommit": "fd7fb16419ca89e82c29c4c6161dcf32d8e31748", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}