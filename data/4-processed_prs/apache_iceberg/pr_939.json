{"pr_number": 939, "pr_title": "Support UpdateEvent for Update Operations", "pr_createdAt": "2020-04-18T14:47:04Z", "pr_url": "https://github.com/apache/iceberg/pull/939", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUzNzQ5OQ==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r411537499", "bodyText": "Why not use table.location()? You can access that using ops.current().location().\nI'm really reluctant to add more methods to this interface since it is an important place where people can plug in their own customizations.", "author": "rdblue", "createdAt": "2020-04-20T16:55:37Z", "path": "core/src/main/java/org/apache/iceberg/TableOperations.java", "diffHunk": "@@ -30,6 +30,8 @@\n  */\n public interface TableOperations {\n \n+  String tablePath();", "originalCommit": "532ccc60959be009f970b2de7a568e8e27ddedb0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU2OTMwNQ==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r411569305", "bodyText": "I guess table location is also fine. We can parse out table name and db name from it. Though is it unclean, as we are relying on hidden/internal implementations on how the location looks like.", "author": "rdsr", "createdAt": "2020-04-20T17:43:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUzNzQ5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUzODk3Nw==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r411538977", "bodyText": "Why use table path/location instead of name? I think we should send a name field with whatever was used to load the table. We might need to add name to the Table interface to do that, but adding that method is easier than adding something to TableOperations because all the implementations are internal.", "author": "rdblue", "createdAt": "2020-04-20T16:57:44Z", "path": "core/src/main/java/org/apache/iceberg/events/CreateSnapshotEvent.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg.events;\n+\n+import java.util.Map;\n+\n+public final class CreateSnapshotEvent implements UpdateEvent {\n+  private final String operation;\n+  private final String tablePath;\n+  private final Map<String, String> summary;\n+  private final Iterable<String> addedFiles;\n+  private final Iterable<String> appendedManifests;\n+  private final Iterable<String> deletePaths;\n+\n+  public CreateSnapshotEvent(\n+      String operation, String tablePath, Map<String, String> summary,\n+      Iterable<String> addedFiles, Iterable<String> appendedManifests, Iterable<String> deletePaths) {", "originalCommit": "532ccc60959be009f970b2de7a568e8e27ddedb0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU3NDAzNA==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r411574034", "bodyText": "I think we might need a reference to Table . Where we call commit and publish events we only have access to TableOperations . Any thoughts on how to get the name during commits?", "author": "rdsr", "createdAt": "2020-04-20T17:50:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUzODk3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU3NzQwMQ==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r411577401", "bodyText": "Table creates all of these operations, so it can pass in its name as well as ops. I'd prefer that to trying to parse a location.", "author": "rdblue", "createdAt": "2020-04-20T17:55:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUzODk3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU5ODQ4Mg==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r411598482", "bodyText": "Maybe I can pass in the name as a property which can reside in table metadata. I can access that metadata during commit and I don't have to add any new api in TableOperations ?", "author": "rdsr", "createdAt": "2020-04-20T18:29:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUzODk3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYwNjA0NQ==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r411606045", "bodyText": "I don't think we need to add to TableOperations. Table keeps track of its name, and is responsible for creating the operations classes, like FastAppend. So we can just pass the name in along side TableOperations:\n  @Override\n  public AppendFiles newFastAppend() {\n    return new FastAppend(name, ops);\n  }", "author": "rdblue", "createdAt": "2020-04-20T18:42:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUzODk3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU0MjAwNA==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r411542004", "bodyText": "This needs to be in a try/catch block to ensure that no exceptions are thrown. It is important for correctness that this returns successfully if the commit was successful. If the commit succeeds, but this throws an exception, then higher-level retries will re-attempt the operation on the same data and produce duplicates.\nAlso, if this is sent after commit, then it should include the sequence number that was committed.", "author": "rdblue", "createdAt": "2020-04-20T17:02:18Z", "path": "core/src/main/java/org/apache/iceberg/SnapshotProducer.java", "diffHunk": "@@ -293,6 +294,8 @@ public void commit() {\n     } catch (RuntimeException e) {\n       LOG.warn(\"Failed to load committed table metadata, skipping manifest clean-up\", e);\n     }\n+\n+    Listeners.notifyAll(updateEvent());", "originalCommit": "532ccc60959be009f970b2de7a568e8e27ddedb0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU3MTQzOA==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r411571438", "bodyText": "Makes sense", "author": "rdsr", "createdAt": "2020-04-20T17:47:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU0MjAwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU0NDQ5Ng==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r411544496", "bodyText": "I think this should also include the snapshot ID and sequence number that were committed.", "author": "rdblue", "createdAt": "2020-04-20T17:06:10Z", "path": "core/src/main/java/org/apache/iceberg/MergingSnapshotProducer.java", "diffHunk": "@@ -317,6 +319,18 @@ private ManifestFile copyManifest(ManifestFile manifest) {\n     }\n   }\n \n+  @Override\n+  public UpdateEvent updateEvent() {\n+    return new CreateSnapshotEvent(", "originalCommit": "532ccc60959be009f970b2de7a568e8e27ddedb0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU0NDY5Nw==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r411544697", "bodyText": "I think we can add update events individually.", "author": "rdblue", "createdAt": "2020-04-20T17:06:30Z", "path": "core/src/main/java/org/apache/iceberg/SchemaUpdate.java", "diffHunk": "@@ -476,4 +476,6 @@ public Type primitive(Type.PrimitiveType primitive) {\n     newFields.addAll(adds);\n     return Types.StructType.of(newFields);\n   }\n+\n+  //TODO: updateEvent", "originalCommit": "532ccc60959be009f970b2de7a568e8e27ddedb0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU2OTkwNg==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r411569906", "bodyText": "Makes sense", "author": "rdsr", "createdAt": "2020-04-20T17:44:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU0NDY5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU0NzM1MQ==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r411547351", "bodyText": "What is the value of having an interface for all types of updates with no methods?\nThe listener code routes these events using listeners.get(event.getClass()) so the interface doesn't help to subscribe to all events.", "author": "rdblue", "createdAt": "2020-04-20T17:10:27Z", "path": "api/src/main/java/org/apache/iceberg/events/UpdateEvent.java", "diffHunk": "@@ -0,0 +1,26 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg.events;\n+\n+public interface UpdateEvent {", "originalCommit": "532ccc60959be009f970b2de7a568e8e27ddedb0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU3OTgwNw==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r411579807", "bodyText": "I was thinking that there may be some update operations where commit is being performed in their superclass. In those cases, we have to get the sub class' update\nevent. Seeing through the code again, I don't see this and where a commit it being performed in a class it has all the information to send the event.\nI'll delete this event interface", "author": "rdsr", "createdAt": "2020-04-20T17:59:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU0NzM1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU4NDk4NQ==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r411584985", "bodyText": "The issue is that I need to call the listeners after commit, but I don't have all the information to construct the event. For instance for SnapshotProducer where we are committing  I don't have information on how to construct the event and I'm relying on the subclass MergingSnapshotProducer to construct the right event properly.", "author": "rdsr", "createdAt": "2020-04-20T18:07:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU0NzM1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYwNzM2OQ==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r411607369", "bodyText": "Makes sense. We could also have updateEvent() return Object, since there are no requirements for objects passed to Listeners.notifyAll.", "author": "rdblue", "createdAt": "2020-04-20T18:44:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU0NzM1MQ=="}], "type": "inlineReview"}, {"oid": "b04a180eac6244190ac995b8cc6239293e91925e", "url": "https://github.com/apache/iceberg/commit/b04a180eac6244190ac995b8cc6239293e91925e", "message": "Support UpdateEvent for Update Operations\n\nsave", "committedDate": "2020-04-22T06:39:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5NDAxNA==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r413194014", "bodyText": "Did you mean to use identifier.toString here as well?", "author": "rdblue", "createdAt": "2020-04-22T17:53:17Z", "path": "core/src/main/java/org/apache/iceberg/BaseMetastoreCatalog.java", "diffHunk": "@@ -93,7 +93,7 @@ public Transaction newCreateTableTransaction(\n     String baseLocation = location != null ? location : defaultWarehouseLocation(identifier);\n     Map<String, String> tableProperties = properties != null ? properties : Maps.newHashMap();\n     TableMetadata metadata = TableMetadata.newTableMetadata(schema, spec, baseLocation, tableProperties);\n-    return Transactions.createTableTransaction(ops, metadata);\n+    return Transactions.createTableTransaction(identifier.name(), ops, metadata);", "originalCommit": "b04a180eac6244190ac995b8cc6239293e91925e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTkyNDU1NQ==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r415924555", "bodyText": "Fixed.", "author": "rdsr", "createdAt": "2020-04-27T15:42:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5NDAxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5NDI5NA==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r413194294", "bodyText": "Nit: Other places use name.", "author": "rdblue", "createdAt": "2020-04-22T17:53:43Z", "path": "core/src/main/java/org/apache/iceberg/BaseReplacePartitions.java", "diffHunk": "@@ -25,8 +25,8 @@\n \n public class BaseReplacePartitions\n     extends MergingSnapshotProducer<ReplacePartitions> implements ReplacePartitions {\n-  BaseReplacePartitions(TableOperations ops) {\n-    super(ops);\n+  BaseReplacePartitions(String tableName, TableOperations ops) {\n+    super(tableName, ops);", "originalCommit": "b04a180eac6244190ac995b8cc6239293e91925e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTkyMTUzOA==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r415921538", "bodyText": "I felt tableName was more appropriate. I have changed it as such in the code I added/modified.\nThere are still uses of name though, e.g in Transaction api. I haven't changed them.  Let me know if u feel strongly in using name or changing to tableName everywhere. I'm fine with either", "author": "rdsr", "createdAt": "2020-04-27T15:39:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5NDI5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5NTIxNw==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r413195217", "bodyText": "Couldn't this method be added in a separate commit?", "author": "rdblue", "createdAt": "2020-04-22T17:54:56Z", "path": "core/src/main/java/org/apache/iceberg/BaseTable.java", "diffHunk": "@@ -39,6 +39,11 @@ public BaseTable(TableOperations ops, String name) {\n     this.name = name;\n   }\n \n+  @Override\n+  public String name() {", "originalCommit": "b04a180eac6244190ac995b8cc6239293e91925e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTkwMjcxNg==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r415902716", "bodyText": "Removed", "author": "rdsr", "createdAt": "2020-04-27T15:17:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5NTIxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5NjcyNg==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r413196726", "bodyText": "Nit: this file doesn't need to change.", "author": "rdblue", "createdAt": "2020-04-22T17:56:56Z", "path": "core/src/main/java/org/apache/iceberg/PropertiesUpdate.java", "diffHunk": "@@ -37,6 +37,7 @@\n import static org.apache.iceberg.TableProperties.COMMIT_TOTAL_RETRY_TIME_MS_DEFAULT;\n \n class PropertiesUpdate implements UpdateProperties {\n+", "originalCommit": "b04a180eac6244190ac995b8cc6239293e91925e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5ODEwMg==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r413198102", "bodyText": "I think the append event should be created in this PR if we are sending events from MergingSnapshotProducer. I don't think it is necessary to implement events for SnapshotManager yet, though.", "author": "rdblue", "createdAt": "2020-04-22T17:58:56Z", "path": "core/src/main/java/org/apache/iceberg/FastAppend.java", "diffHunk": "@@ -49,7 +49,8 @@\n   private ManifestFile newManifest = null;\n   private boolean hasNewFiles = false;\n \n-  FastAppend(TableOperations ops) {\n+  FastAppend(String tableName, TableOperations ops) {\n+    //TODO we use tableName to publish notification", "originalCommit": "b04a180eac6244190ac995b8cc6239293e91925e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTEyOTA2Mg==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r415129062", "bodyText": "So FastAppend extends SnapshotProducer . If I change SnapshotProducer, I'll have to change BaseRewriteManifests. OK to make that change in this PR?", "author": "rdsr", "createdAt": "2020-04-25T19:36:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5ODEwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk1ODM3NA==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r415958374", "bodyText": "Are you saying that SnapshotProducer would send the event? What needs to be changed?", "author": "rdblue", "createdAt": "2020-04-27T16:22:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5ODEwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjAwMzc0Nw==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r416003747", "bodyText": "My bad. I think this can be supported. I'll do that as part of this pr", "author": "rdsr", "createdAt": "2020-04-27T17:24:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5ODEwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5ODU4Ng==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r413198586", "bodyText": "Why comment this out? Looks correct to me.", "author": "rdblue", "createdAt": "2020-04-22T17:59:34Z", "path": "core/src/main/java/org/apache/iceberg/MergingSnapshotProducer.java", "diffHunk": "@@ -317,6 +321,22 @@ private ManifestFile copyManifest(ManifestFile manifest) {\n     }\n   }\n \n+  @Override\n+  public Object updateEvent() {\n+    long snapshotId = snapshotId();\n+    //long sequenceNumber = ops.refresh().snapshot(snapshotId).sequenceNumber();", "originalCommit": "b04a180eac6244190ac995b8cc6239293e91925e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5OTgwOA==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r413199808", "bodyText": "Minor: the other methods use past tense and refer to data files as \"files\", so this would be deletedFiles() right?", "author": "rdblue", "createdAt": "2020-04-22T18:01:10Z", "path": "core/src/main/java/org/apache/iceberg/events/CreateSnapshotEvent.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg.events;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+\n+public final class CreateSnapshotEvent {\n+  private final String tableName;\n+  private final String operation;\n+  private final long snapshotId;\n+  private final long sequenceNumber;\n+  private final Map<String, String> summary;\n+  private final List<String> addedFiles;\n+  private final List<String> appendedManifests;\n+  private final List<String> deletePaths;\n+\n+  public CreateSnapshotEvent(\n+      String tableName, String operation, long snapshotId, long sequenceNumber, Map<String, String> summary,\n+      List<String> addedFiles, List<String> appendedManifests, List<String> deletePaths) {\n+    this.tableName = tableName;\n+    this.operation = operation;\n+    this.snapshotId = snapshotId;\n+    this.sequenceNumber = sequenceNumber;\n+    this.summary = summary;\n+    this.addedFiles = addedFiles;\n+    this.appendedManifests = appendedManifests;\n+    this.deletePaths = deletePaths;\n+  }\n+\n+  public String tableName() {\n+    return tableName;\n+  }\n+\n+  public String operation() {\n+    return operation;\n+  }\n+\n+  public long snapshotId() {\n+    return snapshotId;\n+  }\n+\n+  public long sequenceNumber() {\n+    return sequenceNumber;\n+  }\n+\n+  public Map<String, String> summary() {\n+    return summary;\n+  }\n+\n+  public List<String> addedFiles() {\n+    return addedFiles;\n+  }\n+\n+  public List<String> appendedManifests() {\n+    return appendedManifests;\n+  }\n+\n+  public List<String> deletePaths() {", "originalCommit": "b04a180eac6244190ac995b8cc6239293e91925e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTkwNDUzMA==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r415904530", "bodyText": "fixed.", "author": "rdsr", "createdAt": "2020-04-27T15:19:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5OTgwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzIwMDQ2Ng==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r413200466", "bodyText": "Is this the set of manifests that were added to the dataset, or the ones that were passed to appendManifest? I think we should be careful that we know exactly what is in these messages. If it isn't obvious what these should be, then we should remove the data. We can always add more information later.", "author": "rdblue", "createdAt": "2020-04-22T18:02:05Z", "path": "core/src/main/java/org/apache/iceberg/events/CreateSnapshotEvent.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg.events;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+\n+public final class CreateSnapshotEvent {\n+  private final String tableName;\n+  private final String operation;\n+  private final long snapshotId;\n+  private final long sequenceNumber;\n+  private final Map<String, String> summary;\n+  private final List<String> addedFiles;\n+  private final List<String> appendedManifests;\n+  private final List<String> deletePaths;\n+\n+  public CreateSnapshotEvent(\n+      String tableName, String operation, long snapshotId, long sequenceNumber, Map<String, String> summary,\n+      List<String> addedFiles, List<String> appendedManifests, List<String> deletePaths) {\n+    this.tableName = tableName;\n+    this.operation = operation;\n+    this.snapshotId = snapshotId;\n+    this.sequenceNumber = sequenceNumber;\n+    this.summary = summary;\n+    this.addedFiles = addedFiles;\n+    this.appendedManifests = appendedManifests;\n+    this.deletePaths = deletePaths;\n+  }\n+\n+  public String tableName() {\n+    return tableName;\n+  }\n+\n+  public String operation() {\n+    return operation;\n+  }\n+\n+  public long snapshotId() {\n+    return snapshotId;\n+  }\n+\n+  public long sequenceNumber() {\n+    return sequenceNumber;\n+  }\n+\n+  public Map<String, String> summary() {\n+    return summary;\n+  }\n+\n+  public List<String> addedFiles() {\n+    return addedFiles;\n+  }\n+\n+  public List<String> appendedManifests() {", "originalCommit": "b04a180eac6244190ac995b8cc6239293e91925e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTkwMzk3OQ==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r415903979", "bodyText": "Removed for now.", "author": "rdsr", "createdAt": "2020-04-27T15:18:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzIwMDQ2Ng=="}], "type": "inlineReview"}, {"oid": "370be6d3080a1d09ad3e8687d1b581f9b3988ca9", "url": "https://github.com/apache/iceberg/commit/370be6d3080a1d09ad3e8687d1b581f9b3988ca9", "message": "Support UpdateEvent for Update Operations\n\nsave", "committedDate": "2020-04-27T15:12:32Z", "type": "commit"}, {"oid": "905afc37ecc7d60d8f59e5532117a1153d48386a", "url": "https://github.com/apache/iceberg/commit/905afc37ecc7d60d8f59e5532117a1153d48386a", "message": "Address comments", "committedDate": "2020-04-27T15:12:32Z", "type": "forcePushed"}, {"oid": "5c43caaaf65e3c70d942296363865ec01627a05e", "url": "https://github.com/apache/iceberg/commit/5c43caaaf65e3c70d942296363865ec01627a05e", "message": "Address comments", "committedDate": "2020-04-27T15:35:26Z", "type": "commit"}, {"oid": "5c43caaaf65e3c70d942296363865ec01627a05e", "url": "https://github.com/apache/iceberg/commit/5c43caaaf65e3c70d942296363865ec01627a05e", "message": "Address comments", "committedDate": "2020-04-27T15:35:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk1OTUwNg==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r415959506", "bodyText": "Why did this change? Can we not return the interface?", "author": "rdblue", "createdAt": "2020-04-27T16:24:17Z", "path": "core/src/main/java/org/apache/iceberg/BaseTable.java", "diffHunk": "@@ -136,37 +136,37 @@ public RewriteManifests rewriteManifests() {\n \n   @Override\n   public OverwriteFiles newOverwrite() {\n-    return new BaseOverwriteFiles(ops);\n+    return new BaseOverwriteFiles(name, ops);\n   }\n \n   @Override\n   public ReplacePartitions newReplacePartitions() {\n-    return new BaseReplacePartitions(ops);\n+    return new BaseReplacePartitions(name, ops);\n   }\n \n   @Override\n   public DeleteFiles newDelete() {\n-    return new StreamingDelete(ops);\n+    return new StreamingDelete(name, ops);\n   }\n \n   @Override\n-  public ExpireSnapshots expireSnapshots() {\n+  public RemoveSnapshots expireSnapshots() {", "originalCommit": "5c43caaaf65e3c70d942296363865ec01627a05e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk5NzI1Ng==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r415997256", "bodyText": "Fixed. My bad.", "author": "rdsr", "createdAt": "2020-04-27T17:14:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk1OTUwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk2MTg4MA==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r415961880", "bodyText": "What happens if manifests are added? Is this incomplete?", "author": "rdblue", "createdAt": "2020-04-27T16:27:27Z", "path": "core/src/main/java/org/apache/iceberg/events/CreateSnapshotEvent.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg.events;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+\n+public final class CreateSnapshotEvent {\n+  private final String tableName;\n+  private final String operation;\n+  private final long snapshotId;\n+  private final long sequenceNumber;\n+  private final Map<String, String> summary;\n+  private final List<String> addedFiles;\n+  private final List<String> deleteFiles;\n+\n+  public CreateSnapshotEvent(\n+      String tableName, String operation, long snapshotId, long sequenceNumber,\n+      Map<String, String> summary, List<String> addedFiles, List<String> deleteFiles) {\n+    this.tableName = tableName;\n+    this.operation = operation;\n+    this.snapshotId = snapshotId;\n+    this.sequenceNumber = sequenceNumber;\n+    this.summary = summary;\n+    this.addedFiles = addedFiles;\n+    this.deleteFiles = deleteFiles;\n+  }\n+\n+  public String tableName() {\n+    return tableName;\n+  }\n+\n+  public String operation() {\n+    return operation;\n+  }\n+\n+  public long snapshotId() {\n+    return snapshotId;\n+  }\n+\n+  public long sequenceNumber() {\n+    return sequenceNumber;\n+  }\n+\n+  public Map<String, String> summary() {\n+    return summary;\n+  }\n+\n+  public List<String> addedFiles() {", "originalCommit": "5c43caaaf65e3c70d942296363865ec01627a05e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0a631d024108fcd7f3717a80f9b29cefc62f44a6", "url": "https://github.com/apache/iceberg/commit/0a631d024108fcd7f3717a80f9b29cefc62f44a6", "message": "Address comments", "committedDate": "2020-04-28T03:23:36Z", "type": "forcePushed"}, {"oid": "a1a03ef4c97d2b3beecdf342ff6d5e0f00ae61df", "url": "https://github.com/apache/iceberg/commit/a1a03ef4c97d2b3beecdf342ff6d5e0f00ae61df", "message": "Address comments", "committedDate": "2020-04-28T03:27:38Z", "type": "commit"}, {"oid": "a1a03ef4c97d2b3beecdf342ff6d5e0f00ae61df", "url": "https://github.com/apache/iceberg/commit/a1a03ef4c97d2b3beecdf342ff6d5e0f00ae61df", "message": "Address comments", "committedDate": "2020-04-28T03:27:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTU0NzIxMQ==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r419547211", "bodyText": "The commit is going to update the current metadata, so there shouldn't be a need to refresh here. You'll get the correct information using current, with less chance of failure.", "author": "rdblue", "createdAt": "2020-05-04T16:03:36Z", "path": "core/src/main/java/org/apache/iceberg/FastAppend.java", "diffHunk": "@@ -141,6 +144,18 @@ private ManifestFile copyManifest(ManifestFile manifest) {\n     return newManifests;\n   }\n \n+  @Override\n+  public Object updateEvent() {\n+    long snapshotId = snapshotId();\n+    long sequenceNumber = ops.refresh().snapshot(snapshotId).sequenceNumber();", "originalCommit": "a1a03ef4c97d2b3beecdf342ff6d5e0f00ae61df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTU2NDIzMQ==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r419564231", "bodyText": "fixed", "author": "rdsr", "createdAt": "2020-05-04T16:28:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTU0NzIxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTU0ODcwMA==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r419548700", "bodyText": "It doesn't create a new snapshot, but should it send an event? Maybe as a follow-up?", "author": "rdblue", "createdAt": "2020-05-04T16:05:46Z", "path": "core/src/main/java/org/apache/iceberg/SnapshotManager.java", "diffHunk": "@@ -127,6 +127,32 @@ public ManageSnapshots rollbackTo(long snapshotId) {\n     return setCurrentSnapshot(snapshotId);\n   }\n \n+  @Override\n+  public Object updateEvent() {\n+    if (targetSnapshotId == null) {\n+      // NOOP operation, no snapshot created\n+      return null;\n+    }\n+\n+    switch (managerOperation) {\n+      case ROLLBACK:\n+        // rollback does not create a new snapshot", "originalCommit": "a1a03ef4c97d2b3beecdf342ff6d5e0f00ae61df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTU1MzEzNA==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r419553134", "bodyText": "Yes. I'll create a followup for this. I presume this would be a specific Rollback event?", "author": "rdsr", "createdAt": "2020-05-04T16:12:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTU0ODcwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTU1NDYyMg==", "url": "https://github.com/apache/iceberg/pull/939#discussion_r419554622", "bodyText": "Maybe a history modification event with a type that could be \"rollback\", \"fast-forward\", \"cherry-pick\", or \"set-current\"?", "author": "rdblue", "createdAt": "2020-05-04T16:14:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTU0ODcwMA=="}], "type": "inlineReview"}, {"oid": "85ef6281838017ba7c78214178b569b56667a068", "url": "https://github.com/apache/iceberg/commit/85ef6281838017ba7c78214178b569b56667a068", "message": "Address comments", "committedDate": "2020-05-04T16:25:25Z", "type": "commit"}]}