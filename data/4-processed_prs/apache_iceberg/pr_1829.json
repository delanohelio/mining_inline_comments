{"pr_number": 1829, "pr_title": "Refactor/rename metrics related classes for NaN support", "pr_createdAt": "2020-11-25T20:06:25Z", "pr_url": "https://github.com/apache/iceberg/pull/1829", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDYxNzQ4MQ==", "url": "https://github.com/apache/iceberg/pull/1829#discussion_r530617481", "bodyText": "The reason for changing this class is discussed in this thread", "author": "yyanyy", "createdAt": "2020-11-25T20:07:32Z", "path": "spark/src/main/java/org/apache/iceberg/spark/source/StructInternalRow.java", "diffHunk": "@@ -115,12 +120,30 @@ public short getShort(int ordinal) {\n \n   @Override\n   public int getInt(int ordinal) {\n-    return struct.get(ordinal, Integer.class);\n+    Object integer = struct.get(ordinal, Object.class);", "originalCommit": "c150f5a25a73e6bc87a6f686df0845a0ee4fd6cc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY2MjU0MA==", "url": "https://github.com/apache/iceberg/pull/1829#discussion_r530662540", "bodyText": "inputschema can be null at this point.", "author": "giovannifumarola", "createdAt": "2020-11-25T21:57:31Z", "path": "core/src/main/java/org/apache/iceberg/MetricsUtil.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg;\n+\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+import org.apache.iceberg.relocated.com.google.common.collect.Maps;\n+\n+public class MetricsUtil {\n+\n+  private MetricsUtil() {\n+  }\n+\n+  public static Map<Integer, Long> getNanValueCounts(\n+      Stream<FieldMetrics> fieldMetrics, MetricsConfig metricsConfig, Schema inputSchema) {\n+    if (fieldMetrics == null || inputSchema == null) {\n+      return Maps.newHashMap();\n+    }\n+\n+    return fieldMetrics\n+        .filter(metrics -> getMetricsMode(inputSchema, metricsConfig, metrics.id()) != MetricsModes.None.get())\n+        .collect(Collectors.toMap(FieldMetrics::id, FieldMetrics::nanValueCount));\n+  }\n+\n+  public static MetricsModes.MetricsMode getMetricsMode(Schema inputSchema, MetricsConfig metricsConfig, int fieldId) {\n+    String columnName = inputSchema.findColumnName(fieldId);", "originalCommit": "c150f5a25a73e6bc87a6f686df0845a0ee4fd6cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY5MTEzMg==", "url": "https://github.com/apache/iceberg/pull/1829#discussion_r530691132", "bodyText": "I'll add a validation check to ensure they are not null", "author": "yyanyy", "createdAt": "2020-11-25T23:24:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY2MjU0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjkyNjA3Ng==", "url": "https://github.com/apache/iceberg/pull/1829#discussion_r536926076", "bodyText": "I agree. Let's add checks to fail when metricsConfig or inputSchema is null. This is a useful method so I think it is worth keeping it public, but we would ideally not fail with a NullPointerException. This is not called in a tight loop, so it should be fine to add the checks on each call.", "author": "rdblue", "createdAt": "2020-12-06T01:06:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY2MjU0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzc5MTk5NQ==", "url": "https://github.com/apache/iceberg/pull/1829#discussion_r537791995", "bodyText": "Yes, sorry I overwrote my own earlier change that addressed this when I renamed this file...", "author": "yyanyy", "createdAt": "2020-12-07T19:59:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY2MjU0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY2MjYyOQ==", "url": "https://github.com/apache/iceberg/pull/1829#discussion_r530662629", "bodyText": "same for metrics config.", "author": "giovannifumarola", "createdAt": "2020-11-25T21:57:44Z", "path": "core/src/main/java/org/apache/iceberg/MetricsUtil.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg;\n+\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+import org.apache.iceberg.relocated.com.google.common.collect.Maps;\n+\n+public class MetricsUtil {\n+\n+  private MetricsUtil() {\n+  }\n+\n+  public static Map<Integer, Long> getNanValueCounts(\n+      Stream<FieldMetrics> fieldMetrics, MetricsConfig metricsConfig, Schema inputSchema) {\n+    if (fieldMetrics == null || inputSchema == null) {\n+      return Maps.newHashMap();\n+    }\n+\n+    return fieldMetrics\n+        .filter(metrics -> getMetricsMode(inputSchema, metricsConfig, metrics.id()) != MetricsModes.None.get())\n+        .collect(Collectors.toMap(FieldMetrics::id, FieldMetrics::nanValueCount));\n+  }\n+\n+  public static MetricsModes.MetricsMode getMetricsMode(Schema inputSchema, MetricsConfig metricsConfig, int fieldId) {\n+    String columnName = inputSchema.findColumnName(fieldId);\n+    return metricsConfig.columnMode(columnName);", "originalCommit": "c150f5a25a73e6bc87a6f686df0845a0ee4fd6cc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDY2MjcwNQ==", "url": "https://github.com/apache/iceberg/pull/1829#discussion_r530662705", "bodyText": "NIT: add javadoc.", "author": "giovannifumarola", "createdAt": "2020-11-25T21:57:55Z", "path": "core/src/main/java/org/apache/iceberg/MetricsUtil.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iceberg;\n+\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+import org.apache.iceberg.relocated.com.google.common.collect.Maps;\n+\n+public class MetricsUtil {\n+\n+  private MetricsUtil() {\n+  }\n+\n+  public static Map<Integer, Long> getNanValueCounts(", "originalCommit": "c150f5a25a73e6bc87a6f686df0845a0ee4fd6cc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjkyNTMzMA==", "url": "https://github.com/apache/iceberg/pull/1829#discussion_r536925330", "bodyText": "Since we expect to add lower and upper bounds to this class (since Parquet and ORC do not ignore NaN values), I think this should probably be called FloatFieldMetrics. That way we don't need to rename when this adds support for lower and upper.", "author": "rdblue", "createdAt": "2020-12-06T01:00:17Z", "path": "core/src/main/java/org/apache/iceberg/NaNFieldMetrics.java", "diffHunk": "@@ -17,51 +17,50 @@\n  * under the License.\n  */\n \n-package org.apache.iceberg.parquet;\n+package org.apache.iceberg;\n \n import java.nio.ByteBuffer;\n-import org.apache.iceberg.FieldMetrics;\n \n /**\n- * Iceberg internally tracked field level metrics, used by Parquet writer only.\n+ * Iceberg internally tracked field level metrics, used by Parquet and ORC writers only.\n  * <p>\n- * Parquet keeps track of most metrics in its footer, and only NaN counter is actually tracked by writers.\n- * This wrapper ensures that metrics not being updated by Parquet writers will not be incorrectly used, by throwing\n+ * Parquet/ORC keeps track of most metrics in file statistics, and only NaN counter is actually tracked by writers.\n+ * This wrapper ensures that metrics not being updated by those writers will not be incorrectly used, by throwing\n  * exceptions when they are accessed.\n  */\n-public class ParquetFieldMetrics extends FieldMetrics {\n+public class NaNFieldMetrics extends FieldMetrics {", "originalCommit": "b7d88f21aa7ee7ec332b5fa628d427351c1988fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzc5MjA1Nw==", "url": "https://github.com/apache/iceberg/pull/1829#discussion_r537792057", "bodyText": "Sounds good; I'll keep the javadoc as is since they currently reflect reality, and will update comments to mention tracking float fields when the class starts to track upper/lower bound", "author": "yyanyy", "createdAt": "2020-12-07T19:59:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjkyNTMzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjkyNTUwNA==", "url": "https://github.com/apache/iceberg/pull/1829#discussion_r536925504", "bodyText": "This demonstrates the drawback to adding too much context to an exception message. The method and class should be in the stack trace and renames require updating this message. Let's keep the good error message, but remove the class and method names.", "author": "rdblue", "createdAt": "2020-12-06T01:01:38Z", "path": "core/src/main/java/org/apache/iceberg/NaNFieldMetrics.java", "diffHunk": "@@ -17,51 +17,50 @@\n  * under the License.\n  */\n \n-package org.apache.iceberg.parquet;\n+package org.apache.iceberg;\n \n import java.nio.ByteBuffer;\n-import org.apache.iceberg.FieldMetrics;\n \n /**\n- * Iceberg internally tracked field level metrics, used by Parquet writer only.\n+ * Iceberg internally tracked field level metrics, used by Parquet and ORC writers only.\n  * <p>\n- * Parquet keeps track of most metrics in its footer, and only NaN counter is actually tracked by writers.\n- * This wrapper ensures that metrics not being updated by Parquet writers will not be incorrectly used, by throwing\n+ * Parquet/ORC keeps track of most metrics in file statistics, and only NaN counter is actually tracked by writers.\n+ * This wrapper ensures that metrics not being updated by those writers will not be incorrectly used, by throwing\n  * exceptions when they are accessed.\n  */\n-public class ParquetFieldMetrics extends FieldMetrics {\n+public class NaNFieldMetrics extends FieldMetrics {\n \n   /**\n-   * Constructor for creating a Parquet-specific FieldMetrics.\n+   * Constructor for creating a FieldMetrics with only NaN counter.\n    * @param id field id being tracked by the writer\n    * @param nanValueCount number of NaN values, will only be non-0 for double or float field.\n    */\n-  public ParquetFieldMetrics(int id,\n-                             long nanValueCount) {\n+  public NaNFieldMetrics(int id,\n+                         long nanValueCount) {\n     super(id, 0L, 0L, nanValueCount, null, null);\n   }\n \n   @Override\n   public long valueCount() {\n     throw new IllegalStateException(\n-        \"Shouldn't access valueCount() within ParquetFieldMetrics, as this metric is tracked by Parquet footer. \");\n+        \"Shouldn't access valueCount() within NaNOnlyFieldMetrics, as this metric is tracked in file statistics. \");\n   }\n \n   @Override\n   public long nullValueCount() {\n     throw new IllegalStateException(\n-        \"Shouldn't access nullValueCount() within ParquetFieldMetrics, as this metric is tracked by Parquet footer. \");\n+        \"Shouldn't access nullValueCount() within NaNOnlyFieldMetrics, as this metric is tracked in file statistics. \");\n   }\n \n   @Override\n   public ByteBuffer lowerBound() {\n     throw new IllegalStateException(\n-        \"Shouldn't access lowerBound() within ParquetFieldMetrics, as this metric is tracked by Parquet footer. \");\n+        \"Shouldn't access lowerBound() within NaNOnlyFieldMetrics, as this metric is tracked in file statistics. \");\n   }\n \n   @Override\n   public ByteBuffer upperBound() {\n     throw new IllegalStateException(\n-        \"Shouldn't access upperBound() within ParquetFieldMetrics, as this metric is tracked by Parquet footer. \");\n+        \"Shouldn't access upperBound() within NaNOnlyFieldMetrics, as this metric is tracked in file statistics. \");", "originalCommit": "b7d88f21aa7ee7ec332b5fa628d427351c1988fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "382d39d47ed373116d18afa125475060b0b48827", "url": "https://github.com/apache/iceberg/commit/382d39d47ed373116d18afa125475060b0b48827", "message": "Refactor/rename metrics related classes for NaN support", "committedDate": "2020-12-07T19:47:47Z", "type": "commit"}, {"oid": "6ee1853f3bc641af0833d38125434a81d1fa577c", "url": "https://github.com/apache/iceberg/commit/6ee1853f3bc641af0833d38125434a81d1fa577c", "message": "add javadoc and null check", "committedDate": "2020-12-07T19:47:47Z", "type": "commit"}, {"oid": "ee0ae1d7f93702f4acc74fe80f9c0d69f0491bdc", "url": "https://github.com/apache/iceberg/commit/ee0ae1d7f93702f4acc74fe80f9c0d69f0491bdc", "message": "update based on comments in #1790", "committedDate": "2020-12-07T19:47:47Z", "type": "commit"}, {"oid": "e2da2becdb948a116fa814a9b13e031cb559200e", "url": "https://github.com/apache/iceberg/commit/e2da2becdb948a116fa814a9b13e031cb559200e", "message": "add forgot file", "committedDate": "2020-12-07T19:47:47Z", "type": "commit"}, {"oid": "4bb427f0131b700aac7ea64984bb52bb2c5dd6a6", "url": "https://github.com/apache/iceberg/commit/4bb427f0131b700aac7ea64984bb52bb2c5dd6a6", "message": "address comments", "committedDate": "2020-12-07T19:50:12Z", "type": "commit"}, {"oid": "4bb427f0131b700aac7ea64984bb52bb2c5dd6a6", "url": "https://github.com/apache/iceberg/commit/4bb427f0131b700aac7ea64984bb52bb2c5dd6a6", "message": "address comments", "committedDate": "2020-12-07T19:50:12Z", "type": "forcePushed"}, {"oid": "55b1e5bbf1002ab82f63623acc4e44e9f35b1e5d", "url": "https://github.com/apache/iceberg/commit/55b1e5bbf1002ab82f63623acc4e44e9f35b1e5d", "message": "move generic testing outside of parquet folder", "committedDate": "2020-12-14T23:25:00Z", "type": "commit"}, {"oid": "37a86810f26dbeb7693f78d40f10cec4694165e0", "url": "https://github.com/apache/iceberg/commit/37a86810f26dbeb7693f78d40f10cec4694165e0", "message": "fix timestamp type to use microseconds instead", "committedDate": "2020-12-16T06:25:48Z", "type": "commit"}, {"oid": "37a86810f26dbeb7693f78d40f10cec4694165e0", "url": "https://github.com/apache/iceberg/commit/37a86810f26dbeb7693f78d40f10cec4694165e0", "message": "fix timestamp type to use microseconds instead", "committedDate": "2020-12-16T06:25:48Z", "type": "forcePushed"}]}