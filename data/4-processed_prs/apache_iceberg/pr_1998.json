{"pr_number": 1998, "pr_title": "Hive: ensure unlock is called when new metadata cannot be deleted", "pr_createdAt": "2020-12-28T17:38:58Z", "pr_url": "https://github.com/apache/iceberg/pull/1998", "timeline": [{"oid": "4df96840ea674a160d2fa5af56dda2ecfcd98bd8", "url": "https://github.com/apache/iceberg/commit/4df96840ea674a160d2fa5af56dda2ecfcd98bd8", "message": "Hive: ensure unlock is called when new metadata cannot be deleted", "committedDate": "2020-12-28T17:37:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ0NTcyMg==", "url": "https://github.com/apache/iceberg/pull/1998#discussion_r549445722", "bodyText": "Not a fan of Throw within a Catch.\nMaybe you can wrap it in something else.", "author": "giovannifumarola", "createdAt": "2020-12-28T18:30:04Z", "path": "hive-metastore/src/main/java/org/apache/iceberg/hive/HiveTableOperations.java", "diffHunk": "@@ -367,6 +363,20 @@ private long acquireLock() throws UnknownHostException, TException, InterruptedE\n     return lockId;\n   }\n \n+  private void cleanupMetadataAndUnlock(boolean errorThrown, String metadataLocation, Optional<Long> lockId) {\n+    try {\n+      if (errorThrown) {\n+        // if anything went wrong, clean up the uncommitted metadata file\n+        io().deleteFile(metadataLocation);\n+      }\n+    } catch (RuntimeException e) {\n+      LOG.error(\"Fail to cleanup metadata file at {}\", metadataLocation, e);\n+      throw e;", "originalCommit": "4df96840ea674a160d2fa5af56dda2ecfcd98bd8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ0ODkyNw==", "url": "https://github.com/apache/iceberg/pull/1998#discussion_r549448927", "bodyText": "I think this is fine because we don't want to wrap or modify the original exception, and it is helpful to log the metadata location that was not correctly deleted.", "author": "rdblue", "createdAt": "2020-12-28T18:41:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ0NTcyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY3MTg0MA==", "url": "https://github.com/apache/iceberg/pull/1998#discussion_r549671840", "bodyText": "I think we may leverage runSafely that was added recently.\n    ExceptionUtil.runSafely(\n        () -> {\n          if (errorThrown) {\n            // if anything went wrong, clean up the uncommitted metadata file\n            io().deleteFile(metadataLocation);\n          }\n          return Void.TYPE;\n        },\n        e -> LOG.error(\"Failed to cleanup metadata file at {}\", metadataLocation, e),\n        () -> unlock(lockId));", "author": "aokolnychyi", "createdAt": "2020-12-29T11:34:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ0NTcyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY3MTkwOQ==", "url": "https://github.com/apache/iceberg/pull/1998#discussion_r549671909", "bodyText": "cc @rdblue @jackye1995 @giovannifumarola", "author": "aokolnychyi", "createdAt": "2020-12-29T11:35:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ0NTcyMg=="}], "type": "inlineReview"}]}