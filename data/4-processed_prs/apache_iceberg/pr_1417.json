{"pr_number": 1417, "pr_title": "Hive: Add column projection", "pr_createdAt": "2020-09-03T08:53:59Z", "pr_url": "https://github.com/apache/iceberg/pull/1417", "timeline": [{"oid": "c165dd220e317c0308a13df3afcb03d5d2e65f0c", "url": "https://github.com/apache/iceberg/commit/c165dd220e317c0308a13df3afcb03d5d2e65f0c", "message": "Add column projection", "committedDate": "2020-09-02T14:59:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzAwNzU0NQ==", "url": "https://github.com/apache/iceberg/pull/1417#discussion_r483007545", "bodyText": "I have seen this in Hive code as a comment in ColumnProjectionUtils.getReadColumnIDs:\n      // NOTE: some code uses this list to correlate with column names, and yet these lists may\n      //       contain duplicates, which this call will remove and the other won't. As far as I can\n      //       tell, no code will actually use these two methods together; all is good if the code\n      //       gets the ID list without relying on this method. Or maybe it just works by magic.\n\nNot sure if this comment is still true or it is already fixed. If we might get duplicates I am not sure how Iceberg will behave in this case. Might worth to check. Maybe with some query with different UDFs around the same column?", "author": "pvary", "createdAt": "2020-09-03T14:10:00Z", "path": "mr/src/main/java/org/apache/iceberg/mr/hive/HiveIcebergInputFormat.java", "diffHunk": "@@ -61,6 +62,9 @@\n       }\n     }\n \n+    String[] readColumns = ColumnProjectionUtils.getReadColumnNames(job);", "originalCommit": "c165dd220e317c0308a13df3afcb03d5d2e65f0c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzAyMDA2Mg==", "url": "https://github.com/apache/iceberg/pull/1417#discussion_r483020062", "bodyText": "We stumbled across that same gem of a comment when we originally implemented this in Hiveberg. This seemed to suggest that this method won't return duplicates and thus should be safe to use. We haven't seen any problems so far but yes, if there is some way to trigger the potential duplicates via a Hive query we could add a HiveRunner test for this. Then again, maybe it just works by magic ;)", "author": "massdosage", "createdAt": "2020-09-03T14:26:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzAwNzU0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzEwNDczMg==", "url": "https://github.com/apache/iceberg/pull/1417#discussion_r483104732", "bodyText": "The wording we've generally settled on is that project is used to set a requested schema and select is used to select columns like a SELECT statement in SQL. Following that convention, when we pass a schema we call it a \"projection\" and when we pass columns we call them \"selected columns\".\nI think it would be good to make this more clear, since this is passing columns to project and not a schema. How about SELECTED_COLUMNS = \"iceberg.mr.selected.columns\"?", "author": "rdblue", "createdAt": "2020-09-03T16:24:39Z", "path": "mr/src/main/java/org/apache/iceberg/mr/InputFormatConfig.java", "diffHunk": "@@ -47,6 +47,7 @@ private InputFormatConfig() {\n   public static final String CATALOG = \"iceberg.mr.catalog\";\n   public static final String HADOOP_CATALOG_WAREHOUSE_LOCATION = \"iceberg.mr.catalog.hadoop.warehouse.location\";\n   public static final String CATALOG_LOADER_CLASS = \"iceberg.mr.catalog.loader.class\";\n+  public static final String COLUMN_PROJECTIONS = \"iceberg.mr.column.projections\";", "originalCommit": "c165dd220e317c0308a13df3afcb03d5d2e65f0c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzEwNTE1MQ==", "url": "https://github.com/apache/iceberg/pull/1417#discussion_r483105151", "bodyText": "Could we use a List instead of an array of strings here? It's usually easier if Iceberg converts to an array instead of expecting the caller to.", "author": "rdblue", "createdAt": "2020-09-03T16:25:19Z", "path": "mr/src/main/java/org/apache/iceberg/mr/InputFormatConfig.java", "diffHunk": "@@ -93,6 +94,11 @@ public ConfigBuilder schema(Schema schema) {\n       return this;\n     }\n \n+    public ConfigBuilder select(String[] columns) {", "originalCommit": "c165dd220e317c0308a13df3afcb03d5d2e65f0c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzkzNDk4MQ==", "url": "https://github.com/apache/iceberg/pull/1417#discussion_r483934981", "bodyText": "I believe that this is using String[] as the IcebergInputFormat has been changed in this PR to call org.apache.hadoop.conf.Configuration#getStrings method which returns String[].\nHowever, I agree with the usage of collections (or Lists) vs String[]. It should be noted that org.apache.hadoop.conf.Configuration also has a getStringCollection function that could be called instead.\nDocumentation on getStringCollection:\nhttps://hadoop.apache.org/docs/current/api/org/apache/hadoop/conf/Configuration.html#getStringCollection-java.lang.String-", "author": "kbendick", "createdAt": "2020-09-05T10:01:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzEwNTE1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzkzNTM2Mg==", "url": "https://github.com/apache/iceberg/pull/1417#discussion_r483935362", "bodyText": "In line with @rdblue's comment above, the usage of columnsToProject is potentially confusing given on the difference we've settled on for when to use project vs select. Additionally, there's a project call above on the parsed schema followed by this select, so the diffference between the two is especially noticeable here.\nIn addition to updating the added config's name to SELECTED_COLUMNS, can you possibly change columnsToProject to be columnsToSelect or even simpler, just selectedColumns?", "author": "kbendick", "createdAt": "2020-09-05T10:06:35Z", "path": "mr/src/main/java/org/apache/iceberg/mr/mapreduce/IcebergInputFormat.java", "diffHunk": "@@ -111,6 +111,10 @@\n     if (schemaStr != null) {\n       scan.project(SchemaParser.fromJson(schemaStr));\n     }\n+    String[] columnsToProject = conf.getStrings(InputFormatConfig.COLUMN_PROJECTIONS, null);\n+    if (columnsToProject != null) {\n+      scan.select(columnsToProject);", "originalCommit": "c165dd220e317c0308a13df3afcb03d5d2e65f0c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "36d48bee358f0ee7ac47cd2a871aa2bf3c8fb080", "url": "https://github.com/apache/iceberg/commit/36d48bee358f0ee7ac47cd2a871aa2bf3c8fb080", "message": "Add projection to serde and recordreader", "committedDate": "2020-09-16T13:28:12Z", "type": "commit"}, {"oid": "af369392010e44f0dc7533e9509d3617a25160aa", "url": "https://github.com/apache/iceberg/commit/af369392010e44f0dc7533e9509d3617a25160aa", "message": "merge and resolve conflicts", "committedDate": "2020-11-02T17:20:57Z", "type": "commit"}, {"oid": "1ee90b7f30952e83f6875c7ee12b726e87486f99", "url": "https://github.com/apache/iceberg/commit/1ee90b7f30952e83f6875c7ee12b726e87486f99", "message": "Projection pushdown changes (#18)\n\n* Always check the selected columns when getting a record reader\r\n* Hive: Run StorageHandler tests in both MR and Tez (#1695)\r\n* Disable vectorized Tez executions temporarily\r\nCo-authored-by: Marton Bod <mbod@cloudera.com>", "committedDate": "2020-11-18T14:42:27Z", "type": "commit"}, {"oid": "d97f1b2e88331940fafc6545ce5e3d8081f6d71e", "url": "https://github.com/apache/iceberg/commit/d97f1b2e88331940fafc6545ce5e3d8081f6d71e", "message": "Merge branch 'master' into hive-column-projection", "committedDate": "2020-11-18T14:52:10Z", "type": "commit"}, {"oid": "a8310524fe3d4d15d86f54f628b14fab03de4098", "url": "https://github.com/apache/iceberg/commit/a8310524fe3d4d15d86f54f628b14fab03de4098", "message": "Fix checkstyle problem (#19)\n\n* Always check the selected columns when getting a record reader\r\n* Hive: Run StorageHandler tests in both MR and Tez (#1695)\r\n* fix checkstyle problem\r\n\r\nCo-authored-by: Marton Bod <mbod@cloudera.com>\r\nCo-authored-by: Adrian Woodhead <awoodhead@expediagroup.com>", "committedDate": "2020-11-18T15:11:59Z", "type": "commit"}, {"oid": "3e1698b324cb1b25866e1bfae375002ca6dfc534", "url": "https://github.com/apache/iceberg/commit/3e1698b324cb1b25866e1bfae375002ca6dfc534", "message": "Merge branch 'master' into hive-column-projection", "committedDate": "2020-11-26T14:57:47Z", "type": "commit"}]}