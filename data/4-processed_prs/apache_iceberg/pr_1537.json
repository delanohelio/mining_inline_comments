{"pr_number": 1537, "pr_title": "API: Add name to Table and Catalog APIs", "pr_createdAt": "2020-10-01T00:55:38Z", "pr_url": "https://github.com/apache/iceberg/pull/1537", "timeline": [{"oid": "e37015cf1727c0ea108b5a18cdbe03b788f3bd9a", "url": "https://github.com/apache/iceberg/commit/e37015cf1727c0ea108b5a18cdbe03b788f3bd9a", "message": "API: Add name to Table and Catalog APIs", "committedDate": "2020-10-01T00:53:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg5NTIzNQ==", "url": "https://github.com/apache/iceberg/pull/1537#discussion_r497895235", "bodyText": "I did not intend to add the name to the Catalog API but we need this for proper metadata table names.", "author": "aokolnychyi", "createdAt": "2020-10-01T00:56:50Z", "path": "api/src/main/java/org/apache/iceberg/catalog/Catalog.java", "diffHunk": "@@ -35,6 +35,15 @@\n  */\n public interface Catalog {\n \n+  /**\n+   * Return the name for this catalog.\n+   *\n+   * @return this catalog's name\n+   */\n+  default String name() {", "originalCommit": "e37015cf1727c0ea108b5a18cdbe03b788f3bd9a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg5NjQxMw==", "url": "https://github.com/apache/iceberg/pull/1537#discussion_r497896413", "bodyText": "It is debatable whether we have to default this. I did this to avoid breaking custom implementations.", "author": "aokolnychyi", "createdAt": "2020-10-01T00:58:36Z", "path": "api/src/main/java/org/apache/iceberg/Table.java", "diffHunk": "@@ -30,6 +30,15 @@\n  */\n public interface Table {\n \n+  /**\n+   * Return the full name for this table.\n+   *\n+   * @return this table's name\n+   */\n+  default String name() {", "originalCommit": "e37015cf1727c0ea108b5a18cdbe03b788f3bd9a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg5NzEyNw==", "url": "https://github.com/apache/iceberg/pull/1537#discussion_r497897127", "bodyText": "This was broken before as the name of the metadata table started with its type, not catalog.", "author": "aokolnychyi", "createdAt": "2020-10-01T00:59:50Z", "path": "core/src/main/java/org/apache/iceberg/MetadataTableUtils.java", "diffHunk": "@@ -59,10 +59,10 @@ public static Table createMetadataTableInstance(TableOperations originTableOps,\n   }\n \n   public static Table createMetadataTableInstance(TableOperations originTableOps,\n+                                                  String catalogName,", "originalCommit": "e37015cf1727c0ea108b5a18cdbe03b788f3bd9a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg5ODE2NQ==", "url": "https://github.com/apache/iceberg/pull/1537#discussion_r497898165", "bodyText": "Metadata tables loaded through HadoopTables will have their names as location.type (which is weird as we normally use location#type). I am not sure whether it is a big deal or not.", "author": "aokolnychyi", "createdAt": "2020-10-01T01:01:26Z", "path": "core/src/test/java/org/apache/iceberg/hadoop/TestHadoopTables.java", "diffHunk": "@@ -139,6 +139,18 @@ public void testCustomSortOrder() {\n     Assert.assertEquals(\"Transform must match\", transform, sortOrder.fields().get(0).transform());\n   }\n \n+  @Test\n+  public void testTableName() {\n+    PartitionSpec spec = PartitionSpec.builderFor(SCHEMA)\n+        .bucket(\"data\", 16)\n+        .build();\n+    String location = tableDir.toURI().toString();\n+    TABLES.create(SCHEMA, spec, location);\n+\n+    Table table = TABLES.load(location);", "originalCommit": "e37015cf1727c0ea108b5a18cdbe03b788f3bd9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzk3OTMzNg==", "url": "https://github.com/apache/iceberg/pull/1537#discussion_r497979336", "bodyText": "I think ideally you would be able to use the result of name to load the table. I'd prefer to fix it if we can. Maybe we should pass the full metadata table name in, rather than having it added by the table implementation.", "author": "rdblue", "createdAt": "2020-10-01T04:39:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg5ODE2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQwNTEwOA==", "url": "https://github.com/apache/iceberg/pull/1537#discussion_r498405108", "bodyText": "I fixed it but it did require substantially more changes.", "author": "aokolnychyi", "createdAt": "2020-10-01T17:26:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg5ODE2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzk3ODU5NQ==", "url": "https://github.com/apache/iceberg/pull/1537#discussion_r497978595", "bodyText": "Why rename this?", "author": "rdblue", "createdAt": "2020-10-01T04:35:51Z", "path": "core/src/main/java/org/apache/iceberg/BaseMetastoreCatalog.java", "diffHunk": "@@ -129,16 +129,16 @@ public TableBuilder buildTable(TableIdentifier identifier, Schema schema) {\n   }\n \n   private Table loadMetadataTable(TableIdentifier identifier) {\n-    String name = identifier.name();\n-    MetadataTableType type = MetadataTableType.from(name);\n+    String tableName = identifier.name();\n+    MetadataTableType type = MetadataTableType.from(tableName);", "originalCommit": "e37015cf1727c0ea108b5a18cdbe03b788f3bd9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQwNDg0NA==", "url": "https://github.com/apache/iceberg/pull/1537#discussion_r498404844", "bodyText": "We use name() a few lines below now. I think it will be confusing to have name() that is the catalog name and name that is the metadata table name in the same method.", "author": "aokolnychyi", "createdAt": "2020-10-01T17:26:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzk3ODU5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQxMTE5Nw==", "url": "https://github.com/apache/iceberg/pull/1537#discussion_r498411197", "bodyText": "Makes sense, but if this is the metadata table name (e.g. \"files\") instead of the table name, I think it might make more sense to be specific: metadataName?", "author": "rdblue", "createdAt": "2020-10-01T17:38:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzk3ODU5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ1OTM1Mg==", "url": "https://github.com/apache/iceberg/pull/1537#discussion_r498459352", "bodyText": "I feel like the current way is a bit more consistent with the overall structure of the method: the method name is loadMetadataTable and we use baseTableIdentifier to refer to the base table.", "author": "aokolnychyi", "createdAt": "2020-10-01T19:10:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzk3ODU5NQ=="}], "type": "inlineReview"}, {"oid": "c737af65de69f1e54545d559c04c6dded23323e5", "url": "https://github.com/apache/iceberg/commit/c737af65de69f1e54545d559c04c6dded23323e5", "message": "Fix Hadoop tables", "committedDate": "2020-10-01T17:22:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQwNDE1Ng==", "url": "https://github.com/apache/iceberg/pull/1537#discussion_r498404156", "bodyText": "We instantiate some metadata tables in tests so I kept the old constructor too. Won't harm if someone is using it directly too.", "author": "aokolnychyi", "createdAt": "2020-10-01T17:25:12Z", "path": "core/src/main/java/org/apache/iceberg/AllDataFilesTable.java", "diffHunk": "@@ -42,10 +42,16 @@\n public class AllDataFilesTable extends BaseMetadataTable {\n   private final TableOperations ops;\n   private final Table table;\n+  private final String name;\n \n   public AllDataFilesTable(TableOperations ops, Table table) {", "originalCommit": "c737af65de69f1e54545d559c04c6dded23323e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQwODkxNQ==", "url": "https://github.com/apache/iceberg/pull/1537#discussion_r498408915", "bodyText": "Does it need to be public? Maybe we should make the constructors package-private while we're making these changes. What do you think?", "author": "rdblue", "createdAt": "2020-10-01T17:33:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQwNDE1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ1NzYwNA==", "url": "https://github.com/apache/iceberg/pull/1537#discussion_r498457604", "bodyText": "Updated.", "author": "aokolnychyi", "createdAt": "2020-10-01T19:06:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQwNDE1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQxMjE0MQ==", "url": "https://github.com/apache/iceberg/pull/1537#discussion_r498412141", "bodyText": "Minor: Although it is the same thing, I think it would make this more readable to use catalog.name() directly. That way it is clear that the name isn't coming from the caching catalog.", "author": "rdblue", "createdAt": "2020-10-01T17:39:45Z", "path": "core/src/main/java/org/apache/iceberg/CachingCatalog.java", "diffHunk": "@@ -78,7 +83,9 @@ public Table loadTable(TableIdentifier ident) {\n         TableOperations ops = ((HasTableOperations) originTable).operations();\n         MetadataTableType type = MetadataTableType.from(canonicalized.name());\n \n-        Table metadataTable = MetadataTableUtils.createMetadataTableInstance(ops, originTableIdentifier, type);\n+        Table metadataTable = MetadataTableUtils.createMetadataTableInstance(\n+            ops, name(), originTableIdentifier,", "originalCommit": "c737af65de69f1e54545d559c04c6dded23323e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ1NzUyMg==", "url": "https://github.com/apache/iceberg/pull/1537#discussion_r498457522", "bodyText": "Done.", "author": "aokolnychyi", "createdAt": "2020-10-01T19:06:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQxMjE0MQ=="}], "type": "inlineReview"}, {"oid": "62b80cbf09bcc811dbfa63e5738b0c85c5fe7512", "url": "https://github.com/apache/iceberg/commit/62b80cbf09bcc811dbfa63e5738b0c85c5fe7512", "message": "Minor updates", "committedDate": "2020-10-01T19:06:08Z", "type": "commit"}, {"oid": "ccad56763e76232eb0d7ddca84e747fd9413ac3f", "url": "https://github.com/apache/iceberg/commit/ccad56763e76232eb0d7ddca84e747fd9413ac3f", "message": "Minor cleanup", "committedDate": "2020-10-01T19:12:53Z", "type": "commit"}]}