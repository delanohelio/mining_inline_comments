{"pr_number": 936, "pr_title": "Update TableTestBase tests to run with formats v1 and v2", "pr_createdAt": "2020-04-17T21:41:20Z", "pr_url": "https://github.com/apache/iceberg/pull/936", "timeline": [{"oid": "5c08e31589895f1965efbf0bb0c793376a805541", "url": "https://github.com/apache/iceberg/commit/5c08e31589895f1965efbf0bb0c793376a805541", "message": "Update TableTestBase tests to run on v1 and v2.", "committedDate": "2020-04-17T22:06:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU1MjIyMQ==", "url": "https://github.com/apache/iceberg/pull/936#discussion_r411552221", "bodyText": "This needed to change because it isn't possible to write entries to a manifest that inherits a sequence number but not snapshot ID, unless the snapshot ID matches the commit.", "author": "rdblue", "createdAt": "2020-04-20T17:17:43Z", "path": "core/src/test/java/org/apache/iceberg/TestManifestWriter.java", "diffHunk": "@@ -24,22 +24,36 @@\n import org.apache.iceberg.ManifestEntry.Status;\n import org.junit.Assert;\n import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.Parameterized;\n \n+@RunWith(Parameterized.class)\n public class TestManifestWriter extends TableTestBase {\n+  @Parameterized.Parameters\n+  public static Object[][] parameters() {\n+    return new Object[][] {\n+        new Object[] { 1 },\n+        new Object[] { 2 },\n+    };\n+  }\n+\n+  public TestManifestWriter(int formatVersion) {\n+    super(formatVersion);\n+  }\n \n   @Test\n   public void testManifestStats() throws IOException {\n     ManifestFile manifest = writeManifest(\n         \"manifest.avro\",\n-        manifestEntry(Status.ADDED, 100L, newFile(10)),\n-        manifestEntry(Status.ADDED, 100L, newFile(20)),\n-        manifestEntry(Status.ADDED, 100L, newFile(5)),\n-        manifestEntry(Status.ADDED, 100L, newFile(5)),\n-        manifestEntry(Status.EXISTING, 100L, newFile(15)),\n-        manifestEntry(Status.EXISTING, 100L, newFile(10)),\n-        manifestEntry(Status.EXISTING, 100L, newFile(1)),\n-        manifestEntry(Status.DELETED, 100L, newFile(5)),\n-        manifestEntry(Status.DELETED, 100L, newFile(2)));\n+        manifestEntry(Status.ADDED, null, newFile(10)),\n+        manifestEntry(Status.ADDED, null, newFile(20)),\n+        manifestEntry(Status.ADDED, null, newFile(5)),\n+        manifestEntry(Status.ADDED, null, newFile(5)),\n+        manifestEntry(Status.EXISTING, null, newFile(15)),\n+        manifestEntry(Status.EXISTING, null, newFile(10)),\n+        manifestEntry(Status.EXISTING, null, newFile(1)),\n+        manifestEntry(Status.DELETED, null, newFile(5)),\n+        manifestEntry(Status.DELETED, null, newFile(2)));", "originalCommit": "5c08e31589895f1965efbf0bb0c793376a805541", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQxNTc0Mg==", "url": "https://github.com/apache/iceberg/pull/936#discussion_r412415742", "bodyText": "Whenever we are rewriting manifests in the rewrite manifests action, we create a manifest with snapshot id = null but each entry is assigned a valid snapshot id. Will that continue to work?", "author": "aokolnychyi", "createdAt": "2020-04-21T19:03:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU1MjIyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQzODk2Mg==", "url": "https://github.com/apache/iceberg/pull/936#discussion_r412438962", "bodyText": "Yes. The problem here was that entries had a null snapshot ID, but they shouldn't for rewrites.", "author": "rdblue", "createdAt": "2020-04-21T19:39:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU1MjIyMQ=="}], "type": "inlineReview"}, {"oid": "ad15ff4b395d3220517f860e052edc19e1e493c2", "url": "https://github.com/apache/iceberg/commit/ad15ff4b395d3220517f860e052edc19e1e493c2", "message": "Update TableTestBase tests to run on v1 and v2.", "committedDate": "2020-04-20T21:05:31Z", "type": "forcePushed"}, {"oid": "9d8998073a3f9676eeca9a2fb09d91f695497874", "url": "https://github.com/apache/iceberg/commit/9d8998073a3f9676eeca9a2fb09d91f695497874", "message": "Update TableTestBase tests to run on v1 and v2.", "committedDate": "2020-04-20T21:20:18Z", "type": "commit"}, {"oid": "9d8998073a3f9676eeca9a2fb09d91f695497874", "url": "https://github.com/apache/iceberg/commit/9d8998073a3f9676eeca9a2fb09d91f695497874", "message": "Update TableTestBase tests to run on v1 and v2.", "committedDate": "2020-04-20T21:20:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTcwMDg4OQ==", "url": "https://github.com/apache/iceberg/pull/936#discussion_r411700889", "bodyText": "This is needed to create v2 tables in tests. It isn't public.", "author": "rdblue", "createdAt": "2020-04-20T21:21:54Z", "path": "core/src/main/java/org/apache/iceberg/TableMetadata.java", "diffHunk": "@@ -52,6 +52,14 @@ public static TableMetadata newTableMetadata(Schema schema,\n                                                PartitionSpec spec,\n                                                String location,\n                                                Map<String, String> properties) {\n+    return newTableMetadata(schema, spec, location, properties, DEFAULT_TABLE_FORMAT_VERSION);\n+  }\n+\n+  static TableMetadata newTableMetadata(Schema schema,\n+                                        PartitionSpec spec,\n+                                        String location,\n+                                        Map<String, String> properties,\n+                                        int formatVersion) {", "originalCommit": "9d8998073a3f9676eeca9a2fb09d91f695497874", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3MjM0MQ==", "url": "https://github.com/apache/iceberg/pull/936#discussion_r412372341", "bodyText": "Is it something we want to annotate with @VisibleForTesting?", "author": "aokolnychyi", "createdAt": "2020-04-21T17:58:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTcwMDg4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQyOTM3OA==", "url": "https://github.com/apache/iceberg/pull/936#discussion_r412429378", "bodyText": "We don't use that annotation elsewhere and I'm reluctant to start because it increases our dependence on guava. It is also likely that we will open this up later, so I don't think we need to.", "author": "rdblue", "createdAt": "2020-04-21T19:23:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTcwMDg4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTcwMTI3OQ==", "url": "https://github.com/apache/iceberg/pull/936#discussion_r411701279", "bodyText": "Copied manifests will use a null snapshot ID.", "author": "rdblue", "createdAt": "2020-04-20T21:22:42Z", "path": "core/src/main/java/org/apache/iceberg/V2Metadata.java", "diffHunk": "@@ -243,11 +243,11 @@ static Schema wrapFileSchema(Types.StructType fileSchema) {\n \n   static class IndexedManifestEntry implements ManifestEntry, IndexedRecord {\n     private final org.apache.avro.Schema avroSchema;\n-    private final long commitSnapshotId;\n+    private final Long commitSnapshotId;\n     private final V1Metadata.IndexedDataFile fileWrapper;\n     private ManifestEntry wrapped = null;\n \n-    IndexedManifestEntry(long commitSnapshotId, Types.StructType partitionType) {\n+    IndexedManifestEntry(Long commitSnapshotId, Types.StructType partitionType) {", "originalCommit": "9d8998073a3f9676eeca9a2fb09d91f695497874", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3MTU3NQ==", "url": "https://github.com/apache/iceberg/pull/936#discussion_r412371575", "bodyText": "Does this mean manifests will be written with the v2 schema (i.e. with sequence numbers) even though TableMetadata is v1 and the manifest list is written with v1? And this should work because we do a projection on read and sequence number is optional?", "author": "aokolnychyi", "createdAt": "2020-04-21T17:57:43Z", "path": "core/src/main/java/org/apache/iceberg/ManifestFiles.java", "diffHunk": "@@ -73,8 +73,8 @@ public static ManifestReader read(ManifestFile manifest, FileIO io, Map<Integer,\n    * @return a manifest writer\n    */\n   public static ManifestWriter write(PartitionSpec spec, OutputFile outputFile) {\n-    // always use a v1 writer for appended manifests because sequence number must be inherited\n-    return write(1, spec, outputFile, null);\n+    // always use a v2 writer to preserve sequence numbers, but use null for sequence number so appends inherit", "originalCommit": "9d8998073a3f9676eeca9a2fb09d91f695497874", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM4MDI2NA==", "url": "https://github.com/apache/iceberg/pull/936#discussion_r412380264", "bodyText": "This is the constructor used to create an append or rewritten manifest, so this makes the manifests that are passed into FastAppend, MergeAppend, and RewriteManifests support sequence numbers. It is needed for the last case: when rewriting a manifest for a v2 table, we need to preserve sequence numbers.\nThis works for v1 because v1 tables will ignore the new fields.", "author": "rdblue", "createdAt": "2020-04-21T18:10:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3MTU3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQzMDgwOA==", "url": "https://github.com/apache/iceberg/pull/936#discussion_r412430808", "bodyText": "I think we have to update the condition in get as commitSnapshotId is now Long and we cannot use ==.", "author": "aokolnychyi", "createdAt": "2020-04-21T19:26:17Z", "path": "core/src/main/java/org/apache/iceberg/V2Metadata.java", "diffHunk": "@@ -243,11 +243,11 @@ static Schema wrapFileSchema(Types.StructType fileSchema) {\n \n   static class IndexedManifestEntry implements ManifestEntry, IndexedRecord {\n     private final org.apache.avro.Schema avroSchema;\n-    private final long commitSnapshotId;\n+    private final Long commitSnapshotId;", "originalCommit": "9d8998073a3f9676eeca9a2fb09d91f695497874", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQzNDIwMQ==", "url": "https://github.com/apache/iceberg/pull/936#discussion_r412434201", "bodyText": "Isn't this okay because it will unbox the values first? Using equals would duplicate the null checks, I thought.", "author": "rdblue", "createdAt": "2020-04-21T19:31:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQzMDgwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQzNjA2MQ==", "url": "https://github.com/apache/iceberg/pull/936#discussion_r412436061", "bodyText": "Fixed", "author": "rdblue", "createdAt": "2020-04-21T19:34:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQzMDgwOA=="}], "type": "inlineReview"}, {"oid": "c9c40b12231b09a784b3717d3f75504610edc6e5", "url": "https://github.com/apache/iceberg/commit/c9c40b12231b09a784b3717d3f75504610edc6e5", "message": "Fix equality check.", "committedDate": "2020-04-21T19:38:22Z", "type": "commit"}]}