{"pr_number": 1872, "pr_title": "Core: add contains_nan to field_summary", "pr_createdAt": "2020-12-03T19:44:11Z", "pr_url": "https://github.com/apache/iceberg/pull/1872", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI4ODQ4MQ==", "url": "https://github.com/apache/iceberg/pull/1872#discussion_r536288481", "bodyText": "have we made sure changing the position is backwards compatible?", "author": "jackye1995", "createdAt": "2020-12-04T18:17:04Z", "path": "core/src/main/java/org/apache/iceberg/GenericPartitionFieldSummary.java", "diffHunk": "@@ -136,8 +144,10 @@ public Object get(int i) {\n       case 0:\n         return containsNull;\n       case 1:\n-        return lowerBound();\n+        return containsNaN;", "originalCommit": "beb1b41da649310ac836dea31856137b18478f4e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMwOTA1Mg==", "url": "https://github.com/apache/iceberg/pull/1872#discussion_r536309052", "bodyText": "This is a good point, I forgot that primitive boolean will be default to false which will impact correctness when we use this in evaluator. I'll make this nullable. Thanks for pointing this out!", "author": "yyanyy", "createdAt": "2020-12-04T18:53:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI4ODQ4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjkyODIzOA==", "url": "https://github.com/apache/iceberg/pull/1872#discussion_r536928238", "bodyText": "The position change is compatible. All Iceberg metadata files conform to the Iceberg data file spec, so we can reorder columns if we choose.", "author": "rdblue", "createdAt": "2020-12-06T01:21:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI4ODQ4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzc5Njg0NA==", "url": "https://github.com/apache/iceberg/pull/1872#discussion_r537796844", "bodyText": "Ah sorry I misread the original question... Thanks Ryan for help with answering it!", "author": "yyanyy", "createdAt": "2020-12-07T20:07:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI4ODQ4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjkyODEyNw==", "url": "https://github.com/apache/iceberg/pull/1872#discussion_r536928127", "bodyText": "Why use Boolean instead of the primitive here? Is there a place that constructs these without knowing whether there are NaN values?", "author": "rdblue", "createdAt": "2020-12-06T01:20:54Z", "path": "core/src/main/java/org/apache/iceberg/GenericPartitionFieldSummary.java", "diffHunk": "@@ -72,10 +73,11 @@ public GenericPartitionFieldSummary(Schema avroSchema) {\n     }\n   }\n \n-  public GenericPartitionFieldSummary(boolean containsNull, ByteBuffer lowerBound,\n+  public GenericPartitionFieldSummary(boolean containsNull, Boolean containsNaN, ByteBuffer lowerBound,", "originalCommit": "c59ec69204c98f45c4a75e35b6a21522ed576412", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzc5Njg5Nw==", "url": "https://github.com/apache/iceberg/pull/1872#discussion_r537796897", "bodyText": "This is for a test case that provide null here to test backward compatibility. I guess I'll mark this constructor as @VisibleForTesting and create another public one that accepts boolean?", "author": "yyanyy", "createdAt": "2020-12-07T20:07:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjkyODEyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjkyODM5OQ==", "url": "https://github.com/apache/iceberg/pull/1872#discussion_r536928399", "bodyText": "Since this is a boolean, maybe we can change the constructor as well.", "author": "rdblue", "createdAt": "2020-12-06T01:22:36Z", "path": "core/src/main/java/org/apache/iceberg/PartitionSummary.java", "diffHunk": "@@ -73,14 +75,16 @@ private PartitionFieldStats(Type type) {\n     }\n \n     public PartitionFieldSummary toSummary() {\n-      return new GenericPartitionFieldSummary(containsNull,\n+      return new GenericPartitionFieldSummary(containsNull, containsNaN,", "originalCommit": "c59ec69204c98f45c4a75e35b6a21522ed576412", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bf0e751859bb66bbb03b4754e17ae79aa5c6a7d6", "url": "https://github.com/apache/iceberg/commit/bf0e751859bb66bbb03b4754e17ae79aa5c6a7d6", "message": "Core: add contains_nan to field_summary", "committedDate": "2020-12-07T22:47:00Z", "type": "commit"}, {"oid": "87ebfc0a26d7b61e44ceda9e9c6e35eda1a9e3b7", "url": "https://github.com/apache/iceberg/commit/87ebfc0a26d7b61e44ceda9e9c6e35eda1a9e3b7", "message": "make containsNaN nullable", "committedDate": "2020-12-07T22:47:00Z", "type": "commit"}, {"oid": "1277887017e4f62dfc02fe7476832a66f1118741", "url": "https://github.com/apache/iceberg/commit/1277887017e4f62dfc02fe7476832a66f1118741", "message": "changes after rebase", "committedDate": "2020-12-07T22:47:00Z", "type": "commit"}, {"oid": "1277887017e4f62dfc02fe7476832a66f1118741", "url": "https://github.com/apache/iceberg/commit/1277887017e4f62dfc02fe7476832a66f1118741", "message": "changes after rebase", "committedDate": "2020-12-07T22:47:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDUxMTQzNQ==", "url": "https://github.com/apache/iceberg/pull/1872#discussion_r544511435", "bodyText": "Does it make sense for this to have a default of null?", "author": "holdenk", "createdAt": "2020-12-16T18:05:17Z", "path": "api/src/main/java/org/apache/iceberg/ManifestFile.java", "diffHunk": "@@ -199,6 +200,12 @@ default boolean hasDeletedFiles() {\n      */\n     boolean containsNull();\n \n+    /**\n+     * Returns true if at least one data file in the manifest has a nan value for the field.\n+     * Null if this information doesn't exist.\n+     */\n+    Boolean containsNaN();", "originalCommit": "1277887017e4f62dfc02fe7476832a66f1118741", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDUzMjE4Ng==", "url": "https://github.com/apache/iceberg/pull/1872#discussion_r544532186", "bodyText": "I think once this change is released, this field will be populated by default, and making it nullable is mostly for backward compatibility; also the unassigned value for this field is null in both the actual implementation and test implementation, so I think defaulting to null here might not help much?", "author": "yyanyy", "createdAt": "2020-12-16T18:36:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDUxMTQzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcyNzcxNA==", "url": "https://github.com/apache/iceberg/pull/1872#discussion_r544727714", "bodyText": "While we don't expect other implementations of this interface, it is a fair point that we would accept other implementations in any method that uses ManifestFile as an argument type. Adding the default would ensure backward-compatiblity in case anyone has an alternative implementation, and is really low cost. So I'd opt to add it. Thanks @holdenk!", "author": "rdblue", "createdAt": "2020-12-17T00:46:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDUxMTQzNQ=="}], "type": "inlineReview"}, {"oid": "bade62f2235d660d7863a33b024a893ccaefde1b", "url": "https://github.com/apache/iceberg/commit/bade62f2235d660d7863a33b024a893ccaefde1b", "message": "default containsNaN() to null in manifest file", "committedDate": "2020-12-17T01:46:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjAzODgwOQ==", "url": "https://github.com/apache/iceberg/pull/1872#discussion_r546038809", "bodyText": "Nit: do should we add a closing  in the docstring?", "author": "holdenk", "createdAt": "2020-12-18T19:13:28Z", "path": "api/src/main/java/org/apache/iceberg/ManifestFile.java", "diffHunk": "@@ -203,8 +203,12 @@ default boolean hasDeletedFiles() {\n     /**\n      * Returns true if at least one data file in the manifest has a nan value for the field.\n      * Null if this information doesn't exist.\n+     * <p>", "originalCommit": "bade62f2235d660d7863a33b024a893ccaefde1b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjA4OTMxOQ==", "url": "https://github.com/apache/iceberg/pull/1872#discussion_r546089319", "bodyText": "According to this I think <p> itself might be enough?\n\nIf you have more than one paragraph in the doc comment, separate the paragraphs with a <p> paragraph tag, as shown", "author": "yyanyy", "createdAt": "2020-12-18T21:02:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjAzODgwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM2NDk4OA==", "url": "https://github.com/apache/iceberg/pull/1872#discussion_r555364988", "bodyText": "Just going back to the discussion of default to make sure my understanding is correct, if the returned value is null, does it mean the manifest file would suggest the data file does not contain NaN?\nThis behavior seems consistent with the default false in PartitionSummary.java, but logically speaking it seems like returning true as default is more reasonable to suggest a file always might contain NaN. What is the take here?", "author": "jackye1995", "createdAt": "2021-01-11T21:55:13Z", "path": "api/src/main/java/org/apache/iceberg/ManifestFile.java", "diffHunk": "@@ -199,6 +200,16 @@ default boolean hasDeletedFiles() {\n      */\n     boolean containsNull();\n \n+    /**\n+     * Returns true if at least one data file in the manifest has a nan value for the field.\n+     * Null if this information doesn't exist.\n+     * <p>\n+     * Default to return null to ensure backward compatibility.\n+     */\n+    default Boolean containsNaN() {\n+      return null;", "originalCommit": "bade62f2235d660d7863a33b024a893ccaefde1b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTQ2MzQ1Ng==", "url": "https://github.com/apache/iceberg/pull/1872#discussion_r555463456", "bodyText": "I think PartitionSummary is populated when trying to write a file, so if the code contains this change, it will populate and write NaN boolean correctly. I guess you might be thinking about GenericPartitionFieldSummary when you mention returning true as default since that's the class to be constructed when reading from avro files that may not contain this info?", "author": "yyanyy", "createdAt": "2021-01-12T02:04:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM2NDk4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njk2ODA0MQ==", "url": "https://github.com/apache/iceberg/pull/1872#discussion_r556968041", "bodyText": "I see, make sense, thanks for the explanation.", "author": "jackye1995", "createdAt": "2021-01-14T00:35:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM2NDk4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTAyNTAyOA==", "url": "https://github.com/apache/iceberg/pull/1872#discussion_r569025028", "bodyText": "I understand that this is trying to retain the previous behavior, but if containsNaN is not known, it seems safer to assume there is a NaN value.\nI think there is an argument for doing this: at one point, NaN wasn't handled separately and if lower and upper were null then there were no non-null values. A NaN would cause a bound to be non-null. The problem is that we must accept manifests that were written with the new rule (don't store NaN for lower), but that didn't set this. I'd prefer to go with the safer option.", "author": "rdblue", "createdAt": "2021-02-03T00:27:20Z", "path": "api/src/main/java/org/apache/iceberg/expressions/ManifestEvaluator.java", "diffHunk": "@@ -144,18 +143,37 @@ public Boolean or(Boolean leftResult, Boolean rightResult) {\n     @Override\n     public <T> Boolean isNaN(BoundReference<T> ref) {\n       int pos = Accessors.toPosition(ref.accessor());\n-      // containsNull encodes whether at least one partition value is null, lowerBound is null if\n-      // all partition values are null.\n-      if (stats.get(pos).containsNull() && stats.get(pos).lowerBound() == null) {\n-        return ROWS_CANNOT_MATCH; // all values are null\n+\n+      if (stats.get(pos).containsNaN() != null && !stats.get(pos).containsNaN()) {\n+        return ROWS_CANNOT_MATCH;\n+      }\n+\n+      if (allValuesAreNull(stats.get(pos))) {\n+        return ROWS_CANNOT_MATCH;\n       }\n \n       return ROWS_MIGHT_MATCH;\n     }\n \n+    private boolean allValuesAreNull(PartitionFieldSummary summary) {\n+      // Before introducing containsNaN field, containsNull encodes whether at least one partition value is null,\n+      // lowerBound is null if all partition values are null.\n+      // After introducing containsNaN field, containsNaN must be false to ensure all values are null since bounds\n+      // don't include NaN anymore.\n+      return summary.containsNull() && summary.lowerBound() == null &&\n+          (summary.containsNaN() == null || !summary.containsNaN());", "originalCommit": "bade62f2235d660d7863a33b024a893ccaefde1b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTAzMDY4Mg==", "url": "https://github.com/apache/iceberg/pull/1872#discussion_r569030682", "bodyText": "One more thing: if we go for the safer option, we only need to do that for float and double columns. All other types can't contain NaN.", "author": "rdblue", "createdAt": "2021-02-03T00:43:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTAyNTAyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDYwOTcyMg==", "url": "https://github.com/apache/iceberg/pull/1872#discussion_r570609722", "bodyText": "I think the change for excluding NaN in lower/upper and adding containsNaN both belong to this PR, so if a release contains this change, then it would either be (1) NaN is part of lower/upper and containsNaN is missing, or (2) containsNaN exists and lower/upper doesn't store NaN. But I guess people may implement their own manifest summary that already exclude NaN from bounds but no containsNaN, so we still want to handle this, and file level metrics could give more granular information so there isn't necessarily any performance penalty. I have updated this PR to check for existence of containsNaN, but please let me know if my understanding isn't correct!", "author": "yyanyy", "createdAt": "2021-02-04T23:15:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTAyNTAyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDY1MDUyNQ==", "url": "https://github.com/apache/iceberg/pull/1872#discussion_r570650525", "bodyText": "Yes, I think your summary is correct. Because this is a format change and we expect/want others to implement the format, we want to account for strange cases like that.", "author": "rdblue", "createdAt": "2021-02-05T01:02:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTAyNTAyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTAyNTY5Mw==", "url": "https://github.com/apache/iceberg/pull/1872#discussion_r569025693", "bodyText": "Could you move this private method to the bottom of the class?", "author": "rdblue", "createdAt": "2021-02-03T00:29:09Z", "path": "api/src/main/java/org/apache/iceberg/expressions/ManifestEvaluator.java", "diffHunk": "@@ -144,18 +143,37 @@ public Boolean or(Boolean leftResult, Boolean rightResult) {\n     @Override\n     public <T> Boolean isNaN(BoundReference<T> ref) {\n       int pos = Accessors.toPosition(ref.accessor());\n-      // containsNull encodes whether at least one partition value is null, lowerBound is null if\n-      // all partition values are null.\n-      if (stats.get(pos).containsNull() && stats.get(pos).lowerBound() == null) {\n-        return ROWS_CANNOT_MATCH; // all values are null\n+\n+      if (stats.get(pos).containsNaN() != null && !stats.get(pos).containsNaN()) {\n+        return ROWS_CANNOT_MATCH;\n+      }\n+\n+      if (allValuesAreNull(stats.get(pos))) {\n+        return ROWS_CANNOT_MATCH;\n       }\n \n       return ROWS_MIGHT_MATCH;\n     }\n \n+    private boolean allValuesAreNull(PartitionFieldSummary summary) {", "originalCommit": "bade62f2235d660d7863a33b024a893ccaefde1b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTAyNjIwNg==", "url": "https://github.com/apache/iceberg/pull/1872#discussion_r569026206", "bodyText": "Nit: nan -> NaN", "author": "rdblue", "createdAt": "2021-02-03T00:30:37Z", "path": "api/src/main/java/org/apache/iceberg/ManifestFile.java", "diffHunk": "@@ -199,6 +200,16 @@ default boolean hasDeletedFiles() {\n      */\n     boolean containsNull();\n \n+    /**\n+     * Returns true if at least one data file in the manifest has a nan value for the field.", "originalCommit": "bade62f2235d660d7863a33b024a893ccaefde1b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTAyODI1Mw==", "url": "https://github.com/apache/iceberg/pull/1872#discussion_r569028253", "bodyText": "Nit: indentation is off.", "author": "rdblue", "createdAt": "2021-02-03T00:36:20Z", "path": "core/src/main/java/org/apache/iceberg/GenericPartitionFieldSummary.java", "diffHunk": "@@ -72,7 +74,19 @@ public GenericPartitionFieldSummary(Schema avroSchema) {\n     }\n   }\n \n-  public GenericPartitionFieldSummary(boolean containsNull, ByteBuffer lowerBound,\n+  public GenericPartitionFieldSummary(boolean containsNull, boolean containsNaN, ByteBuffer lowerBound,\n+                               ByteBuffer upperBound) {", "originalCommit": "bade62f2235d660d7863a33b024a893ccaefde1b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTAzMzI1OA==", "url": "https://github.com/apache/iceberg/pull/1872#discussion_r569033258", "bodyText": "Nit: indentation is off.", "author": "rdblue", "createdAt": "2021-02-03T00:50:16Z", "path": "core/src/main/java/org/apache/iceberg/GenericPartitionFieldSummary.java", "diffHunk": "@@ -72,7 +74,19 @@ public GenericPartitionFieldSummary(Schema avroSchema) {\n     }\n   }\n \n-  public GenericPartitionFieldSummary(boolean containsNull, ByteBuffer lowerBound,\n+  public GenericPartitionFieldSummary(boolean containsNull, boolean containsNaN, ByteBuffer lowerBound,\n+                               ByteBuffer upperBound) {\n+    this.avroSchema = AVRO_SCHEMA;\n+    this.containsNull = containsNull;\n+    this.containsNaN = containsNaN;\n+    this.lowerBound = ByteBuffers.toByteArray(lowerBound);\n+    this.upperBound = ByteBuffers.toByteArray(upperBound);\n+    this.fromProjectionPos = null;\n+  }\n+\n+  // for testing backward compatibility only\n+  @VisibleForTesting\n+  GenericPartitionFieldSummary(boolean containsNull, ByteBuffer lowerBound,\n                                       ByteBuffer upperBound) {", "originalCommit": "bade62f2235d660d7863a33b024a893ccaefde1b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "acd440082425342c3f6f60e846e8fcbb194ddd5a", "url": "https://github.com/apache/iceberg/commit/acd440082425342c3f6f60e846e8fcbb194ddd5a", "message": "not consider all_null for missing containsNaN case", "committedDate": "2021-02-04T22:34:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDY1MjQyMw==", "url": "https://github.com/apache/iceberg/pull/1872#discussion_r570652423", "bodyText": "containsNaN could only be true if the type is float or double. Should this check the column type before checking containsNaN? Then we would be able to ignore it for most cases. For example, the test below uses a string column but has no containsNaN values, so it doesn't catch that all values are null.", "author": "rdblue", "createdAt": "2021-02-05T01:08:28Z", "path": "api/src/main/java/org/apache/iceberg/expressions/ManifestEvaluator.java", "diffHunk": "@@ -329,5 +338,12 @@ public Boolean or(Boolean leftResult, Boolean rightResult) {\n \n       return ROWS_MIGHT_MATCH;\n     }\n+\n+    private boolean allValuesAreNull(PartitionFieldSummary summary) {\n+      // containsNull encodes whether at least one partition value is null, lowerBound is null if all partition values\n+      // are null; in case bounds don't include NaN value, containsNaN needs to be checked against.\n+      return summary.containsNull() && summary.lowerBound() == null &&\n+          summary.containsNaN() != null && !summary.containsNaN();", "originalCommit": "acd440082425342c3f6f60e846e8fcbb194ddd5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDY5MzQ5NQ==", "url": "https://github.com/apache/iceberg/pull/1872#discussion_r570693495", "bodyText": "Yes, sorry I forgot to address this comment... Will update", "author": "yyanyy", "createdAt": "2021-02-05T03:18:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDY1MjQyMw=="}], "type": "inlineReview"}, {"oid": "29d5078fcab83afec10409517ad3f2a9cd671217", "url": "https://github.com/apache/iceberg/commit/29d5078fcab83afec10409517ad3f2a9cd671217", "message": "handle floating point types differently in checking all nulls case", "committedDate": "2021-02-05T03:21:20Z", "type": "commit"}]}