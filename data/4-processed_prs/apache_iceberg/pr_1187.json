{"pr_number": 1187, "pr_title": "Add support to parallelise the execution of tasks of metadata and data files delete operations", "pr_createdAt": "2020-07-09T10:57:33Z", "pr_url": "https://github.com/apache/iceberg/pull/1187", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzkyOTczNA==", "url": "https://github.com/apache/iceberg/pull/1187#discussion_r453929734", "bodyText": "Because there is already a deleteWith method that controls an option that is substantially different, I don't think it is a good idea to name the deleteWith. It seems odd to pass a callback to one and an executor service to another. What about naming this executeWith instead?", "author": "rdblue", "createdAt": "2020-07-13T21:00:11Z", "path": "api/src/main/java/org/apache/iceberg/ExpireSnapshots.java", "diffHunk": "@@ -82,4 +83,18 @@\n    * @return this for method chaining\n    */\n   ExpireSnapshots deleteWith(Consumer<String> deleteFunc);\n+\n+  /**\n+   * Passes an alternative executor service that will be used for manifests and data files deletion.\n+   * <p>\n+   * Manifest files that are no longer used by valid snapshots will be deleted. Data files that were\n+   * deleted by snapshots that are expired will be deleted.\n+   * <p>\n+   * If this method is not called, unnecessary manifests and data files will still be deleted using a single threaded\n+   * executor service.\n+   *\n+   * @param executorService an executor service to parallelize tasks to delete manifests and data files\n+   * @return this for method chaining\n+   */\n+  ExpireSnapshots deleteWith(ExecutorService executorService);", "originalCommit": "5d47fb5d81a41468f9f7e539d87ece8fd2eb192e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzkzMTQ2Ng==", "url": "https://github.com/apache/iceberg/pull/1187#discussion_r453931466", "bodyText": "I think the default should be the current behavior, which is to run immediately in the current thread. You can get that behavior by using MoreExecutors.directExecutor() as the default.", "author": "rdblue", "createdAt": "2020-07-13T21:03:33Z", "path": "core/src/main/java/org/apache/iceberg/RemoveSnapshots.java", "diffHunk": "@@ -60,12 +62,19 @@ public void accept(String file) {\n     }\n   };\n \n+  private final ExecutorService defaultDeleteExecutorService = Executors.newSingleThreadExecutor(runnable -> {", "originalCommit": "5d47fb5d81a41468f9f7e539d87ece8fd2eb192e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzkzMTgyNA==", "url": "https://github.com/apache/iceberg/pull/1187#discussion_r453931824", "bodyText": "If you use directExecutor() then this can be static.", "author": "rdblue", "createdAt": "2020-07-13T21:04:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzkzMTQ2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI1NzE5Mw==", "url": "https://github.com/apache/iceberg/pull/1187#discussion_r454257193", "bodyText": "Using MoreExecutors.newDirectExecutorService() to keep it consistent with the expected type java.util.concurrent.ExecutorService to pass to org.apache.iceberg.util.Tasks.Builder#executeWith", "author": "fbocse", "createdAt": "2020-07-14T10:25:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzkzMTQ2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzkzMzgzMw==", "url": "https://github.com/apache/iceberg/pull/1187#discussion_r453933833", "bodyText": "This doesn't actually test that the thread pool is used, does it? What adding the thread ID to a concurrent set in deleteWith? Then you could assert that the threads you created were actually used.", "author": "rdblue", "createdAt": "2020-07-13T21:08:19Z", "path": "core/src/test/java/org/apache/iceberg/TestRemoveSnapshots.java", "diffHunk": "@@ -404,6 +405,59 @@ public void dataFilesCleanup() throws IOException {\n     Assert.assertTrue(\"FILE_B should be deleted\", deletedFiles.contains(FILE_B.path().toString()));\n   }\n \n+  @Test\n+  public void dataFilesCleanupWithParallelTasks() throws IOException {\n+    table.newFastAppend()\n+        .appendFile(FILE_A)\n+        .commit();\n+\n+    table.newFastAppend()\n+        .appendFile(FILE_B)\n+        .commit();\n+\n+    table.newRewrite()\n+        .rewriteFiles(ImmutableSet.of(FILE_B), ImmutableSet.of(FILE_D))\n+        .commit();\n+    long thirdSnapshotId = table.currentSnapshot().snapshotId();\n+\n+    table.newRewrite()\n+        .rewriteFiles(ImmutableSet.of(FILE_A), ImmutableSet.of(FILE_C))\n+        .commit();\n+    long fourthSnapshotId = table.currentSnapshot().snapshotId();\n+\n+    long t4 = System.currentTimeMillis();\n+    while (t4 <= table.currentSnapshot().timestampMillis()) {\n+      t4 = System.currentTimeMillis();\n+    }\n+\n+    List<ManifestFile> manifests = table.currentSnapshot().dataManifests();\n+\n+    ManifestFile newManifest = writeManifest(\n+        \"manifest-file-1.avro\",\n+        manifestEntry(Status.EXISTING, thirdSnapshotId, FILE_C),\n+        manifestEntry(Status.EXISTING, fourthSnapshotId, FILE_D));\n+\n+    RewriteManifests rewriteManifests = table.rewriteManifests();\n+    manifests.forEach(rewriteManifests::deleteManifest);\n+    rewriteManifests.addManifest(newManifest);\n+    rewriteManifests.commit();\n+\n+    Set<String> deletedFiles = Sets.newHashSet();\n+\n+    table.expireSnapshots()\n+        .deleteWith(Executors.newFixedThreadPool(8, runnable -> {\n+          Thread thread = new Thread(runnable);\n+          thread.setDaemon(true);\n+          return thread;\n+        }))\n+        .expireOlderThan(t4)\n+        .deleteWith(deletedFiles::add)", "originalCommit": "5d47fb5d81a41468f9f7e539d87ece8fd2eb192e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI3MTczMg==", "url": "https://github.com/apache/iceberg/pull/1187#discussion_r454271732", "bodyText": "You're right, it doesn't verify that the provided executor services was used to submit the tasks.\nI was looking through the test suites for a pattern on unit testing usage of executor service for tasks parallel execution, didn't find one though.\nI'll follow up on your proposal to making this test more relevant.", "author": "fbocse", "createdAt": "2020-07-14T10:53:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzkzMzgzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ5NjE1Mw==", "url": "https://github.com/apache/iceberg/pull/1187#discussion_r454496153", "bodyText": "Nit: Static final names should be ALL_CAPS.", "author": "rdblue", "createdAt": "2020-07-14T16:46:28Z", "path": "core/src/main/java/org/apache/iceberg/RemoveSnapshots.java", "diffHunk": "@@ -60,12 +62,16 @@ public void accept(String file) {\n     }\n   };\n \n+  // Creates an executor service that runs each task in the thread that invokes execute/submit.\n+  private static final ExecutorService defaultDeleteExecutorService = MoreExecutors.newDirectExecutorService();", "originalCommit": "5657c3eb38f936217a961d412d6aa72029168027", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ5NjY5Mg==", "url": "https://github.com/apache/iceberg/pull/1187#discussion_r454496692", "bodyText": "And can you move this near the logger instead of here? That will keep all the static final fields together.", "author": "rdblue", "createdAt": "2020-07-14T16:47:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ5NjE1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg0ODg5OQ==", "url": "https://github.com/apache/iceberg/pull/1187#discussion_r454848899", "bodyText": "Right, didn't run the checks, I'll run the gradle checks before submitting the changes.", "author": "fbocse", "createdAt": "2020-07-15T07:30:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ5NjE1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ5NzQ4Mg==", "url": "https://github.com/apache/iceberg/pull/1187#discussion_r454497482", "bodyText": "Unfinished comment?", "author": "rdblue", "createdAt": "2020-07-14T16:48:20Z", "path": "core/src/test/java/org/apache/iceberg/TestRemoveSnapshots.java", "diffHunk": "@@ -404,6 +407,69 @@ public void dataFilesCleanup() throws IOException {\n     Assert.assertTrue(\"FILE_B should be deleted\", deletedFiles.contains(FILE_B.path().toString()));\n   }\n \n+  @Test\n+  public void dataFilesCleanupWithParallelTasks() throws IOException {\n+    table.newFastAppend()\n+        .appendFile(FILE_A)\n+        .commit();\n+\n+    table.newFastAppend()\n+        .appendFile(FILE_B)\n+        .commit();\n+\n+    table.newRewrite()\n+        .rewriteFiles(ImmutableSet.of(FILE_B), ImmutableSet.of(FILE_D))\n+        .commit();\n+    long thirdSnapshotId = table.currentSnapshot().snapshotId();\n+\n+    table.newRewrite()\n+        .rewriteFiles(ImmutableSet.of(FILE_A), ImmutableSet.of(FILE_C))\n+        .commit();\n+    long fourthSnapshotId = table.currentSnapshot().snapshotId();\n+\n+    long t4 = System.currentTimeMillis();\n+    while (t4 <= table.currentSnapshot().timestampMillis()) {\n+      t4 = System.currentTimeMillis();\n+    }\n+\n+    List<ManifestFile> manifests = table.currentSnapshot().dataManifests();\n+\n+    ManifestFile newManifest = writeManifest(\n+        \"manifest-file-1.avro\",\n+        manifestEntry(Status.EXISTING, thirdSnapshotId, FILE_C),\n+        manifestEntry(Status.EXISTING, fourthSnapshotId, FILE_D));\n+\n+    RewriteManifests rewriteManifests = table.rewriteManifests();\n+    manifests.forEach(rewriteManifests::deleteManifest);\n+    rewriteManifests.addManifest(newManifest);\n+    rewriteManifests.commit();\n+\n+    Set<String> deletedFiles = Sets.newHashSet();\n+    Set<String> deleteThreads = ConcurrentHashMap.newKeySet();\n+    AtomicInteger deleteThreadsIndex = new AtomicInteger(0);\n+\n+    table.expireSnapshots()\n+        .executeWith(Executors.newFixedThreadPool(4, runnable -> {\n+          Thread thread = new Thread(runnable);\n+          thread.setName(\"remove-snapshot-\" + deleteThreadsIndex.getAndIncrement());\n+          thread.setDaemon(true); // daemon threads will be terminated abruptly when the JVM exits\n+          return thread;\n+        }))\n+        .expireOlderThan(t4)\n+        .deleteWith(s -> {\n+          deleteThreads.add(Thread.currentThread().getName());\n+          deletedFiles.add(s);\n+        })\n+        .commit();\n+\n+    // Verifies the", "originalCommit": "5657c3eb38f936217a961d412d6aa72029168027", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d2a1df33c6e741de386ea10b7da54d84e7a40c81", "url": "https://github.com/apache/iceberg/commit/d2a1df33c6e741de386ea10b7da54d84e7a40c81", "message": "Add support to parallelise the execution of tasks of metadata and data files delete operations, by default execution is single threaded.", "committedDate": "2020-07-20T20:43:02Z", "type": "commit"}, {"oid": "104ec05278b810a43d0f3f80626b85a2c790ee69", "url": "https://github.com/apache/iceberg/commit/104ec05278b810a43d0f3f80626b85a2c790ee69", "message": "[code review] Rename method `executeWith` instead of `deleteWith` to deliver executor service for deleting data and metadata files\n\n[code review] The default behaviour (when no executor service is provided for the delete actions) is to run the delete operation tasks in the same thread.\n\n[code review] minor comment to mention the effect of using daemon threads\n\n[code review] Capture current thread name from delete files method and verify that they\u2019ve originated from the provided executor service to be used to parallelise data files deletion.\n\n[code review] fix check style errors\n\n[code review] Wrapping up unfinished thoughts", "committedDate": "2020-07-20T20:43:02Z", "type": "commit"}, {"oid": "104ec05278b810a43d0f3f80626b85a2c790ee69", "url": "https://github.com/apache/iceberg/commit/104ec05278b810a43d0f3f80626b85a2c790ee69", "message": "[code review] Rename method `executeWith` instead of `deleteWith` to deliver executor service for deleting data and metadata files\n\n[code review] The default behaviour (when no executor service is provided for the delete actions) is to run the delete operation tasks in the same thread.\n\n[code review] minor comment to mention the effect of using daemon threads\n\n[code review] Capture current thread name from delete files method and verify that they\u2019ve originated from the provided executor service to be used to parallelise data files deletion.\n\n[code review] fix check style errors\n\n[code review] Wrapping up unfinished thoughts", "committedDate": "2020-07-20T20:43:02Z", "type": "forcePushed"}]}