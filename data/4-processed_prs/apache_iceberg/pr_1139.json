{"pr_number": 1139, "pr_title": "Fix executor memory leak in Parquet row group filter", "pr_createdAt": "2020-06-25T23:45:22Z", "pr_url": "https://github.com/apache/iceberg/pull/1139", "timeline": [{"oid": "c720e56929763706916c16fbaea8b04116b55485", "url": "https://github.com/apache/iceberg/commit/c720e56929763706916c16fbaea8b04116b55485", "message": "Fix executor memory leak in Parquet row group filter.", "committedDate": "2020-06-25T23:41:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgwNzUyMA==", "url": "https://github.com/apache/iceberg/pull/1139#discussion_r446807520", "bodyText": "As it resets all instance variables, how about directly creating a new EvalVisitor object instead of using ThreadLocal here?", "author": "jun-he", "createdAt": "2020-06-29T06:51:15Z", "path": "parquet/src/main/java/org/apache/iceberg/parquet/ParquetDictionaryRowGroupFilter.java", "diffHunk": "@@ -116,7 +116,18 @@ private boolean eval(MessageType fileSchema, BlockMetaData rowGroup,\n         }\n       }\n \n-      return ExpressionVisitors.visitEvaluator(expr, this);\n+      try {\n+        return ExpressionVisitors.visitEvaluator(expr, this);\n+\n+      } finally {\n+        // allow temporary state to be collected because this is in a thread-local", "originalCommit": "c720e56929763706916c16fbaea8b04116b55485", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE1NjI1Mw==", "url": "https://github.com/apache/iceberg/pull/1139#discussion_r447156253", "bodyText": "Good question. I think we could remove the thread-local. The idea was originally to avoid the Expression handling that is currently done in the constructor: Binder.bind(struct, Expressions.rewriteNot(unbound), caseSensitive).\nWe could remove the thread-local since it is just avoiding a simple object allocation that's probably not worth it. On the other hand, we could also keep it and simply clear all of this state instead of allocating new containers each time. I'd probably opt for that to avoid lots of object creation. What do you think?", "author": "rdblue", "createdAt": "2020-06-29T18:05:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgwNzUyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQyMjg0OQ==", "url": "https://github.com/apache/iceberg/pull/1139#discussion_r447422849", "bodyText": "I think it makes sense to fix it for now with the current way, which has the minimal side effect.\nAdditionally, I think we might not save much in case there is a new thread for each task. Also the thread local itself might add additional cost.", "author": "jun-he", "createdAt": "2020-06-30T05:43:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgwNzUyMA=="}], "type": "inlineReview"}]}