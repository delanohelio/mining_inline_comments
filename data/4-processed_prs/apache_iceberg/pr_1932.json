{"pr_number": 1932, "pr_title": "Refactor Spark schema evolution tests ", "pr_createdAt": "2020-12-14T23:53:26Z", "pr_url": "https://github.com/apache/iceberg/pull/1932", "timeline": [{"oid": "992d665b06aefec1462aa0387c55d0c7bfa59d5d", "url": "https://github.com/apache/iceberg/commit/992d665b06aefec1462aa0387c55d0c7bfa59d5d", "message": "Refactor, fix tests", "committedDate": "2020-12-14T23:50:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk0MjM0MA==", "url": "https://github.com/apache/iceberg/pull/1932#discussion_r542942340", "bodyText": "This shouldn't use Spark test internals. There are assertions in Iceberg to check rows.", "author": "rdblue", "createdAt": "2020-12-15T00:07:08Z", "path": "spark2/src/test/java/org/apache/iceberg/examples/SchemaEvolutionTest.java", "diffHunk": "@@ -84,29 +98,56 @@ public void before() throws IOException {\n \n   @Test\n   public void addColumnToSchema() {\n-    table.updateSchema().addColumn(\"publisher\", Types.StringType.get()).commit();\n \n-    Dataset<Row> df2 = spark.read().json(dataLocation + \"new-books.json\");\n+    String fieldName = \"publisher\";\n+    Schema schema = table.schema();\n+    Assert.assertNull(schema.findField(fieldName));\n+\n+    table.updateSchema().addColumn(fieldName, Types.StringType.get()).commit();\n+\n+    Dataset<Row> df1 = spark.read()\n+        .json(dataLocation + \"books.json\");\n+    df1 = df1.withColumn(fieldName, new Column(Literal$.MODULE$.apply(null)))\n+        .selectExpr(\"title\", \"price\", \"author\", \"cast(published as timestamp)\", \"genre\", \"publisher\");\n \n+    Dataset<Row> df2 = spark.read().json(dataLocation + \"new-books.json\")\n+        .selectExpr(\"title\", \"price\", \"author\", \"cast(published as timestamp)\", \"genre\", \"publisher\");\n+    List<Row> expected = df1.union(df2)\n+        .collectAsList();\n+\n+    // Append data\n     df2.select(df2.col(\"title\"), df2.col(\"price\").cast(DataTypes.IntegerType),\n         df2.col(\"author\"), df2.col(\"published\").cast(DataTypes.TimestampType),\n         df2.col(\"genre\"), df2.col(\"publisher\")).write()\n         .format(\"iceberg\")\n         .mode(\"append\")\n         .save(tableLocation.toString());\n+\n+    // Read iceberg table\n+    Dataset<Row> iceberg = spark.read()\n+        .format(\"iceberg\")\n+        .load(tableLocation.toString());\n+\n+    String error = QueryTest$.MODULE$.checkAnswer(iceberg, expected);", "originalCommit": "992d665b06aefec1462aa0387c55d0c7bfa59d5d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk0MzQ1NA==", "url": "https://github.com/apache/iceberg/pull/1932#discussion_r542943454", "bodyText": "I don't think that this additional check is needed. This is an example, not really a correctness or unit test. So we want the example to be as simple as possible to be readable as an example of using the API. This only lives in tests so that it is kept up to date and we know it doesn't fail.", "author": "rdblue", "createdAt": "2020-12-15T00:08:12Z", "path": "spark2/src/test/java/org/apache/iceberg/examples/SchemaEvolutionTest.java", "diffHunk": "@@ -84,29 +98,56 @@ public void before() throws IOException {\n \n   @Test\n   public void addColumnToSchema() {\n-    table.updateSchema().addColumn(\"publisher\", Types.StringType.get()).commit();\n \n-    Dataset<Row> df2 = spark.read().json(dataLocation + \"new-books.json\");\n+    String fieldName = \"publisher\";\n+    Schema schema = table.schema();\n+    Assert.assertNull(schema.findField(fieldName));\n+\n+    table.updateSchema().addColumn(fieldName, Types.StringType.get()).commit();\n+\n+    Dataset<Row> df1 = spark.read()\n+        .json(dataLocation + \"books.json\");\n+    df1 = df1.withColumn(fieldName, new Column(Literal$.MODULE$.apply(null)))\n+        .selectExpr(\"title\", \"price\", \"author\", \"cast(published as timestamp)\", \"genre\", \"publisher\");", "originalCommit": "992d665b06aefec1462aa0387c55d0c7bfa59d5d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY0NDg0Mw==", "url": "https://github.com/apache/iceberg/pull/1932#discussion_r543644843", "bodyText": "@rdblue Thanks for inputs, I have removed the correctness related changes.", "author": "karuppayya", "createdAt": "2020-12-15T19:56:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk0MzQ1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk0NDEyMw==", "url": "https://github.com/apache/iceberg/pull/1932#discussion_r542944123", "bodyText": "Style: no blocks of imports, just one list ordered alphabetically.", "author": "rdblue", "createdAt": "2020-12-15T00:08:50Z", "path": "spark2/src/test/java/org/apache/iceberg/examples/SchemaEvolutionTest.java", "diffHunk": "@@ -22,18 +22,27 @@\n import java.io.File;\n import java.io.IOException;\n import java.nio.file.Files;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+", "originalCommit": "992d665b06aefec1462aa0387c55d0c7bfa59d5d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY0NTkyNw==", "url": "https://github.com/apache/iceberg/pull/1932#discussion_r543645927", "bodyText": "done.", "author": "karuppayya", "createdAt": "2020-12-15T19:58:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk0NDEyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk0NDU4OA==", "url": "https://github.com/apache/iceberg/pull/1932#discussion_r542944588", "bodyText": "Style: no wildcard imports because it isn't obvious where symbols are coming from.", "author": "rdblue", "createdAt": "2020-12-15T00:09:16Z", "path": "spark2/src/test/java/org/apache/iceberg/examples/SchemaEvolutionTest.java", "diffHunk": "@@ -22,18 +22,27 @@\n import java.io.File;\n import java.io.IOException;\n import java.nio.file.Files;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+\n import org.apache.commons.io.FileUtils;\n import org.apache.iceberg.PartitionSpec;\n import org.apache.iceberg.Schema;\n import org.apache.iceberg.Table;\n import org.apache.iceberg.hadoop.HadoopTables;\n import org.apache.iceberg.types.Types;\n+import org.apache.spark.sql.Column;\n import org.apache.spark.sql.Dataset;\n+import org.apache.spark.sql.QueryTest$;\n import org.apache.spark.sql.Row;\n import org.apache.spark.sql.SparkSession;\n+import org.apache.spark.sql.catalyst.expressions.Literal$;\n import org.apache.spark.sql.types.DataTypes;\n-import org.junit.Before;\n-import org.junit.Test;\n+import org.apache.spark.sql.types.LongType$;\n+import org.apache.spark.sql.types.StructField;\n+import org.junit.*;", "originalCommit": "992d665b06aefec1462aa0387c55d0c7bfa59d5d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY0NjAyNQ==", "url": "https://github.com/apache/iceberg/pull/1932#discussion_r543646025", "bodyText": "done", "author": "karuppayya", "createdAt": "2020-12-15T19:58:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk0NDU4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk0NTAxMQ==", "url": "https://github.com/apache/iceberg/pull/1932#discussion_r542945011", "bodyText": "This are good assertions to have, but they should be JUnit assertions and not assert.", "author": "rdblue", "createdAt": "2020-12-15T00:09:42Z", "path": "spark2/src/test/java/org/apache/iceberg/examples/SchemaEvolutionTest.java", "diffHunk": "@@ -120,13 +161,25 @@ public void renameColumn() {\n \n     results.createOrReplaceTempView(\"table\");\n     spark.sql(\"select * from table\").show();\n+    List<String> fields = Arrays.asList(spark.sql(\"select * from table\").schema().names());\n+    assert (fields.contains(\"writer\"));\n+    assert (!fields.contains(\"author\"));", "originalCommit": "992d665b06aefec1462aa0387c55d0c7bfa59d5d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY0NjE0MQ==", "url": "https://github.com/apache/iceberg/pull/1932#discussion_r543646141", "bodyText": "done", "author": "karuppayya", "createdAt": "2020-12-15T19:58:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk0NTAxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk0NTExNg==", "url": "https://github.com/apache/iceberg/pull/1932#discussion_r542945116", "bodyText": "This is a good assertion to add.", "author": "rdblue", "createdAt": "2020-12-15T00:09:51Z", "path": "spark2/src/test/java/org/apache/iceberg/examples/SchemaEvolutionTest.java", "diffHunk": "@@ -84,29 +98,56 @@ public void before() throws IOException {\n \n   @Test\n   public void addColumnToSchema() {\n-    table.updateSchema().addColumn(\"publisher\", Types.StringType.get()).commit();\n \n-    Dataset<Row> df2 = spark.read().json(dataLocation + \"new-books.json\");\n+    String fieldName = \"publisher\";\n+    Schema schema = table.schema();\n+    Assert.assertNull(schema.findField(fieldName));\n+\n+    table.updateSchema().addColumn(fieldName, Types.StringType.get()).commit();\n+\n+    Dataset<Row> df1 = spark.read()\n+        .json(dataLocation + \"books.json\");\n+    df1 = df1.withColumn(fieldName, new Column(Literal$.MODULE$.apply(null)))\n+        .selectExpr(\"title\", \"price\", \"author\", \"cast(published as timestamp)\", \"genre\", \"publisher\");\n \n+    Dataset<Row> df2 = spark.read().json(dataLocation + \"new-books.json\")\n+        .selectExpr(\"title\", \"price\", \"author\", \"cast(published as timestamp)\", \"genre\", \"publisher\");\n+    List<Row> expected = df1.union(df2)\n+        .collectAsList();\n+\n+    // Append data\n     df2.select(df2.col(\"title\"), df2.col(\"price\").cast(DataTypes.IntegerType),\n         df2.col(\"author\"), df2.col(\"published\").cast(DataTypes.TimestampType),\n         df2.col(\"genre\"), df2.col(\"publisher\")).write()\n         .format(\"iceberg\")\n         .mode(\"append\")\n         .save(tableLocation.toString());\n+\n+    // Read iceberg table\n+    Dataset<Row> iceberg = spark.read()\n+        .format(\"iceberg\")\n+        .load(tableLocation.toString());\n+\n+    String error = QueryTest$.MODULE$.checkAnswer(iceberg, expected);\n+    Assert.assertNull(error);\n+\n   }\n \n   @Test\n   public void deleteColumnFromSchema() {\n-    table.updateSchema().deleteColumn(\"genre\").commit();\n+    List<Row> rows = spark.read()\n+        .format(\"iceberg\")\n+        .load(tableLocation.toString())\n+        .drop(\"genre\").collectAsList();\n \n+    table.updateSchema().deleteColumn(\"genre\").commit();\n     table.refresh();\n+\n     Dataset<Row> results = spark.read()\n         .format(\"iceberg\")\n         .load(tableLocation.toString());\n-\n-    results.createOrReplaceTempView(\"table\");\n-    spark.sql(\"select * from table\").show();\n+    Assert.assertFalse(Arrays.asList(results.schema().names()).contains(\"genre\"));", "originalCommit": "992d665b06aefec1462aa0387c55d0c7bfa59d5d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9cdffdf91e80888ee27db1e36580cf46211c8758", "url": "https://github.com/apache/iceberg/commit/9cdffdf91e80888ee27db1e36580cf46211c8758", "message": "Fix style checks", "committedDate": "2020-12-15T18:28:40Z", "type": "commit"}]}