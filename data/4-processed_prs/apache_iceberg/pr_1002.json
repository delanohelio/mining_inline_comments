{"pr_number": 1002, "pr_title": "Refactor IndexByName to use before and after", "pr_createdAt": "2020-05-05T00:07:43Z", "pr_url": "https://github.com/apache/iceberg/pull/1002", "timeline": [{"oid": "3bb2f8c16018b9fb3fe23e502b46b31710c71daa", "url": "https://github.com/apache/iceberg/commit/3bb2f8c16018b9fb3fe23e502b46b31710c71daa", "message": "Refactor IndexByName to use before and after.", "committedDate": "2020-05-05T00:02:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDE4NjIwOA==", "url": "https://github.com/apache/iceberg/pull/1002#discussion_r420186208", "bodyText": "Do we need to add some description of why return directly when isStructType() is true? IIRC, that could lead to duplicate names.", "author": "chenjunjiedada", "createdAt": "2020-05-05T15:11:14Z", "path": "api/src/main/java/org/apache/iceberg/types/IndexByName.java", "diffHunk": "@@ -23,84 +23,97 @@\n import com.google.common.collect.Lists;\n import com.google.common.collect.Maps;\n import java.util.Deque;\n+import java.util.List;\n import java.util.Map;\n-import java.util.concurrent.Callable;\n-import java.util.function.Supplier;\n import org.apache.iceberg.Schema;\n import org.apache.iceberg.exceptions.ValidationException;\n \n-public class IndexByName extends TypeUtil.CustomOrderSchemaVisitor<Map<String, Integer>> {\n+public class IndexByName extends TypeUtil.SchemaVisitor<Map<String, Integer>> {\n   private static final Joiner DOT = Joiner.on(\".\");\n \n   private final Deque<String> fieldNames = Lists.newLinkedList();\n   private final Map<String, Integer> nameToId = Maps.newHashMap();\n \n   @Override\n-  public Map<String, Integer> schema(Schema schema, Supplier<Map<String, Integer>> structResult) {\n-    return structResult.get();\n+  public void beforeField(Types.NestedField field) {\n+    fieldNames.push(field.name());\n   }\n \n   @Override\n-  public Map<String, Integer> struct(Types.StructType struct, Iterable<Map<String, Integer>> fieldResults) {\n-    // iterate through the fields to update the index for each one, use size to avoid errorprone failure\n-    Lists.newArrayList(fieldResults).size();\n-    return nameToId;\n+  public void afterField(Types.NestedField field) {\n+    fieldNames.pop();\n   }\n \n   @Override\n-  public Map<String, Integer> field(Types.NestedField field, Supplier<Map<String, Integer>> fieldResult) {\n-    withName(field.name(), fieldResult::get);\n-    addField(field.name(), field.fieldId());\n-    return null;\n+  public void beforeListElement(Types.NestedField elementField) {\n+    if (!elementField.type().isStructType()) {", "originalCommit": "3bb2f8c16018b9fb3fe23e502b46b31710c71daa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDIyNTE5MA==", "url": "https://github.com/apache/iceberg/pull/1002#discussion_r420225190", "bodyText": "Yeah, I'll add a comment. The reason is to make the names more natural. If you have a list called locations that has latitude and longitude fields, it would be strange to reference locations.element.latitude instead of locations.latitude. But if the element is not a struct, that doesn't apply.", "author": "rdblue", "createdAt": "2020-05-05T16:03:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDE4NjIwOA=="}], "type": "inlineReview"}, {"oid": "ea028f9316e38914967ed8d185a3ca4578502069", "url": "https://github.com/apache/iceberg/commit/ea028f9316e38914967ed8d185a3ca4578502069", "message": "Add comments.", "committedDate": "2020-05-07T15:53:15Z", "type": "commit"}]}