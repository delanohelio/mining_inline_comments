{"pr_number": 691, "pr_title": "Cleanup ZkOrphanTasks only when leader assignment is successful and fix CoordinatorEventBlockingQueue to handle duplicate events with metadata.", "pr_createdAt": "2020-03-11T00:21:41Z", "pr_url": "https://github.com/linkedin/brooklin/pull/691", "timeline": [{"oid": "c31cd4a15cc8dd69b0a653dbe4201de934ea6d65", "url": "https://github.com/linkedin/brooklin/commit/c31cd4a15cc8dd69b0a653dbe4201de934ea6d65", "message": "Merge pull request #1 from linkedin/master\n\nPull latest", "committedDate": "2019-11-18T20:06:44Z", "type": "commit"}, {"oid": "047465377af69d3e0440eccc484843ceb5d5fa63", "url": "https://github.com/linkedin/brooklin/commit/047465377af69d3e0440eccc484843ceb5d5fa63", "message": "Merge branch 'master' of github.com:linkedin/brooklin into ZkFix", "committedDate": "2020-03-10T21:59:07Z", "type": "commit"}, {"oid": "f21f67c29b745604186693289b4b358e51cfb7a4", "url": "https://github.com/linkedin/brooklin/commit/f21f67c29b745604186693289b4b358e51cfb7a4", "message": "Cleanup ZkOrphanTasks only when leader assignment is successful and fix CoordinatorEventBlockingQueue", "committedDate": "2020-03-11T00:12:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY5ODc4MA==", "url": "https://github.com/linkedin/brooklin/pull/691#discussion_r390698780", "bodyText": "_eventMetadata could be null for some events. I suggest comparing them with Objects.equals().", "author": "ahmedahamid", "createdAt": "2020-03-11T01:23:27Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/CoordinatorEvent.java", "diffHunk": "@@ -134,6 +124,23 @@ public String toString() {\n     return \"type:\" + _eventType;\n   }\n \n+  @Override\n+  public boolean equals(Object o) {\n+    if (this == o) {\n+      return true;\n+    }\n+    if (o == null || getClass() != o.getClass()) {\n+      return false;\n+    }\n+    CoordinatorEvent that = (CoordinatorEvent) o;\n+    return _eventType == that._eventType && _eventMetadata.equals(that._eventMetadata);", "originalCommit": "f21f67c29b745604186693289b4b358e51cfb7a4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMwNTAwMQ==", "url": "https://github.com/linkedin/brooklin/pull/691#discussion_r392305001", "bodyText": "Would it be a good idea to document the purpose of cleanUpOrphanConnectorTasks?\ne.g.\n   * @param cleanUpOrphanConnectorTasks indicates whether the leader should clean up stale/orphan connector\n   *                                    task entries in ZooKeeper", "author": "ahmedahamid", "createdAt": "2020-03-13T15:37:57Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/CoordinatorEvent.java", "diffHunk": "@@ -63,9 +59,10 @@ private CoordinatorEvent(EventType eventType, Object eventMetadata) {\n \n   /**\n    * Returns an event that indicates a new assignment needs to be done (this is a leader-specific event).\n+   * cleanUpOrphanConnectorTasks should be set to true once when the coordinator becomes leader.", "originalCommit": "f21f67c29b745604186693289b4b358e51cfb7a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQyMTI4Mw==", "url": "https://github.com/linkedin/brooklin/pull/691#discussion_r392421283", "bodyText": "Done.", "author": "vmaheshw", "createdAt": "2020-03-13T19:12:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMwNTAwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMxNjQwMA==", "url": "https://github.com/linkedin/brooklin/pull/691#discussion_r392316400", "bodyText": "Objects.equals()? It's not clear to me if _errorMessage can never be null.", "author": "ahmedahamid", "createdAt": "2020-03-13T15:55:50Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/CoordinatorEvent.java", "diffHunk": "@@ -149,6 +156,26 @@ public String getEventData() {\n       return _errorMessage;\n     }\n \n+    @Override\n+    public boolean equals(Object o) {\n+      if (this == o) {\n+        return true;\n+      }\n+      if (o == null || getClass() != o.getClass()) {\n+        return false;\n+      }\n+      if (!super.equals(o)) {\n+        return false;\n+      }\n+      HandleInstanceError that = (HandleInstanceError) o;\n+      return _errorMessage.equals(that._errorMessage);", "originalCommit": "f21f67c29b745604186693289b4b358e51cfb7a4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM0MTg5MA==", "url": "https://github.com/linkedin/brooklin/pull/691#discussion_r392341890", "bodyText": "stale comment? javadoc on function seems stale, too", "author": "ahmedahamid", "createdAt": "2020-03-13T16:38:13Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/CoordinatorEventBlockingQueue.java", "diffHunk": "@@ -38,19 +38,14 @@ public CoordinatorEventBlockingQueue() {\n    */\n   public synchronized void put(CoordinatorEvent event) {\n     LOG.info(\"Queuing event {} to event queue\", event.getType());\n-    if (!_eventMap.containsKey(event.getType())) {\n+    if (!_eventSet.contains(event)) {\n       // only insert if there isn't an event present in the queue with the same name", "originalCommit": "f21f67c29b745604186693289b4b358e51cfb7a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQyMTMzMQ==", "url": "https://github.com/linkedin/brooklin/pull/691#discussion_r392421331", "bodyText": "Done.", "author": "vmaheshw", "createdAt": "2020-03-13T19:12:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM0MTg5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM1MDk3Mw==", "url": "https://github.com/linkedin/brooklin/pull/691#discussion_r392350973", "bodyText": "Since put() permits null to be inserted into _eventSet, shouldn't we move this outside of the if block?\nA quick look didn't show me any places where we explicitly put(null) but I see this method returning null on line 70 and I am not 100% sure some piece of code won't put that back.", "author": "ahmedahamid", "createdAt": "2020-03-13T16:52:28Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/CoordinatorEventBlockingQueue.java", "diffHunk": "@@ -78,7 +73,7 @@ public synchronized CoordinatorEvent take() throws InterruptedException {\n     if (queuedEvent != null) {\n       LOG.info(\"De-queuing event \" + queuedEvent.getType());\n       LOG.debug(\"Event queue size: {}\", _eventQueue.size());\n-      _eventMap.remove(queuedEvent.getType());\n+      _eventSet.remove(queuedEvent);", "originalCommit": "f21f67c29b745604186693289b4b358e51cfb7a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQwMTM3Mw==", "url": "https://github.com/linkedin/brooklin/pull/691#discussion_r392401373", "bodyText": "poll returns null if queue is empty.", "author": "vmaheshw", "createdAt": "2020-03-13T18:29:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM1MDk3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM5MTU2Mw==", "url": "https://github.com/linkedin/brooklin/pull/691#discussion_r392391563", "bodyText": "Thinking out loud: should we assert on the total number of events actually in the queue after these puts, or whether our takes exhaust them?", "author": "ahmedahamid", "createdAt": "2020-03-13T18:10:02Z", "path": "datastream-server/src/test/java/com/linkedin/datastream/server/TestCoordinatorEventBlockingQueue.java", "diffHunk": "@@ -16,38 +16,20 @@\n   @Test\n   public void testHappyPath() throws Exception {\n     CoordinatorEventBlockingQueue eventBlockingQueue = new CoordinatorEventBlockingQueue();\n-    eventBlockingQueue.put(CoordinatorEvent.LEADER_DO_ASSIGNMENT_EVENT);\n-    eventBlockingQueue.put(CoordinatorEvent.LEADER_DO_ASSIGNMENT_EVENT);\n-    eventBlockingQueue.put(CoordinatorEvent.LEADER_DO_ASSIGNMENT_EVENT);\n-    eventBlockingQueue.put(CoordinatorEvent.HANDLE_ASSIGNMENT_CHANGE_EVENT);\n-    eventBlockingQueue.put(CoordinatorEvent.HANDLE_ASSIGNMENT_CHANGE_EVENT);\n-    eventBlockingQueue.put(CoordinatorEvent.HANDLE_ASSIGNMENT_CHANGE_EVENT);\n-    eventBlockingQueue.put(CoordinatorEvent.LEADER_DO_CLEANUP_POST_ELECTION_EVENT);\n-    eventBlockingQueue.put(CoordinatorEvent.LEADER_DO_CLEANUP_POST_ELECTION_EVENT);\n-    eventBlockingQueue.put(CoordinatorEvent.LEADER_DO_CLEANUP_POST_ELECTION_EVENT);\n-    Assert.assertEquals(eventBlockingQueue.take(), CoordinatorEvent.LEADER_DO_ASSIGNMENT_EVENT);\n-    Assert.assertEquals(eventBlockingQueue.take(), CoordinatorEvent.HANDLE_ASSIGNMENT_CHANGE_EVENT);\n-    Assert.assertEquals(eventBlockingQueue.take(), CoordinatorEvent.LEADER_DO_CLEANUP_POST_ELECTION_EVENT);\n-  }\n-\n-\n-  @Test\n-  public void testEventWithMetadata() throws Exception {\n-    CoordinatorEventBlockingQueue eventBlockingQueue = new CoordinatorEventBlockingQueue();\n-    eventBlockingQueue.put(CoordinatorEvent.LEADER_DO_ASSIGNMENT_EVENT);\n-    eventBlockingQueue.put(CoordinatorEvent.LEADER_DO_ASSIGNMENT_EVENT);\n-    eventBlockingQueue.put(CoordinatorEvent.LEADER_DO_ASSIGNMENT_EVENT);\n+    eventBlockingQueue.put(CoordinatorEvent.createLeaderDoAssignmentEvent(false));\n+    eventBlockingQueue.put(CoordinatorEvent.createLeaderDoAssignmentEvent(true));\n+    eventBlockingQueue.put(CoordinatorEvent.createLeaderDoAssignmentEvent(false));\n+    eventBlockingQueue.put(CoordinatorEvent.createLeaderDoAssignmentEvent(true));\n     eventBlockingQueue.put(CoordinatorEvent.createLeaderPartitionAssignmentEvent(\"test1\"));\n     eventBlockingQueue.put(CoordinatorEvent.createLeaderPartitionAssignmentEvent(\"test1\"));\n     eventBlockingQueue.put(CoordinatorEvent.createLeaderPartitionAssignmentEvent(\"test2\"));\n     eventBlockingQueue.put(CoordinatorEvent.HANDLE_ASSIGNMENT_CHANGE_EVENT);\n     eventBlockingQueue.put(CoordinatorEvent.HANDLE_ASSIGNMENT_CHANGE_EVENT);\n     eventBlockingQueue.put(CoordinatorEvent.HANDLE_ASSIGNMENT_CHANGE_EVENT);", "originalCommit": "f21f67c29b745604186693289b4b358e51cfb7a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQyMTM4Mw==", "url": "https://github.com/linkedin/brooklin/pull/691#discussion_r392421383", "bodyText": "Done.", "author": "vmaheshw", "createdAt": "2020-03-13T19:12:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM5MTU2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM5NDQxNQ==", "url": "https://github.com/linkedin/brooklin/pull/691#discussion_r392394415", "bodyText": "I almost reached out to you then thought this would prolly be a lot more useful to ask over here for knowledge sharing and wider visibility (think of future maintainers):\n\nWhy could put() be invoked with duplicate events?\nWhy are we rejecting duplicates?", "author": "ahmedahamid", "createdAt": "2020-03-13T18:16:08Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/CoordinatorEventBlockingQueue.java", "diffHunk": "@@ -38,19 +38,14 @@ public CoordinatorEventBlockingQueue() {\n    */\n   public synchronized void put(CoordinatorEvent event) {\n     LOG.info(\"Queuing event {} to event queue\", event.getType());\n-    if (!_eventMap.containsKey(event.getType())) {\n+    if (!_eventSet.contains(event)) {", "originalCommit": "f21f67c29b745604186693289b4b358e51cfb7a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQwMjc2OQ==", "url": "https://github.com/linkedin/brooklin/pull/691#discussion_r392402769", "bodyText": "Heartbeat is added periodically. If the Coordinator Event thread is stuck or slow at processing, we might add another heartbeat event.\nReason to reject is if the event is already present in the queue, it will do the exact operation twice (which is unnecessary) and delay the pipeline.", "author": "vmaheshw", "createdAt": "2020-03-13T18:32:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM5NDQxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM5ODg0OQ==", "url": "https://github.com/linkedin/brooklin/pull/691#discussion_r392398849", "bodyText": "May just be a good idea to call out why this should only be called once -> that it's an expensive operation.\nSomeone reading this code later may not realize why without making it explicit.", "author": "somandal", "createdAt": "2020-03-13T18:24:59Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/Coordinator.java", "diffHunk": "@@ -375,10 +375,9 @@ public void onBecomeLeader() {\n     // when an instance becomes a leader, make sure we don't miss new datastreams and\n     // new assignment tasks that was not finished by the previous leader\n     _eventQueue.put(CoordinatorEvent.createHandleDatastreamAddOrDeleteEvent());\n-    _eventQueue.put(CoordinatorEvent.createLeaderDoAssignmentEvent());\n-    // This should be only called after createLeaderDoAssignmentEvent as it will verify/cleanup the orphan task nodes\n-    // under connector.\n-    _eventQueue.put(CoordinatorEvent.createLeaderDoCleanupPostElectionEvent());\n+    // verify/cleanup the orphan task nodes under connector should be called only once after becoming leader.", "originalCommit": "f21f67c29b745604186693289b4b358e51cfb7a4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM5OTU5MQ==", "url": "https://github.com/linkedin/brooklin/pull/691#discussion_r392399591", "bodyText": "can we rename this function now, since there is no longer a \"CLEANUP_TASK_POST_ELECTION\" event?", "author": "somandal", "createdAt": "2020-03-13T18:26:21Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/Coordinator.java", "diffHunk": "@@ -1001,6 +996,9 @@ private void handleLeaderDoAssignment() {\n       instances.add(PAUSED_INSTANCE);\n       _adapter.cleanupDeadInstanceAssignments(instances);\n       _adapter.cleanupOldUnusedTasks(previousAssignmentByInstance, newAssignmentsByInstance);\n+      if (cleanUpOrphanConnectorTasks) {\n+        performCleanupTaskPostElection();", "originalCommit": "f21f67c29b745604186693289b4b358e51cfb7a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQyMTUyMw==", "url": "https://github.com/linkedin/brooklin/pull/691#discussion_r392421523", "bodyText": "Done.", "author": "vmaheshw", "createdAt": "2020-03-13T19:13:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM5OTU5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM5OTgyMA==", "url": "https://github.com/linkedin/brooklin/pull/691#discussion_r392399820", "bodyText": "It'll be good to explain what this parameter does", "author": "somandal", "createdAt": "2020-03-13T18:26:42Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/Coordinator.java", "diffHunk": "@@ -960,7 +955,7 @@ private void deleteTopic(Datastream datastream) {\n         .collect(Collectors.toList());\n   }\n \n-  private void handleLeaderDoAssignment() {\n+  private void handleLeaderDoAssignment(boolean cleanUpOrphanConnectorTasks) {", "originalCommit": "f21f67c29b745604186693289b4b358e51cfb7a4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e632ae7354804a2692aa2ba19fef0fd3c536d5ba", "url": "https://github.com/linkedin/brooklin/commit/e632ae7354804a2692aa2ba19fef0fd3c536d5ba", "message": "Fix based on review comments", "committedDate": "2020-03-13T19:11:40Z", "type": "commit"}]}