{"pr_number": 725, "pr_title": "Add support for Producer flush() with a configurable timeout", "pr_createdAt": "2020-06-25T03:25:56Z", "pr_url": "https://github.com/linkedin/brooklin/pull/725", "timeline": [{"oid": "4eeb40a05edb60202a836d4f180db91ad8119635", "url": "https://github.com/linkedin/brooklin/commit/4eeb40a05edb60202a836d4f180db91ad8119635", "message": "Add support Producer flush with a timeout configurable via config", "committedDate": "2020-06-25T03:21:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2NTE2MA==", "url": "https://github.com/linkedin/brooklin/pull/725#discussion_r447165160", "bodyText": "Since you did the refactoring, can you please take of this as well ? May be move down after all private static final.", "author": "vmaheshw", "createdAt": "2020-06-29T18:22:08Z", "path": "datastream-kafka/src/main/java/com/linkedin/datastream/kafka/KafkaProducerWrapper.java", "diffHunk": "@@ -60,15 +60,30 @@\n   @VisibleForTesting", "originalCommit": "4eeb40a05edb60202a836d4f180db91ad8119635", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIwMjc0OQ==", "url": "https://github.com/linkedin/brooklin/pull/725#discussion_r447202749", "bodyText": "done", "author": "somandal", "createdAt": "2020-06-29T19:29:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2NTE2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2NjQ3Nw==", "url": "https://github.com/linkedin/brooklin/pull/725#discussion_r447166477", "bodyText": "Do you see a value in adding a test to ensure that flush timeout is honored?", "author": "vmaheshw", "createdAt": "2020-06-29T18:24:24Z", "path": "datastream-kafka/src/test/java/com/linkedin/datastream/kafka/TestKafkaProducerWrapper.java", "diffHunk": "@@ -150,7 +151,7 @@ void verifySend(int numExpected) {\n     }\n \n     void verifyFlush(int numExpected) {\n-      verify(_mockProducer, times(numExpected)).flush();\n+      verify(_mockProducer, times(numExpected)).flush(anyInt(), any(TimeUnit.class));", "originalCommit": "4eeb40a05edb60202a836d4f180db91ad8119635", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2OTkyNg==", "url": "https://github.com/linkedin/brooklin/pull/725#discussion_r447169926", "bodyText": "One example is here https://github.com/linkedin/brooklin/pull/676/files where it can throw timeoutException. See if this is useful.", "author": "vmaheshw", "createdAt": "2020-06-29T18:30:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2NjQ3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIwMjY1OA==", "url": "https://github.com/linkedin/brooklin/pull/725#discussion_r447202658", "bodyText": "As discussed, adding a test similar to what you had in that PR is hard because we are relying on Kafka's internal timeout  mechanism, unlike in your earlier PR where the KafkaProducerWrapper itself was responsible for timing out the  flush. Instead, added a test to  validate that we handle TimeoutException as expected.", "author": "somandal", "createdAt": "2020-06-29T19:29:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2NjQ3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE3MjAzNw==", "url": "https://github.com/linkedin/brooklin/pull/725#discussion_r447172037", "bodyText": "Not your fault nit: TIMEOUT", "author": "ahmedahamid", "createdAt": "2020-06-29T18:33:44Z", "path": "datastream-kafka/src/main/java/com/linkedin/datastream/kafka/KafkaProducerWrapper.java", "diffHunk": "@@ -60,15 +60,30 @@\n   @VisibleForTesting\n   static final String PRODUCER_COUNT = \"producerCount\";\n \n+  // Default producer configuration for no data loss pipeline.\n+  private static final String DEFAULT_PRODUCER_ACKS_CONFIG_VALUE = \"all\";\n+  private static final String DEFAULT_MAX_BLOCK_MS_CONFIG_VALUE = String.valueOf(Integer.MAX_VALUE);\n+  private static final String DEFAULT_MAX_IN_FLIGHT_REQUESTS_PER_CONNECTION_VALUE = \"1\";\n+\n+  private static final long DEFAULT_SEND_FAILURE_RETRY_WAIT_MS = Duration.ofSeconds(5).toMillis();\n+  private static final int DEFAULT_PRODUCER_FLUSH_TIMEOUT_MS = Integer.MAX_VALUE;\n+  private static final Double DEFAULT_RATE_LIMITER = 0.1;\n+\n+  private static final String CFG_SEND_FAILURE_RETRY_WAIT_MS = \"send.failure.retry.wait.time.ms\";\n+  private static final String CFG_KAFKA_PRODUCER_FACTORY = \"kafkaProducerFactory\";\n+  private static final String CFG_RATE_LIMITER_CFG = \"producerRateLimiter\";\n+  private static final String CFG_PRODUCER_FLUSH_TIMEOUT_MS = \"producerFlushTimeoutMs\";\n+\n   private static final AtomicInteger NUM_PRODUCERS = new AtomicInteger();\n   private static final Supplier<Integer> PRODUCER_GAUGE = NUM_PRODUCERS::get;\n \n-  private static final int TIME_OUT = 2000;\n+  private static final int CLOSE_TIME_OUT_MS = 2000;", "originalCommit": "4eeb40a05edb60202a836d4f180db91ad8119635", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIwMjgwNQ==", "url": "https://github.com/linkedin/brooklin/pull/725#discussion_r447202805", "bodyText": "done", "author": "somandal", "createdAt": "2020-06-29T19:29:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE3MjAzNw=="}], "type": "inlineReview"}, {"oid": "ed323313acdffdb5977abb7b14db5d3ee1449714", "url": "https://github.com/linkedin/brooklin/commit/ed323313acdffdb5977abb7b14db5d3ee1449714", "message": "Address review comments", "committedDate": "2020-06-29T19:27:17Z", "type": "commit"}]}