{"pr_number": 921, "pr_title": "GG-27188 JMX metric indexbuildcountpartitionsleft show values below zero", "pr_createdAt": "2020-02-11T23:50:25Z", "pr_url": "https://github.com/gridgain/gridgain/pull/921", "timeline": [{"oid": "59ef85dcf694c0f6362cf353d65e939634d9ddb3", "url": "https://github.com/gridgain/gridgain/commit/59ef85dcf694c0f6362cf353d65e939634d9ddb3", "message": "GG-27188 JMX metric indexbuildcountpartitionsleft show values below zero", "committedDate": "2020-02-11T23:46:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjM4OTc1NQ==", "url": "https://github.com/gridgain/gridgain/pull/921#discussion_r396389755", "bodyText": "new line need to be here.", "author": "zstan", "createdAt": "2020-03-23T11:42:23Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/CacheGroupMetricsImpl.java", "diffHunk": "@@ -191,6 +191,13 @@ public void setIndexBuildCountPartitionsLeft(long idxBuildCntPartitionsLeft) {\n     public void decrementIndexBuildCountPartitionsLeft() {\n         idxBuildCntPartitionsLeft.decrement();\n     }\n+    /**", "originalCommit": "59ef85dcf694c0f6362cf353d65e939634d9ddb3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjM4OTg4Mw==", "url": "https://github.com/gridgain/gridgain/pull/921#discussion_r396389883", "bodyText": "and new line here", "author": "zstan", "createdAt": "2020-03-23T11:42:38Z", "path": "modules/indexing/src/test/java/org/apache/ignite/internal/processors/cache/CacheGroupMetricsWithIndexTest.java", "diffHunk": "@@ -79,8 +85,32 @@\n         IgniteConfiguration cfg = super.getConfiguration(igniteInstanceName);\n \n         for (CacheConfiguration cacheCfg : cfg.getCacheConfiguration()) {\n-            if (GROUP_NAME.equals(cacheCfg.getGroupName()) && CACHE_NAME.equals(cacheCfg.getName())) {\n-                QueryEntity qryEntity = new QueryEntity(Long.class.getCanonicalName(), OBJECT_NAME);\n+            if (GROUP_NAME.equals(cacheCfg.getGroupName()) && CACHE_NAME2.equals(cacheCfg.getName())) {\n+                QueryEntity qryEntity = new QueryEntity(Long.class.getCanonicalName(), OBJECT_NAME2);\n+\n+                qryEntity.setKeyFieldName(KEY_NAME);\n+\n+                LinkedHashMap<String, String> fields = new LinkedHashMap<>();\n+\n+                fields.put(KEY_NAME, Long.class.getCanonicalName());\n+\n+                fields.put(COLUMN1_NAME, Integer.class.getCanonicalName());\n+\n+                fields.put(COLUMN2_NAME, String.class.getCanonicalName());\n+\n+                qryEntity.setFields(fields);\n+\n+                ArrayList<QueryIndex> indexes = new ArrayList<>();\n+\n+                indexes.add(new QueryIndex(COLUMN1_NAME));\n+\n+                indexes.add(new QueryIndex(COLUMN2_NAME));\n+\n+                qryEntity.setIndexes(indexes);\n+\n+                cacheCfg.setQueryEntities(Collections.singletonList(qryEntity));\n+            }else if (GROUP_NAME.equals(cacheCfg.getGroupName()) && CACHE_NAME3.equals(cacheCfg.getName())) {", "originalCommit": "59ef85dcf694c0f6362cf353d65e939634d9ddb3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ab054861018f60504a83492bc52e3d61e2f2f182", "url": "https://github.com/gridgain/gridgain/commit/ab054861018f60504a83492bc52e3d61e2f2f182", "message": "Merge remote-tracking branch 'gridgain-ce/master' into gg-27188\n\n# Conflicts:\n#\tmodules/core/src/main/java/org/apache/ignite/internal/processors/query/GridQueryProcessor.java\n#\tmodules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/IgniteH2Indexing.java", "committedDate": "2020-03-26T13:40:51Z", "type": "commit"}, {"oid": "d833b2bc1519995a754fcacc0f7ac080ed37d37f", "url": "https://github.com/gridgain/gridgain/commit/d833b2bc1519995a754fcacc0f7ac080ed37d37f", "message": "GG-27188 JMX metric indexbuildcountpartitionsleft show values below zero. Merge master", "committedDate": "2020-03-26T14:47:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE2NzM5Ng==", "url": "https://github.com/gridgain/gridgain/pull/921#discussion_r402167396", "bodyText": "Will be better to rewrite it to use our system view. INFORMATION_SCHEMA don't support by IGNITE at all.", "author": "ygerzhedovich", "createdAt": "2020-04-02T09:14:37Z", "path": "modules/indexing/src/test/java/org/apache/ignite/internal/processors/cache/CacheGroupMetricsWithIndexTest.java", "diffHunk": "@@ -182,34 +213,34 @@ public void testIndexCreateCountPartitionsLeft() throws Exception {\n \n         ignite.cluster().active(true);\n \n-        IgniteCache<Object, Object> cache1 = ignite.cache(CACHE_NAME);\n+        IgniteCache<Object, Object> cache2 = ignite.cache(CACHE_NAME2);\n \n         String addColSql = \"ALTER TABLE \" + TABLE + \" ADD COLUMN \" + COLUMN3_NAME + \" BIGINT\";\n \n-        cache1.query(new SqlFieldsQuery(addColSql)).getAll();\n+        cache2.query(new SqlFieldsQuery(addColSql)).getAll();\n \n         for (int i = 0; i < 100_000; i++) {\n             Long id = (long)i;\n \n-            BinaryObjectBuilder o = ignite.binary().builder(OBJECT_NAME)\n+            BinaryObjectBuilder o = ignite.binary().builder(OBJECT_NAME2)\n                 .setField(KEY_NAME, id)\n                 .setField(COLUMN1_NAME, i / 2)\n                 .setField(COLUMN2_NAME, \"str\" + Integer.toHexString(i))\n                 .setField(COLUMN3_NAME, id * 10);\n \n-            cache1.put(id, o.build());\n+            cache2.put(id, o.build());\n         }\n \n         MetricRegistry metrics = cacheGroupMetrics(0, GROUP_NAME).get2();\n \n         GridTestUtils.runAsync(() -> {\n             String createIdxSql = \"CREATE INDEX \" + INDEX_NAME + \" ON \" + TABLE + \"(\" + COLUMN3_NAME + \")\";\n \n-            cache1.query(new SqlFieldsQuery(createIdxSql)).getAll();\n+            cache2.query(new SqlFieldsQuery(createIdxSql)).getAll();\n \n             String selectIdxSql = \"select * from information_schema.indexes where index_name='\" + INDEX_NAME + \"'\";", "originalCommit": "d833b2bc1519995a754fcacc0f7ac080ed37d37f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE2OTYyNg==", "url": "https://github.com/gridgain/gridgain/pull/921#discussion_r402169626", "bodyText": "when metrics could be null?", "author": "ygerzhedovich", "createdAt": "2020-04-02T09:18:11Z", "path": "modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/IgniteH2Indexing.java", "diffHunk": "@@ -2024,6 +2024,9 @@ public UpdateResult executeUpdateOnDataNode(\n \n         GridFutureAdapter<Void> rebuildCacheIdxFut = new GridFutureAdapter<>();\n \n+        if (cctx.group().metrics() != null)", "originalCommit": "d833b2bc1519995a754fcacc0f7ac080ed37d37f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "62fd88433cf9f0ede330b3dd955f30a0bbd9df0a", "url": "https://github.com/gridgain/gridgain/commit/62fd88433cf9f0ede330b3dd955f30a0bbd9df0a", "message": "GG-27188 JMX metric indexbuildcountpartitionsleft show values below zero. Corrections on the results of the code review.", "committedDate": "2020-04-03T21:37:47Z", "type": "commit"}]}