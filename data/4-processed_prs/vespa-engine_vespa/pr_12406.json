{"pr_number": 12406, "pr_title": "Fail early on submit with missing security/clients.pem", "pr_createdAt": "2020-03-03T08:56:39Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/12406", "timeline": [{"oid": "c504788f5f61acdca835e97a56263d5f2af686b2", "url": "https://github.com/vespa-engine/vespa/commit/c504788f5f61acdca835e97a56263d5f2af686b2", "message": "Fail early on missing security/clients.pem in application package", "committedDate": "2020-03-03T08:53:37Z", "type": "commit"}, {"oid": "07baa14310cbd62b7c94bb8f223d322fd994837b", "url": "https://github.com/vespa-engine/vespa/commit/07baa14310cbd62b7c94bb8f223d322fd994837b", "message": "Add copyright header", "committedDate": "2020-03-03T08:55:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk2NDA3Ng==", "url": "https://github.com/vespa-engine/vespa/pull/12406#discussion_r386964076", "bodyText": "This belongs in ApplicationPackageValidator.", "author": "mpolden", "createdAt": "2020-03-03T11:39:21Z", "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/restapi/application/ApplicationApiHandler.java", "diffHunk": "@@ -1956,6 +1956,12 @@ private HttpResponse submit(String tenant, String application, HttpRequest reque\n \n         ApplicationPackage applicationPackage = new ApplicationPackage(dataParts.get(EnvironmentResource.APPLICATION_ZIP), true);\n \n+        // if we are in public and 'security/clients.pem' is not present (i.e. we don't have any trusted\n+        // certificates), we should fail early instead of waiting for the configserver to fail.\n+        if (controller.system().isPublic() && applicationPackage.trustedCertificates().isEmpty()) {", "originalCommit": "07baa14310cbd62b7c94bb8f223d322fd994837b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk3MjA1NQ==", "url": "https://github.com/vespa-engine/vespa/pull/12406#discussion_r386972055", "bodyText": "Should be fixed now. Take another look. I have no idea if the test works since the build got broken by a later git pull :(", "author": "oyving", "createdAt": "2020-03-03T11:56:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk2NDA3Ng=="}], "type": "inlineReview"}, {"oid": "357cab0701ee5f5edec2a62b7d43e81dced46e83", "url": "https://github.com/vespa-engine/vespa/commit/357cab0701ee5f5edec2a62b7d43e81dced46e83", "message": "Move validation to validator class", "committedDate": "2020-03-03T11:55:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk3MjQ2NA==", "url": "https://github.com/vespa-engine/vespa/pull/12406#discussion_r386972464", "bodyText": "Should be private.", "author": "mpolden", "createdAt": "2020-03-03T11:57:44Z", "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/application/ApplicationPackageValidator.java", "diffHunk": "@@ -46,6 +46,13 @@ public void validate(Application application, ApplicationPackage applicationPack\n         validateSteps(applicationPackage.deploymentSpec());\n         validateEndpointRegions(applicationPackage.deploymentSpec());\n         validateEndpointChange(application, applicationPackage, instant);\n+        validateSecurityClientsPem(applicationPackage);\n+    }\n+\n+    /** Verify that we have the security/clients.pem file for public systems */\n+    public void validateSecurityClientsPem(ApplicationPackage applicationPackage) {", "originalCommit": "357cab0701ee5f5edec2a62b7d43e81dced46e83", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5f9bfebd97b4499056186024b75d7ae360e78bdd", "url": "https://github.com/vespa-engine/vespa/commit/5f9bfebd97b4499056186024b75d7ae360e78bdd", "message": "Make private", "committedDate": "2020-03-03T11:59:35Z", "type": "commit"}, {"oid": "ca8c2aef95c43bce8759eb468ccdf80688293da4", "url": "https://github.com/vespa-engine/vespa/commit/ca8c2aef95c43bce8759eb468ccdf80688293da4", "message": "Fix test by referencing a zone that exists in mock", "committedDate": "2020-03-03T12:11:14Z", "type": "commit"}, {"oid": "ddc15f6257c1efca96e91399e7583fbfed6632d7", "url": "https://github.com/vespa-engine/vespa/commit/ddc15f6257c1efca96e91399e7583fbfed6632d7", "message": "Add a way to add a dummy certificate for testing", "committedDate": "2020-03-03T13:30:40Z", "type": "commit"}]}