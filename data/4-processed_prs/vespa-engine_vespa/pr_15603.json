{"pr_number": 15603, "pr_title": "jonmv/document and test dynamic throttling policy", "pr_createdAt": "2020-12-02T14:09:56Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/15603", "timeline": [{"oid": "2461523aca39b5af3b5bafef44e51c7bb13be76b", "url": "https://github.com/vespa-engine/vespa/commit/2461523aca39b5af3b5bafef44e51c7bb13be76b", "message": "Fix parentheses in carry expression", "committedDate": "2020-12-02T14:09:01Z", "type": "commit"}, {"oid": "ac5041033b8782e2cb8b1f64f880f004c510bea6", "url": "https://github.com/vespa-engine/vespa/commit/ac5041033b8782e2cb8b1f64f880f004c510bea6", "message": "Add unit tests and some doc for DynamicThrottlingPolicy", "committedDate": "2020-12-02T14:09:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDk4Mzk0NQ==", "url": "https://github.com/vespa-engine/vespa/pull/15603#discussion_r534983945", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * which satisfy <code>log10(1 / latency) % 1 = e</code>, for some constant <code>0 < e < 1</code>. Weird? Most certainly!\n          \n          \n            \n             * which satisfy <code>log10(1 / latency) % 1 = e</code>, for some constant <code>0 &lt; e &lt; 1</code>. Weird? Most certainly!", "author": "jonmv", "createdAt": "2020-12-03T09:12:45Z", "path": "messagebus/src/main/java/com/yahoo/messagebus/DynamicThrottlePolicy.java", "diffHunk": "@@ -8,11 +8,43 @@\n \n /**\n  * This is an implementation of the {@link ThrottlePolicy} that offers dynamic limits to the number of pending messages a\n- * {@link SourceSession} is allowed to have.\n- *\n- * <b>NOTE:</b> By context, \"pending\" is referring to the number of sent messages that have not been replied to yet.\n+ * {@link SourceSession} is allowed to have. Pending means the number of sent messages that have not been replied to yet.\n+ * <p>\n+ * The algorithm works by increasing the number of messages allowed to be pending, the <em>winidow size</em>, until\n+ * this no longer increases throughput. At this point, the algorithm is driven by synthetic attraction towards latencies\n+ * which satisfy <code>log10(1 / latency) % 1 = e</code>, for some constant <code>0 < e < 1</code>. Weird? Most certainly!", "originalCommit": "ac5041033b8782e2cb8b1f64f880f004c510bea6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7005bf273d8ed242dcecd7775e5982262192ffbb", "url": "https://github.com/vespa-engine/vespa/commit/7005bf273d8ed242dcecd7775e5982262192ffbb", "message": "fix javadoc", "committedDate": "2020-12-03T09:12:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE0NTYyMg==", "url": "https://github.com/vespa-engine/vespa/pull/15603#discussion_r535145622", "bodyText": "s/winidow/window", "author": "vekterli", "createdAt": "2020-12-03T11:41:01Z", "path": "messagebus/src/main/java/com/yahoo/messagebus/DynamicThrottlePolicy.java", "diffHunk": "@@ -8,11 +8,43 @@\n \n /**\n  * This is an implementation of the {@link ThrottlePolicy} that offers dynamic limits to the number of pending messages a\n- * {@link SourceSession} is allowed to have.\n- *\n- * <b>NOTE:</b> By context, \"pending\" is referring to the number of sent messages that have not been replied to yet.\n+ * {@link SourceSession} is allowed to have. Pending means the number of sent messages that have not been replied to yet.\n+ * <p>\n+ * The algorithm works by increasing the number of messages allowed to be pending, the <em>winidow size</em>, until", "originalCommit": "7005bf273d8ed242dcecd7775e5982262192ffbb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI5MDI1OA==", "url": "https://github.com/vespa-engine/vespa/pull/15603#discussion_r535290258", "bodyText": "Thanks!", "author": "jonmv", "createdAt": "2020-12-03T14:44:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE0NTYyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI5MDg3Mw==", "url": "https://github.com/vespa-engine/vespa/pull/15603#discussion_r535290873", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * The algorithm works by increasing the number of messages allowed to be pending, the <em>winidow size</em>, until\n          \n          \n            \n             * The algorithm works by increasing the number of messages allowed to be pending, the <em>window size</em>, until", "author": "jonmv", "createdAt": "2020-12-03T14:45:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE0NTYyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE3NTkyMA==", "url": "https://github.com/vespa-engine/vespa/pull/15603#discussion_r535175920", "bodyText": "This is probably not intended to be included", "author": "vekterli", "createdAt": "2020-12-03T12:12:52Z", "path": "messagebus/src/main/java/com/yahoo/messagebus/DynamicThrottlePolicy.java", "diffHunk": "@@ -96,30 +129,31 @@ public void processMessage(Message message) {\n         numSent = 0;\n         numOk = 0;\n \n-\n         if (maxThroughput > 0 && throughput > maxThroughput * 0.95) {\n             // No need to increase window when we're this close to max.\n-        } else if (throughput >= localMaxThroughput) {\n+            // TODO jonmv: Not so sure \u2014 what if we're too high, and should back off?\n+        } else if (throughput > localMaxThroughput) {\n             localMaxThroughput = throughput;\n-            windowSize += weight*windowSizeIncrement;\n+            windowSize += weight * windowSizeIncrement;\n             if (log.isLoggable(Level.FINE)) {\n                 log.log(Level.FINE, \"windowSize \" + windowSize + \" throughput \" + throughput + \" local max \" + localMaxThroughput);\n             }\n         } else {\n             // scale up/down throughput for comparing to window size\n             double period = 1;\n-            while(throughput * period/windowSize < 2) {\n+            while(throughput * period / windowSize < 2) {\n                 period *= 10;\n             }\n-            while(throughput * period/windowSize > 2) {\n+            while(throughput * period / windowSize > 2) {\n                 period *= 0.1;\n             }\n-            double efficiency = throughput*period/windowSize;\n+            double efficiency = throughput * period / windowSize; // \"efficiency\" is a strange name. This is where on the level it is.\n+            if (Math.random() < 1e-2) System.err.println(efficiency);", "originalCommit": "7005bf273d8ed242dcecd7775e5982262192ffbb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI5MDM5MQ==", "url": "https://github.com/vespa-engine/vespa/pull/15603#discussion_r535290391", "bodyText": "Absolutely not.", "author": "jonmv", "createdAt": "2020-12-03T14:45:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE3NTkyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI5MTIxOA==", "url": "https://github.com/vespa-engine/vespa/pull/15603#discussion_r535291218", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (Math.random() < 1e-2) System.err.println(efficiency);", "author": "jonmv", "createdAt": "2020-12-03T14:45:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE3NTkyMA=="}], "type": "inlineReview"}, {"oid": "3abdb35128ce98f2dd0cf2dfeb36494cf8a60687", "url": "https://github.com/vespa-engine/vespa/commit/3abdb35128ce98f2dd0cf2dfeb36494cf8a60687", "message": "Apply suggestions from code review", "committedDate": "2020-12-03T14:45:57Z", "type": "commit"}]}