{"pr_number": 13198, "pr_title": "Use a lock to ensure it is thread safe.", "pr_createdAt": "2020-05-08T21:20:11Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/13198", "timeline": [{"oid": "dae38cdf2f8bd74de485130c3fe63fb91729fce1", "url": "https://github.com/vespa-engine/vespa/commit/dae38cdf2f8bd74de485130c3fe63fb91729fce1", "message": "Use a lock to ensure it is thread safe.", "committedDate": "2020-05-08T21:17:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjM5NTY1MA==", "url": "https://github.com/vespa-engine/vespa/pull/13198#discussion_r422395650", "bodyText": "std::lock_guard<std::mutex> should be sufficient here.", "author": "toregge", "createdAt": "2020-05-08T22:00:17Z", "path": "storage/src/tests/persistence/common/persistenceproviderwrapper.h", "diffHunk": "@@ -50,8 +51,10 @@ class PersistenceProviderWrapper : public spi::AbstractPersistenceProvider\n private:\n     spi::PersistenceProvider& _spi;\n     spi::Result _result;\n+    mutable std::mutex  _lock;\n     mutable std::vector<std::string> _log;\n     uint32_t _failureMask;\n+    using Guard = std::unique_lock<std::mutex>;", "originalCommit": "dae38cdf2f8bd74de485130c3fe63fb91729fce1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQxNjkzMw==", "url": "https://github.com/vespa-engine/vespa/pull/13198#discussion_r422416933", "bodyText": "Thanks, fixed", "author": "baldersheim", "createdAt": "2020-05-08T23:21:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjM5NTY1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjM5NzQ1OQ==", "url": "https://github.com/vespa-engine/vespa/pull/13198#discussion_r422397459", "bodyText": "clearResult() above doesn't seem to be used. Consider removing it.", "author": "toregge", "createdAt": "2020-05-08T22:06:03Z", "path": "storage/src/tests/persistence/common/persistenceproviderwrapper.h", "diffHunk": "@@ -61,12 +64,16 @@ class PersistenceProviderWrapper : public spi::AbstractPersistenceProvider\n      * return the given error without the wrapped SPI ever being invoked.\n      */\n     void setResult(const spi::Result& result) {\n+        Guard guard(_lock);\n         _result = result;\n     }\n     void clearResult() {\n         _result = spi::Result(spi::Result::ErrorType::NONE, \"\");\n     }\n-    const spi::Result& getResult() const { return _result; }", "originalCommit": "dae38cdf2f8bd74de485130c3fe63fb91729fce1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQxNjk4OA==", "url": "https://github.com/vespa-engine/vespa/pull/13198#discussion_r422416988", "bodyText": "Good catch, done.", "author": "baldersheim", "createdAt": "2020-05-08T23:22:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjM5NzQ1OQ=="}], "type": "inlineReview"}, {"oid": "36b2ee30dd912e44a4f85cd4d2d86046bbbab2ce", "url": "https://github.com/vespa-engine/vespa/commit/36b2ee30dd912e44a4f85cd4d2d86046bbbab2ce", "message": "Remove unused clearResult method, and use std::lock_guard", "committedDate": "2020-05-08T23:21:03Z", "type": "commit"}]}