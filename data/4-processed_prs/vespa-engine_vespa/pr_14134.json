{"pr_number": 14134, "pr_title": "Ensure that we call commit and wait before changing feedview.", "pr_createdAt": "2020-08-21T20:39:38Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/14134", "timeline": [{"oid": "c21bf9387619e3c47f3ec57db0d81ab0ad43da49", "url": "https://github.com/vespa-engine/vespa/commit/c21bf9387619e3c47f3ec57db0d81ab0ad43da49", "message": "Ensure that we call commit and wait before changing feedview.\nUse a token to ensure the we do not loose any tracked lids.", "committedDate": "2020-08-21T20:27:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk2NDcxMQ==", "url": "https://github.com/vespa-engine/vespa/pull/14134#discussion_r474964711", "bodyText": "Consider explicitly deleting move assignment too.", "author": "toregge", "createdAt": "2020-08-21T20:57:06Z", "path": "searchcore/src/vespa/searchcore/proton/common/pendinglidtracker.h", "diffHunk": "@@ -10,12 +10,29 @@ namespace proton {\n \n class PendingLidTracker {\n public:\n+    class Token {\n+    public:\n+        Token(uint32_t lid, PendingLidTracker & tracker);\n+        Token(const Token &) = delete;\n+        Token & operator = (const Token &) = delete;", "originalCommit": "c21bf9387619e3c47f3ec57db0d81ab0ad43da49", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwMjI1Ng==", "url": "https://github.com/vespa-engine/vespa/pull/14134#discussion_r475102256", "bodyText": "Done", "author": "baldersheim", "createdAt": "2020-08-22T15:37:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk2NDcxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk3MDAwOA==", "url": "https://github.com/vespa-engine/vespa/pull/14134#discussion_r474970008", "bodyText": "Is this needed ? An nested class has access to private member variables and methods in outer class.", "author": "toregge", "createdAt": "2020-08-21T21:05:29Z", "path": "searchcore/src/vespa/searchcore/proton/common/pendinglidtracker.h", "diffHunk": "@@ -10,12 +10,29 @@ namespace proton {\n \n class PendingLidTracker {\n public:\n+    class Token {\n+    public:\n+        Token(uint32_t lid, PendingLidTracker & tracker);\n+        Token(const Token &) = delete;\n+        Token & operator = (const Token &) = delete;\n+        Token(Token && rhs) noexcept\n+            : _tracker(rhs._tracker),\n+              _lid(rhs._lid)\n+        {\n+            rhs._tracker = nullptr;\n+        }\n+        ~Token();\n+    private:\n+        PendingLidTracker * _tracker;\n+        uint32_t            _lid;\n+    };\n     PendingLidTracker();\n     ~PendingLidTracker();\n-    void produce(uint32_t lid);\n-    void consume(uint32_t lid);\n+    Token produce(uint32_t lid);\n     void waitForConsumedLid(uint32_t lid);\n private:\n+    friend Token;", "originalCommit": "c21bf9387619e3c47f3ec57db0d81ab0ad43da49", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwMjI3MQ==", "url": "https://github.com/vespa-engine/vespa/pull/14134#discussion_r475102271", "bodyText": "No, you are right.", "author": "baldersheim", "createdAt": "2020-08-22T15:38:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk3MDAwOA=="}], "type": "inlineReview"}, {"oid": "afefcb59d303e857744a45c8ad0ade8682e46e28", "url": "https://github.com/vespa-engine/vespa/commit/afefcb59d303e857744a45c8ad0ade8682e46e28", "message": "delete unused move = operator, and remove unnecessary friend declaration.", "committedDate": "2020-08-22T15:37:32Z", "type": "commit"}]}