{"pr_number": 13526, "pr_title": "Add APIs to support setting a tensor and update nearest neighbor inde\u2026", "pr_createdAt": "2020-06-09T14:58:14Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/13526", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzUyNDYyMw==", "url": "https://github.com/vespa-engine/vespa/pull/13526#discussion_r437524623", "bodyText": "promise and future handling should be at a layer above this code. Consider using std::unique_ptr<PrepareResult>or PrepareResult&instead of std::future<std::unique_ptr<PrepareResult>>.", "author": "toregge", "createdAt": "2020-06-09T15:32:48Z", "path": "searchlib/src/vespa/searchlib/tensor/nearest_neighbor_index.h", "diffHunk": "@@ -36,6 +38,38 @@ class NearestNeighborIndex {\n     };\n     virtual ~NearestNeighborIndex() {}\n     virtual void add_document(uint32_t docid) = 0;\n+\n+    /**\n+     * Performs the prepare step in a two-phase operation to add a document to the index.\n+     *\n+     * This function can be called by any thread.\n+     * The document to add is represented by the given vector as it is _not_ stored in the enclosing tensor attribute at this point in time.\n+     * It should return the result of the costly and non-modifying part of this operation.\n+     * The given read guard must be kept in the result.\n+     */\n+    virtual std::unique_ptr<PrepareResult> prepare_add_document(uint32_t docid,\n+                                                                vespalib::tensor::TypedCells vector,\n+                                                                vespalib::GenerationHandler::Guard read_guard) const {\n+        // TODO: Make it pure virtual after more wiring is complete.\n+        (void) docid;\n+        (void) vector;\n+        (void) read_guard;\n+        return std::unique_ptr<PrepareResult>();\n+    }\n+\n+    /**\n+     * Performs the complete step in a two-phase operation to add a document to the index.\n+     *\n+     * This function is only called by the attribute writer thread.\n+     * It must wait for the result from the prepare step (via the future) before it does the modifying changes.\n+     */\n+    virtual void complete_add_document(uint32_t docid,\n+                                       std::future<std::unique_ptr<PrepareResult>> prepare_result) {", "originalCommit": "087d679c6e16f8794b26f474151b2703363b5392", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzkxNDYyMQ==", "url": "https://github.com/vespa-engine/vespa/pull/13526#discussion_r437914621", "bodyText": "Fixed", "author": "geirst", "createdAt": "2020-06-10T07:29:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzUyNDYyMw=="}], "type": "inlineReview"}, {"oid": "87e669fde4007de7675295687882d20b73e12aed", "url": "https://github.com/vespa-engine/vespa/commit/87e669fde4007de7675295687882d20b73e12aed", "message": "Add APIs to support setting a tensor and update nearest neighbor index as two-phase operations.\nThis will enable using multiple threads to update the nearest neighbor index.", "committedDate": "2020-06-10T07:28:41Z", "type": "commit"}, {"oid": "87e669fde4007de7675295687882d20b73e12aed", "url": "https://github.com/vespa-engine/vespa/commit/87e669fde4007de7675295687882d20b73e12aed", "message": "Add APIs to support setting a tensor and update nearest neighbor index as two-phase operations.\nThis will enable using multiple threads to update the nearest neighbor index.", "committedDate": "2020-06-10T07:28:41Z", "type": "forcePushed"}]}