{"pr_number": 15589, "pr_title": "Subclass QuorumPeerMain to be able to use initializeAndRun()", "pr_createdAt": "2020-12-02T11:01:33Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/15589", "timeline": [{"oid": "f0f49e6fd076a82050a9b3937d542a8518e89306", "url": "https://github.com/vespa-engine/vespa/commit/f0f49e6fd076a82050a9b3937d542a8518e89306", "message": "Subclass QuorumPeerMain to be able to use initializeAndRun()\n\nCannot use main(), since it calls System.exit() and will not work\nwhen running unit tests, so subclass and use initializeAndRun()", "committedDate": "2020-12-02T10:59:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDEwOTE3Mg==", "url": "https://github.com/vespa-engine/vespa/pull/15589#discussion_r534109172", "bodyText": "Wait for shutdown?", "author": "mpolden", "createdAt": "2020-12-02T11:53:28Z", "path": "zookeeper-server/zookeeper-server-3.5.6/src/main/java/com/yahoo/vespa/zookeeper/ZooKeeperRunner.java", "diffHunk": "@@ -18,31 +25,42 @@\n public class ZooKeeperRunner implements Runnable {\n     private static final Logger log = java.util.logging.Logger.getLogger(ZooKeeperRunner.class.getName());\n \n-    private final Thread zkServerThread;\n+    private final ExecutorService executorService;\n     private final ZookeeperServerConfig zookeeperServerConfig;\n \n     public ZooKeeperRunner(ZookeeperServerConfig zookeeperServerConfig) {\n         this.zookeeperServerConfig = zookeeperServerConfig;\n         new Configurator(zookeeperServerConfig).writeConfigToDisk(TransportSecurityUtils.getOptions());\n-        zkServerThread = new Thread(this, \"zookeeper server\");\n-        zkServerThread.start();\n+        executorService = Executors.newSingleThreadExecutor(new DaemonThreadFactory(\"zookeeper server\"));\n+        executorService.submit(this);\n     }\n \n     void shutdown() {\n-        zkServerThread.interrupt();\n-        try {\n-            zkServerThread.join();\n-        } catch (InterruptedException e) {\n-            log.log(Level.WARNING, \"Error joining server thread on shutdown\", e);\n-        }\n+        executorService.shutdownNow();", "originalCommit": "f0f49e6fd076a82050a9b3937d542a8518e89306", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDExMjcyMw==", "url": "https://github.com/vespa-engine/vespa/pull/15589#discussion_r534112723", "bodyText": "Yep.", "author": "hmusum", "createdAt": "2020-12-02T11:59:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDEwOTE3Mg=="}], "type": "inlineReview"}, {"oid": "68af74ad922e3d05d491655942c5d4f624840580", "url": "https://github.com/vespa-engine/vespa/commit/68af74ad922e3d05d491655942c5d4f624840580", "message": "Shutdown and wait for termination", "committedDate": "2020-12-02T11:58:50Z", "type": "commit"}]}