{"pr_number": 13034, "pr_title": "Add support for aggregating over B-tree keys", "pr_createdAt": "2020-04-23T13:09:37Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/13034", "timeline": [{"oid": "d389b0e2519a139dc9103a22702be175698262d8", "url": "https://github.com/vespa-engine/vespa/commit/d389b0e2519a139dc9103a22702be175698262d8", "message": "Add support for aggregating over B-tree keys\n\nThis complements the existing support for aggregating over values.\n\nLet aggregate calculator specify whether it expects to be invoked\nwith keys or values.\n\nIn the current implementation there is some code duplication\nthat could have been removed by using e.g. tag dispatch, but\nthis is a pragmatic choice intended to guarantee these changes\ndo not introduce any performance regressions for existing\ncode using value aggregation. Can be refactored later once we\nhave a functional baseline with this for both keys and values.", "committedDate": "2020-04-23T12:35:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzgyODE2MA==", "url": "https://github.com/vespa-engine/vespa/pull/13034#discussion_r413828160", "bodyText": "Consider renaming removed to need_aggregation_recalc.", "author": "toregge", "createdAt": "2020-04-23T14:10:11Z", "path": "vespalib/src/vespa/vespalib/btree/btreeremover.hpp", "diffHunk": "@@ -110,11 +110,17 @@ remove(BTreeNode::Ref &root,\n     NodeAllocatorType &allocator(itr.getAllocator());\n     AggrT oldca(AggrCalcT::hasAggregated() ? lnode->getAggregated() : AggrT());\n     AggrT ca;\n-    if (AggrCalcT::hasAggregated() &&\n-        aggrCalc.remove(lnode->getAggregated(),\n-                        aggrCalc.getVal(lnode->getData(idx)))) {\n+    if constexpr (AggrCalcT::hasAggregated()) {\n+        bool removed;", "originalCommit": "d389b0e2519a139dc9103a22702be175698262d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzgzMjMzNw==", "url": "https://github.com/vespa-engine/vespa/pull/13034#discussion_r413832337", "bodyText": "Fixed", "author": "vekterli", "createdAt": "2020-04-23T14:14:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzgyODE2MA=="}], "type": "inlineReview"}, {"oid": "c3ee3ebc4e85e408a4be486e52745743bac85d0f", "url": "https://github.com/vespa-engine/vespa/commit/c3ee3ebc4e85e408a4be486e52745743bac85d0f", "message": "Rename variable to be semantically accurate", "committedDate": "2020-04-23T14:13:37Z", "type": "commit"}]}