{"pr_number": 13741, "pr_title": "Rename unique feature to globalsequence.", "pr_createdAt": "2020-06-29T13:10:24Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/13741", "timeline": [{"oid": "af54254095fae1bdea8d101a9c0f4811ddf69f56", "url": "https://github.com/vespa-engine/vespa/commit/af54254095fae1bdea8d101a9c0f4811ddf69f56", "message": "Rename unique feature to globalsequence.\nInvert so that the first doc from the first node will sort first,\nfollowed by the first doc from the second node, and the the last doc of the last node at the end.\nIt will produce number in the range (1 << 48) down to zero.\nSequence = (1 << 48) - ((docId << 16) | disributionKey)", "committedDate": "2020-06-29T13:08:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUwMzQ4NA==", "url": "https://github.com/vespa-engine/vespa/pull/13741#discussion_r447503484", "bodyText": "what about the 3 bits we allow to overlap between distribution key and docid?", "author": "havardpe", "createdAt": "2020-06-30T08:25:00Z", "path": "searchlib/src/vespa/searchlib/features/global_sequence_feature.cpp", "diffHunk": "@@ -0,0 +1,64 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#include \"global_sequence_feature.h\"\n+#include <vespa/vespalib/util/stash.h>\n+\n+using namespace search::fef;\n+\n+namespace search::features {\n+\n+namespace {\n+\n+/**\n+ * Implements the executor for combining lid and distribution key to form a globally unique value.\n+ */\n+class GlobalSequenceExecutor : public fef::FeatureExecutor {\n+private:\n+    uint32_t _distributionKey;\n+\n+public:\n+    GlobalSequenceExecutor(uint32_t distributionKey)\n+        : _distributionKey(distributionKey)\n+    {\n+    }\n+\n+    void execute(uint32_t docId) override {\n+        outputs().set_number(0, ((1ul << 48u) - ((uint64_t(docId) << 16u) | _distributionKey)));\n+    }\n+};\n+\n+}\n+\n+GlobalSequenceBlueprint::GlobalSequenceBlueprint() :\n+    Blueprint(\"globalsequence\"),\n+    _distributionKey(0)\n+{\n+}\n+\n+void\n+GlobalSequenceBlueprint::visitDumpFeatures(const IIndexEnvironment &, IDumpFeatureVisitor &) const\n+{\n+}\n+\n+bool\n+GlobalSequenceBlueprint::setup(const IIndexEnvironment & env, const ParameterList & )\n+{\n+    _distributionKey = env.getDistributionKey();\n+    assert( _distributionKey < 0x80000);", "originalCommit": "af54254095fae1bdea8d101a9c0f4811ddf69f56", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYxMTM4OQ==", "url": "https://github.com/vespa-engine/vespa/pull/13741#discussion_r447611389", "bodyText": "Ouch, thanks. That should be 0x10000", "author": "baldersheim", "createdAt": "2020-06-30T11:28:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUwMzQ4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUwNjUzOA==", "url": "https://github.com/vespa-engine/vespa/pull/13741#discussion_r447506538", "bodyText": "consider moving the magic to an inlined function in the header that can also be called by the test", "author": "havardpe", "createdAt": "2020-06-30T08:29:23Z", "path": "searchlib/src/vespa/searchlib/features/global_sequence_feature.cpp", "diffHunk": "@@ -0,0 +1,64 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#include \"global_sequence_feature.h\"\n+#include <vespa/vespalib/util/stash.h>\n+\n+using namespace search::fef;\n+\n+namespace search::features {\n+\n+namespace {\n+\n+/**\n+ * Implements the executor for combining lid and distribution key to form a globally unique value.\n+ */\n+class GlobalSequenceExecutor : public fef::FeatureExecutor {\n+private:\n+    uint32_t _distributionKey;\n+\n+public:\n+    GlobalSequenceExecutor(uint32_t distributionKey)\n+        : _distributionKey(distributionKey)\n+    {\n+    }\n+\n+    void execute(uint32_t docId) override {\n+        outputs().set_number(0, ((1ul << 48u) - ((uint64_t(docId) << 16u) | _distributionKey)));", "originalCommit": "af54254095fae1bdea8d101a9c0f4811ddf69f56", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYxNDc1Mg==", "url": "https://github.com/vespa-engine/vespa/pull/13741#discussion_r447614752", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-06-30T11:35:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUwNjUzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUwOTAyMA==", "url": "https://github.com/vespa-engine/vespa/pull/13741#discussion_r447509020", "bodyText": "consider camel case to match naming of other features", "author": "havardpe", "createdAt": "2020-06-30T08:33:04Z", "path": "searchlib/src/vespa/searchlib/features/global_sequence_feature.cpp", "diffHunk": "@@ -0,0 +1,64 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#include \"global_sequence_feature.h\"\n+#include <vespa/vespalib/util/stash.h>\n+\n+using namespace search::fef;\n+\n+namespace search::features {\n+\n+namespace {\n+\n+/**\n+ * Implements the executor for combining lid and distribution key to form a globally unique value.\n+ */\n+class GlobalSequenceExecutor : public fef::FeatureExecutor {\n+private:\n+    uint32_t _distributionKey;\n+\n+public:\n+    GlobalSequenceExecutor(uint32_t distributionKey)\n+        : _distributionKey(distributionKey)\n+    {\n+    }\n+\n+    void execute(uint32_t docId) override {\n+        outputs().set_number(0, ((1ul << 48u) - ((uint64_t(docId) << 16u) | _distributionKey)));\n+    }\n+};\n+\n+}\n+\n+GlobalSequenceBlueprint::GlobalSequenceBlueprint() :\n+    Blueprint(\"globalsequence\"),", "originalCommit": "af54254095fae1bdea8d101a9c0f4811ddf69f56", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUxOTczOQ==", "url": "https://github.com/vespa-engine/vespa/pull/13741#discussion_r447519739", "bodyText": "Yes, the name should use came case.", "author": "geirst", "createdAt": "2020-06-30T08:49:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUwOTAyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYxMjMxOQ==", "url": "https://github.com/vespa-engine/vespa/pull/13741#discussion_r447612319", "bodyText": "globalsequence -> globalSequence", "author": "baldersheim", "createdAt": "2020-06-30T11:30:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzUwOTAyMA=="}], "type": "inlineReview"}, {"oid": "43575b1d6514953e08583999f0d0d29f23cf3ba1", "url": "https://github.com/vespa-engine/vespa/commit/43575b1d6514953e08583999f0d0d29f23cf3ba1", "message": "Followup from PR comments.\n- CamelCase globalsequence -> globalSequence\n- 0x80000 -> 0x10000\n- Factor out computation to header file and use in both test and globalSequence feature.", "committedDate": "2020-06-30T11:37:27Z", "type": "commit"}]}