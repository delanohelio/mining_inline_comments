{"pr_number": 11792, "pr_title": "Fail deployment if the wrong web service port is configured", "pr_createdAt": "2020-01-15T11:19:03Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/11792", "timeline": [{"oid": "dc71d1f9878ec9b32a5432409a2a1f3beadab289", "url": "https://github.com/vespa-engine/vespa/commit/dc71d1f9878ec9b32a5432409a2a1f3beadab289", "message": "Fail deployment if the wrong web service port is configured\n\nThis will cause the application to become unavailable\nso it is not sufficient to emit a warning.", "committedDate": "2020-01-15T11:16:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjgzNzM0Ng==", "url": "https://github.com/vespa-engine/vespa/pull/11792#discussion_r366837346", "bodyText": "Remove this import", "author": "bjorncs", "createdAt": "2020-01-15T11:56:46Z", "path": "config-model/src/main/java/com/yahoo/vespa/model/container/http/xml/HttpBuilder.java", "diffHunk": "@@ -20,6 +20,7 @@\n import com.yahoo.vespa.model.container.http.Binding;\n import org.w3c.dom.Element;\n \n+import javax.management.loading.MLetMBean;", "originalCommit": "dc71d1f9878ec9b32a5432409a2a1f3beadab289", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njg0MzUxNQ==", "url": "https://github.com/vespa-engine/vespa/pull/11792#discussion_r366843515", "bodyText": "Done - thanks", "author": "bratseth", "createdAt": "2020-01-15T12:13:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjgzNzM0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjgzODg3MQ==", "url": "https://github.com/vespa-engine/vespa/pull/11792#discussion_r366838871", "bodyText": "Consider using ExpectedException.", "author": "bjorncs", "createdAt": "2020-01-15T12:00:53Z", "path": "config-model/src/test/java/com/yahoo/config/model/provision/ModelProvisioningTest.java", "diffHunk": "@@ -1313,6 +1314,28 @@ public void testThatStandaloneSyntaxWorksOnHostedVespa() {\n         assertEquals(1, model.getContainerClusters().size());\n     }\n \n+    @Test\n+    public void testThatStandaloneSyntaxOnHostedVespaRequiresDefaultPort() {\n+        try {\n+            String services =\n+                    \"<?xml version='1.0' encoding='utf-8' ?>\" +\n+                    \"<container id='foo' version='1.0'>\" +\n+                    \"  <http>\" +\n+                    \"    <server id='server1' port='8095' />\" +\n+                    \"  </http>\" +\n+                    \"</container>\";\n+            VespaModelTester tester = new VespaModelTester();\n+            tester.addHosts(1);\n+            VespaModel model = tester.createModel(services, true);\n+            fail(\"Expected exception\");\n+        }\n+        catch (IllegalArgumentException e) {\n+            // Success\n+            assertEquals(\"Illegal port 8095 in http server 'server1': Port must be set to \" +", "originalCommit": "dc71d1f9878ec9b32a5432409a2a1f3beadab289", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjgzOTgzNA==", "url": "https://github.com/vespa-engine/vespa/pull/11792#discussion_r366839834", "bodyText": "Consider using ExpectedException.", "author": "bjorncs", "createdAt": "2020-01-15T12:03:17Z", "path": "config-model/src/test/java/com/yahoo/vespa/model/container/xml/ContainerModelBuilderTest.java", "diffHunk": "@@ -133,29 +134,35 @@ public void http_server_port_is_configurable_and_does_not_affect_other_ports() {\n     }\n \n     @Test\n-    public void fail_if_http_port_is_not_4080_in_hosted_vespa() throws Exception {\n-        String servicesXml =\n-                \"<services>\" +\n-                \"<admin version='3.0'>\" +\n-                \"    <nodes count='1'/>\" +\n-                \"</admin>\" +\n-                \"<container version='1.0'>\" +\n-                \"  <http>\" +\n-                \"    <server port='9000' id='foo' />\" +\n-                \"  </http>\" +\n-                nodesXml +\n-                \"</container>\" +\n-                \"</services>\";\n-        ApplicationPackage applicationPackage = new MockApplicationPackage.Builder().withServices(servicesXml).build();\n-        // Need to create VespaModel to make deploy properties have effect\n-        final TestLogger logger = new TestLogger();\n-        new VespaModel(new NullConfigModelRegistry(), new DeployState.Builder()\n-                .applicationPackage(applicationPackage)\n-                .deployLogger(logger)\n-                .properties(new TestProperties().setHostedVespa(true))\n-                .build());\n-        assertFalse(logger.msgs.isEmpty());\n-        assertThat(logger.msgs.get(0).getSecond(), containsString(String.format(\"You cannot set port to anything else than %d\", Container.BASEPORT)));\n+    public void fail_if_http_port_is_not_default_in_hosted_vespa() throws Exception {\n+        try {\n+            String servicesXml =\n+                    \"<services>\" +\n+                    \"<admin version='3.0'>\" +\n+                    \"    <nodes count='1'/>\" +\n+                    \"</admin>\" +\n+                    \"<container version='1.0'>\" +\n+                    \"  <http>\" +\n+                    \"    <server port='9000' id='foo' />\" +\n+                    \"  </http>\" +\n+                    nodesXml +\n+                    \"</container>\" +\n+                    \"</services>\";\n+            ApplicationPackage applicationPackage = new MockApplicationPackage.Builder().withServices(servicesXml).build();\n+            // Need to create VespaModel to make deploy properties have effect\n+            TestLogger logger = new TestLogger();\n+            new VespaModel(new NullConfigModelRegistry(), new DeployState.Builder()\n+                                                                  .applicationPackage(applicationPackage)\n+                                                                  .deployLogger(logger)\n+                                                                  .properties(new TestProperties().setHostedVespa(true))\n+                                                                  .build());\n+            fail(\"Expected exception\");\n+        }\n+        catch (IllegalArgumentException e) {\n+            // Success\n+            assertEquals(\"Illegal port 9000 in http server 'foo': Port must be set to \" + Defaults.getDefaults().vespaWebServicePort(),", "originalCommit": "dc71d1f9878ec9b32a5432409a2a1f3beadab289", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njg0MDk2NQ==", "url": "https://github.com/vespa-engine/vespa/pull/11792#discussion_r366840965", "bodyText": "Consider removing \"hosted Vespa\" from test name as this test does not use a hosted specific model.", "author": "bjorncs", "createdAt": "2020-01-15T12:06:15Z", "path": "config-model/src/test/java/com/yahoo/config/model/provision/ModelProvisioningTest.java", "diffHunk": "@@ -1313,6 +1314,28 @@ public void testThatStandaloneSyntaxWorksOnHostedVespa() {\n         assertEquals(1, model.getContainerClusters().size());\n     }\n \n+    @Test\n+    public void testThatStandaloneSyntaxOnHostedVespaRequiresDefaultPort() {", "originalCommit": "dc71d1f9878ec9b32a5432409a2a1f3beadab289", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njg0Mzk5MQ==", "url": "https://github.com/vespa-engine/vespa/pull/11792#discussion_r366843991", "bodyText": "True, but it is evaluated in an environment set up as hosted Vespa (otherwise the test would fail).", "author": "bratseth", "createdAt": "2020-01-15T12:14:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njg0MDk2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njg0NTIyMw==", "url": "https://github.com/vespa-engine/vespa/pull/11792#discussion_r366845223", "bodyText": "Nvm, I did not know that VespaModelTester defaults to creating a hosted specific model.", "author": "bjorncs", "createdAt": "2020-01-15T12:17:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njg0MDk2NQ=="}], "type": "inlineReview"}, {"oid": "241fd2b9a7573e0e11a9b1508d05a95a2a976859", "url": "https://github.com/vespa-engine/vespa/commit/241fd2b9a7573e0e11a9b1508d05a95a2a976859", "message": "Remove unused imports", "committedDate": "2020-01-15T12:10:04Z", "type": "commit"}, {"oid": "f666777e6494961cfc1aa36fd25f434874644b21", "url": "https://github.com/vespa-engine/vespa/commit/f666777e6494961cfc1aa36fd25f434874644b21", "message": "Merge with master", "committedDate": "2020-01-15T12:56:25Z", "type": "commit"}, {"oid": "566bd79f9881461dfccc24e41bffa317640da75c", "url": "https://github.com/vespa-engine/vespa/commit/566bd79f9881461dfccc24e41bffa317640da75c", "message": "Allow omitting server port to get default", "committedDate": "2020-01-15T13:34:45Z", "type": "commit"}]}