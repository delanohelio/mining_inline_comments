{"pr_number": 11684, "pr_title": "Jvenstad/instances with separate change", "pr_createdAt": "2020-01-07T14:28:38Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/11684", "timeline": [{"oid": "95efcfd4d165b064c7c60284ded1df7d481c6132", "url": "https://github.com/vespa-engine/vespa/commit/95efcfd4d165b064c7c60284ded1df7d481c6132", "message": "Store change per instance", "committedDate": "2020-01-07T14:28:23Z", "type": "commit"}, {"oid": "b2d9b9b58d16c618b47b2932ef1fc85b89c8ce51", "url": "https://github.com/vespa-engine/vespa/commit/b2d9b9b58d16c618b47b2932ef1fc85b89c8ce51", "message": "Compute outstanding change, instead of keeping it in sync", "committedDate": "2020-01-07T14:28:23Z", "type": "commit"}, {"oid": "f69ea8459763217ec20301a3e484cc3bfa7e9f42", "url": "https://github.com/vespa-engine/vespa/commit/f69ea8459763217ec20301a3e484cc3bfa7e9f42", "message": "Clarify and simplify little bits", "committedDate": "2020-01-07T14:28:23Z", "type": "commit"}, {"oid": "b5aaff70bd4ebdd5b659550b055a41e517378c5b", "url": "https://github.com/vespa-engine/vespa/commit/b5aaff70bd4ebdd5b659550b055a41e517378c5b", "message": "Avoid throwing around Versions when checking job completeness", "committedDate": "2020-01-07T14:28:23Z", "type": "commit"}, {"oid": "52df4364530a1dac305ff7da1c785a0e8988b707", "url": "https://github.com/vespa-engine/vespa/commit/52df4364530a1dac305ff7da1c785a0e8988b707", "message": "Move changes to instances", "committedDate": "2020-01-07T14:28:23Z", "type": "commit"}, {"oid": "d8b60f3e7632081872df156d4edb1066554fdcc9", "url": "https://github.com/vespa-engine/vespa/commit/d8b60f3e7632081872df156d4edb1066554fdcc9", "message": "Allow OCD to propagate revisions to instances failing upgrades", "committedDate": "2020-01-07T14:28:23Z", "type": "commit"}, {"oid": "c4afaa3099d5b460f4f8421e3a1cd1bd483d960a", "url": "https://github.com/vespa-engine/vespa/commit/c4afaa3099d5b460f4f8421e3a1cd1bd483d960a", "message": "Update HTTP API handlers and responses", "committedDate": "2020-01-07T14:28:23Z", "type": "commit"}, {"oid": "a5e66672922229e03f8ceed15134434bfa159d74", "url": "https://github.com/vespa-engine/vespa/commit/a5e66672922229e03f8ceed15134434bfa159d74", "message": "Expand complicated deployment spec test", "committedDate": "2020-01-07T15:32:42Z", "type": "commit"}, {"oid": "eea19dc015312134140456efe49280a0900c558e", "url": "https://github.com/vespa-engine/vespa/commit/eea19dc015312134140456efe49280a0900c558e", "message": "Expand test with a third, dependent instance", "committedDate": "2020-01-08T08:09:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDE2MTEyMg==", "url": "https://github.com/vespa-engine/vespa/pull/11684#discussion_r364161122", "bodyText": "Change to \"the instance's current change\"?", "author": "mpolden", "createdAt": "2020-01-08T10:27:05Z", "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/deployment/DeploymentStatus.java", "diffHunk": "@@ -90,34 +90,42 @@ public DeploymentStatus(Application application, Map<JobId, JobStatus> allJobs,\n         this.allSteps = List.copyOf(allSteps);\n     }\n \n+    /** The application this deployment status concerns. */\n     public Application application() {\n         return application;\n     }\n \n+    /** A filterable list of the status of all jobs for this application. */\n     public JobList jobs() {\n         return allJobs;\n     }\n \n+    /** Whether any jobs of this application are failing with other errors than lack of capacity in a test zone. */\n     public boolean hasFailures() {\n         return ! allJobs.failing()\n                         .not().withStatus(RunStatus.outOfCapacity)\n                         .isEmpty();\n     }\n \n+    /** All job statuses, by job type, for the given instance. */\n     public Map<JobType, JobStatus> instanceJobs(InstanceName instance) {\n         return allJobs.asList().stream()\n                       .filter(job -> job.id().application().equals(application.id().instance(instance)))\n                       .collect(Collectors.toUnmodifiableMap(job -> job.id().type(),\n                                                          job -> job));\n     }\n \n+    /** Filterable job status lists for each instance of this application. */\n     public Map<ApplicationId, JobList> instanceJobs() {\n         return allJobs.asList().stream()\n                       .collect(groupingBy(job -> job.id().application(),\n                                           collectingAndThen(toUnmodifiableList(), JobList::from)));\n     }\n \n-    /** Returns the set of jobs that need to run for the application's current change to be considered complete. */\n+    /**\n+     * The set of jobs that need to run for the application's current change to be considered complete,", "originalCommit": "f69ea8459763217ec20301a3e484cc3bfa7e9f42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDIxODIwOQ==", "url": "https://github.com/vespa-engine/vespa/pull/11684#discussion_r364218209", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * The set of jobs that need to run for the application's current change to be considered complete,\n          \n          \n            \n                 * The set of jobs that need to run for the changes of each instance of the application to be considered complete,", "author": "jonmv", "createdAt": "2020-01-08T13:00:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDE2MTEyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDIxODM2Mg==", "url": "https://github.com/vespa-engine/vespa/pull/11684#discussion_r364218362", "bodyText": "Yeah, I should probably look over the javadoc.", "author": "jonmv", "createdAt": "2020-01-08T13:00:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDE2MTEyMg=="}], "type": "inlineReview"}, {"oid": "f64861a8767c8d9d3f82c98d6a01579fcaae335e", "url": "https://github.com/vespa-engine/vespa/commit/f64861a8767c8d9d3f82c98d6a01579fcaae335e", "message": "Update javadoc", "committedDate": "2020-01-08T13:00:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDI1Nzk3MA==", "url": "https://github.com/vespa-engine/vespa/pull/11684#discussion_r364257970", "bodyText": "Ah, this should prefer production instances.", "author": "jonmv", "createdAt": "2020-01-08T14:29:16Z", "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/restapi/application/ApplicationApiHandler.java", "diffHunk": "@@ -699,24 +699,27 @@ private void toSlime(Cursor object, Application application, HttpRequest request\n                                                  \"/job/\",\n                                                  request.getUri()).toString());\n \n+        DeploymentStatus status = controller.jobController().deploymentStatus(application);\n         application.latestVersion().ifPresent(version -> toSlime(version, object.setObject(\"latestVersion\")));\n \n         application.projectId().ifPresent(id -> object.setLong(\"projectId\", id));\n \n-        // Currently deploying change\n-        if ( ! application.change().isEmpty())\n-            toSlime(object.setObject(\"deploying\"), application.change());\n+        // TODO jonmv: Remove this when users are updated.\n+        application.instances().values().stream().findFirst().ifPresent(instance -> {", "originalCommit": "f64861a8767c8d9d3f82c98d6a01579fcaae335e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDI4MTA2OQ==", "url": "https://github.com/vespa-engine/vespa/pull/11684#discussion_r364281069", "bodyText": "Well, I don\u2019t think it\u2019s used for anyrhing now.9", "author": "jonmv", "createdAt": "2020-01-08T15:12:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDI1Nzk3MA=="}], "type": "inlineReview"}]}