{"pr_number": 12323, "pr_title": "add set_node for unit testing", "pr_createdAt": "2020-02-24T14:22:38Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/12323", "timeline": [{"oid": "f1c838e6bb894e7a26203f99aa4c274bb4170baa", "url": "https://github.com/vespa-engine/vespa/commit/f1c838e6bb894e7a26203f99aa4c274bb4170baa", "message": "add set_node for unit testing", "committedDate": "2020-02-24T14:19:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzMyNjY1MQ==", "url": "https://github.com/vespa-engine/vespa/pull/12323#discussion_r383326651", "bodyText": "Also consider checking that doc 5 is connected to {1,2} on level 0 and {4} on level 1.", "author": "geirst", "createdAt": "2020-02-24T15:19:27Z", "path": "searchlib/src/tests/tensor/hnsw_index/hnsw_index_test.cpp", "diffHunk": "@@ -266,5 +266,33 @@ TEST_F(HnswIndexTest, 2d_vectors_inserted_in_hierarchic_graph_with_heuristic_sel\n     expect_level_0(7, {3, 6});\n }\n \n+TEST_F(HnswIndexTest, manual_insert)\n+{\n+    init(false);\n+\n+    std::vector<uint32_t> nbl;\n+    HnswNode empty{nbl};\n+    index->set_node(1, empty);\n+    index->set_node(2, empty);\n+\n+    HnswNode three{{1,2}};\n+    index->set_node(3, three);\n+    expect_level_0(1, {3});\n+    expect_level_0(2, {3});\n+    expect_level_0(3, {1,2});\n+\n+    expect_entry_point(1, 0);\n+\n+    HnswNode twolevels{{{1},nbl}};\n+    index->set_node(4, twolevels);\n+\n+    expect_entry_point(4, 1);\n+    expect_level_0(1, {3,4});\n+\n+    HnswNode five{{{1,2}, {4}}};\n+    index->set_node(5, five);\n+    expect_levels(4, {{1}, {5}});", "originalCommit": "f1c838e6bb894e7a26203f99aa4c274bb4170baa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzMyNjk3OA==", "url": "https://github.com/vespa-engine/vespa/pull/12323#discussion_r383326978", "bodyText": "Even though this is just used for unit testing, consider passing HnswNode as const reference.", "author": "geirst", "createdAt": "2020-02-24T15:20:01Z", "path": "searchlib/src/vespa/searchlib/tensor/hnsw_index.h", "diffHunk": "@@ -145,8 +145,7 @@ class HnswIndex : public NearestNeighborIndex {\n \n     // Should only be used by unit tests.\n     HnswNode get_node(uint32_t docid) const;\n-\n-    // TODO: Implement set_node() as well for use in unit tests.\n+    void set_node(uint32_t docid, HnswNode node);", "originalCommit": "f1c838e6bb894e7a26203f99aa4c274bb4170baa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "30fda84e5f61507fb857cf3fbf5af0ad9db69268", "url": "https://github.com/vespa-engine/vespa/commit/30fda84e5f61507fb857cf3fbf5af0ad9db69268", "message": "minor fixes after review", "committedDate": "2020-02-25T08:20:19Z", "type": "commit"}]}