{"pr_number": 15087, "pr_title": "Jonmv/reindexing data stores", "pr_createdAt": "2020-10-29T11:30:26Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/15087", "timeline": [{"oid": "41a7f812d0393194c89ade76a30f406f80a7f18f", "url": "https://github.com/vespa-engine/vespa/commit/41a7f812d0393194c89ade76a30f406f80a7f18f", "message": "Split out method to get the config generation of all services of an application", "committedDate": "2020-10-29T11:12:13Z", "type": "commit"}, {"oid": "d41673879f667dc06ea326fe14ad8f6520ff981b", "url": "https://github.com/vespa-engine/vespa/commit/d41673879f667dc06ea326fe14ad8f6520ff981b", "message": "Add data store for reindexing data", "committedDate": "2020-10-29T14:47:53Z", "type": "commit"}, {"oid": "d41673879f667dc06ea326fe14ad8f6520ff981b", "url": "https://github.com/vespa-engine/vespa/commit/d41673879f667dc06ea326fe14ad8f6520ff981b", "message": "Add data store for reindexing data", "committedDate": "2020-10-29T14:47:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTgwNjczNg==", "url": "https://github.com/vespa-engine/vespa/pull/15087#discussion_r515806736", "bodyText": "Consider renaming to getServiceConfigGenerationsResponse", "author": "bjorncs", "createdAt": "2020-11-02T08:28:31Z", "path": "configserver/src/main/java/com/yahoo/vespa/config/server/application/ConfigConvergenceChecker.java", "diffHunk": "@@ -70,26 +70,30 @@ public ConfigConvergenceChecker(StateApiFactory stateApiFactory) {\n         this.stateApiFactory = stateApiFactory;\n     }\n \n-    /** Check all services in given application. Returns the minimum current generation of all services */\n-    public ServiceListResponse servicesToCheck(Application application, URI requestUrl, Duration timeoutPerService) {\n-        log.log(Level.FINE, () -> \"Finding services to check config convergence for in '\" + application);\n+    /** Fetches the active config generation for all services in the given application. */\n+    public Map<ServiceInfo, Long> getServiceConfigGenerations(Application application, Duration timeoutPerService) {\n         List<ServiceInfo> servicesToCheck = new ArrayList<>();\n         application.getModel().getHosts()\n                    .forEach(host -> host.getServices().stream()\n                                         .filter(service -> serviceTypesToCheck.contains(service.getServiceType()))\n                                         .forEach(service -> getStatePort(service).ifPresent(port -> servicesToCheck.add(service))));\n \n-        Map<ServiceInfo, Long> currentGenerations = getServiceGenerations(servicesToCheck, timeoutPerService);\n+        return getServiceGenerations(servicesToCheck, timeoutPerService);\n+    }\n+\n+    /** Check all services in given application. Returns the minimum current generation of all services */\n+    public ServiceListResponse getServiceConfigGenerationsJson(Application application, URI requestUrl, Duration timeoutPerService) {", "originalCommit": "41a7f812d0393194c89ade76a30f406f80a7f18f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTgwOTY1Mg==", "url": "https://github.com/vespa-engine/vespa/pull/15087#discussion_r515809652", "bodyText": "What is the reason for not copying the second parameter?", "author": "bjorncs", "createdAt": "2020-11-02T08:34:28Z", "path": "configserver/src/main/java/com/yahoo/vespa/config/server/application/ReindexingStatus.java", "diffHunk": "@@ -0,0 +1,132 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.vespa.config.server.application;\n+\n+import com.yahoo.config.model.api.Reindexing;\n+\n+import java.time.Instant;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Stream;\n+\n+import static java.util.stream.Collectors.toUnmodifiableMap;\n+\n+/**\n+ * Pending and ready reindexing per document type. Each document type can have either a pending or a ready reindexing.\n+ * This is immutable.\n+ *\n+ * @author jonmv\n+ */\n+public class ReindexingStatus implements Reindexing {\n+\n+    private static final ReindexingStatus empty = new ReindexingStatus(Map.of(), Map.of());\n+\n+    private final Map<String, Long> pending;\n+    private final Map<String, Status> ready;\n+\n+    ReindexingStatus(Map<String, Long> pending, Map<String, Status> ready) {\n+        this.pending = Map.copyOf(pending);\n+        this.ready = ready;", "originalCommit": "d41673879f667dc06ea326fe14ad8f6520ff981b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTgxNDM0Ng==", "url": "https://github.com/vespa-engine/vespa/pull/15087#discussion_r515814346", "bodyText": "Silly author, most likely >_<", "author": "jonmv", "createdAt": "2020-11-02T08:43:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTgwOTY1Mg=="}], "type": "inlineReview"}, {"oid": "fe43131104ac22158a65c6e6c040e23a76d16101", "url": "https://github.com/vespa-engine/vespa/commit/fe43131104ac22158a65c6e6c040e23a76d16101", "message": "Rename method and defensively copy in constructor", "committedDate": "2020-11-02T08:45:39Z", "type": "commit"}]}