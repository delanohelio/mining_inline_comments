{"pr_number": 12813, "pr_title": "Bypass communicationmanager Q", "pr_createdAt": "2020-04-02T18:14:47Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/12813", "timeline": [{"oid": "a2c8ad475de58e6686e484610488bc4adae30273", "url": "https://github.com/vespa-engine/vespa/commit/a2c8ad475de58e6686e484610488bc4adae30273", "message": "Bypass communicationmanager Q", "committedDate": "2020-04-02T18:13:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjkzNDk4MQ==", "url": "https://github.com/vespa-engine/vespa/pull/12813#discussion_r402934981", "bodyText": "Were these assertions removed because they were triggering or because it was desired to observe explicit log errors during testing?", "author": "vekterli", "createdAt": "2020-04-03T11:17:20Z", "path": "storage/src/vespa/storage/common/storagelink.cpp", "diffHunk": "@@ -165,9 +165,9 @@ void StorageLink::sendUp(const shared_ptr<StorageMessage> & msg)\n         default:\n             LOG(error, \"Link %s trying to send %s up while in state %s\",\n                 toString().c_str(), msg->toString(true).c_str(), stateToString(getState()));\n-            assert(false);\n+            return;", "originalCommit": "a2c8ad475de58e6686e484610488bc4adae30273", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk4MDgzMw==", "url": "https://github.com/vespa-engine/vespa/pull/12813#discussion_r402980833", "bodyText": "There was one test that tested enque/deque ordering that triggered this. It posted N tasks BEFORE doing open(), and then checking that they were received in same order as posted.\nWith a queue it would wait in the queue until open was called. That would now trigger the assert as it is open once constructed. So I concluded the assert could just be removed.", "author": "baldersheim", "createdAt": "2020-04-03T12:48:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjkzNDk4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk2MzM3MQ==", "url": "https://github.com/vespa-engine/vespa/pull/12813#discussion_r402963371", "bodyText": "We should probably rename CommunicationManager::enqueue in due time as well \ud83d\ude42", "author": "vekterli", "createdAt": "2020-04-03T12:17:23Z", "path": "storage/src/vespa/storage/storageserver/communicationmanager.cpp", "diffHunk": "@@ -492,8 +489,8 @@ void\n CommunicationManager::enqueue(std::shared_ptr<api::StorageMessage> msg)\n {\n     assert(msg);\n-    LOG(spam, \"Enq storage message %s, priority %d\", msg->toString().c_str(), msg->getPriority());\n-    _eventQueue.enqueue(std::move(msg));\n+    LOG(spam, \"Process storage message %s, priority %d\", msg->toString().c_str(), msg->getPriority());\n+    process(msg);", "originalCommit": "a2c8ad475de58e6686e484610488bc4adae30273", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk4MTA2NQ==", "url": "https://github.com/vespa-engine/vespa/pull/12813#discussion_r402981065", "bodyText": "Yes and some other  stuff could go away too.", "author": "baldersheim", "createdAt": "2020-04-03T12:49:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk2MzM3MQ=="}], "type": "inlineReview"}]}