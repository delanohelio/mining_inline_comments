{"pr_number": 12599, "pr_title": "use label marker for distance and closeness features", "pr_createdAt": "2020-03-17T14:29:06Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/12599", "timeline": [{"oid": "ff852cdd5e391417a84b52b0aa45219c4a185d7b", "url": "https://github.com/vespa-engine/vespa/commit/ff852cdd5e391417a84b52b0aa45219c4a185d7b", "message": "use label marker for distance and closeness features\n\n* distance feature now has a two arguments version, allowing\n  the user to explicitly specify label or field\n* extend closeness feature the same ways as distance feature\n* add unit test for NNS closeness", "committedDate": "2020-03-17T13:27:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDMwOTMxNA==", "url": "https://github.com/vespa-engine/vespa/pull/12599#discussion_r394309314", "bodyText": "Labels, NoLabels and SingleLabel are now duplicated in 3 unit tests. Please move them to searchlib/src/vespa/searchlib/fef/test and put them in namespace search::fef::test.", "author": "geirst", "createdAt": "2020-03-18T12:28:52Z", "path": "searchlib/src/tests/features/nns_closeness/nns_closeness_test.cpp", "diffHunk": "@@ -0,0 +1,177 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#include <vespa/vespalib/testkit/test_kit.h>\n+#include <vespa/searchlib/features/setup.h>\n+#include <vespa/searchlib/fef/test/indexenvironment.h>\n+#include <vespa/searchlib/fef/test/indexenvironmentbuilder.h>\n+#include <vespa/searchlib/fef/test/queryenvironment.h>\n+#include <vespa/searchlib/features/closenessfeature.h>\n+#include <vespa/searchlib/fef/fef.h>\n+#include <vespa/searchlib/fef/test/dummy_dependency_handler.h>\n+#include <vespa/vespalib/stllike/asciistream.h>\n+#include <vespa/vespalib/util/stringfmt.h>\n+\n+using search::feature_t;\n+using namespace search::fef;\n+using namespace search::fef::test;\n+using namespace search::features;\n+using CollectionType = FieldInfo::CollectionType;\n+using DataType = FieldInfo::DataType;\n+\n+const vespalib::string labelFeatureName(\"closeness(label,nns)\");\n+const vespalib::string fieldFeatureName(\"closeness(bar)\");\n+\n+struct BlueprintFactoryFixture {\n+    BlueprintFactory factory;\n+    BlueprintFactoryFixture() : factory()\n+    {\n+        setup_search_features(factory);\n+    }\n+};\n+\n+struct IndexFixture {\n+    IndexEnvironment indexEnv;\n+    IndexFixture() : indexEnv()\n+    {\n+        IndexEnvironmentBuilder builder(indexEnv);\n+        builder.addField(FieldType::ATTRIBUTE, CollectionType::SINGLE, DataType::INT64, \"foo\");\n+        builder.addField(FieldType::ATTRIBUTE, CollectionType::SINGLE, DataType::TENSOR, \"bar\");\n+    }\n+};\n+\n+struct FeatureDumpFixture : public IDumpFeatureVisitor {\n+    virtual void visitDumpFeature(const vespalib::string &) override {\n+        TEST_ERROR(\"no features should be dumped\");\n+    }\n+    FeatureDumpFixture() : IDumpFeatureVisitor() {}\n+};\n+\n+struct Labels {", "originalCommit": "ff852cdd5e391417a84b52b0aa45219c4a185d7b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDMyNjY1OQ==", "url": "https://github.com/vespa-engine/vespa/pull/12599#discussion_r394326659", "bodyText": "Labels etc. moved to fef::test now.", "author": "arnej27959", "createdAt": "2020-03-18T12:59:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDMwOTMxNA=="}], "type": "inlineReview"}, {"oid": "61b09ca3ef94afef2f7ef59c78178b6514a3e80b", "url": "https://github.com/vespa-engine/vespa/commit/61b09ca3ef94afef2f7ef59c78178b6514a3e80b", "message": "refactor common test code to reduce duplication", "committedDate": "2020-03-18T12:52:29Z", "type": "commit"}]}