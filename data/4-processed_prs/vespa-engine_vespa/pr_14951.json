{"pr_number": 14951, "pr_title": "Split the persistence thread and the message handler.", "pr_createdAt": "2020-10-19T12:45:21Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/14951", "timeline": [{"oid": "7dff0a9879800c9da8643d1f5c7d4f39fc910467", "url": "https://github.com/vespa-engine/vespa/commit/7dff0a9879800c9da8643d1f5c7d4f39fc910467", "message": "Split the persistence thread and the message handler.\n- Let FileStorManager own and control the Component and PersistenceHandler\n  separately from the Persistence thread.\n- Let FileStorManager allocate and control stripe assignment.", "committedDate": "2020-10-19T11:49:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc4MTM5Nw==", "url": "https://github.com/vespa-engine/vespa/pull/14951#discussion_r507781397", "bodyText": "The setup code per test function is very similar, and we could bundle it together in a helper class. Something to consider for upcoming work.", "author": "geirst", "createdAt": "2020-10-19T14:11:34Z", "path": "storage/src/tests/persistence/filestorage/filestormanagertest.cpp", "diffHunk": "@@ -721,12 +714,14 @@ TEST_F(FileStorManagerTest, priority) {\n     FileStorHandlerImpl filestorHandler(messageSender, metrics, _node->getComponentRegister());\n     ServiceLayerComponent component(_node->getComponentRegister(), \"test\");\n     BucketOwnershipNotifier bucketOwnershipNotifier(component, messageSender);\n-    std::unique_ptr<DiskThread> thread(createThread(\n-            *config, *_node, _node->getPersistenceProvider(),\n-            filestorHandler, bucketOwnershipNotifier, *metrics.disks[0]->threads[0]));\n-    std::unique_ptr<DiskThread> thread2(createThread(\n-            *config, *_node, _node->getPersistenceProvider(),\n-            filestorHandler, bucketOwnershipNotifier, *metrics.disks[0]->threads[1]));\n+    vespa::config::content::StorFilestorConfig cfg;", "originalCommit": "7dff0a9879800c9da8643d1f5c7d4f39fc910467", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgzODc2NQ==", "url": "https://github.com/vespa-engine/vespa/pull/14951#discussion_r507838765", "bodyText": "I have noticed the same, will do on next encounter.", "author": "baldersheim", "createdAt": "2020-10-19T15:19:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc4MTM5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc4NjAzOQ==", "url": "https://github.com/vespa-engine/vespa/pull/14951#discussion_r507786039", "bodyText": "Please update copyright.", "author": "geirst", "createdAt": "2020-10-19T14:17:14Z", "path": "storage/src/vespa/storage/persistence/persistencehandler.cpp", "diffHunk": "@@ -0,0 +1,162 @@\n+// Copyright 2017 Yahoo Holdings. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.", "originalCommit": "7dff0a9879800c9da8643d1f5c7d4f39fc910467", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgzOTgxOQ==", "url": "https://github.com/vespa-engine/vespa/pull/14951#discussion_r507839819", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-10-19T15:21:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc4NjAzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc4NjE5Ng==", "url": "https://github.com/vespa-engine/vespa/pull/14951#discussion_r507786196", "bodyText": "Please update log target.", "author": "geirst", "createdAt": "2020-10-19T14:17:24Z", "path": "storage/src/vespa/storage/persistence/persistencehandler.cpp", "diffHunk": "@@ -0,0 +1,162 @@\n+// Copyright 2017 Yahoo Holdings. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#include \"persistencehandler.h\"\n+\n+#include <vespa/storage/common/bucketoperationlogger.h>\n+#include <vespa/document/fieldset/fieldsetrepo.h>\n+#include <vespa/document/base/exceptions.h>\n+#include <vespa/vespalib/util/exceptions.h>\n+#include <vespa/vespalib/util/isequencedtaskexecutor.h>\n+#include <thread>\n+\n+#include <vespa/log/log.h>\n+LOG_SETUP(\".persistence.thread\");", "originalCommit": "7dff0a9879800c9da8643d1f5c7d4f39fc910467", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg0MDY2Mg==", "url": "https://github.com/vespa-engine/vespa/pull/14951#discussion_r507840662", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-10-19T15:22:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc4NjE5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc4NjgzMA==", "url": "https://github.com/vespa-engine/vespa/pull/14951#discussion_r507786830", "bodyText": "Please update message.", "author": "geirst", "createdAt": "2020-10-19T14:18:09Z", "path": "storage/src/vespa/storage/persistence/persistencehandler.cpp", "diffHunk": "@@ -0,0 +1,162 @@\n+// Copyright 2017 Yahoo Holdings. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#include \"persistencehandler.h\"\n+\n+#include <vespa/storage/common/bucketoperationlogger.h>\n+#include <vespa/document/fieldset/fieldsetrepo.h>\n+#include <vespa/document/base/exceptions.h>\n+#include <vespa/vespalib/util/exceptions.h>\n+#include <vespa/vespalib/util/isequencedtaskexecutor.h>\n+#include <thread>\n+\n+#include <vespa/log/log.h>\n+LOG_SETUP(\".persistence.thread\");\n+\n+using vespalib::make_string_short::fmt;\n+using to_str = vespalib::string;\n+\n+namespace storage {\n+\n+PersistenceHandler::PersistenceHandler(vespalib::ISequencedTaskExecutor & sequencedExecutor,\n+                                     ServiceLayerComponent & component,\n+                                     const vespa::config::content::StorFilestorConfig & cfg,\n+                                     spi::PersistenceProvider& provider,\n+                                     FileStorHandler& filestorHandler,\n+                                     BucketOwnershipNotifier & bucketOwnershipNotifier,\n+                                     FileStorThreadMetrics& metrics)\n+    :\n+      _env(component, filestorHandler, metrics, provider),\n+      _spi(provider),\n+      _processAllHandler(_env, provider),\n+      _mergeHandler(_env, _spi, cfg.bucketMergeChunkSize,\n+                    cfg.enableMergeLocalNodeChooseDocsOptimalization,\n+                    cfg.commonMergeChainOptimalizationMinimumSize),\n+      _asyncHandler(_env, _spi, sequencedExecutor),\n+      _splitJoinHandler(_env, provider, bucketOwnershipNotifier, cfg.enableMultibitSplitOptimalization),\n+      _simpleHandler(_env, provider)\n+{\n+}\n+\n+PersistenceHandler::~PersistenceHandler() = default;\n+\n+MessageTracker::UP\n+PersistenceHandler::handleCommandSplitByType(api::StorageCommand& msg, MessageTracker::UP tracker) const\n+{\n+    switch (msg.getType().getId()) {\n+    case api::MessageType::GET_ID:\n+        return _simpleHandler.handleGet(static_cast<api::GetCommand&>(msg), std::move(tracker));\n+    case api::MessageType::PUT_ID:\n+        return _asyncHandler.handlePut(static_cast<api::PutCommand&>(msg), std::move(tracker));\n+    case api::MessageType::REMOVE_ID:\n+        return _asyncHandler.handleRemove(static_cast<api::RemoveCommand&>(msg), std::move(tracker));\n+    case api::MessageType::UPDATE_ID:\n+        return _asyncHandler.handleUpdate(static_cast<api::UpdateCommand&>(msg), std::move(tracker));\n+    case api::MessageType::REVERT_ID:\n+        return _simpleHandler.handleRevert(static_cast<api::RevertCommand&>(msg), std::move(tracker));\n+    case api::MessageType::CREATEBUCKET_ID:\n+        return _simpleHandler.handleCreateBucket(static_cast<api::CreateBucketCommand&>(msg), std::move(tracker));\n+    case api::MessageType::DELETEBUCKET_ID:\n+        return _simpleHandler.handleDeleteBucket(static_cast<api::DeleteBucketCommand&>(msg), std::move(tracker));\n+    case api::MessageType::JOINBUCKETS_ID:\n+        return _splitJoinHandler.handleJoinBuckets(static_cast<api::JoinBucketsCommand&>(msg), std::move(tracker));\n+    case api::MessageType::SPLITBUCKET_ID:\n+        return _splitJoinHandler.handleSplitBucket(static_cast<api::SplitBucketCommand&>(msg), std::move(tracker));\n+       // Depends on iterators\n+    case api::MessageType::STATBUCKET_ID:\n+        return _processAllHandler.handleStatBucket(static_cast<api::StatBucketCommand&>(msg), std::move(tracker));\n+    case api::MessageType::REMOVELOCATION_ID:\n+        return _processAllHandler.handleRemoveLocation(static_cast<api::RemoveLocationCommand&>(msg), std::move(tracker));\n+    case api::MessageType::MERGEBUCKET_ID:\n+        return _mergeHandler.handleMergeBucket(static_cast<api::MergeBucketCommand&>(msg), std::move(tracker));\n+    case api::MessageType::GETBUCKETDIFF_ID:\n+        return _mergeHandler.handleGetBucketDiff(static_cast<api::GetBucketDiffCommand&>(msg), std::move(tracker));\n+    case api::MessageType::APPLYBUCKETDIFF_ID:\n+        return _mergeHandler.handleApplyBucketDiff(static_cast<api::ApplyBucketDiffCommand&>(msg), std::move(tracker));\n+    case api::MessageType::SETBUCKETSTATE_ID:\n+        return _splitJoinHandler.handleSetBucketState(static_cast<api::SetBucketStateCommand&>(msg), std::move(tracker));\n+    case api::MessageType::INTERNAL_ID:\n+        switch(static_cast<api::InternalCommand&>(msg).getType()) {\n+        case GetIterCommand::ID:\n+            return _simpleHandler.handleGetIter(static_cast<GetIterCommand&>(msg), std::move(tracker));\n+        case CreateIteratorCommand::ID:\n+            return _simpleHandler.handleCreateIterator(static_cast<CreateIteratorCommand&>(msg), std::move(tracker));\n+        case ReadBucketList::ID:\n+            return _simpleHandler.handleReadBucketList(static_cast<ReadBucketList&>(msg), std::move(tracker));\n+        case ReadBucketInfo::ID:\n+            return _simpleHandler.handleReadBucketInfo(static_cast<ReadBucketInfo&>(msg), std::move(tracker));\n+        case InternalBucketJoinCommand::ID:\n+            return _splitJoinHandler.handleInternalBucketJoin(static_cast<InternalBucketJoinCommand&>(msg), std::move(tracker));\n+        case RecheckBucketInfoCommand::ID:\n+            return _splitJoinHandler.handleRecheckBucketInfo(static_cast<RecheckBucketInfoCommand&>(msg), std::move(tracker));\n+        default:\n+            LOG(warning, \"Persistence thread received unhandled internal command %s\", msg.toString().c_str());", "originalCommit": "7dff0a9879800c9da8643d1f5c7d4f39fc910467", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg0Mjc5NQ==", "url": "https://github.com/vespa-engine/vespa/pull/14951#discussion_r507842795", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-10-19T15:25:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc4NjgzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc4NzMxMA==", "url": "https://github.com/vespa-engine/vespa/pull/14951#discussion_r507787310", "bodyText": "Please update copyright.", "author": "geirst", "createdAt": "2020-10-19T14:18:45Z", "path": "storage/src/vespa/storage/persistence/persistencehandler.h", "diffHunk": "@@ -0,0 +1,50 @@\n+// Copyright 2017 Yahoo Holdings. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.", "originalCommit": "7dff0a9879800c9da8643d1f5c7d4f39fc910467", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg0Mjk1OA==", "url": "https://github.com/vespa-engine/vespa/pull/14951#discussion_r507842958", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-10-19T15:25:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc4NzMxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc4NzQ1Mg==", "url": "https://github.com/vespa-engine/vespa/pull/14951#discussion_r507787452", "bodyText": "Consider adding class comment.", "author": "geirst", "createdAt": "2020-10-19T14:18:57Z", "path": "storage/src/vespa/storage/persistence/persistencehandler.h", "diffHunk": "@@ -0,0 +1,50 @@\n+// Copyright 2017 Yahoo Holdings. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#pragma once\n+\n+#include \"processallhandler.h\"\n+#include \"mergehandler.h\"\n+#include \"asynchandler.h\"\n+#include \"persistenceutil.h\"\n+#include \"provider_error_wrapper.h\"\n+#include \"splitjoinhandler.h\"\n+#include \"simplemessagehandler.h\"\n+#include <vespa/storage/common/storagecomponent.h>\n+#include <vespa/vespalib/util/isequencedtaskexecutor.h>\n+#include <vespa/config-stor-filestor.h>\n+\n+namespace storage {\n+\n+class BucketOwnershipNotifier;\n+\n+class PersistenceHandler : public Types", "originalCommit": "7dff0a9879800c9da8643d1f5c7d4f39fc910467", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg2MjM3MA==", "url": "https://github.com/vespa-engine/vespa/pull/14951#discussion_r507862370", "bodyText": "Done", "author": "baldersheim", "createdAt": "2020-10-19T15:49:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc4NzQ1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc5NjE0MA==", "url": "https://github.com/vespa-engine/vespa/pull/14951#discussion_r507796140", "bodyText": "Since this used to be an inner loop, consider renaming j to i to better mesh with naming expectations", "author": "vekterli", "createdAt": "2020-10-19T14:28:57Z", "path": "storage/src/vespa/storage/persistence/filestorage/filestormanager.cpp", "diffHunk": "@@ -133,8 +140,14 @@ FileStorManager::configure(std::unique_ptr<vespa::config::content::StorFilestorC\n         assert(_sequencedExecutor);\n         LOG(spam, \"Setting up the disk\");\n         for (uint32_t j = 0; j < numThreads; j++) {\n-            _threads.push_back(std::make_shared<PersistenceThread>(*_sequencedExecutor, _compReg, *_config, *_provider,\n-                                                                   *_filestorHandler, *_bucketOwnershipNotifier, *_metrics->disks[0]->threads[j]));\n+            _persistenceComponents.push_back(std::make_unique<ServiceLayerComponent>(_compReg, createThreadName(j)));\n+            _persistenceHandlers.push_back(\n+                    std::make_unique<PersistenceHandler>(*_sequencedExecutor,\n+                                                         *_persistenceComponents.back(),\n+                                                         *_config, *_provider, *_filestorHandler,\n+                                                         *_bucketOwnershipNotifier, *_metrics->disks[0]->threads[j]));\n+            _threads.push_back(std::make_unique<PersistenceThread>(*_persistenceHandlers.back(), *_filestorHandler,\n+                                                                   j % numStripes, _component));", "originalCommit": "7dff0a9879800c9da8643d1f5c7d4f39fc910467", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg2Mzc1MQ==", "url": "https://github.com/vespa-engine/vespa/pull/14951#discussion_r507863751", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-10-19T15:51:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc5NjE0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgwMDcwOA==", "url": "https://github.com/vespa-engine/vespa/pull/14951#discussion_r507800708", "bodyText": "Nit: indentation is off", "author": "vekterli", "createdAt": "2020-10-19T14:32:35Z", "path": "storage/src/vespa/storage/persistence/persistencehandler.cpp", "diffHunk": "@@ -0,0 +1,162 @@\n+// Copyright 2017 Yahoo Holdings. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#include \"persistencehandler.h\"\n+\n+#include <vespa/storage/common/bucketoperationlogger.h>\n+#include <vespa/document/fieldset/fieldsetrepo.h>\n+#include <vespa/document/base/exceptions.h>\n+#include <vespa/vespalib/util/exceptions.h>\n+#include <vespa/vespalib/util/isequencedtaskexecutor.h>\n+#include <thread>\n+\n+#include <vespa/log/log.h>\n+LOG_SETUP(\".persistence.thread\");\n+\n+using vespalib::make_string_short::fmt;\n+using to_str = vespalib::string;\n+\n+namespace storage {\n+\n+PersistenceHandler::PersistenceHandler(vespalib::ISequencedTaskExecutor & sequencedExecutor,\n+                                     ServiceLayerComponent & component,", "originalCommit": "7dff0a9879800c9da8643d1f5c7d4f39fc910467", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg2NDU0NA==", "url": "https://github.com/vespa-engine/vespa/pull/14951#discussion_r507864544", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-10-19T15:52:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgwMDcwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgzNzM2MA==", "url": "https://github.com/vespa-engine/vespa/pull/14951#discussion_r507837360", "bodyText": "Nit: indentation off by one", "author": "vekterli", "createdAt": "2020-10-19T15:17:49Z", "path": "storage/src/vespa/storage/persistence/persistencehandler.h", "diffHunk": "@@ -0,0 +1,50 @@\n+// Copyright 2017 Yahoo Holdings. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#pragma once\n+\n+#include \"processallhandler.h\"\n+#include \"mergehandler.h\"\n+#include \"asynchandler.h\"\n+#include \"persistenceutil.h\"\n+#include \"provider_error_wrapper.h\"\n+#include \"splitjoinhandler.h\"\n+#include \"simplemessagehandler.h\"\n+#include <vespa/storage/common/storagecomponent.h>\n+#include <vespa/vespalib/util/isequencedtaskexecutor.h>\n+#include <vespa/config-stor-filestor.h>\n+\n+namespace storage {\n+\n+class BucketOwnershipNotifier;\n+\n+class PersistenceHandler : public Types\n+{\n+public:\n+    PersistenceHandler(vespalib::ISequencedTaskExecutor &, ServiceLayerComponent & component,\n+                      const vespa::config::content::StorFilestorConfig &, spi::PersistenceProvider &,", "originalCommit": "7dff0a9879800c9da8643d1f5c7d4f39fc910467", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg2NDY2NA==", "url": "https://github.com/vespa-engine/vespa/pull/14951#discussion_r507864664", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-10-19T15:52:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzgzNzM2MA=="}], "type": "inlineReview"}, {"oid": "229b5b3d08ead5d2b8f022341bd26feb2d692329", "url": "https://github.com/vespa-engine/vespa/commit/229b5b3d08ead5d2b8f022341bd26feb2d692329", "message": "- Add class comments.\n- Reduce code visibility.\n- Clean up some unused members.\n- Some code unification.", "committedDate": "2020-10-19T15:57:43Z", "type": "commit"}]}