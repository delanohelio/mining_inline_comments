{"pr_number": 12348, "pr_title": "Arnej/shrink if needed", "pr_createdAt": "2020-02-26T12:17:11Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/12348", "timeline": [{"oid": "b3eff781ae386d2f169dcde363ecf1f94e1397cd", "url": "https://github.com/vespa-engine/vespa/commit/b3eff781ae386d2f169dcde363ecf1f94e1397cd", "message": "shrink links if needed\n\n* select \"M\" links on all layers\n* change unit test parameters to avoid triggering shrink early\n* add symmetry validation method for use from unit test", "committedDate": "2020-02-26T11:33:31Z", "type": "commit"}, {"oid": "be8f9cc5c7bc8555e766b95b1e0c4cc6a0bb12b1", "url": "https://github.com/vespa-engine/vespa/commit/be8f9cc5c7bc8555e766b95b1e0c4cc6a0bb12b1", "message": "rename config variable", "committedDate": "2020-02-26T11:33:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU3Njk4NQ==", "url": "https://github.com/vespa-engine/vespa/pull/12348#discussion_r384576985", "bodyText": "Shouldn't we still differentiate between max links for level 0 and hierarchical levels?", "author": "geirst", "createdAt": "2020-02-26T15:42:06Z", "path": "searchlib/src/vespa/searchlib/tensor/hnsw_index.cpp", "diffHunk": "@@ -287,8 +325,8 @@ HnswIndex::add_document(uint32_t docid)\n     while (search_level >= 0) {\n         // TODO: Rename to search_level?\n         search_layer(input, _cfg.neighbors_to_explore_at_construction(), best_neighbors, search_level);\n-        auto neighbors = select_neighbors(best_neighbors.peek(), max_links_for_level(search_level));\n-        connect_new_node(docid, neighbors, search_level);\n+        auto neighbors = select_neighbors(best_neighbors.peek(), _cfg.max_links_at_hierarchic_levels());", "originalCommit": "b3eff781ae386d2f169dcde363ecf1f94e1397cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDk4MTczMA==", "url": "https://github.com/vespa-engine/vespa/pull/12348#discussion_r384981730", "bodyText": "yes and no; we're supposed to select (up to ) M neighbors on all layers when inserting, but the \"Mmax\" used when shrinking is differentiatied (Mmax = M while Mmax0 = 2 * M)", "author": "arnej27959", "createdAt": "2020-02-27T08:43:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU3Njk4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDk5MDMyMw==", "url": "https://github.com/vespa-engine/vespa/pull/12348#discussion_r384990323", "bodyText": "Ok, I see", "author": "geirst", "createdAt": "2020-02-27T09:02:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU3Njk4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU3OTEwNw==", "url": "https://github.com/vespa-engine/vespa/pull/12348#discussion_r384579107", "bodyText": "I guess we can remove the TODO on the next line?", "author": "geirst", "createdAt": "2020-02-26T15:45:04Z", "path": "searchlib/src/vespa/searchlib/tensor/hnsw_index.cpp", "diffHunk": "@@ -287,8 +325,8 @@ HnswIndex::add_document(uint32_t docid)\n     while (search_level >= 0) {\n         // TODO: Rename to search_level?\n         search_layer(input, _cfg.neighbors_to_explore_at_construction(), best_neighbors, search_level);\n-        auto neighbors = select_neighbors(best_neighbors.peek(), max_links_for_level(search_level));\n-        connect_new_node(docid, neighbors, search_level);\n+        auto neighbors = select_neighbors(best_neighbors.peek(), _cfg.max_links_at_hierarchic_levels());\n+        connect_new_node(docid, neighbors.used, search_level);", "originalCommit": "b3eff781ae386d2f169dcde363ecf1f94e1397cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDk4MTgxMw==", "url": "https://github.com/vespa-engine/vespa/pull/12348#discussion_r384981813", "bodyText": "right!", "author": "arnej27959", "createdAt": "2020-02-27T08:44:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU3OTEwNw=="}], "type": "inlineReview"}, {"oid": "f5743cf8b49901bb5c46216044110b20f2f82469", "url": "https://github.com/vespa-engine/vespa/commit/f5743cf8b49901bb5c46216044110b20f2f82469", "message": "remove outdated TODO", "committedDate": "2020-02-27T09:31:14Z", "type": "commit"}]}