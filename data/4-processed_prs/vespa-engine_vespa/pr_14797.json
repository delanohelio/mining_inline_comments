{"pr_number": 14797, "pr_title": "pack FastSparseMap::Key tighter", "pr_createdAt": "2020-10-09T06:39:14Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/14797", "timeline": [{"oid": "a75f0cf67b5b0ddedd36ab34595c2711f9ab9ec7", "url": "https://github.com/vespa-engine/vespa/commit/a75f0cf67b5b0ddedd36ab34595c2711f9ab9ec7", "message": "pack FastSparseMap::Key tighter", "committedDate": "2020-10-09T06:37:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjIyMzkwMw==", "url": "https://github.com/vespa-engine/vespa/pull/14797#discussion_r502223903", "bodyText": "an alternative is to not pass start and redefine the make_addr function instead to get an address from a subspace directly. That would trade a divide with a multiply for the iterate case and we would save the multiply for the time we actually need the address.", "author": "havardpe", "createdAt": "2020-10-09T06:54:11Z", "path": "eval/src/vespa/eval/eval/fast_sparse_map.h", "diffHunk": "@@ -148,7 +147,7 @@ class FastSparseMap\n     void each_map_entry(F &&f) const {\n         _map.for_each([&](const auto &entry)\n                       {\n-                          f(entry.first.start, entry.second, entry.first.hash);\n+                          f(entry.second * _num_dims, entry.second, entry.first.hash);", "originalCommit": "a75f0cf67b5b0ddedd36ab34595c2711f9ab9ec7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjIyNDMyNw==", "url": "https://github.com/vespa-engine/vespa/pull/14797#discussion_r502224327", "bodyText": "if we pack, I think we should also use align 4", "author": "havardpe", "createdAt": "2020-10-09T06:55:14Z", "path": "eval/src/vespa/eval/eval/fast_sparse_map.h", "diffHunk": "@@ -62,12 +62,11 @@ class FastSparseMap\n     }\n \n     struct Key {\n-        uint32_t start;\n         uint64_t hash;\n-        Key() : start(0), hash(0) {}\n-        Key(uint32_t start_in, uint64_t hash_in)\n-            : start(start_in), hash(hash_in) {}\n-    };\n+        Key() : hash(0) {}\n+        Key(uint64_t hash_in)\n+            : hash(hash_in) {}\n+    } __attribute__((packed));", "originalCommit": "a75f0cf67b5b0ddedd36ab34595c2711f9ab9ec7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "80476c1d456ba294755725778fa03701d85e21c7", "url": "https://github.com/vespa-engine/vespa/commit/80476c1d456ba294755725778fa03701d85e21c7", "message": "change to subspace index for make_addr also\n\n* and add alignment attribute", "committedDate": "2020-10-09T08:00:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQwNzEzMg==", "url": "https://github.com/vespa-engine/vespa/pull/14797#discussion_r502407132", "bodyText": "I am not sure if attributes are order sensitive, but we should switch them just to be safe.", "author": "havardpe", "createdAt": "2020-10-09T12:55:14Z", "path": "eval/src/vespa/eval/eval/fast_sparse_map.h", "diffHunk": "@@ -66,7 +66,7 @@ class FastSparseMap\n         Key() : hash(0) {}\n         Key(uint64_t hash_in)\n             : hash(hash_in) {}\n-    } __attribute__((packed));\n+    } __attribute__((aligned(4),packed));", "originalCommit": "80476c1d456ba294755725778fa03701d85e21c7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8219326fa9dfd2693617b049523c2b5d291492ac", "url": "https://github.com/vespa-engine/vespa/commit/8219326fa9dfd2693617b049523c2b5d291492ac", "message": "switch order of attributes", "committedDate": "2020-10-09T13:04:32Z", "type": "commit"}]}