{"pr_number": 12711, "pr_title": "Add control over mbus params", "pr_createdAt": "2020-03-25T14:50:07Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/12711", "timeline": [{"oid": "5ba4494cacab2dda7e037aecd18bf9055033094d", "url": "https://github.com/vespa-engine/vespa/commit/5ba4494cacab2dda7e037aecd18bf9055033094d", "message": "Add control over\n - num network threads\n - num connections per target\n - tcpnodelay\nDefaults are unchanged.", "committedDate": "2020-03-25T14:31:21Z", "type": "commit"}, {"oid": "a4f448633278360f7cb8ef2135f68291cb021a9f", "url": "https://github.com/vespa-engine/vespa/commit/a4f448633278360f7cb8ef2135f68291cb021a9f", "message": "Use auto and captitalize first word in sentence.", "committedDate": "2020-03-25T14:53:32Z", "type": "commit"}, {"oid": "020c88692058131e4009125e00ff5ca2400a2f31", "url": "https://github.com/vespa-engine/vespa/commit/020c88692058131e4009125e00ff5ca2400a2f31", "message": "Add config control over tcpnodelay for c++ too.", "committedDate": "2020-03-25T15:20:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkxOTU4OQ==", "url": "https://github.com/vespa-engine/vespa/pull/12711#discussion_r397919589", "bodyText": "Personal opinion: calling this \"optimize_for\" or similar would be more descriptive than just \"optimization\" (also applies to C++ config)", "author": "vekterli", "createdAt": "2020-03-25T14:55:29Z", "path": "container-messagebus/src/main/resources/configdefinitions/container-mbus.def", "diffHunk": "@@ -2,9 +2,24 @@\n namespace=container.jdisc\n \n #settings for message bus in container\n-enabled bool default=false\n+\n+# Which network port is used\n port int default=0\n+\n+# Number of connections per target\n+numconnectionspertarget int default=1\n+\n+# Number network threads\n+numthreads int default=2\n+\n+# Optimize for latency, or throughput.\n+optimization enum {LATENCY, THROUGHPUT} default=LATENCY", "originalCommit": "5ba4494cacab2dda7e037aecd18bf9055033094d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODIxMDY0Nw==", "url": "https://github.com/vespa-engine/vespa/pull/12711#discussion_r398210647", "bodyText": "So be it, that was one of my options.", "author": "baldersheim", "createdAt": "2020-03-25T22:31:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkxOTU4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkyODMxMQ==", "url": "https://github.com/vespa-engine/vespa/pull/12711#discussion_r397928311", "bodyText": "Do we have any numbers that indicate disabling TCP_NODELAY is worth it? We unconditionally enabled nodelay for everything to get rid  of spurious latency spikes incurred by the in-kernel deferred packet sending.", "author": "vekterli", "createdAt": "2020-03-25T15:06:26Z", "path": "jrt/src/com/yahoo/jrt/Connection.java", "diffHunk": "@@ -89,21 +90,23 @@ private void setState(int state) {\n     }\n \n     public Connection(TransportThread parent, Supervisor owner,\n-                      SocketChannel channel) {\n+                      SocketChannel channel, boolean tcpNoDelay) {\n \n         this.parent = parent;\n         this.owner = owner;\n         this.socket = parent.transport().createServerCryptoSocket(channel);\n         this.spec = null;\n+        this.tcpNoDelay = tcpNoDelay;\n         server = true;\n         owner.sessionInit(this);\n     }\n \n-    public Connection(TransportThread parent, Supervisor owner, Spec spec, Object context) {\n+    public Connection(TransportThread parent, Supervisor owner, Spec spec, Object context, boolean tcpNoDelay) {\n         super(context);\n         this.parent = parent;\n         this.owner = owner;\n         this.spec = spec;\n+        this.tcpNoDelay = tcpNoDelay;", "originalCommit": "5ba4494cacab2dda7e037aecd18bf9055033094d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk3NDA4OA==", "url": "https://github.com/vespa-engine/vespa/pull/12711#discussion_r397974088", "bodyText": "I saw significantly lower system cpu when hardcoding it yesterday.\nHowever I did a lot of different tests then, and I am not putting more into it than it is a dimension that should be tested further. And for that to happen I need config control over it.", "author": "baldersheim", "createdAt": "2020-03-25T16:03:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkyODMxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk1NzUwNQ==", "url": "https://github.com/vespa-engine/vespa/pull/12711#discussion_r397957505", "bodyText": "Consider wrapping in a shouldEnableNoDelay(params) method or similar to make semantics more obvious", "author": "vekterli", "createdAt": "2020-03-25T15:42:44Z", "path": "messagebus/src/main/java/com/yahoo/messagebus/network/rpc/RPCNetwork.java", "diffHunk": "@@ -82,7 +82,7 @@ private static int getNumThreads() {\n     public RPCNetwork(RPCNetworkParams params, SlobrokConfigSubscriber slobrokConfig) {\n         this.slobroksConfig = slobrokConfig;\n         identity = params.getIdentity();\n-        orb = new Supervisor(new Transport(2));\n+        orb = new Supervisor(new Transport(params.getNumNetworkThreads(), params.getOptimization() == RPCNetworkParams.Optimization.LATENCY));", "originalCommit": "020c88692058131e4009125e00ff5ca2400a2f31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE2MzU2OQ==", "url": "https://github.com/vespa-engine/vespa/pull/12711#discussion_r398163569", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-03-25T20:55:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk1NzUwNQ=="}], "type": "inlineReview"}, {"oid": "3cd7be25c87fca3e558c6c793fb7279762a4a7d7", "url": "https://github.com/vespa-engine/vespa/commit/3cd7be25c87fca3e558c6c793fb7279762a4a7d7", "message": "Use a well named helper method for readability.", "committedDate": "2020-03-25T20:54:27Z", "type": "commit"}, {"oid": "36dd79a4ebb70096c1a596d84f7e06e2fc88d4e4", "url": "https://github.com/vespa-engine/vespa/commit/36dd79a4ebb70096c1a596d84f7e06e2fc88d4e4", "message": "optimization => optimize_for", "committedDate": "2020-03-25T22:30:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk0NzgwMw==", "url": "https://github.com/vespa-engine/vespa/pull/12711#discussion_r397947803", "bodyText": "this feels a bit generic\nIf it only controls tcp_nodelay, we can just be more specific. If we add more code alternatives choosing between latency and throughput later we might not be able to test their effects separately, or they need more configuration than a single flag.", "author": "havardpe", "createdAt": "2020-03-25T15:30:46Z", "path": "container-messagebus/src/main/resources/configdefinitions/container-mbus.def", "diffHunk": "@@ -2,9 +2,24 @@\n namespace=container.jdisc\n \n #settings for message bus in container\n-enabled bool default=false\n+\n+# Which network port is used\n port int default=0\n+\n+# Number of connections per target\n+numconnectionspertarget int default=1\n+\n+# Number network threads\n+numthreads int default=2\n+\n+# Optimize for latency, or throughput.\n+optimization enum {LATENCY, THROUGHPUT} default=LATENCY", "originalCommit": "a4f448633278360f7cb8ef2135f68291cb021a9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQxODQ0NQ==", "url": "https://github.com/vespa-engine/vespa/pull/12711#discussion_r398418445", "bodyText": "this feels a bit generic\nIf it only controls tcp_nodelay, we can just be more specific. If we add more code alternatives choosing between latency and throughput later we might not be able to test their effects separately, or they need more configuration than a single flag.", "author": "havardpe", "createdAt": "2020-03-26T09:15:01Z", "path": "container-messagebus/src/main/resources/configdefinitions/container-mbus.def", "diffHunk": "@@ -2,9 +2,24 @@\n namespace=container.jdisc\n \n #settings for message bus in container\n-enabled bool default=false\n+\n+# Which network port is used\n port int default=0\n+\n+# Number of connections per target\n+numconnectionspertarget int default=1\n+\n+# Number network threads\n+numthreads int default=2\n+\n+# Optimize for latency, or throughput.\n+optimize_for enum {LATENCY, THROUGHPUT} default=LATENCY", "originalCommit": "36dd79a4ebb70096c1a596d84f7e06e2fc88d4e4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ1ODg2Ng==", "url": "https://github.com/vespa-engine/vespa/pull/12711#discussion_r398458866", "bodyText": "I do not want to expose too much details. We should figure out a set that works for all.", "author": "baldersheim", "createdAt": "2020-03-26T10:18:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQxODQ0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQyMDYyOQ==", "url": "https://github.com/vespa-engine/vespa/pull/12711#discussion_r398420629", "bodyText": "this feels a bit generic\nIf it only controls tcp_nodelay, we can just be more specific. If we add more code alternatives choosing between latency and throughput later we might not be able to test their effects separately, or they need more configuration than a single flag.", "author": "havardpe", "createdAt": "2020-03-26T09:18:26Z", "path": "storage/src/vespa/storage/config/stor-communicationmanager.def", "diffHunk": "@@ -33,6 +33,8 @@ mbus.rpctargetcache.ttl double default = 600\n ## Any value below 1 will be 1.\n mbus.num_threads int default=4\n \n+mbus.optimize_for enum {LATENCY, THROUGHPUT} default = LATENCY", "originalCommit": "36dd79a4ebb70096c1a596d84f7e06e2fc88d4e4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ1OTIwNw==", "url": "https://github.com/vespa-engine/vespa/pull/12711#discussion_r398459207", "bodyText": "I do not want to expose too much details. We should figure out a set that works for all.", "author": "baldersheim", "createdAt": "2020-03-26T10:18:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQyMDYyOQ=="}], "type": "inlineReview"}]}