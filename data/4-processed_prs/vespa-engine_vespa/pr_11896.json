{"pr_number": 11896, "pr_title": "Add reservedTo field to Node", "pr_createdAt": "2020-01-22T15:23:56Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/11896", "timeline": [{"oid": "aa9cd997630d306f67138240db0c2ace1cf81c84", "url": "https://github.com/vespa-engine/vespa/commit/aa9cd997630d306f67138240db0c2ace1cf81c84", "message": "Add reservedTo field to Node", "committedDate": "2020-01-22T15:11:14Z", "type": "commit"}, {"oid": "0b9f810ca24dc09c4a1677a525abd878eed896ab", "url": "https://github.com/vespa-engine/vespa/commit/0b9f810ca24dc09c4a1677a525abd878eed896ab", "message": "Surfacet reservedTo in nodes/v2 and test", "committedDate": "2020-01-22T15:50:31Z", "type": "commit"}, {"oid": "995e6883f191574ba3f386c49271950fc5e5a50a", "url": "https://github.com/vespa-engine/vespa/commit/995e6883f191574ba3f386c49271950fc5e5a50a", "message": "Don't allocate on hosts reserved to someone else", "committedDate": "2020-01-22T16:02:14Z", "type": "commit"}, {"oid": "97c2dd0fb54bd2aed689e5b8b432588cc4fb6401", "url": "https://github.com/vespa-engine/vespa/commit/97c2dd0fb54bd2aed689e5b8b432588cc4fb6401", "message": "Prefer using reserved hosts", "committedDate": "2020-01-22T16:35:42Z", "type": "commit"}, {"oid": "85c9eb688804ebf00a3593c04086d4eb9354225d", "url": "https://github.com/vespa-engine/vespa/commit/85c9eb688804ebf00a3593c04086d4eb9354225d", "message": "Unreserve hosts with allocations", "committedDate": "2020-01-22T22:47:44Z", "type": "commit"}, {"oid": "71d558135d4a3bc8e6c9b2d556ae7862acd44bb4", "url": "https://github.com/vespa-engine/vespa/commit/71d558135d4a3bc8e6c9b2d556ae7862acd44bb4", "message": "Test reservation of hosts to tenants", "committedDate": "2020-01-22T23:45:43Z", "type": "commit"}, {"oid": "a7a253d824ebb8d096395de4e57f381cf4b92f47", "url": "https://github.com/vespa-engine/vespa/commit/a7a253d824ebb8d096395de4e57f381cf4b92f47", "message": "Cleanup test", "committedDate": "2020-01-22T23:46:43Z", "type": "commit"}, {"oid": "eaf1e0870d990092e9b5b1a1a157d8bac046c48b", "url": "https://github.com/vespa-engine/vespa/commit/eaf1e0870d990092e9b5b1a1a157d8bac046c48b", "message": "Remove temporary short-circuit", "committedDate": "2020-01-23T07:23:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk3MTA0MQ==", "url": "https://github.com/vespa-engine/vespa/pull/11896#discussion_r369971041", "bodyText": "Unintended change?", "author": "freva", "createdAt": "2020-01-23T07:53:23Z", "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/Node.java", "diffHunk": "@@ -41,61 +42,57 @@\n     private final NodeType type;\n     private final Reports reports;\n     private final Optional<String> modelName;\n+    private final Optional<TenantName> reservedTo;\n \n     /** Record of the last event of each type happening to this node */\n     private final History history;\n \n     /** The current allocation of this node, if any */\n     private final Optional<Allocation> allocation;\n+    private Node retire;", "originalCommit": "eaf1e0870d990092e9b5b1a1a157d8bac046c48b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk5MjM2Mg==", "url": "https://github.com/vespa-engine/vespa/pull/11896#discussion_r369992362", "bodyText": "Yes, thanks!", "author": "bratseth", "createdAt": "2020-01-23T08:51:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk3MTA0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk3MzUzMw==", "url": "https://github.com/vespa-engine/vespa/pull/11896#discussion_r369973533", "bodyText": "The convention is this class seems to be to have a withReservedTo(TenantName) and withoutReservedTo()", "author": "freva", "createdAt": "2020-01-23T08:00:54Z", "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/Node.java", "diffHunk": "@@ -265,26 +273,32 @@ public Node allocate(ApplicationId owner, ClusterMembership membership, NodeReso\n      */\n     public Node with(Allocation allocation) {\n         return new Node(id, ipConfig, hostname, parentHostname, flavor, status, state,\n-                        Optional.of(allocation), history, type, reports, modelName);\n+                        Optional.of(allocation), history, type, reports, modelName, reservedTo);\n     }\n \n     /** Returns a new Node without an allocation. */\n     public Node withoutAllocation() {\n         return new Node(id, ipConfig, hostname, parentHostname, flavor, status, state,\n-                        Optional.empty(), history, type, reports, modelName);\n+                        Optional.empty(), history, type, reports, modelName, reservedTo);\n     }\n \n \n     /** Returns a copy of this node with IP config set to the given value. */\n     public Node with(IP.Config ipConfig) {\n         return new Node(id, ipConfig, hostname, parentHostname, flavor, status, state,\n-                        allocation, history, type, reports, modelName);\n+                        allocation, history, type, reports, modelName, reservedTo);\n     }\n \n     /** Returns a copy of this node with the parent hostname assigned to the given value. */\n     public Node withParentHostname(String parentHostname) {\n         return new Node(id, ipConfig, hostname, Optional.of(parentHostname), flavor, status, state,\n-                        allocation, history, type, reports, modelName);\n+                        allocation, history, type, reports, modelName, reservedTo);\n+    }\n+\n+    /** Returns a copy of this node marked as reserved to the given tenant (or empty to remove reservation) */\n+    public Node withReservedTo(Optional<TenantName> reservedTo) {", "originalCommit": "eaf1e0870d990092e9b5b1a1a157d8bac046c48b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk5NDEyMw==", "url": "https://github.com/vespa-engine/vespa/pull/11896#discussion_r369994123", "bodyText": "Done", "author": "bratseth", "createdAt": "2020-01-23T08:55:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk3MzUzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk3NDkwNw==", "url": "https://github.com/vespa-engine/vespa/pull/11896#discussion_r369974907", "bodyText": "This should lock the tenant host application", "author": "freva", "createdAt": "2020-01-23T08:05:38Z", "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/provisioning/Activator.java", "diffHunk": "@@ -90,6 +89,27 @@ private void activateNodes(ApplicationId application, Collection<HostSpec> hosts\n         nodeRepository.deactivate(activeToRemove, transaction);\n         nodeRepository.activate(updateFrom(hosts, continuedActive), transaction); // update active with any changes\n         nodeRepository.activate(updatePortsFrom(hosts, reservedToActivate), transaction);\n+        unreserveParentsOf(reservedToActivate);\n+    }\n+\n+    /** When a tenant node is activated on a host, we can open up that host for use by others */\n+    private void unreserveParentsOf(List<Node> nodes) {\n+        List<String> reservedParents = nodes.stream()\n+                                            .filter(node -> node.parentHostname().isPresent())\n+                                            .map(node -> nodeRepository.getNode(node.parentHostname().get()))\n+                                            .filter(parent -> parent.isPresent())\n+                                            .filter(parent -> parent.get().reservedTo().isPresent())\n+                                            .map(parent -> parent.get().hostname())\n+                                            .collect(Collectors.toList());\n+        if (reservedParents.isEmpty()) return;\n+\n+        try (Mutex lock = nodeRepository.lockUnallocated()) {", "originalCommit": "eaf1e0870d990092e9b5b1a1a157d8bac046c48b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDAwOTY5Ng==", "url": "https://github.com/vespa-engine/vespa/pull/11896#discussion_r370009696", "bodyText": "That stuff has become pretty weird, and it doesn't seem that's how it is consistently done? Anyway; ok, done.", "author": "bratseth", "createdAt": "2020-01-23T09:29:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk3NDkwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk3NTczOA==", "url": "https://github.com/vespa-engine/vespa/pull/11896#discussion_r369975738", "bodyText": "Use appId in this class", "author": "freva", "createdAt": "2020-01-23T08:08:17Z", "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/provisioning/NodePrioritizer.java", "diffHunk": "@@ -122,12 +122,14 @@ void addSurplusNodes(List<Node> surplusNodes) {\n      *\n      * @param exclusively whether the ready docker nodes should only be added on hosts that\n      *                    already have nodes allocated to this tenant\n+     * @param application the application we are adding nodes for\n      */\n-    void addNewDockerNodes(boolean exclusively) {\n+    void addNewDockerNodes(boolean exclusively, ApplicationId application) {", "originalCommit": "eaf1e0870d990092e9b5b1a1a157d8bac046c48b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f981d6569d2d6a6ca311f82d1816e254489af477", "url": "https://github.com/vespa-engine/vespa/commit/f981d6569d2d6a6ca311f82d1816e254489af477", "message": "Remove spurious field", "committedDate": "2020-01-23T08:51:02Z", "type": "commit"}, {"oid": "73bd08b8810794337a6c86f8cc32a031b6583242", "url": "https://github.com/vespa-engine/vespa/commit/73bd08b8810794337a6c86f8cc32a031b6583242", "message": "Only allow clearing reservedTo", "committedDate": "2020-01-23T08:54:33Z", "type": "commit"}, {"oid": "137173a4d6e4914497d10b68a89699b685d6b776", "url": "https://github.com/vespa-engine/vespa/commit/137173a4d6e4914497d10b68a89699b685d6b776", "message": "Use class field", "committedDate": "2020-01-23T09:05:51Z", "type": "commit"}, {"oid": "cdba1da4e60182595cd19fcf5945f98bce72d99e", "url": "https://github.com/vespa-engine/vespa/commit/cdba1da4e60182595cd19fcf5945f98bce72d99e", "message": "Lock node-admin app", "committedDate": "2020-01-23T09:29:19Z", "type": "commit"}, {"oid": "d1f353405fc65e0fa31142a6ccd9f9e8825a1163", "url": "https://github.com/vespa-engine/vespa/commit/d1f353405fc65e0fa31142a6ccd9f9e8825a1163", "message": "Follow internal API change", "committedDate": "2020-01-23T09:40:10Z", "type": "commit"}]}