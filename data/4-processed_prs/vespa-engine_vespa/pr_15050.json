{"pr_number": 15050, "pr_title": "Support provisioning of shared hosts", "pr_createdAt": "2020-10-27T14:33:27Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/15050", "timeline": [{"oid": "6247627fcb1b8f2aa7d277d739f11703b488a503", "url": "https://github.com/vespa-engine/vespa/commit/6247627fcb1b8f2aa7d277d739f11703b488a503", "message": "Support provisioning of shared hosts\n\nAdds shared-host flag to enable and define resources of shared hosts.  This PR\nis a no-op until that flag is set, but there remains some integration with\nexclusiveTo (tbd in this PR or follow-up).", "committedDate": "2020-10-27T14:31:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgwMjMzNw==", "url": "https://github.com/vespa-engine/vespa/pull/15050#discussion_r512802337", "bodyText": "Use requestedNodes.isExclusive()?", "author": "freva", "createdAt": "2020-10-27T15:40:50Z", "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/provisioning/GroupPreparer.java", "diffHunk": "@@ -88,7 +88,7 @@ public GroupPreparer(NodeRepository nodeRepository,\n                             .map(deficit -> hostProvisioner.get().provisionHosts(nodeRepository.database().getProvisionIndexes(deficit.getCount()),\n                                                                                  deficit.getFlavor(),\n                                                                                  application,\n-                                                                                 osVersion))\n+                                                                                 osVersion, false))", "originalCommit": "6247627fcb1b8f2aa7d277d739f11703b488a503", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzMyMzcwNw==", "url": "https://github.com/vespa-engine/vespa/pull/15050#discussion_r513323707", "bodyText": "Done\nLet me do a few related changes (e.g. move to enum) in a follow-up PR", "author": "hakonhall", "createdAt": "2020-10-28T10:11:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgwMjMzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgwNjU1Nw==", "url": "https://github.com/vespa-engine/vespa/pull/15050#discussion_r512806557", "bodyText": "This can be removed now since this is 1:1 with presence of HostProvisioner and this maintainer is only created if it is set in NodeRepositoryMaintenance", "author": "freva", "createdAt": "2020-10-27T15:45:21Z", "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/maintenance/DynamicProvisioningMaintainer.java", "diffHunk": "@@ -113,18 +114,32 @@ private void convergeToCapacity(NodeList nodes) {\n \n \n     /**\n-     * Provision the nodes necessary to satisfy given capacity.\n+     * Provision hosts to ensure there is room to allocate spare nodes.\n      *\n-     * @return excess hosts that can safely be deprovisioned, if any\n+     * @param advertisedSpareCapacity the advertised resources of the spare nodes\n+     * @param nodes list of all nodes\n+     * @return excess hosts that can safely be deprovisioned: An excess host 1. contains no nodes allocated\n+     *         to an application, and assuming the spare nodes have been allocated, and 2. is not parked\n+     *         without wantToDeprovision (which means an operator is looking at the node).\n      */\n-    private List<Node> provision(List<NodeResources> capacity, NodeList nodes) {\n-        List<Node> existingHosts = availableHostsOf(nodes);\n-        if (nodeRepository().zone().getCloud().dynamicProvisioning()) {\n-            existingHosts = removableHostsOf(existingHosts, nodes);\n-        } else if (capacity.isEmpty()) {\n+    private List<Node> provision(List<NodeResources> advertisedSpareCapacity, NodeList nodes) {\n+        if (!nodeRepository().zone().getCloud().dynamicProvisioning()) {", "originalCommit": "6247627fcb1b8f2aa7d277d739f11703b488a503", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzMyMjUwOA==", "url": "https://github.com/vespa-engine/vespa/pull/15050#discussion_r513322508", "bodyText": "nice", "author": "hakonhall", "createdAt": "2020-10-28T10:09:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgwNjU1Nw=="}], "type": "inlineReview"}, {"oid": "0274f45fd9c0108d3c08a1b75b77737ae421eee5", "url": "https://github.com/vespa-engine/vespa/commit/0274f45fd9c0108d3c08a1b75b77737ae421eee5", "message": "Review fixes", "committedDate": "2020-10-28T10:18:47Z", "type": "commit"}]}