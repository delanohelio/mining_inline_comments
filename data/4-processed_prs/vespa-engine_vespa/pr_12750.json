{"pr_number": 12750, "pr_title": "Bratseth/autoscaling ranges 3", "pr_createdAt": "2020-03-28T13:31:01Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/12750", "timeline": [{"oid": "bcaf74cc7cddd26f315ea9c60ceb8a5f9b665168", "url": "https://github.com/vespa-engine/vespa/commit/bcaf74cc7cddd26f315ea9c60ceb8a5f9b665168", "message": "Maintain application min, max and target resources", "committedDate": "2020-03-27T11:57:10Z", "type": "commit"}, {"oid": "b18e2939b6632e7bf02cc12dea096dabecb9e754", "url": "https://github.com/vespa-engine/vespa/commit/b18e2939b6632e7bf02cc12dea096dabecb9e754", "message": "Activate autoscaling", "committedDate": "2020-03-27T14:02:03Z", "type": "commit"}, {"oid": "3124be24e2419dbd17ae448b4cd8203e22278fea", "url": "https://github.com/vespa-engine/vespa/commit/3124be24e2419dbd17ae448b4cd8203e22278fea", "message": "Respect node resource limits", "committedDate": "2020-03-28T12:32:18Z", "type": "commit"}, {"oid": "b59e13352d2f6c5c9a1f70a039e6e95bf7c246f4", "url": "https://github.com/vespa-engine/vespa/commit/b59e13352d2f6c5c9a1f70a039e6e95bf7c246f4", "message": "Prefer the best fulfilment over lowest cost", "committedDate": "2020-03-28T13:29:29Z", "type": "commit"}, {"oid": "8243b7a6c219e0bb28f15d112b02834a68977a89", "url": "https://github.com/vespa-engine/vespa/commit/8243b7a6c219e0bb28f15d112b02834a68977a89", "message": "Log in both cases, remove printlns", "committedDate": "2020-03-28T13:35:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY2NjQ5OA==", "url": "https://github.com/vespa-engine/vespa/pull/12750#discussion_r399666498", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                /** Returns the current resources of this cluster, if it'1s already depoyed and inside the requested limits */\n          \n          \n            \n                /** Returns the current resources of this cluster, if it's already deployed and inside the requested limits */", "author": "freva", "createdAt": "2020-03-28T14:08:51Z", "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/provisioning/NodeRepositoryProvisioner.java", "diffHunk": "@@ -138,6 +141,39 @@ public void remove(NestedTransaction transaction, ApplicationId application) {\n         loadBalancerProvisioner.ifPresent(lbProvisioner -> lbProvisioner.deactivate(application, transaction));\n     }\n \n+    /**\n+     * Returns the target cluster resources, a value between the min and max in the requested capacity,\n+     * and updates the application store with the received min and max,\n+     */\n+    private ClusterResources decideTargetResources(ApplicationId applicationId, ClusterSpec.Id clusterId, Capacity requested) {\n+        try (Mutex lock = nodeRepository.lock(applicationId)) {\n+            Application application = nodeRepository.applications().get(applicationId, true);\n+            application.setClusterLimits(clusterId, requested.minResources(), requested.maxResources(), lock);\n+            return application.cluster(clusterId).targetResources()\n+                    .orElse(currentResources(applicationId, clusterId, requested)\n+                    .orElse(requested.minResources()));\n+        }\n+    }\n+\n+    /** Returns the current resources of this cluster, if it'1s already depoyed and inside the requested limits */", "originalCommit": "bcaf74cc7cddd26f315ea9c60ceb8a5f9b665168", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY2NjY4Nw==", "url": "https://github.com/vespa-engine/vespa/pull/12750#discussion_r399666687", "bodyText": "Consider orElseGet to avoid having to do NodeRepostiory::getNodes every time.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                .orElse(currentResources(applicationId, clusterId, requested)\n          \n          \n            \n                                .orElseGet(() -> currentResources(applicationId, clusterId, requested)", "author": "freva", "createdAt": "2020-03-28T14:10:51Z", "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/provisioning/NodeRepositoryProvisioner.java", "diffHunk": "@@ -138,6 +141,39 @@ public void remove(NestedTransaction transaction, ApplicationId application) {\n         loadBalancerProvisioner.ifPresent(lbProvisioner -> lbProvisioner.deactivate(application, transaction));\n     }\n \n+    /**\n+     * Returns the target cluster resources, a value between the min and max in the requested capacity,\n+     * and updates the application store with the received min and max,\n+     */\n+    private ClusterResources decideTargetResources(ApplicationId applicationId, ClusterSpec.Id clusterId, Capacity requested) {\n+        try (Mutex lock = nodeRepository.lock(applicationId)) {\n+            Application application = nodeRepository.applications().get(applicationId, true);\n+            application.setClusterLimits(clusterId, requested.minResources(), requested.maxResources(), lock);\n+            return application.cluster(clusterId).targetResources()\n+                    .orElse(currentResources(applicationId, clusterId, requested)", "originalCommit": "bcaf74cc7cddd26f315ea9c60ceb8a5f9b665168", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY2OTI0NA==", "url": "https://github.com/vespa-engine/vespa/pull/12750#discussion_r399669244", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (closed) throw new IllegalStateException(this + \"is closed\");\n          \n          \n            \n                    if (closed) throw new IllegalStateException(this + \" is closed\");", "author": "freva", "createdAt": "2020-03-28T14:38:04Z", "path": "node-repository/src/main/java/com/yahoo/vespa/hosted/provision/maintenance/MaintenanceDeployment.java", "diffHunk": "@@ -52,6 +50,16 @@ public boolean isValid() {\n         return deployment.isPresent();\n     }\n \n+    /**\n+     * Returns the application lock held by this, or empty if it is not held.\n+     *\n+     * @throws IllegalStateException id this is called when closed\n+     */\n+    public Optional<Mutex> applicationLock() {\n+        if (closed) throw new IllegalStateException(this + \"is closed\");", "originalCommit": "b18e2939b6632e7bf02cc12dea096dabecb9e754", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a1e11e67da2f5f3df7da1248b58b6dc983c4d0b2", "url": "https://github.com/vespa-engine/vespa/commit/a1e11e67da2f5f3df7da1248b58b6dc983c4d0b2", "message": "Update node-repository/src/main/java/com/yahoo/vespa/hosted/provision/provisioning/NodeRepositoryProvisioner.java\n\nCo-Authored-By: Valerij Fredriksen <freva@users.noreply.github.com>", "committedDate": "2020-03-28T15:45:48Z", "type": "commit"}, {"oid": "12b4ab36a248541156f80e66a66c077811507379", "url": "https://github.com/vespa-engine/vespa/commit/12b4ab36a248541156f80e66a66c077811507379", "message": "Update node-repository/src/main/java/com/yahoo/vespa/hosted/provision/provisioning/NodeRepositoryProvisioner.java\n\nCo-Authored-By: Valerij Fredriksen <freva@users.noreply.github.com>", "committedDate": "2020-03-28T15:46:04Z", "type": "commit"}, {"oid": "0fc3a51689475497b609524459c01152a11ea443", "url": "https://github.com/vespa-engine/vespa/commit/0fc3a51689475497b609524459c01152a11ea443", "message": "Update node-repository/src/main/java/com/yahoo/vespa/hosted/provision/maintenance/MaintenanceDeployment.java\n\nCo-Authored-By: Valerij Fredriksen <freva@users.noreply.github.com>", "committedDate": "2020-03-28T15:46:16Z", "type": "commit"}]}