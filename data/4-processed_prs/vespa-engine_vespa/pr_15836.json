{"pr_number": 15836, "pr_title": "Arnej/storage cluster context", "pr_createdAt": "2020-12-16T12:11:27Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/15836", "timeline": [{"oid": "96e5785df8cf12590e6f80e1ad05a3680fbd98c9", "url": "https://github.com/vespa-engine/vespa/commit/96e5785df8cf12590e6f80e1ad05a3680fbd98c9", "message": "add ClusterContext API\n\n* instead of asking various components for clustername (as reference\n  to string) and then taking the pointer to it, add an API for getting\n  the pointer which has the correct contract documented.", "committedDate": "2020-12-16T11:41:26Z", "type": "commit"}, {"oid": "8044382d3c4a0190561302799c6612b157fb8840", "url": "https://github.com/vespa-engine/vespa/commit/8044382d3c4a0190561302799c6612b157fb8840", "message": "assert that cluster name is only set once", "committedDate": "2020-12-16T11:41:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDMwNzQ3NA==", "url": "https://github.com/vespa-engine/vespa/pull/15836#discussion_r544307474", "bodyText": "Please add copyright", "author": "geirst", "createdAt": "2020-12-16T13:42:52Z", "path": "storage/src/tests/distributor/dummy_cluster_context.h", "diffHunk": "@@ -0,0 +1,11 @@\n+#pragma once", "originalCommit": "8044382d3c4a0190561302799c6612b157fb8840", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDMwNzg2MA==", "url": "https://github.com/vespa-engine/vespa/pull/15836#discussion_r544307860", "bodyText": "Please add class comment.", "author": "geirst", "createdAt": "2020-12-16T13:43:27Z", "path": "storage/src/vespa/storage/common/cluster_context.h", "diffHunk": "@@ -0,0 +1,36 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#pragma once\n+\n+#include <vespa/vespalib/stllike/string.h>\n+\n+namespace storage {\n+\n+struct ClusterContext {", "originalCommit": "8044382d3c4a0190561302799c6612b157fb8840", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDI2NTAzMA==", "url": "https://github.com/vespa-engine/vespa/pull/15836#discussion_r544265030", "bodyText": "Consider const auto* to make constness and pointer more explicitly visible", "author": "vekterli", "createdAt": "2020-12-16T12:38:04Z", "path": "storage/src/vespa/storage/distributor/distributormessagesender.cpp", "diffHunk": "@@ -10,9 +10,10 @@ DistributorMessageSender::sendToNode(const lib::NodeType& nodeType, uint16_t nod\n                                      const std::shared_ptr<api::StorageCommand> & cmd, bool useDocumentAPI)\n {\n     cmd->setSourceIndex(getDistributorIndex());\n+    auto cluster_np = cluster_context().cluster_name_ptr();", "originalCommit": "8044382d3c4a0190561302799c6612b157fb8840", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDMxMTUxMw==", "url": "https://github.com/vespa-engine/vespa/pull/15836#discussion_r544311513", "bodyText": "Consider const auto*", "author": "vekterli", "createdAt": "2020-12-16T13:48:29Z", "path": "storage/src/vespa/storage/persistence/bucketownershipnotifier.cpp", "diffHunk": "@@ -59,7 +59,8 @@ BucketOwnershipNotifier::sendNotifyBucketToDistributor(\n     }\n     auto notifyCmd = std::make_shared<api::NotifyBucketChangeCommand>(bucket, infoToSend);\n \n-    notifyCmd->setAddress(api::StorageMessageAddress::create(&_component.getClusterName(), lib::NodeType::DISTRIBUTOR, distributorIndex));\n+    auto cluster_np = _component.cluster_context().cluster_name_ptr();", "originalCommit": "8044382d3c4a0190561302799c6612b157fb8840", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDMxMTg4Ng==", "url": "https://github.com/vespa-engine/vespa/pull/15836#discussion_r544311886", "bodyText": "Consider const auto*", "author": "vekterli", "createdAt": "2020-12-16T13:49:02Z", "path": "storage/src/vespa/storage/storageserver/mergethrottler.cpp", "diffHunk": "@@ -373,7 +373,8 @@ MergeThrottler::forwardCommandToNode(\n                     mergeCmd.getMaxTimestamp(),\n                     mergeCmd.getClusterStateVersion(),\n                     newChain));\n-    fwdMerge->setAddress(api::StorageMessageAddress::create(&_component.getClusterName(), lib::NodeType::STORAGE, nodeIndex));\n+    auto cluster_np = _component.cluster_context().cluster_name_ptr();", "originalCommit": "8044382d3c4a0190561302799c6612b157fb8840", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDMxMjE1OQ==", "url": "https://github.com/vespa-engine/vespa/pull/15836#discussion_r544312159", "bodyText": "Consider adding a noexcept specifier to this", "author": "vekterli", "createdAt": "2020-12-16T13:49:29Z", "path": "storage/src/vespa/storage/common/cluster_context.h", "diffHunk": "@@ -0,0 +1,36 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#pragma once\n+\n+#include <vespa/vespalib/stllike/string.h>\n+\n+namespace storage {\n+\n+struct ClusterContext {\n+protected:\n+    virtual ~ClusterContext() = default;\n+public:\n+    // returns a pointer to the cluster name\n+    // must be a valid pointer to a constant string for the\n+    // lifetime of all the components that may ask for it\n+    virtual const vespalib::string * cluster_name_ptr() const = 0;", "originalCommit": "8044382d3c4a0190561302799c6612b157fb8840", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e8d657e679f1e8cb9b24c3f847812a72fb14f947", "url": "https://github.com/vespa-engine/vespa/commit/e8d657e679f1e8cb9b24c3f847812a72fb14f947", "message": "review follow-up\n\n* add noexcept to new APIs\n* use \"const auto *\"\n* add documentation comments\n* add copyright", "committedDate": "2020-12-16T15:03:44Z", "type": "commit"}]}