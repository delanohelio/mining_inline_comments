{"pr_number": 15466, "pr_title": "Simplify storage message address", "pr_createdAt": "2020-11-25T13:01:12Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/15466", "timeline": [{"oid": "aa903bfbf23d3b855d50de185a15d8061825c778", "url": "https://github.com/vespa-engine/vespa/commit/aa903bfbf23d3b855d50de185a15d8061825c778", "message": "Change control and data destination to use mbus::Route directly.", "committedDate": "2020-11-25T12:24:02Z", "type": "commit"}, {"oid": "c090dda709692c07ca492b698af9db3e1a76d8e1", "url": "https://github.com/vespa-engine/vespa/commit/c090dda709692c07ca492b698af9db3e1a76d8e1", "message": "Create the mbus::Route on demand instead of storing it inside StorageMessageAddress.\n\nCreating and deleting the route is expensive and not used with RPC for Storage API communication.", "committedDate": "2020-11-25T12:56:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM2NzgzMQ==", "url": "https://github.com/vespa-engine/vespa/pull/15466#discussion_r530367831", "bodyText": "To avoid having to contemplate any struct alignment issues and how they may affect the resulting value, could be simplified down to\nuint16_t buf[] = { type, index };\nreturn vespalib::hashValue(&buf, sizeof(buf));", "author": "vekterli", "createdAt": "2020-11-25T13:19:20Z", "path": "storageapi/src/vespa/storageapi/messageapi/storagemessage.cpp", "diffHunk": "@@ -160,39 +151,50 @@ createAddress(vespalib::stringref cluster, const lib::NodeType& type, uint16_t i\n     return os.str();\n }\n \n+size_t\n+calculate_node_hash(const lib::NodeType& type, uint16_t index)\n+{\n+    struct NodeValue {\n+        uint16_t type;\n+        uint16_t index;\n+        NodeValue(const lib::NodeType& type_in, uint16_t index_in) : type(type_in), index(index_in) {}\n+    };\n+    NodeValue value(type, index);\n+    return vespalib::hashValue(&value, sizeof(NodeValue));", "originalCommit": "c090dda709692c07ca492b698af9db3e1a76d8e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM4OTk0Ng==", "url": "https://github.com/vespa-engine/vespa/pull/15466#discussion_r530389946", "bodyText": "Nice, will fix.", "author": "geirst", "createdAt": "2020-11-25T13:54:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM2NzgzMQ=="}], "type": "inlineReview"}, {"oid": "e9e1b5ef1e6cd77ff5e198ac2ff70449499371af", "url": "https://github.com/vespa-engine/vespa/commit/e9e1b5ef1e6cd77ff5e198ac2ff70449499371af", "message": "Simplify hash calculation.", "committedDate": "2020-11-25T13:59:23Z", "type": "commit"}]}