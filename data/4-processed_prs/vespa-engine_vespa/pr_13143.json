{"pr_number": 13143, "pr_title": "Create a QueryTermVector once and do the significance and connectedne\u2026", "pr_createdAt": "2020-05-04T08:50:12Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/13143", "timeline": [{"oid": "1e8a78d38165897e4c0daad243b21f5db82aa71e", "url": "https://github.com/vespa-engine/vespa/commit/1e8a78d38165897e4c0daad243b21f5db82aa71e", "message": "Create a QueryTermVector once and do the significance and connectedness lookups once.", "committedDate": "2020-05-04T08:38:55Z", "type": "commit"}, {"oid": "88775899c648ecca07143542b329e460dfc45675", "url": "https://github.com/vespa-engine/vespa/commit/88775899c648ecca07143542b329e460dfc45675", "message": "Use correct include <", "committedDate": "2020-05-04T09:17:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTMyNDE0NA==", "url": "https://github.com/vespa-engine/vespa/pull/13143#discussion_r419324144", "bodyText": "This parameter is removed, please update", "author": "geirst", "createdAt": "2020-05-04T09:49:43Z", "path": "searchlib/src/vespa/searchlib/features/queryterm.h", "diffHunk": "@@ -51,10 +61,20 @@ class QueryTermFactory {\n      * @param lookupSignificance whether we should look up the significance for this term.", "originalCommit": "1e8a78d38165897e4c0daad243b21f5db82aa71e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM3MzQ1Mw==", "url": "https://github.com/vespa-engine/vespa/pull/13143#discussion_r419373453", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-05-04T11:36:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTMyNDE0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTMyNDM5Mg==", "url": "https://github.com/vespa-engine/vespa/pull/13143#discussion_r419324392", "bodyText": "Consider adding class comment.", "author": "geirst", "createdAt": "2020-05-04T09:50:08Z", "path": "searchlib/src/vespa/searchlib/features/queryterm.h", "diffHunk": "@@ -51,10 +61,20 @@ class QueryTermFactory {\n      * @param lookupSignificance whether we should look up the significance for this term.\n      * @param lookupConnectedness whether we should look up the connectedness this term has with the previous term.\n      */\n-    static QueryTerm create(const fef::IQueryEnvironment & env,\n-                            uint32_t termIndex,\n-                            bool lookupSignificance = true,\n+    static QueryTerm create(const fef::IQueryEnvironment & env, uint32_t termIndex,\n                             bool lookupConnectedness = false);\n };\n \n+class QueryTermHelper {", "originalCommit": "1e8a78d38165897e4c0daad243b21f5db82aa71e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM3MzUyMQ==", "url": "https://github.com/vespa-engine/vespa/pull/13143#discussion_r419373521", "bodyText": "Done", "author": "baldersheim", "createdAt": "2020-05-04T11:36:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTMyNDM5Mg=="}], "type": "inlineReview"}, {"oid": "5ac2795f69a16004e03dc60d5eff208c76870fce", "url": "https://github.com/vespa-engine/vespa/commit/5ac2795f69a16004e03dc60d5eff208c76870fce", "message": "Update comments.", "committedDate": "2020-05-04T10:49:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM0OTQ3MA==", "url": "https://github.com/vespa-engine/vespa/pull/13143#discussion_r419349470", "bodyText": "'queryvectorhelper' is a bit confusing, consider using 'querytermhelper.queryterms' instead", "author": "havardpe", "createdAt": "2020-05-04T10:42:48Z", "path": "searchlib/src/vespa/searchlib/features/queryterm.cpp", "diffHunk": "@@ -3,45 +3,66 @@\n #include \"queryterm.h\"\n #include \"utils.h\"\n \n-using namespace search::fef;\n using search::feature_t;\n+using namespace search::fef;\n \n namespace search::features {\n \n-QueryTerm::QueryTerm() :\n-    _termData(nullptr),\n-    _handle(IllegalHandle),\n-    _significance(0),\n-    _connectedness(0)\n+QueryTerm\n+QueryTermFactory::create(const IQueryEnvironment & env, uint32_t termIdx, bool lookupConnectedness)\n {\n+    const ITermData *termData = env.getTerm(termIdx);\n+    feature_t fallback = util::getSignificance(*termData);\n+    feature_t significance = features::util::lookupSignificance(env, termIdx, fallback);\n+    feature_t connectedness = 0;\n+    if (lookupConnectedness) {\n+        connectedness = util::lookupConnectedness(env, termIdx);\n+    }\n+    return QueryTerm(termData, significance, connectedness);\n }\n \n-QueryTerm::QueryTerm(const ITermData * td, feature_t sig, feature_t con) :\n-    _termData(td),\n-    _handle(IllegalHandle),\n-    _significance(sig),\n-    _connectedness(con)\n+QueryTermHelper::QueryTermHelper(const IQueryEnvironment &env)\n+        : _fallBack(),\n+          _queryTerms(lookupQueryTerms(env))\n {\n+    if (_queryTerms == nullptr) {\n+        _fallBack = createQueryTermvector(env);\n+        _queryTerms = & _fallBack;\n+    }\n }\n \n-QueryTerm\n-QueryTermFactory::create(const IQueryEnvironment & env,\n-                         uint32_t termIdx,\n-                         bool lookupSignificance,\n-                         bool lookupConnectedness)\n+namespace {\n+\n+using QueryTermVectorWrapper = AnyWrapper<QueryTermVector>;\n+const vespalib::string QUERY_TERMS_KEY(\"queryvectorhelper.queryterms\");", "originalCommit": "88775899c648ecca07143542b329e460dfc45675", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM3Mzc0Nw==", "url": "https://github.com/vespa-engine/vespa/pull/13143#discussion_r419373747", "bodyText": "fixed", "author": "baldersheim", "createdAt": "2020-05-04T11:37:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM0OTQ3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM1MjYyNg==", "url": "https://github.com/vespa-engine/vespa/pull/13143#discussion_r419352626", "bodyText": "push_back is probably more appropriate for object copy", "author": "havardpe", "createdAt": "2020-05-04T10:49:53Z", "path": "searchlib/src/vespa/searchlib/features/queryterm.cpp", "diffHunk": "@@ -3,45 +3,66 @@\n #include \"queryterm.h\"\n #include \"utils.h\"\n \n-using namespace search::fef;\n using search::feature_t;\n+using namespace search::fef;\n \n namespace search::features {\n \n-QueryTerm::QueryTerm() :\n-    _termData(nullptr),\n-    _handle(IllegalHandle),\n-    _significance(0),\n-    _connectedness(0)\n+QueryTerm\n+QueryTermFactory::create(const IQueryEnvironment & env, uint32_t termIdx, bool lookupConnectedness)\n {\n+    const ITermData *termData = env.getTerm(termIdx);\n+    feature_t fallback = util::getSignificance(*termData);\n+    feature_t significance = features::util::lookupSignificance(env, termIdx, fallback);\n+    feature_t connectedness = 0;\n+    if (lookupConnectedness) {\n+        connectedness = util::lookupConnectedness(env, termIdx);\n+    }\n+    return QueryTerm(termData, significance, connectedness);\n }\n \n-QueryTerm::QueryTerm(const ITermData * td, feature_t sig, feature_t con) :\n-    _termData(td),\n-    _handle(IllegalHandle),\n-    _significance(sig),\n-    _connectedness(con)\n+QueryTermHelper::QueryTermHelper(const IQueryEnvironment &env)\n+        : _fallBack(),\n+          _queryTerms(lookupQueryTerms(env))\n {\n+    if (_queryTerms == nullptr) {\n+        _fallBack = createQueryTermvector(env);\n+        _queryTerms = & _fallBack;\n+    }\n }\n \n-QueryTerm\n-QueryTermFactory::create(const IQueryEnvironment & env,\n-                         uint32_t termIdx,\n-                         bool lookupSignificance,\n-                         bool lookupConnectedness)\n+namespace {\n+\n+using QueryTermVectorWrapper = AnyWrapper<QueryTermVector>;\n+const vespalib::string QUERY_TERMS_KEY(\"queryvectorhelper.queryterms\");\n+\n+}\n+const QueryTermVector &\n+QueryTermHelper::lookupAndStoreQueryTerms(const IQueryEnvironment &env, IObjectStore & store)\n {\n-    const ITermData *termData = env.getTerm(termIdx);\n-    feature_t significance = 0;\n-    if (lookupSignificance) {\n-        feature_t fallback = util::getSignificance(*termData);\n-        significance = util::lookupSignificance(env, termIdx, fallback);\n-    }\n-    feature_t connectedness = 0;\n-    if (lookupConnectedness) {\n-        connectedness = search::features::util::lookupConnectedness(env, termIdx);\n+    const Anything * obj = store.get(QUERY_TERMS_KEY);\n+    if (obj == nullptr) {\n+        store.add(QUERY_TERMS_KEY, std::make_unique<QueryTermVectorWrapper>(createQueryTermvector(env)));\n+        obj = store.get(QUERY_TERMS_KEY);\n     }\n-    return QueryTerm(termData, significance, connectedness);\n+    return static_cast<const QueryTermVectorWrapper *>(obj)->getValue();\n }\n \n+const QueryTermVector *\n+QueryTermHelper::lookupQueryTerms(const IQueryEnvironment & env)\n+{\n+    const Anything * obj = env.getObjectStore().get(QUERY_TERMS_KEY);\n+    return (obj != nullptr) ? & static_cast<const QueryTermVectorWrapper *>(obj)->getValue() : nullptr;\n+}\n+\n+QueryTermVector\n+QueryTermHelper::createQueryTermvector(const IQueryEnvironment &env) {\n+    QueryTermVector vector;\n+    vector.reserve(env.getNumTerms());\n+    for (size_t i(0); i < env.getNumTerms(); i++) {\n+        vector.emplace_back(QueryTermFactory::create(env, i));", "originalCommit": "88775899c648ecca07143542b329e460dfc45675", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM3MzkxMQ==", "url": "https://github.com/vespa-engine/vespa/pull/13143#discussion_r419373911", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-05-04T11:37:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM1MjYyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM1NDYyMQ==", "url": "https://github.com/vespa-engine/vespa/pull/13143#discussion_r419354621", "bodyText": "consider adding a static convenience function to the AnyWrapper template that casts the Anything pointer to a const T reference.", "author": "havardpe", "createdAt": "2020-05-04T10:54:24Z", "path": "searchlib/src/vespa/searchlib/features/queryterm.cpp", "diffHunk": "@@ -3,45 +3,66 @@\n #include \"queryterm.h\"\n #include \"utils.h\"\n \n-using namespace search::fef;\n using search::feature_t;\n+using namespace search::fef;\n \n namespace search::features {\n \n-QueryTerm::QueryTerm() :\n-    _termData(nullptr),\n-    _handle(IllegalHandle),\n-    _significance(0),\n-    _connectedness(0)\n+QueryTerm\n+QueryTermFactory::create(const IQueryEnvironment & env, uint32_t termIdx, bool lookupConnectedness)\n {\n+    const ITermData *termData = env.getTerm(termIdx);\n+    feature_t fallback = util::getSignificance(*termData);\n+    feature_t significance = features::util::lookupSignificance(env, termIdx, fallback);\n+    feature_t connectedness = 0;\n+    if (lookupConnectedness) {\n+        connectedness = util::lookupConnectedness(env, termIdx);\n+    }\n+    return QueryTerm(termData, significance, connectedness);\n }\n \n-QueryTerm::QueryTerm(const ITermData * td, feature_t sig, feature_t con) :\n-    _termData(td),\n-    _handle(IllegalHandle),\n-    _significance(sig),\n-    _connectedness(con)\n+QueryTermHelper::QueryTermHelper(const IQueryEnvironment &env)\n+        : _fallBack(),\n+          _queryTerms(lookupQueryTerms(env))\n {\n+    if (_queryTerms == nullptr) {\n+        _fallBack = createQueryTermvector(env);\n+        _queryTerms = & _fallBack;\n+    }\n }\n \n-QueryTerm\n-QueryTermFactory::create(const IQueryEnvironment & env,\n-                         uint32_t termIdx,\n-                         bool lookupSignificance,\n-                         bool lookupConnectedness)\n+namespace {\n+\n+using QueryTermVectorWrapper = AnyWrapper<QueryTermVector>;\n+const vespalib::string QUERY_TERMS_KEY(\"queryvectorhelper.queryterms\");\n+\n+}\n+const QueryTermVector &\n+QueryTermHelper::lookupAndStoreQueryTerms(const IQueryEnvironment &env, IObjectStore & store)\n {\n-    const ITermData *termData = env.getTerm(termIdx);\n-    feature_t significance = 0;\n-    if (lookupSignificance) {\n-        feature_t fallback = util::getSignificance(*termData);\n-        significance = util::lookupSignificance(env, termIdx, fallback);\n-    }\n-    feature_t connectedness = 0;\n-    if (lookupConnectedness) {\n-        connectedness = search::features::util::lookupConnectedness(env, termIdx);\n+    const Anything * obj = store.get(QUERY_TERMS_KEY);\n+    if (obj == nullptr) {\n+        store.add(QUERY_TERMS_KEY, std::make_unique<QueryTermVectorWrapper>(createQueryTermvector(env)));\n+        obj = store.get(QUERY_TERMS_KEY);\n     }\n-    return QueryTerm(termData, significance, connectedness);\n+    return static_cast<const QueryTermVectorWrapper *>(obj)->getValue();", "originalCommit": "88775899c648ecca07143542b329e460dfc45675", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM3NDA1MA==", "url": "https://github.com/vespa-engine/vespa/pull/13143#discussion_r419374050", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-05-04T11:37:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM1NDYyMQ=="}], "type": "inlineReview"}, {"oid": "42a9844982ca2d9985bda3fa128786879c27ec0e", "url": "https://github.com/vespa-engine/vespa/commit/42a9844982ca2d9985bda3fa128786879c27ec0e", "message": "Better naming and convenience cast.", "committedDate": "2020-05-04T11:34:59Z", "type": "commit"}]}