{"pr_number": 13501, "pr_title": "Arnej/global filter after fetch postings", "pr_createdAt": "2020-06-08T07:12:25Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/13501", "timeline": [{"oid": "c5dbeedb10013c7e5931b5da27d00de5808e50d3", "url": "https://github.com/vespa-engine/vespa/commit/c5dbeedb10013c7e5931b5da27d00de5808e50d3", "message": "perform TopK in set_global_filter\n\n* global filter must be computed after fetchPostings,\n  so move actual TopK computation.", "committedDate": "2020-06-07T19:16:58Z", "type": "commit"}, {"oid": "29a4e89c1e85aa1e967586606676bef35a9ad47a", "url": "https://github.com/vespa-engine/vespa/commit/29a4e89c1e85aa1e967586606676bef35a9ad47a", "message": "compute and apply global filter after fetchPostings", "committedDate": "2020-06-07T19:17:03Z", "type": "commit"}, {"oid": "54a23d2bc9a05eb7d503d5be5cbe5e757eea571e", "url": "https://github.com/vespa-engine/vespa/commit/54a23d2bc9a05eb7d503d5be5cbe5e757eea571e", "message": "do estimates like before, broke unit test", "committedDate": "2020-06-08T07:38:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYwOTUyNg==", "url": "https://github.com/vespa-engine/vespa/pull/13501#discussion_r436609526", "bodyText": "Until we have data on performance tests, perhaps we should not do fallback to brute force. That will make it harder to interpret the results.", "author": "geirst", "createdAt": "2020-06-08T10:49:16Z", "path": "searchlib/src/vespa/searchlib/queryeval/nearest_neighbor_blueprint.cpp", "diffHunk": "@@ -84,10 +87,15 @@ NearestNeighborBlueprint::set_global_filter(const GlobalFilter &global_filter)\n {\n     _global_filter = global_filter.shared_from_this();\n     auto nns_index = _attr_tensor.nearest_neighbor_index();\n+    LOG(debug, \"set_global_filter with: %s / %s / %s\",\n+        (_approximate ? \"approximate\" : \"exact\"),\n+        (nns_index ? \"nns_index\" : \"no_index\"),\n+        (_global_filter->has_filter() ? \"has_filter\" : \"no_filter\"));\n     if (_approximate && nns_index) {\n         uint32_t est_hits = _attr_tensor.getNumDocs();\n         if (_global_filter->has_filter()) {\n             uint32_t max_hits = _global_filter->filter()->countTrueBits();\n+            LOG(debug, \"set_global_filter getNumDocs: %u / max_hits %u\", est_hits, max_hits);\n             if (max_hits * 10 < est_hits) {", "originalCommit": "54a23d2bc9a05eb7d503d5be5cbe5e757eea571e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ffe564fef3def35b34cc3e4bd661bb68b45469b6", "url": "https://github.com/vespa-engine/vespa/commit/ffe564fef3def35b34cc3e4bd661bb68b45469b6", "message": "no fallback to brute force for now", "committedDate": "2020-06-08T11:36:34Z", "type": "commit"}]}