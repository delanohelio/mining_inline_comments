{"pr_number": 14732, "pr_title": "Reuse document meta store state from prepare step", "pr_createdAt": "2020-10-06T09:12:37Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/14732", "timeline": [{"oid": "43cf58d24470e3c0cc85ec43a3bf8f314cd29c99", "url": "https://github.com/vespa-engine/vespa/commit/43cf58d24470e3c0cc85ec43a3bf8f314cd29c99", "message": "Reuse document meta store state from prepare step instead of doing\na new lookup in btree mapping from gid to lid during live feed.", "committedDate": "2020-10-06T09:10:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE4MDM5OQ==", "url": "https://github.com/vespa-engine/vespa/pull/14732#discussion_r500180399", "bodyText": "Do you need this when you are using uint64_t instead of SerialNum", "author": "baldersheim", "createdAt": "2020-10-06T10:50:08Z", "path": "searchcore/src/vespa/searchcore/proton/documentmetastore/i_store.h", "diffHunk": "@@ -6,6 +6,7 @@\n #include <vespa/document/base/globalid.h>\n #include <vespa/document/bucket/bucketid.h>\n #include <persistence/spi/types.h>\n+#include <vespa/searchlib/common/serialnum.h>", "originalCommit": "43cf58d24470e3c0cc85ec43a3bf8f314cd29c99", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE4NDc2Nw==", "url": "https://github.com/vespa-engine/vespa/pull/14732#discussion_r500184767", "bodyText": "No. Removed.", "author": "toregge", "createdAt": "2020-10-06T10:57:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE4MDM5OQ=="}], "type": "inlineReview"}, {"oid": "3858a5faffad96ef4a255afb96d344dc7ab426d7", "url": "https://github.com/vespa-engine/vespa/commit/3858a5faffad96ef4a255afb96d344dc7ab426d7", "message": "Remove unneeded include.", "committedDate": "2020-10-06T10:56:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE4NjkyMw==", "url": "https://github.com/vespa-engine/vespa/pull/14732#discussion_r500186923", "bodyText": "Wait with takeGuard untial after validLid check ?", "author": "baldersheim", "createdAt": "2020-10-06T11:02:03Z", "path": "searchcore/src/vespa/searchcore/proton/documentmetastore/documentmetastore.cpp", "diffHunk": "@@ -536,40 +538,44 @@ DocumentMetaStore::updateMetaData(DocId lid,\n     return true;\n }\n \n-bool\n-DocumentMetaStore::remove(DocId lid, BucketDBOwner::Guard &bucketGuard)\n+void\n+DocumentMetaStore::remove(DocId lid, uint64_t prepare_serial_num, BucketDBOwner::Guard &bucketGuard)\n {\n-    if (!validLid(lid)) {\n-        return false;\n-    }\n     const GlobalId & gid = getRawGid(lid);\n     KeyComp comp(gid, _metaDataStore, *_gidCompare);\n-    if (!_gidToLidMap.remove(lid, comp)) {\n+    auto& itr = _gid_to_lid_map_write_itr;\n+    if (prepare_serial_num == 0u || _gid_to_lid_map_write_itr_prepare_serial_num != prepare_serial_num) {\n+        itr.lower_bound(_gidToLidMap.getRoot(), lid, comp);\n+    }\n+    if (!itr.valid() || comp(lid, itr.getKey())) {\n         throw IllegalStateException(make_string(\n                         \"document meta data store corrupted,\"\n                         \" cannot remove\"\n                         \" document with lid '%u' and gid '%s'\",\n                         lid, gid.toString().c_str()));\n     }\n+    _gidToLidMap.remove(itr);\n     _lidAlloc.unregisterLid(lid);\n     RawDocumentMetaData &oldMetaData = _metaDataStore[lid];\n     bucketGuard->remove(oldMetaData.getGid(),\n                         oldMetaData.getBucketId().stripUnused(),\n                         oldMetaData.getTimestamp(), oldMetaData.getDocSize(),\n                         _subDbType);\n-    return true;\n }\n \n bool\n-DocumentMetaStore::remove(DocId lid)\n+DocumentMetaStore::remove(DocId lid, uint64_t prepare_serial_num)\n {\n     BucketDBOwner::Guard bucketGuard = _bucketDB->takeGuard();", "originalCommit": "43cf58d24470e3c0cc85ec43a3bf8f314cd29c99", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE5MDY5Mw==", "url": "https://github.com/vespa-engine/vespa/pull/14732#discussion_r500190693", "bodyText": "Fixed.", "author": "toregge", "createdAt": "2020-10-06T11:09:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE4NjkyMw=="}], "type": "inlineReview"}, {"oid": "9fa42f01249386655f6018184b5b4e562e9af81a", "url": "https://github.com/vespa-engine/vespa/commit/9fa42f01249386655f6018184b5b4e562e9af81a", "message": "Take bucket guard after having passed validLid() check.", "committedDate": "2020-10-06T11:07:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDI2MDI1MA==", "url": "https://github.com/vespa-engine/vespa/pull/14732#discussion_r500260250", "bodyText": "Consider adding a helper function for this, e.g. update_gid_to_lid_map_write_itr(prepare_serial_num). Same check is used in three places.", "author": "geirst", "createdAt": "2020-10-06T13:07:26Z", "path": "searchcore/src/vespa/searchcore/proton/documentmetastore/documentmetastore.cpp", "diffHunk": "@@ -462,20 +462,23 @@ DocumentMetaStore::put(const GlobalId &gid,\n                        const BucketId &bucketId,\n                        const Timestamp &timestamp,\n                        uint32_t docSize,\n-                       DocId lid)\n+                       DocId lid,\n+                       uint64_t prepare_serial_num)\n {\n     Result res;\n     RawDocumentMetaData metaData(gid, bucketId, timestamp, docSize);\n     KeyComp comp(metaData, _metaDataStore, *_gidCompare);\n-    TreeType::Iterator itr = _gidToLidMap.lowerBound(KeyComp::FIND_DOC_ID,\n-            comp);\n+    auto& itr = _gid_to_lid_map_write_itr;\n+    if (prepare_serial_num == 0u || _gid_to_lid_map_write_itr_prepare_serial_num != prepare_serial_num) {", "originalCommit": "9fa42f01249386655f6018184b5b4e562e9af81a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDI2MDY1Ng==", "url": "https://github.com/vespa-engine/vespa/pull/14732#discussion_r500260656", "bodyText": "Consider adding a comment on how this serial num relates to _gid_to_lid_map_write_itr.", "author": "geirst", "createdAt": "2020-10-06T13:08:02Z", "path": "searchcore/src/vespa/searchcore/proton/documentmetastore/documentmetastore.h", "diffHunk": "@@ -68,6 +68,8 @@ class DocumentMetaStore final : public DocumentMetaStoreAttribute,\n \n     MetaDataStore       _metaDataStore;\n     TreeType            _gidToLidMap;\n+    Iterator            _gid_to_lid_map_write_itr; // Iterator used for all updates of _gidToLidMap\n+    SerialNum           _gid_to_lid_map_write_itr_prepare_serial_num;", "originalCommit": "9fa42f01249386655f6018184b5b4e562e9af81a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}