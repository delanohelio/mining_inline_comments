{"pr_number": 14104, "pr_title": "return Vespa connection when deploying Vespa app.", "pr_createdAt": "2020-08-19T11:49:07Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/14104", "timeline": [{"oid": "ebc079a91a0b4bbe5ad9a1a8de8cead7d2f7ddc3", "url": "https://github.com/vespa-engine/vespa/commit/ebc079a91a0b4bbe5ad9a1a8de8cead7d2f7ddc3", "message": "return Vespa connection when deploying Vespa app.", "committedDate": "2020-08-19T11:48:19Z", "type": "commit"}, {"oid": "63a21adb6720d9182ace983b69c9b1636371fd4e", "url": "https://github.com/vespa-engine/vespa/commit/63a21adb6720d9182ace983b69c9b1636371fd4e", "message": "add __repr__ method", "committedDate": "2020-08-19T12:21:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk5MjU3NA==", "url": "https://github.com/vespa-engine/vespa/pull/14104#discussion_r472992574", "bodyText": "Is it idiomatic to return a tuple with message and a handle? It seems odd, and how do you programatically see the difference between successes and failures here?\nYou should probably use self.local_port instead of directly referencing port 8080?", "author": "oyving", "createdAt": "2020-08-19T12:32:14Z", "path": "python/vespa/vespa/package.py", "diffHunk": "@@ -446,4 +457,8 @@ def deploy(self, disk_folder: str, container_memory: str = \"4G\"):\n         deployment = self.container.exec_run(\n             \"bash -c '/opt/vespa/bin/vespa-deploy prepare /app/application && /opt/vespa/bin/vespa-deploy activate'\"\n         )\n-        return deployment.output.decode(\"utf-8\").split(\"\\n\")\n+\n+        return (\n+            deployment.output.decode(\"utf-8\").split(\"\\n\"),\n+            Vespa(url=\"http://localhost\", port=8080),", "originalCommit": "63a21adb6720d9182ace983b69c9b1636371fd4e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzc1NzMyMA==", "url": "https://github.com/vespa-engine/vespa/pull/14104#discussion_r473757320", "bodyText": "Yes, you are right. The tuple seems odd. I suggest to store the deployment message as an attribute of the Vespa instance. What do you think?\n\n\nAbout the difference between successes and failures: This info needs to be extracted from the deployment message. My plan is to improve this part of the code as I experience deployment failures as I do not have a full overview of the type of errors I can face at this moment.\n\n\nI agree about self.local_port. I will make the change after we settle about the points above.", "author": "thigm85", "createdAt": "2020-08-20T08:26:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk5MjU3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg3MjY1OA==", "url": "https://github.com/vespa-engine/vespa/pull/14104#discussion_r473872658", "bodyText": "I guess the idiomatic way would be to throw and exception on failure and return the handle on success? It can lead to a bit noisy code, but I think that's the way the Python standard libraries does it (e.g. opening a file failures). Then an error message could be encoded in the exception. Messages on success can be an attribute on the Vespa object.", "author": "oyving", "createdAt": "2020-08-20T10:43:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk5MjU3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg4MTcwOA==", "url": "https://github.com/vespa-engine/vespa/pull/14104#discussion_r473881708", "bodyText": "Yes, I agree. I will definitely throw an exception if a deployment failure occur. I will implement the exceptions as soon as I face a deployment failure. But I think we are agreeing that the deployment message will be included on the Vespa instance when it is returned (which will only happen if deployment goes through.)", "author": "thigm85", "createdAt": "2020-08-20T10:56:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk5MjU3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzkwNTQ0Ng==", "url": "https://github.com/vespa-engine/vespa/pull/14104#discussion_r473905446", "bodyText": "Also, I found a way to detect when vespa deployment fails and then the code raises RunTimeError exception with the deployment message showing what went wrong.", "author": "thigm85", "createdAt": "2020-08-20T11:39:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk5MjU3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzkzOTA1OQ==", "url": "https://github.com/vespa-engine/vespa/pull/14104#discussion_r473939059", "bodyText": "Suddenly I wonder why port is a separate parameter to the constructor and not part of the URL. I'm slow to catch that :)", "author": "oyving", "createdAt": "2020-08-20T12:41:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk5MjU3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE4MTAwNQ==", "url": "https://github.com/vespa-engine/vespa/pull/14104#discussion_r474181005", "bodyText": "Not sure why I chose that besides the fact that I guess url and port often comes as two different arguments in other libraries. I myself always wonder if port should be included or not when specifying urls. Do you suggest a change?", "author": "thigm85", "createdAt": "2020-08-20T18:16:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk5MjU3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE4NzgwNA==", "url": "https://github.com/vespa-engine/vespa/pull/14104#discussion_r474187804", "bodyText": "But if we agree to unify url and port into one I can do so in another PR.", "author": "thigm85", "createdAt": "2020-08-20T18:28:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk5MjU3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI1MjE3NQ==", "url": "https://github.com/vespa-engine/vespa/pull/14104#discussion_r474252175", "bodyText": "In general the URL should only omit the port number if it's the default port number for the protocol specified in the URL. But yes, let's keep that for a different PR then :)", "author": "oyving", "createdAt": "2020-08-20T20:24:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk5MjU3NA=="}], "type": "inlineReview"}, {"oid": "c5b2d82bb3d8612f7a3df85ff6b61b8200099b47", "url": "https://github.com/vespa-engine/vespa/commit/c5b2d82bb3d8612f7a3df85ff6b61b8200099b47", "message": "include vespa engine deployment message in the Vespa class as attribute", "committedDate": "2020-08-20T11:28:58Z", "type": "commit"}, {"oid": "3f6fcaefe320aa5f6207f87ea5b5c538c2304686", "url": "https://github.com/vespa-engine/vespa/commit/3f6fcaefe320aa5f6207f87ea5b5c538c2304686", "message": "raise exception when deployment fails or return Vespa with deployment message when deployment succeeds.", "committedDate": "2020-08-20T11:37:13Z", "type": "commit"}, {"oid": "9fd6d4a25199bbf356f3ebbb9265cff76e126a84", "url": "https://github.com/vespa-engine/vespa/commit/9fd6d4a25199bbf356f3ebbb9265cff76e126a84", "message": "use self.local_port instead of hard coded 8080", "committedDate": "2020-08-20T11:38:12Z", "type": "commit"}]}