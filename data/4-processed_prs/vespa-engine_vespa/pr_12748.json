{"pr_number": 12748, "pr_title": "Use atomics to avoid locking instructions in hot path.", "pr_createdAt": "2020-03-28T01:06:15Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/12748", "timeline": [{"oid": "720a6c64c4bd9e70f52a89d909560f6f26125887", "url": "https://github.com/vespa-engine/vespa/commit/720a6c64c4bd9e70f52a89d909560f6f26125887", "message": "Use atomics to avoid locking instructions in hot path.", "committedDate": "2020-03-28T01:02:36Z", "type": "commit"}, {"oid": "506d2d5491448fea5683ea8d34957b10e048847b", "url": "https://github.com/vespa-engine/vespa/commit/506d2d5491448fea5683ea8d34957b10e048847b", "message": "Only start LRU mode once half full", "committedDate": "2020-03-29T21:14:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAyNTU5NA==", "url": "https://github.com/vespa-engine/vespa/pull/12748#discussion_r400025594", "bodyText": "There seems to be a transitive data visibility dependency from _state to _version, so to ensure _version is well defined this should be a memory_order_acquire load.", "author": "vekterli", "createdAt": "2020-03-30T08:50:07Z", "path": "messagebus/src/vespa/messagebus/network/rpctarget.cpp", "diffHunk": "@@ -25,11 +25,12 @@ RPCTarget::~RPCTarget()\n void\n RPCTarget::resolveVersion(duration timeout, RPCTarget::IVersionHandler &handler)\n {\n-    bool hasVersion = false;\n     bool shouldInvoke = false;\n-    {\n+    ResolveState state = _state.load(std::memory_order_relaxed);", "originalCommit": "506d2d5491448fea5683ea8d34957b10e048847b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA2Nzc0MQ==", "url": "https://github.com/vespa-engine/vespa/pull/12748#discussion_r400067741", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-03-30T09:57:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAyNTU5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAyNzMyNQ==", "url": "https://github.com/vespa-engine/vespa/pull/12748#discussion_r400027325", "bodyText": "Is RPCTarget::isValid() ever used in a way where the caller assumes something about the contents of _version based on the return value here? If so, consider using memory_order_acquire here as well.", "author": "vekterli", "createdAt": "2020-03-30T08:52:47Z", "path": "messagebus/src/vespa/messagebus/network/rpctarget.cpp", "diffHunk": "@@ -54,11 +55,11 @@ RPCTarget::resolveVersion(duration timeout, RPCTarget::IVersionHandler &handler)\n bool\n RPCTarget::isValid() const\n {\n-    vespalib::MonitorGuard guard(_lock);\n     if (_target.IsValid()) {\n         return true;\n     }\n-    if (_state == TARGET_INVOKED || _state == PROCESSING_HANDLERS) {\n+    ResolveState state = _state.load(std::memory_order_relaxed);", "originalCommit": "506d2d5491448fea5683ea8d34957b10e048847b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA3MDIwNA==", "url": "https://github.com/vespa-engine/vespa/pull/12748#discussion_r400070204", "bodyText": "No, it is just used once to detect if connection should be dropped and remove from pool.", "author": "baldersheim", "createdAt": "2020-03-30T10:00:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAyNzMyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAzNTk2NA==", "url": "https://github.com/vespa-engine/vespa/pull/12748#discussion_r400035964", "bodyText": "By removing the check for _state == VERSION_RESOLVED, doesn't this open up for the following race condition?\n\nThread reads _state == TARGET_INVOKED cached into local state variable, attempts to enter critical section. Is put on hold by kernel.\nMBus thread receives resolved version, enters critical section, finishes processing handlers and finally sets _state = VERSION_RESOLVED\nOriginal thread wakes up, enters critical section\nOriginal thread sees that cached state value is not equal to PROCESSING_HANDLERS, does not enter branch that can set hasVersion = true\nOriginal thread initiates new version fetch towards peer even though version has already been resolved\nNew round of same race condition possible by any other subsequent concurrent senders\n\nNote that it should be safe to use the original expression with both loads being made explicitly relaxed, as visibility should be guaranteed from entering the critical section. That should avoid the race condition while not introducing any memory fences.", "author": "vekterli", "createdAt": "2020-03-30T09:06:27Z", "path": "messagebus/src/vespa/messagebus/network/rpctarget.cpp", "diffHunk": "@@ -25,11 +25,12 @@ RPCTarget::~RPCTarget()\n void\n RPCTarget::resolveVersion(duration timeout, RPCTarget::IVersionHandler &handler)\n {\n-    bool hasVersion = false;\n     bool shouldInvoke = false;\n-    {\n+    ResolveState state = _state.load(std::memory_order_relaxed);\n+    bool hasVersion = (state == VERSION_RESOLVED);\n+    if ( ! hasVersion ) {\n         vespalib::MonitorGuard guard(_lock);\n-        if (_state == VERSION_RESOLVED || _state == PROCESSING_HANDLERS) {\n+        if (state == PROCESSING_HANDLERS) {", "originalCommit": "506d2d5491448fea5683ea8d34957b10e048847b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA4NjA0OA==", "url": "https://github.com/vespa-engine/vespa/pull/12748#discussion_r400086048", "bodyText": "Very good catch - Classic error.", "author": "baldersheim", "createdAt": "2020-03-30T10:28:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAzNTk2NA=="}], "type": "inlineReview"}, {"oid": "42f80e15c96ef559799a17c68964f2a86e5bc934", "url": "https://github.com/vespa-engine/vespa/commit/42f80e15c96ef559799a17c68964f2a86e5bc934", "message": "Use original logic to avoid race condition.", "committedDate": "2020-03-30T10:25:32Z", "type": "commit"}]}