{"pr_number": 14847, "pr_title": "Balder/monitor 2 mutex and cond 4", "pr_createdAt": "2020-10-13T23:02:29Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/14847", "timeline": [{"oid": "71c10939b19be8ea115cda9ecddcad7749b2c20d", "url": "https://github.com/vespa-engine/vespa/commit/71c10939b19be8ea115cda9ecddcad7749b2c20d", "message": "Use std::mutex/std::condition_variable over vespalib::Monitor", "committedDate": "2020-10-13T20:39:16Z", "type": "commit"}, {"oid": "001bdf0053ba9cb02e20afcceb9d0f7ed63f1178", "url": "https://github.com/vespa-engine/vespa/commit/001bdf0053ba9cb02e20afcceb9d0f7ed63f1178", "message": "Use std::mutex and std:.condition_variable and GC some unused code.", "committedDate": "2020-10-13T22:56:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUxNzY0Mw==", "url": "https://github.com/vespa-engine/vespa/pull/14847#discussion_r504517643", "bodyText": "I'm not sure if I understand how the original destruction logic here is meant to work. Seems like we'll just be very rapidly increasing _count as long as someone is waiting on the semaphore? Replace with the assertion mentioned in the comment instead? Unless I'm greatly misunderstanding something, which might be the case \ud83d\ude42", "author": "vekterli", "createdAt": "2020-10-14T09:01:39Z", "path": "document/src/vespa/document/util/queue.h", "diffHunk": "@@ -16,35 +16,32 @@ class Semaphore\n private:\n     int _count;\n     int _numWaiters;\n-    vespalib::Monitor _sync;\n-\n-    // assignment would be unsafe\n-    Semaphore& operator= (const Semaphore& other);\n+    std::mutex _lock;\n+    std::condition_variable _cond;\n public:\n-    // XXX is it really safe to just copy other._count here?\n-    Semaphore(const Semaphore& other) : _count(other._count), _numWaiters(0), _sync() {}\n-\n-    Semaphore(int count=0) : _count(count), _numWaiters(0), _sync() { }\n+    Semaphore(int count=0) : _count(count), _numWaiters(0), _lock() { }\n \n-    virtual ~Semaphore() {\n+    ~Semaphore() {\n         // XXX alternative: assert(_numWaiters == 0)\n         while (true) {\n-            vespalib::MonitorGuard guard(_sync);\n-            if (_numWaiters == 0) break;\n-            _count++;\n-            guard.signal();\n+            {\n+                std::lock_guard guard(_lock);\n+                if (_numWaiters == 0) break;\n+                _count++;\n+            }\n+            _cond.notify_one();", "originalCommit": "001bdf0053ba9cb02e20afcceb9d0f7ed63f1178", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU4ODI3NA==", "url": "https://github.com/vespa-engine/vespa/pull/14847#discussion_r504588274", "bodyText": "Agree, I think an assert is better.\nThat will make sure we fail fast if we have logical bugs.", "author": "baldersheim", "createdAt": "2020-10-14T11:01:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUxNzY0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUyMTYxMQ==", "url": "https://github.com/vespa-engine/vespa/pull/14847#discussion_r504521611", "bodyText": "Extra indentation level intended?", "author": "vekterli", "createdAt": "2020-10-14T09:07:37Z", "path": "messagebus/src/vespa/messagebus/messenger.cpp", "diffHunk": "@@ -157,22 +156,23 @@ class DiscardRecurrentTasks : public SyncTask {\n namespace mbus {\n \n Messenger::Messenger(bool skip_request_thread, bool skip_reply_thread) :\n-    _monitor(),\n-    _pool(128000),\n-    _children(),\n-    _queue(),\n-    _closed(false),\n-    _skip_request_thread(skip_request_thread),\n-    _skip_reply_thread(skip_reply_thread)\n+        _lock(),\n+        _pool(128000),\n+        _children(),\n+        _queue(),\n+        _closed(false),\n+        _skip_request_thread(skip_request_thread),\n+        _skip_reply_thread(skip_reply_thread)", "originalCommit": "001bdf0053ba9cb02e20afcceb9d0f7ed63f1178", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU5MDY2NA==", "url": "https://github.com/vespa-engine/vespa/pull/14847#discussion_r504590664", "bodyText": "Oops, I guess clion played me a little trick...", "author": "baldersheim", "createdAt": "2020-10-14T11:06:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUyMTYxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUzNDA5MQ==", "url": "https://github.com/vespa-engine/vespa/pull/14847#discussion_r504534091", "bodyText": "Should this be == std::cv_status::timeout instead to have the same semantics as before?", "author": "vekterli", "createdAt": "2020-10-14T09:27:28Z", "path": "messagebus/src/vespa/messagebus/routablequeue.cpp", "diffHunk": "@@ -43,9 +44,9 @@ RoutableQueue::dequeue(duration timeout)\n {\n     steady_clock::time_point startTime = steady_clock::now();\n     duration left = timeout;\n-    vespalib::MonitorGuard guard(_monitor);\n+    std::unique_lock guard(_lock);\n     while (_queue.size() == 0 && left > duration::zero()) {\n-        if (!guard.wait(left) || _queue.size() > 0) {\n+        if ((_cond.wait_for(guard, left) == std::cv_status::no_timeout) || (_queue.size() > 0)) {", "originalCommit": "001bdf0053ba9cb02e20afcceb9d0f7ed63f1178", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU5MDI5Mw==", "url": "https://github.com/vespa-engine/vespa/pull/14847#discussion_r504590293", "bodyText": "Yes, good catch.", "author": "baldersheim", "createdAt": "2020-10-14T11:05:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUzNDA5MQ=="}], "type": "inlineReview"}, {"oid": "73871d40a7c2731a0e2ada3b8df1500c86023420", "url": "https://github.com/vespa-engine/vespa/commit/73871d40a7c2731a0e2ada3b8df1500c86023420", "message": "Assert instead of silently fix", "committedDate": "2020-10-14T11:03:56Z", "type": "commit"}, {"oid": "bd751971740a4a3b986fc73841a5c6283a0de6f3", "url": "https://github.com/vespa-engine/vespa/commit/bd751971740a4a3b986fc73841a5c6283a0de6f3", "message": "Reindent", "committedDate": "2020-10-14T11:04:36Z", "type": "commit"}, {"oid": "e243bfa017fa78db756edc3e90ee1ca06535340e", "url": "https://github.com/vespa-engine/vespa/commit/e243bfa017fa78db756edc3e90ee1ca06535340e", "message": "Fix inverted logic", "committedDate": "2020-10-14T11:05:09Z", "type": "commit"}]}