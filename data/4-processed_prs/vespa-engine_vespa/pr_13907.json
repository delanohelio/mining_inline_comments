{"pr_number": 13907, "pr_title": "Detect changed bucket space for document type.", "pr_createdAt": "2020-07-16T13:42:24Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/13907", "timeline": [{"oid": "4b656fd432dd5dec91d10d5ba3957ead6f4110f3", "url": "https://github.com/vespa-engine/vespa/commit/4b656fd432dd5dec91d10d5ba3957ead6f4110f3", "message": "Detect changed bucket space for document type.", "committedDate": "2020-07-16T13:23:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjMyMTA3OA==", "url": "https://github.com/vespa-engine/vespa/pull/13907#discussion_r456321078", "bodyText": "It could be helpful to mention in the log message that doing this in a running system has undefined behavior and that the process must therefore immediately restart.", "author": "vekterli", "createdAt": "2020-07-17T09:12:11Z", "path": "searchcore/src/vespa/searchcore/proton/server/proton_configurer.cpp", "diffHunk": "@@ -177,6 +180,13 @@ ProtonConfigurer::configureDocumentDB(const ProtonConfigSnapshot &configSnapshot\n     } else {\n         auto documentDB = dbitr->second.first.lock();\n         assert(documentDB);\n+        auto old_bucket_space = documentDB->getBucketSpace();\n+        if (bucketSpace != old_bucket_space) {\n+            vespalib::string old_bucket_space_name = document::FixedBucketSpaces::to_string(old_bucket_space);\n+            vespalib::string bucket_space_name = document::FixedBucketSpaces::to_string(bucketSpace);\n+            LOG(fatal, \"Bucket space for document type %s changed from %s to %s\", docTypeName.getName().c_str(), old_bucket_space_name.c_str(), bucket_space_name.c_str());", "originalCommit": "4b656fd432dd5dec91d10d5ba3957ead6f4110f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjMyNDY4NA==", "url": "https://github.com/vespa-engine/vespa/pull/13907#discussion_r456324684", "bodyText": "Yes, and that the restart will fix it.", "author": "geirst", "createdAt": "2020-07-17T09:19:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjMyMTA3OA=="}], "type": "inlineReview"}, {"oid": "f5116ccd4b414ff03f51697992f6a3bbfb0b2262", "url": "https://github.com/vespa-engine/vespa/commit/f5116ccd4b414ff03f51697992f6a3bbfb0b2262", "message": "Extend log message when bucket space for document type has changed.", "committedDate": "2020-07-17T09:49:12Z", "type": "commit"}]}