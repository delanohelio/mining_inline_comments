{"pr_number": 15168, "pr_title": "Arnej/add generic lambda ", "pr_createdAt": "2020-11-03T16:58:37Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/15168", "timeline": [{"oid": "225935b5b222542270661f2ba8cca97dc20b90b6", "url": "https://github.com/vespa-engine/vespa/commit/225935b5b222542270661f2ba8cca97dc20b90b6", "message": "add GenericLambda instruction", "committedDate": "2020-11-03T15:59:06Z", "type": "commit"}, {"oid": "1bb61817d751db52c6781ec7737dd083c9e9efad", "url": "https://github.com/vespa-engine/vespa/commit/1bb61817d751db52c6781ec7737dd083c9e9efad", "message": "export nodes belonging to inner lambdas", "committedDate": "2020-11-03T15:59:06Z", "type": "commit"}, {"oid": "ad8787ce2fe985bd5dd305280a1d7b07fab6504c", "url": "https://github.com/vespa-engine/vespa/commit/ad8787ce2fe985bd5dd305280a1d7b07fab6504c", "message": "test with simple factory also", "committedDate": "2020-11-03T15:59:06Z", "type": "commit"}, {"oid": "8d7b90f92866fb1d9f3be79f9f0393a2db76e972", "url": "https://github.com/vespa-engine/vespa/commit/8d7b90f92866fb1d9f3be79f9f0393a2db76e972", "message": "GC unused include", "committedDate": "2020-11-03T16:50:49Z", "type": "commit"}, {"oid": "cc1685fc5a2eaff414a78c0e1bfec5b43df2cc10", "url": "https://github.com/vespa-engine/vespa/commit/cc1685fc5a2eaff414a78c0e1bfec5b43df2cc10", "message": "use as<TensorLambda>", "committedDate": "2020-11-03T17:03:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM1Mjg0Ng==", "url": "https://github.com/vespa-engine/vespa/pull/15168#discussion_r517352846", "bodyText": "consider adding test of nested lambda type exporting", "author": "havardpe", "createdAt": "2020-11-04T13:45:57Z", "path": "eval/src/vespa/eval/eval/node_types.cpp", "diffHunk": "@@ -307,7 +307,13 @@ struct TypeExporter : public NodeTraverser {\n         : parent_type_map(parent_type_map_in),\n           exported_type_map(exported_type_map_out),\n           missing_cnt(0) {}\n-    bool open(const Node &) override { return true; }\n+    bool open(const Node &node) override {\n+        if (auto lambda = as<TensorLambda>(node)) {\n+            lambda->lambda().root().traverse(*this);", "originalCommit": "cc1685fc5a2eaff414a78c0e1bfec5b43df2cc10", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM1NTY3Mw==", "url": "https://github.com/vespa-engine/vespa/pull/15168#discussion_r517355673", "bodyText": "consider creating uninitialized array", "author": "havardpe", "createdAt": "2020-11-04T13:50:10Z", "path": "eval/src/vespa/eval/instruction/generic_lambda.cpp", "diffHunk": "@@ -0,0 +1,143 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#include \"generic_lambda.h\"\n+#include <vespa/eval/eval/llvm/compiled_function.h>\n+#include <vespa/eval/eval/llvm/compile_cache.h>\n+#include <assert.h>\n+\n+using namespace vespalib::eval::tensor_function;\n+\n+namespace vespalib::eval::instruction {\n+\n+using Instruction = InterpretedFunction::Instruction;\n+using State = InterpretedFunction::State;\n+\n+namespace {\n+\n+//-----------------------------------------------------------------------------\n+\n+bool step_labels(double *labels, const ValueType &type) {\n+    for (size_t idx = type.dimensions().size(); idx-- > 0; ) {\n+        if ((labels[idx] += 1.0) < type.dimensions()[idx].size) {\n+            return true;\n+        } else {\n+            labels[idx] = 0.0;\n+        }\n+    }\n+    return false;\n+}\n+\n+struct ParamProxy : public LazyParams {\n+    const std::vector<double> &labels;\n+    const LazyParams          &params;\n+    const std::vector<size_t> &bindings;\n+    ParamProxy(const std::vector<double> &labels_in, const LazyParams &params_in, const std::vector<size_t> &bindings_in)\n+        : labels(labels_in), params(params_in), bindings(bindings_in) {}\n+    const Value &resolve(size_t idx, Stash &stash) const override {\n+        if (idx < labels.size()) {\n+            return stash.create<DoubleValue>(labels[idx]);\n+        }\n+        return params.resolve(bindings[idx - labels.size()], stash);\n+    }\n+};\n+\n+//-----------------------------------------------------------------------------\n+\n+struct CompiledParams {\n+    const ValueType &result_type;\n+    const std::vector<size_t> &bindings;\n+    size_t num_cells;\n+    CompileCache::Token::UP token;\n+    CompiledParams(const Lambda &lambda) \n+        : result_type(lambda.result_type()),\n+          bindings(lambda.bindings()),\n+          num_cells(result_type.dense_subspace_size()),\n+          token(CompileCache::compile(lambda.lambda(), PassParams::ARRAY))\n+    {\n+        assert(lambda.lambda().num_params() == (result_type.dimensions().size() + bindings.size()));\n+    }\n+};\n+\n+template <typename CT>\n+void my_compiled_lambda_op(eval::InterpretedFunction::State &state, uint64_t param) {\n+    const CompiledParams &params = unwrap_param<CompiledParams>(param);\n+    std::vector<double> args(params.result_type.dimensions().size() + params.bindings.size(), 0.0);\n+    double *bind_next = &args[params.result_type.dimensions().size()];\n+    for (size_t binding: params.bindings) {\n+        *bind_next++ = state.params->resolve(binding, state.stash).as_double();\n+    }\n+    auto fun = params.token->get().get_function();\n+    ArrayRef<CT> dst_cells = state.stash.create_array<CT>(params.num_cells);", "originalCommit": "cc1685fc5a2eaff414a78c0e1bfec5b43df2cc10", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "45cbfe5b1f40caad53d28f936ada89cbcdbb4741", "url": "https://github.com/vespa-engine/vespa/commit/45cbfe5b1f40caad53d28f936ada89cbcdbb4741", "message": "use stash.create_uninitialized_array", "committedDate": "2020-11-04T14:25:14Z", "type": "commit"}, {"oid": "d88bbff8050f59d19b7cad81ae6067ab8b4c1636", "url": "https://github.com/vespa-engine/vespa/commit/d88bbff8050f59d19b7cad81ae6067ab8b4c1636", "message": "also add test of type exporting for inner lambdas", "committedDate": "2020-11-04T14:32:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5MzI2OA==", "url": "https://github.com/vespa-engine/vespa/pull/15168#discussion_r517393268", "bodyText": "should verify that outer is equal to types", "author": "havardpe", "createdAt": "2020-11-04T14:42:10Z", "path": "eval/src/tests/eval/tensor_lambda/tensor_lambda_test.cpp", "diffHunk": "@@ -215,4 +215,16 @@ TEST(\"require that type resolving also include nodes in the inner tensor lambda\n     EXPECT_EQUAL(types.get_type(*symbol).to_spec(), \"double\");\n }\n \n+TEST(\"require that type exporting also include nodes in the inner tensor lambda function\") {\n+    auto fun = Function::parse(\"tensor(x[2])(tensor(y[2])((x+y)+a){y:(x)})\");\n+    NodeTypes types(*fun, {ValueType::from_spec(\"double\")});\n+    const auto &root = fun->root();\n+    auto lambda = nodes::as<nodes::TensorLambda>(root);\n+    ASSERT_TRUE(lambda != nullptr);\n+    NodeTypes outer = types.export_types(root);", "originalCommit": "d88bbff8050f59d19b7cad81ae6067ab8b4c1636", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5MzY3NA==", "url": "https://github.com/vespa-engine/vespa/pull/15168#discussion_r517393674", "bodyText": "should also try to export the internal types of the inner lambda", "author": "havardpe", "createdAt": "2020-11-04T14:42:43Z", "path": "eval/src/tests/eval/tensor_lambda/tensor_lambda_test.cpp", "diffHunk": "@@ -215,4 +215,16 @@ TEST(\"require that type resolving also include nodes in the inner tensor lambda\n     EXPECT_EQUAL(types.get_type(*symbol).to_spec(), \"double\");\n }\n \n+TEST(\"require that type exporting also include nodes in the inner tensor lambda function\") {\n+    auto fun = Function::parse(\"tensor(x[2])(tensor(y[2])((x+y)+a){y:(x)})\");\n+    NodeTypes types(*fun, {ValueType::from_spec(\"double\")});\n+    const auto &root = fun->root();\n+    auto lambda = nodes::as<nodes::TensorLambda>(root);\n+    ASSERT_TRUE(lambda != nullptr);\n+    NodeTypes outer = types.export_types(root);\n+    ASSERT_TRUE(outer.errors().empty());\n+    NodeTypes inner = outer.export_types(lambda->lambda().root());\n+    EXPECT_TRUE(inner.errors().empty());\n+}", "originalCommit": "d88bbff8050f59d19b7cad81ae6067ab8b4c1636", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5OTA0MQ==", "url": "https://github.com/vespa-engine/vespa/pull/15168#discussion_r517399041", "bodyText": "we need to also bind our own type, unfortunately, removing return false is the simplest way, which is a bit confusing.", "author": "havardpe", "createdAt": "2020-11-04T14:50:01Z", "path": "eval/src/vespa/eval/eval/node_types.cpp", "diffHunk": "@@ -307,7 +307,13 @@ struct TypeExporter : public NodeTraverser {\n         : parent_type_map(parent_type_map_in),\n           exported_type_map(exported_type_map_out),\n           missing_cnt(0) {}\n-    bool open(const Node &) override { return true; }\n+    bool open(const Node &node) override {\n+        if (auto lambda = as<TensorLambda>(node)) {\n+            lambda->lambda().root().traverse(*this);\n+            return false;", "originalCommit": "d88bbff8050f59d19b7cad81ae6067ab8b4c1636", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8092b21022943489786fe27c02d4a79942382ee7", "url": "https://github.com/vespa-engine/vespa/commit/8092b21022943489786fe27c02d4a79942382ee7", "message": "fix lambda traversing and extend test", "committedDate": "2020-11-04T15:05:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkxODI5Nw==", "url": "https://github.com/vespa-engine/vespa/pull/15168#discussion_r517918297", "bodyText": "I would prefer something like count_types, since this is not really related to exporting", "author": "havardpe", "createdAt": "2020-11-05T09:46:22Z", "path": "eval/src/tests/eval/tensor_lambda/tensor_lambda_test.cpp", "diffHunk": "@@ -215,16 +215,31 @@ TEST(\"require that type resolving also include nodes in the inner tensor lambda\n     EXPECT_EQUAL(types.get_type(*symbol).to_spec(), \"double\");\n }\n \n+size_t num_exported(const NodeTypes &types) {", "originalCommit": "8092b21022943489786fe27c02d4a79942382ee7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a782057e6ef5105313dc2ffdee3ff00d0f670cf5", "url": "https://github.com/vespa-engine/vespa/commit/a782057e6ef5105313dc2ffdee3ff00d0f670cf5", "message": "rename method counting typed nodes", "committedDate": "2020-11-05T12:11:41Z", "type": "commit"}]}