{"pr_number": 11933, "pr_title": "More compact convergence output", "pr_createdAt": "2020-01-24T14:48:24Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/11933", "timeline": [{"oid": "59b7e6370223866905efb73089d489a134433223", "url": "https://github.com/vespa-engine/vespa/commit/59b7e6370223866905efb73089d489a134433223", "message": "Wipe certificates when writing runs to history", "committedDate": "2020-01-24T14:42:45Z", "type": "commit"}, {"oid": "918470b5362503a755622bf3261cb3d6108d93e9", "url": "https://github.com/vespa-engine/vespa/commit/918470b5362503a755622bf3261cb3d6108d93e9", "message": "Store instant since which no nodes were allowed to be down in run", "committedDate": "2020-01-24T14:42:45Z", "type": "commit"}, {"oid": "e2216c17ba105dc771043560ea4d7d1662b91d58", "url": "https://github.com/vespa-engine/vespa/commit/e2216c17ba105dc771043560ea4d7d1662b91d58", "message": "Store summary of convergence of application deployment in run", "committedDate": "2020-01-24T14:42:45Z", "type": "commit"}, {"oid": "4d786f7ad1214bc3fcb5b22b7ad3b15d3770907a", "url": "https://github.com/vespa-engine/vespa/commit/4d786f7ad1214bc3fcb5b22b7ad3b15d3770907a", "message": "Denser convergence log output", "committedDate": "2020-01-24T14:42:45Z", "type": "commit"}, {"oid": "2d10633b4c83bb0afb3279052ded58b9b60ffa73", "url": "https://github.com/vespa-engine/vespa/commit/2d10633b4c83bb0afb3279052ded58b9b60ffa73", "message": "Fix broken unit test", "committedDate": "2020-01-24T14:47:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY5NjgxOA==", "url": "https://github.com/vespa-engine/vespa/pull/11933#discussion_r370696818", "bodyText": "Oops. \ud83d\ude48", "author": "jonmv", "createdAt": "2020-01-24T15:36:43Z", "path": "controller-server/src/test/java/com/yahoo/vespa/hosted/controller/restapi/application/JobControllerApiHandlerHelperTest.java", "diffHunk": "@@ -182,6 +182,7 @@ public void testResponsesWithDirectDeployment() {\n     private void compare(HttpResponse response, String expected) throws JSONException, IOException {\n         ByteArrayOutputStream baos = new ByteArrayOutputStream();\n         response.render(baos);\n+        System.err.println(baos.toString());", "originalCommit": "2d10633b4c83bb0afb3279052ded58b9b60ffa73", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "867865729efe99dc2f5d9425056059d26061a7fc", "url": "https://github.com/vespa-engine/vespa/commit/867865729efe99dc2f5d9425056059d26061a7fc", "message": "Print convergence summary for unfinished, but started, convergence steps", "committedDate": "2020-01-24T15:42:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcyMDMxMQ==", "url": "https://github.com/vespa-engine/vespa/pull/11933#discussion_r370720311", "bodyText": "\"Number of suspended nodes with pending platform upgrade\"? E.g. we actually don't know whether a node is suspended because it plans to upgrade.", "author": "hakonhall", "createdAt": "2020-01-24T16:21:47Z", "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/deployment/ConvergenceSummary.java", "diffHunk": "@@ -0,0 +1,130 @@\n+// Copyright 2020 Oath Inc. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+package com.yahoo.vespa.hosted.controller.deployment;\n+\n+import java.util.Objects;\n+\n+/**\n+ * Summary of node and service status during a deployment job.\n+ *\n+ * @author jonmv\n+ */\n+public class ConvergenceSummary {\n+\n+    private final long nodes;\n+    private final long down;\n+    private final long upgradingOs;\n+    private final long needPlatformUpgrade;\n+    private final long upgradingPlatform;\n+    private final long needReboot;\n+    private final long rebooting;\n+    private final long needRestart;\n+    private final long restarting;\n+    private final long services;\n+    private final long needNewConfig;\n+\n+    public ConvergenceSummary(long nodes, long down, long upgradingOs, long needPlatformUpgrade, long upgradingPlatform,\n+                              long needReboot, long rebooting, long needRestart, long restarting, long services, long needNewConfig) {\n+        this.nodes = nodes;\n+        this.down = down;\n+        this.upgradingOs = upgradingOs;\n+        this.needPlatformUpgrade = needPlatformUpgrade;\n+        this.upgradingPlatform = upgradingPlatform;\n+        this.needReboot = needReboot;\n+        this.rebooting = rebooting;\n+        this.needRestart = needRestart;\n+        this.restarting = restarting;\n+        this.services = services;\n+        this.needNewConfig = needNewConfig;\n+    }\n+\n+    /** Number of nodes in the application. */\n+    public long nodes() {\n+        return nodes;\n+    }\n+\n+    /** Number of nodes allowed to be down. */\n+    public long down() {\n+        return down;\n+    }\n+\n+    /** Number of nodes down for OS upgrade. */\n+    public long upgradingOs() {\n+        return upgradingOs;\n+    }\n+\n+    /** Number of nodes in need of a platform upgrade. */\n+    public long needPlatformUpgrade() {\n+        return needPlatformUpgrade;\n+    }\n+\n+    /** Number of nodes down for platform upgrade. */", "originalCommit": "867865729efe99dc2f5d9425056059d26061a7fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcyMTgwNA==", "url": "https://github.com/vespa-engine/vespa/pull/11933#discussion_r370721804", "bodyText": "(I liked this message in the original, as it made it crystal clear I need to wait longer. But it could be this is superfluous with the other changes...)", "author": "hakonhall", "createdAt": "2020-01-24T16:24:48Z", "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/deployment/InternalStepRunner.java", "diffHunk": "@@ -320,24 +346,49 @@ else if (timedOut(id, deployment.get(), endpointTimeout)) {\n                 return Optional.of(error);\n             }\n         }\n+        controller.jobController().locked(id, lockedRun -> lockedRun.withSummary(summary));\n \n         if (timedOut(id, deployment.get(), installationTimeout)) {\n+            logger.log(nodeList.asList().stream()\n+                               .flatMap(node -> nodeDetails(node, true))\n+                               .collect(toList()));\n             logger.log(INFO, \"Installation failed to complete within \" + installationTimeout.toMinutes() + \" minutes!\");\n             return Optional.of(installationFailed);\n         }\n \n-        logger.log(\"Installation not yet complete.\");", "originalCommit": "867865729efe99dc2f5d9425056059d26061a7fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc3MjExMQ==", "url": "https://github.com/vespa-engine/vespa/pull/11933#discussion_r370772111", "bodyText": "Should be covered by the High-level status, indeed.", "author": "jonmv", "createdAt": "2020-01-24T18:16:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcyMTgwNA=="}], "type": "inlineReview"}]}