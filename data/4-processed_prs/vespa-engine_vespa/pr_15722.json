{"pr_number": 15722, "pr_title": "Add a force_insert method to the hash_table. It is faster as it skips\u2026", "pr_createdAt": "2020-12-07T14:19:20Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/15722", "timeline": [{"oid": "313875e52617ed3ba23cbe288ca69ff297a818a6", "url": "https://github.com/vespa-engine/vespa/commit/313875e52617ed3ba23cbe288ca69ff297a818a6", "message": "Add a force_insert method to the hash_table. It is faster as it skips the presence check and avoid equality compare.\nIt allows duplicates and should hence be used carefully.\nAt least resize will be faster as it it can safely be used there.", "committedDate": "2020-12-07T14:14:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU1MjA4OA==", "url": "https://github.com/vespa-engine/vespa/pull/15722#discussion_r537552088", "bodyText": "consider aliasing First to Select1st (use actual code instead of custom code that does the same)", "author": "havardpe", "createdAt": "2020-12-07T14:32:32Z", "path": "vespalib/src/tests/stllike/hashtable_test.cpp", "diffHunk": "@@ -73,6 +73,48 @@ TEST(\"require that hashtable<int> can be copied\") {\n     EXPECT_EQUAL(42, *table2.find(42));\n }\n \n+TEST(\"require that you can insert duplicates\") {\n+    using Pair = std::pair<int, vespalib::string>;\n+    using Map = hashtable<int, Pair, vespalib::hash<int>, std::equal_to<int>, First<int, Pair>>;", "originalCommit": "313875e52617ed3ba23cbe288ca69ff297a818a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYzNzQ5MQ==", "url": "https://github.com/vespa-engine/vespa/pull/15722#discussion_r537637491", "bodyText": "Done", "author": "baldersheim", "createdAt": "2020-12-07T16:20:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU1MjA4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU1NDg1MQ==", "url": "https://github.com/vespa-engine/vespa/pull/15722#discussion_r537554851", "bodyText": "should also verify that duplicates survive resizing", "author": "havardpe", "createdAt": "2020-12-07T14:36:11Z", "path": "vespalib/src/tests/stllike/hashtable_test.cpp", "diffHunk": "@@ -73,6 +73,48 @@ TEST(\"require that hashtable<int> can be copied\") {\n     EXPECT_EQUAL(42, *table2.find(42));\n }\n \n+TEST(\"require that you can insert duplicates\") {\n+    using Pair = std::pair<int, vespalib::string>;\n+    using Map = hashtable<int, Pair, vespalib::hash<int>, std::equal_to<int>, First<int, Pair>>;\n+\n+    Map m(1);\n+    EXPECT_EQUAL(0u, m.size());\n+    EXPECT_EQUAL(8u, m.capacity());\n+    auto res = m.insert(Pair(1, \"1\"));\n+    EXPECT_TRUE(res.second);\n+    EXPECT_EQUAL(1u, m.size());\n+    EXPECT_EQUAL(8u, m.capacity());\n+    res = m.insert(Pair(1, \"1.2\"));\n+    EXPECT_FALSE(res.second);\n+    auto found = m.find(1);\n+    ASSERT_TRUE(found != m.end());\n+    EXPECT_EQUAL(found->second, \"1\");\n+\n+    m.force_insert(Pair(1, \"1.2\"));\n+    EXPECT_EQUAL(2u, m.size());\n+    EXPECT_EQUAL(8u, m.capacity());\n+    m.force_insert(Pair(1, \"1.3\"));\n+    EXPECT_EQUAL(3u, m.size());\n+    EXPECT_EQUAL(16u, m.capacity());\n+    found = m.find(1);\n+    ASSERT_TRUE(found != m.end());\n+    EXPECT_EQUAL(found->second, \"1\");\n+\n+    m.erase(1);\n+    EXPECT_EQUAL(2u, m.size());\n+    EXPECT_EQUAL(16u, m.capacity());\n+    found = m.find(1);\n+    ASSERT_TRUE(found != m.end());\n+    EXPECT_EQUAL(found->second, \"1.3\");\n+\n+    m.erase(1);\n+    EXPECT_EQUAL(1u, m.size());\n+    EXPECT_EQUAL(16u, m.capacity());\n+    found = m.find(1);\n+    ASSERT_TRUE(found != m.end());\n+    EXPECT_EQUAL(found->second, \"1.2\");\n+}", "originalCommit": "313875e52617ed3ba23cbe288ca69ff297a818a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYzMDU5NA==", "url": "https://github.com/vespa-engine/vespa/pull/15722#discussion_r537630594", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-12-07T16:11:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU1NDg1MQ=="}], "type": "inlineReview"}, {"oid": "2c56085ba10570d063571d5aa4a68ee538e89612", "url": "https://github.com/vespa-engine/vespa/commit/2c56085ba10570d063571d5aa4a68ee538e89612", "message": "Expect that all are present after resize too.", "committedDate": "2020-12-07T16:08:17Z", "type": "commit"}, {"oid": "467b6fed9bbb7034f81b3b4ecbc3417911afdc18", "url": "https://github.com/vespa-engine/vespa/commit/467b6fed9bbb7034f81b3b4ecbc3417911afdc18", "message": "Use Select1st", "committedDate": "2020-12-07T16:19:43Z", "type": "commit"}]}