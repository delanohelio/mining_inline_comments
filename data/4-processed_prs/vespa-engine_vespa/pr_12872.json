{"pr_number": 12872, "pr_title": "add unit tests for HnswIndex::get_state()", "pr_createdAt": "2020-04-08T08:03:10Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/12872", "timeline": [{"oid": "91e0020981c6ebfedf7db7f9975f780001d05cce", "url": "https://github.com/vespa-engine/vespa/commit/91e0020981c6ebfedf7db7f9975f780001d05cce", "message": "add unit tests for HnswIndex::get_state()", "committedDate": "2020-04-08T07:50:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ1ODg2MA==", "url": "https://github.com/vespa-engine/vespa/pull/12872#discussion_r405458860", "bodyText": "Consider checking number of nodes with 1 outgoing link at level 0 as well (root[\"level_0_links_histogram\"][1])", "author": "geirst", "createdAt": "2020-04-08T11:39:36Z", "path": "searchlib/src/tests/tensor/hnsw_index/hnsw_index_test.cpp", "diffHunk": "@@ -293,6 +297,19 @@ TEST_F(HnswIndexTest, 2d_vectors_inserted_in_hierarchic_graph_with_heuristic_sel\n     expect_level_0(5, {2, 6});\n     expect_levels(6, {{2, 5, 7}, {3}, {}});\n     expect_level_0(7, {3, 6});\n+    {\n+        Slime actualSlime;\n+        SlimeInserter inserter(actualSlime);\n+        index->get_state(inserter);\n+        const auto &root = actualSlime.get();\n+        EXPECT_EQ(0, root[\"memory_usage\"][\"onHold\"].asLong());\n+        EXPECT_EQ(8, root[\"nodes\"].asLong());\n+        EXPECT_EQ(7, root[\"valid_nodes\"].asLong());\n+        EXPECT_EQ(0, root[\"level_histogram\"][0].asLong());\n+        EXPECT_EQ(5, root[\"level_histogram\"][1].asLong());\n+        EXPECT_EQ(0, root[\"level_0_links_histogram\"][0].asLong());", "originalCommit": "91e0020981c6ebfedf7db7f9975f780001d05cce", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ1OTAwMA==", "url": "https://github.com/vespa-engine/vespa/pull/12872#discussion_r405459000", "bodyText": "Consider checking number of nodes with 1 outgoing link at level 0 as well (root[\"level_0_links_histogram\"][1])", "author": "geirst", "createdAt": "2020-04-08T11:39:48Z", "path": "searchlib/src/tests/tensor/hnsw_index/hnsw_index_test.cpp", "diffHunk": "@@ -305,6 +322,19 @@ TEST_F(HnswIndexTest, 2d_vectors_inserted_in_hierarchic_graph_with_heuristic_sel\n     expect_level_0(5, {2, 6});\n     expect_levels(6, {{2, 5, 7}, {3}, {}});\n     expect_level_0(7, {3, 6});\n+    {\n+        Slime actualSlime;\n+        SlimeInserter inserter(actualSlime);\n+        index->get_state(inserter);\n+        const auto &root = actualSlime.get();\n+        EXPECT_EQ(0, root[\"memory_usage\"][\"onHold\"].asLong());\n+        EXPECT_EQ(8, root[\"nodes\"].asLong());\n+        EXPECT_EQ(6, root[\"valid_nodes\"].asLong());\n+        EXPECT_EQ(0, root[\"level_histogram\"][0].asLong());\n+        EXPECT_EQ(4, root[\"level_histogram\"][1].asLong());\n+        EXPECT_EQ(0, root[\"level_0_links_histogram\"][0].asLong());", "originalCommit": "91e0020981c6ebfedf7db7f9975f780001d05cce", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "921203ba11357efeeeefcdf0f7cebeae2bc75092", "url": "https://github.com/vespa-engine/vespa/commit/921203ba11357efeeeefcdf0f7cebeae2bc75092", "message": "unit test links histogram better", "committedDate": "2020-04-08T19:44:13Z", "type": "commit"}]}