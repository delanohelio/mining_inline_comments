{"pr_number": 13412, "pr_title": "Arnej/create filter in intermediates", "pr_createdAt": "2020-05-28T08:39:39Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/13412", "timeline": [{"oid": "ec94e96642e4068f173e1063badc92da8b17366f", "url": "https://github.com/vespa-engine/vespa/commit/ec94e96642e4068f173e1063badc92da8b17366f", "message": "implement createFilterSearch in basic intermediate blueprints", "committedDate": "2020-05-28T08:16:59Z", "type": "commit"}, {"oid": "ce1d1e4a5f6b314f937ce1713b9fee5c21427192", "url": "https://github.com/vespa-engine/vespa/commit/ce1d1e4a5f6b314f937ce1713b9fee5c21427192", "message": "add multiline regex option", "committedDate": "2020-05-28T08:16:59Z", "type": "commit"}, {"oid": "18022457c4a6424d7b08eb9ec6d18d42885b8410", "url": "https://github.com/vespa-engine/vespa/commit/18022457c4a6424d7b08eb9ec6d18d42885b8410", "message": "extend SimpleBlueprint: add createFilterSearch that tags iterator", "committedDate": "2020-05-28T08:17:00Z", "type": "commit"}, {"oid": "e68078428d1b48bbae8bfefad572b7221b862b37", "url": "https://github.com/vespa-engine/vespa/commit/e68078428d1b48bbae8bfefad572b7221b862b37", "message": "test createFilterSearch in basic intermediate blueprints", "committedDate": "2020-05-28T08:17:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY3OTczOA==", "url": "https://github.com/vespa-engine/vespa/pull/13412#discussion_r431679738", "bodyText": "According to the RE2 docs, set_dot_nl(bool) has the behavior \"dot matches everything including new line\". Maybe we should call this DotMatchesNewline instead to be explicit that this does not trigger any changes to how anchors work etc? MultiLine might imply some different semantics than what is currently in place.", "author": "vekterli", "createdAt": "2020-05-28T08:48:28Z", "path": "vespalib/src/vespa/vespalib/regex/regex.h", "diffHunk": "@@ -44,7 +44,8 @@ class Regex {\n     // TODO consider using type-safe parameter instead.\n     enum Options {\n         None       = 0,\n-        IgnoreCase = 1\n+        IgnoreCase = 1,\n+        MultiLine  = 2", "originalCommit": "e68078428d1b48bbae8bfefad572b7221b862b37", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY4MTcwNQ==", "url": "https://github.com/vespa-engine/vespa/pull/13412#discussion_r431681705", "bodyText": "all EXPECT macros also return whether the check was successful, so the above if could check the EXPECT_TRUE result instead.", "author": "havardpe", "createdAt": "2020-05-28T08:51:50Z", "path": "searchlib/src/tests/queryeval/queryeval.cpp", "diffHunk": "@@ -213,6 +217,16 @@ TEST(\"test that non-strict andnot search does NOT forward to its greedy first ch\n     EXPECT_TRUE(nullptr != search->andWith(std::move(filter), 8).get());\n }\n \n+void expect_match(std::string input, std::string regexp) {\n+    using vespalib::Regex;\n+    Regex pattern = Regex::from_pattern(regexp, Regex::Options::MultiLine);\n+    if (! pattern.partial_match(input)) {\n+        fprintf(stderr, \"no match for pattern: >>>%s<<< in input:\\n>>>\\n%s\\n<<<\\n\",\n+                regexp.c_str(), input.c_str());\n+    }\n+    EXPECT_TRUE(pattern.partial_match(input));", "originalCommit": "e68078428d1b48bbae8bfefad572b7221b862b37", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY4ODIyOA==", "url": "https://github.com/vespa-engine/vespa/pull/13412#discussion_r431688228", "bodyText": "consider using inheritStrict for consistency", "author": "havardpe", "createdAt": "2020-05-28T09:02:41Z", "path": "searchlib/src/vespa/searchlib/queryeval/intermediate_blueprints.cpp", "diffHunk": "@@ -320,6 +363,19 @@ OrBlueprint::createIntermediateSearch(const MultiSearch::Children &subSearches,\n     return SearchIterator::UP(OrSearch::create(subSearches, strict, unpackInfo));\n }\n \n+SearchIterator::UP\n+OrBlueprint::createFilterSearch(bool strict, FilterConstraint constraint) const\n+{\n+    MultiSearch::Children subSearches;\n+    subSearches.reserve(childCnt());\n+    for (size_t i = 0; i < childCnt(); ++i) {\n+        auto search = getChild(i).createFilterSearch(strict, constraint);", "originalCommit": "e68078428d1b48bbae8bfefad572b7221b862b37", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTc0MTI1Nw==", "url": "https://github.com/vespa-engine/vespa/pull/13412#discussion_r431741257", "bodyText": "Consider snake_case for consistency (e.g. child_strict is used further down).", "author": "geirst", "createdAt": "2020-05-28T10:38:03Z", "path": "searchlib/src/vespa/searchlib/queryeval/intermediate_blueprints.cpp", "diffHunk": "@@ -168,6 +168,33 @@ AndNotBlueprint::createIntermediateSearch(const MultiSearch::Children &subSearch\n     return SearchIterator::UP(AndNotSearch::create(subSearches, strict));\n }\n \n+namespace {\n+Blueprint::FilterConstraint invert(Blueprint::FilterConstraint constraint) {\n+    if (constraint == Blueprint::FilterConstraint::UPPER_BOUND) {\n+        return Blueprint::FilterConstraint::LOWER_BOUND;\n+    }\n+    if (constraint == Blueprint::FilterConstraint::LOWER_BOUND) {\n+        return Blueprint::FilterConstraint::UPPER_BOUND;\n+    }\n+    abort();\n+}\n+} // namespace <unnamed>\n+\n+SearchIterator::UP\n+AndNotBlueprint::createFilterSearch(bool strict, FilterConstraint constraint) const\n+{\n+    MultiSearch::Children subSearches;", "originalCommit": "ec94e96642e4068f173e1063badc92da8b17366f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTc0MTQzMg==", "url": "https://github.com/vespa-engine/vespa/pull/13412#discussion_r431741432", "bodyText": "Consider snake_case for consistency.", "author": "geirst", "createdAt": "2020-05-28T10:38:24Z", "path": "searchlib/src/vespa/searchlib/queryeval/intermediate_blueprints.cpp", "diffHunk": "@@ -243,6 +270,22 @@ AndBlueprint::createIntermediateSearch(const MultiSearch::Children &subSearches,\n     return SearchIterator::UP(search);\n }\n \n+SearchIterator::UP\n+AndBlueprint::createFilterSearch(bool strict, FilterConstraint constraint) const\n+{\n+    MultiSearch::Children subSearches;", "originalCommit": "ec94e96642e4068f173e1063badc92da8b17366f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTc0MTQ3NA==", "url": "https://github.com/vespa-engine/vespa/pull/13412#discussion_r431741474", "bodyText": "Consider snake_case for consistency.", "author": "geirst", "createdAt": "2020-05-28T10:38:29Z", "path": "searchlib/src/vespa/searchlib/queryeval/intermediate_blueprints.cpp", "diffHunk": "@@ -243,6 +270,22 @@ AndBlueprint::createIntermediateSearch(const MultiSearch::Children &subSearches,\n     return SearchIterator::UP(search);\n }\n \n+SearchIterator::UP\n+AndBlueprint::createFilterSearch(bool strict, FilterConstraint constraint) const\n+{\n+    MultiSearch::Children subSearches;\n+    subSearches.reserve(childCnt());\n+    for (size_t i = 0; i < childCnt(); ++i) {\n+        bool child_strict = strict && inheritStrict(i);\n+        auto search = getChild(i).createFilterSearch(child_strict, constraint);\n+        subSearches.push_back(search.release());\n+    }\n+    UnpackInfo unpackInfo;", "originalCommit": "ec94e96642e4068f173e1063badc92da8b17366f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "aef6f8956f85f0ab76735456225bdb5af1b516a2", "url": "https://github.com/vespa-engine/vespa/commit/aef6f8956f85f0ab76735456225bdb5af1b516a2", "message": "rename regex option MultiLine -> DotMatchesNewline", "committedDate": "2020-05-28T11:17:01Z", "type": "commit"}, {"oid": "d2cec706ee0f3511ed2b6d40ca392563b59fa291", "url": "https://github.com/vespa-engine/vespa/commit/d2cec706ee0f3511ed2b6d40ca392563b59fa291", "message": "use snake_case more", "committedDate": "2020-05-28T11:23:21Z", "type": "commit"}]}