{"pr_number": 11958, "pr_title": "add various validation of endpoint certificates", "pr_createdAt": "2020-01-27T10:17:44Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/11958", "timeline": [{"oid": "2911962cef11affacba3a355ace91cb2ff46127b", "url": "https://github.com/vespa-engine/vespa/commit/2911962cef11affacba3a355ace91cb2ff46127b", "message": "add various validation of endpoint certificates", "committedDate": "2020-01-27T10:09:58Z", "type": "commit"}, {"oid": "42d9ece77530bd4a803677f62380e41462d37b50", "url": "https://github.com/vespa-engine/vespa/commit/42d9ece77530bd4a803677f62380e41462d37b50", "message": "move endpoint certificate handling out of applicationcontroller", "committedDate": "2020-01-27T11:50:47Z", "type": "commit"}, {"oid": "9e4b9422124073188f9aab1c0498f9fd04f6c8c1", "url": "https://github.com/vespa-engine/vespa/commit/9e4b9422124073188f9aab1c0498f9fd04f6c8c1", "message": "set up mocked unit test", "committedDate": "2020-01-27T13:45:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTI1MjUwNg==", "url": "https://github.com/vespa-engine/vespa/pull/11958#discussion_r371252506", "bodyText": "log?", "author": "tokle", "createdAt": "2020-01-27T13:56:41Z", "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/endpointcertificates/EndpointCertificateManager.java", "diffHunk": "@@ -0,0 +1,146 @@\n+package com.yahoo.vespa.hosted.controller.endpointcertificates;\n+\n+import com.yahoo.config.provision.ApplicationId;\n+import com.yahoo.config.provision.ClusterSpec;\n+import com.yahoo.config.provision.zone.ZoneApi;\n+import com.yahoo.config.provision.zone.ZoneId;\n+import com.yahoo.container.jdisc.secretstore.SecretStore;\n+import com.yahoo.log.LogLevel;\n+import com.yahoo.security.SubjectAlternativeName;\n+import com.yahoo.security.X509CertificateUtils;\n+import com.yahoo.vespa.hosted.controller.Instance;\n+import com.yahoo.vespa.hosted.controller.api.integration.certificates.ApplicationCertificate;\n+import com.yahoo.vespa.hosted.controller.api.integration.certificates.ApplicationCertificateProvider;\n+import com.yahoo.vespa.hosted.controller.api.integration.certificates.EndpointCertificateMetadata;\n+import com.yahoo.vespa.hosted.controller.api.integration.zone.ZoneRegistry;\n+import com.yahoo.vespa.hosted.controller.application.Endpoint;\n+import com.yahoo.vespa.hosted.controller.application.EndpointId;\n+import com.yahoo.vespa.hosted.controller.persistence.CuratorDb;\n+import com.yahoo.vespa.hosted.controller.persistence.EndpointCertificateMetadataSerializer;\n+\n+import java.security.cert.X509Certificate;\n+import java.time.Clock;\n+import java.time.Instant;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+public class EndpointCertificateManager {\n+\n+    private static final Logger log = Logger.getLogger(EndpointCertificateManager.class.getName());\n+\n+    private final ZoneRegistry zoneRegistry;\n+    private final CuratorDb curator;\n+    private final SecretStore secretStore;\n+    private final ApplicationCertificateProvider applicationCertificateProvider;\n+    private final Clock clock;\n+\n+    public EndpointCertificateManager(ZoneRegistry zoneRegistry,\n+                                      CuratorDb curator,\n+                                      SecretStore secretStore,\n+                                      ApplicationCertificateProvider applicationCertificateProvider,\n+                                      Clock clock) {\n+        this.zoneRegistry = zoneRegistry;\n+        this.curator = curator;\n+        this.secretStore = secretStore;\n+        this.applicationCertificateProvider = applicationCertificateProvider;\n+        this.clock = clock;\n+    }\n+\n+    public Optional<EndpointCertificateMetadata> getEndpointCertificateMetadata(Instance instance, ZoneId zone) {\n+\n+        if (!zoneRegistry.zones().directlyRouted().ids().contains(zone)) return Optional.empty();\n+\n+        // Re-use certificate if already provisioned\n+        Optional<EndpointCertificateMetadata> endpointCertificateMetadata =\n+                curator.readEndpointCertificateMetadata(instance.id())\n+                        .or(() -> Optional.of(provisionEndpointCertificate(instance)));\n+\n+        // Only logs warnings for now\n+        endpointCertificateMetadata.ifPresent(certificateMetadata -> verifyEndpointCertificate(certificateMetadata, instance, zone));\n+\n+        return endpointCertificateMetadata;\n+    }\n+\n+    private EndpointCertificateMetadata provisionEndpointCertificate(Instance instance) {\n+        List<ZoneId> directlyRoutedZones = zoneRegistry.zones().directlyRouted().zones().stream().map(ZoneApi::getId).collect(Collectors.toUnmodifiableList());\n+        ApplicationCertificate newCertificate = applicationCertificateProvider\n+                .requestCaSignedCertificate(instance.id(), dnsNamesOf(instance.id(), directlyRoutedZones));\n+        EndpointCertificateMetadata provisionedCertificateMetadata = EndpointCertificateMetadataSerializer.fromTlsSecretsKeysString(newCertificate.secretsKeyNamePrefix());\n+        curator.writeEndpointCertificateMetadata(instance.id(), provisionedCertificateMetadata);\n+        return provisionedCertificateMetadata;\n+    }\n+\n+    private boolean verifyEndpointCertificate(EndpointCertificateMetadata endpointCertificateMetadata, Instance instance, ZoneId zone) {\n+        try {\n+            var pemEncodedEndpointCertificate = secretStore.getSecret(endpointCertificateMetadata.certName(), endpointCertificateMetadata.version());\n+\n+            if (pemEncodedEndpointCertificate == null) return logWarning(\"Certificate not found in secret store\");\n+\n+            List<X509Certificate> x509CertificateList = X509CertificateUtils.certificateListFromPem(pemEncodedEndpointCertificate);\n+\n+            if (x509CertificateList.isEmpty()) return logWarning(\"Empty certificate list\");\n+            if (x509CertificateList.size() < 2)\n+                return logWarning(\"Only a single certificate found in chain - intermediate certificates likely missing\");\n+\n+            Instant now = clock.instant();\n+            Instant firstExpiry = Instant.MAX;\n+            for (X509Certificate x509Certificate : x509CertificateList) {\n+                Instant notBefore = x509Certificate.getNotBefore().toInstant();\n+                Instant notAfter = x509Certificate.getNotAfter().toInstant();\n+                if (now.isBefore(notBefore)) return logWarning(\"Certificate is not yet valid\");\n+                if (now.isAfter(notAfter)) return logWarning(\"Certificate has expired\");\n+                if (notAfter.isBefore(firstExpiry)) firstExpiry = notAfter;\n+            }\n+\n+            X509Certificate endEntityCertificate = x509CertificateList.get(0);\n+            List<String> subjectAlternativeNames = X509CertificateUtils.getSubjectAlternativeNames(endEntityCertificate).stream()\n+                    .filter(san -> san.getType().equals(SubjectAlternativeName.Type.DNS_NAME))\n+                    .map(SubjectAlternativeName::getValue).collect(Collectors.toList());\n+\n+            System.out.println(subjectAlternativeNames);", "originalCommit": "9e4b9422124073188f9aab1c0498f9fd04f6c8c1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTI1MzAwMQ==", "url": "https://github.com/vespa-engine/vespa/pull/11958#discussion_r371253001", "bodyText": "Perhaps also check that the certificate does not contain any additional  SAN DNS values?", "author": "tokle", "createdAt": "2020-01-27T13:57:40Z", "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/endpointcertificates/EndpointCertificateManager.java", "diffHunk": "@@ -0,0 +1,146 @@\n+package com.yahoo.vespa.hosted.controller.endpointcertificates;\n+\n+import com.yahoo.config.provision.ApplicationId;\n+import com.yahoo.config.provision.ClusterSpec;\n+import com.yahoo.config.provision.zone.ZoneApi;\n+import com.yahoo.config.provision.zone.ZoneId;\n+import com.yahoo.container.jdisc.secretstore.SecretStore;\n+import com.yahoo.log.LogLevel;\n+import com.yahoo.security.SubjectAlternativeName;\n+import com.yahoo.security.X509CertificateUtils;\n+import com.yahoo.vespa.hosted.controller.Instance;\n+import com.yahoo.vespa.hosted.controller.api.integration.certificates.ApplicationCertificate;\n+import com.yahoo.vespa.hosted.controller.api.integration.certificates.ApplicationCertificateProvider;\n+import com.yahoo.vespa.hosted.controller.api.integration.certificates.EndpointCertificateMetadata;\n+import com.yahoo.vespa.hosted.controller.api.integration.zone.ZoneRegistry;\n+import com.yahoo.vespa.hosted.controller.application.Endpoint;\n+import com.yahoo.vespa.hosted.controller.application.EndpointId;\n+import com.yahoo.vespa.hosted.controller.persistence.CuratorDb;\n+import com.yahoo.vespa.hosted.controller.persistence.EndpointCertificateMetadataSerializer;\n+\n+import java.security.cert.X509Certificate;\n+import java.time.Clock;\n+import java.time.Instant;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+public class EndpointCertificateManager {\n+\n+    private static final Logger log = Logger.getLogger(EndpointCertificateManager.class.getName());\n+\n+    private final ZoneRegistry zoneRegistry;\n+    private final CuratorDb curator;\n+    private final SecretStore secretStore;\n+    private final ApplicationCertificateProvider applicationCertificateProvider;\n+    private final Clock clock;\n+\n+    public EndpointCertificateManager(ZoneRegistry zoneRegistry,\n+                                      CuratorDb curator,\n+                                      SecretStore secretStore,\n+                                      ApplicationCertificateProvider applicationCertificateProvider,\n+                                      Clock clock) {\n+        this.zoneRegistry = zoneRegistry;\n+        this.curator = curator;\n+        this.secretStore = secretStore;\n+        this.applicationCertificateProvider = applicationCertificateProvider;\n+        this.clock = clock;\n+    }\n+\n+    public Optional<EndpointCertificateMetadata> getEndpointCertificateMetadata(Instance instance, ZoneId zone) {\n+\n+        if (!zoneRegistry.zones().directlyRouted().ids().contains(zone)) return Optional.empty();\n+\n+        // Re-use certificate if already provisioned\n+        Optional<EndpointCertificateMetadata> endpointCertificateMetadata =\n+                curator.readEndpointCertificateMetadata(instance.id())\n+                        .or(() -> Optional.of(provisionEndpointCertificate(instance)));\n+\n+        // Only logs warnings for now\n+        endpointCertificateMetadata.ifPresent(certificateMetadata -> verifyEndpointCertificate(certificateMetadata, instance, zone));\n+\n+        return endpointCertificateMetadata;\n+    }\n+\n+    private EndpointCertificateMetadata provisionEndpointCertificate(Instance instance) {\n+        List<ZoneId> directlyRoutedZones = zoneRegistry.zones().directlyRouted().zones().stream().map(ZoneApi::getId).collect(Collectors.toUnmodifiableList());\n+        ApplicationCertificate newCertificate = applicationCertificateProvider\n+                .requestCaSignedCertificate(instance.id(), dnsNamesOf(instance.id(), directlyRoutedZones));\n+        EndpointCertificateMetadata provisionedCertificateMetadata = EndpointCertificateMetadataSerializer.fromTlsSecretsKeysString(newCertificate.secretsKeyNamePrefix());\n+        curator.writeEndpointCertificateMetadata(instance.id(), provisionedCertificateMetadata);\n+        return provisionedCertificateMetadata;\n+    }\n+\n+    private boolean verifyEndpointCertificate(EndpointCertificateMetadata endpointCertificateMetadata, Instance instance, ZoneId zone) {\n+        try {\n+            var pemEncodedEndpointCertificate = secretStore.getSecret(endpointCertificateMetadata.certName(), endpointCertificateMetadata.version());\n+\n+            if (pemEncodedEndpointCertificate == null) return logWarning(\"Certificate not found in secret store\");\n+\n+            List<X509Certificate> x509CertificateList = X509CertificateUtils.certificateListFromPem(pemEncodedEndpointCertificate);\n+\n+            if (x509CertificateList.isEmpty()) return logWarning(\"Empty certificate list\");\n+            if (x509CertificateList.size() < 2)\n+                return logWarning(\"Only a single certificate found in chain - intermediate certificates likely missing\");\n+\n+            Instant now = clock.instant();\n+            Instant firstExpiry = Instant.MAX;\n+            for (X509Certificate x509Certificate : x509CertificateList) {\n+                Instant notBefore = x509Certificate.getNotBefore().toInstant();\n+                Instant notAfter = x509Certificate.getNotAfter().toInstant();\n+                if (now.isBefore(notBefore)) return logWarning(\"Certificate is not yet valid\");\n+                if (now.isAfter(notAfter)) return logWarning(\"Certificate has expired\");\n+                if (notAfter.isBefore(firstExpiry)) firstExpiry = notAfter;\n+            }\n+\n+            X509Certificate endEntityCertificate = x509CertificateList.get(0);\n+            List<String> subjectAlternativeNames = X509CertificateUtils.getSubjectAlternativeNames(endEntityCertificate).stream()\n+                    .filter(san -> san.getType().equals(SubjectAlternativeName.Type.DNS_NAME))\n+                    .map(SubjectAlternativeName::getValue).collect(Collectors.toList());\n+\n+            System.out.println(subjectAlternativeNames);\n+\n+            if (!subjectAlternativeNames.containsAll(dnsNamesOf(instance.id(), List.of(zone))))", "originalCommit": "9e4b9422124073188f9aab1c0498f9fd04f6c8c1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a6769f64b639152760d84ed4e6f3300f1f83d90b", "url": "https://github.com/vespa-engine/vespa/commit/a6769f64b639152760d84ed4e6f3300f1f83d90b", "message": "stricter SAN verification", "committedDate": "2020-01-27T14:17:15Z", "type": "commit"}, {"oid": "0a8a46202e974a853dd6690c9359a3d26450dd89", "url": "https://github.com/vespa-engine/vespa/commit/0a8a46202e974a853dd6690c9359a3d26450dd89", "message": "stricter SAN verification 2", "committedDate": "2020-01-27T14:18:17Z", "type": "commit"}]}