{"pr_number": 13113, "pr_title": "- Add async interface to put", "pr_createdAt": "2020-04-29T14:19:18Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/13113", "timeline": [{"oid": "eb7b71781ca079b5577a13b300beafee388bc1ce", "url": "https://github.com/vespa-engine/vespa/commit/eb7b71781ca079b5577a13b300beafee388bc1ce", "message": "- Add async interface to put\n- Use MessageTracker for keeping context.\n- implement putAsync, but still use it synchronously.", "committedDate": "2020-04-29T14:14:03Z", "type": "commit"}, {"oid": "e3da8487f35e6ff4ea65f27ba6f3e1bcb89d32a2", "url": "https://github.com/vespa-engine/vespa/commit/e3da8487f35e6ff4ea65f27ba6f3e1bcb89d32a2", "message": "Move error checking to tracker.", "committedDate": "2020-04-29T18:55:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzgxNTgwNg==", "url": "https://github.com/vespa-engine/vespa/pull/13113#discussion_r417815806", "bodyText": "Consider adding class description.", "author": "geirst", "createdAt": "2020-04-30T07:40:24Z", "path": "searchcore/src/vespa/searchcore/proton/common/feedtoken.h", "diffHunk": "@@ -15,36 +15,53 @@ typedef std::unique_ptr<storage::spi::Result> ResultUP;\n  * instance of this class is passed to every invokation of the IFeedHandler.\n  */\n namespace feedtoken {\n-    class ITransport {\n-    public:\n-        virtual ~ITransport() { }\n-        virtual void send(ResultUP result, bool documentWasFound) = 0;\n-    };\n-\n-    class State : public search::IDestructorCallback {\n-    public:\n-        State(const State &) = delete;\n-        State & operator = (const State &) = delete;\n-        State(ITransport & transport);\n-        ~State() override;\n-        void fail();\n-        void setResult(ResultUP result, bool documentWasFound) {\n-            _documentWasFound = documentWasFound;\n-            _result = std::move(result);\n-        }\n-        const storage::spi::Result &getResult() { return *_result; }\n-    private:\n-        void ack();\n-        ITransport           &_transport;\n-        ResultUP              _result;\n-        bool                  _documentWasFound;\n-        std::atomic<bool>     _alreadySent;\n-    };\n-\n-    inline std::shared_ptr<State>\n-    make(ITransport & latch) {\n-        return std::make_shared<State>(latch);\n+\n+class ITransport {\n+public:\n+    virtual ~ITransport() { }\n+    virtual void send(ResultUP result, bool documentWasFound) = 0;\n+};\n+\n+class State : public search::IDestructorCallback {\n+public:\n+    State(const State &) = delete;\n+    State & operator = (const State &) = delete;\n+    State(ITransport & transport);\n+    ~State() override;\n+    void fail();\n+    void setResult(ResultUP result, bool documentWasFound) {\n+        _documentWasFound = documentWasFound;\n+        _result = std::move(result);\n     }\n+    const storage::spi::Result &getResult() { return *_result; }\n+protected:\n+    void ack();\n+private:\n+    ITransport           &_transport;\n+    ResultUP              _result;\n+    bool                  _documentWasFound;\n+    std::atomic<bool>     _alreadySent;\n+};\n+class OwningState : public State {", "originalCommit": "eb7b71781ca079b5577a13b300beafee388bc1ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk3ODQ4Ng==", "url": "https://github.com/vespa-engine/vespa/pull/13113#discussion_r417978486", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-04-30T12:39:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzgxNTgwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzgxODM3Mg==", "url": "https://github.com/vespa-engine/vespa/pull/13113#discussion_r417818372", "bodyText": "Consider adding a reference to the lock to ensure that we don't call this when the lock is not taken.", "author": "geirst", "createdAt": "2020-04-30T07:45:12Z", "path": "searchcore/src/vespa/searchcore/proton/persistenceengine/transport_latch.cpp", "diffHunk": "@@ -8,10 +8,50 @@ using storage::spi::Result;\n \n namespace proton {\n \n+std::unique_ptr<std::mutex> createOptionalLock(bool needLocking) {\n+    return needLocking\n+        ? std::make_unique<std::mutex>()\n+        : std::unique_ptr<std::mutex>();\n+}\n+TransportMerger::TransportMerger(bool needLocking)\n+    : _result(),\n+      _lock(createOptionalLock(needLocking))\n+{\n+}\n+TransportMerger::~TransportMerger() = default;\n+\n+void\n+TransportMerger::mergeResult(ResultUP result, bool documentWasFound) {\n+    if (_lock) {\n+        std::lock_guard<std::mutex> guard(*_lock);\n+        mergeWithLock(std::move(result), documentWasFound);\n+    } else {\n+        mergeWithLock(std::move(result), documentWasFound);\n+    }\n+}\n+\n+void\n+TransportMerger::mergeWithLock(ResultUP result, bool documentWasFound) {", "originalCommit": "eb7b71781ca079b5577a13b300beafee388bc1ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk4MTE4MA==", "url": "https://github.com/vespa-engine/vespa/pull/13113#discussion_r417981180", "bodyText": "I did not do that sine the lock is optional.", "author": "baldersheim", "createdAt": "2020-04-30T12:44:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzgxODM3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzgxODkzMQ==", "url": "https://github.com/vespa-engine/vespa/pull/13113#discussion_r417818931", "bodyText": "Is class comment still correct?", "author": "geirst", "createdAt": "2020-04-30T07:46:16Z", "path": "searchcore/src/vespa/searchcore/proton/persistenceengine/transport_latch.h", "diffHunk": "@@ -13,18 +13,33 @@ namespace proton {\n  * Implementation of FeedToken::ITransport for handling the async reply for an operation.\n  * Uses an internal count down latch to keep track the number of outstanding replies.\n  */\n-class TransportLatch : public feedtoken::ITransport {\n-private:\n+", "originalCommit": "eb7b71781ca079b5577a13b300beafee388bc1ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk4MDQyMg==", "url": "https://github.com/vespa-engine/vespa/pull/13113#discussion_r417980422", "bodyText": "Now it is.", "author": "baldersheim", "createdAt": "2020-04-30T12:43:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzgxODkzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzgxOTU2OQ==", "url": "https://github.com/vespa-engine/vespa/pull/13113#discussion_r417819569", "bodyText": "Please add class comment.", "author": "geirst", "createdAt": "2020-04-30T07:47:27Z", "path": "searchcore/src/vespa/searchcore/proton/persistenceengine/transport_latch.h", "diffHunk": "@@ -13,18 +13,33 @@ namespace proton {\n  * Implementation of FeedToken::ITransport for handling the async reply for an operation.\n  * Uses an internal count down latch to keep track the number of outstanding replies.\n  */\n-class TransportLatch : public feedtoken::ITransport {\n-private:\n+\n+class TransportMerger : public feedtoken::ITransport {\n+public:\n     using Result = storage::spi::Result;\n+    static Result mergeErrorResults(const Result &lhs, const Result &rhs);\n+protected:\n+    TransportMerger(bool needLocking);\n+    ~TransportMerger() override;\n+    void mergeResult(ResultUP result, bool documentWasFound);\n+    virtual void completeIfDone() { } // Called with lock held if necessary on every merge\n+    ResultUP  _result;\n+\n+private:\n+    void mergeWithLock(ResultUP result, bool documentWasFound);\n+    std::unique_ptr<std::mutex> _lock;\n+};\n+class TransportLatch : public TransportMerger {", "originalCommit": "eb7b71781ca079b5577a13b300beafee388bc1ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk4MDI3MA==", "url": "https://github.com/vespa-engine/vespa/pull/13113#discussion_r417980270", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-04-30T12:42:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzgxOTU2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM1OTQzOQ==", "url": "https://github.com/vespa-engine/vespa/pull/13113#discussion_r417359439", "bodyText": "Should use new VZM copyright comment", "author": "vekterli", "createdAt": "2020-04-29T14:28:32Z", "path": "persistence/src/vespa/persistence/spi/operationcomplete.h", "diffHunk": "@@ -0,0 +1,22 @@\n+// Copyright 2017 Yahoo Holdings. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.", "originalCommit": "eb7b71781ca079b5577a13b300beafee388bc1ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk4MjcxMg==", "url": "https://github.com/vespa-engine/vespa/pull/13113#discussion_r417982712", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-04-30T12:47:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM1OTQzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM2NzM3MA==", "url": "https://github.com/vespa-engine/vespa/pull/13113#discussion_r417367370", "bodyText": "The naming of this function might be a bit confusing. It can be read as \"wait for result\" (i.e. result is ready when function returns) rather than \"(future) result of waiting\". Maybe call it future_result or similar?", "author": "vekterli", "createdAt": "2020-04-29T14:38:26Z", "path": "persistence/src/vespa/persistence/spi/persistenceprovider.cpp", "diffHunk": "@@ -1,9 +1,35 @@\n // Copyright 2017 Yahoo Holdings. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n \n #include \"persistenceprovider.h\"\n+#include <future>\n \n namespace storage::spi {\n \n PersistenceProvider::~PersistenceProvider() = default;\n \n+class CatchResult : public OperationComplete {\n+public:\n+    std::future<Result::UP> waitResult() {", "originalCommit": "eb7b71781ca079b5577a13b300beafee388bc1ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk4NDEwMw==", "url": "https://github.com/vespa-engine/vespa/pull/13113#discussion_r417984103", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-04-30T12:49:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM2NzM3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkzMTMwNQ==", "url": "https://github.com/vespa-engine/vespa/pull/13113#discussion_r417931305", "bodyText": "Is it valid behavior with the current code that a tracker still has a reply upon destruction? If not, when is the latency metric updated? Should it be moved to sendReply()?", "author": "vekterli", "createdAt": "2020-04-30T11:06:48Z", "path": "storage/src/vespa/storage/persistence/persistenceutil.cpp", "diffHunk": "@@ -14,22 +14,69 @@ namespace {\n         ost << \"PersistenceUtil(\" << p << \")\";\n         return ost.str();\n     }\n+\n+    bool isBatchable(api::MessageType::Id id)\n+    {\n+        return (id == api::MessageType::PUT_ID ||\n+                id == api::MessageType::REMOVE_ID ||\n+                id == api::MessageType::UPDATE_ID ||\n+                id == api::MessageType::REVERT_ID);\n+    }\n+\n+    bool hasBucketInfo(api::MessageType::Id id)\n+    {\n+        return (isBatchable(id) ||\n+                (id == api::MessageType::REMOVELOCATION_ID ||\n+                 id == api::MessageType::JOINBUCKETS_ID));\n+    }\n+\n }\n \n-MessageTracker::MessageTracker(FileStorThreadMetrics::Op& metric,\n-                               framework::Clock& clock)\n+MessageTracker::MessageTracker(PersistenceUtil & env,\n+                               FileStorHandler::BucketLockInterface::SP bucketLock,\n+                               api::StorageMessage::SP msg)\n     : _sendReply(true),\n-      _metric(metric),\n+      _updateBucketInfo(hasBucketInfo(msg->getType().getId())),\n+      _bucketLock(std::move(bucketLock)),\n+      _msg(std::move(msg)),\n+      _context(_msg->getLoadType(), _msg->getPriority(), _msg->getTrace().getLevel()),\n+      _env(env),\n+      _metric(nullptr),\n       _result(api::ReturnCode::OK),\n-      _timer(clock)\n-{\n-    _metric.count.inc();\n+      _timer(_env._component.getClock())\n+{ }\n+\n+void\n+MessageTracker::setMetric(FileStorThreadMetrics::Op& metric) {\n+    metric.count.inc();\n+    _metric = &metric;\n }\n \n MessageTracker::~MessageTracker()\n {\n     if (_reply.get() && _reply->getResult().success()) {\n-        _metric.latency.addValue(_timer.getElapsedTimeAsDouble());\n+        _metric->latency.addValue(_timer.getElapsedTimeAsDouble());", "originalCommit": "eb7b71781ca079b5577a13b300beafee388bc1ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODAxMTgyMA==", "url": "https://github.com/vespa-engine/vespa/pull/13113#discussion_r418011820", "bodyText": "That is entirely correct. Good catch.", "author": "baldersheim", "createdAt": "2020-04-30T13:32:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkzMTMwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkzMjQzOQ==", "url": "https://github.com/vespa-engine/vespa/pull/13113#discussion_r417932439", "bodyText": "Does it make sense to append a trace to a message that has no reply associated with it?", "author": "vekterli", "createdAt": "2020-04-30T11:09:14Z", "path": "storage/src/vespa/storage/persistence/persistenceutil.cpp", "diffHunk": "@@ -14,22 +14,69 @@ namespace {\n         ost << \"PersistenceUtil(\" << p << \")\";\n         return ost.str();\n     }\n+\n+    bool isBatchable(api::MessageType::Id id)\n+    {\n+        return (id == api::MessageType::PUT_ID ||\n+                id == api::MessageType::REMOVE_ID ||\n+                id == api::MessageType::UPDATE_ID ||\n+                id == api::MessageType::REVERT_ID);\n+    }\n+\n+    bool hasBucketInfo(api::MessageType::Id id)\n+    {\n+        return (isBatchable(id) ||\n+                (id == api::MessageType::REMOVELOCATION_ID ||\n+                 id == api::MessageType::JOINBUCKETS_ID));\n+    }\n+\n }\n \n-MessageTracker::MessageTracker(FileStorThreadMetrics::Op& metric,\n-                               framework::Clock& clock)\n+MessageTracker::MessageTracker(PersistenceUtil & env,\n+                               FileStorHandler::BucketLockInterface::SP bucketLock,\n+                               api::StorageMessage::SP msg)\n     : _sendReply(true),\n-      _metric(metric),\n+      _updateBucketInfo(hasBucketInfo(msg->getType().getId())),\n+      _bucketLock(std::move(bucketLock)),\n+      _msg(std::move(msg)),\n+      _context(_msg->getLoadType(), _msg->getPriority(), _msg->getTrace().getLevel()),\n+      _env(env),\n+      _metric(nullptr),\n       _result(api::ReturnCode::OK),\n-      _timer(clock)\n-{\n-    _metric.count.inc();\n+      _timer(_env._component.getClock())\n+{ }\n+\n+void\n+MessageTracker::setMetric(FileStorThreadMetrics::Op& metric) {\n+    metric.count.inc();\n+    _metric = &metric;\n }\n \n MessageTracker::~MessageTracker()\n {\n     if (_reply.get() && _reply->getResult().success()) {\n-        _metric.latency.addValue(_timer.getElapsedTimeAsDouble());\n+        _metric->latency.addValue(_timer.getElapsedTimeAsDouble());\n+    }\n+}\n+\n+void\n+MessageTracker::sendReply() {\n+    if (hasReply()) {\n+        if ( ! _context.getTrace().getRoot().isEmpty()) {\n+            getReply().getTrace().getRoot().addChild(_context.getTrace().getRoot());\n+        }\n+        if (_updateBucketInfo) {\n+            if (getReply().getResult().success()) {\n+                _env.setBucketInfo(*this, _bucketLock->getBucket());\n+            }\n+        }\n+        LOG(spam, \"Sending reply up: %s %\" PRIu64,\n+            getReply().toString().c_str(), getReply().getMsgId());\n+        _env._fileStorHandler.sendReply(std::move(_reply));\n+    } else {\n+        if ( ! _context.getTrace().getRoot().isEmpty()) {\n+            _msg->getTrace().getRoot().addChild(_context.getTrace().getRoot());", "originalCommit": "eb7b71781ca079b5577a13b300beafee388bc1ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk4NTIzOQ==", "url": "https://github.com/vespa-engine/vespa/pull/13113#discussion_r417985239", "bodyText": "I do not know, I just tried to preserve current behavior.", "author": "baldersheim", "createdAt": "2020-04-30T12:51:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkzMjQzOQ=="}], "type": "inlineReview"}, {"oid": "704b6635543a6e0b1489f6371de865383575c6e3", "url": "https://github.com/vespa-engine/vespa/commit/704b6635543a6e0b1489f6371de865383575c6e3", "message": "Add class comments and resolve PR comments.", "committedDate": "2020-04-30T13:31:15Z", "type": "commit"}]}