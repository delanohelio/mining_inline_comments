{"pr_number": 13856, "pr_title": "If flush has been triggered due to spread, we need to prioritize that\u2026", "pr_createdAt": "2020-07-09T14:23:47Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/13856", "timeline": [{"oid": "a59af1171472ef0f9f58ec20996f21deb7e7b9f2", "url": "https://github.com/vespa-engine/vespa/commit/a59af1171472ef0f9f58ec20996f21deb7e7b9f2", "message": "If flush has been triggered due to spread, we need to prioritize that correctly.\nWe should never prioritize bloat of single file, unless global bloat is exceeded.\nThis will significantly reduce number of compaction operations.", "committedDate": "2020-07-09T14:18:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI3MTk0OA==", "url": "https://github.com/vespa-engine/vespa/pull/13856#discussion_r452271948", "bodyText": "Consider a strategy to avoid having to call getDiskBloat() again here, e.g. return std::pair<bool, size_t> or just a size_t from a renamed isTotalDiskBloatExceeded().", "author": "toregge", "createdAt": "2020-07-09T14:45:17Z", "path": "searchlib/src/vespa/searchlib/docstore/logdatastore.cpp", "diffHunk": "@@ -313,16 +313,23 @@ LogDataStore::compact(uint64_t syncToken)\n     }\n }\n \n+bool\n+LogDataStore::isTotalDiskBloatExceeded() const {\n+    const size_t diskFootPrint = getDiskFootprint();\n+    const size_t maxConfiguredDiskBloat = diskFootPrint * _config.getMaxDiskBloatFactor();\n+    return getDiskBloat() > maxConfiguredDiskBloat;\n+}\n+\n size_t\n LogDataStore::getMaxCompactGain() const\n {\n+    size_t bloat = 0;\n+    if ( isTotalDiskBloatExceeded() ) {\n+        bloat = getDiskBloat();", "originalCommit": "a59af1171472ef0f9f58ec20996f21deb7e7b9f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM3MDg1MQ==", "url": "https://github.com/vespa-engine/vespa/pull/13856#discussion_r452370851", "bodyText": "Done, in addition to avoid deadlock.", "author": "baldersheim", "createdAt": "2020-07-09T17:16:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI3MTk0OA=="}], "type": "inlineReview"}, {"oid": "c595d62a06070f9f4463641c40e5b9aa59cbb932", "url": "https://github.com/vespa-engine/vespa/commit/c595d62a06070f9f4463641c40e5b9aa59cbb932", "message": "Refactor to avoid deadlock due to trying to aquire a lock you already hold. Also reduce number of calls to getDiskBloat/getDiskFootPrint", "committedDate": "2020-07-09T17:11:51Z", "type": "commit"}]}