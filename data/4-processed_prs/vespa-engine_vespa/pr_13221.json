{"pr_number": 13221, "pr_title": "allow filter in bruteforce", "pr_createdAt": "2020-05-12T08:52:19Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/13221", "timeline": [{"oid": "503880f98dae838c24fbb6869840108b73684952", "url": "https://github.com/vespa-engine/vespa/commit/503880f98dae838c24fbb6869840108b73684952", "message": "allow filter in bruteforce\n\n* add support for using a whitelist filter in bruteforce nearest neighbor iterator.", "committedDate": "2020-05-12T08:49:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY2ODgyMA==", "url": "https://github.com/vespa-engine/vespa/pull/13221#discussion_r423668820", "bodyText": "Consider inverting template argument to use_filter instead. It is easier to read it that way.", "author": "geirst", "createdAt": "2020-05-12T11:44:58Z", "path": "searchlib/src/vespa/searchlib/queryeval/nearest_neighbor_iterator.cpp", "diffHunk": "@@ -29,7 +30,7 @@ is_compatible(const vespalib::eval::ValueType& lhs,\n  * Keeps a heap of the K best hit distances.\n  * Currently always does brute-force scanning, which is very expensive.\n  **/\n-template <bool strict>\n+template <bool strict, bool no_bitvector>", "originalCommit": "503880f98dae838c24fbb6869840108b73684952", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY2OTkyNQ==", "url": "https://github.com/vespa-engine/vespa/pull/13221#discussion_r423669925", "bodyText": "Consider renaming bit_vector to filter to match how it is named in hnsw index.", "author": "geirst", "createdAt": "2020-05-12T11:47:09Z", "path": "searchlib/src/vespa/searchlib/queryeval/nearest_neighbor_iterator.cpp", "diffHunk": "@@ -112,11 +116,16 @@ NearestNeighborIterator::create(\n         const vespalib::tensor::DenseTensorView &queryTensor,\n         const search::tensor::DenseTensorAttribute &tensorAttribute,\n         NearestNeighborDistanceHeap &distanceHeap,\n+        const search::BitVector *bit_vector,\n         const search::tensor::DistanceFunction *dist_fun)\n \n {\n-    Params params(tfmd, queryTensor, tensorAttribute, distanceHeap, dist_fun);\n-    return resolve_strict_LCT_RCT(strict, params);\n+    Params params(tfmd, queryTensor, tensorAttribute, distanceHeap, bit_vector, dist_fun);", "originalCommit": "503880f98dae838c24fbb6869840108b73684952", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY3MDE0OA==", "url": "https://github.com/vespa-engine/vespa/pull/13221#discussion_r423670148", "bodyText": "Consider renaming bit_vector to filter to match how it is named in hnsw index. Applies for rest of file.", "author": "geirst", "createdAt": "2020-05-12T11:47:36Z", "path": "searchlib/src/vespa/searchlib/queryeval/nearest_neighbor_iterator.h", "diffHunk": "@@ -25,17 +25,20 @@ class NearestNeighborIterator : public SearchIterator\n         const DenseTensorView &queryTensor;\n         const DenseTensorAttribute &tensorAttribute;\n         NearestNeighborDistanceHeap &distanceHeap;\n+        const search::BitVector *bit_vector;", "originalCommit": "503880f98dae838c24fbb6869840108b73684952", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6007048884ea5c222c0ad88862f7cc12992ac336", "url": "https://github.com/vespa-engine/vespa/commit/6007048884ea5c222c0ad88862f7cc12992ac336", "message": "no_bitvector -> !has_filter", "committedDate": "2020-05-12T13:20:20Z", "type": "commit"}]}