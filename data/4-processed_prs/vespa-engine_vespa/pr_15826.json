{"pr_number": 15826, "pr_title": "Gjoranv/wait for deconstruct upon shutdown", "pr_createdAt": "2020-12-15T15:29:41Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/15826", "timeline": [{"oid": "08d1933bd7a34d0fae3c4cf0dcd8ba28084d83d1", "url": "https://github.com/vespa-engine/vespa/commit/08d1933bd7a34d0fae3c4cf0dcd8ba28084d83d1", "message": "Wait for component deconstruction to finish when shutting down.\n\n- Wait up to 10 minuts.\n- Add separate modes for reconfig and shutdown.\n- Add test ctor for setting the delay before deconstruction starts\n  in RECONFIG mode. (Tests are TBD.)", "committedDate": "2020-12-15T13:37:14Z", "type": "commit"}, {"oid": "79e8e0a9632002c6c7a3bb687820b896019c4ded", "url": "https://github.com/vespa-engine/vespa/commit/79e8e0a9632002c6c7a3bb687820b896019c4ded", "message": "Add constant for the deconstruct delay in RECONFIG mode.", "committedDate": "2020-12-15T14:06:19Z", "type": "commit"}, {"oid": "81d4a76511c3dfc19aed98b47153dcea95fd31fd", "url": "https://github.com/vespa-engine/vespa/commit/81d4a76511c3dfc19aed98b47153dcea95fd31fd", "message": "Extract method for task waiting and exception handling.", "committedDate": "2020-12-15T14:07:38Z", "type": "commit"}, {"oid": "1df01cb01cb5fd95f947b8a84763662411a05b4b", "url": "https://github.com/vespa-engine/vespa/commit/1df01cb01cb5fd95f947b8a84763662411a05b4b", "message": "Switch test to use RECONFIG mode by default.\n\n- Use SHUTDOWN mode for the latest test that uses a component\n  with the delayed deconstruct method.\n- Remove the now unnecessary explanation from the class comment.", "committedDate": "2020-12-15T14:33:34Z", "type": "commit"}, {"oid": "0fc476b0a59950a75330d78fa3d96386dc0f572e", "url": "https://github.com/vespa-engine/vespa/commit/0fc476b0a59950a75330d78fa3d96386dc0f572e", "message": "Optimize imports.", "committedDate": "2020-12-15T14:34:22Z", "type": "commit"}, {"oid": "cbd03ebf7b571348c7b4eff762ddeebdc41e3e2c", "url": "https://github.com/vespa-engine/vespa/commit/cbd03ebf7b571348c7b4eff762ddeebdc41e3e2c", "message": "Make the deconstruct executor private again.\n\n- Add helper method in test to wait for deconstruct to finish.", "committedDate": "2020-12-15T15:20:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ5NzE5NQ==", "url": "https://github.com/vespa-engine/vespa/pull/15826#discussion_r543497195", "bodyText": "Isn't there also a 50s timeout on shutdown, somewhere further up?", "author": "jonmv", "createdAt": "2020-12-15T16:32:10Z", "path": "container-disc/src/main/java/com/yahoo/container/jdisc/component/Deconstructor.java", "diffHunk": "@@ -61,9 +81,24 @@ public void deconstruct(List<Object> components, Collection<Bundle> bundles) {\n                 ((SharedResource) component).release();\n             }\n         }\n-        if (! destructibleComponents.isEmpty() || ! bundles.isEmpty())\n-            executor.schedule(new DestructComponentTask(destructibleComponents, bundles),\n+        if (!destructibleComponents.isEmpty() || !bundles.isEmpty()) {\n+            var task = executor.schedule(new DestructComponentTask(destructibleComponents, bundles),\n                               delay.getSeconds(), TimeUnit.SECONDS);\n+            if (mode.equals(Mode.SHUTDOWN)) {\n+                // Wait for deconstruction to finish\n+                try {\n+                    log.info(\"Waiting up to \" + SHUTDOWN_DECONSTRUCT_TIMEOUT.toSeconds() + \" seconds for all components to deconstruct.\");", "originalCommit": "08d1933bd7a34d0fae3c4cf0dcd8ba28084d83d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzUwNTIyOQ==", "url": "https://github.com/vespa-engine/vespa/pull/15826#discussion_r543505229", "bodyText": "Yes, you're right. That seems a bit harsh. Perhaps we should increase the \"shutdownDeadlineExecutor\" to at least 90 sec, and set this one to 80? I don't know the background for that. Maybe it's to ensure shutdown within a reasonable amount of time. What do you think about 45 seconds? In normal use cases, that's probably plenty.", "author": "gjoranv", "createdAt": "2020-12-15T16:42:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ5NzE5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzUxMTM3OA==", "url": "https://github.com/vespa-engine/vespa/pull/15826#discussion_r543511378", "bodyText": "I think 45s is good!", "author": "jonmv", "createdAt": "2020-12-15T16:49:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ5NzE5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzUxMDE5MQ==", "url": "https://github.com/vespa-engine/vespa/pull/15826#discussion_r543510191", "bodyText": "Yes, was made visible for testing. All tests can use the synchronous shutdown instead :)", "author": "jonmv", "createdAt": "2020-12-15T16:47:58Z", "path": "container-disc/src/main/java/com/yahoo/container/jdisc/component/Deconstructor.java", "diffHunk": "@@ -35,13 +39,29 @@\n \n     private static final Logger log = Logger.getLogger(Deconstructor.class.getName());\n \n+    private static final Duration SHUTDOWN_DECONSTRUCT_TIMEOUT = Duration.ofMinutes(10);\n+\n+    public enum Mode {\n+        RECONFIG,  // Delay deconstruction to allow old components to finish processing in-flight requests.\n+        SHUTDOWN   // The container is shutting down. Start deconstructing immediately, and wait until all components\n+                   // are deconstructed, to prevent shutting down while deconstruct is in progress.\n+    }\n+\n+    // TODO: make private again", "originalCommit": "08d1933bd7a34d0fae3c4cf0dcd8ba28084d83d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f9571e410b812bf014342443aacc13273a2bc0fe", "url": "https://github.com/vespa-engine/vespa/commit/f9571e410b812bf014342443aacc13273a2bc0fe", "message": "Reduce shutdown deconstruction timeout from 10 min -> 45 sec\n\n.. due to ConfiguredApplication.shutdownDeadlineExecutor", "committedDate": "2020-12-15T16:49:35Z", "type": "commit"}]}