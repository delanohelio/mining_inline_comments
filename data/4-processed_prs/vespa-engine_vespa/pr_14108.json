{"pr_number": 14108, "pr_title": "Balder/move commit time tracker to replay state", "pr_createdAt": "2020-08-19T20:39:44Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/14108", "timeline": [{"oid": "76db49d501be07b1fc6ac09370886bb89ffab8ef", "url": "https://github.com/vespa-engine/vespa/commit/76db49d501be07b1fc6ac09370886bb89ffab8ef", "message": "Do the time tracking for immediate commit in the replay state instead of having it spread all over.", "committedDate": "2020-08-19T20:36:51Z", "type": "commit"}, {"oid": "c912d10154c3d554ca42d635377b9e34e3c882a4", "url": "https://github.com/vespa-engine/vespa/commit/c912d10154c3d554ca42d635377b9e34e3c882a4", "message": "Avoid time based commit handling inside storeonly feed view.", "committedDate": "2020-08-19T20:36:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzc4NTg4OQ==", "url": "https://github.com/vespa-engine/vespa/pull/14108#discussion_r473785889", "bodyText": "Consider also removing forward declaration earlier in the file.", "author": "toregge", "createdAt": "2020-08-20T08:57:53Z", "path": "searchcore/src/vespa/searchcore/proton/server/storeonlyfeedview.h", "diffHunk": "@@ -81,24 +81,21 @@ class StoreOnlyFeedView : public IFeedView,\n         const std::shared_ptr<const document::DocumentTypeRepo>    &_repo;\n         searchcorespi::index::IThreadingService &_writeService;\n         documentmetastore::ILidReuseDelayer     &_lidReuseDelayer;\n-        CommitTimeTracker                       &_commitTimeTracker;", "originalCommit": "c912d10154c3d554ca42d635377b9e34e3c882a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzkwMTgxNA==", "url": "https://github.com/vespa-engine/vespa/pull/14108#discussion_r473901814", "bodyText": "Fixed.", "author": "baldersheim", "createdAt": "2020-08-20T11:32:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzc4NTg4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg1NzQ2Mg==", "url": "https://github.com/vespa-engine/vespa/pull/14108#discussion_r473857462", "bodyText": "Use of auto here triggers a stack use after scope error (detected by address sanitizer).", "author": "toregge", "createdAt": "2020-08-20T10:24:14Z", "path": "searchcore/src/tests/proton/documentdb/configurer/configurer_test.cpp", "diffHunk": "@@ -267,16 +262,16 @@ struct MyFastAccessFeedView\n         ISummaryAdapter::SP summaryAdapter(new MySummaryAdapter());\n         Schema::SP schema(new Schema());\n         _dmsc = make_shared<DocumentMetaStoreContext>(std::make_shared<BucketDBOwner>());\n-        _lidReuseDelayer.reset(new documentmetastore::LidReuseDelayer(_writeService, _dmsc->get()));\n+        _lidReuseDelayer = std::make_unique<documentmetastore::LidReuseDelayer>(_writeService, _dmsc->get());\n         std::shared_ptr<const DocumentTypeRepo> repo = createRepo();\n         StoreOnlyFeedView::Context storeOnlyCtx(summaryAdapter, schema, _dmsc, *_gidToLidChangeHandler, repo,\n-                                                _writeService, *_lidReuseDelayer, _commitTimeTracker);\n+                                                _writeService, *_lidReuseDelayer);\n         StoreOnlyFeedView::PersistentParams params(1, 1, DocTypeName(DOC_TYPE), 0, SubDbType::NOTREADY);\n         auto mgr = make_shared<AttributeManager>(BASE_DIR, \"test.subdb\", TuneFileAttributes(), _fileHeaderContext,\n                                                  _writeService.attributeFieldWriter(), _writeService.shared(), _hwInfo);\n-        IAttributeWriter::SP writer(new AttributeWriter(mgr));\n+        auto writer = std::make_shared<AttributeWriter>(mgr);", "originalCommit": "c912d10154c3d554ca42d635377b9e34e3c882a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzkwMTc0Mg==", "url": "https://github.com/vespa-engine/vespa/pull/14108#discussion_r473901742", "bodyText": "How does that change scope ?", "author": "baldersheim", "createdAt": "2020-08-20T11:32:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg1NzQ2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzkyMDE0Mg==", "url": "https://github.com/vespa-engine/vespa/pull/14108#discussion_r473920142", "bodyText": "A reference to a temporary std::shared_pointer is passed to FastAccessFeedView::Context constructor and goes out of scope right afterwards, causing fastUpdateCtx to reference a dead stack variable.", "author": "toregge", "createdAt": "2020-08-20T12:07:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg1NzQ2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzkyOTg4OQ==", "url": "https://github.com/vespa-engine/vespa/pull/14108#discussion_r473929889", "bodyText": "Fixed implementation of ...::Context to use shared_ptr by value instead.", "author": "baldersheim", "createdAt": "2020-08-20T12:24:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg1NzQ2Mg=="}], "type": "inlineReview"}, {"oid": "edbae1ae4f5fe5f4d35cd35174393cb4c246f708", "url": "https://github.com/vespa-engine/vespa/commit/edbae1ae4f5fe5f4d35cd35174393cb4c246f708", "message": "Transfer shared_ptr by value.", "committedDate": "2020-08-20T12:06:48Z", "type": "commit"}, {"oid": "a5882a6afe23f4167ccef46a8181001ccf608bf3", "url": "https://github.com/vespa-engine/vespa/commit/a5882a6afe23f4167ccef46a8181001ccf608bf3", "message": "Use a fixed visibility-delay of 100ms during replay", "committedDate": "2020-08-20T12:23:09Z", "type": "commit"}, {"oid": "e323ff017e125896ab4e2da681059f228cec1379", "url": "https://github.com/vespa-engine/vespa/commit/e323ff017e125896ab4e2da681059f228cec1379", "message": "GC unused code", "committedDate": "2020-08-20T12:32:21Z", "type": "commit"}]}