{"pr_number": 14937, "pr_title": "Balder/factor out split join rebased", "pr_createdAt": "2020-10-18T11:54:00Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/14937", "timeline": [{"oid": "f34acff8f2f40938d97b5b20ed960101d6622eff", "url": "https://github.com/vespa-engine/vespa/commit/f34acff8f2f40938d97b5b20ed960101d6622eff", "message": "Factor out handling of operations that might change bucket ownership.", "committedDate": "2020-10-18T11:25:35Z", "type": "commit"}, {"oid": "554e8e480b6a614c7b730390472b83daf11911b9", "url": "https://github.com/vespa-engine/vespa/commit/554e8e480b6a614c7b730390472b83daf11911b9", "message": "Reduce usage of Component", "committedDate": "2020-10-18T11:25:35Z", "type": "commit"}, {"oid": "a7f45c9843e197c5881ef67fa83e1d23c78daa17", "url": "https://github.com/vespa-engine/vespa/commit/a7f45c9843e197c5881ef67fa83e1d23c78daa17", "message": "We must detect changes in document config.", "committedDate": "2020-10-18T11:50:06Z", "type": "commit"}, {"oid": "b17c5c96e18ae04a1b39b4d0ec3dc89832038c05", "url": "https://github.com/vespa-engine/vespa/commit/b17c5c96e18ae04a1b39b4d0ec3dc89832038c05", "message": "Do not retrieve config once for every thread.", "committedDate": "2020-10-18T12:54:07Z", "type": "commit"}, {"oid": "e099df397486313831f09befa1d081b178384632", "url": "https://github.com/vespa-engine/vespa/commit/e099df397486313831f09befa1d081b178384632", "message": "Move join handling together with split handling.", "committedDate": "2020-10-18T14:54:28Z", "type": "commit"}, {"oid": "e6a8e2c087d25335784c05a8d01e1c1b665d3b3d", "url": "https://github.com/vespa-engine/vespa/commit/e6a8e2c087d25335784c05a8d01e1c1b665d3b3d", "message": "Factor out handling of the remaining messages.", "committedDate": "2020-10-18T15:50:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY1MTkzMg==", "url": "https://github.com/vespa-engine/vespa/pull/14937#discussion_r507651932", "bodyText": "It's a bit philosophically questionable to have this const when it mutates state transitively, but I digress \ud83d\ude09", "author": "vekterli", "createdAt": "2020-10-19T10:50:39Z", "path": "storage/src/vespa/storage/persistence/persistenceutil.cpp", "diffHunk": "@@ -157,26 +155,23 @@ MessageTracker::generateReply(api::StorageCommand& cmd)\n }\n \n PersistenceUtil::PersistenceUtil(\n-        const config::ConfigUri & configUri,\n         ServiceLayerComponent& component,\n         FileStorHandler& fileStorHandler,\n         FileStorThreadMetrics& metrics,\n         spi::PersistenceProvider& provider)\n-    : _config(*config::ConfigGetter<vespa::config::content::StorFilestorConfig>::getConfig(configUri.getConfigId(), configUri.getContext())),\n-      _component(component),\n+    : _component(component),\n       _fileStorHandler(fileStorHandler),\n       _nodeIndex(component.getIndex()),\n       _metrics(metrics),\n       _bucketFactory(component.getBucketIdFactory()),\n-      _repo(component.getTypeRepo()->documentTypeRepo),\n       _spi(provider)\n {\n }\n \n PersistenceUtil::~PersistenceUtil() = default;\n \n void\n-PersistenceUtil::updateBucketDatabase(const document::Bucket &bucket, const api::BucketInfo& i)\n+PersistenceUtil::updateBucketDatabase(const document::Bucket &bucket, const api::BucketInfo& i) const", "originalCommit": "e6a8e2c087d25335784c05a8d01e1c1b665d3b3d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY3NzAzNA==", "url": "https://github.com/vespa-engine/vespa/pull/14937#discussion_r507677034", "bodyText": ":)", "author": "baldersheim", "createdAt": "2020-10-19T11:37:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY1MTkzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY1NDA2NQ==", "url": "https://github.com/vespa-engine/vespa/pull/14937#discussion_r507654065", "bodyText": "A class comment would be nice, especially for what \"simple\" means in this context", "author": "vekterli", "createdAt": "2020-10-19T10:54:30Z", "path": "storage/src/vespa/storage/persistence/simplemessagehandler.h", "diffHunk": "@@ -0,0 +1,33 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#pragma once\n+\n+#include \"types.h\"\n+#include \"messages.h\"\n+#include <vespa/storage/common/bucketmessages.h>\n+#include <vespa/storageapi/message/persistence.h>\n+\n+namespace storage {\n+\n+namespace spi { struct PersistenceProvider; }\n+struct PersistenceUtil;\n+\n+class SimpleMessageHandler : public Types {", "originalCommit": "e6a8e2c087d25335784c05a8d01e1c1b665d3b3d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY3NzE0NQ==", "url": "https://github.com/vespa-engine/vespa/pull/14937#discussion_r507677145", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-10-19T11:38:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY1NDA2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY1OTg0NA==", "url": "https://github.com/vespa-engine/vespa/pull/14937#discussion_r507659844", "bodyText": "Nit: missing space before context", "author": "vekterli", "createdAt": "2020-10-19T11:05:12Z", "path": "storage/src/vespa/storage/persistence/testandsethelper.cpp", "diffHunk": "@@ -35,7 +35,7 @@ void TestAndSetHelper::parseDocumentSelection(const document::DocumentTypeRepo &\n }\n \n spi::GetResult TestAndSetHelper::retrieveDocument(const document::FieldSet & fieldSet, spi::Context & context) {\n-    return _spi.get(_env.getBucket(_docId, _cmd.getBucket()), fieldSet,_cmd.getDocumentId(),context);\n+    return _spi.get(_env.getBucket(_docId, _cmd.getBucket()), fieldSet, _cmd.getDocumentId(),context);", "originalCommit": "e6a8e2c087d25335784c05a8d01e1c1b665d3b3d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY3NzIxOQ==", "url": "https://github.com/vespa-engine/vespa/pull/14937#discussion_r507677219", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-10-19T11:38:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY1OTg0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY2NTEzMw==", "url": "https://github.com/vespa-engine/vespa/pull/14937#discussion_r507665133", "bodyText": "Nitpick: Missing '.' at the end. On the next sentence as well.", "author": "geirst", "createdAt": "2020-10-19T11:15:10Z", "path": "storage/src/vespa/storage/persistence/asynchandler.h", "diffHunk": "@@ -13,8 +13,11 @@ namespace spi {\n }\n struct PersistenceUtil;\n \n+/**\n+ * Handle async operations that uses a sequenced executor", "originalCommit": "f34acff8f2f40938d97b5b20ed960101d6622eff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY3NzcxNg==", "url": "https://github.com/vespa-engine/vespa/pull/14937#discussion_r507677716", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-10-19T11:39:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY2NTEzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY2NjgwMg==", "url": "https://github.com/vespa-engine/vespa/pull/14937#discussion_r507666802", "bodyText": "There is something wrong with this sentence.\nNitpick: Missing '.' at the end. On the next sentence as well.", "author": "geirst", "createdAt": "2020-10-19T11:18:26Z", "path": "storage/src/vespa/storage/persistence/splitjoinhandler.h", "diffHunk": "@@ -0,0 +1,32 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#pragma once\n+\n+#include \"types.h\"\n+#include <vespa/storageapi/message/bucketsplitting.h>\n+\n+namespace storage {\n+\n+namespace spi { struct PersistenceProvider; }\n+struct PersistenceUtil;\n+class BucketOwnershipNotifier;\n+class RecheckBucketInfoCommand;\n+\n+/**\n+ * Handle operations that uses changes bucket ownership operations", "originalCommit": "f34acff8f2f40938d97b5b20ed960101d6622eff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY3ODIzNA==", "url": "https://github.com/vespa-engine/vespa/pull/14937#discussion_r507678234", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-10-19T11:40:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY2NjgwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY3MTY3Mg==", "url": "https://github.com/vespa-engine/vespa/pull/14937#discussion_r507671672", "bodyText": "Consider using const auto.", "author": "geirst", "createdAt": "2020-10-19T11:27:46Z", "path": "storage/src/vespa/storage/persistence/mergehandler.cpp", "diffHunk": "@@ -426,6 +426,7 @@ MergeHandler::fetchLocalData(\n     }\n \n     document::BucketIdFactory idFactory;\n+    const std::shared_ptr<const document::DocumentTypeRepo> repo = _env._component.getTypeRepo()->documentTypeRepo;", "originalCommit": "a7f45c9843e197c5881ef67fa83e1d23c78daa17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY3ODkzMw==", "url": "https://github.com/vespa-engine/vespa/pull/14937#discussion_r507678933", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-10-19T11:41:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY3MTY3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY3MzI3NQ==", "url": "https://github.com/vespa-engine/vespa/pull/14937#discussion_r507673275", "bodyText": "Consider using const auto.", "author": "geirst", "createdAt": "2020-10-19T11:30:41Z", "path": "storage/src/vespa/storage/persistence/testandsethelper.cpp", "diffHunk": "@@ -47,8 +47,9 @@ TestAndSetHelper::TestAndSetHelper(const PersistenceUtil & env, const spi::Persi\n       _docTypePtr(_cmd.getDocumentType()),\n       _missingDocumentImpliesMatch(missingDocumentImpliesMatch)\n {\n-    resolveDocumentType(*env._repo);\n-    parseDocumentSelection(*env._repo);\n+    const std::shared_ptr<const document::DocumentTypeRepo> _repo = _env._component.getTypeRepo()->documentTypeRepo;", "originalCommit": "a7f45c9843e197c5881ef67fa83e1d23c78daa17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY3OTYwMw==", "url": "https://github.com/vespa-engine/vespa/pull/14937#discussion_r507679603", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-10-19T11:42:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY3MzI3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY3NTIxMw==", "url": "https://github.com/vespa-engine/vespa/pull/14937#discussion_r507675213", "bodyText": "Consider updating log target.", "author": "geirst", "createdAt": "2020-10-19T11:34:28Z", "path": "storage/src/vespa/storage/persistence/simplemessagehandler.cpp", "diffHunk": "@@ -0,0 +1,241 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#include \"simplemessagehandler.h\"\n+#include \"persistenceutil.h\"\n+#include <vespa/persistence/spi/persistenceprovider.h>\n+#include <vespa/storage/common/bucketoperationlogger.h>\n+#include <vespa/document/base/exceptions.h>\n+#include <vespa/document/fieldset/fieldsetrepo.h>\n+\n+#include <vespa/log/log.h>\n+LOG_SETUP(\".persistence.processall\");", "originalCommit": "e6a8e2c087d25335784c05a8d01e1c1b665d3b3d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY3OTczMA==", "url": "https://github.com/vespa-engine/vespa/pull/14937#discussion_r507679730", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-10-19T11:42:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY3NTIxMw=="}], "type": "inlineReview"}, {"oid": "4daf38778b4d9ca2241bd813d6ad3f535d2634c6", "url": "https://github.com/vespa-engine/vespa/commit/4daf38778b4d9ca2241bd813d6ad3f535d2634c6", "message": "Follow up PR comments\n- Improve comments, and some minor syntax.\n- const auto", "committedDate": "2020-10-19T11:43:21Z", "type": "commit"}]}