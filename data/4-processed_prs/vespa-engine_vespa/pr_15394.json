{"pr_number": 15394, "pr_title": "Delay gid to lid change notifications for put operations.", "pr_createdAt": "2020-11-19T15:41:57Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/15394", "timeline": [{"oid": "67f83ab6dbf0912cf53885b65991aa63d5a41fcc", "url": "https://github.com/vespa-engine/vespa/commit/67f83ab6dbf0912cf53885b65991aa63d5a41fcc", "message": "Delay gid to lid change notifications for put operations.", "committedDate": "2020-11-19T15:39:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU5Mjk3NA==", "url": "https://github.com/vespa-engine/vespa/pull/15394#discussion_r527592974", "bodyText": "Consider return {}; instead.", "author": "geirst", "createdAt": "2020-11-20T10:21:27Z", "path": "searchcore/src/vespa/searchcore/proton/reference/dummy_gid_to_lid_change_handler.cpp", "diffHunk": "@@ -18,9 +19,10 @@ DummyGidToLidChangeHandler::notifyRemove(IDestructorCallbackSP , GlobalId, Seria\n {\n }\n \n-void\n-DummyGidToLidChangeHandler::notifyRemoveDone(GlobalId, SerialNum)\n+std::unique_ptr<IPendingGidToLidChanges>\n+DummyGidToLidChangeHandler::grab_pending_changes()\n {\n+    return std::unique_ptr<IPendingGidToLidChanges>();", "originalCommit": "67f83ab6dbf0912cf53885b65991aa63d5a41fcc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU5NTE3Ng==", "url": "https://github.com/vespa-engine/vespa/pull/15394#discussion_r527595176", "bodyText": "Consider return {}; instead.", "author": "geirst", "createdAt": "2020-11-20T10:25:16Z", "path": "searchcore/src/vespa/searchcore/proton/reference/gid_to_lid_change_handler.cpp", "diffHunk": "@@ -96,6 +105,16 @@ GidToLidChangeHandler::notifyRemoveDone(GlobalId gid, SerialNum serialNum)\n     }\n }\n \n+std::unique_ptr<IPendingGidToLidChanges>\n+GidToLidChangeHandler::grab_pending_changes()\n+{\n+    lock_guard guard(_lock);\n+    if (_pending_changes.empty()) {\n+        return std::unique_ptr<IPendingGidToLidChanges>();", "originalCommit": "67f83ab6dbf0912cf53885b65991aa63d5a41fcc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU5NjM4OA==", "url": "https://github.com/vespa-engine/vespa/pull/15394#discussion_r527596388", "bodyText": "Consider updating comment to reflect that it is batched and applied later.", "author": "geirst", "createdAt": "2020-11-20T10:27:12Z", "path": "searchcore/src/vespa/searchcore/proton/reference/i_gid_to_lid_change_handler.h", "diffHunk": "@@ -38,9 +40,9 @@ class IGidToLidChangeHandler\n     /**\n      * Notify gid to lid mapping change.\n      */\n-    virtual void notifyPutDone(IDestructorCallbackSP context, GlobalId gid, uint32_t lid, SerialNum serialNum) = 0;\n+    virtual void notifyPut(IDestructorCallbackSP context, GlobalId gid, uint32_t lid, SerialNum serial_num) = 0;", "originalCommit": "67f83ab6dbf0912cf53885b65991aa63d5a41fcc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYwMDQ1MQ==", "url": "https://github.com/vespa-engine/vespa/pull/15394#discussion_r527600451", "bodyText": "Consider return {}; instead.", "author": "geirst", "createdAt": "2020-11-20T10:34:19Z", "path": "searchcore/src/vespa/searchcore/proton/test/mock_gid_to_lid_change_handler.h", "diffHunk": "@@ -42,9 +43,9 @@ class MockGidToLidChangeHandler : public IGidToLidChangeHandler {\n         _removes.emplace_back(docTypeName, keepNames);\n     }\n \n-    void notifyPutDone(IDestructorCallbackSP, document::GlobalId, uint32_t, SerialNum)  override { }\n+    void notifyPut(IDestructorCallbackSP, document::GlobalId, uint32_t, SerialNum)  override { }\n     void notifyRemove(IDestructorCallbackSP, document::GlobalId, SerialNum)  override { }\n-    void notifyRemoveDone(document::GlobalId, SerialNum)  override { }\n+    std::unique_ptr<IPendingGidToLidChanges> grab_pending_changes() override { return std::unique_ptr<IPendingGidToLidChanges>(); }", "originalCommit": "67f83ab6dbf0912cf53885b65991aa63d5a41fcc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9de0ac3fb140d563b8172c11608a299f515a3d26", "url": "https://github.com/vespa-engine/vespa/commit/9de0ac3fb140d563b8172c11608a299f515a3d26", "message": "Update comments.", "committedDate": "2020-11-20T11:14:28Z", "type": "commit"}, {"oid": "1908604cb3e0d32120be68b22f0798d0db253c30", "url": "https://github.com/vespa-engine/vespa/commit/1908604cb3e0d32120be68b22f0798d0db253c30", "message": "Simplify return statements.", "committedDate": "2020-11-20T11:14:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAwODc0MA==", "url": "https://github.com/vespa-engine/vespa/pull/15394#discussion_r528008740", "bodyText": "Move _serial_num up before the gid to avoid unused bytes due to alignment and smaller object size.", "author": "baldersheim", "createdAt": "2020-11-20T22:41:14Z", "path": "searchcore/src/vespa/searchcore/proton/reference/pending_gid_to_lid_change.h", "diffHunk": "@@ -0,0 +1,44 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#pragma once\n+\n+#include <vespa/searchlib/common/idestructorcallback.h>\n+#include <vespa/document/base/globalid.h>\n+#include <vespa/searchlib/common/serialnum.h>\n+\n+namespace proton {\n+\n+/*\n+ * Class for a gid to lid change awaiting a force commit.\n+ */\n+class PendingGidToLidChange\n+{\n+    using Context = std::shared_ptr<search::IDestructorCallback>;\n+    using GlobalId = document::GlobalId;\n+    using SerialNum = search::SerialNum;\n+\n+    Context   _context;\n+    GlobalId  _gid;\n+    uint32_t  _lid;\n+    SerialNum _serial_num;", "originalCommit": "1908604cb3e0d32120be68b22f0798d0db253c30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAxMTUyOQ==", "url": "https://github.com/vespa-engine/vespa/pull/15394#discussion_r528011529", "bodyText": "Fixed.", "author": "toregge", "createdAt": "2020-11-20T22:49:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAwODc0MA=="}], "type": "inlineReview"}, {"oid": "49f0ccb2a45f4884c14eecf1482a6331cb81eebb", "url": "https://github.com/vespa-engine/vespa/commit/49f0ccb2a45f4884c14eecf1482a6331cb81eebb", "message": "Place _serial_num member variable earlier in the class.", "committedDate": "2020-11-20T22:45:55Z", "type": "commit"}]}