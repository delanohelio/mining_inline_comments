{"pr_number": 12225, "pr_title": "Use enable_shared_from_this to simplify interface and keep the detail\u2026", "pr_createdAt": "2020-02-17T14:55:52Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/12225", "timeline": [{"oid": "c4a01e6c3b85eb18ece1c4b5d9f337b08ba3b76d", "url": "https://github.com/vespa-engine/vespa/commit/c4a01e6c3b85eb18ece1c4b5d9f337b08ba3b76d", "message": "Use enable_shared_from_this to simplify interface and keep the details local.", "committedDate": "2020-02-17T14:48:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjUwMjA2OA==", "url": "https://github.com/vespa-engine/vespa/pull/12225#discussion_r382502068", "bodyText": "I do not like this const-cast. Maybe this function should not be const (since it is allowed to change the object state).", "author": "havardpe", "createdAt": "2020-02-21T10:17:58Z", "path": "searchcore/src/vespa/searchcore/proton/server/searchview.cpp", "diffHunk": "@@ -161,8 +161,9 @@ SearchView::getDocsumsInternal(const DocsumRequest & req)\n }\n \n std::unique_ptr<SearchReply>\n-SearchView::match(const ISearchHandler::SP &self, const SearchRequest &req, ThreadBundle &threadBundle) const {\n-    return _matchView->match(self, req, threadBundle);\n+SearchView::match(const SearchRequest &req, ThreadBundle &threadBundle) const {\n+    ISearchHandler::SP self = const_cast<SearchView *>(this)->shared_from_this();", "originalCommit": "c4a01e6c3b85eb18ece1c4b5d9f337b08ba3b76d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk0Mzk4Mg==", "url": "https://github.com/vespa-engine/vespa/pull/12225#discussion_r382943982", "bodyText": "Const cast was not necessary. Just passing a const ISearchHandler was sufficient.", "author": "baldersheim", "createdAt": "2020-02-22T21:48:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjUwMjA2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjUwNDE0OQ==", "url": "https://github.com/vespa-engine/vespa/pull/12225#discussion_r382504149", "bodyText": "A class inheriting from enable_shared_from_this should pass itself as template parameter.\nAlso consider making the constructors private and replace them with static create functions returning shared pointers to ensure that objects are actually owned by shared pointers.", "author": "havardpe", "createdAt": "2020-02-21T10:22:07Z", "path": "searchcore/src/vespa/searchcore/proton/server/searchview.h", "diffHunk": "@@ -8,7 +8,7 @@\n \n namespace proton {\n \n-class SearchView : public ISearchHandler\n+class SearchView : public ISearchHandler, public std::enable_shared_from_this<ISearchHandler>", "originalCommit": "c4a01e6c3b85eb18ece1c4b5d9f337b08ba3b76d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjkzOTU2NQ==", "url": "https://github.com/vespa-engine/vespa/pull/12225#discussion_r382939565", "bodyText": "Fixed.", "author": "baldersheim", "createdAt": "2020-02-22T20:32:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjUwNDE0OQ=="}], "type": "inlineReview"}, {"oid": "6a31d94bcc91fad03a8f4058edc9139d29c58118", "url": "https://github.com/vespa-engine/vespa/commit/6a31d94bcc91fad03a8f4058edc9139d29c58118", "message": "Only expose shared_ptr", "committedDate": "2020-02-21T17:53:37Z", "type": "commit"}, {"oid": "fb751b67469af516373874a44c307fa1af2c6a83", "url": "https://github.com/vespa-engine/vespa/commit/fb751b67469af516373874a44c307fa1af2c6a83", "message": "Allow passing const SearchView", "committedDate": "2020-02-22T21:31:21Z", "type": "commit"}]}