{"pr_number": 14295, "pr_title": "Add content bucket DB metrics and reduce memory footprint", "pr_createdAt": "2020-09-04T16:06:51Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/14295", "timeline": [{"oid": "ca28ce90eaf1c4f247ce70533bb5937bce8755a6", "url": "https://github.com/vespa-engine/vespa/commit/ca28ce90eaf1c4f247ce70533bb5937bce8755a6", "message": "Add content node bucket DB memory usage metrics", "committedDate": "2020-09-04T15:30:24Z", "type": "commit"}, {"oid": "248e1a26010de03a51e1662015899dd1554d163f", "url": "https://github.com/vespa-engine/vespa/commit/248e1a26010de03a51e1662015899dd1554d163f", "message": "Reintroduce DataStore ctor taking explicit min_arrays argument\n\nLets caller specify a reasonable minimum array count without needing\nto create an explicit buffer.\n\nUse explicit `min_arrays=1024` for content node bucket DB `DataStore`.\nReduces default memory footprint of an empty (or sparsely populated)\ncontent node bucket DB with a factor of more than 1200x.", "committedDate": "2020-09-04T15:57:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc3MDc4Ng==", "url": "https://github.com/vespa-engine/vespa/pull/14295#discussion_r483770786", "bodyText": "You should probably count everything as 'used' as well.", "author": "geirst", "createdAt": "2020-09-04T17:52:51Z", "path": "storage/src/vespa/storage/bucketdb/lockablemap.hpp", "diffHunk": "@@ -85,6 +85,15 @@ LockableMap<Map>::getMemoryUsage() const noexcept\n         sizeof(std::mutex) + sizeof(std::condition_variable);\n }\n \n+template <typename Map>\n+vespalib::MemoryUsage LockableMap<Map>::detailed_memory_usage() const noexcept {\n+    // We don't have any details for this map type, just count everything as \"allocated\".\n+    size_t used = getMemoryUsage();\n+    vespalib::MemoryUsage mem_usage;\n+    mem_usage.incAllocatedBytes(used);", "originalCommit": "ca28ce90eaf1c4f247ce70533bb5937bce8755a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI3NTI4Mg==", "url": "https://github.com/vespa-engine/vespa/pull/14295#discussion_r484275282", "bodyText": "Good point, done", "author": "vekterli", "createdAt": "2020-09-07T08:30:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc3MDc4Ng=="}], "type": "inlineReview"}, {"oid": "55742ef2731b333a057baa2f0d3c4d0a13e0dffe", "url": "https://github.com/vespa-engine/vespa/commit/55742ef2731b333a057baa2f0d3c4d0a13e0dffe", "message": "Also count memory as used for legacy DB memory stats", "committedDate": "2020-09-07T08:29:41Z", "type": "commit"}]}