{"pr_number": 15673, "pr_title": "Retry reconfiguration if another one is in progress", "pr_createdAt": "2020-12-04T12:28:26Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/15673", "timeline": [{"oid": "62f160914b073b552fbc6286278bfcebe73ce5cc", "url": "https://github.com/vespa-engine/vespa/commit/62f160914b073b552fbc6286278bfcebe73ce5cc", "message": "Retry reconfiguration if another one is in progress", "committedDate": "2020-12-04T12:25:08Z", "type": "commit"}, {"oid": "4e360658e832106ccff64f49d9f591841fe7a51d", "url": "https://github.com/vespa-engine/vespa/commit/4e360658e832106ccff64f49d9f591841fe7a51d", "message": "Split out constant", "committedDate": "2020-12-04T12:28:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA2NzA3MA==", "url": "https://github.com/vespa-engine/vespa/pull/15673#discussion_r536067070", "bodyText": "This seems too long. How about 30 seconds? Typically there will only be one config change and subsequent reconfigs on other nodes will effectively be no-ops.", "author": "mpolden", "createdAt": "2020-12-04T12:33:01Z", "path": "zookeeper-server/zookeeper-server-3.5.6/src/main/java/com/yahoo/vespa/zookeeper/Reconfigurer.java", "diffHunk": "@@ -26,6 +27,7 @@\n \n     private static final Logger log = java.util.logging.Logger.getLogger(Reconfigurer.class.getName());\n     private static final Duration sessionTimeout = Duration.ofSeconds(30);\n+    private static final Duration retryReconfigurationPeriod = Duration.ofMinutes(5);", "originalCommit": "4e360658e832106ccff64f49d9f591841fe7a51d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA3MDU3Ng==", "url": "https://github.com/vespa-engine/vespa/pull/15673#discussion_r536070576", "bodyText": "Yes, I have no idea how long this should be. But we can try 30 seconds", "author": "hmusum", "createdAt": "2020-12-04T12:39:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA2NzA3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA2ODU2MQ==", "url": "https://github.com/vespa-engine/vespa/pull/15673#discussion_r536068561", "bodyText": "Consider making the sleeper configurable by having an instance of Consumer<Duration> in this class, then the unit test doesn't actually have to sleep.", "author": "mpolden", "createdAt": "2020-12-04T12:35:36Z", "path": "zookeeper-server/zookeeper-server-3.5.6/src/main/java/com/yahoo/vespa/zookeeper/Reconfigurer.java", "diffHunk": "@@ -86,7 +88,26 @@ private void reconfigure(ZookeeperServerConfig newConfig) {\n         joiningServers = joiningServers.isEmpty() ? null : joiningServers;\n         log.log(Level.INFO, \"Will reconfigure ZooKeeper cluster. Joining servers: \" + joiningServers +\n                             \", leaving servers: \" + leavingServers);\n-        zooKeeperReconfigure(connectionSpec(activeConfig), joiningServers, leavingServers);\n+\n+        String connectionSpec = connectionSpec(activeConfig);\n+        boolean reconfigured = false;\n+        Instant end = Instant.now().plus(retryReconfigurationPeriod);\n+        // Loop reconfiguring since we might need to wait until another reconfiguration is finished before we can succeed\n+        while ( ! reconfigured && Instant.now().isBefore(end)) {\n+            try {\n+                zooKeeperReconfigure(connectionSpec, joiningServers, leavingServers);\n+                reconfigured = true;\n+            } catch (KeeperException e) {\n+                if ( ! (e instanceof KeeperException.ReconfigInProgress))\n+                    throw new RuntimeException(e);\n+                log.log(Level.INFO, \"Will retry in 1 second\");\n+                try {\n+                    Thread.sleep(1000);", "originalCommit": "4e360658e832106ccff64f49d9f591841fe7a51d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA2OTY3NQ==", "url": "https://github.com/vespa-engine/vespa/pull/15673#discussion_r536069675", "bodyText": "Consider extracting a constant for the sleep period that is used both in the log message and sleep parameter.", "author": "mpolden", "createdAt": "2020-12-04T12:37:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA2ODU2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA4NDExOQ==", "url": "https://github.com/vespa-engine/vespa/pull/15673#discussion_r536084119", "bodyText": "Good suggestions, will implement", "author": "hmusum", "createdAt": "2020-12-04T13:02:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA2ODU2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA3MDQ2MA==", "url": "https://github.com/vespa-engine/vespa/pull/15673#discussion_r536070460", "bodyText": "Consider logging how long reconfig took, so that we can fine-tune the timeouts.", "author": "mpolden", "createdAt": "2020-12-04T12:38:54Z", "path": "zookeeper-server/zookeeper-server-3.5.6/src/main/java/com/yahoo/vespa/zookeeper/Reconfigurer.java", "diffHunk": "@@ -86,7 +88,26 @@ private void reconfigure(ZookeeperServerConfig newConfig) {\n         joiningServers = joiningServers.isEmpty() ? null : joiningServers;\n         log.log(Level.INFO, \"Will reconfigure ZooKeeper cluster. Joining servers: \" + joiningServers +\n                             \", leaving servers: \" + leavingServers);\n-        zooKeeperReconfigure(connectionSpec(activeConfig), joiningServers, leavingServers);\n+\n+        String connectionSpec = connectionSpec(activeConfig);\n+        boolean reconfigured = false;\n+        Instant end = Instant.now().plus(retryReconfigurationPeriod);\n+        // Loop reconfiguring since we might need to wait until another reconfiguration is finished before we can succeed\n+        while ( ! reconfigured && Instant.now().isBefore(end)) {\n+            try {\n+                zooKeeperReconfigure(connectionSpec, joiningServers, leavingServers);\n+                reconfigured = true;", "originalCommit": "4e360658e832106ccff64f49d9f591841fe7a51d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA3MDg1Mw==", "url": "https://github.com/vespa-engine/vespa/pull/15673#discussion_r536070853", "bodyText": "Yes, good idea", "author": "hmusum", "createdAt": "2020-12-04T12:39:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA3MDQ2MA=="}], "type": "inlineReview"}, {"oid": "a0a120474cfd719ef6aeebfbd780f43b86b2f6e0", "url": "https://github.com/vespa-engine/vespa/commit/a0a120474cfd719ef6aeebfbd780f43b86b2f6e0", "message": "Implement suggestions from review (sleeper, more logging, sleep shorter)", "committedDate": "2020-12-04T13:03:03Z", "type": "commit"}]}