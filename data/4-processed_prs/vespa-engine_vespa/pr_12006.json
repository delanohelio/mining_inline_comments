{"pr_number": 12006, "pr_title": "Prepare for setting PERMANENTLY_DOWN", "pr_createdAt": "2020-01-30T10:23:22Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/12006", "timeline": [{"oid": "cac9c69875dee164b45c1eddfbc2322eaa97a6f7", "url": "https://github.com/vespa-engine/vespa/commit/cac9c69875dee164b45c1eddfbc2322eaa97a6f7", "message": "Prepare for setting PERMANENTLY_DOWN", "committedDate": "2020-01-30T10:23:16Z", "type": "commit"}, {"oid": "a2777855122b34b49b4b98633eb131a67e74b2f7", "url": "https://github.com/vespa-engine/vespa/commit/a2777855122b34b49b4b98633eb131a67e74b2f7", "message": "Avoid setting PERMANENTLY_DOWN in mock", "committedDate": "2020-01-30T10:27:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg3MTQ0Nw==", "url": "https://github.com/vespa-engine/vespa/pull/12006#discussion_r372871447", "bodyText": "This line is fairly new. The older code read the cache counter only once, and cleared the cache only once (or didn't clear it at all). While the current code will do cache invalidation on every invocation of the returned Function. The old behavior is restored with this PR.", "author": "hakonhall", "createdAt": "2020-01-30T10:32:36Z", "path": "orchestrator/src/main/java/com/yahoo/vespa/orchestrator/status/ZookeeperStatusService.java", "diffHunk": "@@ -99,12 +99,13 @@ public boolean setHostStatus(ApplicationInstanceReference application, HostName\n \n     /**\n      * Cache is checked for freshness when this mapping is created, and may be invalidated again later\n-     * by other users of the cache. Since this function is backed by the cache, any such invalidations\n+     * by other users of the cache. Since this function is backed by the cache, any such invalidation\n      * will be reflected in the returned mapping; all users of the cache collaborate in repopulating it.\n      */\n     @Override\n-    public Function<ApplicationInstanceReference, Set<HostName>> getSuspendedHostsByApplication() {\n-        return application -> hostInfosCache.getHostInfos(application).suspendedHostsnames();", "originalCommit": "cac9c69875dee164b45c1eddfbc2322eaa97a6f7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c1985cf796f265ffb929b49f944e63158558e8da", "url": "https://github.com/vespa-engine/vespa/commit/c1985cf796f265ffb929b49f944e63158558e8da", "message": "Remove unused suspendedHostnames", "committedDate": "2020-01-30T10:37:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg4NDg2Mw==", "url": "https://github.com/vespa-engine/vespa/pull/12006#discussion_r372884863", "bodyText": "Why not just\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return hostInfosCache::getCachedHostInfos;\n          \n          \n            \n                    return hostInfosCache::getHostInfos;\n          \n      \n    \n    \n  \n\n?", "author": "freva", "createdAt": "2020-01-30T11:01:08Z", "path": "orchestrator/src/main/java/com/yahoo/vespa/orchestrator/status/ZookeeperStatusService.java", "diffHunk": "@@ -99,12 +99,13 @@ public boolean setHostStatus(ApplicationInstanceReference application, HostName\n \n     /**\n      * Cache is checked for freshness when this mapping is created, and may be invalidated again later\n-     * by other users of the cache. Since this function is backed by the cache, any such invalidations\n+     * by other users of the cache. Since this function is backed by the cache, any such invalidation\n      * will be reflected in the returned mapping; all users of the cache collaborate in repopulating it.\n      */\n     @Override\n-    public Function<ApplicationInstanceReference, Set<HostName>> getSuspendedHostsByApplication() {\n-        return application -> hostInfosCache.getHostInfos(application).suspendedHostsnames();\n+    public Function<ApplicationInstanceReference, HostInfos> getHostInfosByApplicationResolver() {\n+        hostInfosCache.refreshCache();\n+        return hostInfosCache::getCachedHostInfos;", "originalCommit": "c1985cf796f265ffb929b49f944e63158558e8da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjkwNTI4Mg==", "url": "https://github.com/vespa-engine/vespa/pull/12006#discussion_r372905282", "bodyText": "I tried to explain that to the left?", "author": "hakonhall", "createdAt": "2020-01-30T11:50:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg4NDg2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjkwNjc5MA==", "url": "https://github.com/vespa-engine/vespa/pull/12006#discussion_r372906790", "bodyText": "\ud83e\udd26\u200d\u2642\ufe0f", "author": "freva", "createdAt": "2020-01-30T11:54:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg4NDg2Mw=="}], "type": "inlineReview"}]}