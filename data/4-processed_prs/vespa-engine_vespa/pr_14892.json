{"pr_number": 14892, "pr_title": "handle both engine- and factory-based tensors", "pr_createdAt": "2020-10-15T08:28:52Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/14892", "timeline": [{"oid": "08393e9e14635f1c6a6c84650c25023a0db7ed0b", "url": "https://github.com/vespa-engine/vespa/commit/08393e9e14635f1c6a6c84650c25023a0db7ed0b", "message": "handle both engine- and factory-based tensors\n\n* use EngineOrFactory::get() instead of DefaultTensorEngine::ref()\n* avoid direct use of DenseTensorView etc where possible\n* use eval::Value instead of tensor::Tensor where possible", "committedDate": "2020-10-15T08:18:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQxNDAzNg==", "url": "https://github.com/vespa-engine/vespa/pull/14892#discussion_r505414036", "bodyText": "prefer not using is_tensor, consider checking the type or spec for validity instead.", "author": "havardpe", "createdAt": "2020-10-15T09:54:30Z", "path": "document/src/tests/documentupdatetestcase.cpp", "diffHunk": "@@ -771,11 +772,12 @@ TEST(DocumentUpdateTest, testMapValueUpdate)\n     EXPECT_EQ(fv4->find(StringFieldValue(\"apple\")), fv4->end());\n }\n \n-std::unique_ptr<Tensor>\n+std::unique_ptr<vespalib::eval::Value>\n makeTensor(const TensorSpec &spec)\n {\n-    auto result = DefaultTensorEngine::ref().from_spec(spec);\n-    return std::unique_ptr<Tensor>(dynamic_cast<Tensor*>(result.release()));\n+    auto result = EngineOrFactory::get().from_spec(spec);\n+    EXPECT_TRUE(result->is_tensor());", "originalCommit": "08393e9e14635f1c6a6c84650c25023a0db7ed0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQxOTg4Mg==", "url": "https://github.com/vespa-engine/vespa/pull/14892#discussion_r505419882", "bodyText": "combine lines?", "author": "havardpe", "createdAt": "2020-10-15T10:03:04Z", "path": "searchcore/src/tests/proton/common/attribute_updater/attribute_updater_test.cpp", "diffHunk": "@@ -442,7 +442,9 @@ struct TensorFixture : public Fixture {\n     }\n \n     void assertTensor(const TensorSpec &expSpec) {\n-        EXPECT_EQUAL(expSpec, attribute->getTensor(1)->toSpec());\n+        auto engine = EngineOrFactory::get();\n+        auto actual = engine.to_spec(*attribute->getTensor(1));", "originalCommit": "08393e9e14635f1c6a6c84650c25023a0db7ed0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQyMDEyNQ==", "url": "https://github.com/vespa-engine/vespa/pull/14892#discussion_r505420125", "bodyText": "just return here?", "author": "havardpe", "createdAt": "2020-10-15T10:03:29Z", "path": "searchcore/src/tests/proton/docsummary/docsummary.cpp", "diffHunk": "@@ -139,9 +138,9 @@ getDocTypeName()\n     return \"searchdocument\";\n }\n \n-Tensor::UP make_tensor(const TensorSpec &spec) {\n-    auto tensor = DefaultTensorEngine::ref().from_spec(spec);\n-    return Tensor::UP(dynamic_cast<Tensor*>(tensor.release()));\n+vespalib::eval::Value::UP make_tensor(const TensorSpec &spec) {\n+    auto tensor = EngineOrFactory::get().from_spec(spec);", "originalCommit": "08393e9e14635f1c6a6c84650c25023a0db7ed0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQyMzY5MQ==", "url": "https://github.com/vespa-engine/vespa/pull/14892#discussion_r505423691", "bodyText": "prefer checking type instead obj.get().type().is_double()", "author": "havardpe", "createdAt": "2020-10-15T10:09:40Z", "path": "searchcore/src/vespa/searchcore/proton/matching/docsum_matcher.cpp", "diffHunk": "@@ -71,9 +72,9 @@ get_feature_set(const MatchToolsFactory &mtf,\n             for (uint32_t j = 0; j < featureNames.size(); ++j) {\n                 if (resolver.is_object(j)) {\n                     auto obj = resolver.resolve(j).as_object(docId);\n-                    if (const auto *tensor = obj.get().as_tensor()) {\n+                    if (! obj.get().is_double()) {", "originalCommit": "08393e9e14635f1c6a6c84650c25023a0db7ed0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQyODczMw==", "url": "https://github.com/vespa-engine/vespa/pull/14892#discussion_r505428733", "bodyText": "return here?", "author": "havardpe", "createdAt": "2020-10-15T10:18:41Z", "path": "searchlib/src/tests/attribute/tensorattribute/tensorattribute_test.cpp", "diffHunk": "@@ -50,36 +50,19 @@ using search::tensor::PrepareResult;\n using search::tensor::TensorAttribute;\n using vespalib::eval::TensorSpec;\n using vespalib::eval::ValueType;\n-using vespalib::tensor::DefaultTensorEngine;\n-using vespalib::tensor::DenseTensor;\n-using vespalib::tensor::DenseTensorView;\n-using vespalib::tensor::Tensor;\n+using vespalib::eval::Value;\n+using vespalib::eval::EngineOrFactory;\n \n using DoubleVector = std::vector<double>;\n using generation_t = vespalib::GenerationHandler::generation_t;\n \n-namespace vespalib::tensor {\n-\n-static bool operator==(const Tensor &lhs, const Tensor &rhs)\n-{\n-    return lhs.equals(rhs);\n-}\n-\n-}\n-\n vespalib::string sparseSpec(\"tensor(x{},y{})\");\n vespalib::string denseSpec(\"tensor(x[2],y[3])\");\n vespalib::string vec_2d_spec(\"tensor(x[2])\");\n \n-Tensor::UP createTensor(const TensorSpec &spec) {\n-    auto value = DefaultTensorEngine::ref().from_spec(spec);\n-    if (value->is_double()) {\n-        return Tensor::UP(new DenseTensor<double>(ValueType::double_type(), {value->as_double()}));\n-    }\n-    Tensor *tensor = dynamic_cast<Tensor*>(value.get());\n-    ASSERT_TRUE(tensor != nullptr);\n-    value.release();\n-    return Tensor::UP(tensor);\n+Value::UP createTensor(const TensorSpec &spec) {\n+    auto value = EngineOrFactory::get().from_spec(spec);", "originalCommit": "08393e9e14635f1c6a6c84650c25023a0db7ed0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQyOTIwMQ==", "url": "https://github.com/vespa-engine/vespa/pull/14892#discussion_r505429201", "bodyText": "return here?", "author": "havardpe", "createdAt": "2020-10-15T10:19:32Z", "path": "searchlib/src/tests/attribute/tensorattribute/tensorattribute_test.cpp", "diffHunk": "@@ -922,12 +903,9 @@ class NearestNeighborBlueprintFixture : public DenseTensorAttributeMockIndex {\n         set_tensor(10, vec_2d(0, 0));\n     }\n \n-    std::unique_ptr<QueryTensor> createDenseTensor(const TensorSpec &spec) {\n-        auto value = DefaultTensorEngine::ref().from_spec(spec);\n-        QueryTensor *tensor = dynamic_cast<QueryTensor *>(value.get());\n-        ASSERT_TRUE(tensor != nullptr);\n-        value.release();\n-        return std::unique_ptr<QueryTensor>(tensor);\n+    std::unique_ptr<Value> createDenseTensor(const TensorSpec &spec) {\n+        auto value = EngineOrFactory::get().from_spec(spec);", "originalCommit": "08393e9e14635f1c6a6c84650c25023a0db7ed0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQyOTY0Mw==", "url": "https://github.com/vespa-engine/vespa/pull/14892#discussion_r505429643", "bodyText": "return here?", "author": "havardpe", "createdAt": "2020-10-15T10:20:18Z", "path": "searchlib/src/tests/features/tensor_from_weighted_set/tensor_from_weighted_set_test.cpp", "diffHunk": "@@ -27,21 +28,20 @@ using search::StringAttribute;\n using vespalib::eval::Value;\n using vespalib::eval::Function;\n using vespalib::eval::TensorSpec;\n-using vespalib::tensor::Tensor;\n-using vespalib::tensor::DefaultTensorEngine;\n+using vespalib::eval::EngineOrFactory;\n \n typedef search::attribute::Config AVC;\n typedef search::attribute::BasicType AVBT;\n typedef search::attribute::CollectionType AVCT;\n typedef search::AttributeVector::SP AttributePtr;\n typedef FtTestApp FTA;\n \n-Tensor::UP make_tensor(const TensorSpec &spec) {\n-    auto tensor = DefaultTensorEngine::ref().from_spec(spec);\n-    return Tensor::UP(dynamic_cast<Tensor*>(tensor.release()));\n+Value::UP make_tensor(const TensorSpec &spec) {\n+    auto tensor = EngineOrFactory::get().from_spec(spec);", "originalCommit": "08393e9e14635f1c6a6c84650c25023a0db7ed0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQzMDExOQ==", "url": "https://github.com/vespa-engine/vespa/pull/14892#discussion_r505430119", "bodyText": "return here?", "author": "havardpe", "createdAt": "2020-10-15T10:21:06Z", "path": "searchlib/src/tests/tensor/dense_tensor_store/dense_tensor_store_test.cpp", "diffHunk": "@@ -3,26 +3,28 @@\n LOG_SETUP(\"dense_tensor_store_test\");\n #include <vespa/vespalib/testkit/test_kit.h>\n #include <vespa/searchlib/tensor/dense_tensor_store.h>\n+#include <vespa/eval/eval/engine_or_factory.h>\n #include <vespa/eval/eval/tensor_spec.h>\n+#include <vespa/eval/eval/test/value_compare.h>\n+#include <vespa/eval/eval/value.h>\n #include <vespa/eval/eval/value_type.h>\n #include <vespa/eval/tensor/default_tensor_engine.h>\n-#include <vespa/eval/tensor/tensor.h>\n #include <vespa/eval/tensor/dense/mutable_dense_tensor_view.h>\n \n using search::tensor::DenseTensorStore;\n using vespalib::eval::TensorSpec;\n+using vespalib::eval::Value;\n using vespalib::eval::ValueType;\n+using vespalib::eval::EngineOrFactory;\n using vespalib::tensor::MutableDenseTensorView;\n-using vespalib::tensor::Tensor;\n-using vespalib::tensor::DefaultTensorEngine;\n \n using EntryRef = DenseTensorStore::EntryRef;\n \n-Tensor::UP\n+Value::UP\n makeTensor(const TensorSpec &spec)\n {\n-    auto tensor = DefaultTensorEngine::ref().from_spec(spec);\n-    return Tensor::UP(dynamic_cast<Tensor *>(tensor.release()));\n+    auto tensor = EngineOrFactory::get().from_spec(spec);", "originalCommit": "08393e9e14635f1c6a6c84650c25023a0db7ed0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQzMDkyMg==", "url": "https://github.com/vespa-engine/vespa/pull/14892#discussion_r505430922", "bodyText": "query_tensor->type() -> qt_type", "author": "havardpe", "createdAt": "2020-10-15T10:22:34Z", "path": "searchlib/src/vespa/searchlib/attribute/attribute_blueprint_factory.cpp", "diffHunk": "@@ -724,19 +723,17 @@ class CreateBlueprintVisitor : public CreateBlueprintVisitorHelper\n         if (query_tensor.get() == nullptr) {\n             return fail_nearest_neighbor_term(n, \"Query tensor was not found in request context\");\n         }\n-        auto* dense_query_tensor = dynamic_cast<DenseTensorView*>(query_tensor.get());\n-        if (dense_query_tensor == nullptr) {\n+        const auto & qt_type = query_tensor->type();\n+        if (! qt_type.is_dense()) {\n             return fail_nearest_neighbor_term(n, make_string(\"Query tensor is not a dense tensor (type=%s)\",\n                                                              query_tensor->type().to_spec().c_str()));\n         }\n-        if (!is_compatible_for_nearest_neighbor(dense_attr_tensor->getTensorType(), dense_query_tensor->type())) {\n+        if (!is_compatible_for_nearest_neighbor(dense_attr_tensor->getTensorType(), qt_type)) {\n             return fail_nearest_neighbor_term(n, make_string(\"Attribute tensor type (%s) and query tensor type (%s) are not compatible\",\n-                                                             dense_attr_tensor->getTensorType().to_spec().c_str(), dense_query_tensor->type().to_spec().c_str()));\n+                                                             dense_attr_tensor->getTensorType().to_spec().c_str(), query_tensor->type().to_spec().c_str()));", "originalCommit": "08393e9e14635f1c6a6c84650c25023a0db7ed0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ1MzI3NQ==", "url": "https://github.com/vespa-engine/vespa/pull/14892#discussion_r505453275", "bodyText": "Consider return {}; instead.", "author": "geirst", "createdAt": "2020-10-15T11:02:36Z", "path": "document/src/vespa/document/update/tensor_add_update.cpp", "diffHunk": "@@ -78,14 +82,34 @@ TensorAddUpdate::checkCompatibility(const Field& field) const\n     }\n }\n \n-std::unique_ptr<Tensor>\n-TensorAddUpdate::applyTo(const Tensor &tensor) const\n+namespace {\n+\n+std::unique_ptr<vespalib::eval::Value>\n+old_add(const vespalib::eval::Value *input,\n+        const vespalib::eval::Value *add_cells)\n+{\n+    auto a = dynamic_cast<const vespalib::tensor::Tensor *>(input);\n+    assert(a);\n+    auto b = dynamic_cast<const vespalib::tensor::Tensor *>(add_cells);\n+    assert(b);\n+    return a->add(*b);\n+}\n+\n+} // namespace\n+\n+std::unique_ptr<vespalib::eval::Value>\n+TensorAddUpdate::applyTo(const vespalib::eval::Value &tensor) const\n {\n     auto addTensor = _tensor->getAsTensorPtr();\n     if (addTensor) {\n-        return tensor.add(*addTensor);\n+        auto engine = EngineOrFactory::get();\n+        if (engine.is_factory()) {\n+            return TensorPartialUpdate::add(tensor, *addTensor, engine.factory());\n+        } else {\n+            return old_add(&tensor, addTensor);\n+        }\n     }\n-    return std::unique_ptr<Tensor>();\n+    return std::unique_ptr<vespalib::eval::Value>();", "originalCommit": "08393e9e14635f1c6a6c84650c25023a0db7ed0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ1MzM5NA==", "url": "https://github.com/vespa-engine/vespa/pull/14892#discussion_r505453394", "bodyText": "Consider return {}; instead.", "author": "geirst", "createdAt": "2020-10-15T11:02:49Z", "path": "document/src/vespa/document/update/tensor_modify_update.cpp", "diffHunk": "@@ -156,16 +160,32 @@ TensorModifyUpdate::checkCompatibility(const Field& field) const\n     }\n }\n \n-std::unique_ptr<Tensor>\n-TensorModifyUpdate::applyTo(const Tensor &tensor) const\n+\n+std::unique_ptr<vespalib::eval::Value>\n+old_modify(const vespalib::eval::Value *input,\n+           const vespalib::eval::Value *modify_spec,\n+           join_fun_t function)\n+{\n+    auto a = dynamic_cast<const vespalib::tensor::Tensor *>(input);\n+    // Cells tensor being sparse was validated during deserialize().\n+    auto b = dynamic_cast<const vespalib::tensor::SparseTensor *>(modify_spec);\n+    vespalib::tensor::CellValues cellValues(*b);\n+    return a->modify(function, cellValues);\n+}\n+\n+std::unique_ptr<vespalib::eval::Value>\n+TensorModifyUpdate::applyTo(const vespalib::eval::Value &tensor) const\n {\n     auto cellsTensor = _tensor->getAsTensorPtr();\n     if (cellsTensor) {\n-        // Cells tensor being sparse was validated during deserialize().\n-        vespalib::tensor::CellValues cellValues(static_cast<const vespalib::tensor::SparseTensor &>(*cellsTensor));\n-        return tensor.modify(getJoinFunction(_operation), cellValues);\n+        auto engine = EngineOrFactory::get();\n+        if (engine.is_factory()) {\n+            return TensorPartialUpdate::modify(tensor, getJoinFunction(_operation), *cellsTensor, engine.factory());\n+        } else {\n+            return old_modify(&tensor, cellsTensor, getJoinFunction(_operation));\n+        }\n     }\n-    return std::unique_ptr<Tensor>();\n+    return std::unique_ptr<vespalib::eval::Value>();", "originalCommit": "08393e9e14635f1c6a6c84650c25023a0db7ed0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ1Mzc4NA==", "url": "https://github.com/vespa-engine/vespa/pull/14892#discussion_r505453784", "bodyText": "Consider return {}; instead.", "author": "geirst", "createdAt": "2020-10-15T11:03:32Z", "path": "document/src/vespa/document/update/tensor_remove_update.cpp", "diffHunk": "@@ -102,16 +117,19 @@ TensorRemoveUpdate::checkCompatibility(const Field &field) const\n     }\n }\n \n-std::unique_ptr<Tensor>\n-TensorRemoveUpdate::applyTo(const Tensor &tensor) const\n+std::unique_ptr<vespalib::eval::Value>\n+TensorRemoveUpdate::applyTo(const vespalib::eval::Value &tensor) const\n {\n     auto addressTensor = _tensor->getAsTensorPtr();\n     if (addressTensor) {\n-        // Address tensor being sparse was validated during deserialize().\n-        vespalib::tensor::CellValues cellAddresses(static_cast<const vespalib::tensor::SparseTensor &>(*addressTensor));\n-        return tensor.remove(cellAddresses);\n+        auto engine = EngineOrFactory::get();\n+        if (engine.is_factory()) {\n+            return TensorPartialUpdate::remove(tensor, *addressTensor, engine.factory());\n+        } else {\n+            return old_remove(&tensor, addressTensor);\n+        }\n     }\n-    return std::unique_ptr<Tensor>();\n+    return std::unique_ptr<vespalib::eval::Value>();", "originalCommit": "08393e9e14635f1c6a6c84650c25023a0db7ed0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ1NTExMw==", "url": "https://github.com/vespa-engine/vespa/pull/14892#discussion_r505455113", "bodyText": "Consider auto tensor instead.", "author": "geirst", "createdAt": "2020-10-15T11:06:09Z", "path": "searchcore/src/tests/proton/docsummary/docsummary.cpp", "diffHunk": "@@ -335,7 +334,7 @@ assertTensor(const Tensor::UP & exp, const std::string & fieldName,\n     EXPECT_EQUAL(exp.get() == nullptr, data.size == 0u);\n     if (exp) {\n         vespalib::nbostream x(data.data, data.size);\n-        Tensor::UP tensor = vespalib::tensor::TypedBinaryFormat::deserialize(x);\n+        vespalib::eval::Value::UP tensor = EngineOrFactory::get().decode(x);", "originalCommit": "08393e9e14635f1c6a6c84650c25023a0db7ed0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ1NjA5Ng==", "url": "https://github.com/vespa-engine/vespa/pull/14892#discussion_r505456096", "bodyText": "Consider returning here.", "author": "geirst", "createdAt": "2020-10-15T11:08:02Z", "path": "searchcore/src/tests/proton/docsummary/summaryfieldconverter_test.cpp", "diffHunk": "@@ -675,9 +676,9 @@ Test::requireThatPredicateIsPrinted()\n                 SFC::convertSummaryField(false, *doc.getValue(\"predicate\")).get());\n }\n \n-Tensor::UP make_tensor(const TensorSpec &spec) {\n-    auto tensor = DefaultTensorEngine::ref().from_spec(spec);\n-    return Tensor::UP(dynamic_cast<Tensor*>(tensor.release()));\n+Value::UP make_tensor(const TensorSpec &spec) {\n+    auto tensor = EngineOrFactory::get().from_spec(spec);", "originalCommit": "08393e9e14635f1c6a6c84650c25023a0db7ed0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ1NjMwNA==", "url": "https://github.com/vespa-engine/vespa/pull/14892#discussion_r505456304", "bodyText": "Consider returning here.", "author": "geirst", "createdAt": "2020-10-15T11:08:23Z", "path": "searchcore/src/tests/proton/common/attribute_updater/attribute_updater_test.cpp", "diffHunk": "@@ -408,11 +408,11 @@ getTensorDataType(const vespalib::string &spec)\n     return *insres.first->second;\n }\n \n-std::unique_ptr<Tensor>\n+std::unique_ptr<Value>\n makeTensor(const TensorSpec &spec)\n {\n-    auto result = DefaultTensorEngine::ref().from_spec(spec);\n-    return std::unique_ptr<Tensor>(dynamic_cast<Tensor*>(result.release()));\n+    auto result = EngineOrFactory::get().from_spec(spec);", "originalCommit": "08393e9e14635f1c6a6c84650c25023a0db7ed0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ1NjY1NQ==", "url": "https://github.com/vespa-engine/vespa/pull/14892#discussion_r505456655", "bodyText": "Consider using auto.", "author": "geirst", "createdAt": "2020-10-15T11:09:06Z", "path": "searchcore/src/tests/proton/server/documentretriever_test.cpp", "diffHunk": "@@ -110,8 +113,8 @@ const char dyn_field_nas[] = \"dynamic null attr string field\"; // in document, n\n const char position_field[] = \"position_field\";\n vespalib::string dyn_field_tensor(\"dynamic_tensor_field\");\n vespalib::string tensor_spec(\"tensor(x{})\");\n-std::unique_ptr<Tensor> static_tensor = makeTensor<Tensor>(TensorSpec(tensor_spec).add({{\"x\", \"1\"}}, 1.5));\n-std::unique_ptr<Tensor> dynamic_tensor = makeTensor<Tensor>(TensorSpec(tensor_spec).add({{\"x\", \"2\"}}, 3.5));\n+std::unique_ptr<Value> static_tensor = makeTensor<Value>(TensorSpec(tensor_spec).add({{\"x\", \"1\"}}, 1.5));", "originalCommit": "08393e9e14635f1c6a6c84650c25023a0db7ed0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ1NjcyNA==", "url": "https://github.com/vespa-engine/vespa/pull/14892#discussion_r505456724", "bodyText": "Consider using auto.", "author": "geirst", "createdAt": "2020-10-15T11:09:15Z", "path": "searchcore/src/tests/proton/server/documentretriever_test.cpp", "diffHunk": "@@ -110,8 +113,8 @@ const char dyn_field_nas[] = \"dynamic null attr string field\"; // in document, n\n const char position_field[] = \"position_field\";\n vespalib::string dyn_field_tensor(\"dynamic_tensor_field\");\n vespalib::string tensor_spec(\"tensor(x{})\");\n-std::unique_ptr<Tensor> static_tensor = makeTensor<Tensor>(TensorSpec(tensor_spec).add({{\"x\", \"1\"}}, 1.5));\n-std::unique_ptr<Tensor> dynamic_tensor = makeTensor<Tensor>(TensorSpec(tensor_spec).add({{\"x\", \"2\"}}, 3.5));\n+std::unique_ptr<Value> static_tensor = makeTensor<Value>(TensorSpec(tensor_spec).add({{\"x\", \"1\"}}, 1.5));\n+std::unique_ptr<Value> dynamic_tensor = makeTensor<Value>(TensorSpec(tensor_spec).add({{\"x\", \"2\"}}, 3.5));", "originalCommit": "08393e9e14635f1c6a6c84650c25023a0db7ed0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ1NzMxMQ==", "url": "https://github.com/vespa-engine/vespa/pull/14892#discussion_r505457311", "bodyText": "Consider using auto.", "author": "geirst", "createdAt": "2020-10-15T11:10:24Z", "path": "searchlib/src/tests/attribute/tensorattribute/tensorattribute_test.cpp", "diffHunk": "@@ -435,14 +418,14 @@ struct Fixture {\n \n     void assertGetNoTensor(uint32_t docId) {\n         AttributeGuard guard(_attr);\n-        Tensor::UP actTensor = _tensorAttr->getTensor(docId);\n+        Value::UP actTensor = _tensorAttr->getTensor(docId);", "originalCommit": "08393e9e14635f1c6a6c84650c25023a0db7ed0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ1NzQxMQ==", "url": "https://github.com/vespa-engine/vespa/pull/14892#discussion_r505457411", "bodyText": "Consider using auto.", "author": "geirst", "createdAt": "2020-10-15T11:10:32Z", "path": "searchlib/src/tests/attribute/tensorattribute/tensorattribute_test.cpp", "diffHunk": "@@ -435,14 +418,14 @@ struct Fixture {\n \n     void assertGetNoTensor(uint32_t docId) {\n         AttributeGuard guard(_attr);\n-        Tensor::UP actTensor = _tensorAttr->getTensor(docId);\n+        Value::UP actTensor = _tensorAttr->getTensor(docId);\n         EXPECT_FALSE(actTensor);\n     }\n \n     void assertGetTensor(const TensorSpec &expSpec, uint32_t docId) {\n-        Tensor::UP expTensor = createTensor(expSpec);\n+        Value::UP expTensor = createTensor(expSpec);", "originalCommit": "08393e9e14635f1c6a6c84650c25023a0db7ed0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ1NzQ1Ng==", "url": "https://github.com/vespa-engine/vespa/pull/14892#discussion_r505457456", "bodyText": "Consider using auto.", "author": "geirst", "createdAt": "2020-10-15T11:10:37Z", "path": "searchlib/src/tests/attribute/tensorattribute/tensorattribute_test.cpp", "diffHunk": "@@ -435,14 +418,14 @@ struct Fixture {\n \n     void assertGetNoTensor(uint32_t docId) {\n         AttributeGuard guard(_attr);\n-        Tensor::UP actTensor = _tensorAttr->getTensor(docId);\n+        Value::UP actTensor = _tensorAttr->getTensor(docId);\n         EXPECT_FALSE(actTensor);\n     }\n \n     void assertGetTensor(const TensorSpec &expSpec, uint32_t docId) {\n-        Tensor::UP expTensor = createTensor(expSpec);\n+        Value::UP expTensor = createTensor(expSpec);\n         AttributeGuard guard(_attr);\n-        Tensor::UP actTensor = _tensorAttr->getTensor(docId);\n+        Value::UP actTensor = _tensorAttr->getTensor(docId);", "originalCommit": "08393e9e14635f1c6a6c84650c25023a0db7ed0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ1NzUxMg==", "url": "https://github.com/vespa-engine/vespa/pull/14892#discussion_r505457512", "bodyText": "Consider using auto.", "author": "geirst", "createdAt": "2020-10-15T11:10:45Z", "path": "searchlib/src/tests/attribute/tensorattribute/tensorattribute_test.cpp", "diffHunk": "@@ -655,7 +638,7 @@ void\n Fixture::testEmptyTensor()\n {\n     const TensorAttribute &tensorAttr = *_tensorAttr;\n-    Tensor::UP emptyTensor = tensorAttr.getEmptyTensor();\n+    Value::UP emptyTensor = tensorAttr.getEmptyTensor();", "originalCommit": "08393e9e14635f1c6a6c84650c25023a0db7ed0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ1NzYzMQ==", "url": "https://github.com/vespa-engine/vespa/pull/14892#discussion_r505457631", "bodyText": "Consider using auto.", "author": "geirst", "createdAt": "2020-10-15T11:11:00Z", "path": "searchlib/src/tests/features/constant/constant_test.cpp", "diffHunk": "@@ -63,7 +62,7 @@ struct ExecFixture\n     void addTensor(const vespalib::string &name,\n                    const TensorSpec &spec)\n     {\n-        Tensor::UP tensor = make_tensor(spec);\n+        Value::UP tensor = make_tensor(spec);", "originalCommit": "08393e9e14635f1c6a6c84650c25023a0db7ed0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ1Nzg3MQ==", "url": "https://github.com/vespa-engine/vespa/pull/14892#discussion_r505457871", "bodyText": "Consider returning here.", "author": "geirst", "createdAt": "2020-10-15T11:11:28Z", "path": "searchlib/src/tests/features/tensor_from_labels/tensor_from_labels_test.cpp", "diffHunk": "@@ -26,21 +27,20 @@ using search::StringAttribute;\n using vespalib::eval::Value;\n using vespalib::eval::Function;\n using vespalib::eval::TensorSpec;\n-using vespalib::tensor::DefaultTensorEngine;\n-using vespalib::tensor::Tensor;\n+using vespalib::eval::EngineOrFactory;\n \n typedef search::attribute::Config AVC;\n typedef search::attribute::BasicType AVBT;\n typedef search::attribute::CollectionType AVCT;\n typedef search::AttributeVector::SP AttributePtr;\n typedef FtTestApp FTA;\n \n-Tensor::UP make_tensor(const TensorSpec &spec) {\n-    auto tensor = DefaultTensorEngine::ref().from_spec(spec);\n-    return Tensor::UP(dynamic_cast<Tensor*>(tensor.release()));\n+Value::UP make_tensor(const TensorSpec &spec) {\n+    auto tensor = EngineOrFactory::get().from_spec(spec);", "originalCommit": "08393e9e14635f1c6a6c84650c25023a0db7ed0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ1ODE1Ng==", "url": "https://github.com/vespa-engine/vespa/pull/14892#discussion_r505458156", "bodyText": "Consider using auto.", "author": "geirst", "createdAt": "2020-10-15T11:12:02Z", "path": "searchlib/src/tests/tensor/dense_tensor_store/dense_tensor_store_test.cpp", "diffHunk": "@@ -32,23 +34,23 @@ struct Fixture\n         : store(ValueType::from_spec(tensorType))\n     {}\n     void assertSetAndGetTensor(const TensorSpec &tensorSpec) {\n-        Tensor::UP expTensor = makeTensor(tensorSpec);\n+        Value::UP expTensor = makeTensor(tensorSpec);", "originalCommit": "08393e9e14635f1c6a6c84650c25023a0db7ed0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ1ODE5Mg==", "url": "https://github.com/vespa-engine/vespa/pull/14892#discussion_r505458192", "bodyText": "Consider using auto.", "author": "geirst", "createdAt": "2020-10-15T11:12:07Z", "path": "searchlib/src/tests/tensor/dense_tensor_store/dense_tensor_store_test.cpp", "diffHunk": "@@ -32,23 +34,23 @@ struct Fixture\n         : store(ValueType::from_spec(tensorType))\n     {}\n     void assertSetAndGetTensor(const TensorSpec &tensorSpec) {\n-        Tensor::UP expTensor = makeTensor(tensorSpec);\n+        Value::UP expTensor = makeTensor(tensorSpec);\n         EntryRef ref = store.setTensor(*expTensor);\n-        Tensor::UP actTensor = store.getTensor(ref);\n-        EXPECT_EQUAL(expTensor->toSpec(), actTensor->toSpec());\n+        Value::UP actTensor = store.getTensor(ref);", "originalCommit": "08393e9e14635f1c6a6c84650c25023a0db7ed0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ1ODI2MA==", "url": "https://github.com/vespa-engine/vespa/pull/14892#discussion_r505458260", "bodyText": "Consider using auto.", "author": "geirst", "createdAt": "2020-10-15T11:12:12Z", "path": "searchlib/src/tests/tensor/dense_tensor_store/dense_tensor_store_test.cpp", "diffHunk": "@@ -32,23 +34,23 @@ struct Fixture\n         : store(ValueType::from_spec(tensorType))\n     {}\n     void assertSetAndGetTensor(const TensorSpec &tensorSpec) {\n-        Tensor::UP expTensor = makeTensor(tensorSpec);\n+        Value::UP expTensor = makeTensor(tensorSpec);\n         EntryRef ref = store.setTensor(*expTensor);\n-        Tensor::UP actTensor = store.getTensor(ref);\n-        EXPECT_EQUAL(expTensor->toSpec(), actTensor->toSpec());\n+        Value::UP actTensor = store.getTensor(ref);\n+        EXPECT_EQUAL(*expTensor, *actTensor);\n         assertTensorView(ref, *expTensor);\n     }\n     void assertEmptyTensor(const TensorSpec &tensorSpec) {\n-        Tensor::UP expTensor = makeTensor(tensorSpec);\n+        Value::UP expTensor = makeTensor(tensorSpec);", "originalCommit": "08393e9e14635f1c6a6c84650c25023a0db7ed0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ1ODI5NQ==", "url": "https://github.com/vespa-engine/vespa/pull/14892#discussion_r505458295", "bodyText": "Consider using auto.", "author": "geirst", "createdAt": "2020-10-15T11:12:17Z", "path": "searchlib/src/tests/tensor/dense_tensor_store/dense_tensor_store_test.cpp", "diffHunk": "@@ -32,23 +34,23 @@ struct Fixture\n         : store(ValueType::from_spec(tensorType))\n     {}\n     void assertSetAndGetTensor(const TensorSpec &tensorSpec) {\n-        Tensor::UP expTensor = makeTensor(tensorSpec);\n+        Value::UP expTensor = makeTensor(tensorSpec);\n         EntryRef ref = store.setTensor(*expTensor);\n-        Tensor::UP actTensor = store.getTensor(ref);\n-        EXPECT_EQUAL(expTensor->toSpec(), actTensor->toSpec());\n+        Value::UP actTensor = store.getTensor(ref);\n+        EXPECT_EQUAL(*expTensor, *actTensor);\n         assertTensorView(ref, *expTensor);\n     }\n     void assertEmptyTensor(const TensorSpec &tensorSpec) {\n-        Tensor::UP expTensor = makeTensor(tensorSpec);\n+        Value::UP expTensor = makeTensor(tensorSpec);\n         EntryRef ref;\n-        Tensor::UP actTensor = store.getTensor(ref);\n+        Value::UP actTensor = store.getTensor(ref);", "originalCommit": "08393e9e14635f1c6a6c84650c25023a0db7ed0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ1OTMzMw==", "url": "https://github.com/vespa-engine/vespa/pull/14892#discussion_r505459333", "bodyText": "Consider return {}; instead.", "author": "geirst", "createdAt": "2020-10-15T11:14:15Z", "path": "searchlib/src/vespa/searchlib/tensor/dense_tensor_attribute.cpp", "diffHunk": "@@ -164,15 +160,15 @@ DenseTensorAttribute::complete_set_tensor(DocId docid, const Tensor& tensor,\n     }\n }\n \n-std::unique_ptr<Tensor>\n+std::unique_ptr<vespalib::eval::Value>\n DenseTensorAttribute::getTensor(DocId docId) const\n {\n     EntryRef ref;\n     if (docId < getCommittedDocIdLimit()) {\n         ref = _refVector[docId];\n     }\n     if (!ref.valid()) {\n-        return std::unique_ptr<Tensor>();\n+        return std::unique_ptr<vespalib::eval::Value>();", "originalCommit": "08393e9e14635f1c6a6c84650c25023a0db7ed0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ1OTcwMQ==", "url": "https://github.com/vespa-engine/vespa/pull/14892#discussion_r505459701", "bodyText": "Consider return {}; instead.", "author": "geirst", "createdAt": "2020-10-15T11:14:56Z", "path": "searchlib/src/vespa/searchlib/tensor/dense_tensor_store.cpp", "diffHunk": "@@ -131,14 +127,14 @@ DenseTensorStore::move(EntryRef ref)\n     return newraw.ref;\n }\n \n-std::unique_ptr<Tensor>\n+std::unique_ptr<Value>\n DenseTensorStore::getTensor(EntryRef ref) const\n {\n     if (!ref.valid()) {\n-        return std::unique_ptr<Tensor>();\n+        return std::unique_ptr<Value>();", "originalCommit": "08393e9e14635f1c6a6c84650c25023a0db7ed0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ2MDcyMg==", "url": "https://github.com/vespa-engine/vespa/pull/14892#discussion_r505460722", "bodyText": "Consider return {};  instead.", "author": "geirst", "createdAt": "2020-10-15T11:16:50Z", "path": "searchlib/src/vespa/searchlib/tensor/serialized_tensor_attribute.cpp", "diffHunk": "@@ -34,23 +34,23 @@ SerializedTensorAttribute::~SerializedTensorAttribute()\n }\n \n void\n-SerializedTensorAttribute::setTensor(DocId docId, const Tensor &tensor)\n+SerializedTensorAttribute::setTensor(DocId docId, const vespalib::eval::Value &tensor)\n {\n     checkTensorType(tensor);\n     EntryRef ref = _serializedTensorStore.setTensor(tensor);\n     setTensorRef(docId, ref);\n }\n \n \n-std::unique_ptr<Tensor>\n+std::unique_ptr<Value>\n SerializedTensorAttribute::getTensor(DocId docId) const\n {\n     EntryRef ref;\n     if (docId < getCommittedDocIdLimit()) {\n         ref = _refVector[docId];\n     }\n     if (!ref.valid()) {\n-        return std::unique_ptr<Tensor>();\n+        return std::unique_ptr<Value>();", "originalCommit": "08393e9e14635f1c6a6c84650c25023a0db7ed0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ2MDk0Ng==", "url": "https://github.com/vespa-engine/vespa/pull/14892#discussion_r505460946", "bodyText": "Consider return {}; instead.", "author": "geirst", "createdAt": "2020-10-15T11:17:19Z", "path": "searchlib/src/vespa/searchlib/tensor/serialized_tensor_store.cpp", "diffHunk": "@@ -87,21 +86,21 @@ SerializedTensorStore::move(EntryRef ref)\n     return newraw.ref;\n }\n \n-std::unique_ptr<Tensor>\n+std::unique_ptr<Value>\n SerializedTensorStore::getTensor(EntryRef ref) const\n {\n     auto raw = getRawBuffer(ref);\n     if (raw.second == 0u) {\n-        return std::unique_ptr<Tensor>();\n+        return std::unique_ptr<Value>();", "originalCommit": "08393e9e14635f1c6a6c84650c25023a0db7ed0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d78c40cb1330fea628684b9aaa8aa993fd70eecc", "url": "https://github.com/vespa-engine/vespa/commit/d78c40cb1330fea628684b9aaa8aa993fd70eecc", "message": "simplify", "committedDate": "2020-10-15T11:22:15Z", "type": "commit"}, {"oid": "4023419b26cb8f3f3a4cd9886596db2475d43ae3", "url": "https://github.com/vespa-engine/vespa/commit/4023419b26cb8f3f3a4cd9886596db2475d43ae3", "message": "check is_double via type", "committedDate": "2020-10-15T11:22:18Z", "type": "commit"}, {"oid": "1d0927e9658bcffdf1575decacfaf06da43d95c6", "url": "https://github.com/vespa-engine/vespa/commit/1d0927e9658bcffdf1575decacfaf06da43d95c6", "message": "use qt_type again", "committedDate": "2020-10-15T11:22:19Z", "type": "commit"}, {"oid": "740ead4c0de7533a7ff27186d1e608a87ad4b7b7", "url": "https://github.com/vespa-engine/vespa/commit/740ead4c0de7533a7ff27186d1e608a87ad4b7b7", "message": "use auto", "committedDate": "2020-10-15T11:29:04Z", "type": "commit"}, {"oid": "1210a91e2861882ba25187db1f239da78474deeb", "url": "https://github.com/vespa-engine/vespa/commit/1210a91e2861882ba25187db1f239da78474deeb", "message": "use \"return {};\" to return empty unique_ptr", "committedDate": "2020-10-15T11:29:37Z", "type": "commit"}, {"oid": "5824d277f0aad866643431af7610f808d9d9198c", "url": "https://github.com/vespa-engine/vespa/commit/5824d277f0aad866643431af7610f808d9d9198c", "message": "simplify", "committedDate": "2020-10-15T11:35:33Z", "type": "commit"}, {"oid": "73e810c5ccb25f1e24d1832684be52d4f07badfc", "url": "https://github.com/vespa-engine/vespa/commit/73e810c5ccb25f1e24d1832684be52d4f07badfc", "message": "fix spec", "committedDate": "2020-10-15T12:00:32Z", "type": "commit"}, {"oid": "d5658226bf02ba1d8438c8c0e889cdf5ae679264", "url": "https://github.com/vespa-engine/vespa/commit/d5658226bf02ba1d8438c8c0e889cdf5ae679264", "message": "fix spec", "committedDate": "2020-10-15T12:54:50Z", "type": "commit"}, {"oid": "c11a1e22c2fa9f4ff43093fd3f661e196475d1ae", "url": "https://github.com/vespa-engine/vespa/commit/c11a1e22c2fa9f4ff43093fd3f661e196475d1ae", "message": "handle more exceptions", "committedDate": "2020-10-15T12:55:03Z", "type": "commit"}, {"oid": "0d4cd6e776cafa8c9718b3420286f0b4cf297169", "url": "https://github.com/vespa-engine/vespa/commit/0d4cd6e776cafa8c9718b3420286f0b4cf297169", "message": "throw exceptions on unexpected input", "committedDate": "2020-10-15T12:56:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTU3MzE3Nw==", "url": "https://github.com/vespa-engine/vespa/pull/14892#discussion_r505573177", "bodyText": "can probably just return here", "author": "havardpe", "createdAt": "2020-10-15T14:08:35Z", "path": "searchlib/src/tests/queryeval/nearest_neighbor/nearest_neighbor_test.cpp", "diffHunk": "@@ -42,7 +42,6 @@ DistanceFunction::UP euclid_f = search::tensor::make_distance_function(DistanceM\n \n std::unique_ptr<Value> createTensor(const TensorSpec &spec) {\n     auto value = EngineOrFactory::get().from_spec(spec);", "originalCommit": "d78c40cb1330fea628684b9aaa8aa993fd70eecc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTU3NDAxMw==", "url": "https://github.com/vespa-engine/vespa/pull/14892#discussion_r505574013", "bodyText": "can probably just return here using implicit cast operator from std::reference_wrapper<>", "author": "havardpe", "createdAt": "2020-10-15T14:09:39Z", "path": "searchlib/src/tests/features/tensor_from_weighted_set/tensor_from_weighted_set_test.cpp", "diffHunk": "@@ -122,7 +121,6 @@ struct ExecFixture\n     }\n     const Value &extractTensor(uint32_t docid) {\n         Value::CREF value = test.resolveObjectFeature(docid);", "originalCommit": "d78c40cb1330fea628684b9aaa8aa993fd70eecc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTU3NDE5Ng==", "url": "https://github.com/vespa-engine/vespa/pull/14892#discussion_r505574196", "bodyText": "can probably just return here using implicit cast operator from std::reference_wrapper<>", "author": "havardpe", "createdAt": "2020-10-15T14:09:55Z", "path": "searchlib/src/tests/features/tensor_from_labels/tensor_from_labels_test.cpp", "diffHunk": "@@ -123,7 +122,6 @@ struct ExecFixture\n     }\n     const Value &extractTensor(uint32_t docid) {\n         Value::CREF value = test.resolveObjectFeature(docid);", "originalCommit": "d78c40cb1330fea628684b9aaa8aa993fd70eecc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}