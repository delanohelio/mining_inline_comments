{"pr_number": 12586, "pr_title": "Add initial metadata-only phase to inconsistent update handling ", "pr_createdAt": "2020-03-16T15:48:23Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/12586", "timeline": [{"oid": "eb28962cb8edfdc3ad75fc9298a71bf31ab96af2", "url": "https://github.com/vespa-engine/vespa/commit/eb28962cb8edfdc3ad75fc9298a71bf31ab96af2", "message": "Add initial metadata-only phase to inconsistent update handling\n\nIf bucket replicas are inconsistent, the common case is that only\na small subset of documents contained in the buckets are actually\nmutually out of sync. The added metadata phase optimizes for\nsuch a case by initially sending Get requests to all divergent\nreplicas that only ask for the timestamps (and no fields). This\nis a very cheap and fast operation. If all returned timestamps\nare in sync, the update can be restarted in the fast path.\nOtherwise, a full Get will _only_ be sent to the newest replica,\nand its result will be used for performing the update on the\ndistributor itself, before pushing out the result as Puts.\n\nThis is in contrast to today's behavior where full Gets are\nsent to all replicas. For users with large documents this\ncan be very expensive.\n\nIn addition, the metadata Get operations are sent with weak\ninternal read consistency (as they do not need to read any\npreviously written, possibly in-flight fields). This lets them\nbypass the main commit queue entirely.", "committedDate": "2020-03-16T15:14:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUyNzkzNA==", "url": "https://github.com/vespa-engine/vespa/pull/12586#discussion_r393527934", "bodyText": "Please add class comment", "author": "geirst", "createdAt": "2020-03-17T08:58:56Z", "path": "storage/src/vespa/storage/distributor/operations/external/newest_replica.h", "diffHunk": "@@ -0,0 +1,38 @@\n+#pragma once\n+\n+#include <vespa/document/bucket/bucketid.h>\n+#include <vespa/storageapi/defs.h>\n+#include <iosfwd>\n+#include <stddef.h>\n+\n+namespace storage::distributor {\n+\n+struct NewestReplica {", "originalCommit": "eb28962cb8edfdc3ad75fc9298a71bf31ab96af2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzY4MjIzNQ==", "url": "https://github.com/vespa-engine/vespa/pull/12586#discussion_r393682235", "bodyText": "Done", "author": "vekterli", "createdAt": "2020-03-17T13:34:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUyNzkzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUyODA3Ng==", "url": "https://github.com/vespa-engine/vespa/pull/12586#discussion_r393528076", "bodyText": "Please add copyright", "author": "geirst", "createdAt": "2020-03-17T08:59:11Z", "path": "storage/src/vespa/storage/distributor/operations/external/newest_replica.h", "diffHunk": "@@ -0,0 +1,38 @@\n+#pragma once", "originalCommit": "eb28962cb8edfdc3ad75fc9298a71bf31ab96af2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzY4MjM0MA==", "url": "https://github.com/vespa-engine/vespa/pull/12586#discussion_r393682340", "bodyText": "Done", "author": "vekterli", "createdAt": "2020-03-17T13:34:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUyODA3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUyODE3MA==", "url": "https://github.com/vespa-engine/vespa/pull/12586#discussion_r393528170", "bodyText": "Please add copyright", "author": "geirst", "createdAt": "2020-03-17T08:59:23Z", "path": "storage/src/vespa/storage/distributor/operations/external/newest_replica.cpp", "diffHunk": "@@ -0,0 +1,13 @@\n+#include \"newest_replica.h\"", "originalCommit": "eb28962cb8edfdc3ad75fc9298a71bf31ab96af2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzY4MjQzMw==", "url": "https://github.com/vespa-engine/vespa/pull/12586#discussion_r393682433", "bodyText": "Done", "author": "vekterli", "createdAt": "2020-03-17T13:34:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUyODE3MA=="}], "type": "inlineReview"}, {"oid": "611e572184e095ceaa0fb09e7a2da062a699b1d3", "url": "https://github.com/vespa-engine/vespa/commit/611e572184e095ceaa0fb09e7a2da062a699b1d3", "message": "Add comments and some extra safety handling of single Get command", "committedDate": "2020-03-17T13:33:14Z", "type": "commit"}]}