{"pr_number": 14849, "pr_title": "Drain all messages on flush to avoid the odd signaling on every message.", "pr_createdAt": "2020-10-14T10:02:17Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/14849", "timeline": [{"oid": "24dd0d9445e072fe3de5c146b92f75605e140da9", "url": "https://github.com/vespa-engine/vespa/commit/24dd0d9445e072fe3de5c146b92f75605e140da9", "message": "Drain all messages on flush to avoid the odd signaling on every message.", "committedDate": "2020-10-14T10:00:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDYyMTUzOA==", "url": "https://github.com/vespa-engine/vespa/pull/14849#discussion_r504621538", "bodyText": "Could potentially just check the queue size for the thread's stripe, but getQueueSize() is a superset of that stripe so shouldn't matter in practice.", "author": "vekterli", "createdAt": "2020-10-14T12:04:29Z", "path": "storage/src/vespa/storage/persistence/persistencethread.cpp", "diffHunk": "@@ -950,22 +949,15 @@ PersistenceThread::run(framework::ThreadHandle& thread)\n         if (lock.first) {\n             processLockedMessage(std::move(lock));\n         }\n-\n-        vespalib::MonitorGuard flushMonitorGuard(_flushMonitor);\n-        flushMonitorGuard.broadcast();\n     }\n     LOG(debug, \"Closing down persistence thread\");\n-    vespalib::MonitorGuard flushMonitorGuard(_flushMonitor);\n-    _closed = true;\n-    flushMonitorGuard.broadcast();\n }\n \n void\n PersistenceThread::flush()\n {\n-    vespalib::MonitorGuard flushMonitorGuard(_flushMonitor);\n-    if (!_closed) {\n-        flushMonitorGuard.wait();\n+    while (_env._fileStorHandler.getQueueSize() != 0) {", "originalCommit": "24dd0d9445e072fe3de5c146b92f75605e140da9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY1MjI0Ng==", "url": "https://github.com/vespa-engine/vespa/pull/14849#discussion_r504652246", "bodyText": "I will add an api for that after disk concept is removed.", "author": "baldersheim", "createdAt": "2020-10-14T12:54:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDYyMTUzOA=="}], "type": "inlineReview"}, {"oid": "bfdbbe4051e3e89009db4ba33cfd8d44fb606359", "url": "https://github.com/vespa-engine/vespa/commit/bfdbbe4051e3e89009db4ba33cfd8d44fb606359", "message": "Only check the stripeid.", "committedDate": "2020-10-14T12:41:13Z", "type": "commit"}, {"oid": "445096ed1e0f168b3307ded76c5e0f7745e4588e", "url": "https://github.com/vespa-engine/vespa/commit/445096ed1e0f168b3307ded76c5e0f7745e4588e", "message": "disk is not stripe....", "committedDate": "2020-10-14T12:53:10Z", "type": "commit"}]}