{"pr_number": 12733, "pr_title": "Add save and load of HNSW index", "pr_createdAt": "2020-03-27T08:45:29Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/12733", "timeline": [{"oid": "3c2f98129e223c0dbf713ad046d7e913228873a0", "url": "https://github.com/vespa-engine/vespa/commit/3c2f98129e223c0dbf713ad046d7e913228873a0", "message": "Add save and load of HNSW index\n\n* split graph data out into a simpler struct\n* implement HnswIndexSaver\n* implement HnswIndexLoader\n* add unit test checking that saving and loading\n  works as expected", "committedDate": "2020-03-26T14:52:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIwNDMwMQ==", "url": "https://github.com/vespa-engine/vespa/pull/12733#discussion_r399204301", "bodyText": "Consider using = default; instead", "author": "geirst", "createdAt": "2020-03-27T11:38:39Z", "path": "searchlib/src/vespa/searchlib/tensor/hnsw_graph.cpp", "diffHunk": "@@ -0,0 +1,51 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#include \"hnsw_graph.h\"\n+#include \"hnsw_index.h\"\n+#include <vespa/vespalib/datastore/array_store.hpp>\n+#include <vespa/vespalib/util/rcuvector.hpp>\n+\n+namespace search::tensor {\n+\n+HnswGraph::HnswGraph()\n+  : node_refs(),\n+    nodes(HnswIndex::make_default_node_store_config()),\n+    links(HnswIndex::make_default_link_store_config()),\n+    entry_docid(0), // Note that docid 0 is reserved and never used\n+    entry_level(-1)\n+{}\n+\n+HnswGraph::~HnswGraph() {}", "originalCommit": "3c2f98129e223c0dbf713ad046d7e913228873a0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIwOTY1MA==", "url": "https://github.com/vespa-engine/vespa/pull/12733#discussion_r399209650", "bodyText": "Consider '{' on next line as used elsewhere.", "author": "geirst", "createdAt": "2020-03-27T11:49:34Z", "path": "searchlib/src/vespa/searchlib/tensor/hnsw_graph.cpp", "diffHunk": "@@ -0,0 +1,51 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#include \"hnsw_graph.h\"\n+#include \"hnsw_index.h\"\n+#include <vespa/vespalib/datastore/array_store.hpp>\n+#include <vespa/vespalib/util/rcuvector.hpp>\n+\n+namespace search::tensor {\n+\n+HnswGraph::HnswGraph()\n+  : node_refs(),\n+    nodes(HnswIndex::make_default_node_store_config()),\n+    links(HnswIndex::make_default_link_store_config()),\n+    entry_docid(0), // Note that docid 0 is reserved and never used\n+    entry_level(-1)\n+{}\n+\n+HnswGraph::~HnswGraph() {}\n+\n+void\n+HnswGraph::make_node_for_document(uint32_t docid, uint32_t num_levels) {", "originalCommit": "3c2f98129e223c0dbf713ad046d7e913228873a0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIwOTcwNg==", "url": "https://github.com/vespa-engine/vespa/pull/12733#discussion_r399209706", "bodyText": "Consider '{' on next line as used elsewhere.", "author": "geirst", "createdAt": "2020-03-27T11:49:41Z", "path": "searchlib/src/vespa/searchlib/tensor/hnsw_graph.cpp", "diffHunk": "@@ -0,0 +1,51 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#include \"hnsw_graph.h\"\n+#include \"hnsw_index.h\"\n+#include <vespa/vespalib/datastore/array_store.hpp>\n+#include <vespa/vespalib/util/rcuvector.hpp>\n+\n+namespace search::tensor {\n+\n+HnswGraph::HnswGraph()\n+  : node_refs(),\n+    nodes(HnswIndex::make_default_node_store_config()),\n+    links(HnswIndex::make_default_link_store_config()),\n+    entry_docid(0), // Note that docid 0 is reserved and never used\n+    entry_level(-1)\n+{}\n+\n+HnswGraph::~HnswGraph() {}\n+\n+void\n+HnswGraph::make_node_for_document(uint32_t docid, uint32_t num_levels) {\n+    node_refs.ensure_size(docid + 1, AtomicEntryRef());\n+    // A document cannot be added twice.\n+    assert(!node_refs[docid].load_acquire().valid());\n+    // Note: The level array instance lives as long as the document is present in the index.\n+    vespalib::Array<AtomicEntryRef> levels(num_levels, AtomicEntryRef());\n+    auto node_ref = nodes.add(levels);\n+    node_refs[docid].store_release(node_ref);\n+}\n+\n+void\n+HnswGraph::remove_node_for_document(uint32_t docid) {", "originalCommit": "3c2f98129e223c0dbf713ad046d7e913228873a0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIxMjM5Nw==", "url": "https://github.com/vespa-engine/vespa/pull/12733#discussion_r399212397", "bodyText": "Please add class description.", "author": "geirst", "createdAt": "2020-03-27T11:55:09Z", "path": "searchlib/src/vespa/searchlib/tensor/hnsw_index_loader.h", "diffHunk": "@@ -0,0 +1,20 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#pragma once\n+\n+namespace search::fileutil { class LoadedBuffer; }\n+\n+namespace search::tensor {\n+\n+class HnswGraph;\n+\n+class HnswIndexLoader {", "originalCommit": "3c2f98129e223c0dbf713ad046d7e913228873a0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIxMzUwNA==", "url": "https://github.com/vespa-engine/vespa/pull/12733#discussion_r399213504", "bodyText": "Consider using '{' instead of one line if statements. Applies to rest of function as well.", "author": "geirst", "createdAt": "2020-03-27T11:57:34Z", "path": "searchlib/src/vespa/searchlib/tensor/hnsw_index_loader.cpp", "diffHunk": "@@ -0,0 +1,48 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#include \"hnsw_index_loader.h\"\n+#include \"hnsw_graph.h\"\n+#include <vespa/searchlib/util/fileutil.h>\n+\n+namespace search::tensor {\n+\n+HnswIndexLoader::~HnswIndexLoader() {}\n+\n+HnswIndexLoader::HnswIndexLoader(HnswGraph &graph)\n+    : _graph(graph)\n+{\n+}\n+\n+bool\n+HnswIndexLoader::load(const fileutil::LoadedBuffer& buf)\n+{\n+    size_t num_readable = buf.size(sizeof(uint32_t));\n+    if (num_readable < 3) return false;", "originalCommit": "3c2f98129e223c0dbf713ad046d7e913228873a0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIxMzg3MA==", "url": "https://github.com/vespa-engine/vespa/pull/12733#discussion_r399213870", "bodyText": "I suggest we change NearestNeighborIndex::load() to return a bool instead. Then we can choose what to do with an error case on a higher level.", "author": "geirst", "createdAt": "2020-03-27T11:58:28Z", "path": "searchlib/src/vespa/searchlib/tensor/hnsw_index.cpp", "diffHunk": "@@ -439,13 +386,17 @@ HnswIndex::get_state(const vespalib::slime::Inserter& inserter) const\n std::unique_ptr<NearestNeighborIndexSaver>\n HnswIndex::make_saver() const\n {\n-    return std::unique_ptr<NearestNeighborIndexSaver>();\n+    return std::make_unique<HnswIndexSaver>(_graph);\n }\n \n void\n HnswIndex::load(const fileutil::LoadedBuffer& buf)\n {\n-    (void) buf;\n+    assert(get_entry_docid() == 0); // cannot load after index has data\n+    HnswIndexLoader loader(_graph);\n+    if (! loader.load(buf)) {\n+        fprintf(stderr, \"ERROR loading HNSW graph\\n\");", "originalCommit": "3c2f98129e223c0dbf713ad046d7e913228873a0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIyNDQyMQ==", "url": "https://github.com/vespa-engine/vespa/pull/12733#discussion_r399224421", "bodyText": "If num_levels is 0 (representing a removed document), we should create an entry for this document to ensure that node_refs has the right size. If the last document loaded has 0 levels (removed) the size of node_refs will be off by one.", "author": "geirst", "createdAt": "2020-03-27T12:19:40Z", "path": "searchlib/src/vespa/searchlib/tensor/hnsw_index_loader.cpp", "diffHunk": "@@ -0,0 +1,48 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#include \"hnsw_index_loader.h\"\n+#include \"hnsw_graph.h\"\n+#include <vespa/searchlib/util/fileutil.h>\n+\n+namespace search::tensor {\n+\n+HnswIndexLoader::~HnswIndexLoader() {}\n+\n+HnswIndexLoader::HnswIndexLoader(HnswGraph &graph)\n+    : _graph(graph)\n+{\n+}\n+\n+bool\n+HnswIndexLoader::load(const fileutil::LoadedBuffer& buf)\n+{\n+    size_t num_readable = buf.size(sizeof(uint32_t));\n+    if (num_readable < 3) return false;\n+    const uint32_t *ptr = static_cast<const uint32_t *>(buf.buffer());\n+    const uint32_t *end = ptr + num_readable;\n+    uint32_t entry_docid = *ptr++;\n+    int32_t entry_level = *ptr++;\n+    uint32_t num_nodes = *ptr++;\n+    std::vector<uint32_t> link_array;\n+    for (uint32_t docid = 0; docid < num_nodes; ++docid) {\n+        if (ptr == end) return false;\n+        uint32_t num_levels = *ptr++;\n+        if (num_levels > 0) {", "originalCommit": "3c2f98129e223c0dbf713ad046d7e913228873a0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIyNTAzNw==", "url": "https://github.com/vespa-engine/vespa/pull/12733#discussion_r399225037", "bodyText": "Please add class description.", "author": "geirst", "createdAt": "2020-03-27T12:20:49Z", "path": "searchlib/src/vespa/searchlib/tensor/hnsw_index_saver.h", "diffHunk": "@@ -0,0 +1,34 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#pragma once\n+\n+#include \"nearest_neighbor_index_saver.h\"\n+#include <vespa/vespalib/datastore/entryref.h>\n+#include <vector>\n+\n+namespace search::tensor {\n+\n+class HnswGraph;\n+\n+class HnswIndexSaver : public NearestNeighborIndexSaver {", "originalCommit": "3c2f98129e223c0dbf713ad046d7e913228873a0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d217c94fcbf129e4a557264b64b76f8563c1d892", "url": "https://github.com/vespa-engine/vespa/commit/d217c94fcbf129e4a557264b64b76f8563c1d892", "message": "review follow-up:\n* add documentation comments\n* style fixes\n* return bool from load() for error handling", "committedDate": "2020-03-27T13:08:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk4NTI4Mg==", "url": "https://github.com/vespa-engine/vespa/pull/12733#discussion_r399985282", "bodyText": "Please consider snake case for consistency.", "author": "geirst", "createdAt": "2020-03-30T07:40:56Z", "path": "searchlib/src/vespa/searchlib/tensor/hnsw_index_loader.h", "diffHunk": "@@ -2,19 +2,34 @@\n \n #pragma once\n \n+#include <cstdint>\n+\n namespace search::fileutil { class LoadedBuffer; }\n \n namespace search::tensor {\n \n class HnswGraph;\n \n+/**\n+ * Implements loading of HNSW graph structure from binary format.\n+ **/\n class HnswIndexLoader {\n public:\n     HnswIndexLoader(HnswGraph &graph);\n     ~HnswIndexLoader();\n     bool load(const fileutil::LoadedBuffer& buf);\n private:\n     HnswGraph &_graph;\n+    const uint32_t *_ptr;\n+    const uint32_t *_end;\n+    bool _failed;\n+    uint32_t nextVal() {", "originalCommit": "d217c94fcbf129e4a557264b64b76f8563c1d892", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}