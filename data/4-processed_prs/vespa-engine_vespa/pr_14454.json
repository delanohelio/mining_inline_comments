{"pr_number": 14454, "pr_title": "Jonmv/async document v1", "pr_createdAt": "2020-09-18T14:54:55Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/14454", "timeline": [{"oid": "2c5028827208f37292774d233e2f3918a2728260", "url": "https://github.com/vespa-engine/vespa/commit/2c5028827208f37292774d233e2f3918a2728260", "message": "Non-functional", "committedDate": "2020-09-14T10:55:04Z", "type": "commit"}, {"oid": "f6f0e76416325171b4a39585d58af50133fe7372", "url": "https://github.com/vespa-engine/vespa/commit/f6f0e76416325171b4a39585d58af50133fe7372", "message": "Deprecate DocumentAccess.createDefault which uses self subscription", "committedDate": "2020-09-16T07:31:52Z", "type": "commit"}, {"oid": "88c81c7bd65d1f2e00beac6e7f8d607b1f8b9f64", "url": "https://github.com/vespa-engine/vespa/commit/88c81c7bd65d1f2e00beac6e7f8d607b1f8b9f64", "message": "Accept DocumentPut in AsyncSession", "committedDate": "2020-09-16T10:11:44Z", "type": "commit"}, {"oid": "3f18f634d0cd82d71be52c8c1a98f619b48b4ae3", "url": "https://github.com/vespa-engine/vespa/commit/3f18f634d0cd82d71be52c8c1a98f619b48b4ae3", "message": "Non-functional changes", "committedDate": "2020-09-18T13:28:56Z", "type": "commit"}, {"oid": "7e814691df005b6992b4c0e8352ff95e8775bf8d", "url": "https://github.com/vespa-engine/vespa/commit/7e814691df005b6992b4c0e8352ff95e8775bf8d", "message": "Deprecate and ignore impossible outcome of sending to MBus", "committedDate": "2020-09-18T13:29:26Z", "type": "commit"}, {"oid": "608ca56971e61216b53c1184f82d5974debef431", "url": "https://github.com/vespa-engine/vespa/commit/608ca56971e61216b53c1184f82d5974debef431", "message": "Add unit test to document inaccurate reply merging on TAS failed", "committedDate": "2020-09-18T14:40:40Z", "type": "commit"}, {"oid": "03824050b9de32cc7c68c5a26179cc93a70bd82c", "url": "https://github.com/vespa-engine/vespa/commit/03824050b9de32cc7c68c5a26179cc93a70bd82c", "message": "Get more juice out of Response", "committedDate": "2020-09-18T14:53:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA0NjUyNg==", "url": "https://github.com/vespa-engine/vespa/pull/14454#discussion_r491046526", "bodyText": "But that's more difficult ... doesn't this just work?", "author": "bratseth", "createdAt": "2020-09-18T16:01:19Z", "path": "documentapi/src/main/java/com/yahoo/documentapi/DocumentAccess.java", "diffHunk": "@@ -55,8 +55,11 @@\n      * while attempting to create such an object, this method will throw an\n      * exception.\n      *\n+     * @deprecated Inject a DocumentManagerConfig and create a MessageBusDocumentAccess from this instead.", "originalCommit": "f6f0e76416325171b4a39585d58af50133fe7372", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTExNTIyOQ==", "url": "https://github.com/vespa-engine/vespa/pull/14454#discussion_r491115229", "bodyText": "@baldersheim wqs of the opinion this should go.", "author": "jonmv", "createdAt": "2020-09-18T18:16:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA0NjUyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE5NzIyMg==", "url": "https://github.com/vespa-engine/vespa/pull/14454#discussion_r491197222", "bodyText": "It uses self subscription.\n1 - It means that at will change out of sync with the other components also using the same config.\n\nComponents will be out of sync in for a short time.\nIt is either very costly due to extra synchronisation. However I think it is worse, they will never agree, as there are thread visibility issues.\n2 - It leaks resources. Every heapdump I have checked where the customer has done this, it is leaking threads and other resources.\n\n3 - I think that having the config injected is a simple remediation for this mess. I thought that was the whole reason for having config injected and creating final components.\nThis is one og our bad past patterns.", "author": "baldersheim", "createdAt": "2020-09-18T21:23:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA0NjUyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTI5MDQzNw==", "url": "https://github.com/vespa-engine/vespa/pull/14454#discussion_r491290437", "bodyText": "Yes DocumentAccess is a factory for clients, if you're in a container you should have everything injected. This used to be convenient when running a client on a node which can reach config servers. It's not relevant to cloud deployments, so fine I guess.\nBtw, we should have an object you can have injected directly to make it more obvious what to do when running in a container, perhaps that could be done as part of this work.", "author": "bratseth", "createdAt": "2020-09-19T06:26:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA0NjUyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTQyNzY1MA==", "url": "https://github.com/vespa-engine/vespa/pull/14454#discussion_r491427650", "bodyText": "Yes, I thought the same thing. The document access is perhaps something we wish to create only when needed, so a factory which is always present, based on the relevant config?", "author": "jonmv", "createdAt": "2020-09-19T13:05:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA0NjUyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTQ3Mjg1OA==", "url": "https://github.com/vespa-engine/vespa/pull/14454#discussion_r491472858", "bodyText": "Yes, or preferably something like a session (or, two - one sync and one async) which is always present so we don't need to destroy it - but otoh I'm not sure if we want to create the connections if we don't need them.", "author": "bratseth", "createdAt": "2020-09-19T16:54:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA0NjUyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTY3MjU2Nw==", "url": "https://github.com/vespa-engine/vespa/pull/14454#discussion_r491672567", "bodyText": "But sync sessions are often used one per client? So rather a session factory, i.e. a document access? How about a lazy doc access, then? If one of those is always enough.", "author": "jonmv", "createdAt": "2020-09-20T09:26:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA0NjUyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTY3Mzc0Mg==", "url": "https://github.com/vespa-engine/vespa/pull/14454#discussion_r491673742", "bodyText": "A doc access is also what you need for visitor sessions.", "author": "jonmv", "createdAt": "2020-09-20T09:41:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA0NjUyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTgxNjQ3Ng==", "url": "https://github.com/vespa-engine/vespa/pull/14454#discussion_r491816476", "bodyText": "Hmm, why the sync sessions are used one per thread/operation in the current document/v1, I don't know ... Seems like an error to me. So you could indeed have injectable Sync and Async-Sessions. That doesn't cover the other types of sessions, though.", "author": "jonmv", "createdAt": "2020-09-21T06:31:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA0NjUyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTgyNzczOQ==", "url": "https://github.com/vespa-engine/vespa/pull/14454#discussion_r491827739", "bodyText": "If anything, using multiple SyncSessions to handle a feed of operations breaks operation sequencing ...", "author": "jonmv", "createdAt": "2020-09-21T07:03:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA0NjUyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg2MzA4NQ==", "url": "https://github.com/vespa-engine/vespa/pull/14454#discussion_r491863085", "bodyText": "Yes, that should work if we're ok with always having instances of these sessions.\nWhat other types of sessions?", "author": "bratseth", "createdAt": "2020-09-21T08:17:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA0NjUyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg2NTc0Ng==", "url": "https://github.com/vespa-engine/vespa/pull/14454#discussion_r491865746", "bodyText": "VisitorSession. I guess SubscriptionSession never got an implementation. See #14461 for a suggestion of a lazy DocumentAccess provider.", "author": "jonmv", "createdAt": "2020-09-21T08:22:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA0NjUyNg=="}], "type": "inlineReview"}, {"oid": "060c1c8dc162ce9cf7e88b44f9fb986b511bf29b", "url": "https://github.com/vespa-engine/vespa/commit/060c1c8dc162ce9cf7e88b44f9fb986b511bf29b", "message": "Update abi-spec", "committedDate": "2020-09-18T20:53:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk3OTc2OA==", "url": "https://github.com/vespa-engine/vespa/pull/14454#discussion_r491979768", "bodyText": "Consider setting forRemoval=true. IDE/compiler gives stronger feedback if true.", "author": "bjorncs", "createdAt": "2020-09-21T11:49:08Z", "path": "documentapi/src/main/java/com/yahoo/documentapi/DocumentIdResponse.java", "diffHunk": "@@ -36,9 +35,9 @@ public DocumentIdResponse(long requestId, DocumentId documentId) {\n      * @param textMessage the message to encapsulate in the Response\n      * @param success     true if the response represents a successful call\n      */\n+    @Deprecated(since = \"7\") // TODO: Remove on Vespa 8", "originalCommit": "03824050b9de32cc7c68c5a26179cc93a70bd82c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}