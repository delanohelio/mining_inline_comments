{"pr_number": 12281, "pr_title": "Arnej/add nns iterator", "pr_createdAt": "2020-02-20T11:02:32Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/12281", "timeline": [{"oid": "4b216edf783258ae9555ee32a12bd0b7fedc5ea1", "url": "https://github.com/vespa-engine/vespa/commit/4b216edf783258ae9555ee32a12bd0b7fedc5ea1", "message": "add search iterator using result from find_top_k", "committedDate": "2020-02-20T09:20:48Z", "type": "commit"}, {"oid": "97ebc6ec54db9ea2005eb6cd958c3ce3c76cde63", "url": "https://github.com/vespa-engine/vespa/commit/97ebc6ec54db9ea2005eb6cd958c3ce3c76cde63", "message": "unit test vector iterator", "committedDate": "2020-02-20T10:26:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk5NjY0MQ==", "url": "https://github.com/vespa-engine/vespa/pull/12281#discussion_r381996641", "bodyText": "Please add a short class description.", "author": "geirst", "createdAt": "2020-02-20T13:27:54Z", "path": "searchlib/src/vespa/searchlib/queryeval/nns_index_iterator.h", "diffHunk": "@@ -0,0 +1,21 @@\n+// Copyright 2020 Oath Inc. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#pragma once\n+\n+#include \"searchiterator.h\"\n+#include <vespa/searchlib/fef/termfieldmatchdata.h>\n+#include <vespa/searchlib/tensor/nearest_neighbor_index.h>\n+\n+namespace search::queryeval {\n+\n+class NnsIndexIterator : public SearchIterator", "originalCommit": "4b216edf783258ae9555ee32a12bd0b7fedc5ea1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk5ODkyNw==", "url": "https://github.com/vespa-engine/vespa/pull/12281#discussion_r381998927", "bodyText": "Something off with indentation?", "author": "geirst", "createdAt": "2020-02-20T13:32:07Z", "path": "searchlib/src/vespa/searchlib/queryeval/nns_index_iterator.cpp", "diffHunk": "@@ -0,0 +1,65 @@\n+// Copyright 2020 Oath Inc. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#include \"nns_index_iterator.h\"\n+#include <vespa/searchlib/tensor/nearest_neighbor_index.h>\n+#include <cmath>\n+\n+using Hit = search::tensor::NearestNeighborIndex::Neighbor;\n+\n+namespace search::queryeval {\n+\n+class NeighborVectorIterator : public NnsIndexIterator\n+{\n+private:\n+    fef::TermFieldMatchData &_tfmd;\n+    const std::vector<Hit> &_hits;\n+    uint32_t _idx;\n+    double _last_sq_dist;\n+public:\n+    NeighborVectorIterator(fef::TermFieldMatchData &tfmd,\n+                           const std::vector<Hit> &hits)\n+        : _tfmd(tfmd),\n+          _hits(hits),\n+          _idx(0),\n+          _last_sq_dist(0.0)\n+    {}\n+\n+    void initRange(uint32_t begin_id, uint32_t end_id) override {\n+        SearchIterator::initRange(begin_id, end_id);\n+        _idx = 0;\n+    }\n+\n+    void doSeek(uint32_t docId) override {\n+        while (_idx < _hits.size()) {\n+            uint32_t hit_id = _hits[_idx].docid;\n+            if (hit_id < docId) {\n+                ++_idx;\n+            } else if (hit_id < getEndId()) {\n+                setDocId(hit_id);\n+                _last_sq_dist = _hits[_idx].distance;\n+                return;\n+            } else {\n+                _idx = _hits.size();\n+            }\n+\t}", "originalCommit": "4b216edf783258ae9555ee32a12bd0b7fedc5ea1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjAxNDM0Ng==", "url": "https://github.com/vespa-engine/vespa/pull/12281#discussion_r382014346", "bodyText": "To make the test easier to read, consider creating some helper functions: one that seeks and expects a match with associated raw score. The other that seeks but doesn't expect a match, but checks current doc id on the iterator. The last that seeks and expects to be at the end.", "author": "geirst", "createdAt": "2020-02-20T13:59:00Z", "path": "searchlib/src/tests/queryeval/nearest_neighbor/nearest_neighbor_test.cpp", "diffHunk": "@@ -190,4 +191,70 @@ TEST(\"require that NearestNeighborIterator sets expected rawscore\") {\n     TEST_DO(verify_iterator_sets_expected_rawscore(denseSpecFloat, denseSpecDouble));\n }\n \n+TEST(\"require that NnsIndexIterator works as expected\") {\n+    std::vector<NnsIndexIterator::Hit> hits{{2,4.0}, {3,9.0}, {5,1.0}, {8,16.0}, {9,36.0}};\n+    auto md = MatchData::makeTestInstance(2, 2);\n+    auto &tfmd = *(md->resolveTermField(0));\n+    auto search = NnsIndexIterator::create(true, tfmd, hits);\n+    uint32_t docid = 1;\n+    search->initFullRange();\n+    bool match = search->seek(docid);\n+    EXPECT_FALSE(match);\n+    EXPECT_FALSE(search->isAtEnd());\n+    EXPECT_EQUAL(2u, search->getDocId());\n+    docid = 2;\n+    match = search->seek(docid);", "originalCommit": "97ebc6ec54db9ea2005eb6cd958c3ce3c76cde63", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjU1NDgzNw==", "url": "https://github.com/vespa-engine/vespa/pull/12281#discussion_r382554837", "bodyText": "consider keeping the Neighbor name", "author": "havardpe", "createdAt": "2020-02-21T12:26:29Z", "path": "searchlib/src/vespa/searchlib/queryeval/nns_index_iterator.h", "diffHunk": "@@ -0,0 +1,21 @@\n+// Copyright 2020 Oath Inc. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#pragma once\n+\n+#include \"searchiterator.h\"\n+#include <vespa/searchlib/fef/termfieldmatchdata.h>\n+#include <vespa/searchlib/tensor/nearest_neighbor_index.h>\n+\n+namespace search::queryeval {\n+\n+class NnsIndexIterator : public SearchIterator\n+{\n+public:\n+    using Hit = search::tensor::NearestNeighborIndex::Neighbor;", "originalCommit": "97ebc6ec54db9ea2005eb6cd958c3ce3c76cde63", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjU1NjQ5NQ==", "url": "https://github.com/vespa-engine/vespa/pull/12281#discussion_r382556495", "bodyText": "consider removing this if you are always strict, since the caller is kind of yourself anyways.", "author": "havardpe", "createdAt": "2020-02-21T12:30:56Z", "path": "searchlib/src/vespa/searchlib/queryeval/nns_index_iterator.cpp", "diffHunk": "@@ -0,0 +1,65 @@\n+// Copyright 2020 Oath Inc. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#include \"nns_index_iterator.h\"\n+#include <vespa/searchlib/tensor/nearest_neighbor_index.h>\n+#include <cmath>\n+\n+using Hit = search::tensor::NearestNeighborIndex::Neighbor;\n+\n+namespace search::queryeval {\n+\n+class NeighborVectorIterator : public NnsIndexIterator\n+{\n+private:\n+    fef::TermFieldMatchData &_tfmd;\n+    const std::vector<Hit> &_hits;\n+    uint32_t _idx;\n+    double _last_sq_dist;\n+public:\n+    NeighborVectorIterator(fef::TermFieldMatchData &tfmd,\n+                           const std::vector<Hit> &hits)\n+        : _tfmd(tfmd),\n+          _hits(hits),\n+          _idx(0),\n+          _last_sq_dist(0.0)\n+    {}\n+\n+    void initRange(uint32_t begin_id, uint32_t end_id) override {\n+        SearchIterator::initRange(begin_id, end_id);\n+        _idx = 0;\n+    }\n+\n+    void doSeek(uint32_t docId) override {\n+        while (_idx < _hits.size()) {\n+            uint32_t hit_id = _hits[_idx].docid;\n+            if (hit_id < docId) {\n+                ++_idx;\n+            } else if (hit_id < getEndId()) {\n+                setDocId(hit_id);\n+                _last_sq_dist = _hits[_idx].distance;\n+                return;\n+            } else {\n+                _idx = _hits.size();\n+            }\n+\t}\n+        setAtEnd();\n+    }\n+\n+    void doUnpack(uint32_t docId) override {\n+        _tfmd.setRawScore(docId, sqrt(_last_sq_dist));\n+    }\n+\n+    Trinary is_strict() const override { return Trinary::True; }\n+};\n+\n+std::unique_ptr<NnsIndexIterator>\n+NnsIndexIterator::create(\n+        bool strict,", "originalCommit": "97ebc6ec54db9ea2005eb6cd958c3ce3c76cde63", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}