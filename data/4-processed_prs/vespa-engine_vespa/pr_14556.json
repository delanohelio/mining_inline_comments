{"pr_number": 14556, "pr_title": "Internal restart on internal deployments", "pr_createdAt": "2020-09-25T10:33:04Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/14556", "timeline": [{"oid": "9fe53dc16eaf71124bebf16aa283a4ee37625e86", "url": "https://github.com/vespa-engine/vespa/commit/9fe53dc16eaf71124bebf16aa283a4ee37625e86", "message": "Allow creating Deployment with PrepareParams", "committedDate": "2020-09-25T08:42:13Z", "type": "commit"}, {"oid": "4fb114d59b873a66ac5ea4d4e9693f7540d9e275", "url": "https://github.com/vespa-engine/vespa/commit/4fb114d59b873a66ac5ea4d4e9693f7540d9e275", "message": "Use deployment to prepare", "committedDate": "2020-09-25T09:06:59Z", "type": "commit"}, {"oid": "f55fed1e7da7b4ed4f4d35cb7359ec9d1ac5a6a2", "url": "https://github.com/vespa-engine/vespa/commit/f55fed1e7da7b4ed4f4d35cb7359ec9d1ac5a6a2", "message": "Remove unused argument", "committedDate": "2020-09-25T10:30:35Z", "type": "commit"}, {"oid": "1e3f05536e75344d4e5444b656ca5904387a4041", "url": "https://github.com/vespa-engine/vespa/commit/1e3f05536e75344d4e5444b656ca5904387a4041", "message": "Move internal restart to Deployment", "committedDate": "2020-09-25T10:30:35Z", "type": "commit"}, {"oid": "22accc554d2cbe3e07dc21a4e9af375468b95118", "url": "https://github.com/vespa-engine/vespa/commit/22accc554d2cbe3e07dc21a4e9af375468b95118", "message": "Use same Deployment across prepare & activate", "committedDate": "2020-09-25T10:30:35Z", "type": "commit"}, {"oid": "27c498346fcf15c999f5c93ddf8e9e36e055a2b8", "url": "https://github.com/vespa-engine/vespa/commit/27c498346fcf15c999f5c93ddf8e9e36e055a2b8", "message": "Deploy with internal restart if flag is set in zone", "committedDate": "2020-09-25T10:30:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDkwMDg3Nw==", "url": "https://github.com/vespa-engine/vespa/pull/14556#discussion_r494900877", "bodyText": "Without ZONE_ID here since the flag will be set on the configserver for internal deployments. For external deployments the flag still must be set on the controller. That could be changed, but would need to re-create PrepareParams.\nI think we can remove internalRestart parameter and this flag in a week or so anyway and just always do internal restarts if the provisioner is set?", "author": "freva", "createdAt": "2020-09-25T10:37:02Z", "path": "configserver/src/main/java/com/yahoo/vespa/config/server/ApplicationRepository.java", "diffHunk": "@@ -395,9 +382,10 @@ public PrepareResult deploy(File applicationPackage, PrepareParams prepareParams\n         SessionRepository sessionRepository = tenant.getSessionRepository();\n         LocalSession newSession = sessionRepository.createSessionFromExisting(activeSession, logger, true, timeoutBudget);\n         sessionRepository.addLocalSession(newSession);\n+        boolean internalRestart = deployWithInternalRestart.with(FetchVector.Dimension.APPLICATION_ID, application.serializedForm()).value();", "originalCommit": "27c498346fcf15c999f5c93ddf8e9e36e055a2b8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}