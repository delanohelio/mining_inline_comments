{"pr_number": 14484, "pr_title": "- Group commits to the TLS and sync to disk before acking.", "pr_createdAt": "2020-09-22T12:20:39Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/14484", "timeline": [{"oid": "2fc48b76ba4187b88c303f5fb7372c4df2a93f1e", "url": "https://github.com/vespa-engine/vespa/commit/2fc48b76ba4187b88c303f5fb7372c4df2a93f1e", "message": "- Group commits to the TLS and sync to disk before acking.\n- Add zstd as compression.\n- No immediate commit. Delay ack until fully committed instead.", "committedDate": "2020-09-22T12:04:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY5NTcyNg==", "url": "https://github.com/vespa-engine/vespa/pull/14484#discussion_r492695726", "bodyText": "This if should be unneeded, we know that completed is set, otherwise previous line would have caused a crash.", "author": "toregge", "createdAt": "2020-09-22T12:33:28Z", "path": "searchlib/src/vespa/searchlib/transactionlog/domain.cpp", "diffHunk": "@@ -318,22 +323,78 @@ Domain::optionallyRotateFile(SerialNum serialNum) {\n     return dp;\n }\n \n+void\n+Domain::append(const Packet & packet, Writer::DoneCallback onDone) {\n+    vespalib::MonitorGuard guard(_currentChunkMonitor);\n+    if (_lastSerial >= packet.range().from()) {\n+        throw runtime_error(fmt(\"Incoming serial number(%\" PRIu64 \") must be bigger than the last one (%\" PRIu64 \").\",\n+                                packet.range().from(), _lastSerial));\n+    } else {\n+        _lastSerial = packet.range().to();\n+    }\n+    _currentChunk->add(packet, std::move(onDone));\n+    commitIfFull(guard);\n+}\n+\n Domain::CommitResult\n Domain::startCommit(DoneCallback onDone) {\n-    (void) onDone;\n+    vespalib::MonitorGuard guard(_currentChunkMonitor);\n+    if ( !_currentChunk->empty() ) {\n+        auto completed = grabCurrentChunk(guard);\n+        assert(completed);\n+        completed->setCommitDoneCallback(std::move(onDone));\n+        CommitResult result(completed->createCommitResult());\n+        commitChunk(std::move(completed), guard);\n+        return result;\n+    }\n     return CommitResult();\n }\n \n void\n-Domain::append(const Packet & packet, Writer::DoneCallback onDone)\n-{\n-    (void) onDone;\n+Domain::commitIfFull(const vespalib::MonitorGuard &guard) {\n+    if (_currentChunk->sizeBytes() > _config.getChunkSizeLimit()) {\n+        auto completed = std::move(_currentChunk);\n+        _currentChunk = std::make_unique<CommitChunk>(_config.getChunkSizeLimit(), completed->stealCallbacks());\n+        if (completed) {", "originalCommit": "2fc48b76ba4187b88c303f5fb7372c4df2a93f1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjcwMjA3Mw==", "url": "https://github.com/vespa-engine/vespa/pull/14484#discussion_r492702073", "bodyText": "Correct, fixed", "author": "baldersheim", "createdAt": "2020-09-22T12:43:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY5NTcyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY5NzEyOQ==", "url": "https://github.com/vespa-engine/vespa/pull/14484#discussion_r492697129", "bodyText": "This guard should be moved into the following lambda. We want to keep chunk alive until previous chunks have been committed.", "author": "toregge", "createdAt": "2020-09-22T12:35:46Z", "path": "searchlib/src/vespa/searchlib/transactionlog/domain.cpp", "diffHunk": "@@ -318,22 +323,78 @@ Domain::optionallyRotateFile(SerialNum serialNum) {\n     return dp;\n }\n \n+void\n+Domain::append(const Packet & packet, Writer::DoneCallback onDone) {\n+    vespalib::MonitorGuard guard(_currentChunkMonitor);\n+    if (_lastSerial >= packet.range().from()) {\n+        throw runtime_error(fmt(\"Incoming serial number(%\" PRIu64 \") must be bigger than the last one (%\" PRIu64 \").\",\n+                                packet.range().from(), _lastSerial));\n+    } else {\n+        _lastSerial = packet.range().to();\n+    }\n+    _currentChunk->add(packet, std::move(onDone));\n+    commitIfFull(guard);\n+}\n+\n Domain::CommitResult\n Domain::startCommit(DoneCallback onDone) {\n-    (void) onDone;\n+    vespalib::MonitorGuard guard(_currentChunkMonitor);\n+    if ( !_currentChunk->empty() ) {\n+        auto completed = grabCurrentChunk(guard);\n+        assert(completed);\n+        completed->setCommitDoneCallback(std::move(onDone));\n+        CommitResult result(completed->createCommitResult());\n+        commitChunk(std::move(completed), guard);\n+        return result;\n+    }\n     return CommitResult();\n }\n \n void\n-Domain::append(const Packet & packet, Writer::DoneCallback onDone)\n-{\n-    (void) onDone;\n+Domain::commitIfFull(const vespalib::MonitorGuard &guard) {\n+    if (_currentChunk->sizeBytes() > _config.getChunkSizeLimit()) {\n+        auto completed = std::move(_currentChunk);\n+        _currentChunk = std::make_unique<CommitChunk>(_config.getChunkSizeLimit(), completed->stealCallbacks());\n+        if (completed) {\n+            commitChunk(std::move(completed), guard);\n+        }\n+    }\n+}\n+\n+std::unique_ptr<CommitChunk>\n+Domain::grabCurrentChunk(const vespalib::MonitorGuard & guard) {\n+    assert(guard.monitors(_currentChunkMonitor));\n+    auto chunk = std::move(_currentChunk);\n+    _currentChunk = createCommitChunk(_config);\n+    return chunk;\n+}\n+\n+bool\n+Domain::commitChunk(std::unique_ptr<CommitChunk> chunk, const vespalib::MonitorGuard & chunkOrderGuard) {\n+    assert(chunkOrderGuard.monitors(_currentChunkMonitor));\n+    if ( ! chunk->getPacket().empty()) {", "originalCommit": "2fc48b76ba4187b88c303f5fb7372c4df2a93f1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjcwMjMwNA==", "url": "https://github.com/vespa-engine/vespa/pull/14484#discussion_r492702304", "bodyText": "Correct, fixed.", "author": "baldersheim", "createdAt": "2020-09-22T12:44:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY5NzEyOQ=="}], "type": "inlineReview"}, {"oid": "e7f7be2e596453f16d80896eb11f68895d275eb1", "url": "https://github.com/vespa-engine/vespa/commit/e7f7be2e596453f16d80896eb11f68895d275eb1", "message": "Remove unnecessary guard and move check for emptiness inside doCommit to ensure ordering also of empty chunks.", "committedDate": "2020-09-22T12:43:10Z", "type": "commit"}, {"oid": "2b7f9bf28844837b7a7dfd21857806406578ec0e", "url": "https://github.com/vespa-engine/vespa/commit/2b7f9bf28844837b7a7dfd21857806406578ec0e", "message": "Check for no data, as there might be callbacks that have been moved over.", "committedDate": "2020-09-22T12:52:11Z", "type": "commit"}]}