{"pr_number": 15873, "pr_title": "Jonmv/remove storage policy", "pr_createdAt": "2020-12-23T11:57:03Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/15873", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkzMzY3Mg==", "url": "https://github.com/vespa-engine/vespa/pull/15873#discussion_r547933672", "bodyText": "Oops, not intended to be here, but this is just removal of dead code that shouldn't be there in the first place.", "author": "jonmv", "createdAt": "2020-12-23T12:24:50Z", "path": "vespaclient-container-plugin/src/main/java/com/yahoo/document/restapi/resource/DocumentV1ApiHandler.java", "diffHunk": "@@ -377,10 +377,6 @@ private DocumentOperationParameters parametersFromRequest(HttpRequest request, S\n                                                           .map(parameters::withRoute)\n                                                           .orElse(parameters);\n                 break;\n-            case CONDITION:\n-                parameters = getProperty(request, ROUTE).map(parameters::withRoute)\n-                                                        .orElse(parameters);\n-                break;", "originalCommit": "d37f395ccb4db43ad6cb813412e7df5683363219", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7bf09c3200422d047100362c82de6e1fdf2b323c", "url": "https://github.com/vespa-engine/vespa/commit/7bf09c3200422d047100362c82de6e1fdf2b323c", "message": "Revert \"Revert \"Merge StoragePolicy down into ContentPolicy, and always use this\"\"", "committedDate": "2020-12-30T10:59:56Z", "type": "commit"}, {"oid": "7efd5dfa1111e0aa94b97fbca06852de95258aa5", "url": "https://github.com/vespa-engine/vespa/commit/7efd5dfa1111e0aa94b97fbca06852de95258aa5", "message": "Replace use of [Storage... with [Content... and avoid overriding config id", "committedDate": "2020-12-30T10:59:56Z", "type": "commit"}, {"oid": "ae314e6d20ba0f4e77e00c4bf3542c39cb3bef46", "url": "https://github.com/vespa-engine/vespa/commit/ae314e6d20ba0f4e77e00c4bf3542c39cb3bef46", "message": "Use just content cluster name as route", "committedDate": "2020-12-30T10:59:56Z", "type": "commit"}, {"oid": "3ca9668a22041a80ffebc53924f5c5c244b484e8", "url": "https://github.com/vespa-engine/vespa/commit/3ca9668a22041a80ffebc53924f5c5c244b484e8", "message": "Merge storagepolicy into contentpolicy", "committedDate": "2020-12-30T10:59:56Z", "type": "commit"}, {"oid": "965d21f339ccca4fc042eab8c76d1d055fb0863b", "url": "https://github.com/vespa-engine/vespa/commit/965d21f339ccca4fc042eab8c76d1d055fb0863b", "message": "Non-functional", "committedDate": "2020-12-30T10:59:56Z", "type": "commit"}, {"oid": "965d21f339ccca4fc042eab8c76d1d055fb0863b", "url": "https://github.com/vespa-engine/vespa/commit/965d21f339ccca4fc042eab8c76d1d055fb0863b", "message": "Non-functional", "committedDate": "2020-12-30T10:59:56Z", "type": "forcePushed"}, {"oid": "6eede0d2c93cd086a980d2bed5c5cc5d1eca9712", "url": "https://github.com/vespa-engine/vespa/commit/6eede0d2c93cd086a980d2bed5c5cc5d1eca9712", "message": "More non-functional", "committedDate": "2020-12-30T11:26:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTMwNjEwNA==", "url": "https://github.com/vespa-engine/vespa/pull/15873#discussion_r551306104", "bodyText": "Consider adding a note in the comment on when this can be done so major version cleanup greps can find it", "author": "vekterli", "createdAt": "2021-01-04T13:06:54Z", "path": "documentapi/src/vespa/documentapi/messagebus/documentprotocol.cpp", "diffHunk": "@@ -32,14 +32,14 @@ DocumentProtocol::DocumentProtocol(std::shared_ptr<const DocumentTypeRepo> repo,\n     // When adding factories to this list, please KEEP THEM ORDERED alphabetically like they are now.\n     putRoutingPolicyFactory(\"AND\", std::make_shared<RoutingPolicyFactories::AndPolicyFactory>());\n     putRoutingPolicyFactory(\"Content\", std::make_shared<RoutingPolicyFactories::ContentPolicyFactory>());\n-    putRoutingPolicyFactory(\"MessageType\", std::make_shared<RoutingPolicyFactories::MessageTypePolicyFactory>());\n+    putRoutingPolicyFactory(\"Storage\", std::make_shared<RoutingPolicyFactories::ContentPolicyFactory>()); // TODO: remove", "originalCommit": "6eede0d2c93cd086a980d2bed5c5cc5d1eca9712", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM1MjUwOQ==", "url": "https://github.com/vespa-engine/vespa/pull/15873#discussion_r551352509", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                putRoutingPolicyFactory(\"Storage\", std::make_shared<RoutingPolicyFactories::ContentPolicyFactory>()); // TODO: remove\n          \n          \n            \n                putRoutingPolicyFactory(\"Storage\", std::make_shared<RoutingPolicyFactories::ContentPolicyFactory>()); // TODO Vespa 8: remove", "author": "jonmv", "createdAt": "2021-01-04T14:35:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTMwNjEwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM1Mjc4NA==", "url": "https://github.com/vespa-engine/vespa/pull/15873#discussion_r551352784", "bodyText": "Yes. Major version is a good idea, since this kills the \"Storage\" policy.", "author": "jonmv", "createdAt": "2021-01-04T14:35:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTMwNjEwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM0MDEyMg==", "url": "https://github.com/vespa-engine/vespa/pull/15873#discussion_r551340122", "bodyText": "Should we retain at least one test per language that tests that Storage still works?", "author": "vekterli", "createdAt": "2021-01-04T14:14:31Z", "path": "documentapi/src/tests/policies/policies_test.cpp", "diffHunk": "@@ -83,10 +83,10 @@ class Test : public vespalib::TestApp {\n     void requireThatExternPolicyWithUnknownPatternSelectsNone();\n     void requireThatExternPolicySelectsFromExternSlobrok();\n     void requireThatExternPolicyMergesOneReplyAsProtocol();\n-    void requireThatStoragePolicyWithIllegalParamIsAnErrorPolicy();\n-    void requireThatStoragePolicyIsRandomWithoutState();\n-    void requireThatStoragePolicyIsTargetedWithState();\n-    void requireThatStoragePolicyCombinesSystemAndSlobrokState();\n+    void requireThatContentPolicyWithIllegalParamIsAnErrorPolicy();\n+    void requireThatContentPolicyIsRandomWithoutState();\n+    void requireThatContentPolicyIsTargetedWithState();\n+    void requireThatContentPolicyCombinesSystemAndSlobrokState();", "originalCommit": "6eede0d2c93cd086a980d2bed5c5cc5d1eca9712", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM1MzEwMw==", "url": "https://github.com/vespa-engine/vespa/pull/15873#discussion_r551353103", "bodyText": "Yes.", "author": "jonmv", "createdAt": "2021-01-04T14:36:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM0MDEyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM1Njc4Mw==", "url": "https://github.com/vespa-engine/vespa/pull/15873#discussion_r551356783", "bodyText": "I think there weren't any tests that \"Content\" worked, before ... \ud83d\ude40", "author": "jonmv", "createdAt": "2021-01-04T14:42:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM0MDEyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQwNzQ5NA==", "url": "https://github.com/vespa-engine/vespa/pull/15873#discussion_r551407494", "bodyText": "So in Java-land there is no test of this setup \u2014 only a mock setup where some random string (\"storage\") is used as the policy name.\nIn C++ land there is a test which involves getting a policy from a semi-real mbus. The simplest thing to do would probably just be to verify that whatever policy was returned for \"Storage\" was the same as what was returned for \"Content\" \u2014 do you feel the call?", "author": "jonmv", "createdAt": "2021-01-04T16:04:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM0MDEyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQwODQzOA==", "url": "https://github.com/vespa-engine/vespa/pull/15873#discussion_r551408438", "bodyText": "It's really a trivial thing, though. Not absolutely convinced we need it.", "author": "jonmv", "createdAt": "2021-01-04T16:05:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM0MDEyMg=="}], "type": "inlineReview"}, {"oid": "50a2a9012a1a01f1240759cfd724c3bdf71783cb", "url": "https://github.com/vespa-engine/vespa/commit/50a2a9012a1a01f1240759cfd724c3bdf71783cb", "message": "Specify when TODO", "committedDate": "2021-01-04T14:36:33Z", "type": "commit"}, {"oid": "b1e15a0e12bc6fb258b65cdd6e6fcfb925e8f3c1", "url": "https://github.com/vespa-engine/vespa/commit/b1e15a0e12bc6fb258b65cdd6e6fcfb925e8f3c1", "message": "Use clustername-direct routes for visitors", "committedDate": "2021-01-04T15:43:06Z", "type": "commit"}, {"oid": "3e32d199fca6e9fd347bbec75d7cf30f56b99253", "url": "https://github.com/vespa-engine/vespa/commit/3e32d199fca6e9fd347bbec75d7cf30f56b99253", "message": "Merge branch 'jonmv/remove-storage-policy' of github.com:vespa-engine/vespa into jonmv/remove-storage-policy", "committedDate": "2021-01-04T17:13:09Z", "type": "commit"}]}