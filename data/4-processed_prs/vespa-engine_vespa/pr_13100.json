{"pr_number": 13100, "pr_title": "Support blocking lid space compaction during high remove rate", "pr_createdAt": "2020-04-29T09:56:37Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/13100", "timeline": [{"oid": "6d108bacdf3c92ebbf8a84b70ff619201ff1ba53", "url": "https://github.com/vespa-engine/vespa/commit/6d108bacdf3c92ebbf8a84b70ff619201ff1ba53", "message": "Improve tracking of remove batch rate used to consider to block lid space compaction.\n\nThis is also a preparation for tracking the rate of regular remove operations,\nand use this to consider to block lid space compaction.", "committedDate": "2020-04-29T07:51:06Z", "type": "commit"}, {"oid": "7cc0f99900706932ac98c29af66c609199387785", "url": "https://github.com/vespa-engine/vespa/commit/7cc0f99900706932ac98c29af66c609199387785", "message": "Add tracking of remove operations rate and use this to consider blocking lid space compaction.\n\nDuring a period with a high rate of remove operations, there is no use running lid space compaction\nas this will interfere with the remove operations, increasing latency of those.\nMoving a document as part of lid space compaction is a costly operation (similar to putting the document in the first place)\nand it typically uses both the index and attribute writer thread pools.", "committedDate": "2020-04-29T09:46:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIwODE0MQ==", "url": "https://github.com/vespa-engine/vespa/pull/13100#discussion_r417208141", "bodyText": "Consider using std::shared_ptr<documentmetastore::OperationListener>, to be consistent with forward declaration above\nand not depend on corresponding include file having been included.", "author": "toregge", "createdAt": "2020-04-29T10:15:10Z", "path": "searchcore/src/vespa/searchcore/proton/documentmetastore/documentmetastore.h", "diffHunk": "@@ -71,7 +74,7 @@ class DocumentMetaStore final : public DocumentMetaStoreAttribute,\n     uint32_t            _shrinkLidSpaceBlockers;\n     const SubDbType     _subDbType;\n     bool                _trackDocumentSizes;\n-    search::LidUsageStats::TimePoint _last_remove_batch;\n+    documentmetastore::OperationListener::SP _op_listener;", "originalCommit": "7cc0f99900706932ac98c29af66c609199387785", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI3NzA0Mg==", "url": "https://github.com/vespa-engine/vespa/pull/13100#discussion_r417277042", "bodyText": "Fixed", "author": "geirst", "createdAt": "2020-04-29T12:30:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIwODE0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIxMTQ1OQ==", "url": "https://github.com/vespa-engine/vespa/pull/13100#discussion_r417211459", "bodyText": "Consider forward declaring documentmetastore::OperationListener and using std::shared_ptr here.", "author": "toregge", "createdAt": "2020-04-29T10:21:54Z", "path": "searchcore/src/vespa/searchcore/proton/documentmetastore/i_document_meta_store.h", "diffHunk": "@@ -82,6 +83,8 @@ struct IDocumentMetaStore : public search::IDocumentMetaStore,\n      */\n     virtual void compactLidSpace(DocId wantedLidLimit) = 0;\n \n+    virtual void set_operation_listener(documentmetastore::OperationListener::SP op_listener) = 0;", "originalCommit": "7cc0f99900706932ac98c29af66c609199387785", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI3NzA5Mg==", "url": "https://github.com/vespa-engine/vespa/pull/13100#discussion_r417277092", "bodyText": "Fixed", "author": "geirst", "createdAt": "2020-04-29T12:30:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIxMTQ1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIxMTg1Nw==", "url": "https://github.com/vespa-engine/vespa/pull/13100#discussion_r417211857", "bodyText": "This include is not needed if documentmetastore::OperationListener is forward declared later on in this file.", "author": "toregge", "createdAt": "2020-04-29T10:22:42Z", "path": "searchcore/src/vespa/searchcore/proton/documentmetastore/i_document_meta_store.h", "diffHunk": "@@ -4,6 +4,7 @@\n \n #include \"lid_gid_key_comparator.h\"\n #include \"i_simple_document_meta_store.h\"\n+#include \"operation_listener.h\"", "originalCommit": "7cc0f99900706932ac98c29af66c609199387785", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI3NzE1MQ==", "url": "https://github.com/vespa-engine/vespa/pull/13100#discussion_r417277151", "bodyText": "Fixed", "author": "geirst", "createdAt": "2020-04-29T12:30:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIxMTg1Nw=="}], "type": "inlineReview"}, {"oid": "902795d717aa6fc54f42e92cd7d06a930070383b", "url": "https://github.com/vespa-engine/vespa/commit/902795d717aa6fc54f42e92cd7d06a930070383b", "message": "Use forward declaration of OperationListener in header files.", "committedDate": "2020-04-29T12:29:37Z", "type": "commit"}]}