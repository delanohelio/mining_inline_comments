{"pr_number": 13729, "pr_title": "filter invalid UTF-8 (including encoded surrogates) to make protobuf \u2026", "pr_createdAt": "2020-06-29T08:48:55Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/13729", "timeline": [{"oid": "e0c5ffc933056386947eb8d2a2cdff940a68dfc1", "url": "https://github.com/vespa-engine/vespa/commit/e0c5ffc933056386947eb8d2a2cdff940a68dfc1", "message": "filter invalid UTF-8 (including encoded surrogates) to make protobuf happy", "committedDate": "2020-06-26T12:59:00Z", "type": "commit"}, {"oid": "24fdd53f64c84f4ed0533b4480810a8cb67b3071", "url": "https://github.com/vespa-engine/vespa/commit/24fdd53f64c84f4ed0533b4480810a8cb67b3071", "message": "fix bug/typo in surrogate range constant", "committedDate": "2020-06-29T07:59:41Z", "type": "commit"}, {"oid": "e7f9060cec1a9671a65b71cc60457c51edf92c17", "url": "https://github.com/vespa-engine/vespa/commit/e7f9060cec1a9671a65b71cc60457c51edf92c17", "message": "Utf8Reader does the surrogate filtering; unit test that it works", "committedDate": "2020-06-29T08:13:13Z", "type": "commit"}, {"oid": "2df4a50f754fc8d1021dc7c201e050279a4a47dd", "url": "https://github.com/vespa-engine/vespa/commit/2df4a50f754fc8d1021dc7c201e050279a4a47dd", "message": "allow Utf8Writer to target std::string as well", "committedDate": "2020-06-29T08:43:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkxMDQzOA==", "url": "https://github.com/vespa-engine/vespa/pull/13729#discussion_r446910438", "bodyText": "Consider moving the filtering to a helper function to make the code easier to read.", "author": "geirst", "createdAt": "2020-06-29T11:51:18Z", "path": "logd/src/logd/proto_converter.cpp", "diffHunk": "@@ -59,7 +60,20 @@ ProtoConverter::log_message_to_proto(const LogMessage& message, ProtoLogMessage&\n     proto.set_service(message.service());\n     proto.set_component(message.component());\n     proto.set_level(convert_level(message.level()));\n-    proto.set_payload(message.payload());\n+    const std::string &payload = message.payload();\n+    vespalib::Utf8Reader reader(payload.c_str(), payload.size());", "originalCommit": "e0c5ffc933056386947eb8d2a2cdff940a68dfc1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ3NTQ5OQ==", "url": "https://github.com/vespa-engine/vespa/pull/13729#discussion_r447475499", "bodyText": "please take another look now", "author": "arnej27959", "createdAt": "2020-06-30T07:40:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkxMDQzOA=="}], "type": "inlineReview"}, {"oid": "975afb02388be225e7e7bd827e6aaa8e5ccf7aea", "url": "https://github.com/vespa-engine/vespa/commit/975afb02388be225e7e7bd827e6aaa8e5ccf7aea", "message": "move UTF-8 filtering to vespalib::Utf8", "committedDate": "2020-06-30T07:39:04Z", "type": "commit"}, {"oid": "8c1b6e8cece2f1a317a05052e8bf35934680743e", "url": "https://github.com/vespa-engine/vespa/commit/8c1b6e8cece2f1a317a05052e8bf35934680743e", "message": "use common filtering function", "committedDate": "2020-06-30T07:41:07Z", "type": "commit"}]}