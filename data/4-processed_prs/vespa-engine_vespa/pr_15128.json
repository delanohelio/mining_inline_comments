{"pr_number": 15128, "pr_title": "Check if the lid might block due to missing commit.", "pr_createdAt": "2020-10-30T23:44:46Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/15128", "timeline": [{"oid": "f6cb5c24a40953b6e8d130ea3b39edc93a1b0219", "url": "https://github.com/vespa-engine/vespa/commit/f6cb5c24a40953b6e8d130ea3b39edc93a1b0219", "message": "Check if the lid might block due to missing commit.\nIf so pill back and reschedule.\nRescheduling will give a busy loop, but that is rare and find.", "committedDate": "2020-10-30T23:41:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQzMTc3Mg==", "url": "https://github.com/vespa-engine/vespa/pull/15128#discussion_r515431772", "bodyText": "Consider adding braces to fix style here.", "author": "toregge", "createdAt": "2020-10-31T00:22:59Z", "path": "searchcore/src/vespa/searchcore/proton/server/bucketmovejob.cpp", "diffHunk": "@@ -125,14 +125,15 @@ BucketMoveJob::moveDocuments(DocumentBucketMover &mover,\n         bucketGuard = _frozenBuckets.acquireExclusiveBucket(mover.getBucket());\n         if (! bucketGuard) {\n             maybeDelayMover(mover, mover.getBucket());\n-            return;\n+            return true;\n         }\n     }\n     assert(mover.getBucket() == bucketGuard->getBucket());\n-    mover.moveDocuments(maxDocsToMove);\n+    if ( ! mover.moveDocuments(maxDocsToMove)) return false;", "originalCommit": "f6cb5c24a40953b6e8d130ea3b39edc93a1b0219", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTUwOTYyOQ==", "url": "https://github.com/vespa-engine/vespa/pull/15128#discussion_r515509629", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-10-31T15:46:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQzMTc3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQzMTk1MA==", "url": "https://github.com/vespa-engine/vespa/pull/15128#discussion_r515431950", "bodyText": "Consider adding braces to fix style.", "author": "toregge", "createdAt": "2020-10-31T00:24:16Z", "path": "searchcore/src/vespa/searchcore/proton/server/bucketmovejob.cpp", "diffHunk": "@@ -334,7 +335,10 @@ BucketMoveJob::run()\n     if (isBlocked()) {\n         return true; // indicate work is done, since node state is bad\n     }\n-    scanAndMove(200, 1);\n+    /// Returning false here will immediately post the job back on the executor. This will give a busy loop,\n+    /// but this is considered fine as it is very rare and it will be intermingled with multiple feed operations.\n+    if ( ! scanAndMove(200, 1) ) return false;", "originalCommit": "f6cb5c24a40953b6e8d130ea3b39edc93a1b0219", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTUwOTY0Mg==", "url": "https://github.com/vespa-engine/vespa/pull/15128#discussion_r515509642", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-10-31T15:46:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQzMTk1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQzMjE2OQ==", "url": "https://github.com/vespa-engine/vespa/pull/15128#discussion_r515432169", "bodyText": "Consider adding braces to fix style.", "author": "toregge", "createdAt": "2020-10-31T00:25:30Z", "path": "searchcore/src/vespa/searchcore/proton/server/documentbucketmover.cpp", "diffHunk": "@@ -19,14 +19,15 @@ namespace proton {\n \n typedef IDocumentMetaStore::Iterator Iterator;\n \n-void\n+bool\n DocumentBucketMover::moveDocument(DocumentIdT lid,\n                                   const document::GlobalId &gid,\n                                   Timestamp timestamp)\n {\n-    Document::SP doc(_source->retriever()->getFullDocument(lid).release());\n+    if ( _source->lidNeedsCommit(lid) ) return false;", "originalCommit": "f6cb5c24a40953b6e8d130ea3b39edc93a1b0219", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTUwOTY2NQ==", "url": "https://github.com/vespa-engine/vespa/pull/15128#discussion_r515509665", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-10-31T15:46:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQzMjE2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQzMjI3Nw==", "url": "https://github.com/vespa-engine/vespa/pull/15128#discussion_r515432277", "bodyText": "Consider adding braces to fix style.", "author": "toregge", "createdAt": "2020-10-31T00:26:12Z", "path": "searchcore/src/vespa/searchcore/proton/server/documentbucketmover.cpp", "diffHunk": "@@ -131,8 +134,9 @@ DocumentBucketMover::moveDocuments(size_t maxDocsToMove)\n         setBucketDone();\n     }\n     for (const MoveKey & key : toMove) {\n-        moveDocument(key._lid, key._gid, key._timestamp);\n+        if ( ! moveDocument(key._lid, key._gid, key._timestamp)) return false;", "originalCommit": "f6cb5c24a40953b6e8d130ea3b39edc93a1b0219", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTUwOTY3OA==", "url": "https://github.com/vespa-engine/vespa/pull/15128#discussion_r515509678", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-10-31T15:46:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQzMjI3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQzMjYxOA==", "url": "https://github.com/vespa-engine/vespa/pull/15128#discussion_r515432618", "bodyText": "Consider adding != nullptr for a more standard style with pointer checks.", "author": "toregge", "createdAt": "2020-10-31T00:28:57Z", "path": "searchcore/src/vespa/searchcore/proton/server/maintenancedocumentsubdb.cpp", "diffHunk": "@@ -38,4 +41,10 @@ MaintenanceDocumentSubDB::clear()\n     _feed_view.reset();\n }\n \n+bool\n+MaintenanceDocumentSubDB::lidNeedsCommit(search::DocumentIdT lid) const {\n+    return (_pendingLidsForCommit &&", "originalCommit": "f6cb5c24a40953b6e8d130ea3b39edc93a1b0219", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTUwOTY5OA==", "url": "https://github.com/vespa-engine/vespa/pull/15128#discussion_r515509698", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-10-31T15:46:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQzMjYxOA=="}], "type": "inlineReview"}, {"oid": "39770f40d3261d6d7e338c0fde4eb9611dd8a109", "url": "https://github.com/vespa-engine/vespa/commit/39770f40d3261d6d7e338c0fde4eb9611dd8a109", "message": "Use braces.", "committedDate": "2020-10-31T15:45:33Z", "type": "commit"}]}