{"pr_number": 14010, "pr_title": "- Change APi for fetching documents to support optimal document retri\u2026", "pr_createdAt": "2020-08-07T12:40:00Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/14010", "timeline": [{"oid": "7af09657ed382216b3406e26c6f79bb43ba090e3", "url": "https://github.com/vespa-engine/vespa/commit/7af09657ed382216b3406e26c6f79bb43ba090e3", "message": "- Change APi for fetching documents to support optimal document retrival when everything is available in memory.\n- When all fields are present only in attributes, only access the fields that are required.", "committedDate": "2020-08-07T12:35:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU1Mjk2Nw==", "url": "https://github.com/vespa-engine/vespa/pull/14010#discussion_r468552967", "bodyText": "getFullDocument?", "author": "havardpe", "createdAt": "2020-08-11T12:48:24Z", "path": "searchcore/src/vespa/searchcore/proton/persistenceengine/i_document_retriever.h", "diffHunk": "@@ -32,10 +32,17 @@ class IDocumentRetriever\n \n     virtual ~IDocumentRetriever() = default;\n \n-    virtual const document::DocumentTypeRepo &getDocumentTypeRepo() const = 0;\n+    virtual const document::DocumentTypeRepo & getDocumentTypeRepo() const = 0;\n     virtual void getBucketMetaData(const storage::spi::Bucket &bucket, search::DocumentMetaData::Vector &result) const = 0;\n     virtual search::DocumentMetaData getDocumentMetaData(const document::DocumentId &id) const = 0;\n-    virtual DocumentUP getDocument(search::DocumentIdT lid) const = 0;\n+    /**\n+     * Extracts the full document based on the LID\n+     */\n+    virtual DocumentUP getDocumentByLidOnly(search::DocumentIdT lid) const = 0;", "originalCommit": "7af09657ed382216b3406e26c6f79bb43ba090e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE4MDA5MQ==", "url": "https://github.com/vespa-engine/vespa/pull/14010#discussion_r469180091", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-08-12T11:06:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU1Mjk2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU1MzE2Nw==", "url": "https://github.com/vespa-engine/vespa/pull/14010#discussion_r468553167", "bodyText": "getPartialDocument?", "author": "havardpe", "createdAt": "2020-08-11T12:48:41Z", "path": "searchcore/src/vespa/searchcore/proton/persistenceengine/i_document_retriever.h", "diffHunk": "@@ -32,10 +32,17 @@ class IDocumentRetriever\n \n     virtual ~IDocumentRetriever() = default;\n \n-    virtual const document::DocumentTypeRepo &getDocumentTypeRepo() const = 0;\n+    virtual const document::DocumentTypeRepo & getDocumentTypeRepo() const = 0;\n     virtual void getBucketMetaData(const storage::spi::Bucket &bucket, search::DocumentMetaData::Vector &result) const = 0;\n     virtual search::DocumentMetaData getDocumentMetaData(const document::DocumentId &id) const = 0;\n-    virtual DocumentUP getDocument(search::DocumentIdT lid) const = 0;\n+    /**\n+     * Extracts the full document based on the LID\n+     */\n+    virtual DocumentUP getDocumentByLidOnly(search::DocumentIdT lid) const = 0;\n+    /**\n+     * Fetches the necessary set of fields, allowing for more optimal fetch when combining only from attributes.\n+     */\n+    virtual DocumentUP getDocument(search::DocumentIdT lid, const document::DocumentId & docId, const document::FieldSet & fieldSet) const = 0;", "originalCommit": "7af09657ed382216b3406e26c6f79bb43ba090e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE3OTkzMw==", "url": "https://github.com/vespa-engine/vespa/pull/14010#discussion_r469179933", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-08-12T11:06:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU1MzE2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU2MjI3OA==", "url": "https://github.com/vespa-engine/vespa/pull/14010#discussion_r468562278", "bodyText": "not sure how much convenience should be in the API, but if there is convenience, consider adding the default implementation of get(Partial)Document as well, to get rid of duplication.", "author": "havardpe", "createdAt": "2020-08-11T13:03:38Z", "path": "searchcore/src/vespa/searchcore/proton/persistenceengine/i_document_retriever.h", "diffHunk": "@@ -47,13 +54,17 @@ class IDocumentRetriever\n     virtual void visitDocuments(const LidVector &lids, search::IDocumentVisitor &visitor, ReadConsistency readConsistency) const = 0;\n \n     virtual CachedSelect::SP parseSelect(const vespalib::string &selection) const = 0;\n+\n+    // Convenience to get all fields\n+    DocumentUP getDocument(search::DocumentIdT lid, const document::DocumentId & docId) const;", "originalCommit": "7af09657ed382216b3406e26c6f79bb43ba090e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE4MjYyOQ==", "url": "https://github.com/vespa-engine/vespa/pull/14010#discussion_r469182629", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-08-12T11:12:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU2MjI3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU3MDQ5MQ==", "url": "https://github.com/vespa-engine/vespa/pull/14010#discussion_r468570491", "bodyText": "seems to always be set to false", "author": "havardpe", "createdAt": "2020-08-11T13:16:27Z", "path": "searchcore/src/vespa/searchcore/proton/server/documentretriever.h", "diffHunk": "@@ -25,15 +25,26 @@ class DocumentRetriever : public DocumentRetrieverBase {\n                       const search::IDocumentStore &doc_store);\n     ~DocumentRetriever() override;\n \n-    document::Document::UP getDocument(search::DocumentIdT lid) const override;\n+    document::Document::UP getDocumentByLidOnly(search::DocumentIdT lid) const override;\n     void visitDocuments(const LidVector & lids, search::IDocumentVisitor & visitor, ReadConsistency) const override;\n+    DocumentUP getDocument(search::DocumentIdT lid, const document::DocumentId &, const document::FieldSet &) const override;\n     void populate(search::DocumentIdT lid, document::Document & doc) const;\n+    bool needFetchFromDocStore(const document::FieldSet &) const;\n private:\n+    using FieldSetAttributeMap = vespalib::hash_map<uint64_t, bool>;\n+    bool needFetchFromDocStore(uint64_t key, const document::Field &) const;\n+    bool needFetchFromDocStore(uint64_t key, const document::Field::Set &) const;\n+    void populate(search::DocumentIdT lid, document::Document & doc, const document::Field::Set & attributeFields) const;\n+\n+    bool isFieldAttribute(const document::Field & field) const;\n     const search::index::Schema     &_schema;\n     const search::IAttributeManager &_attr_manager;\n     const search::IDocumentStore    &_doc_store;\n     PositionFields                   _possiblePositionFields;\n-    AttributeFields                  _attributeFields;\n+    document::Field::Set             _attributeFields;\n+    bool                             _areAllFieldsAttributes;", "originalCommit": "7af09657ed382216b3406e26c6f79bb43ba090e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE4NTI1Mg==", "url": "https://github.com/vespa-engine/vespa/pull/14010#discussion_r469185252", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-08-12T11:18:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU3MDQ5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU3OTQyMg==", "url": "https://github.com/vespa-engine/vespa/pull/14010#discussion_r468579422", "bodyText": "please remove", "author": "havardpe", "createdAt": "2020-08-11T13:29:37Z", "path": "searchcore/src/vespa/searchcore/proton/server/documentretriever.cpp", "diffHunk": "@@ -73,13 +77,82 @@ ::DocumentRetriever(const DocTypeName &docTypeName,\n         } else {\n             const vespalib::string &name = field->getName();\n             AttributeGuard::UP attr = attr_manager.getAttribute(name);\n-            if (attr && attr->valid()) {\n-                _attributeFields.emplace_back(field);\n+            if (attr && attr->valid()\n+                && !_schema.isIndexField(field->getName())\n+                && ((*attr)->getBasicType() != BasicType::PREDICATE)\n+                && ((*attr)->getBasicType() != BasicType::REFERENCE))\n+            {\n+                _attributeFields.insert(field);\n             }\n         }\n     }\n }\n \n+bool\n+DocumentRetriever::needFetchFromDocStore(const document::FieldSet & fieldSet) const {\n+    switch (fieldSet.getType()) {\n+        case document::FieldSet::Type::NONE:\n+            return false;\n+        case document::FieldSet::Type::DOCID:\n+            return false;\n+        case document::FieldSet::Type::ALL:\n+            return ! _areAllFieldsAttributes;\n+        case document::FieldSet::Type::FIELD: {\n+            const auto & field = static_cast<const document::Field &>(fieldSet);\n+            return needFetchFromDocStore(field.getId(), field);\n+        }\n+        case document::FieldSet::Type::SET: {\n+            const auto &set = static_cast<const document::FieldCollection &>(fieldSet);\n+            return needFetchFromDocStore(set.hash(), set.getFields());\n+        }\n+        default:\n+            abort();\n+    }\n+}\n+\n+bool\n+DocumentRetriever::isFieldAttribute(const document::Field & field) const {\n+    return _attributeFields.find(&field) != _attributeFields.end();\n+#if 0", "originalCommit": "7af09657ed382216b3406e26c6f79bb43ba090e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE4NTk2Mg==", "url": "https://github.com/vespa-engine/vespa/pull/14010#discussion_r469185962", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-08-12T11:19:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU3OTQyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU4NjE2Mw==", "url": "https://github.com/vespa-engine/vespa/pull/14010#discussion_r468586163", "bodyText": "if this is actually useful/needed, please refactor into a separate class telling us if a specific field set is a superset of other field sets or not. How much faster is it to take a lock compared to looking up a set of strings in an immutable hash table?", "author": "havardpe", "createdAt": "2020-08-11T13:39:19Z", "path": "searchcore/src/vespa/searchcore/proton/server/documentretriever.h", "diffHunk": "@@ -25,15 +25,26 @@ class DocumentRetriever : public DocumentRetrieverBase {\n                       const search::IDocumentStore &doc_store);\n     ~DocumentRetriever() override;\n \n-    document::Document::UP getDocument(search::DocumentIdT lid) const override;\n+    document::Document::UP getDocumentByLidOnly(search::DocumentIdT lid) const override;\n     void visitDocuments(const LidVector & lids, search::IDocumentVisitor & visitor, ReadConsistency) const override;\n+    DocumentUP getDocument(search::DocumentIdT lid, const document::DocumentId &, const document::FieldSet &) const override;\n     void populate(search::DocumentIdT lid, document::Document & doc) const;\n+    bool needFetchFromDocStore(const document::FieldSet &) const;\n private:\n+    using FieldSetAttributeMap = vespalib::hash_map<uint64_t, bool>;\n+    bool needFetchFromDocStore(uint64_t key, const document::Field &) const;\n+    bool needFetchFromDocStore(uint64_t key, const document::Field::Set &) const;\n+    void populate(search::DocumentIdT lid, document::Document & doc, const document::Field::Set & attributeFields) const;\n+\n+    bool isFieldAttribute(const document::Field & field) const;\n     const search::index::Schema     &_schema;\n     const search::IAttributeManager &_attr_manager;\n     const search::IDocumentStore    &_doc_store;\n     PositionFields                   _possiblePositionFields;\n-    AttributeFields                  _attributeFields;\n+    document::Field::Set             _attributeFields;\n+    bool                             _areAllFieldsAttributes;\n+    mutable FieldSetAttributeMap     _isFieldSetAttributeOnly;", "originalCommit": "7af09657ed382216b3406e26c6f79bb43ba090e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIwNDUzOA==", "url": "https://github.com/vespa-engine/vespa/pull/14010#discussion_r469204538", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-08-12T11:58:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU4NjE2Mw=="}], "type": "inlineReview"}, {"oid": "be4d955b8bc9ab94d8ed1b72b03d5a112e196da2", "url": "https://github.com/vespa-engine/vespa/commit/be4d955b8bc9ab94d8ed1b72b03d5a112e196da2", "message": "Follow up of PR comment with renaming and refactoring.", "committedDate": "2020-08-12T11:58:14Z", "type": "commit"}]}