{"pr_number": 13592, "pr_title": "Two phase put in attribute writer", "pr_createdAt": "2020-06-15T12:36:44Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/13592", "timeline": [{"oid": "587dcfb75c840f60ed76e4af6f5b06a428d1fef5", "url": "https://github.com/vespa-engine/vespa/commit/587dcfb75c840f60ed76e4af6f5b06a428d1fef5", "message": "Simplify attribute writer tests by using mock attribute manager.", "committedDate": "2020-06-15T08:05:52Z", "type": "commit"}, {"oid": "a600b2141c93c668d0f6aa4c2b5bc680e8eaf380", "url": "https://github.com/vespa-engine/vespa/commit/a600b2141c93c668d0f6aa4c2b5bc680e8eaf380", "message": "Rename variable '_m' -> '_mgr'.", "committedDate": "2020-06-15T08:05:52Z", "type": "commit"}, {"oid": "8c0fa90a06966d7f6411e915b7c0d6906c53b130", "url": "https://github.com/vespa-engine/vespa/commit/8c0fa90a06966d7f6411e915b7c0d6906c53b130", "message": "Implement initial support for two-phase puts in attribute writer.\n\nThis is only turned on for tensor attributes with a hnsw index that allows multi-threaded indexing.", "committedDate": "2020-06-15T08:05:53Z", "type": "commit"}, {"oid": "f0ce676f7de72f90cd5919c33d2fa3fb6ec76c4f", "url": "https://github.com/vespa-engine/vespa/commit/f0ce676f7de72f90cd5919c33d2fa3fb6ec76c4f", "message": "Test that attribute writer can handle put in two phases.", "committedDate": "2020-06-15T12:00:36Z", "type": "commit"}, {"oid": "b17ee23a6fd3c81ffc5ca8505b74ac922a6f6165", "url": "https://github.com/vespa-engine/vespa/commit/b17ee23a6fd3c81ffc5ca8505b74ac922a6f6165", "message": "Remove default tensor spec in doctype builder.", "committedDate": "2020-06-15T12:34:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDE2NDQ4Mg==", "url": "https://github.com/vespa-engine/vespa/pull/13592#discussion_r440164482", "bodyText": "This will hang if promise is never set, e.g. when PreparePutTask::run() doesn't set promise due to field value not being set.", "author": "toregge", "createdAt": "2020-06-15T13:11:46Z", "path": "searchcore/src/vespa/searchcore/proton/attribute/attribute_writer.cpp", "diffHunk": "@@ -303,6 +351,101 @@ PutTask::run()\n     }\n }\n \n+\n+class PreparePutTask : public vespalib::Executor::Task {\n+private:\n+    const SerialNum _serial_num;\n+    const uint32_t _docid;\n+    AttributeVector& _attr;\n+    FieldValue::SP _field_value;\n+    std::promise<std::unique_ptr<PrepareResult>> _result_promise;\n+\n+public:\n+    PreparePutTask(SerialNum serial_num_in,\n+                   uint32_t docid_in,\n+                   const AttributeWriter::WriteField& field,\n+                   std::shared_ptr<DocumentFieldExtractor> field_extractor);\n+    ~PreparePutTask() override;\n+    void run() override;\n+    SerialNum serial_num() const { return _serial_num; }\n+    uint32_t docid() const { return _docid; }\n+    AttributeVector& attr() { return _attr; }\n+    FieldValue::SP field_value() { return _field_value; }\n+    std::future<std::unique_ptr<PrepareResult>> result_future() {\n+        return _result_promise.get_future();\n+    }\n+};\n+\n+PreparePutTask::PreparePutTask(SerialNum serial_num_in,\n+                               uint32_t docid_in,\n+                               const AttributeWriter::WriteField& field,\n+                               std::shared_ptr<DocumentFieldExtractor> field_extractor)\n+    : _serial_num(serial_num_in),\n+      _docid(docid_in),\n+      _attr(field.getAttribute()),\n+      _field_value(),\n+      _result_promise()\n+{\n+    // Note: No need to store the field extractor as we are not extracting struct fields.\n+    auto value = field_extractor->getFieldValue(field.getFieldPath());\n+    _field_value.reset(value.release());\n+}\n+\n+PreparePutTask::~PreparePutTask() = default;\n+\n+void\n+PreparePutTask::run()\n+{\n+    if (_attr.getStatus().getLastSyncToken() < _serial_num) {\n+        if (_field_value.get()) {\n+            _result_promise.set_value(AttributeUpdater::prepare_set_value(_attr, _docid, *_field_value));\n+        }\n+    }\n+}\n+\n+class CompletePutTask : public vespalib::Executor::Task {\n+private:\n+    const SerialNum _serial_num;\n+    const uint32_t _docid;\n+    AttributeVector& _attr;\n+    FieldValue::SP _field_value;\n+    std::future<std::unique_ptr<PrepareResult>> _result_future;\n+    const bool _immediate_commit;\n+    std::remove_reference_t<AttributeWriter::OnWriteDoneType> _on_write_done;\n+\n+public:\n+    CompletePutTask(PreparePutTask& prepare_task,\n+                    bool immediate_commit,\n+                    AttributeWriter::OnWriteDoneType on_write_done);\n+    ~CompletePutTask() override;\n+    void run() override;\n+};\n+\n+CompletePutTask::CompletePutTask(PreparePutTask& prepare_task,\n+                                 bool immediate_commit,\n+                                 AttributeWriter::OnWriteDoneType on_write_done)\n+    : _serial_num(prepare_task.serial_num()),\n+      _docid(prepare_task.docid()),\n+      _attr(prepare_task.attr()),\n+      _field_value(prepare_task.field_value()),\n+      _result_future(prepare_task.result_future()),\n+      _immediate_commit(immediate_commit),\n+      _on_write_done(on_write_done)\n+{\n+}\n+\n+CompletePutTask::~CompletePutTask() = default;\n+\n+void\n+CompletePutTask::run()\n+{\n+    if (_attr.getStatus().getLastSyncToken() < _serial_num) {\n+        auto result = _result_future.get();", "originalCommit": "b17ee23a6fd3c81ffc5ca8505b74ac922a6f6165", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDE3NzkwMA==", "url": "https://github.com/vespa-engine/vespa/pull/13592#discussion_r440177900", "bodyText": "Fixed", "author": "geirst", "createdAt": "2020-06-15T13:32:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDE2NDQ4Mg=="}], "type": "inlineReview"}, {"oid": "a507d071f8c5f5922351e55fc23a7b12ab9c3968", "url": "https://github.com/vespa-engine/vespa/commit/a507d071f8c5f5922351e55fc23a7b12ab9c3968", "message": "Avoid deadlock if field value is not set in two phase put.", "committedDate": "2020-06-15T13:31:54Z", "type": "commit"}]}