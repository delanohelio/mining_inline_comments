{"pr_number": 15382, "pr_title": "Havardpe/more efficient single outer reduce", "pr_createdAt": "2020-11-18T16:08:07Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/15382", "timeline": [{"oid": "421108968003bc43a5b7cf594c1b7b73b91573c3", "url": "https://github.com/vespa-engine/vespa/commit/421108968003bc43a5b7cf594c1b7b73b91573c3", "message": "added combine operations for simple aggregators\n\nalso added more compile-time information to make it easier to handle\ndifferent kinds of aggregators differently.", "committedDate": "2020-11-18T15:23:11Z", "type": "commit"}, {"oid": "ce040dc378b22e1d624fe80a97a51a247f13d898", "url": "https://github.com/vespa-engine/vespa/commit/ce040dc378b22e1d624fe80a97a51a247f13d898", "message": "improve non-inner simple reduce", "committedDate": "2020-11-18T16:04:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY3MDAxMQ==", "url": "https://github.com/vespa-engine/vespa/pull/15382#discussion_r526670011", "bodyText": "namespave -> namespace", "author": "arnej27959", "createdAt": "2020-11-19T08:19:33Z", "path": "eval/src/vespa/eval/eval/aggr.h", "diffHunk": "@@ -156,17 +186,21 @@ template <typename T> class Median {\n         }\n         return result;\n     }\n+    static constexpr Aggr enum_type() { return Aggr::MEDIAN; }\n };\n \n template <typename T> class Min {\n private:\n     T _min;\n public:\n+    using value_type = T;\n     constexpr Min() : _min{std::numeric_limits<T>::infinity()} {}\n     constexpr Min(T value) : _min{value} {}\n     constexpr void sample(T value) { _min = std::min(_min, value); }\n     constexpr void merge(const Min &rhs) { _min = std::min(_min, rhs._min); }\n     constexpr T result() const { return _min; }\n+    static constexpr Aggr enum_type() { return Aggr::MIN; }\n+    static T combine(T a, T b) { return std::min(a,b); }\n };\n \n } // namespave vespalib::eval::aggr", "originalCommit": "ce040dc378b22e1d624fe80a97a51a247f13d898", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY3MjI2Mg==", "url": "https://github.com/vespa-engine/vespa/pull/15382#discussion_r526672262", "bodyText": "while \"enum_type\" works well, I think I would have chosen to call it \"enum_value\" or \"aggr_enum\" instead.", "author": "arnej27959", "createdAt": "2020-11-19T08:23:25Z", "path": "eval/src/vespa/eval/eval/aggr.cpp", "diffHunk": "@@ -17,6 +17,7 @@ struct Wrapper : Aggregator {\n     virtual void first(double value) final override { aggr = T{value}; }\n     virtual void next(double value) final override { aggr.sample(value); }\n     virtual double result() const final override { return aggr.result(); }\n+    virtual Aggr enum_type() const final override { return T::enum_type(); }", "originalCommit": "ce040dc378b22e1d624fe80a97a51a247f13d898", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY3MzA0OQ==", "url": "https://github.com/vespa-engine/vespa/pull/15382#discussion_r526673049", "bodyText": "is it useful to have a += b here?  As it's used from\n*dst = combine(*dst, *src++);\nit gives me some doubt.   I guess you also considered formulation with\nstatic void combine(T& a, T b) { a += b; }\nand so on.", "author": "arnej27959", "createdAt": "2020-11-19T08:24:45Z", "path": "eval/src/vespa/eval/eval/aggr.h", "diffHunk": "@@ -76,56 +93,69 @@ template <typename T> class Avg {\n         _cnt += rhs._cnt;\n     };\n     constexpr T result() const { return (_sum / _cnt); }\n+    static constexpr Aggr enum_type() { return Aggr::AVG; }\n };\n \n template <typename T> class Count {\n private:\n     size_t _cnt;\n public:\n+    using value_type = T;\n     constexpr Count() : _cnt{0} {}\n     constexpr Count(T) : _cnt{1} {}\n     constexpr void sample(T) { ++_cnt; }\n     constexpr void merge(const Count &rhs) { _cnt += rhs._cnt; }\n     constexpr T result() const { return _cnt; }\n+    static constexpr Aggr enum_type() { return Aggr::COUNT; }\n };\n \n template <typename T> class Prod {\n private:\n     T _prod;\n public:\n+    using value_type = T;\n     constexpr Prod() : _prod{1} {}\n     constexpr Prod(T value) : _prod{value} {}\n     constexpr void sample(T value) { _prod *= value; }\n     constexpr void merge(const Prod &rhs) { _prod *= rhs._prod; }\n     constexpr T result() const { return _prod; }\n+    static constexpr Aggr enum_type() { return Aggr::PROD; }\n+    static T combine(T a, T b) { return (a * b); }\n };\n \n template <typename T> class Sum {\n private:\n     T _sum;\n public:\n+    using value_type = T;\n     constexpr Sum() : _sum{0} {}\n     constexpr Sum(T value) : _sum{value} {}\n     constexpr void sample(T value) { _sum += value; }\n     constexpr void merge(const Sum &rhs) { _sum += rhs._sum; }\n     constexpr T result() const { return _sum; }\n+    static constexpr Aggr enum_type() { return Aggr::SUM; }\n+    static T combine(T a, T b) { return (a += b); }", "originalCommit": "ce040dc378b22e1d624fe80a97a51a247f13d898", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjcwNjUzMA==", "url": "https://github.com/vespa-engine/vespa/pull/15382#discussion_r526706530", "bodyText": "yes, was a relic from the 'past'", "author": "havardpe", "createdAt": "2020-11-19T09:19:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY3MzA0OQ=="}], "type": "inlineReview"}, {"oid": "55dad1ab4491465c2d67fc9ad19cf28b867f078d", "url": "https://github.com/vespa-engine/vespa/commit/55dad1ab4491465c2d67fc9ad19cf28b867f078d", "message": "minor fixup", "committedDate": "2020-11-19T09:29:13Z", "type": "commit"}]}