{"pr_number": 12918, "pr_title": "Introduce top-k-probability and use it to fetch correct proper amount\u2026", "pr_createdAt": "2020-04-15T10:20:44Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/12918", "timeline": [{"oid": "712ad877d53849772f29b6962a5cb261131e3668", "url": "https://github.com/vespa-engine/vespa/commit/712ad877d53849772f29b6962a5cb261131e3668", "message": "Introduce top-k-probability and use it to fetch correct proper amount of hits from each partition", "committedDate": "2020-04-15T10:16:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0MzA2Ng==", "url": "https://github.com/vespa-engine/vespa/pull/12918#discussion_r408743066", "bodyText": "Not: It's just a single formula", "author": "bratseth", "createdAt": "2020-04-15T10:33:21Z", "path": "configdefinitions/src/vespa/dispatch.def", "diffHunk": "@@ -23,6 +23,13 @@ distributionPolicy enum { ROUNDROBIN, ADAPTIVE } default=ROUNDROBIN\n ## don't use it if you don't (really) mean it.\n maxHitsPerNode int default=2147483647\n \n+## Probability for getting the correct topK documents.\n+## A value of 1.0 will ask all partitions for topK documents.\n+## Any value between <0, 1> will use a Student T fith 30 degrees freedom and compute a K value that\n+## will give you the topK documents according to this formulae.", "originalCommit": "712ad877d53849772f29b6962a5cb261131e3668", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc4NDk5OQ==", "url": "https://github.com/vespa-engine/vespa/pull/12918#discussion_r408784999", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-04-15T11:54:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0MzA2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0NDM2Mg==", "url": "https://github.com/vespa-engine/vespa/pull/12918#discussion_r408744362", "bodyText": "Here perhaps we should say \"for the number of documents specified by the hits parameter\".\nIn general it's a bit strange that \"hits\" is suddenly called \"topK\" just because we optimize, but otoh it makes it easier to search for this :-)", "author": "bratseth", "createdAt": "2020-04-15T10:35:43Z", "path": "configdefinitions/src/vespa/dispatch.def", "diffHunk": "@@ -23,6 +23,13 @@ distributionPolicy enum { ROUNDROBIN, ADAPTIVE } default=ROUNDROBIN\n ## don't use it if you don't (really) mean it.\n maxHitsPerNode int default=2147483647\n \n+## Probability for getting the correct topK documents.\n+## A value of 1.0 will ask all partitions for topK documents.", "originalCommit": "712ad877d53849772f29b6962a5cb261131e3668", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc4NTA2Mw==", "url": "https://github.com/vespa-engine/vespa/pull/12918#discussion_r408785063", "bodyText": "Improved", "author": "baldersheim", "createdAt": "2020-04-15T11:54:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0NDM2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0NjY1OQ==", "url": "https://github.com/vespa-engine/vespa/pull/12918#discussion_r408746659", "bodyText": "Would be better to move this into the estimator I think. (And then also move it to the top level as a package-visible class).", "author": "bratseth", "createdAt": "2020-04-15T10:40:06Z", "path": "container-search/src/main/java/com/yahoo/search/dispatch/searchcluster/SearchCluster.java", "diffHunk": "@@ -76,6 +96,9 @@ public SearchCluster(String clusterId, DispatchConfig dispatchConfig, int contai\n         for (Node node : nodes)\n             nodesByHostBuilder.put(node.hostname(), node);\n         this.nodesByHost = nodesByHostBuilder.build();\n+        hitEstimator = ((0.0 < dispatchConfig.topKProbability()) && (dispatchConfig.topKProbability() < 1.0))", "originalCommit": "712ad877d53849772f29b6962a5cb261131e3668", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc3NzY5Nw==", "url": "https://github.com/vespa-engine/vespa/pull/12918#discussion_r408777697", "bodyText": "Agree, done.", "author": "baldersheim", "createdAt": "2020-04-15T11:41:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0NjY1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0NjgyNA==", "url": "https://github.com/vespa-engine/vespa/pull/12918#discussion_r408746824", "bodyText": "Same, why not move this into the estimator.", "author": "bratseth", "createdAt": "2020-04-15T10:40:19Z", "path": "container-search/src/main/java/com/yahoo/search/dispatch/searchcluster/SearchCluster.java", "diffHunk": "@@ -240,6 +263,12 @@ private void setInRotationOnlyIf(boolean inRotation) {\n             vipStatus.removeFromRotation(clusterId);\n     }\n \n+    public int estimateHitsToFetch(int wantedHits, int numPartitions) {\n+        return ((hitEstimator == null) || (numPartitions <= 1))", "originalCommit": "712ad877d53849772f29b6962a5cb261131e3668", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0NzcxMA==", "url": "https://github.com/vespa-engine/vespa/pull/12918#discussion_r408747710", "bodyText": "Might be quite useful to control this by query? How much you care can depend on use case ...", "author": "bratseth", "createdAt": "2020-04-15T10:41:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0NjgyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc4NTMzNw==", "url": "https://github.com/vespa-engine/vespa/pull/12918#discussion_r408785337", "bodyText": "Moved.\nWill add query too.", "author": "baldersheim", "createdAt": "2020-04-15T11:55:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0NjgyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg1MzMzNg==", "url": "https://github.com/vespa-engine/vespa/pull/12918#discussion_r408853336", "bodyText": "Now I have added query side control. dispatch.top-k-probability.\nCan '-' be used in query without requiring any escaping ?\nI used that to have it identical with services.xml.", "author": "baldersheim", "createdAt": "2020-04-15T13:45:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc0NjgyNA=="}], "type": "inlineReview"}, {"oid": "2cebe16d47872f08472ac52cbfc9e1102fb695da", "url": "https://github.com/vespa-engine/vespa/commit/2cebe16d47872f08472ac52cbfc9e1102fb695da", "message": "Say that we are using commons.math.", "committedDate": "2020-04-15T11:39:56Z", "type": "commit"}, {"oid": "a4e565c808f7999f561b0dad881f3a34040ab5d7", "url": "https://github.com/vespa-engine/vespa/commit/a4e565c808f7999f561b0dad881f3a34040ab5d7", "message": "Make SearchCluster.TopKEstimator a top level class.", "committedDate": "2020-04-15T11:58:29Z", "type": "commit"}, {"oid": "d07b20d7655d74f0460abc5dfceb7039bb8ec371", "url": "https://github.com/vespa-engine/vespa/commit/d07b20d7655d74f0460abc5dfceb7039bb8ec371", "message": "Add query control of top-k-probability.", "committedDate": "2020-04-15T13:32:56Z", "type": "commit"}, {"oid": "f3cdaea393449a02f03435fd20e78d622a2abaf3", "url": "https://github.com/vespa-engine/vespa/commit/f3cdaea393449a02f03435fd20e78d622a2abaf3", "message": "Use camelcase", "committedDate": "2020-04-15T13:50:22Z", "type": "commit"}, {"oid": "ea8be02317e30e7f4d0f8dd02b6dc661eb8fb99a", "url": "https://github.com/vespa-engine/vespa/commit/ea8be02317e30e7f4d0f8dd02b6dc661eb8fb99a", "message": "Hide in container-dev what you use in container-search.", "committedDate": "2020-04-15T15:13:37Z", "type": "commit"}, {"oid": "d54d3da12ab2a935ac97cf95f4edb49db6ca1c5a", "url": "https://github.com/vespa-engine/vespa/commit/d54d3da12ab2a935ac97cf95f4edb49db6ca1c5a", "message": "Add copyright too.", "committedDate": "2020-04-15T15:20:21Z", "type": "commit"}, {"oid": "e43e5c2bbb4fcae4346d25ce9e4b96e9264aaf7c", "url": "https://github.com/vespa-engine/vespa/commit/e43e5c2bbb4fcae4346d25ce9e4b96e9264aaf7c", "message": "common -> commons", "committedDate": "2020-04-15T16:28:10Z", "type": "commit"}, {"oid": "4d1d647f1a15bf2c2491b0c28df2888f0359eb7c", "url": "https://github.com/vespa-engine/vespa/commit/4d1d647f1a15bf2c2491b0c28df2888f0359eb7c", "message": "Add export pacaked on org.apache.commons.math3.distribution", "committedDate": "2020-04-15T17:18:34Z", "type": "commit"}, {"oid": "40e0e4a802619c90568b79ce7b095de8ae0540b2", "url": "https://github.com/vespa-engine/vespa/commit/40e0e4a802619c90568b79ce7b095de8ae0540b2", "message": "Needed here anyway.", "committedDate": "2020-04-15T18:19:40Z", "type": "commit"}, {"oid": "3188b0ed12db5c43220e99173b949911a3dcd6b6", "url": "https://github.com/vespa-engine/vespa/commit/3188b0ed12db5c43220e99173b949911a3dcd6b6", "message": "Remove exclude.", "committedDate": "2020-04-15T21:30:33Z", "type": "commit"}, {"oid": "cc436f402118300a5ffba223480cd63da2345008", "url": "https://github.com/vespa-engine/vespa/commit/cc436f402118300a5ffba223480cd63da2345008", "message": "- Add compile scope in applicatio/pom.xml\n- Exclude in container-dev/pom.xml", "committedDate": "2020-04-15T23:34:57Z", "type": "commit"}]}