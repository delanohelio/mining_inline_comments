{"pr_number": 13075, "pr_title": "Prepare for making persistence layer async.", "pr_createdAt": "2020-04-26T23:13:10Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/13075", "timeline": [{"oid": "4663fd3fab5ee4d7a00c7549a96628d44f27ca6d", "url": "https://github.com/vespa-engine/vespa/commit/4663fd3fab5ee4d7a00c7549a96628d44f27ca6d", "message": "Prepare for making persistence layer async.\nAvoid state in the thread.", "committedDate": "2020-04-26T23:09:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTYyMDU1NQ==", "url": "https://github.com/vespa-engine/vespa/pull/13075#discussion_r415620555", "bodyText": "Super nitpick: missing leading space", "author": "vekterli", "createdAt": "2020-04-27T08:36:56Z", "path": "storage/src/vespa/storage/persistence/persistencethread.cpp", "diffHunk": "@@ -934,7 +933,10 @@ PersistenceThread::flushAllReplies(\n         }\n #endif\n         spi::Bucket b(bucket, spi::PartitionId(_env._partition));\n-        spi::Result result = _spi.flush(b, _context);\n+        // Flush is not used for anything currentlu, and the context is not correct either when batching is done\n+        //So just faking it here.", "originalCommit": "4663fd3fab5ee4d7a00c7549a96628d44f27ca6d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTYzMTE4MA==", "url": "https://github.com/vespa-engine/vespa/pull/13075#discussion_r415631180", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-04-27T08:52:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTYyMDU1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTYyMTU5NQ==", "url": "https://github.com/vespa-engine/vespa/pull/13075#discussion_r415621595", "bodyText": "Consider removing now outdated comment for this line regarding old _context", "author": "vekterli", "createdAt": "2020-04-27T08:38:30Z", "path": "storage/src/vespa/storage/persistence/persistencethread.cpp", "diffHunk": "@@ -186,9 +185,9 @@ PersistenceThread::handleGet(api::GetCommand& cmd)\n     document::FieldSetRepo repo;\n     document::FieldSet::UP fieldSet = repo.parse(*_env._component.getTypeRepo(), cmd.getFieldSet());\n     // _context is reset per command, so it's safe to modify it like this.\n-    _context.setReadConsistency(api_read_consistency_to_spi(cmd.internal_read_consistency()));\n+    context.setReadConsistency(api_read_consistency_to_spi(cmd.internal_read_consistency()));", "originalCommit": "4663fd3fab5ee4d7a00c7549a96628d44f27ca6d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTYzMTUyNw==", "url": "https://github.com/vespa-engine/vespa/pull/13075#discussion_r415631527", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-04-27T08:52:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTYyMTU5NQ=="}], "type": "inlineReview"}, {"oid": "391580eefbecc3a97a8527a79a02e8687c8db46a", "url": "https://github.com/vespa-engine/vespa/commit/391580eefbecc3a97a8527a79a02e8687c8db46a", "message": "Update comments to reflect reality.", "committedDate": "2020-04-27T08:49:33Z", "type": "commit"}]}