{"pr_number": 12223, "pr_title": "Arnej/hnsw search preview.", "pr_createdAt": "2020-02-17T14:16:21Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/12223", "timeline": [{"oid": "b73944d9d7745fa59b228958b75cba46a92447b8", "url": "https://github.com/vespa-engine/vespa/commit/b73944d9d7745fa59b228958b75cba46a92447b8", "message": "add simple find_top_k method", "committedDate": "2020-02-17T12:58:59Z", "type": "commit"}, {"oid": "f4d3589c6b00c330246fa486afc5fe20f6a0f9fe", "url": "https://github.com/vespa-engine/vespa/commit/f4d3589c6b00c330246fa486afc5fe20f6a0f9fe", "message": "test find_top_k also", "committedDate": "2020-02-17T13:25:04Z", "type": "commit"}, {"oid": "1ab187d4152775a22d1b554fd2364ec5058cdfee", "url": "https://github.com/vespa-engine/vespa/commit/1ab187d4152775a22d1b554fd2364ec5058cdfee", "message": "add search API in NearestNeighborIndex", "committedDate": "2020-02-17T14:07:24Z", "type": "commit"}, {"oid": "d3853d707b9fd95a7cdb9d0edf1ad8de245dc049", "url": "https://github.com/vespa-engine/vespa/commit/d3853d707b9fd95a7cdb9d0edf1ad8de245dc049", "message": "test top-level API also", "committedDate": "2020-02-17T14:13:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDUyNDI3OQ==", "url": "https://github.com/vespa-engine/vespa/pull/12223#discussion_r380524279", "bodyText": "Perhaps 'k + 100' should be a parameter to the function instead, e.g. 'search_k'?", "author": "geirst", "createdAt": "2020-02-18T08:39:16Z", "path": "searchlib/src/vespa/searchlib/tensor/hnsw_index.cpp", "diffHunk": "@@ -310,6 +310,43 @@ HnswIndex::remove_document(uint32_t docid)\n     _node_refs[docid].store_release(invalid);\n }\n \n+std::vector<uint32_t>\n+HnswIndex::find_top_k(TypedCells vector, uint32_t k)\n+{\n+    std::vector<uint32_t> result;\n+    std::vector<HnswCandidate> candidates = top_k_candidates(vector, k + 100);", "originalCommit": "d3853d707b9fd95a7cdb9d0edf1ad8de245dc049", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTI1OTk5OA==", "url": "https://github.com/vespa-engine/vespa/pull/12223#discussion_r381259998", "bodyText": "now exposed as \"explore_k\"", "author": "arnej27959", "createdAt": "2020-02-19T12:28:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDUyNDI3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDUyNjkyOA==", "url": "https://github.com/vespa-engine/vespa/pull/12223#discussion_r380526928", "bodyText": "Consider removing this.", "author": "geirst", "createdAt": "2020-02-18T08:44:55Z", "path": "searchlib/src/tests/tensor/hnsw_index/hnsw_index_test.cpp", "diffHunk": "@@ -86,6 +86,24 @@ class HnswIndexTest : public ::testing::Test {\n         ASSERT_EQ(exp_levels.size(), act_node.size());\n         EXPECT_EQ(exp_levels, act_node.levels());\n     }\n+    void expect_top_3(uint32_t docid, std::vector<uint32_t> exp_hits) {\n+        uint32_t k = 3;\n+        auto qv = vectors.get_vector(docid);\n+        auto rv = index->top_k_candidates(qv, k);\n+        size_t idx = 0;\n+        for (const auto & hit : rv) {\n+            // fprintf(stderr, \"found docid %u dist %.1f\\n\", hit.docid, hit.distance);", "originalCommit": "d3853d707b9fd95a7cdb9d0edf1ad8de245dc049", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6d06888aeadc0f10f9c5ac1d0e780fdbb00701aa", "url": "https://github.com/vespa-engine/vespa/commit/6d06888aeadc0f10f9c5ac1d0e780fdbb00701aa", "message": "expose explore_k in top level API", "committedDate": "2020-02-19T12:15:00Z", "type": "commit"}, {"oid": "347c2d62ef1d1a73bc53da22ce5dfa3f213946da", "url": "https://github.com/vespa-engine/vespa/commit/347c2d62ef1d1a73bc53da22ce5dfa3f213946da", "message": "explore at least k always", "committedDate": "2020-02-19T14:42:19Z", "type": "commit"}]}