{"pr_number": 13870, "pr_title": "Shutdown state server and metric manager before service layer", "pr_createdAt": "2020-07-13T09:17:35Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/13870", "timeline": [{"oid": "ccc59fb7598ee714d0119e7e8de39699e467603c", "url": "https://github.com/vespa-engine/vespa/commit/ccc59fb7598ee714d0119e7e8de39699e467603c", "message": "Shutdown state server and metric manager before service layer\n\nAvoids a very small race condition window where metric update hooks\nmay point into the service layer components even after they have\nbeen destroyed, as these are not explicitly unregistered today.\n\nAnother option would be to add unregistering on component destruction,\nbut that adds another race condition where an external client may\nobserve partial metric existence during this time window. By shutting\ndown the metric exporting interfaces first, we should avoid this.", "committedDate": "2020-07-13T09:04:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU4NDg1Ng==", "url": "https://github.com/vespa-engine/vespa/pull/13870#discussion_r453584856", "bodyText": "We need to reset _customComponentRootToken and _customComponentBindToken first, as these have reference to a JsonHandlerRepo owned by the StateServer, and will access this when destructed.", "author": "geirst", "createdAt": "2020-07-13T11:31:48Z", "path": "searchcore/src/vespa/searchcore/proton/server/proton.cpp", "diffHunk": "@@ -462,6 +462,15 @@ Proton::~Proton()\n     LOG(debug, \"Explicit destructor done\");\n }\n \n+void\n+Proton::perform_pre_service_layer_shutdown_steps()\n+{\n+    _stateServer.reset();", "originalCommit": "ccc59fb7598ee714d0119e7e8de39699e467603c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU4NjMzOA==", "url": "https://github.com/vespa-engine/vespa/pull/13870#discussion_r453586338", "bodyText": "In Proton::~Proton() we do _executor.sync(); before any of this. I am not sure if we need something similar here. @toregge can you comment on that?", "author": "geirst", "createdAt": "2020-07-13T11:34:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU4NDg1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU5NzI3MQ==", "url": "https://github.com/vespa-engine/vespa/pull/13870#discussion_r453597271", "bodyText": "That depends on what queued tasks can contain references to the structure being destroyed.  We should probably close the config fetcher, disable reconfig and sync the executor, to avoid new DocumentDB instances arriving after we've decided to take down the metrics manager\n.", "author": "toregge", "createdAt": "2020-07-13T11:57:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU4NDg1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY0Nzg2NA==", "url": "https://github.com/vespa-engine/vespa/pull/13870#discussion_r453647864", "bodyText": "I have moved config, token, state server and metrics shutdown into a dedicated method. Explicit executor sync is done in both places. PTAL", "author": "vekterli", "createdAt": "2020-07-13T13:26:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU4NDg1Ng=="}], "type": "inlineReview"}, {"oid": "6baa1e6579ea6b9e21e2d10eb0e25368e6b594ed", "url": "https://github.com/vespa-engine/vespa/commit/6baa1e6579ea6b9e21e2d10eb0e25368e6b594ed", "message": "Close config and reset component tokens prior to state server shutdown", "committedDate": "2020-07-13T12:49:29Z", "type": "commit"}]}