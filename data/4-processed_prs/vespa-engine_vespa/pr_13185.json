{"pr_number": 13185, "pr_title": "Balder/handle operation with shorter vectors", "pr_createdAt": "2020-05-07T21:33:39Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/13185", "timeline": [{"oid": "90e3dc358cad438b12e59489302c746541c1dda9", "url": "https://github.com/vespa-engine/vespa/commit/90e3dc358cad438b12e59489302c746541c1dda9", "message": "Code cleanup while reading code.", "committedDate": "2020-05-07T18:04:33Z", "type": "commit"}, {"oid": "b42b06208f31a120009adade2238d34ce228ed18", "url": "https://github.com/vespa-engine/vespa/commit/b42b06208f31a120009adade2238d34ce228ed18", "message": "In order to handle and/or/andnot where the left hand side is longer than the right hand size,\nwe handle it as if it had been false padded.\nThis is to handle the case where you end up below a SourceBlender, where the disk indexes\nhave different ages and docId limits. These padded bits will never be accessed, as they will never be chosen by the source blender.\nBut having well defined behavior is always good.", "committedDate": "2020-05-07T21:14:40Z", "type": "commit"}, {"oid": "4b071b048ee01b58ef920899a64e928bbb0d88cf", "url": "https://github.com/vespa-engine/vespa/commit/4b071b048ee01b58ef920899a64e928bbb0d88cf", "message": "Rename after change of sematics.", "committedDate": "2020-05-07T21:35:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjA2NTYzMA==", "url": "https://github.com/vespa-engine/vespa/pull/13185#discussion_r422065630", "bodyText": "This should check if the right one ends before this one, since the right one could start before this one and also end before this one while still having greater size (should also add unit test for this case).", "author": "havardpe", "createdAt": "2020-05-08T10:21:21Z", "path": "searchlib/src/vespa/searchlib/common/bitvector.cpp", "diffHunk": "@@ -178,8 +178,17 @@ void\n BitVector::orWith(const BitVector & right)\n {\n     verifyContains(*this, right);\n-    IAccelrated::getAccelrator().orBit(getActiveStart(), right.getWordIndex(getStartIndex()), getActiveBytes());\n \n+    if (right.size() < size()) {", "originalCommit": "b42b06208f31a120009adade2238d34ce228ed18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQxNDkxNg==", "url": "https://github.com/vespa-engine/vespa/pull/13185#discussion_r422414916", "bodyText": "I don't think this is a problem, since size() includes the portion before getStartIndex().\ngetEndIndex() doesn't make sense, and should be removed.", "author": "toregge", "createdAt": "2020-05-08T23:12:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjA2NTYzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQxODk0Mw==", "url": "https://github.com/vespa-engine/vespa/pull/13185#discussion_r422418943", "bodyText": "That was my conclusion after looking at the details. Removed getEndIndex.", "author": "baldersheim", "createdAt": "2020-05-08T23:31:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjA2NTYzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQwNTAwOQ==", "url": "https://github.com/vespa-engine/vespa/pull/13185#discussion_r422405009", "bodyText": "Consider adjusting exception message to match new semantics.", "author": "toregge", "createdAt": "2020-05-08T22:31:35Z", "path": "searchlib/src/vespa/searchlib/common/bitvector.cpp", "diffHunk": "@@ -20,11 +20,11 @@ using vespalib::alloc::Alloc;\n \n namespace {\n \n-void verifyContains(const search::BitVector & a, const search::BitVector & b) __attribute__((noinline));\n+void verifyInclusiveStart(const search::BitVector & a, const search::BitVector & b) __attribute__((noinline));\n \n-void verifyContains(const search::BitVector & a, const search::BitVector & b)\n+void verifyInclusiveStart(const search::BitVector & a, const search::BitVector & b)\n {\n-    if ((a.getStartIndex() < b.getStartIndex()) || (a.size() > b.size())) {\n+    if (a.getStartIndex() < b.getStartIndex()) {", "originalCommit": "4b071b048ee01b58ef920899a64e928bbb0d88cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQyMDE5Mw==", "url": "https://github.com/vespa-engine/vespa/pull/13185#discussion_r422420193", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-05-08T23:37:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQwNTAwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQwODE0MA==", "url": "https://github.com/vespa-engine/vespa/pull/13185#discussion_r422408140", "bodyText": "If right.size() is 0 then we get a wraparound and bad memory accesses. Note that bitvector have other methods that fails in a similar manner when size() is 0, e.g. clearIntervalNoInvalidation(), setInterval(), countInterval().", "author": "toregge", "createdAt": "2020-05-08T22:43:08Z", "path": "searchlib/src/vespa/searchlib/common/bitvector.cpp", "diffHunk": "@@ -177,9 +177,18 @@ BitVector::countInterval(Index start, Index end) const\n void\n BitVector::orWith(const BitVector & right)\n {\n-    verifyContains(*this, right);\n-    IAccelrated::getAccelrator().orBit(getActiveStart(), right.getWordIndex(getStartIndex()), getActiveBytes());\n+    verifyInclusiveStart(*this, right);\n \n+    if (right.size() < size()) {\n+        ssize_t commonBytes = numActiveBytes(getStartIndex(), right.size()) - sizeof(Word);\n+        if (commonBytes > 0) {\n+            IAccelrated::getAccelrator().orBit(getActiveStart(), right.getWordIndex(getStartIndex()), commonBytes);\n+        }\n+        Index last(right.size() - 1);", "originalCommit": "4b071b048ee01b58ef920899a64e928bbb0d88cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQzMjA4MQ==", "url": "https://github.com/vespa-engine/vespa/pull/13185#discussion_r422432081", "bodyText": "Guard added", "author": "baldersheim", "createdAt": "2020-05-09T00:41:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQwODE0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQxMDg3OQ==", "url": "https://github.com/vespa-engine/vespa/pull/13185#discussion_r422410879", "bodyText": "Note that repairEnds() fails to set guard bit if size() is 0. Although this should be harmless, since the guard bit should already have been set.", "author": "toregge", "createdAt": "2020-05-08T22:54:34Z", "path": "searchlib/src/vespa/searchlib/common/bitvector.cpp", "diffHunk": "@@ -199,23 +208,36 @@ BitVector::repairEnds()\n void\n BitVector::andWith(const BitVector & right)\n {\n-    verifyContains(*this, right);\n+    verifyInclusiveStart(*this, right);\n \n-    IAccelrated::getAccelrator().andBit(getActiveStart(), right.getWordIndex(getStartIndex()), getActiveBytes());\n+    uint32_t commonBytes = std::min(getActiveBytes(), numActiveBytes(getStartIndex(), right.size()));\n+    IAccelrated::getAccelrator().andBit(getActiveStart(), right.getWordIndex(getStartIndex()), commonBytes);\n+    if (right.size() < size()) {\n+        clearInterval(right.size(), size());\n+    }\n \n-    setGuardBit();\n+    repairEnds();", "originalCommit": "4b071b048ee01b58ef920899a64e928bbb0d88cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQzMjM1OA==", "url": "https://github.com/vespa-engine/vespa/pull/13185#discussion_r422432358", "bodyText": "Not guarding setGuardBit.", "author": "baldersheim", "createdAt": "2020-05-09T00:42:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQxMDg3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQxMjE1MA==", "url": "https://github.com/vespa-engine/vespa/pull/13185#discussion_r422412150", "bodyText": "Wraparound when right.size() is 0, followed by bad memory access.", "author": "toregge", "createdAt": "2020-05-08T23:00:03Z", "path": "searchlib/src/vespa/searchlib/common/bitvector.cpp", "diffHunk": "@@ -199,23 +208,36 @@ BitVector::repairEnds()\n void\n BitVector::andWith(const BitVector & right)\n {\n-    verifyContains(*this, right);\n+    verifyInclusiveStart(*this, right);\n \n-    IAccelrated::getAccelrator().andBit(getActiveStart(), right.getWordIndex(getStartIndex()), getActiveBytes());\n+    uint32_t commonBytes = std::min(getActiveBytes(), numActiveBytes(getStartIndex(), right.size()));\n+    IAccelrated::getAccelrator().andBit(getActiveStart(), right.getWordIndex(getStartIndex()), commonBytes);\n+    if (right.size() < size()) {\n+        clearInterval(right.size(), size());\n+    }\n \n-    setGuardBit();\n+    repairEnds();\n     invalidateCachedCount();\n }\n \n \n void\n BitVector::andNotWith(const BitVector& right)\n {\n-    verifyContains(*this, right);\n+    verifyInclusiveStart(*this, right);\n \n-    IAccelrated::getAccelrator().andNotBit(getActiveStart(), right.getWordIndex(getStartIndex()), getActiveBytes());\n+    if (right.size() < size()) {\n+        ssize_t commonBytes = numActiveBytes(getStartIndex(), right.size()) - sizeof(Word);\n+        if (commonBytes > 0) {\n+            IAccelrated::getAccelrator().andNotBit(getActiveStart(), right.getWordIndex(getStartIndex()), commonBytes);\n+        }\n+        Index last(right.size() - 1);", "originalCommit": "4b071b048ee01b58ef920899a64e928bbb0d88cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQzMjM5NA==", "url": "https://github.com/vespa-engine/vespa/pull/13185#discussion_r422432394", "bodyText": "Guard added", "author": "baldersheim", "createdAt": "2020-05-09T00:42:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQxMjE1MA=="}], "type": "inlineReview"}, {"oid": "1435d93b3d22f5c3819761246c564d6669cac54b", "url": "https://github.com/vespa-engine/vespa/commit/1435d93b3d22f5c3819761246c564d6669cac54b", "message": "Follow up on code PR comments.", "committedDate": "2020-05-08T23:33:15Z", "type": "commit"}, {"oid": "9fa23dc9f5530702d9f281b62e04ef8f4c3793c5", "url": "https://github.com/vespa-engine/vespa/commit/9fa23dc9f5530702d9f281b62e04ef8f4c3793c5", "message": "Add protection to avoid going out of bounds when handling an empty bitvector.", "committedDate": "2020-05-09T00:40:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQzNTM2Nw==", "url": "https://github.com/vespa-engine/vespa/pull/13185#discussion_r422435367", "bodyText": "Consider also checking that org.getStartIndex() is zero or adjusting constructor for AllocatedBitVector to handle\nthat case.", "author": "toregge", "createdAt": "2020-05-09T01:07:05Z", "path": "searchlib/src/vespa/searchlib/common/bitvector.cpp", "diffHunk": "@@ -351,8 +351,8 @@ BitVector::create(Index start, Index end)\n BitVector::UP\n BitVector::create(const BitVector & org, Index start, Index end)\n {\n-    return (start == 0)\n-           ? create(end)\n+    return ((start == 0) && (end == org.size()))", "originalCommit": "1435d93b3d22f5c3819761246c564d6669cac54b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ4MDc0NQ==", "url": "https://github.com/vespa-engine/vespa/pull/13185#discussion_r422480745", "bodyText": "Fixed using first option.", "author": "baldersheim", "createdAt": "2020-05-09T10:33:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQzNTM2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQzNjM0MQ==", "url": "https://github.com/vespa-engine/vespa/pull/13185#discussion_r422436341", "bodyText": "This can be simplified if end is set to std::min(end, size()) before checking for start >= end.\nif end or size() is  0 then start >= end will evaluate to true, triggering the early return.", "author": "toregge", "createdAt": "2020-05-09T01:16:39Z", "path": "searchlib/src/vespa/searchlib/common/bitvector.cpp", "diffHunk": "@@ -91,9 +91,10 @@ BitVector::clearInterval(Index start, Index end)\n }\n \n void\n-BitVector::clearIntervalNoInvalidation(Index start, Index end)\n+BitVector::clearIntervalNoInvalidation(Index start_in, Index end)\n {\n-    if (start >= end) { return; }\n+    Index start = std::max(start_in, getStartIndex());\n+    if (start >= end || end == 0 || size() == 0) { return; }", "originalCommit": "9fa23dc9f5530702d9f281b62e04ef8f4c3793c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ4MDc5MQ==", "url": "https://github.com/vespa-engine/vespa/pull/13185#discussion_r422480791", "bodyText": "Refactored range checking.", "author": "baldersheim", "createdAt": "2020-05-09T10:33:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQzNjM0MQ=="}], "type": "inlineReview"}, {"oid": "68709adeaefb2641974fc1e5d951e99254f001dd", "url": "https://github.com/vespa-engine/vespa/commit/68709adeaefb2641974fc1e5d951e99254f001dd", "message": "Refactor and simplify range checking.", "committedDate": "2020-05-09T10:31:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ4NDQ3OQ==", "url": "https://github.com/vespa-engine/vespa/pull/13185#discussion_r422484479", "bodyText": "Consider adding curly braces around return 0.", "author": "toregge", "createdAt": "2020-05-09T11:18:59Z", "path": "searchlib/src/vespa/searchlib/common/bitvector.cpp", "diffHunk": "@@ -133,28 +133,28 @@ BitVector::setInterval(Index start_in, Index end)\n BitVector::Index\n BitVector::count() const\n {\n-    return countInterval(getStartIndex(), size());\n+    return countInterval(Range(getStartIndex(), size()));\n }\n \n BitVector::Index\n-BitVector::countInterval(Index start_in, Index end) const\n+BitVector::countInterval(Range range_in) const\n {\n-    Index start = std::max(start_in, getStartIndex());\n-    if (start >= end || end == 0 || size() == 0) { return 0; }\n+    Range range = sanitize(range_in);\n+    if ( ! range.validNonZero()) return 0;", "originalCommit": "68709adeaefb2641974fc1e5d951e99254f001dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ4NzUyNg==", "url": "https://github.com/vespa-engine/vespa/pull/13185#discussion_r422487526", "bodyText": "Done", "author": "baldersheim", "createdAt": "2020-05-09T12:01:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ4NDQ3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ4NDUwMA==", "url": "https://github.com/vespa-engine/vespa/pull/13185#discussion_r422484500", "bodyText": "Consider adding curly braces around return statement.", "author": "toregge", "createdAt": "2020-05-09T11:19:32Z", "path": "searchlib/src/vespa/searchlib/common/bitvector.cpp", "diffHunk": "@@ -85,46 +85,46 @@ BitVector::clear()\n void\n BitVector::clearInterval(Index start, Index end)\n {\n-    clearIntervalNoInvalidation(start, end);\n+    clearIntervalNoInvalidation(Range(start, end));\n \n     invalidateCachedCount();\n }\n \n void\n-BitVector::clearIntervalNoInvalidation(Index start_in, Index end)\n+BitVector::clearIntervalNoInvalidation(Range range_in)\n {\n-    Index start = std::max(start_in, getStartIndex());\n-    if (start >= end || end == 0 || size() == 0) { return; }\n+    Range range = sanitize(range_in);\n+    if ( ! range.validNonZero()) return;\n \n-    Index last = std::min(end, size()) - 1;\n-    Index startw = wordNum(start);\n+    Index last = range.end() - 1;\n+    Index startw = wordNum(range.start());\n     Index endw = wordNum(last);\n \n     if (endw > startw) {\n-        _words[startw++] &= startBits(start);\n+        _words[startw++] &= startBits(range.start());\n         memset(_words+startw, 0, sizeof(*_words)*(endw-startw));\n         _words[endw] &= endBits(last);\n     } else {\n-        _words[startw] &= (startBits(start) | endBits(last));\n+        _words[startw] &= (startBits(range.start()) | endBits(last));\n     }\n }\n \n void\n-BitVector::setInterval(Index start_in, Index end)\n+BitVector::setInterval(Index start_in, Index end_in)\n {\n-    Index start = std::max(start_in, getStartIndex());\n-    if (start >= end || end == 0 || size() == 0) { return; }\n+    Range range = sanitize(Range(start_in, end_in));\n+    if ( ! range.validNonZero()) return;", "originalCommit": "68709adeaefb2641974fc1e5d951e99254f001dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ4NzUxMA==", "url": "https://github.com/vespa-engine/vespa/pull/13185#discussion_r422487510", "bodyText": "Done", "author": "baldersheim", "createdAt": "2020-05-09T12:01:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ4NDUwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ4NDUwOQ==", "url": "https://github.com/vespa-engine/vespa/pull/13185#discussion_r422484509", "bodyText": "Consider adding curly braces around return statement.", "author": "toregge", "createdAt": "2020-05-09T11:19:50Z", "path": "searchlib/src/vespa/searchlib/common/bitvector.cpp", "diffHunk": "@@ -85,46 +85,46 @@ BitVector::clear()\n void\n BitVector::clearInterval(Index start, Index end)\n {\n-    clearIntervalNoInvalidation(start, end);\n+    clearIntervalNoInvalidation(Range(start, end));\n \n     invalidateCachedCount();\n }\n \n void\n-BitVector::clearIntervalNoInvalidation(Index start_in, Index end)\n+BitVector::clearIntervalNoInvalidation(Range range_in)\n {\n-    Index start = std::max(start_in, getStartIndex());\n-    if (start >= end || end == 0 || size() == 0) { return; }\n+    Range range = sanitize(range_in);\n+    if ( ! range.validNonZero()) return;", "originalCommit": "68709adeaefb2641974fc1e5d951e99254f001dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ4NzQ5OA==", "url": "https://github.com/vespa-engine/vespa/pull/13185#discussion_r422487498", "bodyText": "Done", "author": "baldersheim", "createdAt": "2020-05-09T12:00:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ4NDUwOQ=="}], "type": "inlineReview"}, {"oid": "b192594d9147c20bab4ec08e81dfe5130171cab3", "url": "https://github.com/vespa-engine/vespa/commit/b192594d9147c20bab4ec08e81dfe5130171cab3", "message": "Add braces", "committedDate": "2020-05-09T12:00:29Z", "type": "commit"}]}