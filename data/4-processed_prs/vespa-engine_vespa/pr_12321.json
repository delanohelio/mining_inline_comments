{"pr_number": 12321, "pr_title": "Arnej/rework ann filter bm", "pr_createdAt": "2020-02-24T13:01:32Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/12321", "timeline": [{"oid": "ffa2293de302d99051f7fc97d29c4dc606f045f1", "url": "https://github.com/vespa-engine/vespa/commit/ffa2293de302d99051f7fc97d29c4dc606f045f1", "message": "experimental HNSW with various extensions", "committedDate": "2020-02-24T09:57:59Z", "type": "commit"}, {"oid": "cc3c709d6278ebd699d4f4c67f8f769c9b6fa177", "url": "https://github.com/vespa-engine/vespa/commit/cc3c709d6278ebd699d4f4c67f8f769c9b6fa177", "message": "add and verify filter option\nsplit out common subroutines", "committedDate": "2020-02-24T12:22:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzczNjI5Mw==", "url": "https://github.com/vespa-engine/vespa/pull/12321#discussion_r383736293", "bodyText": "Even though this code is only used for experimentation and benchmarking, I don't think we should rely on this amount of copy-paste. Please move LinkList, Node, VisitedSet, VisitedSetPool, HnswHit, GreaterDist, LesserDist, NearestPriQ and FurthestPriQ to a common place shared by this file and xp-hnswlike-nns.cpp.", "author": "geirst", "createdAt": "2020-02-25T08:56:11Z", "path": "eval/src/tests/ann/extended-hnsw.cpp", "diffHunk": "@@ -0,0 +1,830 @@\n+// Copyright 2020 Oath Inc. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#include <algorithm>\n+#include <assert.h>\n+#include <queue>\n+#include <cinttypes>\n+#include \"std-random.h\"\n+#include \"nns.h\"\n+\n+/*\n+ Todo:\n+\n+ measure effect of:\n+ 1) removing leftover backlinks during \"shrink\" operation\n+ 2) refilling to low-watermark after 1) happens\n+ 3) refilling to mid-watermark after 1) happens\n+ 4) adding then removing 20% extra documents\n+ 5) removing 20% first-added documents\n+ 6) removing first-added documents while inserting new ones\n+\n+ 7) auto-tune search_k to ensure >= 50% recall on 1000 Q with k=100\n+ 8) auto-tune search_k to ensure avg 90% recall on 1000 Q with k=100\n+ 9) auto-tune search_k to ensure >= 90% reachability of 10000 docids\n+\n+ 10) timings for SIFT, GIST, and DEEP data (100k, 200k, 300k, 500k, 700k, 1000k)\n+ */\n+\n+static size_t distcalls_simple;\n+static size_t distcalls_search_layer;\n+static size_t distcalls_other;\n+static size_t distcalls_heuristic;\n+static size_t distcalls_shrink;\n+static size_t distcalls_refill;\n+static size_t refill_needed_calls;\n+static size_t shrink_needed_calls;\n+static size_t disconnected_weak_links;\n+static size_t disconnected_for_symmetry;\n+static size_t select_n_full;\n+static size_t select_n_partial;\n+\n+struct LinkList : std::vector<uint32_t>", "originalCommit": "ffa2293de302d99051f7fc97d29c4dc606f045f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzgzNTg2NQ==", "url": "https://github.com/vespa-engine/vespa/pull/12321#discussion_r383835865", "bodyText": "I don't think we should rely on this amount of copy-paste-mutate. A lot of this code is already in sift_benchmark.cpp, the only difference being the number of dimensions. Please move the following to a common place: PointVector, DocVectorAdapter, computeDistance, read_queries, read_docs, read_data, BfHitComparator, BfHitHeap. I am afraid this code will be hard to maintain otherwise.", "author": "geirst", "createdAt": "2020-02-25T12:00:36Z", "path": "eval/src/tests/ann/gist_benchmark.cpp", "diffHunk": "@@ -0,0 +1,295 @@\n+// Copyright 2020 Oath Inc. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#include <vespa/vespalib/testkit/test_kit.h>\n+#include <vespa/vespalib/util/priority_queue.h>\n+#include <sys/types.h>\n+#include <sys/stat.h>\n+#include <fcntl.h>\n+#include <unistd.h>\n+#include <stdio.h>\n+#include <chrono>\n+\n+#define NUM_DIMS 960\n+#define NUM_DOCS 200000\n+#define NUM_REACH 10000\n+#define NUM_Q 1000\n+\n+#include \"doc_vector_access.h\"\n+#include \"nns.h\"\n+#include \"for-sift-hit.h\"\n+#include \"for-sift-top-k.h\"\n+\n+std::vector<TopK> bruteforceResults;\n+\n+struct PointVector {", "originalCommit": "cc3c709d6278ebd699d4f4c67f8f769c9b6fa177", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "44fef3325d3e9bfa673d71b87721f0979f8404c8", "url": "https://github.com/vespa-engine/vespa/commit/44fef3325d3e9bfa673d71b87721f0979f8404c8", "message": "split out common subroutines", "committedDate": "2020-02-25T14:12:03Z", "type": "commit"}, {"oid": "16c477ad557d556fe4d63c871025f10b18aba84d", "url": "https://github.com/vespa-engine/vespa/commit/16c477ad557d556fe4d63c871025f10b18aba84d", "message": "keep more code common", "committedDate": "2020-02-25T14:47:36Z", "type": "commit"}, {"oid": "6355c5dd0b2dc355812414e836b8ca6bbe2bc8ca", "url": "https://github.com/vespa-engine/vespa/commit/6355c5dd0b2dc355812414e836b8ca6bbe2bc8ca", "message": "add common header file", "committedDate": "2020-02-26T10:34:21Z", "type": "commit"}]}