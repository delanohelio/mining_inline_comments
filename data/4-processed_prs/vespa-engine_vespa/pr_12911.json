{"pr_number": 12911, "pr_title": "Ensure that documentid is legal.", "pr_createdAt": "2020-04-14T17:02:24Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/12911", "timeline": [{"oid": "9125d1651742481bdd359b7288a171c57e7b6b54", "url": "https://github.com/vespa-engine/vespa/commit/9125d1651742481bdd359b7288a171c57e7b6b54", "message": "Ensure that documentid is legal.", "committedDate": "2020-04-14T16:54:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY0MDgyNw==", "url": "https://github.com/vespa-engine/vespa/pull/12911#discussion_r408640827", "bodyText": "s/Namspace/Namespace/", "author": "vekterli", "createdAt": "2020-04-15T07:38:21Z", "path": "document/src/test/java/com/yahoo/document/IdIdStringTest.java", "diffHunk": "@@ -59,6 +62,35 @@ public void requireThatKeysWithoutValuesThrow() throws Exception {\n             new IdIdString(\"namespace\", \"type\", \"illegal-pair\", \"foo\");\n             fail();\n         } catch (IllegalArgumentException e) {\n+            assertEquals(\"Illegal key-value pair 'illegal-pair'\", e.getMessage());\n+        }\n+    }\n+\n+    @Test\n+    public void requireThatTooLongPreNamspaceSpecificThrowsWhileParsing() throws Exception {\n+        StringBuilder builder = new StringBuilder(\"id:\");\n+        for (int i = 0; i < 0x10000; i++) {\n+            builder.append('n');\n+        }\n+        builder.append(\":type::namespacespecificpart_01\");\n+        try {\n+            IdString.createIdString(builder.toString());\n+            fail();\n+        } catch (IllegalArgumentException e) {\n+            assertEquals(\"Document id prior to the namespace specific part, 65545, is longer than 65534\", e.getMessage().substring(0, 77));\n+        }\n+    }\n+    @Test\n+    public void requireThatTooLongPreNamspaceSpecificThrowsOnConstruction() {", "originalCommit": "9125d1651742481bdd359b7288a171c57e7b6b54", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY0MDg1Ng==", "url": "https://github.com/vespa-engine/vespa/pull/12911#discussion_r408640856", "bodyText": "s/Namspace/Namespace/", "author": "vekterli", "createdAt": "2020-04-15T07:38:25Z", "path": "document/src/test/java/com/yahoo/document/IdIdStringTest.java", "diffHunk": "@@ -59,6 +62,35 @@ public void requireThatKeysWithoutValuesThrow() throws Exception {\n             new IdIdString(\"namespace\", \"type\", \"illegal-pair\", \"foo\");\n             fail();\n         } catch (IllegalArgumentException e) {\n+            assertEquals(\"Illegal key-value pair 'illegal-pair'\", e.getMessage());\n+        }\n+    }\n+\n+    @Test\n+    public void requireThatTooLongPreNamspaceSpecificThrowsWhileParsing() throws Exception {", "originalCommit": "9125d1651742481bdd359b7288a171c57e7b6b54", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY0Nzk3MQ==", "url": "https://github.com/vespa-engine/vespa/pull/12911#discussion_r408647971", "bodyText": "I think a quick comment on the significance of the number 5 would be nice here", "author": "vekterli", "createdAt": "2020-04-15T07:51:11Z", "path": "document/src/main/java/com/yahoo/document/idstring/IdIdString.java", "diffHunk": "@@ -47,6 +47,10 @@ public IdIdString(String namespace, String type, String keyValues, String localI\n         super(Scheme.id, namespace, localId);\n         this.type = type;\n         boolean hasSetLocation = false;\n+        if (namespace.length() + type.length() + keyValues.length() + 5 >= IdString.MAX_LENGTH_EXCEPT_NAMESPACE_SPECIFIC) {", "originalCommit": "9125d1651742481bdd359b7288a171c57e7b6b54", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY4MTI2MA==", "url": "https://github.com/vespa-engine/vespa/pull/12911#discussion_r408681260", "bodyText": "0xffff - 1 due to actual offset being the next char after :, I presume? A tiny comment would be nice for future reference \ud83d\ude42", "author": "vekterli", "createdAt": "2020-04-15T08:47:50Z", "path": "document/src/main/java/com/yahoo/document/idstring/IdString.java", "diffHunk": "@@ -42,6 +42,7 @@ public String getGroup() {\n     private final String namespace;\n     private final String namespaceSpecific;\n     private Utf8String cache;\n+    static final int MAX_LENGTH_EXCEPT_NAMESPACE_SPECIFIC = 0xfffe;", "originalCommit": "9125d1651742481bdd359b7288a171c57e7b6b54", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}