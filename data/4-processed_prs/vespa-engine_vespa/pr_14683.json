{"pr_number": 14683, "pr_title": "Add support for multiple RPC targets per node when using Storage API \u2026", "pr_createdAt": "2020-10-02T13:04:45Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/14683", "timeline": [{"oid": "9f41290e7d90b7f100c6c7bed478873ee73924ef", "url": "https://github.com/vespa-engine/vespa/commit/9f41290e7d90b7f100c6c7bed478873ee73924ef", "message": "Add support for multiple RPC targets per node when using Storage API over RPC.\n\nThis should allow for better parallelization and higher feed throughput.\nThe bucket id associated with a message is used to select the RPC target.\nThis ensures the same RPC target is used for all messages to the same bucket to the same node,\nand the RPC target itself handles sequencing of these messages.", "committedDate": "2020-10-02T13:00:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgyODU0Mg==", "url": "https://github.com/vespa-engine/vespa/pull/14683#discussion_r498828542", "bodyText": "Before we can start using this in production I believe we must derive and use the superbucket here rather than the sub-bucket. This is because operations in flight can be remapped to other buckets when their original destination bucket is split or joined. Since RPC requests are bound to the target for the original, non-remapped bucket it's possible for sequencing to be broken for a single bucket when the replies are sent. Remapped buckets are always contained within the superbucket, so they will always be bound to the same RPC target if we use it instead.", "author": "vekterli", "createdAt": "2020-10-02T13:41:10Z", "path": "storage/src/vespa/storage/storageserver/rpc/storage_api_rpc_service.cpp", "diffHunk": "@@ -216,7 +220,7 @@ void StorageApiRpcService::send_rpc_v1_request(std::shared_ptr<api::StorageComma\n         cmd->getType().getName().c_str(), cmd->getAddress()->toString().c_str());\n \n     assert(cmd->getAddress() != nullptr);\n-    auto target = _target_resolver->resolve_rpc_target(*cmd->getAddress());\n+    auto target = _target_resolver->resolve_rpc_target(*cmd->getAddress(), cmd->getBucketId().getId());", "originalCommit": "9f41290e7d90b7f100c6c7bed478873ee73924ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQzMjkwMA==", "url": "https://github.com/vespa-engine/vespa/pull/14683#discussion_r534432900", "bodyText": "Fixed in #15617.", "author": "geirst", "createdAt": "2020-12-02T19:39:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgyODU0Mg=="}], "type": "inlineReview"}]}