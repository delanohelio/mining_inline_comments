{"pr_number": 14885, "pr_title": "GC disk related code.", "pr_createdAt": "2020-10-15T05:00:33Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/14885", "timeline": [{"oid": "30d76ff5080f3f911d9119125202d7bad0a2a9da", "url": "https://github.com/vespa-engine/vespa/commit/30d76ff5080f3f911d9119125202d7bad0a2a9da", "message": "GC disk related code.", "committedDate": "2020-10-15T04:59:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTM3ODYwNA==", "url": "https://github.com/vespa-engine/vespa/pull/14885#discussion_r505378604", "bodyText": "Should this be 1 instead?", "author": "geirst", "createdAt": "2020-10-15T09:06:51Z", "path": "storage/src/tests/persistence/persistencetestutils.cpp", "diffHunk": "@@ -76,15 +70,14 @@ PersistenceTestUtils::PersistenceTestUtils() = default;\n PersistenceTestUtils::~PersistenceTestUtils() = default;\n \n std::string\n-PersistenceTestUtils::dumpBucket(const document::BucketId& bid, uint16_t disk) {\n-    assert(disk == 0u);\n+PersistenceTestUtils::dumpBucket(const document::BucketId& bid) {\n     return dynamic_cast<spi::dummy::DummyPersistence&>(_env->_node.getPersistenceProvider()).dumpBucket(makeSpiBucket(bid));\n }\n \n void\n-PersistenceTestUtils::setupDisks(uint32_t numDisks) {\n-    _env = std::make_unique<PersistenceTestEnvironment>(DiskCount(numDisks), \"todo-make-unique-persistencetestutils\");\n-    setupExecutor(numDisks);\n+PersistenceTestUtils::setupDisks() {\n+    _env = std::make_unique<PersistenceTestEnvironment>(\"todo-make-unique-persistencetestutils\");\n+    setupExecutor(2);", "originalCommit": "30d76ff5080f3f911d9119125202d7bad0a2a9da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQxMzIwNA==", "url": "https://github.com/vespa-engine/vespa/pull/14885#discussion_r505413204", "bodyText": "Yes it should, I just tested with 2 too as it did not see the connection between disk and executors.", "author": "baldersheim", "createdAt": "2020-10-15T09:53:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTM3ODYwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTM4Mzc3Mw==", "url": "https://github.com/vespa-engine/vespa/pull/14885#discussion_r505383773", "bodyText": "This should be removed.", "author": "geirst", "createdAt": "2020-10-15T09:13:38Z", "path": "storage/src/vespa/storage/persistence/filestorage/filestorhandler.h", "diffHunk": "@@ -108,14 +105,14 @@ class FileStorHandler : public MessageSender {\n      * Schedule a storage message to be processed by the given disk\n      * @return True if we maanged to schedule operation. False if not\n      */\n-    bool schedule(const std::shared_ptr<api::StorageMessage>&, uint16_t disk);\n+    bool schedule(const std::shared_ptr<api::StorageMessage>&);\n \n     /**\n      * Used by file stor threads to get their next message to process.\n      *\n      * @param disk The disk to get messages for", "originalCommit": "30d76ff5080f3f911d9119125202d7bad0a2a9da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQxMjU2MA==", "url": "https://github.com/vespa-engine/vespa/pull/14885#discussion_r505412560", "bodyText": "Fixed", "author": "baldersheim", "createdAt": "2020-10-15T09:52:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTM4Mzc3Mw=="}], "type": "inlineReview"}, {"oid": "74ee668794123075fee9be2a052fbe311572619e", "url": "https://github.com/vespa-engine/vespa/commit/74ee668794123075fee9be2a052fbe311572619e", "message": "Do not change number of executors, and update comments.", "committedDate": "2020-10-15T09:38:34Z", "type": "commit"}, {"oid": "4e449284ab770f9956cb0c39d3834c7c881b81ec", "url": "https://github.com/vespa-engine/vespa/commit/4e449284ab770f9956cb0c39d3834c7c881b81ec", "message": "Update comment", "committedDate": "2020-10-15T09:52:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTM4ODQxNQ==", "url": "https://github.com/vespa-engine/vespa/pull/14885#discussion_r505388415", "bodyText": "Is there anything left actually using this directory at this point?", "author": "vekterli", "createdAt": "2020-10-15T09:20:01Z", "path": "storage/src/tests/persistence/persistencetestutils.cpp", "diffHunk": "@@ -25,13 +25,11 @@ namespace {\n \n     spi::LoadType defaultLoadType(0, \"default\");\n \n-    vdstestlib::DirConfig initialize(uint32_t numDisks, const std::string & rootOfRoot) {\n+    vdstestlib::DirConfig initialize(const std::string & rootOfRoot) {\n         vdstestlib::DirConfig config(getStandardConfig(true, rootOfRoot));\n         std::string rootFolder = getRootFolder(config);\n         vespalib::rmdir(rootFolder, true);\n-        for (uint32_t i = 0; i < numDisks; i++) {\n-            vespalib::mkdir(vespalib::make_string(\"%s/disks/d%d\", rootFolder.c_str(), i), true);\n-        }\n+        vespalib::mkdir(vespalib::make_string(\"%s/disks/d0\", rootFolder.c_str()), true);", "originalCommit": "30d76ff5080f3f911d9119125202d7bad0a2a9da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ2MzEwNA==", "url": "https://github.com/vespa-engine/vespa/pull/14885#discussion_r505463104", "bodyText": "Not that I know of.", "author": "baldersheim", "createdAt": "2020-10-15T11:21:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTM4ODQxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ0NTMxOA==", "url": "https://github.com/vespa-engine/vespa/pull/14885#discussion_r505445318", "bodyText": "Consider removing extra indentation", "author": "vekterli", "createdAt": "2020-10-15T10:47:57Z", "path": "storage/src/vespa/storage/persistence/filestorage/filestorhandlerimpl.cpp", "diffHunk": "@@ -151,11 +141,9 @@ FileStorHandlerImpl::clearMergeStatus(const document::Bucket& bucket, const api:\n void\n FileStorHandlerImpl::flush(bool killPendingMerges)\n {\n-    for (uint32_t i=0; i<_diskInfo.size(); ++i) {\n-        LOG(debug, \"Wait until queues and bucket locks released for disk '%d'\", i);\n-        _diskInfo[i].flush();\n-        LOG(debug, \"All queues and bucket locks released for disk '%d'\", i);\n-    }\n+        LOG(debug, \"Wait until queues and bucket locks released.\");\n+        _disk.flush();\n+        LOG(debug, \"All queues and bucket locks released.\");", "originalCommit": "4e449284ab770f9956cb0c39d3834c7c881b81ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ2MzQ3OA==", "url": "https://github.com/vespa-engine/vespa/pull/14885#discussion_r505463478", "bodyText": "It is on its way in a new PR", "author": "baldersheim", "createdAt": "2020-10-15T11:22:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ0NTMxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ0OTAxNA==", "url": "https://github.com/vespa-engine/vespa/pull/14885#discussion_r505449014", "bodyText": "Consider removing this header since it no longer provides a useful hierarchy", "author": "vekterli", "createdAt": "2020-10-15T10:54:35Z", "path": "storage/src/vespa/storage/persistence/filestorage/filestorhandlerimpl.cpp", "diffHunk": "@@ -1295,22 +1232,21 @@ FileStorHandlerImpl::getStatus(std::ostream& out, const framework::HttpUrlPath&\n {\n     bool verbose = path.hasAttribute(\"verbose\");\n     out << \"<h1>Filestor handler</h1>\\n\";\n-    for (uint32_t i=0; i<_diskInfo.size(); ++i) {\n-        out << \"<h2>Disk \" << i << \"</h2>\\n\";\n-        const Disk& disk(_diskInfo[i]);\n-        out << \"Queue size: \" << disk.getQueueSize() << \"<br>\\n\";\n-        out << \"Disk state: \";\n-        switch (disk.getState()) {\n-            case FileStorHandler::AVAILABLE: out << \"AVAILABLE\"; break;\n-            case FileStorHandler::DISABLED: out << \"DISABLED\"; break;\n-            case FileStorHandler::CLOSED: out << \"CLOSED\"; break;\n-        }\n-        out << \"<h4>Active operations</h4>\\n\";\n-        disk.dumpActiveHtml(out);\n-        if (!verbose) continue;\n+\n+    out << \"<h2>Disk \" << \"</h2>\\n\";", "originalCommit": "4e449284ab770f9956cb0c39d3834c7c881b81ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ2Mzc0Mg==", "url": "https://github.com/vespa-engine/vespa/pull/14885#discussion_r505463742", "bodyText": "Will do in followup PR", "author": "baldersheim", "createdAt": "2020-10-15T11:22:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ0OTAxNA=="}], "type": "inlineReview"}]}