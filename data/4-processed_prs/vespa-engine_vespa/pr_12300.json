{"pr_number": 12300, "pr_title": "Remove user tenants", "pr_createdAt": "2020-02-21T08:45:58Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/12300", "timeline": [{"oid": "cca6019344fcbc03fd84007059f73c2ea7c6cbce", "url": "https://github.com/vespa-engine/vespa/commit/cca6019344fcbc03fd84007059f73c2ea7c6cbce", "message": "Remove user tenants\n\n@mpolden please review. @tokle FYI.\n\nThis removes all traces of user tenants from our controllers.\nExisting deployments (there are none right now) are deactivated,\nand applications deleted on restart of the controller, for all\napplications under a user tenant.\nExisting user tenants are deleted on restart of the controller.\nAPIs pretends creating user tenants is OK, and that any user\ntenant already exists, for the purposes of dashboard compatibility.", "committedDate": "2020-02-21T08:45:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQ2NDYxMA==", "url": "https://github.com/vespa-engine/vespa/pull/12300#discussion_r382464610", "bodyText": "Add a TODO for removing this.", "author": "mpolden", "createdAt": "2020-02-21T08:58:56Z", "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/ApplicationController.java", "diffHunk": "@@ -130,13 +130,18 @@\n             int count = 0;\n             for (TenantAndApplicationId id: curator.readApplicationIds()) {\n                 lockApplicationIfPresent(id, application -> {\n-                    if (id.tenant().value().startsWith(\"by-\"))\n-                        application = application.with(DeploymentSpec.empty);\n-                    else\n+                    if (id.tenant().value().startsWith(\"by-\")) {", "originalCommit": "cca6019344fcbc03fd84007059f73c2ea7c6cbce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQ3NDMxMA==", "url": "https://github.com/vespa-engine/vespa/pull/12300#discussion_r382474310", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                if (id.tenant().value().startsWith(\"by-\")) {\n          \n          \n            \n                                if (id.tenant().value().startsWith(\"by-\")) { // TODO jonmv: Remove after run once.", "author": "jonmv", "createdAt": "2020-02-21T09:20:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQ2NDYxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQ2NDc2OQ==", "url": "https://github.com/vespa-engine/vespa/pull/12300#discussion_r382464769", "bodyText": "Add a TODO for removing this.", "author": "mpolden", "createdAt": "2020-02-21T08:59:15Z", "path": "controller-server/src/main/java/com/yahoo/vespa/hosted/controller/TenantController.java", "diffHunk": "@@ -47,8 +46,12 @@ public TenantController(Controller controller, CuratorDb curator, AccessControl\n             Instant start = controller.clock().instant();\n             int count = 0;\n             for (TenantName name : curator.readTenantNames()) {\n-                lockIfPresent(name, LockedTenant.class, this::store);\n-                count++;\n+                if (name.value().startsWith(Tenant.userPrefix))", "originalCommit": "cca6019344fcbc03fd84007059f73c2ea7c6cbce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQ3NDQ0MQ==", "url": "https://github.com/vespa-engine/vespa/pull/12300#discussion_r382474441", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            if (name.value().startsWith(Tenant.userPrefix))\n          \n          \n            \n                            if (name.value().startsWith(Tenant.userPrefix)) // TODO jonmv: Remove after run once.", "author": "jonmv", "createdAt": "2020-02-21T09:20:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQ2NDc2OQ=="}], "type": "inlineReview"}, {"oid": "165b51c2b0aaab6113c1cdeb29880e4da6d682b3", "url": "https://github.com/vespa-engine/vespa/commit/165b51c2b0aaab6113c1cdeb29880e4da6d682b3", "message": "Add TODOs for removing transition code", "committedDate": "2020-02-21T09:20:57Z", "type": "commit"}]}