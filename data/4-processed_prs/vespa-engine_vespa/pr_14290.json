{"pr_number": 14290, "pr_title": "Arnej/optimize copy cells", "pr_createdAt": "2020-09-04T13:12:00Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/14290", "timeline": [{"oid": "6785469ac47303825b4195bbd03e2f574f0c1582", "url": "https://github.com/vespa-engine/vespa/commit/6785469ac47303825b4195bbd03e2f574f0c1582", "message": "resize hashtable before inserting", "committedDate": "2020-09-04T13:07:03Z", "type": "commit"}, {"oid": "5648f551b6f8953a79fe4d31ce5ffeebe17609a8", "url": "https://github.com/vespa-engine/vespa/commit/5648f551b6f8953a79fe4d31ce5ffeebe17609a8", "message": "copy the entire hash table and adjust the pointers.", "committedDate": "2020-09-04T13:07:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzcxNzYzNw==", "url": "https://github.com/vespa-engine/vespa/pull/14290#discussion_r483717637", "bodyText": "1 - A little comment about this not changing the hash value would be good.\n2 - I guess you can can also write it as\ncell.first = SparseTensorAddressRef(cell.first, stash);\nYou should see what effect it has on speed. The compiler might find it easier or harder.\nnoexcept on the SparseTensorAddressRef constructors might also make it easier on the optimizer.", "author": "baldersheim", "createdAt": "2020-09-04T16:08:43Z", "path": "eval/src/vespa/eval/tensor/sparse/sparse_tensor.cpp", "diffHunk": "@@ -29,10 +29,11 @@ using Cells = SparseTensor::Cells;\n void\n copyCells(Cells &cells, const Cells &cells_in, Stash &stash)\n {\n-    for (const auto &cell : cells_in) {\n+    cells = cells_in;\n+    for (auto &cell : cells) {\n         SparseTensorAddressRef oldRef = cell.first;\n         SparseTensorAddressRef newRef(oldRef, stash);\n-        cells[newRef] = cell.second;\n+        cell.first = newRef;", "originalCommit": "5648f551b6f8953a79fe4d31ce5ffeebe17609a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDIxOTAxOQ==", "url": "https://github.com/vespa-engine/vespa/pull/14290#discussion_r484219019", "bodyText": "added some comments.\ndoing 2) or adding noexcept didn't have any impact on the produced code, so I left it as-is.", "author": "arnej27959", "createdAt": "2020-09-07T06:57:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzcxNzYzNw=="}], "type": "inlineReview"}, {"oid": "cb68428feab8bb84d4c5fe5ef6800c3543ee67f4", "url": "https://github.com/vespa-engine/vespa/commit/cb68428feab8bb84d4c5fe5ef6800c3543ee67f4", "message": "add comment explaining dirty tricks", "committedDate": "2020-09-07T06:48:52Z", "type": "commit"}]}