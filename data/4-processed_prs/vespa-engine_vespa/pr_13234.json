{"pr_number": 13234, "pr_title": "Arnej/use global filter in nn blueprint ", "pr_createdAt": "2020-05-13T09:56:29Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/13234", "timeline": [{"oid": "aa958f364f43e58a0e8fff81b4e2e77513f22a7b", "url": "https://github.com/vespa-engine/vespa/commit/aa958f364f43e58a0e8fff81b4e2e77513f22a7b", "message": "use global filter in NN blueprint", "committedDate": "2020-05-12T14:29:42Z", "type": "commit"}, {"oid": "a72a4afc5d33c175f360460f727e5d51c9574fac", "url": "https://github.com/vespa-engine/vespa/commit/a72a4afc5d33c175f360460f727e5d51c9574fac", "message": "own the filter in a class and use shared_from_this", "committedDate": "2020-05-12T14:29:42Z", "type": "commit"}, {"oid": "ee292c3b215c8609513e50e4de52afb26912fc94", "url": "https://github.com/vespa-engine/vespa/commit/ee292c3b215c8609513e50e4de52afb26912fc94", "message": "use std::forward correctly", "committedDate": "2020-05-13T08:32:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMzMzIyMg==", "url": "https://github.com/vespa-engine/vespa/pull/13234#discussion_r424333222", "bodyText": "global filter should be const here", "author": "havardpe", "createdAt": "2020-05-13T10:24:41Z", "path": "searchlib/src/vespa/searchlib/queryeval/blueprint.h", "diffHunk": "@@ -186,7 +187,7 @@ class Blueprint\n \n     virtual bool supports_termwise_children() const { return false; }\n     virtual bool always_needs_unpack() const { return false; }\n-    virtual void set_global_filter(std::shared_ptr<BitVector> global_filter);\n+    virtual void set_global_filter(GlobalFilter &global_filter);", "originalCommit": "ee292c3b215c8609513e50e4de52afb26912fc94", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMzNDEwMA==", "url": "https://github.com/vespa-engine/vespa/pull/13234#discussion_r424334100", "bodyText": "just use ctor_tag() instead of x", "author": "havardpe", "createdAt": "2020-05-13T10:26:14Z", "path": "searchlib/src/vespa/searchlib/queryeval/global_filter.h", "diffHunk": "@@ -0,0 +1,39 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#pragma once\n+\n+#include <memory>\n+#include <vespa/searchlib/common/bitvector.h>\n+\n+namespace search::queryeval {\n+\n+class GlobalFilter : public std::enable_shared_from_this<GlobalFilter>\n+{\n+private:\n+    struct ctor_tag {};\n+    std::unique_ptr<search::BitVector> bit_vector;\n+\n+    GlobalFilter(const GlobalFilter &) = delete;\n+    GlobalFilter(GlobalFilter &&) = delete;\n+public:\n+\n+    GlobalFilter(ctor_tag, std::unique_ptr<search::BitVector> bit_vector_in)\n+      : bit_vector(std::move(bit_vector_in))\n+    {}\n+\n+    GlobalFilter(ctor_tag) : bit_vector() {}\n+\n+    ~GlobalFilter() {}\n+\n+    template<typename ... Params>\n+    static std::shared_ptr<GlobalFilter> create(Params&& ... params) {\n+        ctor_tag x;\n+        return std::make_shared<GlobalFilter>(x, std::forward<Params>(params)...);", "originalCommit": "ee292c3b215c8609513e50e4de52afb26912fc94", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMzNTQxMg==", "url": "https://github.com/vespa-engine/vespa/pull/13234#discussion_r424335412", "bodyText": "prefer bool(bit_vector) to (bool)bit_vector", "author": "havardpe", "createdAt": "2020-05-13T10:28:41Z", "path": "searchlib/src/vespa/searchlib/queryeval/global_filter.h", "diffHunk": "@@ -0,0 +1,39 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#pragma once\n+\n+#include <memory>\n+#include <vespa/searchlib/common/bitvector.h>\n+\n+namespace search::queryeval {\n+\n+class GlobalFilter : public std::enable_shared_from_this<GlobalFilter>\n+{\n+private:\n+    struct ctor_tag {};\n+    std::unique_ptr<search::BitVector> bit_vector;\n+\n+    GlobalFilter(const GlobalFilter &) = delete;\n+    GlobalFilter(GlobalFilter &&) = delete;\n+public:\n+\n+    GlobalFilter(ctor_tag, std::unique_ptr<search::BitVector> bit_vector_in)\n+      : bit_vector(std::move(bit_vector_in))\n+    {}\n+\n+    GlobalFilter(ctor_tag) : bit_vector() {}\n+\n+    ~GlobalFilter() {}\n+\n+    template<typename ... Params>\n+    static std::shared_ptr<GlobalFilter> create(Params&& ... params) {\n+        ctor_tag x;\n+        return std::make_shared<GlobalFilter>(x, std::forward<Params>(params)...);\n+    }\n+\n+    const search::BitVector *filter() const { return bit_vector.get(); }\n+\n+    bool has_filter() const { return (bool)bit_vector; }", "originalCommit": "ee292c3b215c8609513e50e4de52afb26912fc94", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5319a2c4c0614d8fd1dd635a29a92922fd73d0e7", "url": "https://github.com/vespa-engine/vespa/commit/5319a2c4c0614d8fd1dd635a29a92922fd73d0e7", "message": "constify GlobalFilter passing", "committedDate": "2020-05-13T11:37:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM3NDM1NA==", "url": "https://github.com/vespa-engine/vespa/pull/13234#discussion_r424374354", "bodyText": "Consider using auto.", "author": "geirst", "createdAt": "2020-05-13T11:47:23Z", "path": "searchlib/src/tests/queryeval/blueprint/intermediate_blueprints_test.cpp", "diffHunk": "@@ -70,8 +70,9 @@ TEST(\"test AndNot Blueprint\") {\n         EXPECT_EQUAL(false, a.getState().want_global_filter());\n         a.addChild(ap(MyLeafSpec(20).addField(1, 1).want_global_filter().create()));\n         EXPECT_EQUAL(true, a.getState().want_global_filter());\n-        std::shared_ptr<BitVector> empty_global_filter;\n-        a.set_global_filter(empty_global_filter);\n+        std::shared_ptr<GlobalFilter> empty_global_filter = GlobalFilter::create();", "originalCommit": "5319a2c4c0614d8fd1dd635a29a92922fd73d0e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM3NDQ1NQ==", "url": "https://github.com/vespa-engine/vespa/pull/13234#discussion_r424374455", "bodyText": "Consider using auto.", "author": "geirst", "createdAt": "2020-05-13T11:47:35Z", "path": "searchlib/src/tests/queryeval/blueprint/intermediate_blueprints_test.cpp", "diffHunk": "@@ -145,8 +146,8 @@ TEST(\"test And Blueprint\") {\n         EXPECT_EQUAL(false, a.getState().want_global_filter());\n         a.addChild(ap(MyLeafSpec(20).addField(1, 1).want_global_filter().create()));\n         EXPECT_EQUAL(true, a.getState().want_global_filter());\n-        std::shared_ptr<BitVector> empty_global_filter;\n-        a.set_global_filter(empty_global_filter);\n+        std::shared_ptr<GlobalFilter> empty_global_filter = GlobalFilter::create();", "originalCommit": "5319a2c4c0614d8fd1dd635a29a92922fd73d0e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM3NDU3NA==", "url": "https://github.com/vespa-engine/vespa/pull/13234#discussion_r424374574", "bodyText": "Consider using auto.", "author": "geirst", "createdAt": "2020-05-13T11:47:47Z", "path": "searchlib/src/tests/queryeval/blueprint/intermediate_blueprints_test.cpp", "diffHunk": "@@ -225,8 +226,8 @@ TEST(\"test Or Blueprint\") {\n         EXPECT_EQUAL(false, o.getState().want_global_filter());\n         o.addChild(ap(MyLeafSpec(20).addField(1, 1).want_global_filter().create()));\n         EXPECT_EQUAL(true, o.getState().want_global_filter());\n-        std::shared_ptr<BitVector> empty_global_filter;\n-        o.set_global_filter(empty_global_filter);\n+        std::shared_ptr<GlobalFilter> empty_global_filter = GlobalFilter::create();", "originalCommit": "5319a2c4c0614d8fd1dd635a29a92922fd73d0e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM3NDY1Ng==", "url": "https://github.com/vespa-engine/vespa/pull/13234#discussion_r424374656", "bodyText": "Consider using auto.", "author": "geirst", "createdAt": "2020-05-13T11:47:55Z", "path": "searchlib/src/tests/queryeval/blueprint/intermediate_blueprints_test.cpp", "diffHunk": "@@ -380,8 +381,8 @@ TEST(\"test Rank Blueprint\") {\n         EXPECT_EQUAL(false, a.getState().want_global_filter());\n         a.addChild(ap(MyLeafSpec(20).addField(1, 1).want_global_filter().create()));\n         EXPECT_EQUAL(true, a.getState().want_global_filter());\n-        std::shared_ptr<BitVector> empty_global_filter;\n-        a.set_global_filter(empty_global_filter);\n+        std::shared_ptr<GlobalFilter> empty_global_filter = GlobalFilter::create();", "originalCommit": "5319a2c4c0614d8fd1dd635a29a92922fd73d0e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM3NDg5Mw==", "url": "https://github.com/vespa-engine/vespa/pull/13234#discussion_r424374893", "bodyText": "Please add class comment.", "author": "geirst", "createdAt": "2020-05-13T11:48:23Z", "path": "searchlib/src/vespa/searchlib/queryeval/global_filter.h", "diffHunk": "@@ -0,0 +1,38 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#pragma once\n+\n+#include <memory>\n+#include <vespa/searchlib/common/bitvector.h>\n+\n+namespace search::queryeval {\n+\n+class GlobalFilter : public std::enable_shared_from_this<GlobalFilter>", "originalCommit": "5319a2c4c0614d8fd1dd635a29a92922fd73d0e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM3NzMzMA==", "url": "https://github.com/vespa-engine/vespa/pull/13234#discussion_r424377330", "bodyText": "We should create a unit test for what happens when the global filter is considered. Should be sufficient to test the estimate result on the blueprint, and whether we are still approximate or not.", "author": "geirst", "createdAt": "2020-05-13T11:52:58Z", "path": "searchlib/src/vespa/searchlib/queryeval/nearest_neighbor_blueprint.cpp", "diffHunk": "@@ -73,20 +74,31 @@ NearestNeighborBlueprint::NearestNeighborBlueprint(const queryeval::FieldSpec& f\n         _dist_fun = nns_index->distance_function();\n     }\n     uint32_t est_hits = _attr_tensor.getNumDocs();\n-    if (_approximate && nns_index) {\n-        est_hits = std::min(target_num_hits, est_hits);\n-    }\n     setEstimate(HitEstimate(est_hits, false));\n     set_want_global_filter(true);\n }\n \n NearestNeighborBlueprint::~NearestNeighborBlueprint() = default;\n \n void\n-NearestNeighborBlueprint::set_global_filter(std::shared_ptr<BitVector> global_filter)\n+NearestNeighborBlueprint::set_global_filter(const GlobalFilter &global_filter)", "originalCommit": "5319a2c4c0614d8fd1dd635a29a92922fd73d0e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM3Nzc0Ng==", "url": "https://github.com/vespa-engine/vespa/pull/13234#discussion_r424377746", "bodyText": "This threshold should probably be configurable, but that we can do in a later PR.", "author": "geirst", "createdAt": "2020-05-13T11:53:47Z", "path": "searchlib/src/vespa/searchlib/queryeval/nearest_neighbor_blueprint.cpp", "diffHunk": "@@ -73,20 +74,31 @@ NearestNeighborBlueprint::NearestNeighborBlueprint(const queryeval::FieldSpec& f\n         _dist_fun = nns_index->distance_function();\n     }\n     uint32_t est_hits = _attr_tensor.getNumDocs();\n-    if (_approximate && nns_index) {\n-        est_hits = std::min(target_num_hits, est_hits);\n-    }\n     setEstimate(HitEstimate(est_hits, false));\n     set_want_global_filter(true);\n }\n \n NearestNeighborBlueprint::~NearestNeighborBlueprint() = default;\n \n void\n-NearestNeighborBlueprint::set_global_filter(std::shared_ptr<BitVector> global_filter)\n+NearestNeighborBlueprint::set_global_filter(const GlobalFilter &global_filter)\n {\n-    // XXX do something with global_filter here\n-    (void) global_filter;\n+    _global_filter = global_filter.shared_from_this();\n+    auto nns_index = _attr_tensor.nearest_neighbor_index();\n+    if (_approximate && nns_index) {\n+        uint32_t est_hits = _attr_tensor.getNumDocs();\n+        if (_global_filter->has_filter()) {\n+            uint32_t max_hits = _global_filter->filter()->countTrueBits();\n+            if (max_hits * 10 < est_hits) {", "originalCommit": "5319a2c4c0614d8fd1dd635a29a92922fd73d0e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "666512148e0c7a05ceb2de1ec471400fb719534a", "url": "https://github.com/vespa-engine/vespa/commit/666512148e0c7a05ceb2de1ec471400fb719534a", "message": "use auto", "committedDate": "2020-05-13T12:02:20Z", "type": "commit"}, {"oid": "433b4402498648f0f78c2eea8b38a46864420d39", "url": "https://github.com/vespa-engine/vespa/commit/433b4402498648f0f78c2eea8b38a46864420d39", "message": "add class description", "committedDate": "2020-05-13T12:08:44Z", "type": "commit"}, {"oid": "52bbe79b9d91288a83876c79b870f1e90f022fc1", "url": "https://github.com/vespa-engine/vespa/commit/52bbe79b9d91288a83876c79b870f1e90f022fc1", "message": "unit test blueprint's handling of global filter", "committedDate": "2020-05-13T14:00:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ3Nzc4NQ==", "url": "https://github.com/vespa-engine/vespa/pull/13234#discussion_r424477785", "bodyText": "For consideration: To make the tests easier to read I would prefer having one test function for each of the 3 cases tested, and move the common setup (tensor content + blueprint) to a fixture that could inherit DenseTensorAttributeMockIndex.", "author": "geirst", "createdAt": "2020-05-13T14:22:41Z", "path": "searchlib/src/tests/attribute/tensorattribute/tensorattribute_test.cpp", "diffHunk": "@@ -658,6 +667,69 @@ class DenseTensorAttributeMockIndex : public Fixture {\n     DenseTensorAttributeMockIndex() : Fixture(vec_2d_spec, true, true, true) {}\n };\n \n+TEST_F(\"blueprint takes global filter into account\", DenseTensorAttributeMockIndex)", "originalCommit": "52bbe79b9d91288a83876c79b870f1e90f022fc1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "409693b97750d60e3be4b9a216bbc5c9d9def4ab", "url": "https://github.com/vespa-engine/vespa/commit/409693b97750d60e3be4b9a216bbc5c9d9def4ab", "message": "refactor tests", "committedDate": "2020-05-14T06:29:58Z", "type": "commit"}]}