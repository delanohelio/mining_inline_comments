{"pr_number": 14281, "pr_title": "Import TensorFlow models via ONNX conversion", "pr_createdAt": "2020-09-04T08:34:49Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/14281", "timeline": [{"oid": "67caf3b6eee690bcd0c7fc7a7666bd2cf41b8816", "url": "https://github.com/vespa-engine/vespa/commit/67caf3b6eee690bcd0c7fc7a7666bd2cf41b8816", "message": "Import TensorFlow models via ONNX conversion", "committedDate": "2020-09-04T06:30:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ3NzEwMQ==", "url": "https://github.com/vespa-engine/vespa/pull/14281#discussion_r483477101", "bodyText": "Might be useful to include the last reason here?", "author": "bratseth", "createdAt": "2020-09-04T08:43:21Z", "path": "model-integration/src/main/java/ai/vespa/rankingexpression/importer/tensorflow/TensorFlowImporter.java", "diffHunk": "@@ -78,15 +69,18 @@ public ImportedModel importModel(String modelName, String modelDir, SavedModelBu\n     private ImportedModel convertToOnnxAndImport(String modelName, String modelDir) {\n         Path tempDir = null;\n         try {\n-            log.info(\"Converting TensorFlow model '\" + modelDir + \"' to ONNX...\");\n             tempDir = Files.createTempDirectory(\"tf2onnx\");\n             String convertedPath = tempDir.toString() + File.separatorChar + \"converted.onnx\";\n-            Pair<Integer, String> res = convertToOnnx(modelDir, convertedPath, defaultOnnxOpset);\n-            if (res.getFirst() != 0) {\n-                throw new IllegalArgumentException(\"Conversion from TensorFlow to ONNX failed for '\" + modelDir + \"'. \" +\n-                        \"Reason: \" + res.getSecond());\n+            for (int opset : onnxOpsetsToTry) {\n+                log.info(\"Converting TensorFlow model '\" + modelDir + \"' to ONNX with opset \" + opset + \"...\");\n+                Pair<Integer, String> res = convertToOnnx(modelDir, convertedPath, opset);\n+                if (res.getFirst() == 0) {\n+                    log.info(\"Conversion to ONNX with opset \" + opset + \" successful.\");\n+                    return onnxImporter.importModel(modelName, convertedPath);\n+                }\n+                log.info(\"Conversion to ONNX with opset \" + opset + \" failed. Reason: \" + res.getSecond());\n             }\n-            return onnxImporter.importModel(modelName, convertedPath);\n+            throw new IllegalArgumentException(\"Unable to convert TensorFlow model in '\" + modelDir + \"' to ONNX.\");", "originalCommit": "67caf3b6eee690bcd0c7fc7a7666bd2cf41b8816", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ5MzMwOQ==", "url": "https://github.com/vespa-engine/vespa/pull/14281#discussion_r483493309", "bodyText": "Good suggestion. Fixed.", "author": "lesters", "createdAt": "2020-09-04T09:12:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ3NzEwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ3NzM4NQ==", "url": "https://github.com/vespa-engine/vespa/pull/14281#discussion_r483477385", "bodyText": "I think this should probably be Level.FINE?", "author": "bratseth", "createdAt": "2020-09-04T08:43:52Z", "path": "model-integration/src/main/java/ai/vespa/rankingexpression/importer/tensorflow/TensorFlowImporter.java", "diffHunk": "@@ -78,15 +69,18 @@ public ImportedModel importModel(String modelName, String modelDir, SavedModelBu\n     private ImportedModel convertToOnnxAndImport(String modelName, String modelDir) {\n         Path tempDir = null;\n         try {\n-            log.info(\"Converting TensorFlow model '\" + modelDir + \"' to ONNX...\");\n             tempDir = Files.createTempDirectory(\"tf2onnx\");\n             String convertedPath = tempDir.toString() + File.separatorChar + \"converted.onnx\";\n-            Pair<Integer, String> res = convertToOnnx(modelDir, convertedPath, defaultOnnxOpset);\n-            if (res.getFirst() != 0) {\n-                throw new IllegalArgumentException(\"Conversion from TensorFlow to ONNX failed for '\" + modelDir + \"'. \" +\n-                        \"Reason: \" + res.getSecond());\n+            for (int opset : onnxOpsetsToTry) {\n+                log.info(\"Converting TensorFlow model '\" + modelDir + \"' to ONNX with opset \" + opset + \"...\");\n+                Pair<Integer, String> res = convertToOnnx(modelDir, convertedPath, opset);\n+                if (res.getFirst() == 0) {\n+                    log.info(\"Conversion to ONNX with opset \" + opset + \" successful.\");\n+                    return onnxImporter.importModel(modelName, convertedPath);\n+                }\n+                log.info(\"Conversion to ONNX with opset \" + opset + \" failed. Reason: \" + res.getSecond());", "originalCommit": "67caf3b6eee690bcd0c7fc7a7666bd2cf41b8816", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ5MzQxOA==", "url": "https://github.com/vespa-engine/vespa/pull/14281#discussion_r483493418", "bodyText": "Fixed.", "author": "lesters", "createdAt": "2020-09-04T09:12:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ3NzM4NQ=="}], "type": "inlineReview"}, {"oid": "5f96bfdcb4dbf38743fd4c93bad9e3acabbbd3b0", "url": "https://github.com/vespa-engine/vespa/commit/5f96bfdcb4dbf38743fd4c93bad9e3acabbbd3b0", "message": "Add reason for conversion fail to exception", "committedDate": "2020-09-04T09:11:24Z", "type": "commit"}]}