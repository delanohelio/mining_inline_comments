{"pr_number": 13255, "pr_title": "add a special API to get a whitelist bitvector", "pr_createdAt": "2020-05-14T12:56:25Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/13255", "timeline": [{"oid": "a3a3b1838b04cd35c13f1fc99dea5d90aef15c38", "url": "https://github.com/vespa-engine/vespa/commit/a3a3b1838b04cd35c13f1fc99dea5d90aef15c38", "message": "add a special API to get a whitelist bitvector", "committedDate": "2020-05-14T11:56:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE0NTc4NA==", "url": "https://github.com/vespa-engine/vespa/pull/13255#discussion_r425145784", "bodyText": "Consider forward declaring search::BitVector and using std::unique_ptrsearch::BitVector.", "author": "toregge", "createdAt": "2020-05-14T13:41:45Z", "path": "searchcore/src/vespa/searchcore/proton/documentmetastore/white_list_provider.h", "diffHunk": "@@ -0,0 +1,15 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#include <vespa/searchlib/common/bitvector.h>\n+\n+#pragma once\n+\n+namespace proton::documentmetastore {\n+\n+struct WhiteListProvider {\n+    virtual search::BitVector::UP get_white_list_filter() const = 0;", "originalCommit": "a3a3b1838b04cd35c13f1fc99dea5d90aef15c38", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE0OTMzNQ==", "url": "https://github.com/vespa-engine/vespa/pull/13255#discussion_r425149335", "bodyText": "This adds a cost (creating a copy of the white list bitvector) even when this copy won't be used.", "author": "toregge", "createdAt": "2020-05-14T13:46:28Z", "path": "searchcore/src/vespa/searchcore/proton/matching/query.cpp", "diffHunk": "@@ -156,6 +157,11 @@ void\n Query::setWhiteListBlueprint(Blueprint::UP whiteListBlueprint)\n {\n     _whiteListBlueprint = std::move(whiteListBlueprint);\n+    using proton::documentmetastore::WhiteListProvider;\n+    auto wlf = dynamic_cast<WhiteListProvider *>(_whiteListBlueprint.get());\n+    if (wlf) {\n+        _global_white_list = wlf->get_white_list_filter();", "originalCommit": "a3a3b1838b04cd35c13f1fc99dea5d90aef15c38", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTIwNjYxNg==", "url": "https://github.com/vespa-engine/vespa/pull/13255#discussion_r425206616", "bodyText": "Agree with Tor. Can we do this in optimize() instead, where we know we need it? In that case we need to store a pointer to WhiteListProvider in Query as the white list blueprint are moved into the blueprint tree between this call and the call to optimize().", "author": "geirst", "createdAt": "2020-05-14T15:01:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE0OTMzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE5OTUyMg==", "url": "https://github.com/vespa-engine/vespa/pull/13255#discussion_r425199522", "bodyText": "Please add interface comment. Consider using a class instead.", "author": "geirst", "createdAt": "2020-05-14T14:52:48Z", "path": "searchcore/src/vespa/searchcore/proton/documentmetastore/white_list_provider.h", "diffHunk": "@@ -0,0 +1,15 @@\n+// Copyright Verizon Media. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.\n+\n+#include <vespa/searchlib/common/bitvector.h>\n+\n+#pragma once\n+\n+namespace proton::documentmetastore {\n+\n+struct WhiteListProvider {", "originalCommit": "a3a3b1838b04cd35c13f1fc99dea5d90aef15c38", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6f5a1c69ba2ed4b7eddbd0e3a0b85542626fd665", "url": "https://github.com/vespa-engine/vespa/commit/6f5a1c69ba2ed4b7eddbd0e3a0b85542626fd665", "message": "minor fixes after review", "committedDate": "2020-05-14T17:54:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY0MjgyMA==", "url": "https://github.com/vespa-engine/vespa/pull/13255#discussion_r425642820", "bodyText": "This could be const as get_white_list_filter() is const.", "author": "geirst", "createdAt": "2020-05-15T08:21:40Z", "path": "searchcore/src/vespa/searchcore/proton/matching/query.h", "diffHunk": "@@ -19,11 +21,12 @@ class Query\n {\n private:\n     using Blueprint=search::queryeval::Blueprint;\n+    using WhiteListProvider=proton::documentmetastore::WhiteListProvider;\n     search::query::Node::UP _query_tree;\n     Blueprint::UP           _blueprint;\n     search::fef::Location   _location;\n     Blueprint::UP           _whiteListBlueprint;\n-    search::BitVector::UP   _global_white_list;\n+    WhiteListProvider      *_white_list_provider;", "originalCommit": "6f5a1c69ba2ed4b7eddbd0e3a0b85542626fd665", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}