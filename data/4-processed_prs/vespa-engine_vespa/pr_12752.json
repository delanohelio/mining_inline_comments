{"pr_number": 12752, "pr_title": "Set warmup duration based on zone", "pr_createdAt": "2020-03-29T07:57:37Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/12752", "timeline": [{"oid": "d0e36f8329daba094e908c1949dddd7e7de941e8", "url": "https://github.com/vespa-engine/vespa/commit/d0e36f8329daba094e908c1949dddd7e7de941e8", "message": "Set warmup duration based on zone\n\nNo warmup time necessary in cd or test environments. Set\ndefault warmup time to 89 seconds, as the previous value of 60\nseconds (which ended up being ~90 seconds) was the wanted one based\non experience with prod applications.", "committedDate": "2020-03-29T07:54:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTc2NjcyMw==", "url": "https://github.com/vespa-engine/vespa/pull/12752#discussion_r399766723", "bodyText": "Any reason this shouldn't apply to PublicCd?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return zone.getSystemName() == SystemName.cd || zone.getEnvironment().isTest()\n          \n          \n            \n                    return zone.getSystemName().isCd() || zone.getEnvironment().isTest()", "author": "freva", "createdAt": "2020-03-29T08:50:11Z", "path": "node-admin/src/main/java/com/yahoo/vespa/hosted/node/admin/nodeagent/NodeAgentImpl.java", "diffHunk": "@@ -605,4 +606,10 @@ public void createSymlink(Path symlink, Path target) {\n     protected Optional<CredentialsMaintainer> credentialsMaintainer() {\n         return credentialsMaintainer;\n     }\n+\n+    private static Duration warmUpDurationForZone(ZoneApi zone) {\n+        return zone.getSystemName() == SystemName.cd || zone.getEnvironment().isTest()", "originalCommit": "d0e36f8329daba094e908c1949dddd7e7de941e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTc2NzEwNQ==", "url": "https://github.com/vespa-engine/vespa/pull/12752#discussion_r399767105", "bodyText": "Duration of zero still starts the container unconstrained, but then immediately attempts to suspend against orch. to set limits. Negative will start the container with the constraints \n  \n    \n      vespa/node-admin/src/main/java/com/yahoo/vespa/hosted/node/admin/nodeagent/NodeAgentImpl.java\n    \n    \n         Line 215\n      in\n      44e2be1\n    \n    \n    \n    \n\n        \n          \n           ContainerResources wantedResources = context.nodeType() != NodeType.tenant || warmUpDuration.isNegative() ? \n        \n    \n  \n\n\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            ? Duration.ZERO\n          \n          \n            \n                            ? Duration.ofSeconds(-1)", "author": "freva", "createdAt": "2020-03-29T08:53:40Z", "path": "node-admin/src/main/java/com/yahoo/vespa/hosted/node/admin/nodeagent/NodeAgentImpl.java", "diffHunk": "@@ -605,4 +606,10 @@ public void createSymlink(Path symlink, Path target) {\n     protected Optional<CredentialsMaintainer> credentialsMaintainer() {\n         return credentialsMaintainer;\n     }\n+\n+    private static Duration warmUpDurationForZone(ZoneApi zone) {\n+        return zone.getSystemName() == SystemName.cd || zone.getEnvironment().isTest()\n+                ? Duration.ZERO", "originalCommit": "d0e36f8329daba094e908c1949dddd7e7de941e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTc2NzU4Nw==", "url": "https://github.com/vespa-engine/vespa/pull/12752#discussion_r399767587", "bodyText": "Consider just resolving this when needed via the ZoneApi in NodeAgentContext", "author": "freva", "createdAt": "2020-03-29T08:58:24Z", "path": "node-admin/src/main/java/com/yahoo/vespa/hosted/node/admin/nodeagent/NodeAgentImpl.java", "diffHunk": "@@ -102,9 +103,9 @@\n     public NodeAgentImpl(NodeAgentContextSupplier contextSupplier, NodeRepository nodeRepository,\n                          Orchestrator orchestrator, DockerOperations dockerOperations, StorageMaintainer storageMaintainer,\n                          FlagSource flagSource, Optional<CredentialsMaintainer> credentialsMaintainer,\n-                         Optional<AclMaintainer> aclMaintainer, Optional<HealthChecker> healthChecker, Clock clock) {\n+                         Optional<AclMaintainer> aclMaintainer, Optional<HealthChecker> healthChecker, Clock clock, ZoneApi zone) {\n         this(contextSupplier, nodeRepository, orchestrator, dockerOperations, storageMaintainer, flagSource, credentialsMaintainer,\n-                aclMaintainer, healthChecker, clock, DEFAULT_WARM_UP_DURATION);\n+             aclMaintainer, healthChecker, clock, warmUpDurationForZone(zone));", "originalCommit": "d0e36f8329daba094e908c1949dddd7e7de941e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTc2OTg5Mg==", "url": "https://github.com/vespa-engine/vespa/pull/12752#discussion_r399769892", "bodyText": "NodeAgentContextSupplier.nextContext() says blocks until the next context is readyand that sounded like something I wouldn't do in a constructor, I think I'll leave this for now at least", "author": "hmusum", "createdAt": "2020-03-29T09:20:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTc2NzU4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTc3MDI5MA==", "url": "https://github.com/vespa-engine/vespa/pull/12752#discussion_r399770290", "bodyText": "No, I meant in the methods that actually use this variable (startContainer(), updateContainerIfNeeded() and doConverge()).\nAnother option is to pass the initial context to the constructor instead of just the zone, since NodeAgentFactory already has it \n  \n    \n      vespa/node-admin/src/main/java/com/yahoo/vespa/hosted/node/admin/nodeagent/NodeAgentFactory.java\n    \n    \n         Line 9\n      in\n      44e2be1\n    \n    \n    \n    \n\n        \n          \n           NodeAgent create(NodeAgentContextSupplier contextSupplier, NodeAgentContext nodeAgentContext);", "author": "freva", "createdAt": "2020-03-29T09:24:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTc2NzU4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTc3NDY1Ng==", "url": "https://github.com/vespa-engine/vespa/pull/12752#discussion_r399774656", "bodyText": "Yes, I initially did resolving when needed, let's go back to it. Thanks, done", "author": "hmusum", "createdAt": "2020-03-29T10:05:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTc2NzU4Nw=="}], "type": "inlineReview"}, {"oid": "efc586ec3d49146b5c8ed44f9805556637db2378", "url": "https://github.com/vespa-engine/vespa/commit/efc586ec3d49146b5c8ed44f9805556637db2378", "message": "Update node-admin/src/main/java/com/yahoo/vespa/hosted/node/admin/nodeagent/NodeAgentImpl.java\n\nCo-Authored-By: Valerij Fredriksen <freva@users.noreply.github.com>", "committedDate": "2020-03-29T09:18:05Z", "type": "commit"}, {"oid": "965e3af747afaa4c4c0521d92b25cc155320d80b", "url": "https://github.com/vespa-engine/vespa/commit/965e3af747afaa4c4c0521d92b25cc155320d80b", "message": "Update node-admin/src/main/java/com/yahoo/vespa/hosted/node/admin/nodeagent/NodeAgentImpl.java\n\nCo-Authored-By: Valerij Fredriksen <freva@users.noreply.github.com>", "committedDate": "2020-03-29T09:18:14Z", "type": "commit"}, {"oid": "9109a39de0048098fc45ecf3910ac9eaaa87459b", "url": "https://github.com/vespa-engine/vespa/commit/9109a39de0048098fc45ecf3910ac9eaaa87459b", "message": "Use zone from context and resolve warmup time in method instead", "committedDate": "2020-03-29T10:03:42Z", "type": "commit"}]}