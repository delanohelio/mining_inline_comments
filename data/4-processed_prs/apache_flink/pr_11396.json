{"pr_number": 11396, "pr_title": "[FLINK-16170][connectors/elasticsearch]SearchTemplateRequest ClassNotFoundException when use flink-sql-connector-elasticsearch7", "pr_createdAt": "2020-03-13T04:59:48Z", "pr_url": "https://github.com/apache/flink/pull/11396", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjIxOTUyOA==", "url": "https://github.com/apache/flink/pull/11396#discussion_r392219528", "bodyText": "Do we need to remove this one? If yes, how about es6?", "author": "libenchao", "createdAt": "2020-03-13T13:15:25Z", "path": "flink-connectors/flink-sql-connector-elasticsearch7/pom.xml", "diffHunk": "@@ -135,10 +131,6 @@ under the License.\n \t\t\t\t\t\t\t\t\t<pattern>org.elasticsearch</pattern>\n \t\t\t\t\t\t\t\t\t<shadedPattern>org.apache.flink.elasticsearch7.shaded.org.elasticsearch</shadedPattern>\n \t\t\t\t\t\t\t\t</relocation>\n-\t\t\t\t\t\t\t\t<relocation>", "originalCommit": "28221f8d9b902110266893c9f4038ff1e6d89298", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzAwNDIwOQ==", "url": "https://github.com/apache/flink/pull/11396#discussion_r393004209", "bodyText": "Yes, sql-connector-es6 has been fixed in FLINK-16287.\nBTW, sql-connector-es6 is easier to found because  end2end test in sql_client_test cover, so this PR add e2e test for sql-connector-es7 too.", "author": "leonardBang", "createdAt": "2020-03-16T12:57:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjIxOTUyOA=="}], "type": "inlineReview"}, {"oid": "679fa6a6696f5adb075d8ef2608b97eaa99904fd", "url": "https://github.com/apache/flink/commit/679fa6a6696f5adb075d8ef2608b97eaa99904fd", "message": "replace local jar with url", "committedDate": "2020-03-16T13:01:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQ2NjYzMA==", "url": "https://github.com/apache/flink/pull/11396#discussion_r393466630", "bodyText": "We can use \"$ELASTICSEARCH_VERSION\" in SQL_CONF to avoid content replacement.", "author": "wuchong", "createdAt": "2020-03-17T06:27:04Z", "path": "flink-end-to-end-tests/test-scripts/test_sql_client.sh", "diffHunk": "@@ -262,10 +271,66 @@ EOF\n JOB_ID=$($FLINK_DIR/bin/sql-client.sh embedded \\\n   --jar $KAFKA_SQL_JAR \\\n   --jar $JSON_SQL_JAR \\\n-  --jar $ELASTICSEARCH_SQL_JAR \\\n+  --jar $ELASTICSEARCH6_SQL_JAR \\\n   --jar $SQL_TOOLBOX_JAR \\\n   --environment $SQL_CONF \\\n-  --update \"$SQL_STATEMENT_5\" | grep \"Job ID:\" | sed 's/.* //g')\n+  --update \"$SQL_STATEMENT_3\" | grep \"Job ID:\" | sed 's/.* //g')\n \n # 3 upsert results and 6 append results and 3 match_recognize results\n verify_result_line_number 12 \"$ELASTICSEARCH_INDEX\"\n+\n+###############################################################################\n+# Test sql-connector-elasticsearch7\n+###############################################################################\n+echo \"Executing SQL: Values -> Elasticsearch7 (upsert)\"\n+\n+# prepare client_conf and sql statement\n+ELASTICSEARCH_VERSION=7\n+ELASTICSEARCH7_MAC_DOWNLOAD_URL='https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.5.1-darwin-x86_64.tar.gz'\n+ELASTICSEARCH7_LINUX_DOWNLOAD_URL='https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.5.1-linux-x86_64.tar.gz'\n+\n+SQL_CONF_CONTENT=$(cat ${SQL_CONF})\n+cat >> $SQL_CONF << EOF\n+${SQL_CONF_CONTENT//version: 6/version: 7}", "originalCommit": "679fa6a6696f5adb075d8ef2608b97eaa99904fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQ3MDQwNQ==", "url": "https://github.com/apache/flink/pull/11396#discussion_r393470405", "bodyText": "nice tips", "author": "leonardBang", "createdAt": "2020-03-17T06:40:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQ2NjYzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQ2Njc4Mw==", "url": "https://github.com/apache/flink/pull/11396#discussion_r393466783", "bodyText": "Why do we need this? Does linux binary not work in mac?", "author": "wuchong", "createdAt": "2020-03-17T06:27:39Z", "path": "flink-end-to-end-tests/test-scripts/test_sql_client.sh", "diffHunk": "@@ -262,10 +271,66 @@ EOF\n JOB_ID=$($FLINK_DIR/bin/sql-client.sh embedded \\\n   --jar $KAFKA_SQL_JAR \\\n   --jar $JSON_SQL_JAR \\\n-  --jar $ELASTICSEARCH_SQL_JAR \\\n+  --jar $ELASTICSEARCH6_SQL_JAR \\\n   --jar $SQL_TOOLBOX_JAR \\\n   --environment $SQL_CONF \\\n-  --update \"$SQL_STATEMENT_5\" | grep \"Job ID:\" | sed 's/.* //g')\n+  --update \"$SQL_STATEMENT_3\" | grep \"Job ID:\" | sed 's/.* //g')\n \n # 3 upsert results and 6 append results and 3 match_recognize results\n verify_result_line_number 12 \"$ELASTICSEARCH_INDEX\"\n+\n+###############################################################################\n+# Test sql-connector-elasticsearch7\n+###############################################################################\n+echo \"Executing SQL: Values -> Elasticsearch7 (upsert)\"\n+\n+# prepare client_conf and sql statement\n+ELASTICSEARCH_VERSION=7\n+ELASTICSEARCH7_MAC_DOWNLOAD_URL='https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.5.1-darwin-x86_64.tar.gz'\n+ELASTICSEARCH7_LINUX_DOWNLOAD_URL='https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.5.1-linux-x86_64.tar.gz'\n+\n+SQL_CONF_CONTENT=$(cat ${SQL_CONF})\n+cat >> $SQL_CONF << EOF\n+${SQL_CONF_CONTENT//version: 6/version: 7}\n+EOF\n+\n+SQL_STATEMENT_4=$(cat << EOF\n+INSERT INTO ElasticsearchUpsertSinkTable\n+  SELECT user_id, user_name, COUNT(*) AS user_count\n+  FROM (VALUES (1, 'Bob'), (22, 'Tom'), (42, 'Kim'), (42, 'Kim'), (42, 'Kim'), (1, 'Bob'))\n+    AS UserCountTable(user_id, user_name)\n+  GROUP BY user_id, user_name\n+EOF\n+)\n+\n+# elastcisearch offers different release binary file for corresponding system since version 7.\n+case \"$(uname -s)\" in\n+    Linux*)     OS_TYPE=linux;;\n+    Darwin*)    OS_TYPE=mac;;\n+    *)          OS_TYPE=\"UNKNOWN:${unameOut}\"\n+esac\n+OS_TYPE='test'\n+if [[ \"$OS_TYPE\" == \"mac\" ]]; then\n+  DOWNLOAD_URL=$ELASTICSEARCH_MAC_DOWNLOAD_URL\n+elif  [[ \"$OS_TYPE\" == \"linux\" ]]; then\n+  DOWNLOAD_URL=$ELASTICSEARCH7_LINUX_DOWNLOAD_URL\n+else\n+  echo \"unsupported OS, only support Mac OS\u3001Linux now.\"\n+  exit 0\n+fi", "originalCommit": "679fa6a6696f5adb075d8ef2608b97eaa99904fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQ3MDM3Mg==", "url": "https://github.com/apache/flink/pull/11396#discussion_r393470372", "bodyText": "yes\uff0c linux binary not work in ma", "author": "leonardBang", "createdAt": "2020-03-17T06:40:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQ2Njc4Mw=="}], "type": "inlineReview"}, {"oid": "86af6a0a881c8def3f472ed333cc0305bd38c3ec", "url": "https://github.com/apache/flink/commit/86af6a0a881c8def3f472ed333cc0305bd38c3ec", "message": "[FLINK-16170][Connectors/elasticsearch]SearchTemplateRequest ClassNotFoundException when use flink-sql-connector-elasticsearch7", "committedDate": "2020-03-17T08:36:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUxNzg4OA==", "url": "https://github.com/apache/flink/pull/11396#discussion_r393517888", "bodyText": "es6 and es7 have different json format about total hits in return data,\nes6:\n{ \"took\" : 263, \"timed_out\" : false, \"_shards\" : { \"total\" : 5, \"successful\" : 5, \"skipped\" : 0, \"failed\" : 0 }, \"hits\" : { \"total\" : 3, \"max_score\" : 1.0, \"hits\" : [ { \"_index\" : \"my_users\", \"_type\" : \"user\", \"_id\" : \"42_Kim\", \"_score\" : 1.0, \"_source\" : { \"user_id\" : 42, \"user_name\" : \"Kim\", \"user_count\" : 3 } }, { \"_index\" : \"my_users\", \"_type\" : \"user\", \"_id\" : \"1_Bob\", \"_score\" : 1.0, \"_source\" : { \"user_id\" : 1, \"user_name\" : \"Bob\", \"user_count\" : 2 } }, { \"_index\" : \"my_users\", \"_type\" : \"user\", \"_id\" : \"22_Tom\", \"_score\" : 1.0, \"_source\" : { \"user_id\" : 22, \"user_name\" : \"Tom\", \"user_count\" : 1 } } ] } }\nes7:\n{ \"took\" : 263, \"timed_out\" : false, \"_shards\" : { \"total\" : 5, \"successful\" : 5, \"skipped\" : 0, \"failed\" : 0 }, \"hits\" : { \"total\" : { \"value\" : 3, \"relation\" : \"eq\" }, \"max_score\" : 1.0, \"hits\" : [ { \"_index\" : \"my_users\", \"_type\" : \"user\", \"_id\" : \"42_Kim\", \"_score\" : 1.0, \"_source\" : { \"user_id\" : 42, \"user_name\" : \"Kim\", \"user_count\" : 3 } }, { \"_index\" : \"my_users\", \"_type\" : \"user\", \"_id\" : \"1_Bob\", \"_score\" : 1.0, \"_source\" : { \"user_id\" : 1, \"user_name\" : \"Bob\", \"user_count\" : 2 } }, { \"_index\" : \"my_users\", \"_type\" : \"user\", \"_id\" : \"22_Tom\", \"_score\" : 1.0, \"_source\" : { \"user_id\" : 22, \"user_name\" : \"Tom\", \"user_count\" : 1 } } ] } }\ncheck line numbers here for general purpose.", "author": "leonardBang", "createdAt": "2020-03-17T08:40:43Z", "path": "flink-end-to-end-tests/test-scripts/test_sql_client.sh", "diffHunk": "@@ -200,18 +224,20 @@ EOF\n )\n \n JOB_ID=$($FLINK_DIR/bin/sql-client.sh embedded \\\n-  --library $SQL_JARS_DIR \\\n+  --jar $KAFKA_SQL_JAR \\\n+  --jar $JSON_SQL_JAR \\\n+  --jar $ELASTICSEARCH_SQL_JAR \\\n   --jar $SQL_TOOLBOX_JAR \\\n   --environment $SQL_CONF \\\n-  --update \"$SQL_STATEMENT_3\" | grep \"Job ID:\" | sed 's/.* //g')\n+  --update \"$SQL_STATEMENT_1\" | grep \"Job ID:\" | sed 's/.* //g')\n \n wait_job_terminal_state \"$JOB_ID\" \"FINISHED\"\n \n-verify_result_hash \"SQL Client Elasticsearch Upsert\" \"$ELASTICSEARCH_INDEX\" 3 \"21a76360e2a40f442816d940e7071ccf\"\n+verify_result_line_number 3 \"$ELASTICSEARCH_INDEX\"\n ", "originalCommit": "86af6a0a881c8def3f472ed333cc0305bd38c3ec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ1MzI0Mw==", "url": "https://github.com/apache/flink/pull/11396#discussion_r396453243", "bodyText": "What about echo an error message and exist 1 to give an explicitly exception? Otherwise, we may miss the error alert if 7 doesn't work.", "author": "wuchong", "createdAt": "2020-03-23T13:34:09Z", "path": "flink-end-to-end-tests/test-scripts/test_sql_client.sh", "diffHunk": "@@ -85,6 +90,31 @@ function sql_cleanup() {\n }\n on_exit sql_cleanup\n \n+function prepare_elasticsearch {\n+  echo \"Preparing Elasticsearch(version=$ELASTICSEARCH_VERSION)...\"\n+  # elastcisearch offers different release binary file for corresponding system since version 7.\n+  case \"$(uname -s)\" in\n+      Linux*)     OS_TYPE=linux;;\n+      Darwin*)    OS_TYPE=mac;;\n+      *)          OS_TYPE=\"UNKNOWN:${unameOut}\"\n+  esac\n+\n+  if [[ \"$ELASTICSEARCH_VERSION\" == 6 ]]; then\n+    DOWNLOAD_URL=$ELASTICSEARCH6_DOWNLOAD_URL\n+  elif [[ \"$ELASTICSEARCH_VERSION\" == 7 ]] && [[ \"$OS_TYPE\" == \"mac\" ]]; then\n+    DOWNLOAD_URL=$ELASTICSEARCH7_MAC_DOWNLOAD_URL\n+  elif [[ \"$ELASTICSEARCH_VERSION\" == 7 ]] && [[ \"$OS_TYPE\" == \"linux\" ]]; then\n+    DOWNLOAD_URL=$ELASTICSEARCH7_LINUX_DOWNLOAD_URL\n+  else\n+    echo \"Unsupported elasticsearch version($ELASTICSEARCH_VERSION) for OS: $OS_TYPE, fallback to elasticsearh($ELASTICSEARCH_VERSION).\"", "originalCommit": "86af6a0a881c8def3f472ed333cc0305bd38c3ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njg3MDQwMg==", "url": "https://github.com/apache/flink/pull/11396#discussion_r396870402", "bodyText": "okay\uff0cgiving an exception is better than fallback to elasticsearch 6.", "author": "leonardBang", "createdAt": "2020-03-24T02:35:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ1MzI0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ1NzkwMg==", "url": "https://github.com/apache/flink/pull/11396#discussion_r396457902", "bodyText": "Do we need to include carrotsearch? I saw elasticsearch connector 6 exclude this.", "author": "wuchong", "createdAt": "2020-03-23T13:40:58Z", "path": "flink-connectors/flink-sql-connector-elasticsearch7/pom.xml", "diffHunk": "@@ -63,14 +63,10 @@ under the License.\n \t\t\t\t\t\t\t\t</includes>\n \t\t\t\t\t\t\t\t<excludes>\n \t\t\t\t\t\t\t\t\t<!-- These dependencies are not required. -->\n-\t\t\t\t\t\t\t\t\t<exclude>com.carrotsearch:hppc</exclude>", "originalCommit": "86af6a0a881c8def3f472ed333cc0305bd38c3ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njg2ODk1OA==", "url": "https://github.com/apache/flink/pull/11396#discussion_r396868958", "bodyText": "yes\uff0celasticsearch connector 7 need this.", "author": "leonardBang", "createdAt": "2020-03-24T02:29:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ1NzkwMg=="}], "type": "inlineReview"}, {"oid": "16f47dc38839069d90481fe007803e12bdb49c1d", "url": "https://github.com/apache/flink/commit/16f47dc38839069d90481fe007803e12bdb49c1d", "message": "[FLINK-16170][Connectors/elasticsearch]SearchTemplateRequest ClassNotFoundException when use flink-sql-connector-elasticsearch7", "committedDate": "2020-03-24T01:21:32Z", "type": "commit"}, {"oid": "7f2e1aa51a0160c617b1dcdf5cbf231b0daae2cb", "url": "https://github.com/apache/flink/commit/7f2e1aa51a0160c617b1dcdf5cbf231b0daae2cb", "message": "[FLINK-16170][Connectors/elasticsearch]SearchTemplateRequest ClassNotFoundException when use flink-sql-connector-elasticsearch7", "committedDate": "2020-03-24T01:21:32Z", "type": "commit"}, {"oid": "2020724ee4af4b70eb09ca38690a670c9e76e17e", "url": "https://github.com/apache/flink/commit/2020724ee4af4b70eb09ca38690a670c9e76e17e", "message": "bubble up es e2e tests to avoid time limitation", "committedDate": "2020-03-24T01:21:32Z", "type": "commit"}, {"oid": "17a2cf81bfd4bcc83d26cff1c0203af4cef414b1", "url": "https://github.com/apache/flink/commit/17a2cf81bfd4bcc83d26cff1c0203af4cef414b1", "message": "address minor comments and rebase master", "committedDate": "2020-03-24T02:53:04Z", "type": "commit"}, {"oid": "17a2cf81bfd4bcc83d26cff1c0203af4cef414b1", "url": "https://github.com/apache/flink/commit/17a2cf81bfd4bcc83d26cff1c0203af4cef414b1", "message": "address minor comments and rebase master", "committedDate": "2020-03-24T02:53:04Z", "type": "forcePushed"}]}