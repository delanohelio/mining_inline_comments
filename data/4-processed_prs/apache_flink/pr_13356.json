{"pr_number": 13356, "pr_title": "[FLINK-16789][runtime][rest] Enable JMX RMI port retrieval via REST API", "pr_createdAt": "2020-09-08T14:51:38Z", "pr_url": "https://github.com/apache/flink/pull/13356", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjIzMTUyNw==", "url": "https://github.com/apache/flink/pull/13356#discussion_r486231527", "bodyText": "@zentol It seems that the documentation generation is not deterministic?", "author": "rmetzger", "createdAt": "2020-09-10T10:26:47Z", "path": "docs/_includes/generated/execution_config_configuration.html", "diffHunk": "@@ -106,6 +100,12 @@\n             <td>Boolean</td>\n             <td>Whether to compress spilled data. Currently we only support compress spilled data for sort and hash-agg and hash-join operators.</td>\n         </tr>\n+        <tr>\n+            <td><h5>table.exec.state.ttl</h5><br> <span class=\"label label-primary\">Streaming</span></td>\n+            <td style=\"word-wrap: break-word;\">0 ms</td>\n+            <td>Duration</td>\n+            <td>Specifies a minimum time interval for how long idle state (i.e. state which was not updated), will be retained. State will never be cleared until it was idle for less than the minimum time, and will be cleared at some time after it was idle. Default is never clean-up the state. NOTE: Cleaning up state requires additional overhead for bookkeeping. Default value is 0, which means that it will never clean up state.</td>\n+        </tr>", "originalCommit": "656789f8c2f1288e3b9cf369f82d0698b249f179", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjIzNDIzMQ==", "url": "https://github.com/apache/flink/pull/13356#discussion_r486234231", "bodyText": "It would be good to understand where these changes are coming from -- I want to avoid a situation where the next person generating docs will change the order again.", "author": "rmetzger", "createdAt": "2020-09-10T10:31:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjIzMTUyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQzMjQ2MA==", "url": "https://github.com/apache/flink/pull/13356#discussion_r487432460", "bodyText": "not sure why but the doc generated by this PR actually preserves alphabetical ordering", "author": "walterddr", "createdAt": "2020-09-12T17:48:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjIzMTUyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI0NzQ2NA==", "url": "https://github.com/apache/flink/pull/13356#discussion_r489247464", "bodyText": "The ordering is deterministic; but when people manually modify the files and commit it this can of course happen.", "author": "zentol", "createdAt": "2020-09-16T08:11:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjIzMTUyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI1NzUwNg==", "url": "https://github.com/apache/flink/pull/13356#discussion_r489257506", "bodyText": "We could enhance the tests to also check that the entries are sorted properly.", "author": "zentol", "createdAt": "2020-09-16T08:28:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjIzMTUyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM2OTA2Nw==", "url": "https://github.com/apache/flink/pull/13356#discussion_r489369067", "bodyText": "https://issues.apache.org/jira/browse/FLINK-19263", "author": "zentol", "createdAt": "2020-09-16T11:38:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjIzMTUyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjIzMzczNw==", "url": "https://github.com/apache/flink/pull/13356#discussion_r486233737", "bodyText": "Why is this file generated now? (I don't see a code change that triggers this)", "author": "rmetzger", "createdAt": "2020-09-10T10:30:49Z", "path": "docs/_includes/generated/jmx_server_configuration.html", "diffHunk": "@@ -0,0 +1,18 @@\n+<table class=\"table table-bordered\">", "originalCommit": "656789f8c2f1288e3b9cf369f82d0698b249f179", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQzMjUyNw==", "url": "https://github.com/apache/flink/pull/13356#discussion_r487432527", "bodyText": "this is actually due to the fact that doc gen only regenerate files (and if there's deletion, lines will be removed) but it doesn't remove the html when all items in that file was removed. I manually removed this for one of my fault doc gen", "author": "walterddr", "createdAt": "2020-09-12T17:49:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjIzMzczNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI1MjQ4OA==", "url": "https://github.com/apache/flink/pull/13356#discussion_r489252488", "bodyText": "I would prefer a more general approach; basically just a Map<String, String> containing various meta-data bits. Then we could easily add information about other services and/or ports in the future.", "author": "zentol", "createdAt": "2020-09-16T08:20:14Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/resourcemanager/TaskExecutorRegistration.java", "diffHunk": "@@ -72,13 +77,15 @@ public TaskExecutorRegistration(\n \t\t\tfinal String taskExecutorAddress,\n \t\t\tfinal ResourceID resourceId,\n \t\t\tfinal int dataPort,\n+\t\t\tfinal int jmxPort,\n \t\t\tfinal HardwareDescription hardwareDescription,\n \t\t\tfinal TaskExecutorMemoryConfiguration memoryConfiguration,\n \t\t\tfinal ResourceProfile defaultSlotResourceProfile,\n \t\t\tfinal ResourceProfile totalResourceProfile) {\n \t\tthis.taskExecutorAddress = checkNotNull(taskExecutorAddress);\n \t\tthis.resourceId = checkNotNull(resourceId);\n \t\tthis.dataPort = dataPort;\n+\t\tthis.jmxPort = jmxPort;", "originalCommit": "060bb38dd26df122e05fc232cd730b35717e84b0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUwNjk3Mg==", "url": "https://github.com/apache/flink/pull/13356#discussion_r489506972", "bodyText": "we can do that, in fact it is very similar to the JobConfigInfo message content.\ndo you want to move dataPort and some other components into this generic metadata collection? (we can mark them deprecated first then remove them in the next release)", "author": "walterddr", "createdAt": "2020-09-16T15:00:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI1MjQ4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg0NjkwOQ==", "url": "https://github.com/apache/flink/pull/13356#discussion_r490846909", "bodyText": "hmm...I think it would make sense to also include the dataPort; it doesn't appear to be used by the runtime? But that also seems to apply to the hardwareDescription and memoryConfiguration.\nhmm...maybe we should instead just bundle them in container, that is then just passed along. It would achieve my goal of not having explicit accesses to the jmx Port in various components, while still allowing us to use them for other things down the line.", "author": "zentol", "createdAt": "2020-09-18T10:15:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI1MjQ4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTQ3MTE0Ng==", "url": "https://github.com/apache/flink/pull/13356#discussion_r491471146", "bodyText": "hmm. I understand your concern. and putting an opaque Map<String, String> would definitely be safer.\ncould you elaborate what you meant by \"just bundle them in container\"? do you mean putting everything in the Map<String, String> container?", "author": "walterddr", "createdAt": "2020-09-19T16:33:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI1MjQ4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk0NTg5OA==", "url": "https://github.com/apache/flink/pull/13356#discussion_r491945898", "bodyText": "could you elaborate what you meant by \"just bundle them in container\"?\n\nJust a POJO containing all these.", "author": "zentol", "createdAt": "2020-09-21T10:41:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI1MjQ4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ4MjEyOA==", "url": "https://github.com/apache/flink/pull/13356#discussion_r495482128", "bodyText": "after some experiment, it seems like it is modifying a whole lot of public classes including header/messages in REST API as well as TaskExecutor. I think separating that into a refactor PR might've been a better idea. what do you think?", "author": "walterddr", "createdAt": "2020-09-26T18:21:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI1MjQ4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgwOTUzNw==", "url": "https://github.com/apache/flink/pull/13356#discussion_r495809537", "bodyText": "Let's leave it like it is then. I'm sure there is some way to achieve it, but it seems more hassle than it's worth.", "author": "zentol", "createdAt": "2020-09-28T09:33:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI1MjQ4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI1NTg1Nw==", "url": "https://github.com/apache/flink/pull/13356#discussion_r489255857", "bodyText": "This strikes me as an odd default value, and I could imagine this being misunderstood as \"running on some random port\". -1 may be a better choice, or even better, with my above suggestion of using a map, just not including it in the map at all.", "author": "zentol", "createdAt": "2020-09-16T08:25:42Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/taskexecutor/TaskExecutor.java", "diffHunk": "@@ -1130,6 +1131,7 @@ private void connectToResourceManager() {\n \t\t\tgetAddress(),\n \t\t\tgetResourceID(),\n \t\t\tunresolvedTaskManagerLocation.getDataPort(),\n+\t\t\tJMXService.getPort().orElse(0),", "originalCommit": "060bb38dd26df122e05fc232cd730b35717e84b0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c95d0e33b9cd23264c899aae7df75c83d290f129", "url": "https://github.com/apache/flink/commit/c95d0e33b9cd23264c899aae7df75c83d290f129", "message": "set default jmxPort to -1", "committedDate": "2020-09-26T18:18:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk3NjI0Nw==", "url": "https://github.com/apache/flink/pull/13356#discussion_r495976247", "bodyText": "this shouldn't be deleted; even if options are included in specific sections we also always generate a separate table for each originating file", "author": "zentol", "createdAt": "2020-09-28T14:20:14Z", "path": "docs/_includes/generated/jmx_server_configuration.html", "diffHunk": "@@ -1,18 +0,0 @@\n-<table class=\"table table-bordered\">\n-    <thead>\n-        <tr>\n-            <th class=\"text-left\" style=\"width: 20%\">Key</th>", "originalCommit": "c95d0e33b9cd23264c899aae7df75c83d290f129", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "174ea945be035310bd0f27bc3d00af5c815cda3d", "url": "https://github.com/apache/flink/commit/174ea945be035310bd0f27bc3d00af5c815cda3d", "message": "[FLINK-16789][runtime] add in task manager jmx port to taskmanagers/:taskmanagerid endpoint", "committedDate": "2020-09-29T03:49:45Z", "type": "commit"}, {"oid": "174ea945be035310bd0f27bc3d00af5c815cda3d", "url": "https://github.com/apache/flink/commit/174ea945be035310bd0f27bc3d00af5c815cda3d", "message": "[FLINK-16789][runtime] add in task manager jmx port to taskmanagers/:taskmanagerid endpoint", "committedDate": "2020-09-29T03:49:45Z", "type": "forcePushed"}]}