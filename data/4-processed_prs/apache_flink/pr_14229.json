{"pr_number": 14229, "pr_title": "[FLINK-20292][doc] Improve the document about table formats overlap in user fat jar", "pr_createdAt": "2020-11-26T08:52:13Z", "pr_url": "https://github.com/apache/flink/pull/14229", "timeline": [{"oid": "7d520e24839b2c31a88b651807c5169960a8595c", "url": "https://github.com/apache/flink/commit/7d520e24839b2c31a88b651807c5169960a8595c", "message": "address comments", "committedDate": "2020-11-30T15:38:47Z", "type": "forcePushed"}, {"oid": "65380924b30878760771fe7d498f66b53ce7be0b", "url": "https://github.com/apache/flink/commit/65380924b30878760771fe7d498f66b53ce7be0b", "message": "[FLINK-20292][doc] Improve the document about table formats overlap in user fat jar", "committedDate": "2020-12-01T02:58:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzEyMDQwMw==", "url": "https://github.com/apache/flink/pull/14229#discussion_r533120403", "bodyText": "We might change make -> to build, and used -> uses", "author": "gaoyunhaii", "createdAt": "2020-12-01T07:24:21Z", "path": "docs/dev/table/connectors/formats/avro-confluent.md", "diffHunk": "@@ -45,6 +45,8 @@ Dependencies\n     connector=connector\n %}\n \n+**NOTE:** If you need make an uber-jar from the project which used multiple table formats, please see [shade table formats]({% link dev/table/connectors/formats/index.md %}#shade-table-formats) for more information.", "originalCommit": "65380924b30878760771fe7d498f66b53ce7be0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzEyMTA0Ng==", "url": "https://github.com/apache/flink/pull/14229#discussion_r533121046", "bodyText": "There should be one empty line between the two notes, otherwise the two notes will be viewed as the same paragraph and will not have line break.", "author": "gaoyunhaii", "createdAt": "2020-12-01T07:25:51Z", "path": "docs/dev/table/connectors/formats/canal.md", "diffHunk": "@@ -51,7 +51,9 @@ Dependencies\n     connector=connector\n %}\n \n-*Note: please refer to [Canal documentation](https://github.com/alibaba/canal/wiki) about how to deploy Canal to synchronize changelog to message queues.*\n+\n+**NOTE:** Please refer to [Canal documentation](https://github.com/alibaba/canal/wiki) about how to deploy Canal to synchronize changelog to message queues.\n+**NOTE:** If you need make an uber-jar from the project which used multiple table formats, please see [shade table formats]({% link dev/table/connectors/formats/index.md %}#shade-table-formats) for more information.", "originalCommit": "65380924b30878760771fe7d498f66b53ce7be0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzEyMTI4OA==", "url": "https://github.com/apache/flink/pull/14229#discussion_r533121288", "bodyText": "Similarly, there should be one empty line between the two notes.", "author": "gaoyunhaii", "createdAt": "2020-12-01T07:26:32Z", "path": "docs/dev/table/connectors/formats/canal.zh.md", "diffHunk": "@@ -51,7 +51,8 @@ Flink \u8fd8\u652f\u6301\u5c06 Flink SQL \u4e2d\u7684 INSERT / UPDATE / DELETE \u6d88\u606f\u7f16\u7801\u4e3a Can\n     connector=connector\n %}\n \n-*\u6ce8\u610f\uff1a\u6709\u5173\u5982\u4f55\u90e8\u7f72 Canal \u4ee5\u5c06\u53d8\u66f4\u65e5\u5fd7\u540c\u6b65\u5230\u6d88\u606f\u961f\u5217\uff0c\u8bf7\u53c2\u9605 [Canal \u6587\u6863](https://github.com/alibaba/canal/wiki)\u3002*\n+**\u6ce8\u610f:** \u6709\u5173\u5982\u4f55\u90e8\u7f72 Canal \u4ee5\u5c06\u53d8\u66f4\u65e5\u5fd7\u540c\u6b65\u5230\u6d88\u606f\u961f\u5217\uff0c\u8bf7\u53c2\u9605 [Canal \u6587\u6863](https://github.com/alibaba/canal/wiki)\u3002\n+**\u6ce8\u610f:** \u5982\u679c\u4f60\u9700\u8981\u4ece\u4e00\u4e2a\u5305\u542b\u591a\u4e2a\u8868\u683c\u5f0f\u7684\u5de5\u7a0b\u521b\u5efa uber-jar, \u8bf7\u67e5\u770b [shade \u8868\u683c\u5f0f]({% link dev/table/connectors/formats/index.zh.md %}#shade-\u8868\u683c\u5f0f) \u9875\u9762\u83b7\u53d6\u66f4\u591a\u4fe1\u606f\u3002", "originalCommit": "65380924b30878760771fe7d498f66b53ce7be0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzEyMTMyNA==", "url": "https://github.com/apache/flink/pull/14229#discussion_r533121324", "bodyText": "Similarly, there should be one empty line between the two notes.", "author": "gaoyunhaii", "createdAt": "2020-12-01T07:26:39Z", "path": "docs/dev/table/connectors/formats/debezium.md", "diffHunk": "@@ -59,7 +59,9 @@ Dependencies\n </div>\n </div>\n \n-*Note: please refer to [Debezium documentation](https://debezium.io/documentation/reference/1.3/index.html) about how to setup a Debezium Kafka Connect to synchronize changelog to Kafka topics.*\n+**NOTE:** please refer to [Debezium documentation](https://debezium.io/documentation/reference/1.3/index.html) about how to setup a Debezium Kafka Connect to synchronize changelog to Kafka topics.\n+**NOTE:** If you need make an uber-jar from the project which used multiple table formats, please see [shade table formats]({% link dev/table/connectors/formats/index.md %}#shade-table-formats) for more information.", "originalCommit": "65380924b30878760771fe7d498f66b53ce7be0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzEyMTM1NA==", "url": "https://github.com/apache/flink/pull/14229#discussion_r533121354", "bodyText": "Similarly, there should be one empty line between the two notes.", "author": "gaoyunhaii", "createdAt": "2020-12-01T07:26:44Z", "path": "docs/dev/table/connectors/formats/debezium.zh.md", "diffHunk": "@@ -59,7 +59,8 @@ Flink \u8fd8\u652f\u6301\u5c06 Flink SQL \u4e2d\u7684 INSERT / UPDATE / DELETE \u6d88\u606f\u7f16\u7801\u4e3a Deb\n </div>\n </div>\n \n-*\u6ce8\u610f: \u8bf7\u53c2\u8003 [Debezium \u6587\u6863](https://debezium.io/documentation/reference/1.3/index.html)\uff0c\u4e86\u89e3\u5982\u4f55\u8bbe\u7f6e Debezium Kafka Connect \u7528\u6765\u5c06\u53d8\u66f4\u65e5\u5fd7\u540c\u6b65\u5230 Kafka \u4e3b\u9898\u3002*\n+**\u6ce8\u610f:** \u8bf7\u53c2\u8003 [Debezium \u6587\u6863](https://debezium.io/documentation/reference/1.3/index.html)\uff0c\u4e86\u89e3\u5982\u4f55\u8bbe\u7f6e Debezium Kafka Connect \u7528\u6765\u5c06\u53d8\u66f4\u65e5\u5fd7\u540c\u6b65\u5230 Kafka \u4e3b\u9898\u3002\n+**\u6ce8\u610f:** \u5982\u679c\u4f60\u9700\u8981\u4ece\u4e00\u4e2a\u5305\u542b\u591a\u4e2a\u8868\u683c\u5f0f\u7684\u5de5\u7a0b\u521b\u5efa uber-jar, \u8bf7\u67e5\u770b [shade \u8868\u683c\u5f0f]({% link dev/table/connectors/formats/index.zh.md %}#shade-\u8868\u683c\u5f0f) \u9875\u9762\u83b7\u53d6\u66f4\u591a\u4fe1\u606f\u3002", "originalCommit": "65380924b30878760771fe7d498f66b53ce7be0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzEyODc3Mw==", "url": "https://github.com/apache/flink/pull/14229#discussion_r533128773", "bodyText": "If we want to make this line in a separate paragraph there should be one empty line between the two lines.", "author": "gaoyunhaii", "createdAt": "2020-12-01T07:43:50Z", "path": "docs/dev/table/connectors/formats/index.md", "diffHunk": "@@ -90,3 +90,61 @@ Flink supports the following formats:\n         </tr>\n     </tbody>\n </table>\n+\n+\n+Shade Table Formats\n+-------------------\n+ Flink uses Java's [Service Provider Interfaces (SPI)](https://docs.oracle.com/javase/tutorial/sound/SPI-intro.html) to load the factory of table format by table format identifier, the SPI configuration file `org.apache.flink.table.factories.Factory` for every table format is under the same directory `META-INF/services`, these META-INF/services files will overlap each other when building a jar-with-dependency of the project if your project has used more than one table format, this will lead Flink can not load these table format factories correctly.\n+ In this situation, a recommended way is shading these table formats and using maven-shade-plugin [ServicesResourceTransformer](https://maven.apache.org/plugins/maven-shade-plugin/examples/resource-transformers.html) to merge these META-INF/services files properly.", "originalCommit": "65380924b30878760771fe7d498f66b53ce7be0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzEzNDYzMQ==", "url": "https://github.com/apache/flink/pull/14229#discussion_r533134631", "bodyText": "shading these table formats : I think we should not need to shade these table formats, to me shading should refers to the action like change the package of io.netty to org.apache.flink.shaded.io.netty. We only use the transformer to merge the configuration files.\nthese META-INF/services files: we might use the configuration files under META-INF/services to be more precise ?", "author": "gaoyunhaii", "createdAt": "2020-12-01T07:56:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzEyODc3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzEzMTQ5Mw==", "url": "https://github.com/apache/flink/pull/14229#discussion_r533131493", "bodyText": "How about we change\n\nload the factory of table factory by table format identifier, -> load the table format factories by their identifiers.\nthe SPI configuration file ... -> Since the SPI configuration file named...\nthese META-INF/services files  -> these configuration files  ? I think the files are the configuration files that get overrided\noverlap -> override ?\na jar-with-dependency -> the uber-jar ? Since we use uber-jar in other places and might better to unify the names.\nthis will...  -> which will... \nlead Flink can not -> cause Flink to fail to, it seems lead must be used as lead to + nonu.", "author": "gaoyunhaii", "createdAt": "2020-12-01T07:49:39Z", "path": "docs/dev/table/connectors/formats/index.md", "diffHunk": "@@ -90,3 +90,61 @@ Flink supports the following formats:\n         </tr>\n     </tbody>\n </table>\n+\n+\n+Shade Table Formats\n+-------------------\n+ Flink uses Java's [Service Provider Interfaces (SPI)](https://docs.oracle.com/javase/tutorial/sound/SPI-intro.html) to load the factory of table format by table format identifier, the SPI configuration file `org.apache.flink.table.factories.Factory` for every table format is under the same directory `META-INF/services`, these META-INF/services files will overlap each other when building a jar-with-dependency of the project if your project has used more than one table format, this will lead Flink can not load these table format factories correctly.", "originalCommit": "65380924b30878760771fe7d498f66b53ce7be0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzEzMzI1NA==", "url": "https://github.com/apache/flink/pull/14229#discussion_r533133254", "bodyText": "We might add one line of <!-- ... --> to show that we might add other transformers", "author": "gaoyunhaii", "createdAt": "2020-12-01T07:53:26Z", "path": "docs/dev/table/connectors/formats/index.md", "diffHunk": "@@ -90,3 +90,61 @@ Flink supports the following formats:\n         </tr>\n     </tbody>\n </table>\n+\n+\n+Shade Table Formats\n+-------------------\n+ Flink uses Java's [Service Provider Interfaces (SPI)](https://docs.oracle.com/javase/tutorial/sound/SPI-intro.html) to load the factory of table format by table format identifier, the SPI configuration file `org.apache.flink.table.factories.Factory` for every table format is under the same directory `META-INF/services`, these META-INF/services files will overlap each other when building a jar-with-dependency of the project if your project has used more than one table format, this will lead Flink can not load these table format factories correctly.\n+ In this situation, a recommended way is shading these table formats and using maven-shade-plugin [ServicesResourceTransformer](https://maven.apache.org/plugins/maven-shade-plugin/examples/resource-transformers.html) to merge these META-INF/services files properly.\n+ \n+Given the pom.xml file content of example that contains `flink-avro` and `flink-parquet` table formats in a project.\n+ \n+{% highlight xml %}\n+ \n+    <modelVersion>4.0.0</modelVersion>\n+    <groupId>org.example</groupId>\n+    <artifactId>myProject</artifactId>\n+    <version>1.0-SNAPSHOT</version>\n+\n+    <dependencies>\n+        <!--  other project dependencies  ...-->\n+        <dependency>\n+            <groupId>org.apache.flink</groupId>\n+            <artifactId>flink-orc_2.11</artifactId>\n+            <version>${flink-version}</version>\n+        </dependency>\n+\n+        <dependency>\n+            <groupId>org.apache.flink</groupId>\n+            <artifactId>flink-parquet_2.11</artifactId>\n+            <version>${flink-version}</version>\n+        </dependency>\n+\n+    </dependencies>\n+\n+    <build>\n+        <plugins>\n+            <plugin>\n+                <groupId>org.apache.maven.plugins</groupId>\n+                <artifactId>maven-shade-plugin</artifactId>\n+                <executions>\n+                    <execution>\n+                        <id>shade</id>\n+                        <phase>package</phase>\n+                        <goals>\n+                            <goal>shade</goal>\n+                        </goals>\n+                        <configuration>\n+                            <transformers combine.children=\"append\">\n+                                <!-- The service transformer is needed to merge META-INF/services files -->\n+                                <transformer implementation=\"org.apache.maven.plugins.shade.resource.ServicesResourceTransformer\"/>", "originalCommit": "65380924b30878760771fe7d498f66b53ce7be0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1fb988b0bded589b2092ec6664d995c5016e9ba6", "url": "https://github.com/apache/flink/commit/1fb988b0bded589b2092ec6664d995c5016e9ba6", "message": "address comments", "committedDate": "2020-12-01T14:52:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDYyMjA2OQ==", "url": "https://github.com/apache/flink/pull/14229#discussion_r534622069", "bodyText": "Can we move these document to connector/index?\nI think this is common mechanism for all connectors and formats.", "author": "JingsongLi", "createdAt": "2020-12-03T02:33:44Z", "path": "docs/dev/table/connectors/formats/index.md", "diffHunk": "@@ -90,3 +90,62 @@ Flink supports the following formats:\n         </tr>\n     </tbody>\n </table>\n+\n+\n+Transform Table Format Resources\n+--------------------------------\n+\n+Flink uses Java's [Service Provider Interfaces (SPI)](https://docs.oracle.com/javase/tutorial/sound/SPI-intro.html) to load the table format factories by their identifiers. Since the SPI resource file named `org.apache.flink.table.factories.Factory` for every table format is under the same directory `META-INF/services`, these resource files will override each other when build the uber-jar of the project which uses more than one table format, which will cause Flink to fail to load table format factories. In this situation, a recommended way is transforming these resource files under the directory `META-INF/services` by [ServicesResourceTransformer](https://maven.apache.org/plugins/maven-shade-plugin/examples/resource-transformers.html) of maven shade plugin.", "originalCommit": "1fb988b0bded589b2092ec6664d995c5016e9ba6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b6cb320ef6f35f097a3ddf721d68929802a46a0f", "url": "https://github.com/apache/flink/commit/b6cb320ef6f35f097a3ddf721d68929802a46a0f", "message": "[FLINK-20292][doc] Improve the document about transforming connector/format SPI resource files", "committedDate": "2020-12-03T04:16:17Z", "type": "commit"}, {"oid": "b6cb320ef6f35f097a3ddf721d68929802a46a0f", "url": "https://github.com/apache/flink/commit/b6cb320ef6f35f097a3ddf721d68929802a46a0f", "message": "[FLINK-20292][doc] Improve the document about transforming connector/format SPI resource files", "committedDate": "2020-12-03T04:16:17Z", "type": "forcePushed"}]}