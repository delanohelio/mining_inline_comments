{"pr_number": 11483, "pr_title": "[FLINK-15438][metrics][datadog] Report counter deltas and not totals", "pr_createdAt": "2020-03-22T18:16:36Z", "pr_url": "https://github.com/apache/flink/pull/11483", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc3NDIxNA==", "url": "https://github.com/apache/flink/pull/11483#discussion_r397774214", "bodyText": "I think we can simplify this mechanism a bit; my suggestion would be:\npublic class DCounter extends DMetric {\n\t...\n\tprivate long lastReportCount = 0;\n\tprivate long currentReportCount = 0;\n\t...\n\tpublic Number getMetricValue() {\n\t\tlong currentCount = counter.getCount();\n\t\tlong difference = currentCount - lastReportCount;\n\t\tcurrentReportCount = currentCount;\n\t\treturn difference;\n\t}\n\n\tpublic void ackReport() {\n\t\tlastReportCount = currentReportCount;\n\t}\n}\n\npublic class DatadogHttpReporter ... {\n\t...\n\tpublic void report() {\n\t\t...\n\t\tcounters.values().forEach(request::addCounter);\n\t\t...\n\t\ttry {\n\t\t\tclient.send(request);\n\t\t\tcounters.values().forEach(request::ackReport);\n\t\t} ...\n\t}\n}\n\nThis way we don't assemble another map, we have less of a back-and-forth between the reporter/metric and the error handling remains as is.", "author": "zentol", "createdAt": "2020-03-25T11:10:52Z", "path": "flink-metrics/flink-metrics-datadog/src/main/java/org/apache/flink/metrics/datadog/DCounter.java", "diffHunk": "@@ -28,17 +28,34 @@\n public class DCounter extends DMetric {\n \tprivate final Counter counter;\n \n+\tprivate long lastReportedValue = 0;", "originalCommit": "734a0bc7631586f212a22d9a71e60518d49d2274", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1ac54f0d5858be27c66f55fb56b96664f4252256", "url": "https://github.com/apache/flink/commit/1ac54f0d5858be27c66f55fb56b96664f4252256", "message": "[FLINK-15438][metrics][datadog] Report counter deltas and not totals\n\nThe Flink semantics of a counter are not matching with the counters\nin DataDog. In Flink a counter counts the total of increment and\ndecrement calls. In DataDog a counter is the number of increment\nand decrement calls during the reporting interval.", "committedDate": "2020-03-25T23:22:50Z", "type": "commit"}, {"oid": "1ac54f0d5858be27c66f55fb56b96664f4252256", "url": "https://github.com/apache/flink/commit/1ac54f0d5858be27c66f55fb56b96664f4252256", "message": "[FLINK-15438][metrics][datadog] Report counter deltas and not totals\n\nThe Flink semantics of a counter are not matching with the counters\nin DataDog. In Flink a counter counts the total of increment and\ndecrement calls. In DataDog a counter is the number of increment\nand decrement calls during the reporting interval.", "committedDate": "2020-03-25T23:22:50Z", "type": "forcePushed"}]}