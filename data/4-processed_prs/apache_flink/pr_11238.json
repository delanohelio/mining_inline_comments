{"pr_number": 11238, "pr_title": "[FLINK-16304][python] Remove python packages bundled in the flink-python jar.", "pr_createdAt": "2020-02-27T11:10:12Z", "pr_url": "https://github.com/apache/flink/pull/11238", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU2NTcwMA==", "url": "https://github.com/apache/flink/pull/11238#discussion_r385565700", "bodyText": "There are a few imports which could also be removed in this file.", "author": "dianfu", "createdAt": "2020-02-28T08:33:30Z", "path": "flink-python/pyflink/shell.py", "diffHunk": "@@ -31,23 +31,6 @@\n from pyflink.table.descriptors import *\n from pyflink.table.window import *\n ", "originalCommit": "42b69f81b3274b2f74891c6dc5f931b3dad2e6f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU2ODY5NQ==", "url": "https://github.com/apache/flink/pull/11238#discussion_r385568695", "bodyText": "Why remove this license file?", "author": "dianfu", "createdAt": "2020-02-28T08:40:57Z", "path": "flink-python/src/main/resources/META-INF/licenses/LICENSE.cloudpickle", "diffHunk": "@@ -1,32 +0,0 @@\n-This module was extracted from the `cloud` package, developed by", "originalCommit": "42b69f81b3274b2f74891c6dc5f931b3dad2e6f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY5MjgyNA==", "url": "https://github.com/apache/flink/pull/11238#discussion_r385692824", "bodyText": "We do not bundle cloudpickle in jar anymore, so the license file in jar should be removed", "author": "WeiZhong94", "createdAt": "2020-02-28T13:24:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU2ODY5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc2Mzk3OA==", "url": "https://github.com/apache/flink/pull/11238#discussion_r385763978", "bodyText": "if it is no longer bundled please also remove the entry in the the root NOTICE and licenses directory.", "author": "zentol", "createdAt": "2020-02-28T15:36:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU2ODY5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQyMjY3MA==", "url": "https://github.com/apache/flink/pull/11238#discussion_r387422670", "bodyText": "Thanks for your reminder Chesnay. But the cloudpickle still exists in the build-target of flink-dist, i.e. flink/build-target/opt/python/cloudpickle-1.2.2-src.zip. So I think there is no need to change the root NOTICE and licenses directory.", "author": "WeiZhong94", "createdAt": "2020-03-04T02:51:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU2ODY5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI5MTQyOQ==", "url": "https://github.com/apache/flink/pull/11238#discussion_r388291429", "bodyText": "@zentol As the cloudpickle-1.2.2-src.zip is still bundled to the binary release, its license file need to copy to the binary release. But collect_license_files.sh only collects the license files in jar, which means we need to add some code to ensure that the LICENSE.cloudpickle can be collected by the script. There are 2 solutions in my mind:\n\nbundle the license file to flink-python.jar\nlet the collect_license_files.sh also collect the license files in the root license directory.\n\nWhat do you think about those solutions?", "author": "WeiZhong94", "createdAt": "2020-03-05T13:27:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU2ODY5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU2ODc0OQ==", "url": "https://github.com/apache/flink/pull/11238#discussion_r385568749", "bodyText": "Why remove this license file?", "author": "dianfu", "createdAt": "2020-02-28T08:41:06Z", "path": "flink-python/src/main/resources/META-INF/licenses/LICENSE.py4j", "diffHunk": "@@ -1,26 +0,0 @@\n-Copyright (c) 2009-2018, Barthelemy Dagenais and individual contributors. All\n-rights reserved.", "originalCommit": "42b69f81b3274b2f74891c6dc5f931b3dad2e6f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU3MzQzMg==", "url": "https://github.com/apache/flink/pull/11238#discussion_r385573432", "bodyText": "Should we move pyflink-udf-runner.sh to src/main/resources of the jar of flink-python then I think there is no necessary to extract it from the jar file any more?", "author": "dianfu", "createdAt": "2020-02-28T08:52:14Z", "path": "flink-python/src/main/java/org/apache/flink/python/util/ResourceUtil.java", "diffHunk": "@@ -22,71 +22,45 @@\n import java.io.IOException;\n import java.nio.file.Files;\n import java.nio.file.Paths;\n-import java.util.ArrayList;\n-import java.util.List;\n \n /**\n  * Utils for building the most basic environment for running python udf workers. The basic environment does not include\n  * python part of Apache Beam. Users need to prepare it themselves.\n  */\n public class ResourceUtil {\n \n-\tpublic static final String[] BUILT_IN_PYTHON_DEPENDENCIES = {\n-\t\t\"pyflink.zip\",\n-\t\t\"py4j-0.10.8.1-src.zip\",\n-\t\t\"cloudpickle-1.2.2-src.zip\",\n-\t\t\"pyflink-udf-runner.sh\"\n-\t};\n+\tpublic static final String PYFLINK_UDF_RUNNER = \"pyflink-udf-runner.sh\";", "originalCommit": "42b69f81b3274b2f74891c6dc5f931b3dad2e6f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a715f80958d35e1507f075982e63e5844d94d893", "url": "https://github.com/apache/flink/commit/a715f80958d35e1507f075982e63e5844d94d893", "message": "fix tests and remove unnecessary code", "committedDate": "2020-02-28T13:56:43Z", "type": "forcePushed"}, {"oid": "adf9599ad65c36a99e8c0fa9130fc30baf00ebb6", "url": "https://github.com/apache/flink/commit/adf9599ad65c36a99e8c0fa9130fc30baf00ebb6", "message": "[FLINK-16304][python] Remove python packages bundled in the flink-python jar.", "committedDate": "2020-03-03T09:58:00Z", "type": "forcePushed"}, {"oid": "adf9599ad65c36a99e8c0fa9130fc30baf00ebb6", "url": "https://github.com/apache/flink/commit/adf9599ad65c36a99e8c0fa9130fc30baf00ebb6", "message": "[FLINK-16304][python] Remove python packages bundled in the flink-python jar.", "committedDate": "2020-03-03T09:58:00Z", "type": "commit"}, {"oid": "4b84fb01719d2f614e7484d2d29de7bfc685329c", "url": "https://github.com/apache/flink/commit/4b84fb01719d2f614e7484d2d29de7bfc685329c", "message": "Let the collect_license_files.sh also collect license files that are not bundled in any jar.", "committedDate": "2020-03-10T11:31:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg1NTc2NA==", "url": "https://github.com/apache/flink/pull/11238#discussion_r390855764", "bodyText": "It seems that it isn't necessary to exclude .txt?", "author": "dianfu", "createdAt": "2020-03-11T09:54:45Z", "path": "tools/releasing/collect_license_files.sh", "diffHunk": "@@ -57,4 +57,19 @@ LICENSES=\"${DST}/licenses\"\n [ -f \"${LICENSES}\" ] && rm -r \"${LICENSES}\"\n find \"${TMP}\" -name \"licenses\" -type d -exec cp -r -- \"{}\" \"${DST}\" \\;\n \n+# Search the source directory and collect those license files that\n+# not bundled in any jars but exist in binary distribution.\n+# The root license directory, hidden directories, docs, node.js should be excluded.\n+# The file name should be \"LICENSE.PROJECT_NAME\", so the license files with incorrect\n+# file names will be excluded.\n+find \"${SRC}\" -name \"LICENSE.*\" -type f \\\n+! -path \"*/.*/*\" \\\n+! -path \"*/target/*\" \\\n+! -path \"*/licenses/*\" \\\n+! -path \"*/docs/*\" \\\n+! -path \"*/flink-runtime-web/web-dashboard/node*/*\" \\\n+! -path \"*.txt\" \\", "originalCommit": "4b84fb01719d2f614e7484d2d29de7bfc685329c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkyMDY3Mg==", "url": "https://github.com/apache/flink/pull/11238#discussion_r390920672", "bodyText": "This is because there are many LICENSE.txt file in our source directory which need to be excluded. As the latest commit change to search the binary distribution, this line is not necessary anymore.", "author": "WeiZhong94", "createdAt": "2020-03-11T11:56:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg1NTc2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg4Nzg1Mg==", "url": "https://github.com/apache/flink/pull/11238#discussion_r390887852", "bodyText": "The license are in the binary distribution under opt/python, why are we searching the source instead of just the distribution?", "author": "zentol", "createdAt": "2020-03-11T10:51:22Z", "path": "tools/releasing/collect_license_files.sh", "diffHunk": "@@ -57,4 +57,19 @@ LICENSES=\"${DST}/licenses\"\n [ -f \"${LICENSES}\" ] && rm -r \"${LICENSES}\"\n find \"${TMP}\" -name \"licenses\" -type d -exec cp -r -- \"{}\" \"${DST}\" \\;\n \n+# Search the source directory and collect those license files that", "originalCommit": "4b84fb01719d2f614e7484d2d29de7bfc685329c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ee983bedfb58e59b0fa7452667c2b1e5c3910ef1", "url": "https://github.com/apache/flink/commit/ee983bedfb58e59b0fa7452667c2b1e5c3910ef1", "message": "change to search the binary distribution directory.", "committedDate": "2020-03-11T11:50:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk2MzY2MA==", "url": "https://github.com/apache/flink/pull/11238#discussion_r390963660", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            find \"${SRC}/flink-dist/target\" -name \"LICENSE.*\" -type f \\\n          \n          \n            \n            find \"${SRC}\" -name \"LICENSE.*\" -type f \\\n          \n      \n    \n    \n  \n\nSRC already points to the desired directory, see create_binary_release.sh#78", "author": "zentol", "createdAt": "2020-03-11T13:20:27Z", "path": "tools/releasing/collect_license_files.sh", "diffHunk": "@@ -57,4 +57,9 @@ LICENSES=\"${DST}/licenses\"\n [ -f \"${LICENSES}\" ] && rm -r \"${LICENSES}\"\n find \"${TMP}\" -name \"licenses\" -type d -exec cp -r -- \"{}\" \"${DST}\" \\;\n \n+# Search the binary distribution directory and collect those license files that\n+# not bundled in any jars.\n+find \"${SRC}/flink-dist/target\" -name \"LICENSE.*\" -type f \\", "originalCommit": "ee983bedfb58e59b0fa7452667c2b1e5c3910ef1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk2NzIyMQ==", "url": "https://github.com/apache/flink/pull/11238#discussion_r390967221", "bodyText": "-path \"*/flink-*-bin/*\" should not be necessary with the above suggestion.\n\n\nIt may be worthwhile to explicitly exclude ${TMP}/licenses and ${DST}/licenses; this script should continue to work even if the python licenses are moved into to opt/python/licenses.\n\n\nmaybe do a move instead so we have a single point for licenses.", "author": "zentol", "createdAt": "2020-03-11T13:25:56Z", "path": "tools/releasing/collect_license_files.sh", "diffHunk": "@@ -57,4 +57,9 @@ LICENSES=\"${DST}/licenses\"\n [ -f \"${LICENSES}\" ] && rm -r \"${LICENSES}\"\n find \"${TMP}\" -name \"licenses\" -type d -exec cp -r -- \"{}\" \"${DST}\" \\;\n \n+# Search the binary distribution directory and collect those license files that\n+# not bundled in any jars.\n+find \"${SRC}/flink-dist/target\" -name \"LICENSE.*\" -type f \\\n+-path \"*/flink-*-bin/*\" ! -path \"*/licenses/*\" -exec cp -- \"{}\" \"${DST}/licenses\" \\;", "originalCommit": "ee983bedfb58e59b0fa7452667c2b1e5c3910ef1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk4ODM5Mg==", "url": "https://github.com/apache/flink/pull/11238#discussion_r390988392", "bodyText": "+1 for the 1st and 2nd comments. For 3rd comments I'm not sure it is a good idea, because \"move\" is not a idempotent and safe operation. If someone run this script multiple times the results may not be what they expected. If someone run this script in other directories, there may be unexpected consequences, such as the strange disappearance of many files.", "author": "WeiZhong94", "createdAt": "2020-03-11T13:57:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk2NzIyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk2ODgxNw==", "url": "https://github.com/apache/flink/pull/11238#discussion_r390968817", "bodyText": "this entry needs to be moved to tools/releasing/NOTICE-binary_PREAMBLE.txt, otherwise this will not show up in any NOTICE.", "author": "zentol", "createdAt": "2020-03-11T13:28:27Z", "path": "flink-python/src/main/resources/META-INF/NOTICE", "diffHunk": "@@ -59,7 +59,6 @@ See bundled license files for details\n - com.google.protobuf:protobuf-java:3.7.1\n - com.google.protobuf:protobuf-java-util:3.7.1\n - com.google.auth:google-auth-library-credentials:0.13.0\n-- cloudpickle:1.2.2", "originalCommit": "ee983bedfb58e59b0fa7452667c2b1e5c3910ef1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk2OTU3MQ==", "url": "https://github.com/apache/flink/pull/11238#discussion_r390969571", "bodyText": "I assume the py4j entry is retained since we still bundle the java part?", "author": "zentol", "createdAt": "2020-03-11T13:29:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk2ODgxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk4OTExMQ==", "url": "https://github.com/apache/flink/pull/11238#discussion_r390989111", "bodyText": "Yes. The flink-python jar bundles the java part of py4j.", "author": "WeiZhong94", "createdAt": "2020-03-11T13:58:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk2ODgxNw=="}], "type": "inlineReview"}, {"oid": "1e1f9de29552097bc7a7973c6532f678dfc1dabe", "url": "https://github.com/apache/flink/commit/1e1f9de29552097bc7a7973c6532f678dfc1dabe", "message": "Change the target directory of the find command to $SRC. Exclude $DST/licenses and $TMP/licenses.", "committedDate": "2020-03-11T13:47:33Z", "type": "commit"}, {"oid": "3ede7b0ecef98c97bd511c9929928ceb1668582b", "url": "https://github.com/apache/flink/commit/3ede7b0ecef98c97bd511c9929928ceb1668582b", "message": "add cloudpickle to the NOTICE-binary-PREAMBLE.txt.", "committedDate": "2020-03-11T14:00:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIxNDc1NQ==", "url": "https://github.com/apache/flink/pull/11238#discussion_r391214755", "bodyText": "this is BSD licensed based on the python NOTICE", "author": "zentol", "createdAt": "2020-03-11T19:37:01Z", "path": "tools/releasing/NOTICE-binary_PREAMBLE.txt", "diffHunk": "@@ -12,3 +12,4 @@ This project bundles the following dependencies under the Apache Software Licens\n - org.apache.logging.log4j:log4j-core:2.12.1\n - org.apache.logging.log4j:log4j-slf4j-impl:2.12.1\n - org.apache.logging.log4j:log4j-1.2-api:2.12.1\n+- cloudpickle:1.2.2", "originalCommit": "3ede7b0ecef98c97bd511c9929928ceb1668582b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4d180da9a55cbbf11f1c1b6b6dc3a0cbe6a101f4", "url": "https://github.com/apache/flink/commit/4d180da9a55cbbf11f1c1b6b6dc3a0cbe6a101f4", "message": "Add BSD license description to NOTICE-binary_PREAMBLE.txt.", "committedDate": "2020-03-12T01:37:27Z", "type": "commit"}]}