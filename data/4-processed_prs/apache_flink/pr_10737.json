{"pr_number": 10737, "pr_title": "[FLINK-15430][table-planner-blink] Fix Java 64K method compiling limi\u2026", "pr_createdAt": "2020-01-01T15:55:48Z", "pr_url": "https://github.com/apache/flink/pull/10737", "timeline": [{"oid": "fdd885648d4585ef6a77fc71584aef144c99af64", "url": "https://github.com/apache/flink/commit/fdd885648d4585ef6a77fc71584aef144c99af64", "message": "[FLINK-15430][table-planner-blink] Fix Java 64K method compiling limitation for blink planner", "committedDate": "2020-01-01T15:32:18Z", "type": "commit"}, {"oid": "263bb0c191d7090cc1971a4973fc9153bfffc024", "url": "https://github.com/apache/flink/commit/263bb0c191d7090cc1971a4973fc9153bfffc024", "message": "Change MatchCodeGenerator to declare reusable local variables", "committedDate": "2020-01-02T02:38:56Z", "type": "commit"}, {"oid": "5852f35c8a38722f738b30d5478464439bbe9ae1", "url": "https://github.com/apache/flink/commit/5852f35c8a38722f738b30d5478464439bbe9ae1", "message": "Revert \"Change MatchCodeGenerator to declare reusable local variables\"\n\nThis reverts commit 263bb0c191d7090cc1971a4973fc9153bfffc024.", "committedDate": "2020-01-05T06:49:04Z", "type": "commit"}, {"oid": "fe8321877a13fcaf202f24643e3ff0933cfb63c9", "url": "https://github.com/apache/flink/commit/fe8321877a13fcaf202f24643e3ff0933cfb63c9", "message": "Add allowSplit param, to narrow down code split scope", "committedDate": "2020-01-05T07:16:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE0OTMyNA==", "url": "https://github.com/apache/flink/pull/10737#discussion_r363149324", "bodyText": "throws", "author": "JingsongLi", "createdAt": "2020-01-06T03:43:21Z", "path": "flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/codegen/ExprCodeGenerator.scala", "diffHunk": "@@ -285,11 +287,30 @@ class ExprCodeGenerator(ctx: CodeGeneratorContext, nullableInput: Boolean)\n       case _ => // ok\n     }\n \n-    val setFieldsCode = fieldExprs.zipWithIndex.map { case (fieldExpr, index) =>\n+    val setFieldsCodes = fieldExprs.zipWithIndex.map { case (fieldExpr, index) =>\n       val pos = fieldExprIdxToOutputRowPosMap.getOrElse(index,\n         throw new CodeGenException(s\"Illegal field expr index: $index\"))\n       baseRowSetField(ctx, returnTypeClazz, outRow, pos.toString, fieldExpr, outRowWriter)\n-    }.mkString(\"\\n\")\n+    }\n+    val totalLen = setFieldsCodes.map(_.length).sum\n+    val maxCodeLength = ctx.tableConfig.getMaxGeneratedCodeLength\n+    val setFieldsCode = if (allowSplit && totalLen > maxCodeLength) {\n+      // do the split.\n+      ctx.setSplit()\n+      setFieldsCodes.map(project => {\n+        val methodName = newName(\"split\")\n+        val method =\n+          s\"\"\"\n+            |private void $methodName() throw Exception {", "originalCommit": "fe8321877a13fcaf202f24643e3ff0933cfb63c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE1MTY5OA==", "url": "https://github.com/apache/flink/pull/10737#discussion_r363151698", "bodyText": "Thanks for the review, fixed.", "author": "libenchao", "createdAt": "2020-01-06T04:02:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE0OTMyNA=="}], "type": "inlineReview"}, {"oid": "c5bceadd1288ab341212b44480c90d10329f5c74", "url": "https://github.com/apache/flink/commit/c5bceadd1288ab341212b44480c90d10329f5c74", "message": "Fix typo throw to throws", "committedDate": "2020-01-06T04:01:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE4MDMyNg==", "url": "https://github.com/apache/flink/pull/10737#discussion_r363180326", "bodyText": "Rename the variable to isCodeSplit to make it clear that the code is splitted?\nThe comment can also be improved Flag that indicates whether the generated code is split into several methods.", "author": "wuchong", "createdAt": "2020-01-06T07:12:47Z", "path": "flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/codegen/CodeGeneratorContext.scala", "diffHunk": "@@ -108,6 +108,11 @@ class CodeGeneratorContext(val tableConfig: TableConfig) {\n     */\n   private var currentMethodNameForLocalVariables = \"DEFAULT\"\n \n+  /**\n+   * Flag indicating whether split has occurred.\n+   */\n+  private var isSplit = false", "originalCommit": "c5bceadd1288ab341212b44480c90d10329f5c74", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE4MTc3Ng==", "url": "https://github.com/apache/flink/pull/10737#discussion_r363181776", "bodyText": "enableCodeSplit() or setCodeSplit()?  Please also add Javadoc above this method.", "author": "wuchong", "createdAt": "2020-01-06T07:20:42Z", "path": "flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/codegen/CodeGeneratorContext.scala", "diffHunk": "@@ -143,6 +148,9 @@ class CodeGeneratorContext(val tableConfig: TableConfig) {\n     reusableLocalVariableStatements(methodName) = mutable.LinkedHashSet[String]()\n   }\n \n+  def setSplit(): Unit = {", "originalCommit": "c5bceadd1288ab341212b44480c90d10329f5c74", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "780431a2687cd36cc23e9c4815e041c279b8fb97", "url": "https://github.com/apache/flink/commit/780431a2687cd36cc23e9c4815e041c279b8fb97", "message": "Refine naming and comment", "committedDate": "2020-01-06T07:42:20Z", "type": "commit"}]}