{"pr_number": 11123, "pr_title": "[FLINK-16014][s3] Force usage of SAXParserFactory over XMLReaderFactory in aws-java-sdk-s3.", "pr_createdAt": "2020-02-18T13:18:34Z", "pr_url": "https://github.com/apache/flink/pull/11123", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY5MTU3Mw==", "url": "https://github.com/apache/flink/pull/11123#discussion_r380691573", "bodyText": "add a note that this can be removed once Java8 support is dropped?", "author": "zentol", "createdAt": "2020-02-18T14:06:22Z", "path": "flink-filesystems/flink-s3-fs-base/pom.xml", "diffHunk": "@@ -204,6 +204,11 @@ under the License.\n \t\t\t<artifactId>aws-java-sdk-dynamodb</artifactId>\n \t\t\t<version>${fs.s3.aws.version}</version>\n \t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>xerces</groupId>\n+\t\t\t<artifactId>xercesImpl</artifactId>", "originalCommit": "83b98e39b163308ede9d79d2f905d6c12f23203b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY5MTYwOQ==", "url": "https://github.com/apache/flink/pull/11123#discussion_r380691609", "bodyText": "add a note that this can be removed once Java8 support is dropped?", "author": "zentol", "createdAt": "2020-02-18T14:06:25Z", "path": "flink-filesystems/flink-s3-fs-base/src/main/java/org/xml/sax/helpers/XMLReaderFactory.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.xml.sax.helpers;\n+\n+import org.apache.xerces.jaxp.SAXParserFactoryImpl;\n+import org.xml.sax.SAXException;\n+import org.xml.sax.XMLReader;\n+\n+import javax.xml.parsers.ParserConfigurationException;\n+import javax.xml.parsers.SAXParserFactory;\n+\n+/**\n+ * Workaround for JDK-8015099, this factory always provides a bundled xerces parser for plugins.\n+ *\n+ * <p>Will provide a proper isolation for all kinds of different setups (other sax parser in lib or bundled in user\n+ * code).\n+ */\n+public class XMLReaderFactory {", "originalCommit": "83b98e39b163308ede9d79d2f905d6c12f23203b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d9e9614f86446ec1de22bdb4bc641e78f8725d39", "url": "https://github.com/apache/flink/commit/d9e9614f86446ec1de22bdb4bc641e78f8725d39", "message": "[FLINK-16014] Adding xerces to s3 plugins to avoid ClassNotFound issues.\n\nRoot cause is a bug in JDK8. `XMLReaderFactory` caches the class name independent of the classloader. On EMR, xercesImpl is on classpath (because of HDFS) and will be loaded at some point in time.\nAlso overwriting the faulty `XMLReaderFactory` in the plugins with a non-caching implementation that only loads the bundled xerces.", "committedDate": "2020-02-19T13:30:21Z", "type": "forcePushed"}, {"oid": "385ebf4f1ad02ea7a62b2f6fadd54cd1fa6121e2", "url": "https://github.com/apache/flink/commit/385ebf4f1ad02ea7a62b2f6fadd54cd1fa6121e2", "message": "[FLINK-16014] Adding xerces to s3 plugins to avoid ClassNotFound issues.\n\nRoot cause is a bug in JDK8. `XMLReaderFactory` caches the class name independent of the classloader. On EMR, xercesImpl is on classpath (because of HDFS) and will be loaded at some point in time.\nAlso overwriting the faulty `XMLReaderFactory` in the plugins with a non-caching implementation that only loads the bundled xerces.", "committedDate": "2020-02-19T13:31:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg0MzA0Mg==", "url": "https://github.com/apache/flink/pull/11123#discussion_r381843042", "bodyText": "are we not also bundling xml-apis:xml-apis, a transitive dependency of xercesImpl?", "author": "zentol", "createdAt": "2020-02-20T08:20:26Z", "path": "flink-filesystems/flink-s3-fs-hadoop/src/main/resources/META-INF/NOTICE", "diffHunk": "@@ -31,6 +31,7 @@ This project bundles the following dependencies under the Apache Software Licens\n - org.apache.httpcomponents:httpcore:4.4.6\n - org.apache.httpcomponents:httpclient:4.5.3\n - software.amazon.ion:ion-java:1.0.2\n+- xerces:xercesImpl:2.12.0", "originalCommit": "385ebf4f1ad02ea7a62b2f6fadd54cd1fa6121e2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "128a485e9c65cb7b24f5e48400ff830af16ff620", "url": "https://github.com/apache/flink/commit/128a485e9c65cb7b24f5e48400ff830af16ff620", "message": "[FLINK-16014][s3] Force usage of SAXParserFactory over XMLReaderFactory in aws-java-sdk-s3.\n\nThis avoids a ClassNotFound exception of the underlying XML reader class in plugin classloaders.\nRoot cause is a bug in JDK8 (JDK-8015099). XMLReaderFactory caches the class name independent of the classloader. On EMR, xercesImpl is on classpath (because of HDFS) and will be loaded at some point in time.", "committedDate": "2020-02-27T13:42:10Z", "type": "forcePushed"}, {"oid": "3b18e6f5ff641afd27cfeccb5236a52f1e844498", "url": "https://github.com/apache/flink/commit/3b18e6f5ff641afd27cfeccb5236a52f1e844498", "message": "[FLINK-16014][s3] Force usage of SAXParserFactory over XMLReaderFactory in aws-java-sdk-s3.\n\nThis avoids a ClassNotFound exception of the underlying XML reader class in plugin classloaders.\nRoot cause is a bug in JDK8 (JDK-8015099). XMLReaderFactory caches the class name independent of the classloader. On EMR, xercesImpl is on classpath (because of HDFS) and will be loaded at some point in time.", "committedDate": "2020-02-28T15:09:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjM0NTEzOA==", "url": "https://github.com/apache/flink/pull/11123#discussion_r386345138", "bodyText": "add a comment for why this is done", "author": "zentol", "createdAt": "2020-03-02T11:43:33Z", "path": "flink-filesystems/flink-s3-fs-base/pom.xml", "diffHunk": "@@ -231,6 +231,30 @@ under the License.\n \t\t\t\t\t<skip>true</skip>\n \t\t\t\t</configuration>\n \t\t\t</plugin>\n+\n+\t\t\t<plugin>\n+\t\t\t\t<groupId>org.apache.maven.plugins</groupId>\n+\t\t\t\t<artifactId>maven-shade-plugin</artifactId>\n+\t\t\t\t<executions>\n+\t\t\t\t\t<execution>\n+\t\t\t\t\t\t<id>shade-flink</id>\n+\t\t\t\t\t\t<phase>package</phase>\n+\t\t\t\t\t\t<goals>\n+\t\t\t\t\t\t\t<goal>shade</goal>\n+\t\t\t\t\t\t</goals>\n+\t\t\t\t\t\t<configuration>\n+\t\t\t\t\t\t\t<filters>\n+\t\t\t\t\t\t\t\t<filter>\n+\t\t\t\t\t\t\t\t\t<artifact>com.amazonaws:aws-java-sdk-s3</artifact>\n+\t\t\t\t\t\t\t\t\t<excludes>\n+\t\t\t\t\t\t\t\t\t\t<exclude>com/amazonaws/services/s3/model/transform/XmlResponsesSaxParser**</exclude>", "originalCommit": "3b18e6f5ff641afd27cfeccb5236a52f1e844498", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "05703e66f5eeb89e476145d40538684c0926908d", "url": "https://github.com/apache/flink/commit/05703e66f5eeb89e476145d40538684c0926908d", "message": "[FLINK-16014][s3] Force usage of SAXParserFactory over XMLReaderFactory in aws-java-sdk-s3.\n\nThis avoids a ClassNotFound exception of the underlying XML reader class in plugin classloaders.\nRoot cause is a bug in JDK8 (JDK-8015099). XMLReaderFactory caches the class name independent of the classloader. On EMR, xercesImpl is on classpath (because of HDFS) and will be loaded at some point in time.", "committedDate": "2020-03-04T08:22:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU3Mjc4Mw==", "url": "https://github.com/apache/flink/pull/11123#discussion_r387572783", "bodyText": "it would be safer to move this into the presto/hadoop modules; as it stands you're excluding one dependency (and kicking out a transitive one), with downstream modules not being aware that this module is bundling anything and hence also trying to bundle aws-java-sdk-s3.\nThis is the warning you get when building downstream modules:\n[WARNING] flink-s3-fs-base-1.11-SNAPSHOT.jar, aws-java-sdk-s3-1.11.271.jar define 29 overlapping classes: \n[WARNING]   - com.amazonaws.services.s3.model.transform.XmlResponsesSaxParser$GetObjectTaggingHandler\n[WARNING]   - com.amazonaws.services.s3.model.transform.XmlResponsesSaxParser$ListPartsHandler\n[WARNING]   - com.amazonaws.services.s3.model.transform.XmlResponsesSaxParser$BucketLocationHandler\n[WARNING]   - com.amazonaws.services.s3.model.transform.XmlResponsesSaxParser$ListVersionsHandler\n[WARNING]   - com.amazonaws.services.s3.model.transform.XmlResponsesSaxParser$ListAllMyBucketsHandler\n[WARNING]   - com.amazonaws.services.s3.model.transform.XmlResponsesSaxParser$ListBucketInventoryConfigurationsHandler\n[WARNING]   - com.amazonaws.services.s3.model.transform.XmlResponsesSaxParser$ListBucketHandler\n[WARNING]   - com.amazonaws.services.s3.model.transform.XmlResponsesSaxParser$AccessControlListHandler\n[WARNING]   - com.amazonaws.services.s3.model.transform.XmlResponsesSaxParser$InitiateMultipartUploadHandler\n[WARNING]   - com.amazonaws.services.s3.model.transform.XmlResponsesSaxParser$GetBucketInventoryConfigurationHandler\n[WARNING]   - 19 more...\n\nAs it stands this will require duplicating things; it would've easier if the S3 filesystems where organized in a hierarchy such that we could use inheritance for this stuff.", "author": "zentol", "createdAt": "2020-03-04T10:22:10Z", "path": "flink-filesystems/flink-s3-fs-base/pom.xml", "diffHunk": "@@ -231,6 +231,33 @@ under the License.\n \t\t\t\t\t<skip>true</skip>\n \t\t\t\t</configuration>\n \t\t\t</plugin>\n+\n+\t\t\t<plugin>\n+\t\t\t\t<groupId>org.apache.maven.plugins</groupId>\n+\t\t\t\t<artifactId>maven-shade-plugin</artifactId>", "originalCommit": "05703e66f5eeb89e476145d40538684c0926908d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU4OTg2Mg==", "url": "https://github.com/apache/flink/pull/11123#discussion_r387589862", "bodyText": "I will try to pursuit the hierarchy approach.", "author": "AHeise", "createdAt": "2020-03-04T10:53:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU3Mjc4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg4MTE2OA==", "url": "https://github.com/apache/flink/pull/11123#discussion_r387881168", "bodyText": "Unfortunately, it's not that easy. If it's a parent project, it needs to be of type pom and cannot ship code by default.\nThere is a workaround, but it's certainly adding some complexity.\nThe cleanest solution would be to add another module just for the pom, but that's also more complex than I'd like it to be.", "author": "AHeise", "createdAt": "2020-03-04T19:21:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU3Mjc4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM2MDIxMw==", "url": "https://github.com/apache/flink/pull/11123#discussion_r388360213", "bodyText": "it doesn't have to ship code; you can define the shade plugin configuration in the parent, which is then inherited by the child modules, which then do the inclusion/exclusion.", "author": "zentol", "createdAt": "2020-03-05T15:17:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU3Mjc4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUwMzkxNA==", "url": "https://github.com/apache/flink/pull/11123#discussion_r388503914", "bodyText": "Not sure what you mean but flink-s3-fs-base has code that is lost when I change packaging to pom, which in turn is required for parent projects.", "author": "AHeise", "createdAt": "2020-03-05T19:12:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU3Mjc4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg2ODA1Mg==", "url": "https://github.com/apache/flink/pull/11123#discussion_r388868052", "bodyText": "I forgot that S3 base contains code, ignore the suggestion about parent modules.", "author": "zentol", "createdAt": "2020-03-06T12:08:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU3Mjc4Mw=="}], "type": "inlineReview"}, {"oid": "95e457e1d10f8c7b0de7e52fef42f6ac029912a6", "url": "https://github.com/apache/flink/commit/95e457e1d10f8c7b0de7e52fef42f6ac029912a6", "message": "[FLINK-16014][s3] Force usage of SAXParserFactory over XMLReaderFactory in aws-java-sdk-s3.\n\nThis avoids a ClassNotFound exception of the underlying XML reader class in plugin classloaders.\nRoot cause is a bug in JDK8 (JDK-8015099). XMLReaderFactory caches the class name independent of the classloader. On EMR, xercesImpl is on classpath (because of HDFS) and will be loaded at some point in time.", "committedDate": "2020-03-04T10:55:08Z", "type": "forcePushed"}, {"oid": "3d28892370884e69d1dfa550c69fd664d0053fdd", "url": "https://github.com/apache/flink/commit/3d28892370884e69d1dfa550c69fd664d0053fdd", "message": "[FLINK-16014][s3] Force usage of SAXParserFactory over XMLReaderFactory in aws-java-sdk-s3.\n\nThis avoids a ClassNotFound exception of the underlying XML reader class in plugin classloaders.\nRoot cause is a bug in JDK8 (JDK-8015099). XMLReaderFactory caches the class name independent of the classloader. On EMR, xercesImpl is on classpath (because of HDFS) and will be loaded at some point in time.", "committedDate": "2020-03-04T19:25:33Z", "type": "forcePushed"}, {"oid": "bd9da339fdfee9967e478154bf127976b7a333b5", "url": "https://github.com/apache/flink/commit/bd9da339fdfee9967e478154bf127976b7a333b5", "message": "[FLINK-16014][s3] Force usage of SAXParserFactory over XMLReaderFactory in aws-java-sdk-s3.\n\nThis avoids a ClassNotFound exception of the underlying XML reader class in plugin classloaders.\nRoot cause is a bug in JDK8 (JDK-8015099). XMLReaderFactory caches the class name independent of the classloader. On EMR, xercesImpl is on classpath (because of HDFS) and will be loaded at some point in time.", "committedDate": "2020-03-05T15:11:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg2ODQ1NA==", "url": "https://github.com/apache/flink/pull/11123#discussion_r388868454", "bodyText": "this should no longer be necessary since flink-s3-fs-base no longer bundles this dependency", "author": "zentol", "createdAt": "2020-03-06T12:09:57Z", "path": "flink-filesystems/flink-s3-fs-base/pom.xml", "diffHunk": "@@ -231,6 +231,33 @@ under the License.\n \t\t\t\t\t<skip>true</skip>\n \t\t\t\t</configuration>\n \t\t\t</plugin>\n+\n+\t\t\t<plugin>\n+\t\t\t\t<groupId>org.apache.maven.plugins</groupId>\n+\t\t\t\t<artifactId>maven-shade-plugin</artifactId>\n+\t\t\t\t<executions>\n+\t\t\t\t\t<execution>\n+\t\t\t\t\t\t<id>shade-flink</id>\n+\t\t\t\t\t\t<phase>package</phase>\n+\t\t\t\t\t\t<goals>\n+\t\t\t\t\t\t\t<goal>shade</goal>\n+\t\t\t\t\t\t</goals>\n+\t\t\t\t\t\t<configuration>\n+\t\t\t\t\t\t\t<filters>\n+\t\t\t\t\t\t\t\t<filter>\n+\t\t\t\t\t\t\t\t\t<artifact>com.amazonaws:aws-java-sdk-s3</artifact>", "originalCommit": "bd9da339fdfee9967e478154bf127976b7a333b5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYzMTAzOQ==", "url": "https://github.com/apache/flink/pull/11123#discussion_r389631039", "bodyText": "Good catch. Not sure why I thought it was necessary.", "author": "AHeise", "createdAt": "2020-03-09T12:33:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg2ODQ1NA=="}], "type": "inlineReview"}, {"oid": "86c767d21b0e1b49e068fb086741776aa7d56b3e", "url": "https://github.com/apache/flink/commit/86c767d21b0e1b49e068fb086741776aa7d56b3e", "message": "[FLINK-16014][s3] Force usage of SAXParserFactory over XMLReaderFactory in aws-java-sdk-s3.\n\nThis avoids a ClassNotFound exception of the underlying XML reader class in plugin classloaders.\nRoot cause is a bug in JDK8 (JDK-8015099). XMLReaderFactory caches the class name independent of the classloader. On EMR, xercesImpl is on classpath (because of HDFS) and will be loaded at some point in time.", "committedDate": "2020-03-06T16:56:47Z", "type": "commit"}, {"oid": "86c767d21b0e1b49e068fb086741776aa7d56b3e", "url": "https://github.com/apache/flink/commit/86c767d21b0e1b49e068fb086741776aa7d56b3e", "message": "[FLINK-16014][s3] Force usage of SAXParserFactory over XMLReaderFactory in aws-java-sdk-s3.\n\nThis avoids a ClassNotFound exception of the underlying XML reader class in plugin classloaders.\nRoot cause is a bug in JDK8 (JDK-8015099). XMLReaderFactory caches the class name independent of the classloader. On EMR, xercesImpl is on classpath (because of HDFS) and will be loaded at some point in time.", "committedDate": "2020-03-06T16:56:47Z", "type": "forcePushed"}]}