{"pr_number": 13260, "pr_title": "[FLINK-16768][tests] Let the watchdog also monitor mvn logs", "pr_createdAt": "2020-08-27T07:21:12Z", "pr_url": "https://github.com/apache/flink/pull/13260", "timeline": [{"oid": "858238cb47175439c563bc2c6d23ded57b1ab6f2", "url": "https://github.com/apache/flink/commit/858238cb47175439c563bc2c6d23ded57b1ab6f2", "message": "[FLINK-16768][tests] Let the watchdog also monitor mvn logs\n\nThis experimental change aims to make the watchdog more accurate by extending the monitoring from the output to log files produced by the tests.\nIn particular the S3 tests seem to produce no output while they are producing output to the log files.\n\nThe risk of this change is that a hanging test is still producing log output (e.g. the test is stuck in a retry-loop).", "committedDate": "2020-08-27T07:20:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODM2MDQ1OQ==", "url": "https://github.com/apache/flink/pull/13260#discussion_r478360459", "bodyText": "It looks alright. FYI: The following one-liner should do the same:\nmod_time() {\n  stat -c \"%Y\" \"$CMD_OUT $WATCHDOG_ADDITIONAL_MONITORING_FILES\" | sort -nr | head -1\n}", "author": "XComp", "createdAt": "2020-08-27T11:54:58Z", "path": "tools/ci/watchdog.sh", "diffHunk": "@@ -38,8 +38,26 @@ CMD_EXIT=\"/tmp/watchdog.exit\"\n # Utility functions\n # ============================================= \n \n+max_of() {\n+  local max number\n+\n+  max=\"$1\"\n+\n+  for number in \"${@:2}\"; do\n+    if ((number > max)); then\n+      max=\"$number\"\n+    fi\n+  done\n+\n+  printf '%d\\n' \"$max\"\n+}\n+\n+# Returns the highest modification time out of $CMD_OUT (which is the command output file)\n+# and any file(s) named \"mvn-*.log\" (which are logging files created by Flink's tests)\n mod_time () {\n-\techo `stat -c \"%Y\" $CMD_OUT`\n+\tCMD_OUT_MOD_TIME=`stat -c \"%Y\" $CMD_OUT`\n+\tADDITIONAL_FILES_MOD_TIMES=`stat -c \"%Y\" $WATCHDOG_ADDITIONAL_MONITORING_FILES 2> /dev/null`\n+\techo `max_of $CMD_OUT_MOD_TIME $ADDITIONAL_FILES_MOD_TIMES`", "originalCommit": "858238cb47175439c563bc2c6d23ded57b1ab6f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTEzNzAyMg==", "url": "https://github.com/apache/flink/pull/13260#discussion_r481137022", "bodyText": "damn, sometimes, I'm overthinking it. Thanks for the pointer.", "author": "rmetzger", "createdAt": "2020-09-01T13:28:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODM2MDQ1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODM2NTIxMQ==", "url": "https://github.com/apache/flink/pull/13260#discussion_r478365211", "bodyText": "Wouldn't it be better to pass this variable as a parameter to source \"${HERE}/watchdog.sh\"? Of course, we would have to handle the variable in watchdog.sh properly, then, since it has to be accessed through $1. The variable $WATCHDOG_ADDITIONAL_MONITORING_FILES is nowhere else used.", "author": "XComp", "createdAt": "2020-08-27T12:02:57Z", "path": "tools/ci/test_controller.sh", "diffHunk": "@@ -69,6 +69,10 @@ export JAVA_TOOL_OPTIONS=\"-XX:+HeapDumpOnOutOfMemoryError\"\n # some tests provide additional logs if they find this variable\n export IS_CI=true\n \n+export WATCHDOG_ADDITIONAL_MONITORING_FILES=\"$DEBUG_FILES_OUTPUT_DIR/mvn-*.log\"", "originalCommit": "858238cb47175439c563bc2c6d23ded57b1ab6f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0MzM4MQ==", "url": "https://github.com/apache/flink/pull/13260#discussion_r481143381", "bodyText": "Somehow I consider \"source\" something like an \"import\" statement, that doesn't support passing variables.\nAnd this seems to be a feature only available in bash: https://unix.stackexchange.com/questions/5024/passing-variables-to-a-bash-script-when-sourcing-it", "author": "rmetzger", "createdAt": "2020-09-01T13:37:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODM2NTIxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODM3NTQzNQ==", "url": "https://github.com/apache/flink/pull/13260#discussion_r478375435", "bodyText": "I forgot to ask here: Is there a reason why you didn't just use echo \"$max\" instead?", "author": "XComp", "createdAt": "2020-08-27T12:19:46Z", "path": "tools/ci/watchdog.sh", "diffHunk": "@@ -38,8 +38,26 @@ CMD_EXIT=\"/tmp/watchdog.exit\"\n # Utility functions\n # ============================================= \n \n+max_of() {\n+  local max number\n+\n+  max=\"$1\"\n+\n+  for number in \"${@:2}\"; do\n+    if ((number > max)); then\n+      max=\"$number\"\n+    fi\n+  done\n+\n+  printf '%d\\n' \"$max\"", "originalCommit": "858238cb47175439c563bc2c6d23ded57b1ab6f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0MDU4NQ==", "url": "https://github.com/apache/flink/pull/13260#discussion_r481140585", "bodyText": "Well, my code is (of course) inspired by Stackoverflow.\nBut there seems to be some arguments why printf is better than echo: https://unix.stackexchange.com/questions/65803/why-is-printf-better-than-echo", "author": "rmetzger", "createdAt": "2020-09-01T13:33:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODM3NTQzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0NDEyNg==", "url": "https://github.com/apache/flink/pull/13260#discussion_r481144126", "bodyText": ":-D I like how the accepted answer feels to be 10 pages long for something I considered a minor thing ^^", "author": "XComp", "createdAt": "2020-09-01T13:38:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODM3NTQzNQ=="}], "type": "inlineReview"}]}