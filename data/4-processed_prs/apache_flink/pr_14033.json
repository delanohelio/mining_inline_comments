{"pr_number": 14033, "pr_title": "[FLINK-19979][e2e] Add sanity check after bash e2e tests for no leftovers", "pr_createdAt": "2020-11-11T11:43:44Z", "pr_url": "https://github.com/apache/flink/pull/14033", "timeline": [{"oid": "9e5179d99ac3f1ee67388f6236a5ffd087941a94", "url": "https://github.com/apache/flink/commit/9e5179d99ac3f1ee67388f6236a5ffd087941a94", "message": "[FLINK-19979][e2e] Add sanity check after bash e2e tests for no leftover processes\n\nThis commit also contains a number of robustness improvements.", "committedDate": "2020-11-13T07:52:07Z", "type": "commit"}, {"oid": "9e5179d99ac3f1ee67388f6236a5ffd087941a94", "url": "https://github.com/apache/flink/commit/9e5179d99ac3f1ee67388f6236a5ffd087941a94", "message": "[FLINK-19979][e2e] Add sanity check after bash e2e tests for no leftover processes\n\nThis commit also contains a number of robustness improvements.", "committedDate": "2020-11-13T07:52:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzEyMjYzMA==", "url": "https://github.com/apache/flink/pull/14033#discussion_r523122630", "bodyText": "Shouldn't we move that out into its own common utility function considering that we used almost the exact same code in PR #14062 (FLINK-17470)?", "author": "XComp", "createdAt": "2020-11-13T17:48:15Z", "path": "flink-end-to-end-tests/test-scripts/common.sh", "diffHunk": "@@ -587,9 +588,25 @@ function tm_kill_all {\n \n # Kills all processes that match the given name.\n function kill_all {\n-  local pid=`jps | grep -E \"${1}\" | cut -d \" \" -f 1 || true`\n-  kill ${pid} 2> /dev/null || true\n-  wait ${pid} 2> /dev/null || true\n+  # using ps instead of jps to identify jvms in shutdown as well, so that we can wait for the shutdown to finish (jps doesn't show killed JVMs while shutting down)\n+  # use awk to strip leading and trailing whitespaces\n+  # use cut to get the pid\n+  for pid in $(ps ax | grep \"java\" | grep -E \"${1}\" | awk '{$1=$1;print}' | cut -d \" \" -f 1)\n+  do\n+      echo \"Waiting till process is stopped: pid = $pid pattern = '${1}'\"\n+      kill ${pid} 2> /dev/null || true\n+      if [[ \"$OS_TYPE\" == \"mac\" ]]; then\n+          # works on mac, but does seem to return before the process has finished on Linux\n+          wait ${pid} 2> /dev/null || true\n+      else\n+          # use tail to wait for a process to finish: https://stackoverflow.com/questions/1058047/wait-for-a-process-to-finish/11719943\n+          timeout 60 tail --pid=${pid} -f /dev/null\n+          if [ \"$?\" -eq 124 ]; then\n+            echo \"Process (pid = $pid) didn't stop within 60 seconds. Killing it:\"\n+            kill -9 $pid\n+          fi\n+      fi", "originalCommit": "9e5179d99ac3f1ee67388f6236a5ffd087941a94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzE0NzA2MA==", "url": "https://github.com/apache/flink/pull/14033#discussion_r523147060", "bodyText": "The problem is that the scripts in #14062 is shipped to the users as part of the Flink distribution for starting Flink.\nThe code here is solely for the testing infrastructure. We could in theory source a script from the distribution here, but that would be a weird dependency.", "author": "rmetzger", "createdAt": "2020-11-13T18:31:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzEyMjYzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzgyMTA5Ng==", "url": "https://github.com/apache/flink/pull/14033#discussion_r523821096", "bodyText": "I see. Makes sense.", "author": "XComp", "createdAt": "2020-11-15T22:09:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzEyMjYzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzEyNzIyOQ==", "url": "https://github.com/apache/flink/pull/14033#discussion_r523127229", "bodyText": "I couldn't verify it that's why I'm asking: Are you sure that this is what you want to do? AFAIK, pkill would need some pattern and -P just restricts the parent PID?! \ud83e\udd14", "author": "XComp", "createdAt": "2020-11-13T17:56:50Z", "path": "flink-end-to-end-tests/test-scripts/common.sh", "diffHunk": "@@ -822,11 +839,20 @@ internal_run_with_timeout() {\n \n   (\n       command_pid=$BASHPID\n-      (sleep \"${timeout_in_seconds}\" # set a timeout for this command\n-      echo \"${command_label:-\"The command '${command}'\"} (pid: $command_pid) did not finish after $timeout_in_seconds seconds.\"\n-      eval \"${on_failure}\"\n-      kill \"$command_pid\") & watchdog_pid=$!\n+      (# this subshell contains the watchdog\n+        local wakeup_time=$(( ${timeout_in_seconds} + $(date +%s) ))\n+        while true; do\n+          sleep 1\n+          if [ $wakeup_time -le $(date +%s) ]; then\n+            echo \"${command_label:-\"The command '${command}'\"} (pid: $command_pid) did not finish after $timeout_in_seconds seconds.\"\n+            eval \"${on_failure}\"\n+            kill \"$command_pid\"\n+            pkill -P \"$command_pid\"", "originalCommit": "9e5179d99ac3f1ee67388f6236a5ffd087941a94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzE1MTQyMw==", "url": "https://github.com/apache/flink/pull/14033#discussion_r523151423", "bodyText": "My understanding is that this command kills all children of $command_pid, and if there's no pattern, it'll kill all of them", "author": "rmetzger", "createdAt": "2020-11-13T18:36:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzEyNzIyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzgyMzMyMw==", "url": "https://github.com/apache/flink/pull/14033#discussion_r523823323", "bodyText": "Ok, I did some more research on it. Looks like it works like that.", "author": "XComp", "createdAt": "2020-11-15T22:27:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzEyNzIyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzEzMTE4Mw==", "url": "https://github.com/apache/flink/pull/14033#discussion_r523131183", "bodyText": "why do we have to run sudo here? Isn't the test executed by root? \ud83e\udd14", "author": "XComp", "createdAt": "2020-11-13T18:04:12Z", "path": "flink-end-to-end-tests/test-scripts/test-runner-common.sh", "diffHunk": "@@ -110,10 +114,40 @@ function post_test_validation {\n     fi\n }\n \n+# returns the number of allocated ports\n+function get_num_ports {\n+    # \"ps --ppid 2 -p 2 --deselect\" shows all non-kernel processes\n+    # \"ps --ppid $$\" shows all children of this bash process\n+    # \"ps -o pid= -o comm=\" removes the header line\n+    echo $(sudo netstat -tulpn | wc -l)", "originalCommit": "9e5179d99ac3f1ee67388f6236a5ffd087941a94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzE1MjMzOA==", "url": "https://github.com/apache/flink/pull/14033#discussion_r523152338", "bodyText": "afaik the tests are run by vsts user on Azure. I just want to be sure that we are catching all ports", "author": "rmetzger", "createdAt": "2020-11-13T18:38:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzEzMTE4Mw=="}], "type": "inlineReview"}, {"oid": "fc9f926baa63a9070e7522e17211b43fd7003bca", "url": "https://github.com/apache/flink/commit/fc9f926baa63a9070e7522e17211b43fd7003bca", "message": "print pstree for debugging dotnet", "committedDate": "2020-11-13T18:43:07Z", "type": "commit"}]}