{"pr_number": 13392, "pr_title": "[FLINK-18713][table-planner-blink] Change duration configOption to duration type", "pr_createdAt": "2020-09-15T07:51:38Z", "pr_url": "https://github.com/apache/flink/pull/13392", "timeline": [{"oid": "027716b255e7333fa2c8ff2fdddab70591b5925d", "url": "https://github.com/apache/flink/commit/027716b255e7333fa2c8ff2fdddab70591b5925d", "message": "[FLINK-18713][table-planner-blink] Change duration configOption to to duration type", "committedDate": "2020-09-15T07:44:44Z", "type": "commit"}, {"oid": "bfb82165ec567b63f6f743aec7be913a2a440fa1", "url": "https://github.com/apache/flink/commit/bfb82165ec567b63f6f743aec7be913a2a440fa1", "message": "fix test fail", "committedDate": "2020-09-15T11:58:56Z", "type": "commit"}, {"oid": "f3af04d02472f93c5d49e0262ce7957cdd910707", "url": "https://github.com/apache/flink/commit/f3af04d02472f93c5d49e0262ce7957cdd910707", "message": "Fix test failed and update doc for config options changed", "committedDate": "2020-09-16T18:43:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDExNTg1OQ==", "url": "https://github.com/apache/flink/pull/13392#discussion_r490115859", "bodyText": "The default value is 0ms now. It would be better to mention the meaning of default value, otherwise it's confusing.\n\nDefault value is 0, which means detecting source idleness is not enabled.", "author": "wuchong", "createdAt": "2020-09-17T09:49:19Z", "path": "flink-table/flink-table-api-java/src/main/java/org/apache/flink/table/api/config/ExecutionConfigOptions.java", "diffHunk": "@@ -60,9 +60,10 @@\n \t// ------------------------------------------------------------------------\n \n \t@Documentation.TableOption(execMode = Documentation.ExecMode.STREAMING)\n-\tpublic static final ConfigOption<String> TABLE_EXEC_SOURCE_IDLE_TIMEOUT =\n+\tpublic static final ConfigOption<Duration> TABLE_EXEC_SOURCE_IDLE_TIMEOUT =\n \t\tkey(\"table.exec.source.idle-timeout\")\n-\t\t\t.defaultValue(\"-1 ms\")\n+\t\t\t.durationType()\n+\t\t\t.defaultValue(Duration.ofMillis(0))\n \t\t\t.withDescription(\"When a source do not receive any elements for the timeout time, \" +\n \t\t\t\t\"it will be marked as temporarily idle. This allows downstream \" +\n \t\t\t\t\"tasks to advance their watermarks without the need to wait for \" +", "originalCommit": "f3af04d02472f93c5d49e0262ce7957cdd910707", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDExNjgyMQ==", "url": "https://github.com/apache/flink/pull/13392#discussion_r490116821", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    val miniBatchLatency =config.getConfiguration.get(\n          \n          \n            \n                    val miniBatchLatency = config.getConfiguration.get(", "author": "wuchong", "createdAt": "2020-09-17T09:50:55Z", "path": "flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/plan/optimize/StreamCommonSubGraphBasedOptimizer.scala", "diffHunk": "@@ -61,8 +60,8 @@ class StreamCommonSubGraphBasedOptimizer(planner: StreamPlanner)\n \n       val miniBatchInterval: MiniBatchInterval = if (config.getConfiguration.getBoolean(\n         ExecutionConfigOptions.TABLE_EXEC_MINIBATCH_ENABLED)) {\n-        val miniBatchLatency = getMillisecondFromConfigDuration(config,\n-          ExecutionConfigOptions.TABLE_EXEC_MINIBATCH_ALLOW_LATENCY)\n+        val miniBatchLatency =config.getConfiguration.get(", "originalCommit": "f3af04d02472f93c5d49e0262ce7957cdd910707", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDExNzk1OQ==", "url": "https://github.com/apache/flink/pull/13392#discussion_r490117959", "bodyText": "It's not allowed to use -1ms for Duration type. We can use .noDefaultValue() to keep the same behavior as before. You can use tableConfig.getConfiguration.getOptional(TABLE_EXEC_EMIT_EARLY_FIRE_DELAY).isPresent to check whether it is set.", "author": "wuchong", "createdAt": "2020-09-17T09:52:53Z", "path": "flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/plan/utils/WindowEmitStrategy.scala", "diffHunk": "@@ -179,9 +178,10 @@ object WindowEmitStrategy {\n \n   // It is a experimental config, will may be removed later.\n   @Experimental\n-  val TABLE_EXEC_EMIT_EARLY_FIRE_DELAY: ConfigOption[String] =\n+  val TABLE_EXEC_EMIT_EARLY_FIRE_DELAY: ConfigOption[Duration] =\n   key(\"table.exec.emit.early-fire.delay\")\n-      .noDefaultValue\n+      .durationType()\n+      .defaultValue(Duration.ofMillis(-1))", "originalCommit": "f3af04d02472f93c5d49e0262ce7957cdd910707", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDExNzk5OA==", "url": "https://github.com/apache/flink/pull/13392#discussion_r490117998", "bodyText": "We can use .noDefaultValue() to keep the same behavior as before.", "author": "wuchong", "createdAt": "2020-09-17T09:52:56Z", "path": "flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/plan/utils/WindowEmitStrategy.scala", "diffHunk": "@@ -198,9 +198,10 @@ object WindowEmitStrategy {\n \n   // It is a experimental config, will may be removed later.\n   @Experimental\n-  val TABLE_EXEC_EMIT_LATE_FIRE_DELAY: ConfigOption[String] =\n+  val TABLE_EXEC_EMIT_LATE_FIRE_DELAY: ConfigOption[Duration] =\n   key(\"table.exec.emit.late-fire.delay\")\n-      .noDefaultValue\n+      .durationType()\n+      .defaultValue(Duration.ofMillis(-1))", "originalCommit": "f3af04d02472f93c5d49e0262ce7957cdd910707", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b4edfc577e0d1d20203de931dbbab1ac4ab2d621", "url": "https://github.com/apache/flink/commit/b4edfc577e0d1d20203de931dbbab1ac4ab2d621", "message": "Update the content of the comments", "committedDate": "2020-09-17T14:25:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgxMzk5Mg==", "url": "https://github.com/apache/flink/pull/13392#discussion_r490813992", "bodyText": "What about refactoring the earlyFireDelay to Duration type? Then we can simplify the above code to\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                val earlyFireDelay: JLong = if (tableConfig.getConfiguration\n          \n          \n            \n                  .getOptional(TABLE_EXEC_EMIT_EARLY_FIRE_DELAY).isPresent) {\n          \n          \n            \n                  tableConfig.getConfiguration\n          \n          \n            \n                    .get(TABLE_EXEC_EMIT_EARLY_FIRE_DELAY).toMillis\n          \n          \n            \n                } else {\n          \n          \n            \n                  null\n          \n          \n            \n                }\n          \n          \n            \n            val earlyFireDelay: Duration = tableConfig.getConfiguration\n          \n          \n            \n                  .getOptional(TABLE_EXEC_EMIT_EARLY_FIRE_DELAY)\n          \n          \n            \n                  .orElse(null)\n          \n      \n    \n    \n  \n\nI think Duration is more concise than Long.", "author": "wuchong", "createdAt": "2020-09-18T09:16:02Z", "path": "flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/plan/utils/WindowEmitStrategy.scala", "diffHunk": "@@ -153,12 +152,22 @@ object WindowEmitStrategy {\n     }\n     val enableEarlyFireDelay = tableConfig.getConfiguration.getBoolean(\n       TABLE_EXEC_EMIT_EARLY_FIRE_ENABLED)\n-    val earlyFireDelay = getMillisecondFromConfigDuration(\n-      tableConfig, TABLE_EXEC_EMIT_EARLY_FIRE_DELAY)\n+    val earlyFireDelay: JLong = if (tableConfig.getConfiguration\n+      .getOptional(TABLE_EXEC_EMIT_EARLY_FIRE_DELAY).isPresent) {\n+      tableConfig.getConfiguration\n+        .get(TABLE_EXEC_EMIT_EARLY_FIRE_DELAY).toMillis\n+    } else {\n+      null\n+    }", "originalCommit": "b4edfc577e0d1d20203de931dbbab1ac4ab2d621", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTY4Mzc1OA==", "url": "https://github.com/apache/flink/pull/13392#discussion_r491683758", "bodyText": "Yes, Duration type for earlyFireDelay and lateFireDelay will be more reasonable.\nI have updated, thanks for reviewing again.", "author": "wangxlong", "createdAt": "2020-09-20T11:49:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgxMzk5Mg=="}], "type": "inlineReview"}, {"oid": "0ae80979b126523815401a76c4dac86a06d9e23c", "url": "https://github.com/apache/flink/commit/0ae80979b126523815401a76c4dac86a06d9e23c", "message": "Refactoring earlyFireDelay and lateFireDelay to Duration type", "committedDate": "2020-09-20T11:45:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc3MTg3OQ==", "url": "https://github.com/apache/flink/pull/13392#discussion_r491771879", "bodyText": "Please update this too.", "author": "wuchong", "createdAt": "2020-09-21T02:43:00Z", "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/runtime/stream/sql/WindowAggregateITCase.scala", "diffHunk": "@@ -349,15 +349,20 @@ class WindowAggregateITCase(mode: StateBackendMode)\n \n   private def withLateFireDelay(tableConfig: TableConfig, interval: Time): Unit = {\n     val intervalInMillis = interval.toMilliseconds\n-    val preLateFireInterval = getMillisecondFromConfigDuration(tableConfig,\n-      TABLE_EXEC_EMIT_LATE_FIRE_DELAY)\n+    val preLateFireInterval = if (tableConfig.getConfiguration\n+      .getOptional(TABLE_EXEC_EMIT_LATE_FIRE_DELAY).isPresent) {\n+      tableConfig.getConfiguration.get(\n+        TABLE_EXEC_EMIT_LATE_FIRE_DELAY).toMillis\n+    } else {\n+      null\n+    }", "originalCommit": "0ae80979b126523815401a76c4dac86a06d9e23c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjA2NTA1Mg==", "url": "https://github.com/apache/flink/pull/13392#discussion_r492065052", "bodyText": "Updated.", "author": "wangxlong", "createdAt": "2020-09-21T13:56:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc3MTg3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc3MjA3OA==", "url": "https://github.com/apache/flink/pull/13392#discussion_r491772078", "bodyText": "Pleaes update this too.", "author": "wuchong", "createdAt": "2020-09-21T02:44:28Z", "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/plan/stream/sql/MiniBatchIntervalInferTest.scala", "diffHunk": "@@ -426,15 +428,20 @@ class MiniBatchIntervalInferTest extends TableTestBase {\n \n   private def withEarlyFireDelay(tableConfig: TableConfig, interval: Time): Unit = {\n     val intervalInMillis = interval.toMilliseconds\n-    val preEarlyFireInterval = TableConfigUtils.getMillisecondFromConfigDuration(\n-      tableConfig, TABLE_EXEC_EMIT_EARLY_FIRE_DELAY)\n+    val preEarlyFireInterval = if (tableConfig.getConfiguration\n+      .getOptional(TABLE_EXEC_EMIT_EARLY_FIRE_DELAY).isPresent) {\n+      tableConfig.getConfiguration\n+        .get(TABLE_EXEC_EMIT_EARLY_FIRE_DELAY).toMillis\n+    } else {\n+      null\n+    }", "originalCommit": "0ae80979b126523815401a76c4dac86a06d9e23c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjA2NDg2MQ==", "url": "https://github.com/apache/flink/pull/13392#discussion_r492064861", "bodyText": "Updated.", "author": "wangxlong", "createdAt": "2020-09-21T13:56:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc3MjA3OA=="}], "type": "inlineReview"}, {"oid": "9f86e01988e6d8ad8b904670f66713ab21e485d6", "url": "https://github.com/apache/flink/commit/9f86e01988e6d8ad8b904670f66713ab21e485d6", "message": "Refactoring fireDelay to duration type", "committedDate": "2020-09-21T13:53:51Z", "type": "commit"}]}