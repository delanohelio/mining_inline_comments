{"pr_number": 11509, "pr_title": "[FLINK-16753] Use CheckpointException to wrap exceptions thrown from AsyncCheckpointRunnable", "pr_createdAt": "2020-03-25T12:16:18Z", "pr_url": "https://github.com/apache/flink/pull/11509", "timeline": [{"oid": "f2abe6b16e459e6b5143c06e9205a8cf93d78ff4", "url": "https://github.com/apache/flink/commit/f2abe6b16e459e6b5143c06e9205a8cf93d78ff4", "message": "use CheckpointException to wrap exceptions thrown from AsyncCheckpointRunnable", "committedDate": "2020-03-30T07:23:00Z", "type": "forcePushed"}, {"oid": "e01cd5124932776df8549097e1d0d57a31bf3cc4", "url": "https://github.com/apache/flink/commit/e01cd5124932776df8549097e1d0d57a31bf3cc4", "message": "use CheckpointException to wrap exceptions thrown from AsyncCheckpointRunnable", "committedDate": "2020-09-27T07:44:23Z", "type": "commit"}, {"oid": "e01cd5124932776df8549097e1d0d57a31bf3cc4", "url": "https://github.com/apache/flink/commit/e01cd5124932776df8549097e1d0d57a31bf3cc4", "message": "use CheckpointException to wrap exceptions thrown from AsyncCheckpointRunnable", "committedDate": "2020-09-27T07:44:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU2NDAyMA==", "url": "https://github.com/apache/flink/pull/11509#discussion_r495564020", "bodyText": "I have two concerns for this change:\n\nI saw the motivation from the respective jira description that it wants to resolve the misleading CheckpointFailureReason.JOB_FAILURE. But when I traced the codes, I found the JOB_FAILURE was used in the below region of CheckpointCoordinator#receiveDeclineMessage:\n\nfinal CheckpointException checkpointException;\nif (message.getReason() == null) {\n\t\tcheckpointException = new CheckpointException(CheckpointFailureReason.CHECKPOINT_DECLINED);\n} else {\n\t\tcheckpointException = getCheckpointException(CheckpointFailureReason.JOB_FAILURE, message.getReason());\n}\n\nSo I guess whatever which exception is wrapped here, it would be all regarded as JOB_FAILURE unless null reason. Or I misunderstood something else?\n\nThe semantic seems not correct when we use CheckpointFailureReason.EXCEPTION here, because CheckpointFailureReason#preFlight will be true for this exception. But we know that if the exception happens during async checkpoint process, the semantic of #preFlight should be false.\n\nAnother tiny comment for the formatting is to either make every argument in separate line or both in the same line. :)", "author": "zhijiangW", "createdAt": "2020-09-27T11:40:30Z", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/AsyncCheckpointRunnable.java", "diffHunk": "@@ -197,7 +199,8 @@ private void handleExecutionException(Exception e) {\n \t\t\t\t// We only report the exception for the original cause of fail and cleanup.\n \t\t\t\t// Otherwise this followup exception could race the original exception in failing the task.\n \t\t\t\ttry {\n-\t\t\t\t\ttaskEnvironment.declineCheckpoint(checkpointMetaData.getCheckpointId(), checkpointException);\n+\t\t\t\t\ttaskEnvironment.declineCheckpoint(checkpointMetaData.getCheckpointId(),\n+\t\t\t\t\t\t\tnew CheckpointException(CheckpointFailureReason.EXCEPTION, checkpointException));", "originalCommit": "e01cd5124932776df8549097e1d0d57a31bf3cc4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTczNTc3NQ==", "url": "https://github.com/apache/flink/pull/11509#discussion_r495735775", "bodyText": "@zhijiangW\n\nCheckpointFailureReason.JOB_FAILURE is the default value of method getCheckpointException, you can check the implementation for more details.\nYou're right about the semantic. In our internal version we add a new CheckpointFailureReason value:\n\nCHECKPOINT_ASYNC_EXCEPTION(false, \"Asynchronous task checkpoint failed.\"),\n\nHow about this way?", "author": "Jiayi-Liao", "createdAt": "2020-09-28T07:21:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU2NDAyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjU1NzU4Ng==", "url": "https://github.com/apache/flink/pull/11509#discussion_r496557586", "bodyText": "CheckpointFailureReason.JOB_FAILURE is the default value of method getCheckpointException, you can check the implementation for more details.\n\nYeah, you are right.\n\nYou're right about the semantic. In our internal version we add a new CheckpointFailureReason value:\n\nI like the CHECKPOINT_ASYNC_EXCEPTION way. Go ahead!\nBTW, how about supplementing somehow unit test for the changes if possible?\nMaybe construct AsyncCheckpointRunnable  like did in LocalStateForwardingTest  and then throw an exception during run. Then we can override the implementation of StreamMockEnvironment#declineCheckpoint to verify the exception argument instanceof CheckpointException and preFlight = false. Or there are some other easier way I did not think through.", "author": "zhijiangW", "createdAt": "2020-09-29T09:04:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU2NDAyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY0NzQwOQ==", "url": "https://github.com/apache/flink/pull/11509#discussion_r496647409", "bodyText": "How about adding two tests?\n\nVerify the exception thrown from AsyncCheckpointRunnable.\nVerify the CheckpointReason on CheckpointCoordinator's side.", "author": "Jiayi-Liao", "createdAt": "2020-09-29T11:38:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU2NDAyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY1MzcxMQ==", "url": "https://github.com/apache/flink/pull/11509#discussion_r496653711", "bodyText": "I think the first one is necessary since the type of thrown exception is changed in this PR.\nThe second one is optional since we do not change any logics there. But if you want to supplement some previously missing unit tests for the CheckpointCoordinator component, I am also fine with it. :)", "author": "zhijiangW", "createdAt": "2020-09-29T11:50:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU2NDAyMA=="}], "type": "inlineReview"}, {"oid": "fdde82701ae1a784c81ecb14c0f7b779e0c9f65f", "url": "https://github.com/apache/flink/commit/fdde82701ae1a784c81ecb14c0f7b779e0c9f65f", "message": "fix", "committedDate": "2020-09-29T12:44:01Z", "type": "commit"}, {"oid": "0a96025249d753072b8eaab23b404ded9b6ddf47", "url": "https://github.com/apache/flink/commit/0a96025249d753072b8eaab23b404ded9b6ddf47", "message": "fix checkstyle", "committedDate": "2020-09-29T13:02:49Z", "type": "commit"}, {"oid": "086b22995f36319eff14d180e91a5aae4d1fbcb5", "url": "https://github.com/apache/flink/commit/086b22995f36319eff14d180e91a5aae4d1fbcb5", "message": "fix checkstyle", "committedDate": "2020-09-30T02:47:35Z", "type": "commit"}]}