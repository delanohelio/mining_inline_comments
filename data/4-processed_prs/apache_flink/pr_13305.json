{"pr_number": 13305, "pr_title": "[FLINK-19109][task] Ignore isLoopRunning in MailboxExecutor.isIdle", "pr_createdAt": "2020-09-02T11:09:20Z", "pr_url": "https://github.com/apache/flink/pull/13305", "timeline": [{"oid": "db800b0d36bc68eba7f346ce1b66fbf738c182fd", "url": "https://github.com/apache/flink/commit/db800b0d36bc68eba7f346ce1b66fbf738c182fd", "message": "[FLINK-19109][task] Ignore isLoopRunning in MailboxExecutor.isIdle\n\nWhen closing, this flag is set, but mailbox can still contain\n(and receive new) mails (e.g. from timers) that should be processed.\nIn particular, this check currently prevents periodic watermarks from\nbeing emitted.", "committedDate": "2020-09-02T16:37:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI5MzMxOA==", "url": "https://github.com/apache/flink/pull/13305#discussion_r482293318", "bodyText": "Overall this looks good to me, but I'm just trying to check that this assertion isn't going to be brittle. Is this simply asserting that the actual number of WMs should be at least 20% of the expected number -- which is based on how long the sink was open?", "author": "alpinegizmo", "createdAt": "2020-09-02T18:40:20Z", "path": "flink-tests/src/test/java/org/apache/flink/test/streaming/api/FileReadingWatermarkITCase.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.test.streaming.api;\n+\n+import org.apache.flink.api.common.JobExecutionResult;\n+import org.apache.flink.api.common.accumulators.IntCounter;\n+import org.apache.flink.api.common.accumulators.LongCounter;\n+import org.apache.flink.configuration.Configuration;\n+import org.apache.flink.streaming.api.TimeCharacteristic;\n+import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;\n+import org.apache.flink.streaming.api.functions.sink.RichSinkFunction;\n+import org.apache.flink.streaming.api.functions.sink.SinkFunction;\n+import org.apache.flink.streaming.api.functions.timestamps.BoundedOutOfOrdernessTimestampExtractor;\n+import org.apache.flink.streaming.api.windowing.time.Time;\n+\n+import org.junit.Test;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.PrintWriter;\n+import java.util.UUID;\n+\n+import static org.apache.flink.util.Preconditions.checkState;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+/**\n+ * Tests that watermarks are emitted while file is being read, particularly the last split.\n+ *\n+ * @see <a href=\"https://issues.apache.org/jira/browse/FLINK-19109\">FLINK-19109</a>\n+ */\n+public class FileReadingWatermarkITCase {\n+\tprivate static final String DURATION_ACC_NAME = \"duration\";\n+\tprivate static final String NUM_WATERMARKS_ACC_NAME = \"numWatermarks\";\n+\tprivate static final int FILE_SIZE_LINES = 100_000;\n+\tprivate static final int WATERMARK_INTERVAL_MILLIS = 10;\n+\tprivate static final int MIN_EXPECTED_WATERMARKS = 5;\n+\n+\t@Test\n+\tpublic void testWatermarkEmissionWithChaining() throws Exception {\n+\t\tStreamExecutionEnvironment env = StreamExecutionEnvironment.createLocalEnvironment(1);\n+\t\tenv.setStreamTimeCharacteristic(TimeCharacteristic.EventTime);\n+\t\tenv.getConfig().setAutoWatermarkInterval(WATERMARK_INTERVAL_MILLIS);\n+\n+\t\tcheckState(env.isChainingEnabled());\n+\n+\t\tenv\n+\t\t\t.readTextFile(getSourceFile().getAbsolutePath())\n+\t\t\t.assignTimestampsAndWatermarks(getExtractorAssigner())\n+\t\t\t.addSink(getWatermarkCounter());\n+\n+\t\tJobExecutionResult result = env.execute();\n+\n+\t\tint actual = result.getAccumulatorResult(NUM_WATERMARKS_ACC_NAME);\n+\t\tdouble expected = ((double) (long) result.getAccumulatorResult(DURATION_ACC_NAME)) / WATERMARK_INTERVAL_MILLIS;\n+\n+\t\tassertTrue(\"too few watermarks emitted: \" + actual, actual >= MIN_EXPECTED_WATERMARKS);\n+\t\tassertEquals(1, actual / expected, .8d); // very simple pipeline might spend its time on setup instead of actual processing", "originalCommit": "db800b0d36bc68eba7f346ce1b66fbf738c182fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjMyNTMxNg==", "url": "https://github.com/apache/flink/pull/13305#discussion_r482325316", "bodyText": "the actual number of WMs should be at least 20% of the expected number -- which is based on how long the sink was open?\n\nYes, exactly. Do you see any ways to improve this? I came up only with artificially slowing down processing - which is also fragile.", "author": "rkhachatryan", "createdAt": "2020-09-02T19:15:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI5MzMxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc2NjA0MA==", "url": "https://github.com/apache/flink/pull/13305#discussion_r482766040", "bodyText": "I would hope that thanks to mailbox this should be quite easily testable with the test harness.\nWhat about testing that some mailbox action is allowed to be executed when the CFRO is closing up and processing some infinite split?", "author": "pnowojski", "createdAt": "2020-09-03T07:30:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI5MzMxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc3MjcyMA==", "url": "https://github.com/apache/flink/pull/13305#discussion_r482772720", "bodyText": "For the IT test I think it's good enough to see that some meaningful watermarks (i.e., 0 < WM < MAX_WATERMARK) are emitted.", "author": "alpinegizmo", "createdAt": "2020-09-03T07:41:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI5MzMxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjkyMTQwMQ==", "url": "https://github.com/apache/flink/pull/13305#discussion_r482921401", "bodyText": "What about testing that some mailbox action is allowed to be executed when the CFRO is closing up and processing some infinite split?\n\nI don't see any easy way to\n\nsend END_OF_INPUT to the mocked task; without it, mailbox default action is not suspended and isIdle always returns false\nenqueue an email after calling processElement (solvable, but I think too complex given that it's already tested)", "author": "rkhachatryan", "createdAt": "2020-09-03T11:56:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI5MzMxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc2MTQ0Mg==", "url": "https://github.com/apache/flink/pull/13305#discussion_r482761442", "bodyText": "what about adding a unit test for this method? Unit test wouldn't be very useful, but also would be trivial?", "author": "pnowojski", "createdAt": "2020-09-03T07:22:22Z", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/tasks/mailbox/MailboxExecutorImpl.java", "diffHunk": "@@ -57,8 +57,7 @@ public MailboxExecutorImpl(@Nonnull TaskMailbox mailbox, int priority, StreamTas\n \t}\n \n \tpublic boolean isIdle() {\n-\t\treturn !mailboxProcessor.isMailboxLoopRunning() ||\n-\t\t\t(mailboxProcessor.isDefaultActionUnavailable() && !mailbox.hasMail() && mailbox.getState().isAcceptingMails());\n+\t\treturn mailboxProcessor.isDefaultActionUnavailable() && !mailbox.hasMail() && mailbox.getState().isAcceptingMails();", "originalCommit": "db800b0d36bc68eba7f346ce1b66fbf738c182fd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "380b8d7be6ae142a27061c6d529c2ca059a51aa5", "url": "https://github.com/apache/flink/commit/380b8d7be6ae142a27061c6d529c2ca059a51aa5", "message": "[FLINK-19109][task] Ignore isLoopRunning in MailboxExecutor.isIdle\n\nWhen closing, this flag is set, but mailbox can still contain\n(and receive new) mails (e.g. from timers) that should be processed.\nIn particular, this check currently prevents periodic watermarks from\nbeing emitted.", "committedDate": "2020-09-03T13:09:20Z", "type": "commit"}, {"oid": "380b8d7be6ae142a27061c6d529c2ca059a51aa5", "url": "https://github.com/apache/flink/commit/380b8d7be6ae142a27061c6d529c2ca059a51aa5", "message": "[FLINK-19109][task] Ignore isLoopRunning in MailboxExecutor.isIdle\n\nWhen closing, this flag is set, but mailbox can still contain\n(and receive new) mails (e.g. from timers) that should be processed.\nIn particular, this check currently prevents periodic watermarks from\nbeing emitted.", "committedDate": "2020-09-03T13:09:20Z", "type": "forcePushed"}]}