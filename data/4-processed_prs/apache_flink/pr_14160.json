{"pr_number": 14160, "pr_title": "[FLINK-19795][table-blink] Fix Flink SQL throws exception when changelog source contains duplicate change events", "pr_createdAt": "2020-11-22T16:18:49Z", "pr_url": "https://github.com/apache/flink/pull/14160", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU0Mzc5Ng==", "url": "https://github.com/apache/flink/pull/14160#discussion_r528543796", "bodyText": "We drop the before messages in the temporal table, therefore, 1,Euro can correlate a value now.", "author": "wuchong", "createdAt": "2020-11-23T08:48:38Z", "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/runtime/stream/sql/TemporalJoinITCase.scala", "diffHunk": "@@ -537,51 +523,35 @@ class TemporalJoinITCase(state: StateBackendMode)\n       \" ON o.currency = r.currency\"\n     tEnv.executeSql(sql).await()\n \n-    val rawResult = getRawResults(\"rowtime_default_sink\")\n     // Note: the event time semantics in delete event is when the delete event happened,\n     // records \"+I(2,US Dollar)\" and \"+I(3,RMB)\" would not correlate the deleted events\n     val expected = List(\n-      \"+I(1,Euro,12,2020-08-15T00:01,null,null)\",\n-      \"+I(2,US Dollar,1,2020-08-15T00:02,null,null)\",\n-      \"+I(3,RMB,40,2020-08-15T00:03,null,null)\",\n-      \"+I(4,Euro,14,2020-08-16T00:04,118,2020-08-16T00:01)\",\n-      \"-U(2,US Dollar,1,2020-08-16T00:03,106,2020-08-16T00:02)\",\n-      \"+U(2,US Dollar,18,2020-08-16T00:03,106,2020-08-16T00:02)\",\n-      \"+I(5,RMB,40,2020-08-16T00:03,null,null)\",\n-      \"+I(6,RMB,40,2020-08-16T00:04,null,null)\",\n-      \"-D(6,RMB,40,2020-08-16T00:04,null,null)\")\n-    assertEquals(expected.sorted, rawResult.sorted)\n+      \"1,Euro,12,2020-08-15T00:01,114,2020-08-15T00:00:01\",", "originalCommit": "bdea131f32cf7f25237f44e7246e93a219ea1d8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "250fae8059b6141ed0bb3e244a522751f20c2e8b", "url": "https://github.com/apache/flink/commit/250fae8059b6141ed0bb3e244a522751f20c2e8b", "message": "[FLINK-19795][table-blink] Fix Flink SQL throws exception when changelog source contains duplicate change events", "committedDate": "2020-11-23T13:19:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEwMTQ1NA==", "url": "https://github.com/apache/flink/pull/14160#discussion_r530101454", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \u5728\u6b63\u5e38\u7684\u64cd\u4f5c\u73af\u5883\u4e0b\uff0cCanal \u5e94\u7528\u80fd\u4ee5 **exactly-once** \u7684\u8bed\u4e49\u6295\u9012\u6bcf\u6761\u53d8\u66f4\u4e8b\u4ef6\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0cFlink \u6d88\u8d39 Canal \u4ea7\u751f\u7684\u53d8\u66f4\u4e8b\u4ef6\u80fd\u591f\u5de5\u4f5c\u5730\u5f88\u597d\u3002\n          \n          \n            \n            \u5728\u6b63\u5e38\u7684\u64cd\u4f5c\u73af\u5883\u4e0b\uff0cCanal \u5e94\u7528\u80fd\u4ee5 **exactly-once** \u7684\u8bed\u4e49\u6295\u9012\u6bcf\u6761\u53d8\u66f4\u4e8b\u4ef6\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0cFlink \u6d88\u8d39 Canal \u4ea7\u751f\u7684\u53d8\u66f4\u4e8b\u4ef6\u80fd\u591f\u5de5\u4f5c\u5f97\u5f88\u597d\u3002", "author": "leonardBang", "createdAt": "2020-11-25T04:31:02Z", "path": "docs/dev/table/connectors/formats/canal.zh.md", "diffHunk": "@@ -219,6 +219,17 @@ Format \u53c2\u6570\n     </tbody>\n </table>\n \n+\u6ce8\u610f\u4e8b\u9879\n+----------------\n+\n+### \u91cd\u590d\u7684\u53d8\u66f4\u4e8b\u4ef6\n+\n+\u5728\u6b63\u5e38\u7684\u64cd\u4f5c\u73af\u5883\u4e0b\uff0cCanal \u5e94\u7528\u80fd\u4ee5 **exactly-once** \u7684\u8bed\u4e49\u6295\u9012\u6bcf\u6761\u53d8\u66f4\u4e8b\u4ef6\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0cFlink \u6d88\u8d39 Canal \u4ea7\u751f\u7684\u53d8\u66f4\u4e8b\u4ef6\u80fd\u591f\u5de5\u4f5c\u5730\u5f88\u597d\u3002", "originalCommit": "af478685f91c3cf99c0553eeddd320bb8c3f4b35", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEwMTk2Mw==", "url": "https://github.com/apache/flink/pull/14160#discussion_r530101963", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Under normal operating scenarios, the Debezium application delivers every change event **exactly-once**. This works pretty well when Flink consumes Debezium produced events in this situation.\n          \n          \n            \n            Under normal operating scenarios, the Debezium application delivers every change event **exactly-once**. Flink works pretty well when consumes Debezium produced events in this situation.", "author": "leonardBang", "createdAt": "2020-11-25T04:33:17Z", "path": "docs/dev/table/connectors/formats/debezium.md", "diffHunk": "@@ -282,6 +282,14 @@ Use format `debezium-avro-confluent` to interpret Debezium Avro messages and for\n Caveats\n ----------------\n \n+### Duplicate change events\n+\n+Under normal operating scenarios, the Debezium application delivers every change event **exactly-once**. This works pretty well when Flink consumes Debezium produced events in this situation.", "originalCommit": "af478685f91c3cf99c0553eeddd320bb8c3f4b35", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEwNDYwNQ==", "url": "https://github.com/apache/flink/pull/14160#discussion_r530104605", "bodyText": "The condition!changelogMode.containsOnly(RowKind.INSERT) does not indicate the source is a CDC source which is non-upsert", "author": "leonardBang", "createdAt": "2020-11-25T04:43:01Z", "path": "flink-table/flink-table-planner-blink/src/main/java/org/apache/flink/table/planner/sources/DynamicSourceUtils.java", "diffHunk": "@@ -267,6 +302,20 @@ private static void validateScanSourceForStreaming(\n \t\t\t\t\tscanSource.getClass().getName()\n \t\t\t\t)\n \t\t\t);\n+\t\t} else if (!changelogMode.containsOnly(RowKind.INSERT)) {", "originalCommit": "af478685f91c3cf99c0553eeddd320bb8c3f4b35", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE0NDk3NA==", "url": "https://github.com/apache/flink/pull/14160#discussion_r530144974", "bodyText": "This is in the else branch which means it doesn't match !hasUpdateBefore && hasUpdateAfter (upsert source).", "author": "wuchong", "createdAt": "2020-11-25T06:59:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEwNDYwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEwNTc5MA==", "url": "https://github.com/apache/flink/pull/14160#discussion_r530105790", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  \"1,Euro,12,2020-08-15T00:01,114,2020-08-15T00:00:01\",\n          \n          \n            \n                  \"3,RMB,40,2020-08-15T00:03,702,2020-08-15T00:00:04\",\n          \n          \n            \n                  \"4,Euro,14,2020-08-16T00:04,118,2020-08-16T00:01\",\n          \n          \n            \n                  \"2,US Dollar,18,2020-08-16T00:03,106,2020-08-16T00:02\")\n          \n          \n            \n                  \"1,Euro,12,2020-08-15T00:01,114,2020-08-15T00:00:01\",\n          \n          \n            \n                  \"2,US Dollar,18,2020-08-16T00:03,106,2020-08-16T00:02\",\n          \n          \n            \n                  \"3,RMB,40,2020-08-15T00:03,702,2020-08-15T00:00:04\",\n          \n          \n            \n                  \"4,Euro,14,2020-08-16T00:04,118,2020-08-16T00:01\")\n          \n      \n    \n    \n  \n\nminor\uff1a we can give a more readable order that is same as the left table input.", "author": "leonardBang", "createdAt": "2020-11-25T04:47:39Z", "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/runtime/stream/sql/TemporalJoinITCase.scala", "diffHunk": "@@ -455,15 +455,12 @@ class TemporalJoinITCase(state: StateBackendMode)\n       \" ON o.currency = r.currency\"\n \n     tEnv.executeSql(sql).await()\n-    val rawResult = getRawResults(\"rowtime_default_sink\")\n     val expected = List(\n-      \"+I(1,Euro,12,2020-08-15T00:01,114,2020-08-15T00:00:01)\",\n-      \"+I(2,US Dollar,1,2020-08-15T00:02,102,2020-08-15T00:00:02)\",\n-      \"+I(3,RMB,40,2020-08-15T00:03,702,2020-08-15T00:00:04)\",\n-      \"+I(4,Euro,14,2020-08-16T00:04,118,2020-08-16T00:01)\",\n-      \"-U(2,US Dollar,1,2020-08-16T00:03,106,2020-08-16T00:02)\",\n-      \"+U(2,US Dollar,18,2020-08-16T00:03,106,2020-08-16T00:02)\")\n-    assertEquals(expected.sorted, rawResult.sorted)\n+      \"1,Euro,12,2020-08-15T00:01,114,2020-08-15T00:00:01\",\n+      \"3,RMB,40,2020-08-15T00:03,702,2020-08-15T00:00:04\",\n+      \"4,Euro,14,2020-08-16T00:04,118,2020-08-16T00:01\",\n+      \"2,US Dollar,18,2020-08-16T00:03,106,2020-08-16T00:02\")", "originalCommit": "af478685f91c3cf99c0553eeddd320bb8c3f4b35", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5507e70adece61819ef8e20e7333be58e460c6b2", "url": "https://github.com/apache/flink/commit/5507e70adece61819ef8e20e7333be58e460c6b2", "message": "[hotfix][docs] Update YARN config docs", "committedDate": "2020-11-25T07:25:54Z", "type": "commit"}, {"oid": "2ee27f0eff7494ea4a75f20f3a2309132af341bc", "url": "https://github.com/apache/flink/commit/2ee27f0eff7494ea4a75f20f3a2309132af341bc", "message": "[hotfix][table-planner-blink] Enable idle state cleanup for ChangelogNormalize operator", "committedDate": "2020-11-25T07:25:54Z", "type": "commit"}, {"oid": "b67c5115a88afff62c32307f8cfe7210dd10d646", "url": "https://github.com/apache/flink/commit/b67c5115a88afff62c32307f8cfe7210dd10d646", "message": "[FLINK-19795][table-blink] Fix Flink SQL throws exception when changelog source contains duplicate change events\n\nThis closes #14160\n\nfixup docs\n\naddress review comments.\n\nupdate comment\n\nfix", "committedDate": "2020-11-25T07:25:57Z", "type": "commit"}, {"oid": "b67c5115a88afff62c32307f8cfe7210dd10d646", "url": "https://github.com/apache/flink/commit/b67c5115a88afff62c32307f8cfe7210dd10d646", "message": "[FLINK-19795][table-blink] Fix Flink SQL throws exception when changelog source contains duplicate change events\n\nThis closes #14160\n\nfixup docs\n\naddress review comments.\n\nupdate comment\n\nfix", "committedDate": "2020-11-25T07:25:57Z", "type": "forcePushed"}]}