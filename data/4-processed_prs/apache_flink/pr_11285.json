{"pr_number": 11285, "pr_title": " [FLINK-16189][e2e] Remove test logic from FlinkDistribution", "pr_createdAt": "2020-03-02T13:43:32Z", "pr_url": "https://github.com/apache/flink/pull/11285", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU4MTk1OA==", "url": "https://github.com/apache/flink/pull/11285#discussion_r387581958", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \tLocalStandaloneFlinkResource(Path distributionDirectory, Optional<Path> logBackupDirectory, FlinkResourceSetup setup) {\n          \n          \n            \n            \tLocalStandaloneFlinkResource(Path distributionDirectory, @Nullable Path logBackupDirectory, FlinkResourceSetup setup) {\n          \n      \n    \n    \n  \n\ncode style", "author": "azagrebin", "createdAt": "2020-03-04T10:38:26Z", "path": "flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/flink/LocalStandaloneFlinkResource.java", "diffHunk": "@@ -51,16 +58,28 @@\n \n \tprivate static final Logger LOG = LoggerFactory.getLogger(LocalStandaloneFlinkResource.class);\n \n-\tprivate final FlinkDistribution distribution = new FlinkDistribution();\n+\tprivate final TemporaryFolder temporaryFolder = new TemporaryFolder();\n+\tprivate final Path distributionDirectory;\n+\t@Nullable\n+\tprivate final Path logBackupDirectory;\n \tprivate final FlinkResourceSetup setup;\n \n-\tLocalStandaloneFlinkResource(FlinkResourceSetup setup) {\n+\tprivate FlinkDistribution distribution;\n+\n+\tLocalStandaloneFlinkResource(Path distributionDirectory, Optional<Path> logBackupDirectory, FlinkResourceSetup setup) {", "originalCommit": "281fa884afd6a76ece952ce5245227fec2d86bce", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU4Mzg0Mg==", "url": "https://github.com/apache/flink/pull/11285#discussion_r387583842", "bodyText": "nit for hotfix, can be IOException", "author": "azagrebin", "createdAt": "2020-03-04T10:41:43Z", "path": "flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/flink/LocalStandaloneFlinkResource.java", "diffHunk": "@@ -51,16 +58,28 @@\n \n \tprivate static final Logger LOG = LoggerFactory.getLogger(LocalStandaloneFlinkResource.class);\n \n-\tprivate final FlinkDistribution distribution = new FlinkDistribution();\n+\tprivate final TemporaryFolder temporaryFolder = new TemporaryFolder();\n+\tprivate final Path distributionDirectory;\n+\t@Nullable\n+\tprivate final Path logBackupDirectory;\n \tprivate final FlinkResourceSetup setup;\n \n-\tLocalStandaloneFlinkResource(FlinkResourceSetup setup) {\n+\tprivate FlinkDistribution distribution;\n+\n+\tLocalStandaloneFlinkResource(Path distributionDirectory, Optional<Path> logBackupDirectory, FlinkResourceSetup setup) {\n+\t\tthis.distributionDirectory = distributionDirectory;\n+\t\tthis.logBackupDirectory = logBackupDirectory.orElse(null);\n \t\tthis.setup = setup;\n \t}\n \n \t@Override\n \tpublic void before() throws Exception {", "originalCommit": "281fa884afd6a76ece952ce5245227fec2d86bce", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYxMTk0MQ==", "url": "https://github.com/apache/flink/pull/11285#discussion_r387611941", "bodyText": "backupLogs();", "author": "azagrebin", "createdAt": "2020-03-04T11:39:19Z", "path": "flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/flink/LocalStandaloneFlinkResource.java", "diffHunk": "@@ -71,12 +90,33 @@ public void before() throws Exception {\n \n \t@Override\n \tpublic void afterTestSuccess() {\n-\t\tdistribution.afterTestSuccess();\n+\t\tshutdownCluster();\n+\t\ttemporaryFolder.delete();\n \t}\n \n \t@Override\n \tpublic void afterTestFailure() {\n-\t\tdistribution.afterTestFailure();\n+\t\tif (distribution != null) {\n+\t\t\tshutdownCluster();\n+\t\t\tif (logBackupDirectory != null) {\n+\t\t\t\tfinal Path targetDirectory = logBackupDirectory.resolve(UUID.randomUUID().toString());\n+\t\t\t\ttry {\n+\t\t\t\t\tdistribution.copyLogsTo(targetDirectory);\n+\t\t\t\t\tLOG.info(\"Backed up logs to {}.\", targetDirectory);\n+\t\t\t\t} catch (IOException e) {\n+\t\t\t\t\tLOG.warn(\"An error has occurred while backing up logs to {}.\", targetDirectory, e);\n+\t\t\t\t}\n+\t\t\t}", "originalCommit": "281fa884afd6a76ece952ce5245227fec2d86bce", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYxNTA0NA==", "url": "https://github.com/apache/flink/pull/11285#discussion_r387615044", "bodyText": "distribution = createFlinkDistribution();", "author": "azagrebin", "createdAt": "2020-03-04T11:46:20Z", "path": "flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/flink/LocalStandaloneFlinkResource.java", "diffHunk": "@@ -51,16 +58,28 @@\n \n \tprivate static final Logger LOG = LoggerFactory.getLogger(LocalStandaloneFlinkResource.class);\n \n-\tprivate final FlinkDistribution distribution = new FlinkDistribution();\n+\tprivate final TemporaryFolder temporaryFolder = new TemporaryFolder();\n+\tprivate final Path distributionDirectory;\n+\t@Nullable\n+\tprivate final Path logBackupDirectory;\n \tprivate final FlinkResourceSetup setup;\n \n-\tLocalStandaloneFlinkResource(FlinkResourceSetup setup) {\n+\tprivate FlinkDistribution distribution;\n+\n+\tLocalStandaloneFlinkResource(Path distributionDirectory, Optional<Path> logBackupDirectory, FlinkResourceSetup setup) {\n+\t\tthis.distributionDirectory = distributionDirectory;\n+\t\tthis.logBackupDirectory = logBackupDirectory.orElse(null);\n \t\tthis.setup = setup;\n \t}\n \n \t@Override\n \tpublic void before() throws Exception {\n-\t\tdistribution.before();\n+\t\ttemporaryFolder.create();\n+\t\tPath tmp = temporaryFolder.newFolder().toPath();\n+\t\tLOG.info(\"Copying distribution to {}.\", tmp);\n+\t\tTestUtils.copyDirectory(distributionDirectory, tmp);\n+\n+\t\tdistribution = new FlinkDistribution(tmp);", "originalCommit": "281fa884afd6a76ece952ce5245227fec2d86bce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYzODEyNw==", "url": "https://github.com/apache/flink/pull/11285#discussion_r387638127", "bodyText": "meh, seems unnecessary. The whole method is about setting up the distribution; it seems arbitrary to move some of that into another method.", "author": "zentol", "createdAt": "2020-03-04T12:36:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYxNTA0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYyMDU2NQ==", "url": "https://github.com/apache/flink/pull/11285#discussion_r387620565", "bodyText": "Does it mean that running e2e tests from IDE will always need to set distDir manually?", "author": "azagrebin", "createdAt": "2020-03-04T11:58:19Z", "path": "flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/flink/LocalStandaloneFlinkResourceFactory.java", "diffHunk": "@@ -29,9 +33,21 @@\n public final class LocalStandaloneFlinkResourceFactory implements FlinkResourceFactory {\n \tprivate static final Logger LOG = LoggerFactory.getLogger(LocalStandaloneFlinkResourceFactory.class);\n \n+\tprivate static final ParameterProperty<Path> DISTRIBUTION_DIRECTORY = new ParameterProperty<>(\"distDir\", Paths::get);\n+\tprivate static final ParameterProperty<Path> DISTRIBUTION_LOG_BACKUP_DIRECTORY = new ParameterProperty<>(\"logBackupDir\", Paths::get);\n+\n \t@Override\n \tpublic Optional<FlinkResource> create(FlinkResourceSetup setup) {\n+\t\tOptional<Path> distributionDirectory = DISTRIBUTION_DIRECTORY.get();\n+\t\tif (!distributionDirectory.isPresent()) {\n+\t\t\tLOG.warn(\"The distDir property was not set. You can set it when running maven via -DdistDir=<path> .\");", "originalCommit": "281fa884afd6a76ece952ce5245227fec2d86bce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYzNTkyNg==", "url": "https://github.com/apache/flink/pull/11285#discussion_r387635926", "bodyText": "yes, this isn't new.", "author": "zentol", "createdAt": "2020-03-04T12:31:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYyMDU2NQ=="}], "type": "inlineReview"}, {"oid": "275e0876a79f4016bccd0f2c8c3c5dc76bc4b85f", "url": "https://github.com/apache/flink/commit/275e0876a79f4016bccd0f2c8c3c5dc76bc4b85f", "message": "[FLINK-16189][e2e] Remove test logic from FlinkDistribution\n\nThe FlinkDistribution is now a simple wrapper, which makes it easier to use in ways that do not match the jUnit resource life-cycle.", "committedDate": "2020-03-04T12:37:21Z", "type": "commit"}, {"oid": "22ee00c4ac414fc6546ce4bd5158a1fb745b2947", "url": "https://github.com/apache/flink/commit/22ee00c4ac414fc6546ce4bd5158a1fb745b2947", "message": "address comments", "committedDate": "2020-03-04T12:37:21Z", "type": "commit"}, {"oid": "22ee00c4ac414fc6546ce4bd5158a1fb745b2947", "url": "https://github.com/apache/flink/commit/22ee00c4ac414fc6546ce4bd5158a1fb745b2947", "message": "address comments", "committedDate": "2020-03-04T12:37:21Z", "type": "forcePushed"}]}