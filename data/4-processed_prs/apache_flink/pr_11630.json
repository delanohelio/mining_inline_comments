{"pr_number": 11630, "pr_title": "[FLINK-16921][e2e] Describe all resources and show pods logs before cleanup when failed", "pr_createdAt": "2020-04-04T04:36:45Z", "pr_url": "https://github.com/apache/flink/pull/11630", "timeline": [{"oid": "9a9073f279a1bc2bb44352199134c372825cb769", "url": "https://github.com/apache/flink/commit/9a9073f279a1bc2bb44352199134c372825cb769", "message": "[FLINK-16921][e2e] Describe all resources and show pods logs before cleanup when failed\n\nThe pods may be pending because of not enough resources, disk pressure, or other problems. Then wait_rest_endpoint_up will timeout. Describing all resources will help to debug these problems.", "committedDate": "2020-04-04T02:00:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ0MjE4Nw==", "url": "https://github.com/apache/flink/pull/11630#discussion_r403442187", "bodyText": "If this also doesn't help, I used these commands for debugging the k8s the last time it was unstable:\nkubectl get pods -o json -n kube-system\nkubectl get pods -o json\nkubectl get events -o json\nkubectl get deployments -o json\nkubectl describe pods\nkubectl describe nodes\nkubectl get nodes -o json", "author": "rmetzger", "createdAt": "2020-04-04T08:20:15Z", "path": "flink-end-to-end-tests/test-scripts/common_kubernetes.sh", "diffHunk": "@@ -114,10 +114,11 @@ function stop_kubernetes {\n     fi\n }\n \n-function debug_copy_and_show_logs {\n+function debug_and_show_logs {\n     echo \"Debugging failed Kubernetes test:\"\n     echo \"Currently existing Kubernetes resources\"\n     kubectl get all\n+    kubectl describe all", "originalCommit": "9a9073f279a1bc2bb44352199134c372825cb769", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ0MjI4MQ==", "url": "https://github.com/apache/flink/pull/11630#discussion_r403442281", "bodyText": "I recently got to know bash traps, which are basically signal handlers.\nYou can do trap debug_and_show_logs EXIT, which will run debug_and_show_logs whenever the script exists.", "author": "rmetzger", "createdAt": "2020-04-04T08:21:30Z", "path": "flink-end-to-end-tests/test-scripts/test_kubernetes_embedded_job.sh", "diffHunk": "@@ -49,7 +54,4 @@ kubectl wait --for=condition=complete job/flink-job-cluster --timeout=1h\n kubectl cp `kubectl get pods | awk '/task-manager/ {print $1}'`:/cache/${OUTPUT_FILE} ${OUTPUT_VOLUME}/${OUTPUT_FILE}\n \n check_result_hash \"WordCount\" ${OUTPUT_VOLUME}/${OUTPUT_FILE} \"${RESULT_HASH}\"\n-\n-if [ $? != 0 ];then\n-  debug_copy_and_show_logs\n-fi\n+SUCCEEDED=$?", "originalCommit": "9a9073f279a1bc2bb44352199134c372825cb769", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ2Mjc0Ng==", "url": "https://github.com/apache/flink/pull/11630#discussion_r403462746", "bodyText": "We have already use the on_exit cleanup in common_kubernetes.sh. So i put the debug_and_show_logs in cleanup, it will always be called before the script exits.", "author": "wangyang0918", "createdAt": "2020-04-04T12:08:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ0MjI4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ2NDA4MQ==", "url": "https://github.com/apache/flink/pull/11630#discussion_r403464081", "bodyText": "True. You could register on_exit debug_and_show_logs before sourcing common_kubernetes.sh.\nBut I'm fine with your solution. I just wanted to mention it so that you know it exists :)", "author": "rmetzger", "createdAt": "2020-04-04T12:22:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQ0MjI4MQ=="}], "type": "inlineReview"}]}