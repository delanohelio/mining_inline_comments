{"pr_number": 14393, "pr_title": "[FLINK-20605][coordination] Rework cancellation of slot allocation futures", "pr_createdAt": "2020-12-15T16:57:37Z", "pr_url": "https://github.com/apache/flink/pull/14393", "timeline": [{"oid": "247eab048294c9e6c6a9ecf887d986d45cc779a3", "url": "https://github.com/apache/flink/commit/247eab048294c9e6c6a9ecf887d986d45cc779a3", "message": "[hotfix][coordination] Ease debugging of errors during slot allocation\n\nWhen transitioning from PENDING to ALLOCATED we now first verify that the job ID is matching because this is a more serious issues.\nFurthermore, if either the slot state of job ID conditions are not met we now print  better error messages.\n\nFinally, log the state transitions of all slots.", "committedDate": "2020-12-15T16:54:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQxMjQyMQ==", "url": "https://github.com/apache/flink/pull/14393#discussion_r544412421", "bodyText": "Do we still have to distinguish between CancellationException and others in the else branch?", "author": "tillrohrmann", "createdAt": "2020-12-16T15:53:59Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/resourcemanager/slotmanager/DeclarativeSlotManager.java", "diffHunk": "@@ -505,17 +496,12 @@ private void allocateSlot(TaskManagerSlotInformation taskManagerSlot, JobID jobI\n \t\t\tresourceManagerId,\n \t\t\ttaskManagerRequestTimeout);\n \n-\t\trequestFuture.whenComplete(\n+\t\tCompletableFuture<Void> slotAllocationResponseProcessingFuture = requestFuture.handleAsync(\n \t\t\t(Acknowledge acknowledge, Throwable throwable) -> {\n-\t\t\t\tif (acknowledge != null) {\n-\t\t\t\t\tcompletableFuture.complete(acknowledge);\n-\t\t\t\t} else {\n-\t\t\t\t\tcompletableFuture.completeExceptionally(throwable);\n+\t\t\t\tif (!pendingSlotAllocations.contains(slotId)) {\n+\t\t\t\t\tLOG.debug(\"Ignoring slot allocation update from task executor {} for slot {} and job {}, because the allocation was already completed or cancelled.\", instanceId, slotId, jobId);\n+\t\t\t\t\treturn null;\n \t\t\t\t}\n-\t\t\t});\n-\n-\t\tCompletableFuture<Void> slotAllocationResponseProcessingFuture = completableFuture.handleAsync(\n-\t\t\t(Acknowledge acknowledge, Throwable throwable) -> {\n \t\t\t\tif (acknowledge != null) {\n \t\t\t\t\tLOG.trace(\"Completed allocation of slot {} for job {}.\", slotId, jobId);\n \t\t\t\t\tslotTracker.notifyAllocationComplete(slotId, jobId);", "originalCommit": "e449ce26f5e0b80a6e46810bbbffc19d09f5f59b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDY3NzgyNg==", "url": "https://github.com/apache/flink/pull/14393#discussion_r544677826", "bodyText": "hmmmm.....no, it should no longer be possible for the future to be canceled.", "author": "zentol", "createdAt": "2020-12-16T22:45:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQxMjQyMQ=="}], "type": "inlineReview"}, {"oid": "713bd7a1f1896b1a8999ca08dfa5661158408b0f", "url": "https://github.com/apache/flink/commit/713bd7a1f1896b1a8999ca08dfa5661158408b0f", "message": "Remove CancellationException block", "committedDate": "2020-12-17T10:55:52Z", "type": "forcePushed"}, {"oid": "0d433649f8b04bb456aeaf28fd13dfa82cbea936", "url": "https://github.com/apache/flink/commit/0d433649f8b04bb456aeaf28fd13dfa82cbea936", "message": "[FLINK-20605][coordination] Rework cancellation of slot allocation futures\n\nThe previous approach did not properly because it could happen that the future has been completed at the time it is being cancelled (e.g., because the corresponding task\n executor was unregistered). This order of events can happen since the processing of the allocation is done asynchronously, and can be scheduled after any other event.\nThis caused the processing to run although we expected this not too happen, resulting in various errors, including:\n- completing an allocation despite being shut down\n- completing an allocation despite the task executor not being registered anymore\n- completing an allocation despite the slot report already having reporter a slot as allocated", "committedDate": "2020-12-17T15:16:29Z", "type": "commit"}, {"oid": "0d433649f8b04bb456aeaf28fd13dfa82cbea936", "url": "https://github.com/apache/flink/commit/0d433649f8b04bb456aeaf28fd13dfa82cbea936", "message": "[FLINK-20605][coordination] Rework cancellation of slot allocation futures\n\nThe previous approach did not properly because it could happen that the future has been completed at the time it is being cancelled (e.g., because the corresponding task\n executor was unregistered). This order of events can happen since the processing of the allocation is done asynchronously, and can be scheduled after any other event.\nThis caused the processing to run although we expected this not too happen, resulting in various errors, including:\n- completing an allocation despite being shut down\n- completing an allocation despite the task executor not being registered anymore\n- completing an allocation despite the slot report already having reporter a slot as allocated", "committedDate": "2020-12-17T15:16:29Z", "type": "forcePushed"}]}