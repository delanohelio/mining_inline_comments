{"pr_number": 12028, "pr_title": "[FLINK-17553][table]fix plan error when constant exists in group window key", "pr_createdAt": "2020-05-08T06:10:43Z", "pr_url": "https://github.com/apache/flink/pull/12028", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTcyNjQ1MQ==", "url": "https://github.com/apache/flink/pull/12028#discussion_r429726451", "bodyText": "please give a more clear comment here", "author": "godfreyhe", "createdAt": "2020-05-25T04:27:03Z", "path": "flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/plan/rules/FlinkStreamRuleSets.scala", "diffHunk": "@@ -109,6 +109,8 @@ object FlinkStreamRuleSets {\n       List(\n         //removes constant keys from an Agg\n         AggregateProjectPullUpConstantsRule.INSTANCE,\n+        //fix: FLINK-17553", "originalCommit": "e51960bfa9933fc5515fde87896dbee100ef41f8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "16ddb21da79c3369bb7b7cbc6634ae3eed27b2e1", "url": "https://github.com/apache/flink/commit/16ddb21da79c3369bb7b7cbc6634ae3eed27b2e1", "message": "[FLINK-17553][table]fix plan error when constant exists in group window key", "committedDate": "2020-05-25T05:53:09Z", "type": "commit"}, {"oid": "004b3125aaed2507a0b3047e8bdc3d83fab2314c", "url": "https://github.com/apache/flink/commit/004b3125aaed2507a0b3047e8bdc3d83fab2314c", "message": "modify comment more", "committedDate": "2020-05-25T06:26:53Z", "type": "commit"}, {"oid": "5ffb28916f4d997ff9294f2df87389c79a7d1951", "url": "https://github.com/apache/flink/commit/5ffb28916f4d997ff9294f2df87389c79a7d1951", "message": "add itcase to verify fix work normally", "committedDate": "2020-05-25T06:37:28Z", "type": "commit"}, {"oid": "5ffb28916f4d997ff9294f2df87389c79a7d1951", "url": "https://github.com/apache/flink/commit/5ffb28916f4d997ff9294f2df87389c79a7d1951", "message": "add itcase to verify fix work normally", "committedDate": "2020-05-25T06:37:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDEzNDQxMg==", "url": "https://github.com/apache/flink/pull/12028#discussion_r430134412", "bodyText": "nit: redundant empty line", "author": "godfreyhe", "createdAt": "2020-05-26T03:08:59Z", "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/runtime/stream/sql/WindowAggregateITCase.scala", "diffHunk": "@@ -319,6 +319,49 @@ class WindowAggregateITCase(mode: StateBackendMode)\n     assertEquals(expected.sorted, sink.getRetractResults.sorted)\n   }\n \n+  // used to verify compile works normally when constants exists in group window key (FLINK-17553)\n+  @Test\n+  def testWindowAggregateOnConstantValue(): Unit = {\n+    val ddl1 =\n+      \"\"\"\n+        |CREATE TABLE src (\n+        |  log_ts STRING,\n+        |  ts TIMESTAMP(3),\n+        |  a INT,\n+        |  b DOUBLE,\n+        |  rowtime AS CAST(log_ts AS TIMESTAMP(3)),\n+        |  WATERMARK FOR rowtime AS rowtime - INTERVAL '0.001' SECOND\n+        |) WITH (\n+        |  'connector' = 'COLLECTION',\n+        |  'is-bounded' = 'false'\n+        |)\n+      \"\"\".stripMargin\n+    val ddl2 =\n+      \"\"\"\n+        |CREATE TABLE dst (\n+        |  ts TIMESTAMP(3),\n+        |  a BIGINT,\n+        |  b DOUBLE\n+        |) WITH (\n+        |  'connector.type' = 'filesystem',\n+        |  'connector.path' = '/tmp/1',\n+        |  'format.type' = 'csv'\n+        |)\n+      \"\"\".stripMargin\n+    val query =\n+      \"\"\"\n+        |INSERT INTO dst\n+        |SELECT TUMBLE_END(rowtime, INTERVAL '0.003' SECOND), COUNT(ts), SUM(b)\n+        |FROM src\n+        | GROUP BY 'a', TUMBLE(rowtime, INTERVAL '0.003' SECOND)\n+      \"\"\".stripMargin\n+    tEnv.sqlUpdate(ddl1)\n+    tEnv.sqlUpdate(ddl2)\n+    tEnv.sqlUpdate(query)\n+    tEnv.explain(true)\n+  }\n+", "originalCommit": "5ffb28916f4d997ff9294f2df87389c79a7d1951", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDEzNjk5NQ==", "url": "https://github.com/apache/flink/pull/12028#discussion_r430136995", "bodyText": "add the following sentence: this rule will merge the project generated by AggregateProjectPullUpConstantsRule and make sure window aggregate can be correctly rewritten by StreamLogicalWindowAggregateRule", "author": "godfreyhe", "createdAt": "2020-05-26T03:22:15Z", "path": "flink-table/flink-table-planner-blink/src/main/scala/org/apache/flink/table/planner/plan/rules/FlinkStreamRuleSets.scala", "diffHunk": "@@ -109,6 +109,8 @@ object FlinkStreamRuleSets {\n       List(\n         //removes constant keys from an Agg\n         AggregateProjectPullUpConstantsRule.INSTANCE,\n+        //fix: FLINK-17553 unsupported call error when constant exists in group window key\n+        ProjectMergeRule.INSTANCE,", "originalCommit": "5ffb28916f4d997ff9294f2df87389c79a7d1951", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "86e04bf10b62c7dd52655fc8a20340c3c0ba4d38", "url": "https://github.com/apache/flink/commit/86e04bf10b62c7dd52655fc8a20340c3c0ba4d38", "message": "modify code style and address comments", "committedDate": "2020-05-26T03:32:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg0MjA1MA==", "url": "https://github.com/apache/flink/pull/12028#discussion_r433842050", "bodyText": "I think we should verify the result, otherwise, it doesn't need to be added to ITCase.", "author": "wuchong", "createdAt": "2020-06-02T12:37:56Z", "path": "flink-table/flink-table-planner-blink/src/test/scala/org/apache/flink/table/planner/runtime/stream/sql/WindowAggregateITCase.scala", "diffHunk": "@@ -319,6 +319,48 @@ class WindowAggregateITCase(mode: StateBackendMode)\n     assertEquals(expected.sorted, sink.getRetractResults.sorted)\n   }\n \n+  // used to verify compile works normally when constants exists in group window key (FLINK-17553)\n+  @Test\n+  def testWindowAggregateOnConstantValue(): Unit = {\n+    val ddl1 =\n+      \"\"\"\n+        |CREATE TABLE src (\n+        |  log_ts STRING,\n+        |  ts TIMESTAMP(3),\n+        |  a INT,\n+        |  b DOUBLE,\n+        |  rowtime AS CAST(log_ts AS TIMESTAMP(3)),\n+        |  WATERMARK FOR rowtime AS rowtime - INTERVAL '0.001' SECOND\n+        |) WITH (\n+        |  'connector' = 'COLLECTION',\n+        |  'is-bounded' = 'false'\n+        |)\n+      \"\"\".stripMargin\n+    val ddl2 =\n+      \"\"\"\n+        |CREATE TABLE dst (\n+        |  ts TIMESTAMP(3),\n+        |  a BIGINT,\n+        |  b DOUBLE\n+        |) WITH (\n+        |  'connector.type' = 'filesystem',\n+        |  'connector.path' = '/tmp/1',\n+        |  'format.type' = 'csv'\n+        |)\n+      \"\"\".stripMargin\n+    val query =\n+      \"\"\"\n+        |INSERT INTO dst\n+        |SELECT TUMBLE_END(rowtime, INTERVAL '0.003' SECOND), COUNT(ts), SUM(b)\n+        |FROM src\n+        | GROUP BY 'a', TUMBLE(rowtime, INTERVAL '0.003' SECOND)\n+      \"\"\".stripMargin\n+    tEnv.sqlUpdate(ddl1)\n+    tEnv.sqlUpdate(ddl2)\n+    tEnv.sqlUpdate(query)\n+    tEnv.explain(true)", "originalCommit": "86e04bf10b62c7dd52655fc8a20340c3c0ba4d38", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQxNTIxMA==", "url": "https://github.com/apache/flink/pull/12028#discussion_r434415210", "bodyText": "Agreed.  Thanks for you suggestion.\nHere I just want to verify that explain work normally instead of checking the result, but I don't find  a proper test file to place it. Which file would you suggest me to place?", "author": "zjuwangg", "createdAt": "2020-06-03T08:58:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg0MjA1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQxODM3Nw==", "url": "https://github.com/apache/flink/pull/12028#discussion_r434418377", "bodyText": "I would suggest to verify the result. Because you already added a plan test.\nYou can use the following to verify the result.\nval sink = new TestingAppendSink\ntEnv.sqlQuery(sql).toAppendStream[Row].addSink(sink)\nenv.execute()", "author": "wuchong", "createdAt": "2020-06-03T09:03:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg0MjA1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY2NjMyMQ==", "url": "https://github.com/apache/flink/pull/12028#discussion_r435666321", "bodyText": "I got your meaning.", "author": "zjuwangg", "createdAt": "2020-06-05T03:08:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzg0MjA1MA=="}], "type": "inlineReview"}, {"oid": "e8a455a8cc508ab9f8b9d28bfe4e4548709dd93a", "url": "https://github.com/apache/flink/commit/e8a455a8cc508ab9f8b9d28bfe4e4548709dd93a", "message": "update WindowAggreateITCase#testWindowAggregateOnConstantValue to check the result", "committedDate": "2020-06-05T03:24:32Z", "type": "commit"}]}