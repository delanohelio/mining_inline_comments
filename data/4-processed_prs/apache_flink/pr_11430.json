{"pr_number": 11430, "pr_title": "[FLINK-16633][AZP] Fix builds without s3 credentials", "pr_createdAt": "2020-03-17T17:10:40Z", "pr_url": "https://github.com/apache/flink/pull/11430", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg1Nzk2NQ==", "url": "https://github.com/apache/flink/pull/11430#discussion_r393857965", "bodyText": "Add a simple utility function boolean isNotEmpty(@Nullable String) that you call 3 times. This is both more readable and would've prevented bugs like in the second line below where S3_TEST_SECRET_KEY.isEmpty() is missing a negation.", "author": "zentol", "createdAt": "2020-03-17T17:42:41Z", "path": "flink-test-utils-parent/flink-test-utils-junit/src/main/java/org/apache/flink/testutils/s3/S3TestCredentials.java", "diffHunk": "@@ -44,7 +44,8 @@\n \t * of this JVM.\n \t */\n \tpublic static boolean credentialsAvailable() {\n-\t\treturn S3_TEST_BUCKET != null && S3_TEST_ACCESS_KEY != null && S3_TEST_SECRET_KEY != null;", "originalCommit": "25282859e69411e8320cb694679c1404921b5305", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE0MDI5NQ==", "url": "https://github.com/apache/flink/pull/11430#discussion_r394140295", "bodyText": "Thanks a lot. That's a very good idea :)", "author": "rmetzger", "createdAt": "2020-03-18T07:06:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg1Nzk2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg1ODg2Nw==", "url": "https://github.com/apache/flink/pull/11430#discussion_r393858867", "bodyText": "So this was completely broken from the start?", "author": "zentol", "createdAt": "2020-03-17T17:44:05Z", "path": "tools/azure-pipelines/jobs-template.yml", "diffHunk": "@@ -123,9 +123,9 @@ jobs:\n   - script: STAGE=test ${{parameters.environment}} ./tools/azure_controller.sh $(module)\n     displayName: Test - $(module)\n     env:\n-      IT_CASE_S3_BUCKET: $(IT_CASE_S3_BUCKET)\n-      IT_CASE_S3_ACCESS_KEY: $(IT_CASE_S3_ACCESS_KEY)\n-      IT_CASE_S3_SECRET_KEY: $(IT_CASE_S3_SECRET_KEY)\n+      IT_CASE_S3_BUCKET: ${{variables['IT_CASE_S3_BUCKET']}}", "originalCommit": "25282859e69411e8320cb694679c1404921b5305", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDEzODExNg==", "url": "https://github.com/apache/flink/pull/11430#discussion_r394138116", "bodyText": "Yes  :( I did not test this w/o credentials set.", "author": "rmetzger", "createdAt": "2020-03-18T06:59:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg1ODg2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE2MTA0Nw==", "url": "https://github.com/apache/flink/pull/11430#discussion_r394161047", "bodyText": "let's make it private for no", "author": "zentol", "createdAt": "2020-03-18T07:58:09Z", "path": "flink-test-utils-parent/flink-test-utils-junit/src/main/java/org/apache/flink/testutils/s3/S3TestCredentials.java", "diffHunk": "@@ -44,7 +44,14 @@\n \t * of this JVM.\n \t */\n \tpublic static boolean credentialsAvailable() {\n-\t\treturn S3_TEST_BUCKET != null && S3_TEST_ACCESS_KEY != null && S3_TEST_SECRET_KEY != null;\n+\t\treturn isNotEmpty(S3_TEST_BUCKET) && isNotEmpty(S3_TEST_ACCESS_KEY) && isNotEmpty(S3_TEST_SECRET_KEY);\n+\t}\n+\n+\t/**\n+\t * Checks if a String is not null and not empty.\n+\t */\n+\tpublic static boolean isNotEmpty(@Nullable String str) {", "originalCommit": "4a2938805ce595d3263da2684bd8f44ff815ab36", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE2NDUxMA==", "url": "https://github.com/apache/flink/pull/11430#discussion_r394164510", "bodyText": "will do", "author": "rmetzger", "createdAt": "2020-03-18T08:06:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE2MTA0Nw=="}], "type": "inlineReview"}, {"oid": "85a7515407184f45009e7cbe7f6c7099ea4a41be", "url": "https://github.com/apache/flink/commit/85a7515407184f45009e7cbe7f6c7099ea4a41be", "message": "[FLINK-16633][AZP] Fix builds without s3 credentials\n\nProblem: Builds on Azure where failing if S3 credentails were not provided, because the syntax in the pipeline definition was incorrect.\n\nSolution: Use a way to access secret variables that leads to an empty value (instead of the variable name). Also, extend the check in the unit tests to \"variable empty\" instead of just \"variable not set\".", "committedDate": "2020-03-19T14:23:41Z", "type": "commit"}, {"oid": "85a7515407184f45009e7cbe7f6c7099ea4a41be", "url": "https://github.com/apache/flink/commit/85a7515407184f45009e7cbe7f6c7099ea4a41be", "message": "[FLINK-16633][AZP] Fix builds without s3 credentials\n\nProblem: Builds on Azure where failing if S3 credentails were not provided, because the syntax in the pipeline definition was incorrect.\n\nSolution: Use a way to access secret variables that leads to an empty value (instead of the variable name). Also, extend the check in the unit tests to \"variable empty\" instead of just \"variable not set\".", "committedDate": "2020-03-19T14:23:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE3MzI1MQ==", "url": "https://github.com/apache/flink/pull/11430#discussion_r395173251", "bodyText": "Were you not trying $[variables.IT_CASE_S3_BUCKET] in your original post? what else had to be change for things to work?", "author": "zentol", "createdAt": "2020-03-19T16:51:06Z", "path": "azure-pipelines.yml", "diffHunk": "@@ -40,13 +40,19 @@ resources:\n   - container: flink-build-container\n     image: rmetzger/flink-ci:ubuntu-amd64-3528acd\n \n-# See tools/azure-pipelines/jobs-template.yml for a short summary of the caching\n+# Define variables:\n+# - See tools/azure-pipelines/jobs-template.yml for a short summary of the caching\n+# - See https://stackoverflow.com/questions/60742105/how-can-i-access-a-secret-value-from-an-azure-pipelines-expression", "originalCommit": "85a7515407184f45009e7cbe7f6c7099ea4a41be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE5NjA0NQ==", "url": "https://github.com/apache/flink/pull/11430#discussion_r395196045", "bodyText": "Currently on master, we have the $(variables.IT_CASE_S3_BUCKET) syntax, which, returns the variable, or $(variables.IT_CASE_S3_BUCKET) if nothing is set.\nWhat I first proposed in the PR was $[variables.IT_CASE_S3_BUCKET], which is always empty, if you use it in the env block of a task.\nNow, I use this weird workaround of defining the variables in the pipeline definion.\nI don't think this behavior is very intuitive.\nhttps://docs.microsoft.com/en-us/azure/devops/pipelines/process/variables?view=azure-devops&tabs=yaml%2Cbatch", "author": "rmetzger", "createdAt": "2020-03-19T17:24:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE3MzI1MQ=="}], "type": "inlineReview"}]}