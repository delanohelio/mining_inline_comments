{"pr_number": 13878, "pr_title": "[FLINK-19924][config] Disallow UC for iterative jobs", "pr_createdAt": "2020-11-02T10:21:37Z", "pr_url": "https://github.com/apache/flink/pull/13878", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg3NTIzMQ==", "url": "https://github.com/apache/flink/pull/13878#discussion_r515875231", "bodyText": "You probably need to generate docs and add them to this commit.\n mvn install -Dgenerate-config-docs -pl flink-docs", "author": "AHeise", "createdAt": "2020-11-02T10:26:56Z", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/environment/ExecutionCheckpointingOptions.java", "diffHunk": "@@ -159,4 +159,12 @@\n \t\t\t\t\t\"If during checkpointing, checkpoint start delay exceeds this timeout, alignment \" +\n \t\t\t\t\t\"will timeout and checkpoint barrier will start working as unaligned checkpoint.\")\n \t\t\t\t.build());\n+\n+\tpublic static final ConfigOption<Boolean> FORCE_UNALIGNED =", "originalCommit": "3d255dc9980995cb82f157e28876a41092b64fe9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTkzMjY5Mg==", "url": "https://github.com/apache/flink/pull/13878#discussion_r515932692", "bodyText": "Done.", "author": "rkhachatryan", "createdAt": "2020-11-02T12:17:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg3NTIzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg3NTcyNQ==", "url": "https://github.com/apache/flink/pull/13878#discussion_r515875725", "bodyText": "The first getter looks odd. At least the description and tags are wrong.", "author": "AHeise", "createdAt": "2020-11-02T10:27:47Z", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/environment/StreamExecutionEnvironment.java", "diffHunk": "@@ -524,6 +524,28 @@ public boolean isForceCheckpointing() {\n \t\treturn checkpointCfg.isForceCheckpointing();\n \t}\n \n+\t/**\n+\t * Returns whether Unaligned Checkpoints are force-enabled.\n+\t *\n+\t * @deprecated Forcing Unaligned Checkpoints will be removed in future version.\n+\t */\n+\t@Deprecated\n+\t@PublicEvolving\n+\tpublic boolean isUnalignedCheckpointsEnabled() {\n+\t\treturn checkpointCfg.isUnalignedCheckpointsEnabled();\n+\t}\n+", "originalCommit": "3d255dc9980995cb82f157e28876a41092b64fe9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg3NjM2NA==", "url": "https://github.com/apache/flink/pull/13878#discussion_r515876364", "bodyText": "I'd not deprecate it at this point. I see it decoupled from the deprecation of forcing checkpoints.", "author": "AHeise", "createdAt": "2020-11-02T10:28:45Z", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/environment/StreamExecutionEnvironment.java", "diffHunk": "@@ -524,6 +524,28 @@ public boolean isForceCheckpointing() {\n \t\treturn checkpointCfg.isForceCheckpointing();\n \t}\n \n+\t/**\n+\t * Returns whether Unaligned Checkpoints are force-enabled.\n+\t *\n+\t * @deprecated Forcing Unaligned Checkpoints will be removed in future version.\n+\t */\n+\t@Deprecated\n+\t@PublicEvolving\n+\tpublic boolean isUnalignedCheckpointsEnabled() {\n+\t\treturn checkpointCfg.isUnalignedCheckpointsEnabled();\n+\t}\n+\n+\t/**\n+\t * Returns whether Unaligned Checkpoints are force-enabled.\n+\t *\n+\t * @deprecated Forcing checkpoints will be removed in future version.\n+\t */\n+\t@Deprecated", "originalCommit": "3d255dc9980995cb82f157e28876a41092b64fe9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg3NzEzMg==", "url": "https://github.com/apache/flink/pull/13878#discussion_r515877132", "bodyText": "Just to clarify: this is intended for failing late after the user has forced UC and then rescales, right?", "author": "AHeise", "createdAt": "2020-11-02T10:29:59Z", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamConfig.java", "diffHunk": "@@ -663,6 +664,14 @@ public boolean shouldSortInputs() {\n \t\treturn config.get(SORTED_INPUTS);\n \t}\n \n+\tpublic void setGraphContainingLoops(boolean graphContainingLoops) {\n+\t\tconfig.setBoolean(GRAPH_CONTAINING_LOOPS, graphContainingLoops);\n+\t}\n+\n+\tpublic boolean isGraphContainingLoops() {", "originalCommit": "f394642651c37a82c95bd59c5552f6464e94d824", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTkwNTU2Mw==", "url": "https://github.com/apache/flink/pull/13878#discussion_r515905563", "bodyText": "No, this is needed to disable restoring channel state for iterative jobs (so they run normally without restoring or failing).", "author": "rkhachatryan", "createdAt": "2020-11-02T11:21:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg3NzEzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg4MDA5MQ==", "url": "https://github.com/apache/flink/pull/13878#discussion_r515880091", "bodyText": "I'd add more details similar to forcing checkpoints\n\n\"Unaligned Checkpoints are currently not supported for iterative jobs, as Flink cannot rescale from these checkpoints. \"\n+ \"\\nYou can force enable unaligned checkpoints if you don't intend to rescale: env.setForceUnalignedCheckpoints(true)\"", "author": "AHeise", "createdAt": "2020-11-02T10:35:12Z", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamingJobGraphGenerator.java", "diffHunk": "@@ -216,6 +216,9 @@ private void preValidate() {\n \t\t\t\t\t\t+ \"State checkpoints happen normally, but records in-transit during the snapshot will be lost upon failure. \"\n \t\t\t\t\t\t+ \"\\nThe user can force enable state checkpoints with the reduced guarantees by calling: env.enableCheckpointing(interval,true)\");\n \t\t\t}\n+\t\t\tif (streamGraph.isIterative() && !checkpointConfig.isForceUnalignedCheckpoints()) {\n+\t\t\t\tthrow new UnsupportedOperationException(\"Unaligned Checkpoints are currently not supported for iterative jobs\");", "originalCommit": "1a3c8b71bb5bb06638b01cad68cbf5c9ba59ce8d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTkzNjA5NA==", "url": "https://github.com/apache/flink/pull/13878#discussion_r515936094", "bodyText": "Done.", "author": "rkhachatryan", "createdAt": "2020-11-02T12:24:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg4MDA5MQ=="}], "type": "inlineReview"}, {"oid": "f00cf8809a7dce41c441fde3dffde5532548f58e", "url": "https://github.com/apache/flink/commit/f00cf8809a7dce41c441fde3dffde5532548f58e", "message": "[FLINK-19924][config] Disallow Unaligned Checkpoints for iterative jobs by default", "committedDate": "2020-11-02T12:16:31Z", "type": "forcePushed"}, {"oid": "457daf914d01f2f8b21d5141368ae0faf918e0e1", "url": "https://github.com/apache/flink/commit/457daf914d01f2f8b21d5141368ae0faf918e0e1", "message": "[FLINK-19924][config] Disallow Unaligned Checkpoints for iterative jobs by default", "committedDate": "2020-11-02T14:07:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjAwNjczNQ==", "url": "https://github.com/apache/flink/pull/13878#discussion_r516006735", "bodyText": "just noticed that you probably also need to adjust flink-python/pyflink/datastream/checkpoint_config.py", "author": "AHeise", "createdAt": "2020-11-02T14:26:02Z", "path": "flink-streaming-scala/src/main/scala/org/apache/flink/streaming/api/scala/StreamExecutionEnvironment.scala", "diffHunk": "@@ -881,6 +881,16 @@ class StreamExecutionEnvironment(javaEnv: JavaEnv) {\n   def registerCachedFile(filePath: String, name: String, executable: Boolean): Unit = {\n     javaEnv.registerCachedFile(filePath, name, executable)\n   }\n+\n+  /**\n+   * Returns whether Unaligned Checkpoints are enabled.\n+   */\n+  def isUnalignedCheckpointsEnabled: Boolean = javaEnv.isUnalignedCheckpointsEnabled\n+\n+  /**\n+   * Returns whether Unaligned Checkpoints are force-enabled.\n+   */\n+  def isForceUnalignedCheckpoints: Boolean = javaEnv.isForceUnalignedCheckpoints", "originalCommit": "aabf026fb07f0d439e8da17a8dec39f8d5f1a3ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE2NzA5OA==", "url": "https://github.com/apache/flink/pull/13878#discussion_r516167098", "bodyText": "Thanks, updated checkpoint_config.py too.", "author": "rkhachatryan", "createdAt": "2020-11-02T18:15:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjAwNjczNQ=="}], "type": "inlineReview"}, {"oid": "d82f13461fcb7fe573a1994e41fc282298156f82", "url": "https://github.com/apache/flink/commit/d82f13461fcb7fe573a1994e41fc282298156f82", "message": "[FLINK-19924][config] Add StreamConfig.isGraphContainingLoops\n\nThis allows subtasks to decide how to proceed with the recovery of\nchannel state.", "committedDate": "2020-11-02T18:14:23Z", "type": "forcePushed"}, {"oid": "cacd065dad27b5db28139605c97d923f168dfd98", "url": "https://github.com/apache/flink/commit/cacd065dad27b5db28139605c97d923f168dfd98", "message": "[FLINK-19924][config] Add StreamConfig.isGraphContainingLoops\n\nThis allows subtasks to decide how to proceed with the recovery of\nchannel state.", "committedDate": "2020-11-03T05:57:44Z", "type": "forcePushed"}, {"oid": "ad5bbf9f1dc80d6864e78e1bed110334ac044c31", "url": "https://github.com/apache/flink/commit/ad5bbf9f1dc80d6864e78e1bed110334ac044c31", "message": "[hotfix][config] Add env.isUnalignedCheckpointsEnabled() (java/scala/python)\n\nThe next commits adds a force option, so this method is needed for\nconsistency.", "committedDate": "2020-11-03T12:23:11Z", "type": "commit"}, {"oid": "5a4242b8317955b05f207b92795e5a68c44d912a", "url": "https://github.com/apache/flink/commit/5a4242b8317955b05f207b92795e5a68c44d912a", "message": "[FLINK-19924][config] Add an option to force Unaligned Checkpoints", "committedDate": "2020-11-03T12:23:11Z", "type": "commit"}, {"oid": "a62f23c729ea377b830353c3111bedd1bbc44777", "url": "https://github.com/apache/flink/commit/a62f23c729ea377b830353c3111bedd1bbc44777", "message": "[FLINK-19924][config] Disallow Unaligned Checkpoints for iterative jobs by default", "committedDate": "2020-11-03T12:23:11Z", "type": "commit"}, {"oid": "0954e7c3abc4ecb6d971ba1956c23138761df3c9", "url": "https://github.com/apache/flink/commit/0954e7c3abc4ecb6d971ba1956c23138761df3c9", "message": "[FLINK-19924][config] Add StreamConfig.isGraphContainingLoops\n\nThis allows subtasks to decide how to proceed with the recovery of\nchannel state.", "committedDate": "2020-11-03T12:23:11Z", "type": "commit"}, {"oid": "0954e7c3abc4ecb6d971ba1956c23138761df3c9", "url": "https://github.com/apache/flink/commit/0954e7c3abc4ecb6d971ba1956c23138761df3c9", "message": "[FLINK-19924][config] Add StreamConfig.isGraphContainingLoops\n\nThis allows subtasks to decide how to proceed with the recovery of\nchannel state.", "committedDate": "2020-11-03T12:23:11Z", "type": "forcePushed"}]}