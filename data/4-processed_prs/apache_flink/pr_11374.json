{"pr_number": 11374, "pr_title": "[FLINK-16524][python] Optimize the execution of Python UDF to use generator to eliminate unnecessary function calls", "pr_createdAt": "2020-03-11T07:59:06Z", "pr_url": "https://github.com/apache/flink/pull/11374", "timeline": [{"oid": "359627ab356c0998b9074f9cb062a9f73e4cf730", "url": "https://github.com/apache/flink/commit/359627ab356c0998b9074f9cb062a9f73e4cf730", "message": "[FLINK-16524][python] Optimize the result of FlattenRowCoder and ArrowCoder to generator to eliminate unnecessary function calls", "committedDate": "2020-03-11T14:47:29Z", "type": "forcePushed"}, {"oid": "ef45405e3baca296b9acdfb40308276535713fec", "url": "https://github.com/apache/flink/commit/ef45405e3baca296b9acdfb40308276535713fec", "message": "[FLINK-16524][python] Optimize the result of FlattenRowCoder and ArrowCoder to generator to eliminate unnecessary function calls", "committedDate": "2020-03-12T01:05:15Z", "type": "commit"}, {"oid": "ef45405e3baca296b9acdfb40308276535713fec", "url": "https://github.com/apache/flink/commit/ef45405e3baca296b9acdfb40308276535713fec", "message": "[FLINK-16524][python] Optimize the result of FlattenRowCoder and ArrowCoder to generator to eliminate unnecessary function calls", "committedDate": "2020-03-12T01:05:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk5OTE0OQ==", "url": "https://github.com/apache/flink/pull/11374#discussion_r391999149", "bodyText": "Could you rename _filed_count to _field_count? It's not directly related to this PR, however it would be great if we can correct the typo as it's used in this PR.", "author": "dianfu", "createdAt": "2020-03-13T02:32:45Z", "path": "flink-python/pyflink/fn_execution/coder_impl.py", "diffHunk": "@@ -51,18 +55,27 @@ def generate_null_mask_search_table():\n \n         return tuple(null_mask)\n \n-    def encode_to_stream(self, value, out_stream, nested):\n-        self.write_null_mask(value, out_stream)\n+    def encode_to_stream(self, iter_value, out_stream, nested):\n         field_coders = self._field_coders\n-        for i in range(self._filed_count):\n-            item = value[i]\n-            if item is not None:\n-                field_coders[i].encode_to_stream(item, out_stream, nested)\n+        data_out_stream = self.data_out_stream\n+        for value in iter_value:\n+            self.write_null_mask(value, data_out_stream)\n+            for i in range(self._filed_count):", "originalCommit": "ef45405e3baca296b9acdfb40308276535713fec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjAwNDQ1Mw==", "url": "https://github.com/apache/flink/pull/11374#discussion_r392004453", "bodyText": "rename to _decode_one_row_from_stream?", "author": "dianfu", "createdAt": "2020-03-13T02:55:56Z", "path": "flink-python/pyflink/fn_execution/coder_impl.py", "diffHunk": "@@ -51,18 +55,27 @@ def generate_null_mask_search_table():\n \n         return tuple(null_mask)\n \n-    def encode_to_stream(self, value, out_stream, nested):\n-        self.write_null_mask(value, out_stream)\n+    def encode_to_stream(self, iter_value, out_stream, nested):\n         field_coders = self._field_coders\n-        for i in range(self._filed_count):\n-            item = value[i]\n-            if item is not None:\n-                field_coders[i].encode_to_stream(item, out_stream, nested)\n+        data_out_stream = self.data_out_stream\n+        for value in iter_value:\n+            self.write_null_mask(value, data_out_stream)\n+            for i in range(self._filed_count):\n+                item = value[i]\n+                if item is not None:\n+                    field_coders[i].encode_to_stream(item, data_out_stream, nested)\n+            out_stream.write_var_int64(data_out_stream.size())\n+            out_stream.write(data_out_stream.get())\n+            data_out_stream._clear()\n \n     def decode_from_stream(self, in_stream, nested):\n+        while in_stream.size() > 0:\n+            yield self.create_result(in_stream, nested)\n+\n+    def create_result(self, in_stream: create_InputStream, nested: bool) -> List:", "originalCommit": "ef45405e3baca296b9acdfb40308276535713fec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjAwOTkxOQ==", "url": "https://github.com/apache/flink/pull/11374#discussion_r392009919", "bodyText": "rename to _decode_one_row_from_stream", "author": "dianfu", "createdAt": "2020-03-13T03:09:35Z", "path": "flink-python/pyflink/fn_execution/coder_impl.py", "diffHunk": "@@ -414,5 +446,28 @@ def create_array(s, t):\n         arrays = [create_array(cols[i], self._schema.types[i]) for i in range(0, len(self._schema))]\n         return pa.RecordBatch.from_arrays(arrays, self._schema)\n \n+    def _create_result(self, in_stream: create_InputStream) -> List:", "originalCommit": "ef45405e3baca296b9acdfb40308276535713fec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjAxMDYzNQ==", "url": "https://github.com/apache/flink/pull/11374#discussion_r392010635", "bodyText": "Could you help to correct the comments here?\nthere is only arrow batch -> there is only one arrow batch", "author": "dianfu", "createdAt": "2020-03-13T03:12:59Z", "path": "flink-python/pyflink/fn_execution/coder_impl.py", "diffHunk": "@@ -414,5 +446,28 @@ def create_array(s, t):\n         arrays = [create_array(cols[i], self._schema.types[i]) for i in range(0, len(self._schema))]\n         return pa.RecordBatch.from_arrays(arrays, self._schema)\n \n+    def _create_result(self, in_stream: create_InputStream) -> List:\n+        self._resettable_io.set_input_bytes(in_stream.read_all(True))\n+        # there is only arrow batch in the underlying input stream", "originalCommit": "ef45405e3baca296b9acdfb40308276535713fec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjAxMjcyOA==", "url": "https://github.com/apache/flink/pull/11374#discussion_r392012728", "bodyText": "decode_from_stream(in_stream, False) -> decode_from_stream(in_stream, nested) ?", "author": "dianfu", "createdAt": "2020-03-13T03:23:41Z", "path": "flink-python/pyflink/fn_execution/coder_impl.py", "diffHunk": "@@ -414,5 +446,28 @@ def create_array(s, t):\n         arrays = [create_array(cols[i], self._schema.types[i]) for i in range(0, len(self._schema))]\n         return pa.RecordBatch.from_arrays(arrays, self._schema)\n \n+    def _create_result(self, in_stream: create_InputStream) -> List:\n+        self._resettable_io.set_input_bytes(in_stream.read_all(True))\n+        # there is only arrow batch in the underlying input stream\n+        table = pa.Table.from_batches([next(self._batch_reader)])\n+        return [c.to_pandas(date_as_object=True) for c in table.itercolumns()]\n+\n     def __repr__(self):\n         return 'ArrowCoderImpl[%s]' % self._schema\n+\n+\n+class CustomLengthPrefixCoderImpl(StreamCoderImpl):\n+    def __init__(self, value_coder):\n+        self._value_coder = value_coder\n+\n+    def encode_to_stream(self, value, out: create_OutputStream, nested: bool) -> Any:\n+        self._value_coder.encode_to_stream(value, out, nested)\n+\n+    def decode_from_stream(self, in_stream: create_InputStream, nested: bool) -> Any:\n+        return self._value_coder.decode_from_stream(in_stream, False)", "originalCommit": "ef45405e3baca296b9acdfb40308276535713fec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjAxOTM4NQ==", "url": "https://github.com/apache/flink/pull/11374#discussion_r392019385", "bodyText": "What about rename it to PassThroughLengthPrefixCoder to reflect that it does nothing for the prefixed length?", "author": "dianfu", "createdAt": "2020-03-13T03:57:33Z", "path": "flink-python/pyflink/fn_execution/coders.py", "diffHunk": "@@ -414,6 +415,25 @@ def __repr__(self):\n         return 'ArrowCoder[%s]' % self._schema\n \n \n+class CustomLengthPrefixCoder(LengthPrefixCoder):", "originalCommit": "ef45405e3baca296b9acdfb40308276535713fec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjAyMDExMw==", "url": "https://github.com/apache/flink/pull/11374#discussion_r392020113", "bodyText": "Update the comment as following?\nCoder which doesn't prefix the length of the encoded object as the length prefix will be handled by the wrapped value coder.", "author": "dianfu", "createdAt": "2020-03-13T04:01:38Z", "path": "flink-python/pyflink/fn_execution/coders.py", "diffHunk": "@@ -414,6 +415,25 @@ def __repr__(self):\n         return 'ArrowCoder[%s]' % self._schema\n \n \n+class CustomLengthPrefixCoder(LengthPrefixCoder):\n+    \"\"\"\n+    CustomLengthPrefixCoder will replace LengthPrefixCoder in Beam for performance optimization.", "originalCommit": "ef45405e3baca296b9acdfb40308276535713fec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cfc11390372b448843424824e51a260b366d99a1", "url": "https://github.com/apache/flink/commit/cfc11390372b448843424824e51a260b366d99a1", "message": "[FLINK-16524][python] Optimize the result of FlattenRowCoder and ArrowCoder to generator to eliminate unnecessary function calls-fix-1", "committedDate": "2020-03-13T04:50:09Z", "type": "commit"}, {"oid": "944a7b2512fafecc560002d417b85f31c6e030dd", "url": "https://github.com/apache/flink/commit/944a7b2512fafecc560002d417b85f31c6e030dd", "message": "[FLINK-16524][python] Optimize the result of FlattenRowCoder and ArrowCoder to generator to eliminate unnecessary function calls-fix-2", "committedDate": "2020-03-13T06:47:08Z", "type": "commit"}]}