{"pr_number": 14410, "pr_title": "[FLINK-20616][python] Support row-based operation to accept user-defined function directly", "pr_createdAt": "2020-12-17T03:25:09Z", "pr_url": "https://github.com/apache/flink/pull/14410", "timeline": [{"oid": "872ad09e6fdbaca0abb420db2d86321a87f95b01", "url": "https://github.com/apache/flink/commit/872ad09e6fdbaca0abb420db2d86321a87f95b01", "message": "[FLINK-20616][python] Support row-based operation to accept user-defined function directly", "committedDate": "2020-12-17T03:20:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTczMzEzMg==", "url": "https://github.com/apache/flink/pull/14410#discussion_r545733132", "bodyText": "Could you addd some examples in the PythonDoc?", "author": "dianfu", "createdAt": "2020-12-18T10:13:37Z", "path": "flink-python/pyflink/table/table.py", "diffHunk": "@@ -759,7 +761,7 @@ def drop_columns(self, *fields: Union[str, Expression]) -> 'Table':\n             assert isinstance(fields[0], str)\n             return Table(self._j_table.dropColumns(fields[0]), self._t_env)\n \n-    def map(self, func: Union[str, Expression]) -> 'Table':\n+    def map(self, func: Union[str, Expression, UserDefinedScalarFunctionWrapper]) -> 'Table':", "originalCommit": "872ad09e6fdbaca0abb420db2d86321a87f95b01", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM0ODcyMA==", "url": "https://github.com/apache/flink/pull/14410#discussion_r546348720", "bodyText": "Yes. make sense.", "author": "HuangXingBo", "createdAt": "2020-12-20T09:22:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTczMzEzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTczMzIyMg==", "url": "https://github.com/apache/flink/pull/14410#discussion_r545733222", "bodyText": "ditto", "author": "dianfu", "createdAt": "2020-12-18T10:13:45Z", "path": "flink-python/pyflink/table/table.py", "diffHunk": "@@ -800,10 +804,13 @@ def flat_map(self, func: Union[str, Expression]) -> 'Table':\n         \"\"\"\n         if isinstance(func, str):\n             return Table(self._j_table.flatMap(func), self._t_env)\n-        else:\n+        elif isinstance(func, Expression):", "originalCommit": "872ad09e6fdbaca0abb420db2d86321a87f95b01", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTczNDAzMA==", "url": "https://github.com/apache/flink/pull/14410#discussion_r545734030", "bodyText": "one line?", "author": "dianfu", "createdAt": "2020-12-18T10:15:11Z", "path": "flink-python/pyflink/table/table.py", "diffHunk": "@@ -825,10 +832,19 @@ def aggregate(self, func: Union[str, Expression]) -> 'AggregatedTable':\n         \"\"\"\n         if isinstance(func, str):\n             return AggregatedTable(self._j_table.aggregate(func), self._t_env)\n-        else:\n+        elif isinstance(func, Expression):\n             return AggregatedTable(self._j_table.aggregate(func._j_expr), self._t_env)\n+        else:\n+            if hasattr(func, \"_alias_names\"):\n+                alias_names = getattr(func, \"_alias_names\")\n+                func = func(with_columns(col(\"*\"))).alias(*alias_names)\n+            else:\n+                func = func(with_columns(col(\"*\")))\n+            return AggregatedTable(self._j_table.aggregate(func._j_expr),", "originalCommit": "872ad09e6fdbaca0abb420db2d86321a87f95b01", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTc1OTE2NQ==", "url": "https://github.com/apache/flink/pull/14410#discussion_r545759165", "bodyText": "could be removed?", "author": "dianfu", "createdAt": "2020-12-18T11:02:31Z", "path": "flink-python/pyflink/table/table.py", "diffHunk": "@@ -1059,9 +1087,26 @@ def flat_aggregate(self, func: Union[str, Expression]) -> 'FlatAggregateTable':\n         \"\"\"\n         if isinstance(func, str):\n             return FlatAggregateTable(self._j_table.flatAggregate(func), self._t_env)\n+        elif isinstance(func, Expression):\n+            return FlatAggregateTable(self._j_table.flatAggregate(func._j_expr), self._t_env)\n         else:\n+            func = self._without_columns(func)\n             return FlatAggregateTable(self._j_table.flatAggregate(func._j_expr), self._t_env)\n \n+    def _without_columns(self, func: UserDefinedAggregateFunctionWrapper) -> Expression:\n+        get_gateway()", "originalCommit": "872ad09e6fdbaca0abb420db2d86321a87f95b01", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTc2MDk0Mg==", "url": "https://github.com/apache/flink/pull/14410#discussion_r545760942", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    without_keys = without_columns(\n          \n          \n            \n                    fields_without_keys = without_columns(", "author": "dianfu", "createdAt": "2020-12-18T11:05:54Z", "path": "flink-python/pyflink/table/table.py", "diffHunk": "@@ -1059,9 +1087,26 @@ def flat_aggregate(self, func: Union[str, Expression]) -> 'FlatAggregateTable':\n         \"\"\"\n         if isinstance(func, str):\n             return FlatAggregateTable(self._j_table.flatAggregate(func), self._t_env)\n+        elif isinstance(func, Expression):\n+            return FlatAggregateTable(self._j_table.flatAggregate(func._j_expr), self._t_env)\n         else:\n+            func = self._without_columns(func)\n             return FlatAggregateTable(self._j_table.flatAggregate(func._j_expr), self._t_env)\n \n+    def _without_columns(self, func: UserDefinedAggregateFunctionWrapper) -> Expression:\n+        get_gateway()\n+        group_keys_field = self._j_table.getClass().getDeclaredField(\"groupKeys\")\n+        group_keys_field.setAccessible(True)\n+        j_group_keys = group_keys_field.get(self._j_table)\n+        without_keys = without_columns(", "originalCommit": "872ad09e6fdbaca0abb420db2d86321a87f95b01", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTc2MTExMg==", "url": "https://github.com/apache/flink/pull/14410#discussion_r545761112", "bodyText": "could be removed?", "author": "dianfu", "createdAt": "2020-12-18T11:06:15Z", "path": "flink-python/pyflink/table/table.py", "diffHunk": "@@ -1165,9 +1211,30 @@ def aggregate(self, func: Union[str, Expression]) -> 'AggregatedTable':\n         \"\"\"\n         if isinstance(func, str):\n             return AggregatedTable(self._j_table.aggregate(func), self._t_env)\n+        elif isinstance(func, Expression):\n+            return AggregatedTable(self._j_table.aggregate(func._j_expr), self._t_env)\n         else:\n+            func = self._without_columns(func)\n             return AggregatedTable(self._j_table.aggregate(func._j_expr), self._t_env)\n \n+    def _without_columns(self, func: UserDefinedAggregateFunctionWrapper) -> Expression:\n+        get_gateway()", "originalCommit": "872ad09e6fdbaca0abb420db2d86321a87f95b01", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTc3MDQ4MA==", "url": "https://github.com/apache/flink/pull/14410#discussion_r545770480", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                def _without_columns(self, func: UserDefinedAggregateFunctionWrapper) -> Expression:\n          \n          \n            \n                def _to_expr(self, func: UserDefinedAggregateFunctionWrapper) -> Expression:", "author": "dianfu", "createdAt": "2020-12-18T11:25:14Z", "path": "flink-python/pyflink/table/table.py", "diffHunk": "@@ -1165,9 +1211,30 @@ def aggregate(self, func: Union[str, Expression]) -> 'AggregatedTable':\n         \"\"\"\n         if isinstance(func, str):\n             return AggregatedTable(self._j_table.aggregate(func), self._t_env)\n+        elif isinstance(func, Expression):\n+            return AggregatedTable(self._j_table.aggregate(func._j_expr), self._t_env)\n         else:\n+            func = self._without_columns(func)\n             return AggregatedTable(self._j_table.aggregate(func._j_expr), self._t_env)\n \n+    def _without_columns(self, func: UserDefinedAggregateFunctionWrapper) -> Expression:", "originalCommit": "872ad09e6fdbaca0abb420db2d86321a87f95b01", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTc4MDAzNw==", "url": "https://github.com/apache/flink/pull/14410#discussion_r545780037", "bodyText": "I guess .select(\"*\")  could be removed?", "author": "dianfu", "createdAt": "2020-12-18T11:45:44Z", "path": "flink-python/pyflink/table/tests/test_row_based_operation.py", "diffHunk": "@@ -125,9 +123,11 @@ def test_aggregate_with_pandas_udaf(self):\n                                [DataTypes.FIELD(\"a\", DataTypes.FLOAT()),\n                                 DataTypes.FIELD(\"b\", DataTypes.INT())]),\n                            func_type=\"pandas\")\n-        t.group_by(t.a) \\\n-            .aggregate(pandas_udaf(t.b).alias(\"c\", \"d\")) \\\n-            .select(\"a, c, d\").execute_insert(\"Results\") \\\n+        t.select(t.a, t.b) \\\n+            .group_by(t.a) \\\n+            .aggregate(pandas_udaf) \\\n+            .select(\"*\") \\", "originalCommit": "872ad09e6fdbaca0abb420db2d86321a87f95b01", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjM0ODkxMA==", "url": "https://github.com/apache/flink/pull/14410#discussion_r546348910", "bodyText": "AggregateTable need to call select method to convert to Table", "author": "HuangXingBo", "createdAt": "2020-12-20T09:24:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTc4MDAzNw=="}], "type": "inlineReview"}, {"oid": "c40710b468a239841a062702183352fbace8907a", "url": "https://github.com/apache/flink/commit/c40710b468a239841a062702183352fbace8907a", "message": "fix comments", "committedDate": "2020-12-20T09:25:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQ3ODg4Mw==", "url": "https://github.com/apache/flink/pull/14410#discussion_r546478883", "bodyText": "I think the keys should also be given to the row based function.", "author": "dianfu", "createdAt": "2020-12-21T02:26:29Z", "path": "flink-python/pyflink/table/table.py", "diffHunk": "@@ -1059,9 +1098,25 @@ def flat_aggregate(self, func: Union[str, Expression]) -> 'FlatAggregateTable':\n         \"\"\"\n         if isinstance(func, str):\n             return FlatAggregateTable(self._j_table.flatAggregate(func), self._t_env)\n+        elif isinstance(func, Expression):\n+            return FlatAggregateTable(self._j_table.flatAggregate(func._j_expr), self._t_env)\n         else:\n+            func = self._to_expr(func)\n             return FlatAggregateTable(self._j_table.flatAggregate(func._j_expr), self._t_env)\n \n+    def _to_expr(self, func: UserDefinedAggregateFunctionWrapper) -> Expression:\n+        group_keys_field = self._j_table.getClass().getDeclaredField(\"groupKeys\")\n+        group_keys_field.setAccessible(True)\n+        j_group_keys = group_keys_field.get(self._j_table)\n+        fields_without_keys = without_columns(\n+            j_group_keys[0], *([j_group_keys[i] for i in range(1, len(j_group_keys))]))\n+        if hasattr(func, \"alias_names\"):\n+            alias_names = getattr(func, \"alias_names\")\n+            func_expression = func(fields_without_keys).alias(*alias_names)", "originalCommit": "c40710b468a239841a062702183352fbace8907a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQ4MTgwNg==", "url": "https://github.com/apache/flink/pull/14410#discussion_r546481806", "bodyText": "For Row based operation, the row function should receive Row/DataFrame as input. Otherwise, the fields name information will be missing. This will become a problem when there are hundreds of columns. It may be difficult to use as users have to give each column a meaningful name.", "author": "dianfu", "createdAt": "2020-12-21T02:41:03Z", "path": "flink-python/pyflink/table/table.py", "diffHunk": "@@ -817,6 +828,8 @@ def aggregate(self, func: Union[str, Expression]) -> 'AggregatedTable':\n             ...                    DataTypes.FIELD(\"b\", DataTypes.INT())]),\n             ...               func_type=\"pandas\")\n             >>> tab.aggregate(agg(tab.a).alias(\"a\", \"b\")).select(\"a, b\")\n+            >>> # input all columns\n+            >>> tab.aggregate(agg.alias(\"a, b\")).select(\"a, b\")", "originalCommit": "c40710b468a239841a062702183352fbace8907a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjQ4NDIwMw==", "url": "https://github.com/apache/flink/pull/14410#discussion_r546484203", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        >>> # input all columns\n          \n          \n            \n                        >>> # take all the columns as inputs", "author": "dianfu", "createdAt": "2020-12-21T02:52:12Z", "path": "flink-python/pyflink/table/table.py", "diffHunk": "@@ -792,6 +798,8 @@ def flat_map(self, func: Union[str, Expression]) -> 'Table':\n             ...     for s in string.split(\",\"):\n             ...         yield x, s\n             >>> tab.flat_map(split(tab.a, table.b))\n+            >>> # input all columns", "originalCommit": "c40710b468a239841a062702183352fbace8907a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "aeb710b99fcabb7f95ad5627f9c7e636430eb30e", "url": "https://github.com/apache/flink/commit/aeb710b99fcabb7f95ad5627f9c7e636430eb30e", "message": "fix comments-2", "committedDate": "2020-12-21T09:58:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzAxNTExMg==", "url": "https://github.com/apache/flink/pull/14410#discussion_r547015112", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              bool used_in_row_based_operation = 4;\n          \n          \n            \n              bool takes_row_as_input = 4;", "author": "dianfu", "createdAt": "2020-12-22T01:25:51Z", "path": "flink-python/pyflink/proto/flink-fn-execution.proto", "diffHunk": "@@ -47,6 +47,9 @@ message UserDefinedFunction {\n \n   // The index of the over window used in pandas batch over window aggregation\n   int32 window_index = 3;\n+\n+  // Whether the UDF is used in row-based operation\n+  bool used_in_row_based_operation = 4;", "originalCommit": "aeb710b99fcabb7f95ad5627f9c7e636430eb30e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzAyNDEwNw==", "url": "https://github.com/apache/flink/pull/14410#discussion_r547024107", "bodyText": "Why there is no such flag for aggregate function?", "author": "dianfu", "createdAt": "2020-12-22T01:59:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzAxNTExMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzAxNTM2Ng==", "url": "https://github.com/apache/flink/pull/14410#discussion_r547015366", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              // Whether the UDF is used in row-based operation\n          \n          \n            \n              // Whether the UDF takes row as input instead of each columns of a row", "author": "dianfu", "createdAt": "2020-12-22T01:26:37Z", "path": "flink-python/pyflink/proto/flink-fn-execution.proto", "diffHunk": "@@ -47,6 +47,9 @@ message UserDefinedFunction {\n \n   // The index of the over window used in pandas batch over window aggregation\n   int32 window_index = 3;\n+\n+  // Whether the UDF is used in row-based operation", "originalCommit": "aeb710b99fcabb7f95ad5627f9c7e636430eb30e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzAxNjEzOQ==", "url": "https://github.com/apache/flink/pull/14410#discussion_r547016139", "bodyText": "I guess the example doesn't apply any more as the user-defined function should take Row as input. Should also update the other examples.", "author": "dianfu", "createdAt": "2020-12-22T01:29:21Z", "path": "flink-python/pyflink/table/table.py", "diffHunk": "@@ -769,6 +771,8 @@ def map(self, func: Union[str, Expression]) -> 'Table':\n             >>> add = udf(lambda x: Row(x + 1, x * x), result_type=DataTypes.Row(\n             ... [DataTypes.FIELD(\"a\", DataTypes.INT()), DataTypes.FIELD(\"b\", DataTypes.INT())]))\n             >>> tab.map(add(tab.a)).alias(\"a, b\")\n+            >>> # take all the columns as inputs\n+            >>> tab.map(add)", "originalCommit": "aeb710b99fcabb7f95ad5627f9c7e636430eb30e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzAxNzMwNw==", "url": "https://github.com/apache/flink/pull/14410#discussion_r547017307", "bodyText": "Could you also update the example in FlatAggregateTable.select/AggregatedTable.select to use row-based operations?", "author": "dianfu", "createdAt": "2020-12-22T01:34:00Z", "path": "flink-python/pyflink/table/table.py", "diffHunk": "@@ -1165,9 +1224,26 @@ def aggregate(self, func: Union[str, Expression]) -> 'AggregatedTable':\n         \"\"\"\n         if isinstance(func, str):\n             return AggregatedTable(self._j_table.aggregate(func), self._t_env)\n+        elif isinstance(func, Expression):\n+            return AggregatedTable(self._j_table.aggregate(func._j_expr), self._t_env)\n         else:\n+            func.set_used_in_row_based_operation()\n+            func = self._to_expr(func)\n             return AggregatedTable(self._j_table.aggregate(func._j_expr), self._t_env)\n \n+    def _to_expr(self, func: UserDefinedAggregateFunctionWrapper) -> Expression:\n+        group_window_field = self._j_table.getClass().getDeclaredField(\"window\")\n+        group_window_field.setAccessible(True)\n+        j_group_window = group_window_field.get(self._j_table)\n+        j_time_field = j_group_window.getTimeField()\n+        fields_without_window = without_columns(j_time_field)\n+        if hasattr(func, \"_alias_names\"):\n+            alias_names = getattr(func, \"_alias_names\")\n+            func_expression = func(fields_without_window).alias(*alias_names)\n+        else:\n+            func_expression = func(fields_without_window)\n+        return func_expression\n+\n ", "originalCommit": "aeb710b99fcabb7f95ad5627f9c7e636430eb30e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzAxNzc4Ng==", "url": "https://github.com/apache/flink/pull/14410#discussion_r547017786", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                def set_used_in_row_based_operation(self):\n          \n          \n            \n                def _set_takes_row_as_input(self):", "author": "dianfu", "createdAt": "2020-12-22T01:35:52Z", "path": "flink-python/pyflink/table/udf.py", "diffHunk": "@@ -348,11 +348,20 @@ def __init__(self, func, input_types, func_type, deterministic=None, name=None):\n             func.is_deterministic() if isinstance(func, UserDefinedFunction) else True)\n         self._func_type = func_type\n         self._judf_placeholder = None\n+        self._used_in_row_based_operation = False\n \n     def __call__(self, *args) -> Expression:\n         from pyflink.table import expressions as expr\n         return expr.call(self, *args)\n \n+    def alias(self, *alias_names: str):\n+        self._alias_names = alias_names\n+        return self\n+\n+    def set_used_in_row_based_operation(self):", "originalCommit": "aeb710b99fcabb7f95ad5627f9c7e636430eb30e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzAxOTIzMg==", "url": "https://github.com/apache/flink/pull/14410#discussion_r547019232", "bodyText": "What about putting self._used_in_row_based_operation after self._deterministic?", "author": "dianfu", "createdAt": "2020-12-22T01:41:34Z", "path": "flink-python/pyflink/table/udf.py", "diffHunk": "@@ -460,7 +470,8 @@ def _create_judf(self, serialized_func, j_input_types, j_function_kind):\n             j_result_type,\n             j_function_kind,\n             self._deterministic,\n-            _get_python_env())\n+            _get_python_env(),\n+            self._used_in_row_based_operation)", "originalCommit": "aeb710b99fcabb7f95ad5627f9c7e636430eb30e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzAyMDA5Nw==", "url": "https://github.com/apache/flink/pull/14410#discussion_r547020097", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                def alias(self, *alias_names: str):\n          \n          \n            \n                def _alias(self, *alias_names: str):", "author": "dianfu", "createdAt": "2020-12-22T01:44:54Z", "path": "flink-python/pyflink/table/udf.py", "diffHunk": "@@ -348,11 +348,20 @@ def __init__(self, func, input_types, func_type, deterministic=None, name=None):\n             func.is_deterministic() if isinstance(func, UserDefinedFunction) else True)\n         self._func_type = func_type\n         self._judf_placeholder = None\n+        self._used_in_row_based_operation = False\n \n     def __call__(self, *args) -> Expression:\n         from pyflink.table import expressions as expr\n         return expr.call(self, *args)\n \n+    def alias(self, *alias_names: str):", "originalCommit": "aeb710b99fcabb7f95ad5627f9c7e636430eb30e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzAyMDEyNw==", "url": "https://github.com/apache/flink/pull/14410#discussion_r547020127", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                def java_user_defined_function(self):\n          \n          \n            \n                def _java_user_defined_function(self):", "author": "dianfu", "createdAt": "2020-12-22T01:45:02Z", "path": "flink-python/pyflink/table/udf.py", "diffHunk": "@@ -348,11 +348,20 @@ def __init__(self, func, input_types, func_type, deterministic=None, name=None):\n             func.is_deterministic() if isinstance(func, UserDefinedFunction) else True)\n         self._func_type = func_type\n         self._judf_placeholder = None\n+        self._used_in_row_based_operation = False\n \n     def __call__(self, *args) -> Expression:\n         from pyflink.table import expressions as expr\n         return expr.call(self, *args)\n \n+    def alias(self, *alias_names: str):\n+        self._alias_names = alias_names\n+        return self\n+\n+    def set_used_in_row_based_operation(self):\n+        self._used_in_row_based_operation = True\n+        return self\n+\n     def java_user_defined_function(self):", "originalCommit": "aeb710b99fcabb7f95ad5627f9c7e636430eb30e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzAyNTc4OA==", "url": "https://github.com/apache/flink/pull/14410#discussion_r547025788", "bodyText": "I guess we could also add row-based support in join_lateral/left_outer_join_lateral? I'm fine to do it in a separate PR if it you want.", "author": "dianfu", "createdAt": "2020-12-22T02:05:38Z", "path": "flink-table/flink-table-common/src/main/java/org/apache/flink/table/functions/python/PythonTableFunction.java", "diffHunk": "@@ -48,6 +48,7 @@\n \tprivate final PythonFunctionKind pythonFunctionKind;\n \tprivate final boolean deterministic;\n \tprivate final PythonEnv pythonEnv;\n+\tprivate final boolean usedInRowBasedOperation;", "originalCommit": "aeb710b99fcabb7f95ad5627f9c7e636430eb30e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzEwMDU5Mg==", "url": "https://github.com/apache/flink/pull/14410#discussion_r547100592", "bodyText": "Yes. I have created https://issues.apache.org/jira/browse/FLINK-20712 to support this feature.", "author": "HuangXingBo", "createdAt": "2020-12-22T06:53:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzAyNTc4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzAyNjI0MA==", "url": "https://github.com/apache/flink/pull/14410#discussion_r547026240", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            def wrap_inputs_to_row(*args):\n          \n          \n            \n            def wrap_inputs_as_row(*args):", "author": "dianfu", "createdAt": "2020-12-22T02:07:18Z", "path": "flink-python/pyflink/fn_execution/operation_utils.py", "diffHunk": "@@ -43,6 +43,15 @@ def wrap_pandas_result(it):\n     return arrays\n \n \n+def wrap_inputs_to_row(*args):", "originalCommit": "aeb710b99fcabb7f95ad5627f9c7e636430eb30e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzAyNzgwNQ==", "url": "https://github.com/apache/flink/pull/14410#discussion_r547027805", "bodyText": "could you improve pandas_udaf to let it also access the group key?", "author": "dianfu", "createdAt": "2020-12-22T02:13:40Z", "path": "flink-python/pyflink/table/tests/test_row_based_operation.py", "diffHunk": "@@ -120,14 +117,16 @@ def test_aggregate_with_pandas_udaf(self):\n             ['a', 'b', 'c'],\n             [DataTypes.TINYINT(), DataTypes.FLOAT(), DataTypes.INT()])\n         self.t_env.register_table_sink(\"Results\", table_sink)\n-        pandas_udaf = udaf(lambda a: (a.mean(), a.max()),\n+        pandas_udaf = udaf(lambda pd: (pd.b.mean(), pd.b.max()),\n                            result_type=DataTypes.ROW(\n                                [DataTypes.FIELD(\"a\", DataTypes.FLOAT()),\n                                 DataTypes.FIELD(\"b\", DataTypes.INT())]),\n                            func_type=\"pandas\")\n-        t.group_by(t.a) \\\n-            .aggregate(pandas_udaf(t.b).alias(\"c\", \"d\")) \\\n-            .select(\"a, c, d\").execute_insert(\"Results\") \\\n+        t.select(t.a, t.b) \\\n+            .group_by(t.a) \\\n+            .aggregate(pandas_udaf) \\", "originalCommit": "aeb710b99fcabb7f95ad5627f9c7e636430eb30e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e1ced0fdf23670160b01752f98790186f66ca99c", "url": "https://github.com/apache/flink/commit/e1ced0fdf23670160b01752f98790186f66ca99c", "message": "fix comments-3", "committedDate": "2020-12-22T07:02:05Z", "type": "commit"}, {"oid": "e0727e955bba043f05aa6d6f5da5377a9dc086bc", "url": "https://github.com/apache/flink/commit/e0727e955bba043f05aa6d6f5da5377a9dc086bc", "message": "fix", "committedDate": "2020-12-22T09:55:17Z", "type": "commit"}]}