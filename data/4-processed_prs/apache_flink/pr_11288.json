{"pr_number": 11288, "pr_title": "[FLINK-16350][e2e] Run half of streaming HA tests against ZK 3.5", "pr_createdAt": "2020-03-02T15:28:48Z", "pr_url": "https://github.com/apache/flink/pull/11288", "timeline": [{"oid": "297617886bd9ad220b9d007704145dbf7f36a5fd", "url": "https://github.com/apache/flink/commit/297617886bd9ad220b9d007704145dbf7f36a5fd", "message": "[FLINK-16350][e2e] Run half of streaming HA tests against ZK 3.5", "committedDate": "2020-03-02T15:28:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU3OTYzNw==", "url": "https://github.com/apache/flink/pull/11288#discussion_r387579637", "bodyText": "This logic won't work because of common.sh#backup_flink_dir which will overwrite lib after the end of the test. I think it should work if we only copy flink-shaded-zookeeper-3.5 instead of moving it.", "author": "tillrohrmann", "createdAt": "2020-03-04T10:34:12Z", "path": "flink-end-to-end-tests/test-scripts/common.sh", "diffHunk": "@@ -101,6 +101,20 @@ function revert_flink_dir() {\n     CURL_SSL_ARGS=\"\"\n }\n \n+function use_zookeeper_34() {\n+  if [ -e \"${FLINK_DIR}\"/lib/flink-shaded-zookeeper-3.5* ]; then\n+    mv \"${FLINK_DIR}\"/lib/flink-shaded-zookeeper-3.5* \"${FLINK_DIR}/opt\"\n+    mv \"${FLINK_DIR}\"/opt/flink-shaded-zookeeper-3.4* \"${FLINK_DIR}/lib\"\n+  fi\n+}\n+\n+function use_zookeeper_35() {\n+  if [ -e \"${FLINK_DIR}\"/lib/flink-shaded-zookeeper-3.4* ]; then\n+    mv \"${FLINK_DIR}\"/lib/flink-shaded-zookeeper-3.4* \"${FLINK_DIR}/opt\"\n+    mv \"${FLINK_DIR}\"/opt/flink-shaded-zookeeper-3.5* \"${FLINK_DIR}/lib\"\n+  fi\n+}", "originalCommit": "297617886bd9ad220b9d007704145dbf7f36a5fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYzODk1NA==", "url": "https://github.com/apache/flink/pull/11288#discussion_r387638954", "bodyText": "fixed", "author": "zentol", "createdAt": "2020-03-04T12:38:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU3OTYzNw=="}], "type": "inlineReview"}, {"oid": "4479ba78fddb94b572a802662b100c31bfd651f0", "url": "https://github.com/apache/flink/commit/4479ba78fddb94b572a802662b100c31bfd651f0", "message": "never modify opt", "committedDate": "2020-03-04T12:28:58Z", "type": "commit"}, {"oid": "5d6cf20446dbf6e210792be9940027ae3ab2de46", "url": "https://github.com/apache/flink/commit/5d6cf20446dbf6e210792be9940027ae3ab2de46", "message": "+", "committedDate": "2020-03-04T12:38:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzczMTA2OQ==", "url": "https://github.com/apache/flink/pull/11288#discussion_r387731069", "bodyText": "Where does opt/zookeeper-3.4 come from? I think per default only zookeeper-3.5 is in opt.", "author": "tillrohrmann", "createdAt": "2020-03-04T15:14:03Z", "path": "flink-end-to-end-tests/test-scripts/common.sh", "diffHunk": "@@ -101,6 +101,24 @@ function revert_flink_dir() {\n     CURL_SSL_ARGS=\"\"\n }\n \n+function use_zookeeper_34() {\n+  if [ -e \"${FLINK_DIR}\"/lib/flink-shaded-zookeeper-3.5* ]; then\n+    # contents of 'opt' must not be changed since it is not backed up in common.sh#backup_flink_dir\n+    # it is fine to delete jars from 'lib' since it is backed up and will be restored after the test\n+    rm \"${FLINK_DIR}\"/lib/flink-shaded-zookeeper-3.5*\n+    cp \"${FLINK_DIR}\"/opt/flink-shaded-zookeeper-3.4* \"${FLINK_DIR}/lib\"", "originalCommit": "5d6cf20446dbf6e210792be9940027ae3ab2de46", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzgwNDcxNQ==", "url": "https://github.com/apache/flink/pull/11288#discussion_r387804715", "bodyText": "technically speaking we don't need it and we could make the assumption in the test that 3.4 is always in dist and 3.5 is always in opt; but it felt wrong to not do anything if 3.4 is specified as the ZK version.\nWith this it is at least possible to make 3.5 the default ZK version (which we may do in a later release) without requiring changes to the test.", "author": "zentol", "createdAt": "2020-03-04T17:02:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzczMTA2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg0MzcwOA==", "url": "https://github.com/apache/flink/pull/11288#discussion_r387843708", "bodyText": "we could future-proof this a bit more by deleting flink-shaded-zookeeper-3.* from lib instead in both cases, and explicitly check that the 3.4/3.5 jar is present in opt before copying.", "author": "zentol", "createdAt": "2020-03-04T18:12:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzczMTA2OQ=="}], "type": "inlineReview"}, {"oid": "3cf04823e0e8b9a97fcfab622e7ae0f8cb0fec5e", "url": "https://github.com/apache/flink/commit/3cf04823e0e8b9a97fcfab622e7ae0f8cb0fec5e", "message": "+", "committedDate": "2020-03-11T21:15:40Z", "type": "commit"}, {"oid": "425f44277c7751bfb74919013e84aab48d8f270d", "url": "https://github.com/apache/flink/commit/425f44277c7751bfb74919013e84aab48d8f270d", "message": "+", "committedDate": "2020-03-12T09:54:58Z", "type": "commit"}]}