{"pr_number": 11400, "pr_title": "[FLINK-16586][network] Build ResultSubpartitionInfo and InputChannelInfo in respective constructors", "pr_createdAt": "2020-03-13T08:22:27Z", "pr_url": "https://github.com/apache/flink/pull/11400", "timeline": [{"oid": "a86f1e2e6785237893201dac302bc50041610d73", "url": "https://github.com/apache/flink/commit/a86f1e2e6785237893201dac302bc50041610d73", "message": "[FLINK-16586][network] Build ResultSubpartitionInfo and InputChannelInfo in respective constructors\n\nIn the constructors of ResultSubpartition and InputChannel, the respective ResultSubpartitionInfo and InputChannelInfo should be created as well.\nThese infos would be used for interacting with ChannelStateReader and ChannelStateWriter future.", "committedDate": "2020-03-13T08:24:13Z", "type": "forcePushed"}, {"oid": "835d5e2f86901bd8a85cf1d2aea9f91536bd132f", "url": "https://github.com/apache/flink/commit/835d5e2f86901bd8a85cf1d2aea9f91536bd132f", "message": "[FLINK-16586][network] Build ResultSubpartitionInfo and InputChannelInfo in respective constructors\n\nIn the constructors of ResultSubpartition and InputChannel, the respective ResultSubpartitionInfo and InputChannelInfo should be created as well.\nThese infos would be used for interacting with ChannelStateReader and ChannelStateWriter future.", "committedDate": "2020-03-13T08:41:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjExMzAzMg==", "url": "https://github.com/apache/flink/pull/11400#discussion_r392113032", "bodyText": "Wildcard imports are discouraged by flink style guide.", "author": "rkhachatryan", "createdAt": "2020-03-13T09:23:50Z", "path": "flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/consumer/SingleInputGateTest.java", "diffHunk": "@@ -60,10 +61,7 @@\n import java.io.IOException;\n import java.nio.ByteBuffer;\n import java.nio.ByteOrder;\n-import java.util.Arrays;\n-import java.util.HashMap;\n-import java.util.Map;\n-import java.util.Optional;\n+import java.util.*;", "originalCommit": "835d5e2f86901bd8a85cf1d2aea9f91536bd132f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjExNzU0OA==", "url": "https://github.com/apache/flink/pull/11400#discussion_r392117548", "bodyText": "Sure, I was not aware that my local IDE did it automatically. :(", "author": "zhijiangW", "createdAt": "2020-03-13T09:33:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjExMzAzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjExNDczMw==", "url": "https://github.com/apache/flink/pull/11400#discussion_r392114733", "bodyText": "I think it's better to initialize it with an invalid value to force clients to set it.", "author": "rkhachatryan", "createdAt": "2020-03-13T09:27:21Z", "path": "flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/ResultPartitionBuilder.java", "diffHunk": "@@ -40,6 +40,8 @@\n \n \tprivate BoundedBlockingSubpartitionType blockingSubpartitionType = BoundedBlockingSubpartitionType.AUTO;\n \n+\tprivate int partitionIndex = 0;", "originalCommit": "835d5e2f86901bd8a85cf1d2aea9f91536bd132f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEyMjU1OQ==", "url": "https://github.com/apache/flink/pull/11400#discussion_r392122559", "bodyText": "This builder is only for testing purpose, and I do not think this property is more important or very necessary than other existing fields like partitionId, numberOfSubpartitions etc. Even I guess this new field is rare used for most of the testing cases, so I prefer to not making it as mandatory.", "author": "zhijiangW", "createdAt": "2020-03-13T09:43:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjExNDczMw=="}], "type": "inlineReview"}, {"oid": "3c660599680944e8c6f2b3b0ceaf6975b03fc5c4", "url": "https://github.com/apache/flink/commit/3c660599680944e8c6f2b3b0ceaf6975b03fc5c4", "message": "[FLINK-16586][network] Build ResultSubpartitionInfo and InputChannelInfo in respective constructors\n\nIn the constructors of ResultSubpartition and InputChannel, the respective ResultSubpartitionInfo and InputChannelInfo should be created as well.\nThese infos would be used for interacting with ChannelStateReader and ChannelStateWriter future.", "committedDate": "2020-03-13T09:47:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEyNjg5NA==", "url": "https://github.com/apache/flink/pull/11400#discussion_r392126894", "bodyText": "Here, we rely on iteration order (counter), but the type of inputGateDeploymentDescriptors is Collection.\nWhen it is created it is List though.\nSo I think we should change the type of TaskDeploymentDescriptor.inputGates and all parameters down to  inputGateDeploymentDescriptors  to List.", "author": "rkhachatryan", "createdAt": "2020-03-13T09:51:46Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/NettyShuffleEnvironment.java", "diffHunk": "@@ -217,6 +218,7 @@ public ShuffleIOOwnerContext createShuffleIOOwnerContext(\n \t\t\tfor (InputGateDeploymentDescriptor igdd : inputGateDeploymentDescriptors) {\n \t\t\t\tSingleInputGate inputGate = singleInputGateFactory.create(\n \t\t\t\t\townerContext.getOwnerName(),\n+\t\t\t\t\tcounter,", "originalCommit": "3c660599680944e8c6f2b3b0ceaf6975b03fc5c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI0NzYxMQ==", "url": "https://github.com/apache/flink/pull/11400#discussion_r392247611", "bodyText": "I guess your suggestion is for unifying all the related data structures (collection, array) from TaskDeploymentDescriptor.inputGates to List?\nActually I do not see any correctness or performance problems ATM. This unification really spans cross multiple components from scheduler to task stack, and I do think it is really necessary to refactor it now. Or if we want to do that, it should be a separate ticket out of this PR scope. We only make use of previous counter to give a correct gate index while creating in iteration for this PR motivation. WDYT?", "author": "zhijiangW", "createdAt": "2020-03-13T14:04:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEyNjg5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjI5MTMyNQ==", "url": "https://github.com/apache/flink/pull/11400#discussion_r392291325", "bodyText": "Not sure if I got you right.\nI meant to change the type from Collection to List for:\n\ninputGateDeploymentDescriptors parameter in NettyShuffleEnvironment#createInputGates\nTaskDeploymentDescriptor#inputGates field\ninputGateDeploymentDescriptors parameter in Task constructor\ninputGateDeploymentDescriptors parameter in TaskDeploymentDescriptor constructor\n\nWithout it, it's easy to break the ordering, at least for me :)\nI think it should be the same PR because requirement for ordering was added here.", "author": "rkhachatryan", "createdAt": "2020-03-13T15:15:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEyNjg5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjc3Nzc0MQ==", "url": "https://github.com/apache/flink/pull/11400#discussion_r392777741", "bodyText": "I thought you were referring to the unnecessary transformation in the logics before, sorry for misunderstanding.\nYou are right that the current Collection actually does not provide any order guarantee which relies on the subclass interface (List or Set), and we indeed need the determined order after restarting.\nIt is reasonable to adjust the Collection to List as you suggested, but the only trouble is that it would change the public interface of ShuffleEnvironment proposed in FLIP-31. So it might break the compatibility if some outside users already relied on it. I guess it needs to discussion in ML for finalization.  Anyway, I already addressed this issue in a separate commit.", "author": "zhijiangW", "createdAt": "2020-03-16T04:30:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEyNjg5NA=="}], "type": "inlineReview"}, {"oid": "5216b6412ed32669643e576b1879af2122f43e4b", "url": "https://github.com/apache/flink/commit/5216b6412ed32669643e576b1879af2122f43e4b", "message": "[FLINK-16586][network] Build ResultSubpartitionInfo and InputChannelInfo in respective constructors\n\nIn the constructors of ResultSubpartition and InputChannel, the respective ResultSubpartitionInfo and InputChannelInfo should be created as well.\nThese infos would be used for interacting with ChannelStateReader and ChannelStateWriter future.", "committedDate": "2020-03-13T13:29:07Z", "type": "forcePushed"}, {"oid": "ea3d7681318c2a9dcdcb6a27cae8c2f0e95ea316", "url": "https://github.com/apache/flink/commit/ea3d7681318c2a9dcdcb6a27cae8c2f0e95ea316", "message": "[hotfix][task][tests] Remove useless import from TaskTest class", "committedDate": "2020-03-16T04:13:35Z", "type": "forcePushed"}, {"oid": "e1eff48158b2bc4b76dab5d0bdac7b0a57132e18", "url": "https://github.com/apache/flink/commit/e1eff48158b2bc4b76dab5d0bdac7b0a57132e18", "message": "[FLINK-16586][network] Build ResultSubpartitionInfo and InputChannelInfo in respective constructors\n\nIn the constructors of ResultSubpartition and InputChannel, the respective ResultSubpartitionInfo and InputChannelInfo should be created as well.\nThese infos would be used for interacting with ChannelStateReader and ChannelStateWriter future.\n\nThis cloese #11400.", "committedDate": "2020-03-18T03:10:40Z", "type": "commit"}, {"oid": "f0a936bd3411aa7ccaa7373fd51c0ed71a363629", "url": "https://github.com/apache/flink/commit/f0a936bd3411aa7ccaa7373fd51c0ed71a363629", "message": "[hotfix][task][tests] Remove useless import from TaskTest class\n\nThis cloese #11400.", "committedDate": "2020-03-18T03:11:56Z", "type": "commit"}, {"oid": "f0a936bd3411aa7ccaa7373fd51c0ed71a363629", "url": "https://github.com/apache/flink/commit/f0a936bd3411aa7ccaa7373fd51c0ed71a363629", "message": "[hotfix][task][tests] Remove useless import from TaskTest class\n\nThis cloese #11400.", "committedDate": "2020-03-18T03:11:56Z", "type": "forcePushed"}]}