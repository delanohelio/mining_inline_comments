{"pr_number": 10903, "pr_title": "[FLINK-15549][API/DataSet] Fix Integer overflow in ResettableIterator*.", "pr_createdAt": "2020-01-19T12:52:52Z", "pr_url": "https://github.com/apache/flink/pull/10903", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM0NjQ4MA==", "url": "https://github.com/apache/flink/pull/10903#discussion_r368346480", "bodyText": "We should avoid code duplication. Maybe it's better to add a utility function.", "author": "KarmaGYZ", "createdAt": "2020-01-20T02:07:05Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/operators/resettable/SpillingResettableMutableObjectIterator.java", "diffHunk": "@@ -204,8 +204,16 @@ public void consumeAndCacheRemainingData() throws IOException {\n \t\t\t\t} catch (IOException e) {\n \t\t\t\t\tthrow new RuntimeException(\"SpillingIterator: Error writing element to buffer.\", e);\n \t\t\t\t}\n-\t\t\t\tthis.elementCount++;\n+\t\t\t\tincreaseElementCount();\n \t\t\t}\n \t\t}\n \t}\n+\n+\tprivate void increaseElementCount() {", "originalCommit": "4289c3910b39b13938aafc1337cc9c127e46fedd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM1MjA1Mg==", "url": "https://github.com/apache/flink/pull/10903#discussion_r368352052", "bodyText": "Hi, @KarmaGYZ Thanks for your comment.\nSpillingResettableIterator and SpillingResettableMutableObjectIterator  both implemented ResettableIterator, but they are two separate components. Although the logic of adding elementCount is somewhat similar, it is actually related to their respective implementation logic, so i think there is no need to share it.", "author": "killxdcj", "createdAt": "2020-01-20T02:48:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM0NjQ4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM2MDA0NA==", "url": "https://github.com/apache/flink/pull/10903#discussion_r368360044", "bodyText": "I don't think so. The logic of increaseElementCount in two classes is both check the numerical overflow and increase it. Am I understand it correctly?", "author": "KarmaGYZ", "createdAt": "2020-01-20T03:42:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM0NjQ4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQxNTg1OA==", "url": "https://github.com/apache/flink/pull/10903#discussion_r368415858", "bodyText": "Maybe you can think of it this way, there may be many such scenes in reality, and you need to check the overflow, so whether all the places to check the overflow need to use the same code.\nAnd the point is that they are two separate components, and there is no need to reuse them for reuse.", "author": "killxdcj", "createdAt": "2020-01-20T08:23:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM0NjQ4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU0MTg1MA==", "url": "https://github.com/apache/flink/pull/10903#discussion_r368541850", "bodyText": "Extracting that logic to some NumericUtil#safeIncrement in flink-core could be a viable option.", "author": "AHeise", "createdAt": "2020-01-20T13:17:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM0NjQ4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU0MDE5MQ==", "url": "https://github.com/apache/flink/pull/10903#discussion_r368540191", "bodyText": "This method is a bit overengineered: even if we are doing nothing than just incrementing the long value, it takes 60 years on a 4 GHz CPU to reach the overflow in java.\nNevertheless, I expect the branch prediction to also figure that out and not cause any performance degradation.", "author": "AHeise", "createdAt": "2020-01-20T13:12:59Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/operators/resettable/SpillingResettableIterator.java", "diffHunk": "@@ -189,4 +189,12 @@ public void remove() {\n \t\t\treturn memory;\n \t\t}\n \t}\n+\n+\tprivate void increaseElementCount() {", "originalCommit": "4289c3910b39b13938aafc1337cc9c127e46fedd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc4NjU0MA==", "url": "https://github.com/apache/flink/pull/10903#discussion_r368786540", "bodyText": "I agree with you, it was realy a bit overengineered, so I removed the logic of checking long overflow.", "author": "killxdcj", "createdAt": "2020-01-21T02:28:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU0MDE5MQ=="}], "type": "inlineReview"}, {"oid": "d607f61ab374d5ee630dfc72686a4e65d2fc8548", "url": "https://github.com/apache/flink/commit/d607f61ab374d5ee630dfc72686a4e65d2fc8548", "message": "[FLINK-15549] Fix Integer overflow in ResettableIterator.\n\nChange-Id: I98bfac0a881409a1968383d8d85754c48758edd5", "committedDate": "2020-01-21T02:23:52Z", "type": "commit"}, {"oid": "d607f61ab374d5ee630dfc72686a4e65d2fc8548", "url": "https://github.com/apache/flink/commit/d607f61ab374d5ee630dfc72686a4e65d2fc8548", "message": "[FLINK-15549] Fix Integer overflow in ResettableIterator.\n\nChange-Id: I98bfac0a881409a1968383d8d85754c48758edd5", "committedDate": "2020-01-21T02:23:52Z", "type": "forcePushed"}]}