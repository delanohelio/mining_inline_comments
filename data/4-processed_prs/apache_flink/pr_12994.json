{"pr_number": 12994, "pr_title": "[FLINK-18728][network] Make initialCredit of RemoteInputChannel final", "pr_createdAt": "2020-07-27T08:14:36Z", "pr_url": "https://github.com/apache/flink/pull/12994", "timeline": [{"oid": "20ea916ccc154c7d53d40d273b346533b8409b12", "url": "https://github.com/apache/flink/commit/20ea916ccc154c7d53d40d273b346533b8409b12", "message": "[FLINK-18728][network] Make initialCredit of RemoteInputChannel final\n\nThe filed initialCredit of RemoteInputChannel is set only once and can be accessed by multi threads. This patch makes the filed final and moves the initialization to the constructor of RemoteInputChannel to avoid potential thread safety issues.\n\nThis closes #11877.", "committedDate": "2020-07-27T15:14:15Z", "type": "forcePushed"}, {"oid": "e254b80defcac6316bc542918d382159c2ebda5e", "url": "https://github.com/apache/flink/commit/e254b80defcac6316bc542918d382159c2ebda5e", "message": "[FLINK-18728][network] Make initialCredit of RemoteInputChannel final\n\nThe filed initialCredit of RemoteInputChannel is set only once and can be accessed by multi threads. This patch makes the filed final and moves the initialization to the constructor of RemoteInputChannel to avoid potential thread safety issues.\n\nThis closes #11877.", "committedDate": "2020-07-28T06:50:57Z", "type": "forcePushed"}, {"oid": "d164d2a94a4fa87a9f56f7238512d79134a722ee", "url": "https://github.com/apache/flink/commit/d164d2a94a4fa87a9f56f7238512d79134a722ee", "message": "[FLINK-18728][network] Make initialCredit of RemoteInputChannel final\n\nThe filed initialCredit of RemoteInputChannel is set only once and can be accessed by multi threads. This patch makes the filed final and moves the initialization to the constructor of RemoteInputChannel to avoid potential thread safety issues.\n\nThis closes #11877.", "committedDate": "2020-07-29T03:08:21Z", "type": "forcePushed"}, {"oid": "2efaa69c5791a59239feec7c122ba4fd39462238", "url": "https://github.com/apache/flink/commit/2efaa69c5791a59239feec7c122ba4fd39462238", "message": "[FLINK-18728][network] Make initialCredit of RemoteInputChannel final\n\nThe filed initialCredit of RemoteInputChannel is set only once and can be accessed by multi threads. This patch makes the filed final and moves the initialization to the constructor of RemoteInputChannel to avoid potential thread safety issues.\n\nThis closes #11877.", "committedDate": "2020-07-29T03:15:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjI3MjA4NA==", "url": "https://github.com/apache/flink/pull/12994#discussion_r466272084", "bodyText": "The previous initial credit seems to be got from the returned collection size of globalPool.requestMemorySegments() somehow. If we can get the initial credit in advance, then it would be better to also pass it as argument into requestMemorySegments to get required size. To do so, the NetworkBufferPool#requestMemorySegments seems more general to decouple with credit semantic.", "author": "zhijiangW", "createdAt": "2020-08-06T09:23:26Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/BufferManager.java", "diffHunk": "@@ -125,9 +125,9 @@ private boolean shouldContinueRequest(BufferPool bufferPool) {\n \t}\n \n \t/**\n-\t * Requests exclusive buffers from the provider and returns the number of requested amount.\n+\t * Requests exclusive buffers from the provider.\n \t */\n-\tint requestExclusiveBuffers() throws IOException {\n+\tvoid requestExclusiveBuffers() throws IOException {\n \t\tCollection<MemorySegment> segments = globalPool.requestMemorySegments();", "originalCommit": "2efaa69c5791a59239feec7c122ba4fd39462238", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "40d884bc7ab51689d54592a3f99289912abd71d3", "url": "https://github.com/apache/flink/commit/40d884bc7ab51689d54592a3f99289912abd71d3", "message": "[hotfix] Rename BufferManager#unsynchronizedGetExclusiveBuffersUsed to BufferManager#unsynchronizedGetAvailableExclusiveBuffers\n\nThis closes #12994.", "committedDate": "2020-08-07T03:55:40Z", "type": "commit"}, {"oid": "2aab77e658b25b810fcbc29c5977e16cb375c759", "url": "https://github.com/apache/flink/commit/2aab77e658b25b810fcbc29c5977e16cb375c759", "message": "[hotfix] Change signature of MemorySegmentProvider#requestMemorySegments from requestMemorySegments() to requestMemorySegments(int)\n\nThis change makes the interface more flexible and decouples NetworkBufferPool from the concept of exclusive buffer.\n\nThis close #12994.", "committedDate": "2020-08-07T04:03:13Z", "type": "forcePushed"}, {"oid": "511d2dba850a677f5297ff75c6a911ed56efbacd", "url": "https://github.com/apache/flink/commit/511d2dba850a677f5297ff75c6a911ed56efbacd", "message": "[hotfix] Change signature of MemorySegmentProvider#requestMemorySegments from requestMemorySegments() to requestMemorySegments(int)\n\nThis change makes the interface more flexible and decouples NetworkBufferPool from the concept of exclusive buffer.\n\nThis close #12994.", "committedDate": "2020-08-07T08:06:50Z", "type": "forcePushed"}, {"oid": "707c67f554cf59d2ba1e848e05cef0aea1fe7a89", "url": "https://github.com/apache/flink/commit/707c67f554cf59d2ba1e848e05cef0aea1fe7a89", "message": "[hotfix] Change signature of MemorySegmentProvider#requestMemorySegments from requestMemorySegments() to requestMemorySegments(int)\n\nThis change makes the interface more flexible and decouples NetworkBufferPool from the concept of exclusive buffer.\n\nThis close #12994.", "committedDate": "2020-08-07T09:17:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkyNzM1Mw==", "url": "https://github.com/apache/flink/pull/12994#discussion_r466927353", "bodyText": "Do you think we should check the passed argument more than 0 in advance?", "author": "zhijiangW", "createdAt": "2020-08-07T09:24:54Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/buffer/NetworkBufferPool.java", "diffHunk": "@@ -161,13 +155,13 @@ public void recycle(MemorySegment segment) {\n \t}\n \n \t@Override\n-\tpublic List<MemorySegment> requestMemorySegments() throws IOException {\n+\tpublic List<MemorySegment> requestMemorySegments(int numberOfSegmentsToRequest) throws IOException {", "originalCommit": "707c67f554cf59d2ba1e848e05cef0aea1fe7a89", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkyNzQzMg==", "url": "https://github.com/apache/flink/pull/12994#discussion_r466927432", "bodyText": "nit: if we want to check this argument, it would be better to be done in the initialization of constructor.\nI think we can remove it directly since the passed networkBuffersPerChannel in constructor should already be checked in previous component.", "author": "zhijiangW", "createdAt": "2020-08-07T09:25:03Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "diffHunk": "@@ -128,8 +128,9 @@ public RemoteInputChannel(\n \tvoid assignExclusiveSegments() throws IOException {\n \t\tcheckState(bufferManager.unsynchronizedGetAvailableExclusiveBuffers() == 0,\n \t\t\t\"Bug in input channel setup logic: exclusive buffers have already been set for this input channel.\");\n+\t\tcheckState(initialCredit > 0, \"Number of exclusive buffers must be larger than 0.\");", "originalCommit": "707c67f554cf59d2ba1e848e05cef0aea1fe7a89", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkzMTA3Mg==", "url": "https://github.com/apache/flink/pull/12994#discussion_r466931072", "bodyText": "This change seems unnecessary?", "author": "zhijiangW", "createdAt": "2020-08-07T09:32:18Z", "path": "flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannelTest.java", "diffHunk": "@@ -1121,14 +1118,15 @@ public void testUnblockReleasedChannel() throws Exception {\n \t\tremoteChannel.resumeConsumption();\n \t}\n \n-\t// ---------------------------------------------------------------------------------------------\n-\n-\tpublic static RemoteInputChannel createRemoteInputChannel(SingleInputGate inputGate, int numExclusiveSegments) {", "originalCommit": "707c67f554cf59d2ba1e848e05cef0aea1fe7a89", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkzMTQyOA==", "url": "https://github.com/apache/flink/pull/12994#discussion_r466931428", "bodyText": "I guess this test should be adjusted as well based on above comments.", "author": "zhijiangW", "createdAt": "2020-08-07T09:32:59Z", "path": "flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannelTest.java", "diffHunk": "@@ -1121,14 +1118,15 @@ public void testUnblockReleasedChannel() throws Exception {\n \t\tremoteChannel.resumeConsumption();\n \t}\n \n-\t// ---------------------------------------------------------------------------------------------\n-\n-\tpublic static RemoteInputChannel createRemoteInputChannel(SingleInputGate inputGate, int numExclusiveSegments) {\n-\t\treturn InputChannelBuilder.newBuilder()\n-\t\t\t.setNetworkBuffersPerChannel(numExclusiveSegments)\n-\t\t\t.buildRemoteChannel(inputGate);\n+\t@Test(expected = IllegalStateException.class)\n+\tpublic void testIllegalNumberOfExclusiveBuffers() throws Exception {", "originalCommit": "707c67f554cf59d2ba1e848e05cef0aea1fe7a89", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "370e0fc44226f5a616c459cc68d51cf6a3686991", "url": "https://github.com/apache/flink/commit/370e0fc44226f5a616c459cc68d51cf6a3686991", "message": "[FLINK-18728][network] Make initialCredit of RemoteInputChannel final\n\nThe filed initialCredit of RemoteInputChannel is set only once and can be accessed by multi threads. This patch makes the filed final and moves the initialization to the constructor of RemoteInputChannel to avoid potential thread safety issues.\n\nThis closes #12994.", "committedDate": "2020-08-09T03:53:29Z", "type": "commit"}, {"oid": "370e0fc44226f5a616c459cc68d51cf6a3686991", "url": "https://github.com/apache/flink/commit/370e0fc44226f5a616c459cc68d51cf6a3686991", "message": "[FLINK-18728][network] Make initialCredit of RemoteInputChannel final\n\nThe filed initialCredit of RemoteInputChannel is set only once and can be accessed by multi threads. This patch makes the filed final and moves the initialization to the constructor of RemoteInputChannel to avoid potential thread safety issues.\n\nThis closes #12994.", "committedDate": "2020-08-09T03:53:29Z", "type": "forcePushed"}, {"oid": "453eabc11a5acfbf6cca97959b6bf6e57a93b0e9", "url": "https://github.com/apache/flink/commit/453eabc11a5acfbf6cca97959b6bf6e57a93b0e9", "message": "[hotfix] Change signature of MemorySegmentProvider#requestMemorySegments from requestMemorySegments() to requestMemorySegments(int)\n\nThis change makes the interface more flexible and decouples NetworkBufferPool from the concept of exclusive buffer.\n\nThis close #12994.", "committedDate": "2020-08-09T05:26:39Z", "type": "commit"}]}