{"pr_number": 11361, "pr_title": "[FLINK-15727] Let BashJavaUtils return dynamic configs and JVM parame\u2026", "pr_createdAt": "2020-03-10T08:46:55Z", "pr_url": "https://github.com/apache/flink/pull/11361", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkyNDEyNA==", "url": "https://github.com/apache/flink/pull/11361#discussion_r390924124", "bodyText": "head -n 1 should be sufficient since output already only contains 2 lines.", "author": "zentol", "createdAt": "2020-03-11T12:03:52Z", "path": "flink-dist/src/test/bin/runBashJavaUtilsCmd.sh", "diffHunk": "@@ -36,5 +36,6 @@ FLINK_DIST_JAR=`find $FLINK_TARGET_DIR -name 'flink-dist*.jar'`\n \n . ${bin}/../../main/flink-bin/bin/config.sh > /dev/null\n \n-output=`runBashJavaUtilsCmd ${COMMAND} ${FLINK_CONF_DIR} \"$FLINK_TARGET_DIR/bash-java-utils.jar:$FLINK_DIST_JAR}\"`\n-extractExecutionParams \"$output\"\n+output=$(runBashJavaUtilsCmd GET_TM_RESOURCE_PARAMS ${FLINK_CONF_DIR} \"$FLINK_TARGET_DIR/bash-java-utils.jar:$FLINK_DIST_JAR}\" | tail -n 2)\n+extractExecutionParams \"$(echo \"$output\" | tail -n 2 | head -n 1)\"", "originalCommit": "cd09736f8968ac04c685e0bd502a18bd163388bf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkyNTAzNw==", "url": "https://github.com/apache/flink/pull/11361#discussion_r390925037", "bodyText": "head -n 1 should be sufficient since params_output already only contains 2 lines.", "author": "zentol", "createdAt": "2020-03-11T12:05:51Z", "path": "flink-dist/src/main/flink-bin/bin/taskmanager.sh", "diffHunk": "@@ -48,8 +48,9 @@ if [[ $STARTSTOP == \"start\" ]] || [[ $STARTSTOP == \"start-foreground\" ]]; then\n \n     # Startup parameters\n \n-    jvm_params_output=`runBashJavaUtilsCmd GET_TM_RESOURCE_JVM_PARAMS ${FLINK_CONF_DIR}`\n-    jvm_params=`extractExecutionParams \"$jvm_params_output\"`\n+    params_output=$(runBashJavaUtilsCmd GET_TM_RESOURCE_PARAMS ${FLINK_CONF_DIR} | tail -n 2)\n+\n+    jvm_params=$(extractExecutionParams \"$(echo \"$params_output\" | tail -n 2 | head -n 1)\")", "originalCommit": "cd09736f8968ac04c685e0bd502a18bd163388bf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkyNTMyMQ==", "url": "https://github.com/apache/flink/pull/11361#discussion_r390925321", "bodyText": "we could just remove the concept of commands.", "author": "zentol", "createdAt": "2020-03-11T12:06:28Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/util/BashJavaUtils.java", "diffHunk": "@@ -74,13 +70,8 @@ private static Configuration getConfigurationForStandaloneTaskManagers(String[]\n \t */\n \tpublic enum Command {\n \t\t/**\n-\t\t * Get dynamic configs of task executor resources.\n-\t\t */\n-\t\tGET_TM_RESOURCE_DYNAMIC_CONFIGS,\n-\n-\t\t/**\n-\t\t * Get JVM parameters of task executor resources.\n+\t\t * Get JVM parameters and dynamic configs of task executor resources.\n \t\t */\n-\t\tGET_TM_RESOURCE_JVM_PARAMS\n+\t\tGET_TM_RESOURCE_PARAMS", "originalCommit": "cd09736f8968ac04c685e0bd502a18bd163388bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM2NDAzNg==", "url": "https://github.com/apache/flink/pull/11361#discussion_r391364036", "bodyText": "I prefer to keep it in case we add other utility functions in this class.", "author": "KarmaGYZ", "createdAt": "2020-03-12T02:00:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkyNTMyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUxMDUyMA==", "url": "https://github.com/apache/flink/pull/11361#discussion_r391510520", "bodyText": "If this were to happen we'd revert back to having to call it multiple times; we'd likely just print another line instead, no?", "author": "zentol", "createdAt": "2020-03-12T09:57:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkyNTMyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU3MTAxNw==", "url": "https://github.com/apache/flink/pull/11361#discussion_r391571017", "bodyText": "I think we merge the two command here because they are all used in the same place when tm starts. However, the scope of this class is utility for bash. Commands added in future might be called anywhere. In that case, I think it's not just appending another line.", "author": "KarmaGYZ", "createdAt": "2020-03-12T11:55:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkyNTMyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkyODc2OQ==", "url": "https://github.com/apache/flink/pull/11361#discussion_r390928769", "bodyText": "shouldn't this be exactly 2 lines? (and if so, use assertEquals)", "author": "zentol", "createdAt": "2020-03-11T12:14:01Z", "path": "flink-dist/src/test/java/org/apache/flink/dist/BashJavaUtilsITCase.java", "diffHunk": "@@ -36,32 +37,13 @@\n \n \tprivate static final String RUN_BASH_JAVA_UTILS_CMD_SCRIPT = \"src/test/bin/runBashJavaUtilsCmd.sh\";\n \n-\t/**\n-\t * Executes the given shell script wrapper and returns the last line.\n-\t */\n-\tprivate String executeScriptAndFetchLastLine(final String command) throws IOException {\n-\t\tString[] commands = {RUN_BASH_JAVA_UTILS_CMD_SCRIPT, command};\n-\t\tString[] lines = executeScript(commands).split(System.lineSeparator());\n-\t\tif (lines.length == 0) {\n-\t\t\treturn \"\";\n-\t\t} else {\n-\t\t\treturn lines[lines.length - 1];\n-\t\t}\n-\t}\n-\n-\t@Test\n-\tpublic void testGetTmResourceDynamicConfigs() throws Exception {\n-\t\tString result = executeScriptAndFetchLastLine(BashJavaUtils.Command.GET_TM_RESOURCE_DYNAMIC_CONFIGS.toString());\n-\n-\t\tassertNotNull(result);\n-\t\tConfigurationUtils.parseTmResourceDynamicConfigs(result);\n-\t}\n-\n \t@Test\n-\tpublic void testGetTmResourceJvmParams() throws Exception {\n-\t\tString result = executeScriptAndFetchLastLine(BashJavaUtils.Command.GET_TM_RESOURCE_JVM_PARAMS.toString());\n+\tpublic void testGetTmResourceParamsConfigs() throws Exception {\n+\t\tString[] commands = {RUN_BASH_JAVA_UTILS_CMD_SCRIPT, BashJavaUtils.Command.GET_TM_RESOURCE_PARAMS.toString()};\n+\t\tList<String> lines = Arrays.asList(executeScript(commands).split(System.lineSeparator()));\n \n-\t\tassertNotNull(result);\n-\t\tConfigurationUtils.parseTmResourceJvmParams(result);\n+\t\tassertTrue(lines.size() >= 2);", "originalCommit": "cd09736f8968ac04c685e0bd502a18bd163388bf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1ffc375e2b14f76c86e56d6d7aa888094a45d475", "url": "https://github.com/apache/flink/commit/1ffc375e2b14f76c86e56d6d7aa888094a45d475", "message": "[FLINK-15727] Let BashJavaUtils return dynamic configs and JVM parameters in one call", "committedDate": "2020-03-12T02:21:20Z", "type": "commit"}, {"oid": "1ffc375e2b14f76c86e56d6d7aa888094a45d475", "url": "https://github.com/apache/flink/commit/1ffc375e2b14f76c86e56d6d7aa888094a45d475", "message": "[FLINK-15727] Let BashJavaUtils return dynamic configs and JVM parameters in one call", "committedDate": "2020-03-12T02:21:20Z", "type": "forcePushed"}]}