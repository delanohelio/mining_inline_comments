{"pr_number": 14218, "pr_title": "[FLINK-20331][checkpointing][task] Don't fail the task if unaligned checkpoint was subsumed", "pr_createdAt": "2020-11-25T12:40:01Z", "pr_url": "https://github.com/apache/flink/pull/14218", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM0NjAyMw==", "url": "https://github.com/apache/flink/pull/14218#discussion_r530346023", "bodyText": "I was in doubt whether this exception type is appropriate here or whether an Optional should be returned.\nBut at the upper level, it ultimately should be used, and the reason is only known here (so it would be harder to analyze the exception/empty buffers later).", "author": "rkhachatryan", "createdAt": "2020-11-25T12:43:51Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/io/network/partition/consumer/RemoteInputChannel.java", "diffHunk": "@@ -535,13 +536,16 @@ public void checkpointStopped(long checkpointId) {\n \t/**\n \t * Returns a list of buffers, checking the first n non-priority buffers, and skipping all events.\n \t */\n-\tprivate List<Buffer> getInflightBuffersUnsafe(long checkpointId) {\n+\tprivate List<Buffer> getInflightBuffersUnsafe(long checkpointId) throws CheckpointException {\n \t\tassert Thread.holdsLock(receivedBuffers);\n \n+\t\tif (checkpointId < lastBarrierId) {\n+\t\t\tthrow new CheckpointException(", "originalCommit": "1109ad24aebd4a283c3ee77d798eff81bfab609f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM3MDAxOA==", "url": "https://github.com/apache/flink/pull/14218#discussion_r530370018", "bodyText": "I think this is exactly the case for which CheckpointException was designed.", "author": "AHeise", "createdAt": "2020-11-25T13:22:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM0NjAyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM0Njg5NQ==", "url": "https://github.com/apache/flink/pull/14218#discussion_r530346895", "bodyText": "Please double-check this @AHeise  :)", "author": "rkhachatryan", "createdAt": "2020-11-25T12:45:16Z", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/SingleCheckpointBarrierHandler.java", "diffHunk": "@@ -158,14 +163,16 @@ public void processBarrierAnnouncement(\n \t@Override\n \tpublic void processCancellationBarrier(CancelCheckpointMarker cancelBarrier) throws IOException {\n \t\tfinal long cancelledId = cancelBarrier.getCheckpointId();\n-\t\tif (currentCheckpointId > cancelledId || (currentCheckpointId == cancelledId && numBarriersReceived == 0)) {\n-\t\t\treturn;\n+\t\tif (cancelledId >= currentCheckpointId && (cancelledId > currentCheckpointId || numBarriersReceived > 0)) {", "originalCommit": "1109ad24aebd4a283c3ee77d798eff81bfab609f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM1Njk5Nw==", "url": "https://github.com/apache/flink/pull/14218#discussion_r530356997", "bodyText": "It's correct but it might be easier to do\ncancelledId > currentCheckpointId || (currentCheckpointId == cancelledId && numBarriersReceived > 0)\n\nSo either it's a future checkpoint, or it's the current checkpoint and not yet canceled.", "author": "AHeise", "createdAt": "2020-11-25T13:01:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM0Njg5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM3MDQ4MQ==", "url": "https://github.com/apache/flink/pull/14218#discussion_r530370481", "bodyText": "I like it!", "author": "rkhachatryan", "createdAt": "2020-11-25T13:23:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM0Njg5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM0ODI3NQ==", "url": "https://github.com/apache/flink/pull/14218#discussion_r530348275", "bodyText": "This is not necessary currently.\nBut because I extracted this method the assignment became more error-prone, so I added this check.", "author": "rkhachatryan", "createdAt": "2020-11-25T12:47:27Z", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/SingleCheckpointBarrierHandler.java", "diffHunk": "@@ -158,14 +163,16 @@ public void processBarrierAnnouncement(\n \t@Override\n \tpublic void processCancellationBarrier(CancelCheckpointMarker cancelBarrier) throws IOException {\n \t\tfinal long cancelledId = cancelBarrier.getCheckpointId();\n-\t\tif (currentCheckpointId > cancelledId || (currentCheckpointId == cancelledId && numBarriersReceived == 0)) {\n-\t\t\treturn;\n+\t\tif (cancelledId >= currentCheckpointId && (cancelledId > currentCheckpointId || numBarriersReceived > 0)) {\n+\t\t\tabortInternal(cancelledId, new CheckpointException(CheckpointFailureReason.CHECKPOINT_DECLINED_ON_CANCELLATION_BARRIER));\n \t\t}\n+\t}\n+\n+\tprivate void abortInternal(long cancelledId, CheckpointException exception) throws IOException {\n \t\t// by setting the currentCheckpointId to this checkpoint while keeping the numBarriers\n \t\t// at zero means that no checkpoint barrier can start a new alignment\n-\t\tcurrentCheckpointId = cancelledId;\n+\t\tcurrentCheckpointId = Math.max(cancelledId, currentCheckpointId);", "originalCommit": "1109ad24aebd4a283c3ee77d798eff81bfab609f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "34bf5e7bd80836aebb708e47d4c029fbb4e90048", "url": "https://github.com/apache/flink/commit/34bf5e7bd80836aebb708e47d4c029fbb4e90048", "message": "[FLINK-20331][checkpointing][task] Don't fail the task if unaligned checkpoint was subsumed", "committedDate": "2020-11-25T13:23:04Z", "type": "forcePushed"}, {"oid": "cfb594a837c870bab3a6431ec3d73db19ba8b097", "url": "https://github.com/apache/flink/commit/cfb594a837c870bab3a6431ec3d73db19ba8b097", "message": "[FLINK-20331][checkpointing][task] Don't fail the task if unaligned checkpoint was subsumed", "committedDate": "2020-11-25T18:34:02Z", "type": "commit"}, {"oid": "cfb594a837c870bab3a6431ec3d73db19ba8b097", "url": "https://github.com/apache/flink/commit/cfb594a837c870bab3a6431ec3d73db19ba8b097", "message": "[FLINK-20331][checkpointing][task] Don't fail the task if unaligned checkpoint was subsumed", "committedDate": "2020-11-25T18:34:02Z", "type": "forcePushed"}]}