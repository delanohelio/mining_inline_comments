{"pr_number": 12883, "pr_title": "[FLINK-18573][metrics] Ensure metric reporters could be loaded via SPI", "pr_createdAt": "2020-07-13T10:45:23Z", "pr_url": "https://github.com/apache/flink/pull/12883", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzYzMTk0MQ==", "url": "https://github.com/apache/flink/pull/12883#discussion_r453631941", "bodyText": "redundant as we have a e2e test covering it, which is preferable. I'd only add this to reporters that are not otherwise covered as a band-aid.", "author": "zentol", "createdAt": "2020-07-13T13:01:28Z", "path": "flink-metrics/flink-metrics-prometheus/src/test/java/org/apache/flink/metrics/prometheus/PrometheusMetricReporterFactoryTest.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.metrics.prometheus;\n+\n+import org.apache.flink.metrics.reporter.MetricReporterFactory;\n+import org.apache.flink.runtime.metrics.MetricReporterSetupTestBase;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+\n+/**\n+ * Tests for loading the {@link PrometheusPushGatewayReporterFactory} and {@link PrometheusReporterFactory}.\n+ */\n+public class PrometheusMetricReporterFactoryTest extends MetricReporterSetupTestBase {", "originalCommit": "38cebe617ef8ec1088744d750b6887205a5b1a6e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzYzMjIyMA==", "url": "https://github.com/apache/flink/pull/12883#discussion_r453632220", "bodyText": "redundant due to usage in e2e tests.", "author": "zentol", "createdAt": "2020-07-13T13:01:56Z", "path": "flink-metrics/flink-metrics-slf4j/src/test/java/org/apache/flink/metrics/slf4j/Slf4jReporterFactoryTest.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.metrics.slf4j;\n+\n+import org.apache.flink.metrics.reporter.MetricReporterFactory;\n+import org.apache.flink.runtime.metrics.MetricReporterSetupTestBase;\n+\n+import java.util.Collections;\n+import java.util.List;\n+\n+/**\n+ * Tests for loading the {@link Slf4jReporterFactory}.\n+ */\n+public class Slf4jReporterFactoryTest extends MetricReporterSetupTestBase {\n+\n+\t@Override\n+\tprotected List<Class<? extends MetricReporterFactory>> getMetricReporterFactoryClass() {", "originalCommit": "38cebe617ef8ec1088744d750b6887205a5b1a6e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgwNDU5NA==", "url": "https://github.com/apache/flink/pull/12883#discussion_r453804594", "bodyText": "I think e2e test does not focus on this feature and unit test should just focus on one thing. If we change the implementation of e2e test one day, who would guarantee the SPI work successfully?\nI still prefer to include slf4j and Prometheus in the test scopes especially we already include tests for the rest 5 reporters.", "author": "Myasuka", "createdAt": "2020-07-13T17:16:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzYzMjIyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIxOTE1Ng==", "url": "https://github.com/apache/flink/pull/12883#discussion_r454219156", "bodyText": "The Prometheus e2e test very much focuses on this, and tests all configurations one can think of (jar in plugins/lib, loaded via reflection/factory).\nThe reason it is necessary to test as an e2e test is that this feature working in production is reliant on the packaging; if the services stuff isn't included in the jar then it just won't work, and the unit test cannot catch that.", "author": "zentol", "createdAt": "2020-07-14T09:16:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzYzMjIyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI1NjEwNw==", "url": "https://github.com/apache/flink/pull/12883#discussion_r454256107", "bodyText": "After looking at the PrometheusReporterEndToEndITCase, I agree that it has already focused on this and I'll skip to cover on slf4j and Prometheus modules.", "author": "Myasuka", "createdAt": "2020-07-14T10:23:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzYzMjIyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzYzMzQ1Mg==", "url": "https://github.com/apache/flink/pull/12883#discussion_r453633452", "bodyText": "It would be good to get rid of the dependency to flink-runtime; this change goes contrary to our goals of separating the metric modules from flink-runtime.\nThe ServiceLoader mechanism is standardized, so it's fine to just call ServiceLoader.load(MetricReporterFactory.class).iterator() here.", "author": "zentol", "createdAt": "2020-07-13T13:04:04Z", "path": "flink-runtime/src/test/java/org/apache/flink/runtime/metrics/MetricReporterSetupTestBase.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.runtime.metrics;\n+\n+import org.apache.flink.metrics.reporter.MetricReporterFactory;\n+import org.apache.flink.util.TestLogger;\n+\n+import org.junit.Test;\n+\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+\n+/**\n+ * The base class to verify metric reporter factory.\n+ */\n+public abstract class MetricReporterSetupTestBase extends TestLogger {\n+\n+\t@Test\n+\tpublic void testMetricReporterSetupViaSPI() {\n+\t\tIterator<MetricReporterFactory> factoryIterator = ReporterSetup.getAllReporterFactoriesViaSPI();", "originalCommit": "38cebe617ef8ec1088744d750b6887205a5b1a6e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzYzMzY3OA==", "url": "https://github.com/apache/flink/pull/12883#discussion_r453633678", "bodyText": "Let's not introduce inheritance for this. The test could just be a method that is being called with the factory class.", "author": "zentol", "createdAt": "2020-07-13T13:04:28Z", "path": "flink-runtime/src/test/java/org/apache/flink/runtime/metrics/MetricReporterSetupTestBase.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.runtime.metrics;\n+\n+import org.apache.flink.metrics.reporter.MetricReporterFactory;\n+import org.apache.flink.util.TestLogger;\n+\n+import org.junit.Test;\n+\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+\n+/**\n+ * The base class to verify metric reporter factory.\n+ */\n+public abstract class MetricReporterSetupTestBase extends TestLogger {", "originalCommit": "38cebe617ef8ec1088744d750b6887205a5b1a6e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc3Nzc1Ng==", "url": "https://github.com/apache/flink/pull/12883#discussion_r453777756", "bodyText": "If we do not inherit from a base class, we need to add this test method in 5 modules: flink-metrics-datadog, flink-metrics-graphite, flink-metrics-influxdb, flink-metrics-jmx and flink-metrics-statsd (if we give the background knowledge that Prometheus and slf4j reporter has been used in e2e tests). From my point of view, this would be too redundant.\nI could move the base test class from flink-runtime to flink-metrics-core  module to get rid of dependency of flink-runtime even they're in test scope. What do you think?", "author": "Myasuka", "createdAt": "2020-07-13T16:31:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzYzMzY3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIyMjAxMg==", "url": "https://github.com/apache/flink/pull/12883#discussion_r454222012", "bodyText": "It's fine to duplicate things. Factory support is optional after all, and having this as a simple opt-in method that external reporter implementations could use without interfering with class structures is useful.\nWe already see the downsides of inheritance in this PR; the test method must be unnecessarily complex since it must support the Prometheus case where there are multiple reporters, with a signature that for all other reporters doesn't make sense.", "author": "zentol", "createdAt": "2020-07-14T09:21:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzYzMzY3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI1NjY2OA==", "url": "https://github.com/apache/flink/pull/12883#discussion_r454256668", "bodyText": "Okay, I'll update the PR with duplicate test methods to see the final effect.", "author": "Myasuka", "createdAt": "2020-07-14T10:24:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzYzMzY3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzYzNzcwMw==", "url": "https://github.com/apache/flink/pull/12883#discussion_r453637703", "bodyText": "public static void testMetricReporterSetupViaSPI(Class<MetricReporterFactory> clazz) {\n\tSet<Class<? extends MetricReporterFactory>> loadedFactories = StreamSupport\n\t\t.stream(ServiceLoader.load(MetricReporterFactory.class).iterator(), false)\n\t\t.map(MetricReporterFactory::getClass)\n\t\t.collect(Collectors.toSet());\n\tassertThat(loadedFactories , hasItems(clazz));\n}", "author": "zentol", "createdAt": "2020-07-13T13:11:20Z", "path": "flink-runtime/src/test/java/org/apache/flink/runtime/metrics/MetricReporterSetupTestBase.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.runtime.metrics;\n+\n+import org.apache.flink.metrics.reporter.MetricReporterFactory;\n+import org.apache.flink.util.TestLogger;\n+\n+import org.junit.Test;\n+\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+\n+/**\n+ * The base class to verify metric reporter factory.\n+ */\n+public abstract class MetricReporterSetupTestBase extends TestLogger {\n+\n+\t@Test\n+\tpublic void testMetricReporterSetupViaSPI() {\n+\t\tIterator<MetricReporterFactory> factoryIterator = ReporterSetup.getAllReporterFactoriesViaSPI();\n+\t\tSet<String> metricReporterFactoryClasses = getMetricReporterFactoryClass().stream().map(Class::getCanonicalName).collect(Collectors.toSet());\n+\t\tassertFalse(metricReporterFactoryClasses.isEmpty());\n+\t\twhile (factoryIterator.hasNext()) {\n+\t\t\tMetricReporterFactory metricReporterFactory = factoryIterator.next();", "originalCommit": "38cebe617ef8ec1088744d750b6887205a5b1a6e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI2ODQ4MQ==", "url": "https://github.com/apache/flink/pull/12883#discussion_r454268481", "bodyText": "What I meant was to have this method:\npublic static void testMetricReporterSetupViaSPI(Class<MetricReporterFactory> clazz) {\n\tSet<Class<? extends MetricReporterFactory>> loadedFactories = StreamSupport\n\t\t.stream(ServiceLoader.load(MetricReporterFactory.class).iterator(), false)\n\t\t.map(MetricReporterFactory::getClass)\n\t\t.collect(Collectors.toSet());\n\tassertThat(loadedFactories , hasItems(clazz));\n}\n\nin flink-metrics-core, and the reporter tests just call it.", "author": "zentol", "createdAt": "2020-07-14T10:47:30Z", "path": "flink-metrics/flink-metrics-datadog/src/test/java/org/apache/flink/metrics/datadog/DatadogHttpReporterFactoryTest.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.metrics.datadog;\n+\n+import org.apache.flink.metrics.reporter.MetricReporterFactory;\n+import org.apache.flink.util.TestLogger;\n+\n+import org.junit.Test;\n+\n+import java.util.ServiceLoader;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.StreamSupport;\n+\n+import static org.hamcrest.Matchers.hasItem;\n+import static org.junit.Assert.assertThat;\n+\n+/**\n+ * Tests for the {@link DatadogHttpReporterFactory}.\n+ */\n+public class DatadogHttpReporterFactoryTest extends TestLogger {\n+\n+\t@Test\n+\tpublic void testMetricReporterSetupViaSPI() {\n+\t\tSet<Class<? extends MetricReporterFactory>> loadedFactories = StreamSupport", "originalCommit": "93616ee036d921efea80c8003e408d35339cc4ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMyMjQ3MA==", "url": "https://github.com/apache/flink/pull/12883#discussion_r454322470", "bodyText": "Hmm, no wonder I feel confused that you did not want the inherent test classes but still feel okay for those redundant code as they are really not much if following this idea.\nSorry for the misunderstanding, and already updated this PR", "author": "Myasuka", "createdAt": "2020-07-14T12:33:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI2ODQ4MQ=="}], "type": "inlineReview"}, {"oid": "1ff723dcfce4cf39d2bc216c22bbae747bc2aa9f", "url": "https://github.com/apache/flink/commit/1ff723dcfce4cf39d2bc216c22bbae747bc2aa9f", "message": "[FLINK-18573][metrics] Ensure metric reporters could be loaded via SPI", "committedDate": "2020-07-14T18:00:39Z", "type": "forcePushed"}, {"oid": "6a6278179f97044d4b6caff155434317acb3fe77", "url": "https://github.com/apache/flink/commit/6a6278179f97044d4b6caff155434317acb3fe77", "message": "[FLINK-18573][metrics][influxdb] Fix services directory name", "committedDate": "2020-07-14T18:02:23Z", "type": "commit"}, {"oid": "ed22112c4d28477c6e0b0df7780cf524ca05ae0f", "url": "https://github.com/apache/flink/commit/ed22112c4d28477c6e0b0df7780cf524ca05ae0f", "message": "[FLINK-18573][metrics] Add test for loading reporters via service loader", "committedDate": "2020-07-14T18:03:39Z", "type": "commit"}, {"oid": "ed22112c4d28477c6e0b0df7780cf524ca05ae0f", "url": "https://github.com/apache/flink/commit/ed22112c4d28477c6e0b0df7780cf524ca05ae0f", "message": "[FLINK-18573][metrics] Add test for loading reporters via service loader", "committedDate": "2020-07-14T18:03:39Z", "type": "forcePushed"}]}