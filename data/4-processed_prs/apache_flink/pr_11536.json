{"pr_number": 11536, "pr_title": "[FLINK-16807][e2e] Improve reporting for instantiation errors ", "pr_createdAt": "2020-03-26T17:09:04Z", "pr_url": "https://github.com/apache/flink/pull/11536", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUwODY0OQ==", "url": "https://github.com/apache/flink/pull/11536#discussion_r399508649", "bodyText": "(General comment: I'm not familiar enough with this part of the code yet to feel really qualified for a comment here, so I'm potentially shooting in the dark with this feedback item):\nAre we sure that we can always ignore the Exception e?\nDoes it make sense to add it as a cause to the RuntimeException, or log it on DEBUG level?\nThe CI on Azure for this PR was failing with the following error:\n[INFO] Running org.apache.flink.tests.util.kafka.StreamingKafkaITCase\n[ERROR] Tests run: 3, Failures: 0, Errors: 3, Skipped: 0, Time elapsed: 0.006 s <<< FAILURE! - in org.apache.flink.tests.util.kafka.StreamingKafkaITCase\n[ERROR] testKafka[0: kafka-version:0.10.2.0](org.apache.flink.tests.util.kafka.StreamingKafkaITCase)  Time elapsed: 0.004 s  <<< ERROR!\njava.lang.RuntimeException: Could not instantiate instance.\n\tat org.apache.flink.tests.util.kafka.StreamingKafkaITCase.<init>(StreamingKafkaITCase.java:72)\n\n[ERROR] testKafka[1: kafka-version:0.11.0.2](org.apache.flink.tests.util.kafka.StreamingKafkaITCase)  Time elapsed: 0.001 s  <<< ERROR!\njava.lang.RuntimeException: Could not instantiate instance.\n\tat org.apache.flink.tests.util.kafka.StreamingKafkaITCase.<init>(StreamingKafkaITCase.java:72)\n\n[ERROR] testKafka[2: kafka-version:2.2.0](org.apache.flink.tests.util.kafka.StreamingKafkaITCase)  Time elapsed: 0 s  <<< ERROR!\njava.lang.RuntimeException: Could not instantiate instance.\n\tat org.apache.flink.tests.util.kafka.StreamingKafkaITCase.<init>(StreamingKafkaITCase.java:72)\n\nI would have assumed that this PR is improving the exception output for this case specifically.\nI wonder if throwing a RuntimeException here is the right approach? Maybe we should have a checked exception type for this, so that we are forced to handle it at the call site (FlinkResource.get(), where we could rethrow with additonal information (\"Error instantiating FlinkResource\")).", "author": "rmetzger", "createdAt": "2020-03-27T19:59:47Z", "path": "flink-end-to-end-tests/flink-end-to-end-tests-common/src/main/java/org/apache/flink/tests/util/util/FactoryUtils.java", "diffHunk": "@@ -43,24 +45,43 @@\n \t * @throws RuntimeException if no or multiple resources could be instantiated\n \t * @return created instance\n \t */\n-\tpublic static <R, F> R loadAndInvokeFactory(final Class<F> factoryInterface, final Function<F, Optional<R>> factoryInvoker, final Supplier<F> defaultProvider) {\n+\tpublic static <R, F> R loadAndInvokeFactory(final Class<F> factoryInterface, final FactoryInvoker<F, R> factoryInvoker, final Supplier<F> defaultProvider) {\n \t\tfinal ServiceLoader<F> factories = ServiceLoader.load(factoryInterface);\n \n-\t\tfinal List<R> resources = StreamSupport.stream(factories.spliterator(), false)\n-\t\t\t.map(factoryInvoker)\n-\t\t\t.filter(Optional::isPresent)\n-\t\t\t.map(Optional::get)\n-\t\t\t.collect(Collectors.toList());\n+\t\tfinal List<R> instantiatedResources = new ArrayList<>();\n+\t\tfinal List<Exception> errorsDuringInitialization = new ArrayList<>();\n+\t\tfor (F factory : factories) {\n+\t\t\ttry {\n+\t\t\t\tR resource = factoryInvoker.invoke(factory);\n+\t\t\t\tinstantiatedResources.add(resource);\n+\t\t\t\tLOG.info(\"Instantiated {}.\", resource.getClass().getSimpleName());\n+\t\t\t} catch (Exception e) {\n+\t\t\t\tLOG.debug(\"Factory {} could not instantiate instance.\", factory.getClass().getSimpleName(), e);\n+\t\t\t\terrorsDuringInitialization.add(e);\n+\t\t\t}\n+\t\t}\n \n-\t\tif (resources.size() == 1) {\n-\t\t\treturn resources.get(0);\n+\t\tif (instantiatedResources.size() == 1) {\n+\t\t\treturn instantiatedResources.get(0);\n \t\t}\n \n-\t\tif (resources.isEmpty()) {\n-\t\t\treturn factoryInvoker.apply(defaultProvider.get())\n-\t\t\t\t.orElseThrow(() -> new RuntimeException(\"Could not instantiate instance using default factory.\"));\n+\t\tif (instantiatedResources.isEmpty()) {\n+\t\t\ttry {\n+\t\t\t\treturn factoryInvoker.invoke(defaultProvider.get());\n+\t\t\t} catch (Exception e) {\n+\t\t\t\tfinal RuntimeException exception = new RuntimeException(\"Could not instantiate instance.\");", "originalCommit": "02744178a91af131c0be0337a18e7cc65303495d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUzOTIyOA==", "url": "https://github.com/apache/flink/pull/11536#discussion_r399539228", "bodyText": "So, generally speaking it shouldn't be necessary to include e as a cause, the reason being that the default provider is usually included in the set of factories returned by ServiceLoader.load. This also implies that the error is already being logged.\nThere is only one exception to this which is the LolCache, which generally speaking should never fail (technically it could if it can't create a TemporaryDirectory, but then you likely have bigger problems).\nHandling at the call-site doesn't really give us a lot; we can't handle the error but only slightly enhance the error message which shouldn't be necessary in the first place. For some reason the stack trace is being trimmed to ridiculous degrees; which may also cause the suppressed exception to not be shown.\nI will investigate why this happens; I did try it with the FlinkResoure without distDir being set (the original original cause for this PR), and it displayed the right exception. But IIRC I did that in the IDE, so maybe maven/surefire is getting in the way here.", "author": "zentol", "createdAt": "2020-03-27T21:09:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUwODY0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU0ODc2Ng==", "url": "https://github.com/apache/flink/pull/11536#discussion_r399548766", "bodyText": "[...] the default provider is usually included in the set of factories returned by ServiceLoader.load.\n\nSo this is wrong. Neither the Flink nor Kafka resources have a services resource file, and are always loaded as default resources.\nI have amended the PR to also include the error of the default resource.\nI have found the reason for the trimmed stack trace (FLINK-16837, surefire being stupid and old) and have provided a fix for it in this PR.\nThe exception will now look like this:\njava.lang.RuntimeException: Could not instantiate any instance.\n        at org.apache.flink.tests.util.util.FactoryUtils.loadAndInvokeFactory(FactoryUtils.java:72)\n        at org.apache.flink.tests.util.flink.FlinkResource.get(FlinkResource.java:75)\n        at org.apache.flink.metrics.prometheus.tests.PrometheusReporterEndToEndITCase.<init>(PrometheusReporterEndToEndITCase.java:117)\n        at java.base/jdk.internal.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)\n        at java.base/jdk.internal.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)\n        at java.base/jdk.internal.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)\n        at java.base/java.lang.reflect.Constructor.newInstance(Constructor.java:490)\n        at org.junit.runners.BlockJUnit4ClassRunner.createTest(BlockJUnit4ClassRunner.java:217)\n        at org.junit.runners.BlockJUnit4ClassRunner$1.runReflectiveCall(BlockJUnit4ClassRunner.java:266)\n        at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)\n        at org.junit.runners.BlockJUnit4ClassRunner.methodBlock(BlockJUnit4ClassRunner.java:263)\n        at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:78)\n        at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:57)\n        at org.junit.runners.ParentRunner$3.run(ParentRunner.java:290)\n        at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71)\n        at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288)\n        at org.junit.runners.ParentRunner.access$000(ParentRunner.java:58)\n        at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268)\n        at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:26)\n        at org.junit.runners.ParentRunner.run(ParentRunner.java:363)\n        at org.junit.runners.Suite.runChild(Suite.java:128)\n        at org.junit.runners.Suite.runChild(Suite.java:27)\n        at org.junit.runners.ParentRunner$3.run(ParentRunner.java:290)\n        at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71)\n        at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288)\n        at org.junit.runners.ParentRunner.access$000(ParentRunner.java:58)\n        at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268)\n        at org.junit.runners.ParentRunner.run(ParentRunner.java:363)\n        at org.apache.maven.surefire.junitcore.JUnitCore.run(JUnitCore.java:55)\n        at org.apache.maven.surefire.junitcore.JUnitCoreWrapper.createRequestAndRun(JUnitCoreWrapper.java:137)\n        at org.apache.maven.surefire.junitcore.JUnitCoreWrapper.executeEager(JUnitCoreWrapper.java:107)\n        at org.apache.maven.surefire.junitcore.JUnitCoreWrapper.execute(JUnitCoreWrapper.java:83)\n        at org.apache.maven.surefire.junitcore.JUnitCoreWrapper.execute(JUnitCoreWrapper.java:75)\n        at org.apache.maven.surefire.junitcore.JUnitCoreProvider.invoke(JUnitCoreProvider.java:158)\n        at org.apache.maven.surefire.booter.ForkedBooter.invokeProviderInSameClassLoader(ForkedBooter.java:384)\n        at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:345)\n        at org.apache.maven.surefire.booter.ForkedBooter.execute(ForkedBooter.java:126)\n        at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:418)\n        Suppressed: java.lang.RuntimeException: Could not instantiate default instance.\n                at org.apache.flink.tests.util.util.FactoryUtils.loadAndInvokeFactory(FactoryUtils.java:73)\n                ... 37 more\n        Caused by: java.lang.IllegalArgumentException: The distDir property was not set. You can set it when running maven via -DdistDir=<path> .\n                at org.apache.flink.tests.util.flink.LocalStandaloneFlinkResourceFactory.create(LocalStandaloneFlinkResourceFactory.java:43)\n                at org.apache.flink.tests.util.flink.FlinkResource.lambda$get$0(FlinkResource.java:77)\n                at org.apache.flink.tests.util.util.FactoryUtils.loadAndInvokeFactory(FactoryUtils.java:70)\n                ... 37 more\n\nIt is a tad long, but surefire isn't flexible in this regard, and I rather have an exception that is verbose than one that hides critical information.", "author": "zentol", "createdAt": "2020-03-27T21:34:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUwODY0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU0OTEyOA==", "url": "https://github.com/apache/flink/pull/11536#discussion_r399549128", "bodyText": "This issue didn't show up in my test since I tried it with the Prometheus test which doesn't go through FlinkResource.get but directly works against a specific factory, so we're never within FactoryUtils.", "author": "zentol", "createdAt": "2020-03-27T21:35:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUwODY0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDk1NTQ4MA==", "url": "https://github.com/apache/flink/pull/11536#discussion_r400955480", "bodyText": "Thanks a lot!\nI can confirm that the error reporting is much better now!-", "author": "rmetzger", "createdAt": "2020-03-31T14:24:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUwODY0OQ=="}], "type": "inlineReview"}, {"oid": "a96a67f9c1aeacc4b6e8c63149597c0beb39e771", "url": "https://github.com/apache/flink/commit/a96a67f9c1aeacc4b6e8c63149597c0beb39e771", "message": "[FLINK-16837][build] Disable trimStackTrace in surefire-plugin", "committedDate": "2020-03-30T08:04:19Z", "type": "forcePushed"}, {"oid": "550035771736b29f89feae4bb60192ff9a4d924c", "url": "https://github.com/apache/flink/commit/550035771736b29f89feae4bb60192ff9a4d924c", "message": "[FLINK-16807][e2e] Improve reporting for instantiation errors", "committedDate": "2020-04-01T07:48:56Z", "type": "commit"}, {"oid": "4199584a0d1f4371db55b3e65784ede66a1bd103", "url": "https://github.com/apache/flink/commit/4199584a0d1f4371db55b3e65784ede66a1bd103", "message": "[FLINK-16808][e2e] Consolidated logging", "committedDate": "2020-04-01T07:48:56Z", "type": "commit"}, {"oid": "5dd19358b2b14a413ff53c7b1fd98581df675747", "url": "https://github.com/apache/flink/commit/5dd19358b2b14a413ff53c7b1fd98581df675747", "message": "[FLINK-16837][build] Disable trimStackTrace in surefire-plugin", "committedDate": "2020-04-01T07:48:56Z", "type": "commit"}, {"oid": "5dd19358b2b14a413ff53c7b1fd98581df675747", "url": "https://github.com/apache/flink/commit/5dd19358b2b14a413ff53c7b1fd98581df675747", "message": "[FLINK-16837][build] Disable trimStackTrace in surefire-plugin", "committedDate": "2020-04-01T07:48:56Z", "type": "forcePushed"}]}