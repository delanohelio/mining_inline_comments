{"pr_number": 11619, "pr_title": "[FLINK-16921][e2e] Make Kubernetes e2e test stable", "pr_createdAt": "2020-04-02T11:26:12Z", "pr_url": "https://github.com/apache/flink/pull/11619", "timeline": [{"oid": "f9aecde2c18f922e477df8fe399c2d27c973bafa", "url": "https://github.com/apache/flink/commit/f9aecde2c18f922e477df8fe399c2d27c973bafa", "message": "[FLINK-16921][e2e] Do not start/stop minikube in non-linux environment for k8s e2e tests", "committedDate": "2020-04-02T10:14:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI2MTM2Ng==", "url": "https://github.com/apache/flink/pull/11619#discussion_r402261366", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                echo \"Currently exiting Kubernetes resources\"\n          \n          \n            \n                echo \"Currently existing Kubernetes resources\"", "author": "rmetzger", "createdAt": "2020-04-02T12:06:46Z", "path": "flink-end-to-end-tests/test-scripts/common_kubernetes.sh", "diffHunk": "@@ -88,22 +86,43 @@ function start_kubernetes_if_not_running {\n }\n \n function start_kubernetes {\n-    [[ \"${OS_TYPE}\" = \"linux\" ]] && setup_kubernetes_for_linux\n-    if ! retry_times ${MINIKUBE_START_RETRIES} ${MINIKUBE_START_BACKOFF} start_kubernetes_if_not_running; then\n-        echo \"Could not start minikube. Aborting...\"\n-        exit 1\n+    if [[ \"${OS_TYPE}\" != \"linux\" ]]; then\n+        if ! check_kubernetes_status; then\n+            echo \"$NON_LINUX_ENV_NOTE\"\n+            exit 1\n+        fi\n+    else\n+        setup_kubernetes_for_linux\n+        if ! retry_times ${MINIKUBE_START_RETRIES} ${MINIKUBE_START_BACKOFF} start_kubernetes_if_not_running; then\n+            echo \"Could not start minikube. Aborting...\"\n+            exit 1\n+        fi\n     fi\n     eval $(minikube docker-env)\n }\n \n function stop_kubernetes {\n-    echo \"Stopping minikube ...\"\n-    stop_command=\"minikube stop\"\n-    [[ \"${OS_TYPE}\" = \"linux\" ]] && stop_command=\"sudo ${stop_command}\"\n-    if ! retry_times ${MINIKUBE_START_RETRIES} ${MINIKUBE_START_BACKOFF} \"${stop_command}\"; then\n-        echo \"Could not stop minikube. Aborting...\"\n-        exit 1\n+    if [[ \"${OS_TYPE}\" != \"linux\" ]]; then\n+        echo \"$NON_LINUX_ENV_NOTE\"\n+    else\n+        echo \"Stopping minikube ...\"\n+        stop_command=\"sudo minikube stop\"\n+        if ! retry_times ${MINIKUBE_START_RETRIES} ${MINIKUBE_START_BACKOFF} \"${stop_command}\"; then\n+            echo \"Could not stop minikube. Aborting...\"\n+            exit 1\n+        fi\n     fi\n }\n \n+function debug_copy_and_show_logs {\n+    echo \"Debugging failed Kubernetes test:\"\n+    echo \"Currently exiting Kubernetes resources\"", "originalCommit": "68c82eef3469c403b1a0f8a64c13f04d989bf145", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjcxNTMxNQ==", "url": "https://github.com/apache/flink/pull/11619#discussion_r402715315", "bodyText": "Nice catch. I will fix it.", "author": "wangyang0918", "createdAt": "2020-04-03T03:19:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI2MTM2Ng=="}], "type": "inlineReview"}, {"oid": "3747069ee6d5365440d04ec2bf521540877065e0", "url": "https://github.com/apache/flink/commit/3747069ee6d5365440d04ec2bf521540877065e0", "message": "[FLINK-16921][e2e] Print more information for debugging when Kubernetes e2e tests failed", "committedDate": "2020-04-03T03:23:15Z", "type": "commit"}, {"oid": "6bd37e40b9333d646bbf1bb1fbe286ad21d1e709", "url": "https://github.com/apache/flink/commit/6bd37e40b9333d646bbf1bb1fbe286ad21d1e709", "message": "[FLINK-16921][e2e] Wait for rest endpoint up and then submit Flink job to existing Kubernetes session", "committedDate": "2020-04-03T03:23:15Z", "type": "commit"}, {"oid": "6bd37e40b9333d646bbf1bb1fbe286ad21d1e709", "url": "https://github.com/apache/flink/commit/6bd37e40b9333d646bbf1bb1fbe286ad21d1e709", "message": "[FLINK-16921][e2e] Wait for rest endpoint up and then submit Flink job to existing Kubernetes session", "committedDate": "2020-04-03T03:23:15Z", "type": "forcePushed"}]}