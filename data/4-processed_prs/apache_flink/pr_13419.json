{"pr_number": 13419, "pr_title": "[FLINK-18842][e2e] Added 10min timeout to building the container.", "pr_createdAt": "2020-09-18T08:36:07Z", "pr_url": "https://github.com/apache/flink/pull/13419", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU4ODA1Mg==", "url": "https://github.com/apache/flink/pull/13419#discussion_r492588052", "bodyText": "We should be able to re-use run_test_with_timeout. All we basically need to do is move this\necho \"Printing Flink logs and killing it:\"\ncat ${FLINK_DIR}/log/*\n\ninto a separate function, and add a new run_with_timeout that accepts a timeout, run-command, and on-failure-command.\nrun_test_with_timeout() {\n  local TEST_TIMEOUT_SECONDS=$1\n  shift\n  local TEST_COMMAND=$@\n  internal_run_with_timeout $TEST_TIMEOUT_SECONDS \"$TEST_COMMAND\" print_logs\n}\n\nrun_with_timeout() {\n  internal_run_with_timeout $1 \"$2\" \"\"\n}\n\ninternal_run_with_timeout() {\n  local timeout=$1\n  local runCommand=$2\n  local onFailureCommand=$3\n\n  // do stuff\n}\n\nprint_logs() {\n  echo \"Printing Flink logs and killing it:\"\n   cat ${FLINK_DIR}/log/*\n}", "author": "zentol", "createdAt": "2020-09-22T09:14:58Z", "path": "flink-end-to-end-tests/test-scripts/common.sh", "diffHunk": "@@ -830,3 +830,30 @@ run_test_with_timeout() {\n       $TEST_COMMAND\n   )\n }\n+\n+run_with_timeout() {\n+  local timeout=\"$1\"\n+  shift\n+  local pidFile=\"$1\"\n+  shift\n+  local command=\"$@\"\n+\n+  # invoke command\n+  (eval \"$command\"; rm $pidFile; ) &\n+  pid=$!\n+  echo $pid > $pidFile\n+\n+  # invoke timeout guard\n+  (\n+    sleep $timeout\n+    if [[ -e $pidFile ]]; then", "originalCommit": "eedc94a8daeab56af338a0783e3bb2aa014d7191", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc0OTUxMQ==", "url": "https://github.com/apache/flink/pull/13419#discussion_r492749511", "bodyText": "First, I tried to make it work with the old implementation. But I struggled to test it locally on MacOS. Hence, I switched to the new implementation. I tried to make the code change not cause changes to test output. Let's see if the tests run through.", "author": "XComp", "createdAt": "2020-09-22T13:49:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU4ODA1Mg=="}], "type": "inlineReview"}, {"oid": "f49a8ca77cab83df2a0a5c11bc968ac2864fa48c", "url": "https://github.com/apache/flink/commit/f49a8ca77cab83df2a0a5c11bc968ac2864fa48c", "message": "[FLINK-18842][e2e] Added 10min timeout to building the container.", "committedDate": "2020-09-22T13:42:32Z", "type": "forcePushed"}, {"oid": "2d8d50ef9228af65e2df4393e5be8fb1752304a6", "url": "https://github.com/apache/flink/commit/2d8d50ef9228af65e2df4393e5be8fb1752304a6", "message": "[FLINK-18842][e2e] Added 10min timeout to building the container.", "committedDate": "2020-09-22T13:47:32Z", "type": "forcePushed"}, {"oid": "13127f0fb01159538233c928cdc1f1d7f74dbcd9", "url": "https://github.com/apache/flink/commit/13127f0fb01159538233c928cdc1f1d7f74dbcd9", "message": "[FLINK-18842][e2e] Switched back to old implementation.", "committedDate": "2020-09-23T13:59:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg4ODMzNg==", "url": "https://github.com/apache/flink/pull/13419#discussion_r493888336", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                run_with_timeout 600 \"${TEST_DATA_DIR}/docker-build-${RANDOM}.pid\" docker build --no-cache --network=\"host\" -t ${image_name} dev/${image_name}-debian\n          \n          \n            \n                run_with_timeout 600 docker build --no-cache --network=\"host\" -t ${image_name} dev/${image_name}-debian", "author": "zentol", "createdAt": "2020-09-23T20:53:03Z", "path": "flink-end-to-end-tests/test-scripts/common_docker.sh", "diffHunk": "@@ -50,7 +50,7 @@ function build_image() {\n     ./add-custom.sh -u localhost:9999/flink.tgz -n ${image_name}\n \n     echo \"Building images\"\n-    docker build --no-cache --network=\"host\" -t ${image_name} dev/${image_name}-debian\n+    run_with_timeout 600 \"${TEST_DATA_DIR}/docker-build-${RANDOM}.pid\" docker build --no-cache --network=\"host\" -t ${image_name} dev/${image_name}-debian", "originalCommit": "13127f0fb01159538233c928cdc1f1d7f74dbcd9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fa980bb0e5fb9cf2bbe3707def174ac02e70170d", "url": "https://github.com/apache/flink/commit/fa980bb0e5fb9cf2bbe3707def174ac02e70170d", "message": "[FLINK-18842][e2e] Added 10min timeout to building the container.", "committedDate": "2020-09-25T05:16:50Z", "type": "commit"}, {"oid": "e955f78bf582ca3b1c50e357d6ed5d7bfe159268", "url": "https://github.com/apache/flink/commit/e955f78bf582ca3b1c50e357d6ed5d7bfe159268", "message": "[FLINK-18842][e2e] Moved comment down to the actual function that is affected. Additionally, I added the specific feature that causes this comment.", "committedDate": "2020-09-25T05:21:22Z", "type": "commit"}, {"oid": "e955f78bf582ca3b1c50e357d6ed5d7bfe159268", "url": "https://github.com/apache/flink/commit/e955f78bf582ca3b1c50e357d6ed5d7bfe159268", "message": "[FLINK-18842][e2e] Moved comment down to the actual function that is affected. Additionally, I added the specific feature that causes this comment.", "committedDate": "2020-09-25T05:21:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgwMzgyMQ==", "url": "https://github.com/apache/flink/pull/13419#discussion_r495803821", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  (sleep \"${timeout_in_seconds}\" # set a timeout for this test\n          \n          \n            \n                  (sleep \"${timeout_in_seconds}\" # set a timeout for this command", "author": "zentol", "createdAt": "2020-09-28T09:23:55Z", "path": "flink-end-to-end-tests/test-scripts/common.sh", "diffHunk": "@@ -801,32 +801,44 @@ function extract_job_id_from_job_submission_return() {\n     echo \"$JOB_ID\"\n }\n \n-\n-#\n-# NOTE: This function requires at least Bash version >= 4. Mac OS in 2020 still ships 3.x\n-#\n kill_test_watchdog() {\n-    local watchdog_pid=`cat $TEST_DATA_DIR/job_watchdog.pid`\n+    local watchdog_pid=$(cat $TEST_DATA_DIR/job_watchdog.pid)\n     echo \"Stopping job timeout watchdog (with pid=$watchdog_pid)\"\n     kill $watchdog_pid\n }\n \n-run_test_with_timeout() {\n-  local TEST_TIMEOUT_SECONDS=$1\n-  shift\n-  local TEST_COMMAND=$@\n+#\n+# NOTE: This function requires at least Bash version >= 4 due to the usage of $BASHPID. Mac OS in 2020 still ships 3.x\n+#\n+internal_run_with_timeout() {\n+  local timeout_in_seconds=\"$1\"\n+  local on_failure=\"$2\"\n+  local command_label=\"$3\"\n+  local command=\"${@:4}\"\n \n   on_exit kill_test_watchdog\n \n   (\n-      cmdpid=$BASHPID\n-      (sleep $TEST_TIMEOUT_SECONDS # set a timeout for this test\n-      echo \"Test (pid: $cmdpid) did not finish after $TEST_TIMEOUT_SECONDS seconds.\"\n-      echo \"Printing Flink logs and killing it:\"\n-      cat ${FLINK_DIR}/log/*\n-      kill \"$cmdpid\") & watchdog_pid=$!\n+      command_pid=$BASHPID\n+      (sleep \"${timeout_in_seconds}\" # set a timeout for this test", "originalCommit": "e955f78bf582ca3b1c50e357d6ed5d7bfe159268", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2934e6f7d875ee5c6be368884baab4fd2e3797b0", "url": "https://github.com/apache/flink/commit/2934e6f7d875ee5c6be368884baab4fd2e3797b0", "message": "Update flink-end-to-end-tests/test-scripts/common.sh", "committedDate": "2020-09-28T09:26:19Z", "type": "commit"}]}