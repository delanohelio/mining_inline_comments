{"pr_number": 14184, "pr_title": "[FLINK-19852][task] Reuse TempBarrier memory between iterations", "pr_createdAt": "2020-11-23T20:59:19Z", "pr_url": "https://github.com/apache/flink/pull/14184", "timeline": [{"oid": "161581859c40da59bcbe5f8171aa11fd2b56e2bf", "url": "https://github.com/apache/flink/commit/161581859c40da59bcbe5f8171aa11fd2b56e2bf", "message": "[hotfix][task] Fix checkstyle/IDE warnings in BatchTask and TempBarrier", "committedDate": "2020-11-23T16:10:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTU0MDEzMA==", "url": "https://github.com/apache/flink/pull/14184#discussion_r529540130", "bodyText": "This condition seems the wrong way around.", "author": "StephanEwen", "createdAt": "2020-11-24T13:22:05Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/operators/BatchTask.java", "diffHunk": "@@ -893,21 +896,34 @@ protected void resetAllInputs() throws Exception {\n \t\t\t\t\t}\n \t\t\t\t} else {\n \t\t\t\t\t// close the async barrier if there is one\n-\t\t\t\t\tif (this.tempBarriers[i] != null) {\n-\t\t\t\t\t\tthis.tempBarriers[i].close();\n-\t\t\t\t\t\tthis.tempBarriers[i] = null;\n-\t\t\t\t\t}\n+\t\t\t\t\tList<MemorySegment> allocated = tempBarriers[i] == null ? emptyList() :\n+\t\t\t\t\t\ttempBarriers[i].closeAndGetLeftoverMemory();\n+\t\t\t\t\ttempBarriers[i] = null;\n \n-\t\t\t\t\t// recreate the local strategy\n-\t\t\t\t\tinitInputLocalStrategy(i);\n+\t\t\t\t\ttry {\n+\t\t\t\t\t\tinitInputLocalStrategy(i);\n \n-\t\t\t\t\tif (this.inputIsAsyncMaterialized[i]) {\n-\t\t\t\t\t\tfinal int pages = this.materializationMemory[i];\n-\t\t\t\t\t\t@SuppressWarnings({ \"unchecked\", \"rawtypes\" })\n-\t\t\t\t\t\tTempBarrier<?> barrier = new TempBarrier(this, getInput(i), this.inputSerializers[i], memMan, ioMan, pages);\n-\t\t\t\t\t\tbarrier.startReading();\n-\t\t\t\t\t\tthis.tempBarriers[i] = barrier;\n-\t\t\t\t\t\tthis.inputs[i] = null;\n+\t\t\t\t\t\tif (this.inputIsAsyncMaterialized[i]) {\n+\t\t\t\t\t\t\tfinal int pages = this.materializationMemory[i];\n+\t\t\t\t\t\t\tif (pages > allocated.size()) {", "originalCommit": "b5cb5d73481a41652fe13e99b427d50d41cd73e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTU0OTE0Nw==", "url": "https://github.com/apache/flink/pull/14184#discussion_r529549147", "bodyText": "You are right, thanks!\nI changed it to just\nPreconditions.checkState(allocated.size() <= pages);\n(pages should never change as you pointed out, but some of the allocated segments might have been consumed, so it's <= and not ==)", "author": "rkhachatryan", "createdAt": "2020-11-24T13:36:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTU0MDEzMA=="}], "type": "inlineReview"}, {"oid": "c5da44513c122deddcc354e16337a7fb7cd2370e", "url": "https://github.com/apache/flink/commit/c5da44513c122deddcc354e16337a7fb7cd2370e", "message": "[FLINK-19852][task] Reuse TempBarrier memory between iterations", "committedDate": "2020-11-24T13:32:41Z", "type": "commit"}, {"oid": "c5da44513c122deddcc354e16337a7fb7cd2370e", "url": "https://github.com/apache/flink/commit/c5da44513c122deddcc354e16337a7fb7cd2370e", "message": "[FLINK-19852][task] Reuse TempBarrier memory between iterations", "committedDate": "2020-11-24T13:32:41Z", "type": "forcePushed"}]}