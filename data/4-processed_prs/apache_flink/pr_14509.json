{"pr_number": 14509, "pr_title": "[FLINK-20654][checkpointing] Decline checkpoints until restored channel state is consumed", "pr_createdAt": "2020-12-28T14:52:52Z", "pr_url": "https://github.com/apache/flink/pull/14509", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTM5NTMzNg==", "url": "https://github.com/apache/flink/pull/14509#discussion_r549395336", "bodyText": "nit formatting", "author": "pnowojski", "createdAt": "2020-12-28T15:51:56Z", "path": "flink-runtime/src/test/java/org/apache/flink/runtime/io/network/partition/consumer/SingleInputGateTest.java", "diffHunk": "@@ -88,7 +94,14 @@\n /** Tests for {@link SingleInputGate}. */\n public class SingleInputGateTest extends InputGateTestBase {\n \n-    /**\n+    @Test(expected = CheckpointException.class)", "originalCommit": "53e02e1ff19305c2ae291727b9ae58a7488a3157", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "692de7c951bd21f3841560cc351c3aae3f33719c", "url": "https://github.com/apache/flink/commit/692de7c951bd21f3841560cc351c3aae3f33719c", "message": "[FLINK-20654][network] Fix channel indices in StreamTaskNetworkInput\n\nIn StreamTaskNetworkInput.prepareSnapshot, internal channelIndex\nis inconsistent with CheckpointedInputGate channelIndex.\n\nThis change fixes data loss in UnalignedCheckpointITCase.cogroup.", "committedDate": "2020-12-28T20:37:09Z", "type": "forcePushed"}, {"oid": "89cc24da926665e094006c6a825429c1efb7697c", "url": "https://github.com/apache/flink/commit/89cc24da926665e094006c6a825429c1efb7697c", "message": "[FLINK-20654][tests] Disable throttling on checkpoint completion, not snapshotState\n\nThis reduces the number of failures in UnalignedCheckpointITCase.union to ~2/100.", "committedDate": "2020-12-28T21:04:13Z", "type": "forcePushed"}, {"oid": "ad643bad232902ff5e2f5878dfd43776e2142ef1", "url": "https://github.com/apache/flink/commit/ad643bad232902ff5e2f5878dfd43776e2142ef1", "message": "[FLINK-20654][tests] Disable throttling on checkpoint completion, not snapshotState\n\nThis reduces the number of failures in UnalignedCheckpointITCase.union to ~2/100.", "committedDate": "2020-12-28T22:49:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTYxMDY3Ng==", "url": "https://github.com/apache/flink/pull/14509#discussion_r549610676", "bodyText": "As I understand from the offline discussion. Parallel union doesn't work while cogroup is almost working, but not quite - it's still failing? In that case I would keep this test ignored.", "author": "pnowojski", "createdAt": "2020-12-29T08:13:23Z", "path": "flink-tests/src/test/java/org/apache/flink/test/checkpointing/UnalignedCheckpointITCase.java", "diffHunk": "@@ -189,7 +189,6 @@ public UnalignedCheckpointITCase(String desc, UnalignedSettings settings) {\n     }\n \n     @Test\n-    @Ignore", "originalCommit": "36adcd40bc836c05b2dc63cff0a779ea4aeec41c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTYxOTIwOA==", "url": "https://github.com/apache/flink/pull/14509#discussion_r549619208", "bodyText": "I've fiixed the remaining issues with cogroup in Fix channel indices in StreamTaskNetworkInput.\nThe only failing test currently is union. But I commented it out so UnalignedCheckpointITCase should run, but shouldn't fail any builds.\nI can @Ignore it again if you prefer.", "author": "rkhachatryan", "createdAt": "2020-12-29T08:42:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTYxMDY3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY1OTQyMA==", "url": "https://github.com/apache/flink/pull/14509#discussion_r549659420", "bodyText": "If the remaining tests (apart of union) are stable, let's leave it as is. I thought that cogroup is also still failing sporadically.", "author": "pnowojski", "createdAt": "2020-12-29T10:50:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTYxMDY3Ng=="}], "type": "inlineReview"}, {"oid": "72bcb262c1443a4fe0f2cb2817c568e450ef0ae8", "url": "https://github.com/apache/flink/commit/72bcb262c1443a4fe0f2cb2817c568e450ef0ae8", "message": "[FLINK-20654][tests] Disable throttling on checkpoint completion, not snapshotState\n\nThis reduces the number of failures in UnalignedCheckpointITCase.union to ~2/100.", "committedDate": "2020-12-29T08:36:31Z", "type": "forcePushed"}, {"oid": "eda1fc4ace1e19652c97a883bc7411f6cbb99946", "url": "https://github.com/apache/flink/commit/eda1fc4ace1e19652c97a883bc7411f6cbb99946", "message": "[FLINK-20654][tests] Disable throttling on checkpoint completion, not snapshotState\n\nThis reduces the number of failures in UnalignedCheckpointITCase.union to ~2/100.", "committedDate": "2020-12-29T09:31:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY1ODE2MA==", "url": "https://github.com/apache/flink/pull/14509#discussion_r549658160", "bodyText": "The only reason why we need this, is because of StatusWatermarkValve? And theoretically we could migrate StatusWatermarkValve from raw indexes to InputChannelInfo and get rid of this conversion as well?\nIf so, that brings another question. Could there be a similar bugs in StatusWatermarkValve that originate from using raw int as channel index?", "author": "pnowojski", "createdAt": "2020-12-29T10:46:14Z", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/StreamTaskNetworkInput.java", "diffHunk": "@@ -73,21 +72,20 @@\n \n     private final DeserializationDelegate<StreamElement> deserializationDelegate;\n \n-    private final RecordDeserializer<DeserializationDelegate<StreamElement>>[] recordDeserializers;\n+    private final Map<InputChannelInfo, RecordDeserializer<DeserializationDelegate<StreamElement>>>\n+            recordDeserializers;\n+    private final Map<InputChannelInfo, Integer> flattenedChannelIndices;", "originalCommit": "fbe634b6ea1ba38207ccc1fdb0cd5b19d11ab05c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY4NzI0MQ==", "url": "https://github.com/apache/flink/pull/14509#discussion_r549687241", "bodyText": "The only reason why we need this, is because of StatusWatermarkValve? And theoretically we could migrate StatusWatermarkValve from raw indexes to InputChannelInfo and get rid of this conversion as well?\n\nYes, this is needed for StatusWatermarkValve which could also be migrated to InputChannelInfo.\nHowever, I couldn't find any issues there (or any other classes).", "author": "rkhachatryan", "createdAt": "2020-12-29T12:31:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY1ODE2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY1ODUyNg==", "url": "https://github.com/apache/flink/pull/14509#discussion_r549658526", "bodyText": "We are accessing this Map just once per buffer, so there should be no performance penalty?", "author": "pnowojski", "createdAt": "2020-12-29T10:47:20Z", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/io/StreamTaskNetworkInput.java", "diffHunk": "@@ -73,21 +72,20 @@\n \n     private final DeserializationDelegate<StreamElement> deserializationDelegate;\n \n-    private final RecordDeserializer<DeserializationDelegate<StreamElement>>[] recordDeserializers;\n+    private final Map<InputChannelInfo, RecordDeserializer<DeserializationDelegate<StreamElement>>>", "originalCommit": "fbe634b6ea1ba38207ccc1fdb0cd5b19d11ab05c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY4ODQzNg==", "url": "https://github.com/apache/flink/pull/14509#discussion_r549688436", "bodyText": "Yes, once per buffer. Moreover, map access was already there before:\n    private void processBuffer(BufferOrEvent bufferOrEvent) throws IOException {\n        lastChannel = channelIndexes.get(bufferOrEvent.getChannelInfo());\n\nso it shouldn't make any difference.", "author": "rkhachatryan", "createdAt": "2020-12-29T12:36:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY1ODUyNg=="}], "type": "inlineReview"}, {"oid": "172bf20d5196845436c6638c347df70366f4834d", "url": "https://github.com/apache/flink/commit/172bf20d5196845436c6638c347df70366f4834d", "message": "[hotfix][tests] Disable alignment timeout by default in UnalignedCheckpointITCase\n\nMost of the bugs in UC are revealed with higher back-pressure which is not created with alignment timeout.\nThis change disables it by default and adds a new test (p=20) with the timeout enabled.", "committedDate": "2020-12-29T14:00:43Z", "type": "commit"}, {"oid": "f0285f6c6e5305d84aea3de039e8debd81655ac6", "url": "https://github.com/apache/flink/commit/f0285f6c6e5305d84aea3de039e8debd81655ac6", "message": "[FLINK-20654][tests] Disable throttling on checkpoint completion, not snapshotState\n\nThis reduces the number of failures in UnalignedCheckpointITCase.union to ~2/100.", "committedDate": "2020-12-29T14:01:02Z", "type": "forcePushed"}, {"oid": "cfa8f599148497a91dae150e9a67030066389108", "url": "https://github.com/apache/flink/commit/cfa8f599148497a91dae150e9a67030066389108", "message": "[FLINK-20654][network] Fix channel indices in StreamTaskNetworkInput\n\nIn StreamTaskNetworkInput.prepareSnapshot, internal channelIndex\nis inconsistent with CheckpointedInputGate channelIndex.\n\nThis change fixes data loss in UnalignedCheckpointITCase.cogroup.", "committedDate": "2020-12-29T14:21:31Z", "type": "commit"}, {"oid": "c0194d5be34fbb0bd7558d0e46c7f373846587c3", "url": "https://github.com/apache/flink/commit/c0194d5be34fbb0bd7558d0e46c7f373846587c3", "message": "[FLINK-20654][checkpointing] Decline checkpoints until restored channel state is consumed\n\nIn scenarios with multiple inputs (e.g. co-group; not union) one input may receive a\ncheckpoint barrier while the second input is still restoring state. This (previous)\nstate is currently not included into the snapshot, which therefore will be incomplete.", "committedDate": "2020-12-29T14:21:31Z", "type": "commit"}, {"oid": "c0205568cf7f7436f2c3639cb26b8315085582da", "url": "https://github.com/apache/flink/commit/c0205568cf7f7436f2c3639cb26b8315085582da", "message": "[FLINK-20654][tests] Disable throttling on checkpoint completion, not snapshotState\n\nThis reduces the number of failures in UnalignedCheckpointITCase.union to ~2/100.", "committedDate": "2020-12-29T14:21:31Z", "type": "commit"}, {"oid": "c0205568cf7f7436f2c3639cb26b8315085582da", "url": "https://github.com/apache/flink/commit/c0205568cf7f7436f2c3639cb26b8315085582da", "message": "[FLINK-20654][tests] Disable throttling on checkpoint completion, not snapshotState\n\nThis reduces the number of failures in UnalignedCheckpointITCase.union to ~2/100.", "committedDate": "2020-12-29T14:21:31Z", "type": "forcePushed"}]}