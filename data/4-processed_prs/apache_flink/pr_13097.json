{"pr_number": 13097, "pr_title": "[FLINK-18864][python] Support key_by() operation for Python DataStrea\u2026", "pr_createdAt": "2020-08-10T03:02:54Z", "pr_url": "https://github.com/apache/flink/pull/13097", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcxMDk2NQ==", "url": "https://github.com/apache/flink/pull/13097#discussion_r467710965", "bodyText": "The key can be other types if key_by with type information. For example, ds.key_by(MyKeySelector(), Types.INT())", "author": "hequn8128", "createdAt": "2020-08-10T06:37:33Z", "path": "flink-python/src/main/java/org/apache/flink/datastream/runtime/functions/python/PickledKeySelector.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.datastream.runtime.functions.python;\n+\n+import org.apache.flink.api.java.functions.KeySelector;\n+import org.apache.flink.types.Row;\n+\n+import net.razorvine.pickle.Unpickler;\n+\n+/**\n+ * PickledKeySelector is responsible for extracting the first filed of the input row as key.\n+ * The input row is generated by python DataStream map function in the format of (key_selector.get_key(value), value)\n+ * tuple2.\n+ */\n+public class PickledKeySelector implements KeySelector<Row, Object> {\n+\n+\tprivate Unpickler unpickler = null;\n+\n+\t@Override\n+\tpublic Object getKey(Row value) throws Exception {\n+\n+\t\tif (this.unpickler == null) {\n+\t\t\tunpickler = new Unpickler();\n+\t\t}\n+\n+\t\tObject key = value.getField(0);\n+\t\tif (key instanceof byte[]) {", "originalCommit": "52e8670eef5651d09ad0defeb1a8729aa7c589ba", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcxMjQwMA==", "url": "https://github.com/apache/flink/pull/13097#discussion_r467712400", "bodyText": "Use java annotation to describe Java class(e.g., PickledKeySelector, DataStream).", "author": "hequn8128", "createdAt": "2020-08-10T06:41:58Z", "path": "flink-python/src/main/java/org/apache/flink/datastream/runtime/functions/python/PickledKeySelector.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.flink.datastream.runtime.functions.python;\n+\n+import org.apache.flink.api.java.functions.KeySelector;\n+import org.apache.flink.types.Row;\n+\n+import net.razorvine.pickle.Unpickler;\n+\n+/**\n+ * PickledKeySelector is responsible for extracting the first filed of the input row as key.", "originalCommit": "52e8670eef5651d09ad0defeb1a8729aa7c589ba", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcxMzg4MQ==", "url": "https://github.com/apache/flink/pull/13097#discussion_r467713881", "bodyText": ".keyBy(PickledKeySelector(), key_type_info)", "author": "hequn8128", "createdAt": "2020-08-10T06:46:48Z", "path": "flink-python/pyflink/datastream/data_stream.py", "diffHunk": "@@ -233,6 +234,54 @@ def flat_map(self, func: Union[Callable, FlatMapFunction], type_info: TypeInform\n             j_python_data_stream_scalar_function_operator\n         ))\n \n+    def key_by(self, key_selector: Union[Callable, KeySelector],\n+               key_type_info: TypeInformation = None) -> 'KeyedStream':\n+        \"\"\"\n+        Creates a new KeyedStream that uses the provided key for partitioning its operator states.\n+\n+        :param key_selector: The KeySelector to be used for extracting the key for partitioning.\n+        :param key_type_info: The type information describing the key type.\n+        :return: The DataStream with partitioned state(i.e. KeyedStream).\n+        \"\"\"\n+        if callable(key_selector):\n+            key_selector = KeySelectorFunctionWrapper(key_selector)\n+        if not isinstance(key_selector, (KeySelector, KeySelectorFunctionWrapper)):\n+            raise TypeError(\"Parameter key_selector should be a type of KeySelector.\")\n+\n+        gateway = get_gateway()\n+        PickledKeySelector = gateway.jvm \\\n+            .org.apache.flink.datastream.runtime.functions.python.PickledKeySelector\n+        j_output_type_info = self._j_data_stream.getTransformation().getOutputType()\n+        output_type_info = typeinfo._from_java_type(j_output_type_info)\n+        if key_type_info is None:\n+            key_type_info = Types.PICKLED_BYTE_ARRAY()\n+        generated_key_stream = KeyedStream(self.map(lambda x: (key_selector.get_key(x), x),\n+                                                    type_info=Types.ROW([key_type_info,\n+                                                                         output_type_info]))\n+                                           ._j_data_stream\n+                                           .keyBy(PickledKeySelector()))", "originalCommit": "52e8670eef5651d09ad0defeb1a8729aa7c589ba", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcxNDcwNA==", "url": "https://github.com/apache/flink/pull/13097#discussion_r467714704", "bodyText": "The method has never been used.", "author": "hequn8128", "createdAt": "2020-08-10T06:49:28Z", "path": "flink-python/pyflink/datastream/data_stream.py", "diffHunk": "@@ -233,6 +234,54 @@ def flat_map(self, func: Union[Callable, FlatMapFunction], type_info: TypeInform\n             j_python_data_stream_scalar_function_operator\n         ))\n \n+    def key_by(self, key_selector: Union[Callable, KeySelector],\n+               key_type_info: TypeInformation = None) -> 'KeyedStream':\n+        \"\"\"\n+        Creates a new KeyedStream that uses the provided key for partitioning its operator states.\n+\n+        :param key_selector: The KeySelector to be used for extracting the key for partitioning.\n+        :param key_type_info: The type information describing the key type.\n+        :return: The DataStream with partitioned state(i.e. KeyedStream).\n+        \"\"\"\n+        if callable(key_selector):\n+            key_selector = KeySelectorFunctionWrapper(key_selector)\n+        if not isinstance(key_selector, (KeySelector, KeySelectorFunctionWrapper)):\n+            raise TypeError(\"Parameter key_selector should be a type of KeySelector.\")\n+\n+        gateway = get_gateway()\n+        PickledKeySelector = gateway.jvm \\\n+            .org.apache.flink.datastream.runtime.functions.python.PickledKeySelector\n+        j_output_type_info = self._j_data_stream.getTransformation().getOutputType()\n+        output_type_info = typeinfo._from_java_type(j_output_type_info)\n+        if key_type_info is None:\n+            key_type_info = Types.PICKLED_BYTE_ARRAY()\n+        generated_key_stream = KeyedStream(self.map(lambda x: (key_selector.get_key(x), x),\n+                                                    type_info=Types.ROW([key_type_info,\n+                                                                         output_type_info]))\n+                                           ._j_data_stream\n+                                           .keyBy(PickledKeySelector()))\n+        generated_key_stream._original_data_type_info = output_type_info\n+        return generated_key_stream\n+\n+    def _align_output_type(self) -> 'DataStream':", "originalCommit": "52e8670eef5651d09ad0defeb1a8729aa7c589ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc1NjAwNQ==", "url": "https://github.com/apache/flink/pull/13097#discussion_r467756005", "bodyText": "Ok, I will remove it in this pr.", "author": "shuiqiangchen", "createdAt": "2020-08-10T08:28:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcxNDcwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcxNzQ0NQ==", "url": "https://github.com/apache/flink/pull/13097#discussion_r467717445", "bodyText": "Throw exception when perform set_parallelism, name, uid, etc.", "author": "hequn8128", "createdAt": "2020-08-10T06:57:35Z", "path": "flink-python/pyflink/datastream/data_stream.py", "diffHunk": "@@ -290,3 +339,39 @@ def _get_java_python_function_operator(self, func: Union[Function, FunctionWrapp\n             output_type_info.get_java_type_info(),\n             j_python_data_stream_function_info)\n         return j_python_data_stream_scalar_function_operator, output_type_info\n+\n+\n+class KeyedStream(DataStream):", "originalCommit": "52e8670eef5651d09ad0defeb1a8729aa7c589ba", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcxOTU3NQ==", "url": "https://github.com/apache/flink/pull/13097#discussion_r467719575", "bodyText": "The two tests are duplicated?", "author": "hequn8128", "createdAt": "2020-08-10T07:03:37Z", "path": "flink-python/pyflink/datastream/tests/test_data_stream.py", "diffHunk": "@@ -140,15 +135,68 @@ def flat_map(value):\n \n         flat_mapped_stream = ds.flat_map(flat_map, type_info=Types.ROW([Types.STRING(),\n                                                                         Types.INT()]))\n-        collect_util = DataStreamCollectUtil()\n-        collect_util.collect(flat_mapped_stream)\n+        self.collect_util.collect(flat_mapped_stream)\n         self.env.execute('flat_map_test')\n-        results = collect_util.results()\n+        results = self.collect_util.results()\n         expected = ['a,0', 'bdc,2', 'deeefg,4']\n         results.sort()\n         expected.sort()\n         self.assertEqual(expected, results)\n \n+    def test_key_by(self):\n+        element_collection = [('a', 0), ('b', 0), ('c', 1), ('d', 1), ('e', 2)]\n+        self.env.set_parallelism(1)\n+        ds = self.env.from_collection(element_collection,\n+                                      type_info=Types.ROW([Types.STRING(), Types.INT()]))\n+\n+        class AssertKeyMapFunction(MapFunction):\n+            def __init__(self):\n+                self.pre = None\n+\n+            def map(self, value):\n+                if value[0] == 'b':\n+                    assert self.pre == 'a'\n+                if value[0] == 'd':\n+                    assert self.pre == 'c'\n+                self.pre = value[0]\n+                return value\n+\n+        mapped_stream = ds.key_by(MyKeySelector()).map(AssertKeyMapFunction())\n+        self.collect_util.collect(mapped_stream)\n+        self.env.execute('key_by_test')\n+        results = self.collect_util.results()\n+        expected = [\"<Row('a', 0)>\", \"<Row('b', 0)>\", \"<Row('c', 1)>\", \"<Row('d', 1)>\",\n+                    \"<Row('e', 2)>\"]\n+        results.sort()\n+        expected.sort()\n+        self.assertEqual(expected, results)\n+\n+    def test_key_by_map(self):", "originalCommit": "52e8670eef5651d09ad0defeb1a8729aa7c589ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcyMTMwNA==", "url": "https://github.com/apache/flink/pull/13097#discussion_r467721304", "bodyText": "They are almost the same, but the second test is to make sure we have not changed the original DataStream after key_by() operation with two way map operation.", "author": "shuiqiangchen", "createdAt": "2020-08-10T07:08:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcxOTU3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcyOTI2Ng==", "url": "https://github.com/apache/flink/pull/13097#discussion_r467729266", "bodyText": "then we can use the second one to cover the first one.", "author": "hequn8128", "createdAt": "2020-08-10T07:29:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcxOTU3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc1NjEwMg==", "url": "https://github.com/apache/flink/pull/13097#discussion_r467756102", "bodyText": "Ok", "author": "shuiqiangchen", "createdAt": "2020-08-10T08:28:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcxOTU3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc1NDYwNQ==", "url": "https://github.com/apache/flink/pull/13097#discussion_r467754605", "bodyText": "Remove this method in this PR.", "author": "hequn8128", "createdAt": "2020-08-10T08:25:32Z", "path": "flink-python/pyflink/datastream/data_stream.py", "diffHunk": "@@ -233,6 +234,56 @@ def flat_map(self, func: Union[Callable, FlatMapFunction], type_info: TypeInform\n             j_python_data_stream_scalar_function_operator\n         ))\n \n+    def key_by(self, key_selector: Union[Callable, KeySelector],\n+               key_type_info: TypeInformation = None) -> 'KeyedStream':\n+        \"\"\"\n+        Creates a new KeyedStream that uses the provided key for partitioning its operator states.\n+\n+        :param key_selector: The KeySelector to be used for extracting the key for partitioning.\n+        :param key_type_info: The type information describing the key type.\n+        :return: The DataStream with partitioned state(i.e. KeyedStream).\n+        \"\"\"\n+        if callable(key_selector):\n+            key_selector = KeySelectorFunctionWrapper(key_selector)\n+        if not isinstance(key_selector, (KeySelector, KeySelectorFunctionWrapper)):\n+            raise TypeError(\"Parameter key_selector should be a type of KeySelector.\")\n+\n+        gateway = get_gateway()\n+        PickledKeySelector = gateway.jvm \\\n+            .org.apache.flink.datastream.runtime.functions.python.PickledKeySelector\n+        j_output_type_info = self._j_data_stream.getTransformation().getOutputType()\n+        output_type_info = typeinfo._from_java_type(j_output_type_info)\n+        is_key_pickled_byte_array = False\n+        if key_type_info is None:\n+            key_type_info = Types.PICKLED_BYTE_ARRAY()\n+            is_key_pickled_byte_array = True\n+        generated_key_stream = KeyedStream(self.map(lambda x: (key_selector.get_key(x), x),\n+                                                    type_info=Types.ROW([key_type_info,\n+                                                                         output_type_info]))\n+                                           ._j_data_stream\n+                                           .keyBy(PickledKeySelector(is_key_pickled_byte_array)))\n+        generated_key_stream._original_data_type_info = output_type_info\n+        return generated_key_stream\n+\n+    def _align_output_type(self) -> 'DataStream':", "originalCommit": "3a4fc8cbc9cab1b8395b92c33b960fe4913c6d4a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc1NjIwNg==", "url": "https://github.com/apache/flink/pull/13097#discussion_r467756206", "bodyText": "ok", "author": "shuiqiangchen", "createdAt": "2020-08-10T08:28:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc1NDYwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc1NDgzNw==", "url": "https://github.com/apache/flink/pull/13097#discussion_r467754837", "bodyText": "Throw exception when perform set_parallelism, name, uid, etc.", "author": "hequn8128", "createdAt": "2020-08-10T08:25:57Z", "path": "flink-python/pyflink/datastream/data_stream.py", "diffHunk": "@@ -290,3 +341,39 @@ def _get_java_python_function_operator(self, func: Union[Function, FunctionWrapp\n             output_type_info.get_java_type_info(),\n             j_python_data_stream_function_info)\n         return j_python_data_stream_scalar_function_operator, output_type_info\n+\n+\n+class KeyedStream(DataStream):", "originalCommit": "3a4fc8cbc9cab1b8395b92c33b960fe4913c6d4a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc1NTI5Ng==", "url": "https://github.com/apache/flink/pull/13097#discussion_r467755296", "bodyText": ".keyBy(PickledKeySelector(), key_type_info)", "author": "hequn8128", "createdAt": "2020-08-10T08:26:57Z", "path": "flink-python/pyflink/datastream/data_stream.py", "diffHunk": "@@ -233,6 +234,56 @@ def flat_map(self, func: Union[Callable, FlatMapFunction], type_info: TypeInform\n             j_python_data_stream_scalar_function_operator\n         ))\n \n+    def key_by(self, key_selector: Union[Callable, KeySelector],\n+               key_type_info: TypeInformation = None) -> 'KeyedStream':\n+        \"\"\"\n+        Creates a new KeyedStream that uses the provided key for partitioning its operator states.\n+\n+        :param key_selector: The KeySelector to be used for extracting the key for partitioning.\n+        :param key_type_info: The type information describing the key type.\n+        :return: The DataStream with partitioned state(i.e. KeyedStream).\n+        \"\"\"\n+        if callable(key_selector):\n+            key_selector = KeySelectorFunctionWrapper(key_selector)\n+        if not isinstance(key_selector, (KeySelector, KeySelectorFunctionWrapper)):\n+            raise TypeError(\"Parameter key_selector should be a type of KeySelector.\")\n+\n+        gateway = get_gateway()\n+        PickledKeySelector = gateway.jvm \\\n+            .org.apache.flink.datastream.runtime.functions.python.PickledKeySelector\n+        j_output_type_info = self._j_data_stream.getTransformation().getOutputType()\n+        output_type_info = typeinfo._from_java_type(j_output_type_info)\n+        is_key_pickled_byte_array = False\n+        if key_type_info is None:\n+            key_type_info = Types.PICKLED_BYTE_ARRAY()\n+            is_key_pickled_byte_array = True\n+        generated_key_stream = KeyedStream(self.map(lambda x: (key_selector.get_key(x), x),\n+                                                    type_info=Types.ROW([key_type_info,\n+                                                                         output_type_info]))\n+                                           ._j_data_stream\n+                                           .keyBy(PickledKeySelector(is_key_pickled_byte_array)))", "originalCommit": "3a4fc8cbc9cab1b8395b92c33b960fe4913c6d4a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "051cb0425e5a4e644abc4033cbe319a91a69cebd", "url": "https://github.com/apache/flink/commit/051cb0425e5a4e644abc4033cbe319a91a69cebd", "message": "[FLINK-18864][python] Support key_by() operation for Python DataStream API.", "committedDate": "2020-08-10T10:55:47Z", "type": "commit"}, {"oid": "fd88969eaa2c0dd3894566a4f1e2637e724a609d", "url": "https://github.com/apache/flink/commit/fd88969eaa2c0dd3894566a4f1e2637e724a609d", "message": "- fix PickledKeySelector to support user specified key type, clean key_by tests.", "committedDate": "2020-08-10T10:56:58Z", "type": "commit"}, {"oid": "545155322175ba49ef9973ccad13f93f0b57e2a0", "url": "https://github.com/apache/flink/commit/545155322175ba49ef9973ccad13f93f0b57e2a0", "message": "- resolve review issues.", "committedDate": "2020-08-10T10:56:58Z", "type": "commit"}, {"oid": "03a8bdd5a1f59e18ea58fafefacddd76c50a09be", "url": "https://github.com/apache/flink/commit/03a8bdd5a1f59e18ea58fafefacddd76c50a09be", "message": "- rebase master branch", "committedDate": "2020-08-10T11:18:42Z", "type": "commit"}, {"oid": "03a8bdd5a1f59e18ea58fafefacddd76c50a09be", "url": "https://github.com/apache/flink/commit/03a8bdd5a1f59e18ea58fafefacddd76c50a09be", "message": "- rebase master branch", "committedDate": "2020-08-10T11:18:42Z", "type": "forcePushed"}, {"oid": "eb8c81fd06223acfd43bf5b3f4778ba32e8b4ade", "url": "https://github.com/apache/flink/commit/eb8c81fd06223acfd43bf5b3f4778ba32e8b4ade", "message": "[FLINK-18864][python] Simplified test for key_by.", "committedDate": "2020-08-10T13:03:54Z", "type": "commit"}]}