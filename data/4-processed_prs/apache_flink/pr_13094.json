{"pr_number": 13094, "pr_title": "[FLINK-18766][python] Support add_sink() for Python DataStream API.", "pr_createdAt": "2020-08-09T15:57:32Z", "pr_url": "https://github.com/apache/flink/pull/13094", "timeline": [{"oid": "a8517591f8e26a91f25c00e2532af495b8fd3c7b", "url": "https://github.com/apache/flink/commit/a8517591f8e26a91f25c00e2532af495b8fd3c7b", "message": "[FLINK-18766][python] Support add_sink() for Python DataStream API.", "committedDate": "2020-08-09T15:53:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY1OTU2OQ==", "url": "https://github.com/apache/flink/pull/13094#discussion_r467659569", "bodyText": "It makes no sense to let Python users init SinkFunction with a Java object. I think we can make the SinkFunction extends JavaFunctionWrapper and add a get_java_function() method in JavaFunctionWrapper.\nMeanwhile, the JavaFunctionWrapper should support initialization both with a java string or a java object.", "author": "hequn8128", "createdAt": "2020-08-10T02:00:27Z", "path": "flink-python/pyflink/datastream/connectors.py", "diffHunk": "@@ -0,0 +1,37 @@\n+################################################################################\n+#  Licensed to the Apache Software Foundation (ASF) under one\n+#  or more contributor license agreements.  See the NOTICE file\n+#  distributed with this work for additional information\n+#  regarding copyright ownership.  The ASF licenses this file\n+#  to you under the Apache License, Version 2.0 (the\n+#  \"License\"); you may not use this file except in compliance\n+#  with the License.  You may obtain a copy of the License at\n+#\n+#      http://www.apache.org/licenses/LICENSE-2.0\n+#\n+#  Unless required by applicable law or agreed to in writing, software\n+#  distributed under the License is distributed on an \"AS IS\" BASIS,\n+#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+#  See the License for the specific language governing permissions and\n+# limitations under the License.\n+################################################################################\n+\n+\n+class SinkFunction(object):\n+    \"\"\"\n+    The base class for SinkFunctions.\n+    \"\"\"\n+\n+    def __init__(self, j_sink_func):", "originalCommit": "a8517591f8e26a91f25c00e2532af495b8fd3c7b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY1OTY3NQ==", "url": "https://github.com/apache/flink/pull/13094#discussion_r467659675", "bodyText": "Could we also add tests for SinkFunction. For example, you can add a CustomSinkFunction which extends SinkFunction. The code looks like:\nclass TestSinkFunction(SinkFunction):\n   def __init__(self, func):\n      ...\n   def get_results():\n     ...", "author": "hequn8128", "createdAt": "2020-08-10T02:00:45Z", "path": "flink-python/pyflink/datastream/connectors.py", "diffHunk": "@@ -0,0 +1,37 @@\n+################################################################################\n+#  Licensed to the Apache Software Foundation (ASF) under one\n+#  or more contributor license agreements.  See the NOTICE file\n+#  distributed with this work for additional information\n+#  regarding copyright ownership.  The ASF licenses this file\n+#  to you under the Apache License, Version 2.0 (the\n+#  \"License\"); you may not use this file except in compliance\n+#  with the License.  You may obtain a copy of the License at\n+#\n+#      http://www.apache.org/licenses/LICENSE-2.0\n+#\n+#  Unless required by applicable law or agreed to in writing, software\n+#  distributed under the License is distributed on an \"AS IS\" BASIS,\n+#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+#  See the License for the specific language governing permissions and\n+# limitations under the License.\n+################################################################################\n+\n+\n+class SinkFunction(object):", "originalCommit": "a8517591f8e26a91f25c00e2532af495b8fd3c7b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY3MDY5Nw==", "url": "https://github.com/apache/flink/pull/13094#discussion_r467670697", "bodyText": "It's better to add the SinkFunction in the functions.py", "author": "hequn8128", "createdAt": "2020-08-10T03:12:10Z", "path": "flink-python/pyflink/datastream/connectors.py", "diffHunk": "@@ -0,0 +1,37 @@\n+################################################################################\n+#  Licensed to the Apache Software Foundation (ASF) under one\n+#  or more contributor license agreements.  See the NOTICE file\n+#  distributed with this work for additional information\n+#  regarding copyright ownership.  The ASF licenses this file\n+#  to you under the Apache License, Version 2.0 (the\n+#  \"License\"); you may not use this file except in compliance\n+#  with the License.  You may obtain a copy of the License at\n+#\n+#      http://www.apache.org/licenses/LICENSE-2.0\n+#\n+#  Unless required by applicable law or agreed to in writing, software\n+#  distributed under the License is distributed on an \"AS IS\" BASIS,\n+#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+#  See the License for the specific language governing permissions and\n+# limitations under the License.\n+################################################################################\n+\n+\n+class SinkFunction(object):", "originalCommit": "a8517591f8e26a91f25c00e2532af495b8fd3c7b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b2d512352be69a3661708014f21f0dad16050c10", "url": "https://github.com/apache/flink/commit/b2d512352be69a3661708014f21f0dad16050c10", "message": "- make SinkFunction extend a JavaFunctionWrapper, add test case for add_sink().", "committedDate": "2020-08-10T03:45:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY5MjQ0MQ==", "url": "https://github.com/apache/flink/pull/13094#discussion_r467692441", "bodyText": "Add comments for this class.", "author": "hequn8128", "createdAt": "2020-08-10T05:22:18Z", "path": "flink-python/pyflink/datastream/functions.py", "diffHunk": "@@ -147,3 +150,34 @@ def _get_python_env():\n     gateway = get_gateway()\n     exec_type = gateway.jvm.org.apache.flink.table.functions.python.PythonEnv.ExecType.PROCESS\n     return gateway.jvm.org.apache.flink.table.functions.python.PythonEnv(exec_type)\n+\n+\n+class JavaFunctionWrapper(object):", "originalCommit": "b2d512352be69a3661708014f21f0dad16050c10", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY5Mjc1Nw==", "url": "https://github.com/apache/flink/pull/13094#discussion_r467692757", "bodyText": "Move this logic into JavaFunctionWrapper so that can be shared by other classes, e.g., SourceFunction.", "author": "hequn8128", "createdAt": "2020-08-10T05:24:07Z", "path": "flink-python/pyflink/datastream/functions.py", "diffHunk": "@@ -147,3 +150,34 @@ def _get_python_env():\n     gateway = get_gateway()\n     exec_type = gateway.jvm.org.apache.flink.table.functions.python.PythonEnv.ExecType.PROCESS\n     return gateway.jvm.org.apache.flink.table.functions.python.PythonEnv(exec_type)\n+\n+\n+class JavaFunctionWrapper(object):\n+\n+    def __init__(self, j_function):\n+        self._j_function = j_function\n+\n+    def get_java_function(self):\n+        return self._j_function\n+\n+\n+class SinkFunction(JavaFunctionWrapper):\n+    \"\"\"\n+    The base class for SinkFunctions.\n+    \"\"\"\n+\n+    def __init__(self, sink_func: Union[str, JavaObject], *args):\n+        \"\"\"\n+        Constructor of SinkFunction.\n+\n+        :param sink_func: The java SinkFunction object.\n+        \"\"\"\n+        if isinstance(sink_func, str):\n+            j_source_func_class = get_gateway().jvm.__getattr__(sink_func)\n+            if len(args) > 0:\n+                j_sink_func = j_source_func_class(*args)\n+            else:\n+                j_sink_func = j_source_func_class()\n+        else:\n+            j_sink_func = sink_func\n+        super(SinkFunction, self).__init__(j_sink_func)", "originalCommit": "b2d512352be69a3661708014f21f0dad16050c10", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY5MzY5Ng==", "url": "https://github.com/apache/flink/pull/13094#discussion_r467693696", "bodyText": "The test is useless here, as it uses the DataStreamCollectUtil to collect and verify. The add_sink has not been tested. You can add a CustomSinkFunction which extends SinkFunction. The code looks like:\nclass TestSinkFunction(SinkFunction):\n   def __init__(self, func):\n      ...\n   def get_results():\n     ...", "author": "hequn8128", "createdAt": "2020-08-10T05:28:59Z", "path": "flink-python/pyflink/datastream/tests/test_data_stream.py", "diffHunk": "@@ -149,6 +149,22 @@ def flat_map(value):\n         expected.sort()\n         self.assertEqual(expected, results)\n \n+    def test_add_sink_with_sink_func_class(self):", "originalCommit": "b2d512352be69a3661708014f21f0dad16050c10", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY5NTc0MA==", "url": "https://github.com/apache/flink/pull/13094#discussion_r467695740", "bodyText": "If you want to support *args, you need to take all types into consideration, i.e., convert different python types to java types. I think we don't need to support *args here.", "author": "hequn8128", "createdAt": "2020-08-10T05:38:12Z", "path": "flink-python/pyflink/datastream/functions.py", "diffHunk": "@@ -147,3 +150,34 @@ def _get_python_env():\n     gateway = get_gateway()\n     exec_type = gateway.jvm.org.apache.flink.table.functions.python.PythonEnv.ExecType.PROCESS\n     return gateway.jvm.org.apache.flink.table.functions.python.PythonEnv(exec_type)\n+\n+\n+class JavaFunctionWrapper(object):\n+\n+    def __init__(self, j_function):\n+        self._j_function = j_function\n+\n+    def get_java_function(self):\n+        return self._j_function\n+\n+\n+class SinkFunction(JavaFunctionWrapper):\n+    \"\"\"\n+    The base class for SinkFunctions.\n+    \"\"\"\n+\n+    def __init__(self, sink_func: Union[str, JavaObject], *args):", "originalCommit": "b2d512352be69a3661708014f21f0dad16050c10", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ec8d9a8dc42c92427dbb9c51b69be9eaae4cd889", "url": "https://github.com/apache/flink/commit/ec8d9a8dc42c92427dbb9c51b69be9eaae4cd889", "message": "- resolve review issues.", "committedDate": "2020-08-10T06:37:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcyNzM5NA==", "url": "https://github.com/apache/flink/pull/13094#discussion_r467727394", "bodyText": "The test would fail, i.e., there is no collect method on collect_util.", "author": "hequn8128", "createdAt": "2020-08-10T07:24:41Z", "path": "flink-python/pyflink/datastream/tests/test_stream_execution_environment.py", "diffHunk": "@@ -216,7 +216,7 @@ def test_execute(self):\n \n     def test_from_collection_without_data_types(self):\n         ds = self.env.from_collection([(1, 'Hi', 'Hello'), (2, 'Hello', 'Hi')])\n-        collect_util = DataStreamCollectUtil()\n+        collect_util = DataStreamTestSinkFunction()", "originalCommit": "ec8d9a8dc42c92427dbb9c51b69be9eaae4cd889", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcyOTE5MA==", "url": "https://github.com/apache/flink/pull/13094#discussion_r467729190", "bodyText": "Sorry, I forget to update this part.", "author": "shuiqiangchen", "createdAt": "2020-08-10T07:28:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcyNzM5NA=="}], "type": "inlineReview"}, {"oid": "ee75e6cf97ecb11fcff6f48251f0804a6d04c7d4", "url": "https://github.com/apache/flink/commit/ee75e6cf97ecb11fcff6f48251f0804a6d04c7d4", "message": "- fix test for test_stream_execution_environment.", "committedDate": "2020-08-10T07:34:17Z", "type": "commit"}]}