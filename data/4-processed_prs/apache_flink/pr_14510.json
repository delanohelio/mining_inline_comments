{"pr_number": 14510, "pr_title": "[FLINK-19656] [metrics] filter delimiter in metrics components", "pr_createdAt": "2020-12-28T15:14:08Z", "pr_url": "https://github.com/apache/flink/pull/14510", "timeline": [{"oid": "0f3b4c5c88e5bde16c5785750dd7eeae845ed84a", "url": "https://github.com/apache/flink/commit/0f3b4c5c88e5bde16c5785750dd7eeae845ed84a", "message": "[FLINK-19656] Apply deprecation of metrics.scope.delimiter configuration parameter", "committedDate": "2020-12-28T15:42:17Z", "type": "forcePushed"}, {"oid": "932157724cf6bd963643aa9970c82ce0e0b2c8fe", "url": "https://github.com/apache/flink/commit/932157724cf6bd963643aa9970c82ce0e0b2c8fe", "message": "[FLINK-19656] Add a test to make sure that the configured delimiter is used in filtering variable names and values in getAllVariables().", "committedDate": "2020-12-30T18:06:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI0NDI3NA==", "url": "https://github.com/apache/flink/pull/14510#discussion_r551244274", "bodyText": "It is not required to extend this interface since the FrontMetricGroup works against the AbstractMetricGroup, and we currently don't want to extend this interface further.\n(This will also render some other changes moot)", "author": "zentol", "createdAt": "2021-01-04T10:50:46Z", "path": "flink-metrics/flink-metrics-core/src/main/java/org/apache/flink/metrics/MetricGroup.java", "diffHunk": "@@ -186,6 +186,15 @@\n      */\n     Map<String, String> getAllVariables();\n \n+    /**\n+     * Returns a map of all variables and their associated value, for example {@code\n+     * {\"<host>\"=\"host-7\", \"<tm_id>\"=\"taskmanager-2\"}}.\n+     *\n+     * @param filter character filter which is applied to the variables and values if not null.\n+     * @return map of all variables and their associated value\n+     */\n+    Map<String, String> getAllVariables(CharacterFilter filter);", "originalCommit": "932157724cf6bd963643aa9970c82ce0e0b2c8fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDkzMzg0MA==", "url": "https://github.com/apache/flink/pull/14510#discussion_r554933840", "bodyText": "Yes, I hesitated on that one, I tried to make it as general as possible. But if you don't want to extend the interface, fair enough, I'll revert the interface extension and related changes.\nBesides, do you think that having the getAllVariables(CharacterFilter filter) version in AbstractMetricGroup makes sense or only in FrontMetricGroup ?", "author": "echauchot", "createdAt": "2021-01-11T10:02:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI0NDI3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDk5NjY4Nw==", "url": "https://github.com/apache/flink/pull/14510#discussion_r554996687", "bodyText": "I think we will need it in the AbstractMetricGroup.\nIdeally no class works directly against the FrontMetricGroup; this currently only happens for some reporters because we do not find the time to properly move getLogicalScope() into the MetricGroup interface.", "author": "zentol", "createdAt": "2021-01-11T11:56:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI0NDI3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTY1OTIyNA==", "url": "https://github.com/apache/flink/pull/14510#discussion_r555659224", "bodyText": "ok clear, thanks", "author": "echauchot", "createdAt": "2021-01-12T10:16:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI0NDI3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI1MTk1Mw==", "url": "https://github.com/apache/flink/pull/14510#discussion_r551251953", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                CharacterFilter wrapWithDefaultFilter(CharacterFilter filter, char delimiter) {\n          \n          \n            \n                private CharacterFilter wrapWithDefaultFilter(CharacterFilter filter, char delimiter) {", "author": "zentol", "createdAt": "2021-01-04T11:06:28Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/metrics/groups/AbstractMetricGroup.java", "diffHunk": "@@ -119,12 +122,28 @@ public AbstractMetricGroup(MetricRegistry registry, String[] scope, A parent) {\n         this.variables = new Map[registry.getNumberReporters() + 1];\n     }\n \n+    CharacterFilter wrapWithDefaultFilter(CharacterFilter filter, char delimiter) {", "originalCommit": "932157724cf6bd963643aa9970c82ce0e0b2c8fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTAwMjIwMg==", "url": "https://github.com/apache/flink/pull/14510#discussion_r555002202", "bodyText": "oups I forgot to reduce visibilities, thanks for catching !", "author": "echauchot", "createdAt": "2021-01-11T12:08:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI1MTk1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI1MjQzNA==", "url": "https://github.com/apache/flink/pull/14510#discussion_r551252434", "bodyText": "I'd like to keep the reporterIndex as the first argument because all other arguments are somewhat dependent on it", "author": "zentol", "createdAt": "2021-01-04T11:07:35Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/metrics/groups/AbstractMetricGroup.java", "diffHunk": "@@ -119,12 +122,28 @@ public AbstractMetricGroup(MetricRegistry registry, String[] scope, A parent) {\n         this.variables = new Map[registry.getNumberReporters() + 1];\n     }\n \n+    CharacterFilter wrapWithDefaultFilter(CharacterFilter filter, char delimiter) {\n+        CharacterFilter defaultFilter = input -> input.replace(delimiter, DEFAULT_REPLACEMENT);\n+        return filter == null\n+                ? defaultFilter\n+                : input -> defaultFilter.filterCharacters(filter.filterCharacters(input));\n+    }\n+\n     @Override\n     public Map<String, String> getAllVariables() {\n-        return internalGetAllVariables(0, Collections.emptySet());\n+        return internalGetAllVariables(null, 0, Collections.emptySet(), registry.getDelimiter());\n+    }\n+\n+    @Override\n+    public Map<String, String> getAllVariables(CharacterFilter filter) {\n+        return internalGetAllVariables(filter, 0, Collections.emptySet(), registry.getDelimiter());\n     }\n \n-    public Map<String, String> getAllVariables(int reporterIndex, Set<String> excludedVariables) {\n+    public Map<String, String> getAllVariables(\n+            CharacterFilter filter,\n+            int reporterIndex,\n+            Set<String> excludedVariables,\n+            char delimiter) {", "originalCommit": "932157724cf6bd963643aa9970c82ce0e0b2c8fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTAwMjQzMg==", "url": "https://github.com/apache/flink/pull/14510#discussion_r555002432", "bodyText": "+1", "author": "echauchot", "createdAt": "2021-01-11T12:08:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI1MjQzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI1NTk2Ng==", "url": "https://github.com/apache/flink/pull/14510#discussion_r551255966", "bodyText": "There should also be a test that an exclusion that matches the filtered variable (e.g., k_1) is not applied. (i.e., that exclusions are always applied before they are filtered)\nThat said, I don't think that currently works correctly if a group retrieves variables from a parent, because they will already have the default filter applied to them.", "author": "zentol", "createdAt": "2021-01-04T11:15:30Z", "path": "flink-runtime/src/test/java/org/apache/flink/runtime/metrics/groups/AbstractMetricGroupTest.java", "diffHunk": "@@ -415,4 +419,119 @@ public void testGetAllVariablesDoesNotDeadlock() throws InterruptedException {\n             childRegisteringThread.join();\n         }\n     }\n+\n+    @Test\n+    public void testReporterDelimiterIsFiltered() throws Exception {\n+        MetricConfig metricConfig = new MetricConfig();\n+        metricConfig.setProperty(\n+                ConfigConstants.METRICS_REPORTER_SCOPE_DELIMITER, String.valueOf('*'));\n+\n+        MetricRegistryImpl metricRegistry =\n+                new MetricRegistryImpl(\n+                        MetricRegistryConfiguration.defaultMetricRegistryConfiguration(),\n+                        Collections.singletonList(\n+                                ReporterSetup.forReporter(\n+                                        \"test\", metricConfig, new TestReporter())));\n+        try {\n+            String metricName = \"Test*Counter\";\n+            TaskManagerMetricGroup metricGroup =\n+                    new TaskManagerMetricGroup(metricRegistry, \"hos*t\", \"i*d\");\n+            Counter counter = metricGroup.counter(metricName);\n+            TestReporter reporter = (TestReporter) metricRegistry.getReporters().get(0);\n+            final String expected =\n+                    String.format(\n+                            \"%s%s%s%s%s%s%s\",\n+                            \"hos*t\".replace('*', AbstractMetricGroup.DEFAULT_REPLACEMENT),\n+                            '*',\n+                            TaskExecutor.TASK_MANAGER_NAME.replace(\n+                                    '*', AbstractMetricGroup.DEFAULT_REPLACEMENT),\n+                            '*',\n+                            \"i*d\".replace('*', AbstractMetricGroup.DEFAULT_REPLACEMENT),\n+                            '*',\n+                            metricName.replace('*', AbstractMetricGroup.DEFAULT_REPLACEMENT));\n+            assertEquals(expected, reporter.getCounters().get(counter));\n+        } finally {\n+            metricRegistry.shutdown().get();\n+        }\n+    }\n+\n+    private static class TestReporter extends AbstractReporter {\n+        @Override\n+        public void open(MetricConfig config) {}\n+\n+        @Override\n+        public void close() {}\n+\n+        public Map<Counter, String> getCounters() {\n+            return counters;\n+        }\n+\n+        @Override\n+        public String filterCharacters(String input) {\n+            return input;\n+        }\n+    }\n+\n+    @Test\n+    public void testLowLevelGetAllVariablesWithFilterAndDelimiter() throws Exception {\n+        MetricRegistry registry = TestingMetricRegistry.builder().setNumberReporters(2).build();\n+\n+        AbstractMetricGroup<?> group =\n+                new GenericMetricGroup(registry, null, \"test\") {\n+                    @Override\n+                    protected void putVariables(Map<String, String> variables) {\n+                        variables.put(\"k*1\", \"v*1\");\n+                        variables.put(\"k*2\", \"v*2\");\n+                    }\n+                };\n+\n+        Map<String, String> allVariables;\n+        final CharacterFilter simpleFilter = input -> input.replace('1', 'a');\n+\n+        // test filter wrapping\n+        allVariables = group.getAllVariables(simpleFilter, 0, Collections.emptySet(), '*');\n+        assertThat(allVariables, IsMapContaining.hasKey(\"k_a\"));\n+        assertThat(allVariables, IsMapContaining.hasValue(\"v_a\"));\n+\n+        // test default filter, add exclusions to avoid cache hit\n+        allVariables = group.getAllVariables(null, 1, Collections.singleton(\"k*2\"), '*');\n+        assertThat(allVariables, IsMapContaining.hasKey(\"k_1\"));\n+        assertThat(allVariables, IsMapContaining.hasValue(\"v_1\"));", "originalCommit": "932157724cf6bd963643aa9970c82ce0e0b2c8fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTA0NTgyMA==", "url": "https://github.com/apache/flink/pull/14510#discussion_r555045820", "bodyText": "as stated in the comment in the code, this exclusion is added only to avoid cache hit. It is not clear enough, I'll replace it by just recreating the group.\nRegarding exclusions, I'll add proper tests for filtered exclusions, thanks for pointing out.", "author": "echauchot", "createdAt": "2021-01-11T13:28:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI1NTk2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI2MTAzMQ==", "url": "https://github.com/apache/flink/pull/14510#discussion_r551261031", "bodyText": "This implies that variables returned by parent.getAllVariables() already had a filter applied to them for a delimiter that may not be matching delimiter (i.e., registry.getDelimiter()).\nFurthermore, this also means that exclusion may not be applied correctly.\nI think we need to restrict the filtering to cases where the calls originate from a reporter.", "author": "zentol", "createdAt": "2021-01-04T11:26:24Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/metrics/groups/AbstractMetricGroup.java", "diffHunk": "@@ -137,11 +156,18 @@ public AbstractMetricGroup(MetricRegistry registry, String[] scope, A parent) {\n         // if no variables are excluded (which is the default!) we re-use the general variables map\n         // to save space\n         return internalGetAllVariables(\n-                excludedVariables.isEmpty() ? 0 : reporterIndex, excludedVariables);\n+                filter,\n+                excludedVariables.isEmpty() ? 0 : reporterIndex,\n+                excludedVariables,\n+                delimiter);\n     }\n \n     private Map<String, String> internalGetAllVariables(\n-            int cachingIndex, Set<String> excludedVariables) {\n+            CharacterFilter filter,\n+            int cachingIndex,\n+            Set<String> excludedVariables,\n+            char delimiter) {\n+        CharacterFilter newFilter = wrapWithDefaultFilter(filter, delimiter);", "originalCommit": "932157724cf6bd963643aa9970c82ce0e0b2c8fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTA4OTc1OA==", "url": "https://github.com/apache/flink/pull/14510#discussion_r555089758", "bodyText": "ah yeah, thanks for pointing out ! Anyway same goes for the AbstractMetricGroup#getMetricIdentifier() case no ?", "author": "echauchot", "createdAt": "2021-01-11T14:36:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI2MTAzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTEyNjU5MQ==", "url": "https://github.com/apache/flink/pull/14510#discussion_r555126591", "bodyText": "It shouldn't be a problem for getMetricIdentifier(); this method only relies on this.scopeComponents which is constant and does not fetch anything from parent groups.\nMaybe I haven't explained this well.\nLet's say the delimiter is -, the global default delimiter (returned by registry.getDelimiter()) is ., and we have a variable defined in a parent group called -aaa..\nThe result we want is _aaa..\nThe problem is you retrieved this variable in the first place via parent.getAllVariables(). This one doesn't know about your filter, and uses the delimiter returned by registry.getDelimiter(). It will apply this filter, resulting in -aaa_, and when your filter is applied we end up with _aaa_, which is not what we want.\nThe easiest way I see to solve is to only wrap the filter if the cachingIndexis greater than 0.", "author": "zentol", "createdAt": "2021-01-11T15:28:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI2MTAzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTY3NDUzNQ==", "url": "https://github.com/apache/flink/pull/14510#discussion_r555674535", "bodyText": "thanks for the details.\nIt was clear already for the getAllVariables() inheritance case.", "author": "echauchot", "createdAt": "2021-01-12T10:40:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI2MTAzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTgyNDQ5OA==", "url": "https://github.com/apache/flink/pull/14510#discussion_r555824498", "bodyText": "besides I don't think that testing cachingIndex > 0 is enough to detect that the call was done by a reporter because if excluded variables are empty cachingIndex is set to 0 (to save memory space) even when the call is done by a reporter.", "author": "echauchot", "createdAt": "2021-01-12T14:44:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI2MTAzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjE2MTc2Mg==", "url": "https://github.com/apache/flink/pull/14510#discussion_r556161762", "bodyText": "Good catch; we have to extend that optimization to only trigger if there is neither a filter nor any excluded variables.", "author": "zentol", "createdAt": "2021-01-12T23:21:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI2MTAzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjUyNjQ1Nw==", "url": "https://github.com/apache/flink/pull/14510#discussion_r556526457", "bodyText": "what I did for clarity is that internalGetAllVariables takes a boolean calledFromReporter that is true when the provided reporterIndex is valid. AbstractMetricGroup#getAllVariables() and AbstractMetricGroup#getAllVariables(CharacterFilter filter) that call this method with registry.getDelimiter() pass calledFromReporter == false.\nDoes it look good to you ?", "author": "echauchot", "createdAt": "2021-01-13T13:41:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI2MTAzMQ=="}], "type": "inlineReview"}, {"oid": "37d19b610a94e37fdf6fd73b008521fbad799b5d", "url": "https://github.com/apache/flink/commit/37d19b610a94e37fdf6fd73b008521fbad799b5d", "message": "[FLINK-19656][metrics] Automatically replace delimiter characters in identifier and logical scope", "committedDate": "2021-01-18T15:10:51Z", "type": "forcePushed"}, {"oid": "82bdbb806b32df333113990b6df2df3e034418b3", "url": "https://github.com/apache/flink/commit/82bdbb806b32df333113990b6df2df3e034418b3", "message": "[FLINK-19656][metrics] Enforce non-null character filter", "committedDate": "2021-01-18T15:19:04Z", "type": "commit"}, {"oid": "8954fbfdc02b534424f218ef603f5c3be429f7b7", "url": "https://github.com/apache/flink/commit/8954fbfdc02b534424f218ef603f5c3be429f7b7", "message": "[FLINK-19656][metrics] Automatically replace delimiter characters in identifier and logical scope", "committedDate": "2021-01-18T15:19:04Z", "type": "commit"}, {"oid": "8954fbfdc02b534424f218ef603f5c3be429f7b7", "url": "https://github.com/apache/flink/commit/8954fbfdc02b534424f218ef603f5c3be429f7b7", "message": "[FLINK-19656][metrics] Automatically replace delimiter characters in identifier and logical scope", "committedDate": "2021-01-18T15:19:04Z", "type": "forcePushed"}]}