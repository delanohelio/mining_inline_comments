{"pr_number": 13958, "pr_title": "[FLINK-19994][runtime] Do not force iteration job to generate one only pipelined region", "pr_createdAt": "2020-11-06T09:22:50Z", "pr_url": "https://github.com/apache/flink/pull/13958", "timeline": [{"oid": "e6c7892e55dd4baaff4968e4257a63a51023d841", "url": "https://github.com/apache/flink/commit/e6c7892e55dd4baaff4968e4257a63a51023d841", "message": "[FLINK-19994][runtime] Remove unused interface method BaseTopology#containsCoLocationConstraints()", "committedDate": "2020-11-06T12:28:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc4OTY1Nw==", "url": "https://github.com/apache/flink/pull/13958#discussion_r518789657", "bodyText": "This seems to also put CoLocationConstraint == null into the map.\nThe test also passes because of it. Is it expected? The test graph (2 disjoint JVs w/o CoLocationConstraints) seems to be a normal graph. Why should the test fail?", "author": "azagrebin", "createdAt": "2020-11-06T14:34:47Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/scheduler/adapter/DefaultExecutionTopology.java", "diffHunk": "@@ -201,4 +195,32 @@ private static void connectVerticesToConsumedPartitions(\n \t\t\t}\n \t\t}\n \t}\n+\n+\t/**\n+\t * Co-location constraints are only used for iteration head and tail.\n+\t * A paired head and tail needs to be in the same pipelined region so\n+\t * that they can be restarted together.\n+\t */\n+\tprivate void ensureCoLocatedVerticesInSameRegion() {\n+\t\tfinal Map<CoLocationConstraint, DefaultSchedulingPipelinedRegion> constraintToRegion = new IdentityHashMap<>();", "originalCommit": "e6c7892e55dd4baaff4968e4257a63a51023d841", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTEyOTQzNg==", "url": "https://github.com/apache/flink/pull/13958#discussion_r519129436", "bodyText": "Dealing with null constraint is a bug here and have resulted in lots of test failures. I have fixed it.\nThe test was incomplete but I forget about it because it passed due to the null constraint. I will fix it.", "author": "zhuzhurk", "createdAt": "2020-11-07T06:27:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc4OTY1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTEzMzM4Mw==", "url": "https://github.com/apache/flink/pull/13958#discussion_r519133383", "bodyText": "done.", "author": "zhuzhurk", "createdAt": "2020-11-07T06:36:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc4OTY1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc5MTE5Mg==", "url": "https://github.com/apache/flink/pull/13958#discussion_r518791192", "bodyText": "Maybe a side note not for this PR: I would put initializePipelinedRegions and ensureCoLocatedVerticesInSameRegion into a factory method fromExecutionGraph.", "author": "azagrebin", "createdAt": "2020-11-06T14:37:05Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/scheduler/adapter/DefaultExecutionTopology.java", "diffHunk": "@@ -91,6 +88,8 @@ public DefaultExecutionTopology(ExecutionGraph graph) {\n \t\tthis.pipelinedRegionsByVertex = new HashMap<>();\n \t\tthis.pipelinedRegions = new ArrayList<>();\n \t\tinitializePipelinedRegions();\n+\n+\t\tensureCoLocatedVerticesInSameRegion();", "originalCommit": "e6c7892e55dd4baaff4968e4257a63a51023d841", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE0Mzc0Nw==", "url": "https://github.com/apache/flink/pull/13958#discussion_r519143747", "bodyText": "Yes I agree that publishing this in the constructor is not a good idea.\nWill add a separate commit to fix it.", "author": "zhuzhurk", "createdAt": "2020-11-07T07:03:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc5MTE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE0NTY5NA==", "url": "https://github.com/apache/flink/pull/13958#discussion_r519145694", "bodyText": "done.", "author": "zhuzhurk", "createdAt": "2020-11-07T07:09:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc5MTE5Mg=="}], "type": "inlineReview"}, {"oid": "c1b246f5f8538f9bf313c9456a04aac3fdf54b67", "url": "https://github.com/apache/flink/commit/c1b246f5f8538f9bf313c9456a04aac3fdf54b67", "message": "refine check of colocated region", "committedDate": "2020-11-07T06:35:42Z", "type": "forcePushed"}, {"oid": "964580e303ef47cb868c3cfe5e3d0fb855c0c2a3", "url": "https://github.com/apache/flink/commit/964580e303ef47cb868c3cfe5e3d0fb855c0c2a3", "message": "[FLINK-19994][hotfix][runtime] Build pipelined regions only after DefaultExecutionTopology is fully constructed", "committedDate": "2020-11-07T07:08:29Z", "type": "forcePushed"}, {"oid": "f66208c7971d2010aa0d43b4e589a0ed399192a6", "url": "https://github.com/apache/flink/commit/f66208c7971d2010aa0d43b4e589a0ed399192a6", "message": "fix tests", "committedDate": "2020-11-07T11:32:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY3NjEwNA==", "url": "https://github.com/apache/flink/pull/13958#discussion_r519676104", "bodyText": "If we are already factoring out initializePipelinedRegions, could we generate all dependencies of DefaultExecutionTopology in the factory method fromExecutionGraph? This should generally separate concerns and make potential testing simpler.\nI also would put this commit before the actual change of this PR if this is not much effort.", "author": "azagrebin", "createdAt": "2020-11-09T09:47:01Z", "path": "flink-runtime/src/main/java/org/apache/flink/runtime/scheduler/adapter/DefaultExecutionTopology.java", "diffHunk": "@@ -51,20 +53,20 @@\n \n \tprivate static final Logger LOG = LoggerFactory.getLogger(DefaultExecutionTopology.class);\n \n-\tprivate final ExecutionGraph executionGraph;\n-\n \tprivate final Map<ExecutionVertexID, DefaultExecutionVertex> executionVerticesById;\n \n \tprivate final List<DefaultExecutionVertex> executionVerticesList;\n \n \tprivate final Map<IntermediateResultPartitionID, DefaultResultPartition> resultPartitionsById;\n \n-\tprivate final Map<ExecutionVertexID, DefaultSchedulingPipelinedRegion> pipelinedRegionsByVertex;\n+\t@Nullable\n+\tprivate Map<ExecutionVertexID, DefaultSchedulingPipelinedRegion> pipelinedRegionsByVertex;\n \n-\tprivate final List<DefaultSchedulingPipelinedRegion> pipelinedRegions;\n+\t@Nullable\n+\tprivate List<DefaultSchedulingPipelinedRegion> pipelinedRegions;\n \n-\tpublic DefaultExecutionTopology(ExecutionGraph graph) {\n-\t\tthis.executionGraph = checkNotNull(graph, \"execution graph can not be null\");\n+\tprivate DefaultExecutionTopology(ExecutionGraph graph) {", "originalCommit": "2925bc7e08598f79841cb3add571292bcf87127b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTc5NzMyNw==", "url": "https://github.com/apache/flink/pull/13958#discussion_r519797327", "bodyText": "I have reordered the commits to let the hotfix happen first.\nBut I do not feel like to factor out vertices and results creation out from DefaultExecutionTopology because I think it is the core part of DefaultExecutionTopology. One can use TestingSchedulingTopology to generate a controllable topology for testing.", "author": "zhuzhurk", "createdAt": "2020-11-09T13:08:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY3NjEwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg3OTM1OA==", "url": "https://github.com/apache/flink/pull/13958#discussion_r519879358", "bodyText": "I meant testing DefaultExecutionTopology itself and its construction process separately\nbut it seems that tests have already been written for the constructor.\nIn this case, I would keep it as it was with final fields at least (it provides immutability and better guarantees)\nif you think that construction does not need to be separated from the DefaultExecutionTopology as just a data holder or we can discuss it in another ticket.", "author": "azagrebin", "createdAt": "2020-11-09T15:02:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY3NjEwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIzNDkzOQ==", "url": "https://github.com/apache/flink/pull/13958#discussion_r520234939", "bodyText": "We cannot make pipelinedRegions final because it is built from a Topology.\nAnd we should also avoid the dangerous behavior which published this in the constructor.", "author": "zhuzhurk", "createdAt": "2020-11-10T01:51:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY3NjEwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDM4OTQ1OQ==", "url": "https://github.com/apache/flink/pull/13958#discussion_r520389459", "bodyText": "As I understand, the topology is computed from vertices of EG.\nI meant this refactoring: azagrebin@9bd51df.", "author": "azagrebin", "createdAt": "2020-11-10T08:52:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY3NjEwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQ5OTY0Nw==", "url": "https://github.com/apache/flink/pull/13958#discussion_r520499647", "bodyText": "The topology consists of vertices, results and edges. DefaultExecutionTopology currently built these things in the constructor. I feel that moving all these things into the factory method does not bring any immediate benefit but instead introduces risk. So I prefer to do it only when it is needed.", "author": "zhuzhurk", "createdAt": "2020-11-10T11:43:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY3NjEwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU1MjI0NA==", "url": "https://github.com/apache/flink/pull/13958#discussion_r520552244", "bodyText": "Ok, I think we can merge the PR as is and then I can open a follow-up PR #14020 right-away with my suggestion (FLINK-20078).\nMy concern is the private setter as a compromise to work on a partially constructed Topology.\nI still believe that having a separate step-by-step dependencies generation with immutable data structures is more clear in future. There should be also no risks if tests pass.", "author": "azagrebin", "createdAt": "2020-11-10T13:14:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY3NjEwNA=="}], "type": "inlineReview"}, {"oid": "dd4f926834e2ad0209e72f288d04b1c2d0208cb0", "url": "https://github.com/apache/flink/commit/dd4f926834e2ad0209e72f288d04b1c2d0208cb0", "message": "[FLINK-19994][runtime] Remove unused interface method BaseTopology#containsCoLocationConstraints()", "committedDate": "2020-11-09T13:04:27Z", "type": "forcePushed"}, {"oid": "d90cc11078d496cfe3355afc95711501f9f692bb", "url": "https://github.com/apache/flink/commit/d90cc11078d496cfe3355afc95711501f9f692bb", "message": "[FLINK-19994][hotfix][runtime] Build pipelined regions only after DefaultExecutionTopology is fully constructed\n\nCurrently the `this` ref of DefaultExecutionTopology is published to PipelinedRegionComputeUtil in the constructor. This is a dangerous behavior and this commit targets to fix it.", "committedDate": "2020-11-10T11:55:35Z", "type": "commit"}, {"oid": "6b02cb6f27e881e06e81af50ee6e101240ee888c", "url": "https://github.com/apache/flink/commit/6b02cb6f27e881e06e81af50ee6e101240ee888c", "message": "[FLINK-19994][runtime] Do not force iteration job to generate one only pipelined region", "committedDate": "2020-11-10T11:55:35Z", "type": "commit"}, {"oid": "7e08b6b6d4a8dd32da4885944b31b682563f7070", "url": "https://github.com/apache/flink/commit/7e08b6b6d4a8dd32da4885944b31b682563f7070", "message": "[FLINK-19994][runtime] Remove unused interface method BaseTopology#containsCoLocationConstraints()", "committedDate": "2020-11-10T11:55:35Z", "type": "commit"}, {"oid": "7e08b6b6d4a8dd32da4885944b31b682563f7070", "url": "https://github.com/apache/flink/commit/7e08b6b6d4a8dd32da4885944b31b682563f7070", "message": "[FLINK-19994][runtime] Remove unused interface method BaseTopology#containsCoLocationConstraints()", "committedDate": "2020-11-10T11:55:35Z", "type": "forcePushed"}]}