{"pr_number": 11420, "pr_title": "[FLINK-16565][python][ml] Make Pipeline Json compitable between Java and Python if all PipelineStages are Java ones", "pr_createdAt": "2020-03-16T15:03:23Z", "pr_url": "https://github.com/apache/flink/pull/11420", "timeline": [{"oid": "d6eea92060da3afdf541e2fcc90e103c34cef259", "url": "https://github.com/apache/flink/commit/d6eea92060da3afdf541e2fcc90e103c34cef259", "message": "[FLINK-16565][python][ml] Make Pipeline Json compitable between Java and Python if all Pipelinestages are Java ones", "committedDate": "2020-03-16T14:44:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc5MTc1MA==", "url": "https://github.com/apache/flink/pull/11420#discussion_r393791750", "bodyText": "nit: makes error message more verbose, express which stage is problematic\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    \"Unexpected Java PipelineStage. It should be a %s, \"\n          \n          \n            \n                                    \"Unexpected Java PipelineStage: %s. Class should be a %s, \"", "author": "walterddr", "createdAt": "2020-03-17T16:04:25Z", "path": "flink-python/pyflink/ml/api/base.py", "diffHunk": "@@ -265,11 +266,56 @@ def transform(self, t_env: TableEnvironment, input: Table) -> Table:\n         return input\n \n     def to_json(self) -> str:\n-        import jsonpickle\n-        return str(jsonpickle.encode(self, keys=True))\n+        \"\"\"\n+        If all PipelineStages in this Pipeline are Java ones, this method will return a\n+        Java json string, which can be loaded either from a Python Pipeline or a Java Pipeline,\n+        otherwise, it returns a Python json string which can only be loaded from a Python Pipeline.\n+        \"\"\"\n+        # if all PipelineStages are Java ones, we use Java toJson() to generate Json string\n+        # so that the string can also be loaded from Java side.\n+        if all([type(stage) in [JavaTransformer, JavaEstimator, JavaModel]\n+                for stage in self.get_stages()]):\n+            j_pipeline = get_gateway().jvm.org.apache.flink.ml.api.core.Pipeline()\n+            for stage in self.get_stages():\n+                stage._convert_params_to_java(stage._j_obj)\n+                j_pipeline.appendStage(stage._j_obj)\n+            return j_pipeline.toJson()\n+        else:\n+            import jsonpickle\n+            return str(jsonpickle.encode(self, keys=True))\n \n     def load_json(self, json: str) -> None:\n-        import jsonpickle\n-        pipeline = jsonpickle.decode(json, keys=True)\n-        for stage in pipeline.get_stages():\n-            self.append_stage(stage)\n+        \"\"\"\n+        This method can either load from a Java Pipeline json or a Python Pipeline json.\n+        \"\"\"\n+        # noinspection PyBroadException\n+        try:\n+            # try to load json with Python method\n+            import jsonpickle\n+            pipeline = jsonpickle.decode(json, keys=True)\n+            for stage in pipeline.get_stages():\n+                self.append_stage(stage)\n+        except Exception:\n+            # if can't load json with Python method, try to load with Java method\n+            gw = get_gateway()\n+            j_pipeline = gw.jvm.org.apache.flink.ml.api.core.Pipeline()\n+            j_pipeline.loadJson(json)\n+\n+            for j_stage in j_pipeline.getStages():\n+                j_stage_class = j_stage.getClass()\n+                j_transformer_class = java_class(gw.jvm.org.apache.flink.ml.api.core.Transformer)\n+                j_estimator_class = java_class(gw.jvm.org.apache.flink.ml.api.core.Estimator)\n+                j_model_class = java_class(gw.jvm.org.apache.flink.ml.api.core.Model)\n+                if j_transformer_class.isAssignableFrom(j_stage_class):\n+                    self.append_stage(JavaTransformer(j_stage))\n+                elif j_estimator_class.isAssignableFrom(j_stage_class):\n+                    self.append_stage(JavaEstimator(j_stage))\n+                elif j_model_class.isAssignableFrom(j_stage_class):\n+                    self.append_stage(JavaModel(j_stage))\n+                else:\n+                    raise TypeError(\n+                        \"Unexpected Java PipelineStage. It should be a %s, \"", "originalCommit": "d6eea92060da3afdf541e2fcc90e103c34cef259", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc5MjAzNg==", "url": "https://github.com/apache/flink/pull/11420#discussion_r393792036", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    (j_transformer_class.getCanonicalName(),\n          \n          \n            \n                                    (j_stage_class.getCanonicalName(),\n          \n          \n            \n                                     j_transformer_class.getCanonicalName(),", "author": "walterddr", "createdAt": "2020-03-17T16:04:51Z", "path": "flink-python/pyflink/ml/api/base.py", "diffHunk": "@@ -265,11 +266,56 @@ def transform(self, t_env: TableEnvironment, input: Table) -> Table:\n         return input\n \n     def to_json(self) -> str:\n-        import jsonpickle\n-        return str(jsonpickle.encode(self, keys=True))\n+        \"\"\"\n+        If all PipelineStages in this Pipeline are Java ones, this method will return a\n+        Java json string, which can be loaded either from a Python Pipeline or a Java Pipeline,\n+        otherwise, it returns a Python json string which can only be loaded from a Python Pipeline.\n+        \"\"\"\n+        # if all PipelineStages are Java ones, we use Java toJson() to generate Json string\n+        # so that the string can also be loaded from Java side.\n+        if all([type(stage) in [JavaTransformer, JavaEstimator, JavaModel]\n+                for stage in self.get_stages()]):\n+            j_pipeline = get_gateway().jvm.org.apache.flink.ml.api.core.Pipeline()\n+            for stage in self.get_stages():\n+                stage._convert_params_to_java(stage._j_obj)\n+                j_pipeline.appendStage(stage._j_obj)\n+            return j_pipeline.toJson()\n+        else:\n+            import jsonpickle\n+            return str(jsonpickle.encode(self, keys=True))\n \n     def load_json(self, json: str) -> None:\n-        import jsonpickle\n-        pipeline = jsonpickle.decode(json, keys=True)\n-        for stage in pipeline.get_stages():\n-            self.append_stage(stage)\n+        \"\"\"\n+        This method can either load from a Java Pipeline json or a Python Pipeline json.\n+        \"\"\"\n+        # noinspection PyBroadException\n+        try:\n+            # try to load json with Python method\n+            import jsonpickle\n+            pipeline = jsonpickle.decode(json, keys=True)\n+            for stage in pipeline.get_stages():\n+                self.append_stage(stage)\n+        except Exception:\n+            # if can't load json with Python method, try to load with Java method\n+            gw = get_gateway()\n+            j_pipeline = gw.jvm.org.apache.flink.ml.api.core.Pipeline()\n+            j_pipeline.loadJson(json)\n+\n+            for j_stage in j_pipeline.getStages():\n+                j_stage_class = j_stage.getClass()\n+                j_transformer_class = java_class(gw.jvm.org.apache.flink.ml.api.core.Transformer)\n+                j_estimator_class = java_class(gw.jvm.org.apache.flink.ml.api.core.Estimator)\n+                j_model_class = java_class(gw.jvm.org.apache.flink.ml.api.core.Model)\n+                if j_transformer_class.isAssignableFrom(j_stage_class):\n+                    self.append_stage(JavaTransformer(j_stage))\n+                elif j_estimator_class.isAssignableFrom(j_stage_class):\n+                    self.append_stage(JavaEstimator(j_stage))\n+                elif j_model_class.isAssignableFrom(j_stage_class):\n+                    self.append_stage(JavaModel(j_stage))\n+                else:\n+                    raise TypeError(\n+                        \"Unexpected Java PipelineStage. It should be a %s, \"\n+                        \"%s or a %s.\" %\n+                        (j_transformer_class.getCanonicalName(),", "originalCommit": "d6eea92060da3afdf541e2fcc90e103c34cef259", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc5Nzg4Mw==", "url": "https://github.com/apache/flink/pull/11420#discussion_r393797883", "bodyText": "this piece of code replicates most of the logic in Pipeline.to_json() except for the hard-coded pipeline stage \"select_cols\". was wondering if there's a better way of making the test, e.g. use a json string literal here?", "author": "walterddr", "createdAt": "2020-03-17T16:12:48Z", "path": "flink-python/pyflink/ml/tests/test_pipeline_it_case.py", "diffHunk": "@@ -169,3 +169,39 @@ def test_pipeline(self):\n         # the first input is false since 0 + 0 is smaller than the max_sum 14.\n         # the second input is true since 12 + 3 is bigger than the max_sum 14.\n         self.assert_equals(actual, [\"false\", \"true\"])\n+\n+    def test_pipeline_from_and_to_java_json(self):\n+\n+        def get_java_pipeline_json():\n+            wrapper = WrapperTransformer(selected_cols=[\"a\", \"b\"])\n+            wrapper._convert_params_to_java(wrapper._j_obj)\n+            j_pipeline = get_gateway().jvm.org.apache.flink.ml.api.core.Pipeline()\n+            j_pipeline.appendStage(wrapper._j_obj)\n+            return j_pipeline.toJson()", "originalCommit": "d6eea92060da3afdf541e2fcc90e103c34cef259", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA2NjY5Mg==", "url": "https://github.com/apache/flink/pull/11420#discussion_r394066692", "bodyText": "A json string literal sounds good for me.", "author": "hequn8128", "createdAt": "2020-03-18T02:01:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc5Nzg4Mw=="}], "type": "inlineReview"}, {"oid": "acf17c53b9dd8dad8d8e2286c2140f96dca488b3", "url": "https://github.com/apache/flink/commit/acf17c53b9dd8dad8d8e2286c2140f96dca488b3", "message": "address comments", "committedDate": "2020-03-18T02:11:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDExOTAzOA==", "url": "https://github.com/apache/flink/pull/11420#discussion_r394119038", "bodyText": "Do we know the exact exception type here? It would good to not naively catch all the exception if possible. If we don't know the exact exception, we should probably remember the exception and raise it when the Java Pipeline load also failed. The error message would then be something like:\n\"Cannot load the JSON as either a Java Pipeline or a Python Pipeline. Python Pipeline load failed due to THIS_EXCEPTION. Java Pipeline load failed due to ANOTHER_EXCEPTION.\"", "author": "becketqin", "createdAt": "2020-03-18T05:50:43Z", "path": "flink-python/pyflink/ml/api/base.py", "diffHunk": "@@ -265,11 +266,57 @@ def transform(self, t_env: TableEnvironment, input: Table) -> Table:\n         return input\n \n     def to_json(self) -> str:\n-        import jsonpickle\n-        return str(jsonpickle.encode(self, keys=True))\n+        \"\"\"\n+        If all PipelineStages in this Pipeline are Java ones, this method will return a\n+        Java json string, which can be loaded either from a Python Pipeline or a Java Pipeline,\n+        otherwise, it returns a Python json string which can only be loaded from a Python Pipeline.\n+        \"\"\"\n+        # if all PipelineStages are Java ones, we use Java toJson() to generate Json string\n+        # so that the string can also be loaded from Java side.\n+        if all([type(stage) in [JavaTransformer, JavaEstimator, JavaModel]\n+                for stage in self.get_stages()]):\n+            j_pipeline = get_gateway().jvm.org.apache.flink.ml.api.core.Pipeline()\n+            for stage in self.get_stages():\n+                stage._convert_params_to_java(stage._j_obj)\n+                j_pipeline.appendStage(stage._j_obj)\n+            return j_pipeline.toJson()\n+        else:\n+            import jsonpickle\n+            return str(jsonpickle.encode(self, keys=True))\n \n     def load_json(self, json: str) -> None:\n-        import jsonpickle\n-        pipeline = jsonpickle.decode(json, keys=True)\n-        for stage in pipeline.get_stages():\n-            self.append_stage(stage)\n+        \"\"\"\n+        This method can either load from a Java Pipeline json or a Python Pipeline json.\n+        \"\"\"\n+        # noinspection PyBroadException\n+        try:\n+            # try to load json with Python method\n+            import jsonpickle\n+            pipeline = jsonpickle.decode(json, keys=True)\n+            for stage in pipeline.get_stages():\n+                self.append_stage(stage)\n+        except Exception:", "originalCommit": "acf17c53b9dd8dad8d8e2286c2140f96dca488b3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "530f2d828bf1c07e990b25a63c8f93bb127733bf", "url": "https://github.com/apache/flink/commit/530f2d828bf1c07e990b25a63c8f93bb127733bf", "message": "improve the error handling", "committedDate": "2020-03-18T07:00:38Z", "type": "commit"}]}