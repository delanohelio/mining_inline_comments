{"pr_number": 12172, "pr_title": " [FLINK-17656][tests] Migrate docker e2e tests to flink-docker ", "pr_createdAt": "2020-05-15T12:44:40Z", "pr_url": "https://github.com/apache/flink/pull/12172", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgxODUwOA==", "url": "https://github.com/apache/flink/pull/12172#discussion_r425818508", "bodyText": "This doesn't work with python3 anymore. Python 2 support has been discontinued.\nI'm a bit concerned that this blows up at some point. We could add a python version check, and use the equivalent python 3 call (python3 -m http.server), download a python binary from somewhere, dockerize it? ...", "author": "rmetzger", "createdAt": "2020-05-15T13:55:07Z", "path": "flink-end-to-end-tests/test-scripts/common_docker.sh", "diffHunk": "@@ -33,8 +33,25 @@ function containers_health_check() {\n   done\n }\n \n-function build_image_with_jar() {\n-    local job_artifacts=$1\n-    local image_name=${2:-flink-job}\n-    ./build.sh --from-local-dist --job-artifacts ${job_artifacts} --image-name ${image_name}\n+function build_image() {\n+    local image_name=${1:-flink-job}\n+\n+    echo \"Starting fileserver for Flink distribution\"\n+    pushd ${FLINK_DIR}/..\n+    tar -czf \"${TEST_DATA_DIR}/flink.tgz\" flink-*\n+    popd\n+    pushd ${TEST_DATA_DIR}\n+    python -m SimpleHTTPServer 9999 &", "originalCommit": "ff37e0c1c648d9b80bb7d009f6b559d12ad3aeb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgzNzQzMA==", "url": "https://github.com/apache/flink/pull/12172#discussion_r425837430", "bodyText": "Given that we are primarily interested in the running on CI I'm fine with the current state.\nFor the general case it can blow up in any case since you can't guarantee python (2 or 3) to exist at all; the only safe solution being a pure bash/java version, bash naturally not being realistic option and Java not really being worth the additional effort, and it would also make it way harder to offer a script in that case.\nOriginally I wanted to serve things via netcat but it didn't quite work.\nDockerizing this one thing seems a bit overkill to me.", "author": "zentol", "createdAt": "2020-05-15T14:23:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgxODUwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTg1MTY3MA==", "url": "https://github.com/apache/flink/pull/12172#discussion_r425851670", "bodyText": "You don't need to create your own docker image.\ndocker run -it -p 9999:9999 -v `pwd`:/data python:3.7.7-slim-buster python -m http.server 9999", "author": "rmetzger", "createdAt": "2020-05-15T14:45:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgxODUwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE2ODYwOQ==", "url": "https://github.com/apache/flink/pull/12172#discussion_r426168609", "bodyText": "I'd prefer not having to download another 60mb for this menial task; that alone would imo discard it as a viable option as a utility script.", "author": "zentol", "createdAt": "2020-05-16T16:30:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgxODUwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgyMDUyNw==", "url": "https://github.com/apache/flink/pull/12172#discussion_r425820527", "bodyText": "This mechanism is quite useful for developers of Flink. Does it make sense to move this code into a script in \"flink-docker.git\" and use this here?\ngit clone https://github.com/apache/flink-docker.git\ncd flink-docker\n./build-from-local.sh /path/to/my/build/target username/image:tag", "author": "rmetzger", "createdAt": "2020-05-15T13:58:07Z", "path": "flink-end-to-end-tests/test-scripts/common_docker.sh", "diffHunk": "@@ -33,8 +33,25 @@ function containers_health_check() {\n   done\n }\n \n-function build_image_with_jar() {\n-    local job_artifacts=$1\n-    local image_name=${2:-flink-job}\n-    ./build.sh --from-local-dist --job-artifacts ${job_artifacts} --image-name ${image_name}\n+function build_image() {\n+    local image_name=${1:-flink-job}\n+\n+    echo \"Starting fileserver for Flink distribution\"", "originalCommit": "ff37e0c1c648d9b80bb7d009f6b559d12ad3aeb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgzMzkxMQ==", "url": "https://github.com/apache/flink/pull/12172#discussion_r425833911", "bodyText": "maybe, I'm not so sure about it. On the one hand there are some environmental dependencies (see above) and you would need to harden it way more to ensure cleanup of resources (which I'd prefer not to do atm).", "author": "zentol", "createdAt": "2020-05-15T14:18:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgyMDUyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTg1MzM1Ng==", "url": "https://github.com/apache/flink/pull/12172#discussion_r425853356", "bodyText": "In my suggestion above, we only require docker\nFor the cleanup, we could build the archive in /tmp.", "author": "rmetzger", "createdAt": "2020-05-15T14:48:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgyMDUyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE1NDM3NQ==", "url": "https://github.com/apache/flink/pull/12172#discussion_r426154375", "bodyText": "I don't know about you, but I'm really getting tired of Flink dropping hundreds of files into my /tmp directories.\nMy bigger concern is the fileserver process anyway; you definitely don't want that one leaking since it could affect the correctness of subsequent runs.\nSo as I said, it would need more work to be in a state where I would offer it to other people.", "author": "zentol", "createdAt": "2020-05-16T13:37:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgyMDUyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgyNTEyMw==", "url": "https://github.com/apache/flink/pull/12172#discussion_r425825123", "bodyText": "default seems to be flink-job, w/o the :latest.", "author": "rmetzger", "createdAt": "2020-05-15T14:05:13Z", "path": "flink-end-to-end-tests/test-scripts/container-scripts/docker-compose.test.yml", "diffHunk": "@@ -16,15 +16,31 @@\n # limitations under the License.\n ################################################################################\n \n-# Extensions to flink-container/docker/docker-compose.yml that mounts volumes needed for tests\n+# Docker compose file for a Flink job cluster deployment.\n+#\n+# Parameters:\n+# * FLINK_DOCKER_IMAGE_NAME - Image name to use for the deployment (default: flink-job:latest)", "originalCommit": "ff37e0c1c648d9b80bb7d009f6b559d12ad3aeb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgzMjc0Ng==", "url": "https://github.com/apache/flink/pull/12172#discussion_r425832746", "bodyText": ":latest is effectively implied.", "author": "zentol", "createdAt": "2020-05-15T14:17:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgyNTEyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTg1MzU1MQ==", "url": "https://github.com/apache/flink/pull/12172#discussion_r425853551", "bodyText": "Fair point.", "author": "rmetzger", "createdAt": "2020-05-15T14:48:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgyNTEyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE1NDQxNA==", "url": "https://github.com/apache/flink/pull/12172#discussion_r426154414", "bodyText": "This was also copied as is from flink-container/docker/docker-compose.yml", "author": "zentol", "createdAt": "2020-05-16T13:38:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgyNTEyMw=="}], "type": "inlineReview"}, {"oid": "b0f4bffb49fe59cda55a92e9608f678ed0d93259", "url": "https://github.com/apache/flink/commit/b0f4bffb49fe59cda55a92e9608f678ed0d93259", "message": "[FLINK-17656][tests] Migrate docker e2e tests to flink-docker", "committedDate": "2020-05-17T16:32:41Z", "type": "commit"}, {"oid": "8b450055a1e9f35a286342105e0da83ed8c74faa", "url": "https://github.com/apache/flink/commit/8b450055a1e9f35a286342105e0da83ed8c74faa", "message": "[hotfix][docker] Prevent docker-compose caching\n\nThe caching is overly aggressive and potentially even ignores changes to the .yml files.", "committedDate": "2020-05-17T16:32:42Z", "type": "commit"}, {"oid": "8b450055a1e9f35a286342105e0da83ed8c74faa", "url": "https://github.com/apache/flink/commit/8b450055a1e9f35a286342105e0da83ed8c74faa", "message": "[hotfix][docker] Prevent docker-compose caching\n\nThe caching is overly aggressive and potentially even ignores changes to the .yml files.", "committedDate": "2020-05-17T16:32:42Z", "type": "forcePushed"}]}