{"pr_number": 13304, "pr_title": "[FLINK-19118][python] Support Expression in the operations of Python Table API", "pr_createdAt": "2020-09-02T11:00:50Z", "pr_url": "https://github.com/apache/flink/pull/13304", "timeline": [{"oid": "d308fe842311e794be70b21c1f9335c93fb29b5b", "url": "https://github.com/apache/flink/commit/d308fe842311e794be70b21c1f9335c93fb29b5b", "message": "[FLINK-19118][python] Support Expression in the operations of Python Table API", "committedDate": "2020-09-02T09:57:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY1MzAyNw==", "url": "https://github.com/apache/flink/pull/13304#discussion_r482653027", "bodyText": "combine to one string?", "author": "WeiZhong94", "createdAt": "2020-09-03T02:17:14Z", "path": "flink-python/pyflink/table/tests/test_pandas_udf.py", "diffHunk": "@@ -58,8 +59,8 @@ def test_basic_functionality(self):\n \n         t = self.t_env.from_elements([(1, 2, 3), (2, 5, 6), (3, 1, 9)], ['a', 'b', 'c'])\n         exec_insert_table(\n-            t.where(\"add_one(b) <= 3\").select(\"a, b + 1, add(a + 1, subtract_one(c)) + 2, \"\n-                                              \"add(add_one(a), 1L)\"),\n+            t.where(E.call('add_one', t.b) <= 3)\n+             .select(\"a, b + 1, add(a + 1, subtract_one(c)) + 2, \" \"add(add_one(a), 1L)\"),", "originalCommit": "d308fe842311e794be70b21c1f9335c93fb29b5b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY2NTA5OA==", "url": "https://github.com/apache/flink/pull/13304#discussion_r482665098", "bodyText": "\".rows\" seems not supported. Maybe we should support it or use \"row_interval()\" instead?", "author": "WeiZhong94", "createdAt": "2020-09-03T02:30:49Z", "path": "flink-python/pyflink/table/tests/test_window.py", "diffHunk": "@@ -40,8 +41,8 @@ class BatchTableWindowTests(PyFlinkBatchTableTestCase):\n \n     def test_tumble_window(self):\n         t = self.t_env.from_elements([(1, 1, \"Hello\")], [\"a\", \"b\", \"c\"])\n-        result = t.window(Tumble.over(\"2.rows\").on(\"a\").alias(\"w\"))\\\n-            .group_by(\"w, c\").select(\"b.sum\")\n+        result = t.window(Tumble.over(E.lit(2).rows).on(\"a\").alias(\"w\"))\\", "originalCommit": "d308fe842311e794be70b21c1f9335c93fb29b5b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8ad8edefaaa28a0459b40b3587013d9ca7c14933", "url": "https://github.com/apache/flink/commit/8ad8edefaaa28a0459b40b3587013d9ca7c14933", "message": "fix", "committedDate": "2020-09-03T02:51:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjcyOTY1NQ==", "url": "https://github.com/apache/flink/pull/13304#discussion_r482729655", "bodyText": "How about  E -> expr(Shorthand in lowercase)? some as pandas did?  e.g.: import numpy as np\nhttps://github.com/pandas-dev/pandas/blob/master/pandas/tests/dtypes/test_dtypes.py", "author": "sunjincheng121", "createdAt": "2020-09-03T06:20:59Z", "path": "flink-python/pyflink/table/examples/batch/word_count.py", "diffHunk": "@@ -23,6 +23,7 @@\n \n from pyflink.dataset import ExecutionEnvironment\n from pyflink.table import BatchTableEnvironment, TableConfig\n+from pyflink.table import expressions as E", "originalCommit": "8ad8edefaaa28a0459b40b3587013d9ca7c14933", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc0MTgyOA==", "url": "https://github.com/apache/flink/pull/13304#discussion_r482741828", "bodyText": "How about do a little bit change as follows?:\n t2 = t.alias(\"d, e, f\")\n result = t2.select(t2.d, t2.e, t2.f)", "author": "sunjincheng121", "createdAt": "2020-09-03T06:48:03Z", "path": "flink-python/pyflink/table/tests/test_calc.py", "diffHunk": "@@ -31,21 +32,21 @@ class StreamTableCalcTests(PyFlinkStreamTableTestCase):\n \n     def test_select(self):\n         t = self.t_env.from_elements([(1, 'hi', 'hello')], ['a', 'b', 'c'])\n-        result = t.select(\"a + 1, b, c\")\n+        result = t.select(t.a + 1, t.b, t.c)\n         query_operation = result._j_table.getQueryOperation()\n         self.assertEqual('[plus(a, 1), b, c]',\n                          query_operation.getProjectList().toString())\n \n     def test_alias(self):\n         t = self.t_env.from_elements([(1, 'Hi', 'Hello')], ['a', 'b', 'c'])\n-        result = t.alias(\"d, e, f\").select(\"d, e, f\")\n+        result = t.alias(\"d, e, f\").select(E.col('d'), E.col('e'), E.col('f'))", "originalCommit": "8ad8edefaaa28a0459b40b3587013d9ca7c14933", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc0NDA4OA==", "url": "https://github.com/apache/flink/pull/13304#discussion_r482744088", "bodyText": "t.select(\"a, b, c\") -> t.select(t.a, t.b, t.c)\nE.col('a') -> t.a?", "author": "sunjincheng121", "createdAt": "2020-09-03T06:52:57Z", "path": "flink-python/pyflink/table/tests/test_column_operation.py", "diffHunk": "@@ -16,36 +16,37 @@\n # limitations under the License.\n ################################################################################\n \n+from pyflink.table import expressions as E\n from pyflink.testing.test_case_utils import PyFlinkStreamTableTestCase\n \n \n class StreamTableColumnsOperationTests(PyFlinkStreamTableTestCase):\n \n     def test_add_columns(self):\n         t = self.t_env.from_elements([(1, 'Hi', 'Hello')], ['a', 'b', 'c'])\n-        result = t.select(\"a\").add_columns(\"a + 1 as b, a + 2 as c\")\n+        result = t.select(t.a).add_columns((t.a + 1).alias('b'), (t.a + 2).alias('c'))\n         query_operation = result._j_table.getQueryOperation()\n         self.assertEqual('[a, plus(a, 1), '\n                          'plus(a, 2)]',\n                          query_operation.getProjectList().toString())\n \n     def test_add_or_replace_columns(self):\n         t = self.t_env.from_elements([(1, 'Hi', 'Hello')], ['a', 'b', 'c'])\n-        result = t.select(\"a\").add_or_replace_columns(\"a + 1 as b, a + 2 as a\")\n+        result = t.select(\"a\").add_or_replace_columns((t.a + 1).alias('b'), (t.a + 2).alias('a'))\n         query_operation = result._j_table.getQueryOperation()\n         self.assertEqual('[plus(a, 2), '\n                          'plus(a, 1)]',\n                          query_operation.getProjectList().toString())\n \n     def test_rename_columns(self):\n         t = self.t_env.from_elements([(1, 'Hi', 'Hello')], ['a', 'b', 'c'])\n-        result = t.select(\"a, b, c\").rename_columns(\"a as d, c as f, b as e\")\n+        result = t.select(\"a, b, c\").rename_columns(t.a.alias('d'), t.c.alias('f'), t.b.alias('e'))\n         table_schema = result._j_table.getQueryOperation().getTableSchema()\n         self.assertEqual(['d', 'e', 'f'], list(table_schema.getFieldNames()))\n \n     def test_drop_columns(self):\n         t = self.t_env.from_elements([(1, 'Hi', 'Hello')], ['a', 'b', 'c'])\n-        result = t.select(\"a, b, c\").drop_columns(\"a, c\")\n+        result = t.select(\"a, b, c\").drop_columns(E.col('a'), E.col('c'))", "originalCommit": "8ad8edefaaa28a0459b40b3587013d9ca7c14933", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc0NjU1OA==", "url": "https://github.com/apache/flink/pull/13304#discussion_r482746558", "bodyText": "E.col('id') == E.col('word') -> source.id == source.word", "author": "sunjincheng121", "createdAt": "2020-09-03T06:57:52Z", "path": "flink-python/pyflink/table/tests/test_correlate.py", "diffHunk": "@@ -39,7 +40,8 @@ def test_join_lateral_with_join_predicate(self):\n                                                     \"org.apache.flink.table.utils.TableFunc1\")\n         source = t_env.from_elements([(\"1\", \"1#3#5#7\"), (\"2\", \"2#4#6#8\")], [\"id\", \"words\"])\n \n-        result = source.join_lateral(\"split(words) as (word)\", \"id = word\")\n+        result = source.join_lateral(E.call('split', source.words).alias('word'),\n+                                     E.col('id') == E.col('word'))", "originalCommit": "8ad8edefaaa28a0459b40b3587013d9ca7c14933", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgxNjg5Nw==", "url": "https://github.com/apache/flink/pull/13304#discussion_r482816897", "bodyText": "word is not from the source table and so we could not do that.", "author": "dianfu", "createdAt": "2020-09-03T08:54:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc0NjU1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgzODAzMw==", "url": "https://github.com/apache/flink/pull/13304#discussion_r482838033", "bodyText": "Yes, I see.", "author": "sunjincheng121", "createdAt": "2020-09-03T09:26:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc0NjU1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc0NzU2Nw==", "url": "https://github.com/apache/flink/pull/13304#discussion_r482747567", "bodyText": "E.col('a') -> t.a", "author": "sunjincheng121", "createdAt": "2020-09-03T07:00:07Z", "path": "flink-python/pyflink/table/tests/test_dependency.py", "diffHunk": "@@ -112,7 +113,7 @@ def check_requirements(i):\n             ['a', 'b'], [DataTypes.BIGINT(), DataTypes.BIGINT()])\n         self.t_env.register_table_sink(\"Results\", table_sink)\n         t = self.t_env.from_elements([(1, 2), (2, 5), (3, 1)], ['a', 'b'])\n-        exec_insert_table(t.select(\"check_requirements(a), a\"), \"Results\")\n+        exec_insert_table(t.select(E.call('check_requirements', E.col('a')), E.col('a')), \"Results\")", "originalCommit": "8ad8edefaaa28a0459b40b3587013d9ca7c14933", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "83acd696081b6640843fca45874693201aafe13d", "url": "https://github.com/apache/flink/commit/83acd696081b6640843fca45874693201aafe13d", "message": "address comments", "committedDate": "2020-09-03T08:56:52Z", "type": "commit"}]}