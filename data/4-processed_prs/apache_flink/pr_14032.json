{"pr_number": 14032, "pr_title": "[FLINK-19863][tests] check hbase has been ready before use it", "pr_createdAt": "2020-11-11T10:49:08Z", "pr_url": "https://github.com/apache/flink/pull/14032", "timeline": [{"oid": "b923b196287e5ef5c699f853fcb06bfe3fe18bbe", "url": "https://github.com/apache/flink/commit/b923b196287e5ef5c699f853fcb06bfe3fe18bbe", "message": " [FLINK-19863][tests] check embedded zookeeper status when start/close hbase resource", "committedDate": "2020-11-12T14:19:29Z", "type": "forcePushed"}, {"oid": "c8c08d9411dbf6e733fcc0f84cb04c0b9127769b", "url": "https://github.com/apache/flink/commit/c8c08d9411dbf6e733fcc0f84cb04c0b9127769b", "message": " [FLINK-19863][tests] check embedded zookeeper status when start/close hbase resource", "committedDate": "2020-11-12T15:37:03Z", "type": "forcePushed"}, {"oid": "3fb3d2ff2f59cb246824d3971d19f2abe87ca060", "url": "https://github.com/apache/flink/commit/3fb3d2ff2f59cb246824d3971d19f2abe87ca060", "message": "minor", "committedDate": "2020-11-13T04:25:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjgzODUxNg==", "url": "https://github.com/apache/flink/pull/14032#discussion_r522838516", "bodyText": "I'd prefer to shutdown the hbase process by killing the process id because I encountered the hung case before when calling the stop-hbase.sh.", "author": "openinx", "createdAt": "2020-11-13T09:46:20Z", "path": "flink-end-to-end-tests/flink-end-to-end-tests-hbase/src/main/java/org/apache/flink/tests/util/hbase/LocalStandaloneHBaseResource.java", "diffHunk": "@@ -92,62 +95,98 @@ private void setupHBaseDist() throws IOException {\n \t}\n \n \tprivate void setupHBaseCluster() throws IOException {\n-\t\tLOG.info(\"Starting HBase cluster\");\n-\t\tAutoClosableProcess.runBlocking(\n-\t\t\thbaseDir.resolve(Paths.get(\"bin\", \"start-hbase.sh\")).toString());\n-\n-\t\twhile (!isHBaseRunning()) {\n-\t\t\ttry {\n-\t\t\t\tLOG.info(\"Waiting for HBase to start\");\n-\t\t\t\tThread.sleep(500L);\n-\t\t\t} catch (InterruptedException e) {\n-\t\t\t\tThread.currentThread().interrupt();\n-\t\t\t\tbreak;\n-\t\t\t}\n-\t\t}\n+\t\tLOG.info(\"Starting HBase cluster...\");\n+\t\trunHBaseProcessWithRetry(\"start-hbase.sh\", () -> !isHMasterRunning());\n+\t\tLOG.info(\"Start HBase cluster success\");\n \t}\n \n \t@Override\n \tpublic void afterTestSuccess() {\n+\t\tshutdownResource();\n+\t\tdownloadCache.afterTestSuccess();\n+\t\ttmp.delete();\n+\t}\n+\n+\tprivate void shutdownResource() {\n+\t\tLOG.info(\"Stopping HBase Cluster...\");\n \t\ttry {\n-\t\t\tLOG.info(\"Stopping HBase Cluster\");\n-\t\t\tAutoClosableProcess.runBlocking(\n-\t\t\t\thbaseDir.resolve(Paths.get(\"bin\", \"hbase-daemon.sh\")).toString(),\n-\t\t\t\t\"stop\",\n-\t\t\t\t\"master\");\n+\t\t\trunHBaseProcessWithRetry(\"stop-hbase.sh\", () -> isHMasterAlive());", "originalCommit": "3fb3d2ff2f59cb246824d3971d19f2abe87ca060", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6e0ea730dbe4e2bd8fddacbfcfbe3251900c2f13", "url": "https://github.com/apache/flink/commit/6e0ea730dbe4e2bd8fddacbfcfbe3251900c2f13", "message": "[FLINK-19863][tests][hbase] Harden HBase end-to-end tests\n\nThis commit checks the HBase processors and data dir have been cleaned up after shutting down a HBase cluster. And also checks the required resources, e.g. Zookeeper, HBase meta has been available when starting up a new HBase cluster.\n\nThis closes #14032", "committedDate": "2020-11-16T09:42:04Z", "type": "commit"}, {"oid": "6e0ea730dbe4e2bd8fddacbfcfbe3251900c2f13", "url": "https://github.com/apache/flink/commit/6e0ea730dbe4e2bd8fddacbfcfbe3251900c2f13", "message": "[FLINK-19863][tests][hbase] Harden HBase end-to-end tests\n\nThis commit checks the HBase processors and data dir have been cleaned up after shutting down a HBase cluster. And also checks the required resources, e.g. Zookeeper, HBase meta has been available when starting up a new HBase cluster.\n\nThis closes #14032", "committedDate": "2020-11-16T09:42:04Z", "type": "forcePushed"}]}