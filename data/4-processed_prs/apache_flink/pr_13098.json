{"pr_number": 13098, "pr_title": "[FLINK-18866][python] Support filter() operation for Python DataStrea\u2026", "pr_createdAt": "2020-08-10T04:42:50Z", "pr_url": "https://github.com/apache/flink/pull/13098", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY5OTg0Mw==", "url": "https://github.com/apache/flink/pull/13098#discussion_r467699843", "bodyText": "What if the func is a Callable?", "author": "hequn8128", "createdAt": "2020-08-10T05:56:56Z", "path": "flink-python/pyflink/datastream/data_stream.py", "diffHunk": "@@ -233,6 +233,32 @@ def flat_map(self, func: Union[Callable, FlatMapFunction], type_info: TypeInform\n             j_python_data_stream_scalar_function_operator\n         ))\n \n+    def filter(self, func: Union[Callable, FilterFunction]) -> 'DataStream':\n+        \"\"\"\n+        Applies a Filter transformation on a DataStream. The transformation calls a FilterFunction\n+        for each element of the DataStream and retains only those element for which the function\n+        returns true. Elements for which the function returns false are filtered. The user can also\n+        extend RichFilterFunction to gain access to other features provided by the RichFunction\n+        interface.\n+\n+        :param func: The FilterFunction that is called for each element of the DataStream.\n+        :return: The filtered DataStream.\n+        \"\"\"\n+        class FilterFlatMap(FlatMapFunction):\n+            def __init__(self, filter_func):\n+                self._func = filter_func\n+\n+            def flat_map(self, value):\n+                if self._func.filter(value):\n+                    yield value\n+\n+        j_input_type = self._j_data_stream.getTransformation().getOutputType()\n+        type_info = typeinfo._from_java_type(j_input_type)\n+        j_data_stream = self.flat_map(FilterFlatMap(func), type_info=type_info)._j_data_stream", "originalCommit": "8987176f205b330cf101f81aa126637c0846b298", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcwMDMzNA==", "url": "https://github.com/apache/flink/pull/13098#discussion_r467700334", "bodyText": "Remove ;", "author": "hequn8128", "createdAt": "2020-08-10T05:59:01Z", "path": "flink-python/pyflink/datastream/functions.py", "diffHunk": "@@ -83,6 +83,29 @@ def flat_map(self, value):\n         pass\n \n \n+class FilterFunction(Function):\n+    \"\"\"\n+    A filter function is a predicate applied individually to each record. The predicate decides\n+    whether to keep the element, or to discard it.\n+    The basic syntax for using a FilterFunction is as follows:\n+    :\n+         >>> ds = ...;", "originalCommit": "8987176f205b330cf101f81aa126637c0846b298", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcwMDYyMQ==", "url": "https://github.com/apache/flink/pull/13098#discussion_r467700621", "bodyText": "Tre => True", "author": "hequn8128", "createdAt": "2020-08-10T06:00:19Z", "path": "flink-python/pyflink/datastream/functions.py", "diffHunk": "@@ -83,6 +83,29 @@ def flat_map(self, value):\n         pass\n \n \n+class FilterFunction(Function):\n+    \"\"\"\n+    A filter function is a predicate applied individually to each record. The predicate decides\n+    whether to keep the element, or to discard it.\n+    The basic syntax for using a FilterFunction is as follows:\n+    :\n+         >>> ds = ...;\n+         >>> result = ds.filter(new MyFilterFunction())\n+    Note that the system assumes that the function does not modify the elemetns on which the\n+    predicate is applied. Violating this assumption can lead to incoorect results.\n+    \"\"\"\n+\n+    @abc.abstractmethod\n+    def filter(self, value):\n+        \"\"\"\n+        The filter function that evaluates the predicate.\n+\n+        :param value: The value to be filtered.\n+        :return: Tre for values that should be retained, false for values to be filtered out.", "originalCommit": "8987176f205b330cf101f81aa126637c0846b298", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcwMDY5MA==", "url": "https://github.com/apache/flink/pull/13098#discussion_r467700690", "bodyText": "elemetns => elements", "author": "hequn8128", "createdAt": "2020-08-10T06:00:33Z", "path": "flink-python/pyflink/datastream/functions.py", "diffHunk": "@@ -83,6 +83,29 @@ def flat_map(self, value):\n         pass\n \n \n+class FilterFunction(Function):\n+    \"\"\"\n+    A filter function is a predicate applied individually to each record. The predicate decides\n+    whether to keep the element, or to discard it.\n+    The basic syntax for using a FilterFunction is as follows:\n+    :\n+         >>> ds = ...;\n+         >>> result = ds.filter(new MyFilterFunction())\n+    Note that the system assumes that the function does not modify the elemetns on which the", "originalCommit": "8987176f205b330cf101f81aa126637c0846b298", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcwMDc4NA==", "url": "https://github.com/apache/flink/pull/13098#discussion_r467700784", "bodyText": "incoorect => incorrect", "author": "hequn8128", "createdAt": "2020-08-10T06:00:57Z", "path": "flink-python/pyflink/datastream/functions.py", "diffHunk": "@@ -83,6 +83,29 @@ def flat_map(self, value):\n         pass\n \n \n+class FilterFunction(Function):\n+    \"\"\"\n+    A filter function is a predicate applied individually to each record. The predicate decides\n+    whether to keep the element, or to discard it.\n+    The basic syntax for using a FilterFunction is as follows:\n+    :\n+         >>> ds = ...;\n+         >>> result = ds.filter(new MyFilterFunction())\n+    Note that the system assumes that the function does not modify the elemetns on which the\n+    predicate is applied. Violating this assumption can lead to incoorect results.", "originalCommit": "8987176f205b330cf101f81aa126637c0846b298", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcwMDk5Nw==", "url": "https://github.com/apache/flink/pull/13098#discussion_r467700997", "bodyText": "Remove new", "author": "hequn8128", "createdAt": "2020-08-10T06:01:58Z", "path": "flink-python/pyflink/datastream/functions.py", "diffHunk": "@@ -83,6 +83,29 @@ def flat_map(self, value):\n         pass\n \n \n+class FilterFunction(Function):\n+    \"\"\"\n+    A filter function is a predicate applied individually to each record. The predicate decides\n+    whether to keep the element, or to discard it.\n+    The basic syntax for using a FilterFunction is as follows:\n+    :\n+         >>> ds = ...;\n+         >>> result = ds.filter(new MyFilterFunction())", "originalCommit": "8987176f205b330cf101f81aa126637c0846b298", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcwMTUwNA==", "url": "https://github.com/apache/flink/pull/13098#discussion_r467701504", "bodyText": "This class has never been used.", "author": "hequn8128", "createdAt": "2020-08-10T06:04:22Z", "path": "flink-python/pyflink/datastream/functions.py", "diffHunk": "@@ -140,6 +163,19 @@ def flat_map(self, value):\n         return self._func(value)\n \n \n+class FilterFunctionWrapper(FunctionWrapper):", "originalCommit": "8987176f205b330cf101f81aa126637c0846b298", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcwMTcxNA==", "url": "https://github.com/apache/flink/pull/13098#discussion_r467701714", "bodyText": "Change either one to Callable filter function to cover the Callable scenario.", "author": "hequn8128", "createdAt": "2020-08-10T06:05:15Z", "path": "flink-python/pyflink/datastream/tests/test_data_stream.py", "diffHunk": "@@ -149,6 +149,33 @@ def flat_map(value):\n         expected.sort()\n         self.assertEqual(expected, results)\n \n+    def test_filter_without_data_types(self):\n+        ds = self.env.from_collection([(1, 'Hi', 'Hello'), (2, 'Hello', 'Hi')])\n+        filtered_stream = ds.filter(MyFilterFunction())\n+        collect_util = DataStreamCollectUtil()\n+        collect_util.collect(filtered_stream)\n+        self.env.execute(\"test filter\")\n+        results = collect_util.results()\n+        expected = [\"(2, 'Hello', 'Hi')\"]\n+        results.sort()\n+        expected.sort()\n+        self.assertEqual(expected, results)\n+\n+    def test_filter_with_data_types(self):\n+        ds = self.env.from_collection([(1, 'Hi', 'Hello'), (2, 'Hello', 'Hi')],\n+                                      type_info=Types.ROW(\n+                                          [Types.INT(), Types.STRING(), Types.STRING()])\n+                                      )\n+        filtered_stream = ds.filter(MyFilterFunction())\n+        collect_util = DataStreamCollectUtil()\n+        collect_util.collect(filtered_stream)\n+        self.env.execute(\"test filter\")\n+        results = collect_util.results()\n+        expected = ['2,Hello,Hi']\n+        results.sort()\n+        expected.sort()\n+        self.assertEqual(expected, results)", "originalCommit": "8987176f205b330cf101f81aa126637c0846b298", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzczMTMwMA==", "url": "https://github.com/apache/flink/pull/13098#discussion_r467731300", "bodyText": "throw an exception if it is not a FilterFunction nor a Callable function.", "author": "hequn8128", "createdAt": "2020-08-10T07:34:20Z", "path": "flink-python/pyflink/datastream/data_stream.py", "diffHunk": "@@ -233,6 +234,35 @@ def flat_map(self, func: Union[Callable, FlatMapFunction], type_info: TypeInform\n             j_python_data_stream_scalar_function_operator\n         ))\n \n+    def filter(self, func: Union[Callable, FilterFunction]) -> 'DataStream':\n+        \"\"\"\n+        Applies a Filter transformation on a DataStream. The transformation calls a FilterFunction\n+        for each element of the DataStream and retains only those element for which the function\n+        returns true. Elements for which the function returns false are filtered. The user can also\n+        extend RichFilterFunction to gain access to other features provided by the RichFunction\n+        interface.\n+\n+        :param func: The FilterFunction that is called for each element of the DataStream.\n+        :return: The filtered DataStream.\n+        \"\"\"\n+        class FilterFlatMap(FlatMapFunction):\n+            def __init__(self, filter_func):\n+                self._func = filter_func\n+\n+            def flat_map(self, value):\n+                if self._func.filter(value):\n+                    yield value\n+\n+        if isinstance(func, Callable):", "originalCommit": "8c98a59b403eb2e1d16f3915f3b5fca1ba5c88ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzczMjY0NQ==", "url": "https://github.com/apache/flink/pull/13098#discussion_r467732645", "bodyText": "Ok, this will make it more robust.", "author": "shuiqiangchen", "createdAt": "2020-08-10T07:37:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzczMTMwMA=="}], "type": "inlineReview"}, {"oid": "2577a9c0cca713f583f38d593c8803bc6d5506c8", "url": "https://github.com/apache/flink/commit/2577a9c0cca713f583f38d593c8803bc6d5506c8", "message": "- rebase master branch", "committedDate": "2020-08-10T11:51:48Z", "type": "forcePushed"}, {"oid": "af3d92942065464e267e9715696ec3154ed32ee9", "url": "https://github.com/apache/flink/commit/af3d92942065464e267e9715696ec3154ed32ee9", "message": "-rebase master", "committedDate": "2020-08-11T02:17:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM3MDM2Mw==", "url": "https://github.com/apache/flink/pull/13098#discussion_r468370363", "bodyText": "There are side effects for this implementation. If we perform multi key_by, it will also introduce multi maps in the stream graph. This should be avoided.", "author": "hequn8128", "createdAt": "2020-08-11T07:07:58Z", "path": "flink-python/pyflink/datastream/data_stream.py", "diffHunk": "@@ -434,6 +465,16 @@ def flat_map(self, func: Union[Callable, FlatMapFunction], type_info: TypeInform\n             -> 'DataStream':\n         return self._values().flat_map(func, type_info)\n \n+    def filter(self, func: Union[Callable, FilterFunction]) -> 'DataStream':\n+        return self._values().filter(func)\n+\n+    def add_sink(self, sink_func: SinkFunction) -> 'DataStreamSink':\n+        return self._values().add_sink(sink_func)\n+\n+    def key_by(self, key_selector: Union[Callable, KeySelector],\n+               key_type_info: TypeInformation = None) -> 'KeyedStream':\n+        return self._values().key_by(key_selector, key_type_info)", "originalCommit": "19ff831a80a0ab5a1fbaabfb6d19e91f25d32314", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ace2b45eaf1462b8f9d7896cbd298b1b933affcf", "url": "https://github.com/apache/flink/commit/ace2b45eaf1462b8f9d7896cbd298b1b933affcf", "message": "[FLINK-18866][python] Support filter() operation for Python DataStream API.", "committedDate": "2020-08-11T09:25:25Z", "type": "commit"}, {"oid": "76abab84fbdfa86ed35c97368e573a22a606abdb", "url": "https://github.com/apache/flink/commit/76abab84fbdfa86ed35c97368e573a22a606abdb", "message": "- resolve review issues.", "committedDate": "2020-08-11T09:25:25Z", "type": "commit"}, {"oid": "6492a6bcd67aa1666b0ef7e3d9912f27caeeb9f8", "url": "https://github.com/apache/flink/commit/6492a6bcd67aa1666b0ef7e3d9912f27caeeb9f8", "message": "- resolve review issues.", "committedDate": "2020-08-11T09:25:25Z", "type": "commit"}, {"oid": "8dce931da7986e9551066e2298bdc267721bd9fd", "url": "https://github.com/apache/flink/commit/8dce931da7986e9551066e2298bdc267721bd9fd", "message": "- rebase master branch", "committedDate": "2020-08-11T09:25:25Z", "type": "commit"}, {"oid": "0bcbe3e041fa542b38489a9cb2ed283be7b4b450", "url": "https://github.com/apache/flink/commit/0bcbe3e041fa542b38489a9cb2ed283be7b4b450", "message": "-rebase master", "committedDate": "2020-08-11T09:26:23Z", "type": "commit"}, {"oid": "1552f6c1f93a6775863b6d90b8d8db88ad417531", "url": "https://github.com/apache/flink/commit/1552f6c1f93a6775863b6d90b8d8db88ad417531", "message": "[FLINK-18866][python] override filter() for KeyedStream.", "committedDate": "2020-08-11T09:27:04Z", "type": "commit"}, {"oid": "d0b8fe46103e7e96f4afa9bfeda2a0a5becd1244", "url": "https://github.com/apache/flink/commit/d0b8fe46103e7e96f4afa9bfeda2a0a5becd1244", "message": "[FLINK-18866][python] Simplified key_by() for KeyedStream", "committedDate": "2020-08-11T09:27:04Z", "type": "commit"}, {"oid": "9eccf085ce92a91039325b98bb5de50ccd258f5e", "url": "https://github.com/apache/flink/commit/9eccf085ce92a91039325b98bb5de50ccd258f5e", "message": "[FLINK-18866][python] Add filter() operation for Python DataStream API.", "committedDate": "2020-08-11T09:38:39Z", "type": "commit"}, {"oid": "9eccf085ce92a91039325b98bb5de50ccd258f5e", "url": "https://github.com/apache/flink/commit/9eccf085ce92a91039325b98bb5de50ccd258f5e", "message": "[FLINK-18866][python] Add filter() operation for Python DataStream API.", "committedDate": "2020-08-11T09:38:39Z", "type": "forcePushed"}]}