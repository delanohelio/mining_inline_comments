{"pr_number": 1786, "pr_title": "HIVE-23684: Large underestimation in NDV stats when input and join ca\u2026", "pr_createdAt": "2020-12-16T00:06:58Z", "pr_url": "https://github.com/apache/hive/pull/1786", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDYwMjI3Ng==", "url": "https://github.com/apache/hive/pull/1786#discussion_r544602276", "bodyText": "typo: estimatation", "author": "jcamachor", "createdAt": "2020-12-16T20:30:21Z", "path": "common/src/java/org/apache/hadoop/hive/conf/HiveConf.java", "diffHunk": "@@ -2686,6 +2686,8 @@ private static void populateLlapDaemonVarsSet(Set<String> llapDaemonVarsSetLocal\n         \"Estimate statistics in absence of statistics.\"),\n     HIVE_STATS_NDV_ESTIMATE_PERC(\"hive.stats.ndv.estimate.percent\", (float)20,\n         \"This many percentage of rows will be estimated as count distinct in absence of statistics.\"),\n+    HIVE_STATS_JOIN_NDV_READJUSTMENT(\"hive.stats.join.ndv.readjustment\", false,\n+        \"Setting this to true will make Hive use Calcite to adjust estimatation for ndv after join.\"),", "originalCommit": "9f9dbb2a921b285935400c4b4859f7fc9e262834", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDYwMzAwNg==", "url": "https://github.com/apache/hive/pull/1786#discussion_r544603006", "bodyText": "Setting this to true will make Hive use Calcite\nInstead of 'Calcite' logic, could you maybe mention (one-liner since it is a config and there is no need of it to be too long) the kind of estimation it does?", "author": "jcamachor", "createdAt": "2020-12-16T20:31:35Z", "path": "common/src/java/org/apache/hadoop/hive/conf/HiveConf.java", "diffHunk": "@@ -2686,6 +2686,8 @@ private static void populateLlapDaemonVarsSet(Set<String> llapDaemonVarsSetLocal\n         \"Estimate statistics in absence of statistics.\"),\n     HIVE_STATS_NDV_ESTIMATE_PERC(\"hive.stats.ndv.estimate.percent\", (float)20,\n         \"This many percentage of rows will be estimated as count distinct in absence of statistics.\"),\n+    HIVE_STATS_JOIN_NDV_READJUSTMENT(\"hive.stats.join.ndv.readjustment\", false,\n+        \"Setting this to true will make Hive use Calcite to adjust estimatation for ndv after join.\"),", "originalCommit": "9f9dbb2a921b285935400c4b4859f7fc9e262834", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDYwMzUyMA==", "url": "https://github.com/apache/hive/pull/1786#discussion_r544603520", "bodyText": "Can RelMdUtil.numDistinctVals return null? Just making sure we do not need a null check.", "author": "jcamachor", "createdAt": "2020-12-16T20:32:25Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/optimizer/stats/annotation/StatsRulesProcFactory.java", "diffHunk": "@@ -2546,19 +2547,25 @@ private void updateColStats(HiveConf conf, Statistics stats, long leftUnmatchedR\n       for (ColStatistics cs : colStats) {\n         colNameStatsAvailable.add(cs.getColumnName());\n         int pos = jop.getConf().getReversedExprs().get(cs.getColumnName());\n-        long oldRowCount = rowCountParents.get(pos);\n-        double ratio = (double) newNumRows / (double) oldRowCount;\n         long oldDV = cs.getCountDistint();\n+\n+        boolean useCalciteForNdvReadjustment\n+            = HiveConf.getBoolVar(conf, ConfVars.HIVE_STATS_JOIN_NDV_READJUSTMENT);\n         long newDV = oldDV;\n+        if (useCalciteForNdvReadjustment) {\n+          newDV = RelMdUtil.numDistinctVals(oldDV * 1.0, newNumRows * 1.0).longValue();", "originalCommit": "9f9dbb2a921b285935400c4b4859f7fc9e262834", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f447833b98749d72092d27fc5f7760a15cc3c35c", "url": "https://github.com/apache/hive/commit/f447833b98749d72092d27fc5f7760a15cc3c35c", "message": "HIVE-23684: Large underestimation in NDV stats when input and join cardinality ratio is big", "committedDate": "2020-12-21T20:31:19Z", "type": "commit"}, {"oid": "8d3fef877cbf45ea3a54379137490e8f80b9bd48", "url": "https://github.com/apache/hive/commit/8d3fef877cbf45ea3a54379137490e8f80b9bd48", "message": "addressing review comments", "committedDate": "2020-12-21T20:31:19Z", "type": "commit"}, {"oid": "8d3fef877cbf45ea3a54379137490e8f80b9bd48", "url": "https://github.com/apache/hive/commit/8d3fef877cbf45ea3a54379137490e8f80b9bd48", "message": "addressing review comments", "committedDate": "2020-12-21T20:31:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA2NjU3OQ==", "url": "https://github.com/apache/hive/pull/1786#discussion_r547066579", "bodyText": "We should probably add a precondition so we fail it if is null. Otherwise, we will basically not scale the value silently, which is neither the new behavior or the old behavior.", "author": "jcamachor", "createdAt": "2020-12-22T04:51:18Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/optimizer/stats/annotation/StatsRulesProcFactory.java", "diffHunk": "@@ -2553,7 +2553,10 @@ private void updateColStats(HiveConf conf, Statistics stats, long leftUnmatchedR\n             = HiveConf.getBoolVar(conf, ConfVars.HIVE_STATS_JOIN_NDV_READJUSTMENT);\n         long newDV = oldDV;\n         if (useCalciteForNdvReadjustment) {\n-          newDV = RelMdUtil.numDistinctVals(oldDV * 1.0, newNumRows * 1.0).longValue();\n+          Double approxNdv = RelMdUtil.numDistinctVals(oldDV * 1.0, newNumRows * 1.0);\n+          if (approxNdv != null) {", "originalCommit": "8d3fef877cbf45ea3a54379137490e8f80b9bd48", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "14b093d4441dcfe017f7947c5b6e4dc06818d363", "url": "https://github.com/apache/hive/commit/14b093d4441dcfe017f7947c5b6e4dc06818d363", "message": "addressing review comments", "committedDate": "2020-12-22T16:56:41Z", "type": "commit"}, {"oid": "8a95b5d0c85cd9076a363337ecb00830602c7ed1", "url": "https://github.com/apache/hive/commit/8a95b5d0c85cd9076a363337ecb00830602c7ed1", "message": "Merge remote-tracking branch 'upstream/master' into HIVE-23684", "committedDate": "2020-12-22T16:57:19Z", "type": "commit"}, {"oid": "2c2e7c59d315ace51fc3ff52b9abd010b553b5f5", "url": "https://github.com/apache/hive/commit/2c2e7c59d315ace51fc3ff52b9abd010b553b5f5", "message": "Merge remote-tracking branch 'upstream/master' into HIVE-23684", "committedDate": "2021-01-04T16:59:02Z", "type": "commit"}, {"oid": "6802ecc46f31963fbe62bd8e1e8c20ca5f9834f7", "url": "https://github.com/apache/hive/commit/6802ecc46f31963fbe62bd8e1e8c20ca5f9834f7", "message": "Merge remote-tracking branch 'upstream/master' into HIVE-23684", "committedDate": "2021-01-12T20:56:19Z", "type": "commit"}]}