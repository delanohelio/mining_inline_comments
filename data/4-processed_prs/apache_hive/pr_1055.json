{"pr_number": 1055, "pr_title": "HIVE-23602: Use Java Concurrent Package for Operation Handle Set", "pr_createdAt": "2020-06-03T14:53:18Z", "pr_url": "https://github.com/apache/hive/pull/1055", "timeline": [{"oid": "b2eedde2982014ab999a5df50b12288eb4362768", "url": "https://github.com/apache/hive/commit/b2eedde2982014ab999a5df50b12288eb4362768", "message": "HIVE-23602: Use Java Concurrent Package for Operation Handle Set", "committedDate": "2020-06-03T14:49:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM3MDM3Ng==", "url": "https://github.com/apache/hive/pull/1055#discussion_r441370376", "bodyText": "What happens when a new operation arrived concurrently?", "author": "pvary", "createdAt": "2020-06-17T08:24:13Z", "path": "service/src/java/org/apache/hive/service/cli/session/HiveSessionImpl.java", "diffHunk": "@@ -757,14 +754,13 @@ public void close() throws HiveSQLException {\n     try {\n       acquire(true, false);\n       // Iterate through the opHandles and close their operations\n-      List<OperationHandle> ops = null;\n-      synchronized (opHandleSet) {\n-        ops = new ArrayList<>(opHandleSet);\n-        opHandleSet.clear();\n-      }\n-      for (OperationHandle opHandle : ops) {\n+      List<OperationHandle> closedOps = new ArrayList<>();\n+      for (OperationHandle opHandle : opHandleSet) {\n         operationManager.closeOperation(opHandle);\n+        closedOps.add(opHandle);\n       }\n+      opHandleSet.removeAll(closedOps);", "originalCommit": "b2eedde2982014ab999a5df50b12288eb4362768", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjI2NDQ4Nw==", "url": "https://github.com/apache/hive/pull/1055#discussion_r442264487", "bodyText": "Well, this is the close() method so presumably there are no more coming in once this is called.  Regardless, it won't matter.  The opHandleSet is synchronized here so it will remove all of the objects there were closed. which is what the current implementation does too: if new ones come in after the clear, they will just remain in the set.   If we want to add some sort of locking to prevent new entries from coming in after calling close(), that would have to happen in a different ticket.", "author": "belugabehr", "createdAt": "2020-06-18T14:22:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM3MDM3Ng=="}], "type": "inlineReview"}]}