{"pr_number": 1323, "pr_title": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)", "pr_createdAt": "2020-07-27T14:34:10Z", "pr_url": "https://github.com/apache/hive/pull/1323", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY3NTcwNA==", "url": "https://github.com/apache/hive/pull/1323#discussion_r461675704", "bodyText": "Should we also check whether the ReduceSink also has a topn value greater then 0?\nreduceSink.getConf().getTopN() > 0", "author": "kasakrisz", "createdAt": "2020-07-28T15:33:05Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/optimizer/OrderlessLimitPushDownOptimizer.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/*\n+ *\n+ *  * Licensed to the Apache Software Foundation (ASF) under one\n+ *  * or more contributor license agreements.  See the NOTICE file\n+ *  * distributed with this work for additional information\n+ *  * regarding copyright ownership.  The ASF licenses this file\n+ *  * to you under the Apache License, Version 2.0 (the\n+ *  * \"License\"); you may not use this file except in compliance\n+ *  * with the License.  You may obtain a copy of the License at\n+ *  *\n+ *  *     http://www.apache.org/licenses/LICENSE-2.0\n+ *  *\n+ *  * Unless required by applicable law or agreed to in writing, software\n+ *  * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  * See the License for the specific language governing permissions and\n+ *  * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.hadoop.hive.ql.optimizer;\n+\n+import static org.apache.hadoop.hive.ql.optimizer.topnkey.TopNKeyProcessor.copyDown;\n+import static org.apache.hadoop.hive.ql.optimizer.topnkey.TopNKeyPushdownProcessor.moveDown;\n+\n+import java.util.ArrayList;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Stack;\n+\n+import org.apache.hadoop.hive.ql.exec.CommonJoinOperator;\n+import org.apache.hadoop.hive.ql.exec.LimitOperator;\n+import org.apache.hadoop.hive.ql.exec.Operator;\n+import org.apache.hadoop.hive.ql.exec.ReduceSinkOperator;\n+import org.apache.hadoop.hive.ql.lib.DefaultGraphWalker;\n+import org.apache.hadoop.hive.ql.lib.DefaultRuleDispatcher;\n+import org.apache.hadoop.hive.ql.lib.Node;\n+import org.apache.hadoop.hive.ql.lib.NodeProcessorCtx;\n+import org.apache.hadoop.hive.ql.lib.RuleRegExp;\n+import org.apache.hadoop.hive.ql.lib.SemanticGraphWalker;\n+import org.apache.hadoop.hive.ql.lib.SemanticNodeProcessor;\n+import org.apache.hadoop.hive.ql.lib.SemanticRule;\n+import org.apache.hadoop.hive.ql.parse.ParseContext;\n+import org.apache.hadoop.hive.ql.parse.SemanticException;\n+import org.apache.hadoop.hive.ql.plan.JoinCondDesc;\n+import org.apache.hadoop.hive.ql.plan.JoinDesc;\n+import org.apache.hadoop.hive.ql.plan.OperatorDesc;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Push LIMIT without an Order By through Selects and Left Outer Joins\n+ */\n+public class OrderlessLimitPushDownOptimizer extends Transform {\n+  private static final Logger LOG = LoggerFactory.getLogger(OrderlessLimitPushDownOptimizer.class);\n+\n+  @Override\n+  public ParseContext transform(ParseContext pctx) throws SemanticException {\n+    Map<SemanticRule, SemanticNodeProcessor> opRules = new LinkedHashMap<SemanticRule, SemanticNodeProcessor>();\n+    opRules.put(\n+            new RuleRegExp(\"LIMIT push down\", LimitOperator.getOperatorName() + \"%\"),\n+            new LimitPushDown());\n+    SemanticGraphWalker walker = new DefaultGraphWalker(new DefaultRuleDispatcher(null, opRules, null));\n+    walker.startWalking(new ArrayList<>(pctx.getTopOps().values()), null);\n+    return pctx;\n+  }\n+\n+  private static class LimitPushDown implements SemanticNodeProcessor {\n+    @Override\n+    public Object process(Node nd, Stack<Node> stack, NodeProcessorCtx procCtx, Object... nodeOutputs) throws SemanticException {\n+      ReduceSinkOperator reduceSink = findReduceSink(stack);\n+      if (reduceSink != null && !reduceSink.getConf().hasOrderBy()) { // LIMIT + ORDER BY handled by TopNKey push down", "originalCommit": "2759c81ae5e39137f669b1d21e9d68be674bfe5d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjMwNjE1MA==", "url": "https://github.com/apache/hive/pull/1323#discussion_r462306150", "bodyText": "As we discussed offline a limit without order by, sort by and group by doesn't set ReduceSinkDesc.topn", "author": "kasakrisz", "createdAt": "2020-07-29T13:40:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY3NTcwNA=="}], "type": "inlineReview"}, {"oid": "c223a3e76574f8ed62c5962c89bdfa4d826fbc99", "url": "https://github.com/apache/hive/commit/c223a3e76574f8ed62c5962c89bdfa4d826fbc99", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)", "committedDate": "2020-07-29T14:04:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg1MjMxNg==", "url": "https://github.com/apache/hive/pull/1323#discussion_r462852316", "bodyText": "Why couldn't be pushed through[SEL_1]  ?", "author": "kasakrisz", "createdAt": "2020-07-30T08:56:48Z", "path": "ql/src/test/results/clientpositive/llap/explainuser_1.q.out", "diffHunk": "@@ -124,27 +124,25 @@ Stage-3\n                   <-Reducer 2 [SIMPLE_EDGE] llap\n                     File Output Operator [FS_7]\n                       table:{\"name:\":\"default.src_orc_merge_test_part_n1\"}\n-                      Select Operator [SEL_6] (rows=100 width=95)\n+                      Select Operator [SEL_4] (rows=100 width=178)\n                         Output:[\"_col0\",\"_col1\"]\n                         Limit [LIM_5] (rows=100 width=178)\n                           Number of rows:100\n-                          Select Operator [SEL_4] (rows=100 width=178)\n-                            Output:[\"_col0\",\"_col1\"]\n-                          <-Map 1 [CUSTOM_SIMPLE_EDGE] llap\n-                            PARTITION_ONLY_SHUFFLE [RS_3]\n-                              Limit [LIM_2] (rows=100 width=178)\n-                                Number of rows:100\n-                                Select Operator [SEL_1] (rows=500 width=178)\n-                                  Output:[\"_col0\",\"_col1\"]\n-                                  TableScan [TS_0] (rows=500 width=178)\n-                                    default@src,src,Tbl:COMPLETE,Col:COMPLETE,Output:[\"key\",\"value\"]\n+                        <-Map 1 [CUSTOM_SIMPLE_EDGE] llap\n+                          PARTITION_ONLY_SHUFFLE [RS_3]\n+                            Limit [LIM_2] (rows=100 width=178)", "originalCommit": "78c90da56c3bd920b8fb446e63e7481446fd53a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTczNTA2MQ==", "url": "https://github.com/apache/hive/pull/1323#discussion_r465735061", "bodyText": "fixed", "author": "zeroflag", "createdAt": "2020-08-05T13:41:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg1MjMxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg2OTY1MA==", "url": "https://github.com/apache/hive/pull/1323#discussion_r462869650", "bodyText": "Does -- SORT_QUERY_RESULTS help avoid resultset change?", "author": "kasakrisz", "createdAt": "2020-07-30T09:27:01Z", "path": "ql/src/test/results/clientpositive/llap/limit_join_transpose.q.out", "diffHunk": "@@ -108,7 +111,7 @@ limit 1\n POSTHOOK: type: QUERY\n POSTHOOK: Input: default@src\n #### A masked pattern was here ####\n-0\tval_0\t0\tval_0\n+238\tval_238\t238\tval_238", "originalCommit": "78c90da56c3bd920b8fb446e63e7481446fd53a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEyNTM1Nw==", "url": "https://github.com/apache/hive/pull/1323#discussion_r463125357", "bodyText": "I'll try but I don't think it will help in this case. My understanding is that SORT_QUERY_RESULTS sorts the rows on the standard output on the client/driver side.", "author": "zeroflag", "createdAt": "2020-07-30T16:34:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg2OTY1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg3MDI2NA==", "url": "https://github.com/apache/hive/pull/1323#discussion_r462870264", "bodyText": "Result set disappeared.", "author": "kasakrisz", "createdAt": "2020-07-30T09:28:09Z", "path": "ql/src/test/results/clientpositive/llap/limit_join_transpose.q.out", "diffHunk": "@@ -1207,7 +1223,6 @@ limit 1 offset 1\n POSTHOOK: type: QUERY\n POSTHOOK: Input: default@src\n #### A masked pattern was here ####\n-0\tval_0\t0\tval_0", "originalCommit": "78c90da56c3bd920b8fb446e63e7481446fd53a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzExNTgwNg==", "url": "https://github.com/apache/hive/pull/1323#discussion_r463115806", "bodyText": "Good catch, it might be because there is an offset=1 belongs to the limit. The Limit is pushed through the LOJ, but the original one is also kept. The first limit emits 1 row, but the second emits 0 because of offset=1.", "author": "zeroflag", "createdAt": "2020-07-30T16:19:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg3MDI2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg3OTcyNQ==", "url": "https://github.com/apache/hive/pull/1323#discussion_r462879725", "bodyText": "It is worth investigating why we end up with a plan where the parent of a TNK is a Limit but that can be a follow-up patch since it is out of scope of this patch.", "author": "kasakrisz", "createdAt": "2020-07-30T09:44:45Z", "path": "ql/src/test/results/clientpositive/llap/input14_limit.q.out", "diffHunk": "@@ -75,19 +75,19 @@ STAGE PLANS:\n         Reducer 2 \n             Execution mode: vectorized, llap\n             Reduce Operator Tree:\n-              Select Operator\n-                expressions: VALUE._col0 (type: string), VALUE._col1 (type: string)\n-                outputColumnNames: _col0, _col1\n-                Statistics: Num rows: 500 Data size: 89000 Basic stats: COMPLETE Column stats: COMPLETE\n-                Limit\n-                  Number of rows: 20\n-                  Statistics: Num rows: 20 Data size: 3560 Basic stats: COMPLETE Column stats: COMPLETE\n-                  Top N Key Operator\n-                    sort order: +\n-                    keys: _col0 (type: string)\n-                    null sort order: a\n+              Limit", "originalCommit": "78c90da56c3bd920b8fb446e63e7481446fd53a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEwNzE3OQ==", "url": "https://github.com/apache/hive/pull/1323#discussion_r463107179", "bodyText": "I agree, opened HIVE-23957 about it..", "author": "zeroflag", "createdAt": "2020-07-30T16:06:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg3OTcyNQ=="}], "type": "inlineReview"}, {"oid": "933dcb6e0f2f7fb432d34246b8d2e44ec9992eff", "url": "https://github.com/apache/hive/commit/933dcb6e0f2f7fb432d34246b8d2e44ec9992eff", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)", "committedDate": "2020-08-05T13:28:22Z", "type": "forcePushed"}, {"oid": "b9ab95d3cb5c925cdead74a9633eafeeb9dbc916", "url": "https://github.com/apache/hive/commit/b9ab95d3cb5c925cdead74a9633eafeeb9dbc916", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)", "committedDate": "2020-08-12T14:03:11Z", "type": "commit"}, {"oid": "23ad0504777b61cac8575f1b757fbd3a2733f8d7", "url": "https://github.com/apache/hive/commit/23ad0504777b61cac8575f1b757fbd3a2733f8d7", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)", "committedDate": "2020-08-12T14:03:11Z", "type": "commit"}, {"oid": "748db6e71e423fc516f9fd2808e24d1ec938a035", "url": "https://github.com/apache/hive/commit/748db6e71e423fc516f9fd2808e24d1ec938a035", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)", "committedDate": "2020-08-12T14:03:11Z", "type": "commit"}, {"oid": "cc0107b1157c4dfd5c91dd8a8d114f947a098db6", "url": "https://github.com/apache/hive/commit/cc0107b1157c4dfd5c91dd8a8d114f947a098db6", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)", "committedDate": "2020-08-12T14:03:11Z", "type": "commit"}, {"oid": "ab5988fea63c9e281abdf181fab4d0809f0c6f3e", "url": "https://github.com/apache/hive/commit/ab5988fea63c9e281abdf181fab4d0809f0c6f3e", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)", "committedDate": "2020-08-12T14:03:11Z", "type": "commit"}, {"oid": "7fc560e13c6ac28ceac77e870d249e85602fdb31", "url": "https://github.com/apache/hive/commit/7fc560e13c6ac28ceac77e870d249e85602fdb31", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)", "committedDate": "2020-08-12T14:03:12Z", "type": "commit"}, {"oid": "4ba2c5f4a113ad1291e232e84c220124f1560144", "url": "https://github.com/apache/hive/commit/4ba2c5f4a113ad1291e232e84c220124f1560144", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)", "committedDate": "2020-08-12T14:03:12Z", "type": "commit"}, {"oid": "9a8a601e7086abd654cbfcf4ecbcd9d098e3e546", "url": "https://github.com/apache/hive/commit/9a8a601e7086abd654cbfcf4ecbcd9d098e3e546", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)", "committedDate": "2020-08-12T14:03:12Z", "type": "commit"}, {"oid": "12e879caea755db324e816ccac8b47193c7f47a7", "url": "https://github.com/apache/hive/commit/12e879caea755db324e816ccac8b47193c7f47a7", "message": " HIVE-23723. Limit operator pushdown through LOJ (amagyar)", "committedDate": "2020-08-12T14:03:13Z", "type": "commit"}, {"oid": "b002080112f89130094f6b64cf5a51c30efddaee", "url": "https://github.com/apache/hive/commit/b002080112f89130094f6b64cf5a51c30efddaee", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)", "committedDate": "2020-08-12T14:03:13Z", "type": "commit"}, {"oid": "e29d1fc54231428ed555bf3f85506112e6522ac8", "url": "https://github.com/apache/hive/commit/e29d1fc54231428ed555bf3f85506112e6522ac8", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)", "committedDate": "2020-08-12T14:03:13Z", "type": "commit"}, {"oid": "e7f1e12fa6e46ce7f82d3426a25aa538a2af6cb4", "url": "https://github.com/apache/hive/commit/e7f1e12fa6e46ce7f82d3426a25aa538a2af6cb4", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)", "committedDate": "2020-08-12T16:03:49Z", "type": "commit"}, {"oid": "e7f1e12fa6e46ce7f82d3426a25aa538a2af6cb4", "url": "https://github.com/apache/hive/commit/e7f1e12fa6e46ce7f82d3426a25aa538a2af6cb4", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)", "committedDate": "2020-08-12T16:03:49Z", "type": "forcePushed"}]}