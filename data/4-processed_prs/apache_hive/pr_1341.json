{"pr_number": 1341, "pr_title": "HIVE-23959: Provide an option to wipe out column stats for partitioned tables in case of column removal", "pr_createdAt": "2020-07-30T16:26:10Z", "pr_url": "https://github.com/apache/hive/pull/1341", "timeline": [{"oid": "a1818a4721a1dd044699275a9e25f4352f57c521", "url": "https://github.com/apache/hive/commit/a1818a4721a1dd044699275a9e25f4352f57c521", "message": "add p", "committedDate": "2020-07-07T06:58:31Z", "type": "commit"}, {"oid": "a4f69fb9061a4bfec1df01bf32a841eb736d02cd", "url": "https://github.com/apache/hive/commit/a4f69fb9061a4bfec1df01bf32a841eb736d02cd", "message": "fix1", "committedDate": "2020-07-07T07:01:30Z", "type": "commit"}, {"oid": "8ea4a5e78391cf85db3da6fb019c3149f001a604", "url": "https://github.com/apache/hive/commit/8ea4a5e78391cf85db3da6fb019c3149f001a604", "message": "fix", "committedDate": "2020-07-07T07:02:08Z", "type": "commit"}, {"oid": "7b948e136b3ea26eeb062d6a3cd6b99abf397dd3", "url": "https://github.com/apache/hive/commit/7b948e136b3ea26eeb062d6a3cd6b99abf397dd3", "message": "simplfy", "committedDate": "2020-07-13T11:45:35Z", "type": "commit"}, {"oid": "709cc7ca5d8040f788ebdf1ee77599a207655207", "url": "https://github.com/apache/hive/commit/709cc7ca5d8040f788ebdf1ee77599a207655207", "message": "Merge remote-tracking branch 'apache/master' into HIVE-23806-avoid-stat-clear", "committedDate": "2020-07-27T14:54:31Z", "type": "commit"}, {"oid": "92971e5c3f74474f023937dc7ac574179c4c836e", "url": "https://github.com/apache/hive/commit/92971e5c3f74474f023937dc7ac574179c4c836e", "message": "add new method/etc", "committedDate": "2020-07-28T10:27:27Z", "type": "commit"}, {"oid": "62158f64c9e40087cee1e6a7fc89bdb6a7e34479", "url": "https://github.com/apache/hive/commit/62158f64c9e40087cee1e6a7fc89bdb6a7e34479", "message": "add stuff?", "committedDate": "2020-07-28T13:55:56Z", "type": "commit"}, {"oid": "ade550f450571865edf7338ed3ab08cbc530c1d7", "url": "https://github.com/apache/hive/commit/ade550f450571865edf7338ed3ab08cbc530c1d7", "message": "add stuff", "committedDate": "2020-07-28T13:59:18Z", "type": "commit"}, {"oid": "a2dad47ce4b85000c529bc8c7f00e4428fcbc327", "url": "https://github.com/apache/hive/commit/a2dad47ce4b85000c529bc8c7f00e4428fcbc327", "message": "add stuff", "committedDate": "2020-07-29T15:37:46Z", "type": "commit"}, {"oid": "ad6c8ab93651dbf97a3d5942350f6b71096dfac0", "url": "https://github.com/apache/hive/commit/ad6c8ab93651dbf97a3d5942350f6b71096dfac0", "message": "fix", "committedDate": "2020-07-30T05:44:45Z", "type": "commit"}, {"oid": "03e8e36c92e98a01de3d8532dd4679a2d123c59c", "url": "https://github.com/apache/hive/commit/03e8e36c92e98a01de3d8532dd4679a2d123c59c", "message": "changesX", "committedDate": "2020-07-30T08:58:26Z", "type": "commit"}, {"oid": "278716463d16dc46d820a07e12a34fa385baad07", "url": "https://github.com/apache/hive/commit/278716463d16dc46d820a07e12a34fa385baad07", "message": "remove", "committedDate": "2020-07-30T08:59:37Z", "type": "commit"}, {"oid": "cbacfc898d97701a489fe516a33a964cd67b7914", "url": "https://github.com/apache/hive/commit/cbacfc898d97701a489fe516a33a964cd67b7914", "message": "remove", "committedDate": "2020-07-30T09:14:50Z", "type": "commit"}, {"oid": "0329f146a304f7e58ad39945cf446db2d2523c05", "url": "https://github.com/apache/hive/commit/0329f146a304f7e58ad39945cf446db2d2523c05", "message": "back2old", "committedDate": "2020-07-30T14:39:07Z", "type": "commit"}, {"oid": "c42694c3e020d3991de7b9081d01039722688060", "url": "https://github.com/apache/hive/commit/c42694c3e020d3991de7b9081d01039722688060", "message": "fix?", "committedDate": "2020-07-30T15:46:39Z", "type": "commit"}, {"oid": "cf4e4db7e54f6760edc9c9bb68b037a0edaa65e3", "url": "https://github.com/apache/hive/commit/cf4e4db7e54f6760edc9c9bb68b037a0edaa65e3", "message": "there you go", "committedDate": "2020-07-30T16:03:44Z", "type": "commit"}, {"oid": "abec5c36443e357357eb014ee748f88f3b01308e", "url": "https://github.com/apache/hive/commit/abec5c36443e357357eb014ee748f88f3b01308e", "message": "is it safe?", "committedDate": "2020-07-30T16:17:58Z", "type": "commit"}, {"oid": "e780f8d40c0ec62e325257345898c99ac3846434", "url": "https://github.com/apache/hive/commit/e780f8d40c0ec62e325257345898c99ac3846434", "message": "enable for all", "committedDate": "2020-07-30T16:21:55Z", "type": "commit"}, {"oid": "174ee6a46956dc46cf8f137abe9efe0b63ae00ff", "url": "https://github.com/apache/hive/commit/174ee6a46956dc46cf8f137abe9efe0b63ae00ff", "message": "Merge remote-tracking branch 'apache/master' into HIVE-23806-avoid-stat-clear", "committedDate": "2020-07-30T16:24:57Z", "type": "commit"}, {"oid": "d007ced685704732bcf4322ff9e574b5fc166b6b", "url": "https://github.com/apache/hive/commit/d007ced685704732bcf4322ff9e574b5fc166b6b", "message": "Merge branch 'HIVE-23806-avoid-stat-clear' into HIVE-23959-bulk-stat-removal", "committedDate": "2020-07-30T16:25:23Z", "type": "commit"}, {"oid": "bd9529c1b1a94b1fe0f813cc0e148c293977c065", "url": "https://github.com/apache/hive/commit/bd9529c1b1a94b1fe0f813cc0e148c293977c065", "message": "x", "committedDate": "2020-07-30T16:59:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQwNDI1NA==", "url": "https://github.com/apache/hive/pull/1341#discussion_r463404254", "bodyText": "Nit: formatting", "author": "pvary", "createdAt": "2020-07-31T04:54:36Z", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/MetaStoreDirectSql.java", "diffHunk": "@@ -984,16 +984,23 @@ private boolean isViewTable(String catName, String dbName, String tblName) throw\n       part.setCatName(catName);\n       part.setDbName(dbName);\n       part.setTableName(tblName);\n-      if (fields[4] != null) part.setCreateTime(MetastoreDirectSqlUtils.extractSqlInt(fields[4]));\n-      if (fields[5] != null) part.setLastAccessTime(MetastoreDirectSqlUtils.extractSqlInt(fields[5]));\n+      if (fields[4] != null) {\n+        part.setCreateTime(MetastoreDirectSqlUtils.extractSqlInt(fields[4]));\n+      }\n+      if (fields[5] != null) {\n+        part.setLastAccessTime(MetastoreDirectSqlUtils.extractSqlInt(fields[5]));\n+      }\n       Long writeId = MetastoreDirectSqlUtils.extractSqlLong(fields[14]);\n       if (writeId != null) {\n         part.setWriteId(writeId);\n       }\n       partitions.put(partitionId, part);\n \n \n-      if (sdId == null) continue; // Probably a view.\n+      if (sdId == null)", "originalCommit": "bd9529c1b1a94b1fe0f813cc0e148c293977c065", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQwNDc0MQ==", "url": "https://github.com/apache/hive/pull/1341#discussion_r463404741", "bodyText": "Please carefully check every \". Postgres and MySql are very problematic", "author": "pvary", "createdAt": "2020-07-31T04:56:21Z", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/MetaStoreDirectSql.java", "diffHunk": "@@ -2960,4 +2977,22 @@ public void lockDbTable(String tableName) throws MetaException {\n       throw new MetaException(\"Error while locking table \" + tableName + \": \" + sqle.getMessage());\n     }\n   }\n+\n+  public void deleteColumnStatsState(long tbl_id) throws MetaException {\n+    // @formatter:off\n+    String queryText = \"\"\n+        + \"delete from \" + PARTITION_PARAMS + \" pp\"\n+            + \" using \" + PARTITIONS + \" p \"\n+            + \" where \"\n+            + \"   p.\\\"PART_ID = pp.\\\"PART_ID\\\"\"", "originalCommit": "bd9529c1b1a94b1fe0f813cc0e148c293977c065", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzYzODcyOA==", "url": "https://github.com/apache/hive/pull/1341#discussion_r463638728", "bodyText": "I've changed the sql - now it works with mysql as well", "author": "kgyrtkirk", "createdAt": "2020-07-31T14:18:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQwNDc0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQwNTIzMA==", "url": "https://github.com/apache/hive/pull/1341#discussion_r463405230", "bodyText": "This seems strange. Setting this to null and one line below checking", "author": "pvary", "createdAt": "2020-07-31T04:58:36Z", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/ObjectStore.java", "diffHunk": "@@ -9483,6 +9483,81 @@ private void dropPartitionColumnStatisticsNoTxn(\n     queryWithParams.getLeft().closeAll();\n   }\n \n+  @Override\n+  public void deleteAllPartitionColumnStatistics(TableName tn, String writeIdList) {\n+\n+    String catName = tn.getCat();\n+    String dbName = tn.getDb();\n+    String tableName = tn.getTable();\n+\n+    Query query = null;\n+    dbName = org.apache.commons.lang3.StringUtils.defaultString(dbName, Warehouse.DEFAULT_DATABASE_NAME);\n+    catName = normalizeIdentifier(catName);\n+    if (tableName == null) {\n+      throw new RuntimeException(\"Table name is null.\");\n+    }\n+    boolean ret = false;\n+    try {\n+      openTransaction();\n+      MTable mTable = getMTable(catName, dbName, tableName);\n+\n+      query = pm.newQuery(MPartitionColumnStatistics.class);\n+\n+      Object engine = null;", "originalCommit": "bd9529c1b1a94b1fe0f813cc0e148c293977c065", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQzNTU3NA==", "url": "https://github.com/apache/hive/pull/1341#discussion_r463435574", "bodyText": "oh..sorry; I plan to disable this option by default - and leave only a targeted test to cover for it\nbut I wanted to make a sanity check that this will work in case all tests are executed (and it does)\nI should have marked it as wip or something..I'll clean up things like this in the next version.\nthank you for taking a look!  I was testing with psql so far but  I'll check mysql as well!", "author": "kgyrtkirk", "createdAt": "2020-07-31T06:50:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQwNTIzMA=="}], "type": "inlineReview"}, {"oid": "af3b39272e9cded01ea696496e473ff2207567e6", "url": "https://github.com/apache/hive/commit/af3b39272e9cded01ea696496e473ff2207567e6", "message": "updates; test/etc", "committedDate": "2020-07-31T13:20:30Z", "type": "commit"}, {"oid": "211621f4b6d7f4657c78348bf4998b255418eb8d", "url": "https://github.com/apache/hive/commit/211621f4b6d7f4657c78348bf4998b255418eb8d", "message": "mysql doesnt like aliases", "committedDate": "2020-07-31T13:50:11Z", "type": "commit"}, {"oid": "a08a37c71a852b26cd2d94293dddc4bd3bc01a2b", "url": "https://github.com/apache/hive/commit/a08a37c71a852b26cd2d94293dddc4bd3bc01a2b", "message": "mistake", "committedDate": "2020-07-31T14:03:18Z", "type": "commit"}, {"oid": "f3c4c007a504089f4077872487e1f1406a9e69bd", "url": "https://github.com/apache/hive/commit/f3c4c007a504089f4077872487e1f1406a9e69bd", "message": "correct format", "committedDate": "2020-07-31T14:04:22Z", "type": "commit"}, {"oid": "6a58d6387aaa9d4abbb234b88610b8297864c681", "url": "https://github.com/apache/hive/commit/6a58d6387aaa9d4abbb234b88610b8297864c681", "message": "remove engine stuff", "committedDate": "2020-07-31T14:19:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg1MDIwOA==", "url": "https://github.com/apache/hive/pull/1341#discussion_r464850208", "bodyText": "nit: Whether?", "author": "pvary", "createdAt": "2020-08-04T07:21:11Z", "path": "standalone-metastore/metastore-common/src/main/java/org/apache/hadoop/hive/metastore/conf/MetastoreConf.java", "diffHunk": "@@ -1352,6 +1352,12 @@ public static ConfVars getMetaConf(String name) {\n             \"If both this and the metastore.dbaccess.ssl.* properties are set, then the latter properties \\n\" +\n             \"will overwrite what was set in the deprecated property.\"),\n \n+    COLSTATS_RETAIN_ON_COLUMN_REMOVAL(\"metastore.colstats.retain.on.column.removal\",\n+        \"hive.metastore.colstats.retain.on.column.removal\", true,\n+        \"Wether to retain column statistics during column removals in partitioned tables - disabling this \"", "originalCommit": "6a58d6387aaa9d4abbb234b88610b8297864c681", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg1MTAwOA==", "url": "https://github.com/apache/hive/pull/1341#discussion_r464851008", "bodyText": "nit: spaces around the '+' sing", "author": "pvary", "createdAt": "2020-08-04T07:22:52Z", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/MetaStoreDirectSql.java", "diffHunk": "@@ -2960,4 +2976,21 @@ public void lockDbTable(String tableName) throws MetaException {\n       throw new MetaException(\"Error while locking table \" + tableName + \": \" + sqle.getMessage());\n     }\n   }\n+\n+  public void deleteColumnStatsState(long tbl_id) throws MetaException {\n+    // @formatter:off\n+    String queryText = \"\"\n+        + \"delete from \" + PARTITION_PARAMS + \" \"\n+            + \" where \"\n+            + \"   \\\"PART_ID\\\" in (select p.\\\"PART_ID\\\"  from \"+PARTITIONS+\" p where\"", "originalCommit": "6a58d6387aaa9d4abbb234b88610b8297864c681", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d63b98820f6ee61a9ec78366361081b6f3ca0bb0", "url": "https://github.com/apache/hive/commit/d63b98820f6ee61a9ec78366361081b6f3ca0bb0", "message": "fix", "committedDate": "2020-08-04T07:24:42Z", "type": "commit"}, {"oid": "a0f305d059e82adad6250eff289941ce0014da60", "url": "https://github.com/apache/hive/commit/a0f305d059e82adad6250eff289941ce0014da60", "message": "Merge remote-tracking branch 'apache/master' into HIVE-23959-bulk-stat-removal", "committedDate": "2020-08-04T07:24:45Z", "type": "commit"}, {"oid": "509530b80bf3451d4721f6d797bb188caf995f54", "url": "https://github.com/apache/hive/commit/509530b80bf3451d4721f6d797bb188caf995f54", "message": "correct ws", "committedDate": "2020-08-04T07:26:57Z", "type": "commit"}]}