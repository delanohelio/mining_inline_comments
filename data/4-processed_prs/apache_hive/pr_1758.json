{"pr_number": 1758, "pr_title": "HIVE-24504: VectorFileSinkArrowOperator does not serialize complex types correctly", "pr_createdAt": "2020-12-09T11:23:56Z", "pr_url": "https://github.com/apache/hive/pull/1758", "timeline": [{"oid": "9c96e6cef845fa23049be2f4d635f7b9d6d73c83", "url": "https://github.com/apache/hive/commit/9c96e6cef845fa23049be2f4d635f7b9d6d73c83", "message": "HIVE-24504: VectorFileSinkArrowOperator does not serialize complex types correctly", "committedDate": "2020-12-08T16:59:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIyODkzMw==", "url": "https://github.com/apache/hive/pull/1758#discussion_r539228933", "bodyText": "Nit: Would probably name it testEmptyList for consistency with the Serializer", "author": "pgaref", "createdAt": "2020-12-09T11:29:57Z", "path": "ql/src/test/org/apache/hadoop/hive/ql/io/arrow/TestSerializer.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hive.ql.io.arrow;\n+\n+import org.apache.hadoop.hive.conf.HiveConf;\n+import org.apache.hadoop.hive.serde2.typeinfo.TypeInfo;\n+import org.apache.hadoop.hive.serde2.typeinfo.TypeInfoUtils;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+\n+public class TestSerializer {\n+  @Test\n+  public void testEmptyArray() {", "originalCommit": "9c96e6cef845fa23049be2f4d635f7b9d6d73c83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMzNjE0NA==", "url": "https://github.com/apache/hive/pull/1758#discussion_r539336144", "bodyText": "The name was based on the Hive type,  but I think both makes sense so renamed \ud83d\ude04", "author": "pvary", "createdAt": "2020-12-09T14:09:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIyODkzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTM0Njg4Ng==", "url": "https://github.com/apache/hive/pull/1758#discussion_r539346886", "bodyText": "The name was based on the Hive type, but I think both makes sense so renamed \ud83d\ude04\n\nCant disagree with that :D", "author": "pgaref", "createdAt": "2020-12-09T14:22:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIyODkzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIzMjM0OQ==", "url": "https://github.com/apache/hive/pull/1758#discussion_r539232349", "bodyText": "Would it make sense to test nested types here as well? like list ?", "author": "pgaref", "createdAt": "2020-12-09T11:35:29Z", "path": "ql/src/test/org/apache/hadoop/hive/ql/io/arrow/TestSerializer.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hive.ql.io.arrow;\n+\n+import org.apache.hadoop.hive.conf.HiveConf;\n+import org.apache.hadoop.hive.serde2.typeinfo.TypeInfo;\n+import org.apache.hadoop.hive.serde2.typeinfo.TypeInfoUtils;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+\n+public class TestSerializer {\n+  @Test\n+  public void testEmptyArray() {\n+    List<TypeInfo> typeInfos = TypeInfoUtils.getTypeInfosFromTypeString(\"array<tinyint>\");\n+    List<String> fieldNames = Arrays.asList(new String[]{\"a\"});\n+    Serializer converter = new Serializer(new HiveConf(), \"attemptId\", typeInfos, fieldNames);\n+    ArrowWrapperWritable writable = converter.emptyBatch();\n+    Assert.assertEquals(\"Schema<a: List<$data$: Int(8, true)>>\",\n+        writable.getVectorSchemaRoot().getSchema().toString());\n+  }\n+\n+  @Test\n+  public void testEmptyStruct() {\n+    List<TypeInfo> typeInfos = TypeInfoUtils.getTypeInfosFromTypeString(\"struct<b:int,c:string>\");\n+    List<String> fieldNames = Arrays.asList(new String[] { \"a\" });\n+    Serializer converter = new Serializer(new HiveConf(), \"attemptId\", typeInfos, fieldNames);\n+    ArrowWrapperWritable writable = converter.emptyBatch();\n+    Assert.assertEquals(\"Schema<a: Struct<b: Int(32, true), c: Utf8>>\",\n+        writable.getVectorSchemaRoot().getSchema().toString());\n+  }\n+\n+  @Test\n+  public void testEmptyMap() {\n+    List<TypeInfo> typeInfos = TypeInfoUtils.getTypeInfosFromTypeString(\"map<string,string>\");\n+    List<String> fieldNames = Arrays.asList(new String[] { \"a\" });\n+    Serializer converter = new Serializer(new HiveConf(), \"attemptId\", typeInfos, fieldNames);\n+    ArrowWrapperWritable writable = converter.emptyBatch();\n+    Assert.assertEquals(\"Schema<a: List<$data$: Struct<keys: Utf8, values: Utf8>>>\",\n+        writable.getVectorSchemaRoot().getSchema().toString());\n+  }\n+\n+  @Test\n+  public void testEmptyComplexStruct() {\n+    List<TypeInfo> typeInfos = TypeInfoUtils.getTypeInfosFromTypeString(\n+        \"struct<b:array<tinyint>,c:map<string,string>,d:struct<e:array<tinyint>,f:map<string,string>>>\");\n+    List<String> fieldNames = Arrays.asList(new String[] { \"a\" });\n+    Serializer converter = new Serializer(new HiveConf(), \"attemptId\", typeInfos, fieldNames);\n+    ArrowWrapperWritable writable = converter.emptyBatch();\n+    Assert.assertEquals(\n+        \"Schema<a: Struct<b: List<$data$: Int(8, true)>, c: List<$data$: Struct<keys: Utf8, values: Utf8>>, \" +\n+            \"d: Struct<e: List<$data$: Int(8, true)>, f: List<$data$: Struct<keys: Utf8, values: Utf8>>>>>\",\n+        writable.getVectorSchemaRoot().getSchema().toString());\n+  }", "originalCommit": "9c96e6cef845fa23049be2f4d635f7b9d6d73c83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMzNjY5OQ==", "url": "https://github.com/apache/hive/pull/1758#discussion_r539336699", "bodyText": "Addes some more tests to cover every nested type at least once", "author": "pvary", "createdAt": "2020-12-09T14:10:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIzMjM0OQ=="}], "type": "inlineReview"}, {"oid": "0eb926970a3f53efd54465a2ad50f7616af1e2e1", "url": "https://github.com/apache/hive/commit/0eb926970a3f53efd54465a2ad50f7616af1e2e1", "message": "Addressed review comments", "committedDate": "2020-12-09T14:08:25Z", "type": "commit"}]}