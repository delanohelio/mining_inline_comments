{"pr_number": 1186, "pr_title": "HIVE-23768: Metastore's update service wrongly strips partition column stats from the cache", "pr_createdAt": "2020-06-27T00:01:11Z", "pr_url": "https://github.com/apache/hive/pull/1186", "timeline": [{"oid": "e38cfc5905246a06a6eb89bf015dec54ff44e4dd", "url": "https://github.com/apache/hive/commit/e38cfc5905246a06a6eb89bf015dec54ff44e4dd", "message": "HIVE-23768: Add unit test in TestCachedStore reproducing the missing partition column stats problem", "committedDate": "2020-06-26T23:59:52Z", "type": "commit"}, {"oid": "03d26d95d1c17247d5a5ad6448bfe180c136655a", "url": "https://github.com/apache/hive/commit/03d26d95d1c17247d5a5ad6448bfe180c136655a", "message": "HIVE-23768: Remove partition update from updateTablePartitionColStats in CachedStore\n\nUsing alterPartitionInCache is problematic:\n1. It empties all relevant stats about partitions even those updated just now.\n2. It is not necessary since partitions were updated/refreshed just before calling the method updateTablePartitionColStats.", "committedDate": "2020-06-26T23:59:52Z", "type": "commit"}, {"oid": "8520356539ec6a84bbffa1e6a8dc260e4fa00da4", "url": "https://github.com/apache/hive/commit/8520356539ec6a84bbffa1e6a8dc260e4fa00da4", "message": "HIVE-23768: Remove table update from updateTableColStats in CachedStore\n\nSame as before alterTableInCache is not necessary since the table is refreshed.", "committedDate": "2020-06-26T23:59:52Z", "type": "commit"}, {"oid": "ff20976a0337007ae9ccefdea7fe498e83676eba", "url": "https://github.com/apache/hive/commit/ff20976a0337007ae9ccefdea7fe498e83676eba", "message": "HIVE-23768: Remove unused code in TestCachedStore", "committedDate": "2020-06-26T23:59:52Z", "type": "commit"}, {"oid": "6793c82da21901f42c877ceeb322672f1d9f1c97", "url": "https://github.com/apache/hive/commit/6793c82da21901f42c877ceeb322672f1d9f1c97", "message": "HIVE-23768: Refactor createTable method in TestCachedStore\n\n1. Inline a few variables.\n2. Use empty map instead of new hash map.\n3. Hardcode owner for all tables.", "committedDate": "2020-06-26T23:59:52Z", "type": "commit"}, {"oid": "ccfc6d94538d49d8bb56f5767ace5fc0132e322f", "url": "https://github.com/apache/hive/commit/ccfc6d94538d49d8bb56f5767ace5fc0132e322f", "message": "HIVE-23768: Add TODO in CachedStore#mergeColStatsForPartitions", "committedDate": "2020-06-26T23:59:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ2NTAxNA==", "url": "https://github.com/apache/hive/pull/1186#discussion_r447465014", "bodyText": "Sorry, I am bit confused looking at this diff. So, the original issue seems to be - \"Metastore's update service wrongly strips partition column stats from the cache in an attempt to update them.\" . How are we fixing this issue by not updating the stats in the cache ? Wouldn't the right fix for this is to to ensure sharedCache.alterTableInCache and sharedCache.alterPartitionInCache methods do the right thing and not incorrectly remove partition column stats ?", "author": "kishendas", "createdAt": "2020-06-30T07:22:00Z", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/cache/CachedStore.java", "diffHunk": "@@ -851,8 +851,6 @@ private void updateTableColStats(RawStore rawStore, String catName, String dbNam\n             sharedCache.refreshTableColStatsInCache(StringUtils.normalizeIdentifier(catName),\n                 StringUtils.normalizeIdentifier(dbName), StringUtils.normalizeIdentifier(tblName),\n                 tableColStats.getStatsObj());\n-            // Update the table to get consistent stats state.\n-            sharedCache.alterTableInCache(catName, dbName, tblName, table);", "originalCommit": "ccfc6d94538d49d8bb56f5767ace5fc0132e322f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU1MDEzMg==", "url": "https://github.com/apache/hive/pull/1186#discussion_r447550132", "bodyText": "If my understanding is correct the cache is already updated by the time we arrive here. Check my comment regarding alterPartitionsInCache and if something is not clear I can elaborate more.", "author": "zabetak", "createdAt": "2020-06-30T09:37:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ2NTAxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ2NTUyMg==", "url": "https://github.com/apache/hive/pull/1186#discussion_r447465522", "bodyText": "Same concern here as previous. How do we fix this issue by not updating the cache at all ?", "author": "kishendas", "createdAt": "2020-06-30T07:22:50Z", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/cache/CachedStore.java", "diffHunk": "@@ -900,13 +898,6 @@ private void updateTablePartitionColStats(RawStore rawStore, String catName, Str\n               rawStore.getPartitionColumnStatistics(catName, dbName, tblName, partNames, colNames, CacheUtils.HIVE_ENGINE);\n           Deadline.stopTimer();\n           sharedCache.refreshPartitionColStatsInCache(catName, dbName, tblName, partitionColStats);\n-          Deadline.startTimer(\"getPartitionsByNames\");\n-          List<Partition> parts = rawStore.getPartitionsByNames(catName, dbName, tblName, partNames);\n-          Deadline.stopTimer();\n-          // Also save partitions for consistency as they have the stats state.\n-          for (Partition part : parts) {\n-            sharedCache.alterPartitionInCache(catName, dbName, tblName, part.getValues(), part);", "originalCommit": "ccfc6d94538d49d8bb56f5767ace5fc0132e322f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU0Nzg2OQ==", "url": "https://github.com/apache/hive/pull/1186#discussion_r447547869", "bodyText": "The explanation is hidden in the commit message :)\nUsing alterPartitionInCache is problematic:\n\nIt empties all relevant stats about partitions even those updated just now.\nIt is not necessary since partitions were updated/refreshed just before calling the method updateTablePartitionColStats via updateTablePartitions.\nIt is not meant to be used for syncing the cache but rather handle updates in partitions.", "author": "zabetak", "createdAt": "2020-06-30T09:33:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ2NTUyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg5MjMyNA==", "url": "https://github.com/apache/hive/pull/1186#discussion_r447892324", "bodyText": "Ok, thanks for the explanation. Would you need below lines, since you no longer use List [Partition]  ?\n      Deadline.startTimer(\"getPartitionsByNames\");\n      List<Partition> parts = rawStore.getPartitionsByNames(catName, dbName, tblName, partNames);", "author": "kishendas", "createdAt": "2020-06-30T18:25:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ2NTUyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk4MzE0NA==", "url": "https://github.com/apache/hive/pull/1186#discussion_r447983144", "bodyText": "They are already removed aren't they? Maybe, I didn't understand what you mean.", "author": "zabetak", "createdAt": "2020-06-30T21:14:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ2NTUyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk4NDEwNg==", "url": "https://github.com/apache/hive/pull/1186#discussion_r447984106", "bodyText": "Ok, in review mode, only last two lines appear. I can see that they are removed in \"Files changed\" tab.", "author": "kishendas", "createdAt": "2020-06-30T21:16:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ2NTUyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk4NTUwNA==", "url": "https://github.com/apache/hive/pull/1186#discussion_r447985504", "bodyText": "Indeed some times its confusing :)", "author": "zabetak", "createdAt": "2020-06-30T21:19:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ2NTUyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ2NTg0Nw==", "url": "https://github.com/apache/hive/pull/1186#discussion_r447465847", "bodyText": "Please create a JIRA for this TODO and add a reference in the comment.", "author": "kishendas", "createdAt": "2020-06-30T07:23:25Z", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/cache/CachedStore.java", "diffHunk": "@@ -2264,6 +2255,8 @@ private MergedColumnStatsForPartitions mergeColStatsForPartitions(String catName\n       if (colStatsMap.size() < 1) {\n         LOG.debug(\"No stats data found for: dbName={} tblName= {} partNames= {} colNames= \", dbName, tblName, partNames,\n             colNames);\n+        // TODO: If we don't find any stats then most likely we should return null. Returning an empty object will not\n+        // trigger the lookup in the raw store and we will end up with missing stats.", "originalCommit": "ccfc6d94538d49d8bb56f5767ace5fc0132e322f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk4NDM1MA==", "url": "https://github.com/apache/hive/pull/1186#discussion_r447984350", "bodyText": "Did you create a JIRA for this ?", "author": "kishendas", "createdAt": "2020-06-30T21:16:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ2NTg0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk4NTI0MA==", "url": "https://github.com/apache/hive/pull/1186#discussion_r447985240", "bodyText": "Yeap, check https://issues.apache.org/jira/browse/HIVE-23781. I was planning to push a new commit now to update the comment.", "author": "zabetak", "createdAt": "2020-06-30T21:18:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ2NTg0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk4NTQzOQ==", "url": "https://github.com/apache/hive/pull/1186#discussion_r447985439", "bodyText": "Why is this change required ? I think in the test case, it's preferable to explicitly add drop statements , so that we know what's going on.", "author": "kishendas", "createdAt": "2020-06-30T21:19:15Z", "path": "standalone-metastore/metastore-server/src/test/java/org/apache/hadoop/hive/metastore/cache/TestCachedStore.java", "diffHunk": "@@ -136,17 +129,19 @@\n     MetaStoreTestUtils.setConfForStandloneMode(conf);\n     ObjectStore objectStore = new ObjectStore();\n     objectStore.setConf(conf);\n-    objectStore.dropTable(DEFAULT_CATALOG_NAME, db1Utbl1.getDbName(), db1Utbl1.getTableName());\n-    Deadline.startTimer(\"\");\n-    objectStore.dropPartitions(DEFAULT_CATALOG_NAME, db1Ptbl1.getDbName(), db1Ptbl1.getTableName(), db1Ptbl1PtnNames);\n-    objectStore.dropTable(DEFAULT_CATALOG_NAME, db1Ptbl1.getDbName(), db1Ptbl1.getTableName());\n-    objectStore.dropTable(DEFAULT_CATALOG_NAME, db2Utbl1.getDbName(), db2Utbl1.getTableName());\n-    Deadline.startTimer(\"\");\n-    objectStore.dropPartitions(DEFAULT_CATALOG_NAME, db2Ptbl1.getDbName(), db2Ptbl1.getTableName(), db2Ptbl1PtnNames);\n-    objectStore.dropTable(DEFAULT_CATALOG_NAME, db2Ptbl1.getDbName(), db2Ptbl1.getTableName());\n-    objectStore.dropDatabase(DEFAULT_CATALOG_NAME, db1.getName());\n-    objectStore.dropDatabase(DEFAULT_CATALOG_NAME, db2.getName());\n+    for (String clg : objectStore.getCatalogs()) {", "originalCommit": "ccfc6d94538d49d8bb56f5767ace5fc0132e322f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk5OTExOA==", "url": "https://github.com/apache/hive/pull/1186#discussion_r447999118", "bodyText": "The setUp method adds things in the Metastore that are not necessarily needed by every test and this was the case even before my changes. In the new test, I added some more tables/columns cause I think it made things easier to understand at least for me. If I was to follow the current pattern I would have to add the tables, cols, partitions, etc., in the setUp method and then drop them in the teardown method but then they would be visible to all other tests as well.\nI like the philosophy where unit tests are minimal (least possible state) thus I would prefer if every test starts with a clean Metastore and ends with a clean Metastore. I didn't change the setUp in order not to introduce too many unrelated changes but I made one step forward in the teardown.\nIf every test in this class was using the same state then I would definitely agree that the setUp and teardown methods should be the way they are right now.", "author": "zabetak", "createdAt": "2020-06-30T21:49:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk4NTQzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAyMzA4NQ==", "url": "https://github.com/apache/hive/pull/1186#discussion_r448023085", "bodyText": "Sounds good.", "author": "kishendas", "createdAt": "2020-06-30T22:53:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk4NTQzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk4NzExNw==", "url": "https://github.com/apache/hive/pull/1186#discussion_r447987117", "bodyText": "Why is this test case being removed ?", "author": "kishendas", "createdAt": "2020-06-30T21:22:49Z", "path": "standalone-metastore/metastore-server/src/test/java/org/apache/hadoop/hive/metastore/cache/TestCachedStore.java", "diffHunk": "@@ -1566,160 +1643,6 @@ private Table createUnpartitionedTableObject(Database db) {\n     return tbl;\n   }\n \n-  private TableAndColStats createUnpartitionedTableObjectWithColStats(Database db) {", "originalCommit": "ccfc6d94538d49d8bb56f5767ace5fc0132e322f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk5OTYzNA==", "url": "https://github.com/apache/hive/pull/1186#discussion_r447999634", "bodyText": "This is not a test case it is just a private unused method.", "author": "zabetak", "createdAt": "2020-06-30T21:50:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk4NzExNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAyMzA1Ng==", "url": "https://github.com/apache/hive/pull/1186#discussion_r448023056", "bodyText": "Ok, thanks for the cleanup.", "author": "kishendas", "createdAt": "2020-06-30T22:53:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk4NzExNw=="}], "type": "inlineReview"}]}