{"pr_number": 1704, "pr_title": "HIVE-24424: Use PreparedStatements in DbNotificationListener getNextNLId", "pr_createdAt": "2020-11-24T18:41:50Z", "pr_url": "https://github.com/apache/hive/pull/1704", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk1MTc1Mg==", "url": "https://github.com/apache/hive/pull/1704#discussion_r530951752", "bodyText": "These two are constants, please extract them.", "author": "miklosgergely", "createdAt": "2020-11-26T11:08:43Z", "path": "hcatalog/server-extensions/src/main/java/org/apache/hive/hcatalog/listener/DbNotificationListener.java", "diffHunk": "@@ -970,28 +971,44 @@ private static void close(ResultSet rs) {\n     }\n   }\n \n-  private long getNextNLId(Statement stmt, SQLGenerator sqlGenerator, String sequence)\n+  /**\n+   * Get the next notification log ID.\n+   *\n+   * @return The next ID to use for a notification log message\n+   * @throws SQLException if a database access error occurs or this method is\n+   *           called on a closed connection\n+   * @throws MetaException if the sequence table is not properly initialized\n+   */\n+  private long getNextNLId(Connection con, SQLGenerator sqlGenerator, String sequence)\n           throws SQLException, MetaException {\n-    String s = sqlGenerator.addForUpdateClause(\"select \\\"NEXT_VAL\\\" from \" +\n-            \"\\\"SEQUENCE_TABLE\\\" where \\\"SEQUENCE_NAME\\\" = \" + quoteString(sequence));\n-    LOG.debug(\"Going to execute query <\" + s + \">\");\n-    ResultSet rs = null;\n-    try {\n-      rs = stmt.executeQuery(s);\n-      if (!rs.next()) {\n-        throw new MetaException(\"Transaction database not properly configured, can't find next NL id.\");\n+    final String seq_sql = \"select \\\"NEXT_VAL\\\" from \\\"SEQUENCE_TABLE\\\" where \\\"SEQUENCE_NAME\\\" = ?\";", "originalCommit": "5d8eb8880fc37acba1223db33c897d67b9d61026", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM0OTI2Mw==", "url": "https://github.com/apache/hive/pull/1704#discussion_r531349263", "bodyText": "Fixed.  Thanks!", "author": "belugabehr", "createdAt": "2020-11-27T02:17:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk1MTc1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk1MjAyOQ==", "url": "https://github.com/apache/hive/pull/1704#discussion_r530952029", "bodyText": "Please use camelCase for variables within a function.", "author": "miklosgergely", "createdAt": "2020-11-26T11:09:13Z", "path": "hcatalog/server-extensions/src/main/java/org/apache/hive/hcatalog/listener/DbNotificationListener.java", "diffHunk": "@@ -970,28 +971,44 @@ private static void close(ResultSet rs) {\n     }\n   }\n \n-  private long getNextNLId(Statement stmt, SQLGenerator sqlGenerator, String sequence)\n+  /**\n+   * Get the next notification log ID.\n+   *\n+   * @return The next ID to use for a notification log message\n+   * @throws SQLException if a database access error occurs or this method is\n+   *           called on a closed connection\n+   * @throws MetaException if the sequence table is not properly initialized\n+   */\n+  private long getNextNLId(Connection con, SQLGenerator sqlGenerator, String sequence)\n           throws SQLException, MetaException {\n-    String s = sqlGenerator.addForUpdateClause(\"select \\\"NEXT_VAL\\\" from \" +\n-            \"\\\"SEQUENCE_TABLE\\\" where \\\"SEQUENCE_NAME\\\" = \" + quoteString(sequence));\n-    LOG.debug(\"Going to execute query <\" + s + \">\");\n-    ResultSet rs = null;\n-    try {\n-      rs = stmt.executeQuery(s);\n-      if (!rs.next()) {\n-        throw new MetaException(\"Transaction database not properly configured, can't find next NL id.\");\n+    final String seq_sql = \"select \\\"NEXT_VAL\\\" from \\\"SEQUENCE_TABLE\\\" where \\\"SEQUENCE_NAME\\\" = ?\";\n+    final String upd_sql = \"update \\\"SEQUENCE_TABLE\\\" set \\\"NEXT_VAL\\\" = ? where \\\"SEQUENCE_NAME\\\" = ?\";\n+\n+    final String sou_sql = sqlGenerator.addForUpdateClause(seq_sql);", "originalCommit": "5d8eb8880fc37acba1223db33c897d67b9d61026", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6a72369d6dea71eab6e6ee3f8c64164fdab39aea", "url": "https://github.com/apache/hive/commit/6a72369d6dea71eab6e6ee3f8c64164fdab39aea", "message": "Extract static values. Fix CamelCase. Enhance loggig.", "committedDate": "2020-11-27T00:10:23Z", "type": "forcePushed"}, {"oid": "535fa46cadeeb59f4afff1096c8b3616601e91b4", "url": "https://github.com/apache/hive/commit/535fa46cadeeb59f4afff1096c8b3616601e91b4", "message": "HIVE-24424: Use PreparedStatements in DbNotificationListener getNextNLId", "committedDate": "2020-11-30T14:43:49Z", "type": "commit"}, {"oid": "b7493861c67d8a1796cc85212ca44d4da26848d4", "url": "https://github.com/apache/hive/commit/b7493861c67d8a1796cc85212ca44d4da26848d4", "message": "Return the next log id, not next-next. Add JavaDocs", "committedDate": "2020-11-30T14:43:49Z", "type": "commit"}, {"oid": "93490035a3084dcbc2f77e147ac4c71d9d6d140b", "url": "https://github.com/apache/hive/commit/93490035a3084dcbc2f77e147ac4c71d9d6d140b", "message": "Extract static values. Fix CamelCase. Enhance loggig.", "committedDate": "2020-11-30T14:43:49Z", "type": "commit"}, {"oid": "93490035a3084dcbc2f77e147ac4c71d9d6d140b", "url": "https://github.com/apache/hive/commit/93490035a3084dcbc2f77e147ac4c71d9d6d140b", "message": "Extract static values. Fix CamelCase. Enhance loggig.", "committedDate": "2020-11-30T14:43:49Z", "type": "forcePushed"}]}