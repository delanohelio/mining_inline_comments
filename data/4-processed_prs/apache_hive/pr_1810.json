{"pr_number": 1810, "pr_title": "HIVE-24565: Implement standard trim function", "pr_createdAt": "2020-12-23T16:42:12Z", "pr_url": "https://github.com/apache/hive/pull/1810", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODMzNTM4Mg==", "url": "https://github.com/apache/hive/pull/1810#discussion_r548335382", "bodyText": "Since these two keywords are reserved, can you add a test to TestSQL11ReservedKeyWordsNegative.java?", "author": "jcamachor", "createdAt": "2020-12-24T00:54:41Z", "path": "parser/src/java/org/apache/hadoop/hive/ql/parse/HiveLexerParent.g", "diffHunk": "@@ -373,6 +373,8 @@ KW_COST: 'COST';\n KW_JOINCOST: 'JOINCOST';\n KW_WITHIN: 'WITHIN';\n KW_PKFK_JOIN: 'PKFK_JOIN';\n+KW_LEADING: 'LEADING';", "originalCommit": "d13a1a5fd2d1c91d7e26585500abe1366214c1d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI1MzY0OA==", "url": "https://github.com/apache/hive/pull/1810#discussion_r551253648", "bodyText": "do we need to fully reserve these keywords - if not they could be added to: IdentifiersParser.g/nonReserved", "author": "kgyrtkirk", "createdAt": "2021-01-04T11:10:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODMzNTM4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODMzNzU2MA==", "url": "https://github.com/apache/hive/pull/1810#discussion_r548337560", "bodyText": "I think this would match any function name, that then would be converted to trim (or any other variant) by the rules in trimFunction?\nI think one way of fixing this could be to declare TRIM as a keyword, and match directly on TRIM (TRIM is a reserved keyword in SQL standard) rather than functionName.\nCould you also add a negative test, i.e., a test where the trim construct is correct but the function name is different, and make sure it fails and it is not transformed by the parser?", "author": "jcamachor", "createdAt": "2020-12-24T01:05:36Z", "path": "parser/src/java/org/apache/hadoop/hive/ql/parse/IdentifiersParser.g", "diffHunk": "@@ -464,6 +473,7 @@ atomExpression\n     | whenExpression\n     | (subQueryExpression)=> (subQueryExpression)\n         -> ^(TOK_SUBQUERY_EXPR TOK_SUBQUERY_OP subQueryExpression)\n+    | (functionName LPAREN (leading=KW_LEADING | trailing=KW_TRAILING | KW_BOTH)? (trim_characters=selectExpression)? KW_FROM (str=selectExpression) RPAREN) => trimFunction", "originalCommit": "d13a1a5fd2d1c91d7e26585500abe1366214c1d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI1MzYwOA==", "url": "https://github.com/apache/hive/pull/1810#discussion_r551253608", "bodyText": "this is a syntetic predicate expression; narrowing it down furthere will help for sure ; but since trimFunction also matches the functionName LPAREN prefix I think it should be placed in the function rule", "author": "kgyrtkirk", "createdAt": "2021-01-04T11:10:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODMzNzU2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI1NzI2Nw==", "url": "https://github.com/apache/hive/pull/1810#discussion_r551257267", "bodyText": "could you also add somenull cases as well trim(null,'x') and trim('x',null)\nI know they will probably work okay; but its better to cover them", "author": "kgyrtkirk", "createdAt": "2021-01-04T11:18:15Z", "path": "ql/src/test/queries/clientpositive/udf_trim.q", "diffHunk": "@@ -1,2 +1,20 @@\n DESCRIBE FUNCTION trim;\n DESCRIBE FUNCTION EXTENDED trim;\n+\n+SELECT '\"' || trim('   tech   ') || '\"';\n+\n+SELECT '\"' || TRIM(' '  FROM  '   tech   ') || '\"';\n+\n+SELECT '\"' || TRIM(LEADING '0' FROM '000123') || '\"';\n+\n+SELECT '\"' || TRIM(TRAILING '1' FROM 'Tech1') || '\"';\n+\n+SELECT '\"' || TRIM(BOTH '1' FROM '123Tech111') || '\"';\n+\n+SELECT '\"' || ltrim('   tech   ') || '\"', '\"' || rtrim('   tech   ') || '\"';\n+\n+SELECT '\"' || lTRIM('0'  FROM  '000123') || '\"', '\"' || rTRIM('0'  FROM  '000123') || '\"';\n+\n+SELECT trim('000123', '0');", "originalCommit": "d13a1a5fd2d1c91d7e26585500abe1366214c1d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTc2MTYwMg==", "url": "https://github.com/apache/hive/pull/1810#discussion_r551761602", "bodyText": "null cannot be passed as a parameter to trim. It works in Postgres and Oracle but not supported in Hive.\nThe following was executed on master without this patch:\nselect trim(null);\n\n org.apache.hadoop.hive.ql.parse.SemanticException: Line 6:7 Wrong arguments 'TOK_NULL': trim takes only STRING/CHAR/VARCHAR types. Found VOID\n\nIMHO we can implement this in a follow-up patch.", "author": "kasakrisz", "createdAt": "2021-01-05T07:37:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI1NzI2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI1ODYzNQ==", "url": "https://github.com/apache/hive/pull/1810#discussion_r551258635", "bodyText": "there is also some vectorized implementations (see StringRTrim for example)\nthe functionality is enhanced a bit here - those other implementations should be updated as well (and possibly also covered with tests)", "author": "kgyrtkirk", "createdAt": "2021-01-04T11:21:17Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/udf/generic/GenericUDFBaseTrim.java", "diffHunk": "@@ -68,11 +82,24 @@ public Object evaluate(DeferredObject[] arguments) throws HiveException {\n     if (valObject == null) {\n       return null;\n     }\n-    String val = ((Text) converter.convert(valObject)).toString();\n+    String val = stringToTrimConverter.convert(valObject).toString();\n     if (val == null) {\n       return null;\n     }\n-    result.set(performOp(val.toString()));\n+\n+    String trimChars = \" \";", "originalCommit": "d13a1a5fd2d1c91d7e26585500abe1366214c1d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTk1ODEzNw==", "url": "https://github.com/apache/hive/pull/1810#discussion_r551958137", "bodyText": "I add supporting vectorized two parameter version of trim functions when the first parameter is a column the second is a literal. Example:\ncreate table t1 (col0 string);\nselect trim(col0, 'xy') from t1 group by col0;\n\nIn case of trim chars parameter is also column we fall back for non-vectorized version of trim. I guess this use case is not as common as the previous but it can be implemented in a follow-up patch.", "author": "kasakrisz", "createdAt": "2021-01-05T14:16:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI1ODYzNQ=="}], "type": "inlineReview"}, {"oid": "27a01dc7a0dcb7824f843c5694913e1b98466d87", "url": "https://github.com/apache/hive/commit/27a01dc7a0dcb7824f843c5694913e1b98466d87", "message": "negative test: when function call has trim like structure", "committedDate": "2021-01-04T15:09:30Z", "type": "forcePushed"}, {"oid": "2f8709b5b29ce0a8ef1af80a122036a26d9f026f", "url": "https://github.com/apache/hive/commit/2f8709b5b29ce0a8ef1af80a122036a26d9f026f", "message": "support vectorized ltrim,rtrim", "committedDate": "2021-01-05T14:09:59Z", "type": "forcePushed"}, {"oid": "2d534b39d35923dff3022b63dd5308148eebe1b4", "url": "https://github.com/apache/hive/commit/2d534b39d35923dff3022b63dd5308148eebe1b4", "message": "add parser rule", "committedDate": "2021-01-06T13:42:41Z", "type": "commit"}, {"oid": "464493fd866e8968e2648f6ea4aa21d72e86bcfa", "url": "https://github.com/apache/hive/commit/464493fd866e8968e2648f6ea4aa21d72e86bcfa", "message": "support l/r trim", "committedDate": "2021-01-06T13:42:41Z", "type": "commit"}, {"oid": "c2a5750804b231fb5eb756aeb33774c16ca06330", "url": "https://github.com/apache/hive/commit/c2a5750804b231fb5eb756aeb33774c16ca06330", "message": "modify UDF*Trim impl to accept second parameter", "committedDate": "2021-01-06T13:42:41Z", "type": "commit"}, {"oid": "23a20913f891c34e153f32513e76c89473377db7", "url": "https://github.com/apache/hive/commit/23a20913f891c34e153f32513e76c89473377db7", "message": "support one and two parameter versions", "committedDate": "2021-01-06T13:42:41Z", "type": "commit"}, {"oid": "d71b6b1e3bcbf6504ff05169812fed2b7a573307", "url": "https://github.com/apache/hive/commit/d71b6b1e3bcbf6504ff05169812fed2b7a573307", "message": "add negative test for keywords \"LEADING\", \"TRAILING\"", "committedDate": "2021-01-06T13:42:41Z", "type": "commit"}, {"oid": "5d840cb145d2c658c842d4eba79f2ee00ae2bdd8", "url": "https://github.com/apache/hive/commit/5d840cb145d2c658c842d4eba79f2ee00ae2bdd8", "message": "fix TestParseTrim.testParseTrimWithOneParameter assertion", "committedDate": "2021-01-06T13:42:41Z", "type": "commit"}, {"oid": "28b01f6f83a8f93421836c107ee5d832867c0507", "url": "https://github.com/apache/hive/commit/28b01f6f83a8f93421836c107ee5d832867c0507", "message": "rule match only trim function", "committedDate": "2021-01-06T13:42:41Z", "type": "commit"}, {"oid": "7b39754817e4cd6f25328fb24e5c85cc87e482fa", "url": "https://github.com/apache/hive/commit/7b39754817e4cd6f25328fb24e5c85cc87e482fa", "message": "negative test: when function call has trim like structure", "committedDate": "2021-01-06T13:42:41Z", "type": "commit"}, {"oid": "f58e8fb9aa27e5c5235bb8a3ffca76b6016e134c", "url": "https://github.com/apache/hive/commit/f58e8fb9aa27e5c5235bb8a3ffca76b6016e134c", "message": "update udf descriptions", "committedDate": "2021-01-06T13:42:41Z", "type": "commit"}, {"oid": "df90ad766a1ec79ae5a869b01744762150eef154", "url": "https://github.com/apache/hive/commit/df90ad766a1ec79ae5a869b01744762150eef154", "message": "support vectorized trim", "committedDate": "2021-01-06T13:42:41Z", "type": "commit"}, {"oid": "56d73836e4611f6ec85fa44a4cd5b23d30822215", "url": "https://github.com/apache/hive/commit/56d73836e4611f6ec85fa44a4cd5b23d30822215", "message": "test vectorized trim", "committedDate": "2021-01-06T13:42:41Z", "type": "commit"}, {"oid": "5abbc61014aafa42895e3cc7d93706b4ad9fca1e", "url": "https://github.com/apache/hive/commit/5abbc61014aafa42895e3cc7d93706b4ad9fca1e", "message": "support vectorized ltrim,rtrim", "committedDate": "2021-01-06T13:42:41Z", "type": "commit"}, {"oid": "3216efaf9281ebcaacaeb29a28df891dbf565171", "url": "https://github.com/apache/hive/commit/3216efaf9281ebcaacaeb29a28df891dbf565171", "message": "test using explain vectorization expression", "committedDate": "2021-01-06T13:42:41Z", "type": "commit"}, {"oid": "f6f59df880a7866499a42c870559a92a6e7032f5", "url": "https://github.com/apache/hive/commit/f6f59df880a7866499a42c870559a92a6e7032f5", "message": "update q tests out", "committedDate": "2021-01-06T13:42:41Z", "type": "commit"}, {"oid": "62a1484a8fb3ad0bbfe7bf239297880b21197451", "url": "https://github.com/apache/hive/commit/62a1484a8fb3ad0bbfe7bf239297880b21197451", "message": "update UT", "committedDate": "2021-01-06T13:42:41Z", "type": "commit"}, {"oid": "3a86ca4b7b51a73b573db831fbc53c6f4947e447", "url": "https://github.com/apache/hive/commit/3a86ca4b7b51a73b573db831fbc53c6f4947e447", "message": "update q test out", "committedDate": "2021-01-06T13:52:20Z", "type": "commit"}, {"oid": "3a86ca4b7b51a73b573db831fbc53c6f4947e447", "url": "https://github.com/apache/hive/commit/3a86ca4b7b51a73b573db831fbc53c6f4947e447", "message": "update q test out", "committedDate": "2021-01-06T13:52:20Z", "type": "forcePushed"}]}