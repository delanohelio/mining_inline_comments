{"pr_number": 1714, "pr_title": "HIVE-23965: Improve plan regression tests using TPCDS30TB metastore dump and custom configs", "pr_createdAt": "2020-11-26T22:19:02Z", "pr_url": "https://github.com/apache/hive/pull/1714", "timeline": [{"oid": "05676167374d2e2e19a360eacf1edf34e0f36527", "url": "https://github.com/apache/hive/commit/05676167374d2e2e19a360eacf1edf34e0f36527", "message": "HIVE-23965: Improve plan regression tests using TPCDS30TB metastore dump and custom configs (Stamatis Zampetakis, reviewed by Zoltan Haindrich)\n\n1. Add new perf driver, TestTezTPCDS30TBCliDriver, relying on a dockerized metastore.\n2. Use Dockerized postgres metastore with TPC-DS 30TB dump\n3. Remove old drivers (with and without constraints), related classes\n(e.g., MetastoreDumpUtility), and resources.\n\nAfter discussion in the JIRA we decided that keeping the old drivers\nis most likely useless.\n\n4. Use Hive config properties obtained and curated from real-life usages\n5. Allow AbstractCliConfig to override metastore DB type\n6. Rework CorePerfCliDriver to allow pre-initialized metastores\n\nRemove system property settings in the initialization of the driver and\nleave in the configuration to set it up if needed. This is necessary to\nbe able to use the driver with a preinitialised metastore.\n\nRemove redundant logs in System.err. Logging and throwing an exception\nis an anti-pattern.\n\nReplace assertions with exceptions and improve the messages.\n\n7. Upgrade postgres JDBC driver to version 42.2.14 to be compatible\nwith the docker image used\n8. Update path to new postgres version in TestBeelineArgParsing\n9. Display plans using hive.explain.user set to false which seems\nto be preferrable for performing a diff and checking regressions\n\n10. Disable queries 14 (HIVE-24167), 30 (HIVE-23964)\n11. Re-enable CBO plan tests for queries 44, 45, 67, 70, 86\n\nThe queries were disabled as part of HIVE-20718. They were supposed to\nbe fixed in Calcite 1.18.0 and currently Hive is in 1.21.0 so it is not\nsurprising that they pass.\n\n12. Add missing queries: cbo_query41, cbo_query62, query62\n\nCloses apache/hive#1347", "committedDate": "2020-11-25T16:07:31Z", "type": "commit"}, {"oid": "df6e610c7f7b11b0bf06b500b25613c1a811c055", "url": "https://github.com/apache/hive/commit/df6e610c7f7b11b0bf06b500b25613c1a811c055", "message": "HIVE-23965: Support metastore schema upgrades without image rebuilds\n\nIncorporate the logic for upgrading the dockerized metastore inside\nPostgresTPCDS rule to avoid the need for rebuilding the respective\nDocker image every time there is change in the metastore schema on\nmaster.\n\nBump the image version to 1.2 providing a metastore schema at version\n3.1.3000 (and not an already partially upgraded 4.0.0 as before).", "committedDate": "2020-11-26T22:10:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI1ODc1NA==", "url": "https://github.com/apache/hive/pull/1714#discussion_r535258754", "bodyText": "@zabetak qq: will this file be maintained  from now on parallel with upgrade-3.2.0-to-4.0.0.postgres.sql ? Is this needed for upstream?", "author": "pvargacl", "createdAt": "2020-12-03T14:12:33Z", "path": "standalone-metastore/metastore-server/src/test/resources/sql/postgres/upgrade-3.1.3000-to-4.0.0.postgres.sql", "diffHunk": "@@ -0,0 +1,77 @@\n+-- The file has some overlapping with upgrade-3.2.0-to-4.0.0.postgres.sql\n+SELECT 'Upgrading MetaStore schema from 3.1.3000 to 4.0.0';", "originalCommit": "df6e610c7f7b11b0bf06b500b25613c1a811c055", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI2NDI4Nw==", "url": "https://github.com/apache/hive/pull/1714#discussion_r535264287", "bodyText": "Yes, that's the idea for now; I couldn't think of a better alternative at the moment.", "author": "zabetak", "createdAt": "2020-12-03T14:19:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI1ODc1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI2ODc0MQ==", "url": "https://github.com/apache/hive/pull/1714#discussion_r535268741", "bodyText": "How big is the differences between 3.2.0 and 3.1.3000? Is it not possible to manually apply changes to the schema to be 3.2.0 in the image and then use 3.2.0 -> 4.0.0 update path?", "author": "pvargacl", "createdAt": "2020-12-03T14:25:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI1ODc1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI3NjQ4MQ==", "url": "https://github.com/apache/hive/pull/1714#discussion_r535276481", "bodyText": "Sure we can try do this but given that it might take some time I would rather leave it as a follow up. WDYT?", "author": "zabetak", "createdAt": "2020-12-03T14:33:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI1ODc1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI4MTEwNA==", "url": "https://github.com/apache/hive/pull/1714#discussion_r535281104", "bodyText": "You go with this, but I think we would need the follow up soon, this two upgrade path will cause some confusions :)", "author": "pvargacl", "createdAt": "2020-12-03T14:36:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI1ODc1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTMyMjE1Mg==", "url": "https://github.com/apache/hive/pull/1714#discussion_r535322152", "bodyText": "I created HIVE-24480 for that purpose.", "author": "zabetak", "createdAt": "2020-12-03T15:18:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI1ODc1NA=="}], "type": "inlineReview"}]}