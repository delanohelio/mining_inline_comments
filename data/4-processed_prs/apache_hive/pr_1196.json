{"pr_number": 1196, "pr_title": "HIVE-23791: Optimize ACID stats generation", "pr_createdAt": "2020-07-01T12:12:25Z", "pr_url": "https://github.com/apache/hive/pull/1196", "timeline": [{"oid": "85c5a8261e6866be17a382e3d2634764029dbd81", "url": "https://github.com/apache/hive/commit/85c5a8261e6866be17a382e3d2634764029dbd81", "message": "HIVE-23791: Optimize ACID stats generation", "committedDate": "2020-07-01T12:10:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ3NDg1OQ==", "url": "https://github.com/apache/hive/pull/1196#discussion_r448474859", "bodyText": "There is a slight problem here, if we are on hdfs and the file listing with id is supported. Few lines below there is a check for dirsnapshot == null, that was running every time for this case, but now it won't run if you call getacidstate with nonnull dirsnapshot", "author": "pvargacl", "createdAt": "2020-07-01T16:18:49Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/io/AcidUtils.java", "diffHunk": "@@ -1305,7 +1322,9 @@ public static Directory getAcidState(FileSystem fileSystem, Path candidateDirect\n             bestBase, ignoreEmptyFiles, abortedDirectories, fs, validTxnList);\n       }\n     } else {\n-      dirSnapshots = getHdfsDirSnapshots(fs, candidateDirectory);\n+      if (dirSnapshots == null) {", "originalCommit": "85c5a8261e6866be17a382e3d2634764029dbd81", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ4MjA1Nw==", "url": "https://github.com/apache/hive/pull/1196#discussion_r448482057", "bodyText": "this might be out-of-scope for this change: but this static method in AcidUtils is trying to do all the work upfront...\nwhich might lead to:\n\nthat it does work which is not even needed\nit doesn't scan some location - and the map just returns null ; so it might be not noticable\n\nI think it would be better if this method would return a something (it could still be a map) which could fill in stuff from hdfs if its not cached already...", "author": "kgyrtkirk", "createdAt": "2020-07-01T16:30:55Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/io/AcidUtils.java", "diffHunk": "@@ -2614,28 +2633,25 @@ public static Path getVersionFilePath(Path deltaOrBase) {\n           + \" from \" + jc.get(ValidTxnWriteIdList.VALID_TABLES_WRITEIDS_KEY));\n       return null;\n     }\n-    Directory acidInfo = AcidUtils.getAcidState(fs, dir, jc, idList, null, false);\n+    if (fs == null) {\n+      fs = dir.getFileSystem(jc);\n+    }\n+    // Collect the all of the files/dirs\n+    Map<Path, HdfsDirSnapshot> hdfsDirSnapshots = AcidUtils.getHdfsDirSnapshots(fs, dir);", "originalCommit": "85c5a8261e6866be17a382e3d2634764029dbd81", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyNzI3NA==", "url": "https://github.com/apache/hive/pull/1196#discussion_r448527274", "bodyText": "Ohh.. I think I get it now.\n\nYou are right that this will do stuff which is not really needed in this case - namely creating objects which are not needed at here (dirSnapshot.metaDataFile/dirSnapshot.acidFormatFile), also we might list and create objects which are not needed in this snapshot. On the other hand the costly part on S3 (and on HDFS as well) is the number of remote calls, which is reduced to a single listing instead of doing the listing for every directory 1-by-1.\nIt is not possible that it does not scan some location which needed. If this happens then this is a bug in AcidUtils.getAcidState, as it has to return every directory which is readable\n\nWhat I do not understand in your comment is \"this method would return a something (it could still be a map) which could fill in stuff from hdfs if its not cached already\" - the main thing we would like to avoid here is the need of reading the HDFS again and again. The only way to realize that something is missing is reading the directory again... or I miss something :)", "author": "pvary", "createdAt": "2020-07-01T17:56:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ4MjA1Nw=="}], "type": "inlineReview"}, {"oid": "be5818d66c59d3010e176a2fa8255233ecd53c9d", "url": "https://github.com/apache/hive/commit/be5818d66c59d3010e176a2fa8255233ecd53c9d", "message": "Addressing Petya's comment", "committedDate": "2020-07-01T16:38:41Z", "type": "commit"}]}