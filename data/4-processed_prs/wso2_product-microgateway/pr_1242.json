{"pr_number": 1242, "pr_title": "Fix #1239 #802 : Provide endpoint proxy, pool, retry, circuit breaker configs", "pr_createdAt": "2020-05-20T15:24:26Z", "pr_url": "https://github.com/wso2/product-microgateway/pull/1242", "timeline": [{"oid": "461e80e71604df3cb50488c44aec3b876506e830", "url": "https://github.com/wso2/product-microgateway/commit/461e80e71604df3cb50488c44aec3b876506e830", "message": "Fix #1239 #802 : Provide endpoint proxy, pool, retry, circuit breaker configs", "committedDate": "2020-05-20T15:19:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY4MTI2MA==", "url": "https://github.com/wso2/product-microgateway/pull/1242#discussion_r428681260", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * This DTO holds the data related to endpoint retries in case of a failure scenario\n          \n          \n            \n             * This DTO holds the data related to endpoint retries in case of a failure scenario.", "author": "AmaliMatharaarachchi", "createdAt": "2020-05-21T14:19:43Z", "path": "components/micro-gateway-cli/src/main/java/org/wso2/apimgt/gateway/cli/model/mgwcodegen/EndpointRetryDTO.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.wso2.apimgt.gateway.cli.model.mgwcodegen;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * This DTO holds the data related to endpoint retries in case of a failure scenario", "originalCommit": "461e80e71604df3cb50488c44aec3b876506e830", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY4MjE2Ng==", "url": "https://github.com/wso2/product-microgateway/pull/1242#discussion_r428682166", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            {{>endpointProxy}}\n          \n          \n            \n            {{>endpointProxy}}", "author": "AmaliMatharaarachchi", "createdAt": "2020-05-21T14:21:08Z", "path": "components/micro-gateway-cli/src/main/resources/templates/advanceEndpoint.mustache", "diffHunk": "@@ -0,0 +1,6 @@\n+{{#advanceEndpointConfig}},\n+timeoutInMillis:{{advanceEndpointConfig.timeoutInMillis}} {{#advanceEndpointConfig}}{{>endpointRetry}}{{/advanceEndpointConfig}}\n+{{#advanceEndpointConfig}}{{>circuitBreaker}}{{/advanceEndpointConfig}}\n+{{/advanceEndpointConfig}}\n+{{>endpointPoolConfig}}\n+{{>endpointProxy}}", "originalCommit": "461e80e71604df3cb50488c44aec3b876506e830", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY4MjQ0NA==", "url": "https://github.com/wso2/product-microgateway/pull/1242#discussion_r428682444", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            {{/if}}\n          \n          \n            \n            {{/if}}", "author": "AmaliMatharaarachchi", "createdAt": "2020-05-21T14:21:34Z", "path": "components/micro-gateway-cli/src/main/resources/templates/circuitBreaker.mustache", "diffHunk": "@@ -0,0 +1,13 @@\n+{{#if circuitBreaker}},\n+circuitBreaker : {\n+    {{#if circuitBreaker.rollingWindow}}\n+    rollingWindow : {\n+    requestVolumeThreshold : {{circuitBreaker.rollingWindow.requestVolumeThreshold}},\n+    timeWindowInMillis : {{circuitBreaker.rollingWindow.timeWindowInMillis}},\n+    bucketSizeInMillis : {{circuitBreaker.rollingWindow.bucketSizeInMillis}}\n+    },{{/if}}\n+    failureThreshold : {{circuitBreaker.failureThreshold}},\n+    resetTimeInMillis : {{circuitBreaker.resetTimeInMillis}} {{#if circuitBreaker.statusCodes}},\n+    statusCodes : [ {{#circuitBreaker.statusCodes}} {{.}}{{#unless @last}},{{/unless}} {{/circuitBreaker.statusCodes}}]  {{/if}}\n+}\n+{{/if}}", "originalCommit": "461e80e71604df3cb50488c44aec3b876506e830", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY4MjY1NA==", "url": "https://github.com/wso2/product-microgateway/pull/1242#discussion_r428682654", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            httpVersion: gateway:getClientsHttpVersion()\n          \n          \n            \n            httpVersion: gateway:getClientsHttpVersion()", "author": "AmaliMatharaarachchi", "createdAt": "2020-05-21T14:21:54Z", "path": "components/micro-gateway-cli/src/main/resources/templates/clientsHttp2.mustache", "diffHunk": "@@ -0,0 +1,2 @@\n+\n+httpVersion: gateway:getClientsHttpVersion()", "originalCommit": "461e80e71604df3cb50488c44aec3b876506e830", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY4MjgxNQ==", "url": "https://github.com/wso2/product-microgateway/pull/1242#discussion_r428682815", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            }\n          \n          \n            \n            }", "author": "AmaliMatharaarachchi", "createdAt": "2020-05-21T14:22:11Z", "path": "components/micro-gateway-cli/src/main/resources/templates/endpointProxy.mustache", "diffHunk": "@@ -0,0 +1,3 @@\n+, http1Settings : {\n+    proxy: gateway:getClientProxyConfig()\n+}", "originalCommit": "461e80e71604df3cb50488c44aec3b876506e830", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY4MzAxMg==", "url": "https://github.com/wso2/product-microgateway/pull/1242#discussion_r428683012", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            {{/if}}\n          \n          \n            \n            {{/if}}", "author": "AmaliMatharaarachchi", "createdAt": "2020-05-21T14:22:28Z", "path": "components/micro-gateway-cli/src/main/resources/templates/endpointRetry.mustache", "diffHunk": "@@ -0,0 +1,9 @@\n+{{#if retryConfig}},\n+retryConfig : {\n+    count : {{retryConfig.count}},\n+    intervalInMillis : {{retryConfig.intervalInMillis}},\n+    backOffFactor : {{retryConfig.backOffFactor}},\n+    maxWaitIntervalInMillis : {{retryConfig.maxWaitIntervalInMillis}} {{#if retryConfig.statusCodes}},\n+    statusCodes : [ {{#retryConfig.statusCodes}} {{.}}{{#unless @last}},{{/unless}} {{/retryConfig.statusCodes}}]  {{/if}}\n+}\n+{{/if}}", "originalCommit": "461e80e71604df3cb50488c44aec3b876506e830", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY4MzE3MA==", "url": "https://github.com/wso2/product-microgateway/pull/1242#discussion_r428683170", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            });\n          \n          \n            \n            });", "author": "AmaliMatharaarachchi", "createdAt": "2020-05-21T14:22:41Z", "path": "components/micro-gateway-cli/src/main/resources/templates/failoverResourceEndpoint.mustache", "diffHunk": "@@ -3,5 +3,5 @@ targets: [\n {{#endpoints}}    {url: {{#if isEtcdEnabled}}gateway:etcdSetup(\"{{name}}_{{endpointUrlType}}_endpoint_{{@index}}\",\"{{name}}_{{endpointUrlType}}_{{@index}}_etcdKey\",\"{{{endpointUrl}}}\",\"{{etcdKey}}\"){{else}}gateway:retrieveConfig(\"{{name}}_{{endpointUrlType}}_endpoint_{{@index}}\", \"{{{endpointUrl}}}\") {{/if}} {{>secureSocket}} }\n  {{#unless @last}},\n {{/unless}}{{/endpoints}}\n-], {{>http2}}{{>caching}}{{>basicAuth}}\n+], {{>clientsHttp2}}{{>caching}}{{>basicAuth}}{{>advanceEndpoint}}\n });", "originalCommit": "461e80e71604df3cb50488c44aec3b876506e830", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY4MzQyMg==", "url": "https://github.com/wso2/product-microgateway/pull/1242#discussion_r428683422", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            });\n          \n          \n            \n            });", "author": "AmaliMatharaarachchi", "createdAt": "2020-05-21T14:23:05Z", "path": "components/micro-gateway-cli/src/main/resources/templates/lbEndpoint.mustache", "diffHunk": "@@ -3,5 +3,5 @@ http:LoadBalanceClient {{qualifiedServiceName}}_{{endpointUrlType}} = new({\n {{#endpoints}}    {url: {{#if isEtcdEnabled}}gateway:etcdSetup(\"{{name}}_{{endpointUrlType}}_endpoint_{{@index}}\",\"{{name}}_{{endpointUrlType}}_{{@index}}_etcdKey\",\"{{{endpointUrl}}}\",\"{{etcdKey}}\"){{else}}gateway:retrieveConfig(\"{{name}}_{{endpointUrlType}}_endpoint_{{@index}}\", \"{{{endpointUrl}}}\"){{/if}} {{>secureSocket}} }{{#unless @last}},\n     {{/unless}}{{/endpoints}}\n     ],\n-    {{>http2}}{{>caching}}{{>basicAuth}}\n+    {{>clientsHttp2}}{{>caching}}{{>basicAuth}}{{>advanceEndpoint}}\n });", "originalCommit": "461e80e71604df3cb50488c44aec3b876506e830", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY4MzY2Mw==", "url": "https://github.com/wso2/product-microgateway/pull/1242#discussion_r428683663", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            });\n          \n          \n            \n            });", "author": "AmaliMatharaarachchi", "createdAt": "2020-05-21T14:23:31Z", "path": "components/micro-gateway-cli/src/main/resources/templates/lbResourceEndpoint.mustache", "diffHunk": "@@ -4,5 +4,5 @@ targets: [\n {{>secureSocket}} }{{#unless @last}},\n {{/unless}}{{/endpoints}}\n ],\n-{{>http2}}{{>caching}}{{>basicAuth}}\n+{{>clientsHttp2}}{{>caching}}{{>basicAuth}}{{>advanceEndpoint}}\n });", "originalCommit": "461e80e71604df3cb50488c44aec3b876506e830", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY4NDQ4OA==", "url": "https://github.com/wso2/product-microgateway/pull/1242#discussion_r428684488", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  type: failover\n          \n          \n            \n                  type: failover", "author": "AmaliMatharaarachchi", "createdAt": "2020-05-21T14:24:49Z", "path": "tests/src/test/resources/openAPIs/endpoints/advance_config.yaml", "diffHunk": "@@ -0,0 +1,74 @@\n+openapi: 3.0.0\n+info:\n+  version: 2.0.0\n+  title: AdvanceEndpoint\n+x-wso2-basePath: /advanceEp\n+x-wso2-production-endpoints: \"#/x-wso2-endpoints/timeout\"\n+paths:\n+  /timeout:\n+    get:\n+      operationId: timeout\n+      responses:\n+        \"200\":\n+          description: Successful\n+        \"405\":\n+          description: Invalid input\n+  /circuitBreaker:\n+    get:\n+      operationId: circuitBreaker\n+      x-wso2-production-endpoints:\n+        urls:\n+          - https://localhost:2380/v3\n+        advanceEndpointConfig:\n+          circuitBreaker:\n+            rollingWindow:\n+              requestVolumeThreshold: 1\n+              timeWindowInMillis: 60000\n+              bucketSizeInMillis: 2000\n+            failureThreshold: 0.2\n+            resetTimeInMillis: 5000\n+            statusCodes:\n+              - 500\n+      responses:\n+        \"200\":\n+          description: successful operation\n+        \"400\":\n+          description: Invalid status value\n+  /retry:\n+    get:\n+      operationId: retry\n+      x-wso2-production-endpoints:\n+        urls:\n+          - https://localhost:2380/v3\n+        advanceEndpointConfig:\n+          timeoutInMillis: 7000\n+          retryConfig:\n+            count: 1\n+            intervalInMillis: 1000\n+            backOffFactor: 1.2\n+            statusCodes:\n+              - 504\n+      responses:\n+        \"200\":\n+          description: successful operation\n+        \"400\":\n+          description: Invalid tag value\n+      deprecated: true\n+x-wso2-endpoints:\n+  - timeout:\n+      urls:\n+        - https://localhost:2380/v3\n+      advanceEndpointConfig:\n+        timeoutInMillis: 3000\n+  - myEndpoint2:\n+      urls:\n+        - https://non.existant.host:2380/v1\n+  - myEndpoint3:\n+      urls:\n+        - https://non.existant.host:2380/v1\n+        - https://non.existant.host:2380/v2\n+  - myEndpoint4:\n+      urls:\n+        - https://non.existant.host:2380/v1\n+        - https://non.existant.host:2380/v2\n+      type: failover", "originalCommit": "461e80e71604df3cb50488c44aec3b876506e830", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc1NTEzOA==", "url": "https://github.com/wso2/product-microgateway/pull/1242#discussion_r429755138", "bodyText": "Set the retryDone false", "author": "Rajith90", "createdAt": "2020-05-25T06:38:06Z", "path": "tests/src/test/java/org/wso2/micro/gateway/tests/common/MockBackEndServer.java", "diffHunk": "@@ -326,6 +327,54 @@ public void configure(HttpsParameters params) {\n                 exchange.getResponseBody().write(response);\n                 exchange.close();\n             });\n+            httpServer.createContext(contextV3 + \"/timeout\", exchange -> {\n+                try {\n+                    Thread.sleep(5000);\n+                } catch (InterruptedException e) {\n+                    log.error(\"Error while invoking timeout back end\", e);\n+                }\n+                byte[] response = ResponseConstants.responseBodyV1.getBytes();\n+                exchange.getResponseHeaders().set(HttpHeaderNames.CONTENT_TYPE.toString(),\n+                        TokenManagementConstants.CONTENT_TYPE_APPLICATION_JSON);\n+                exchange.sendResponseHeaders(HttpURLConnection.HTTP_OK, response.length);\n+                exchange.getResponseBody().write(response);\n+                exchange.close();\n+            });\n+            httpServer.createContext(contextV3 + \"/retry\", exchange -> {\n+                if (!retryDone) {\n+                    byte[] response = ResponseConstants.responseBodyV1.getBytes();\n+                    exchange.getResponseHeaders().set(HttpHeaderNames.CONTENT_TYPE.toString(),\n+                            TokenManagementConstants.CONTENT_TYPE_APPLICATION_JSON);\n+                    exchange.sendResponseHeaders(HttpURLConnection.HTTP_GATEWAY_TIMEOUT, 0);\n+                    exchange.getResponseBody().write(response);\n+                    exchange.close();\n+                    retryDone = true;\n+                }\n+                byte[] response = ResponseConstants.responseBodyV1.getBytes();\n+                exchange.getResponseHeaders().set(HttpHeaderNames.CONTENT_TYPE.toString(),\n+                        TokenManagementConstants.CONTENT_TYPE_APPLICATION_JSON);\n+                exchange.sendResponseHeaders(HttpURLConnection.HTTP_OK, response.length);\n+                exchange.getResponseBody().write(response);\n+                exchange.close();", "originalCommit": "461e80e71604df3cb50488c44aec3b876506e830", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc1NTMxOQ==", "url": "https://github.com/wso2/product-microgateway/pull/1242#discussion_r429755319", "bodyText": "Describe these paramaters", "author": "Rajith90", "createdAt": "2020-05-25T06:38:46Z", "path": "distribution/resources/conf/default-micro-gw.conf.template", "diffHunk": "@@ -191,14 +191,36 @@\n   enableRequestValidation = false\n   enableResponseValidation = false\n \n-# Enable http2\n+# Enable http2 for the microgateway listeners.\n [http2]\n   enable = true\n \n-# HTTP client configuration\n+# HTTP client configuration. These are used when gateway connects with the upstream backend endpoints\n [httpClients]\n   # Hostname verification\n   verifyHostname=true\n+  # Skip validating certificates when ssl is used\n+  disableSslVerification = false\n+  # Enable http2 when connecting with upstream backend endpoints.\n+  enableHttp2 = true\n+  #Proxy configurations required when microgateway connects to an upstream back end via a corporate proxy.\n+  [httpClients.proxy]\n+    enable = false\n+    enableInternalServices = false", "originalCommit": "461e80e71604df3cb50488c44aec3b876506e830", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "937403a1a3e6d91fe87aa52ff5c6610ae2ad6dfa", "url": "https://github.com/wso2/product-microgateway/commit/937403a1a3e6d91fe87aa52ff5c6610ae2ad6dfa", "message": "Fix review suggestions", "committedDate": "2020-05-26T11:14:57Z", "type": "commit"}]}