{"pr_number": 1180, "pr_title": "Improvement to support multiple token issuers with Claim Mappings #1179", "pr_createdAt": "2020-04-01T10:12:07Z", "pr_url": "https://github.com/wso2/product-microgateway/pull/1180", "timeline": [{"oid": "9b1b5cfc8913074d31d946a8f4f6423f8f26e8ea", "url": "https://github.com/wso2/product-microgateway/commit/9b1b5cfc8913074d31d946a8f4f6423f8f26e8ea", "message": "Add new feature for mapping JWT transformation", "committedDate": "2020-04-01T06:47:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTU1MjAyOQ==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r401552029", "bodyText": "Remove all unwanted new lines", "author": "praminda", "createdAt": "2020-04-01T11:42:44Z", "path": "components/micro-gateway-jwt-transformer/src/main/java/org/wso2/micro/gateway/jwttransformer/JWTTransformer.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ *  Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *  http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package org.wso2.micro.gateway.jwttransformer;\n+\n+\n+import org.ballerinalang.jvm.values.MapValue;\n+\n+/**\n+ * Defines the interface for writing the  jwt tranformation.\n+ */\n+public interface JWTTransformer {", "originalCommit": "c606e67a321b26094d797e20f9c0b589f5bea35b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTU1MjEyMA==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r401552120", "bodyText": "Suggested change", "author": "praminda", "createdAt": "2020-04-01T11:42:52Z", "path": "components/micro-gateway-jwt-transformer/src/main/java/org/wso2/micro/gateway/jwttransformer/DefaultJWTTransformer.java", "diffHunk": "@@ -0,0 +1,45 @@\n+// Copyright (c) 2020 WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+//\n+// WSO2 Inc. licenses this file to you under the Apache License,\n+// Version 2.0 (the \"License\"); you may not use this file except\n+// in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+// http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.wso2.micro.gateway.jwttransformer;\n+\n+import org.ballerinalang.jvm.values.ArrayValueImpl;\n+import org.ballerinalang.jvm.values.MapValue;\n+\n+/**\n+ * This file is for default Jwt transformer\n+ */\n+public class DefaultJWTTransformer implements JWTTransformer {\n+\n+    @Override\n+    public MapValue transformJWT(MapValue scopes) {\n+        String scope = \"\";\n+        MapValue scopesValue = scopes;\n+        int sizeOfScope = scopesValue.size();\n+        String name = scopesValue.get(\"scope\").getClass().getName();\n+        if (scopesValue.containsKey(\"scope\")) {\n+         if (scopesValue.get(\"scope\") instanceof ArrayValueImpl) {\n+             for (int i = 0; i < ((ArrayValueImpl) scopesValue.get(\"scope\")).size(); i++) {\n+                 scope +=  ((ArrayValueImpl) scopesValue.get(\"scope\")).getString(i) + \" \";\n+", "originalCommit": "c606e67a321b26094d797e20f9c0b589f5bea35b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTU1MjU3Mw==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r401552573", "bodyText": "Javadoc must have a . at the end of first sentence. This is a checked by checkstyles\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * This file is for default Jwt transformer\n          \n          \n            \n             * This file is for default Jwt transformer.", "author": "praminda", "createdAt": "2020-04-01T11:43:50Z", "path": "components/micro-gateway-jwt-transformer/src/main/java/org/wso2/micro/gateway/jwttransformer/DefaultJWTTransformer.java", "diffHunk": "@@ -0,0 +1,45 @@\n+// Copyright (c) 2020 WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+//\n+// WSO2 Inc. licenses this file to you under the Apache License,\n+// Version 2.0 (the \"License\"); you may not use this file except\n+// in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+// http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.wso2.micro.gateway.jwttransformer;\n+\n+import org.ballerinalang.jvm.values.ArrayValueImpl;\n+import org.ballerinalang.jvm.values.MapValue;\n+\n+/**\n+ * This file is for default Jwt transformer", "originalCommit": "c606e67a321b26094d797e20f9c0b589f5bea35b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTU1MjYzNw==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r401552637", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            </project>\n          \n          \n            \n            </project>", "author": "praminda", "createdAt": "2020-04-01T11:43:57Z", "path": "components/micro-gateway-jwt-transformer/pom.xml", "diffHunk": "@@ -0,0 +1,60 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <parent>\n+        <artifactId>components</artifactId>\n+        <groupId>org.wso2.am.microgw</groupId>\n+        <version>3.1.0-beta2-SNAPSHOT</version>\n+    </parent>\n+    <modelVersion>4.0.0</modelVersion>\n+\n+    <artifactId>mgw-jwt-transformer</artifactId>\n+    <dependencies>\n+        <dependency>\n+            <groupId>org.ballerinalang</groupId>\n+            <artifactId>ballerina-lang</artifactId>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.ballerinalang</groupId>\n+            <artifactId>ballerina-runtime</artifactId>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.ballerinalang</groupId>\n+            <artifactId>ballerina-http</artifactId>\n+            <version>${ballerina.platform.version}</version>\n+            <type>zip</type>\n+            <classifier>ballerina-binary-repo</classifier>\n+        </dependency>\n+        <dependency>\n+            <groupId>junit</groupId>\n+            <artifactId>junit</artifactId>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.slf4j</groupId>\n+            <artifactId>slf4j-api</artifactId>\n+            <version>${slf4j.version}</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.ballerinalang</groupId>\n+            <artifactId>ballerina-mime</artifactId>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.ballerinalang</groupId>\n+            <artifactId>ballerina-http</artifactId>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.ballerinalang</groupId>\n+            <artifactId>ballerina-io</artifactId>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.ballerinalang</groupId>\n+            <artifactId>ballerina-runtime-api</artifactId>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.json</groupId>\n+            <artifactId>json</artifactId>\n+        </dependency>\n+    </dependencies>\n+\n+</project>", "originalCommit": "c606e67a321b26094d797e20f9c0b589f5bea35b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTU1MjgwNQ==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r401552805", "bodyText": "Suggested change", "author": "praminda", "createdAt": "2020-04-01T11:44:16Z", "path": "components/micro-gateway-core/src/main/java/org/wso2/micro/gateway/core/mapping/MappingInvoker.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ *  Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *  http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package org.wso2.micro.gateway.core.mapping;\n+\n+import org.ballerinalang.jvm.values.MapValue;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.wso2.micro.gateway.jwttransformer.JWTTransformer;\n+\n+\n+/**\n+ * This class Class to dynamically invoke the transformer\n+ */\n+public class MappingInvoker {\n+\n+    private static final Logger log = LoggerFactory.getLogger(\"ballerina\");\n+    private  static JWTTransformer jwtTransformer;\n+\n+    public static String loadMappingClass(String className) {\n+        try {\n+", "originalCommit": "c606e67a321b26094d797e20f9c0b589f5bea35b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTU1MzExNg==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r401553116", "bodyText": "Try block is not formatted properly. Check indentation.", "author": "praminda", "createdAt": "2020-04-01T11:44:57Z", "path": "components/micro-gateway-core/src/main/java/org/wso2/micro/gateway/core/mapping/MappingInvoker.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ *  Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *  http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package org.wso2.micro.gateway.core.mapping;\n+\n+import org.ballerinalang.jvm.values.MapValue;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.wso2.micro.gateway.jwttransformer.JWTTransformer;\n+\n+\n+/**\n+ * This class Class to dynamically invoke the transformer\n+ */\n+public class MappingInvoker {\n+\n+    private static final Logger log = LoggerFactory.getLogger(\"ballerina\");\n+    private  static JWTTransformer jwtTransformer;\n+\n+    public static String loadMappingClass(String className) {\n+        try {", "originalCommit": "c606e67a321b26094d797e20f9c0b589f5bea35b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTU1MzE3MQ==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r401553171", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * This class Class to dynamically invoke the transformer\n          \n          \n            \n             * This class Class to dynamically invoke the transformer.", "author": "praminda", "createdAt": "2020-04-01T11:45:05Z", "path": "components/micro-gateway-core/src/main/java/org/wso2/micro/gateway/core/mapping/MappingInvoker.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ *  Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *  http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package org.wso2.micro.gateway.core.mapping;\n+\n+import org.ballerinalang.jvm.values.MapValue;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.wso2.micro.gateway.jwttransformer.JWTTransformer;\n+\n+\n+/**\n+ * This class Class to dynamically invoke the transformer", "originalCommit": "c606e67a321b26094d797e20f9c0b589f5bea35b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTU1MzMwMQ==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r401553301", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            // Copyright (c) 2019, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n          \n          \n            \n            // Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.", "author": "praminda", "createdAt": "2020-04-01T11:45:20Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/native/jwt_mapping.bal", "diffHunk": "@@ -0,0 +1,42 @@\n+// Copyright (c) 2019, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.", "originalCommit": "c606e67a321b26094d797e20f9c0b589f5bea35b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTYzMDE5Mw==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r401630193", "bodyText": "since you get the decoded payload here, shall we reuse it 74th line, without getting the token from the cache again.", "author": "AmaliMatharaarachchi", "createdAt": "2020-04-01T13:49:51Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/handler_providers/jwt_auth_provider.bal", "diffHunk": "@@ -53,14 +54,20 @@ public type JwtAuthProvider object {\n                 setErrorMessageToInvocationContext(API_AUTH_INVALID_CREDENTIALS);\n                 return handleVar;\n             }\n-\n             boolean isBlacklisted = false;\n             string? jti = \"\";\n             runtime:InvocationContext invocationContext = runtime:getInvocationContext();\n             runtime:AuthenticationContext? authContext = invocationContext?.authenticationContext;\n             if (authContext is runtime:AuthenticationContext) {\n                 string? jwtToken = authContext?.authToken;\n                 if (jwtToken is string) {\n+                    (jwt:JwtPayload | error) payload = getDecodedJWTPayload(jwtToken);", "originalCommit": "c606e67a321b26094d797e20f9c0b589f5bea35b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTYzMTc2Ng==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r401631766", "bodyText": "Why are we reading the jwt issuers again from config? Can we read custom claims in JWT handler creation time without reading the config again here?", "author": "AmaliMatharaarachchi", "createdAt": "2020-04-01T13:52:02Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/handler_providers/jwt_auth_provider.bal", "diffHunk": "@@ -141,3 +147,62 @@ public function validateSubscriptions(string jwtToken, jwt:JwtPayload payload, b\n     setErrorMessageToInvocationContext(API_AUTH_FORBIDDEN);\n     return prepareError(\"Failed to decode the JWT.\");\n }\n+\n+public function doMappingContext(runtime:InvocationContext invocationContext,jwt:JwtPayload payload) returns @tainted (auth:Error)? {\n+    string payloadissuer=payload[\"iss\"].toString();\n+    map<any>? customClaims = invocationContext[\"principal\"][\"claims\"];\n+    map<any>? invocationvalue = invocationContext;\n+    map<anydata>[] | error jwtIssuers = map<anydata>[].constructFrom(config:getAsArray(JWT_INSTANCE_ID));", "originalCommit": "c606e67a321b26094d797e20f9c0b589f5bea35b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "35f038e53744b3562b0b8e0e9c227b24fc823941", "url": "https://github.com/wso2/product-microgateway/commit/35f038e53744b3562b0b8e0e9c227b24fc823941", "message": "Resolve reviewd comments and read custom claims and class name in JWT handler creation", "committedDate": "2020-04-02T11:14:13Z", "type": "forcePushed"}, {"oid": "7b3c4c4d0a2df3ab288572f46c774f12e3973801", "url": "https://github.com/wso2/product-microgateway/commit/7b3c4c4d0a2df3ab288572f46c774f12e3973801", "message": "Resolve reviewd comments", "committedDate": "2020-04-15T10:19:22Z", "type": "commit"}, {"oid": "7b3c4c4d0a2df3ab288572f46c774f12e3973801", "url": "https://github.com/wso2/product-microgateway/commit/7b3c4c4d0a2df3ab288572f46c774f12e3973801", "message": "Resolve reviewd comments", "committedDate": "2020-04-15T10:19:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc5MTkxOQ==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r408791919", "bodyText": "Formatting error... 120 characters exceeded", "author": "menakaj", "createdAt": "2020-04-15T12:08:19Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/handler_providers/jwt_auth_provider.bal", "diffHunk": "@@ -17,31 +17,41 @@\n import ballerina/auth;\n import ballerina/jwt;\n import ballerina/runtime;\n-\n+import ballerina/stringutils;\n \n # Represents inbound JWT auth provider.\n #\n # + jwtValidatorConfig - JWT validator configurations\n # + inboundJwtAuthProvider - Reference to b7a inbound auth provider\n # + subscriptionValEnabled - Validate subscription\n+# + claims - JWT claim set\n+# + className - Transformation class Name\n+# + classLoaded - Class loaded or not\n+# + gatewayCache - the `APIGatewayCache instence`\n public type JwtAuthProvider object {\n     *auth:InboundAuthProvider;\n \n     public jwt:JwtValidatorConfig jwtValidatorConfig;\n     public jwt:InboundJwtAuthProvider inboundJwtAuthProvider;\n     public boolean subscriptionValEnabled;\n+    public map<anydata>[] | error claims;\n+    public string className;\n+    public boolean classLoaded;\n+    public APIGatewayCache gatewayCache = new;\n \n     # Provides authentication based on the provided JWT token.\n     #\n     # + jwtValidatorConfig - JWT validator configurations\n     # + subscriptionValEnabled - Validate subscription\n-    public function __init(jwt:JwtValidatorConfig jwtValidatorConfig, boolean subscriptionValEnabled) {\n+    public function __init(jwt:JwtValidatorConfig jwtValidatorConfig, boolean subscriptionValEnabled, map<anydata>[] | error claims, string className, boolean classLoaded) {", "originalCommit": "7b3c4c4d0a2df3ab288572f46c774f12e3973801", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc5MjE1Mw==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r408792153", "bodyText": "Formatting issue...", "author": "menakaj", "createdAt": "2020-04-15T12:08:44Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/handler_providers/jwt_auth_provider.bal", "diffHunk": "@@ -67,6 +76,25 @@ public type JwtAuthProvider object {\n                     var cachedJwt = trap <jwt:CachedJwt>jwtCache.get(jwtToken);\n                     //finishing span\n                     finishSpan(JWT_CACHE, spanIdCache);\n+                    var isJwtTokenCached = self.gatewayCache.retrieveClaimMappingCache(jwtToken);\n+                    if (isJwtTokenCached is boolean) {\n+                        printDebug(KEY_JWT_AUTH_PROVIDER, \"Moddified claims in the cache\");\n+                     }\n+                    else {\n+                        printDebug(KEY_JWT_AUTH_PROVIDER, \"Moddified claims is not in the cache\");\n+                        (jwt:JwtPayload | error) payloadBody = getDecodedJWTPayload(jwtToken);\n+                        if (payloadBody is jwt:JwtPayload) {\n+                            string payloadIssuer = payloadBody[\"iss\"].toString();\n+                            if( self.jwtValidatorConfig[\"issuer\"] ==  payloadIssuer){\n+                                var result = doMappingContext(invocationContext, self.className, self.claims, self.classLoaded);", "originalCommit": "7b3c4c4d0a2df3ab288572f46c774f12e3973801", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc5MjUzMA==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r408792530", "bodyText": "Formatting issue... exceeding 120 character limit", "author": "menakaj", "createdAt": "2020-04-15T12:09:26Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/handler_providers/jwt_auth_provider.bal", "diffHunk": "@@ -133,11 +161,61 @@ public function validateSubscriptions(string jwtToken, jwt:JwtPayload payload, b\n         if (subscriptionValidated || !subscriptionValEnabled || isGRPC) {\n             printDebug(KEY_JWT_AUTH_PROVIDER, \"Subscriptions validation passed.\");\n             return true;\n-        } else { \n+        } else {\n             setErrorMessageToInvocationContext(API_AUTH_FORBIDDEN);\n             return prepareError(\"Subscriptions validation failed.\");\n         }\n     }\n     setErrorMessageToInvocationContext(API_AUTH_FORBIDDEN);\n     return prepareError(\"Failed to decode the JWT.\");\n }\n+\n+public function doMappingContext(runtime:InvocationContext invocationContext, string className, map<anydata>[] | error claims, boolean classLoaded) returns @tainted (auth:Error)? {", "originalCommit": "7b3c4c4d0a2df3ab288572f46c774f12e3973801", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc5MzA2MQ==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r408793061", "bodyText": "Fix in other places as well", "author": "menakaj", "createdAt": "2020-04-15T12:10:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc5MjUzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc5MjY4NA==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r408792684", "bodyText": "Remove extra line", "author": "menakaj", "createdAt": "2020-04-15T12:09:44Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/handler_providers/jwt_auth_provider.bal", "diffHunk": "@@ -133,11 +161,61 @@ public function validateSubscriptions(string jwtToken, jwt:JwtPayload payload, b\n         if (subscriptionValidated || !subscriptionValEnabled || isGRPC) {\n             printDebug(KEY_JWT_AUTH_PROVIDER, \"Subscriptions validation passed.\");\n             return true;\n-        } else { \n+        } else {\n             setErrorMessageToInvocationContext(API_AUTH_FORBIDDEN);\n             return prepareError(\"Subscriptions validation failed.\");\n         }\n     }\n     setErrorMessageToInvocationContext(API_AUTH_FORBIDDEN);\n     return prepareError(\"Failed to decode the JWT.\");\n }\n+\n+public function doMappingContext(runtime:InvocationContext invocationContext, string className, map<anydata>[] | error claims, boolean classLoaded) returns @tainted (auth:Error)? {\n+    map<any>? customClaims = invocationContext[\"principal\"][\"claims\"];\n+    if (customClaims is map<any>) {\n+        if ( claims is map<anydata>[] && claims.length() > 0) {\n+            foreach map<anydata> claim in claims {\n+                string remoteClaim = claim[\"remoteClaim\"].toString();\n+                string localClaim = claim[\"localClaim\"].toString();\n+                if (customClaims is map<anydata>) {\n+                    if (customClaims.hasKey(remoteClaim) ) {\n+                        customClaims[localClaim] = customClaims[remoteClaim];\n+                        anydata removedElement = customClaims.remove(remoteClaim);\n+                    }\n+                 }\n+            }\n+        }\n+        if (className != \"\") {\n+            if(classLoaded){\n+                map<any>? customClaimsEdited = transformJWTValue(customClaims, className );\n+                if (customClaimsEdited is map<any>) {\n+                    customClaims = customClaimsEdited;\n+                }\n+             }\n+             else{\n+                return prepareError(\"Error while loading the jwttransformer class: \" + className);\n+             }\n+", "originalCommit": "7b3c4c4d0a2df3ab288572f46c774f12e3973801", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc5MzU3Ng==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r408793576", "bodyText": "Formatting issue... exceeding the character limit.", "author": "menakaj", "createdAt": "2020-04-15T12:11:19Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/utils/utils.bal", "diffHunk": "@@ -879,8 +880,18 @@ function readMultipleJWTIssuers() {\n                 },\n                 jwtCache: jwtCache\n             };\n-            JwtAuthProvider jwtAuthProvider \n-                = new (jwtValidatorConfig, getDefaultBooleanValue(jwtIssuer[VALIDATE_SUBSCRIPTION], DEFAULT_VALIDATE_SUBSCRIPTION));\n+            boolean classLoaded = false;\n+            string className = \"\";\n+            if(jwtIssuer.hasKey(\"claimMapperClassName\")){\n+               className = getDefaultStringValue(jwtIssuer[ISSUER_CLASSNAME], DEFAULT_ISSUER_CLASSNAME);\n+               classLoaded = loadMappingClass(className);\n+            }\n+            map<anydata>[] | error claims = [];\n+            if(jwtIssuer.hasKey(\"claims\")){\n+                  claims = map<anydata>[].constructFrom((jwtIssuer[\"claims\"]));\n+            }\n+            JwtAuthProvider jwtAuthProvider\n+                = new (jwtValidatorConfig, getDefaultBooleanValue(jwtIssuer[VALIDATE_SUBSCRIPTION], DEFAULT_VALIDATE_SUBSCRIPTION), claims, className, classLoaded);", "originalCommit": "7b3c4c4d0a2df3ab288572f46c774f12e3973801", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODgwNjAxMw==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r408806013", "bodyText": "Don't we have to use the modified jwt payload to do the rest of the work. I see, here we pass the original payload to subscription filtering (line 128) and so on.", "author": "AmaliMatharaarachchi", "createdAt": "2020-04-15T12:33:38Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/handler_providers/jwt_auth_provider.bal", "diffHunk": "@@ -67,6 +76,25 @@ public type JwtAuthProvider object {\n                     var cachedJwt = trap <jwt:CachedJwt>jwtCache.get(jwtToken);\n                     //finishing span\n                     finishSpan(JWT_CACHE, spanIdCache);\n+                    var isJwtTokenCached = self.gatewayCache.retrieveClaimMappingCache(jwtToken);\n+                    if (isJwtTokenCached is boolean) {\n+                        printDebug(KEY_JWT_AUTH_PROVIDER, \"Moddified claims in the cache\");\n+                     }\n+                    else {\n+                        printDebug(KEY_JWT_AUTH_PROVIDER, \"Moddified claims is not in the cache\");\n+                        (jwt:JwtPayload | error) payloadBody = getDecodedJWTPayload(jwtToken);\n+                        if (payloadBody is jwt:JwtPayload) {\n+                            string payloadIssuer = payloadBody[\"iss\"].toString();\n+                            if( self.jwtValidatorConfig[\"issuer\"] ==  payloadIssuer){\n+                                var result = doMappingContext(invocationContext, self.className, self.claims, self.classLoaded);\n+                                jwtToken = authContext?.authToken.toString();\n+                                self.gatewayCache.addClaimMappingCache(jwtToken, true);\n+                                if (result is auth:Error){\n+                                    return result;\n+                                }\n+                            }\n+                        }\n+                    }\n                     if (cachedJwt is jwt:CachedJwt) {", "originalCommit": "7b3c4c4d0a2df3ab288572f46c774f12e3973801", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODgwNjY3OA==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r408806678", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if ( claims is map<anydata>[] && claims.length() > 0) {\n          \n          \n            \n                    if (claims is map<anydata>[] && claims.length() > 0) {", "author": "AmaliMatharaarachchi", "createdAt": "2020-04-15T12:34:47Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/handler_providers/jwt_auth_provider.bal", "diffHunk": "@@ -133,11 +161,61 @@ public function validateSubscriptions(string jwtToken, jwt:JwtPayload payload, b\n         if (subscriptionValidated || !subscriptionValEnabled || isGRPC) {\n             printDebug(KEY_JWT_AUTH_PROVIDER, \"Subscriptions validation passed.\");\n             return true;\n-        } else { \n+        } else {\n             setErrorMessageToInvocationContext(API_AUTH_FORBIDDEN);\n             return prepareError(\"Subscriptions validation failed.\");\n         }\n     }\n     setErrorMessageToInvocationContext(API_AUTH_FORBIDDEN);\n     return prepareError(\"Failed to decode the JWT.\");\n }\n+\n+public function doMappingContext(runtime:InvocationContext invocationContext, string className, map<anydata>[] | error claims, boolean classLoaded) returns @tainted (auth:Error)? {\n+    map<any>? customClaims = invocationContext[\"principal\"][\"claims\"];\n+    if (customClaims is map<any>) {\n+        if ( claims is map<anydata>[] && claims.length() > 0) {", "originalCommit": "7b3c4c4d0a2df3ab288572f46c774f12e3973801", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODgwNzM3OQ==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r408807379", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                         }\n          \n          \n            \n                         else{\n          \n          \n            \n                         } else {", "author": "AmaliMatharaarachchi", "createdAt": "2020-04-15T12:35:59Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/handler_providers/jwt_auth_provider.bal", "diffHunk": "@@ -133,11 +161,61 @@ public function validateSubscriptions(string jwtToken, jwt:JwtPayload payload, b\n         if (subscriptionValidated || !subscriptionValEnabled || isGRPC) {\n             printDebug(KEY_JWT_AUTH_PROVIDER, \"Subscriptions validation passed.\");\n             return true;\n-        } else { \n+        } else {\n             setErrorMessageToInvocationContext(API_AUTH_FORBIDDEN);\n             return prepareError(\"Subscriptions validation failed.\");\n         }\n     }\n     setErrorMessageToInvocationContext(API_AUTH_FORBIDDEN);\n     return prepareError(\"Failed to decode the JWT.\");\n }\n+\n+public function doMappingContext(runtime:InvocationContext invocationContext, string className, map<anydata>[] | error claims, boolean classLoaded) returns @tainted (auth:Error)? {\n+    map<any>? customClaims = invocationContext[\"principal\"][\"claims\"];\n+    if (customClaims is map<any>) {\n+        if ( claims is map<anydata>[] && claims.length() > 0) {\n+            foreach map<anydata> claim in claims {\n+                string remoteClaim = claim[\"remoteClaim\"].toString();\n+                string localClaim = claim[\"localClaim\"].toString();\n+                if (customClaims is map<anydata>) {\n+                    if (customClaims.hasKey(remoteClaim) ) {\n+                        customClaims[localClaim] = customClaims[remoteClaim];\n+                        anydata removedElement = customClaims.remove(remoteClaim);\n+                    }\n+                 }\n+            }\n+        }\n+        if (className != \"\") {\n+            if(classLoaded){\n+                map<any>? customClaimsEdited = transformJWTValue(customClaims, className );\n+                if (customClaimsEdited is map<any>) {\n+                    customClaims = customClaimsEdited;\n+                }\n+             }\n+             else{", "originalCommit": "7b3c4c4d0a2df3ab288572f46c774f12e3973801", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODgwODM3Mg==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r408808372", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                             }\n          \n          \n            \n                            }", "author": "AmaliMatharaarachchi", "createdAt": "2020-04-15T12:37:40Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/handler_providers/jwt_auth_provider.bal", "diffHunk": "@@ -133,11 +161,61 @@ public function validateSubscriptions(string jwtToken, jwt:JwtPayload payload, b\n         if (subscriptionValidated || !subscriptionValEnabled || isGRPC) {\n             printDebug(KEY_JWT_AUTH_PROVIDER, \"Subscriptions validation passed.\");\n             return true;\n-        } else { \n+        } else {\n             setErrorMessageToInvocationContext(API_AUTH_FORBIDDEN);\n             return prepareError(\"Subscriptions validation failed.\");\n         }\n     }\n     setErrorMessageToInvocationContext(API_AUTH_FORBIDDEN);\n     return prepareError(\"Failed to decode the JWT.\");\n }\n+\n+public function doMappingContext(runtime:InvocationContext invocationContext, string className, map<anydata>[] | error claims, boolean classLoaded) returns @tainted (auth:Error)? {\n+    map<any>? customClaims = invocationContext[\"principal\"][\"claims\"];\n+    if (customClaims is map<any>) {\n+        if ( claims is map<anydata>[] && claims.length() > 0) {\n+            foreach map<anydata> claim in claims {\n+                string remoteClaim = claim[\"remoteClaim\"].toString();\n+                string localClaim = claim[\"localClaim\"].toString();\n+                if (customClaims is map<anydata>) {\n+                    if (customClaims.hasKey(remoteClaim) ) {\n+                        customClaims[localClaim] = customClaims[remoteClaim];\n+                        anydata removedElement = customClaims.remove(remoteClaim);\n+                    }\n+                 }", "originalCommit": "7b3c4c4d0a2df3ab288572f46c774f12e3973801", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODgwOTgwNg==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r408809806", "bodyText": "Can use constants values. Fix all occurrences.", "author": "AmaliMatharaarachchi", "createdAt": "2020-04-15T12:40:02Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/handler_providers/jwt_auth_provider.bal", "diffHunk": "@@ -67,6 +76,25 @@ public type JwtAuthProvider object {\n                     var cachedJwt = trap <jwt:CachedJwt>jwtCache.get(jwtToken);\n                     //finishing span\n                     finishSpan(JWT_CACHE, spanIdCache);\n+                    var isJwtTokenCached = self.gatewayCache.retrieveClaimMappingCache(jwtToken);\n+                    if (isJwtTokenCached is boolean) {\n+                        printDebug(KEY_JWT_AUTH_PROVIDER, \"Moddified claims in the cache\");\n+                     }\n+                    else {\n+                        printDebug(KEY_JWT_AUTH_PROVIDER, \"Moddified claims is not in the cache\");\n+                        (jwt:JwtPayload | error) payloadBody = getDecodedJWTPayload(jwtToken);\n+                        if (payloadBody is jwt:JwtPayload) {\n+                            string payloadIssuer = payloadBody[\"iss\"].toString();\n+                            if( self.jwtValidatorConfig[\"issuer\"] ==  payloadIssuer){", "originalCommit": "7b3c4c4d0a2df3ab288572f46c774f12e3973801", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODgxMzAzMQ==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r408813031", "bodyText": "Why do we check iss here? If it is needed, why not validating the aud as well?", "author": "AmaliMatharaarachchi", "createdAt": "2020-04-15T12:45:17Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/handler_providers/jwt_auth_provider.bal", "diffHunk": "@@ -67,6 +76,25 @@ public type JwtAuthProvider object {\n                     var cachedJwt = trap <jwt:CachedJwt>jwtCache.get(jwtToken);\n                     //finishing span\n                     finishSpan(JWT_CACHE, spanIdCache);\n+                    var isJwtTokenCached = self.gatewayCache.retrieveClaimMappingCache(jwtToken);\n+                    if (isJwtTokenCached is boolean) {\n+                        printDebug(KEY_JWT_AUTH_PROVIDER, \"Moddified claims in the cache\");\n+                     }\n+                    else {\n+                        printDebug(KEY_JWT_AUTH_PROVIDER, \"Moddified claims is not in the cache\");\n+                        (jwt:JwtPayload | error) payloadBody = getDecodedJWTPayload(jwtToken);\n+                        if (payloadBody is jwt:JwtPayload) {\n+                            string payloadIssuer = payloadBody[\"iss\"].toString();\n+                            if( self.jwtValidatorConfig[\"issuer\"] ==  payloadIssuer){", "originalCommit": "7b3c4c4d0a2df3ab288572f46c774f12e3973801", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODgxNTg0MQ==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r408815841", "bodyText": "Can combine.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (className != \"\") {\n          \n          \n            \n                        if(classLoaded){\n          \n          \n            \n                    if (className != \"\" && classLoaded) {", "author": "AmaliMatharaarachchi", "createdAt": "2020-04-15T12:50:01Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/handler_providers/jwt_auth_provider.bal", "diffHunk": "@@ -133,11 +161,61 @@ public function validateSubscriptions(string jwtToken, jwt:JwtPayload payload, b\n         if (subscriptionValidated || !subscriptionValEnabled || isGRPC) {\n             printDebug(KEY_JWT_AUTH_PROVIDER, \"Subscriptions validation passed.\");\n             return true;\n-        } else { \n+        } else {\n             setErrorMessageToInvocationContext(API_AUTH_FORBIDDEN);\n             return prepareError(\"Subscriptions validation failed.\");\n         }\n     }\n     setErrorMessageToInvocationContext(API_AUTH_FORBIDDEN);\n     return prepareError(\"Failed to decode the JWT.\");\n }\n+\n+public function doMappingContext(runtime:InvocationContext invocationContext, string className, map<anydata>[] | error claims, boolean classLoaded) returns @tainted (auth:Error)? {\n+    map<any>? customClaims = invocationContext[\"principal\"][\"claims\"];\n+    if (customClaims is map<any>) {\n+        if ( claims is map<anydata>[] && claims.length() > 0) {\n+            foreach map<anydata> claim in claims {\n+                string remoteClaim = claim[\"remoteClaim\"].toString();\n+                string localClaim = claim[\"localClaim\"].toString();\n+                if (customClaims is map<anydata>) {\n+                    if (customClaims.hasKey(remoteClaim) ) {\n+                        customClaims[localClaim] = customClaims[remoteClaim];\n+                        anydata removedElement = customClaims.remove(remoteClaim);\n+                    }\n+                 }\n+            }\n+        }\n+        if (className != \"\") {\n+            if(classLoaded){", "originalCommit": "7b3c4c4d0a2df3ab288572f46c774f12e3973801", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODgxNzM5NA==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r408817394", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            map<any>? customClaimsEdited = transformJWTValue(customClaims, className );\n          \n          \n            \n                            map<any>? customClaimsEdited = transformJWTValue(customClaims, className);", "author": "AmaliMatharaarachchi", "createdAt": "2020-04-15T12:52:37Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/handler_providers/jwt_auth_provider.bal", "diffHunk": "@@ -133,11 +161,61 @@ public function validateSubscriptions(string jwtToken, jwt:JwtPayload payload, b\n         if (subscriptionValidated || !subscriptionValEnabled || isGRPC) {\n             printDebug(KEY_JWT_AUTH_PROVIDER, \"Subscriptions validation passed.\");\n             return true;\n-        } else { \n+        } else {\n             setErrorMessageToInvocationContext(API_AUTH_FORBIDDEN);\n             return prepareError(\"Subscriptions validation failed.\");\n         }\n     }\n     setErrorMessageToInvocationContext(API_AUTH_FORBIDDEN);\n     return prepareError(\"Failed to decode the JWT.\");\n }\n+\n+public function doMappingContext(runtime:InvocationContext invocationContext, string className, map<anydata>[] | error claims, boolean classLoaded) returns @tainted (auth:Error)? {\n+    map<any>? customClaims = invocationContext[\"principal\"][\"claims\"];\n+    if (customClaims is map<any>) {\n+        if ( claims is map<anydata>[] && claims.length() > 0) {\n+            foreach map<anydata> claim in claims {\n+                string remoteClaim = claim[\"remoteClaim\"].toString();\n+                string localClaim = claim[\"localClaim\"].toString();\n+                if (customClaims is map<anydata>) {\n+                    if (customClaims.hasKey(remoteClaim) ) {\n+                        customClaims[localClaim] = customClaims[remoteClaim];\n+                        anydata removedElement = customClaims.remove(remoteClaim);\n+                    }\n+                 }\n+            }\n+        }\n+        if (className != \"\") {\n+            if(classLoaded){\n+                map<any>? customClaimsEdited = transformJWTValue(customClaims, className );", "originalCommit": "7b3c4c4d0a2df3ab288572f46c774f12e3973801", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODgyMDE0Mg==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r408820142", "bodyText": "Better to add filename to the debug log for easier debugging.", "author": "AmaliMatharaarachchi", "createdAt": "2020-04-15T12:57:03Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/handler_providers/jwt_auth_provider.bal", "diffHunk": "@@ -133,11 +161,61 @@ public function validateSubscriptions(string jwtToken, jwt:JwtPayload payload, b\n         if (subscriptionValidated || !subscriptionValEnabled || isGRPC) {\n             printDebug(KEY_JWT_AUTH_PROVIDER, \"Subscriptions validation passed.\");\n             return true;\n-        } else { \n+        } else {\n             setErrorMessageToInvocationContext(API_AUTH_FORBIDDEN);\n             return prepareError(\"Subscriptions validation failed.\");\n         }\n     }\n     setErrorMessageToInvocationContext(API_AUTH_FORBIDDEN);\n     return prepareError(\"Failed to decode the JWT.\");\n }\n+\n+public function doMappingContext(runtime:InvocationContext invocationContext, string className, map<anydata>[] | error claims, boolean classLoaded) returns @tainted (auth:Error)? {\n+    map<any>? customClaims = invocationContext[\"principal\"][\"claims\"];\n+    if (customClaims is map<any>) {\n+        if ( claims is map<anydata>[] && claims.length() > 0) {\n+            foreach map<anydata> claim in claims {\n+                string remoteClaim = claim[\"remoteClaim\"].toString();\n+                string localClaim = claim[\"localClaim\"].toString();\n+                if (customClaims is map<anydata>) {\n+                    if (customClaims.hasKey(remoteClaim) ) {\n+                        customClaims[localClaim] = customClaims[remoteClaim];\n+                        anydata removedElement = customClaims.remove(remoteClaim);\n+                    }\n+                 }\n+            }\n+        }\n+        if (className != \"\") {\n+            if(classLoaded){\n+                map<any>? customClaimsEdited = transformJWTValue(customClaims, className );\n+                if (customClaimsEdited is map<any>) {\n+                    customClaims = customClaimsEdited;\n+                }\n+             }\n+             else{\n+                return prepareError(\"Error while loading the jwttransformer class: \" + className);\n+             }\n+\n+        }\n+        if(customClaims[\"scope\"].toString() != \"\"){\n+            var result = putScopeValue(customClaims[\"scope\"],invocationContext);\n+            if (result is auth:Error) {\n+                return result;\n+            }\n+        }\n+     }\n+}\n+\n+public function putScopeValue(any scope,runtime:InvocationContext invocationContext) returns @tainted (auth:Error)? {\n+    if (scope is string && scope != \"\") {\n+        string[]? scopes =  stringutils:split(scope.toString(), \" \");\n+        if (scopes is string[]) {\n+            invocationContext.principal.scopes = scopes;\n+            printDebug(\"scopes\", scopes.toString());", "originalCommit": "7b3c4c4d0a2df3ab288572f46c774f12e3973801", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "72b4abe0e4341dc4c2349abf5407222bdb281139", "url": "https://github.com/wso2/product-microgateway/commit/72b4abe0e4341dc4c2349abf5407222bdb281139", "message": "resolved comments and resolved conflict", "committedDate": "2020-04-16T13:42:59Z", "type": "forcePushed"}, {"oid": "7b3c4c4d0a2df3ab288572f46c774f12e3973801", "url": "https://github.com/wso2/product-microgateway/commit/7b3c4c4d0a2df3ab288572f46c774f12e3973801", "message": "Resolve reviewd comments", "committedDate": "2020-04-15T10:19:22Z", "type": "forcePushed"}, {"oid": "daa5a352a50ec1a229dccc0805582c6bd253ecff", "url": "https://github.com/wso2/product-microgateway/commit/daa5a352a50ec1a229dccc0805582c6bd253ecff", "message": "resolved comments and conflict", "committedDate": "2020-04-16T16:14:04Z", "type": "commit"}, {"oid": "9d957047d1d987d102d13656d83a5ea7761b7b63", "url": "https://github.com/wso2/product-microgateway/commit/9d957047d1d987d102d13656d83a5ea7761b7b63", "message": "Add integration test case", "committedDate": "2020-04-24T08:51:06Z", "type": "commit"}, {"oid": "9d957047d1d987d102d13656d83a5ea7761b7b63", "url": "https://github.com/wso2/product-microgateway/commit/9d957047d1d987d102d13656d83a5ea7761b7b63", "message": "Add integration test case", "committedDate": "2020-04-24T08:51:06Z", "type": "forcePushed"}, {"oid": "49be77d90f771dc763c3aaa209f890bf741705ca", "url": "https://github.com/wso2/product-microgateway/commit/49be77d90f771dc763c3aaa209f890bf741705ca", "message": "Move Error handle to ballerina side", "committedDate": "2020-04-24T15:55:02Z", "type": "commit"}, {"oid": "49be77d90f771dc763c3aaa209f890bf741705ca", "url": "https://github.com/wso2/product-microgateway/commit/49be77d90f771dc763c3aaa209f890bf741705ca", "message": "Move Error handle to ballerina side", "committedDate": "2020-04-24T15:55:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA2MDcxMg==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r429060712", "bodyText": "Lets remove unused resources,schemas   from the open API and make it short", "author": "Rajith90", "createdAt": "2020-05-22T06:13:42Z", "path": "tests/src/test/resources/openAPIs/jwtTransformer/jwt_transformer.yaml", "diffHunk": "@@ -0,0 +1,748 @@\n+openapi: 3.0.0", "originalCommit": "49be77d90f771dc763c3aaa209f890bf741705ca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA2MzY4NQ==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r429063685", "bodyText": "Comment seems to have class word twice", "author": "Rajith90", "createdAt": "2020-05-22T06:23:27Z", "path": "components/micro-gateway-core/src/main/java/org/wso2/micro/gateway/core/mapping/MappingInvoker.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ *  Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *  http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package org.wso2.micro.gateway.core.mapping;\n+\n+import org.ballerinalang.jvm.values.ArrayValue;\n+import org.ballerinalang.jvm.values.MapValue;\n+import org.ballerinalang.jvm.values.MapValueImpl;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.wso2.micro.gateway.jwttransformer.JWTValueTransformer;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+/**\n+ * This class Class to dynamically invoke the transformer.", "originalCommit": "49be77d90f771dc763c3aaa209f890bf741705ca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA3Mzk4Ng==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r429073986", "bodyText": "If there are no claims and additional java class specified then we don not always check the cache and invoke doMappingContext method", "author": "Rajith90", "createdAt": "2020-05-22T06:54:37Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/handler_providers/jwt_auth_provider.bal", "diffHunk": "@@ -97,11 +106,37 @@ public type JwtAuthProvider object {\n                         } else {\n                             printDebug(KEY_JWT_AUTH_PROVIDER, \"jti claim not found in the jwt\");\n                         }\n+                        var jwtTokenClaimCached = self.gatewayCache.retrieveClaimMappingCache(jwtToken);\n+                        if (jwtTokenClaimCached is runtime:Principal) {\n+                            invocationContext.principal =  jwtTokenClaimCached;\n+                            printDebug(KEY_JWT_AUTH_PROVIDER, \"Moddified claims in the cache\");\n+                        } else {\n+                            printDebug(KEY_JWT_AUTH_PROVIDER, \"Moddified claims is not in the cache\");\n+                            var result = doMappingContext(invocationContext, self.className, self.claims,\n+                                self.classLoaded, jwtPayloadFromCache, self.jwtValidatorConfig, self.gatewayCache, authContext);\n+                            if (result is auth:Error){\n+                                return result;\n+                            }\n+                            jwtToken = authContext?.authToken.toString();\n+                        }\n                         return validateSubscriptions(jwtToken, cachedJwt.jwtPayload, self.subscriptionValEnabled, isGRPC);\n-                    } \n+                    }\n                     printDebug(KEY_JWT_AUTH_PROVIDER, \"jwt not found in the jwt cache\");\n                     (jwt:JwtPayload | error) payload = getDecodedJWTPayload(jwtToken);\n                     if (payload is jwt:JwtPayload) {\n+                        var jwtTokenClaimCached = self.gatewayCache.retrieveClaimMappingCache(jwtToken);", "originalCommit": "49be77d90f771dc763c3aaa209f890bf741705ca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA3NDMxNA==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r429074314", "bodyText": "Use a proper name for the map", "author": "Rajith90", "createdAt": "2020-05-22T06:55:26Z", "path": "components/micro-gateway-core/src/main/java/org/wso2/micro/gateway/core/mapping/MappingInvoker.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ *  Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *  http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package org.wso2.micro.gateway.core.mapping;\n+\n+import org.ballerinalang.jvm.values.ArrayValue;\n+import org.ballerinalang.jvm.values.MapValue;\n+import org.ballerinalang.jvm.values.MapValueImpl;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.wso2.micro.gateway.jwttransformer.JWTValueTransformer;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+/**\n+ * This class Class to dynamically invoke the transformer.\n+ */\n+public class MappingInvoker {\n+    private static Map map;", "originalCommit": "49be77d90f771dc763c3aaa209f890bf741705ca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f43ac87c2513219c3237d5003e5fc82eb6464522", "url": "https://github.com/wso2/product-microgateway/commit/f43ac87c2513219c3237d5003e5fc82eb6464522", "message": "resolve comments", "committedDate": "2020-05-22T14:35:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjI3MDU5Mw==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r432270593", "bodyText": "Pleae move this line also inside if condition", "author": "Rajith90", "createdAt": "2020-05-29T05:57:04Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/handler_providers/jwt_auth_provider.bal", "diffHunk": "@@ -97,11 +107,41 @@ public type JwtAuthProvider object {\n                         } else {\n                             printDebug(KEY_JWT_AUTH_PROVIDER, \"jti claim not found in the jwt\");\n                         }\n+                        var jwtTokenClaimCached = self.gatewayCache.retrieveClaimMappingCache(jwtToken);", "originalCommit": "f43ac87c2513219c3237d5003e5fc82eb6464522", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1c286051e8eb599adf78d105b01abe58d3460b86", "url": "https://github.com/wso2/product-microgateway/commit/1c286051e8eb599adf78d105b01abe58d3460b86", "message": "add jwt claim mapping in default micro gateway template.", "committedDate": "2020-05-29T06:46:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzAzOTc4NQ==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r433039785", "bodyText": "I think package name should be jwt.transformer", "author": "Rajith90", "createdAt": "2020-06-01T04:49:05Z", "path": "tests/src/main/java/org/wso2/micro/gateway/tests/jwtvaluetransformer/DefaultJwtTransformer.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package org.wso2.micro.gateway.tests.jwtvaluetransformer;\n+\n+import org.wso2.micro.gateway.jwttransformer.JWTValueTransformer;", "originalCommit": "1c286051e8eb599adf78d105b01abe58d3460b86", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzAzOTgyNw==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r433039827", "bodyText": "I think package name should be jwt.transformer", "author": "Rajith90", "createdAt": "2020-06-01T04:49:20Z", "path": "components/micro-gateway-jwt-transformer/src/main/java/org/wso2/micro/gateway/jwttransformer/JWTValueTransformer.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ *  Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *  http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+\n+package org.wso2.micro.gateway.jwttransformer;", "originalCommit": "1c286051e8eb599adf78d105b01abe58d3460b86", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a4a675eef13666e4cd86925e234f8df83099069c", "url": "https://github.com/wso2/product-microgateway/commit/a4a675eef13666e4cd86925e234f8df83099069c", "message": "change package name", "committedDate": "2020-06-01T05:40:48Z", "type": "commit"}, {"oid": "02bf9527a02cb3f6694f8575e978e9c1b9c2d022", "url": "https://github.com/wso2/product-microgateway/commit/02bf9527a02cb3f6694f8575e978e9c1b9c2d022", "message": "edit default template", "committedDate": "2020-06-02T09:05:51Z", "type": "commit"}, {"oid": "5f59752dbe7e675db21fd42ffdb368be6f38d734", "url": "https://github.com/wso2/product-microgateway/commit/5f59752dbe7e675db21fd42ffdb368be6f38d734", "message": "Merge branch 'master' of https://github.com/wso2/product-microgateway into master1\n\n# Conflicts:\n#\tcomponents/micro-gateway-core/pom.xml\n#\tcomponents/micro-gateway-core/src/main/ballerina/src/gateway/api_gateway_cache.bal\n#\ttests/src/test/java/org/wso2/micro/gateway/tests/common/MockBackEndServer.java\n#\ttests/src/test/java/org/wso2/micro/gateway/tests/common/ResponseConstants.java\n#\ttests/src/test/resources/testng.xml", "committedDate": "2020-06-03T04:43:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDMwODgxNQ==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r434308815", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            <project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n          \n          \n            \n            <!--\n          \n          \n            \n              ~ Copyright (c) 2018, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n          \n          \n            \n              ~\n          \n          \n            \n              ~ Licensed under the Apache License, Version 2.0 (the \"License\");\n          \n          \n            \n              ~ you may not use this file except in compliance with the License.\n          \n          \n            \n              ~ You may obtain a copy of the License at\n          \n          \n            \n              ~\n          \n          \n            \n              ~ http://www.apache.org/licenses/LICENSE-2.0\n          \n          \n            \n              ~\n          \n          \n            \n              ~ Unless required by applicable law or agreed to in writing, software\n          \n          \n            \n              ~ distributed under the License is distributed on an \"AS IS\" BASIS,\n          \n          \n            \n              ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n          \n          \n            \n              ~ See the License for the specific language governing permissions and\n          \n          \n            \n              ~ limitations under the License.\n          \n          \n            \n              -->\n          \n          \n            \n            <project xmlns=\"http://maven.apache.org/POM/4.0.0\"", "author": "praminda", "createdAt": "2020-06-03T05:01:29Z", "path": "components/micro-gateway-jwt-transformer/pom.xml", "diffHunk": "@@ -0,0 +1,70 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"", "originalCommit": "5f59752dbe7e675db21fd42ffdb368be6f38d734", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDMwOTM3Ng==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r434309376", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            package org.wso2.micro.gateway.tests.jwtvaluetransformer;\n          \n          \n            \n            /*\n          \n          \n            \n             * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n          \n          \n            \n             *\n          \n          \n            \n             * WSO2 Inc. licenses this file to you under the Apache License,\n          \n          \n            \n             * Version 2.0 (the \"License\"); you may not use this file except\n          \n          \n            \n             * in compliance with the License.\n          \n          \n            \n             * You may obtain a copy of the License at\n          \n          \n            \n             *\n          \n          \n            \n             *    http://www.apache.org/licenses/LICENSE-2.0\n          \n          \n            \n             *\n          \n          \n            \n             * Unless required by applicable law or agreed to in writing,\n          \n          \n            \n             * software distributed under the License is distributed on an\n          \n          \n            \n             * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n          \n          \n            \n             * KIND, either express or implied.  See the License for the\n          \n          \n            \n             * specific language governing permissions and limitations\n          \n          \n            \n             * under the License.\n          \n          \n            \n             */\n          \n          \n            \n            \n          \n          \n            \n            package org.wso2.micro.gateway.tests.jwtvaluetransformer;", "author": "praminda", "createdAt": "2020-06-03T05:03:50Z", "path": "tests/src/main/java/org/wso2/micro/gateway/tests/jwtvaluetransformer/DefaultJwtTransformer.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package org.wso2.micro.gateway.tests.jwtvaluetransformer;", "originalCommit": "5f59752dbe7e675db21fd42ffdb368be6f38d734", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDMwOTQ5Nw==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r434309497", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            package org.wso2.micro.gateway.tests.jwtTransformer;\n          \n          \n            \n            /*\n          \n          \n            \n             * Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n          \n          \n            \n             *\n          \n          \n            \n             * WSO2 Inc. licenses this file to you under the Apache License,\n          \n          \n            \n             * Version 2.0 (the \"License\"); you may not use this file except\n          \n          \n            \n             * in compliance with the License.\n          \n          \n            \n             * You may obtain a copy of the License at\n          \n          \n            \n             *\n          \n          \n            \n             *    http://www.apache.org/licenses/LICENSE-2.0\n          \n          \n            \n             *\n          \n          \n            \n             * Unless required by applicable law or agreed to in writing,\n          \n          \n            \n             * software distributed under the License is distributed on an\n          \n          \n            \n             * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n          \n          \n            \n             * KIND, either express or implied.  See the License for the\n          \n          \n            \n             * specific language governing permissions and limitations\n          \n          \n            \n             * under the License.\n          \n          \n            \n             */\n          \n          \n            \n            \n          \n          \n            \n            package org.wso2.micro.gateway.tests.jwtTransformer;", "author": "praminda", "createdAt": "2020-06-03T05:04:23Z", "path": "tests/src/test/java/org/wso2/micro/gateway/tests/jwtTransformer/JwtTransformerTestCase.java", "diffHunk": "@@ -0,0 +1,67 @@\n+package org.wso2.micro.gateway.tests.jwtTransformer;", "originalCommit": "5f59752dbe7e675db21fd42ffdb368be6f38d734", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5e324f7b3a0fc400b62ef0408976aaea688026f9", "url": "https://github.com/wso2/product-microgateway/commit/5e324f7b3a0fc400b62ef0408976aaea688026f9", "message": "Apply suggestions from code review\n\nCo-authored-by: Praminda <pramindabj@gmail.com>", "committedDate": "2020-06-03T05:15:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDMxMzA2MA==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r434313060", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              ~ Copyright (c) 2018, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n          \n          \n            \n              ~ Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.", "author": "praminda", "createdAt": "2020-06-03T05:17:50Z", "path": "components/micro-gateway-jwt-transformer/pom.xml", "diffHunk": "@@ -0,0 +1,85 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!--\n+  ~ Copyright (c) 2018, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.", "originalCommit": "5e324f7b3a0fc400b62ef0408976aaea688026f9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cf929c7a1e9aacac932ca1663fc1cdcee572a3a0", "url": "https://github.com/wso2/product-microgateway/commit/cf929c7a1e9aacac932ca1663fc1cdcee572a3a0", "message": "update license version", "committedDate": "2020-06-03T05:21:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjI5MzM2MA==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r432293360", "bodyText": "provide example values", "author": "AmaliMatharaarachchi", "createdAt": "2020-05-29T07:05:01Z", "path": "distribution/resources/conf/default-micro-gw.conf.template", "diffHunk": "@@ -100,13 +100,29 @@\n   certificateAlias = \"wso2apim310\"\n   # Validate subscribed APIs\n   validateSubscription = false\n+  #support custom claim mapping\n+  claimMapperClassName = \"class name of jwt claims value transformer 1\"\n+  [[jwtTokenConfig.claims]]\n+    remoteClaim = \"attribute name of remote claim 1\"\n+    localClaim = \"attribute name of local claim 1\"\n+  [[jwtTokenConfig.claims]]\n+    remoteClaim = \"attribute name of remote claim 2\"", "originalCommit": "1c286051e8eb599adf78d105b01abe58d3460b86", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjI5NDYwNw==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r432294607", "bodyText": "Can we use an existing YAML for test cases?", "author": "AmaliMatharaarachchi", "createdAt": "2020-05-29T07:07:51Z", "path": "tests/src/test/resources/openAPIs/jwtTransformer/jwt_transformer.yaml", "diffHunk": "@@ -0,0 +1,145 @@\n+openapi: 3.0.0\n+info:\n+  description: \"This is a sample server Petstore server.  You can find out more about", "originalCommit": "1c286051e8eb599adf78d105b01abe58d3460b86", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDMyMTY0NQ==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r434321645", "bodyText": "It is better to have separate yaml file.", "author": "tharmini", "createdAt": "2020-06-03T05:47:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjI5NDYwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjI5NTE3NA==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r432295174", "bodyText": "remove unnecessary configs and keep only configs specific to the test cases.", "author": "AmaliMatharaarachchi", "createdAt": "2020-05-29T07:09:13Z", "path": "tests/src/test/resources/confs/jwt-transformer-test-config.conf", "diffHunk": "@@ -0,0 +1,46 @@\n+[listenerConfig]", "originalCommit": "1c286051e8eb599adf78d105b01abe58d3460b86", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjI5NjU2MA==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r432296560", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static final String SYSTEM_PROP_JWTTRANSFORMER_JAR = \"jwt_transformer_jar\";\n          \n          \n            \n                public static final String SYSTEM_PROP_JWT_TRANSFORMER_JAR = \"jwt_transformer_jar\";", "author": "AmaliMatharaarachchi", "createdAt": "2020-05-29T07:12:33Z", "path": "tests/src/test/java/org/wso2/micro/gateway/tests/context/Constants.java", "diffHunk": "@@ -29,6 +29,8 @@\n     public static final String SYSTEM_PROP_WINDOWS_RUNTIME = \"runtime_windows\";\n     //Name of the system property define the location of the linux runtime distribution\n     public static final String SYSTEM_PROP_LINUX_RUNTIME = \"runtime_linux\";\n+    // Name of the system property define the custom value  transformer jar file location\n+    public static final String SYSTEM_PROP_JWTTRANSFORMER_JAR = \"jwt_transformer_jar\";", "originalCommit": "1c286051e8eb599adf78d105b01abe58d3460b86", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDMxMDc2Nw==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r434310767", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                            printDebug(KEY_JWT_AUTH_PROVIDER, \"Moddified claims in the cache\");\n          \n          \n            \n                                            printDebug(KEY_JWT_AUTH_PROVIDER, \"Modified claims in the cache\");", "author": "AmaliMatharaarachchi", "createdAt": "2020-06-03T05:09:27Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/handler_providers/jwt_auth_provider.bal", "diffHunk": "@@ -97,11 +107,41 @@ public type JwtAuthProvider object {\n                         } else {\n                             printDebug(KEY_JWT_AUTH_PROVIDER, \"jti claim not found in the jwt\");\n                         }\n+                        if(self.className != \"\" || (claimsSet is map<anydata>[] && claimsSet.length() > 0)) {\n+                            var jwtTokenClaimCached = self.gatewayCache.retrieveClaimMappingCache(jwtToken);\n+                            if (jwtTokenClaimCached is runtime:Principal) {\n+                                invocationContext.principal =  jwtTokenClaimCached;\n+                                printDebug(KEY_JWT_AUTH_PROVIDER, \"Moddified claims in the cache\");", "originalCommit": "5f59752dbe7e675db21fd42ffdb368be6f38d734", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDMxMDg0NA==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r434310844", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                            printDebug(KEY_JWT_AUTH_PROVIDER, \"Moddified claims is not in the cache\");\n          \n          \n            \n                                            printDebug(KEY_JWT_AUTH_PROVIDER, \"Modified claims is not in the cache\");", "author": "AmaliMatharaarachchi", "createdAt": "2020-06-03T05:09:41Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/handler_providers/jwt_auth_provider.bal", "diffHunk": "@@ -97,11 +107,41 @@ public type JwtAuthProvider object {\n                         } else {\n                             printDebug(KEY_JWT_AUTH_PROVIDER, \"jti claim not found in the jwt\");\n                         }\n+                        if(self.className != \"\" || (claimsSet is map<anydata>[] && claimsSet.length() > 0)) {\n+                            var jwtTokenClaimCached = self.gatewayCache.retrieveClaimMappingCache(jwtToken);\n+                            if (jwtTokenClaimCached is runtime:Principal) {\n+                                invocationContext.principal =  jwtTokenClaimCached;\n+                                printDebug(KEY_JWT_AUTH_PROVIDER, \"Moddified claims in the cache\");\n+                            } else {\n+                                printDebug(KEY_JWT_AUTH_PROVIDER, \"Moddified claims is not in the cache\");", "originalCommit": "5f59752dbe7e675db21fd42ffdb368be6f38d734", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDMxMTY5Mw==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r434311693", "bodyText": "jwtToken is already retrieved from above lines. line 62. Why retrieve it again?", "author": "AmaliMatharaarachchi", "createdAt": "2020-06-03T05:12:50Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/handler_providers/jwt_auth_provider.bal", "diffHunk": "@@ -97,11 +107,41 @@ public type JwtAuthProvider object {\n                         } else {\n                             printDebug(KEY_JWT_AUTH_PROVIDER, \"jti claim not found in the jwt\");\n                         }\n+                        if(self.className != \"\" || (claimsSet is map<anydata>[] && claimsSet.length() > 0)) {\n+                            var jwtTokenClaimCached = self.gatewayCache.retrieveClaimMappingCache(jwtToken);\n+                            if (jwtTokenClaimCached is runtime:Principal) {\n+                                invocationContext.principal =  jwtTokenClaimCached;\n+                                printDebug(KEY_JWT_AUTH_PROVIDER, \"Moddified claims in the cache\");\n+                            } else {\n+                                printDebug(KEY_JWT_AUTH_PROVIDER, \"Moddified claims is not in the cache\");\n+                                var result = doMappingContext(invocationContext, self.className, self.claims,\n+                                    self.classLoaded, jwtPayloadFromCache, self.jwtValidatorConfig, self.gatewayCache, authContext);\n+                                if (result is auth:Error){\n+                                    return result;\n+                                }\n+                                jwtToken = authContext?.authToken.toString();", "originalCommit": "5f59752dbe7e675db21fd42ffdb368be6f38d734", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDMyMDg3Mg==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r434320872", "bodyText": "Here we have to take modified jwt token with claims from auth context.", "author": "tharmini", "createdAt": "2020-06-03T05:45:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDMxMTY5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDMxMTgwNg==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r434311806", "bodyText": "Here as well", "author": "AmaliMatharaarachchi", "createdAt": "2020-06-03T05:13:15Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/handler_providers/jwt_auth_provider.bal", "diffHunk": "@@ -97,11 +107,41 @@ public type JwtAuthProvider object {\n                         } else {\n                             printDebug(KEY_JWT_AUTH_PROVIDER, \"jti claim not found in the jwt\");\n                         }\n+                        if(self.className != \"\" || (claimsSet is map<anydata>[] && claimsSet.length() > 0)) {\n+                            var jwtTokenClaimCached = self.gatewayCache.retrieveClaimMappingCache(jwtToken);\n+                            if (jwtTokenClaimCached is runtime:Principal) {\n+                                invocationContext.principal =  jwtTokenClaimCached;\n+                                printDebug(KEY_JWT_AUTH_PROVIDER, \"Moddified claims in the cache\");\n+                            } else {\n+                                printDebug(KEY_JWT_AUTH_PROVIDER, \"Moddified claims is not in the cache\");\n+                                var result = doMappingContext(invocationContext, self.className, self.claims,\n+                                    self.classLoaded, jwtPayloadFromCache, self.jwtValidatorConfig, self.gatewayCache, authContext);\n+                                if (result is auth:Error){\n+                                    return result;\n+                                }\n+                                jwtToken = authContext?.authToken.toString();\n+                            }\n+                         }\n                         return validateSubscriptions(jwtToken, cachedJwt.jwtPayload, self.subscriptionValEnabled, isGRPC);\n-                    } \n+                    }\n                     printDebug(KEY_JWT_AUTH_PROVIDER, \"jwt not found in the jwt cache\");\n                     (jwt:JwtPayload | error) payload = getDecodedJWTPayload(jwtToken);\n                     if (payload is jwt:JwtPayload) {\n+                        if(self.className != \"\" || (claimsSet is map<anydata>[] && claimsSet.length() > 0)) {\n+                            var jwtTokenClaimCached = self.gatewayCache.retrieveClaimMappingCache(jwtToken);\n+                            if (jwtTokenClaimCached is runtime:Principal) {\n+                                invocationContext.principal =  jwtTokenClaimCached;\n+                                printDebug(KEY_JWT_AUTH_PROVIDER, \"Moddified claims in the cache\");\n+                            } else {\n+                                printDebug(KEY_JWT_AUTH_PROVIDER, \"Moddified claims is not in the cache\");\n+                                var result = doMappingContext(invocationContext, self.className, self.claims,\n+                                    self.classLoaded, payload, self.jwtValidatorConfig, self.gatewayCache, authContext);\n+                                if (result is auth:Error){\n+                                    return result;\n+                                }\n+                                jwtToken = authContext?.authToken.toString();", "originalCommit": "5f59752dbe7e675db21fd42ffdb368be6f38d734", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDMyMTM1Ng==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r434321356", "bodyText": "Here we have to take modified jwt token with claims from auth context.", "author": "tharmini", "createdAt": "2020-06-03T05:46:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDMxMTgwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDMxMjUwNg==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r434312506", "bodyText": "it seems, same code is duplicated in above as well. If so, can we fix it?", "author": "AmaliMatharaarachchi", "createdAt": "2020-06-03T05:15:41Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/handler_providers/jwt_auth_provider.bal", "diffHunk": "@@ -97,11 +107,41 @@ public type JwtAuthProvider object {\n                         } else {\n                             printDebug(KEY_JWT_AUTH_PROVIDER, \"jti claim not found in the jwt\");\n                         }\n+                        if(self.className != \"\" || (claimsSet is map<anydata>[] && claimsSet.length() > 0)) {\n+                            var jwtTokenClaimCached = self.gatewayCache.retrieveClaimMappingCache(jwtToken);\n+                            if (jwtTokenClaimCached is runtime:Principal) {\n+                                invocationContext.principal =  jwtTokenClaimCached;\n+                                printDebug(KEY_JWT_AUTH_PROVIDER, \"Moddified claims in the cache\");\n+                            } else {\n+                                printDebug(KEY_JWT_AUTH_PROVIDER, \"Moddified claims is not in the cache\");\n+                                var result = doMappingContext(invocationContext, self.className, self.claims,\n+                                    self.classLoaded, jwtPayloadFromCache, self.jwtValidatorConfig, self.gatewayCache, authContext);\n+                                if (result is auth:Error){\n+                                    return result;\n+                                }\n+                                jwtToken = authContext?.authToken.toString();\n+                            }\n+                         }\n                         return validateSubscriptions(jwtToken, cachedJwt.jwtPayload, self.subscriptionValEnabled, isGRPC);\n-                    } \n+                    }\n                     printDebug(KEY_JWT_AUTH_PROVIDER, \"jwt not found in the jwt cache\");\n                     (jwt:JwtPayload | error) payload = getDecodedJWTPayload(jwtToken);\n                     if (payload is jwt:JwtPayload) {\n+                        if(self.className != \"\" || (claimsSet is map<anydata>[] && claimsSet.length() > 0)) {", "originalCommit": "5f59752dbe7e675db21fd42ffdb368be6f38d734", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDMxMjkwNg==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r434312906", "bodyText": "can we use constants for these?", "author": "AmaliMatharaarachchi", "createdAt": "2020-06-03T05:17:14Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/handler_providers/jwt_auth_provider.bal", "diffHunk": "@@ -133,11 +173,71 @@ public function validateSubscriptions(string jwtToken, jwt:JwtPayload payload, b\n         if (subscriptionValidated || !subscriptionValEnabled || isGRPC) {\n             printDebug(KEY_JWT_AUTH_PROVIDER, \"Subscriptions validation passed.\");\n             return true;\n-        } else { \n+        } else {\n             setErrorMessageToInvocationContext(API_AUTH_FORBIDDEN);\n             return prepareError(\"Subscriptions validation failed.\");\n         }\n     }\n     setErrorMessageToInvocationContext(API_AUTH_FORBIDDEN);\n     return prepareError(\"Failed to decode the JWT.\");\n }\n+\n+public function doMappingContext(runtime:InvocationContext invocationContext, string className,\n+    map<anydata>[] | error claims, boolean classLoaded, jwt:JwtPayload jwtPayloadFromCache,\n+        jwt:JwtValidatorConfig jwtValidatorConfig, APIGatewayCache gatewayCache,\n+            runtime:AuthenticationContext authContext) returns @tainted (auth:Error)? {\n+    string payloadIssuer = jwtPayloadFromCache[\"iss\"].toString();\n+    string payloadAudience = jwtPayloadFromCache[\"aud\"].toString();\n+    if( jwtValidatorConfig[ISSUER] ==  payloadIssuer &&\n+        jwtValidatorConfig[AUDIENCE] ==  payloadAudience) {\n+        map<any>? customClaims = invocationContext[\"principal\"][\"claims\"];", "originalCommit": "5f59752dbe7e675db21fd42ffdb368be6f38d734", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDMxMzkxMA==", "url": "https://github.com/wso2/product-microgateway/pull/1180#discussion_r434313910", "bodyText": "add comments describing these.", "author": "AmaliMatharaarachchi", "createdAt": "2020-06-03T05:21:02Z", "path": "distribution/resources/conf/default-micro-gw.conf.template", "diffHunk": "@@ -98,13 +98,29 @@\n   certificateAlias = \"wso2apim310\"\n   # Validate subscribed APIs\n   validateSubscription = false\n+  #support custom claim mapping\n+  claimMapperClassName = \"org.wso2.micro.gateway.jwtTransformer.DefaultJwtTransformer\"\n+  [[jwtTokenConfig.claims]]\n+    remoteClaim = \"scp\"", "originalCommit": "5f59752dbe7e675db21fd42ffdb368be6f38d734", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}