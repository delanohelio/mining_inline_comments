{"pr_number": 926, "pr_title": "Add changes to solve throttling filter issue with throttle window ", "pr_createdAt": "2020-01-08T12:07:49Z", "pr_url": "https://github.com/wso2/product-microgateway/pull/926", "timeline": [{"oid": "ca1b44be50d3ed7808756b107c3734f7aa97bcb1", "url": "https://github.com/wso2/product-microgateway/commit/ca1b44be50d3ed7808756b107c3734f7aa97bcb1", "message": "Add changes to solve throttling issue with throttle window", "committedDate": "2020-01-08T11:04:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTY0MDkxNw==", "url": "https://github.com/wso2/product-microgateway/pull/926#discussion_r365640917", "bodyText": "Can't we use the request stream and gateway:RequestStreamDTO instead of defining new streams and dtos", "author": "Rajith90", "createdAt": "2020-01-13T03:52:08Z", "path": "components/micro-gateway-cli/src/main/resources/templates/policy.mustache", "diffHunk": "@@ -1,54 +1,19 @@\n import wso2/gateway;\n \n-stream<gateway:IntermediateStream> s{{name}}intermediateStream = new;\n-stream<gateway:GlobalThrottleStreamDTO> s{{name}}resultStream = new;\n-stream<gateway:EligibilityStreamDTO> s{{name}}eligibilityStream = new;\n-stream<gateway:RequestStreamDTO> s{{name}}reqCopy= gateway:getRequestStream();\n-stream<gateway:GlobalThrottleStreamDTO> s{{name}}globalThrotCopy = gateway:getGlobalThrottleStream();\n+stream<gateway:InputRequest> s{{name}}inputStream =gateway:getinputStream();", "originalCommit": "ca1b44be50d3ed7808756b107c3734f7aa97bcb1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTY0MTE3OA==", "url": "https://github.com/wso2/product-microgateway/pull/926#discussion_r365641178", "bodyText": "Check the formatting of the function. Seems like too much indentation", "author": "Rajith90", "createdAt": "2020-01-13T03:54:49Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/filters/throttle_filter.bal", "diffHunk": "@@ -302,53 +302,57 @@ function isRequestBlocked(http:Caller caller, http:Request request, http:FilterC\n }\n \n function generateThrottleEvent(http:Request req, http:FilterContext context, AuthenticationContext keyValidationDto)\n-returns (RequestStreamDTO) {\n-    RequestStreamDTO requestStreamDto = {};\n-    string? apiVersion = getVersion(context);\n-    requestStreamDto.messageID = <string>context.attributes[MESSAGE_ID];\n-    requestStreamDto.apiKey = getContext(context);\n-    requestStreamDto.appKey = keyValidationDto.applicationId + \":\" + keyValidationDto.username;\n-    requestStreamDto.subscriptionKey = keyValidationDto.applicationId + \":\" + getContext(context);\n-    requestStreamDto.appTier = keyValidationDto.applicationTier;\n-    requestStreamDto.apiTier = keyValidationDto.apiTier;\n-    requestStreamDto.subscriptionTier = keyValidationDto.tier;\n-    string resourcekey = context.getResourceName();\n-    requestStreamDto.resourceKey = replaceAll(resourcekey, \"_\", \"\");\n-    TierConfiguration? tier = resourceTierAnnotationMap[resourcekey];\n-    string? policy = (tier is TierConfiguration) ? tier.policy : ();\n-    if (policy is string) {\n-        requestStreamDto.resourceTier = policy;\n-    }\n+returns (InputRequest) {", "originalCommit": "ca1b44be50d3ed7808756b107c3734f7aa97bcb1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTY0MTI3Mw==", "url": "https://github.com/wso2/product-microgateway/pull/926#discussion_r365641273", "bodyText": "Can't we use the global throttle stream instead of new outputstream", "author": "Rajith90", "createdAt": "2020-01-13T03:55:55Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/utils/throttle_util.bal", "diffHunk": "@@ -14,12 +14,12 @@\n // specific language governing permissions and limitations\n // under the License.\n \n-import ballerina/time;\n import wso2/jms;\n \n map<string> blockConditions = {};\n map<any> throttleDataMap = {};\n-stream<RequestStreamDTO> requestStream = new;\n+stream<InputRequest> inputStream =new;\n+stream<ThrottledRequest> outputStream = new;", "originalCommit": "ca1b44be50d3ed7808756b107c3734f7aa97bcb1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTY0MTUzOQ==", "url": "https://github.com/wso2/product-microgateway/pull/926#discussion_r365641539", "bodyText": "Please correct the formatting issue", "author": "hasuniea", "createdAt": "2020-01-13T03:58:43Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/constants/constants.bal", "diffHunk": "@@ -50,6 +50,7 @@ public const string AUTHENTICATION_CONTEXT = \"AUTHENTICATION_CONTEXT\";\n public const string SUPER_TENANT_DOMAIN_NAME = \"carbon.super\";\n public const int SUPER_TENANT_ID = -1234;\n public const string THROTTLE_KEY = \"throttleKey\";\n+public const string POLICY_KEY=\"policyKey\";", "originalCommit": "ca1b44be50d3ed7808756b107c3734f7aa97bcb1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTY0MzIzNg==", "url": "https://github.com/wso2/product-microgateway/pull/926#discussion_r365643236", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public const string POLICY_KEY=\"policyKey\";\n          \n          \n            \n            public const string POLICY_KEY = \"policyKey\";", "author": "praminda", "createdAt": "2020-01-13T04:17:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTY0MTUzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTY0NDE5OQ==", "url": "https://github.com/wso2/product-microgateway/pull/926#discussion_r365644199", "bodyText": "Suggested change", "author": "AmaliMatharaarachchi", "createdAt": "2020-01-13T04:25:59Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/services/throttle_event_listener.bal", "diffHunk": "@@ -59,6 +64,7 @@ service messageServ = service {\n     }\n };\n \n+", "originalCommit": "ca1b44be50d3ed7808756b107c3734f7aa97bcb1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTY0NDI5NQ==", "url": "https://github.com/wso2/product-microgateway/pull/926#discussion_r365644295", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            #x", "author": "AmaliMatharaarachchi", "createdAt": "2020-01-13T04:27:03Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/throttler/throttle_window.bal", "diffHunk": "@@ -0,0 +1,248 @@\n+// Copyright (c) 2019 WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+//\n+// WSO2 Inc. licenses this file to you under the Apache License,\n+// Version 2.0 (the \"License\"); you may not use this file except\n+// in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+// http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+import ballerina/time;\n+import ballerina/task;\n+import ballerina/streams;\n+\n+# ThrottleWindow `throttle(quota, windowSize, partitionAttr)` is a fixed rate time window, which keeps track of\n+# number of events received (per partition) for a given time period, and notifies whether that number exceeds a given\n+# quota. And this window will gets updated and emit current events for every input event.\n+#\n+# E.g.\n+#       type Request record {\n+#           string ip;\n+#           int resetTimestamp = 0;      // Since ThrottleWindow injects resetTimestamp, remainingQuota\n+#           int remainingQuota = 0;      // & isThrottled within the window, we need fields\n+#           boolean isThrottled = false; // to refer to that in selector.\n+#       };\n+#\n+#       type ThrottledRequest record{\n+#           string ip;\n+#           int? resetTimestamp;    // Since ThrottleWindow injects resetTimestamp, remainingQuota\n+#           int? remainingQuota;    // & isThrottled within the window, we need fields\n+#           boolean? isThrottled;   // to refer to that in selector.\n+#       };\n+#\n+#       stream<Request> inputStream = new;\n+#       stream<ThrottledRequest > outputStream = new;\n+#       stream<ThrottledRequest > finaloutputStream = new;\n+#\n+#       forever {\n+#           from inputStream window throttle(5, 1000, inputStream.name)\n+#           select inputStream.ip, inputStream.resetTimestamp, inputStream.remainingQuota, inputStream.isThrottled\n+#           => (ThrottledRequest [] requests) {\n+#               foreach var r in requests {\n+#                   outputStream.publish(r);\n+#               }\n+#           }\n+#       }\n+#\n+#\n+#\n+# + quota - quota limit\n+# + windowSizeInMilliSeconds - size of the window in ms\n+# + initialDelayInMilliSeconds - time until the first scheduled event\n+# + partitionAttribute - partition attribute (i.e ip address, session, etc)\n+# + windowParameters - params for the window\n+# + nextProcessPointer - next processor pointer\n+# + scheduler - scheduler which emits timer events\n+# + counts - counts map to hold current event count per partition\n+#\n+#x", "originalCommit": "ca1b44be50d3ed7808756b107c3734f7aa97bcb1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTY0NDkyOQ==", "url": "https://github.com/wso2/product-microgateway/pull/926#discussion_r365644929", "bodyText": "Fix indentation and formatting issues. You can use 'Ballerina format \"file name\"' command.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    throttleDataMap[throttleEvent.policyKey] = throttleEvent;\n          \n          \n            \n                        throttleDataMap[throttleEvent.policyKey] = throttleEvent;", "author": "AmaliMatharaarachchi", "createdAt": "2020-01-13T04:33:13Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/utils/throttle_util.bal", "diffHunk": "@@ -57,54 +57,52 @@ public function isRequestThrottled(string key) returns [boolean, boolean] {\n     printDebug(KEY_THROTTLE_UTIL, \"throttle data key : \" + key);\n     boolean isThrottled = throttleDataMap.hasKey(key);\n     if (isThrottled) {\n-        int currentTime = time:currentTime().time;\n-        GlobalThrottleStreamDTO dto = <GlobalThrottleStreamDTO>throttleDataMap[key];\n-        int timeStamp = dto.expiryTimeStamp;\n+        ThrottledRequest dto = <ThrottledRequest>throttleDataMap[key];\n         boolean stopOnQuota = dto.stopOnQuota;\n         if (enabledGlobalTMEventPublishing == true) {\n             stopOnQuota = true;\n-        }\n-        if (timeStamp >= currentTime) {\n             return [isThrottled, stopOnQuota];\n-        } else {\n-            var value = throttleDataMap.remove(key);\n-            return [false, stopOnQuota];\n         }\n+        return [isThrottled, stopOnQuota];\n     }\n     return [isThrottled, false];\n }\n \n-public function publishNonThrottleEvent(RequestStreamDTO throttleEvent) {\n+public function publishNonThrottleEvent(InputRequest throttleEvent) {\n     //Publish throttle event to traffic manager\n     if (enabledGlobalTMEventPublishing == true) {\n         publishThrottleEventToTrafficManager(throttleEvent);\n         printDebug(KEY_THROTTLE_UTIL, \"Throttle out event is sent to the traffic manager.\");\n     }\n     //Publish throttle event to internal policies\n     else {\n-        requestStream.publish(throttleEvent);\n-        printDebug(KEY_THROTTLE_UTIL, \"Request stream : \" + requestStream.toString());\n+        inputStream.publish(throttleEvent);\n+        printDebug(KEY_THROTTLE_UTIL, \"Request stream : \" + inputStream.toString());\n         printDebug(KEY_THROTTLE_UTIL, \"Throttle out event is sent to the queue.\");\n     }\n }\n \n public function initializeThrottleSubscription() {\n-    globalThrottleStream.subscribe(onReceiveThrottleEvent);\n+    outputStream.subscribe(onReceiveThrottleEvent);\n     isStreamsInitialized = true;\n     printDebug(KEY_THROTTLE_UTIL, \"Successfully subscribed global throttle stream.\");\n }\n \n-//public function getInitThrottleSubscriptionFuture() returns future<()>{\n-//return ftr;\n-//}\n-public function onReceiveThrottleEvent(GlobalThrottleStreamDTO throttleEvent) {\n-    printDebug(KEY_THROTTLE_UTIL, \"Event GlobalThrottleStream: throttleKey: \" + throttleEvent.throttleKey +\n-    \" ,isThrottled:\" + throttleEvent.isThrottled.toString() + \",expiryTimeStamp:\" + throttleEvent.expiryTimeStamp.toString());\n+\n+// insert throttleevent into the map if it is throttled other wise remove the throttle key it from the throttledata map\n+\n+public function onReceiveThrottleEvent(ThrottledRequest throttleEvent) {\n+    printDebug(KEY_THROTTLE_UTIL, \"Event OutputThrottleStream: throttleKey: \" + throttleEvent.policyKey +\n+    \" ,isThrottled:\" + throttleEvent.isThrottled.toString() );\n     if (throttleEvent.isThrottled) {\n-        throttleDataMap[throttleEvent.throttleKey] = throttleEvent;\n+        if(throttleEvent.policyKey.length() > 0  ){\n+        throttleDataMap[throttleEvent.policyKey] = throttleEvent;", "originalCommit": "ca1b44be50d3ed7808756b107c3734f7aa97bcb1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8c02cd8464492c0a9e1389477f28021e55bafe1d", "url": "https://github.com/wso2/product-microgateway/commit/8c02cd8464492c0a9e1389477f28021e55bafe1d", "message": "Refactor code with suggested changes", "committedDate": "2020-01-13T06:20:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTY1Nzg4OA==", "url": "https://github.com/wso2/product-microgateway/pull/926#discussion_r365657888", "bodyText": "default value should be true", "author": "Rajith90", "createdAt": "2020-01-13T06:23:36Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/dtos/throttle_dtos.bal", "diffHunk": "@@ -72,3 +45,36 @@ public type IntermediateStream record {\n     boolean stopOnQuota = false;\n     int expiryTimeStamp = 0;\n };\n+\n+public type RequestStreamDTO record {\n+    int resetTimestamp = 0;\n+    int remainingQuota = 0;\n+    boolean isThrottled = false;\n+    string messageID = \"\";\n+    string apiKey = \"\";\n+    string appKey = \"\";\n+    boolean stopOnQuota = false;", "originalCommit": "8c02cd8464492c0a9e1389477f28021e55bafe1d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTY1NzkyOQ==", "url": "https://github.com/wso2/product-microgateway/pull/926#discussion_r365657929", "bodyText": "default value should be true", "author": "Rajith90", "createdAt": "2020-01-13T06:23:55Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/dtos/throttle_dtos.bal", "diffHunk": "@@ -72,3 +45,36 @@ public type IntermediateStream record {\n     boolean stopOnQuota = false;\n     int expiryTimeStamp = 0;\n };\n+\n+public type RequestStreamDTO record {\n+    int resetTimestamp = 0;\n+    int remainingQuota = 0;\n+    boolean isThrottled = false;\n+    string messageID = \"\";\n+    string apiKey = \"\";\n+    string appKey = \"\";\n+    boolean stopOnQuota = false;\n+    string subscriptionKey = \"\";\n+    string policyKey = \"\";\n+    string appTier = \"\";\n+    string apiTier = \"\";\n+    string subscriptionTier = \"\";\n+    string resourceKey = \"\";\n+    string resourceTier = \"\";\n+    string userId = \"\";\n+    string apiContext = \"\";\n+    string apiVersion = \"\";\n+    string appTenant = \"\";\n+    string apiTenant = \"\";\n+    string appId = \"\";\n+    string apiName = \"\";\n+    string properties = \"\";\n+};\n+\n+public type GlobalThrottleStreamDTO record {\n+    string policyKey = \"\";\n+    boolean stopOnQuota = false;", "originalCommit": "8c02cd8464492c0a9e1389477f28021e55bafe1d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTY1ODE2NA==", "url": "https://github.com/wso2/product-microgateway/pull/926#discussion_r365658164", "bodyText": "Use the proper method name conventions", "author": "Rajith90", "createdAt": "2020-01-13T06:25:36Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/utils/throttle_util.bal", "diffHunk": "@@ -145,15 +140,14 @@ public function isPolicyExist(map<boolean> deployedPolicies, string policyName)\n     return true;\n }\n \n-public function getRequestStream() returns stream<RequestStreamDTO> {\n+public function getrequestStream() returns stream<RequestStreamDTO> {", "originalCommit": "8c02cd8464492c0a9e1389477f28021e55bafe1d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTY1ODE4NA==", "url": "https://github.com/wso2/product-microgateway/pull/926#discussion_r365658184", "bodyText": "Use the proper method name conventions", "author": "Rajith90", "createdAt": "2020-01-13T06:25:45Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/utils/throttle_util.bal", "diffHunk": "@@ -145,15 +140,14 @@ public function isPolicyExist(map<boolean> deployedPolicies, string policyName)\n     return true;\n }\n \n-public function getRequestStream() returns stream<RequestStreamDTO> {\n+public function getrequestStream() returns stream<RequestStreamDTO> {\n     return requestStream;\n }\n \n-public function getGlobalThrottleStream() returns stream<GlobalThrottleStreamDTO> {\n+public function getglobalThrottleStream() returns stream<GlobalThrottleStreamDTO> {", "originalCommit": "8c02cd8464492c0a9e1389477f28021e55bafe1d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7337ba67df43be716e10d3cf838dc00bca36be89", "url": "https://github.com/wso2/product-microgateway/commit/7337ba67df43be716e10d3cf838dc00bca36be89", "message": "Refactor code with suggested changes", "committedDate": "2020-01-13T07:59:36Z", "type": "commit"}, {"oid": "74792db2e363558cd4be93bf270828e7c1826672", "url": "https://github.com/wso2/product-microgateway/commit/74792db2e363558cd4be93bf270828e7c1826672", "message": "Merge branch 'master' of https://github.com/wso2/product-microgateway into throttle_window", "committedDate": "2020-01-13T09:08:01Z", "type": "commit"}]}