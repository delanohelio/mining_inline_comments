{"pr_number": 1322, "pr_title": "Fix #1321 - Multiple jwt issuer subscription validation issue", "pr_createdAt": "2020-07-13T13:19:07Z", "pr_url": "https://github.com/wso2/product-microgateway/pull/1322", "timeline": [{"oid": "9c6c908d7e0a2aeed6b02be44394a04ec5fa3ff1", "url": "https://github.com/wso2/product-microgateway/commit/9c6c908d7e0a2aeed6b02be44394a04ec5fa3ff1", "message": "Fix #1321 - Multiple jwt issuer subscription validation issue", "committedDate": "2020-07-13T13:17:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY1Njg1NQ==", "url": "https://github.com/wso2/product-microgateway/pull/1322#discussion_r453656855", "bodyText": "We can just return true here, right?", "author": "AmaliMatharaarachchi", "createdAt": "2020-07-13T13:40:15Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/utils/jwt_util.bal", "diffHunk": "@@ -181,7 +178,7 @@ public function handleSubscribedAPIs(string apiKeyToken, jwt:JwtPayload payload,\n                     + authenticationContext.subscriberTenantDomain);\n                 }\n                 invocationContext.attributes[AUTHENTICATION_CONTEXT] = authenticationContext;\n-                return true;\n+                isAllowed = true;", "originalCommit": "9c6c908d7e0a2aeed6b02be44394a04ec5fa3ff1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY1OTIxMQ==", "url": "https://github.com/wso2/product-microgateway/pull/1322#discussion_r453659211", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    printDebug(JWT_UTIL, \"jwt found from the jwt cache\");\n          \n          \n            \n                    printDebug(JWT_UTIL, \"jwt found from the api key cache\");", "author": "AmaliMatharaarachchi", "createdAt": "2020-07-13T13:43:39Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/utils/jwt_util.bal", "diffHunk": "@@ -197,25 +194,44 @@ public function handleSubscribedAPIs(string apiKeyToken, jwt:JwtPayload payload,\n         + authenticationContext.subscriberTenantDomain);\n     }\n     invocationContext.attributes[AUTHENTICATION_CONTEXT] = authenticationContext;\n-    return false;\n+    return isAllowed;\n }\n \n-public function getDecodedJWTPayload(string jwtToken) returns @tainted (jwt:JwtPayload | error) {\n-    //decode jwt\n-    var cachedJwt = trap <jwt:InboundJwtCacheEntry>jwtCache.get(jwtToken);\n+public function getDecodedJWTPayloadOfAPIKey(string jwtToken) returns @tainted (jwt:JwtPayload | error) {\n+    var cachedJwt = trap <jwt:InboundJwtCacheEntry>apiKeyCache.get(jwtToken);\n     if (cachedJwt is jwt:InboundJwtCacheEntry) {\n         printDebug(JWT_UTIL, \"jwt found from the jwt cache\");", "originalCommit": "9c6c908d7e0a2aeed6b02be44394a04ec5fa3ff1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY2NDA3OA==", "url": "https://github.com/wso2/product-microgateway/pull/1322#discussion_r453664078", "bodyText": "validateSubscription is false by default right? If so, why do we need to add it here?", "author": "AmaliMatharaarachchi", "createdAt": "2020-07-13T13:50:26Z", "path": "tests/src/test/resources/confs/default-test-config.conf", "diffHunk": "@@ -5,6 +5,7 @@\n \n [[jwtTokenConfig]]\n   issuer=\"https://localhost:9443/oauth2/token\"\n+  validateSubscription = false", "originalCommit": "9c6c908d7e0a2aeed6b02be44394a04ec5fa3ff1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI1NDc2MA==", "url": "https://github.com/wso2/product-microgateway/pull/1322#discussion_r454254760", "bodyText": "Now we have global config for subscriptions under security. This has been enabled in the test conf files. SO in order to override at the jwt issuer level we need to explicitly specify the subscription validation is false.", "author": "Rajith90", "createdAt": "2020-07-14T10:20:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY2NDA3OA=="}], "type": "inlineReview"}, {"oid": "f8710fb872517b2bcc8c27b9be3eb0a6b8acdace", "url": "https://github.com/wso2/product-microgateway/commit/f8710fb872517b2bcc8c27b9be3eb0a6b8acdace", "message": "Update components/micro-gateway-core/src/main/ballerina/src/gateway/utils/jwt_util.bal\n\nCo-authored-by: Amali Matharaarachchi <amalim@wso2.com>", "committedDate": "2020-07-14T10:32:48Z", "type": "commit"}]}