{"pr_number": 1268, "pr_title": "Fix #1267 - Upgrade to ballerina 1.2.4", "pr_createdAt": "2020-06-08T09:04:40Z", "pr_url": "https://github.com/wso2/product-microgateway/pull/1268", "timeline": [{"oid": "ab4c6ec31eba720b9501ca512d0f46e2bff50295", "url": "https://github.com/wso2/product-microgateway/commit/ab4c6ec31eba720b9501ca512d0f46e2bff50295", "message": "Fix #1267 - Upgrade to ballerina 1.2.4", "committedDate": "2020-06-08T09:01:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU4NDA1Mg==", "url": "https://github.com/wso2/product-microgateway/pull/1268#discussion_r436584052", "bodyText": "Always true?", "author": "praminda", "createdAt": "2020-06-08T09:58:51Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/handler_providers/oauth2_key_validation_provider.bal", "diffHunk": "@@ -274,33 +275,40 @@ public type KeyValidationServerConfig record {|\n \n function convertXmlToKeyValidationObject(xml keyValidationInfoXML) returns APIKeyValidationDto {\n     APIKeyValidationDto apiKeyValidationDto = {};\n-    apiKeyValidationDto.apiName = keyValidationInfoXML[apim:apiName].getTextValue();\n-    apiKeyValidationDto.apiPublisher = keyValidationInfoXML[apim:apiPublisher].getTextValue();\n-    apiKeyValidationDto.apiTier = keyValidationInfoXML[apim:apiTier].getTextValue();\n-    apiKeyValidationDto.applicationId = keyValidationInfoXML[apim:applicationId].getTextValue();\n-    apiKeyValidationDto.applicationName = keyValidationInfoXML[apim:applicationName].getTextValue();\n-    apiKeyValidationDto.applicationTier = keyValidationInfoXML[apim:applicationTier].getTextValue();\n-    apiKeyValidationDto.authorized = stringutils:toBoolean(keyValidationInfoXML[apim:authorized].getTextValue());\n-    apiKeyValidationDto.authorizedDomains = keyValidationInfoXML[apim:authorizedDomains].getTextValue();\n-    apiKeyValidationDto.consumerKey = keyValidationInfoXML[apim:consumerKey].getTextValue();\n-    apiKeyValidationDto.contentAware = keyValidationInfoXML[apim:contentAware].getTextValue();\n-    apiKeyValidationDto.endUserName = keyValidationInfoXML[apim:endUserName].getTextValue();\n-    apiKeyValidationDto.endUserToken = keyValidationInfoXML[apim:endUserToken].getTextValue();\n-    apiKeyValidationDto.issuedTime = keyValidationInfoXML[apim:issuedTime].getTextValue();\n-    apiKeyValidationDto.spikeArrestLimit = keyValidationInfoXML[apim:spikeArrestLimit].getTextValue();\n-    apiKeyValidationDto.spikeArrestUnit = keyValidationInfoXML[apim:spikeArrestUnit].getTextValue();\n-    apiKeyValidationDto.stopOnQuotaReach = keyValidationInfoXML[apim:stopOnQuotaReach].getTextValue();\n-    apiKeyValidationDto.subscriber = keyValidationInfoXML[apim:subscriber].getTextValue();\n-    apiKeyValidationDto.subscriberTenantDomain = keyValidationInfoXML[apim:subscriberTenantDomain].getTextValue();\n-    apiKeyValidationDto.throttlingDataList = keyValidationInfoXML[apim:throttlingDataList].getTextValue();\n-    apiKeyValidationDto.tier = keyValidationInfoXML[apim:tier].getTextValue();\n-    apiKeyValidationDto.keyType = keyValidationInfoXML[apim:'type].getTextValue();\n-    apiKeyValidationDto.userType = keyValidationInfoXML[apim:userType].getTextValue();\n-    apiKeyValidationDto.validationStatus = keyValidationInfoXML[apim:validationStatus].getTextValue();\n-    apiKeyValidationDto.validityPeriod = keyValidationInfoXML[apim:validityPeriod].getTextValue();\n+    apiKeyValidationDto.apiName = getXMLValue(keyValidationInfoXML/<apim:apiName>/*);\n+    apiKeyValidationDto.apiPublisher = getXMLValue(keyValidationInfoXML/<apim:apiPublisher>/*);\n+    apiKeyValidationDto.apiTier = getXMLValue(keyValidationInfoXML/<apim:apiTier>/*);\n+    apiKeyValidationDto.applicationId = getXMLValue(keyValidationInfoXML/<apim:applicationId>/*);\n+    apiKeyValidationDto.applicationName = getXMLValue(keyValidationInfoXML/<apim:applicationName>/*);\n+    apiKeyValidationDto.applicationTier = getXMLValue(keyValidationInfoXML/<apim:applicationTier>/*);\n+    apiKeyValidationDto.authorized = true;", "originalCommit": "ab4c6ec31eba720b9501ca512d0f46e2bff50295", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg0NTk4NQ==", "url": "https://github.com/wso2/product-microgateway/pull/1268#discussion_r437845985", "bodyText": "Yes, this method call happens only if authorised value is true", "author": "Rajith90", "createdAt": "2020-06-10T03:57:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU4NDA1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU4NDE4NQ==", "url": "https://github.com/wso2/product-microgateway/pull/1268#discussion_r436584185", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if(xmlValue is 'xml:Text){\n          \n          \n            \n                if (xmlValue is 'xml:Text) {", "author": "praminda", "createdAt": "2020-06-08T09:59:04Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/handler_providers/oauth2_key_validation_provider.bal", "diffHunk": "@@ -274,33 +275,40 @@ public type KeyValidationServerConfig record {|\n \n function convertXmlToKeyValidationObject(xml keyValidationInfoXML) returns APIKeyValidationDto {\n     APIKeyValidationDto apiKeyValidationDto = {};\n-    apiKeyValidationDto.apiName = keyValidationInfoXML[apim:apiName].getTextValue();\n-    apiKeyValidationDto.apiPublisher = keyValidationInfoXML[apim:apiPublisher].getTextValue();\n-    apiKeyValidationDto.apiTier = keyValidationInfoXML[apim:apiTier].getTextValue();\n-    apiKeyValidationDto.applicationId = keyValidationInfoXML[apim:applicationId].getTextValue();\n-    apiKeyValidationDto.applicationName = keyValidationInfoXML[apim:applicationName].getTextValue();\n-    apiKeyValidationDto.applicationTier = keyValidationInfoXML[apim:applicationTier].getTextValue();\n-    apiKeyValidationDto.authorized = stringutils:toBoolean(keyValidationInfoXML[apim:authorized].getTextValue());\n-    apiKeyValidationDto.authorizedDomains = keyValidationInfoXML[apim:authorizedDomains].getTextValue();\n-    apiKeyValidationDto.consumerKey = keyValidationInfoXML[apim:consumerKey].getTextValue();\n-    apiKeyValidationDto.contentAware = keyValidationInfoXML[apim:contentAware].getTextValue();\n-    apiKeyValidationDto.endUserName = keyValidationInfoXML[apim:endUserName].getTextValue();\n-    apiKeyValidationDto.endUserToken = keyValidationInfoXML[apim:endUserToken].getTextValue();\n-    apiKeyValidationDto.issuedTime = keyValidationInfoXML[apim:issuedTime].getTextValue();\n-    apiKeyValidationDto.spikeArrestLimit = keyValidationInfoXML[apim:spikeArrestLimit].getTextValue();\n-    apiKeyValidationDto.spikeArrestUnit = keyValidationInfoXML[apim:spikeArrestUnit].getTextValue();\n-    apiKeyValidationDto.stopOnQuotaReach = keyValidationInfoXML[apim:stopOnQuotaReach].getTextValue();\n-    apiKeyValidationDto.subscriber = keyValidationInfoXML[apim:subscriber].getTextValue();\n-    apiKeyValidationDto.subscriberTenantDomain = keyValidationInfoXML[apim:subscriberTenantDomain].getTextValue();\n-    apiKeyValidationDto.throttlingDataList = keyValidationInfoXML[apim:throttlingDataList].getTextValue();\n-    apiKeyValidationDto.tier = keyValidationInfoXML[apim:tier].getTextValue();\n-    apiKeyValidationDto.keyType = keyValidationInfoXML[apim:'type].getTextValue();\n-    apiKeyValidationDto.userType = keyValidationInfoXML[apim:userType].getTextValue();\n-    apiKeyValidationDto.validationStatus = keyValidationInfoXML[apim:validationStatus].getTextValue();\n-    apiKeyValidationDto.validityPeriod = keyValidationInfoXML[apim:validityPeriod].getTextValue();\n+    apiKeyValidationDto.apiName = getXMLValue(keyValidationInfoXML/<apim:apiName>/*);\n+    apiKeyValidationDto.apiPublisher = getXMLValue(keyValidationInfoXML/<apim:apiPublisher>/*);\n+    apiKeyValidationDto.apiTier = getXMLValue(keyValidationInfoXML/<apim:apiTier>/*);\n+    apiKeyValidationDto.applicationId = getXMLValue(keyValidationInfoXML/<apim:applicationId>/*);\n+    apiKeyValidationDto.applicationName = getXMLValue(keyValidationInfoXML/<apim:applicationName>/*);\n+    apiKeyValidationDto.applicationTier = getXMLValue(keyValidationInfoXML/<apim:applicationTier>/*);\n+    apiKeyValidationDto.authorized = true;\n+    apiKeyValidationDto.authorizedDomains = getXMLValue(keyValidationInfoXML/<apim:authorizedDomains>/*);\n+    apiKeyValidationDto.consumerKey = getXMLValue(keyValidationInfoXML/<apim:consumerKey>/*);\n+    apiKeyValidationDto.contentAware = getXMLValue(keyValidationInfoXML/<apim:contentAware>/*);\n+    apiKeyValidationDto.endUserName = getXMLValue(keyValidationInfoXML/<apim:endUserName>/*);\n+    apiKeyValidationDto.endUserToken = getXMLValue(keyValidationInfoXML/<apim:endUserToken>/*);\n+    apiKeyValidationDto.issuedTime = getXMLValue(keyValidationInfoXML/<apim:issuedTime>/*);\n+    apiKeyValidationDto.spikeArrestLimit = getXMLValue(keyValidationInfoXML/<apim:spikeArrestLimit>/*);\n+    apiKeyValidationDto.spikeArrestUnit = getXMLValue(keyValidationInfoXML/<apim:spikeArrestUnit>/*);\n+    apiKeyValidationDto.stopOnQuotaReach = getXMLValue(keyValidationInfoXML/<apim:stopOnQuotaReach>/*);\n+    apiKeyValidationDto.subscriber = getXMLValue(keyValidationInfoXML/<apim:subscriber>/*);\n+    apiKeyValidationDto.subscriberTenantDomain = getXMLValue(keyValidationInfoXML/<apim:subscriberTenantDomain>/*);\n+    apiKeyValidationDto.throttlingDataList = getXMLValue(keyValidationInfoXML/<apim:throttlingDataList>/*);\n+    apiKeyValidationDto.tier = getXMLValue(keyValidationInfoXML/<apim:tier>/*);\n+    apiKeyValidationDto.keyType = getXMLValue(keyValidationInfoXML/<apim:'type>/*);\n+    apiKeyValidationDto.userType = getXMLValue(keyValidationInfoXML/<apim:userType>/*);\n+    apiKeyValidationDto.validationStatus = getXMLValue(keyValidationInfoXML/<apim:validationStatus>/*);\n+    apiKeyValidationDto.validityPeriod = getXMLValue(keyValidationInfoXML/<apim:validityPeriod>/*);\n     return apiKeyValidationDto;\n }\n \n+function getXMLValue(xml xmlValue) returns string {\n+    if(xmlValue is 'xml:Text){", "originalCommit": "ab4c6ec31eba720b9501ca512d0f46e2bff50295", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU4NDI5Mg==", "url": "https://github.com/wso2/product-microgateway/pull/1268#discussion_r436584292", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if(err is error) {\n          \n          \n            \n                        if (err is error) {", "author": "praminda", "createdAt": "2020-06-08T09:59:18Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/handlers/jwt_auth_handler.bal", "diffHunk": "@@ -336,7 +336,10 @@ public function setJWTHeader(jwt:JwtPayload payload,\n \n         // add to cache if cache enabled\n         if (enabledCaching) {\n-            jwtGeneratorCache.put(cacheKey, generatedToken.toString());\n+            error? err = jwtGeneratorCache.put(<@untainted>cacheKey, <@untainted>generatedToken.toString());\n+            if(err is error) {", "originalCommit": "ab4c6ec31eba720b9501ca512d0f46e2bff50295", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjU4NzM1Mw==", "url": "https://github.com/wso2/product-microgateway/pull/1268#discussion_r436587353", "bodyText": "Can't we pass this from initAuthHandlers to here? without reading the same config twise in the same flow?", "author": "praminda", "createdAt": "2020-06-08T10:05:08Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/utils/utils.bal", "diffHunk": "@@ -907,11 +911,15 @@ function readMultipleJWTIssuers() {\n         printDebug(KEY_UTILS, \"Found new multiple JWT issuer configs\");\n         string trustStorePath = getConfigValue(LISTENER_CONF_INSTANCE_ID, TRUST_STORE_PATH, DEFAULT_TRUST_STORE_PATH);\n         string trustStorePassword = getConfigValue(LISTENER_CONF_INSTANCE_ID, TRUST_STORE_PASSWORD, DEFAULT_TRUST_STORE_PASSWORD);\n+        int timestampSkew = getConfigIntValue(SERVER_CONF_ID, SERVER_TIMESTAMP_SKEW, DEFAULT_SERVER_TIMESTAMP_SKEW);", "originalCommit": "ab4c6ec31eba720b9501ca512d0f46e2bff50295", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ec2ab1febf3056b9daf3fb3f5907bf6e9400d677", "url": "https://github.com/wso2/product-microgateway/commit/ec2ab1febf3056b9daf3fb3f5907bf6e9400d677", "message": "Resolve merge conflicts", "committedDate": "2020-06-09T16:46:40Z", "type": "commit"}, {"oid": "b998d80c48c63f30eda9b756b1be52ff8374984f", "url": "https://github.com/wso2/product-microgateway/commit/b998d80c48c63f30eda9b756b1be52ff8374984f", "message": "Fix formatting issues", "committedDate": "2020-06-10T04:15:44Z", "type": "commit"}]}