{"pr_number": 1330, "pr_title": "Backend JWT generation compatible with OAuth2 flow and API Manager non selfcontained JWT Token", "pr_createdAt": "2020-07-15T16:08:15Z", "pr_url": "https://github.com/wso2/product-microgateway/pull/1330", "timeline": [{"oid": "9f25c8e22530a1d10ecf4d3a07870740ab416b06", "url": "https://github.com/wso2/product-microgateway/commit/9f25c8e22530a1d10ecf4d3a07870740ab416b06", "message": "Backend JWT generation compatible for OAuth2 and 3.2.0 API Manger JWT Token", "committedDate": "2020-07-15T16:59:53Z", "type": "commit"}, {"oid": "9f25c8e22530a1d10ecf4d3a07870740ab416b06", "url": "https://github.com/wso2/product-microgateway/commit/9f25c8e22530a1d10ecf4d3a07870740ab416b06", "message": "Backend JWT generation compatible for OAuth2 and 3.2.0 API Manger JWT Token", "committedDate": "2020-07-15T16:59:53Z", "type": "forcePushed"}, {"oid": "62ff7ad8499cd04fb67368a547da5396764f33b9", "url": "https://github.com/wso2/product-microgateway/commit/62ff7ad8499cd04fb67368a547da5396764f33b9", "message": "refactor code", "committedDate": "2020-07-16T04:16:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUwMTIwNw==", "url": "https://github.com/wso2/product-microgateway/pull/1330#discussion_r455501207", "bodyText": "Move the class loading to jwtgenerator class loading location", "author": "VirajSalaka", "createdAt": "2020-07-16T04:21:21Z", "path": "components/micro-gateway-cli/src/main/resources/templates/main.mustache", "diffHunk": "@@ -29,6 +29,7 @@ public function main() {\n     gateway:initThrottleDataPublisher();\n     gateway:initGlobalThrottleDataPublisher();\n     gateway:startObservabilityListener();\n+    gateway:loadClaimRetrieverImpl();", "originalCommit": "62ff7ad8499cd04fb67368a547da5396764f33b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUwMjI1Mw==", "url": "https://github.com/wso2/product-microgateway/pull/1330#discussion_r455502253", "bodyText": "No need to check if map is empty, to provide user the capability to add additional properties to the existing apim credentials", "author": "VirajSalaka", "createdAt": "2020-07-16T04:25:37Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/jwt_generator/claim_retriever.bal", "diffHunk": "@@ -0,0 +1,136 @@\n+// Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+//\n+// WSO2 Inc. licenses this file to you under the Apache License,\n+// Version 2.0 (the \"License\"); you may not use this file except\n+// in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+// http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+import ballerina/jwt;\n+import ballerina/runtime;\n+\n+boolean claimRetrieveEnabled = true;\n+\n+# To retrieve claims via the user specific claim retrieve implementation.\n+# \n+# + userInfo - Authentication Context of the user, which is provided as input to the claim retriever Implementation\n+# + return - ClaimListDTO if there are any claims added from the user specific implementation\n+function retrieveClaims (UserAuthContextDTO? userInfo) returns @tainted RetrievedUserClaimsListDTO ? {\n+    //if claim retrieve variable is disabled, there is no need to run through the method.\n+    if (!claimRetrieveEnabled) {\n+        return;\n+    }\n+    if (userInfo is UserAuthContextDTO) {\n+        printDebug (CLAIM_RETRIEVER, \"User Auth Context information provided to the claim retrieval implementation : \" +\n+                    userInfo.toString());\n+        RetrievedUserClaimsListDTO? | error claimListDTO = trap retrieveClaimsFromImpl(userInfo);\n+        if (claimListDTO is RetrievedUserClaimsListDTO ) {\n+            printDebug (CLAIM_RETRIEVER, \"Claims List received from the claim retrieval implementation : \" +\n+                        claimListDTO.toString());\n+            return claimListDTO;\n+        } else if (claimListDTO is ()) {\n+            printDebug(CLAIM_RETRIEVER , \"No user claims are received from the claim retrieval implementation\");\n+        } else {\n+            printError(CLAIM_RETRIEVER , \"Error while retrieving user claims from the claim retrieval implementation\",\n+                claimListDTO);\n+        }\n+    }\n+}\n+\n+# To do the class loading operation for the user specific claim retriever implementation.\n+public function loadClaimRetrieverImpl() {\n+    \n+    //todo: bring a configuration if required\n+    if (!isConfigAvailable(JWT_GENERATOR__CLAIM_RETRIEVAL_INSTANCE_ID, JWT_GENERATOR_CLAIM_RETRIEVAL_IMPLEMENTATION)) {\n+        printDebug(CLAIM_RETRIEVER, \"Claim Retrieval related class loading is disabled as the implementation is not provided.\" +  \n+                    \"Hence claim retrieval is disabled\");\n+        claimRetrieveEnabled = false;            \n+        return;\n+    }\n+\n+    string claimRetrieverImplClassName = getConfigValue(JWT_GENERATOR__CLAIM_RETRIEVAL_INSTANCE_ID,\n+                                                        JWT_GENERATOR_CLAIM_RETRIEVAL_IMPLEMENTATION,\n+                                                        DEFAULT_JWT_GENERATOR_CLAIM_RETRIEVAL_IMPLEMENTATION);\n+    map<any> claimRetrieverConfig = getConfigMapValue(JWT_GENERATOR_CLAIM_RETRIEVAL_CONFIGURATION);\n+\n+    if (claimRetrieverConfig.length() == 0) {", "originalCommit": "62ff7ad8499cd04fb67368a547da5396764f33b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUwMzA2NQ==", "url": "https://github.com/wso2/product-microgateway/pull/1330#discussion_r455503065", "bodyText": "Remove this, as it is unused", "author": "VirajSalaka", "createdAt": "2020-07-16T04:29:06Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/constants/micro_gw_conf_defaults.bal", "diffHunk": "@@ -186,5 +190,13 @@ public const int DEFAULT_JWT_GENERATOR_TOKEN_EXPIRY = 900000;\n public const string DEFAULT_JWT_GENERATOR_TOKEN_ISSUER = \"wso2.org/products/am\";\n public const string DEFAULT_JWT_GENERATOR_IMPLEMENTATION = \"org.wso2.micro.gateway.jwt.generator.MGWJWTGeneratorImpl\";\n public const boolean DEFAULT_JWT_GENERATOR_TOKEN_CACHE_ENABLED = true;\n+public const string DEFAULT_JWT_GENERATOR_USERNAME = \"admin\";", "originalCommit": "62ff7ad8499cd04fb67368a547da5396764f33b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUwNzc5OA==", "url": "https://github.com/wso2/product-microgateway/pull/1330#discussion_r455507798", "bodyText": "Move this method as we dont need this unless the backend jwt generation is enabled.", "author": "VirajSalaka", "createdAt": "2020-07-16T04:48:14Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/handlers/token_introspection_handler.bal", "diffHunk": "@@ -95,14 +96,37 @@ public type KeyValidationHandler object {\n                    [authenticationContext, isAllowed] =\n                      validateSubscriptionFromDataStores(credential, clientId, apiName, apiVersion,\n                      self.validateSubscriptions);\n-                    authenticationContext.username = principal?.username ?: USER_NAME_UNKNOWN;\n-                    invocationContext.attributes[AUTHENTICATION_CONTEXT] = authenticationContext;\n-                    invocationContext.attributes[KEY_TYPE_ATTR] = authenticationContext.keyType;\n+                   authenticationContext.username = principal?.username ?: USER_NAME_UNKNOWN;\n+                   invocationContext.attributes[AUTHENTICATION_CONTEXT] = authenticationContext;\n+                   invocationContext.attributes[KEY_TYPE_ATTR] = authenticationContext.keyType;\n+                   if (isAllowed) {\n+                       map<string> apiDetails = createAPIDetailsMap(invocationContext);", "originalCommit": "62ff7ad8499cd04fb67368a547da5396764f33b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bc83f918471d1e8365eca5bfb7c08f6cb951ea7c", "url": "https://github.com/wso2/product-microgateway/commit/bc83f918471d1e8365eca5bfb7c08f6cb951ea7c", "message": "bug fix - oauth2 backend jwt token cache", "committedDate": "2020-07-16T05:22:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUxOTI2MA==", "url": "https://github.com/wso2/product-microgateway/pull/1330#discussion_r455519260", "bodyText": "Avoid redundant code", "author": "VirajSalaka", "createdAt": "2020-07-16T05:31:35Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/handlers/token_introspection_handler.bal", "diffHunk": "@@ -95,14 +96,38 @@ public type KeyValidationHandler object {\n                    [authenticationContext, isAllowed] =\n                      validateSubscriptionFromDataStores(credential, clientId, apiName, apiVersion,\n                      self.validateSubscriptions);\n-                    authenticationContext.username = principal?.username ?: USER_NAME_UNKNOWN;\n-                    invocationContext.attributes[AUTHENTICATION_CONTEXT] = authenticationContext;\n-                    invocationContext.attributes[KEY_TYPE_ATTR] = authenticationContext.keyType;\n+                   authenticationContext.username = principal?.username ?: USER_NAME_UNKNOWN;\n+                   invocationContext.attributes[AUTHENTICATION_CONTEXT] = authenticationContext;\n+                   invocationContext.attributes[KEY_TYPE_ATTR] = authenticationContext.keyType;\n+                   if (isAllowed) {\n+                       boolean enabledJWTGenerator = getConfigBooleanValue(JWT_GENERATOR_ID,\n+                                                                            JWT_GENERATOR_ENABLED,\n+                                                                            DEFAULT_JWT_GENERATOR_ENABLED);\n+                       if (enabledJWTGenerator) {\n+                           string cacheKey = credential + apiName + apiVersion;\n+                           boolean tokenGenStatus = setJWTHeaderForOauth2(req, authenticationContext, cacheKey);\n+                           if (!tokenGenStatus) {\n+                               printError(KEY_AUTHN_FILTER, \"Error while adding the Backend JWT header\");\n+                           }\n+                       }\n+                   }\n                    return isAllowed;    \n                 } else { // Otherwise return the introspection response.\n                     authenticationContext.username = principal?.username ?: USER_NAME_UNKNOWN;\n                     invocationContext.attributes[AUTHENTICATION_CONTEXT] = authenticationContext;\n                     invocationContext.attributes[KEY_TYPE_ATTR] = authenticationContext.keyType;\n+                    if (authenticationResult) {", "originalCommit": "bc83f918471d1e8365eca5bfb7c08f6cb951ea7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUxOTM4Mw==", "url": "https://github.com/wso2/product-microgateway/pull/1330#discussion_r455519383", "bodyText": "Move this to jwt auth handler.", "author": "VirajSalaka", "createdAt": "2020-07-16T05:32:00Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/jwt_generator/jwt_gen_util.bal", "diffHunk": "@@ -0,0 +1,204 @@\n+// Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+//\n+// WSO2 Inc. licenses this file to you under the Apache License,\n+// Version 2.0 (the \"License\"); you may not use this file except\n+// in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+// http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+import ballerina/runtime;\n+import ballerina/jwt;\n+import ballerina/http;\n+\n+# Refactoring method for setting JWT header\n+#\n+# + payload - The payload of the authentication token\n+# + req - The `Request` instance.\n+# + cacheKey - key for the jwt generator cache\n+# + enabledCaching - jwt generator caching enabled\n+# + apiDetails - extracted api details for the current api\n+# + remoteUserClaimRetrievalEnabled - true if remoteUserClaimRetrieval is enabled\n+# + return - Returns `true` if the token generation and setting the header completed successfully\n+# or the `AuthenticationError` in case of an error.\n+public function setJWTHeader(jwt:JwtPayload payload,", "originalCommit": "bc83f918471d1e8365eca5bfb7c08f6cb951ea7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUyMDE2Nw==", "url": "https://github.com/wso2/product-microgateway/pull/1330#discussion_r455520167", "bodyText": "rename both method and dto to : userClamimRetrieverContext", "author": "VirajSalaka", "createdAt": "2020-07-16T05:34:48Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/jwt_generator/claim_retriever.bal", "diffHunk": "@@ -0,0 +1,136 @@\n+// Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+//\n+// WSO2 Inc. licenses this file to you under the Apache License,\n+// Version 2.0 (the \"License\"); you may not use this file except\n+// in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+// http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+import ballerina/jwt;\n+import ballerina/runtime;\n+\n+boolean claimRetrieveEnabled = true;\n+\n+# To retrieve claims via the user specific claim retrieve implementation.\n+# \n+# + userInfo - Authentication Context of the user, which is provided as input to the claim retriever Implementation\n+# + return - ClaimListDTO if there are any claims added from the user specific implementation\n+function retrieveClaims (UserAuthContextDTO? userInfo) returns @tainted RetrievedUserClaimsListDTO ? {\n+    //if claim retrieve variable is disabled, there is no need to run through the method.\n+    if (!claimRetrieveEnabled) {\n+        return;\n+    }\n+    if (userInfo is UserAuthContextDTO) {\n+        printDebug (CLAIM_RETRIEVER, \"User Auth Context information provided to the claim retrieval implementation : \" +\n+                    userInfo.toString());\n+        RetrievedUserClaimsListDTO? | error claimListDTO = trap retrieveClaimsFromImpl(userInfo);\n+        if (claimListDTO is RetrievedUserClaimsListDTO ) {\n+            printDebug (CLAIM_RETRIEVER, \"Claims List received from the claim retrieval implementation : \" +\n+                        claimListDTO.toString());\n+            return claimListDTO;\n+        } else if (claimListDTO is ()) {\n+            printDebug(CLAIM_RETRIEVER , \"No user claims are received from the claim retrieval implementation\");\n+        } else {\n+            printError(CLAIM_RETRIEVER , \"Error while retrieving user claims from the claim retrieval implementation\",\n+                claimListDTO);\n+        }\n+    }\n+}\n+\n+# To do the class loading operation for the user specific claim retriever implementation.\n+public function loadClaimRetrieverImpl() {\n+    \n+    //todo: bring a configuration if required\n+    if (!isConfigAvailable(JWT_GENERATOR__CLAIM_RETRIEVAL_INSTANCE_ID, JWT_GENERATOR_CLAIM_RETRIEVAL_IMPLEMENTATION)) {\n+        printDebug(CLAIM_RETRIEVER, \"Claim Retrieval related class loading is disabled as the implementation is not provided.\" +  \n+                    \"Hence claim retrieval is disabled\");\n+        claimRetrieveEnabled = false;            \n+        return;\n+    }\n+\n+    string claimRetrieverImplClassName = getConfigValue(JWT_GENERATOR__CLAIM_RETRIEVAL_INSTANCE_ID,\n+                                                        JWT_GENERATOR_CLAIM_RETRIEVAL_IMPLEMENTATION,\n+                                                        DEFAULT_JWT_GENERATOR_CLAIM_RETRIEVAL_IMPLEMENTATION);\n+    map<any> claimRetrieverConfig = getConfigMapValue(JWT_GENERATOR_CLAIM_RETRIEVAL_CONFIGURATION);\n+\n+    if (claimRetrieverConfig.length() == 0) {\n+        string username = getConfigValue(APIM_CREDENTIALS_INSTANCE_ID, APIM_CREDENTIALS_USERNAME,\n+                            DEFAULT_APIM_CREDENTIALS_USERNAME);\n+        string password = getConfigValue(APIM_CREDENTIALS_INSTANCE_ID, APIM_CREDENTIALS_PASSWORD,\n+                            DEFAULT_APIM_CREDENTIALS_PASSWORD);\n+        string keyManagerURL = getConfigValue(KM_CONF_INSTANCE_ID, KM_SERVER_URL, DEFAULT_KM_SERVER_URL);\n+        claimRetrieverConfig[APIM_CREDENTIALS_USERNAME] = username;\n+        claimRetrieverConfig[APIM_CREDENTIALS_PASSWORD] = password;\n+        claimRetrieverConfig[KM_SERVER_URL] = keyManagerURL;\n+    }\n+\n+    boolean claimRetrieveClassLoaded =\n+                        loadClaimRetrieverClass(claimRetrieverImplClassName, claimRetrieverConfig);\n+    if (claimRetrieveClassLoaded) {\n+        printDebug(CLAIM_RETRIEVER, \"JWT Claim Retriever Classloading is successful.\");\n+    } else {\n+        printError(CLAIM_RETRIEVER, \"Claim Retriever classloading is failed. Hence claim retrieval process is disabled\");\n+        //If the classloading is failed, the configuration is set to disabled.\n+        claimRetrieveEnabled = false;\n+    }\n+}\n+\n+# Populate the DTO required for the claim retrieval implementation from authContext and principal component.\n+# \n+# + authContext - Authentication Context\n+# + principal - Principal component\n+# + return - populated UserAuthContextDTO\n+function generateAuthContextInfoFromPrincipal(AuthenticationContext authContext, runtime:Principal principal)", "originalCommit": "bc83f918471d1e8365eca5bfb7c08f6cb951ea7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUyMDQ2Nw==", "url": "https://github.com/wso2/product-microgateway/pull/1330#discussion_r455520467", "bodyText": "opaque", "author": "VirajSalaka", "createdAt": "2020-07-16T05:35:37Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/jwt_generator/claim_retriever.bal", "diffHunk": "@@ -0,0 +1,136 @@\n+// Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+//\n+// WSO2 Inc. licenses this file to you under the Apache License,\n+// Version 2.0 (the \"License\"); you may not use this file except\n+// in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+// http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+import ballerina/jwt;\n+import ballerina/runtime;\n+\n+boolean claimRetrieveEnabled = true;\n+\n+# To retrieve claims via the user specific claim retrieve implementation.\n+# \n+# + userInfo - Authentication Context of the user, which is provided as input to the claim retriever Implementation\n+# + return - ClaimListDTO if there are any claims added from the user specific implementation\n+function retrieveClaims (UserAuthContextDTO? userInfo) returns @tainted RetrievedUserClaimsListDTO ? {\n+    //if claim retrieve variable is disabled, there is no need to run through the method.\n+    if (!claimRetrieveEnabled) {\n+        return;\n+    }\n+    if (userInfo is UserAuthContextDTO) {\n+        printDebug (CLAIM_RETRIEVER, \"User Auth Context information provided to the claim retrieval implementation : \" +\n+                    userInfo.toString());\n+        RetrievedUserClaimsListDTO? | error claimListDTO = trap retrieveClaimsFromImpl(userInfo);\n+        if (claimListDTO is RetrievedUserClaimsListDTO ) {\n+            printDebug (CLAIM_RETRIEVER, \"Claims List received from the claim retrieval implementation : \" +\n+                        claimListDTO.toString());\n+            return claimListDTO;\n+        } else if (claimListDTO is ()) {\n+            printDebug(CLAIM_RETRIEVER , \"No user claims are received from the claim retrieval implementation\");\n+        } else {\n+            printError(CLAIM_RETRIEVER , \"Error while retrieving user claims from the claim retrieval implementation\",\n+                claimListDTO);\n+        }\n+    }\n+}\n+\n+# To do the class loading operation for the user specific claim retriever implementation.\n+public function loadClaimRetrieverImpl() {\n+    \n+    //todo: bring a configuration if required\n+    if (!isConfigAvailable(JWT_GENERATOR__CLAIM_RETRIEVAL_INSTANCE_ID, JWT_GENERATOR_CLAIM_RETRIEVAL_IMPLEMENTATION)) {\n+        printDebug(CLAIM_RETRIEVER, \"Claim Retrieval related class loading is disabled as the implementation is not provided.\" +  \n+                    \"Hence claim retrieval is disabled\");\n+        claimRetrieveEnabled = false;            \n+        return;\n+    }\n+\n+    string claimRetrieverImplClassName = getConfigValue(JWT_GENERATOR__CLAIM_RETRIEVAL_INSTANCE_ID,\n+                                                        JWT_GENERATOR_CLAIM_RETRIEVAL_IMPLEMENTATION,\n+                                                        DEFAULT_JWT_GENERATOR_CLAIM_RETRIEVAL_IMPLEMENTATION);\n+    map<any> claimRetrieverConfig = getConfigMapValue(JWT_GENERATOR_CLAIM_RETRIEVAL_CONFIGURATION);\n+\n+    if (claimRetrieverConfig.length() == 0) {\n+        string username = getConfigValue(APIM_CREDENTIALS_INSTANCE_ID, APIM_CREDENTIALS_USERNAME,\n+                            DEFAULT_APIM_CREDENTIALS_USERNAME);\n+        string password = getConfigValue(APIM_CREDENTIALS_INSTANCE_ID, APIM_CREDENTIALS_PASSWORD,\n+                            DEFAULT_APIM_CREDENTIALS_PASSWORD);\n+        string keyManagerURL = getConfigValue(KM_CONF_INSTANCE_ID, KM_SERVER_URL, DEFAULT_KM_SERVER_URL);\n+        claimRetrieverConfig[APIM_CREDENTIALS_USERNAME] = username;\n+        claimRetrieverConfig[APIM_CREDENTIALS_PASSWORD] = password;\n+        claimRetrieverConfig[KM_SERVER_URL] = keyManagerURL;\n+    }\n+\n+    boolean claimRetrieveClassLoaded =\n+                        loadClaimRetrieverClass(claimRetrieverImplClassName, claimRetrieverConfig);\n+    if (claimRetrieveClassLoaded) {\n+        printDebug(CLAIM_RETRIEVER, \"JWT Claim Retriever Classloading is successful.\");\n+    } else {\n+        printError(CLAIM_RETRIEVER, \"Claim Retriever classloading is failed. Hence claim retrieval process is disabled\");\n+        //If the classloading is failed, the configuration is set to disabled.\n+        claimRetrieveEnabled = false;\n+    }\n+}\n+\n+# Populate the DTO required for the claim retrieval implementation from authContext and principal component.\n+# \n+# + authContext - Authentication Context\n+# + principal - Principal component\n+# + return - populated UserAuthContextDTO\n+function generateAuthContextInfoFromPrincipal(AuthenticationContext authContext, runtime:Principal principal)\n+        returns UserAuthContextDTO {\n+    UserAuthContextDTO userAuthContextDTO = {};\n+    userAuthContextDTO.username = principal?.username ?: UNKNOWN_VALUE;\n+    userAuthContextDTO.token_type = \"oauth2\";", "originalCommit": "bc83f918471d1e8365eca5bfb7c08f6cb951ea7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUyMDg5OQ==", "url": "https://github.com/wso2/product-microgateway/pull/1330#discussion_r455520899", "bodyText": "rename token_type to just \"type\"", "author": "VirajSalaka", "createdAt": "2020-07-16T05:37:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUyMDQ2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUyMTYzOQ==", "url": "https://github.com/wso2/product-microgateway/pull/1330#discussion_r455521639", "bodyText": "avoid config reading inside methods.", "author": "VirajSalaka", "createdAt": "2020-07-16T05:40:05Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/jwt_generator/claim_retriever.bal", "diffHunk": "@@ -0,0 +1,136 @@\n+// Copyright (c) 2020, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.\n+//\n+// WSO2 Inc. licenses this file to you under the Apache License,\n+// Version 2.0 (the \"License\"); you may not use this file except\n+// in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+// http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+import ballerina/jwt;\n+import ballerina/runtime;\n+\n+boolean claimRetrieveEnabled = true;\n+\n+# To retrieve claims via the user specific claim retrieve implementation.\n+# \n+# + userInfo - Authentication Context of the user, which is provided as input to the claim retriever Implementation\n+# + return - ClaimListDTO if there are any claims added from the user specific implementation\n+function retrieveClaims (UserAuthContextDTO? userInfo) returns @tainted RetrievedUserClaimsListDTO ? {\n+    //if claim retrieve variable is disabled, there is no need to run through the method.\n+    if (!claimRetrieveEnabled) {\n+        return;\n+    }\n+    if (userInfo is UserAuthContextDTO) {\n+        printDebug (CLAIM_RETRIEVER, \"User Auth Context information provided to the claim retrieval implementation : \" +\n+                    userInfo.toString());\n+        RetrievedUserClaimsListDTO? | error claimListDTO = trap retrieveClaimsFromImpl(userInfo);\n+        if (claimListDTO is RetrievedUserClaimsListDTO ) {\n+            printDebug (CLAIM_RETRIEVER, \"Claims List received from the claim retrieval implementation : \" +\n+                        claimListDTO.toString());\n+            return claimListDTO;\n+        } else if (claimListDTO is ()) {\n+            printDebug(CLAIM_RETRIEVER , \"No user claims are received from the claim retrieval implementation\");\n+        } else {\n+            printError(CLAIM_RETRIEVER , \"Error while retrieving user claims from the claim retrieval implementation\",\n+                claimListDTO);\n+        }\n+    }\n+}\n+\n+# To do the class loading operation for the user specific claim retriever implementation.\n+public function loadClaimRetrieverImpl() {\n+    \n+    //todo: bring a configuration if required\n+    if (!isConfigAvailable(JWT_GENERATOR__CLAIM_RETRIEVAL_INSTANCE_ID, JWT_GENERATOR_CLAIM_RETRIEVAL_IMPLEMENTATION)) {\n+        printDebug(CLAIM_RETRIEVER, \"Claim Retrieval related class loading is disabled as the implementation is not provided.\" +  \n+                    \"Hence claim retrieval is disabled\");\n+        claimRetrieveEnabled = false;            \n+        return;\n+    }\n+\n+    string claimRetrieverImplClassName = getConfigValue(JWT_GENERATOR__CLAIM_RETRIEVAL_INSTANCE_ID,\n+                                                        JWT_GENERATOR_CLAIM_RETRIEVAL_IMPLEMENTATION,\n+                                                        DEFAULT_JWT_GENERATOR_CLAIM_RETRIEVAL_IMPLEMENTATION);\n+    map<any> claimRetrieverConfig = getConfigMapValue(JWT_GENERATOR_CLAIM_RETRIEVAL_CONFIGURATION);\n+\n+    if (claimRetrieverConfig.length() == 0) {\n+        string username = getConfigValue(APIM_CREDENTIALS_INSTANCE_ID, APIM_CREDENTIALS_USERNAME,\n+                            DEFAULT_APIM_CREDENTIALS_USERNAME);\n+        string password = getConfigValue(APIM_CREDENTIALS_INSTANCE_ID, APIM_CREDENTIALS_PASSWORD,\n+                            DEFAULT_APIM_CREDENTIALS_PASSWORD);\n+        string keyManagerURL = getConfigValue(KM_CONF_INSTANCE_ID, KM_SERVER_URL, DEFAULT_KM_SERVER_URL);\n+        claimRetrieverConfig[APIM_CREDENTIALS_USERNAME] = username;\n+        claimRetrieverConfig[APIM_CREDENTIALS_PASSWORD] = password;\n+        claimRetrieverConfig[KM_SERVER_URL] = keyManagerURL;\n+    }\n+\n+    boolean claimRetrieveClassLoaded =\n+                        loadClaimRetrieverClass(claimRetrieverImplClassName, claimRetrieverConfig);\n+    if (claimRetrieveClassLoaded) {\n+        printDebug(CLAIM_RETRIEVER, \"JWT Claim Retriever Classloading is successful.\");\n+    } else {\n+        printError(CLAIM_RETRIEVER, \"Claim Retriever classloading is failed. Hence claim retrieval process is disabled\");\n+        //If the classloading is failed, the configuration is set to disabled.\n+        claimRetrieveEnabled = false;\n+    }\n+}\n+\n+# Populate the DTO required for the claim retrieval implementation from authContext and principal component.\n+# \n+# + authContext - Authentication Context\n+# + principal - Principal component\n+# + return - populated UserAuthContextDTO\n+function generateAuthContextInfoFromPrincipal(AuthenticationContext authContext, runtime:Principal principal)\n+        returns UserAuthContextDTO {\n+    UserAuthContextDTO userAuthContextDTO = {};\n+    userAuthContextDTO.username = principal?.username ?: UNKNOWN_VALUE;\n+    userAuthContextDTO.token_type = \"oauth2\";\n+    userAuthContextDTO.issuer = getConfigValue(KM_CONF_INSTANCE_ID, KM_CONF_ISSUER, DEFAULT_KM_CONF_ISSUER);", "originalCommit": "bc83f918471d1e8365eca5bfb7c08f6cb951ea7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTUyNjM3OA==", "url": "https://github.com/wso2/product-microgateway/pull/1330#discussion_r455526378", "bodyText": "state that bydefault this is not occupied", "author": "VirajSalaka", "createdAt": "2020-07-16T05:55:52Z", "path": "distribution/resources/conf/default-micro-gw.conf.template", "diffHunk": "@@ -446,6 +454,12 @@\n   audience=[\"http://org.wso2.apimgt/gateway\"]\n   # JWT token generator implementation\n   generatorImpl=\"org.wso2.micro.gateway.jwt.generator.MGWJWTGeneratorImpl\"\n+  [jwtGeneratorConfig.claimRetrieval]\n+      //todo: add the sample implementation to retrieve claims from API Manager", "originalCommit": "bc83f918471d1e8365eca5bfb7c08f6cb951ea7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9d4ffae1d6bc16bba150d18fc8373f281bd6cd8a", "url": "https://github.com/wso2/product-microgateway/commit/9d4ffae1d6bc16bba150d18fc8373f281bd6cd8a", "message": "refactor code : move jwt generator related methods jwt handler", "committedDate": "2020-07-16T06:40:11Z", "type": "commit"}, {"oid": "ef72eb408eb0e739ce7f2aac4d43f0e561ecb829", "url": "https://github.com/wso2/product-microgateway/commit/ef72eb408eb0e739ce7f2aac4d43f0e561ecb829", "message": "bug fix: jwt token cache is not used in the opaque token flow", "committedDate": "2020-07-16T09:08:02Z", "type": "commit"}, {"oid": "e06fef81fe43fa70e764a4b3fb28c50cd30c5c9a", "url": "https://github.com/wso2/product-microgateway/commit/e06fef81fe43fa70e764a4b3fb28c50cd30c5c9a", "message": "add KM issuer read operation to the Token Introspection handler", "committedDate": "2020-07-16T09:45:33Z", "type": "commit"}, {"oid": "0f3b06d42c2b07393d5499571e2914c9b5f28578", "url": "https://github.com/wso2/product-microgateway/commit/0f3b06d42c2b07393d5499571e2914c9b5f28578", "message": "refactor code", "committedDate": "2020-07-16T10:32:58Z", "type": "commit"}, {"oid": "0f3b06d42c2b07393d5499571e2914c9b5f28578", "url": "https://github.com/wso2/product-microgateway/commit/0f3b06d42c2b07393d5499571e2914c9b5f28578", "message": "refactor code", "committedDate": "2020-07-16T10:32:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY5MDQ1Ng==", "url": "https://github.com/wso2/product-microgateway/pull/1330#discussion_r455690456", "bodyText": "Do we need this config at provider level. Can't we have it only in handler level", "author": "Rajith90", "createdAt": "2020-07-16T10:35:34Z", "path": "components/micro-gateway-core/src/main/ballerina/src/gateway/handler_providers/jwt_auth_provider.bal", "diffHunk": "@@ -40,20 +41,23 @@ public type JwtAuthProvider object {\n     public string className;\n     public boolean classLoaded;\n     public APIGatewayCache gatewayCache = new;\n+    public boolean remoteUserClaimRetrievalEnabled = false;\n \n     # Provides authentication based on the provided JWT token.\n     #\n     # + jwtValidatorConfig - JWT validator configurations\n     # + subscriptionValEnabled - Validate subscription\n+    # + remoteUserClaimRetrievalEnabled - true if the remote user claim retrieval is required\n     public function __init(jwt:JwtValidatorConfig jwtValidatorConfig, boolean subscriptionValEnabled, string consumerKeyClaim,\n-        map<anydata>[] | error claims, string className, boolean classLoaded) {\n+        map<anydata>[] | error claims, string className, boolean classLoaded, boolean remoteUserClaimRetrievalEnabled) {\n         self.jwtValidatorConfig = jwtValidatorConfig;\n         self.inboundJwtAuthProvider = new (jwtValidatorConfig);\n         self.subscriptionValEnabled = subscriptionValEnabled;\n         self.consumerKeyClaim = consumerKeyClaim;\n         self.claims = claims;\n         self.className = className;\n         self.classLoaded = classLoaded;\n+        self.remoteUserClaimRetrievalEnabled = remoteUserClaimRetrievalEnabled;", "originalCommit": "0f3b06d42c2b07393d5499571e2914c9b5f28578", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTcwNTY5MQ==", "url": "https://github.com/wso2/product-microgateway/pull/1330#discussion_r455705691", "bodyText": "Added in this level because need this for each issuer separately. Don't we need such granularity?", "author": "VirajSalaka", "createdAt": "2020-07-16T11:05:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTY5MDQ1Ng=="}], "type": "inlineReview"}]}