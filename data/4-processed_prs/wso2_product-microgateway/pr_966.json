{"pr_number": 966, "pr_title": "Create docker base image for microgateway runtime", "pr_createdAt": "2020-02-03T18:45:29Z", "pr_url": "https://github.com/wso2/product-microgateway/pull/966", "timeline": [{"oid": "e1f4a1687903533ecca7c7592af25f8b6c77bcf6", "url": "https://github.com/wso2/product-microgateway/commit/e1f4a1687903533ecca7c7592af25f8b6c77bcf6", "message": "Basic image is created", "committedDate": "2020-01-28T05:38:23Z", "type": "commit"}, {"oid": "8bd358ab80e3d384adf83efd8174179679e2249e", "url": "https://github.com/wso2/product-microgateway/commit/8bd358ab80e3d384adf83efd8174179679e2249e", "message": "apim 2.6 configs and JAVA_OPTS gc variables", "committedDate": "2020-01-29T09:43:42Z", "type": "commit"}, {"oid": "b47d94cf8b9c7e6f960f23a702fb10bcb1779eaa", "url": "https://github.com/wso2/product-microgateway/commit/b47d94cf8b9c7e6f960f23a702fb10bcb1779eaa", "message": "complete docker image and provide CMD from gateway executable", "committedDate": "2020-02-03T18:26:09Z", "type": "commit"}, {"oid": "2296833a8a90ea334fdcd778336a9f1e09572454", "url": "https://github.com/wso2/product-microgateway/commit/2296833a8a90ea334fdcd778336a9f1e09572454", "message": "change gateway executable such that the config file parameter can be overwritten", "committedDate": "2020-02-03T18:27:14Z", "type": "commit"}, {"oid": "086db46dc4825052197c82a17ebeed1ebe3cd31a", "url": "https://github.com/wso2/product-microgateway/commit/086db46dc4825052197c82a17ebeed1ebe3cd31a", "message": "remove unnecessary statements from dockerfile:", "committedDate": "2020-02-03T18:44:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTA5MzI2Nw==", "url": "https://github.com/wso2/product-microgateway/pull/966#discussion_r375093267", "bodyText": "Why do we need 0.14 which is AM 260 rest version? Even if we need to use compatibility version then this has to be 0.15 IMO", "author": "praminda", "createdAt": "2020-02-05T07:24:35Z", "path": "distribution/resources/cli-conf/toolkit-config.toml", "diffHunk": "@@ -3,7 +3,7 @@ httpRequestTimeout = 1000000\n \n [token]\n baseURL = \"\"\n-restVersion = \"v1.0\"", "originalCommit": "086db46dc4825052197c82a17ebeed1ebe3cd31a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIwNjQ3OQ==", "url": "https://github.com/wso2/product-microgateway/pull/966#discussion_r377206479", "bodyText": "fixed via fe1f68c", "author": "VirajSalaka", "createdAt": "2020-02-10T17:26:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTA5MzI2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTA5MzMwNg==", "url": "https://github.com/wso2/product-microgateway/pull/966#discussion_r375093306", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            {{/if}}\n          \n          \n            \n            {{/if}}", "author": "praminda", "createdAt": "2020-02-05T07:24:43Z", "path": "components/micro-gateway-cli/src/main/resources/templates/dockerConfig.mustache", "diffHunk": "@@ -11,6 +11,7 @@\n     debugPort:\"{{containerConfig.docker.dockerConfig.debugPort}}\"{{/if}}{{#if containerConfig.docker.dockerConfig.push}},\n     push:{{containerConfig.docker.dockerConfig.push}}{{/if}}{{#if containerConfig.docker.dockerConfig.username}},\n     username:\"{{containerConfig.docker.dockerConfig.username}}\"{{/if}}{{#if containerConfig.docker.dockerConfig.password}},\n-    password:\"{{containerConfig.docker.dockerConfig.password}}\"{{/if}}\n+    password:\"{{containerConfig.docker.dockerConfig.password}}\"{{/if}}{{#if containerConfig.docker.dockerConfig.cmd}},\n+    cmd: \"{{containerConfig.docker.dockerConfig.cmd}}\"{{/if}}\n }\n {{/if}}", "originalCommit": "086db46dc4825052197c82a17ebeed1ebe3cd31a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIwNjM4Nw==", "url": "https://github.com/wso2/product-microgateway/pull/966#discussion_r377206387", "bodyText": "fixed via fe1f68c", "author": "VirajSalaka", "createdAt": "2020-02-10T17:26:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTA5MzMwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY0NDE4MQ==", "url": "https://github.com/wso2/product-microgateway/pull/966#discussion_r375644181", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            restVersion = \"v0.14\"\n          \n          \n            \n            restVersion = \"v1.0\"", "author": "Rajith90", "createdAt": "2020-02-06T05:16:30Z", "path": "distribution/resources/cli-conf/toolkit-config.toml", "diffHunk": "@@ -3,7 +3,7 @@ httpRequestTimeout = 1000000\n \n [token]\n baseURL = \"\"\n-restVersion = \"v1.0\"\n+restVersion = \"v0.14\"", "originalCommit": "086db46dc4825052197c82a17ebeed1ebe3cd31a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIwNjMxNQ==", "url": "https://github.com/wso2/product-microgateway/pull/966#discussion_r377206315", "bodyText": "fixed via fe1f68c", "author": "VirajSalaka", "createdAt": "2020-02-10T17:26:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY0NDE4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg3MzQ1Ng==", "url": "https://github.com/wso2/product-microgateway/pull/966#discussion_r376873456", "bodyText": "Shall we move this docker related logic to separate method", "author": "praminda", "createdAt": "2020-02-10T05:26:50Z", "path": "components/micro-gateway-cli/src/main/java/org/wso2/apimgt/gateway/cli/cmd/BuildCmd.java", "diffHunk": "@@ -220,8 +220,7 @@ private void init(String projectName, String configPath, String deploymentConfig\n                 copyFile.setIsBallerinaConf(\"true\");\n                 copyFile.setSource(CmdUtils.getResourceFolderLocation() + File.separator + CliConstants.GW_DIST_CONF\n                         + File.separator + CliConstants.MICRO_GW_CONF_FILE);\n-                copyFile.setTarget(File.separator + CliConstants.WSO2 + File.separator + CliConstants.MGW", "originalCommit": "086db46dc4825052197c82a17ebeed1ebe3cd31a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIwNjIzOA==", "url": "https://github.com/wso2/product-microgateway/pull/966#discussion_r377206238", "bodyText": "fixed via fe1f68c", "author": "VirajSalaka", "createdAt": "2020-02-10T17:25:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg3MzQ1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg3NTUwMA==", "url": "https://github.com/wso2/product-microgateway/pull/966#discussion_r376875500", "bodyText": "Remove this\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              echo \"JAVA_HOME...\"", "author": "praminda", "createdAt": "2020-02-10T05:38:32Z", "path": "distribution/resources/bin/gateway", "diffHunk": "@@ -45,11 +45,13 @@ PRGDIR=`dirname \"$PRG\"`\n \n # set BALLERINA_HOME\n GW_HOME=`cd \"$PRGDIR/..\" ; pwd`\n-export JAVA_HOME=$GW_HOME'/lib/jdk8u202-b08-jre'\n export MGW_VERSION=\"3.1.0\"\n \n JAVA_PATH=$GW_HOME/lib/jdk8u202-b08-jre\n-if [ -d \"$JAVA_PATH\" ]; then\n+if [ -d \"$JAVA_HOME\" ]; then\n+  echo \"JAVA_HOME is externally set: $JAVA_HOME\"\n+else\n+  echo \"JAVA_HOME...\"", "originalCommit": "086db46dc4825052197c82a17ebeed1ebe3cd31a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIwNjE1NA==", "url": "https://github.com/wso2/product-microgateway/pull/966#discussion_r377206154", "bodyText": "fixed via fe1f68c", "author": "VirajSalaka", "createdAt": "2020-02-10T17:25:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg3NTUwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg3NTY1OQ==", "url": "https://github.com/wso2/product-microgateway/pull/966#discussion_r376875659", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              echo $JAVA_HOME", "author": "praminda", "createdAt": "2020-02-10T05:39:27Z", "path": "distribution/resources/bin/gateway", "diffHunk": "@@ -85,8 +87,8 @@ fi\n \n # For Migwn, ensure paths are in UNIX format before anything is touched\n if $mingw ; then\n-  [ -n \"$JAVA_HOME\" ] &&\n-    JAVA_HOME=\"`(cd \"$JAVA_HOME\"; pwd)`\"\n+  echo $JAVA_HOME", "originalCommit": "086db46dc4825052197c82a17ebeed1ebe3cd31a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIwNjA3Nw==", "url": "https://github.com/wso2/product-microgateway/pull/966#discussion_r377206077", "bodyText": "fixed via fe1f68c", "author": "VirajSalaka", "createdAt": "2020-02-10T17:25:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg3NTY1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg3NjA0MA==", "url": "https://github.com/wso2/product-microgateway/pull/966#discussion_r376876040", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                echo \"Error: Microgateway is supported only on JDK 1.8\"\n          \n          \n            \n                echo \"Error: Microgateway is supported only on Java 1.8\"", "author": "praminda", "createdAt": "2020-02-10T05:41:29Z", "path": "distribution/resources/bin/gateway", "diffHunk": "@@ -102,6 +104,12 @@ if [ -z \"$JAVACMD\" ] ; then\n     fi\n fi\n \n+JDK_18=`$JAVACMD -version 2>&1 | grep \"1.8.\"`\n+if [ \"$JDK_18\" = \"\" ]; then\n+    echo \"Error: Microgateway is supported only on JDK 1.8\"", "originalCommit": "086db46dc4825052197c82a17ebeed1ebe3cd31a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIwNTk3NQ==", "url": "https://github.com/wso2/product-microgateway/pull/966#discussion_r377205975", "bodyText": "fixed via fe1f68c", "author": "VirajSalaka", "createdAt": "2020-02-10T17:25:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg3NjA0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg3NjM1MQ==", "url": "https://github.com/wso2/product-microgateway/pull/966#discussion_r376876351", "bodyText": "As per the discussion we had regarding docker config loading, we don't need this change anymore", "author": "praminda", "createdAt": "2020-02-10T05:42:58Z", "path": "distribution/resources/bin/gateway", "diffHunk": "@@ -167,7 +175,7 @@ java_cmd_gateway () {\n     $JAVA_OPTS \\\n     -Dmgw-runtime.home=${GW_HOME} \\\n     -Dballerina.home=${GW_HOME} \\\n-    -jar $args --api.usage.data.path=$GW_HOME/api-usage-data --b7a.http.accesslog.path=$GW_HOME/logs/access_logs --b7a.config.file=$GW_HOME/conf/micro-gw.conf 2>&1 | tee -a $GW_HOME/logs/microgateway.log\n+    -jar ${args[0]} --api.usage.data.path=$GW_HOME/api-usage-data --b7a.http.accesslog.path=$GW_HOME/logs/access_logs --b7a.config.file=$GW_HOME/conf/micro-gw.conf ${args[@]:1}  2>&1 | tee -a $GW_HOME/logs/microgateway.log", "originalCommit": "086db46dc4825052197c82a17ebeed1ebe3cd31a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIwNTg5MA==", "url": "https://github.com/wso2/product-microgateway/pull/966#discussion_r377205890", "bodyText": "fixed via fe1f68c", "author": "VirajSalaka", "createdAt": "2020-02-10T17:25:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg3NjM1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg3NjgzOQ==", "url": "https://github.com/wso2/product-microgateway/pull/966#discussion_r376876839", "bodyText": "Suggested change", "author": "praminda", "createdAt": "2020-02-10T05:45:36Z", "path": "docker/Dockerfile", "diffHunk": "@@ -1,3 +1,4 @@\n+", "originalCommit": "086db46dc4825052197c82a17ebeed1ebe3cd31a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIwNTgxNA==", "url": "https://github.com/wso2/product-microgateway/pull/966#discussion_r377205814", "bodyText": "fixed via fe1f68c", "author": "VirajSalaka", "createdAt": "2020-02-10T17:25:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg3NjgzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg3NzI2Mg==", "url": "https://github.com/wso2/product-microgateway/pull/966#discussion_r376877262", "bodyText": "Use specific version of the image", "author": "praminda", "createdAt": "2020-02-10T05:48:00Z", "path": "docker/Dockerfile", "diffHunk": "@@ -17,33 +18,70 @@\n FROM openjdk:jre-alpine", "originalCommit": "086db46dc4825052197c82a17ebeed1ebe3cd31a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIwNTcyMg==", "url": "https://github.com/wso2/product-microgateway/pull/966#discussion_r377205722", "bodyText": "fixed via fe1f68c", "author": "VirajSalaka", "createdAt": "2020-02-10T17:24:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg3NzI2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg3OTMzMg==", "url": "https://github.com/wso2/product-microgateway/pull/966#discussion_r376879332", "bodyText": "Use ${USER}", "author": "praminda", "createdAt": "2020-02-10T05:59:32Z", "path": "docker/Dockerfile", "diffHunk": "@@ -17,33 +18,70 @@\n FROM openjdk:jre-alpine\n LABEL maintainer=\"dev@wso2.org\"\n \n-# Ballerina runtime distribution filename.\n+# Microgateway runtime distribution filename.\n ARG MGW_DIST\n+ARG USER=ballerina\n+ARG USER_ID=802\n+ARG USER_GROUP=ballerina\n+ARG USER_GROUP_ID=802\n+ARG USER_HOME=/home/${USER}\n+\n+# build arguments for WSO2 product installation\n+ARG MGW_SERVER_NAME=wso2am-micro-gw-linux\n+ARG MGW_SERVER_VERSION=3.1.0-SNAPSHOT\n+ARG MGW_SERVER=${MGW_SERVER_NAME}-${MGW_SERVER_VERSION}\n+ARG MGW_SERVER_HOME=${USER_HOME}/${MGW_SERVER}\n+ARG MGW_RUNTIME_HOME=${USER_HOME}/wso2\n+ARG INTERNAL_JRE=jdk8u202-b08-jre\n+\n+# build argument for MOTD\n+ARG MOTD='printf \"\\n\\\n+ Welcome to WSO2 Docker Resources \\n\\\n+ --------------------------------- \\n\\\n+ This Docker container comprises of a WSO2 product, running with its latest GA release \\n\\\n+ which is under the Apache License, Version 2.0. \\n\\\n+ Read more about Apache License, Version 2.0 here @ http://www.apache.org/licenses/LICENSE-2.0.\\n\"'\n+ENV ENV=${USER_HOME}\"/.ashrc\"\n+\n+# create the non-root user and group and set MOTD login message\n+RUN \\\n+    addgroup -S -g ${USER_GROUP_ID} ${USER_GROUP} \\\n+    && adduser -S -u ${USER_ID} -h ${USER_HOME} -G ${USER_GROUP} ${USER} \\\n+    && echo ${MOTD} > \"${ENV}\"\n \n-# Add Ballerina runtime.\n-COPY ${MGW_DIST} /root/\n-\n-# Create folders, unzip distribution, create users, & set permissions.\n-RUN mkdir -p /wso2/files \\\n-    && addgroup wso2 \\\n-    && adduser -S -s /bin/bash -g 'wso2' -G wso2 -D wso2 \\\n-    && apk add --update --no-cache bash \\\n-    && unzip /root/${MGW_DIST} -d /wso2/ > /dev/null 2>&1 \\\n-    && mv /wso2/wso2* /wso2/mgw \\\n-    && mkdir -p /wso2/mgw/runtime \\\n-    && unzip /wso2/mgw/runtime.zip -d wso2/mgw/runtime \\\n-    && rm -rf /wso2/mgw/runtime.zip \\\n-    && cp /wso2/mgw/lib/gateway/*.jar /wso2/mgw/runtime/bre/lib/ \\\n-    && chown -R wso2:wso2 /wso2 \\\n-    && rm -rf /root/${MGW_DIST} > /dev/null 2>&1 \\\n+RUN \\\n+    apk add --update --no-cache \\\n+        bash \\\n+        libxml2-utils \\\n+        netcat-openbsd \\\n     && rm -rf /var/cache/apk/*\n \n-ENV BALLERINA_HOME /wso2/mgw/runtime\n-ENV PATH $BALLERINA_HOME/bin:$PATH\n+COPY  runtime/ /root/\n+# Create folders, unzip distribution\n+RUN \\\n+    unzip /root/${MGW_SERVER}.zip -d /home/ballerina/ >/dev/null 2>&1 \\\n+    && rm -rf /home/ballerina/${MGW_SERVER}/lib/${INTERNAL_JRE} \\\n+    && mkdir -p /home/ballerina/conf \\\n+    && mv /home/ballerina/${MGW_SERVER} ${MGW_RUNTIME_HOME} \\\n+    && cp ${MGW_RUNTIME_HOME}/conf/micro-gw.conf ${USER_HOME}/conf/micro-gw.conf \\\n+    && chown ${USER}:${USER_GROUP} -R ${USER_HOME}  \\\n+    && rm -rf /root/${MGW_SERVER}.zip > /dev/null 2>&1\n+\n+ENV BALLERINA_HOME ${MGW_RUNTIME_HOME}/runtime\n+ENV GW_HOME ${MGW_RUNTIME_HOME}\n+ENV PATH $GW_HOME/bin:$PATH\n+\n+WORKDIR /home/ballerina\n+\n+USER ballerina", "originalCommit": "086db46dc4825052197c82a17ebeed1ebe3cd31a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIwNTYyMg==", "url": "https://github.com/wso2/product-microgateway/pull/966#discussion_r377205622", "bodyText": "fixed via fe1f68c", "author": "VirajSalaka", "createdAt": "2020-02-10T17:24:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg3OTMzMg=="}], "type": "inlineReview"}, {"oid": "fe1f68c2c9d1d39e961d2664256249498d69c5aa", "url": "https://github.com/wso2/product-microgateway/commit/fe1f68c2c9d1d39e961d2664256249498d69c5aa", "message": "fix commented issues", "committedDate": "2020-02-10T17:22:00Z", "type": "commit"}]}