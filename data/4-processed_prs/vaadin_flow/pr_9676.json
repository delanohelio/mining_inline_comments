{"pr_number": 9676, "pr_title": "fix: verify theme folder existence based on app-theme name in @Theme", "pr_createdAt": "2020-12-16T16:41:54Z", "pr_url": "https://github.com/vaadin/flow/pull/9676", "timeline": [{"oid": "eb64cb567a60b6ccb9700ccb4e2c336c8d2679e6", "url": "https://github.com/vaadin/flow/commit/eb64cb567a60b6ccb9700ccb4e2c336c8d2679e6", "message": "verify theme folder existence based on app-theme name used in @Theme", "committedDate": "2020-12-16T16:37:06Z", "type": "commit"}, {"oid": "4edf914050ce5bb51ec99e3728e5b67caef078de", "url": "https://github.com/vaadin/flow/commit/4edf914050ce5bb51ec99e3728e5b67caef078de", "message": "Apply Sonar review comment about Files.notExists", "committedDate": "2020-12-16T22:39:49Z", "type": "commit"}, {"oid": "2feb0a3cdffa6037d257a8d763d5ec2a512c82b1", "url": "https://github.com/vaadin/flow/commit/2feb0a3cdffa6037d257a8d763d5ec2a512c82b1", "message": "organize imports", "committedDate": "2020-12-16T22:41:25Z", "type": "commit"}, {"oid": "7287ef3f951ad1c9d01bc4613f32e7f70be2a95d", "url": "https://github.com/vaadin/flow/commit/7287ef3f951ad1c9d01bc4613f32e7f70be2a95d", "message": "add tests to verify exception is thrown if custom theme folder not present", "committedDate": "2020-12-17T14:02:39Z", "type": "commit"}, {"oid": "3bd4210fe297a11eed2665b08231822104eecb9f", "url": "https://github.com/vaadin/flow/commit/3bd4210fe297a11eed2665b08231822104eecb9f", "message": "convert task field to local variable\n and changed lambda to method reference", "committedDate": "2020-12-17T19:05:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU4MjM0MQ==", "url": "https://github.com/vaadin/flow/pull/9676#discussion_r545582341", "bodyText": "Tan is addin to Constants\n    /**\n     * The name of the application theme root folder.\n     */\n    public static final String APPLICATION_THEME_ROOT = \"themes\";\n\nAnd I feel we should define it only in one place.", "author": "caalador", "createdAt": "2020-12-18T05:31:54Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/frontend/FrontendUtils.java", "diffHunk": "@@ -316,6 +316,13 @@\n \n     public static final String BRIGHT_BLUE = \"\\u001b[94m%s\\u001b[0m\";\n \n+    /**\n+     * The directory name for the themes directory. It should be the direct\n+     * child of frontend directory which is by default named as \"frontend\", @see\n+     * {@link FrontendUtils#FRONTEND} and {@link FrontendUtils#DEFAULT_FRONTEND_DIR}\n+     */\n+    public static final String APP_THEMES_FOLDER_NAME = \"themes\";", "originalCommit": "3bd4210fe297a11eed2665b08231822104eecb9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU4MjgwMA==", "url": "https://github.com/vaadin/flow/pull/9676#discussion_r545582800", "bodyText": "Nit: you could just have the method take in String themeName to not have theme.getName() in so many places", "author": "caalador", "createdAt": "2020-12-18T05:33:31Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/frontend/TaskUpdateThemeImport.java", "diffHunk": "@@ -67,4 +75,20 @@ public void execute() throws ExecutionFailedException {\n                 \"Unable to write theme import file\", e);\n         }\n     }\n+\n+    private void verifyThemeDirectoryExistence() throws ExecutionFailedException {", "originalCommit": "3bd4210fe297a11eed2665b08231822104eecb9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU4MzY5MQ==", "url": "https://github.com/vaadin/flow/pull/9676#discussion_r545583691", "bodyText": "Again this is not the only place we support so we should also check\n\nsrc/main/resources/META-INF/resources\nsrc/main/resources/static\n${flowFrontend} (where the generated is written to, will also get the jar contents)", "author": "caalador", "createdAt": "2020-12-18T05:36:41Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/frontend/TaskUpdateThemeImport.java", "diffHunk": "@@ -67,4 +75,20 @@ public void execute() throws ExecutionFailedException {\n                 \"Unable to write theme import file\", e);\n         }\n     }\n+\n+    private void verifyThemeDirectoryExistence() throws ExecutionFailedException {\n+        File themesDir = new File (frontendDirectory, APP_THEMES_FOLDER_NAME);", "originalCommit": "3bd4210fe297a11eed2665b08231822104eecb9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU4NjI4Nw==", "url": "https://github.com/vaadin/flow/pull/9676#discussion_r545586287", "bodyText": "We can ofc suggest creating to the frontend folder, but we should still check all the possibilities.\nAlso this doesn't check for jar contents at the moment. This is possible to check in the flowFrontend directory as the files will have been copied out from the jar before we process this step.", "author": "caalador", "createdAt": "2020-12-18T05:46:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU4MzY5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU4NTA2OQ==", "url": "https://github.com/vaadin/flow/pull/9676#discussion_r545585069", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        String errorMessage = \"Discovered @Theme(\\\"%s\\\") annotation but \" +\n          \n          \n            \n                                \"no \\\"%s/%s/%s/\\\" directory present in the \" +\n          \n          \n            \n                                \"project or available or inside a jar dependency for the \" +\n          \n          \n            \n                                \"app. Check if you forgot to create the folder or have \" +\n          \n          \n            \n                                \"typo in the theme or folder name \\\"%s\\\".\";\n          \n          \n            \n                        String errorMessage = \"Discovered @Theme annotation with theme name '%s', \" +\n          \n          \n            \n                                \"but could not find the theme directory in the \" +\n          \n          \n            \n                                \"project or available as a jar dependency.\" +\n          \n          \n            \n                                \"Check if you forgot to create the folder in '%s' or have \" +\n          \n          \n            \n                                \"mistyped the theme or folder name for '%s'.\";", "author": "caalador", "createdAt": "2020-12-18T05:41:28Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/frontend/TaskUpdateThemeImport.java", "diffHunk": "@@ -67,4 +75,20 @@ public void execute() throws ExecutionFailedException {\n                 \"Unable to write theme import file\", e);\n         }\n     }\n+\n+    private void verifyThemeDirectoryExistence() throws ExecutionFailedException {\n+        File themesDir = new File (frontendDirectory, APP_THEMES_FOLDER_NAME);\n+        File customThemeDir = new File (themesDir, theme.getName());\n+        if (!customThemeDir.exists()) {\n+            String errorMessage = \"Discovered @Theme(\\\"%s\\\") annotation but \" +\n+                    \"no \\\"%s/%s/%s/\\\" directory present in the \" +\n+                    \"project or available or inside a jar dependency for the \" +\n+                    \"app. Check if you forgot to create the folder or have \" +\n+                    \"typo in the theme or folder name \\\"%s\\\".\";", "originalCommit": "3bd4210fe297a11eed2665b08231822104eecb9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU4NTMyMQ==", "url": "https://github.com/vaadin/flow/pull/9676#discussion_r545585321", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        throw new ExecutionFailedException(String.format(errorMessage,\n          \n          \n            \n                                theme.getName(), frontendDirectory.getName(),\n          \n          \n            \n                                APP_THEMES_FOLDER_NAME, theme.getName(), theme.getName()));\n          \n          \n            \n                        throw new ExecutionFailedException(String.format(errorMessage,\n          \n          \n            \n                                theme.getName(), themesDir, theme.getName()));", "author": "caalador", "createdAt": "2020-12-18T05:42:26Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/frontend/TaskUpdateThemeImport.java", "diffHunk": "@@ -67,4 +75,20 @@ public void execute() throws ExecutionFailedException {\n                 \"Unable to write theme import file\", e);\n         }\n     }\n+\n+    private void verifyThemeDirectoryExistence() throws ExecutionFailedException {\n+        File themesDir = new File (frontendDirectory, APP_THEMES_FOLDER_NAME);\n+        File customThemeDir = new File (themesDir, theme.getName());\n+        if (!customThemeDir.exists()) {\n+            String errorMessage = \"Discovered @Theme(\\\"%s\\\") annotation but \" +\n+                    \"no \\\"%s/%s/%s/\\\" directory present in the \" +\n+                    \"project or available or inside a jar dependency for the \" +\n+                    \"app. Check if you forgot to create the folder or have \" +\n+                    \"typo in the theme or folder name \\\"%s\\\".\";\n+\n+            throw new ExecutionFailedException(String.format(errorMessage,\n+                    theme.getName(), frontendDirectory.getName(),\n+                    APP_THEMES_FOLDER_NAME, theme.getName(), theme.getName()));", "originalCommit": "3bd4210fe297a11eed2665b08231822104eecb9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "51d526e16f3847b3cc2c6032841f963c078b3fbb", "url": "https://github.com/vaadin/flow/commit/51d526e16f3847b3cc2c6032841f963c078b3fbb", "message": "Apply suggestions from code review\n\nCo-authored-by: caalador <mikael.grankvist@gmail.com>", "committedDate": "2020-12-18T08:38:59Z", "type": "commit"}, {"oid": "23a39be915d13915a55d2749f7527a8760cca889", "url": "https://github.com/vaadin/flow/commit/23a39be915d13915a55d2749f7527a8760cca889", "message": "apply review comments and add tests", "committedDate": "2020-12-21T02:12:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjUzMjcxMg==", "url": "https://github.com/vaadin/flow/pull/9676#discussion_r546532712", "bodyText": "Just as a note the webpack run actually checks first project files and then the frontend folder as anything in the project is more significant.", "author": "caalador", "createdAt": "2020-12-21T06:35:52Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/frontend/TaskUpdateThemeImport.java", "diffHunk": "@@ -76,18 +80,63 @@ public void execute() throws ExecutionFailedException {\n         }\n     }\n \n-    private void verifyThemeDirectoryExistence() throws ExecutionFailedException {\n-        File themesDir = new File (frontendDirectory, APP_THEMES_FOLDER_NAME);\n-        File customThemeDir = new File (themesDir, theme.getName());\n-        if (!customThemeDir.exists()) {\n-            String errorMessage = \"Discovered @Theme annotation with theme name '%s', \" +\n-                    \"but could not find the theme directory in the \" +\n-                    \"project or available as a jar dependency.\" +\n-                    \"Check if you forgot to create the folder in '%s' or have \" +\n-                    \"mistyped the theme or folder name for '%s'.\";\n-\n-            throw new ExecutionFailedException(String.format(errorMessage,\n-                    theme.getName(), themesDir, theme.getName()));\n+    private void verifyThemeDirectoryExistence(String themeName,\n+                                               File frontendDirectory)\n+            throws ExecutionFailedException {\n+\n+        File mainThemesDir = new File (frontendDirectory, APPLICATION_THEME_ROOT);", "originalCommit": "23a39be915d13915a55d2749f7527a8760cca889", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjUzNTY4OA==", "url": "https://github.com/vaadin/flow/pull/9676#discussion_r546535688", "bodyText": "This is npmFolder  which is the root of the project containing wepack.generated.js etc.\nBasically if the frontend folder is user defiend then it might be {projectRoot}/hide/my/jayes/things which would now make you root dir {projectRoot}/hide/my/jayes\nNot that many people do this, but it would break the feature.", "author": "caalador", "createdAt": "2020-12-21T06:46:06Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/frontend/TaskUpdateThemeImport.java", "diffHunk": "@@ -76,18 +80,63 @@ public void execute() throws ExecutionFailedException {\n         }\n     }\n \n-    private void verifyThemeDirectoryExistence() throws ExecutionFailedException {\n-        File themesDir = new File (frontendDirectory, APP_THEMES_FOLDER_NAME);\n-        File customThemeDir = new File (themesDir, theme.getName());\n-        if (!customThemeDir.exists()) {\n-            String errorMessage = \"Discovered @Theme annotation with theme name '%s', \" +\n-                    \"but could not find the theme directory in the \" +\n-                    \"project or available as a jar dependency.\" +\n-                    \"Check if you forgot to create the folder in '%s' or have \" +\n-                    \"mistyped the theme or folder name for '%s'.\";\n-\n-            throw new ExecutionFailedException(String.format(errorMessage,\n-                    theme.getName(), themesDir, theme.getName()));\n+    private void verifyThemeDirectoryExistence(String themeName,\n+                                               File frontendDirectory)\n+            throws ExecutionFailedException {\n+\n+        File mainThemesDir = new File (frontendDirectory, APPLICATION_THEME_ROOT);\n+        File mainCustomThemeDir = new File (mainThemesDir, themeName);\n+\n+        Stream<File> otherFoldersToSearch = getOtherFoldersToSearchForAppTheme(\n+                themeName, frontendDirectory);\n+\n+        if (!mainCustomThemeDir.exists()) {\n+            if (otherFoldersToSearch.noneMatch(File::exists)) {\n+                String errorMessage = \"Discovered @Theme annotation with \" +\n+                        \"theme name '%s', but could not find the theme \" +\n+                        \"directory in the project or available as a jar \" +\n+                        \"dependency. Check if you forgot to create the \" +\n+                        \"folder under './%s/%s/' or have mistyped the theme \" +\n+                        \"or folder name for '%s'.\";\n+\n+                throw new ExecutionFailedException(String.format(errorMessage,\n+                        themeName, frontendDirectory.getName(),\n+                        APPLICATION_THEME_ROOT, themeName));\n+            }\n+        } else {\n+            if (otherFoldersToSearch.anyMatch(File::exists)) {\n+                String errorMessage = \"Discovered Theme folder for theme \" +\n+                        \"'%s' in more than one place in the project. Please \" +\n+                        \"remove the duplicate(s) and try again. The \" +\n+                        \"recommended place to put the theme folder inside \" +\n+                        \"the project is './%s/%s/'\";\n+\n+                throw new ExecutionFailedException(String.format(errorMessage,\n+                        themeName, frontendDirectory.getName(),\n+                        APPLICATION_THEME_ROOT));\n+            }\n         }\n     }\n+\n+    private Stream<File> getOtherFoldersToSearchForAppTheme(String themeName,\n+                                                    File frontendDirectory) {\n+        File projectRootDir = frontendDirectory.getParentFile();", "originalCommit": "23a39be915d13915a55d2749f7527a8760cca889", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYyOTI2Mg==", "url": "https://github.com/vaadin/flow/pull/9676#discussion_r546629262", "bodyText": "Yeah, right, totally understand this since I was struggling with the same issue in my mind while I was taking the look at available runtime parameters from builder in NodeTask.java and didn't find any proper parameter which holds the project-root.\nShould I assume that npmFolder is the project-root? Since I wasn't sure that it is not gonna be customized by some users. Is adding a new runtime parameter in builder a good idea?", "author": "taefi", "createdAt": "2020-12-21T10:32:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjUzNTY4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYzNTE2Mg==", "url": "https://github.com/vaadin/flow/pull/9676#discussion_r546635162", "bodyText": "It's where everything else is calculated from also so it should be fine to assume it's the project root. it bsically needs to be the place where pom.xml exists.", "author": "caalador", "createdAt": "2020-12-21T10:44:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjUzNTY4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjUzNjE4Mw==", "url": "https://github.com/vaadin/flow/pull/9676#discussion_r546536183", "bodyText": "Why are you sending frontendDirectory as a method param when it is available as an instance variable?", "author": "caalador", "createdAt": "2020-12-21T06:47:55Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/frontend/TaskUpdateThemeImport.java", "diffHunk": "@@ -76,18 +80,63 @@ public void execute() throws ExecutionFailedException {\n         }\n     }\n \n-    private void verifyThemeDirectoryExistence() throws ExecutionFailedException {\n-        File themesDir = new File (frontendDirectory, APP_THEMES_FOLDER_NAME);\n-        File customThemeDir = new File (themesDir, theme.getName());\n-        if (!customThemeDir.exists()) {\n-            String errorMessage = \"Discovered @Theme annotation with theme name '%s', \" +\n-                    \"but could not find the theme directory in the \" +\n-                    \"project or available as a jar dependency.\" +\n-                    \"Check if you forgot to create the folder in '%s' or have \" +\n-                    \"mistyped the theme or folder name for '%s'.\";\n-\n-            throw new ExecutionFailedException(String.format(errorMessage,\n-                    theme.getName(), themesDir, theme.getName()));\n+    private void verifyThemeDirectoryExistence(String themeName,\n+                                               File frontendDirectory)", "originalCommit": "23a39be915d13915a55d2749f7527a8760cca889", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYyMzAyMg==", "url": "https://github.com/vaadin/flow/pull/9676#discussion_r546623022", "bodyText": "I'm trying to maintain integrity for the input parameters, so either the method to be totally dependent on fields or totally act as independent as possible. In this case, I would remove themeName also from the input args and would create a local variable as String themeName = theme.getName() inside the method, since it feels kinda the same for me to pass in theme.getName() while the theme is available as a field.", "author": "taefi", "createdAt": "2020-12-21T10:19:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjUzNjE4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYyODkxOQ==", "url": "https://github.com/vaadin/flow/pull/9676#discussion_r546628919", "bodyText": "We shouldn't pass instance variables around internal private methods. Even though theme is available the name is as such not, but it's fine to have getName everywhere it is needed..", "author": "caalador", "createdAt": "2020-12-21T10:31:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjUzNjE4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjUzNzAzOQ==", "url": "https://github.com/vaadin/flow/pull/9676#discussion_r546537039", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    \"folder under './%s/%s/' or have mistyped the theme \" +\n          \n          \n            \n                                    \"folder under '%s' or have mistyped the theme \" +\n          \n      \n    \n    \n  \n\nThis is a development time exception and it's fine to show the full path for the developer with the OS specific path separators.", "author": "caalador", "createdAt": "2020-12-21T06:51:11Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/frontend/TaskUpdateThemeImport.java", "diffHunk": "@@ -76,18 +80,63 @@ public void execute() throws ExecutionFailedException {\n         }\n     }\n \n-    private void verifyThemeDirectoryExistence() throws ExecutionFailedException {\n-        File themesDir = new File (frontendDirectory, APP_THEMES_FOLDER_NAME);\n-        File customThemeDir = new File (themesDir, theme.getName());\n-        if (!customThemeDir.exists()) {\n-            String errorMessage = \"Discovered @Theme annotation with theme name '%s', \" +\n-                    \"but could not find the theme directory in the \" +\n-                    \"project or available as a jar dependency.\" +\n-                    \"Check if you forgot to create the folder in '%s' or have \" +\n-                    \"mistyped the theme or folder name for '%s'.\";\n-\n-            throw new ExecutionFailedException(String.format(errorMessage,\n-                    theme.getName(), themesDir, theme.getName()));\n+    private void verifyThemeDirectoryExistence(String themeName,\n+                                               File frontendDirectory)\n+            throws ExecutionFailedException {\n+\n+        File mainThemesDir = new File (frontendDirectory, APPLICATION_THEME_ROOT);\n+        File mainCustomThemeDir = new File (mainThemesDir, themeName);\n+\n+        Stream<File> otherFoldersToSearch = getOtherFoldersToSearchForAppTheme(\n+                themeName, frontendDirectory);\n+\n+        if (!mainCustomThemeDir.exists()) {\n+            if (otherFoldersToSearch.noneMatch(File::exists)) {\n+                String errorMessage = \"Discovered @Theme annotation with \" +\n+                        \"theme name '%s', but could not find the theme \" +\n+                        \"directory in the project or available as a jar \" +\n+                        \"dependency. Check if you forgot to create the \" +\n+                        \"folder under './%s/%s/' or have mistyped the theme \" +", "originalCommit": "23a39be915d13915a55d2749f7527a8760cca889", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjUzNzE4MQ==", "url": "https://github.com/vaadin/flow/pull/9676#discussion_r546537181", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            throw new ExecutionFailedException(String.format(errorMessage,\n          \n          \n            \n                                    themeName, frontendDirectory.getName(),\n          \n          \n            \n                                    APPLICATION_THEME_ROOT, themeName));\n          \n          \n            \n                            throw new ExecutionFailedException(String.format(errorMessage,\n          \n          \n            \n                                    themeName, mainThemesDir, themeName));", "author": "caalador", "createdAt": "2020-12-21T06:51:39Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/frontend/TaskUpdateThemeImport.java", "diffHunk": "@@ -76,18 +80,63 @@ public void execute() throws ExecutionFailedException {\n         }\n     }\n \n-    private void verifyThemeDirectoryExistence() throws ExecutionFailedException {\n-        File themesDir = new File (frontendDirectory, APP_THEMES_FOLDER_NAME);\n-        File customThemeDir = new File (themesDir, theme.getName());\n-        if (!customThemeDir.exists()) {\n-            String errorMessage = \"Discovered @Theme annotation with theme name '%s', \" +\n-                    \"but could not find the theme directory in the \" +\n-                    \"project or available as a jar dependency.\" +\n-                    \"Check if you forgot to create the folder in '%s' or have \" +\n-                    \"mistyped the theme or folder name for '%s'.\";\n-\n-            throw new ExecutionFailedException(String.format(errorMessage,\n-                    theme.getName(), themesDir, theme.getName()));\n+    private void verifyThemeDirectoryExistence(String themeName,\n+                                               File frontendDirectory)\n+            throws ExecutionFailedException {\n+\n+        File mainThemesDir = new File (frontendDirectory, APPLICATION_THEME_ROOT);\n+        File mainCustomThemeDir = new File (mainThemesDir, themeName);\n+\n+        Stream<File> otherFoldersToSearch = getOtherFoldersToSearchForAppTheme(\n+                themeName, frontendDirectory);\n+\n+        if (!mainCustomThemeDir.exists()) {\n+            if (otherFoldersToSearch.noneMatch(File::exists)) {\n+                String errorMessage = \"Discovered @Theme annotation with \" +\n+                        \"theme name '%s', but could not find the theme \" +\n+                        \"directory in the project or available as a jar \" +\n+                        \"dependency. Check if you forgot to create the \" +\n+                        \"folder under './%s/%s/' or have mistyped the theme \" +\n+                        \"or folder name for '%s'.\";\n+\n+                throw new ExecutionFailedException(String.format(errorMessage,\n+                        themeName, frontendDirectory.getName(),\n+                        APPLICATION_THEME_ROOT, themeName));", "originalCommit": "23a39be915d13915a55d2749f7527a8760cca889", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjUzNzI0OQ==", "url": "https://github.com/vaadin/flow/pull/9676#discussion_r546537249", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    \"the project is './%s/%s/'\";\n          \n          \n            \n                                    \"the project is '%s'\";\n          \n      \n    \n    \n  \n\nSame as above", "author": "caalador", "createdAt": "2020-12-21T06:52:00Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/frontend/TaskUpdateThemeImport.java", "diffHunk": "@@ -76,18 +80,63 @@ public void execute() throws ExecutionFailedException {\n         }\n     }\n \n-    private void verifyThemeDirectoryExistence() throws ExecutionFailedException {\n-        File themesDir = new File (frontendDirectory, APP_THEMES_FOLDER_NAME);\n-        File customThemeDir = new File (themesDir, theme.getName());\n-        if (!customThemeDir.exists()) {\n-            String errorMessage = \"Discovered @Theme annotation with theme name '%s', \" +\n-                    \"but could not find the theme directory in the \" +\n-                    \"project or available as a jar dependency.\" +\n-                    \"Check if you forgot to create the folder in '%s' or have \" +\n-                    \"mistyped the theme or folder name for '%s'.\";\n-\n-            throw new ExecutionFailedException(String.format(errorMessage,\n-                    theme.getName(), themesDir, theme.getName()));\n+    private void verifyThemeDirectoryExistence(String themeName,\n+                                               File frontendDirectory)\n+            throws ExecutionFailedException {\n+\n+        File mainThemesDir = new File (frontendDirectory, APPLICATION_THEME_ROOT);\n+        File mainCustomThemeDir = new File (mainThemesDir, themeName);\n+\n+        Stream<File> otherFoldersToSearch = getOtherFoldersToSearchForAppTheme(\n+                themeName, frontendDirectory);\n+\n+        if (!mainCustomThemeDir.exists()) {\n+            if (otherFoldersToSearch.noneMatch(File::exists)) {\n+                String errorMessage = \"Discovered @Theme annotation with \" +\n+                        \"theme name '%s', but could not find the theme \" +\n+                        \"directory in the project or available as a jar \" +\n+                        \"dependency. Check if you forgot to create the \" +\n+                        \"folder under './%s/%s/' or have mistyped the theme \" +\n+                        \"or folder name for '%s'.\";\n+\n+                throw new ExecutionFailedException(String.format(errorMessage,\n+                        themeName, frontendDirectory.getName(),\n+                        APPLICATION_THEME_ROOT, themeName));\n+            }\n+        } else {\n+            if (otherFoldersToSearch.anyMatch(File::exists)) {\n+                String errorMessage = \"Discovered Theme folder for theme \" +\n+                        \"'%s' in more than one place in the project. Please \" +\n+                        \"remove the duplicate(s) and try again. The \" +\n+                        \"recommended place to put the theme folder inside \" +\n+                        \"the project is './%s/%s/'\";", "originalCommit": "23a39be915d13915a55d2749f7527a8760cca889", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjUzNzMwNQ==", "url": "https://github.com/vaadin/flow/pull/9676#discussion_r546537305", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            throw new ExecutionFailedException(String.format(errorMessage,\n          \n          \n            \n                                    themeName, frontendDirectory.getName(),\n          \n          \n            \n                                    APPLICATION_THEME_ROOT));\n          \n          \n            \n                            throw new ExecutionFailedException(String.format(errorMessage,\n          \n          \n            \n                                    themeName, mainThemesDir));", "author": "caalador", "createdAt": "2020-12-21T06:52:14Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/frontend/TaskUpdateThemeImport.java", "diffHunk": "@@ -76,18 +80,63 @@ public void execute() throws ExecutionFailedException {\n         }\n     }\n \n-    private void verifyThemeDirectoryExistence() throws ExecutionFailedException {\n-        File themesDir = new File (frontendDirectory, APP_THEMES_FOLDER_NAME);\n-        File customThemeDir = new File (themesDir, theme.getName());\n-        if (!customThemeDir.exists()) {\n-            String errorMessage = \"Discovered @Theme annotation with theme name '%s', \" +\n-                    \"but could not find the theme directory in the \" +\n-                    \"project or available as a jar dependency.\" +\n-                    \"Check if you forgot to create the folder in '%s' or have \" +\n-                    \"mistyped the theme or folder name for '%s'.\";\n-\n-            throw new ExecutionFailedException(String.format(errorMessage,\n-                    theme.getName(), themesDir, theme.getName()));\n+    private void verifyThemeDirectoryExistence(String themeName,\n+                                               File frontendDirectory)\n+            throws ExecutionFailedException {\n+\n+        File mainThemesDir = new File (frontendDirectory, APPLICATION_THEME_ROOT);\n+        File mainCustomThemeDir = new File (mainThemesDir, themeName);\n+\n+        Stream<File> otherFoldersToSearch = getOtherFoldersToSearchForAppTheme(\n+                themeName, frontendDirectory);\n+\n+        if (!mainCustomThemeDir.exists()) {\n+            if (otherFoldersToSearch.noneMatch(File::exists)) {\n+                String errorMessage = \"Discovered @Theme annotation with \" +\n+                        \"theme name '%s', but could not find the theme \" +\n+                        \"directory in the project or available as a jar \" +\n+                        \"dependency. Check if you forgot to create the \" +\n+                        \"folder under './%s/%s/' or have mistyped the theme \" +\n+                        \"or folder name for '%s'.\";\n+\n+                throw new ExecutionFailedException(String.format(errorMessage,\n+                        themeName, frontendDirectory.getName(),\n+                        APPLICATION_THEME_ROOT, themeName));\n+            }\n+        } else {\n+            if (otherFoldersToSearch.anyMatch(File::exists)) {\n+                String errorMessage = \"Discovered Theme folder for theme \" +\n+                        \"'%s' in more than one place in the project. Please \" +\n+                        \"remove the duplicate(s) and try again. The \" +\n+                        \"recommended place to put the theme folder inside \" +\n+                        \"the project is './%s/%s/'\";\n+\n+                throw new ExecutionFailedException(String.format(errorMessage,\n+                        themeName, frontendDirectory.getName(),\n+                        APPLICATION_THEME_ROOT));", "originalCommit": "23a39be915d13915a55d2749f7527a8760cca889", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjUzNzQ5OA==", "url": "https://github.com/vaadin/flow/pull/9676#discussion_r546537498", "bodyText": "frontendDirectory is available as an instance variable", "author": "caalador", "createdAt": "2020-12-21T06:53:02Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/frontend/TaskUpdateThemeImport.java", "diffHunk": "@@ -76,18 +80,63 @@ public void execute() throws ExecutionFailedException {\n         }\n     }\n \n-    private void verifyThemeDirectoryExistence() throws ExecutionFailedException {\n-        File themesDir = new File (frontendDirectory, APP_THEMES_FOLDER_NAME);\n-        File customThemeDir = new File (themesDir, theme.getName());\n-        if (!customThemeDir.exists()) {\n-            String errorMessage = \"Discovered @Theme annotation with theme name '%s', \" +\n-                    \"but could not find the theme directory in the \" +\n-                    \"project or available as a jar dependency.\" +\n-                    \"Check if you forgot to create the folder in '%s' or have \" +\n-                    \"mistyped the theme or folder name for '%s'.\";\n-\n-            throw new ExecutionFailedException(String.format(errorMessage,\n-                    theme.getName(), themesDir, theme.getName()));\n+    private void verifyThemeDirectoryExistence(String themeName,\n+                                               File frontendDirectory)\n+            throws ExecutionFailedException {\n+\n+        File mainThemesDir = new File (frontendDirectory, APPLICATION_THEME_ROOT);\n+        File mainCustomThemeDir = new File (mainThemesDir, themeName);\n+\n+        Stream<File> otherFoldersToSearch = getOtherFoldersToSearchForAppTheme(\n+                themeName, frontendDirectory);\n+\n+        if (!mainCustomThemeDir.exists()) {\n+            if (otherFoldersToSearch.noneMatch(File::exists)) {\n+                String errorMessage = \"Discovered @Theme annotation with \" +\n+                        \"theme name '%s', but could not find the theme \" +\n+                        \"directory in the project or available as a jar \" +\n+                        \"dependency. Check if you forgot to create the \" +\n+                        \"folder under './%s/%s/' or have mistyped the theme \" +\n+                        \"or folder name for '%s'.\";\n+\n+                throw new ExecutionFailedException(String.format(errorMessage,\n+                        themeName, frontendDirectory.getName(),\n+                        APPLICATION_THEME_ROOT, themeName));\n+            }\n+        } else {\n+            if (otherFoldersToSearch.anyMatch(File::exists)) {\n+                String errorMessage = \"Discovered Theme folder for theme \" +\n+                        \"'%s' in more than one place in the project. Please \" +\n+                        \"remove the duplicate(s) and try again. The \" +\n+                        \"recommended place to put the theme folder inside \" +\n+                        \"the project is './%s/%s/'\";\n+\n+                throw new ExecutionFailedException(String.format(errorMessage,\n+                        themeName, frontendDirectory.getName(),\n+                        APPLICATION_THEME_ROOT));\n+            }\n         }\n     }\n+\n+    private Stream<File> getOtherFoldersToSearchForAppTheme(String themeName,\n+                                                    File frontendDirectory) {", "originalCommit": "23a39be915d13915a55d2749f7527a8760cca889", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYyNDU3MQ==", "url": "https://github.com/vaadin/flow/pull/9676#discussion_r546624571", "bodyText": "Same as https://github.com/vaadin/flow/pull/9676/files#r546623022", "author": "taefi", "createdAt": "2020-12-21T10:22:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjUzNzQ5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU0MTA1NA==", "url": "https://github.com/vaadin/flow/pull/9676#discussion_r546541054", "bodyText": "I would just have this method return a list (stream?) of strings concatenate as String.join(\"/\", APPLICATION_META_INF_RESOURCES, APPLICATION_THEME_ROOT, themeName) Also I would not call this other folders as it should just be the full set of folders.", "author": "caalador", "createdAt": "2020-12-21T07:05:40Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/frontend/TaskUpdateThemeImport.java", "diffHunk": "@@ -76,18 +80,63 @@ public void execute() throws ExecutionFailedException {\n         }\n     }\n \n-    private void verifyThemeDirectoryExistence() throws ExecutionFailedException {\n-        File themesDir = new File (frontendDirectory, APP_THEMES_FOLDER_NAME);\n-        File customThemeDir = new File (themesDir, theme.getName());\n-        if (!customThemeDir.exists()) {\n-            String errorMessage = \"Discovered @Theme annotation with theme name '%s', \" +\n-                    \"but could not find the theme directory in the \" +\n-                    \"project or available as a jar dependency.\" +\n-                    \"Check if you forgot to create the folder in '%s' or have \" +\n-                    \"mistyped the theme or folder name for '%s'.\";\n-\n-            throw new ExecutionFailedException(String.format(errorMessage,\n-                    theme.getName(), themesDir, theme.getName()));\n+    private void verifyThemeDirectoryExistence(String themeName,\n+                                               File frontendDirectory)\n+            throws ExecutionFailedException {\n+\n+        File mainThemesDir = new File (frontendDirectory, APPLICATION_THEME_ROOT);\n+        File mainCustomThemeDir = new File (mainThemesDir, themeName);\n+\n+        Stream<File> otherFoldersToSearch = getOtherFoldersToSearchForAppTheme(\n+                themeName, frontendDirectory);\n+\n+        if (!mainCustomThemeDir.exists()) {\n+            if (otherFoldersToSearch.noneMatch(File::exists)) {\n+                String errorMessage = \"Discovered @Theme annotation with \" +\n+                        \"theme name '%s', but could not find the theme \" +\n+                        \"directory in the project or available as a jar \" +\n+                        \"dependency. Check if you forgot to create the \" +\n+                        \"folder under './%s/%s/' or have mistyped the theme \" +\n+                        \"or folder name for '%s'.\";\n+\n+                throw new ExecutionFailedException(String.format(errorMessage,\n+                        themeName, frontendDirectory.getName(),\n+                        APPLICATION_THEME_ROOT, themeName));\n+            }\n+        } else {\n+            if (otherFoldersToSearch.anyMatch(File::exists)) {\n+                String errorMessage = \"Discovered Theme folder for theme \" +\n+                        \"'%s' in more than one place in the project. Please \" +\n+                        \"remove the duplicate(s) and try again. The \" +\n+                        \"recommended place to put the theme folder inside \" +\n+                        \"the project is './%s/%s/'\";\n+\n+                throw new ExecutionFailedException(String.format(errorMessage,\n+                        themeName, frontendDirectory.getName(),\n+                        APPLICATION_THEME_ROOT));\n+            }\n         }\n     }\n+\n+    private Stream<File> getOtherFoldersToSearchForAppTheme(String themeName,\n+                                                    File frontendDirectory) {\n+        File projectRootDir = frontendDirectory.getParentFile();\n+\n+        File metaInfDir = new File(projectRootDir,\n+                APPLICATION_META_INF_RESOURCES);\n+        File metaInfThemesDir = new File(metaInfDir, APPLICATION_THEME_ROOT);\n+        File metaInfCustomThemeDir = new File(metaInfThemesDir, themeName);\n+", "originalCommit": "23a39be915d13915a55d2749f7527a8760cca889", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU0NzIzNw==", "url": "https://github.com/vaadin/flow/pull/9676#discussion_r546547237", "bodyText": "And the stream/list would be used as Stream.filter(path -> new File(npmFolder, path).exists()).count()\nor Stream.filter(path -> new File(npmFolder, path).exists()).collect(Collect...list) to be able to check the jar +non jar state.", "author": "caalador", "createdAt": "2020-12-21T07:25:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU0MTA1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU0MTU5Mg==", "url": "https://github.com/vaadin/flow/pull/9676#discussion_r546541592", "bodyText": "This exception is sort of wrong if you have the same themeName in frontend and a jar.\nIn that case the exception should be more like \"Theme '\" + themeName + \"'should not exist inside a jar and in the project at the same time\\n Extending another theme is possible by adding { \\\"parent\\\": \\\"my-parent-theme\\\" } entry to the theme.json file inside your theme folder.\"\nBut this case is checked in the webpack plugin.", "author": "caalador", "createdAt": "2020-12-21T07:07:17Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/frontend/TaskUpdateThemeImport.java", "diffHunk": "@@ -76,18 +80,63 @@ public void execute() throws ExecutionFailedException {\n         }\n     }\n \n-    private void verifyThemeDirectoryExistence() throws ExecutionFailedException {\n-        File themesDir = new File (frontendDirectory, APP_THEMES_FOLDER_NAME);\n-        File customThemeDir = new File (themesDir, theme.getName());\n-        if (!customThemeDir.exists()) {\n-            String errorMessage = \"Discovered @Theme annotation with theme name '%s', \" +\n-                    \"but could not find the theme directory in the \" +\n-                    \"project or available as a jar dependency.\" +\n-                    \"Check if you forgot to create the folder in '%s' or have \" +\n-                    \"mistyped the theme or folder name for '%s'.\";\n-\n-            throw new ExecutionFailedException(String.format(errorMessage,\n-                    theme.getName(), themesDir, theme.getName()));\n+    private void verifyThemeDirectoryExistence(String themeName,\n+                                               File frontendDirectory)\n+            throws ExecutionFailedException {\n+\n+        File mainThemesDir = new File (frontendDirectory, APPLICATION_THEME_ROOT);\n+        File mainCustomThemeDir = new File (mainThemesDir, themeName);\n+\n+        Stream<File> otherFoldersToSearch = getOtherFoldersToSearchForAppTheme(\n+                themeName, frontendDirectory);\n+\n+        if (!mainCustomThemeDir.exists()) {\n+            if (otherFoldersToSearch.noneMatch(File::exists)) {\n+                String errorMessage = \"Discovered @Theme annotation with \" +\n+                        \"theme name '%s', but could not find the theme \" +\n+                        \"directory in the project or available as a jar \" +\n+                        \"dependency. Check if you forgot to create the \" +\n+                        \"folder under './%s/%s/' or have mistyped the theme \" +\n+                        \"or folder name for '%s'.\";\n+\n+                throw new ExecutionFailedException(String.format(errorMessage,\n+                        themeName, frontendDirectory.getName(),\n+                        APPLICATION_THEME_ROOT, themeName));\n+            }\n+        } else {\n+            if (otherFoldersToSearch.anyMatch(File::exists)) {\n+                String errorMessage = \"Discovered Theme folder for theme \" +", "originalCommit": "23a39be915d13915a55d2749f7527a8760cca889", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY0MzY5Mg==", "url": "https://github.com/vaadin/flow/pull/9676#discussion_r546643692", "bodyText": "I'm validating this to cover such situations that user wrongly copies the same /themes/some-theme structure in more than one place, for instance having it in both [project-root]/frontend/themes/some-theme and [project-root]/src/main/resources/static/themes/some-theme. As far as I understood, webpack is only checking the duplicity in jar and project files, not between to places in project files. Please correct me if I'm wrong.", "author": "taefi", "createdAt": "2020-12-21T11:03:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU0MTU5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY0NDk4OA==", "url": "https://github.com/vaadin/flow/pull/9676#discussion_r546644988", "bodyText": "yes, but as this is done earlier and the check does even check for jar resource theme it should handle the fronten+jar scenario and inform that the jar should be marked as a parent theme and the other should get a new name.", "author": "caalador", "createdAt": "2020-12-21T11:06:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU0MTU5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjU0Mjc2OQ==", "url": "https://github.com/vaadin/flow/pull/9676#discussion_r546542769", "bodyText": "Will anyone else have need of these paths? I would have them in the task only.", "author": "caalador", "createdAt": "2020-12-21T07:11:35Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/Constants.java", "diffHunk": "@@ -412,6 +412,25 @@\n     // Non-default port currently not supported (#7970)\n     public static final int SPRING_BOOT_DEFAULT_LIVE_RELOAD_PORT = 35729;\n \n+    /**\n+     * The name of the application theme root folder.\n+     *\n+     * It should be the direct child of frontend directory which is by default\n+     * named as \"frontend\".\n+     */\n+    public static final String APPLICATION_THEME_ROOT = \"themes\";\n+\n+    /**\n+     * The constant \"src/main/resources/META-INF/resources\" path in project\n+     * source files.\n+     */\n+    public static final String APPLICATION_META_INF_RESOURCES = \"src/main/resources/META-INF/resources\";\n+\n+    /**\n+     * The constant \"src/main/resources/static\" path in project sources files.\n+     */\n+    public static final String APPLICATION_STATIC_RESOURCES = \"src/main/resources/static\";", "originalCommit": "23a39be915d13915a55d2749f7527a8760cca889", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4f6acc7087428a60375eb86750f520644cd9073e", "url": "https://github.com/vaadin/flow/commit/4f6acc7087428a60375eb86750f520644cd9073e", "message": "Merge branch 'master' into should-throw-no-theme-exists", "committedDate": "2020-12-21T09:45:04Z", "type": "commit"}, {"oid": "fccb5ca723eccafc82e521cb7e29f36f94233abc", "url": "https://github.com/vaadin/flow/commit/fccb5ca723eccafc82e521cb7e29f36f94233abc", "message": "Apply suggestions from code review\n\nCo-authored-by: caalador <mikael.grankvist@gmail.com>", "committedDate": "2020-12-21T10:02:46Z", "type": "commit"}, {"oid": "86a0c1d4e06349c102512a2ffca635aec233719a", "url": "https://github.com/vaadin/flow/commit/86a0c1d4e06349c102512a2ffca635aec233719a", "message": "Apply suggestions from code review\n\nCo-authored-by: caalador <mikael.grankvist@gmail.com>", "committedDate": "2020-12-21T10:05:03Z", "type": "commit"}, {"oid": "a3fa9710ba22b60e39c899f35ff6ff1e6ed32108", "url": "https://github.com/vaadin/flow/commit/a3fa9710ba22b60e39c899f35ff6ff1e6ed32108", "message": "apply review comments and add tests", "committedDate": "2020-12-21T17:48:01Z", "type": "commit"}, {"oid": "bedd4a3be284749773b0f27f1c073b0aeea1ae75", "url": "https://github.com/vaadin/flow/commit/bedd4a3be284749773b0f27f1c073b0aeea1ae75", "message": "apply sonarqube review comments", "committedDate": "2020-12-21T20:27:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA5NjU1OA==", "url": "https://github.com/vaadin/flow/pull/9676#discussion_r547096558", "bodyText": "This should just be one of the possible paths. No need to single it out.", "author": "caalador", "createdAt": "2020-12-22T06:40:21Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/frontend/TaskUpdateThemeImport.java", "diffHunk": "@@ -70,4 +84,77 @@ public void execute() throws ExecutionFailedException {\n                 \"Unable to write theme import file\", e);\n         }\n     }\n+\n+    private void verifyThemeDirectoryExistence()\n+            throws ExecutionFailedException {\n+\n+        String themeName = theme.getName();\n+        String themePath = String.join(\"/\", APPLICATION_THEME_ROOT, themeName);\n+        File mainCustomThemeDir = new File(frontendDirectory, themePath);", "originalCommit": "bedd4a3be284749773b0f27f1c073b0aeea1ae75", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA5Njc2NA==", "url": "https://github.com/vaadin/flow/pull/9676#discussion_r547096764", "bodyText": "This check is only needed if we have 2 or more matches over all the possible paths.", "author": "caalador", "createdAt": "2020-12-22T06:41:10Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/frontend/TaskUpdateThemeImport.java", "diffHunk": "@@ -70,4 +84,77 @@ public void execute() throws ExecutionFailedException {\n                 \"Unable to write theme import file\", e);\n         }\n     }\n+\n+    private void verifyThemeDirectoryExistence()\n+            throws ExecutionFailedException {\n+\n+        String themeName = theme.getName();\n+        String themePath = String.join(\"/\", APPLICATION_THEME_ROOT, themeName);\n+        File mainCustomThemeDir = new File(frontendDirectory, themePath);\n+\n+        List<String> appThemePossiblePaths = getAppThemePossiblePaths(\n+                themePath);\n+        List<File> existingAppThemeDirectories =\n+                appThemePossiblePaths.stream()\n+                .map(path -> new File(npmFolder, path))\n+                .filter(File::exists)\n+                .collect(Collectors.toList());\n+\n+        String classPathThemeResourcePath = FrontendUtils.NODE_MODULES\n+                + FrontendUtils.FLOW_NPM_PACKAGE_NAME + themePath;\n+\n+        boolean appThemeFoundInClassPath = existingAppThemeDirectories.stream()\n+                .map(File::getPath)\n+                .anyMatch(path -> path.contains(classPathThemeResourcePath));", "originalCommit": "bedd4a3be284749773b0f27f1c073b0aeea1ae75", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzEwNzI2NA==", "url": "https://github.com/vaadin/flow/pull/9676#discussion_r547107264", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private List<String> getAppThemePossiblePaths(String themePath) {\n          \n          \n            \n            \n          \n          \n            \n                    String themePathInMetaInfResources = String.join(\"/\",\n          \n          \n            \n                            APPLICATION_META_INF_RESOURCES, themePath);\n          \n          \n            \n            \n          \n          \n            \n                    String themePathInStaticResources = String.join(\"/\",\n          \n          \n            \n                            APPLICATION_STATIC_RESOURCES, themePath);\n          \n          \n            \n            \n          \n          \n            \n                    String themePathInClassPathResources = FrontendUtils.NODE_MODULES\n          \n          \n            \n                            + FrontendUtils.FLOW_NPM_PACKAGE_NAME + themePath;\n          \n          \n            \n            \n          \n          \n            \n                    return Arrays.asList(themePathInMetaInfResources,\n          \n          \n            \n                            themePathInStaticResources, themePathInClassPathResources);\n          \n          \n            \n                }\n          \n          \n            \n                private List<String> getAppThemePossiblePaths(String themePath) {\n          \n          \n            \n                    String frontendTheme = String.join(\"/\",\n          \n          \n            \n                        npmFolder.toPath().relativize(frontendDirectory.toPath())\n          \n          \n            \n                            .toString(), themePath);\n          \n          \n            \n                            \n          \n          \n            \n                    String themePathInMetaInfResources = String.join(\"/\",\n          \n          \n            \n                            APPLICATION_META_INF_RESOURCES, themePath);\n          \n          \n            \n            \n          \n          \n            \n                    String themePathInStaticResources = String.join(\"/\",\n          \n          \n            \n                            APPLICATION_STATIC_RESOURCES, themePath);\n          \n          \n            \n            \n          \n          \n            \n                    String themePathInClassPathResources = String\n          \n          \n            \n                        .join(\"\", FrontendUtils.NODE_MODULES,\n          \n          \n            \n                            FrontendUtils.FLOW_NPM_PACKAGE_NAME, themePath);\n          \n          \n            \n            \n          \n          \n            \n                    return Arrays.asList(frontendTheme, themePathInMetaInfResources,\n          \n          \n            \n                        themePathInStaticResources, themePathInClassPathResources);\n          \n          \n            \n                }", "author": "caalador", "createdAt": "2020-12-22T07:13:19Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/frontend/TaskUpdateThemeImport.java", "diffHunk": "@@ -70,4 +84,77 @@ public void execute() throws ExecutionFailedException {\n                 \"Unable to write theme import file\", e);\n         }\n     }\n+\n+    private void verifyThemeDirectoryExistence()\n+            throws ExecutionFailedException {\n+\n+        String themeName = theme.getName();\n+        String themePath = String.join(\"/\", APPLICATION_THEME_ROOT, themeName);\n+        File mainCustomThemeDir = new File(frontendDirectory, themePath);\n+\n+        List<String> appThemePossiblePaths = getAppThemePossiblePaths(\n+                themePath);\n+        List<File> existingAppThemeDirectories =\n+                appThemePossiblePaths.stream()\n+                .map(path -> new File(npmFolder, path))\n+                .filter(File::exists)\n+                .collect(Collectors.toList());\n+\n+        String classPathThemeResourcePath = FrontendUtils.NODE_MODULES\n+                + FrontendUtils.FLOW_NPM_PACKAGE_NAME + themePath;\n+\n+        boolean appThemeFoundInClassPath = existingAppThemeDirectories.stream()\n+                .map(File::getPath)\n+                .anyMatch(path -> path.contains(classPathThemeResourcePath));\n+        \n+        if (appThemeFoundInClassPath && (mainCustomThemeDir.exists()\n+                || existingAppThemeDirectories.size() > 1)) {\n+            String errorMessage = \"Theme '%s' should not exist inside a \"\n+                    + \"jar and in the project at the same time.%n\"\n+                    + \"Extending another theme is possible by adding \"\n+                    + \"{ \\\"parent\\\": \\\"your-parent-theme\\\" } entry to the \"\n+                    + \"'theme.json' file inside your theme folder.\";\n+            throw new ExecutionFailedException(\n+                    String.format(errorMessage, themeName));\n+        }\n+\n+        if (existingAppThemeDirectories.size() > 1\n+                || (mainCustomThemeDir.exists()\n+                        && !existingAppThemeDirectories.isEmpty())) {\n+            String errorMessage = \"Discovered Theme folder for theme '%s' \"\n+                    + \"in more than one place in the project. Please \"\n+                    + \"make sure there is only one theme folder with name '%s' \"\n+                    + \"exists in the your project. \"\n+                    + \"The recommended place to put the theme folder inside \"\n+                    + \"the project is '%s'\";\n+            throw new ExecutionFailedException(String.format(errorMessage,\n+                    themeName, themeName, mainCustomThemeDir.getPath()));\n+        }\n+\n+        if (!mainCustomThemeDir.exists()\n+                && existingAppThemeDirectories.isEmpty()) {\n+            String errorMessage = \"Discovered @Theme annotation with theme \"\n+                    + \"name '%s', but could not find the theme directory \"\n+                    + \"in the project or available as a jar dependency. \"\n+                    + \"Check if you forgot to create the folder under '%s' \"\n+                    + \"or have mistyped the theme or folder name for '%s'.\";\n+            throw new ExecutionFailedException(String.format(errorMessage,\n+                    themeName, mainCustomThemeDir.getPath(), themeName));\n+        }\n+    }\n+\n+    private List<String> getAppThemePossiblePaths(String themePath) {\n+\n+        String themePathInMetaInfResources = String.join(\"/\",\n+                APPLICATION_META_INF_RESOURCES, themePath);\n+\n+        String themePathInStaticResources = String.join(\"/\",\n+                APPLICATION_STATIC_RESOURCES, themePath);\n+\n+        String themePathInClassPathResources = FrontendUtils.NODE_MODULES\n+                + FrontendUtils.FLOW_NPM_PACKAGE_NAME + themePath;\n+\n+        return Arrays.asList(themePathInMetaInfResources,\n+                themePathInStaticResources, themePathInClassPathResources);\n+    }", "originalCommit": "bedd4a3be284749773b0f27f1c073b0aeea1ae75", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzEwNzczOQ==", "url": "https://github.com/vaadin/flow/pull/9676#discussion_r547107739", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    String classPathThemeResourcePath = FrontendUtils.NODE_MODULES\n          \n          \n            \n                            + FrontendUtils.FLOW_NPM_PACKAGE_NAME + themePath;\n          \n          \n            \n            \n          \n          \n            \n                    boolean appThemeFoundInClassPath = existingAppThemeDirectories.stream()\n          \n          \n            \n                            .map(File::getPath)\n          \n          \n            \n                            .anyMatch(path -> path.contains(classPathThemeResourcePath));\n          \n          \n            \n                    \n          \n          \n            \n                    if (appThemeFoundInClassPath && (mainCustomThemeDir.exists()\n          \n          \n            \n                            || existingAppThemeDirectories.size() > 1)) {\n          \n          \n            \n                        String errorMessage = \"Theme '%s' should not exist inside a \"\n          \n          \n            \n                                + \"jar and in the project at the same time.%n\"\n          \n          \n            \n                                + \"Extending another theme is possible by adding \"\n          \n          \n            \n                                + \"{ \\\"parent\\\": \\\"your-parent-theme\\\" } entry to the \"\n          \n          \n            \n                                + \"'theme.json' file inside your theme folder.\";\n          \n          \n            \n                        throw new ExecutionFailedException(\n          \n          \n            \n                                String.format(errorMessage, themeName));\n          \n          \n            \n                    }\n          \n          \n            \n            \n          \n          \n            \n                    if (existingAppThemeDirectories.size() > 1\n          \n          \n            \n                            || (mainCustomThemeDir.exists()\n          \n          \n            \n                                    && !existingAppThemeDirectories.isEmpty())) {\n          \n          \n            \n                        String errorMessage = \"Discovered Theme folder for theme '%s' \"\n          \n          \n            \n                                + \"in more than one place in the project. Please \"\n          \n          \n            \n                                + \"make sure there is only one theme folder with name '%s' \"\n          \n          \n            \n                                + \"exists in the your project. \"\n          \n          \n            \n                                + \"The recommended place to put the theme folder inside \"\n          \n          \n            \n                                + \"the project is '%s'\";\n          \n          \n            \n                        throw new ExecutionFailedException(String.format(errorMessage,\n          \n          \n            \n                                themeName, themeName, mainCustomThemeDir.getPath()));\n          \n          \n            \n                    }\n          \n          \n            \n            \n          \n          \n            \n                    if (!mainCustomThemeDir.exists()\n          \n          \n            \n                            && existingAppThemeDirectories.isEmpty()) {\n          \n          \n            \n                        String errorMessage = \"Discovered @Theme annotation with theme \"\n          \n          \n            \n                                + \"name '%s', but could not find the theme directory \"\n          \n          \n            \n                                + \"in the project or available as a jar dependency. \"\n          \n          \n            \n                                + \"Check if you forgot to create the folder under '%s' \"\n          \n          \n            \n                                + \"or have mistyped the theme or folder name for '%s'.\";\n          \n          \n            \n                        throw new ExecutionFailedException(String.format(errorMessage,\n          \n          \n            \n                                themeName, mainCustomThemeDir.getPath(), themeName));\n          \n          \n            \n                    }\n          \n          \n            \n                    \n          \n          \n            \n                    if (existingAppThemeDirectories.isEmpty()) {\n          \n          \n            \n                        String errorMessage = \"Discovered @Theme annotation with theme \"\n          \n          \n            \n                            + \"name '%s', but could not find the theme directory \"\n          \n          \n            \n                            + \"in the project or available as a jar dependency. \"\n          \n          \n            \n                            + \"Check if you forgot to create the folder under '%s' \"\n          \n          \n            \n                            + \"or have mistyped the theme or folder name for '%s'.\";\n          \n          \n            \n                        throw new ExecutionFailedException(String\n          \n          \n            \n                            .format(errorMessage, themeName,\n          \n          \n            \n                                new File(frontendDirectory, APPLICATION_THEME_ROOT)\n          \n          \n            \n                                    .getPath(), themeName));\n          \n          \n            \n                    }\n          \n          \n            \n                    if (existingAppThemeDirectories.size() >= 2) {\n          \n          \n            \n            \n          \n          \n            \n                        boolean appThemeFoundInClassPath = existingAppThemeDirectories\n          \n          \n            \n                            .stream().map(File::getPath)\n          \n          \n            \n                            .anyMatch(path -> path.contains(FrontendUtils.FLOW_NPM_PACKAGE_NAME));\n          \n          \n            \n            \n          \n          \n            \n                        if (appThemeFoundInClassPath) {\n          \n          \n            \n                            String errorMessage = \"Theme '%s' should not exist inside a \"\n          \n          \n            \n                                + \"jar and in the project at the same time.%n\"\n          \n          \n            \n                                + \"Extending another theme is possible by adding \"\n          \n          \n            \n                                + \"{ \\\"parent\\\": \\\"your-parent-theme\\\" } entry to the \"\n          \n          \n            \n                                + \"'theme.json' file inside your theme folder.\";\n          \n          \n            \n                            throw new ExecutionFailedException(\n          \n          \n            \n                                String.format(errorMessage, themeName));\n          \n          \n            \n                        } else {\n          \n          \n            \n                            String errorMessage = \"Discovered Theme folder for theme '%s' \"\n          \n          \n            \n                                + \"in more than one place in the project. Please \"\n          \n          \n            \n                                + \"make sure there is only one theme folder with name '%s' \"\n          \n          \n            \n                                + \"exists in the your project. \"\n          \n          \n            \n                                + \"The recommended place to put the theme folder inside \"\n          \n          \n            \n                                + \"the project is '%s'\";\n          \n          \n            \n                            throw new ExecutionFailedException(String\n          \n          \n            \n                                .format(errorMessage, themeName, themeName,\n          \n          \n            \n                                    new File(frontendDirectory, APPLICATION_THEME_ROOT)\n          \n          \n            \n                                        .getPath()));\n          \n          \n            \n                        }\n          \n          \n            \n                    }", "author": "caalador", "createdAt": "2020-12-22T07:14:34Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/frontend/TaskUpdateThemeImport.java", "diffHunk": "@@ -70,4 +84,77 @@ public void execute() throws ExecutionFailedException {\n                 \"Unable to write theme import file\", e);\n         }\n     }\n+\n+    private void verifyThemeDirectoryExistence()\n+            throws ExecutionFailedException {\n+\n+        String themeName = theme.getName();\n+        String themePath = String.join(\"/\", APPLICATION_THEME_ROOT, themeName);\n+        File mainCustomThemeDir = new File(frontendDirectory, themePath);\n+\n+        List<String> appThemePossiblePaths = getAppThemePossiblePaths(\n+                themePath);\n+        List<File> existingAppThemeDirectories =\n+                appThemePossiblePaths.stream()\n+                .map(path -> new File(npmFolder, path))\n+                .filter(File::exists)\n+                .collect(Collectors.toList());\n+\n+        String classPathThemeResourcePath = FrontendUtils.NODE_MODULES\n+                + FrontendUtils.FLOW_NPM_PACKAGE_NAME + themePath;\n+\n+        boolean appThemeFoundInClassPath = existingAppThemeDirectories.stream()\n+                .map(File::getPath)\n+                .anyMatch(path -> path.contains(classPathThemeResourcePath));\n+        \n+        if (appThemeFoundInClassPath && (mainCustomThemeDir.exists()\n+                || existingAppThemeDirectories.size() > 1)) {\n+            String errorMessage = \"Theme '%s' should not exist inside a \"\n+                    + \"jar and in the project at the same time.%n\"\n+                    + \"Extending another theme is possible by adding \"\n+                    + \"{ \\\"parent\\\": \\\"your-parent-theme\\\" } entry to the \"\n+                    + \"'theme.json' file inside your theme folder.\";\n+            throw new ExecutionFailedException(\n+                    String.format(errorMessage, themeName));\n+        }\n+\n+        if (existingAppThemeDirectories.size() > 1\n+                || (mainCustomThemeDir.exists()\n+                        && !existingAppThemeDirectories.isEmpty())) {\n+            String errorMessage = \"Discovered Theme folder for theme '%s' \"\n+                    + \"in more than one place in the project. Please \"\n+                    + \"make sure there is only one theme folder with name '%s' \"\n+                    + \"exists in the your project. \"\n+                    + \"The recommended place to put the theme folder inside \"\n+                    + \"the project is '%s'\";\n+            throw new ExecutionFailedException(String.format(errorMessage,\n+                    themeName, themeName, mainCustomThemeDir.getPath()));\n+        }\n+\n+        if (!mainCustomThemeDir.exists()\n+                && existingAppThemeDirectories.isEmpty()) {\n+            String errorMessage = \"Discovered @Theme annotation with theme \"\n+                    + \"name '%s', but could not find the theme directory \"\n+                    + \"in the project or available as a jar dependency. \"\n+                    + \"Check if you forgot to create the folder under '%s' \"\n+                    + \"or have mistyped the theme or folder name for '%s'.\";\n+            throw new ExecutionFailedException(String.format(errorMessage,\n+                    themeName, mainCustomThemeDir.getPath(), themeName));\n+        }", "originalCommit": "bedd4a3be284749773b0f27f1c073b0aeea1ae75", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzEwNzgxMg==", "url": "https://github.com/vaadin/flow/pull/9676#discussion_r547107812", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    File mainCustomThemeDir = new File(frontendDirectory, themePath);", "author": "caalador", "createdAt": "2020-12-22T07:14:55Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/frontend/TaskUpdateThemeImport.java", "diffHunk": "@@ -70,4 +84,77 @@ public void execute() throws ExecutionFailedException {\n                 \"Unable to write theme import file\", e);\n         }\n     }\n+\n+    private void verifyThemeDirectoryExistence()\n+            throws ExecutionFailedException {\n+\n+        String themeName = theme.getName();\n+        String themePath = String.join(\"/\", APPLICATION_THEME_ROOT, themeName);\n+        File mainCustomThemeDir = new File(frontendDirectory, themePath);", "originalCommit": "bedd4a3be284749773b0f27f1c073b0aeea1ae75", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4e0e55959428775f82177edf1c1868ceffc04081", "url": "https://github.com/vaadin/flow/commit/4e0e55959428775f82177edf1c1868ceffc04081", "message": "Apply suggestions from code review\n\nCo-authored-by: caalador <mikael.grankvist@gmail.com>", "committedDate": "2020-12-22T08:48:11Z", "type": "commit"}, {"oid": "85d1042978e3f1b8325b66cc1c34fa301cedcf15", "url": "https://github.com/vaadin/flow/commit/85d1042978e3f1b8325b66cc1c34fa301cedcf15", "message": "format codes", "committedDate": "2020-12-22T09:03:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE1ODU3MA==", "url": "https://github.com/vaadin/flow/pull/9676#discussion_r547158570", "bodyText": "Minor nit. Now that I read this like this appThemeFoundInClasPath is not perhaps the most explanatory name. Could be jarThemeFound as that's what it checks, also it's basically not on the classpath what we check.", "author": "caalador", "createdAt": "2020-12-22T09:13:23Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/frontend/TaskUpdateThemeImport.java", "diffHunk": "@@ -70,4 +84,77 @@ public void execute() throws ExecutionFailedException {\n                 \"Unable to write theme import file\", e);\n         }\n     }\n+\n+    private void verifyThemeDirectoryExistence()\n+            throws ExecutionFailedException {\n+\n+        String themeName = theme.getName();\n+        String themePath = String.join(\"/\", APPLICATION_THEME_ROOT, themeName);\n+\n+        List<String> appThemePossiblePaths = getAppThemePossiblePaths(\n+                themePath);\n+        List<File> existingAppThemeDirectories = appThemePossiblePaths.stream()\n+                .map(path -> new File(npmFolder, path))\n+                .filter(File::exists)\n+                .collect(Collectors.toList());\n+\n+        if (existingAppThemeDirectories.isEmpty()) {\n+            String errorMessage = \"Discovered @Theme annotation with theme \"\n+                    + \"name '%s', but could not find the theme directory \"\n+                    + \"in the project or available as a jar dependency. \"\n+                    + \"Check if you forgot to create the folder under '%s' \"\n+                    + \"or have mistyped the theme or folder name for '%s'.\";\n+            throw new ExecutionFailedException(\n+                    String.format(errorMessage, themeName,\n+                            new File(frontendDirectory, APPLICATION_THEME_ROOT)\n+                                    .getPath(), themeName));\n+        }\n+        if (existingAppThemeDirectories.size() >= 2) {\n+\n+            boolean appThemeFoundInClassPath = existingAppThemeDirectories\n+                    .stream().map(File::getPath)\n+                    .anyMatch(path -> path\n+                            .contains(FrontendUtils.FLOW_NPM_PACKAGE_NAME));\n+\n+            if (appThemeFoundInClassPath) {", "originalCommit": "85d1042978e3f1b8325b66cc1c34fa301cedcf15", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE5MzAxMA==", "url": "https://github.com/vaadin/flow/pull/9676#discussion_r547193010", "bodyText": "Agree, renamed it themeFoundInJar to be read as a natural sentence in if", "author": "taefi", "createdAt": "2020-12-22T10:21:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE1ODU3MA=="}], "type": "inlineReview"}, {"oid": "97105842e8aa54f5f4d0073d01b0225336e3d9e7", "url": "https://github.com/vaadin/flow/commit/97105842e8aa54f5f4d0073d01b0225336e3d9e7", "message": "refactored variable name for better readability", "committedDate": "2020-12-22T10:19:53Z", "type": "commit"}]}