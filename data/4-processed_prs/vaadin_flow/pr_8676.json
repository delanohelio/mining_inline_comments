{"pr_number": 8676, "pr_title": "Add getItem(int index) to DataView #8652", "pr_createdAt": "2020-07-01T15:35:32Z", "pr_url": "https://github.com/vaadin/flow/pull/8676", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ3MTgwOQ==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r448471809", "bodyText": "The intention was that it works the same way regardless of anything, defined or undefined size.\nSo this should use the data communicator to get the item and the data communicator gets the item from active range or makes a fetch query.", "author": "pleku", "createdAt": "2020-07-01T16:13:50Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/AbstractLazyDataView.java", "diffHunk": "@@ -37,28 +37,46 @@\n      * Creates a new instance and verifies the passed data provider is\n      * compatible with this data view implementation.\n      *\n-     * @param dataCommunicator\n-     *            the data communicator of the component\n-     * @param component\n-     *            the component\n+     * @param dataCommunicator the data communicator of the component\n+     * @param component        the component\n      */\n     public AbstractLazyDataView(DataCommunicator<T> dataCommunicator,\n-            Component component) {\n+                                Component component) {\n         super(dataCommunicator::getDataProvider, component);\n         this.dataCommunicator = dataCommunicator;\n     }\n \n     /**\n      * Returns the data communicator for the component and checks that the data\n      * provider is of the correct type.\n-     * \n+     *\n      * @return the data communicator\n      */\n     protected DataCommunicator<T> getDataCommunicator() {\n         verifyDataProviderType(dataCommunicator.getDataProvider().getClass());\n         return dataCommunicator;\n     }\n \n+    @SuppressWarnings(\"unchecked\")\n+    @Override\n+    public T getItem(int index) {\n+        DataCommunicator<T> verifiedDataCommunicator = getDataCommunicator();\n+        if (verifiedDataCommunicator.isDefinedSize()) {\n+            final int itemCount = this.dataCommunicator.getDataSize();\n+            validateItemIndex(index, itemCount);\n+            Optional<T> optionalItem =\n+                    verifiedDataCommunicator.getDataProvider()\n+                            .fetch(this.dataCommunicator.buildQuery(index, 1))\n+                            .findFirst();\n+            return optionalItem.orElseThrow(() ->\n+                    new IllegalStateException(String.format(\n+                            \"Item with an index %d is expected to be fetched\" +\n+                                    \" from backend, but not found\", index)));\n+        } else {\n+            return verifiedDataCommunicator.getActiveItemOnIndex(index);", "originalCommit": "15c48e25b555315c0ca4da6fea123d9b165e36d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyMzU0Ng==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r448523546", "bodyText": "activeKeyOrder in DataCommunicator might not contain all the items available in backend, if user has't scrolled to the end. So we can't obtain non-active items this way, and with backend query we can. BUT this probably does not make sense, why do someone need something which is not fetched and rendered/visible. So you right, this should be unified and  I would prefer getActiveItemOnIndex over backend query, because in that case the items are already cached, no need to send the one more request. Will fix.", "author": "mshabarov", "createdAt": "2020-07-01T17:49:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ3MTgwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU4NDYwOQ==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r448584609", "bodyText": "I cannot come up with why would one want to get item at some index that is not visible, but if getItem(int index) only returns the item when it happens to be on active range, it cannot be named getItem. And the exact point of the rename and this ticket was to make it always return the item in the given index.\nOne case where someone might want to get the index that is not active is because it is somehow related to bookmark / navigation / linking and the item needs to be fetched even if the grid scroll position might not change. Anyway the point is still that if getItem only works for active range, it cannot be named getItem then.", "author": "pleku", "createdAt": "2020-07-01T19:56:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ3MTgwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAzNjExNA==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r449036114", "bodyText": "Thank you for explanations! Done", "author": "mshabarov", "createdAt": "2020-07-02T14:19:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ3MTgwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ3MjU2NQ==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r448472565", "bodyText": "This logic IMO  belongs to the data communicator, not here.", "author": "pleku", "createdAt": "2020-07-01T16:15:02Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/AbstractLazyDataView.java", "diffHunk": "@@ -37,28 +37,46 @@\n      * Creates a new instance and verifies the passed data provider is\n      * compatible with this data view implementation.\n      *\n-     * @param dataCommunicator\n-     *            the data communicator of the component\n-     * @param component\n-     *            the component\n+     * @param dataCommunicator the data communicator of the component\n+     * @param component        the component\n      */\n     public AbstractLazyDataView(DataCommunicator<T> dataCommunicator,\n-            Component component) {\n+                                Component component) {\n         super(dataCommunicator::getDataProvider, component);\n         this.dataCommunicator = dataCommunicator;\n     }\n \n     /**\n      * Returns the data communicator for the component and checks that the data\n      * provider is of the correct type.\n-     * \n+     *\n      * @return the data communicator\n      */\n     protected DataCommunicator<T> getDataCommunicator() {\n         verifyDataProviderType(dataCommunicator.getDataProvider().getClass());\n         return dataCommunicator;\n     }\n \n+    @SuppressWarnings(\"unchecked\")\n+    @Override\n+    public T getItem(int index) {\n+        DataCommunicator<T> verifiedDataCommunicator = getDataCommunicator();\n+        if (verifiedDataCommunicator.isDefinedSize()) {", "originalCommit": "15c48e25b555315c0ca4da6fea123d9b165e36d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAzNjUwMQ==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r449036501", "bodyText": "Yes, moved to data communicator. Done", "author": "mshabarov", "createdAt": "2020-07-02T14:19:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ3MjU2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ3NDMzNQ==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r448474335", "bodyText": "This would mean that the item is not given when the component has not fetched any items.\nWould be weird that the same code fails first but later on works.", "author": "pleku", "createdAt": "2020-07-01T16:17:54Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/DataCommunicator.java", "diffHunk": "@@ -325,6 +325,10 @@ public boolean isItemActive(T item) {\n      * @return the item\n      */\n     public T getActiveItemOnIndex(int index) {\n+        if (activeKeyOrder.size() == 0) {", "originalCommit": "15c48e25b555315c0ca4da6fea123d9b165e36d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUzODQ2OQ==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r448538469", "bodyText": "I could make it return null instead of throws. List implementation should also return null then also. Or you mean something else?\nOne thing is that if the component fetches no items (both activeStart and activeKeyOrder are 0), then the exception message is \"Given index SOME_INDEX is outside of the active range of the component '0 - -1'\"", "author": "mshabarov", "createdAt": "2020-07-01T18:18:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ3NDMzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU4MzIzNQ==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r448583235", "bodyText": "As I'm trying to explain, the data communicator should take care of things so that\n\nit first checks if the item is on active index and returns if is\nit makes a backend query for the index (as offset) with limit as 1 and gets the item from the backend.\n\nSo basically the item is always returned, regardless of list, lazy with exact size or lazy with unknown size.", "author": "pleku", "createdAt": "2020-07-01T19:52:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ3NDMzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAzOTUxMg==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r449039512", "bodyText": "Thanks for explanations. Now it's totally clear. Done.", "author": "mshabarov", "createdAt": "2020-07-02T14:23:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ3NDMzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ3NDYzMA==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r448474630", "bodyText": "We can hide this method, not expose it anymore", "author": "pleku", "createdAt": "2020-07-01T16:18:26Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/DataCommunicator.java", "diffHunk": "@@ -325,6 +325,10 @@ public boolean isItemActive(T item) {\n      * @return the item\n      */\n     public T getActiveItemOnIndex(int index) {", "originalCommit": "15c48e25b555315c0ca4da6fea123d9b165e36d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ3NDkzMw==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r448474933", "bodyText": "Just expose getItemOnIndex which works consistently", "author": "pleku", "createdAt": "2020-07-01T16:18:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ3NDYzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0MTYwNw==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r448541607", "bodyText": "Not sure I understand your idea. getActiveItemOnIndex was only used for getItemOnRow/Index in components, and now it's going to be used only for getItem method.", "author": "mshabarov", "createdAt": "2020-07-01T18:24:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ3NDYzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU4MjMzMA==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r448582330", "bodyText": "The idea is that this method is not needed anymore - we can just add getItem(int index) to DataCommunicator and make it work whenever called. The method implementation will handle the state details of data communicator.\nIt is not IMO good design that data views would have to check the state of data communicator to decide how to get an item from it. That is a code smell to me. The data communicator should not expose extra API like active range if not needed outside - it should just provide a T getItem(int index) that works for exact or estimated row count.", "author": "pleku", "createdAt": "2020-07-01T19:51:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ3NDYzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA0MDA3Ng==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r449040076", "bodyText": "Done", "author": "mshabarov", "createdAt": "2020-07-02T14:24:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ3NDYzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ3NjU4MA==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r448476580", "bodyText": "Please emphasize the \"filtered and sorted data set\"", "author": "pleku", "createdAt": "2020-07-01T16:21:33Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/DataView.java", "diffHunk": "@@ -28,12 +28,22 @@\n  * Base view interface for getting information on current data set of a\n  * Component.\n  *\n- * @param <T>\n- *            data type\n+ * @param <T> data type\n  * @since\n  */\n public interface DataView<T> extends Serializable {\n \n+    /**\n+     * Gets the item at the given index from the data available to the\n+     * component. Data is filtered and sorted the same way as in the component.\n+     *\n+     * @param index item index number\n+     * @return item on index\n+     * @throws IndexOutOfBoundsException requested index is outside of the\n+     *                                   available data set.", "originalCommit": "15c48e25b555315c0ca4da6fea123d9b165e36d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA0MDE0NA==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r449040144", "bodyText": "Done", "author": "mshabarov", "createdAt": "2020-07-02T14:24:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ3NjU4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ3ODA2Mw==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r448478063", "bodyText": "Missing test that sorting and filtering is applied?", "author": "pleku", "createdAt": "2020-07-01T16:24:13Z", "path": "flow-data/src/test/java/com/vaadin/flow/data/provider/AbstractLazyDataViewTest.java", "diffHunk": "@@ -251,6 +256,138 @@ public void getItems_withUndefinedSize() {\n                 items.count());\n     }\n \n+    @Test\n+    public void getItem_withDefinedSizeAndCorrectIndex() {\n+        dataCommunicator.setRequestedRange(0, 50);\n+        dataCommunicator.setDataProvider(DataProvider.fromCallbacks(query -> {\n+            query.getOffset();\n+            query.getLimit();\n+            return Stream.of(\"foo\", \"bar\", \"baz\");\n+        }, query -> 3), null);\n+\n+        Assert.assertEquals(\"Invalid item on index 0\", \"foo\",\n+                dataView.getItem(0));\n+    }\n+\n+    @Test\n+    public void getItem_withDefinedSizeAndNegativeIndex() {\n+        exceptionRule.expect(IndexOutOfBoundsException.class);\n+        exceptionRule.expectMessage(\n+                \"Given index -1 is outside of the accepted range '0 - 2'\");\n+        dataCommunicator.setRequestedRange(0, 50);\n+        dataCommunicator.setDataProvider(DataProvider.fromCallbacks(query -> {\n+            query.getOffset();\n+            query.getLimit();\n+            return Stream.of(\"foo\", \"bar\", \"baz\");\n+        }, query -> 3), null);\n+\n+        dataView.getItem(-1);\n+    }\n+\n+    @Test\n+    public void getItem_withDefinedSizeAndEmptyDataset() {\n+        exceptionRule.expect(IndexOutOfBoundsException.class);\n+        exceptionRule.expectMessage(\n+                \"Requested index 0 on empty data.\");\n+        dataCommunicator.setRequestedRange(0, 50);\n+        dataCommunicator.setDataProvider(DataProvider.fromCallbacks(query -> {\n+            query.getOffset();\n+            query.getLimit();\n+            return Stream.empty();\n+        }, query -> 0), null);\n+\n+        dataView.getItem(0);\n+    }\n+\n+    @Test\n+    public void getItem_withDefinedSizeAndIndexOutsideOfRange() {\n+        exceptionRule.expect(IndexOutOfBoundsException.class);\n+        exceptionRule.expectMessage(\n+                \"Given index 3 is outside of the accepted range '0 - 2'\");\n+        dataCommunicator.setRequestedRange(0, 50);\n+        dataCommunicator.setDataProvider(DataProvider.fromCallbacks(query -> {\n+            query.getOffset();\n+            query.getLimit();\n+            return Stream.of(\"foo\", \"bar\", \"baz\");\n+        }, query -> 3), null);\n+\n+        Assert.assertEquals(\"Invalid item on index 0\", \"foo\",\n+                dataView.getItem(3));\n+    }\n+\n+    @Test\n+    public void getItem_withUndefinedSizeAndCorrectIndex() {\n+        dataCommunicator.setRequestedRange(0, 50);\n+        dataCommunicator.setDataProvider(DataProvider.fromCallbacks(query -> {\n+            query.getOffset();\n+            query.getLimit();\n+            return Stream.of(\"foo\", \"bar\", \"baz\");\n+        }, query -> -1), null);\n+\n+        dataCommunicator.setRowCountEstimate(5);\n+        fakeClientCommunication();\n+\n+        Assert.assertEquals(\"Wrong item on index 0\", \"foo\",\n+                dataView.getItem(0));\n+        Assert.assertEquals(\"Wrong item on index 2\", \"baz\",\n+                dataView.getItem(2));\n+    }\n+\n+    @Test\n+    public void getItem_withUndefinedSizeAndNegativeIndex() {\n+        exceptionRule.expect(IndexOutOfBoundsException.class);\n+        exceptionRule.expectMessage(\n+                \"Given index -1 is outside of the active range of the \" +\n+                        \"component '0 - 2'\");\n+        dataCommunicator.setRequestedRange(0, 50);\n+        dataCommunicator.setDataProvider(DataProvider.fromCallbacks(query -> {\n+            query.getOffset();\n+            query.getLimit();\n+            return Stream.of(\"foo\", \"bar\", \"baz\");\n+        }, query -> -1), null);\n+\n+        dataCommunicator.setRowCountEstimate(1);\n+        fakeClientCommunication();\n+\n+        dataView.getItem(-1);\n+    }\n+\n+    @Test\n+    public void getItem_withUndefinedSizeAndEmptyDataset() {\n+        exceptionRule.expect(IndexOutOfBoundsException.class);\n+        exceptionRule.expectMessage(\"Requested index 0 on empty data.\");\n+        dataCommunicator.setRequestedRange(0, 50);\n+        dataCommunicator.setDataProvider(DataProvider.fromCallbacks(query -> {\n+            query.getOffset();\n+            query.getLimit();\n+            return Stream.empty();\n+        }, query -> -1), null);\n+\n+        dataCommunicator.setRowCountEstimate(2);\n+        fakeClientCommunication();\n+\n+        dataView.getItem(0);\n+    }\n+\n+    @Test\n+    public void getItem_withUndefinedSizeAndIndexOutsideOfRange() {\n+        exceptionRule.expect(IndexOutOfBoundsException.class);\n+        exceptionRule.expectMessage(\n+                \"Given index 3 is outside of the active range of the \" +\n+                        \"component '0 - 2'\");\n+        dataCommunicator.setRequestedRange(0, 50);\n+        dataCommunicator.setDataProvider(DataProvider.fromCallbacks(query -> {\n+            query.getOffset();\n+            query.getLimit();\n+            return Stream.of(\"foo\", \"bar\", \"baz\");\n+        }, query -> -1), null);\n+\n+        dataCommunicator.setRowCountEstimate(3);\n+        fakeClientCommunication();\n+\n+        dataView.getItem(3);", "originalCommit": "15c48e25b555315c0ca4da6fea123d9b165e36d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA0MDI0Mw==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r449040243", "bodyText": "Done", "author": "mshabarov", "createdAt": "2020-07-02T14:24:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ3ODA2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ3ODY2Ng==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r448478666", "bodyText": "Missing tests for sorting and filtering", "author": "pleku", "createdAt": "2020-07-01T16:25:13Z", "path": "flow-data/src/test/java/com/vaadin/flow/data/provider/AbstractListDataViewTest.java", "diffHunk": "@@ -741,6 +713,34 @@ public void updateItem_itemNotPresent_itemNotRefreshed() {\n                 .refreshItem(updatedItem);\n     }\n \n+    @Test\n+    public void getItem_correctIndex_itemFound() {\n+        Assert.assertEquals(\"Wrong item returned for index\", \"first\",\n+                dataView.getItem(0));\n+    }\n+\n+    @Test\n+    public void getItem_negativeIndex_throwsException() {\n+        exceptionRule.expect(IndexOutOfBoundsException.class);\n+        exceptionRule.expectMessage(\n+                \"Given index -1 is outside of the accepted range '0 - 2'\");\n+        dataView.getItem(-1);\n+    }\n+\n+    @Test\n+    public void getItem_emptyDataSet_throwsException() {\n+        dataProvider = DataProvider.ofItems();\n+        exceptionRule.expect(IndexOutOfBoundsException.class);\n+        exceptionRule.expectMessage(\"Requested index 0 on empty data.\");\n+        dataView.getItem(0);\n+    }\n+\n+    @Test\n+    public void getItem_indexOutsideOfSize_throwsException() {\n+        exceptionRule.expect(IndexOutOfBoundsException.class);\n+        dataView.getItem(items.size());\n+    }", "originalCommit": "15c48e25b555315c0ca4da6fea123d9b165e36d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA0MDMxNQ==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r449040315", "bodyText": "Done", "author": "mshabarov", "createdAt": "2020-07-02T14:24:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ3ODY2Ng=="}], "type": "inlineReview"}, {"oid": "589d3da1d5fd1eb5dd4c52564220a800e7e7f0bd", "url": "https://github.com/vaadin/flow/commit/589d3da1d5fd1eb5dd4c52564220a800e7e7f0bd", "message": "Rework getItem, filtering and sorting tests added", "committedDate": "2020-07-02T14:20:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIwMDM4NQ==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r449200385", "bodyText": "I think this intentionally on multiple lines, so you'd should revert this and use\n//@formatter:on ...", "author": "pleku", "createdAt": "2020-07-02T18:33:49Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/AbstractListDataView.java", "diffHunk": "@@ -173,9 +173,7 @@ public boolean contains(T item) {\n     @Override\n     public AbstractListDataView<T> updateItem(T item) {\n         Objects.requireNonNull(item, NULL_ITEM_ERROR_MESSAGE);\n-        getItems()\n-                .filter(i -> equals(item, i))\n-                .findFirst()\n+        getItems().filter(i -> equals(item, i)).findFirst()", "originalCommit": "589d3da1d5fd1eb5dd4c52564220a800e7e7f0bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUzNDI2Mg==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r449534262", "bodyText": "Done", "author": "mshabarov", "createdAt": "2020-07-03T11:28:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIwMDM4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIwMDYzMA==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r449200630", "bodyText": "I think this intentionally on multiple lines, so you'd should revert this and use\n//@formatter:on ...", "author": "pleku", "createdAt": "2020-07-02T18:34:23Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/AbstractListDataView.java", "diffHunk": "@@ -186,10 +184,8 @@ public boolean contains(T item) {\n         if (!items.isEmpty()) {\n             final ListDataProvider<T> dataProvider = getDataProvider();\n             Collection<T> backendItems = dataProvider.getItems();\n-            items.stream()\n-                    .filter(this::contains)\n-                    .forEach(item ->\n-                            removeItemIfPresent(item, dataProvider));\n+            items.stream().filter(this::contains)\n+                    .forEach(item -> removeItemIfPresent(item, dataProvider));", "originalCommit": "589d3da1d5fd1eb5dd4c52564220a800e7e7f0bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUzNDMwNQ==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r449534305", "bodyText": "Done", "author": "mshabarov", "createdAt": "2020-07-03T11:29:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIwMDYzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIwMDc2MA==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r449200760", "bodyText": "I think this intentionally on multiple lines, so you'd should revert this and use\n//@formatter:on ...", "author": "pleku", "createdAt": "2020-07-02T18:34:36Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/AbstractListDataView.java", "diffHunk": "@@ -281,8 +276,7 @@ private int getItemIndex(T item) {\n         Objects.requireNonNull(item, NULL_ITEM_ERROR_MESSAGE);\n         AtomicInteger index = new AtomicInteger(-1);\n         if (!getItems().peek(t -> index.incrementAndGet())\n-                .filter(t -> equals(item, t))\n-                .findFirst().isPresent()) {\n+                .filter(t -> equals(item, t)).findFirst().isPresent()) {", "originalCommit": "589d3da1d5fd1eb5dd4c52564220a800e7e7f0bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUzNDM1MA==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r449534350", "bodyText": "Done", "author": "mshabarov", "createdAt": "2020-07-03T11:29:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIwMDc2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIwMjU3NA==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r449202574", "bodyText": "NIT: \"the index of the item to get\" is IMO the better wording to use here, why change it ?", "author": "pleku", "createdAt": "2020-07-02T18:38:40Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/DataCommunicator.java", "diffHunk": "@@ -316,22 +316,38 @@ public boolean isItemActive(T item) {\n     }\n \n     /**\n-     * Returns the active item at the given index or throws a\n-     * {@link IndexOutOfBoundsException} in case the item is not active at the\n-     * moment.\n-     * \n+     * Gets the item at the given index from the data available to the\n+     * component. Data is filtered and sorted the same way as in the component.\n+     * <p>\n+     * Call to the backend is triggered if the item for a requested index is\n+     * not present in the cached active items.\n+     *\n      * @param index\n-     *            the index of the item to get\n-     * @return the item\n+     *            item index number", "originalCommit": "589d3da1d5fd1eb5dd4c52564220a800e7e7f0bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUzNDQ0NA==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r449534444", "bodyText": "Reverted, done", "author": "mshabarov", "createdAt": "2020-07-03T11:29:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIwMjU3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIxMDkxNg==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r449210916", "bodyText": "For unknown size, getItemCount() returns either 0 (initially) or the current estimate.\nWhy is not intentionally working if I ask for the item that is current estimate + 1?\nWhy is not intentionally working if I ask for the first item before the data communicator has fetched any items?\nIt should be my problem if my backend cannot handle the query for outside the range, or then when I return null then this just returns null.\nI would presume that\n\nif exact size is used and I request outside the current size, I get the exception because we know this\nif unknown size is used, the query is done even if it is outside of the current estimate - what this method returns cannot depend on the active range or the estimate at that moment or whether or not the data provider has loaded any items yet, as the flush occurs later during the roundtrip.", "author": "pleku", "createdAt": "2020-07-02T18:56:40Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/DataCommunicator.java", "diffHunk": "@@ -316,22 +316,38 @@ public boolean isItemActive(T item) {\n     }\n \n     /**\n-     * Returns the active item at the given index or throws a\n-     * {@link IndexOutOfBoundsException} in case the item is not active at the\n-     * moment.\n-     * \n+     * Gets the item at the given index from the data available to the\n+     * component. Data is filtered and sorted the same way as in the component.\n+     * <p>\n+     * Call to the backend is triggered if the item for a requested index is\n+     * not present in the cached active items.\n+     *\n      * @param index\n-     *            the index of the item to get\n-     * @return the item\n+     *            item index number\n+     * @return item on index\n+     * @throws IndexOutOfBoundsException\n+     *             requested index is outside of the filtered and sorted data\n+     *             set or the data set is empty\n      */\n-    public T getActiveItemOnIndex(int index) {\n+    @SuppressWarnings(\"unchecked\")\n+    public T getItem(int index) {\n         int activeDataEnd = activeStart + activeKeyOrder.size() - 1;\n         if (index < activeStart || index > activeDataEnd) {\n-            throw new IndexOutOfBoundsException(String.format(\n-                    \"Given index %d is outside of the active range of the component '%d - %d'\",\n-                    index, activeStart, activeDataEnd));\n+            int dataSize = getItemCount();", "originalCommit": "589d3da1d5fd1eb5dd4c52564220a800e7e7f0bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUzNTIzNQ==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r449535235", "bodyText": "Excellent comment! I've missed those two cases. Done", "author": "mshabarov", "createdAt": "2020-07-03T11:31:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIxMDkxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIxMzkwMA==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r449213900", "bodyText": "I think a stream that just provides an object that can be validated against the correct index could be used instead of an empty string", "author": "pleku", "createdAt": "2020-07-02T19:03:06Z", "path": "flow-data/src/test/java/com/vaadin/flow/data/provider/AbstractLazyDataViewTest.java", "diffHunk": "@@ -267,6 +273,277 @@ public void getItems_withUndefinedSize() {\n                 items.count());\n     }\n \n+    @Test\n+    public void getItem_withDefinedSizeAndCorrectIndex() {\n+        dataCommunicator.setRequestedRange(0, 50);\n+        dataCommunicator.setDataProvider(DataProvider.fromCallbacks(query -> {\n+            query.getOffset();\n+            query.getLimit();\n+            return Stream.of(\"foo\", \"bar\", \"baz\");\n+        }, query -> 3), null);\n+\n+        fakeClientCommunication();\n+\n+        // Request the item within the active range\n+        Assert.assertEquals(\"Invalid item on index 0\", \"foo\",\n+                dataView.getItem(0));\n+\n+        dataCommunicator.setDataProvider(DataProvider.fromCallbacks(\n+                query -> Stream.generate(String::new).skip(query.getOffset())", "originalCommit": "589d3da1d5fd1eb5dd4c52564220a800e7e7f0bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUzNTI3OQ==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r449535279", "bodyText": "Done", "author": "mshabarov", "createdAt": "2020-07-03T11:31:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIxMzkwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIxOTc1MA==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r449219750", "bodyText": "So now when unknown size is used and nothing is yet fetched as flush occurs later, I get an exception for any item.\nAs a user I would not like this, and the error doesn't give me any indication why the data is not yet fetchable.\nI think we should just make it always work and educate the users with javadocs on getItem in LazyDataView to understand that \"Calling this method with an index that is not currently active in the component will cause a query to the backend, so do not call this method carelessly. Use `UI::beforeClientResponse to access items that will be fetched later on.\"", "author": "pleku", "createdAt": "2020-07-02T19:15:39Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/DataCommunicator.java", "diffHunk": "@@ -316,22 +316,38 @@ public boolean isItemActive(T item) {\n     }\n \n     /**\n-     * Returns the active item at the given index or throws a\n-     * {@link IndexOutOfBoundsException} in case the item is not active at the\n-     * moment.\n-     * \n+     * Gets the item at the given index from the data available to the\n+     * component. Data is filtered and sorted the same way as in the component.\n+     * <p>\n+     * Call to the backend is triggered if the item for a requested index is\n+     * not present in the cached active items.\n+     *\n      * @param index\n-     *            the index of the item to get\n-     * @return the item\n+     *            item index number\n+     * @return item on index\n+     * @throws IndexOutOfBoundsException\n+     *             requested index is outside of the filtered and sorted data\n+     *             set or the data set is empty\n      */\n-    public T getActiveItemOnIndex(int index) {\n+    @SuppressWarnings(\"unchecked\")\n+    public T getItem(int index) {\n         int activeDataEnd = activeStart + activeKeyOrder.size() - 1;\n         if (index < activeStart || index > activeDataEnd) {\n-            throw new IndexOutOfBoundsException(String.format(\n-                    \"Given index %d is outside of the active range of the component '%d - %d'\",\n-                    index, activeStart, activeDataEnd));\n+            int dataSize = getItemCount();\n+            if (dataSize == 0) {", "originalCommit": "589d3da1d5fd1eb5dd4c52564220a800e7e7f0bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUzNTQxMQ==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r449535411", "bodyText": "Done", "author": "mshabarov", "createdAt": "2020-07-03T11:31:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIxOTc1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIyMzA0Nw==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r449223047", "bodyText": "The fakeClientCommunication() call above will increase the estimate to 60+200 because the requested range 0,50 is less than one page from the estimate.\nYou need to test with items that are\n\navailable in the backend\nnot within the current size estimate\n(this will not work currently but it should, like I explained in the DC comments)", "author": "pleku", "createdAt": "2020-07-02T19:23:04Z", "path": "flow-data/src/test/java/com/vaadin/flow/data/provider/AbstractLazyDataViewTest.java", "diffHunk": "@@ -267,6 +273,277 @@ public void getItems_withUndefinedSize() {\n                 items.count());\n     }\n \n+    @Test\n+    public void getItem_withDefinedSizeAndCorrectIndex() {\n+        dataCommunicator.setRequestedRange(0, 50);\n+        dataCommunicator.setDataProvider(DataProvider.fromCallbacks(query -> {\n+            query.getOffset();\n+            query.getLimit();\n+            return Stream.of(\"foo\", \"bar\", \"baz\");\n+        }, query -> 3), null);\n+\n+        fakeClientCommunication();\n+\n+        // Request the item within the active range\n+        Assert.assertEquals(\"Invalid item on index 0\", \"foo\",\n+                dataView.getItem(0));\n+\n+        dataCommunicator.setDataProvider(DataProvider.fromCallbacks(\n+                query -> Stream.generate(String::new).skip(query.getOffset())\n+                        .limit(query.getLimit()),\n+                query -> 300), null);\n+\n+        fakeClientCommunication();\n+\n+        // Request an item outside the active range\n+        Assert.assertNotNull(dataView.getItem(260));\n+    }\n+\n+    @Test\n+    public void getItem_withDefinedSizeAndNegativeIndex() {\n+        exceptionRule.expect(IndexOutOfBoundsException.class);\n+        exceptionRule.expectMessage(\n+                \"Given index -1 is outside of the accepted range '0 - 2'\");\n+        dataCommunicator.setRequestedRange(0, 50);\n+        dataCommunicator.setDataProvider(DataProvider.fromCallbacks(query -> {\n+            query.getOffset();\n+            query.getLimit();\n+            return Stream.of(\"foo\", \"bar\", \"baz\");\n+        }, query -> 3), null);\n+\n+        fakeClientCommunication();\n+\n+        dataView.getItem(-1);\n+    }\n+\n+    @Test\n+    public void getItem_withDefinedSizeAndEmptyDataset() {\n+        exceptionRule.expect(IndexOutOfBoundsException.class);\n+        exceptionRule.expectMessage(\"Requested index 0 on empty data.\");\n+        dataCommunicator.setRequestedRange(0, 50);\n+        dataCommunicator.setDataProvider(DataProvider.fromCallbacks(query -> {\n+            query.getOffset();\n+            query.getLimit();\n+            return Stream.empty();\n+        }, query -> 0), null);\n+\n+        fakeClientCommunication();\n+\n+        dataView.getItem(0);\n+    }\n+\n+    @Test\n+    public void getItem_withDefinedSizeAndIndexOutsideOfRange() {\n+        exceptionRule.expect(IndexOutOfBoundsException.class);\n+        exceptionRule.expectMessage(\n+                \"Given index 3 is outside of the accepted range '0 - 2'\");\n+        dataCommunicator.setRequestedRange(0, 50);\n+        dataCommunicator.setDataProvider(DataProvider.fromCallbacks(query -> {\n+            query.getOffset();\n+            query.getLimit();\n+            return Stream.of(\"foo\", \"bar\", \"baz\");\n+        }, query -> 3), null);\n+\n+        fakeClientCommunication();\n+\n+        Assert.assertEquals(\"Invalid item on index 0\", \"foo\",\n+                dataView.getItem(3));\n+    }\n+\n+    @Test\n+    public void getItem_withDefinedSizeAndFiltering() {\n+        final String initialFilter = \"bar\";\n+        final String newFilter = \"foo\";\n+\n+        dataCommunicator.setRequestedRange(0, 50);\n+        SerializableConsumer<String> newFilterProvider = dataCommunicator\n+                .setDataProvider(DataProvider.fromFilteringCallbacks(query -> {\n+                    query.getOffset();\n+                    query.getLimit();\n+                    return Stream.of(\"foo\", \"bar\", \"baz\").filter(\n+                            item -> item.equals(query.getFilter().get()));\n+                }, query -> 1), initialFilter);\n+\n+        fakeClientCommunication();\n+        Assert.assertEquals(\"Invalid item on index 0\", initialFilter,\n+                dataView.getItem(0));\n+\n+        newFilterProvider.accept(newFilter);\n+\n+        fakeClientCommunication();\n+        Assert.assertEquals(\"Invalid item on index 0\", newFilter,\n+                dataView.getItem(0));\n+    }\n+\n+    @Test\n+    public void getItem_withDefinedSizeAndSorting() {\n+        dataCommunicator.setRequestedRange(0, 50);\n+        dataCommunicator.setDataProvider(DataProvider.fromCallbacks(query -> {\n+            query.getOffset();\n+            query.getLimit();\n+            Stream<String> stream = Stream.of(\"foo\", \"bar\", \"baz\");\n+            if (query.getInMemorySorting() != null) {\n+                stream = stream.sorted(query.getInMemorySorting());\n+            }\n+            return stream;\n+        }, query -> 3), null);\n+\n+        fakeClientCommunication();\n+        Assert.assertEquals(\"Invalid item on index 0\", \"foo\",\n+                dataView.getItem(0));\n+\n+        dataCommunicator.setInMemorySorting(String::compareTo);\n+\n+        fakeClientCommunication();\n+        Assert.assertEquals(\"Invalid item on index 0\", \"bar\",\n+                dataView.getItem(0));\n+    }\n+\n+    @Test\n+    public void getItem_withUndefinedSizeAndCorrectIndex() {\n+        dataCommunicator.setRequestedRange(0, 50);\n+        dataCommunicator.setDataProvider(DataProvider.fromCallbacks(query -> {\n+            query.getOffset();\n+            query.getLimit();\n+            return Stream.of(\"foo\", \"bar\", \"baz\");\n+        }, query -> -1), null);\n+\n+        dataCommunicator.setItemCountEstimate(5);\n+        fakeClientCommunication();\n+\n+        // Request the item within the active range\n+        Assert.assertEquals(\"Wrong item on index 0\", \"foo\",\n+                dataView.getItem(0));\n+        Assert.assertEquals(\"Wrong item on index 2\", \"baz\",\n+                dataView.getItem(2));\n+\n+        // Request the item outside the active range\n+        dataCommunicator.setDataProvider(DataProvider.fromCallbacks(query -> {\n+            if (query.getOffset() > 70) {\n+                return Stream.empty();\n+            } else {\n+                return Stream.generate(String::new).skip(query.getOffset())\n+                        .limit(Math.min(query.getOffset() + query.getLimit(),\n+                                70));\n+            }\n+        }, query -> -1), null);\n+\n+        final int itemCountEstimate = 60;\n+        dataCommunicator.setItemCountEstimate(itemCountEstimate);\n+\n+        fakeClientCommunication();\n+        Assert.assertNotNull(dataView.getItem(49));\n+        Assert.assertNotNull(dataView.getItem(59));\n+        Assert.assertNotNull(dataView.getItem(69));\n+        Assert.assertNull(dataView.getItem(79));", "originalCommit": "589d3da1d5fd1eb5dd4c52564220a800e7e7f0bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUzNTU2Ng==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r449535566", "bodyText": "Done", "author": "mshabarov", "createdAt": "2020-07-03T11:32:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIyMzA0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIyMzkzNQ==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r449223935", "bodyText": "I don't like the newFilter = \"foo\" since the result from that is the same as no filter used at all when using getItem(0) so a regression in applying the filter not working would not be caught", "author": "pleku", "createdAt": "2020-07-02T19:25:17Z", "path": "flow-data/src/test/java/com/vaadin/flow/data/provider/AbstractLazyDataViewTest.java", "diffHunk": "@@ -267,6 +273,277 @@ public void getItems_withUndefinedSize() {\n                 items.count());\n     }\n \n+    @Test\n+    public void getItem_withDefinedSizeAndCorrectIndex() {\n+        dataCommunicator.setRequestedRange(0, 50);\n+        dataCommunicator.setDataProvider(DataProvider.fromCallbacks(query -> {\n+            query.getOffset();\n+            query.getLimit();\n+            return Stream.of(\"foo\", \"bar\", \"baz\");\n+        }, query -> 3), null);\n+\n+        fakeClientCommunication();\n+\n+        // Request the item within the active range\n+        Assert.assertEquals(\"Invalid item on index 0\", \"foo\",\n+                dataView.getItem(0));\n+\n+        dataCommunicator.setDataProvider(DataProvider.fromCallbacks(\n+                query -> Stream.generate(String::new).skip(query.getOffset())\n+                        .limit(query.getLimit()),\n+                query -> 300), null);\n+\n+        fakeClientCommunication();\n+\n+        // Request an item outside the active range\n+        Assert.assertNotNull(dataView.getItem(260));\n+    }\n+\n+    @Test\n+    public void getItem_withDefinedSizeAndNegativeIndex() {\n+        exceptionRule.expect(IndexOutOfBoundsException.class);\n+        exceptionRule.expectMessage(\n+                \"Given index -1 is outside of the accepted range '0 - 2'\");\n+        dataCommunicator.setRequestedRange(0, 50);\n+        dataCommunicator.setDataProvider(DataProvider.fromCallbacks(query -> {\n+            query.getOffset();\n+            query.getLimit();\n+            return Stream.of(\"foo\", \"bar\", \"baz\");\n+        }, query -> 3), null);\n+\n+        fakeClientCommunication();\n+\n+        dataView.getItem(-1);\n+    }\n+\n+    @Test\n+    public void getItem_withDefinedSizeAndEmptyDataset() {\n+        exceptionRule.expect(IndexOutOfBoundsException.class);\n+        exceptionRule.expectMessage(\"Requested index 0 on empty data.\");\n+        dataCommunicator.setRequestedRange(0, 50);\n+        dataCommunicator.setDataProvider(DataProvider.fromCallbacks(query -> {\n+            query.getOffset();\n+            query.getLimit();\n+            return Stream.empty();\n+        }, query -> 0), null);\n+\n+        fakeClientCommunication();\n+\n+        dataView.getItem(0);\n+    }\n+\n+    @Test\n+    public void getItem_withDefinedSizeAndIndexOutsideOfRange() {\n+        exceptionRule.expect(IndexOutOfBoundsException.class);\n+        exceptionRule.expectMessage(\n+                \"Given index 3 is outside of the accepted range '0 - 2'\");\n+        dataCommunicator.setRequestedRange(0, 50);\n+        dataCommunicator.setDataProvider(DataProvider.fromCallbacks(query -> {\n+            query.getOffset();\n+            query.getLimit();\n+            return Stream.of(\"foo\", \"bar\", \"baz\");\n+        }, query -> 3), null);\n+\n+        fakeClientCommunication();\n+\n+        Assert.assertEquals(\"Invalid item on index 0\", \"foo\",\n+                dataView.getItem(3));\n+    }\n+\n+    @Test\n+    public void getItem_withDefinedSizeAndFiltering() {\n+        final String initialFilter = \"bar\";\n+        final String newFilter = \"foo\";\n+\n+        dataCommunicator.setRequestedRange(0, 50);\n+        SerializableConsumer<String> newFilterProvider = dataCommunicator\n+                .setDataProvider(DataProvider.fromFilteringCallbacks(query -> {\n+                    query.getOffset();\n+                    query.getLimit();\n+                    return Stream.of(\"foo\", \"bar\", \"baz\").filter(\n+                            item -> item.equals(query.getFilter().get()));\n+                }, query -> 1), initialFilter);\n+\n+        fakeClientCommunication();\n+        Assert.assertEquals(\"Invalid item on index 0\", initialFilter,\n+                dataView.getItem(0));\n+\n+        newFilterProvider.accept(newFilter);\n+\n+        fakeClientCommunication();\n+        Assert.assertEquals(\"Invalid item on index 0\", newFilter,\n+                dataView.getItem(0));\n+    }\n+\n+    @Test\n+    public void getItem_withDefinedSizeAndSorting() {\n+        dataCommunicator.setRequestedRange(0, 50);\n+        dataCommunicator.setDataProvider(DataProvider.fromCallbacks(query -> {\n+            query.getOffset();\n+            query.getLimit();\n+            Stream<String> stream = Stream.of(\"foo\", \"bar\", \"baz\");\n+            if (query.getInMemorySorting() != null) {\n+                stream = stream.sorted(query.getInMemorySorting());\n+            }\n+            return stream;\n+        }, query -> 3), null);\n+\n+        fakeClientCommunication();\n+        Assert.assertEquals(\"Invalid item on index 0\", \"foo\",\n+                dataView.getItem(0));\n+\n+        dataCommunicator.setInMemorySorting(String::compareTo);\n+\n+        fakeClientCommunication();\n+        Assert.assertEquals(\"Invalid item on index 0\", \"bar\",\n+                dataView.getItem(0));\n+    }\n+\n+    @Test\n+    public void getItem_withUndefinedSizeAndCorrectIndex() {\n+        dataCommunicator.setRequestedRange(0, 50);\n+        dataCommunicator.setDataProvider(DataProvider.fromCallbacks(query -> {\n+            query.getOffset();\n+            query.getLimit();\n+            return Stream.of(\"foo\", \"bar\", \"baz\");\n+        }, query -> -1), null);\n+\n+        dataCommunicator.setItemCountEstimate(5);\n+        fakeClientCommunication();\n+\n+        // Request the item within the active range\n+        Assert.assertEquals(\"Wrong item on index 0\", \"foo\",\n+                dataView.getItem(0));\n+        Assert.assertEquals(\"Wrong item on index 2\", \"baz\",\n+                dataView.getItem(2));\n+\n+        // Request the item outside the active range\n+        dataCommunicator.setDataProvider(DataProvider.fromCallbacks(query -> {\n+            if (query.getOffset() > 70) {\n+                return Stream.empty();\n+            } else {\n+                return Stream.generate(String::new).skip(query.getOffset())\n+                        .limit(Math.min(query.getOffset() + query.getLimit(),\n+                                70));\n+            }\n+        }, query -> -1), null);\n+\n+        final int itemCountEstimate = 60;\n+        dataCommunicator.setItemCountEstimate(itemCountEstimate);\n+\n+        fakeClientCommunication();\n+        Assert.assertNotNull(dataView.getItem(49));\n+        Assert.assertNotNull(dataView.getItem(59));\n+        Assert.assertNotNull(dataView.getItem(69));\n+        Assert.assertNull(dataView.getItem(79));\n+    }\n+\n+    @Test\n+    public void getItem_withUndefinedSizeAndFiltering() {\n+        final String initialFilter = \"bar\";\n+        final String newFilter = \"foo\";\n+\n+        dataCommunicator.setRequestedRange(0, 50);\n+        SerializableConsumer<String> newFilterProvider = dataCommunicator\n+                .setDataProvider(DataProvider.fromFilteringCallbacks(query -> {\n+                    query.getOffset();\n+                    query.getLimit();\n+                    return Stream.of(\"foo\", \"bar\", \"baz\").filter(\n+                            item -> item.equals(query.getFilter().get()));\n+                }, query -> -1), initialFilter);\n+\n+        dataCommunicator.setItemCountEstimate(5);\n+\n+        fakeClientCommunication();\n+        Assert.assertEquals(\"Invalid item on index 0\", initialFilter,\n+                dataView.getItem(0));\n+\n+        newFilterProvider.accept(newFilter);", "originalCommit": "589d3da1d5fd1eb5dd4c52564220a800e7e7f0bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUzNTYyMQ==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r449535621", "bodyText": "Good catch! Done", "author": "mshabarov", "createdAt": "2020-07-03T11:32:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIyMzkzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIyNjQ4Mg==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r449226482", "bodyText": "I think these active item tests are a bit weird now - and probably as the AbstractLazyDataView just delegates to the DataCommunicator for getItem calls, maybe all the tests for that should just be here ...\nAt least the ones here need to get the name updated, and if the majority of the class is tested through another class, then maybe drop a comment here that \"getItem is tested from ...\"", "author": "pleku", "createdAt": "2020-07-02T19:31:06Z", "path": "flow-data/src/test/java/com/vaadin/flow/data/provider/DataCommunicatorTest.java", "diffHunk": "@@ -534,19 +534,19 @@ public void getActiveItemOnIndex_activeRangeChanges_itemsReturned() {\n         dataCommunicator.setRequestedRange(0, 50);", "originalCommit": "589d3da1d5fd1eb5dd4c52564220a800e7e7f0bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUzNjIyNg==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r449536226", "bodyText": "I moved those tests from data view to data communicator. Their home there i believe. On the data view side, I've put only some generic tests checking that the common behaviour works properly.", "author": "mshabarov", "createdAt": "2020-07-03T11:34:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIyNjQ4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIyNzA4Mg==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r449227082", "bodyText": "There is no throwing verified here so the name is incorrect ?", "author": "pleku", "createdAt": "2020-07-02T19:32:36Z", "path": "flow-data/src/test/java/com/vaadin/flow/data/provider/DataCommunicatorTest.java", "diffHunk": "@@ -577,15 +577,15 @@ public void isItemActive_newItems() {\n                 dataCommunicator.isItemActive(new Item(100)));\n     }\n \n-    @Test(expected = IndexOutOfBoundsException.class)\n-    public void getActiveItemOnIndex_outsizeActiveRange_throws() {\n+    @Test\n+    public void getItem_outsizeActiveRange_throws() {", "originalCommit": "589d3da1d5fd1eb5dd4c52564220a800e7e7f0bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUzNjI3Nw==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r449536277", "bodyText": "Yes, Done", "author": "mshabarov", "createdAt": "2020-07-03T11:34:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIyNzA4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU2MTg4OQ==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r449561889", "bodyText": "Since this variable is used only once, why isn't it inlined ? The name even matches the getter so it doesn't help readability", "author": "pleku", "createdAt": "2020-07-03T12:38:15Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/DataCommunicator.java", "diffHunk": "@@ -323,30 +323,54 @@ public boolean isItemActive(T item) {\n      * not present in the cached active items.\n      *\n      * @param index\n-     *            item index number\n+     *            the index of the item to get\n      * @return item on index\n      * @throws IndexOutOfBoundsException\n      *             requested index is outside of the filtered and sorted data\n-     *             set or the data set is empty\n+     *             set\n      */\n     @SuppressWarnings(\"unchecked\")\n     public T getItem(int index) {\n+        if (index < 0) {\n+            throw new IndexOutOfBoundsException(\"Index must be non-negative\");\n+        }\n         int activeDataEnd = activeStart + activeKeyOrder.size() - 1;\n-        if (index < activeStart || index > activeDataEnd) {\n-            int dataSize = getItemCount();\n-            if (dataSize == 0) {\n-                throw new IndexOutOfBoundsException(String\n-                        .format(\"Requested index %d on empty data.\", index));\n-            }\n-            if (index < 0 || index >= dataSize) {\n-                throw new IndexOutOfBoundsException(String.format(\n-                        \"Given index %d is outside of the accepted range '0 - %d'\",\n-                        index, dataSize - 1));\n+        /*\n+         * Check if the item on a requested index is already in the cache of\n+         * active items. No matter is this currently a defined or undefined\n+         * mode\n+         */\n+        if (index >= activeStart && index <= activeDataEnd) {\n+            return getKeyMapper().get(activeKeyOrder.get(index - activeStart));\n+        } else {\n+            final int itemCount = getItemCount();\n+            final boolean definedSize = isDefinedSize();", "originalCommit": "5858b86b41b20b7e2a0308158612179ac7068c70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU3MDY1Mw==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r449570653", "bodyText": "Yes, will fix in a couple of minutes", "author": "mshabarov", "createdAt": "2020-07-03T12:58:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU2MTg4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU3MzA2Nw==", "url": "https://github.com/vaadin/flow/pull/8676#discussion_r449573067", "bodyText": "Done", "author": "mshabarov", "createdAt": "2020-07-03T13:03:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU2MTg4OQ=="}], "type": "inlineReview"}, {"oid": "910bf10d4aab54e0b251cf956ebb5ac129c74e75", "url": "https://github.com/vaadin/flow/commit/910bf10d4aab54e0b251cf956ebb5ac129c74e75", "message": "Add getItem(int index) to DataView #8652", "committedDate": "2020-07-03T14:17:35Z", "type": "commit"}, {"oid": "d02f54f1fb6e741a9d26b5d48783fad9cc54adbb", "url": "https://github.com/vaadin/flow/commit/d02f54f1fb6e741a9d26b5d48783fad9cc54adbb", "message": "Rework getItem, filtering and sorting tests added", "committedDate": "2020-07-03T14:19:11Z", "type": "commit"}, {"oid": "5c6b74c7ef69271fce4f33db368540f6b6da9061", "url": "https://github.com/vaadin/flow/commit/5c6b74c7ef69271fce4f33db368540f6b6da9061", "message": "Get item from outside estimation case, rework the unit tests", "committedDate": "2020-07-03T14:19:11Z", "type": "commit"}, {"oid": "5f09636b751534b967f0153d9ca18d80571951a2", "url": "https://github.com/vaadin/flow/commit/5f09636b751534b967f0153d9ca18d80571951a2", "message": "Remove unnecessary variable", "committedDate": "2020-07-03T14:19:11Z", "type": "commit"}, {"oid": "ab3252765d16a79cf52e216f2beb46c8ae479219", "url": "https://github.com/vaadin/flow/commit/ab3252765d16a79cf52e216f2beb46c8ae479219", "message": "Rebase and remove unnecessary import", "committedDate": "2020-07-03T14:22:46Z", "type": "commit"}, {"oid": "ab3252765d16a79cf52e216f2beb46c8ae479219", "url": "https://github.com/vaadin/flow/commit/ab3252765d16a79cf52e216f2beb46c8ae479219", "message": "Rebase and remove unnecessary import", "committedDate": "2020-07-03T14:22:46Z", "type": "forcePushed"}]}