{"pr_number": 9036, "pr_title": "feat: submit cached endpoint requests in window online listener", "pr_createdAt": "2020-09-18T20:47:37Z", "pr_url": "https://github.com/vaadin/flow/pull/9036", "timeline": [{"oid": "b9d27738a03986ece3010332b9d4b8dfbcde92ad", "url": "https://github.com/vaadin/flow/commit/b9d27738a03986ece3010332b9d4b8dfbcde92ad", "message": "submit cached requests in window online listner", "committedDate": "2020-09-18T20:37:34Z", "type": "commit"}, {"oid": "310adcf8d078abca5feb3f278571174f76bc1dc1", "url": "https://github.com/vaadin/flow/commit/310adcf8d078abca5feb3f278571174f76bc1dc1", "message": "use idb transaction to avoid duplicated submission", "committedDate": "2020-09-18T20:37:51Z", "type": "commit"}, {"oid": "845aae9f825078b6a6a77d4082bc664fa3659696", "url": "https://github.com/vaadin/flow/commit/845aae9f825078b6a6a77d4082bc664fa3659696", "message": "add tests", "committedDate": "2020-09-18T20:38:16Z", "type": "commit"}, {"oid": "f838c560b2953b36cf5c16718f5b52e862cef477", "url": "https://github.com/vaadin/flow/commit/f838c560b2953b36cf5c16718f5b52e862cef477", "message": "add more tests", "committedDate": "2020-09-18T20:42:01Z", "type": "commit"}, {"oid": "0bc4758d3744bf3d3e2f7d15826fad5fe2cdafaf", "url": "https://github.com/vaadin/flow/commit/0bc4758d3744bf3d3e2f7d15826fad5fe2cdafaf", "message": "remove used import", "committedDate": "2020-09-18T20:42:41Z", "type": "commit"}, {"oid": "d2c92d06c22c1c638acb6bff4d51cec358d32449", "url": "https://github.com/vaadin/flow/commit/d2c92d06c22c1c638acb6bff4d51cec358d32449", "message": "add new line", "committedDate": "2020-09-18T20:49:03Z", "type": "commit"}, {"oid": "4133da4e78fadd8d90cef403de046bd95290b2c6", "url": "https://github.com/vaadin/flow/commit/4133da4e78fadd8d90cef403de046bd95290b2c6", "message": "always setup the request queue  upon read/write", "committedDate": "2020-09-19T20:32:14Z", "type": "commit"}, {"oid": "178fc87d9470a3e761cd24c3832a32a49ea04c4e", "url": "https://github.com/vaadin/flow/commit/178fc87d9470a3e761cd24c3832a32a49ea04c4e", "message": "submit requests in sequence", "committedDate": "2020-09-21T15:09:05Z", "type": "commit"}, {"oid": "d09cc3be2c76d9979b69b7981d4c58ee9aa5e152", "url": "https://github.com/vaadin/flow/commit/d09cc3be2c76d9979b69b7981d4c58ee9aa5e152", "message": "fake endpoint call with delay", "committedDate": "2020-09-21T18:01:26Z", "type": "commit"}, {"oid": "dbb86893934546f8b4c4f39209fc29ef70c8e7cb", "url": "https://github.com/vaadin/flow/commit/dbb86893934546f8b4c4f39209fc29ef70c8e7cb", "message": "add comment to explain the idb transaction", "committedDate": "2020-09-21T18:06:58Z", "type": "commit"}, {"oid": "b8051df2b8d1b5a61048f6252c3d20ef56e59258", "url": "https://github.com/vaadin/flow/commit/b8051df2b8d1b5a61048f6252c3d20ef56e59258", "message": "generalise binder.submitTo method", "committedDate": "2020-09-21T18:44:45Z", "type": "commit"}, {"oid": "010170147fef7c31cea3cfa1a8fbddeddcf7db88", "url": "https://github.com/vaadin/flow/commit/010170147fef7c31cea3cfa1a8fbddeddcf7db88", "message": "fix: fail access check when no csrf token in session", "committedDate": "2020-09-29T11:47:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY1MTU3MQ==", "url": "https://github.com/vaadin/flow/pull/9036#discussion_r496651571", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if(shouldSubmit){\n          \n          \n            \n                if (shouldSubmit) {", "author": "Haprog", "createdAt": "2020-09-29T11:46:07Z", "path": "flow-client/src/main/resources/META-INF/resources/frontend/Connect.ts", "diffHunk": "@@ -407,15 +411,75 @@ export class ConnectClient {\n     return navigator.onLine;\n   }\n \n-  private async cacheEndpointRequest(endpointRequest: EndpointRequest) {\n-    await set(endpointRequest.id, endpointRequest, this.getOrCreateEndpointRequetsQueue());\n+  private async cacheEndpointRequest(endpointRequest: EndpointRequest): Promise<EndpointRequest>{\n+    const db = await this.openOrCreateDB();\n+    const id = await db.add(REQUEST_QUEUE_STORE_NAME, endpointRequest);\n+    db.close();\n+    endpointRequest.id = id;\n+    return endpointRequest;\n   }\n \n-  private getOrCreateEndpointRequetsQueue(): Store {\n-    if (!this.endpointRequetsQueue) {\n-      this.endpointRequetsQueue = new Store('cached-vaadin-endpoint-requests');\n+  private async openOrCreateDB(): Promise<IDBPDatabase<RequestQueueDB>> {\n+    return openDB<RequestQueueDB>(REQUEST_QUEUE_DB_NAME, 1, {\n+      upgrade(db) {\n+        db.createObjectStore(REQUEST_QUEUE_STORE_NAME, {\n+          keyPath: 'id',\n+          autoIncrement: true\n+        });\n+      },\n+    });\n+  }\n+\n+  private async checkAndSubmitCachedRequests(){\n+    const db = await this.openOrCreateDB();\n+\n+    /**\n+     * Cannot wait for submitting the cached requests in the indexed db transaction, \n+     * as the transaction only wait for db operations. \n+     * See https://github.com/jakearchibald/idb#transaction-lifetime\n+     */\n+    const shouldSubmit = await this.shouldSubmitCachedRequests(db);\n+\n+    if(shouldSubmit){", "originalCommit": "b8051df2b8d1b5a61048f6252c3d20ef56e59258", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY1NDYyOQ==", "url": "https://github.com/vaadin/flow/pull/9036#discussion_r496654629", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if(!request.id){\n          \n          \n            \n                    if (!request.id) {", "author": "Haprog", "createdAt": "2020-09-29T11:51:58Z", "path": "flow-client/src/test/frontend/ConnectTests.ts", "diffHunk": "@@ -508,19 +508,19 @@ describe('ConnectClient', () => {\n \n   describe(\"Defer Request\", () => {\n     let client: ConnectClient;\n-    const offlineRequestQueue = new Store('cached-vaadin-endpoint-requests');\n \n     beforeEach(() => {\n       client = new ConnectClient();\n     });\n \n-    afterEach(() => {\n-      fetchMock.restore();\n-      clear(offlineRequestQueue);\n-    });\n-\n     it(\"Should return a DeferrableResult that retains request meta when invoking deferRequest offline\", async () => {\n       sinon.stub(client, \"checkOnline\").callsFake(() => false);\n+      sinon.stub(client, \"cacheEndpointRequest\").callsFake((request:any) => {\n+        if(!request.id){", "originalCommit": "b8051df2b8d1b5a61048f6252c3d20ef56e59258", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a71eb8f1b038afb1e7a8908d8c08bd89de02deea", "url": "https://github.com/vaadin/flow/commit/a71eb8f1b038afb1e7a8908d8c08bd89de02deea", "message": "chore: code format", "committedDate": "2020-09-30T07:02:18Z", "type": "commit"}, {"oid": "23dadeef13907698daaf77af9d1ca0041ab31f79", "url": "https://github.com/vaadin/flow/commit/23dadeef13907698daaf77af9d1ca0041ab31f79", "message": "Merge branch 'feature/offline' into haijian/submit-cached-offline-requests", "committedDate": "2020-09-30T07:03:03Z", "type": "commit"}]}