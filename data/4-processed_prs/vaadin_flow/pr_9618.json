{"pr_number": 9618, "pr_title": "chore: add internal classes to access classloader and init context", "pr_createdAt": "2020-12-09T10:11:21Z", "pr_url": "https://github.com/vaadin/flow/pull/9618", "timeline": [{"oid": "268184bfb2a1e1e79e53897a6079f6f9cca1e277", "url": "https://github.com/vaadin/flow/commit/268184bfb2a1e1e79e53897a6079f6f9cca1e277", "message": "chore: add internal classes to access classloader and init context\n\nrelated to #9601 : needed to restore OSGi resource provider", "committedDate": "2020-12-09T10:10:40Z", "type": "commit"}, {"oid": "3f23f1007dcbbe4801005e74d79a3dfd795afdaf", "url": "https://github.com/vaadin/flow/commit/3f23f1007dcbbe4801005e74d79a3dfd795afdaf", "message": "fix: exclude helper interfaces from serializable classes test", "committedDate": "2020-12-09T10:54:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIzOTMyMA==", "url": "https://github.com/vaadin/flow/pull/9618#discussion_r539239320", "bodyText": "Replace this lambda with a method reference.", "author": "vaadin-bot", "createdAt": "2020-12-09T11:46:36Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/VaadinServlet.java", "diffHunk": "@@ -513,4 +520,22 @@ public void destroy() {\n         getService().destroy();\n     }\n \n+    private VaadinServletContext initializeContext() {\n+        ServletContext servletContext = getServletConfig().getServletContext();\n+        VaadinServletContext vaadinServletContext = new VaadinServletContext(\n+                servletContext);\n+        // ensure the web application classloader is available via context\n+        ApplicationClassLoaderAccess access = () -> servletContext", "originalCommit": "3f23f1007dcbbe4801005e74d79a3dfd795afdaf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIxNTc3MA==", "url": "https://github.com/vaadin/flow/pull/9618#discussion_r539215770", "bodyText": "Why do we have a runnable running a runnable. can't we just have access as the default instead of  () -> access` else drop access and put it directly in the getAttribute default value.", "author": "caalador", "createdAt": "2020-12-09T11:09:18Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/VaadinServlet.java", "diffHunk": "@@ -513,4 +520,22 @@ public void destroy() {\n         getService().destroy();\n     }\n \n+    private VaadinServletContext initializeContext() {\n+        ServletContext servletContext = getServletConfig().getServletContext();\n+        VaadinServletContext vaadinServletContext = new VaadinServletContext(\n+                servletContext);\n+        // ensure the web application classloader is available via context\n+        ApplicationClassLoaderAccess access = () -> servletContext\n+                .getClassLoader();\n+        vaadinServletContext.getAttribute(ApplicationClassLoaderAccess.class,\n+                () -> access);", "originalCommit": "3f23f1007dcbbe4801005e74d79a3dfd795afdaf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI1MjA4NQ==", "url": "https://github.com/vaadin/flow/pull/9618#discussion_r539252085", "bodyText": "The first \"runnable\" is a factory which produces a value for the attribute.\nThe second \"runnable\" is the access which returns a classloader.\nYou suggestion means  the ClassLoader  instance will be set as the attribute  \"ClassLoader.class\" value.\nThere are two reasons why I don't want to use ClassLoader instance directly but instead wrap it:\n\nif I recall correctly you had problems with accessing to ServletContext::getClassLoader . Sometimes it may throw an exception if it's called \"too early\" (I have no idea what \"too early\" means). ServletContext::getClassLoader has bad API since there is a public method which you may call at any point but in fact it may not be called at any point. So I'm trying to avoid calling it right away. Instead \"access\"/factory is used to call it.\nI don't want to expose ClassLoader  as the attribute value for \"ClassLoader.class\"  attribute.\nClassLoader is the standard JVM class. So it's possible that someone (an app  developer) may use ClassLoader.class  attribute for his own purposes. This will break internal assumptions.\n\nIdeally ApplicationClassLoaderAccess would be a private class so no-one is able to use ApplicationClassLoaderAccess.class  attribute to override its value. But that will require the servlet class in osgi  module (which can be done but then OSGiXXXXServlet should be used instead of VaadinServlet and I'm trying to avoid that).", "author": "denis-anisimov", "createdAt": "2020-12-09T12:07:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIxNTc3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI2MDIyNA==", "url": "https://github.com/vaadin/flow/pull/9618#discussion_r539260224", "bodyText": "A conversation is not resolved by you answering it. It should be up to the one making the comment to resolve it as agreed on slack a while ago.", "author": "caalador", "createdAt": "2020-12-09T12:20:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIxNTc3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI4NzM5NA==", "url": "https://github.com/vaadin/flow/pull/9618#discussion_r539287394", "bodyText": "Do you mean I should not click \"resolved\" ?\nDoes it mean that you should resolve it ?\nBut then why the button is shown to me ?\nOr should I use the button only when I made some change ?", "author": "denis-anisimov", "createdAt": "2020-12-09T13:02:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIxNTc3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI4OTA5Mg==", "url": "https://github.com/vaadin/flow/pull/9618#discussion_r539289092", "bodyText": "But you may click technically \"unresolve conversation\" if you disagree .....\nI'm trying to make all the conversations resolved if I answer it so if I don't go into the same conversation if I forget that it has a complete answer.\nAnd I expect that it will be unresolved if it's not resolved yet...", "author": "denis-anisimov", "createdAt": "2020-12-09T13:04:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIxNTc3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI5NTMxNg==", "url": "https://github.com/vaadin/flow/pull/9618#discussion_r539295316", "bodyText": "OK, I missed the agreement.\nSo then it's the responsibility of the author to resolve regardless of comment or real cahnge.\nOK.", "author": "denis-anisimov", "createdAt": "2020-12-09T13:14:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIxNTc3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTkwMzA0Mw==", "url": "https://github.com/vaadin/flow/pull/9618#discussion_r539903043", "bodyText": "This is more of an issue with how this works on github. With reviewable it only hid the conversation for the one clicking the acc button, but here it fully closes the comment block  making finding the conversation really hard especially if there happens to be multiple review rounds with comments in different faces.", "author": "caalador", "createdAt": "2020-12-10T06:45:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIxNTc3MA=="}], "type": "inlineReview"}]}