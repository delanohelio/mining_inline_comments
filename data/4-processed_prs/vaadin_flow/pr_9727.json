{"pr_number": 9727, "pr_title": "Refactor Lookup initialization for Servlet 3.0 containers", "pr_createdAt": "2020-12-29T08:41:19Z", "pr_url": "https://github.com/vaadin/flow/pull/9727", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY3ODMwNQ==", "url": "https://github.com/vaadin/flow/pull/9727#discussion_r549678305", "bodyText": "Remove this use of \"DeprecatedPolymerPublishedEventHandler\"; it is deprecated.", "author": "vaadin-bot", "createdAt": "2020-12-29T11:59:31Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/startup/LookupServletContainerInitializer.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\n+ * Copyright 2000-2020 Vaadin Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package com.vaadin.flow.server.startup;\n+\n+import javax.servlet.ServletContainerInitializer;\n+import javax.servlet.ServletContext;\n+import javax.servlet.ServletException;\n+import javax.servlet.annotation.HandlesTypes;\n+\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import com.vaadin.flow.component.template.internal.DeprecatedPolymerPublishedEventHandler;\n+import com.vaadin.flow.di.InstantiatorFactory;\n+import com.vaadin.flow.di.Lookup;\n+import com.vaadin.flow.di.LookupInitializer;\n+import com.vaadin.flow.di.ResourceProvider;\n+import com.vaadin.flow.internal.ReflectTools;\n+import com.vaadin.flow.server.VaadinServletContext;\n+import com.vaadin.flow.server.frontend.EndpointGeneratorTaskFactory;\n+\n+/**\n+ * Standard servlet initializer for collecting all SPI implementations.\n+ * \n+ * @author Vaadin Ltd\n+ * @since\n+ *\n+ */\n+@HandlesTypes({ ResourceProvider.class, InstantiatorFactory.class,\n+        DeprecatedPolymerPublishedEventHandler.class,", "originalCommit": "172a0059662622ddf1351b8df82f1e133d64a2e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY3ODMwOQ==", "url": "https://github.com/vaadin/flow/pull/9727#discussion_r549678309", "bodyText": "\"servletContext\" is a method parameter, and should not be used for synchronization.", "author": "vaadin-bot", "createdAt": "2020-12-29T11:59:32Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/startup/LookupServletContainerInitializer.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\n+ * Copyright 2000-2020 Vaadin Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package com.vaadin.flow.server.startup;\n+\n+import javax.servlet.ServletContainerInitializer;\n+import javax.servlet.ServletContext;\n+import javax.servlet.ServletException;\n+import javax.servlet.annotation.HandlesTypes;\n+\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import com.vaadin.flow.component.template.internal.DeprecatedPolymerPublishedEventHandler;\n+import com.vaadin.flow.di.InstantiatorFactory;\n+import com.vaadin.flow.di.Lookup;\n+import com.vaadin.flow.di.LookupInitializer;\n+import com.vaadin.flow.di.ResourceProvider;\n+import com.vaadin.flow.internal.ReflectTools;\n+import com.vaadin.flow.server.VaadinServletContext;\n+import com.vaadin.flow.server.frontend.EndpointGeneratorTaskFactory;\n+\n+/**\n+ * Standard servlet initializer for collecting all SPI implementations.\n+ * \n+ * @author Vaadin Ltd\n+ * @since\n+ *\n+ */\n+@HandlesTypes({ ResourceProvider.class, InstantiatorFactory.class,\n+        DeprecatedPolymerPublishedEventHandler.class,\n+        EndpointGeneratorTaskFactory.class,\n+        ApplicationConfigurationFactory.class, LookupInitializer.class })\n+public class LookupServletContainerInitializer\n+        implements ClassLoaderAwareServletContainerInitializer {\n+\n+    @Override\n+    public void process(Set<Class<?>> classSet, ServletContext servletContext)\n+            throws ServletException {\n+        VaadinServletContext vaadinContext = new VaadinServletContext(\n+                servletContext);\n+        Map<Class<?>, Collection<Class<?>>> services = new HashMap<>();\n+\n+        collectSubclasses(LookupInitializer.class, classSet, services);\n+\n+        LookupInitializer initializer = getLookupInitializer(services);\n+\n+        services.remove(LookupInitializer.class);\n+\n+        collectServiceImplementations(classSet, services);\n+\n+        initializer.initialize(vaadinContext, services, lookup -> {\n+            vaadinContext.setAttribute(Lookup.class, lookup);\n+\n+            DeferredServletContextInitializers deferredInitializers;\n+            synchronized (servletContext) {", "originalCommit": "172a0059662622ddf1351b8df82f1e133d64a2e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7d3a02d90099d3a9370fd066a3f61eeb07103dc0", "url": "https://github.com/vaadin/flow/commit/7d3a02d90099d3a9370fd066a3f61eeb07103dc0", "message": "refactor: make \"instantiate\" method protected", "committedDate": "2020-12-29T12:00:42Z", "type": "forcePushed"}, {"oid": "dab2acb167bea5715c2b71f70bce97077d024c5a", "url": "https://github.com/vaadin/flow/commit/dab2acb167bea5715c2b71f70bce97077d024c5a", "message": "fix: avoid calling intentionally overridable method in CTOR", "committedDate": "2020-12-29T12:06:22Z", "type": "forcePushed"}, {"oid": "5f427ef59d9eeab788e5d5c9f2435ce90330defd", "url": "https://github.com/vaadin/flow/commit/5f427ef59d9eeab788e5d5c9f2435ce90330defd", "message": "fix: make ResourceProviderImpl CTOR public", "committedDate": "2020-12-29T12:17:12Z", "type": "forcePushed"}, {"oid": "11f924f073b0c3d4ebc3a3cb79117afb29582e81", "url": "https://github.com/vaadin/flow/commit/11f924f073b0c3d4ebc3a3cb79117afb29582e81", "message": "fix: make ResourceProviderImpl CTOR public", "committedDate": "2020-12-29T12:18:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTcxODMzNg==", "url": "https://github.com/vaadin/flow/pull/9727#discussion_r549718336", "bodyText": "Add a nested comment explaining why this method is empty, throw an UnsupportedOperationException or complete the implementation.", "author": "vaadin-bot", "createdAt": "2020-12-29T14:10:16Z", "path": "flow-server/src/main/java/com/vaadin/flow/di/LookupInitializer.java", "diffHunk": "@@ -0,0 +1,387 @@\n+/*\n+ * Copyright 2000-2020 Vaadin Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package com.vaadin.flow.di;\n+\n+import javax.servlet.ServletContainerInitializer;\n+import javax.servlet.ServletException;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URL;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.ServiceLoader;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.function.BiFunction;\n+import java.util.stream.Collectors;\n+\n+import org.apache.commons.io.IOUtils;\n+\n+import com.vaadin.flow.function.VaadinApplicationInitializationBootstrap;\n+import com.vaadin.flow.internal.ReflectTools;\n+import com.vaadin.flow.server.VaadinContext;\n+import com.vaadin.flow.server.startup.ApplicationConfigurationFactory;\n+import com.vaadin.flow.server.startup.DefaultApplicationConfigurationFactory;\n+import com.vaadin.flow.server.startup.LookupServletContainerInitializer;\n+\n+/**\n+ * SPI for customizing lookup in applications inside Servlet 3.0 containers.\n+ * <p>\n+ * There are two ways of customizing Lookup in various servlet containers:\n+ * <ul>\n+ * <li>Somehow completely disable {@link LookupServletContainerInitializer} and\n+ * implement own way to set up {@link Lookup} and make it available via\n+ * {@link VaadinContext#getAttribute(Class)}.\n+ * <li>Use {@link LookupInitializer} SPI via providing an implementation for the\n+ * framework which doesn't prevent {@link LookupServletContainerInitializer}\n+ * execution.\n+ * </ul>\n+ * \n+ * The first case is only possible when a servlet container doesn't run\n+ * {@link ServletContainerInitializer}s out of the box (e.g. OSGi or Spring boot\n+ * executed as a Jar) at all. Otherwise you may not disable an existing\n+ * {@link ServletContainerInitializer} and it will be executed anyway.\n+ * <p>\n+ * The second case allows to customize {@link Lookup} creation and\n+ * initialization in case when it's not possible to prevent\n+ * {@link LookupServletContainerInitializer} execution (any container which\n+ * completely supports Servlet 3.0 specification). In this case it's possible to\n+ * implement {@link LookupInitializer} for the framework.\n+ * <p>\n+ * This is SPI for {@link Lookup} SPI. The difference is:\n+ * <ul>\n+ * <li>{@link Lookup} allows to override services per Web application (by the\n+ * application developer). For some service interfaces there can be several\n+ * implementations available in {@link Lookup}.\n+ * <li>{@link LookupInitializer} allows to override how the {@link Lookup} works\n+ * per framework. The default implementation available if no framework is used.\n+ * Only one service implementation (excluding the default one) may be available\n+ * in the web application classpath and it's provided by the developers for the\n+ * framework support (the main usecase here is Spring add-on).\n+ * </ul>\n+ * \n+ * @author Vaadin Ltd\n+ * @since\n+ *\n+ */\n+public class LookupInitializer {\n+\n+    protected static final String SPI = \" SPI: \";\n+\n+    protected static final String ONE_IMPL_REQUIRED = \". Only one implementation should be registered. \"\n+            + \"Use lookupAll to get all instances of the given type.\";\n+\n+    protected static final String SEVERAL_IMPLS = \"Found several implementations in the classpath for \";\n+\n+    /**\n+     * Default implementation of {@link Lookup}.\n+     * \n+     * @author Vaadin Ltd\n+     * @since\n+     *\n+     */\n+    protected static class LookupImpl implements Lookup {\n+\n+        protected final Map<Class<?>, Collection<Object>> serviceMap;\n+\n+        /**\n+         * Creates a new instance of {@link Lookup} with services found in the\n+         * application classpath.\n+         * \n+         * @param initialServices\n+         *            map of initial services with their implementations\n+         * @param factory\n+         *            a factory to create a service object instance\n+         */\n+        protected LookupImpl(\n+                Map<Class<?>, Collection<Class<?>>> initialServices,\n+                BiFunction<Class<?>, Class<?>, Object> factory) {\n+            serviceMap = new HashMap<>();\n+            initialServices.forEach((serviceClass,\n+                    impls) -> serviceMap.put(serviceClass, impls.stream()\n+                            .map(impl -> factory.apply(serviceClass, impl))\n+                            .filter(Objects::nonNull)\n+                            .collect(Collectors.toList())));\n+        }\n+\n+        @Override\n+        public <T> T lookup(Class<T> serviceClass) {\n+            Collection<Object> registered = serviceMap.get(serviceClass);\n+            if (registered == null || registered.isEmpty()) {\n+                ServiceLoader<T> loader = ServiceLoader.load(serviceClass);\n+                List<T> services = new ArrayList<>();\n+                for (Iterator<T> iterator = loader.iterator(); iterator\n+                        .hasNext();) {\n+                    services.add(iterator.next());\n+                }\n+                if (services.size() > 1) {\n+                    throw new IllegalStateException(SEVERAL_IMPLS + serviceClass\n+                            + SPI + services + ONE_IMPL_REQUIRED);\n+                } else if (services.size() == 1) {\n+                    return services.get(0);\n+                }\n+                return null;\n+            } else if (registered.size() > 1) {\n+                throw new IllegalStateException(SEVERAL_IMPLS + serviceClass\n+                        + SPI + registered + ONE_IMPL_REQUIRED);\n+            } else {\n+                return serviceClass.cast(registered.iterator().next());\n+            }\n+        }\n+\n+        @Override\n+        public <T> Collection<T> lookupAll(Class<T> serviceClass) {\n+            List<T> result = new ArrayList<>();\n+            Collection<Object> registered = serviceMap.get(serviceClass);\n+\n+            Set<?> registeredClasses = registered == null\n+                    ? Collections.emptySet()\n+                    : registered.stream().map(Object::getClass)\n+                            .collect(Collectors.toSet());\n+            if (registered != null) {\n+                registered.forEach(\n+                        service -> result.add(serviceClass.cast(service)));\n+            }\n+            ServiceLoader<T> loader = ServiceLoader.load(serviceClass);\n+            for (Iterator<T> iterator = loader.iterator(); iterator\n+                    .hasNext();) {\n+                T next = iterator.next();\n+                if (!registeredClasses.contains(next.getClass())) {\n+                    result.add(next);\n+                }\n+            }\n+            return result;\n+        }\n+\n+    }\n+\n+    /**\n+     * Default implementation of {@link ResourceProvider}.\n+     * \n+     * @author Vaadin Ltd\n+     * @since\n+     *\n+     */\n+    protected static class ResourceProviderImpl implements ResourceProvider {\n+\n+        private Map<String, CachedStreamData> cache = new ConcurrentHashMap<>();\n+\n+        /**\n+         * Creates a new instance.\n+         */\n+        public ResourceProviderImpl() {", "originalCommit": "f59db83576f1d192cc2ddfe79499cea1b8bdf00b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "61249348d72579a6d2828d2cc2c2ed3cc0b8c5d7", "url": "https://github.com/vaadin/flow/commit/61249348d72579a6d2828d2cc2c2ed3cc0b8c5d7", "message": "refactor: rename lookup initializer class", "committedDate": "2020-12-30T10:07:22Z", "type": "commit"}, {"oid": "ae38b07cccd79b979f4ba46c289c883e06dd056a", "url": "https://github.com/vaadin/flow/commit/ae38b07cccd79b979f4ba46c289c883e06dd056a", "message": "test: add unit tests for refactored code", "committedDate": "2020-12-30T10:07:23Z", "type": "commit"}, {"oid": "4bbe958426d688e65f7fa0a76e9ad1d924d70cf1", "url": "https://github.com/vaadin/flow/commit/4bbe958426d688e65f7fa0a76e9ad1d924d70cf1", "message": "refactor: add VaadinContext as a parameter to SPI", "committedDate": "2020-12-30T10:07:23Z", "type": "commit"}, {"oid": "15932d798b58edbc309b03287be41fe82ca7989d", "url": "https://github.com/vaadin/flow/commit/15932d798b58edbc309b03287be41fe82ca7989d", "message": "fix: fix javadocs and serializable tests", "committedDate": "2020-12-30T10:07:23Z", "type": "commit"}, {"oid": "f78b5278743fd5dc6e07b043d7a776be7ea55631", "url": "https://github.com/vaadin/flow/commit/f78b5278743fd5dc6e07b043d7a776be7ea55631", "message": "fix: fix javadocs", "committedDate": "2020-12-30T10:07:24Z", "type": "commit"}, {"oid": "44b256984bbf53801d4e849021a6e93b0bc9c7b6", "url": "https://github.com/vaadin/flow/commit/44b256984bbf53801d4e849021a6e93b0bc9c7b6", "message": "refactor: extend protected SPI method with context param", "committedDate": "2020-12-30T10:07:24Z", "type": "commit"}, {"oid": "2b5b4d49a63d186ba19e61954d7531f63be07f78", "url": "https://github.com/vaadin/flow/commit/2b5b4d49a63d186ba19e61954d7531f63be07f78", "message": "refactor: make \"instantiate\" method protected", "committedDate": "2020-12-30T10:07:24Z", "type": "commit"}, {"oid": "7775481a5d6991e1504feec0734df65096a70187", "url": "https://github.com/vaadin/flow/commit/7775481a5d6991e1504feec0734df65096a70187", "message": "fix: avoid calling intentionally overridable method in CTOR", "committedDate": "2020-12-30T10:07:25Z", "type": "commit"}, {"oid": "c9a7d751e8c46ee1fea95fa279e74fba5dbc2b7a", "url": "https://github.com/vaadin/flow/commit/c9a7d751e8c46ee1fea95fa279e74fba5dbc2b7a", "message": "fix: make ResourceProviderImpl CTOR public", "committedDate": "2020-12-30T10:07:25Z", "type": "commit"}, {"oid": "26241bfe3a5adbe5a14a867db98ee70fb1deb3e3", "url": "https://github.com/vaadin/flow/commit/26241bfe3a5adbe5a14a867db98ee70fb1deb3e3", "message": "fix: cleanup, fix javadocs", "committedDate": "2020-12-30T10:07:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTE5MDc0OA==", "url": "https://github.com/vaadin/flow/pull/9727#discussion_r551190748", "bodyText": "This shouldn't start with Somehow and should be the second way as it's not the recommended way (as we can't say how to disable a part from the ServletContainerInitializer)", "author": "caalador", "createdAt": "2021-01-04T09:07:59Z", "path": "flow-server/src/main/java/com/vaadin/flow/di/LookupInitializer.java", "diffHunk": "@@ -0,0 +1,387 @@\n+/*\n+ * Copyright 2000-2020 Vaadin Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package com.vaadin.flow.di;\n+\n+import javax.servlet.ServletContainerInitializer;\n+import javax.servlet.ServletException;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URL;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.ServiceLoader;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.function.BiFunction;\n+import java.util.stream.Collectors;\n+\n+import org.apache.commons.io.IOUtils;\n+\n+import com.vaadin.flow.function.VaadinApplicationInitializationBootstrap;\n+import com.vaadin.flow.internal.ReflectTools;\n+import com.vaadin.flow.server.VaadinContext;\n+import com.vaadin.flow.server.startup.ApplicationConfigurationFactory;\n+import com.vaadin.flow.server.startup.DefaultApplicationConfigurationFactory;\n+import com.vaadin.flow.server.startup.LookupServletContainerInitializer;\n+\n+/**\n+ * SPI for customizing lookup in applications inside Servlet 3.0 containers.\n+ * <p>\n+ * There are two ways of customizing Lookup in various servlet containers:\n+ * <ul>\n+ * <li>Somehow completely disable {@link LookupServletContainerInitializer} and\n+ * implement own way to set up {@link Lookup} and make it available via\n+ * {@link VaadinContext#getAttribute(Class)}.", "originalCommit": "f59db83576f1d192cc2ddfe79499cea1b8bdf00b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQ0ODQ4MA==", "url": "https://github.com/vaadin/flow/pull/9727#discussion_r551448480", "bodyText": "Done", "author": "denis-anisimov", "createdAt": "2021-01-04T17:09:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTE5MDc0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTIxNTg4NQ==", "url": "https://github.com/vaadin/flow/pull/9727#discussion_r551215885", "bodyText": "The name could say why it is expected to throw. Multiple instances I presume?", "author": "caalador", "createdAt": "2021-01-04T09:57:03Z", "path": "flow-server/src/test/java/com/vaadin/flow/di/LookupIntializerTest.java", "diffHunk": "@@ -0,0 +1,263 @@\n+/*\n+ * Copyright 2000-2020 Vaadin Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package com.vaadin.flow.di;\n+\n+import javax.servlet.ServletException;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Iterator;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicReference;\n+import java.util.stream.Collectors;\n+\n+import org.apache.commons.io.IOUtils;\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.mockito.Mockito;\n+\n+import com.vaadin.flow.di.LookupInitializer.ResourceProviderImpl;\n+import com.vaadin.flow.function.VaadinApplicationInitializationBootstrap;\n+import com.vaadin.flow.server.startup.ApplicationConfigurationFactory;\n+import com.vaadin.flow.server.startup.DefaultApplicationConfigurationFactory;\n+import com.vaadin.flow.server.startup.testdata.AnotherTestInstantiatorFactory;\n+import com.vaadin.flow.server.startup.testdata.OneMoreTestInstantiatorFactory;\n+import com.vaadin.flow.server.startup.testdata.TestInstantiatorFactory;\n+import com.vaadin.flow.server.startup.testdata.TestResourceProvider;\n+\n+import elemental.json.Json;\n+import elemental.json.JsonObject;\n+\n+public class LookupIntializerTest {\n+\n+    private LookupInitializer initializer = new LookupInitializer();\n+\n+    @Test(expected = IllegalStateException.class)\n+    public void createLookup_instantiatorsAreProvidedAsAService_lookupThrows()\n+            throws ServletException {\n+        // Java standard SPI is used to register several instantiators via\n+        // META-INF/services\n+        Lookup lookup = initializer.createLookup(null, new HashMap<>());\n+\n+        lookup.lookup(InstantiatorFactory.class);\n+    }\n+\n+    @Test(expected = IllegalStateException.class)\n+    public void createLookup_instantiatorsAreProvidedAsScannedClasses_lookupThrows()", "originalCommit": "f59db83576f1d192cc2ddfe79499cea1b8bdf00b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQ1MDM5MQ==", "url": "https://github.com/vaadin/flow/pull/9727#discussion_r551450391", "bodyText": "Done", "author": "denis-anisimov", "createdAt": "2021-01-04T17:12:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTIxNTg4NQ=="}], "type": "inlineReview"}, {"oid": "4962b6699a6a4c37d9fcc18a45a380aef3edd577", "url": "https://github.com/vaadin/flow/commit/4962b6699a6a4c37d9fcc18a45a380aef3edd577", "message": "fix: fix javadocs and rename unit test method (review comments)", "committedDate": "2021-01-04T17:12:08Z", "type": "commit"}, {"oid": "4962b6699a6a4c37d9fcc18a45a380aef3edd577", "url": "https://github.com/vaadin/flow/commit/4962b6699a6a4c37d9fcc18a45a380aef3edd577", "message": "fix: fix javadocs and rename unit test method (review comments)", "committedDate": "2021-01-04T17:12:08Z", "type": "forcePushed"}]}