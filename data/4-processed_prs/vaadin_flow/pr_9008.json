{"pr_number": 9008, "pr_title": "Read text for template element", "pr_createdAt": "2020-09-15T07:41:07Z", "pr_url": "https://github.com/vaadin/flow/pull/9008", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODcwODgyNA==", "url": "https://github.com/vaadin/flow/pull/9008#discussion_r488708824", "bodyText": "Method could be compacted to one-liner using computeIfAbsent.", "author": "joheriks", "createdAt": "2020-09-15T14:22:56Z", "path": "flow-server/src/main/java/com/vaadin/flow/component/polymertemplate/IdCollector.java", "diffHunk": "@@ -194,4 +196,23 @@ private void setAttributeData(Attribute attribute,\n     private boolean isBooleanAttribute(Attribute attribute) {\n         return attribute.getKey().equals(attribute.toString());\n     }\n+\n+    private Map<String, String> getAttributeData(String id) {\n+        Map<String, String> map = attributesById.get(id);\n+        if (map == null) {\n+            map = new HashMap<>();\n+            attributesById.put(id, map);\n+        }\n+        return map;", "originalCommit": "1404cad33cddefe87cdc0eca742c25ec7f5557bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODcyNDAwOQ==", "url": "https://github.com/vaadin/flow/pull/9008#discussion_r488724009", "bodyText": "Could be final", "author": "joheriks", "createdAt": "2020-09-15T14:42:11Z", "path": "flow-server/src/main/java/com/vaadin/flow/component/template/internal/AbstractInjectableElementInitializer.java", "diffHunk": "@@ -34,6 +34,15 @@\n public abstract class AbstractInjectableElementInitializer\n         implements Consumer<Map<String, String>> {\n \n+    /**\n+     * Represents text key which should be set to an {@link Element} via\n+     * {@link Element#setText(String)}.\n+     * <p>\n+     * The real attribute may not contain {@code \"=\"} sign in the name so it's\n+     * safe to use this special key for text value in a map.\n+     */\n+    public static String TEXT_DATA = \"=text\";", "originalCommit": "1404cad33cddefe87cdc0eca742c25ec7f5557bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc1Nzc1Mw==", "url": "https://github.com/vaadin/flow/pull/9008#discussion_r488757753", "bodyText": "The assertion on the order indeed seems more sensible after the change, so the order was wrong before and there is a bug fixed also?\nI find the assertions messy after this change, as some of the calls to assertNodeOrder will be with the concated texts and some with separate parameters. Would be easier to understand and modify if the \\n were removed from the inserted text pieces in the test views and the assertion changed to simply:\n    private void assertNodeOrder(WebElement container, String... nodes) {\n        String texts = container.getText().replace(\"\\n\", \"\");\n        String expected = String.join(\"\", nodes);\n        Assert.assertEquals(expected, texts);\n    }\nThat would abstract away from the extra complication of whitespace between the added nodes. Unless for some reason that is actually part of the test?", "author": "joheriks", "createdAt": "2020-09-15T15:25:37Z", "path": "flow-tests/test-root-context/src/test/java/com/vaadin/flow/uitest/ui/template/ChildOrderIT.java", "diffHunk": "@@ -163,29 +163,28 @@ public void prependTextsFromServer_textsAreAddedBeforeExistingOnes() {\n         assertNodeOrder(container, \"Client text\");\n \n         clickAndWaitForContainerToChange(container, \"prependChildToContainer2\");\n-        assertNodeOrder(container, \"Client text\", \"Server text 1\");\n+        assertNodeOrder(container, \"Server text 1Client text\");\n \n         clickAndWaitForContainerToChange(container, \"prependChildToContainer2\");\n-        assertNodeOrder(container, \"Client text\", \"Server text 2\",\n-                \"Server text 1\");\n+        assertNodeOrder(container, \"Server text 2\", \"Server text 1Client text\");", "originalCommit": "1404cad33cddefe87cdc0eca742c25ec7f5557bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE4NjA0OQ==", "url": "https://github.com/vaadin/flow/pull/9008#discussion_r489186049", "bodyText": "No any bugs here previously or now.\nThe behavior has changed: \"Client text\" is now set to the containerWithText on the server side which means the element now has a text element (on the server side text is an element). As a result the server side containerWithText always has initial one element now.\nAnd every test which touches this element has to consider index shift back or forward.\nSo this is just direct consequence of setting the text for the element in template.\n(there is a genuine bug in another test failure)\nI don't like this test since it does too many things and it's too easy to break other things correcting another.\nThis test is not a part of this PR. It just fails with the changes in this PR and that's why I'm modifying it.\nI don't want to change anything else here accept the minimal changes to keep it passing.\nYou suggestion makes some sense, but it may introduce false positive result if strings (test data) in the nodes are modified.\nCurrently \"\\n\" is used as a clear separator for text in nodes, concatenating all string in one big string removes any separation and the comparison becomes fragile.\nI understand you concern about ugly string \"Server text 1Client text\"which I don't like either but this is a consequence of how DOM is done on the client side and absence the proper method of getting text recursively in Selenium.\nI see call assertNodeOrder(container, \"Server text 3\", \"Server text 2\",\"Server text 1Client text\", \"Client text\") with the current impl is more reliable and in fact quite expected within the current limitations (even though it's quite not-obvious why it works in this way, so you need to go deeply).\nEven though I completely agree that from \"internal API\" point of view assertNodeOrder(container, \"Server text 3\", \"Server text 2\",\"Server text 1\",\"Client text\", \"Client text\") is just much better: but simple impl of this is unclear for me.\nSo I would prefer to keep this as is : this issue  can be considered separately.", "author": "denis-anisimov", "createdAt": "2020-09-16T06:10:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc1Nzc1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI2NzU0OQ==", "url": "https://github.com/vaadin/flow/pull/9008#discussion_r489267549", "bodyText": "Ok, thanks for the clarifications.", "author": "joheriks", "createdAt": "2020-09-16T08:42:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc1Nzc1Mw=="}], "type": "inlineReview"}, {"oid": "24701f0a1148245a22e233c1bc20d6ae5f720605", "url": "https://github.com/vaadin/flow/commit/24701f0a1148245a22e233c1bc20d6ae5f720605", "message": "Improve code a bit based on review", "committedDate": "2020-09-16T12:42:16Z", "type": "forcePushed"}, {"oid": "e8fec4595e231062dbc71024599009a279177602", "url": "https://github.com/vaadin/flow/commit/e8fec4595e231062dbc71024599009a279177602", "message": "Read text content as an attribute data", "committedDate": "2020-09-17T09:47:43Z", "type": "commit"}, {"oid": "b01556d156ee704c7bf572fca7d7c790e13c5e86", "url": "https://github.com/vaadin/flow/commit/b01556d156ee704c7bf572fca7d7c790e13c5e86", "message": "Add unit tests for template element set text", "committedDate": "2020-09-17T09:47:44Z", "type": "commit"}, {"oid": "8ca4a9a2105973f42ef7ef25ecdc1a4e65436f39", "url": "https://github.com/vaadin/flow/commit/8ca4a9a2105973f42ef7ef25ecdc1a4e65436f39", "message": "Add IT for template element set text", "committedDate": "2020-09-17T09:47:44Z", "type": "commit"}, {"oid": "cc9aea88d7b2dc2f882006adcd1612ae8e65f269", "url": "https://github.com/vaadin/flow/commit/cc9aea88d7b2dc2f882006adcd1612ae8e65f269", "message": "Update IT after change for reading text", "committedDate": "2020-09-17T09:47:44Z", "type": "commit"}, {"oid": "b0b96b1b75a9cd2c3f31359c9104dfb451c61e36", "url": "https://github.com/vaadin/flow/commit/b0b96b1b75a9cd2c3f31359c9104dfb451c61e36", "message": "Improve code a bit based on review", "committedDate": "2020-09-17T09:47:45Z", "type": "commit"}, {"oid": "b6857b887f509973624fd8a169162068b9c206c8", "url": "https://github.com/vaadin/flow/commit/b6857b887f509973624fd8a169162068b9c206c8", "message": "Add missed tag for the component", "committedDate": "2020-09-17T09:47:45Z", "type": "commit"}, {"oid": "a79443097b5164a55a2656f6f260f329687ac34e", "url": "https://github.com/vaadin/flow/commit/a79443097b5164a55a2656f6f260f329687ac34e", "message": "Remove extra symbol", "committedDate": "2020-09-17T09:47:46Z", "type": "commit"}, {"oid": "6eeb9aa4d125d2f53fa1583b76eee23fa7b830db", "url": "https://github.com/vaadin/flow/commit/6eeb9aa4d125d2f53fa1583b76eee23fa7b830db", "message": "Add lost lines after merge", "committedDate": "2020-09-17T09:47:46Z", "type": "commit"}, {"oid": "6eeb9aa4d125d2f53fa1583b76eee23fa7b830db", "url": "https://github.com/vaadin/flow/commit/6eeb9aa4d125d2f53fa1583b76eee23fa7b830db", "message": "Add lost lines after merge", "committedDate": "2020-09-17T09:47:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDE0NjQ4OA==", "url": "https://github.com/vaadin/flow/pull/9008#discussion_r490146488", "bodyText": "Call \"tagName.isPresent()\" before accessing the value.", "author": "vaadin-bot", "createdAt": "2020-09-17T10:43:37Z", "path": "flow-server/src/main/java/com/vaadin/flow/component/polymertemplate/IdCollector.java", "diffHunk": "@@ -136,8 +137,10 @@ private boolean collectElementData(String id, Field field) {\n             Optional<String> tagName = element\n                     .map(org.jsoup.nodes.Element::tagName);\n             if (element.isPresent()) {\n+                Element domElement = element.get();\n                 tagById.put(id, tagName.get());", "originalCommit": "6eeb9aa4d125d2f53fa1583b76eee23fa7b830db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}