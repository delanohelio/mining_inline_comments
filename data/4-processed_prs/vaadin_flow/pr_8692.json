{"pr_number": 8692, "pr_title": "Fix exact item count resolving if scrolled far", "pr_createdAt": "2020-07-05T20:10:42Z", "pr_url": "https://github.com/vaadin/flow/pull/8692", "timeline": [{"oid": "8809535f52c83fc2ffeee35643eb00d241a982d9", "url": "https://github.com/vaadin/flow/commit/8809535f52c83fc2ffeee35643eb00d241a982d9", "message": "Fix exact item count resolving if scrolled far\n\nAdds isCountEstimated() to ItemCountChangeEvent.\n\nIf item count estimate allows the user to scroll way past the exact count,\nDataCommunicator will now resolve the exact count immediately instead of\nreturning 0 items and new size to the client, which would have to keep\nrequesting items until the end was reached.\n\nFixes #8643", "committedDate": "2020-07-05T20:36:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAxMzMyMg==", "url": "https://github.com/vaadin/flow/pull/8692#discussion_r450013322", "bodyText": "Doesn't this break the connector behaviour? Have you tested the grid manually after these changes? I'm a bit worry about the fact that the connector send the requested range to the server, and then the server sends back the data corresponding to another request range (which is shifted by the server). Is that a some kind of optimisation to avoid redundant client-servers interactions?", "author": "mshabarov", "createdAt": "2020-07-06T06:43:19Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/DataCommunicator.java", "diffHunk": "@@ -792,7 +797,20 @@ private void flush() {\n                 // the end has been reached\n                 assumedSize = requestedRange.getStart()\n                         + activation.getActiveKeys().size();\n-                skipSizeCheckUntilReset = true;\n+                skipCountIncreaseUntilReset = true;\n+                /*\n+                 * If the fetch query returned 0 items, it means that the user\n+                 * has scrolled past the end of the exact item count. Instead of\n+                 * returning 0 items to the client and letting it incrementally\n+                 * request for the previous pages, we'll cancel this flush and\n+                 * tweak the requested range and flush again.\n+                 */\n+                if (assumedSize != 0 && activation.getActiveKeys().size() == 0) {", "originalCommit": "8809535f52c83fc2ffeee35643eb00d241a982d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDA1MDkyNQ==", "url": "https://github.com/vaadin/flow/pull/8692#discussion_r450050925", "bodyText": "I've tested this case using the GridDemo (with appropriate itemCountEstimate and itemCountEstimateIncrease) and it works good. Withdraw my comment.", "author": "mshabarov", "createdAt": "2020-07-06T08:04:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAxMzMyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI5OTQ2OA==", "url": "https://github.com/vaadin/flow/pull/8692#discussion_r450299468", "bodyText": "I did test it myself too as I was unsure how the web component would react - but it is simple and beautiful that it will just work - as it first gets the new size and it requests the new item range which is already available on the client.", "author": "pleku", "createdAt": "2020-07-06T15:24:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAxMzMyMg=="}], "type": "inlineReview"}, {"oid": "aee06073f8fac98757fb41a4300c24f077e6b493", "url": "https://github.com/vaadin/flow/commit/aee06073f8fac98757fb41a4300c24f077e6b493", "message": "Fix exact item count resolving if scrolled far\n\nAdds isCountEstimated() to ItemCountChangeEvent.\n\nIf item count estimate allows the user to scroll way past the exact count,\nDataCommunicator will now resolve the exact count immediately instead of\nreturning 0 items and new size to the client, which would have to keep\nrequesting items until the end was reached.\n\nFixes #8643", "committedDate": "2020-07-06T11:34:41Z", "type": "commit"}, {"oid": "c6c5a8eaeb12a2fe707be3198d540f8bb9ab1f2a", "url": "https://github.com/vaadin/flow/commit/c6c5a8eaeb12a2fe707be3198d540f8bb9ab1f2a", "message": "Fix sonar issues", "committedDate": "2020-07-06T11:34:42Z", "type": "commit"}, {"oid": "c6c5a8eaeb12a2fe707be3198d540f8bb9ab1f2a", "url": "https://github.com/vaadin/flow/commit/c6c5a8eaeb12a2fe707be3198d540f8bb9ab1f2a", "message": "Fix sonar issues", "committedDate": "2020-07-06T11:34:42Z", "type": "forcePushed"}]}