{"pr_number": 9377, "pr_title": "feat: application connection state store", "pr_createdAt": "2020-11-11T08:17:41Z", "pr_url": "https://github.com/vaadin/flow/pull/9377", "timeline": [{"oid": "f5f87fbee2bd235d1176f675f45a9d4db2b5d5c9", "url": "https://github.com/vaadin/flow/commit/f5f87fbee2bd235d1176f675f45a9d4db2b5d5c9", "message": "Connection state transition transitions", "committedDate": "2020-11-11T13:26:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTUxMDM4MA==", "url": "https://github.com/vaadin/flow/pull/9377#discussion_r521510380", "bodyText": "BTW: Using Set instead of array for storage works better for this use case, in particular, addStateChangeListener and removeStateChangeListener methods would map directly to stateChangeListeners.add and stateChangeListeners.remove.\nIterating a Set could be done with for...of\nhttps://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Set", "author": "platosha", "createdAt": "2020-11-11T17:12:46Z", "path": "flow-client/src/main/resources/META-INF/resources/frontend/ConnectionState.ts", "diffHunk": "@@ -0,0 +1,72 @@\n+export enum ConnectionState {\n+  /**\n+   * Application is connected to server: last transaction over the wire (XHR /\n+   * heartbeat / endpoint call) was successful.\n+   */\n+  CONNECTED ='connected',\n+\n+  /**\n+   * Application is connected and Flow is loading application state from the\n+   * server, or Fusion is waiting for an endpoint call to return.\n+   */\n+  LOADING = 'loading',\n+\n+  /**\n+   * Application has been temporarily disconnected from the server because the\n+   * last transaction over the write (XHR / heartbeat / endpoint call) resulted\n+   * in a network error. Flow is attempting to reconnect.\n+   */\n+  RECONNECTING = 'reconnecting',\n+\n+  /**\n+   * Application has been permanently disconnected due to browser going offline,\n+   * or the server not being reached after a number of reconnect attempts\n+   * (see ReconnectDialogConfiguration.java: RECONNECT_ATTEMPTS_KEY).\n+   */\n+  CONNECTION_LOST = 'connection-lost'\n+}\n+\n+type ConnectionStateChangeListener = (previous: ConnectionState, current: ConnectionState) => void;\n+\n+export class ConnectionStateStore {\n+\n+  private state: ConnectionState;\n+\n+  private stateChangeListeners: ConnectionStateChangeListener[] = [];", "originalCommit": "62c2196d3060ed05840c922f376c141fbbd97020", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg5Mzc5MA==", "url": "https://github.com/vaadin/flow/pull/9377#discussion_r521893790", "bodyText": "Done.", "author": "joheriks", "createdAt": "2020-11-12T07:41:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTUxMDM4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTUxMDQxOQ==", "url": "https://github.com/vaadin/flow/pull/9377#discussion_r521510419", "bodyText": "Should we do get state() set state() instead of getState()/setState() maybe?", "author": "platosha", "createdAt": "2020-11-11T17:12:48Z", "path": "flow-client/src/main/resources/META-INF/resources/frontend/ConnectionState.ts", "diffHunk": "@@ -0,0 +1,72 @@\n+export enum ConnectionState {\n+  /**\n+   * Application is connected to server: last transaction over the wire (XHR /\n+   * heartbeat / endpoint call) was successful.\n+   */\n+  CONNECTED ='connected',\n+\n+  /**\n+   * Application is connected and Flow is loading application state from the\n+   * server, or Fusion is waiting for an endpoint call to return.\n+   */\n+  LOADING = 'loading',\n+\n+  /**\n+   * Application has been temporarily disconnected from the server because the\n+   * last transaction over the write (XHR / heartbeat / endpoint call) resulted\n+   * in a network error. Flow is attempting to reconnect.\n+   */\n+  RECONNECTING = 'reconnecting',\n+\n+  /**\n+   * Application has been permanently disconnected due to browser going offline,\n+   * or the server not being reached after a number of reconnect attempts\n+   * (see ReconnectDialogConfiguration.java: RECONNECT_ATTEMPTS_KEY).\n+   */\n+  CONNECTION_LOST = 'connection-lost'\n+}\n+\n+type ConnectionStateChangeListener = (previous: ConnectionState, current: ConnectionState) => void;\n+\n+export class ConnectionStateStore {\n+\n+  private state: ConnectionState;\n+\n+  private stateChangeListeners: ConnectionStateChangeListener[] = [];\n+\n+  constructor(initialState: ConnectionState) {\n+      this.state = initialState;\n+  }\n+\n+  getState(): ConnectionState {", "originalCommit": "62c2196d3060ed05840c922f376c141fbbd97020", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg5Mzc1Mw==", "url": "https://github.com/vaadin/flow/pull/9377#discussion_r521893753", "bodyText": "Agreed, done.", "author": "joheriks", "createdAt": "2020-11-12T07:41:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTUxMDQxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTUxOTA4MA==", "url": "https://github.com/vaadin/flow/pull/9377#discussion_r521519080", "bodyText": "Maybe get online(): boolean should be preferred", "author": "platosha", "createdAt": "2020-11-11T17:26:26Z", "path": "flow-client/src/main/resources/META-INF/resources/frontend/ConnectionState.ts", "diffHunk": "@@ -0,0 +1,72 @@\n+export enum ConnectionState {\n+  /**\n+   * Application is connected to server: last transaction over the wire (XHR /\n+   * heartbeat / endpoint call) was successful.\n+   */\n+  CONNECTED ='connected',\n+\n+  /**\n+   * Application is connected and Flow is loading application state from the\n+   * server, or Fusion is waiting for an endpoint call to return.\n+   */\n+  LOADING = 'loading',\n+\n+  /**\n+   * Application has been temporarily disconnected from the server because the\n+   * last transaction over the write (XHR / heartbeat / endpoint call) resulted\n+   * in a network error. Flow is attempting to reconnect.\n+   */\n+  RECONNECTING = 'reconnecting',\n+\n+  /**\n+   * Application has been permanently disconnected due to browser going offline,\n+   * or the server not being reached after a number of reconnect attempts\n+   * (see ReconnectDialogConfiguration.java: RECONNECT_ATTEMPTS_KEY).\n+   */\n+  CONNECTION_LOST = 'connection-lost'\n+}\n+\n+type ConnectionStateChangeListener = (previous: ConnectionState, current: ConnectionState) => void;\n+\n+export class ConnectionStateStore {\n+\n+  private state: ConnectionState;\n+\n+  private stateChangeListeners: ConnectionStateChangeListener[] = [];\n+\n+  constructor(initialState: ConnectionState) {\n+      this.state = initialState;\n+  }\n+\n+  getState(): ConnectionState {\n+    return this.state;\n+  }\n+\n+  addStateChangeListener(listener: ConnectionStateChangeListener): void {\n+    if (this.stateChangeListeners.indexOf(listener) === -1) {\n+      this.stateChangeListeners.push(listener);\n+    }\n+  }\n+\n+  removeStateChangeListener(listener: ConnectionStateChangeListener): void {\n+    const index = this.stateChangeListeners.indexOf(listener);\n+    this.stateChangeListeners.splice(index);\n+  }\n+\n+  setState(newState: ConnectionState) {\n+    if (newState !== this.state) {\n+      const prevState = this.state;\n+      this.state = newState;\n+      this.stateChangeListeners.forEach(listener => listener(prevState, this.state));\n+    }\n+  }\n+\n+  isOnline(): boolean {", "originalCommit": "62c2196d3060ed05840c922f376c141fbbd97020", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg5MzcwOA==", "url": "https://github.com/vaadin/flow/pull/9377#discussion_r521893708", "bodyText": "Done.", "author": "joheriks", "createdAt": "2020-11-12T07:41:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTUxOTA4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTUxOTE3Nw==", "url": "https://github.com/vaadin/flow/pull/9377#discussion_r521519177", "bodyText": "Placing these handlers in Flow.ts makes them inactive before the first server-side view is requested, right? Was that intentional?", "author": "platosha", "createdAt": "2020-11-11T17:26:36Z", "path": "flow-client/src/main/resources/META-INF/resources/frontend/Flow.ts", "diffHunk": "@@ -404,19 +394,34 @@ export class Flow {\n     // be reused in Connect.ts\n     let timeout2nd: any;\n     let timeout3rd: any;\n-    $wnd.Vaadin.Flow.loading = (action: boolean) => {\n+    const connectionState = new ConnectionStateStore(\n+      navigator.onLine ? ConnectionState.CONNECTED : ConnectionState.CONNECTION_LOST);\n+    connectionState.addStateChangeListener( (_: ConnectionState, current: ConnectionState) => {\n       clearTimeout(timeout2nd);\n       clearTimeout(timeout3rd);\n       loading.classList.remove('second');\n       loading.classList.remove('third');\n-      if (action) {\n+      if (current === ConnectionState.LOADING) {\n         loading.removeAttribute('style');\n         timeout2nd = setTimeout(() => loading.classList.add('second'), 1500);\n         timeout3rd = setTimeout(() => loading.classList.add('third'), 5000);\n+\n+        // Make Testbench know that server request is in progress\n+        this.isActive = true;\n       } else {\n         loading.setAttribute('style', 'none');\n+        // Make Testbench know that server request is no longer active\n+        this.isActive = false;\n       }\n-    };\n+    });\n+\n+    $wnd.addEventListener('online', () => {\n+      connectionState.setState(ConnectionState.CONNECTED);", "originalCommit": "62c2196d3060ed05840c922f376c141fbbd97020", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg5MzY3Nw==", "url": "https://github.com/vaadin/flow/pull/9377#discussion_r521893677", "bodyText": "This code is invoked from the constructor of Flow, and this object is always created (in index.ts) even when starting from a client-side view AFAIK.", "author": "joheriks", "createdAt": "2020-11-12T07:41:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTUxOTE3Nw=="}], "type": "inlineReview"}, {"oid": "cf36ec07e7fca9082a9faf88d5ed645ed0029e07", "url": "https://github.com/vaadin/flow/commit/cf36ec07e7fca9082a9faf88d5ed645ed0029e07", "message": "Minor improvements: keep listeners in Set instead of array, online/offline properties", "committedDate": "2020-11-12T07:46:49Z", "type": "forcePushed"}, {"oid": "c2625ce4611cbb5cc6ed6b9198bed0012c05b6b9", "url": "https://github.com/vaadin/flow/commit/c2625ce4611cbb5cc6ed6b9198bed0012c05b6b9", "message": "De-flake IT", "committedDate": "2020-11-13T07:27:32Z", "type": "forcePushed"}, {"oid": "8d8ec36f80c3d19073e1ae9033e43ef75d397359", "url": "https://github.com/vaadin/flow/commit/8d8ec36f80c3d19073e1ae9033e43ef75d397359", "message": "fix: transition logic, loadingStarted/loadingSucceded pair for stacking LOADING transitions.", "committedDate": "2020-11-16T10:15:48Z", "type": "forcePushed"}, {"oid": "1672dd02b2cef4bd40832139b9e0a2f50340eab7", "url": "https://github.com/vaadin/flow/commit/1672dd02b2cef4bd40832139b9e0a2f50340eab7", "message": "feat: initial sketch of connection state store", "committedDate": "2020-11-16T10:17:22Z", "type": "commit"}, {"oid": "b236fde166e5e423c8652f01f61309a35bbd8d51", "url": "https://github.com/vaadin/flow/commit/b236fde166e5e423c8652f01f61309a35bbd8d51", "message": "Connection state transition transitions", "committedDate": "2020-11-16T10:21:32Z", "type": "commit"}, {"oid": "b1cbeb88df92f650adf696fdcf0726ded559ccfb", "url": "https://github.com/vaadin/flow/commit/b1cbeb88df92f650adf696fdcf0726ded559ccfb", "message": "Minor improvements: keep listeners in Set instead of array, online/offline properties", "committedDate": "2020-11-16T10:21:39Z", "type": "commit"}, {"oid": "7f20931a48b068d22f636a80d0bbfdce7d132baf", "url": "https://github.com/vaadin/flow/commit/7f20931a48b068d22f636a80d0bbfdce7d132baf", "message": "Add `ConnectionState` to `generated-flow-imports.js`. Add connectionState to `window.Vaadin.Flow` on import.", "committedDate": "2020-11-16T10:21:39Z", "type": "commit"}, {"oid": "3d84b0b8f99478f7341f7c64ce61cb7dffdb21ca", "url": "https://github.com/vaadin/flow/commit/3d84b0b8f99478f7341f7c64ce61cb7dffdb21ca", "message": "ConnectionState: `state` as property instead of getter, setter methods.", "committedDate": "2020-11-16T10:21:39Z", "type": "commit"}, {"oid": "19ea28ea0bbf78a851aca8573e36693ee70e3e7c", "url": "https://github.com/vaadin/flow/commit/19ea28ea0bbf78a851aca8573e36693ee70e3e7c", "message": "Serializable", "committedDate": "2020-11-16T10:21:39Z", "type": "commit"}, {"oid": "45e126ba55f8fe120ec59c16895ceaa3f131d51b", "url": "https://github.com/vaadin/flow/commit/45e126ba55f8fe120ec59c16895ceaa3f131d51b", "message": "fix: Create only one ConnectionStateStore", "committedDate": "2020-11-16T10:21:39Z", "type": "commit"}, {"oid": "266d2915f005c59d7ffeaa8346873ec4c65b7dcc", "url": "https://github.com/vaadin/flow/commit/266d2915f005c59d7ffeaa8346873ec4c65b7dcc", "message": "Force ConnectionState into primary chunk", "committedDate": "2020-11-16T10:21:39Z", "type": "commit"}, {"oid": "5cbc6cab2c6b0a2d6f28169da707b59f5044fed6", "url": "https://github.com/vaadin/flow/commit/5cbc6cab2c6b0a2d6f28169da707b59f5044fed6", "message": "fix: GWT - TS compatibility for `ConnectionState` type", "committedDate": "2020-11-16T10:21:39Z", "type": "commit"}, {"oid": "6579b620a493c07122b73d2f9a17f5a32fbf94af", "url": "https://github.com/vaadin/flow/commit/6579b620a493c07122b73d2f9a17f5a32fbf94af", "message": "De-flake IT", "committedDate": "2020-11-16T10:21:39Z", "type": "commit"}, {"oid": "031c711ef3a43eb891649d1142014868fc2dcee8", "url": "https://github.com/vaadin/flow/commit/031c711ef3a43eb891649d1142014868fc2dcee8", "message": "Basic backwards-compatible LoadingIndicator Lit element with light DOM", "committedDate": "2020-11-16T10:21:39Z", "type": "commit"}, {"oid": "fd050b2e9fc4729d34bf1bf80d1369c6a5539027", "url": "https://github.com/vaadin/flow/commit/fd050b2e9fc4729d34bf1bf80d1369c6a5539027", "message": "fix: loading indicator unit tests", "committedDate": "2020-11-16T10:21:39Z", "type": "commit"}, {"oid": "7fab411f726eb62f4fbac59f5bbc068314c11cec", "url": "https://github.com/vaadin/flow/commit/7fab411f726eb62f4fbac59f5bbc068314c11cec", "message": "Add LoadingIndicator.ts as JsModule dependency to UI for main bundle inclusion", "committedDate": "2020-11-16T10:21:39Z", "type": "commit"}, {"oid": "0f3b39c46f626187e36e18df873f4286b6ff7c0a", "url": "https://github.com/vaadin/flow/commit/0f3b39c46f626187e36e18df873f4286b6ff7c0a", "message": "fix: namespace (s/Vaadin.Flow.loadingIndicator/Vaadin.loadingIndicator/, s/Vaadin.Flow.connectionState/Vaadin.connectionState/)", "committedDate": "2020-11-16T10:21:39Z", "type": "commit"}, {"oid": "6abd215182c54c908b43b5de482d73f745a116db", "url": "https://github.com/vaadin/flow/commit/6abd215182c54c908b43b5de482d73f745a116db", "message": "fix: updated unit tests failing after UI annotation", "committedDate": "2020-11-16T10:21:39Z", "type": "commit"}, {"oid": "40468593e69a449b4c02bb1bea701bab54d49446", "url": "https://github.com/vaadin/flow/commit/40468593e69a449b4c02bb1bea701bab54d49446", "message": "fix: transition logic, loadingStarted/loadingSucceded pair for stacking LOADING transitions.", "committedDate": "2020-11-16T10:22:17Z", "type": "commit"}, {"oid": "aec44f9d29b5b699919a63cc10f53d0f84a23b15", "url": "https://github.com/vaadin/flow/commit/aec44f9d29b5b699919a63cc10f53d0f84a23b15", "message": "fix: transition to CONNECTION_LOST when an endpoint call encounters network failure", "committedDate": "2020-11-16T11:05:00Z", "type": "commit"}, {"oid": "aec44f9d29b5b699919a63cc10f53d0f84a23b15", "url": "https://github.com/vaadin/flow/commit/aec44f9d29b5b699919a63cc10f53d0f84a23b15", "message": "fix: transition to CONNECTION_LOST when an endpoint call encounters network failure", "committedDate": "2020-11-16T11:05:00Z", "type": "forcePushed"}, {"oid": "5fead6afa736a7c5cd78f1c3f80a70c614906ecf", "url": "https://github.com/vaadin/flow/commit/5fead6afa736a7c5cd78f1c3f80a70c614906ecf", "message": "Guard statement accessing Vaadin.connectionState", "committedDate": "2020-11-16T13:08:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI4MjIwMQ==", "url": "https://github.com/vaadin/flow/pull/9377#discussion_r524282201", "bodyText": "Do we really need this? Isn't the LoadingIndicator imported in Flow.ts?", "author": "haijian-vaadin", "createdAt": "2020-11-16T13:52:49Z", "path": "flow-server/src/main/java/com/vaadin/flow/component/UI.java", "diffHunk": "@@ -92,6 +93,7 @@\n  *\n  * @since 1.0\n  */\n+@JsModule(\"@vaadin/flow-frontend/LoadingIndicator.js\")", "originalCommit": "5fead6afa736a7c5cd78f1c3f80a70c614906ecf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI4NjcyNA==", "url": "https://github.com/vaadin/flow/pull/9377#discussion_r524286724", "bodyText": "Flow.ts is not loaded in legacy bootstrapping mode. Agree it's not very nice to have a JsModule annotation here, open to suggestions for other ways of solving the backwards compatibility issue.", "author": "joheriks", "createdAt": "2020-11-16T13:59:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI4MjIwMQ=="}], "type": "inlineReview"}, {"oid": "70ed8a47133a300d6fac460f15e6d0e0f5384f62", "url": "https://github.com/vaadin/flow/commit/70ed8a47133a300d6fac460f15e6d0e0f5384f62", "message": "De-flake another IT", "committedDate": "2020-11-16T19:32:57Z", "type": "commit"}, {"oid": "a1f23728d26f1dd6b5ee36805a7fe6994cca7072", "url": "https://github.com/vaadin/flow/commit/a1f23728d26f1dd6b5ee36805a7fe6994cca7072", "message": "Update `isActive` eagerly instead of reactively on state transitions", "committedDate": "2020-11-16T21:01:18Z", "type": "commit"}, {"oid": "047b2a27c3366de88073f69d5d5efb4adbad0160", "url": "https://github.com/vaadin/flow/commit/047b2a27c3366de88073f69d5d5efb4adbad0160", "message": "Revert \"De-flake IT\"\n\nThis reverts commit 6579b620a493c07122b73d2f9a17f5a32fbf94af.", "committedDate": "2020-11-17T07:07:22Z", "type": "commit"}, {"oid": "962b19e9d18126463cf08c3a3e959c5d56d8ae78", "url": "https://github.com/vaadin/flow/commit/962b19e9d18126463cf08c3a3e959c5d56d8ae78", "message": "Revert \"De-flake another IT\"\n\nThis reverts commit 70ed8a47133a300d6fac460f15e6d0e0f5384f62.", "committedDate": "2020-11-17T07:07:29Z", "type": "commit"}]}