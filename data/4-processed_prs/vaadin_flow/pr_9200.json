{"pr_number": 9200, "pr_title": "feat: offline stub for server-side views", "pr_createdAt": "2020-10-19T17:10:07Z", "pr_url": "https://github.com/vaadin/flow/pull/9200", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk4NTMzMA==", "url": "https://github.com/vaadin/flow/pull/9200#discussion_r508985330", "bodyText": "Maybe we should also check if a custom offlinePath is defined. Otherwise, Anton's PR won't work.", "author": "haijian-vaadin", "createdAt": "2020-10-21T04:40:52Z", "path": "flow-client/src/main/resources/META-INF/resources/frontend/Flow.ts", "diffHunk": "@@ -117,11 +117,26 @@ export class Flow {\n       // Store last action pathname so as we can check it in events\n       this.pathname = params.pathname;\n \n-      await this.flowInit();\n-      // When an action happens, navigation will be resolved `onBeforeEnter`\n-      this.container.onBeforeEnter = (ctx, cmd) => this.flowNavigate(ctx, cmd);\n-      // For covering the 'server -> client' use case\n-      this.container.onBeforeLeave = (ctx, cmd) => this.flowLeave(ctx, cmd);\n+      if (navigator.onLine) {", "originalCommit": "93d51943b80baa2662298475f55806319b2b0c9c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "31e5e46e49d46acb859fe989e1bf48fbb545f9ca", "url": "https://github.com/vaadin/flow/commit/31e5e46e49d46acb859fe989e1bf48fbb545f9ca", "message": "Unit test for offline stub", "committedDate": "2020-10-21T14:13:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDgyMjIwMQ==", "url": "https://github.com/vaadin/flow/pull/9200#discussion_r510822201", "bodyText": "onLine could be false positive, for example, if there is a network but it is not functional.\nIt would be nice to have a fallback for this use case as well. Something like:\nif (!navigator.onLine) {\n  await this.showOfflineStub();\n} else {\n  try {\n    await this.flowInit();\n  } catch(error) {\n    await this.showOfflineStub();\n  }\n}", "author": "platosha", "createdAt": "2020-10-23T11:36:45Z", "path": "flow-client/src/main/resources/META-INF/resources/frontend/Flow.ts", "diffHunk": "@@ -117,7 +117,17 @@ export class Flow {\n       // Store last action pathname so as we can check it in events\n       this.pathname = params.pathname;\n \n-      await this.flowInit();\n+      if (navigator.onLine) {\n+        // @ts-ignore\n+        await this.flowInit();", "originalCommit": "e43a038429751014b6ceffe6efa4c22db07b25b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDkzMzE0NQ==", "url": "https://github.com/vaadin/flow/pull/9200#discussion_r510933145", "bodyText": "Good idea, updated to show the offline stub also in the failed connection case. Only unit test for this one though, as setting up the scenario in IT gets unnecessarily complicated.", "author": "joheriks", "createdAt": "2020-10-23T14:42:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDgyMjIwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc2Njc2NA==", "url": "https://github.com/vaadin/flow/pull/9200#discussion_r511766764", "bodyText": "Should it also check what kind of error it is? simply catching all the errors might lead to a confusing situation, e.g. when the server throws some exception and the user suddenly sees an offline page.", "author": "haijian-vaadin", "createdAt": "2020-10-26T07:46:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDgyMjIwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkzMjcxOA==", "url": "https://github.com/vaadin/flow/pull/9200#discussion_r511932718", "bodyText": "The logic of flowInitUI wraps a XMLHttpRequest with a promise that is rejected only onerror. This SO thread  concludes that onerror only triggers for network-level errors (e.g., no internet, DNS lookup failure, same-origin violation, etc.). It does not trigger for irregular HTTP response code such as 404, 501, etc. I added a specific exception raised there so that offline stub is not shown for other exceptions raised within flowInitUI (instead the user will see the infinitely blinking loading indicator as before).", "author": "joheriks", "createdAt": "2020-10-26T12:47:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDgyMjIwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE5NjEwNw==", "url": "https://github.com/vaadin/flow/pull/9200#discussion_r512196107", "bodyText": "Looks good!\nJust found one small improvement that can be made. I think we could also hide the loading indicator (the hideLoading() method), otherwise when the server is not reachable, it shows the loading indicator indefinitely.", "author": "haijian-vaadin", "createdAt": "2020-10-26T18:55:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDgyMjIwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjIyMjA3Ng==", "url": "https://github.com/vaadin/flow/pull/9200#discussion_r512222076", "bodyText": "Done.", "author": "joheriks", "createdAt": "2020-10-26T19:41:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDgyMjIwMQ=="}], "type": "inlineReview"}, {"oid": "da855dd70a95c73e823ebf45512dddeb76b4a27d", "url": "https://github.com/vaadin/flow/commit/da855dd70a95c73e823ebf45512dddeb76b4a27d", "message": "Hide loading indicator when showing offline stub due to XMLHttpRequest onerror", "committedDate": "2020-10-26T19:42:57Z", "type": "forcePushed"}, {"oid": "27f3b34cdc0d426752f7da54523b88811411fc4a", "url": "https://github.com/vaadin/flow/commit/27f3b34cdc0d426752f7da54523b88811411fc4a", "message": "feat: offline stub for server-side views", "committedDate": "2020-10-28T15:39:57Z", "type": "commit"}, {"oid": "27f3b34cdc0d426752f7da54523b88811411fc4a", "url": "https://github.com/vaadin/flow/commit/27f3b34cdc0d426752f7da54523b88811411fc4a", "message": "feat: offline stub for server-side views", "committedDate": "2020-10-28T15:39:57Z", "type": "forcePushed"}]}