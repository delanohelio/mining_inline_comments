{"pr_number": 9406, "pr_title": "feat: Only handle annotated theme", "pr_createdAt": "2020-11-16T08:29:51Z", "pr_url": "https://github.com/vaadin/flow/pull/9406", "timeline": [{"oid": "c4514f8239faab36bdc79d3c208ffac832c5ef4b", "url": "https://github.com/vaadin/flow/commit/c4514f8239faab36bdc79d3c208ffac832c5ef4b", "message": "feat: Only handle annotated theme\n\nNow we only handle the theme with\nthe name inside the Theme annotation.\n\nFixes #9383", "committedDate": "2020-11-16T07:05:33Z", "type": "commit"}, {"oid": "a5a3f0705909681229f63d36e16c6ce672930a47", "url": "https://github.com/vaadin/flow/commit/a5a3f0705909681229f63d36e16c6ce672930a47", "message": "Merge branch 'master' into issues/9383_only_handle_target_theme\n\n# Conflicts:\n#\tflow-tests/test-misc/src/test/java/com/vaadin/flow/misc/ui/NpmThemedComponentIT.java", "committedDate": "2020-11-16T10:27:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA1MTM5Mw==", "url": "https://github.com/vaadin/flow/pull/9406#discussion_r524051393", "bodyText": "Mayhaps this msg could be updated too", "author": "pleku", "createdAt": "2020-11-16T09:55:13Z", "path": "flow-server/src/main/resources/plugins/application-theme-plugin/application-theme-plugin.js", "diffHunk": "@@ -24,25 +24,23 @@ let logger;\n /**\n  * The application theme plugin is for generating, collecting and copying of theme files for the application theme.\n  *\n- * TODO: enable giving themes to handle #9383\n- *\n  * The plugin should be supplied with the paths for\n  *\n- *  themeJarFolder                  - theme folder inside a jar\n+ *  themeResourceFolder             - theme folder where flow copies local and jar resource frontend files\n  *  themeProjectFolders             - array of possible locations for theme folders inside the project\n  *  projectStaticAssetsOutputFolder - path to where static assets should be put\n  */\n class ApplicationThemePlugin {\n   constructor(options) {\n     this.options = options;\n \n-    if(!this.options.themeJarFolder) {\n+    if (!this.options.themeResourceFolder) {\n       throw new Error(\"Missing themeJarFolder path\");", "originalCommit": "c4514f8239faab36bdc79d3c208ffac832c5ef4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk2MTc5OA==", "url": "https://github.com/vaadin/flow/pull/9406#discussion_r524961798", "bodyText": "\ud83d\udc4d", "author": "caalador", "createdAt": "2020-11-17T08:18:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA1MTM5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA2OTI4OA==", "url": "https://github.com/vaadin/flow/pull/9406#discussion_r524069288", "bodyText": "Does it make sense to move this outside of the method to be reused ?", "author": "pleku", "createdAt": "2020-11-16T10:11:02Z", "path": "flow-server/src/main/resources/plugins/application-theme-plugin/application-theme-plugin.js", "diffHunk": "@@ -51,17 +49,30 @@ class ApplicationThemePlugin {\n     logger = compiler.getInfrastructureLogger(\"ApplicationThemePlugin\");\n \n     compiler.hooks.afterEnvironment.tap(\"ApplicationThemePlugin\", () => {\n-      if (fs.existsSync(this.options.themeJarFolder)) {\n-        logger.debug(\"Found themeFolder in jar file \", this.options.themeJarFolder);\n-        handleThemes(this.options.themeJarFolder, this.options.projectStaticAssetsOutputFolder);\n-      }\n+      const generatedThemeFile = path.resolve(this.options.themeResourceFolder, \"theme-generated.js\");\n+      if (fs.existsSync(generatedThemeFile)) {\n+\n+        // read theme name from the theme-generated.js as there we always mark the used theme for webpack to handle.\n+        const nameRegex = /theme\\/(.*)\\/\\1.js/g; // matches theme folder name in 'theme/my-theme/my-theme.js'", "originalCommit": "c4514f8239faab36bdc79d3c208ffac832c5ef4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk2MjUyMw==", "url": "https://github.com/vaadin/flow/pull/9406#discussion_r524962523", "bodyText": "\ud83d\udc4d", "author": "caalador", "createdAt": "2020-11-17T08:19:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA2OTI4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA3NTU5NQ==", "url": "https://github.com/vaadin/flow/pull/9406#discussion_r524075595", "bodyText": "Should this refer to @Theme, I mean that user might be confused what this is about and might unnecessarily worry about it. Maybe also could include keyword Vaadin like \"Skipping Vaadin application theme handling\", unless it is present otherwise in the log line", "author": "pleku", "createdAt": "2020-11-16T10:16:35Z", "path": "flow-server/src/main/resources/plugins/application-theme-plugin/application-theme-plugin.js", "diffHunk": "@@ -51,17 +49,30 @@ class ApplicationThemePlugin {\n     logger = compiler.getInfrastructureLogger(\"ApplicationThemePlugin\");\n \n     compiler.hooks.afterEnvironment.tap(\"ApplicationThemePlugin\", () => {\n-      if (fs.existsSync(this.options.themeJarFolder)) {\n-        logger.debug(\"Found themeFolder in jar file \", this.options.themeJarFolder);\n-        handleThemes(this.options.themeJarFolder, this.options.projectStaticAssetsOutputFolder);\n-      }\n+      const generatedThemeFile = path.resolve(this.options.themeResourceFolder, \"theme-generated.js\");\n+      if (fs.existsSync(generatedThemeFile)) {\n+\n+        // read theme name from the theme-generated.js as there we always mark the used theme for webpack to handle.\n+        const nameRegex = /theme\\/(.*)\\/\\1.js/g; // matches theme folder name in 'theme/my-theme/my-theme.js'\n+        const themeName = nameRegex.exec(fs.readFileSync(generatedThemeFile, {encoding: 'utf8'}))[1];\n+        if (!themeName) {\n+          throw new Error(\"Couldn't parse theme name from '\" + generatedThemeFile + \"'.\");\n+        }\n \n-      this.options.themeProjectFolders.forEach((themeProjectFolder) => {\n-        if (fs.existsSync(themeProjectFolder)) {\n-          logger.debug(\"Found themeFolder from \", themeProjectFolder);\n-          handleThemes(themeProjectFolder, this.options.projectStaticAssetsOutputFolder);\n+        if (fs.existsSync(this.options.themeResourceFolder)) {\n+          logger.debug(\"Found themeFolder in jar file \", this.options.themeResourceFolder);\n+          handleThemes(themeName, this.options.themeResourceFolder, this.options.projectStaticAssetsOutputFolder);\n         }\n-      });\n+\n+        this.options.themeProjectFolders.forEach((themeProjectFolder) => {\n+          if (fs.existsSync(themeProjectFolder)) {\n+            logger.debug(\"Found themeFolder from \", themeProjectFolder);\n+            handleThemes(themeName, themeProjectFolder, this.options.projectStaticAssetsOutputFolder);\n+          }\n+        });\n+      } else {\n+        logger.log(\"No '\", generatedThemeFile, \"' found. Skipping application theme handling.\");", "originalCommit": "c4514f8239faab36bdc79d3c208ffac832c5ef4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTAxNTQzNA==", "url": "https://github.com/vaadin/flow/pull/9406#discussion_r525015434", "bodyText": "Changed log level and added extra trace with more information.", "author": "caalador", "createdAt": "2020-11-17T09:42:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA3NTU5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI2MTkwOQ==", "url": "https://github.com/vaadin/flow/pull/9406#discussion_r524261909", "bodyText": "So now when theme-name is discovered from both inside a .jar and inside the /theme/ folder in the project both will be loaded. While I cannot figure out at the moment why it would be a bad thing yet, the spec says that when you have something inside a .jar, it should be used from there. If you have something inside  the /theme/ folder in the project, it should be used there. But not both. If the in-project theme defines a parent theme, that should be loaded before the in-project theme.\nSo we should probably decide (and document) how it goes when you have this situation that the theme is present both in-project and inside a .jar.", "author": "pleku", "createdAt": "2020-11-16T13:20:39Z", "path": "flow-server/src/main/resources/plugins/application-theme-plugin/application-theme-plugin.js", "diffHunk": "@@ -51,17 +49,30 @@ class ApplicationThemePlugin {\n     logger = compiler.getInfrastructureLogger(\"ApplicationThemePlugin\");\n \n     compiler.hooks.afterEnvironment.tap(\"ApplicationThemePlugin\", () => {\n-      if (fs.existsSync(this.options.themeJarFolder)) {\n-        logger.debug(\"Found themeFolder in jar file \", this.options.themeJarFolder);\n-        handleThemes(this.options.themeJarFolder, this.options.projectStaticAssetsOutputFolder);\n-      }\n+      const generatedThemeFile = path.resolve(this.options.themeResourceFolder, \"theme-generated.js\");\n+      if (fs.existsSync(generatedThemeFile)) {\n+\n+        // read theme name from the theme-generated.js as there we always mark the used theme for webpack to handle.\n+        const nameRegex = /theme\\/(.*)\\/\\1.js/g; // matches theme folder name in 'theme/my-theme/my-theme.js'\n+        const themeName = nameRegex.exec(fs.readFileSync(generatedThemeFile, {encoding: 'utf8'}))[1];\n+        if (!themeName) {\n+          throw new Error(\"Couldn't parse theme name from '\" + generatedThemeFile + \"'.\");\n+        }\n \n-      this.options.themeProjectFolders.forEach((themeProjectFolder) => {\n-        if (fs.existsSync(themeProjectFolder)) {\n-          logger.debug(\"Found themeFolder from \", themeProjectFolder);\n-          handleThemes(themeProjectFolder, this.options.projectStaticAssetsOutputFolder);\n+        if (fs.existsSync(this.options.themeResourceFolder)) {\n+          logger.debug(\"Found themeFolder in jar file \", this.options.themeResourceFolder);\n+          handleThemes(themeName, this.options.themeResourceFolder, this.options.projectStaticAssetsOutputFolder);\n         }\n-      });\n+", "originalCommit": "a5a3f0705909681229f63d36e16c6ce672930a47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI2ODk2MA==", "url": "https://github.com/vaadin/flow/pull/9406#discussion_r524268960", "bodyText": "Probably throwing and instructing the in-project theme to use the parent theme inside theme.json is the thing to do.\nIn context of this ticket, maybe it would be fine to just first check the in-project location and if it is not there, then the .jar. Or even now the .jar could be commented out until we re-enable it with parent theme support ...", "author": "pleku", "createdAt": "2020-11-16T13:32:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI2MTkwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTAxMjk5Nw==", "url": "https://github.com/vaadin/flow/pull/9406#discussion_r525012997", "bodyText": "Only handling frontend theme and trowing if found also from \"jar\"", "author": "caalador", "createdAt": "2020-11-17T09:38:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI2MTkwOQ=="}], "type": "inlineReview"}, {"oid": "3830fd5de55fdd889f589e543438e4e554f7b460", "url": "https://github.com/vaadin/flow/commit/3830fd5de55fdd889f589e543438e4e554f7b460", "message": "Stricter handling on theme duplicates", "committedDate": "2020-11-17T09:55:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTA2OTY4Nw==", "url": "https://github.com/vaadin/flow/pull/9406#discussion_r525069687", "bodyText": "\"If extending the jar theme the 'parent' theme feature should be used\")\n\nI'm not sure if this is enough for anyone who doesn't know about the it already. Maybe\n\"Extending another theme is possible by adding { \"parent\": \"my-parent-theme\" }  entry to the theme.json file inside your theme's folder.\" would be explicit", "author": "pleku", "createdAt": "2020-11-17T11:05:41Z", "path": "flow-server/src/main/resources/plugins/application-theme-plugin/application-theme-plugin.js", "diffHunk": "@@ -53,25 +56,39 @@ class ApplicationThemePlugin {\n       if (fs.existsSync(generatedThemeFile)) {\n \n         // read theme name from the theme-generated.js as there we always mark the used theme for webpack to handle.\n-        const nameRegex = /theme\\/(.*)\\/\\1.js/g; // matches theme folder name in 'theme/my-theme/my-theme.js'\n         const themeName = nameRegex.exec(fs.readFileSync(generatedThemeFile, {encoding: 'utf8'}))[1];\n         if (!themeName) {\n           throw new Error(\"Couldn't parse theme name from '\" + generatedThemeFile + \"'.\");\n         }\n \n-        if (fs.existsSync(this.options.themeResourceFolder)) {\n-          logger.debug(\"Found themeFolder in jar file \", this.options.themeResourceFolder);\n-          handleThemes(themeName, this.options.themeResourceFolder, this.options.projectStaticAssetsOutputFolder);\n+        let themeFound = false;\n+        for (let i = 0; i<this.options.themeProjectFolders.length; i++) {\n+          const themeProjectFolder = this.options.themeProjectFolders[i];\n+          if (fs.existsSync(themeProjectFolder)) {\n+            logger.info(\"Searching theme folder \", themeProjectFolder, \" for theme \", themeName);\n+            const handled = handleThemes(themeName, themeProjectFolder, this.options.projectStaticAssetsOutputFolder);\n+            if (handled) {\n+              if(themeFound) {\n+                throw new Error(\"Found theme filed in '\" + themeProjectFolder + \"' and '\"\n+                  + themeFound + \"'. Theme should only be available in one folder\");\n+              }\n+              logger.info(\"Found theme files from '\", themeProjectFolder, \"'\");\n+              themeFound = themeProjectFolder;\n+            }\n+          }\n         }\n \n-        this.options.themeProjectFolders.forEach((themeProjectFolder) => {\n-          if (fs.existsSync(themeProjectFolder)) {\n-            logger.debug(\"Found themeFolder from \", themeProjectFolder);\n-            handleThemes(themeName, themeProjectFolder, this.options.projectStaticAssetsOutputFolder);\n+        if (fs.existsSync(this.options.themeResourceFolder)) {\n+          if (themeFound && fs.existsSync(path.resolve(this.options.themeResourceFolder, themeName))) {\n+            throw new Error(\"Theme '\" + themeName + \"'should not exist inside a jar and in the project at the same time\\n\" +\n+              \"If extending the jar theme the 'parent' theme feature should be used\");", "originalCommit": "3830fd5de55fdd889f589e543438e4e554f7b460", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTA3NTIyNw==", "url": "https://github.com/vaadin/flow/pull/9406#discussion_r525075227", "bodyText": "\ud83d\udc4d", "author": "caalador", "createdAt": "2020-11-17T11:15:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTA2OTY4Nw=="}], "type": "inlineReview"}, {"oid": "a5f958e1ba622a1a27d8c2f6d65f318d0caf1716", "url": "https://github.com/vaadin/flow/commit/a5f958e1ba622a1a27d8c2f6d65f318d0caf1716", "message": "Update error text", "committedDate": "2020-11-17T11:14:44Z", "type": "commit"}]}