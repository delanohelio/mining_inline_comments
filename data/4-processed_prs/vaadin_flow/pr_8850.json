{"pr_number": 8850, "pr_title": "Backend is requested for pages that don't exist", "pr_createdAt": "2020-08-14T08:17:49Z", "pr_url": "https://github.com/vaadin/flow/pull/8850", "timeline": [{"oid": "0520b2f5122f106b3b412b4d2f0301406b02b907", "url": "https://github.com/vaadin/flow/commit/0520b2f5122f106b3b412b4d2f0301406b02b907", "message": "Backend is requested for pages that don't exist", "committedDate": "2020-08-14T10:03:33Z", "type": "commit"}, {"oid": "0520b2f5122f106b3b412b4d2f0301406b02b907", "url": "https://github.com/vaadin/flow/commit/0520b2f5122f106b3b412b4d2f0301406b02b907", "message": "Backend is requested for pages that don't exist", "committedDate": "2020-08-14T10:03:33Z", "type": "forcePushed"}, {"oid": "0d659820c1f5ab098ae9f160cfce42e499db04d3", "url": "https://github.com/vaadin/flow/commit/0d659820c1f5ab098ae9f160cfce42e499db04d3", "message": "Useless assignment to local variable 'stream' removed", "committedDate": "2020-08-14T12:26:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI1OTk2OA==", "url": "https://github.com/vaadin/flow/pull/8850#discussion_r471259968", "bodyText": "As everything is returned as a Stream anyway in the end, I started to wonder if there would be a good way to not collect each page into a list to get the size. It seems that the only (?) way to do that without a terminal operation for a stream would be to use a builder, atomic boolean and a consumer. While this is a bit on the \"premature optimization\" side of things, at least we could avoid the collection this way.\nBuilder<T> builder = Stream.builder();\nAtomicBoolean pageHasItems= new AtomicBoolean(true);\nConsumer<T> consumer = item -> {\n    builder.add(item);\n    pageHasItems.set(true);\n}\nfor (int page = 0; page < pages && pageHasItems.getAndSet(false); page++) {\n  ...\n  getDataProvider().fetch(query).forEach(consumer);\n}\n...\nstream = builder.build();\nWhat do you think? I know it adds a bit complexity but it would avoid collecting items.", "author": "pleku", "createdAt": "2020-08-17T06:39:41Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/DataCommunicator.java", "diffHunk": "@@ -723,20 +725,24 @@ protected Object getFilter() {\n                  * Requested range is split to several pages, and queried from\n                  * backend page by page\n                  */\n+                final Collection<T> fetchedPages = new LinkedList<>();\n                 for (int page = 0; page < pages; page++) {\n                     final int newOffset = offset + page * pageSize;\n                     query = new QueryTrace(newOffset, pageSize, backEndSorting,\n                             inMemorySorting, filter);\n-                    /*\n-                    * TODO: DataProvider is still queried for next pages\n-                    * even when backend returns empty pages/partial page.\n-                    * This should be improved so as to analyze the returned\n-                    * page item count and stop if it's empty/partial.\n-                    * See https://github.com/vaadin/flow/issues/8844\n-                    */\n-                    stream = Stream.concat(stream,\n-                            getDataProvider().fetch(query));\n+                    Stream<T> fetchedPageStream =\n+                            getDataProvider().fetch(query);\n+                    List<T> fetchedPage =\n+                            fetchedPageStream.collect(Collectors.toList());", "originalCommit": "0d659820c1f5ab098ae9f160cfce42e499db04d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM3MDU4OQ==", "url": "https://github.com/vaadin/flow/pull/8850#discussion_r471370589", "bodyText": "Could be fine, but if this is added then I would like to have the whole if in its own method, even if it means returning a holder object as the query is needed for checks at the end.", "author": "caalador", "createdAt": "2020-08-17T09:56:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI1OTk2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ0NTIxMw==", "url": "https://github.com/vaadin/flow/pull/8850#discussion_r471445213", "bodyText": "The drawback of this approach is that the next page will always be requested even if the previous page has partial number of items (returned item count < page size). I'm getting try to rework it so as to get rid of this.", "author": "mshabarov", "createdAt": "2020-08-17T12:30:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI1OTk2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ0Nzg0Nw==", "url": "https://github.com/vaadin/flow/pull/8850#discussion_r471447847", "bodyText": "Yes that is a drawback. If the page request crosses a network boundary then it will be probably a bigger impact than the collecting items. However you can rework my naive approach by using an atomicInteger instead and comparing that to page size.", "author": "pleku", "createdAt": "2020-08-17T12:35:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI1OTk2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ1MTM5Ng==", "url": "https://github.com/vaadin/flow/pull/8850#discussion_r471451396", "bodyText": "Yes, that's exactly I'm gonna do", "author": "mshabarov", "createdAt": "2020-08-17T12:42:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI1OTk2OA=="}], "type": "inlineReview"}, {"oid": "3a832d0ac24d2f4ad62ba0637f3c6a2a18818bff", "url": "https://github.com/vaadin/flow/commit/3a832d0ac24d2f4ad62ba0637f3c6a2a18818bff", "message": "Replace items collecting with a stream building", "committedDate": "2020-08-17T13:12:05Z", "type": "commit"}, {"oid": "029cabba6beedf5065ed916702807b00858f5531", "url": "https://github.com/vaadin/flow/commit/029cabba6beedf5065ed916702807b00858f5531", "message": "Add missed Serializable marker", "committedDate": "2020-08-17T13:42:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTk0Mjc2OA==", "url": "https://github.com/vaadin/flow/pull/8850#discussion_r471942768", "bodyText": "When the query is split to pages we only check that the last query has getLimit/getPageSize and getOffset/getPage called ? It feels weird to me that we have to add this new class here to just check the last query. If we insist on keeping the check, which I suppose might help some users, why shouldn't it be checked consistently for each page query and not just the last one? Or how is the last one so significant - is it enough indication on whether or not the user has called the methods ? If this has been decided on purpose, it is not visible on the code and should be documented so in a comment.\nI would not add this extra class, I would just instead maybe move the checking part to its own method and call it directly here. It seems fine to move the checking before the size verification and parallel stream check even for the other queries (in the method calling this method).", "author": "pleku", "createdAt": "2020-08-18T06:28:19Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/DataCommunicator.java", "diffHunk": "@@ -1116,6 +1101,29 @@ private JsonValue generateJson(T item) {\n         return json;\n     }\n \n+    @SuppressWarnings({ \"rawtypes\", \"unchecked\" })\n+    private PagesFetchResult<T> fetchPages(int pages, int offset) {\n+        QueryTrace query;\n+        final Stream.Builder<T> streamBuilder = Stream.builder();\n+\n+        final AtomicInteger fetchedPerPage = new AtomicInteger(0);\n+        Consumer<T> addItemAndCheckConsumer = item -> {\n+            streamBuilder.add(item);\n+            fetchedPerPage.getAndIncrement();\n+        };\n+        // Keep fetching the pages until we get empty/partial page,\n+        // or run out of pages to request\n+        int page = 0;\n+        do {\n+            final int newOffset = offset + (page++) * pageSize;\n+            query = new QueryTrace(newOffset, pageSize, backEndSorting,\n+                    inMemorySorting, filter);\n+            getDataProvider().fetch(query).forEach(addItemAndCheckConsumer);\n+        } while (page < pages && fetchedPerPage.getAndSet(0) == pageSize);\n+\n+        return new PagesFetchResult<>(streamBuilder.build(), query);", "originalCommit": "029cabba6beedf5065ed916702807b00858f5531", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA4MzU1OQ==", "url": "https://github.com/vaadin/flow/pull/8850#discussion_r472083559", "bodyText": "Oh, yes. I overlooked that. All the queries should be checked, not only the last one. Will fix that.", "author": "mshabarov", "createdAt": "2020-08-18T10:40:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTk0Mjc2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjEwMTA1OQ==", "url": "https://github.com/vaadin/flow/pull/8850#discussion_r472101059", "bodyText": "done", "author": "mshabarov", "createdAt": "2020-08-18T11:16:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTk0Mjc2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTk0Mzg1OA==", "url": "https://github.com/vaadin/flow/pull/8850#discussion_r471943858", "bodyText": "Non-blocking comment while you are making changes: I would not mind having the page++; on its own line in the end of the loop, it is just cleaner that way IMO.", "author": "pleku", "createdAt": "2020-08-18T06:31:08Z", "path": "flow-data/src/main/java/com/vaadin/flow/data/provider/DataCommunicator.java", "diffHunk": "@@ -1116,6 +1101,29 @@ private JsonValue generateJson(T item) {\n         return json;\n     }\n \n+    @SuppressWarnings({ \"rawtypes\", \"unchecked\" })\n+    private PagesFetchResult<T> fetchPages(int pages, int offset) {\n+        QueryTrace query;\n+        final Stream.Builder<T> streamBuilder = Stream.builder();\n+\n+        final AtomicInteger fetchedPerPage = new AtomicInteger(0);\n+        Consumer<T> addItemAndCheckConsumer = item -> {\n+            streamBuilder.add(item);\n+            fetchedPerPage.getAndIncrement();\n+        };\n+        // Keep fetching the pages until we get empty/partial page,\n+        // or run out of pages to request\n+        int page = 0;\n+        do {\n+            final int newOffset = offset + (page++) * pageSize;", "originalCommit": "029cabba6beedf5065ed916702807b00858f5531", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA4Mzc3Mg==", "url": "https://github.com/vaadin/flow/pull/8850#discussion_r472083772", "bodyText": "Agree. Will do", "author": "mshabarov", "createdAt": "2020-08-18T10:40:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTk0Mzg1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjEwMTQxOA==", "url": "https://github.com/vaadin/flow/pull/8850#discussion_r472101418", "bodyText": "done", "author": "mshabarov", "createdAt": "2020-08-18T11:17:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTk0Mzg1OA=="}], "type": "inlineReview"}, {"oid": "26c26920a40e12a47af8624451537b955270dd97", "url": "https://github.com/vaadin/flow/commit/26c26920a40e12a47af8624451537b955270dd97", "message": "Check offset and limit invocation for all queries", "committedDate": "2020-08-18T11:14:53Z", "type": "commit"}, {"oid": "256dabfca90e98218a076b059ed306afd63d26e7", "url": "https://github.com/vaadin/flow/commit/256dabfca90e98218a076b059ed306afd63d26e7", "message": "Remove unused variable", "committedDate": "2020-08-18T12:29:48Z", "type": "commit"}]}