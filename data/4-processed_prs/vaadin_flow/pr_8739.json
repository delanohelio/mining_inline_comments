{"pr_number": 8739, "pr_title": "Store webpack dev server port in tempfile named from JVM unique constant and project folder", "pr_createdAt": "2020-07-20T09:27:35Z", "pr_url": "https://github.com/vaadin/flow/pull/8739", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM1NDUzMQ==", "url": "https://github.com/vaadin/flow/pull/8739#discussion_r457354531", "bodyText": "I think I don't understand the reason of the issue.\nDoes JVM exit ?\nThe current (before the patch) state of code assumes that the port file is 1:1 JVM.\nIf JVM has exited then I don't understand how this code allows to get the same file name in new JVM.\nIf JVM has not terminated then why there is a need to modify the code ?\nIn the second case if JVM has terminated watchdog should terminate the webpack dev server as well.\nAnd it looks like the fix is done in a wrong place ?....", "author": "denis-anisimov", "createdAt": "2020-07-20T12:51:58Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/DevModeHandler.java", "diffHunk": "@@ -464,7 +468,7 @@ public String getFailedOutput() {\n      * Remove the running port from the vaadinContext and temporary file.\n      */\n     public void removeRunningDevServerPort() {\n-        FileUtils.deleteQuietly(LazyDevServerPortFileInit.DEV_SERVER_PORT_FILE);", "originalCommit": "2ab807c4b75d054f60cd9eab95fcb3dc62126d93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY1NDk3MQ==", "url": "https://github.com/vaadin/flow/pull/8739#discussion_r457654971", "bodyText": "The JVM doesn't terminate when Jetty restarts from monitored class modification and scanInterval. However, app context is reloaded and all static initializers are rerun, which results in the handle to the port file being lost. This in turns means that DevModeHandler can't connect to the existing Webpack dev server, and spawns another one unnecessarily. The interleaved output from multiple concurrently running dev servers, which includes ANSI sequences, causes terminal problems.\nPort file isn't necessarily 1:1 with JVM since it is possible (but maybe not common) to run multiple applications in dev mode simultaneously under the same JVM. Each app will have its own Webpack dev server. AFAIK has of thread group + full file path to frontend build directory ought to be unique for each deployed app and for each new start of the app in another JVM.", "author": "joheriks", "createdAt": "2020-07-20T19:54:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM1NDUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgzOTA5NQ==", "url": "https://github.com/vaadin/flow/pull/8739#discussion_r457839095", "bodyText": "Hmmm.....\nLazyDevServerPortFileInit.DEV_SERVER_PORT_FILE  can't be lost since JVM is not terminated.\nIt doesn't matter whether initializers are rerun or not. Class is loaded once and should be there since JVM is alive.\nThe only thing which I missed is: the app is loaded via another classloader after Jetty restart even though JVM is not\nterminiated.\nThat's why static initializers are rerun: they are not rerun in fact. Classes are loaded by another classloader so that previous initializers initialized differerent classes (in a different scope).\nNow I see my mistake.", "author": "denis-anisimov", "createdAt": "2020-07-21T05:07:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM1NDUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgzOTUzMg==", "url": "https://github.com/vaadin/flow/pull/8739#discussion_r457839532", "bodyText": "Hmmm.....\nLazyDevServerPortFileInit.DEV_SERVER_PORT_FILE can't be lost since JVM is not terminated.\nIt doesn't matter whether initializers are rerun or not. Class is loaded once and should be there since JVM is alive.\nThe only thing which I missed is: the app is loaded via another classloader after Jetty restart even though JVM is not\nterminiated.\nThat's why static initializers are rerun: they are not rerun in fact. Classes are loaded by another classloader so that previous initializers initialized differerent classes (in a different scope).\nNow I see my mistake.", "author": "denis-anisimov", "createdAt": "2020-07-21T05:09:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM1NDUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgzOTg2MA==", "url": "https://github.com/vaadin/flow/pull/8739#discussion_r457839860", "bodyText": "Alright, now I understand the reason by I don't understand the solution.....\nBut that should be a comment in another place.", "author": "denis-anisimov", "createdAt": "2020-07-21T05:10:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM1NDUzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg0MDA2Nw==", "url": "https://github.com/vaadin/flow/pull/8739#discussion_r457840067", "bodyText": "What I don't understand here: why the thread group will be the same after restart ?\nWhich way it's forced ?", "author": "denis-anisimov", "createdAt": "2020-07-21T05:10:59Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/DevModeHandler.java", "diffHunk": "@@ -742,18 +745,21 @@ void join() {\n         devServerStartFuture.join();\n     }\n \n-    private static final class LazyDevServerPortFileInit {\n-\n-        private static final File DEV_SERVER_PORT_FILE = createDevServerPortFile();\n-\n-        private static File createDevServerPortFile() {\n-            try {\n-                return File.createTempFile(\"flow-dev-server\", \"port\");\n-            } catch (IOException exception) {\n-                throw new UncheckedIOException(exception);\n-            }\n-        }\n \n+    private static File getDevServerPortFile(File npmFolder) {\n+        // The thread group is the same in each servlet-container restart\n+        String threadGroup = String\n+                .valueOf(Thread.currentThread().getThreadGroup().hashCode());", "originalCommit": "2ab807c4b75d054f60cd9eab95fcb3dc62126d93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg5OTA5OQ==", "url": "https://github.com/vaadin/flow/pull/8739#discussion_r457899099", "bodyText": "That the thread group hash code stays the when Jetty reloads I have only empirically verified, other suggestions welcome. The string used needs to satisfy the following:\n\nChange when the JVM is restarted\nRemain the same when Jetty reloads and the JVM is not restarted", "author": "joheriks", "createdAt": "2020-07-21T07:40:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg0MDA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzk5MjcyNQ==", "url": "https://github.com/vaadin/flow/pull/8739#discussion_r457992725", "bodyText": "Thread group hash may stay the same when JVM restarts.\nSo it fixes the issue (even though there is no proof) but it doesn't fit to your requirements.\nWhen I run simple Main java class all threads have the same hash on every restart.", "author": "denis-anisimov", "createdAt": "2020-07-21T10:21:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg0MDA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzk5NDE5MQ==", "url": "https://github.com/vaadin/flow/pull/8739#discussion_r457994191", "bodyText": "Original code contained a JVM id : 2bc0128#diff-023ed25c83cd7d7abab003a4d2ff7607\nBut ManagementFactory.getRuntimeMXBean().getName() takes 5 seconds and totally block any execution (executing it in a separate thread doesn't help). So it's extremely bad idea to use this code.", "author": "denis-anisimov", "createdAt": "2020-07-21T10:24:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg0MDA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI0MTk0Mg==", "url": "https://github.com/vaadin/flow/pull/8739#discussion_r459241942", "bodyText": "Now creates a new UUID and stores in a special system property (vaadin.frontend.webpack.portfile.uuid), which should a satisfy the above two criteria.", "author": "joheriks", "createdAt": "2020-07-23T06:39:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg0MDA2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg2MTIxNg==", "url": "https://github.com/vaadin/flow/pull/8739#discussion_r457861216", "bodyText": "What do you think about using File.createTempFile instead? (https://docs.oracle.com/javase/8/docs/api/java/io/File.html#createTempFile-java.lang.String-java.lang.String-)", "author": "knoobie", "createdAt": "2020-07-21T06:17:23Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/DevModeHandler.java", "diffHunk": "@@ -742,18 +745,21 @@ void join() {\n         devServerStartFuture.join();\n     }\n \n-    private static final class LazyDevServerPortFileInit {\n-\n-        private static final File DEV_SERVER_PORT_FILE = createDevServerPortFile();\n-\n-        private static File createDevServerPortFile() {\n-            try {\n-                return File.createTempFile(\"flow-dev-server\", \"port\");\n-            } catch (IOException exception) {\n-                throw new UncheckedIOException(exception);\n-            }\n-        }\n \n+    private static File getDevServerPortFile(File npmFolder) {\n+        // The thread group is the same in each servlet-container restart\n+        String threadGroup = String\n+                .valueOf(Thread.currentThread().getThreadGroup().hashCode());\n+        String frontendBuildPath = npmFolder.getAbsolutePath();\n+\n+        // #8723: keep webpack alive when Jetty restarts.\n+        // Thread group ID prevents the port file from being picked up after JVM\n+        // restart. Frontend path ensures uniqueness when multiple devmode apps\n+        // are deployed.\n+        String uniqueUid = UUID\n+                .nameUUIDFromBytes((threadGroup + frontendBuildPath)\n+                        .getBytes(StandardCharsets.UTF_8))\n+                .toString();\n+        return new File(System.getProperty(\"java.io.tmpdir\"), uniqueUid);", "originalCommit": "2ab807c4b75d054f60cd9eab95fcb3dc62126d93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg5MzU3NQ==", "url": "https://github.com/vaadin/flow/pull/8739#discussion_r457893575", "bodyText": "File::createTempFile creates a new empty temporary file with a unique name. After Jetty reload there's no way to get the same file name again, to read the port number from.  I believe File::createTempFile works like this by design so that temporary files are guaranteed to never clash. In this case we actually need a predictable temporary file name that remains the same throughout Jetty reload.", "author": "joheriks", "createdAt": "2020-07-21T07:30:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg2MTIxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg5Njc3Mg==", "url": "https://github.com/vaadin/flow/pull/8739#discussion_r457896772", "bodyText": "You are right! I was thinking about the following:\n\nusing File::createTempFile with a unique prefix vaadin-webpack-lock and a suffix portnumber\nthis would allow on server start to search in the temp directory for files starting with vaadin-webpack-lock and identifying the portnumberit used last time\n\nDrawback: This would create a huge problem with running multiple vaadin instances locally at the same time. :(", "author": "knoobie", "createdAt": "2020-07-21T07:36:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg2MTIxNg=="}], "type": "inlineReview"}, {"oid": "6a9ddc400f3949caf4cf4b70d85150157a1ff57c", "url": "https://github.com/vaadin/flow/commit/6a9ddc400f3949caf4cf4b70d85150157a1ff57c", "message": "Store webpack dev server in tempfile named from threadgroup and frontend folder", "committedDate": "2020-07-21T14:12:24Z", "type": "commit"}, {"oid": "6825f136b40adb42604483ccc8cb1e3f239307a9", "url": "https://github.com/vaadin/flow/commit/6825f136b40adb42604483ccc8cb1e3f239307a9", "message": "Fixed failing test", "committedDate": "2020-07-21T14:12:24Z", "type": "commit"}, {"oid": "0aec4c0861feef9d2b1797ac7ea9f8647fd8b3b3", "url": "https://github.com/vaadin/flow/commit/0aec4c0861feef9d2b1797ac7ea9f8647fd8b3b3", "message": "IT module that verifies webpack reuse", "committedDate": "2020-07-21T14:12:24Z", "type": "commit"}, {"oid": "5c598c273dba007aaa8956735e8aa98835158fae", "url": "https://github.com/vaadin/flow/commit/5c598c273dba007aaa8956735e8aa98835158fae", "message": "Use UUID in system property to distinguish JVM runtimes", "committedDate": "2020-07-21T14:12:24Z", "type": "commit"}, {"oid": "5c598c273dba007aaa8956735e8aa98835158fae", "url": "https://github.com/vaadin/flow/commit/5c598c273dba007aaa8956735e8aa98835158fae", "message": "Use UUID in system property to distinguish JVM runtimes", "committedDate": "2020-07-21T14:12:24Z", "type": "forcePushed"}, {"oid": "83c4d407940266fa34a1c5c7570f491dc3be34ef", "url": "https://github.com/vaadin/flow/commit/83c4d407940266fa34a1c5c7570f491dc3be34ef", "message": "Debugging aids", "committedDate": "2020-07-21T17:43:38Z", "type": "forcePushed"}, {"oid": "87c0f927ce645154172c49058dc35c95030addb5", "url": "https://github.com/vaadin/flow/commit/87c0f927ce645154172c49058dc35c95030addb5", "message": "Debugging aids", "committedDate": "2020-07-21T20:02:18Z", "type": "commit"}, {"oid": "f9033f99d53510b7f6ad35654f638b6a7f7d1a6d", "url": "https://github.com/vaadin/flow/commit/f9033f99d53510b7f6ad35654f638b6a7f7d1a6d", "message": "Set reuseDevServer property explicity", "committedDate": "2020-07-21T20:02:52Z", "type": "commit"}, {"oid": "f9033f99d53510b7f6ad35654f638b6a7f7d1a6d", "url": "https://github.com/vaadin/flow/commit/f9033f99d53510b7f6ad35654f638b6a7f7d1a6d", "message": "Set reuseDevServer property explicity", "committedDate": "2020-07-21T20:02:52Z", "type": "forcePushed"}, {"oid": "40a0aa237d13b196feb63a440d886a74419be1bd", "url": "https://github.com/vaadin/flow/commit/40a0aa237d13b196feb63a440d886a74419be1bd", "message": "More log", "committedDate": "2020-07-22T08:34:09Z", "type": "commit"}, {"oid": "40a0aa237d13b196feb63a440d886a74419be1bd", "url": "https://github.com/vaadin/flow/commit/40a0aa237d13b196feb63a440d886a74419be1bd", "message": "More log", "committedDate": "2020-07-22T08:34:09Z", "type": "forcePushed"}, {"oid": "3198a8b406dd0af0bd523a0f82726b752c6114f5", "url": "https://github.com/vaadin/flow/commit/3198a8b406dd0af0bd523a0f82726b752c6114f5", "message": "Force system property override", "committedDate": "2020-07-22T09:59:49Z", "type": "commit"}, {"oid": "3198a8b406dd0af0bd523a0f82726b752c6114f5", "url": "https://github.com/vaadin/flow/commit/3198a8b406dd0af0bd523a0f82726b752c6114f5", "message": "Force system property override", "committedDate": "2020-07-22T09:59:49Z", "type": "forcePushed"}, {"oid": "b47e8c0939bde4822212087bd380eae03792ed8b", "url": "https://github.com/vaadin/flow/commit/b47e8c0939bde4822212087bd380eae03792ed8b", "message": "Revert \"More log\"\n\nThis reverts commit 40a0aa237d13b196feb63a440d886a74419be1bd.", "committedDate": "2020-07-22T10:11:36Z", "type": "commit"}, {"oid": "df31a69e2ae93646f972ffda7460cf803b23ce36", "url": "https://github.com/vaadin/flow/commit/df31a69e2ae93646f972ffda7460cf803b23ce36", "message": "Revert \"Debugging aids\"\n\nThis reverts commit 87c0f927ce645154172c49058dc35c95030addb5.", "committedDate": "2020-07-22T10:11:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTIwODE5OQ==", "url": "https://github.com/vaadin/flow/pull/8739#discussion_r459208199", "bodyText": "Minor : please avoid one letter variable .\nFix only if there are other things to fix as well...", "author": "denis-anisimov", "createdAt": "2020-07-23T04:27:08Z", "path": "flow-tests/test-jetty-reload/src/main/java/com/vaadin/flow/uitest/ui/WebpackDevServerPortView.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Copyright 2000-2020 Vaadin Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package com.vaadin.flow.uitest.ui;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.util.UUID;\n+\n+import com.vaadin.flow.component.html.Div;\n+import com.vaadin.flow.component.html.NativeButton;\n+import com.vaadin.flow.component.html.Span;\n+import com.vaadin.flow.router.Route;\n+import com.vaadin.flow.server.DevModeHandler;\n+import com.vaadin.flow.uitest.servlet.ViewTestLayout;\n+\n+@Route(value = \"com.vaadin.flow.uitest.ui.WebpackDevServerPortView\", layout = ViewTestLayout.class)\n+public class WebpackDevServerPortView extends Div {\n+\n+    public static final String UUID_ID = \"uuid\";\n+    public static final String WEBPACK_PORT_ID = \"webpackPortId\";\n+    public static final String TRIGGER_RELOAD_ID = \"triggerReload\";\n+\n+    private static final UUID uuid = UUID.randomUUID();\n+\n+    public WebpackDevServerPortView() {\n+        // Add a unique number to identify reload\n+        Span unique = new Span(String.valueOf(uuid));\n+        unique.setId(UUID_ID);\n+        add(unique);\n+\n+        DevModeHandler handler = DevModeHandler.getDevModeHandler();\n+        Span portSpan = new Span(String.valueOf(handler.getPort()));\n+        portSpan.setId(WEBPACK_PORT_ID);\n+        add(portSpan);\n+\n+        final NativeButton triggerButton = new NativeButton(\"Trigger reload\",\n+                e -> {", "originalCommit": "df31a69e2ae93646f972ffda7460cf803b23ce36", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI0MDk3Mw==", "url": "https://github.com/vaadin/flow/pull/8739#discussion_r459240973", "bodyText": "Done", "author": "joheriks", "createdAt": "2020-07-23T06:36:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTIwODE5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTIwODI4NA==", "url": "https://github.com/vaadin/flow/pull/8739#discussion_r459208284", "bodyText": "Any reason to have it ?", "author": "denis-anisimov", "createdAt": "2020-07-23T04:27:37Z", "path": "flow-tests/test-jetty-reload/src/test/java/com/vaadin/flow/uitest/ui/WebpackDevServerPortIT.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Copyright 2000-2020 Vaadin Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package com.vaadin.flow.uitest.ui;\n+\n+import net.jcip.annotations.NotThreadSafe;\n+import org.apache.commons.lang3.math.NumberUtils;\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.openqa.selenium.By;\n+import org.openqa.selenium.TimeoutException;\n+\n+import com.vaadin.flow.testutil.ChromeBrowserTest;\n+\n+@NotThreadSafe", "originalCommit": "df31a69e2ae93646f972ffda7460cf803b23ce36", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI0MDk5OA==", "url": "https://github.com/vaadin/flow/pull/8739#discussion_r459240998", "bodyText": "At the moment strictly no, since there is only one test. However, I wanted to save future headaches. This test must be isolated from other as it forces Jetty restart and the annotation is easily forgotten if/when another test method is added to the class.", "author": "joheriks", "createdAt": "2020-07-23T06:36:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTIwODI4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTIwOTgzOQ==", "url": "https://github.com/vaadin/flow/pull/8739#discussion_r459209839", "bodyText": "10 is a magic constant.\nI would perhaps use waitUntil with some hardcoded big timeout.\nwaitUntil is effectively doing the same: run the condition until it becomes true over and over again.\nSo you may just put getDriver().navigate().refresh(); and return !initialUUID.equals( findElement(By.id(WebpackDevServerPortView.UUID_ID)) .getText() as the expected condition impl.\nAlso add a second parameter as a timeout.\nThat will allow to avoid: magic 10 constant, cycle, reconnected flag, catch an exception.", "author": "denis-anisimov", "createdAt": "2020-07-23T04:35:34Z", "path": "flow-tests/test-jetty-reload/src/test/java/com/vaadin/flow/uitest/ui/WebpackDevServerPortIT.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Copyright 2000-2020 Vaadin Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package com.vaadin.flow.uitest.ui;\n+\n+import net.jcip.annotations.NotThreadSafe;\n+import org.apache.commons.lang3.math.NumberUtils;\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.openqa.selenium.By;\n+import org.openqa.selenium.TimeoutException;\n+\n+import com.vaadin.flow.testutil.ChromeBrowserTest;\n+\n+@NotThreadSafe\n+public class WebpackDevServerPortIT extends ChromeBrowserTest {\n+\n+    @Test\n+    public void webpackDevServerPortShouldBeReusedOnReload() {\n+        open();\n+\n+        String initialUUID = findElement(\n+                By.id(WebpackDevServerPortView.UUID_ID)).getText();\n+        Assert.assertEquals(36, initialUUID.length());\n+\n+        String initialPort = findElement(\n+                By.id(WebpackDevServerPortView.WEBPACK_PORT_ID)).getText();\n+        Assert.assertTrue(NumberUtils.isDigits(initialPort));\n+\n+        // trigger jetty reload\n+        findElement(By.id(WebpackDevServerPortView.TRIGGER_RELOAD_ID)).click();\n+\n+        // keep refreshing until page comes back (the UUID has changed)\n+        boolean reconnected = false;\n+        for (int i = 0; i < 10; i++) {", "originalCommit": "df31a69e2ae93646f972ffda7460cf803b23ce36", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI0MTAxNA==", "url": "https://github.com/vaadin/flow/pull/8739#discussion_r459241014", "bodyText": "waitUntil checks the condition repeatedly but it doesn't refresh the page. So a single waitUntil would need to rely on client side JS repeatedly trying to refresh the page when the connection to the first Jetty is lost (heartbeat missed or session timeout). This is not reliable.\n(Maybe it would work to call driver.navigate().refresh() inside the waitUntil but having a side effect there would be uglier in my opinion).", "author": "joheriks", "createdAt": "2020-07-23T06:36:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTIwOTgzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI3MjE0NQ==", "url": "https://github.com/vaadin/flow/pull/8739#discussion_r459272145", "bodyText": "Well, using driver.navigate().refresh() inside waitUntil  looks OK for me but I understand your concern about side effect.\nWhat I still don't like : magic 10 number.\nCould you make it work as a timeout : define a hardcoded timeout and replace for loop with while which checks that the current time of execution is less than the initial time + timeout value.\nAlso would be really good to avoid TimeoutException  : since your are almost duplicating the waitUntil functionality I would just avoid waitUntil at all.\nBut this is optional.", "author": "denis-anisimov", "createdAt": "2020-07-23T07:51:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTIwOTgzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI3MzUxNg==", "url": "https://github.com/vaadin/flow/pull/8739#discussion_r459273516", "bodyText": "", "author": "denis-anisimov", "createdAt": "2020-07-23T07:54:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTIwOTgzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI5MTA4NQ==", "url": "https://github.com/vaadin/flow/pull/8739#discussion_r459291085", "bodyText": "Done", "author": "joheriks", "createdAt": "2020-07-23T08:28:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTIwOTgzOQ=="}], "type": "inlineReview"}, {"oid": "711692c76219dde71dae592caf769b1d5c62d889", "url": "https://github.com/vaadin/flow/commit/711692c76219dde71dae592caf769b1d5c62d889", "message": "Renamed variable", "committedDate": "2020-07-23T06:36:49Z", "type": "commit"}, {"oid": "83811f491944621205e477406334b81ff133dd0e", "url": "https://github.com/vaadin/flow/commit/83811f491944621205e477406334b81ff133dd0e", "message": "Simplified wait loop for Jetty reload", "committedDate": "2020-07-23T08:27:59Z", "type": "commit"}]}