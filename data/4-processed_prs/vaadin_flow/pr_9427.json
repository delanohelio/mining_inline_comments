{"pr_number": 9427, "pr_title": "feat: TypeScript API for connection indicator configuration", "pr_createdAt": "2020-11-17T15:42:58Z", "pr_url": "https://github.com/vaadin/flow/pull/9427", "timeline": [{"oid": "bed16d14188ca3fe90f648f41a05290805381d05", "url": "https://github.com/vaadin/flow/commit/bed16d14188ca3fe90f648f41a05290805381d05", "message": "feat: TypeScript API for connection indicator configuration", "committedDate": "2020-11-17T15:45:16Z", "type": "forcePushed"}, {"oid": "4a05c90f411b96c5c2ef227d11b81b0729c6f0e9", "url": "https://github.com/vaadin/flow/commit/4a05c90f411b96c5c2ef227d11b81b0729c6f0e9", "message": "feat(offline): add connection indicator element", "committedDate": "2020-11-17T16:59:58Z", "type": "commit"}, {"oid": "2f02523f7c51de0ce56e36474505a5357044ead3", "url": "https://github.com/vaadin/flow/commit/2f02523f7c51de0ce56e36474505a5357044ead3", "message": "use ConnectionStateStore in connection indicator element", "committedDate": "2020-11-17T17:13:37Z", "type": "commit"}, {"oid": "974f09ca388ba2eccd82fa75c4ac6b71b9442bd1", "url": "https://github.com/vaadin/flow/commit/974f09ca388ba2eccd82fa75c4ac6b71b9442bd1", "message": "combine separate loading boolean states into LoadingBarState enum", "committedDate": "2020-11-17T17:13:43Z", "type": "commit"}, {"oid": "43d971cc6445356772668bfddf48c995dd8aaef0", "url": "https://github.com/vaadin/flow/commit/43d971cc6445356772668bfddf48c995dd8aaef0", "message": "fix linter errors", "committedDate": "2020-11-17T17:23:03Z", "type": "commit"}, {"oid": "b586e0eca18b438ebcb60bc8d243d778a71e614c", "url": "https://github.com/vaadin/flow/commit/b586e0eca18b438ebcb60bc8d243d778a71e614c", "message": "render connection indicator style under head", "committedDate": "2020-11-17T18:23:08Z", "type": "commit"}, {"oid": "f8ee252316cdfee93bceb2f345c40f877766c7c8", "url": "https://github.com/vaadin/flow/commit/f8ee252316cdfee93bceb2f345c40f877766c7c8", "message": "fix document.head contents removed by accident", "committedDate": "2020-11-18T11:02:16Z", "type": "commit"}, {"oid": "fa9c9e72cdae60c9504cf7aa5fc742f898c59cc2", "url": "https://github.com/vaadin/flow/commit/fa9c9e72cdae60c9504cf7aa5fc742f898c59cc2", "message": "reflect reconnecting attribute", "committedDate": "2020-11-18T11:11:40Z", "type": "commit"}, {"oid": "16a7eed3ed2f0464baa2a5b5babc2db97d0af338", "url": "https://github.com/vaadin/flow/commit/16a7eed3ed2f0464baa2a5b5babc2db97d0af338", "message": "remove obsolete LoadingIndicator.ts", "committedDate": "2020-11-18T12:43:07Z", "type": "commit"}, {"oid": "793a3ffb7de0aefa0acef5a09809bfc00a8c1647", "url": "https://github.com/vaadin/flow/commit/793a3ffb7de0aefa0acef5a09809bfc00a8c1647", "message": "rename Vaadin.loadingIndicator to .connectionIndicator", "committedDate": "2020-11-18T13:31:38Z", "type": "commit"}, {"oid": "b30af65e9ac09e5c2a177e351406d952249c9d07", "url": "https://github.com/vaadin/flow/commit/b30af65e9ac09e5c2a177e351406d952249c9d07", "message": "Configuration of additional parameters", "committedDate": "2020-11-18T14:35:01Z", "type": "forcePushed"}, {"oid": "979d10e1cfbf795cffcdabdbac725a93050cf288", "url": "https://github.com/vaadin/flow/commit/979d10e1cfbf795cffcdabdbac725a93050cf288", "message": "fix ConnectionIndicator showing online text for reconnecting", "committedDate": "2020-11-18T15:20:18Z", "type": "commit"}, {"oid": "2a4768da2fad4c9bdf0b819c67a2304b8eeeb489", "url": "https://github.com/vaadin/flow/commit/2a4768da2fad4c9bdf0b819c67a2304b8eeeb489", "message": "fix: only expand connection indicator when after state changes", "committedDate": "2020-11-18T16:24:48Z", "type": "commit"}, {"oid": "4ea6f59931c1f3685f2cb13e2c3bb13a5dbdd970", "url": "https://github.com/vaadin/flow/commit/4ea6f59931c1f3685f2cb13e2c3bb13a5dbdd970", "message": "feat: TypeScript API for connection indicator configuration", "committedDate": "2020-11-18T19:23:19Z", "type": "commit"}, {"oid": "0d5b891d2022d18fd2cd42d4d2e39a6f30ecd869", "url": "https://github.com/vaadin/flow/commit/0d5b891d2022d18fd2cd42d4d2e39a6f30ecd869", "message": "Configuration of additional parameters", "committedDate": "2020-11-18T19:23:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY3Mzg3OQ==", "url": "https://github.com/vaadin/flow/pull/9427#discussion_r526673879", "bodyText": "Maybe it's better to put this at the top of the file", "author": "haijian-vaadin", "createdAt": "2020-11-19T08:26:11Z", "path": "flow-client/src/main/resources/META-INF/resources/frontend/AppShell.ts", "diffHunk": "@@ -0,0 +1,103 @@\n+export interface ConnectionIndicatorConfiguration {\n+  onlineText?: string;\n+  offlineText?: string;\n+  firstDelay?: number;\n+  secondDelay?: number;\n+  thirdDelay?: number;\n+  applyDefaultTheme?: boolean;\n+  reconnectModal?: boolean;\n+  reconnectingText?: string;\n+}\n+\n+const $wnd = window as any;\n+\n+/**\n+ * Configures window.Vaadin.connectionIndicator. If not available globally, schedules a repeating\n+ * task until it becomes available.\n+ *\n+ * @param conf All defined fields are applied to the connection indicator configuration.\n+ * @returns The updated configuration of the connection indicator.\n+ */\n+export async function setConnectionIndicatorConfiguration(conf: ConnectionIndicatorConfiguration):\n+  Promise<ConnectionIndicatorConfiguration> {\n+  return new Promise((resolve, reject) => {\n+    const updateConfiguration = () => {\n+      try {\n+        validateDelay(conf.firstDelay);\n+        validateDelay(conf.secondDelay);\n+        validateDelay(conf.thirdDelay);\n+      } catch (error) {\n+        reject(error);\n+      }\n+      if ($wnd.Vaadin?.connectionIndicator) {\n+        setValidatedConnectionIndicatorConfiguration(conf);\n+        return true;\n+      } else {\n+        return false;\n+      }\n+    };\n+    let attempts = 0;\n+    const interval = setInterval(() => {\n+      if (updateConfiguration()) {\n+        clearInterval(interval);\n+        resolve(getConnectionIndicatorConfiguration());\n+      } else {\n+        attempts += 1;\n+        if (attempts >= 10) {\n+          throw new ConfigurationError('window.Vaadin.connectionIndicator not defined');\n+        }\n+      }\n+    }, 100);\n+  });\n+}\n+\n+/**\n+ * An exception that gets thrown for illegal configuration values.\n+ */\n+export class ConfigurationError extends Error {\n+  /**\n+   * @param message the `message` property value\n+   */\n+  constructor(message: string) {\n+    super(message);\n+  }\n+}\n+\n+function validateDelay(delay?: number) {\n+  if (delay !== undefined && delay! < 0) {\n+    throw new ConfigurationError('delays must be positive');\n+  }\n+}\n+\n+/**\n+ * Concrete values for each ConnectionIndicatorConfiguration to enable reflection over the field names.\n+ */\n+\n+/* tslint:disable: max-classes-per-file */", "originalCommit": "b30af65e9ac09e5c2a177e351406d952249c9d07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjcwNDY5Mg==", "url": "https://github.com/vaadin/flow/pull/9427#discussion_r526704692", "bodyText": "Done.", "author": "joheriks", "createdAt": "2020-11-19T09:16:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY3Mzg3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY3NTI2Mg==", "url": "https://github.com/vaadin/flow/pull/9427#discussion_r526675262", "bodyText": "Could also add Appshell.ts here?", "author": "haijian-vaadin", "createdAt": "2020-11-19T08:28:30Z", "path": "flow-client/src/main/resources/META-INF/resources/frontend/index.ts", "diffHunk": "@@ -2,3 +2,4 @@ export * from './Flow';\n export * from './Connect';\n export * from './Authentication';\n export * from './Offline';\n+export * from './ConnectionIndicator';", "originalCommit": "b30af65e9ac09e5c2a177e351406d952249c9d07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjcwNDc2MA==", "url": "https://github.com/vaadin/flow/pull/9427#discussion_r526704760", "bodyText": "Done.", "author": "joheriks", "createdAt": "2020-11-19T09:16:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY3NTI2Mg=="}], "type": "inlineReview"}, {"oid": "84efcc563f1a74e4b2ed13b3ff7e2ae1b15585d6", "url": "https://github.com/vaadin/flow/commit/84efcc563f1a74e4b2ed13b3ff7e2ae1b15585d6", "message": "Create vaadin-connection-indicator eagerly when configuring", "committedDate": "2020-11-19T09:14:57Z", "type": "commit"}, {"oid": "27799d22ebc709e4cb902a64ce400088c0d24787", "url": "https://github.com/vaadin/flow/commit/27799d22ebc709e4cb902a64ce400088c0d24787", "message": "Add exports", "committedDate": "2020-11-19T09:15:11Z", "type": "commit"}, {"oid": "27799d22ebc709e4cb902a64ce400088c0d24787", "url": "https://github.com/vaadin/flow/commit/27799d22ebc709e4cb902a64ce400088c0d24787", "message": "Add exports", "committedDate": "2020-11-19T09:15:11Z", "type": "forcePushed"}, {"oid": "08a2ac3339337da602dfdd414ddbb179bf719880", "url": "https://github.com/vaadin/flow/commit/08a2ac3339337da602dfdd414ddbb179bf719880", "message": "Doc correction", "committedDate": "2020-11-19T09:17:40Z", "type": "commit"}, {"oid": "11bd03d449a294b838c0d156281873fb63616b98", "url": "https://github.com/vaadin/flow/commit/11bd03d449a294b838c0d156281873fb63616b98", "message": "Connection indicator configuration IT", "committedDate": "2020-11-19T10:58:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjgxNDAyMg==", "url": "https://github.com/vaadin/flow/pull/9427#discussion_r526814022", "bodyText": "Maybe DefaultConnectionIndicatorConfiguration would be better than ConnectionIndicatorConfigurationImpl?", "author": "haijian-vaadin", "createdAt": "2020-11-19T12:02:31Z", "path": "flow-client/src/main/resources/META-INF/resources/frontend/AppShell.ts", "diffHunk": "@@ -0,0 +1,82 @@\n+/* tslint:disable: max-classes-per-file */\n+\n+import {addConnectionIndicator} from \"./ConnectionIndicator\";\n+\n+export interface ConnectionIndicatorConfiguration {\n+  onlineText?: string;\n+  offlineText?: string;\n+  firstDelay?: number;\n+  secondDelay?: number;\n+  thirdDelay?: number;\n+  applyDefaultTheme?: boolean;\n+  reconnectModal?: boolean;\n+  reconnectingText?: string;\n+}\n+\n+const $wnd = window as any;\n+\n+/**\n+ * Configures window.Vaadin.connectionIndicator.\n+ *\n+ * @param conf All defined fields are applied to the connection indicator configuration.\n+ * @returns The updated configuration of the connection indicator.\n+ */\n+export function setConnectionIndicatorConfiguration(conf: ConnectionIndicatorConfiguration):\n+  ConnectionIndicatorConfiguration {\n+  // ensure the connection indicator is in the DOM and accessible via window.Vaadin.connectionIndicator\n+  addConnectionIndicator();\n+  validateDelay(conf.firstDelay);\n+  validateDelay(conf.secondDelay);\n+  validateDelay(conf.thirdDelay);\n+  setValidatedConnectionIndicatorConfiguration(conf);\n+  return getConnectionIndicatorConfiguration();\n+}\n+\n+/**\n+ * An exception that gets thrown for illegal configuration values.\n+ */\n+export class ConfigurationError extends Error {\n+  /**\n+   * @param message the `message` property value\n+   */\n+  constructor(message: string) {\n+    super(message);\n+  }\n+}\n+\n+function validateDelay(delay?: number) {\n+  if (delay !== undefined && delay! < 0) {\n+    throw new ConfigurationError('delays must be positive');\n+  }\n+}\n+\n+/**\n+ * Concrete values for each ConnectionIndicatorConfiguration to enable reflection over the field names.\n+ */\n+class ConnectionIndicatorConfigurationImpl implements ConnectionIndicatorConfiguration {", "originalCommit": "11bd03d449a294b838c0d156281873fb63616b98", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODgyODY1Mg==", "url": "https://github.com/vaadin/flow/pull/9427#discussion_r528828652", "bodyText": "Renamed to ConcreteConnectionIndicatorConfiguration instead (to avoid potential confusion with default configuration values, which are defined in the ConnectionIndicator component).", "author": "joheriks", "createdAt": "2020-11-23T16:19:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjgxNDAyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjgxNDU2Mw==", "url": "https://github.com/vaadin/flow/pull/9427#discussion_r526814563", "bodyText": "Could we have some inline doc for the class and the properties?", "author": "haijian-vaadin", "createdAt": "2020-11-19T12:03:35Z", "path": "flow-client/src/main/resources/META-INF/resources/frontend/AppShell.ts", "diffHunk": "@@ -0,0 +1,82 @@\n+/* tslint:disable: max-classes-per-file */\n+\n+import {addConnectionIndicator} from \"./ConnectionIndicator\";\n+\n+export interface ConnectionIndicatorConfiguration {\n+  onlineText?: string;", "originalCommit": "11bd03d449a294b838c0d156281873fb63616b98", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODgyOTM1OQ==", "url": "https://github.com/vaadin/flow/pull/9427#discussion_r528829359", "bodyText": "Done. However, there is now duplication of properties and documentation here. Maybe we should consider whether we really need this intermediate configuration DTO, or if we instead could consider the ConnectionIndicator the public configuration interface instead.", "author": "joheriks", "createdAt": "2020-11-23T16:20:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjgxNDU2Mw=="}], "type": "inlineReview"}, {"oid": "28d71d198a9bffa6b4e4760264cb98a2a6dfc57a", "url": "https://github.com/vaadin/flow/commit/28d71d198a9bffa6b4e4760264cb98a2a6dfc57a", "message": "Merge branch 'feature/offline-connection-indicator-element' into joheriks/9402-connection-indicator-ts-conf-api\n\n# Conflicts:\n#\tflow-client/src/main/resources/META-INF/resources/frontend/ConnectionIndicator.ts\n#\tflow-client/src/main/resources/META-INF/resources/frontend/Flow.ts\n#\tflow-client/src/main/resources/META-INF/resources/frontend/index.ts", "committedDate": "2020-11-23T15:50:28Z", "type": "commit"}, {"oid": "b7c77cb84f9dee95d1af72a7734967c501bbeb86", "url": "https://github.com/vaadin/flow/commit/b7c77cb84f9dee95d1af72a7734967c501bbeb86", "message": "Documented configuration fields, added expandedDuration, renamed internal class", "committedDate": "2020-11-23T16:17:49Z", "type": "commit"}, {"oid": "8d53d42e20bd242ab3a7f03bacb2833fc7d1e1ae", "url": "https://github.com/vaadin/flow/commit/8d53d42e20bd242ab3a7f03bacb2833fc7d1e1ae", "message": "fix: If flow client not loaded, check server reachability using HEAD request", "committedDate": "2020-11-24T07:36:13Z", "type": "commit"}, {"oid": "56ab2d5887eb6af49f60885145c22193bb98555c", "url": "https://github.com/vaadin/flow/commit/56ab2d5887eb6af49f60885145c22193bb98555c", "message": "chore: unit test for transitions from CONNECTION_LOST to CONNECTED/RECONNECTING", "committedDate": "2020-11-24T08:33:25Z", "type": "commit"}, {"oid": "66b00624163ad14ef19847052b289527e9481e15", "url": "https://github.com/vaadin/flow/commit/66b00624163ad14ef19847052b289527e9481e15", "message": "feat: simplified the connection indicator configuration (removed intermediate DTO)", "committedDate": "2020-11-24T08:40:56Z", "type": "commit"}, {"oid": "b6bb6b2b548838cf47d579c539063fdfbef26127", "url": "https://github.com/vaadin/flow/commit/b6bb6b2b548838cf47d579c539063fdfbef26127", "message": "doc: documented getConnectionIndicator", "committedDate": "2020-11-24T08:51:21Z", "type": "commit"}, {"oid": "8e1b67a3d0532c60008b2f17f98992fe7b2551cd", "url": "https://github.com/vaadin/flow/commit/8e1b67a3d0532c60008b2f17f98992fe7b2551cd", "message": "fix: go to RECONNECTING when receiving \"online\" in CONNECTION_LOST", "committedDate": "2020-11-24T09:06:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTMxODQ4MA==", "url": "https://github.com/vaadin/flow/pull/9427#discussion_r529318480", "bodyText": "indentations missing?", "author": "haijian-vaadin", "createdAt": "2020-11-24T09:07:58Z", "path": "flow-client/src/main/resources/META-INF/resources/frontend/ConnectionIndicator.ts", "diffHunk": "@@ -124,9 +124,9 @@ export class ConnectionIndicator extends LitElement {\n        style=\"${this.getLoadingBarStyle()}\"></div>\n \n       <div class=\"v-status-message ${classMap({\n-        active: this.reconnecting,\n-        modal: this.reconnectModal\n-      })}\">\n+      active: this.reconnecting,", "originalCommit": "b6bb6b2b548838cf47d579c539063fdfbef26127", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTM5MDUxNg==", "url": "https://github.com/vaadin/flow/pull/9427#discussion_r529390516", "bodyText": "Done (apparently this was too difficult for my IDE to auto-indent properly).", "author": "joheriks", "createdAt": "2020-11-24T10:05:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTMxODQ4MA=="}], "type": "inlineReview"}, {"oid": "3957b979d3610b7c1d0ec6c551858c099a7502fd", "url": "https://github.com/vaadin/flow/commit/3957b979d3610b7c1d0ec6c551858c099a7502fd", "message": "chore: indentation fix", "committedDate": "2020-11-24T10:04:27Z", "type": "commit"}, {"oid": "66cf96ef498c3cbe0ca409eb7c18d05b293dd31e", "url": "https://github.com/vaadin/flow/commit/66cf96ef498c3cbe0ca409eb7c18d05b293dd31e", "message": "chore: minor test name correction", "committedDate": "2020-11-24T10:07:34Z", "type": "commit"}]}