{"pr_number": 8810, "pr_title": "#7911 Implement Component.isAttached().", "pr_createdAt": "2020-08-04T08:23:45Z", "pr_url": "https://github.com/vaadin/flow/pull/8810", "timeline": [{"oid": "ec86029e8364cbefa0f4a159800b93d69382a66e", "url": "https://github.com/vaadin/flow/commit/ec86029e8364cbefa0f4a159800b93d69382a66e", "message": "#7911 Implement Component.isAttached(). Closes #7911", "committedDate": "2020-08-04T08:22:44Z", "type": "commit"}, {"oid": "c6782df485051e014a7b3d7dfb20e2c22a0e48c1", "url": "https://github.com/vaadin/flow/commit/c6782df485051e014a7b3d7dfb20e2c22a0e48c1", "message": "#7911 More tests for Component.isAttached()", "committedDate": "2020-08-04T08:26:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDkzNjYyMw==", "url": "https://github.com/vaadin/flow/pull/8810#discussion_r464936623", "bodyText": "Wouldn't it be more logical that the component isn't attached anymore when the UI is closed / removed?", "author": "knoobie", "createdAt": "2020-08-04T09:54:06Z", "path": "flow-server/src/test/java/com/vaadin/flow/component/ComponentTest.java", "diffHunk": "@@ -757,6 +757,51 @@ public void testSecondAttach() {\n         Assert.assertFalse(initialAttach.get());\n     }\n \n+    /**\n+     * Tests {@link Component#isAttached}.\n+     */\n+    @Test\n+    public void testIsAttached() {\n+        UI ui = new UI();\n+        // ui is always attached\n+        Assert.assertTrue(ui.isAttached());\n+\n+        TestComponentContainer parent = new TestComponentContainer();\n+        TestComponentContainer child = new TestComponentContainer();\n+        TestComponent grandChild = new TestComponent();\n+        child.track();\n+        grandChild.addAttachListener(\n+                event -> Assert.assertTrue(grandChild.isAttached()));\n+        grandChild.addDetachListener(\n+                event -> grandChild.getDetachEvents().incrementAndGet());\n+\n+        parent.add(child);\n+        child.add(grandChild);\n+        Assert.assertFalse(parent.isAttached());\n+        Assert.assertFalse(child.isAttached());\n+        Assert.assertFalse(grandChild.isAttached());\n+\n+        ui.add(parent);\n+        Assert.assertTrue(parent.isAttached());\n+        Assert.assertTrue(child.isAttached());\n+        Assert.assertTrue(grandChild.isAttached());\n+\n+        ui.remove(parent);\n+        Assert.assertFalse(parent.isAttached());\n+        Assert.assertFalse(child.isAttached());\n+        Assert.assertFalse(grandChild.isAttached());\n+\n+        ui.add(parent);\n+        Assert.assertTrue(parent.isAttached());\n+        Assert.assertTrue(child.isAttached());\n+        Assert.assertTrue(grandChild.isAttached());\n+\n+        ui.close();\n+        Assert.assertTrue(parent.isAttached());", "originalCommit": "c6782df485051e014a7b3d7dfb20e2c22a0e48c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk0MjI4Ng==", "url": "https://github.com/vaadin/flow/pull/8810#discussion_r464942286", "bodyText": "I agree, that also sounds more intuitive to me; also that's how Vaadin 8 used to work. However, with Vaadin 14 the onDetach()/detach listeners are also not fired when the UI is closed - this tells me that there is a bigger work needed to be done. Could you please open a new bug report in this regard, so that it can be discussed separately?", "author": "mvysny", "createdAt": "2020-08-04T10:04:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDkzNjYyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTAyNzg5OA==", "url": "https://github.com/vaadin/flow/pull/8810#discussion_r465027898", "bodyText": "Done #8812", "author": "knoobie", "createdAt": "2020-08-04T12:54:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDkzNjYyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQ1OTE5Mg==", "url": "https://github.com/vaadin/flow/pull/8810#discussion_r468459192", "bodyText": "ui.close() only marks the ui as closing * Marks this UI to be detached from the session at the end of the current request and the actual cleanup and detach for the UI happens in the VaadinService when the request has been handled.\nSo the actual simulated close would be ui.getInternals().setSession(null); (NOTE that the existing session can not be null in this case)", "author": "caalador", "createdAt": "2020-08-11T09:47:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDkzNjYyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTExODgzMQ==", "url": "https://github.com/vaadin/flow/pull/8810#discussion_r469118831", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    ui.close();\n          \n          \n            \n                    Assert.assertTrue(parent.isAttached());\n          \n          \n            \n                    Assert.assertTrue(child.isAttached());\n          \n          \n            \n                    Assert.assertTrue(grandChild.isAttached());\n          \n          \n            \n                    // Mock closing of UI after request handled\n          \n          \n            \n                    ui.getInternals().setSession(Mockito.mock(VaadinSession.class));\n          \n          \n            \n                    ui.close();\n          \n          \n            \n                    ui.getInternals().setSession(null);\n          \n          \n            \n            \n          \n          \n            \n                    Assert.assertFalse(parent.isAttached());\n          \n          \n            \n                    Assert.assertFalse(child.isAttached());\n          \n          \n            \n                    Assert.assertFalse(grandChild.isAttached());", "author": "caalador", "createdAt": "2020-08-12T09:11:47Z", "path": "flow-server/src/test/java/com/vaadin/flow/component/ComponentTest.java", "diffHunk": "@@ -757,6 +757,51 @@ public void testSecondAttach() {\n         Assert.assertFalse(initialAttach.get());\n     }\n \n+    /**\n+     * Tests {@link Component#isAttached}.\n+     */\n+    @Test\n+    public void testIsAttached() {\n+        UI ui = new UI();\n+        // ui is always attached\n+        Assert.assertTrue(ui.isAttached());\n+\n+        TestComponentContainer parent = new TestComponentContainer();\n+        TestComponentContainer child = new TestComponentContainer();\n+        TestComponent grandChild = new TestComponent();\n+        child.track();\n+        grandChild.addAttachListener(\n+                event -> Assert.assertTrue(grandChild.isAttached()));\n+        grandChild.addDetachListener(\n+                event -> grandChild.getDetachEvents().incrementAndGet());\n+\n+        parent.add(child);\n+        child.add(grandChild);\n+        Assert.assertFalse(parent.isAttached());\n+        Assert.assertFalse(child.isAttached());\n+        Assert.assertFalse(grandChild.isAttached());\n+\n+        ui.add(parent);\n+        Assert.assertTrue(parent.isAttached());\n+        Assert.assertTrue(child.isAttached());\n+        Assert.assertTrue(grandChild.isAttached());\n+\n+        ui.remove(parent);\n+        Assert.assertFalse(parent.isAttached());\n+        Assert.assertFalse(child.isAttached());\n+        Assert.assertFalse(grandChild.isAttached());\n+\n+        ui.add(parent);\n+        Assert.assertTrue(parent.isAttached());\n+        Assert.assertTrue(child.isAttached());\n+        Assert.assertTrue(grandChild.isAttached());\n+\n+        ui.close();\n+        Assert.assertTrue(parent.isAttached());\n+        Assert.assertTrue(child.isAttached());\n+        Assert.assertTrue(grandChild.isAttached());", "originalCommit": "c6782df485051e014a7b3d7dfb20e2c22a0e48c1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTEyMDcwNA==", "url": "https://github.com/vaadin/flow/pull/8810#discussion_r469120704", "bodyText": "This can also be true if the UI has \"detached\" (e.g. closed and removed from the session)", "author": "caalador", "createdAt": "2020-08-12T09:14:56Z", "path": "flow-server/src/main/java/com/vaadin/flow/component/Component.java", "diffHunk": "@@ -451,6 +451,17 @@ protected void onDetach(DetachEvent detachEvent) {\n         // NOOP by default\n     }\n \n+    /**\n+     * Checks whether this component is currently attached to a UI.\n+     * <p>\n+     * Returns true for attached components even if the UI itself is closed.\n+     *\n+     * @return true if the component is attached to an UI.", "originalCommit": "c6782df485051e014a7b3d7dfb20e2c22a0e48c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE0NDg2OA==", "url": "https://github.com/vaadin/flow/pull/8810#discussion_r469144868", "bodyText": "That sounds weird. The attach/detach thing served as a means to lazy-init+destroy a component when it became visible (or active on-screen). With Vaadin 14 the detach may not even be called at all, which just sounds plain wrong.", "author": "mvysny", "createdAt": "2020-08-12T09:55:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTEyMDcwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE1MDEzNw==", "url": "https://github.com/vaadin/flow/pull/8810#discussion_r469150137", "bodyText": "I just tried ui.close() + ui.internals.session=null: the UI including all of its components becomes detached \ud83d\udc4d", "author": "mvysny", "createdAt": "2020-08-12T10:05:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTEyMDcwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTc4NTM1Ng==", "url": "https://github.com/vaadin/flow/pull/8810#discussion_r469785356", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @return true if the component is attached to an UI.\n          \n          \n            \n                 * @return true if the component is attached to an active UI.", "author": "caalador", "createdAt": "2020-08-13T08:30:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTEyMDcwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTEyMjE0NQ==", "url": "https://github.com/vaadin/flow/pull/8810#discussion_r469122145", "bodyText": "UI is always initially attached as it is the root node, but it can be \"detached\" as is the case in the final assert with the fixes mock close of the UI.", "author": "caalador", "createdAt": "2020-08-12T09:17:15Z", "path": "flow-server/src/test/java/com/vaadin/flow/component/ComponentTest.java", "diffHunk": "@@ -757,6 +757,51 @@ public void testSecondAttach() {\n         Assert.assertFalse(initialAttach.get());\n     }\n \n+    /**\n+     * Tests {@link Component#isAttached}.\n+     */\n+    @Test\n+    public void testIsAttached() {\n+        UI ui = new UI();\n+        // ui is always attached", "originalCommit": "c6782df485051e014a7b3d7dfb20e2c22a0e48c1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "069a1a722bbfe74a10abc1cfb157a8d0789345df", "url": "https://github.com/vaadin/flow/commit/069a1a722bbfe74a10abc1cfb157a8d0789345df", "message": "Update flow-server/src/test/java/com/vaadin/flow/component/ComponentTest.java\n\nCo-authored-by: caalador <mikael.grankvist@gmail.com>", "committedDate": "2020-08-12T09:47:47Z", "type": "commit"}, {"oid": "8d2b2e36702435e2501987c764727119ca3c906c", "url": "https://github.com/vaadin/flow/commit/8d2b2e36702435e2501987c764727119ca3c906c", "message": "Fixed ComponentTest", "committedDate": "2020-08-12T09:53:10Z", "type": "commit"}, {"oid": "01ac66b520e0685340bd54f5beaeb9afd3070f93", "url": "https://github.com/vaadin/flow/commit/01ac66b520e0685340bd54f5beaeb9afd3070f93", "message": "Improved javadoc of Component.isAttached()", "committedDate": "2020-08-12T10:09:50Z", "type": "commit"}, {"oid": "d7d90847730d680afb1e84911cb615b1faa3099b", "url": "https://github.com/vaadin/flow/commit/d7d90847730d680afb1e84911cb615b1faa3099b", "message": "Update flow-server/src/main/java/com/vaadin/flow/component/Component.java\n\nCo-authored-by: caalador <mikael.grankvist@gmail.com>", "committedDate": "2020-08-14T05:32:22Z", "type": "commit"}]}