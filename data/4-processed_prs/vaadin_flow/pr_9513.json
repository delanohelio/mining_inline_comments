{"pr_number": 9513, "pr_title": "feat(offline): retry server navigation when back online", "pr_createdAt": "2020-11-26T18:24:10Z", "pr_url": "https://github.com/vaadin/flow/pull/9513", "timeline": [{"oid": "2587aaa44d2d12407c19d5bb65451462e59b6843", "url": "https://github.com/vaadin/flow/commit/2587aaa44d2d12407c19d5bb65451462e59b6843", "message": "feat(offline): retry server navigation when back online\n\nFixes #9207", "committedDate": "2020-11-27T13:37:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTYyODUwOQ==", "url": "https://github.com/vaadin/flow/pull/9513#discussion_r531628509", "bodyText": "Was this file intended to be added?", "author": "joheriks", "createdAt": "2020-11-27T14:20:16Z", "path": "flow-tests/test-ccdm-flow-navigation/sw.ts", "diffHunk": "@@ -0,0 +1,45 @@\n+/// <reference lib=\"webworker\" />\n+\n+importScripts('sw-runtime-resources-precache.js');\n+import {skipWaiting, clientsClaim} from 'workbox-core';\n+import {matchPrecache, precacheAndRoute} from 'workbox-precaching';\n+import {NavigationRoute, registerRoute} from 'workbox-routing';\n+import {PrecacheEntry} from 'workbox-precaching/_types';\n+import {NetworkOnly} from 'workbox-strategies';\n+\n+skipWaiting();\n+clientsClaim();\n+\n+const appShellPath = '/';\n+// @ts-ignore: OFFLINE_PATH_ENABLED and OFFLINE_PATH are defined by webpack.generated.js\n+const offlinePath = OFFLINE_PATH_ENABLED ? '/' + OFFLINE_PATH : appShellPath;\n+const networkOnly = new NetworkOnly();\n+const navigationFallback = new NavigationRoute(async (params: any) => {\n+  // Use offlinePath fallback if offline was detected\n+  if (!self.navigator.onLine) {\n+    const offlinePathPrecachedResponse = await matchPrecache(offlinePath);\n+    if (offlinePathPrecachedResponse) {\n+      return offlinePathPrecachedResponse;\n+    }\n+  }\n+\n+  // Sometimes navigator.onLine is not reliable, use fallback to offlinePath\n+  // also in case of network failure\n+  try {\n+    return await networkOnly.handle(params);\n+  } catch (error) {\n+    return (await matchPrecache(offlinePath)) || error;\n+  }\n+});\n+\n+registerRoute(navigationFallback);\n+\n+// @ts-ignore: __WB_MANIFEST is injected by the InjectManifest plugin\n+let manifestEntries: Array<PrecacheEntry> = self.__WB_MANIFEST;\n+// @ts-ignore: additionalManifestEntries is defined in sw-runtime-resources-precache.js\n+const additionalManifestEntries: Array<PrecacheEntry> = self.additionalManifestEntries;\n+if (additionalManifestEntries && additionalManifestEntries.length) {\n+  manifestEntries = [...manifestEntries, ...additionalManifestEntries];\n+}\n+\n+precacheAndRoute(manifestEntries);", "originalCommit": "2587aaa44d2d12407c19d5bb65451462e59b6843", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTcxMTcxMg==", "url": "https://github.com/vaadin/flow/pull/9513#discussion_r531711712", "bodyText": "oops, accidental. Removed.", "author": "platosha", "createdAt": "2020-11-27T17:35:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTYyODUwOQ=="}], "type": "inlineReview"}, {"oid": "504f4e62018b98d9206f7a23f89f5d4bd2428bbd", "url": "https://github.com/vaadin/flow/commit/504f4e62018b98d9206f7a23f89f5d4bd2428bbd", "message": "feat(offline): retry server navigation when back online\n\nFixes #9207", "committedDate": "2020-11-27T17:33:50Z", "type": "forcePushed"}, {"oid": "9c2753319ff7e7a952cefcc01d963ca5aa19c7b8", "url": "https://github.com/vaadin/flow/commit/9c2753319ff7e7a952cefcc01d963ca5aa19c7b8", "message": "feat(offline): retry server navigation when back online\n\nFixes #9207", "committedDate": "2020-11-27T17:35:34Z", "type": "commit"}, {"oid": "9c2753319ff7e7a952cefcc01d963ca5aa19c7b8", "url": "https://github.com/vaadin/flow/commit/9c2753319ff7e7a952cefcc01d963ca5aa19c7b8", "message": "feat(offline): retry server navigation when back online\n\nFixes #9207", "committedDate": "2020-11-27T17:35:34Z", "type": "forcePushed"}, {"oid": "f3d63ba2f1b2b0abaf2cbacb9cfa8e59e6b9c9b1", "url": "https://github.com/vaadin/flow/commit/f3d63ba2f1b2b0abaf2cbacb9cfa8e59e6b9c9b1", "message": "Merge branch 'feature/offline' into ap/feature/offline-heartbeat-and-reload", "committedDate": "2020-11-30T08:31:38Z", "type": "commit"}]}