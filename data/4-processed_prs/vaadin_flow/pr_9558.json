{"pr_number": 9558, "pr_title": "feat: Resource handling to not need plugin copying", "pr_createdAt": "2020-12-02T19:55:38Z", "pr_url": "https://github.com/vaadin/flow/pull/9558", "timeline": [{"oid": "2c3a1b668c506b07011866e92aa9aafd3c2f6855", "url": "https://github.com/vaadin/flow/commit/2c3a1b668c506b07011866e92aa9aafd3c2f6855", "message": "feat: Resource handling to not need plugin copying\n\nFixed the url handling so that theme resources\nget prepended with theme/[themeName] while\nhaving the correct absolute path. With this we can handle\nthese url resources with the css-loader which in turn\nleads to file-loader gettign the files for copying.\n\nExternal url are still not touched in any way.\n\nOnly negative is now we loose any folder the resources\nwere located at.", "committedDate": "2020-12-03T04:54:04Z", "type": "commit"}, {"oid": "2c3a1b668c506b07011866e92aa9aafd3c2f6855", "url": "https://github.com/vaadin/flow/commit/2c3a1b668c506b07011866e92aa9aafd3c2f6855", "message": "feat: Resource handling to not need plugin copying\n\nFixed the url handling so that theme resources\nget prepended with theme/[themeName] while\nhaving the correct absolute path. With this we can handle\nthese url resources with the css-loader which in turn\nleads to file-loader gettign the files for copying.\n\nExternal url are still not touched in any way.\n\nOnly negative is now we loose any folder the resources\nwere located at.", "committedDate": "2020-12-03T04:54:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTAyODU2MA==", "url": "https://github.com/vaadin/flow/pull/9558#discussion_r535028560", "bodyText": "Should the docs above be updated to mention that this copies only node modules files ?", "author": "pleku", "createdAt": "2020-12-03T09:52:54Z", "path": "flow-server/src/main/resources/plugins/application-theme-plugin/theme-copy.js", "diffHunk": "@@ -23,44 +23,6 @@ const fs = require('fs');\n const path = require('path');\n const glob = require('glob');\n \n-/**", "originalCommit": "2c3a1b668c506b07011866e92aa9aafd3c2f6855", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTA4MTU3NA==", "url": "https://github.com/vaadin/flow/pull/9558#discussion_r535081574", "bodyText": "updated that any copy functions should be here.", "author": "caalador", "createdAt": "2020-12-03T10:39:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTAyODU2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTAzMjAxNQ==", "url": "https://github.com/vaadin/flow/pull/9558#discussion_r535032015", "bodyText": "Not sure if these checks could be just combined to one debug log that outputs what is happening (also NIT missing whitespace)", "author": "pleku", "createdAt": "2020-12-03T09:55:47Z", "path": "flow-server/src/main/resources/webpack.generated.js", "diffHunk": "@@ -179,7 +179,14 @@ module.exports = {\n             options: {\n               url: (url, resourcePath) => {\n                 // Only translate files from node_modules\n-                return resourcePath.includes('/node_modules/');\n+                const resolve = resourcePath.match(/(\\\\|\\/)node_modules\\1/);\n+                const themResource = resourcePath.match(/(\\\\|\\/)theme\\1[\\s\\S]*?\\1/) && url.match(/theme\\/[\\s\\S]*?\\//);\n+                if(resolve) {", "originalCommit": "2c3a1b668c506b07011866e92aa9aafd3c2f6855", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTA3OTQ4OA==", "url": "https://github.com/vaadin/flow/pull/9558#discussion_r535079488", "bodyText": "But they are 2 different handles so you get more information about what is happening when they are differentiated as the url printed won't give you the path info and you don't really want or need the full resource path in the log.", "author": "caalador", "createdAt": "2020-12-03T10:37:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTAzMjAxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTA4NDI0OQ==", "url": "https://github.com/vaadin/flow/pull/9558#discussion_r535084249", "bodyText": "Dropped the log altogether as it is not clear how it would help the developer in any way.", "author": "caalador", "createdAt": "2020-12-03T10:41:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTAzMjAxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTAzNzA3MQ==", "url": "https://github.com/vaadin/flow/pull/9558#discussion_r535037071", "bodyText": "If I understood correctly, the comments for the theme-loader below are not valid anymore as it is not aboud VAADIN/static but the  theme/[themeFolder]", "author": "pleku", "createdAt": "2020-12-03T10:00:00Z", "path": "flow-server/src/main/resources/webpack.generated.js", "diffHunk": "@@ -179,7 +179,14 @@ module.exports = {\n             options: {\n               url: (url, resourcePath) => {\n                 // Only translate files from node_modules\n-                return resourcePath.includes('/node_modules/');\n+                const resolve = resourcePath.match(/(\\\\|\\/)node_modules\\1/);\n+                const themResource = resourcePath.match(/(\\\\|\\/)theme\\1[\\s\\S]*?\\1/) && url.match(/theme\\/[\\s\\S]*?\\//);\n+                if(resolve) {\n+                  console.debug(\"Inlining node_module resource: \", url);\n+                } else if(themResource) {\n+                  console.debug(\"Handling theme resource: \", url);\n+                }\n+                return resolve || themResource;\n               },\n               // use theme-loader to also handle any imports in css files\n               importLoaders: 1", "originalCommit": "2c3a1b668c506b07011866e92aa9aafd3c2f6855", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTA3NzU5Mw==", "url": "https://github.com/vaadin/flow/pull/9558#discussion_r535077593", "bodyText": "It's still valid as the theme-loader handles the resources to be in the theme/my-theme format and css loader should give it any css imports to check also.", "author": "caalador", "createdAt": "2020-12-03T10:35:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTAzNzA3MQ=="}], "type": "inlineReview"}, {"oid": "0fcbdc3600817dadf2b01ff8e13a2be69237263b", "url": "https://github.com/vaadin/flow/commit/0fcbdc3600817dadf2b01ff8e13a2be69237263b", "message": "Update comments and logging.", "committedDate": "2020-12-03T10:42:05Z", "type": "commit"}, {"oid": "daec031b9b2c3b459786e3e466b4eb1c89a59164", "url": "https://github.com/vaadin/flow/commit/daec031b9b2c3b459786e3e466b4eb1c89a59164", "message": "Fix file loader to use the correct path.", "committedDate": "2020-12-03T11:03:46Z", "type": "commit"}, {"oid": "8192a95215fa3e39a2a243e5ec25a3e502fc6d1d", "url": "https://github.com/vaadin/flow/commit/8192a95215fa3e39a2a243e5ec25a3e502fc6d1d", "message": "Revert test paths", "committedDate": "2020-12-03T11:06:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE2NzkzMA==", "url": "https://github.com/vaadin/flow/pull/9558#discussion_r535167930", "bodyText": "typo", "author": "pleku", "createdAt": "2020-12-03T12:04:56Z", "path": "flow-server/src/main/resources/webpack.generated.js", "diffHunk": "@@ -179,7 +179,9 @@ module.exports = {\n             options: {\n               url: (url, resourcePath) => {\n                 // Only translate files from node_modules\n-                return resourcePath.includes('/node_modules/');\n+                const resolve = resourcePath.match(/(\\\\|\\/)node_modules\\1/);\n+                const themResource = resourcePath.match(/(\\\\|\\/)theme\\1[\\s\\S]*?\\1/) && url.match(/theme\\/[\\s\\S]*?\\//);", "originalCommit": "8192a95215fa3e39a2a243e5ec25a3e502fc6d1d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE5MTIwNA==", "url": "https://github.com/vaadin/flow/pull/9558#discussion_r535191204", "bodyText": "fixed", "author": "caalador", "createdAt": "2020-12-03T12:34:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE2NzkzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE2OTc2Mg==", "url": "https://github.com/vaadin/flow/pull/9558#discussion_r535169762", "bodyText": "Should this regex be somewhere so that it is named and shared for both usage (this & css-loader) ?", "author": "pleku", "createdAt": "2020-12-03T12:06:57Z", "path": "flow-server/src/main/resources/webpack.generated.js", "diffHunk": "@@ -195,6 +197,23 @@ module.exports = {\n           }\n         ],\n       },\n+      {\n+        // File-loader only copies files used as imports in .js files or handled by css-loader\n+        test: /\\.(png|gif|jpg|jpeg|svg|eot|woff|woff2|ttf)$/,\n+        use: [{\n+          loader: 'file-loader',\n+          options: {\n+            outputPath: 'static/',\n+            name(resourcePath, resourceQuery) {\n+              const urlResource = resourcePath.substring(frontendFolder.length);\n+              if(urlResource.match(/(\\\\|\\/)theme\\1[\\s\\S]*?\\1/)){", "originalCommit": "8192a95215fa3e39a2a243e5ec25a3e502fc6d1d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE5NTkxMQ==", "url": "https://github.com/vaadin/flow/pull/9558#discussion_r535195911", "bodyText": "done.", "author": "caalador", "createdAt": "2020-12-03T12:42:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE2OTc2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE4MjE3NA==", "url": "https://github.com/vaadin/flow/pull/9558#discussion_r535182174", "bodyText": "Just to make sure, the frontendFolder will never end with / or \\ ?", "author": "pleku", "createdAt": "2020-12-03T12:19:58Z", "path": "flow-server/src/main/resources/webpack.generated.js", "diffHunk": "@@ -195,6 +197,23 @@ module.exports = {\n           }\n         ],\n       },\n+      {\n+        // File-loader only copies files used as imports in .js files or handled by css-loader\n+        test: /\\.(png|gif|jpg|jpeg|svg|eot|woff|woff2|ttf)$/,\n+        use: [{\n+          loader: 'file-loader',\n+          options: {\n+            outputPath: 'static/',\n+            name(resourcePath, resourceQuery) {\n+              const urlResource = resourcePath.substring(frontendFolder.length);\n+              if(urlResource.match(/(\\\\|\\/)theme\\1[\\s\\S]*?\\1/)){", "originalCommit": "8192a95215fa3e39a2a243e5ec25a3e502fc6d1d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE5MzQ0NA==", "url": "https://github.com/vaadin/flow/pull/9558#discussion_r535193444", "bodyText": "path.resolve never ends in a path separator. From the documentation The resulting path is normalized and trailing slashes are removed unless the path is resolved to the root directory.", "author": "caalador", "createdAt": "2020-12-03T12:38:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE4MjE3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE4MjY0Mw==", "url": "https://github.com/vaadin/flow/pull/9558#discussion_r535182643", "bodyText": "Would it make sense to either use the output from the match above so there is only one regex operation ?", "author": "pleku", "createdAt": "2020-12-03T12:20:45Z", "path": "flow-server/src/main/resources/webpack.generated.js", "diffHunk": "@@ -195,6 +197,23 @@ module.exports = {\n           }\n         ],\n       },\n+      {\n+        // File-loader only copies files used as imports in .js files or handled by css-loader\n+        test: /\\.(png|gif|jpg|jpeg|svg|eot|woff|woff2|ttf)$/,\n+        use: [{\n+          loader: 'file-loader',\n+          options: {\n+            outputPath: 'static/',\n+            name(resourcePath, resourceQuery) {\n+              const urlResource = resourcePath.substring(frontendFolder.length);\n+              if(urlResource.match(/(\\\\|\\/)theme\\1[\\s\\S]*?\\1/)){\n+                return /[\\s\\S]*(\\\\|\\/)theme\\1[\\s\\S]*?\\1(.*)/.exec(resourcePath)[2];", "originalCommit": "8192a95215fa3e39a2a243e5ec25a3e502fc6d1d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTIwMjI4OA==", "url": "https://github.com/vaadin/flow/pull/9558#discussion_r535202288", "bodyText": "The match above doesn't collect the file name at all just checks that the theme part is there.\nIn the first case we match for the css file not for the resource file so then they need to differ in usage.", "author": "caalador", "createdAt": "2020-12-03T12:52:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE4MjY0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE4MzE3NQ==", "url": "https://github.com/vaadin/flow/pull/9558#discussion_r535183175", "bodyText": "Will this code be only executed for the currently active theme's resources as the theme name is not checked here ? I think so but just checking", "author": "pleku", "createdAt": "2020-12-03T12:21:34Z", "path": "flow-server/src/main/resources/webpack.generated.js", "diffHunk": "@@ -195,6 +197,23 @@ module.exports = {\n           }\n         ],\n       },\n+      {\n+        // File-loader only copies files used as imports in .js files or handled by css-loader\n+        test: /\\.(png|gif|jpg|jpeg|svg|eot|woff|woff2|ttf)$/,\n+        use: [{\n+          loader: 'file-loader',\n+          options: {\n+            outputPath: 'static/',\n+            name(resourcePath, resourceQuery) {\n+              const urlResource = resourcePath.substring(frontendFolder.length);\n+              if(urlResource.match(/(\\\\|\\/)theme\\1[\\s\\S]*?\\1/)){\n+                return /[\\s\\S]*(\\\\|\\/)theme\\1[\\s\\S]*?\\1(.*)/.exec(resourcePath)[2];", "originalCommit": "8192a95215fa3e39a2a243e5ec25a3e502fc6d1d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTIwMjkzOQ==", "url": "https://github.com/vaadin/flow/pull/9558#discussion_r535202939", "bodyText": "No other themes are pointed to so that webpack would find them so this will only handle the active theme.", "author": "caalador", "createdAt": "2020-12-03T12:53:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE4MzE3NQ=="}], "type": "inlineReview"}, {"oid": "6dd25aa8caf03372e98202538ca61ed6db6fee21", "url": "https://github.com/vaadin/flow/commit/6dd25aa8caf03372e98202538ca61ed6db6fee21", "message": "Use single regex for file- and css-loader\n\nUpdate url matcher to require that\ntheme/my-theme is in the beginning.", "committedDate": "2020-12-03T12:54:39Z", "type": "commit"}, {"oid": "6d93000be9985d921dc485cec69ae3b4f7bdad69", "url": "https://github.com/vaadin/flow/commit/6d93000be9985d921dc485cec69ae3b4f7bdad69", "message": "Update file path + name regex\n\nUpdated regex so we don't have a possible\nsuper-linear problem. (even though we handle file system paths not input)", "committedDate": "2020-12-04T05:59:30Z", "type": "commit"}]}