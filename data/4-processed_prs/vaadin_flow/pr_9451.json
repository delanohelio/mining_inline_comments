{"pr_number": 9451, "pr_title": "feat: Serve theme static files from VAADIN/static", "pr_createdAt": "2020-11-20T09:58:34Z", "pr_url": "https://github.com/vaadin/flow/pull/9451", "timeline": [{"oid": "b088d805652b7db7a642b772e5635b0dd5576ad3", "url": "https://github.com/vaadin/flow/commit/b088d805652b7db7a642b772e5635b0dd5576ad3", "message": "feat: Serve theme static files from VAADIN/static\n\nStatic files in META-INF/VAADIN/static will now be served\non request to VAADIN/static.\nAdded new webpack loader that changes app theme\ncss urls targeting ./ to be VAADIN/static/ instead.\n\nFixes #9405", "committedDate": "2020-11-20T09:57:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU5MTQwMg==", "url": "https://github.com/vaadin/flow/pull/9451#discussion_r527591402", "bodyText": "Isn't that exactly the opposite of #9430?  @pleku", "author": "knoobie", "createdAt": "2020-11-20T10:18:42Z", "path": "flow-tests/test-themes/frontend/theme/app-theme/global.css", "diffHunk": "@@ -1,3 +1,3 @@\n body {\n-    background-image: url('theme/app-theme/img/bg.jpg');\n+    background-image: url(\"./img/bg.jpg\");", "originalCommit": "b088d805652b7db7a642b772e5635b0dd5576ad3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYwMDMxNg==", "url": "https://github.com/vaadin/flow/pull/9451#discussion_r527600316", "bodyText": "hmm... but now it's a direct reference from the css file so IDEA (and others) can for instance auto complete and validate the reference file.", "author": "caalador", "createdAt": "2020-11-20T10:34:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU5MTQwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYxMDIxNg==", "url": "https://github.com/vaadin/flow/pull/9451#discussion_r527610216", "bodyText": "That's a convenient for developer for \"small\" projects but can be a huge burden for dev or ops teams in bigger projects when you have requirements to load images from something outside of the app.\nAt least this \"magic\" should be configurable(opt-out) if that's something you need to have for vaadin's DX.", "author": "knoobie", "createdAt": "2020-11-20T10:50:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU5MTQwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY1MDA5NQ==", "url": "https://github.com/vaadin/flow/pull/9451#discussion_r527650095", "bodyText": "Updated so that we only change the url if the file actually exists relative to the css being handled.", "author": "caalador", "createdAt": "2020-11-20T12:09:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU5MTQwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY2MDEwMQ==", "url": "https://github.com/vaadin/flow/pull/9451#discussion_r527660101", "bodyText": "Interesting idea!\nJust a test case to verify: Project setup: Vaadin + Spring Boot\nresources/public/img/first.png\nresources/META-INF/VAADIN/static/img/second.jpg\nresources/VAADIN/themes/my-theme/global.css\nglobal.css:\nbody {\n background-image: url(\"./img/first.png\");\n}\nmain {\n background-image: url(\"./img/second.jpg\");\n}\nSpring boot would serve the image first.png because it is inside the public folder. Now your change would not change the background-image of the css because first.png isn't reachable for webpack. And the background-image of main would be rewritten and of course served successfully. Correct?", "author": "knoobie", "createdAt": "2020-11-20T12:30:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU5MTQwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY2NzI5Mg==", "url": "https://github.com/vaadin/flow/pull/9451#discussion_r527667292", "bodyText": "The theme-loader will now actually check that the file exists relative to the css file handled so: if it can find the file resources/VAADIN/themes/my-theme/img/second.jpg it will be rewritten with VAADIN/static else it's seen as \"external\" and supplied by someone else.", "author": "caalador", "createdAt": "2020-11-20T12:44:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU5MTQwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY3MDM3Mg==", "url": "https://github.com/vaadin/flow/pull/9451#discussion_r527670372", "bodyText": "That was the missing piece, thanks!", "author": "knoobie", "createdAt": "2020-11-20T12:50:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU5MTQwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY3MTI5MQ==", "url": "https://github.com/vaadin/flow/pull/9451#discussion_r527671291", "bodyText": "I think if we check that the file exists either in the folder or inside a the parent theme .jar \ud83d\udc40 and only modify it then, we would be handling only the URLs that we should. But then ofc. it might be quite hard for the users to detect typos (?) if those only result in 404 on the page. Could do something for that, e.g. make them more visible in development mode", "author": "pleku", "createdAt": "2020-11-20T12:52:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU5MTQwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ5Nzg3NA==", "url": "https://github.com/vaadin/flow/pull/9451#discussion_r528497874", "bodyText": "for dev mode we now log any url not modified.", "author": "caalador", "createdAt": "2020-11-23T06:56:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU5MTQwMg=="}], "type": "inlineReview"}, {"oid": "d25cc506118629a906121cd36f1e5830578da70a", "url": "https://github.com/vaadin/flow/commit/d25cc506118629a906121cd36f1e5830578da70a", "message": "expect theme-loader", "committedDate": "2020-11-20T10:30:26Z", "type": "commit"}, {"oid": "84588d133fa429fecfdc340fafd74f85c5ae00b3", "url": "https://github.com/vaadin/flow/commit/84588d133fa429fecfdc340fafd74f85c5ae00b3", "message": "update: theme-loader only updates url if file exists by path.", "committedDate": "2020-11-20T12:05:03Z", "type": "commit"}, {"oid": "25d12923738b3e98c65c1bfcaac93d76a4ae316b", "url": "https://github.com/vaadin/flow/commit/25d12923738b3e98c65c1bfcaac93d76a4ae316b", "message": "Merge branch 'master' into issues/9405_theme_static_files\n\n# Conflicts:\n#\tflow-tests/test-themes/frontend/theme/app-theme/global.css", "committedDate": "2020-11-20T12:52:07Z", "type": "commit"}, {"oid": "cb7d2d50f91fc64c5bb9e458a84af10e40846215", "url": "https://github.com/vaadin/flow/commit/cb7d2d50f91fc64c5bb9e458a84af10e40846215", "message": "Fix theme test paths", "committedDate": "2020-11-20T12:53:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY2OTU1OQ==", "url": "https://github.com/vaadin/flow/pull/9451#discussion_r527669559", "bodyText": "We could verify that a file that is not intended to be copied is not actually copied (and served), maybe like .css or theme.json", "author": "pleku", "createdAt": "2020-11-20T12:49:09Z", "path": "flow-server/src/test/java/com/vaadin/flow/server/StaticFileServerTest.java", "diffHunk": "@@ -488,6 +488,37 @@ public void serveStaticBundleBuildResource() throws IOException {\n         assertBundleBuildResource(pathInfo);\n     }\n \n+    @Test\n+    public void contextAndServletPath_serveStaticFileResource()\n+            throws IOException {\n+        String pathInfo = \"/VAADIN/static/img/bg.jpg\";\n+        setupRequestURI(\"/context\", \"/servlet\", pathInfo);\n+        assertBundleBuildResource(pathInfo);\n+    }\n+\n+    @Test\n+    public void ServletPath_serveStaticFileResource()\n+            throws IOException {\n+        String pathInfo = \"/VAADIN/static/img/bg.jpg\";\n+        setupRequestURI(\"\", \"/servlet\", pathInfo);\n+        assertBundleBuildResource(pathInfo);\n+    }\n+\n+    @Test\n+    public void contextPath_serveStaticFileResource()\n+            throws IOException {\n+        String pathInfo = \"/VAADIN/static/img/bg.jpg\";\n+        setupRequestURI(\"/context\", \"\", pathInfo);\n+        assertBundleBuildResource(pathInfo);\n+    }\n+\n+    @Test\n+    public void serveStaticFileResource() throws IOException {\n+        String pathInfo = \"/VAADIN/static/img/bg.jpg\";\n+        setupRequestURI(\"\", \"\", pathInfo);\n+        assertBundleBuildResource(pathInfo);\n+    }\n+", "originalCommit": "84588d133fa429fecfdc340fafd74f85c5ae00b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ5Nzc2MA==", "url": "https://github.com/vaadin/flow/pull/9451#discussion_r528497760", "bodyText": "This can only be done in the IT test as here we don't copy anything and anything in VAADIN/static should be shared.", "author": "caalador", "createdAt": "2020-11-23T06:55:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY2OTU1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY3NjA0Mg==", "url": "https://github.com/vaadin/flow/pull/9451#discussion_r527676042", "bodyText": "maybe clarify what theme files will be copied", "author": "pleku", "createdAt": "2020-11-20T13:01:56Z", "path": "flow-server/src/main/resources/plugins/application-theme-plugin/theme-copy.js", "diffHunk": "@@ -16,30 +16,23 @@\n \n /**\n  * This file handles copying of theme files to\n- * [staticResourcesFolder]/theme/[theme-name]\n+ * [staticResourcesFolder]\n  */\n \n const fs = require('fs');\n const path = require('path');\n \n /**\n- * create theme/themeName folders and copy theme files there.\n+ * copy theme files  to static assets folder.", "originalCommit": "cb7d2d50f91fc64c5bb9e458a84af10e40846215", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ4NTU3Ng==", "url": "https://github.com/vaadin/flow/pull/9451#discussion_r528485576", "bodyText": "done", "author": "caalador", "createdAt": "2020-11-23T06:05:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY3NjA0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY4MTExNA==", "url": "https://github.com/vaadin/flow/pull/9451#discussion_r527681114", "bodyText": "I think to be reused you would have to make a new Regexp(...)", "author": "pleku", "createdAt": "2020-11-20T13:12:06Z", "path": "flow-server/src/main/resources/plugins/theme-loader/theme-loader.js", "diffHunk": "@@ -0,0 +1,26 @@\n+const fs = require('fs');\n+const path = require('path');\n+\n+const urlMatcher = /(url\\()(\\'|\\\")?(\\.\\/)(.*\\2\\))/g;\n+\n+module.exports = function (source, map) {\n+  const handledResourceFolder = path.dirname(this._module.resource);\n+  const logger = this.getLogger(\"theme-loader\");\n+\n+  // Collect groups [url(] [ |'|\"]optional './' and end of url\n+  source = source.replace(urlMatcher, function (match, url, quoteMark, replace, endString) {\n+    // for some reason this matcher can not be reused as a constant", "originalCommit": "cb7d2d50f91fc64c5bb9e458a84af10e40846215", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ4NTkxNA==", "url": "https://github.com/vaadin/flow/pull/9451#discussion_r528485914", "bodyText": "The issue was the global flag which adds a position on last use.\nFixed by removing g as it doesn't need to remember the position of the last exec.", "author": "caalador", "createdAt": "2020-11-23T06:07:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY4MTExNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODYxMzQ2OQ==", "url": "https://github.com/vaadin/flow/pull/9451#discussion_r528613469", "bodyText": "In the end the main matcher was updated so that we get the url part directly from there.", "author": "caalador", "createdAt": "2020-11-23T10:47:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY4MTExNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY4MjMzMA==", "url": "https://github.com/vaadin/flow/pull/9451#discussion_r527682330", "bodyText": "Lets add another test which verifies that `url(\"../icons/icon.png\"); or similar works", "author": "pleku", "createdAt": "2020-11-20T13:14:37Z", "path": "flow-tests/test-themes/frontend/theme/app-theme/global.css", "diffHunk": "@@ -1,9 +1,9 @@\n @font-face {\n     font-family: \"Ostrich\";\n-    src: url(\"theme/app-theme/font/ostrich-sans-regular.ttf\") format(\"TrueType\");\n+    src: url(\"./font/ostrich-sans-regular.ttf\") format(\"TrueType\");\n }\n \n body {\n-    background-image: url('theme/app-theme/img/bg.jpg');\n+    background-image: url(\"./img/bg.jpg\");", "originalCommit": "cb7d2d50f91fc64c5bb9e458a84af10e40846215", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ4Mjk5Ng==", "url": "https://github.com/vaadin/flow/pull/9451#discussion_r528482996", "bodyText": "Here we have a small problem in that we won't accept static serving for anything that contains ../\nWhat we could do would be to accept navigation inside the theme folder and rewrite those to be absolute to the file target so we wouldn't have ../ e.g. ../icons/icon.png  would fail from /app-theme/global.css, but would be rewritten to icons/icon.png in app-theme/sub/extras.css", "author": "caalador", "createdAt": "2020-11-23T05:53:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY4MjMzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU0NDYyOQ==", "url": "https://github.com/vaadin/flow/pull/9451#discussion_r528544629", "bodyText": "Another option could be to use a magic URL thingy there like theme:// but not sure if it should resolve to\n\nto the theme/ folder\nto the currently active theme\nUsually it should resolve to 2) but in some cases when you're creating a reusable theme it should refer to the parent theme and not the currently active theme ... so probably this is just unnecessary complication and thus a bad idea.\n\nI think using e.g. ../icons/icon.png is common so if we can just automatically handle it, lets go with that.\nFor Java code, we'll expect people to anyway use the full path \"frontend/theme/my-theme/icons/icon.png\".\nOne thing to note, even though it is not directly part of this issue, that the npm-based imports it is supposed to work with:\n\"foobar/images/image.png\" when the package has been declared to be imported in theme.json. These URLs should not be touched even though they are not \"external\".", "author": "pleku", "createdAt": "2020-11-23T08:50:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY4MjMzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODYxODMzNA==", "url": "https://github.com/vaadin/flow/pull/9451#discussion_r528618334", "bodyText": "in the format \"foobar/images/image.png\" they won't be touched. Only ./is handled.", "author": "caalador", "createdAt": "2020-11-23T10:55:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY4MjMzMA=="}], "type": "inlineReview"}, {"oid": "7e63eb7c5408f09431f4d4c03f7fa00b19cbe725", "url": "https://github.com/vaadin/flow/commit/7e63eb7c5408f09431f4d4c03f7fa00b19cbe725", "message": "Handle CSS imports with theme-loader\n\ncorrectly update urls with path navigation.", "committedDate": "2020-11-23T09:34:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY3NjcwNg==", "url": "https://github.com/vaadin/flow/pull/9451#discussion_r528676706", "bodyText": "As looking at url(...) examples from MDN, it has\nlist-style-image: url('../images/bullet.jpg');\nso I think we should be able to have the same, ../ is less things to type than ./../.", "author": "pleku", "createdAt": "2020-11-23T12:44:14Z", "path": "flow-tests/test-themes/frontend/theme/app-theme/sub-css/sub.css", "diffHunk": "@@ -0,0 +1,6 @@\n+#sub-component {\n+    background: url('./../icons/archive.png') left top;", "originalCommit": "7e63eb7c5408f09431f4d4c03f7fa00b19cbe725", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY5MDU1OQ==", "url": "https://github.com/vaadin/flow/pull/9451#discussion_r528690559", "bodyText": "done", "author": "caalador", "createdAt": "2020-11-23T13:08:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY3NjcwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY3NzUyNA==", "url": "https://github.com/vaadin/flow/pull/9451#discussion_r528677524", "bodyText": "So this IMO should handle ../ too and not just ./", "author": "pleku", "createdAt": "2020-11-23T12:45:34Z", "path": "flow-server/src/main/resources/plugins/theme-loader/theme-loader.js", "diffHunk": "@@ -1,23 +1,34 @@\n+const loaderUtils = require(\"loader-utils\");\n const fs = require('fs');\n const path = require('path');\n \n-const urlMatcher = /(url\\()(\\'|\\\")?(\\.\\/)(.*\\2\\))/g;\n+// Collect groups [url(] [ |'|\"]optional './', file part and end of url\n+const urlMatcher = /(url\\()(\\'|\\\")?(\\.\\/)(\\S*)(\\2\\))/g;", "originalCommit": "7e63eb7c5408f09431f4d4c03f7fa00b19cbe725", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY5MDA2Mw==", "url": "https://github.com/vaadin/flow/pull/9451#discussion_r528690063", "bodyText": "Added now with more \\ and /", "author": "caalador", "createdAt": "2020-11-23T13:07:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY3NzUyNA=="}], "type": "inlineReview"}, {"oid": "9563620d6e7b27d3df59da538c1acd2d0c9f2199", "url": "https://github.com/vaadin/flow/commit/9563620d6e7b27d3df59da538c1acd2d0c9f2199", "message": "Accept ./ and ../ on URL", "committedDate": "2020-11-23T13:05:49Z", "type": "commit"}]}