{"pr_number": 6863, "pr_title": "onTrimMemory call super", "pr_createdAt": "2020-08-10T00:42:50Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6863", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MTU1Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6863#discussion_r467661553", "bodyText": "This doesn't look like it's implemented in a thread-safe manner", "author": "david-allison-1", "createdAt": "2020-08-10T02:14:53Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/AnkiActivity.java", "diffHunk": "@@ -570,5 +571,14 @@ protected void enableToolbar(@Nullable View view) {\n             setSupportActionBar(toolbar);\n         }\n     }\n+\n+    /* If we don't have enough memory left, removing undo task may free some space without too creating to much trouble.\n+    Todo: find a way to free only a part of the queue, enough to have space, but leaving a few actions for the user.\n+    */\n+    @Override\n+    public void onTrimMemory(int pressureLevel) {\n+        super.onTrimMemory(pressureLevel);\n+        getCol().clearUndo();", "originalCommit": "bd5414a16b9063cb9d39e97c16381b0d7c0f96f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2NTcxMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6863#discussion_r467665711", "bodyText": "You know what. Nothing is thread safe here. We do not even check that the no action were added to the queue, so when we call undo we may be doing an action which was added to the queue after the name of the undo button was selected. It is also possible that the queue was cleared if we click on undo and then select a deck soon after, while undo is waiting to be executed. This is actually quite possible on a table since the undo button may be displayed on the right part of the screen and the list of deck on the left part", "author": "Arthur-Milchior", "createdAt": "2020-08-10T02:41:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MTU1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY4NjI2Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6863#discussion_r467686262", "bodyText": "Corrected in #6864\nI suggest that we wait until #6864 is seen to consider the current PR", "author": "Arthur-Milchior", "createdAt": "2020-08-10T04:48:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MTU1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk1MzY2Nw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6863#discussion_r472953667", "bodyText": "Could we consider moving this to a separate PR so we can get these two obviously correct lines into the codebase?", "author": "david-allison-1", "createdAt": "2020-08-19T11:20:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MTU1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk1NjM3OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6863#discussion_r472956378", "bodyText": "Done", "author": "Arthur-Milchior", "createdAt": "2020-08-19T11:25:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MTU1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk1OTQ0MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6863#discussion_r472959441", "bodyText": "Give me a ping when it's pushed - let's get this one in", "author": "david-allison-1", "createdAt": "2020-08-19T11:31:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MTU1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk2MzE4Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/6863#discussion_r472963186", "bodyText": "ping", "author": "Arthur-Milchior", "createdAt": "2020-08-19T11:38:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MTU1Mw=="}], "type": "inlineReview"}, {"oid": "37a8a2b33dc6faa61e043ce1aecf885469052ecb", "url": "https://github.com/ankidroid/Anki-Android/commit/37a8a2b33dc6faa61e043ce1aecf885469052ecb", "message": "NF: in case of memory pressure, empty undo", "committedDate": "2020-08-10T02:16:53Z", "type": "forcePushed"}, {"oid": "97b490da9f639edf943e696cc096521676c56364", "url": "https://github.com/ankidroid/Anki-Android/commit/97b490da9f639edf943e696cc096521676c56364", "message": "onTrimMemory call super\n\nAccording to documentation \" If you override this method you must call through to the superclass implementation.\"\nhttps://developer.android.com/reference/android/app/Application#onTrimMemory(int)", "committedDate": "2020-08-19T11:25:51Z", "type": "commit"}, {"oid": "8e499a3142be15873abaa34bef9ed09afb018189", "url": "https://github.com/ankidroid/Anki-Android/commit/8e499a3142be15873abaa34bef9ed09afb018189", "message": "NF: in case of memory pressure, empty undo", "committedDate": "2020-08-19T11:25:51Z", "type": "forcePushed"}, {"oid": "97b490da9f639edf943e696cc096521676c56364", "url": "https://github.com/ankidroid/Anki-Android/commit/97b490da9f639edf943e696cc096521676c56364", "message": "onTrimMemory call super\n\nAccording to documentation \" If you override this method you must call through to the superclass implementation.\"\nhttps://developer.android.com/reference/android/app/Application#onTrimMemory(int)", "committedDate": "2020-08-19T11:25:51Z", "type": "forcePushed"}]}