{"pr_number": 6800, "pr_title": "Fixes 6770", "pr_createdAt": "2020-08-02T16:09:30Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6800", "timeline": [{"oid": "17f4e4536ac735de104e9482c271e377c1bbe23b", "url": "https://github.com/ankidroid/Anki-Android/commit/17f4e4536ac735de104e9482c271e377c1bbe23b", "message": "NF: regression test for #6770", "committedDate": "2020-08-03T16:08:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDUxNzIzOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6800#discussion_r464517238", "bodyText": "Why has this been added?", "author": "david-allison-1", "createdAt": "2020-08-03T16:16:58Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Card.java", "diffHunk": "@@ -451,6 +451,7 @@ public int getQueue() {\n \n \n     public void setQueue(@Consts.CARD_QUEUE int queue) {\n+        Assert.that(queue != Consts.QUEUE_TYPE_DAY_LEARN_RELEARN, \"Day\");", "originalCommit": "17f4e4536ac735de104e9482c271e377c1bbe23b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDUxODYzOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6800#discussion_r464518638", "bodyText": "I thought I added it in another branch. I don't know how it ended here. Clearly I should remove it", "author": "Arthur-Milchior", "createdAt": "2020-08-03T16:19:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDUxNzIzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDUyMjAxNw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6800#discussion_r464522017", "bodyText": "Removed. I used it to try to debug #6768 but it seems it was useless anyway", "author": "Arthur-Milchior", "createdAt": "2020-08-03T16:25:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDUxNzIzOA=="}], "type": "inlineReview"}, {"oid": "67a645c00b271863a167c00953279277aa4b5545", "url": "https://github.com/ankidroid/Anki-Android/commit/67a645c00b271863a167c00953279277aa4b5545", "message": "NF: regression test for #6770", "committedDate": "2020-08-03T16:19:44Z", "type": "forcePushed"}, {"oid": "9825d61b31ee671b8970dbe8a945b6f3a9230fba", "url": "https://github.com/ankidroid/Anki-Android/commit/9825d61b31ee671b8970dbe8a945b6f3a9230fba", "message": "NF: Regression test for 6770", "committedDate": "2020-08-03T16:20:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDUxNzY1MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6800#discussion_r464517651", "bodyText": "Nit: These refactorings don't seem relevant to the change", "author": "david-allison-1", "createdAt": "2020-08-03T16:17:45Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sched/Sched.java", "diffHunk": "@@ -481,13 +483,15 @@ protected void _answerLrnCard(Card card, int ease) {\n                 card.setQueue(Consts.QUEUE_TYPE_LRN);\n                 if (!mLrnQueue.isEmpty() && mRevCount == 0 && mNewCount == 0) {\n                     long smallestDue = mLrnQueue.getFirst().getDue();\n-                    card.setDue(Math.max(card.getDue(), smallestDue + 1));\n+                    long maxDue = Math.max(card.getDue(), smallestDue + 1);", "originalCommit": "17f4e4536ac735de104e9482c271e377c1bbe23b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDUzOTUwMw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6800#discussion_r464539503", "bodyText": "I removed all the changes that were due to another branch. I don't really understand how they made it to this branch", "author": "Arthur-Milchior", "createdAt": "2020-08-03T16:57:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDUxNzY1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDUxNzk2MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6800#discussion_r464517960", "bodyText": "This seems to have changed since the last time I reviewed. Is this part of the bugfix?", "author": "david-allison-1", "createdAt": "2020-08-03T16:18:19Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sched/SchedV2.java", "diffHunk": "@@ -2898,6 +2926,16 @@ protected boolean currentCardIsInQueueWithDeck(int queue, long did) {\n         // mCurrentCard may be set to null when the reviewer gets closed. So we copy it to be sure to avoid NullPointerException\n         Card currentCard = mCurrentCard;\n         List<Long> currentCardParentsDid = mCurrentCardParentsDid;\n-        return currentCard != null && currentCard.getQueue() == queue && currentCardParentsDid != null && currentCardParentsDid.contains(did);\n+        if (currentCard == null) {", "originalCommit": "17f4e4536ac735de104e9482c271e377c1bbe23b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU0MDQ2Nw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6800#discussion_r464540467", "bodyText": "Absolutely not.\u00a0It's part of the branch I used to debug another problem. I didn't think it would split unto multiple commit. I don't get it", "author": "Arthur-Milchior", "createdAt": "2020-08-03T16:59:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDUxNzk2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDUxODgzNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6800#discussion_r464518835", "bodyText": "For future: I've added addNoteUsingBasicModel inside RobolectricTest", "author": "david-allison-1", "createdAt": "2020-08-03T16:19:51Z", "path": "AnkiDroid/src/test/java/com/ichi2/libanki/sched/SchedTest.java", "diffHunk": "@@ -142,4 +149,47 @@ public void ensureDeckTree() {\n     private void selectDefaultDeck() {\n         getCol().getDecks().select(Consts.DEFAULT_DECK_ID);\n     }\n+\n+    @Test\n+    public void ensureUndoCorrectCounts() {\n+        Collection col = getCol();\n+        AbstractSched sched = col.getSched();\n+        Deck deck = col.getDecks().get(1);\n+        DeckConfig dconf = col.getDecks().getConf(1);\n+        dconf.getJSONObject(\"new\").put(\"perDay\", 10);\n+        JSONArray newCount = deck.getJSONArray(\"newToday\");\n+        for (int i = 0; i < 20; i++) {\n+            Note note = col.newNote();\n+            note.setField(0, \"a\");", "originalCommit": "17f4e4536ac735de104e9482c271e377c1bbe23b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU0MjEyMw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6800#discussion_r464542123", "bodyText": "Thanks. Used it while I was making the changes", "author": "Arthur-Milchior", "createdAt": "2020-08-03T17:02:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDUxODgzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDUyMDQxOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6800#discussion_r464520419", "bodyText": "I've added waitForTask(UNDO, timeout); which should cut down on code here", "author": "david-allison-1", "createdAt": "2020-08-03T16:22:39Z", "path": "AnkiDroid/src/test/java/com/ichi2/libanki/sched/SchedV2Test.java", "diffHunk": "@@ -156,5 +161,48 @@ public void ensureDeckTree() {\n         Assert.assertEquals(\"Tree has not the expected structure\", expectedTree(sched, true), tree);\n     }\n \n+    // Regression test for 6770\n+    @Test\n+    public void ensureUndoCorrectCounts() throws InterruptedException {\n+        Collection col = getCol();\n+        AbstractSched sched = col.getSched();\n+        Deck deck = col.getDecks().get(1);\n+        DeckConfig dconf = col.getDecks().getConf(1);\n+        dconf.getJSONObject(\"new\").put(\"perDay\", 10);\n+        JSONArray newCount = deck.getJSONArray(\"newToday\");\n+        for (int i = 0; i < 20; i++) {\n+            Note note = col.newNote();\n+            note.setField(0, \"a\");\n+            col.addNote(note);\n+        }\n+        sched.reset();\n+        assertThat(col.cardCount(), is(20));\n+        assertThat(sched.counts()[0], is(10));\n+        Card card = sched.getCard();\n+        assertThat(sched.counts()[0], is(9));\n+        assertThat(sched.counts(card)[0], is(10));\n+        sched.answerCard(card, 3);\n+        sched.getCard();\n+        CollectionTask.launchCollectionTask(UNDO,", "originalCommit": "9825d61b31ee671b8970dbe8a945b6f3a9230fba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU0MTE2Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/6800#discussion_r464541166", "bodyText": "I don't think it fit. I actually want to take the card in onProgressUpdate and it does not seems there is a way to do it using only waitForTask", "author": "Arthur-Milchior", "createdAt": "2020-08-03T17:00:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDUyMDQxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU0MzExNg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6800#discussion_r464543116", "bodyText": "For context, when you undo, progressUpdate is used to send a card to the reviewer. Then the reviewer uses this card and send it to counts() to get the counts it actually displays. So it is actually required to do onProgressUpdate to check whether the code actually works", "author": "Arthur-Milchior", "createdAt": "2020-08-03T17:04:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDUyMDQxOQ=="}], "type": "inlineReview"}, {"oid": "36ce3b61076eb440b82718ae8e23d2a38610e170", "url": "https://github.com/ankidroid/Anki-Android/commit/36ce3b61076eb440b82718ae8e23d2a38610e170", "message": "NF: Regression test for 6770", "committedDate": "2020-08-03T16:58:54Z", "type": "forcePushed"}, {"oid": "c31b9b72f6a79dfc1848333f53d3491652676f31", "url": "https://github.com/ankidroid/Anki-Android/commit/c31b9b72f6a79dfc1848333f53d3491652676f31", "message": "NF: Regression test for 6770", "committedDate": "2020-08-03T17:02:10Z", "type": "forcePushed"}, {"oid": "60c79b2079a74548c07f2d63befd4a48368c712a", "url": "https://github.com/ankidroid/Anki-Android/commit/60c79b2079a74548c07f2d63befd4a48368c712a", "message": "NF: Regression test for 6770", "committedDate": "2020-08-04T18:45:15Z", "type": "forcePushed"}, {"oid": "71edee3f96002cd973ba0193fbd41be6ff305b14", "url": "https://github.com/ankidroid/Anki-Android/commit/71edee3f96002cd973ba0193fbd41be6ff305b14", "message": "NF: Regression test for 6770", "committedDate": "2020-08-04T19:52:35Z", "type": "forcePushed"}, {"oid": "2df8d2f7ec2ea7da15e86d1a3b5d4ff2d5f0c6b0", "url": "https://github.com/ankidroid/Anki-Android/commit/2df8d2f7ec2ea7da15e86d1a3b5d4ff2d5f0c6b0", "message": "NF: Regression test for 6770", "committedDate": "2020-08-04T19:55:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMyMjM5Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6800#discussion_r465322393", "bodyText": "Can you add an assertion that this code is executed? Guarantees about how multithreaded code execute can change over time with testing framework changes, and knowing explicitly that a test is broken gives value in this case", "author": "david-allison-1", "createdAt": "2020-08-04T20:50:36Z", "path": "AnkiDroid/src/test/java/com/ichi2/libanki/sched/AbstractSchedTest.java", "diffHunk": "@@ -85,4 +90,47 @@ public void testUndoResetsCardCountsToCorrectValue() throws InterruptedException\n \n         assertThat(\"Counts after an undo should be the same as before an undo\", countsAfterUndo, is(countsBeforeUndo));\n     }\n+\n+    @Test\n+    public void ensureUndoCorrectCounts() {\n+        Collection col = getCol();\n+        AbstractSched sched = col.getSched();\n+        Deck deck = col.getDecks().get(1);\n+        DeckConfig dconf = col.getDecks().getConf(1);\n+        dconf.getJSONObject(\"new\").put(\"perDay\", 10);\n+        JSONArray newCount = deck.getJSONArray(\"newToday\");\n+        for (int i = 0; i < 20; i++) {\n+            Note note = col.newNote();\n+            note.setField(0, \"a\");\n+            col.addNote(note);\n+        }\n+        sched.reset();\n+        assertThat(col.cardCount(), is(20));\n+        assertThat(sched.counts()[0], is(10));\n+        Card card = sched.getCard();\n+        assertThat(sched.counts()[0], is(9));\n+        assertThat(sched.counts(card)[0], is(10));\n+        sched.answerCard(card, 3);\n+        sched.getCard();\n+        CollectionTask.launchCollectionTask(UNDO,\n+                new CollectionTask.TaskListener() {\n+                    Card card;\n+                    @Override\n+                    public void onPreExecute() {\n+\n+                    }\n+\n+                    @Override\n+                    public void onProgressUpdate(TaskData data) {\n+                        card = data.getCard();\n+                    }\n+\n+\n+                    @Override\n+                    public void onPostExecute(TaskData result) {\n+                        assertThat(sched.counts()[0], is(9));\n+                        assertThat(sched.counts(card)[0], is(10));", "originalCommit": "2df8d2f7ec2ea7da15e86d1a3b5d4ff2d5f0c6b0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMyNzE1MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6800#discussion_r465327151", "bodyText": "Interesting - you mean like, a member variable that starts false, you set it to true in onPostExecute and then assert it is true... where?", "author": "mikehardy", "createdAt": "2020-08-04T20:59:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMyMjM5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMzMTk1Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6800#discussion_r465331952", "bodyText": "It was executed on my computer, that is sure because the test did fail when it was applied before the fix. That does not mean it also works on travis.\nI guess I can copy the code from waitForTask and wait one second and see whether the inner code was executed. It means that one second will be lost each times test are executed, which is quite often. I would hope for better way to exists", "author": "Arthur-Milchior", "createdAt": "2020-08-04T21:09:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMyMjM5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMzMzYyNA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6800#discussion_r465333624", "bodyText": "I added a method: waitForAsyncTasksToComplete - it has more semantic meaning and may be helpful, although the current implementation isn't good", "author": "david-allison-1", "createdAt": "2020-08-04T21:13:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMyMjM5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM1MTc4NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6800#discussion_r465351785", "bodyText": "What should I do ?\u00a0Call it twice to ensure that two tests are exectued ? The code does not seems clear to me right now", "author": "Arthur-Milchior", "createdAt": "2020-08-04T21:53:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMyMjM5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM1MzU2NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6800#discussion_r465353564", "bodyText": "Hmm... leave a boolean as a local: boolean onPostExecuteCalled = false, set it at the end of onPostExecute()\nCall waitForAsyncTasksToComplete  then assert the boolean has been set.\nUse Android Studio auto refactorings to convert the boolean into an AtomicBoolean to remove the compile errors", "author": "david-allison-1", "createdAt": "2020-08-04T21:58:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMyMjM5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM1NTY5Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/6800#discussion_r465355696", "bodyText": "Done. Thanks", "author": "Arthur-Milchior", "createdAt": "2020-08-04T22:03:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMyMjM5Mw=="}], "type": "inlineReview"}, {"oid": "e59861f9cbc575df2d98190ba24309035a33033c", "url": "https://github.com/ankidroid/Anki-Android/commit/e59861f9cbc575df2d98190ba24309035a33033c", "message": "NF: Regression test for 6770", "committedDate": "2020-08-04T22:03:11Z", "type": "forcePushed"}, {"oid": "e859ffde3ce935f6bf936586a78d4f73e7edcd48", "url": "https://github.com/ankidroid/Anki-Android/commit/e859ffde3ce935f6bf936586a78d4f73e7edcd48", "message": "NF: Regression test for 6770", "committedDate": "2020-08-05T11:31:34Z", "type": "forcePushed"}, {"oid": "69247993d5ecba00f0239619b01217985ef105ad", "url": "https://github.com/ankidroid/Anki-Android/commit/69247993d5ecba00f0239619b01217985ef105ad", "message": "Correct number of cards after undo: #6770\n\nIf the number of cards to see is limited by deck option, undo would not re-increase the limit correctly. This correct it.", "committedDate": "2020-08-05T16:17:54Z", "type": "commit"}, {"oid": "1a159cf8eeec92a28b2c9f655f58d657441c62ad", "url": "https://github.com/ankidroid/Anki-Android/commit/1a159cf8eeec92a28b2c9f655f58d657441c62ad", "message": "NF: Commenting scheduler\n\nA lot of actions are not trivial to undersatnd. Adding comments to explain exactly what occurred.", "committedDate": "2020-08-05T16:18:33Z", "type": "commit"}, {"oid": "0712d72803155e0cbcf242e955323049bb30fadf", "url": "https://github.com/ankidroid/Anki-Android/commit/0712d72803155e0cbcf242e955323049bb30fadf", "message": "NF: Regression test for 6770", "committedDate": "2020-08-05T16:18:33Z", "type": "commit"}, {"oid": "0712d72803155e0cbcf242e955323049bb30fadf", "url": "https://github.com/ankidroid/Anki-Android/commit/0712d72803155e0cbcf242e955323049bb30fadf", "message": "NF: Regression test for 6770", "committedDate": "2020-08-05T16:18:33Z", "type": "forcePushed"}]}