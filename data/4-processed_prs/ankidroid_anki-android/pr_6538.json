{"pr_number": 6538, "pr_title": "Deck name in node", "pr_createdAt": "2020-06-23T16:41:12Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6538", "timeline": [{"oid": "6f8f536c418388ff794d61d799d5d3bbe737e252", "url": "https://github.com/ankidroid/Anki-Android/commit/6f8f536c418388ff794d61d799d5d3bbe737e252", "message": "NF: processNodes don't need depth variable", "committedDate": "2020-06-23T16:58:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM4NDMxNw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6538#discussion_r444384317", "bodyText": "I like this change a lot I think it makes it more clear to reason about the name, certainly.\nNow I'm going to propose a change that will touch every line of the PR just about, but is also a simple rename refactor in Android Studio :-), \"Splitted\" is not a valid word in English, and the variable really represents an array of the variable's components, so perhaps:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    private String[] mSplittedName;\n          \n          \n            \n                    private String[] mNameComponents;", "author": "mikehardy", "createdAt": "2020-06-23T17:19:26Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sched/AbstractSched.java", "diffHunk": "@@ -178,29 +178,25 @@\n      * this field and use getNamePart(0) for those cases.\n      */\n     public class DeckDueTreeNode implements Comparable {\n-        private String[] mName;\n+        private final String mName;\n+        private String[] mSplittedName;", "originalCommit": "36a754b4f1d682289b428833019933435818a3c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM4OTg3NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6538#discussion_r444389874", "bodyText": "Done", "author": "Arthur-Milchior", "createdAt": "2020-06-23T17:28:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM4NDMxNw=="}], "type": "inlineReview"}, {"oid": "f68cf5505f79c5390270318ac64ac0496a8a6fd6", "url": "https://github.com/ankidroid/Anki-Android/commit/f68cf5505f79c5390270318ac64ac0496a8a6fd6", "message": "NF: processNodes don't need depth variable", "committedDate": "2020-06-23T17:28:48Z", "type": "forcePushed"}, {"oid": "7b19c703a4ecddcf43d25409bb5445dce6d16a33", "url": "https://github.com/ankidroid/Anki-Android/commit/7b19c703a4ecddcf43d25409bb5445dce6d16a33", "message": "NF: processNodes don't need depth variable", "committedDate": "2020-06-23T19:35:20Z", "type": "forcePushed"}, {"oid": "91d6655605369a4a11c35f9d0c255c36f89b7b11", "url": "https://github.com/ankidroid/Anki-Android/commit/91d6655605369a4a11c35f9d0c255c36f89b7b11", "message": "NF: processNodes don't need depth variable", "committedDate": "2020-06-23T20:12:47Z", "type": "forcePushed"}, {"oid": "4ff76061cf21e4b30182c6a123be4655b1d471f8", "url": "https://github.com/ankidroid/Anki-Android/commit/4ff76061cf21e4b30182c6a123be4655b1d471f8", "message": "NF: processNodes don't need depth variable", "committedDate": "2020-06-23T20:16:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU3NTMzMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6538#discussion_r444575331", "bodyText": "mName is final, and this is the only place we set it\nmNameComponents is built off mName, implying that it can be final as well, and should be set right here\nThen you don't need a method setNameComponents with a null check and worry about whether it is set or not", "author": "mikehardy", "createdAt": "2020-06-24T00:13:46Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sched/AbstractSched.java", "diffHunk": "@@ -178,29 +177,25 @@\n      * this field and use getNamePart(0) for those cases.\n      */\n     public class DeckDueTreeNode implements Comparable {\n-        private String[] mName;\n+        private final String mName;\n+        private String[] mNameComponents;\n         private long mDid;\n-        private int mDepth;\n         private int mRevCount;\n         private int mLrnCount;\n         private int mNewCount;\n         private List<DeckDueTreeNode> mChildren = new ArrayList<>();\n \n-        public DeckDueTreeNode(String[] mName, long mDid, int mRevCount, int mLrnCount, int mNewCount) {\n+        public DeckDueTreeNode(String mName, long mDid, int mRevCount, int mLrnCount, int mNewCount) {\n             this.mName = mName;", "originalCommit": "1423bb175853f8cadbc83ffca7dd2b37684271bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU3Njg5NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6538#discussion_r444576894", "bodyText": "The list of deck is used in CardContentProvider and in sync. In both cases, we never need to access the splited name. Splitting string is kind of slow so I want to avoid doing it unless it's need, to speed up those actions.", "author": "Arthur-Milchior", "createdAt": "2020-06-24T00:19:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU3NTMzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU3Njk1OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6538#discussion_r444576958", "bodyText": "Never mind, I just recalled I have a method caching splits, so this was a useless optimization", "author": "Arthur-Milchior", "createdAt": "2020-06-24T00:20:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU3NTMzMQ=="}], "type": "inlineReview"}, {"oid": "5948c3c700bd7f2d85a707b3a25f23094cf0d7ac", "url": "https://github.com/ankidroid/Anki-Android/commit/5948c3c700bd7f2d85a707b3a25f23094cf0d7ac", "message": "NF: processNodes don't need depth variable", "committedDate": "2020-06-24T00:21:37Z", "type": "forcePushed"}, {"oid": "5cfb880edc5e628d582f5529c6c69c949b822610", "url": "https://github.com/ankidroid/Anki-Android/commit/5cfb880edc5e628d582f5529c6c69c949b822610", "message": "NF: processNodes don't need depth variable", "committedDate": "2020-06-24T19:22:28Z", "type": "forcePushed"}, {"oid": "f87580d38db17cbcf6a5c4245e2012945de72984", "url": "https://github.com/ankidroid/Anki-Android/commit/f87580d38db17cbcf6a5c4245e2012945de72984", "message": "NF: compute loop size outside of loop", "committedDate": "2020-06-24T21:35:49Z", "type": "commit"}, {"oid": "19137685dd646f8bd0056075198b28984485d9da", "url": "https://github.com/ankidroid/Anki-Android/commit/19137685dd646f8bd0056075198b28984485d9da", "message": "NF: rename getNamePart into getDeckNameComponent\n\nI don't know why and how the wrong name was commited into master", "committedDate": "2020-06-24T21:39:07Z", "type": "commit"}, {"oid": "6612016658e5d458273f3ca1d435ade06d64906d", "url": "https://github.com/ankidroid/Anki-Android/commit/6612016658e5d458273f3ca1d435ade06d64906d", "message": "NF: processNodes don't need depth variable", "committedDate": "2020-06-24T21:40:53Z", "type": "forcePushed"}, {"oid": "fe384112ffda10d7b3de54190495f7affe51ac58", "url": "https://github.com/ankidroid/Anki-Android/commit/fe384112ffda10d7b3de54190495f7affe51ac58", "message": "NF: processNodes don't need depth variable", "committedDate": "2020-06-24T21:42:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg1NzM0MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6538#discussion_r445857340", "bodyText": "(this comment was duplicated below in your commit for Sched, for SchedV2 it was missing before so nothing to do there)\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // Compose the \"children\" node list. The children is a list of all the nodes that proceed\n          \n          \n            \n                        // the current one that contain the same name[0], except for the current one itself.\n          \n          \n            \n                        // I.e., they are subdecks that stem from this node.\n          \n          \n            \n                        // This is our version of python's itertools.groupby.", "author": "mikehardy", "createdAt": "2020-06-25T21:47:40Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sched/Sched.java", "diffHunk": "@@ -245,21 +245,27 @@ private void unburyCardsForDeck(List<Long> allDecks) {\n \n \n     @Override\n-    protected List<DeckDueTreeNode> _groupChildrenMain(List<DeckDueTreeNode> grps) {\n+    protected List<DeckDueTreeNode> _groupChildrenMain(List<DeckDueTreeNode> grps, int depth) {\n         List<DeckDueTreeNode> tree = new ArrayList<>();\n         // group and recurse\n         ListIterator<DeckDueTreeNode> it = grps.listIterator();\n         while (it.hasNext()) {\n             DeckDueTreeNode node = it.next();\n-            String head = node.getDeckNameComponent(0);\n+            String head = node.getDeckNameComponent(depth);\n             // Compose the \"children\" node list. The children is a list of all the nodes that proceed\n             // the current one that contain the same name[0], except for the current one itself.\n             // I.e., they are subdecks that stem from this node.\n             // This is our version of python's itertools.groupby.", "originalCommit": "bbf24faff866340d6cc2729499f0620f0ee736f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg5ODA0Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6538#discussion_r445898043", "bodyText": "Corrected", "author": "Arthur-Milchior", "createdAt": "2020-06-25T23:50:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg1NzM0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg2Mzg2OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6538#discussion_r445863869", "bodyText": "Wold be nice to have a comment on both of these methods giving an example of what they return", "author": "david-allison-1", "createdAt": "2020-06-25T22:03:07Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sched/AbstractSched.java", "diffHunk": "@@ -230,32 +228,28 @@ public int compareTo(Object other) {\n \n         @Override\n         public String toString() {\n-            return String.format(Locale.US, \"%s, %d, %d, %d, %d, %d, %s\",\n-                    Arrays.toString(mName), mDid, mDepth, mRevCount, mLrnCount, mNewCount, mChildren);\n+            return String.format(Locale.US, \"%s, %d, %d, %d, %d, %s\",\n+                    mName, mDid, mRevCount, mLrnCount, mNewCount, mChildren);\n         }\n \n-        public String[] getNames() {\n+        public String getFullDeckName() {\n             return mName;\n         }\n \n-        public String getNamePart(int part) {\n-            return mName[part];\n+        public String getDeckNameComponent(int part) {", "originalCommit": "fe384112ffda10d7b3de54190495f7affe51ac58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg5NjMwNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6538#discussion_r445896305", "bodyText": "Done", "author": "Arthur-Milchior", "createdAt": "2020-06-25T23:43:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg2Mzg2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg2NjMzOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6538#discussion_r445866339", "bodyText": "Could you @NonNull this", "author": "david-allison-1", "createdAt": "2020-06-25T22:09:36Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sched/AbstractSched.java", "diffHunk": "@@ -178,29 +178,26 @@\n      * this field and use getNamePart(0) for those cases.\n      */\n     public class DeckDueTreeNode implements Comparable {\n-        private String[] mName;\n+        private final String mName;\n+        private final String[] mNameComponents;\n         private long mDid;\n-        private int mDepth;\n         private int mRevCount;\n         private int mLrnCount;\n         private int mNewCount;\n         private List<DeckDueTreeNode> mChildren = new ArrayList<>();", "originalCommit": "fe384112ffda10d7b3de54190495f7affe51ac58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg5Njk5Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6538#discussion_r445896993", "bodyText": "I could, and this would be true with current code. However, I believe that it is actually a bad idea. Because children are not always set, and I believe that until we actually know whether there are children or not, it would make more sens to let the value be null than be an empty list. I didn't make this change in the code mostly because I didn't need it in any way for my goal of loading the deck picker faster on launch", "author": "Arthur-Milchior", "createdAt": "2020-06-25T23:46:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg2NjMzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwNjY0Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6538#discussion_r445906643", "bodyText": "I thought it was set implicitly in both constructors?", "author": "david-allison-1", "createdAt": "2020-06-26T00:22:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg2NjMzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg2Njc3MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6538#discussion_r445866771", "bodyText": "Do we have the Android API to use Comparable<T> here?", "author": "david-allison-1", "createdAt": "2020-06-25T22:10:43Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sched/AbstractSched.java", "diffHunk": "@@ -178,29 +178,26 @@\n      * this field and use getNamePart(0) for those cases.\n      */\n     public class DeckDueTreeNode implements Comparable {", "originalCommit": "fe384112ffda10d7b3de54190495f7affe51ac58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg5NzY0NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6538#discussion_r445897644", "bodyText": "I don't understand why you're referencing the android API.\nThe scheduler sorts a list of DeckDueTreeNode and uses the fact that the nodes are comparable.\nI can write Comparable<DeckDueTreeNode> if you prefer. I have not touched this line but it would not be hard to add it", "author": "Arthur-Milchior", "createdAt": "2020-06-25T23:48:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg2Njc3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwNjAzOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6538#discussion_r445906038", "bodyText": "I don't understand why you're referencing the android API.\nThe scheduler sorts a list of DeckDueTreeNode and uses the fact that the nodes are comparable.\nI can write Comparable<DeckDueTreeNode> if you prefer. I have not touched this line but it would not be hard to add it\n\nUsually the reason we're not using a \"better\" API is due to us referencing API 16. I was wondering if this was the rationale behind not using the correct Comparable", "author": "david-allison-1", "createdAt": "2020-06-26T00:20:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg2Njc3MQ=="}], "type": "inlineReview"}, {"oid": "665bfdfff617291e88879ed62e41cc630133d1fb", "url": "https://github.com/ankidroid/Anki-Android/commit/665bfdfff617291e88879ed62e41cc630133d1fb", "message": "NF: processNodes don't need depth variable", "committedDate": "2020-06-25T23:43:25Z", "type": "forcePushed"}, {"oid": "46fb40b4fd6f6f83d4386653c895f1e995d6ec10", "url": "https://github.com/ankidroid/Anki-Android/commit/46fb40b4fd6f6f83d4386653c895f1e995d6ec10", "message": "NF: processNodes don't need depth variable", "committedDate": "2020-06-25T23:49:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwNTM0MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6538#discussion_r445905340", "bodyText": "The *s in the comment seems irregular", "author": "david-allison-1", "createdAt": "2020-06-26T00:17:17Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sched/AbstractSched.java", "diffHunk": "@@ -270,10 +286,17 @@ public int getLrnCount() {\n             return mLrnCount;\n         }\n \n+        /** \n+         * @return The children of this deck. Note that they are set\n+         in the * data structure returned by DeckDueTree but are", "originalCommit": "46fb40b4fd6f6f83d4386653c895f1e995d6ec10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkxODM1MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6538#discussion_r445918350", "bodyText": "Thanks", "author": "Arthur-Milchior", "createdAt": "2020-06-26T01:12:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwNTM0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwNTUzNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6538#discussion_r445905535", "bodyText": "A doccomment is for one method, so try to avoid referencing other methods", "author": "david-allison-1", "createdAt": "2020-06-26T00:18:09Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sched/AbstractSched.java", "diffHunk": "@@ -230,34 +228,52 @@ public int compareTo(Object other) {\n \n         @Override\n         public String toString() {\n-            return String.format(Locale.US, \"%s, %d, %d, %d, %d, %d, %s\",\n-                    Arrays.toString(mName), mDid, mDepth, mRevCount, mLrnCount, mNewCount, mChildren);\n+            return String.format(Locale.US, \"%s, %d, %d, %d, %d, %s\",\n+                    mName, mDid, mRevCount, mLrnCount, mNewCount, mChildren);\n         }\n \n-        public String[] getNames() {\n+        /** \n+         * @return The full deck name, e.g. \"A::B::C\"\n+         * */\n+        public String getFullDeckName() {\n             return mName;\n         }\n \n-        public String getNamePart(int part) {\n-            return mName[part];\n+        /** \n+         * For deck \"A::B::C\", `getDeckNameComponent(0)` returns \"A\",\n+         * `getDeckNameComponent(1)` returns \"B\", etc...\n+         */\n+        public String getDeckNameComponent(int part) {\n+            return mNameComponents[part];\n         }\n-        \n-        public void setNames(String[] mName) {\n-            this.mName = mName;\n+\n+        /** \n+         * The part of the name displayed in deck picker, i.e. the\n+         * part that does not belong to its parents. E.g.  for deck\n+         * \"A::B::C\", returns \"C\".\n+         */\n+        public String getLastDeckNameComponent() {\n+            return getDeckNameComponent(getDepth());\n         }\n \n         public long getDid() {\n             return mDid;\n         }\n \n+        /** \n+         * @return The depth of a deck. Top level decks have depth 0,\n+         * their children have depth 1, etc... So \"A::B::C\" would have\n+         * depth 2.\n+         */\n         public int getDepth() {\n-            return mDepth;\n-        }\n-\n-        public void setDepth(int mDepth) {\n-            this.mDepth = mDepth;\n+            return mNameComponents.length - 1;\n         }\n \n+        /** The three following methods return the numbers to be", "originalCommit": "46fb40b4fd6f6f83d4386653c895f1e995d6ec10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwNTU4Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/6538#discussion_r445905586", "bodyText": "Not relevant to the PR, let's remove it", "author": "david-allison-1", "createdAt": "2020-06-26T00:18:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwNTUzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkxODQ1Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6538#discussion_r445918453", "bodyText": "Okay", "author": "Arthur-Milchior", "createdAt": "2020-06-26T01:13:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkwNTUzNQ=="}], "type": "inlineReview"}, {"oid": "4c695bf9f3f178f23a174c4026a9cfa44021e412", "url": "https://github.com/ankidroid/Anki-Android/commit/4c695bf9f3f178f23a174c4026a9cfa44021e412", "message": "NF: DeckDueTree avoid changing names", "committedDate": "2020-06-26T01:35:07Z", "type": "commit"}, {"oid": "e5882cbdd2d0225cbbc516fb246fd9faf712e723", "url": "https://github.com/ankidroid/Anki-Android/commit/e5882cbdd2d0225cbbc516fb246fd9faf712e723", "message": "NF: processNodes don't need depth variable", "committedDate": "2020-06-26T01:35:08Z", "type": "commit"}, {"oid": "e5882cbdd2d0225cbbc516fb246fd9faf712e723", "url": "https://github.com/ankidroid/Anki-Android/commit/e5882cbdd2d0225cbbc516fb246fd9faf712e723", "message": "NF: processNodes don't need depth variable", "committedDate": "2020-06-26T01:35:08Z", "type": "forcePushed"}]}