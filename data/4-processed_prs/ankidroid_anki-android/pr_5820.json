{"pr_number": 5820, "pr_title": "Gracefully handle WebView Crashes", "pr_createdAt": "2020-03-14T18:06:35Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/5820", "timeline": [{"oid": "9cc0244a723bfaa29ca1645da811160b1479a714", "url": "https://github.com/ankidroid/Anki-Android/commit/9cc0244a723bfaa29ca1645da811160b1479a714", "message": "Fix #5780 - WebView OOM Crashes Application\n\nOut of Memory issues in the WebView Renderer (e.g. large fonts)\nwere causing the application to crash and restart, going to the deck\nbrowser.\n\nWe catch the OOM using `onRenderProcessGone()` (API >= 26) and recreate\nthe WebView to allow the application to continue with minor disruption.\n\nIf a card has not been rendered, or if the same card fails twice, we\nfail gracefully and return to the deck browser.", "committedDate": "2020-03-14T18:19:39Z", "type": "commit"}, {"oid": "9cc0244a723bfaa29ca1645da811160b1479a714", "url": "https://github.com/ankidroid/Anki-Android/commit/9cc0244a723bfaa29ca1645da811160b1479a714", "message": "Fix #5780 - WebView OOM Crashes Application\n\nOut of Memory issues in the WebView Renderer (e.g. large fonts)\nwere causing the application to crash and restart, going to the deck\nbrowser.\n\nWe catch the OOM using `onRenderProcessGone()` (API >= 26) and recreate\nthe WebView to allow the application to continue with minor disruption.\n\nIf a card has not been rendered, or if the same card fails twice, we\nfail gracefully and return to the deck browser.", "committedDate": "2020-03-14T18:19:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjYxMjU0NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5820#discussion_r392612545", "bodyText": "\"The application's implementation of this callback should only attempt to clean up the specific WebView given as a parameter, and should not assume that other WebView instances are affected\" doesn't that mean that we can return true? And the right log level would be information?", "author": "mikehardy", "createdAt": "2020-03-14T19:21:48Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java", "diffHunk": "@@ -1541,12 +1554,107 @@ public void onPageFinished(WebView view, String url) {\n                 drawMark();\n                 view.loadUrl(\"javascript:onPageFinished();\");\n             }\n+\n+            /** Fix: #5780 - WebView Renderer OOM crashes reviewer */\n+            @Override\n+            @TargetApi(Build.VERSION_CODES.O)\n+            public boolean onRenderProcessGone(WebView view, RenderProcessGoneDetail detail) {\n+\n+                if (mCard == null || !mCard.equals(view)) {\n+                    //A view crashed that wasn't ours. Unexpected.\n+                    Timber.wtf(\"Unexpected WebView Renderer terminated. Crashed: %b\",  detail.didCrash());\n+                    return false;", "originalCommit": "9cc0244a723bfaa29ca1645da811160b1479a714", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjYxNzQ5OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/5820#discussion_r392617498", "bodyText": "You're correct. Anything that returns false will cause an issue. https://chromium.googlesource.com/chromium/src.git/+/62.0.3178.1/android_webview/browser/aw_browser_terminator.cc?autodive=0%2F%2F#72", "author": "david-allison-1", "createdAt": "2020-03-14T20:37:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjYxMjU0NQ=="}], "type": "inlineReview"}, {"oid": "2253e1e76f7fe681422ba9d91627630efb208af8", "url": "https://github.com/ankidroid/Anki-Android/commit/2253e1e76f7fe681422ba9d91627630efb208af8", "message": "Review: Don't crash on unrelated render failure\n\nDocumentation states we should not try to clean up unrelated instances\nof WebViews.\n\nReturning false will cause a crash. Therefore return true to state\nthat we don't need to crash.", "committedDate": "2020-03-14T21:22:14Z", "type": "commit"}, {"oid": "9e0d75c35a4f1a64acadd7ae74a15910dc1626f7", "url": "https://github.com/ankidroid/Anki-Android/commit/9e0d75c35a4f1a64acadd7ae74a15910dc1626f7", "message": "Converted WebView crash error dialog to toast\n\nIt was an error which showed the card details (id). It's best to allow\nthe user to explicitly dismiss it, as they may want to screenshot the\ndetails.", "committedDate": "2020-03-16T17:14:13Z", "type": "commit"}, {"oid": "a27ebde6b94c94ca8b38dcf1e4a45317a691f245", "url": "https://github.com/ankidroid/Anki-Android/commit/a27ebde6b94c94ca8b38dcf1e4a45317a691f245", "message": "WebView Render crash: Additional fix\n\nSometimes, even after writing a handler, the application crashed.\n\nI believe that the C++ counts Java references when determining what to\ncheck when a WebView process dies. We perform a GC to ensure these are\ncleaned up by the time te C++ executes.", "committedDate": "2020-03-16T17:17:29Z", "type": "commit"}, {"oid": "e2f090db7d59eaf5f81f1734867df00e51aca107", "url": "https://github.com/ankidroid/Anki-Android/commit/e2f090db7d59eaf5f81f1734867df00e51aca107", "message": "NF: Fix Typo", "committedDate": "2020-03-16T17:20:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIyMjYyOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/5820#discussion_r393222628", "bodyText": "Since you return in the other branch of the if, the else seems unnecessary - I have a preference to not use an else in these cases. What I'd prefer is to have the logic that is in the else currently moved out (deleting the else) and a comment that positively asserts the state allowing us to continue executing, e.g. \"If we got here, it's a recoverable crash and the first time on this card, attempt to re-display\", followed by the logic", "author": "mikehardy", "createdAt": "2020-03-16T18:14:20Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java", "diffHunk": "@@ -1541,12 +1554,124 @@ public void onPageFinished(WebView view, String url) {\n                 drawMark();\n                 view.loadUrl(\"javascript:onPageFinished();\");\n             }\n+\n+            /** Fix: #5780 - WebView Renderer OOM crashes reviewer */\n+            @Override\n+            @TargetApi(Build.VERSION_CODES.O)\n+            public boolean onRenderProcessGone(WebView view, RenderProcessGoneDetail detail) {\n+\n+                if (mCard == null || !mCard.equals(view)) {\n+                    //A view crashed that wasn't ours.\n+                    //We have nothing to handle. Returning false is a desire to crash, so return true.\n+                    Timber.i(\"Unrelated WebView Renderer terminated. Crashed: %b\",  detail.didCrash());\n+                    return true;\n+                }\n+\n+                Timber.e(\"WebView Renderer process terminated. Crashed: %b\",  detail.didCrash());\n+\n+                //Destroy the current WebView (to ensure WebView is GCed).\n+                //Otherwise, we get the following error:\n+                //\"crash wasn't handled by all associated webviews, triggering application crash\"\n+                destroyWebView(mCard);\n+                ViewGroup parent = (ViewGroup) mCardFrame.getParent();\n+                parent.removeView(mCardFrame);\n+                mCard = null;\n+                mCardFrame = null;\n+                //Even with the above, I occasionally saw the above error. Manually trigger the GC.\n+                //I'll keep this line unless I see another crash, which would point to another underlying issue.\n+                System.gc();\n+\n+                //We only want to show one message per branch.\n+\n+                //It's not necessarily an OOM crash, false implies a general code which is for \"system terminated\".\n+                int errorCauseId = detail.didCrash() ? R.string.webview_crash_unknown : R.string.webview_crash_oom;\n+                String errorCauseString = getResources().getString(errorCauseId);\n+\n+                if (!canRecoverFromWebViewRendererCrash()) {\n+                    Timber.e(\"Unrecoverable WebView Render crash\");\n+                    String errorMessage = getResources().getString(R.string.webview_crash_fatal, errorCauseString);\n+                    UIUtils.showThemedToast(AbstractFlashcardViewer.this, errorMessage, false);\n+                    finishWithoutAnimation();\n+                    return true;\n+                }\n+\n+                if (webViewRendererLastCrashedOnCard(mCurrentCard.getId())) {\n+                    Timber.e(\"Web Renderer crash loop on card: %d\", mCurrentCard.getId());\n+                    displayRenderLoopDialog(mCurrentCard, detail);\n+                    return true;\n+                } else {", "originalCommit": "e2f090db7d59eaf5f81f1734867df00e51aca107", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIyMzQ3NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5820#discussion_r393223475", "bodyText": "Logs will only tell if you include a log, seems like a Timber.w might apply here as we think we can recover but it is unexpected / unwanted state?", "author": "mikehardy", "createdAt": "2020-03-16T18:15:40Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java", "diffHunk": "@@ -1541,12 +1554,124 @@ public void onPageFinished(WebView view, String url) {\n                 drawMark();\n                 view.loadUrl(\"javascript:onPageFinished();\");\n             }\n+\n+            /** Fix: #5780 - WebView Renderer OOM crashes reviewer */\n+            @Override\n+            @TargetApi(Build.VERSION_CODES.O)\n+            public boolean onRenderProcessGone(WebView view, RenderProcessGoneDetail detail) {\n+\n+                if (mCard == null || !mCard.equals(view)) {\n+                    //A view crashed that wasn't ours.\n+                    //We have nothing to handle. Returning false is a desire to crash, so return true.\n+                    Timber.i(\"Unrelated WebView Renderer terminated. Crashed: %b\",  detail.didCrash());\n+                    return true;\n+                }\n+\n+                Timber.e(\"WebView Renderer process terminated. Crashed: %b\",  detail.didCrash());\n+\n+                //Destroy the current WebView (to ensure WebView is GCed).\n+                //Otherwise, we get the following error:\n+                //\"crash wasn't handled by all associated webviews, triggering application crash\"\n+                destroyWebView(mCard);\n+                ViewGroup parent = (ViewGroup) mCardFrame.getParent();\n+                parent.removeView(mCardFrame);\n+                mCard = null;\n+                mCardFrame = null;\n+                //Even with the above, I occasionally saw the above error. Manually trigger the GC.\n+                //I'll keep this line unless I see another crash, which would point to another underlying issue.\n+                System.gc();\n+\n+                //We only want to show one message per branch.\n+\n+                //It's not necessarily an OOM crash, false implies a general code which is for \"system terminated\".\n+                int errorCauseId = detail.didCrash() ? R.string.webview_crash_unknown : R.string.webview_crash_oom;\n+                String errorCauseString = getResources().getString(errorCauseId);\n+\n+                if (!canRecoverFromWebViewRendererCrash()) {\n+                    Timber.e(\"Unrecoverable WebView Render crash\");\n+                    String errorMessage = getResources().getString(R.string.webview_crash_fatal, errorCauseString);\n+                    UIUtils.showThemedToast(AbstractFlashcardViewer.this, errorMessage, false);\n+                    finishWithoutAnimation();\n+                    return true;\n+                }\n+\n+                if (webViewRendererLastCrashedOnCard(mCurrentCard.getId())) {\n+                    Timber.e(\"Web Renderer crash loop on card: %d\", mCurrentCard.getId());\n+                    displayRenderLoopDialog(mCurrentCard, detail);\n+                    return true;\n+                } else {\n+                    // This logic may need to be better defined. The card could have changed by the time we get here.\n+                    lastCrashingCardId = mCurrentCard.getId();\n+                }\n+\n+                String nonFatalError = getResources().getString(R.string.webview_crash_nonfatal, errorCauseString);\n+                UIUtils.showThemedToast(AbstractFlashcardViewer.this, nonFatalError, false);\n+\n+                //inflate a new instance of mCardFrame\n+                mCardFrame = inflateNewView(R.id.flashcard);\n+                parent.addView(mCardFrame);\n+\n+                recreateWebView();\n+                displayCardQuestion();\n+\n+                //We handled the crash and can continue.\n+                return true;\n+            }\n+\n+\n+            @TargetApi(Build.VERSION_CODES.O)\n+            private void displayRenderLoopDialog(Card mCurrentCard, RenderProcessGoneDetail detail) {\n+                String cardInformation = Long.toString(mCurrentCard.getId());\n+                Resources res = getResources();\n+\n+                String errorDetails = detail.didCrash()\n+                        ? res.getString(R.string.webview_crash_unknwon_detailed)\n+                        : res.getString(R.string.webview_crash_oom_details);\n+                new MaterialDialog.Builder(AbstractFlashcardViewer.this)\n+                        .title(res.getString(R.string.webview_crash_loop_dialog_title))\n+                        .content(res.getString(R.string.webview_crash_loop_dialog_content, cardInformation, errorDetails))\n+                        .positiveText(R.string.dialog_ok)\n+                        .onPositive((materialDialog, dialogAction) -> finishWithoutAnimation())\n+                        .show();\n+            }\n         });\n         // Set transparent color to prevent flashing white when night mode enabled\n         webView.setBackgroundColor(Color.argb(1, 0, 0, 0));\n         return webView;\n     }\n \n+    private boolean webViewRendererLastCrashedOnCard(long cardId) {\n+        return lastCrashingCardId != null && lastCrashingCardId == cardId;\n+    }\n+\n+\n+    private boolean canRecoverFromWebViewRendererCrash() {\n+        // DEFECT\n+        // If we don't have a card to render, we're in a bad state. The class doesn't currently track state\n+        // well enough to be able to know exactly where we are in the initialisation pipeline.\n+        // so it's best to mark the crash as non-recoverable.\n+        // We should fix this, but it's very unlikely that we'll ever get here. Logs will tell", "originalCommit": "e2f090db7d59eaf5f81f1734867df00e51aca107", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIzMTIzNA==", "url": "https://github.com/ankidroid/Anki-Android/pull/5820#discussion_r393231234", "bodyText": "Done at the call site\nTimber.e(\"Unrecoverable WebView Render crash\");", "author": "david-allison-1", "createdAt": "2020-03-16T18:29:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIyMzQ3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIyNDMyNw==", "url": "https://github.com/ankidroid/Anki-Android/pull/5820#discussion_r393224327", "bodyText": "I'm not sure you intend for this line to remain here? seems like it would crash any time we showed answer, and is likely just for local testing?", "author": "mikehardy", "createdAt": "2020-03-16T18:17:14Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java", "diffHunk": "@@ -2026,6 +2155,7 @@ protected String cleanTypedAnswer(String answer) {\n \n     protected void displayCardAnswer() {\n         Timber.d(\"displayCardAnswer()\");\n+        crashWebViewRenderer();", "originalCommit": "e2f090db7d59eaf5f81f1734867df00e51aca107", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIzMDIzOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5820#discussion_r393230239", "bodyText": "\ud83e\udd26\u200d\u2642", "author": "david-allison-1", "createdAt": "2020-03-16T18:27:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIyNDMyNw=="}], "type": "inlineReview"}, {"oid": "2c8f145a9cc0e2d30d6e3de456e714db71475e73", "url": "https://github.com/ankidroid/Anki-Android/commit/2c8f145a9cc0e2d30d6e3de456e714db71475e73", "message": "Fix accidental testing code insertion", "committedDate": "2020-03-16T18:31:34Z", "type": "commit"}, {"oid": "8e748b1895b6372c85033c75dee0036436006084", "url": "https://github.com/ankidroid/Anki-Android/commit/8e748b1895b6372c85033c75dee0036436006084", "message": "Review Change: Coding style", "committedDate": "2020-03-16T18:33:47Z", "type": "commit"}]}