{"pr_number": 6804, "pr_title": "Indicator for unsynced local changes", "pr_createdAt": "2020-08-03T23:32:37Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6804", "timeline": [{"oid": "655f6af757a1d146a1943af992d3b9407f6f4bb7", "url": "https://github.com/ankidroid/Anki-Android/commit/655f6af757a1d146a1943af992d3b9407f6f4bb7", "message": "Add badging functionality for App Bar MenuItems\n\nThis allows textual/colourful badges for items in the app bar\n\nTo be trialed with a badge for unsynced changes in 3524", "committedDate": "2020-08-03T21:57:38Z", "type": "commit"}, {"oid": "4cb4bd7fbef9de0007095dbdbbffa15d830f7768", "url": "https://github.com/ankidroid/Anki-Android/commit/4cb4bd7fbef9de0007095dbdbbffa15d830f7768", "message": "DeckPicker: no pending sync if deck changed\n\nThe UI is better if it only shows worthwhile changes\notherwise users will ignore it", "committedDate": "2020-08-03T23:49:24Z", "type": "forcePushed"}, {"oid": "0f08b85a92105fe003cf604be90d20aa160c6588", "url": "https://github.com/ankidroid/Anki-Android/commit/0f08b85a92105fe003cf604be90d20aa160c6588", "message": "DeckPicker: no pending sync icon if deck changed\n\nThe UI is better if it only shows worthwhile changes\notherwise users will ignore it", "committedDate": "2020-08-03T23:50:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcxOTMwMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6804#discussion_r464719301", "bodyText": "doesn't seem \"web\"-y to me, seems more utils-y to me ? Shame all the boilerplate is necessary!", "author": "mikehardy", "createdAt": "2020-08-03T23:46:23Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/web/DatabaseChangeDecorator.java", "diffHunk": "@@ -0,0 +1,281 @@\n+/*\n+ Copyright (c) 2020 David Allison <davidallisongithub@gmail.com>\n+\n+ This program is free software; you can redistribute it and/or modify it under\n+ the terms of the GNU General Public License as published by the Free Software\n+ Foundation; either version 3 of the License, or (at your option) any later\n+ version.\n+\n+ This program is distributed in the hope that it will be useful, but WITHOUT ANY\n+ WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A\n+ PARTICULAR PURPOSE. See the GNU General Public License for more details.\n+\n+ You should have received a copy of the GNU General Public License along with\n+ this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package com.ichi2.anki.web;", "originalCommit": "ec3bfde588c0531ad4f3978983005914873156f3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcxOTQ3MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6804#discussion_r464719470", "bodyText": "also maybe Utils-y ?", "author": "mikehardy", "createdAt": "2020-08-03T23:47:04Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/SyncStatus.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ Copyright (c) 2020 David Allison <davidallisongithub@gmail.com>\n+\n+ This program is free software; you can redistribute it and/or modify it under\n+ the terms of the GNU General Public License as published by the Free Software\n+ Foundation; either version 3 of the License, or (at your option) any later\n+ version.\n+\n+ This program is distributed in the hope that it will be useful, but WITHOUT ANY\n+ WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A\n+ PARTICULAR PURPOSE. See the GNU General Public License for more details.\n+\n+ You should have received a copy of the GNU General Public License along with\n+ this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package com.ichi2.anki;", "originalCommit": "d02246b56b13ce29f52eaf954617875cb6b9025f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcyMDIyNw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6804#discussion_r464720227", "bodyText": "I'd prefer if this sort of stuff was in the Compat infrastructure so we didn't spread the API-dependent conditionals across the codebase. Not sure how to do that well when there are related public methods like here though \ud83e\udd14 might be this is as good as it gets and we already have to do a full code scan for API codes anyway, so maybe just think about it for a timebox of no more than two minutes, and leave as is if it doesn't seem easy to fit into Compat/CompatV16/CompatV23", "author": "mikehardy", "createdAt": "2020-08-03T23:49:52Z", "path": "AnkiDroid/src/main/java/com/ichi2/ui/BadgeDrawableBuilder.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ Copyright (c) 2020 David Allison <davidallisongithub@gmail.com>\n+\n+ This program is free software; you can redistribute it and/or modify it under\n+ the terms of the GNU General Public License as published by the Free Software\n+ Foundation; either version 3 of the License, or (at your option) any later\n+ version.\n+\n+ This program is distributed in the hope that it will be useful, but WITHOUT ANY\n+ WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A\n+ PARTICULAR PURPOSE. See the GNU General Public License for more details.\n+\n+ You should have received a copy of the GNU General Public License along with\n+ this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package com.ichi2.ui;\n+\n+import android.content.res.Resources;\n+import android.graphics.drawable.Drawable;\n+import android.os.Build;\n+import android.view.MenuItem;\n+\n+import com.ichi2.anki.R;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.core.graphics.drawable.DrawableCompat;\n+import androidx.vectordrawable.graphics.drawable.VectorDrawableCompat;\n+import timber.log.Timber;\n+\n+public class BadgeDrawableBuilder {\n+    private final Resources mResources;\n+    private char mChar;\n+    private Integer mColor;\n+\n+\n+    public BadgeDrawableBuilder(@NonNull Resources resources) {\n+        mResources = resources;\n+    }\n+\n+\n+    public static void removeBadge(MenuItem menuItem) {\n+        if (android.os.Build.VERSION.SDK_INT < Build.VERSION_CODES.M) {\n+            return;", "originalCommit": "655f6af757a1d146a1943af992d3b9407f6f4bb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcyNDMxMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6804#discussion_r464724311", "bodyText": "I couldn't and can't see a way to make this fit in as we inherit from an API23+ class - the conditionals are (nicely) hidden away in the Builder so they won't be seen by consumers, but it's still unpleasant.", "author": "david-allison-1", "createdAt": "2020-08-04T00:04:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcyMDIyNw=="}], "type": "inlineReview"}, {"oid": "167ac7859f106f405cb4d1fb8ac0fdfa24513297", "url": "https://github.com/ankidroid/Anki-Android/commit/167ac7859f106f405cb4d1fb8ac0fdfa24513297", "message": "DeckPicker: no pending sync icon if deck changed\n\nThe UI is better if it only shows worthwhile changes\notherwise users will ignore it", "committedDate": "2020-08-04T00:15:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcyODY2MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6804#discussion_r464728660", "bodyText": "Also flagging - static state is typically something to be avoided, but we'd need DI to solve it.", "author": "david-allison-1", "createdAt": "2020-08-04T00:20:14Z", "path": "AnkiDroid/src/main/java/com/ichi2/utils/SyncStatus.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/*\n+ Copyright (c) 2020 David Allison <davidallisongithub@gmail.com>\n+\n+ This program is free software; you can redistribute it and/or modify it under\n+ the terms of the GNU General Public License as published by the Free Software\n+ Foundation; either version 3 of the License, or (at your option) any later\n+ version.\n+\n+ This program is distributed in the hope that it will be useful, but WITHOUT ANY\n+ WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A\n+ PARTICULAR PURPOSE. See the GNU General Public License for more details.\n+\n+ You should have received a copy of the GNU General Public License along with\n+ this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package com.ichi2.utils;\n+\n+import android.content.SharedPreferences;\n+\n+import com.ichi2.anki.AnkiDroidApp;\n+import com.ichi2.libanki.Collection;\n+import com.ichi2.utils.FunctionalInterfaces.Supplier;\n+\n+import androidx.annotation.NonNull;\n+\n+public enum SyncStatus {\n+    INCONCLUSIVE,\n+    NO_ACCOUNT,\n+    NO_CHANGES,\n+    HAS_CHANGES,\n+    FULL_SYNC;\n+\n+    private static boolean sPauseCheckingDatabase = false;", "originalCommit": "167ac7859f106f405cb4d1fb8ac0fdfa24513297", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc0MDk5MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6804#discussion_r464740990", "bodyText": "I'm okay with it when needed", "author": "mikehardy", "createdAt": "2020-08-04T01:07:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcyODY2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcyOTMwMg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6804#discussion_r464729302", "bodyText": "@mikehardy Bikeshedding - but I'd actually like to move these new additions out of \"Network.xml\", and use a \"Sync\" string for the DeckPicker, would that be OK with you?\nIt's used in a few places (dialog, notification channel name and the action item) and I feel the action item would be best named \"Sync\"\nEDIT: Done, TBC if it's appropriate. Maybe they should be in \"core\"?", "author": "david-allison-1", "createdAt": "2020-08-04T00:22:27Z", "path": "AnkiDroid/src/main/res/values/04-network.xml", "diffHunk": "@@ -62,6 +62,8 @@\n     <string name=\"sync_uploading_message\">Uploading\u2026</string>\n     <string name=\"sync_downloading_message\">Downloading\u2026</string>\n     <string name=\"sync_title\">Synchronization</string>\n+    <string name=\"sync_title_full_sync\">Sync (full)</string>", "originalCommit": "167ac7859f106f405cb4d1fb8ac0fdfa24513297", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b72fc1a4c6894550c5214cc381655473a3ef4d4b", "url": "https://github.com/ankidroid/Anki-Android/commit/b72fc1a4c6894550c5214cc381655473a3ef4d4b", "message": "DeckPicker: Added badge for unsynced changes\n\nNote: This does not yet handle normal syncs - only no account or full syncs\n\nThis also changes the default menu name from \"Synchronization\" to \"Sync\"\n\nFixes 3524", "committedDate": "2020-08-04T00:33:49Z", "type": "commit"}, {"oid": "319f95f1dbcedca8caaa0b9f516897aef9a0691f", "url": "https://github.com/ankidroid/Anki-Android/commit/319f95f1dbcedca8caaa0b9f516897aef9a0691f", "message": "Unsynced changes badge - handle regular changes\n\nWe implement this by listening to the database and triggering a flag if any\nmodifications are detected via SQL.\n\nThis is similar to DB.java, but works at a lower level, as we\noften call getDb().getDatabase()\n\n_recoverOrphans has an update which generally does nothing\nAs it's performed when the DeckPicker is loaded, we don't want this\nto set the preference\n\nFixes 3524", "committedDate": "2020-08-04T00:33:52Z", "type": "commit"}, {"oid": "677831e94aa2cbd83284a305cf9cb88050e78f4f", "url": "https://github.com/ankidroid/Anki-Android/commit/677831e94aa2cbd83284a305cf9cb88050e78f4f", "message": "DeckPicker: no pending sync icon if deck changed\n\nThe UI is better if it only shows worthwhile changes\notherwise users will ignore it", "committedDate": "2020-08-04T00:33:52Z", "type": "commit"}, {"oid": "677831e94aa2cbd83284a305cf9cb88050e78f4f", "url": "https://github.com/ankidroid/Anki-Android/commit/677831e94aa2cbd83284a305cf9cb88050e78f4f", "message": "DeckPicker: no pending sync icon if deck changed\n\nThe UI is better if it only shows worthwhile changes\notherwise users will ignore it", "committedDate": "2020-08-04T00:33:52Z", "type": "forcePushed"}]}