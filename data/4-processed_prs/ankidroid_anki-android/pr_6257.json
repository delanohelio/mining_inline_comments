{"pr_number": 6257, "pr_title": "string consisting only of whitespace does not generate card (Previously NF: clean _renderQA)", "pr_createdAt": "2020-05-22T22:46:55Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6257", "timeline": [{"oid": "378024856e7bb75a12fa09049c1c6cf78de79e28", "url": "https://github.com/ankidroid/Anki-Android/commit/378024856e7bb75a12fa09049c1c6cf78de79e28", "message": "NF: remove unused variable nid", "committedDate": "2020-06-03T09:20:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQzMDM1NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6257#discussion_r434430355", "bodyText": "Issue found: Avoid long parameter lists.", "author": "timrae", "createdAt": "2020-06-03T09:23:45Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -1007,38 +1007,39 @@ public void updateFieldCache(long[] nids) {\n     /**\n      * Returns hash of id, question, answer.\n      */\n-    public HashMap<String, String> _renderQA(Object[] data) {\n-        return _renderQA(data, false, null, null);\n+    public HashMap<String, String> _renderQA(long cid, long mid, long did, int ord, String tags, String packedFields, int flags) {\n+        return _renderQA(cid, mid, did, ord, tags, packedFields, flags, false, null, null);\n     }\n \n-    public HashMap<String, String> _renderQA(Object[] data, boolean browser, String qfmt, String afmt) {\n+\n+    public HashMap<String, String> _renderQA(long cid, long mid, long did, int ord, String tags, String packedFields, int flags, boolean browser, String qfmt, String afmt) {", "originalCommit": "378024856e7bb75a12fa09049c1c6cf78de79e28", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg1MDE1MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6257#discussion_r438850151", "bodyText": "String.class should be faster than new String[a.size()] as it removes the array allocation", "author": "david-allison-1", "createdAt": "2020-06-11T14:59:21Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Models.java", "diffHunk": "@@ -987,11 +987,13 @@ private void _updateRequired(JSONObject m) {\n             b.add(\"\");\n         }\n         Object[] data;\n-        data = new Object[] {1L, 1L, m.getLong(\"id\"), 1L, t.getInt(\"ord\"), \"\",\n-                             Utils.joinFields(a.toArray(new String[a.size()])), 0};\n+        Long mid = m.getLong(\"id\");\n+        int ord = t.getInt(\"ord\");\n+        String packedFields = Utils.joinFields(a.toArray(new String[a.size()]));", "originalCommit": "2b43e8effe2a279133fc07373a4b81b1d044e98b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk2MDIyNw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6257#discussion_r438960227", "bodyText": "I don't know what String.class is.\nI should note that the array allocation was already here before, so your remark is probably relevant, whether or not this PR is accepted.", "author": "Arthur-Milchior", "createdAt": "2020-06-11T17:43:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg1MDE1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAwMzIwOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6257#discussion_r439003208", "bodyText": "Hmm... I could have sworn that you could pass in a class instance to obtain a faster array copy.\nAnyway, there's a similar recommended refactoring at the call site which should unintuitively increase performance: https://stackoverflow.com/a/29444594/13121290\nb.toArray(new String[b.size()])\nto:\nb.toArray(new String[0])", "author": "david-allison-1", "createdAt": "2020-06-11T18:56:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg1MDE1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkxNjM0Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6257#discussion_r438916342", "bodyText": "Architecturally better as a class, probably bad for performance though.", "author": "david-allison-1", "createdAt": "2020-06-11T16:27:53Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -1007,21 +1007,14 @@ public void updateFieldCache(long[] nids) {\n     /**\n      * Returns hash of id, question, answer.\n      */\n-    public HashMap<String, String> _renderQA(Object[] data) {\n-        return _renderQA(data, false, null, null);\n+    public HashMap<String, String> _renderQA(long cid, long nid, long mid, long did, int ord, String tags, String packedFields, int flags) {\n+        return _renderQA(cid, nid, mid, did, ord, tags, packedFields, flags, false, null, null);\n     }\n \n-    public HashMap<String, String> _renderQA(Object[] data, boolean browser, String qfmt, String afmt) {\n+\n+    public HashMap<String, String> _renderQA(long cid, long nid, long mid, long did, int ord, String tags, String packedFields, int flags, boolean browser, String qfmt, String afmt) {", "originalCommit": "91fdeb6bcd634fa0c11c18dcc87c4dc32641985b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7ce763dd8fda99d212f7ff234f6061b5df2e4585", "url": "https://github.com/ankidroid/Anki-Android/commit/7ce763dd8fda99d212f7ff234f6061b5df2e4585", "message": "NF: _renderQA took an array of string", "committedDate": "2020-06-11T20:18:15Z", "type": "forcePushed"}, {"oid": "5d5b0433669cf1e9b938f7f9bea49ef91bdcf75e", "url": "https://github.com/ankidroid/Anki-Android/commit/5d5b0433669cf1e9b938f7f9bea49ef91bdcf75e", "message": "NF: _renderQA took an array of string", "committedDate": "2020-06-11T22:15:00Z", "type": "forcePushed"}, {"oid": "6e69a83cf22acbe01e9c4eaa0a8c417c73936f4c", "url": "https://github.com/ankidroid/Anki-Android/commit/6e69a83cf22acbe01e9c4eaa0a8c417c73936f4c", "message": "NF: _renderQA took an array of string", "committedDate": "2020-06-13T20:54:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYzMzU5Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6257#discussion_r441633592", "bodyText": "The previous code did nothing, which was likely a bug. This performs a mutation.", "author": "david-allison-1", "createdAt": "2020-06-17T15:26:12Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Models.java", "diffHunk": "@@ -1060,27 +1052,26 @@ private void _updateRequired(JSONObject m) {\n         type = \"any\";\n         req = new JSONArray();\n         for (int i = 0; i < flds.size(); i++) {\n-            tmp.clear();\n-            tmp.addAll(b);\n-            tmp.set(i, \"1\");\n-            data[6] = Utils.joinFields(tmp.toArray(new String[tmp.size()]));\n+            b[i] = \"1\";\n             // if not the same as empty, this field can make the card non-blank\n-            if (!mCol._renderQA(data).get(\"q\").equals(empty)) {\n+            if (!mCol._renderQA(1L, m, 1L, ord, \"\", b, 0).get(\"q\").equals(empty)) {\n                 req.put(i);\n             }\n+            b[i] = \"\";\n         }\n         return new Object[] { type, req };\n     }\n \n \n     /** Given a joined field string, return available template ordinals */\n-    public ArrayList<Integer> availOrds(JSONObject m, String flds) {\n+    public ArrayList<Integer> availOrds(JSONObject m, String[] sfld) {\n         if (m.getInt(\"type\") == Consts.MODEL_CLOZE) {\n-            return _availClozeOrds(m, flds);\n+            return _availClozeOrds(m, sfld);\n         }\n-        String[] fields = Utils.splitFields(flds);\n-        for (String f : fields) {\n-            f = f.trim();\n+        int nbField = sfld.length;\n+        String[] fields = new String[nbField];\n+        for (int i = 0; i < nbField; i++) {\n+            fields[i] = sfld[i].trim();", "originalCommit": "6e69a83cf22acbe01e9c4eaa0a8c417c73936f4c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY3NTM5Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6257#discussion_r441675393", "bodyText": "I did not even realized, but yeah, it was clearly a bug. It means that if there was a field which only contained whitespace, new line, etc... it would allow a card to be generated, while upstream would not generate the card. That's interesting that it was never discovered as a problem.\nDo you want me to leave the bug and correct it in another PR ? Do you want me to just remove the \"NF\" since it's not actually NF.\nNice catch anyway.", "author": "Arthur-Milchior", "createdAt": "2020-06-17T16:31:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYzMzU5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY4NjE2OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6257#discussion_r441686168", "bodyText": "No need for another PR, I'm happy if you're happy to mark the bugfix", "author": "david-allison-1", "createdAt": "2020-06-17T16:48:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYzMzU5Mg=="}], "type": "inlineReview"}, {"oid": "f5accbabab1cd6ace54048d0ec4743593b681ef3", "url": "https://github.com/ankidroid/Anki-Android/commit/f5accbabab1cd6ace54048d0ec4743593b681ef3", "message": "NF: remove a line", "committedDate": "2020-06-17T16:52:10Z", "type": "commit"}, {"oid": "08f1fb909e971e9d75aee5773833fcaa86d28a62", "url": "https://github.com/ankidroid/Anki-Android/commit/08f1fb909e971e9d75aee5773833fcaa86d28a62", "message": "NF: introducing a variable did", "committedDate": "2020-06-17T16:52:10Z", "type": "commit"}, {"oid": "6d50227e99faed50b6975035c9a5a25c3c55d30a", "url": "https://github.com/ankidroid/Anki-Android/commit/6d50227e99faed50b6975035c9a5a25c3c55d30a", "message": "NF: in Models: use variable", "committedDate": "2020-06-17T16:52:10Z", "type": "commit"}, {"oid": "70f7d541720b156717a69c770b01581c6d2bf017", "url": "https://github.com/ankidroid/Anki-Android/commit/70f7d541720b156717a69c770b01581c6d2bf017", "message": "NF: _renderQA: uses explicit variable name", "committedDate": "2020-06-17T16:52:10Z", "type": "commit"}, {"oid": "d0ed0d6aaec811c0ef49fe034b31e6bb6ba2698b", "url": "https://github.com/ankidroid/Anki-Android/commit/d0ed0d6aaec811c0ef49fe034b31e6bb6ba2698b", "message": "NF: _renderQA takes explicit argument", "committedDate": "2020-06-17T16:52:10Z", "type": "commit"}, {"oid": "9871399c7b2fa65ddba26f4f3abf694637a51da7", "url": "https://github.com/ankidroid/Anki-Android/commit/9871399c7b2fa65ddba26f4f3abf694637a51da7", "message": "NF: remove unused variable nid", "committedDate": "2020-06-17T16:52:10Z", "type": "commit"}, {"oid": "5bb03a904b06a68b9f628bf3769ca9a698eb00a2", "url": "https://github.com/ankidroid/Anki-Android/commit/5bb03a904b06a68b9f628bf3769ca9a698eb00a2", "message": "NF: Avoid recreating tmp", "committedDate": "2020-06-17T16:52:10Z", "type": "commit"}, {"oid": "e6501b95c8471f9fc2bcd67cf96cc793a7f98951", "url": "https://github.com/ankidroid/Anki-Android/commit/e6501b95c8471f9fc2bcd67cf96cc793a7f98951", "message": "NF: remove variable tmp", "committedDate": "2020-06-17T16:52:10Z", "type": "commit"}, {"oid": "913f06b5cf85dc1610ebf020c926192aecbbe259", "url": "https://github.com/ankidroid/Anki-Android/commit/913f06b5cf85dc1610ebf020c926192aecbbe259", "message": "NF: uses array directly\n\nI do not know why, in f40a71d1244c09f14145baf112b2bb8c60c109f0, array\nlists were used and were always transformed into array.\n\nI have no reason to believe it is an actual performance trouble,\nespecially since this is executed only when note type are changed,\nbut to please\nhttps://github.com/ankidroid/Anki-Android/pull/6257/files/456cf7b42132a70c0e346c6bd996f2b3960ea1c4..2b43e8effe2a279133fc07373a4b81b1d044e98b#r438850151\nhere I make it more efficient by using arrays directly.", "committedDate": "2020-06-17T16:52:10Z", "type": "commit"}, {"oid": "31a59290c6c252470f68d74a2d0501d357e9237e", "url": "https://github.com/ankidroid/Anki-Android/commit/31a59290c6c252470f68d74a2d0501d357e9237e", "message": "NF: _availClozeOrds takes an array of string", "committedDate": "2020-06-17T16:52:10Z", "type": "commit"}, {"oid": "6da049e52ecd3e3d1b43f1d8700193fa4abac2fd", "url": "https://github.com/ankidroid/Anki-Android/commit/6da049e52ecd3e3d1b43f1d8700193fa4abac2fd", "message": "Bug correction: save trimming result\n\nCurrently, we differ from upstream, by trimming field content but not\nsaving the result. This is corrected.\n\nThis mean that if some field contains only whitespace, it used to be\nusable to generate a card, and no it won't be usable anymore. Doing\nthis, we follow upstream, and there is a risk we break some user card\nif they relayed on this specific feature.", "committedDate": "2020-06-17T16:57:41Z", "type": "commit"}, {"oid": "d69222c9203a895e071aa68f4cedfa4a503c8e92", "url": "https://github.com/ankidroid/Anki-Android/commit/d69222c9203a895e071aa68f4cedfa4a503c8e92", "message": "NF: _availClozeOrds takes an array of string", "committedDate": "2020-06-17T17:00:29Z", "type": "commit"}, {"oid": "053c3878daaaf35c65c10a46a5842a0a592afd32", "url": "https://github.com/ankidroid/Anki-Android/commit/053c3878daaaf35c65c10a46a5842a0a592afd32", "message": "NF: availOrds take an array of string", "committedDate": "2020-06-17T17:01:03Z", "type": "commit"}, {"oid": "859551de98a6ee19dcdad5b09772eb50788ea78d", "url": "https://github.com/ankidroid/Anki-Android/commit/859551de98a6ee19dcdad5b09772eb50788ea78d", "message": "NF: _renderQA took an array of string", "committedDate": "2020-06-17T17:01:03Z", "type": "commit"}, {"oid": "859551de98a6ee19dcdad5b09772eb50788ea78d", "url": "https://github.com/ankidroid/Anki-Android/commit/859551de98a6ee19dcdad5b09772eb50788ea78d", "message": "NF: _renderQA took an array of string", "committedDate": "2020-06-17T17:01:03Z", "type": "forcePushed"}]}