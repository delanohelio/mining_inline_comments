{"pr_number": 6597, "pr_title": "Save current card", "pr_createdAt": "2020-07-01T01:00:08Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6597", "timeline": [{"oid": "7dbc2f9bf22dcbc3957d0323ce86a130206916ff", "url": "https://github.com/ankidroid/Anki-Android/commit/7dbc2f9bf22dcbc3957d0323ce86a130206916ff", "message": "Copy variables before checking for null\n\nSince those variables may be set to null, there is a run of a\nNullPointerException due to concurrent access. This commit should\navoid it.", "committedDate": "2020-07-01T01:59:14Z", "type": "forcePushed"}, {"oid": "39264d1d240d1ba14590b954369eae550207420e", "url": "https://github.com/ankidroid/Anki-Android/commit/39264d1d240d1ba14590b954369eae550207420e", "message": "Copy variables before checking for null\n\nSince those variables may be set to null, there is a run of a\nNullPointerException due to concurrent access. This commit should\navoid it.", "committedDate": "2020-07-01T03:37:05Z", "type": "forcePushed"}, {"oid": "12c98099eca2598bed4faf523fe787e11d51d1c1", "url": "https://github.com/ankidroid/Anki-Android/commit/12c98099eca2598bed4faf523fe787e11d51d1c1", "message": "Copy variables before checking for null\n\nSince those variables may be set to null, there is a run of a\nNullPointerException due to concurrent access. This commit should\navoid it.", "committedDate": "2020-07-01T16:00:53Z", "type": "forcePushed"}, {"oid": "5483f5078b9bd6fa24bd41013a5224e36917bc79", "url": "https://github.com/ankidroid/Anki-Android/commit/5483f5078b9bd6fa24bd41013a5224e36917bc79", "message": "Copy variables before checking for null\n\nSince those variables may be set to null, there is a run of a\nNullPointerException due to concurrent access. This commit should\navoid it.", "committedDate": "2020-07-01T16:13:52Z", "type": "forcePushed"}, {"oid": "7b12724558f40787cbf90e3c96e448f3ba76ed59", "url": "https://github.com/ankidroid/Anki-Android/commit/7b12724558f40787cbf90e3c96e448f3ba76ed59", "message": "Copy variables before checking for null\n\nSince those variables may be set to null, there is a run of a\nNullPointerException due to concurrent access. This commit should\navoid it.", "committedDate": "2020-07-01T16:20:41Z", "type": "forcePushed"}, {"oid": "e8bc745448d60a91256d95038a768f97aa8658ad", "url": "https://github.com/ankidroid/Anki-Android/commit/e8bc745448d60a91256d95038a768f97aa8658ad", "message": "Copy variables before checking for null\n\nSince those variables may be set to null, there is a run of a\nNullPointerException due to concurrent access. This commit should\navoid it.", "committedDate": "2020-07-01T17:49:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyNDgxMw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6597#discussion_r448524813", "bodyText": "can this be moved inside the scheduler?", "author": "david-allison-1", "createdAt": "2020-07-01T17:51:27Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java", "diffHunk": "@@ -3057,6 +3063,7 @@ protected void onFlag(Card card, @FlagDef int flag) {\n \n     protected void dismiss(Collection.DismissType type) {\n         blockControls(false);\n+        mSched.discardCurrentCard();", "originalCommit": "e8bc745448d60a91256d95038a768f97aa8658ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0MzMwNw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6597#discussion_r448543307", "bodyText": "On second thought, seems useless now that \"reset\" change the current card. After all, after each dismiss, sched.deferReset() is called in doInBackgroundDismissNote", "author": "Arthur-Milchior", "createdAt": "2020-07-01T18:28:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyNDgxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyNDg1NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6597#discussion_r448524855", "bodyText": "Isn't this in the scheduler already?", "author": "david-allison-1", "createdAt": "2020-07-01T17:51:32Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java", "diffHunk": "@@ -1344,6 +1349,7 @@ protected void answerCard(int ease) {\n         mSoundPlayer.stopSounds();\n         mCurrentEase = ease;\n \n+        mSched.discardCurrentCard();", "originalCommit": "e8bc745448d60a91256d95038a768f97aa8658ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0MzkyNw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6597#discussion_r448543927", "bodyText": "right. I actually got confused because I was sure I did add discardCurrentCard in answerCard. I know understand I added it in AbstractFlashCardViewer by accident instead of Scheduler", "author": "Arthur-Milchior", "createdAt": "2020-07-01T18:29:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyNDg1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyNTMwMw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6597#discussion_r448525303", "bodyText": "nit: spacing change", "author": "david-allison-1", "createdAt": "2020-07-01T17:52:27Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sched/Sched.java", "diffHunk": "@@ -367,7 +368,7 @@ protected boolean _fillLrn() {\n                     .getDatabase()\n                     .query(\n                             \"SELECT due, id FROM cards WHERE did IN \" + _deckLimit() + \" AND queue = \" + Consts.QUEUE_TYPE_LRN + \" AND due < ? LIMIT ?\",\n-                                    new Object[]{mDayCutoff, mReportLimit});\n+                            new Object[]{mDayCutoff, mReportLimit});", "originalCommit": "e8bc745448d60a91256d95038a768f97aa8658ad", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyNTk2Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6597#discussion_r448525962", "bodyText": "I think this conditional and setup would be best extracted to a method (accepting a QueueType and did) as it's used in 3 places\nSomething along the lines of\ncurrentCardIsInQueueWithDeck(Consts.QUEUE_TYPE_REV, did);\nBonus points for defining the Queue types in Consts via an IntDef", "author": "david-allison-1", "createdAt": "2020-07-01T17:53:43Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sched/Sched.java", "diffHunk": "@@ -660,7 +661,14 @@ protected int _deckRevLimitSingle(JSONObject d) {\n         }\n         long did = d.getLong(\"id\");\n         JSONObject c = mCol.getDecks().confForDid(did);\n-        return Math.max(0, c.getJSONObject(\"rev\").getInt(\"perDay\") - d.getJSONArray(\"revToday\").getInt(1));\n+        int lim = Math.max(0, c.getJSONObject(\"rev\").getInt(\"perDay\") - d.getJSONArray(\"revToday\").getInt(1));\n+        // mCurrentCard may be set to null when the reviewer gets closed. So we copy it to be sure to avoid NullPointerException\n+        Card currentCard = mCurrentCard;\n+        List<Long> currentCardParentsDid = mCurrentCardParentsDid;\n+        if (currentCard != null && currentCard.getQueue() == Consts.QUEUE_TYPE_REV && currentCardParentsDid != null && currentCardParentsDid.contains(did)) {", "originalCommit": "e8bc745448d60a91256d95038a768f97aa8658ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU0OTk2NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6597#discussion_r448549965", "bodyText": "I'll check for IndDef later. Remaining done", "author": "Arthur-Milchior", "createdAt": "2020-07-01T18:41:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyNTk2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgyMDg3Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/6597#discussion_r449820876", "bodyText": "Done (in another\u00a0PR)", "author": "Arthur-Milchior", "createdAt": "2020-07-05T01:42:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyNTk2Mg=="}], "type": "inlineReview"}, {"oid": "0457b2f3991a3dfbdef25c3cb43cf55d14350a20", "url": "https://github.com/ankidroid/Anki-Android/commit/0457b2f3991a3dfbdef25c3cb43cf55d14350a20", "message": "Copy variables before checking for null\n\nSince those variables may be set to null, there is a run of a\nNullPointerException due to concurrent access. This commit should\navoid it.", "committedDate": "2020-07-01T18:31:04Z", "type": "forcePushed"}, {"oid": "13b0da8b9ad94619c4cb928cdfb74150eaa736a7", "url": "https://github.com/ankidroid/Anki-Android/commit/13b0da8b9ad94619c4cb928cdfb74150eaa736a7", "message": "NF: Copy variables before checking for null\n\nSince those variables may be set to null, there is a run of a\nNullPointerException due to concurrent access. This commit should\navoid it.", "committedDate": "2020-07-01T20:32:46Z", "type": "forcePushed"}, {"oid": "25f7902e02a8548d4e4e6e081f3ce5fad79374fd", "url": "https://github.com/ankidroid/Anki-Android/commit/25f7902e02a8548d4e4e6e081f3ce5fad79374fd", "message": "NF: Copy variables before checking for null\n\nSince those variables may be set to null, there is a run of a\nNullPointerException due to concurrent access. This commit should\navoid it.", "committedDate": "2020-07-01T21:41:45Z", "type": "forcePushed"}, {"oid": "45eab54ed1a9644ab4124373af9ada907a8af909", "url": "https://github.com/ankidroid/Anki-Android/commit/45eab54ed1a9644ab4124373af9ada907a8af909", "message": "NF: Copy variables before checking for null\n\nSince those variables may be set to null, there is a run of a\nNullPointerException due to concurrent access. This commit should\navoid it.", "committedDate": "2020-07-01T21:42:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NDM3Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6597#discussion_r448664373", "bodyText": "This isn't called yet.", "author": "david-allison-1", "createdAt": "2020-07-01T23:19:48Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sched/SchedV2.java", "diffHunk": "@@ -760,6 +821,17 @@ private void _maybeResetLrn(boolean force) {\n         }\n     }\n \n+    /** Same as _resetRev, but assume discardCard is currently in the reviewer and so don't conunt it.*/\n+    protected void _resetLrn(@Nullable Card discardCard) {", "originalCommit": "45eab54ed1a9644ab4124373af9ada907a8af909", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk1NDk2NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6597#discussion_r448954964", "bodyText": "I guess I could remove it. When I wrote it I didn't realize that fillRev and fillNew both potentially reset their queue but fillLrn never reset it.\nI find it more consistent to add a new reset for the three queues, but on second thought there is no reason to do it", "author": "Arthur-Milchior", "createdAt": "2020-07-02T12:09:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NDM3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NDkzOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6597#discussion_r448664938", "bodyText": "Nit: might want to rename card to something more descriptive", "author": "david-allison-1", "createdAt": "2020-07-01T23:21:45Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sched/SchedV2.java", "diffHunk": "@@ -2667,8 +2759,12 @@ public int eta(int[] counts, boolean reload) {\n         return (int) Math.round((newTotal + relrnTotal + revTotal + futureRelrnTotal) / 60000);\n     }\n \n-\n-    public void decrementCounts(Card card) {\n+    /**\n+     * This is used when card is currently in the reviewer, to adapt the counts by removing this card from it.*/\n+    public void decrementCounts(@Nullable Card card) {", "originalCommit": "45eab54ed1a9644ab4124373af9ada907a8af909", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk1NTg3OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6597#discussion_r448955878", "bodyText": "Any idea ?\ncardInReviewer would make sens I guess, since decrementCounts is always called on the card which is sent to the reviewer or is already in it. I should use the same name in the methods resetNew/Rev(Card card)", "author": "Arthur-Milchior", "createdAt": "2020-07-02T12:11:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2NDkzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2ODEyOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6597#discussion_r448668128", "bodyText": "Just flagging this line for second review - I feel it's OK, but a second pair of eyes would be useful.", "author": "david-allison-1", "createdAt": "2020-07-01T23:32:20Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sched/SchedV2.java", "diffHunk": "@@ -161,7 +180,10 @@ public Card getCard() {\n             // decrement the counts here, when the card is returned to\n             // the reviewer.\n             decrementCounts(card);\n+            setCurrentCard(card);", "originalCommit": "45eab54ed1a9644ab4124373af9ada907a8af909", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk1ODU2Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6597#discussion_r448958563", "bodyText": "The main idea here is:\nI want the scheduler to know what the reviewer currently has.\nSince we don't want to actually send data from reviewer to scheduler (because we can't be sure another reviewer would send the same data), instead, I save the data in \"getCard\", which is the method called by the scheduler. That is, the scheduler remembers the current card. The current card is either:\n\nthe last card send with reset (there is a card if the reset is done because of undo, there is no card otherwise)\notherwise, the last card sent by getCard\notherwise, there is no card", "author": "Arthur-Milchior", "createdAt": "2020-07-02T12:16:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY2ODEyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3MDExNg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6597#discussion_r448670116", "bodyText": "Don't we need to handle duplicates as well as maintaining the counts here?", "author": "david-allison-1", "createdAt": "2020-07-01T23:39:08Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sched/SchedV2.java", "diffHunk": "@@ -760,6 +821,17 @@ private void _maybeResetLrn(boolean force) {\n         }\n     }\n \n+    /** Same as _resetRev, but assume discardCard is currently in the reviewer and so don't conunt it.*/\n+    protected void _resetLrn(@Nullable Card discardCard) {\n+        _resetLrn();\n+        if (discardCard != null && (\n+                discardCard.getQueue() == Consts.QUEUE_TYPE_LRN ||\n+                discardCard.getQueue() == Consts.QUEUE_TYPE_PREVIEW ||\n+                discardCard.getQueue() == Consts.QUEUE_TYPE_DAY_LEARN_RELEARN", "originalCommit": "45eab54ed1a9644ab4124373af9ada907a8af909", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk1OTc5Nw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6597#discussion_r448959797", "bodyText": "What do you mean by \"duplicate\" ?\nDo you mean the fact that, in scheduler 1, we count the number of time each card in learning  will be seen before its graduation ?\nIn this case, it makes no difference, because if a card in learning is in reviewer, the user will see it only a single time, so we only need to decrement by one the value of mLrnCount.", "author": "Arthur-Milchior", "createdAt": "2020-07-02T12:18:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3MDExNg=="}], "type": "inlineReview"}, {"oid": "8e76fdbb01539198437c20d3d5307bd7fb926a26", "url": "https://github.com/ankidroid/Anki-Android/commit/8e76fdbb01539198437c20d3d5307bd7fb926a26", "message": "NF: Copy variables before checking for null\n\nSince those variables may be set to null, there is a run of a\nNullPointerException due to concurrent access. This commit should\navoid it.", "committedDate": "2020-07-02T13:20:26Z", "type": "forcePushed"}, {"oid": "89be0e44c2dc6c166d5706501a94a850f982d7fb", "url": "https://github.com/ankidroid/Anki-Android/commit/89be0e44c2dc6c166d5706501a94a850f982d7fb", "message": "NF: Copy variables before checking for null\n\nSince those variables may be set to null, there is a run of a\nNullPointerException due to concurrent access. This commit should\navoid it.", "committedDate": "2020-07-02T14:09:12Z", "type": "forcePushed"}, {"oid": "c50567fffa73128811f84142248a83f9017ff520", "url": "https://github.com/ankidroid/Anki-Android/commit/c50567fffa73128811f84142248a83f9017ff520", "message": "NF: Copy variables before checking for null\n\nSince those variables may be set to null, there is a run of a\nNullPointerException due to concurrent access. This commit should\navoid it.", "committedDate": "2020-07-02T14:30:17Z", "type": "forcePushed"}, {"oid": "ec96edea1e2e6efcd994cfbbae46ad702312db57", "url": "https://github.com/ankidroid/Anki-Android/commit/ec96edea1e2e6efcd994cfbbae46ad702312db57", "message": "NF: Copy variables before checking for null\n\nSince those variables may be set to null, there is a run of a\nNullPointerException due to concurrent access. This commit should\navoid it.", "committedDate": "2020-07-02T14:41:01Z", "type": "forcePushed"}, {"oid": "6db123ec1c3608697f5f09a1c2288e51e2b8dc9f", "url": "https://github.com/ankidroid/Anki-Android/commit/6db123ec1c3608697f5f09a1c2288e51e2b8dc9f", "message": "NF: Copy variables before checking for null\n\nSince those variables may be set to null, there is a run of a\nNullPointerException due to concurrent access. This commit should\navoid it.", "committedDate": "2020-07-03T15:32:32Z", "type": "forcePushed"}, {"oid": "dbfb9c55515be7e35db7c0723d538315c9dfeab7", "url": "https://github.com/ankidroid/Anki-Android/commit/dbfb9c55515be7e35db7c0723d538315c9dfeab7", "message": "NF: Copy variables before checking for null\n\nSince those variables may be set to null, there is a run of a\nNullPointerException due to concurrent access. This commit should\navoid it.", "committedDate": "2020-07-04T17:17:36Z", "type": "forcePushed"}, {"oid": "708b8cdb3c005362b89ac3b9a4c89a1187aa9608", "url": "https://github.com/ankidroid/Anki-Android/commit/708b8cdb3c005362b89ac3b9a4c89a1187aa9608", "message": "NF: Copy variables before checking for null\n\nSince those variables may be set to null, there is a run of a\nNullPointerException due to concurrent access. This commit should\navoid it.", "committedDate": "2020-07-04T20:23:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg4MzIyNA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6597#discussion_r449883224", "bodyText": "You have very strict line length limits set up I think. I think breaking these lines decreases readability and if the editor did that because of limits, you should bump the limits. 80 chars isn't a hard limit anywhere anymore I don't think, 100 or 120 when really needed is okay by me\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * This is used when card is currently in the reviewer, to adapt\n          \n          \n            \n                 * the counts by removing this card from it.\n          \n          \n            \n                 *\n          \n          \n            \n                 * @param discardCard A card sent to reviewer that should not be\n          \n          \n            \n                 * counted.\n          \n          \n            \n                 * Used when card is currently in the reviewer, adapts the counts by removing this card from it.\n          \n          \n            \n                 *\n          \n          \n            \n                 * @param discardCard A card sent to reviewer that should not be counted.\n          \n      \n    \n    \n  \n\nThat can be taken as a general comment, I've noticed it before in your patches, but this one was the most glaring because I'm not sure javadoc @param annotations even work when broken like that, so your editor limit I think actually broke javadoc", "author": "mikehardy", "createdAt": "2020-07-05T14:25:04Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sched/Sched.java", "diffHunk": "@@ -1608,19 +1608,24 @@ public int eta(int[] counts, boolean reload) {\n \n \n     /**\n-     * This is used when card is currently in the reviewer, to adapt the counts by removing this card from it.*/\n+     * This is used when card is currently in the reviewer, to adapt\n+     * the counts by removing this card from it.\n+     *\n+     * @param discardCard A card sent to reviewer that should not be\n+     * counted.", "originalCommit": "5022b234879db9f9faf0dca1ee5d945c80a6ea21", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg4MzQyNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6597#discussion_r449883425", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // Tells the scheduler there is no more current cards. 0 is\n          \n          \n            \n                    // not a valid id.\n          \n          \n            \n                    // Tells the scheduler there are no more current cards. 0 is not a valid id.", "author": "mikehardy", "createdAt": "2020-07-05T14:26:48Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java", "diffHunk": "@@ -945,6 +945,11 @@ protected void onResume() {\n     @Override\n     protected void onDestroy() {\n         super.onDestroy();\n+        // Tells the scheduler there is no more current cards. 0 is\n+        // not a valid id.", "originalCommit": "ace81f3547f9c4b0955231cde57a9bb342482f54", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg4NDE3MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6597#discussion_r449884170", "bodyText": "maybe a naive question, but should it be and id != ? for currentCardId() if the goal is \"we don't want to get the same card a second time\"? this seems like it would only get the same card, every time?", "author": "mikehardy", "createdAt": "2020-07-05T14:31:58Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sched/Sched.java", "diffHunk": "@@ -366,9 +367,20 @@ protected boolean _fillLrn() {\n         mLrnQueue.clear();\n         SupportSQLiteDatabase db = mCol.getDb().getDatabase();\n         try {\n+            /* Difference with upstream:\n+             * Current card can't come in the queue.\n+             *\n+             * In standard usage, a card is not requested before the\n+             * previous card is marked as reviewed. However, if we\n+             * decide to query a second card sooner, we don't want to\n+             * get the same card a second time. This simulate\n+             * _getLrnCard which did remove the card from the\n+             * queue. _sortIntoLrn will add the card back to the queue\n+             * if required when the card is reviewed.\n+             */\n             cur = db.query(\n-                            \"SELECT due, id FROM cards WHERE did IN \" + _deckLimit() + \" AND queue = \" + Consts.QUEUE_TYPE_LRN + \" AND due < ? LIMIT ?\",\n-                                    new Object[]{mDayCutoff, mReportLimit});\n+                           \"SELECT due, id FROM cards WHERE did IN \" + _deckLimit() + \" AND queue = \" + Consts.QUEUE_TYPE_LRN + \" AND due < ? AND id = ? LIMIT ?\",", "originalCommit": "ace81f3547f9c4b0955231cde57a9bb342482f54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg4NDUzOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6597#discussion_r449884539", "bodyText": "Yeah, entirely right", "author": "Arthur-Milchior", "createdAt": "2020-07-05T14:35:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg4NDE3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg4NDc0Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6597#discussion_r449884743", "bodyText": "Corrected", "author": "Arthur-Milchior", "createdAt": "2020-07-05T14:37:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg4NDE3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg4NDQxNA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6597#discussion_r449884414", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Must not be returned during prefetching (as it is currently\n          \n          \n            \n                 * shown)\n          \n          \n            \n                 * Must not be returned during prefetching (as it is currently shown)", "author": "mikehardy", "createdAt": "2020-07-05T14:34:20Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sched/SchedV2.java", "diffHunk": "@@ -109,6 +109,24 @@\n     // Not in libanki\n     protected WeakReference<Activity> mContextReference;\n \n+    /**\n+     * The card currently being reviewed.\n+     *\n+     * Must not be returned during prefetching (as it is currently\n+     * shown)", "originalCommit": "ace81f3547f9c4b0955231cde57a9bb342482f54", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "34803aab579de4aa9d815c1806794e24c28e921b", "url": "https://github.com/ankidroid/Anki-Android/commit/34803aab579de4aa9d815c1806794e24c28e921b", "message": "NF: decrementCounts accepts null", "committedDate": "2020-07-05T14:36:12Z", "type": "commit"}, {"oid": "27ab7bb12c4cf2892fe13669c07f2d998cbe9096", "url": "https://github.com/ankidroid/Anki-Android/commit/27ab7bb12c4cf2892fe13669c07f2d998cbe9096", "message": "NF: factorize getDatabase in queue filler", "committedDate": "2020-07-05T14:36:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg4NDY5OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6597#discussion_r449884698", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 */\n          \n          \n            \n                protected Card mCurrentCard;\n          \n          \n            \n                /** The list of parent decks of the current card.\n          \n          \n            \n                 * Cached for performance .\n          \n          \n            \n            \n          \n          \n            \n                    Null iff mNextCard is null.*/\n          \n          \n            \n                @Nullable\n          \n          \n            \n                protected List<Long> mCurrentCardParentsDid;\n          \n          \n            \n                /* The next card that will be sent to the reviewer. I.e. the\n          \n          \n            \n                 * result of a second call to getCard, which is not the current\n          \n          \n            \n                 * card nor a sibling.\n          \n          \n            \n                 */\n          \n          \n            \n                 */\n          \n          \n            \n                protected Card mCurrentCard;\n          \n          \n            \n                \n          \n          \n            \n                /**\n          \n          \n            \n                 * Cached list of parent decks of the current card for performance\n          \n          \n            \n                 *\n          \n          \n            \n                 *  Null iff mNextCard is null.\n          \n          \n            \n                 */\n          \n          \n            \n                @Nullable\n          \n          \n            \n                protected List<Long> mCurrentCardParentsDid;\n          \n          \n            \n                \n          \n          \n            \n                /**\n          \n          \n            \n                 * The next card that will be sent to the reviewer. \n          \n          \n            \n                 * I.e. the result of a second call to getCard, which is not the current card nor a sibling.\n          \n          \n            \n                 */", "author": "mikehardy", "createdAt": "2020-07-05T14:37:07Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sched/SchedV2.java", "diffHunk": "@@ -109,6 +109,24 @@\n     // Not in libanki\n     protected WeakReference<Activity> mContextReference;\n \n+    /**\n+     * The card currently being reviewed.\n+     *\n+     * Must not be returned during prefetching (as it is currently\n+     * shown)\n+     */\n+    protected Card mCurrentCard;\n+    /** The list of parent decks of the current card.\n+     * Cached for performance .\n+\n+        Null iff mNextCard is null.*/\n+    @Nullable\n+    protected List<Long> mCurrentCardParentsDid;\n+    /* The next card that will be sent to the reviewer. I.e. the\n+     * result of a second call to getCard, which is not the current\n+     * card nor a sibling.\n+     */", "originalCommit": "ace81f3547f9c4b0955231cde57a9bb342482f54", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a2e28b884166d53783cd401b160be680300fc0cb", "url": "https://github.com/ankidroid/Anki-Android/commit/a2e28b884166d53783cd401b160be680300fc0cb", "message": "NF: Copy variables before checking for null\n\nSince those variables may be set to null, there is a run of a\nNullPointerException due to concurrent access. This commit should\navoid it.", "committedDate": "2020-07-05T14:37:24Z", "type": "forcePushed"}, {"oid": "a47c0cbc7459ec024fb7b5c6820ca25331c4fa28", "url": "https://github.com/ankidroid/Anki-Android/commit/a47c0cbc7459ec024fb7b5c6820ca25331c4fa28", "message": "NF: rename decrementCounts argument", "committedDate": "2020-07-05T14:42:14Z", "type": "commit"}, {"oid": "6f7568461a190b3b588b9e0b3cb11a0c179bee09", "url": "https://github.com/ankidroid/Anki-Android/commit/6f7568461a190b3b588b9e0b3cb11a0c179bee09", "message": "NF: reset of specific queue takes a card to discard as parameter\n\nThis simulate reset(Card) but applied to a specific queue.\n\nNote that, I believe that ideally, \"count\" should ignore the card\ncurrently in the reviewer; instead the number should be the number of\ncard to review today, and the reviewer should be in charge of knowing\nit currently it has a card so it should decrease the number", "committedDate": "2020-07-05T14:42:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg4ODc1NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6597#discussion_r449888755", "bodyText": "chastate?", "author": "david-allison-1", "createdAt": "2020-07-05T15:17:54Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sched/SchedV2.java", "diffHunk": "@@ -2725,4 +2872,43 @@ public void setReportLimit(int reportLimit) {\n     }\n \n     /** End #5666 */\n+    public void discardCurrentCard() {\n+        mCurrentCard = null;\n+        mCurrentCardParentsDid = null;\n+    }\n+\n+    /**\n+     * This imitate the action of the method answerCard, except that\n+     * it does not chastate of any card.", "originalCommit": "a2e28b884166d53783cd401b160be680300fc0cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg4OTMwMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6597#discussion_r449889301", "bodyText": "I was pretty sure it was already corrected. \"change the state\"", "author": "Arthur-Milchior", "createdAt": "2020-07-05T15:24:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg4ODc1NQ=="}], "type": "inlineReview"}, {"oid": "3aa4c4cf17652766d3ce78056730f4b1d0342b2f", "url": "https://github.com/ankidroid/Anki-Android/commit/3aa4c4cf17652766d3ce78056730f4b1d0342b2f", "message": "NF: mCurrentCard\n\nIf we want to preload the next card (and fill the queues if required)\nwe need to consider the card currently being reviewed in order to be\nsure not to enqueue it.\n\nThis used to be done automatically simply because, if \"undo\" or\n\"dismiss\" (i.e. bury, suspend) did a reset, it was not actually\ncomputed before the next call to getCard. So it was first marking the\ncurrent card as reviewed and then filling the queues.\n\nNow, we need to take into consideration the fact that the current card\nshould not be added in the queue nor found as the next card. Similarly\nthe sibling of the current card can't be in the queue. And the current\ncard should be considered in the computation of the limit.\n\nSo the AbstractFlashcardViewer warns the scheduler when it gets a\ncard, and also when it closes.", "committedDate": "2020-07-05T15:23:58Z", "type": "commit"}, {"oid": "15e1a970e35f39b2eb0868647292e9b77f5ee869", "url": "https://github.com/ankidroid/Anki-Android/commit/15e1a970e35f39b2eb0868647292e9b77f5ee869", "message": "NF: Copy variables before checking for null\n\nSince those variables may be set to null, there is a run of a\nNullPointerException due to concurrent access. This commit should\navoid it.", "committedDate": "2020-07-05T15:23:59Z", "type": "commit"}, {"oid": "15e1a970e35f39b2eb0868647292e9b77f5ee869", "url": "https://github.com/ankidroid/Anki-Android/commit/15e1a970e35f39b2eb0868647292e9b77f5ee869", "message": "NF: Copy variables before checking for null\n\nSince those variables may be set to null, there is a run of a\nNullPointerException due to concurrent access. This commit should\navoid it.", "committedDate": "2020-07-05T15:23:59Z", "type": "forcePushed"}]}