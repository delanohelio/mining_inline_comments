{"pr_number": 5941, "pr_title": "Remove Ability to \"Change Deck\" to Dynamic Deck", "pr_createdAt": "2020-04-06T16:33:07Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/5941", "timeline": [{"oid": "7c5db15c1f5d940815226adafdfdc79d794f54a9", "url": "https://github.com/ankidroid/Anki-Android/commit/7c5db15c1f5d940815226adafdfdc79d794f54a9", "message": "NF: Extract getValidDecksForChangeDeck()\n\nWe want to target this function for change and it's the best abstraction\nto take without large code changes", "committedDate": "2020-04-05T21:15:33Z", "type": "commit"}, {"oid": "7e8b9ab6142d5670061780215b9a4b73ab2ef14e", "url": "https://github.com/ankidroid/Anki-Android/commit/7e8b9ab6142d5670061780215b9a4b73ab2ef14e", "message": "Disable selecting dynamic decks in \"Change Deck\"\n\nJust contains the UI logic fix, Anki Desktop doesn't support the\noperation", "committedDate": "2020-04-06T08:54:20Z", "type": "commit"}, {"oid": "b6f7965224e8bd57dd4f1bb641c4ca00179f7616", "url": "https://github.com/ankidroid/Anki-Android/commit/b6f7965224e8bd57dd4f1bb641c4ca00179f7616", "message": "Add check to block transfer to dynamic deck\n\nAnki Desktop does not allow this. We already block it in the UI, but add\nan additional check in-case there's a race condition in the UI logic", "committedDate": "2020-04-06T09:51:15Z", "type": "commit"}, {"oid": "82c2b50d9d9ba49b9d6270730d61aeffc666ab65", "url": "https://github.com/ankidroid/Anki-Android/commit/82c2b50d9d9ba49b9d6270730d61aeffc666ab65", "message": "NF: Add attributes to Decks", "committedDate": "2020-04-06T10:53:58Z", "type": "commit"}, {"oid": "d7ec091290fed3c6948ccc63b2eee2b721546814", "url": "https://github.com/ankidroid/Anki-Android/commit/d7ec091290fed3c6948ccc63b2eee2b721546814", "message": "Add failure to transfer deck task\n\nThis ensures that the task can't be provided with an invalid deckId\n\nWe fix two bugs:\n\n* A Dynamic Deck is supplied\n* A Deck which doesn't exist is supplied (moving the cards to the\ndefault)", "committedDate": "2020-04-06T11:19:35Z", "type": "commit"}, {"oid": "acbe97b86e07c8137b793e8270dec760d585f72b", "url": "https://github.com/ankidroid/Anki-Android/commit/acbe97b86e07c8137b793e8270dec760d585f72b", "message": "Fix regression in CardBrowser selection\n\nWe now use getValidDecksForChangeDeck to display the items, so we need\nthis to correctly map from the index back to the selected deck", "committedDate": "2020-04-06T16:27:12Z", "type": "commit"}, {"oid": "680b7128d43c5df2953ad62e91de2a86fba8d2c4", "url": "https://github.com/ankidroid/Anki-Android/commit/680b7128d43c5df2953ad62e91de2a86fba8d2c4", "message": "NF: Codacy Scoping Fix", "committedDate": "2020-04-06T16:36:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIzMjY0Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/5941#discussion_r404232642", "bodyText": "getDecks().get() returns did:1 if unsuccessful.", "author": "david-allison-1", "createdAt": "2020-04-06T16:38:43Z", "path": "AnkiDroid/src/main/java/com/ichi2/async/DeckTask.java", "diffHunk": "@@ -737,6 +737,28 @@ private TaskData doInBackgroundDismissNotes(TaskData... params) {\n \n                     case CHANGE_DECK_MULTI: {\n                         long newDid = (long) data[2];\n+\n+                        Timber.i(\"Changing %d cards to deck: '%d'\", cards.length, newDid);\n+                        JSONObject deckData = col.getDecks().get(newDid);\n+\n+                        if (Decks.isDynamic(deckData)) {\n+                            //#5932 - can't change to a dynamic deck. Use \"Rebuild\"\n+                            Timber.w(\"Attempted to move to dynamic deck. Cancelling task.\");\n+                            return new TaskData(false);\n+                        }\n+\n+                        //Confirm that the deck exists (and is not the default)\n+                        try {\n+                            long actualId = deckData.getLong(\"id\");", "originalCommit": "680b7128d43c5df2953ad62e91de2a86fba8d2c4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIzMzE0NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5941#discussion_r404233145", "bodyText": "I know streams whenever we reach a new API level, is there anything now?", "author": "david-allison-1", "createdAt": "2020-04-06T16:39:24Z", "path": "AnkiDroid/src/test/java/com/ichi2/anki/CardBrowserTest.java", "diffHunk": "@@ -159,6 +273,15 @@ private void selectMenuItem(CardBrowser browser, int action_select_all) {\n         shadowActivity.clickMenuItem(action_select_all);\n     }\n \n+    //There has to be a better way :(\n+    private long[] toLongArray(List<Long> list){\n+        long[] ret = new long[list.size()];", "originalCommit": "680b7128d43c5df2953ad62e91de2a86fba8d2c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMxNjAxMA==", "url": "https://github.com/ankidroid/Anki-Android/pull/5941#discussion_r404316010", "bodyText": "no idea, and certainly not bothered in a test. in the main code you can use the compat infrastructure if you need to access higher API things to either prepare for major deprecation / access important new feature / achieve massive speedup by having an old-style backup in the lowest API level compat then overriding it in the first compat API level you have the APIs you need", "author": "mikehardy", "createdAt": "2020-04-06T18:54:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIzMzE0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMxOTQ5Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/5941#discussion_r404319493", "bodyText": "I'm just reviewing as I go through the commits in series so this may be addressed later but writing it while I think it: this is the exact assumption that bit us somewhere else but you worked on it directly so you might remember better. There were two different tests for a deck and whether it was dynamic right? And the previous problem was that they were used in different spots and (incorrectly I think) they returned different answers sometimes. Centralizing this and making sure everyone is using the same test and everything still works should be a side quest I think", "author": "mikehardy", "createdAt": "2020-04-06T19:00:24Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java", "diffHunk": "@@ -1053,4 +1053,8 @@ public boolean hasDeckOptions(long deckId) throws NoSuchDeckException {\n     public void removeDeckOptions(long deckId) throws NoSuchDeckException {\n         getDeckOrFail(deckId).remove(\"conf\");\n     }\n+\n+    public static boolean isDynamic(JSONObject deck) {\n+        return deck.getInt(\"dyn\") != 0;", "originalCommit": "7e8b9ab6142d5670061780215b9a4b73ab2ef14e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMzMzcxMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5941#discussion_r404333711", "bodyText": "I'm fine doing this, but:\n\nI want to keep libAnki compatibility as much as possible. Inlining and renaming methods can sadly introduce bugs and reduce clarity\nDamien is in the process of strongly typing the deck object.\n\n\nIn the coming months I plan to deserialize the decks json into a proper structure before access instead of accessing it as an untyped map,\n\nDyn != 0 is the standard way to check. Has(conf) was the irregular way.", "author": "david-allison-1", "createdAt": "2020-04-06T19:26:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMxOTQ5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM2MzU1MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5941#discussion_r404363551", "bodyText": "good points on all counts - as long as we know this check at least is the regular way, good to go", "author": "mikehardy", "createdAt": "2020-04-06T20:21:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMxOTQ5Mw=="}], "type": "inlineReview"}]}