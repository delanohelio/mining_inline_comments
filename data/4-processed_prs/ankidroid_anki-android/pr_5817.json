{"pr_number": 5817, "pr_title": "Add ability to answer cards via javascript in WebView", "pr_createdAt": "2020-03-14T10:19:34Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/5817", "timeline": [{"oid": "3a4a301da3dca4f6a44edef2193988bed15316ad", "url": "https://github.com/ankidroid/Anki-Android/commit/3a4a301da3dca4f6a44edef2193988bed15316ad", "message": "Add files via upload", "committedDate": "2020-03-14T09:50:07Z", "type": "commit"}, {"oid": "3e57c4ceca25bb1fec92ca743eaa98700966108f", "url": "https://github.com/ankidroid/Anki-Android/commit/3e57c4ceca25bb1fec92ca743eaa98700966108f", "message": "Update card.js", "committedDate": "2020-03-15T09:39:50Z", "type": "commit"}, {"oid": "e7e91bc09a085ffc129535442af8456f97f6dc80", "url": "https://github.com/ankidroid/Anki-Android/commit/e7e91bc09a085ffc129535442af8456f97f6dc80", "message": "Update AbstractFlashcardViewer.java", "committedDate": "2020-03-15T09:41:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY2MDA1NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/5817#discussion_r392660054", "bodyText": "Having functionality which will allow external actors to mutate the collection probably warrants an investigation into security.\nTheoretically, if someone hijacks a JS dependency in my deck, or I insert a malicious card from an external deck, a card could answer itself without my knowledge.\nA card being able to answer itself isn't too bad, but it'd be good to model it.\nIf the card could queue up a series of the actions, and they're executed outside the context of the current card, then that's really problematic\n//probably fine\nwindow.location = \"signal:showAnswer()\";\nwindow.location = \"signal:answer_ease1\";\n//Very bad if these are executed.\nwindow.location = \"signal:showAnswer()\";\nwindow.location = \"signal:answer_ease1\";\nI don't know what will happen with the above, but we should check.\nI don't know if our threat model is defined anywhere yet. We currently allow people to do crazy things, which we probably shouldn't. Maybe the horse has bolted on this one.", "author": "david-allison-1", "createdAt": "2020-03-15T10:24:52Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java", "diffHunk": "@@ -1480,6 +1475,46 @@ private boolean filterUrl(String url) {\n                     mFlipCardLayout.setVisibility(View.GONE);\n                     return true;\n                 }\n+                /*show answer using js functions*/\n+                if(\"signal:show_answer\".equals(url)){\n+                    if (!sDisplayAnswer) {\n+                        displayCardAnswer();\n+                    }\n+                    return true;\n+                }\n+                if(\"signal:answer_ease1\".equals(url)){", "originalCommit": "e7e91bc09a085ffc129535442af8456f97f6dc80", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY2MDkyMg==", "url": "https://github.com/ankidroid/Anki-Android/pull/5817#discussion_r392660922", "bodyText": "I have just implemented it. I am currently learning new stuffs.\nIf functions call queued then It has to be checked.\nI am finding solution about it.\nThank you", "author": "infinyte7", "createdAt": "2020-03-15T10:36:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY2MDA1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY2MTczOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5817#discussion_r392661739", "bodyText": "Just posting my thoughts on it. I'm not in a position to approve/deny anything.\nIMO, it'd be great to get this functionality in and better documented for deck authors to take advantage of. There's so much untapped potential with custom note types that we haven't explored yet, and it's even better if we allow people to do this in JS so they don't need to know AnkiDroid internals.", "author": "david-allison-1", "createdAt": "2020-03-15T10:49:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY2MDA1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY3OTM2MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5817#discussion_r392679361", "bodyText": "Yes, Giving potentiality of js capabilities make more useful for learnes as well as deck creators.", "author": "infinyte7", "createdAt": "2020-03-15T14:32:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY2MDA1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY3NTI4NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5817#discussion_r392675285", "bodyText": "This logic branch (\"are we showing the answer? if not show the answer...\") is duplicated 4 times, seems it could be pulled up into one if(url.contains(\"signal:answer_ease\")) { if (!sDisplayAnswer) { displayCardAnswer(); return true; } then a switch on which answer_easeN was requested?\nAlso please note that your whitespace is inconsistent, we use a space after if, before parentheses - 'if (' not 'if('", "author": "mikehardy", "createdAt": "2020-03-15T13:44:42Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java", "diffHunk": "@@ -1475,6 +1475,46 @@ private boolean filterUrl(String url) {\n                     mFlipCardLayout.setVisibility(View.GONE);\n                     return true;\n                 }\n+                /*show answer using js functions*/\n+                if(\"signal:show_answer\".equals(url)){\n+                    if (!sDisplayAnswer) {\n+                        displayCardAnswer();\n+                    }\n+                    return true;\n+                }\n+                if(\"signal:answer_ease1\".equals(url)){\n+                    if (sDisplayAnswer) {\n+                        answerCard(EASE_1);\n+                    } else {\n+                        displayCardAnswer();\n+                    }\n+                    return true;\n+                }\n+                if(\"signal:answer_ease2\".equals(url)){\n+                    if (sDisplayAnswer) {\n+                        answerCard(EASE_2);\n+                    } else {\n+                        displayCardAnswer();\n+                    }\n+                    return true;\n+                }\n+                if(\"signal:answer_ease3\".equals(url)){\n+                    if (sDisplayAnswer) {\n+                        answerCard(EASE_3);\n+                    } else {\n+                        displayCardAnswer();\n+                    }\n+                    return true;\n+                }\n+                if(\"signal:answer_ease4\".equals(url)){\n+                    if (sDisplayAnswer) {\n+                        answerCard(EASE_4);\n+                    } else {", "originalCommit": "e7e91bc09a085ffc129535442af8456f97f6dc80", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY3NTMwNg==", "url": "https://github.com/ankidroid/Anki-Android/pull/5817#discussion_r392675306", "bodyText": "likewise, we have a space between close parentheses and open curly brace - ') {' vs '){'", "author": "mikehardy", "createdAt": "2020-03-15T13:45:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY3NTI4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY3OTQ4OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5817#discussion_r392679489", "bodyText": "Okay, I will follow that, and implement as per requested.", "author": "infinyte7", "createdAt": "2020-03-15T14:33:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY3NTI4NQ=="}], "type": "inlineReview"}, {"oid": "366610142dc2b93fd4a54958878b9205a9d59f52", "url": "https://github.com/ankidroid/Anki-Android/commit/366610142dc2b93fd4a54958878b9205a9d59f52", "message": "Update AbstractFlashcardViewer.java", "committedDate": "2020-03-15T15:52:38Z", "type": "commit"}, {"oid": "7c5ec74a43504d5357e66dfec9b329a64c88c04f", "url": "https://github.com/ankidroid/Anki-Android/commit/7c5ec74a43504d5357e66dfec9b329a64c88c04f", "message": "Update card.js", "committedDate": "2020-03-15T15:55:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5MTU3Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/5817#discussion_r392691572", "bodyText": "A pervasive issue is the naming of EASE_X in AbstractFlashCardViewer. This refers to the ordinal of the button, not the answer. This is better due to the V2 Scheduler adding \"Hard\", but there are still some cases where these don't match.\nIt'd be good to either document this assumption heavily, or do away with it and move to a \"Hard/Good/Easy\" based approach.\n\n  \n    \n      Anki-Android/AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java\n    \n    \n        Lines 1251 to 1255\n      in\n      86ef26c\n    \n    \n    \n    \n\n        \n          \n           case EASE_2: \n        \n\n        \n          \n               mChosenAnswer.setText(\"\\u2022\\u2022\"); \n        \n\n        \n          \n               mChosenAnswer.setTextColor(ContextCompat.getColor(this, buttonNumber == 4 ? \n        \n\n        \n          \n                       R.color.material_blue_grey_600: \n        \n\n        \n          \n                       R.color.material_green_500)); \n        \n    \n  \n\n\nI have the code to do this on my PC (ping for a copy if we want to go down this route).", "author": "david-allison-1", "createdAt": "2020-03-15T16:49:45Z", "path": "AnkiDroid/src/main/assets/scripts/card.js", "diffHunk": "@@ -64,6 +64,25 @@ function taFocus() {\n     window.location.href = \"signal:typefocus\";\n }\n \n+/*  Call displayCardAnswer() and answerCard() from anki deck template using javascript\n+ *  See also AbstractFlashcardViewer.\n+ */\n+function showAnswer() {\n+    window.location.href = \"signal:show_answer\";\n+}\n+function buttonAnswerEase1() {", "originalCommit": "7c5ec74a43504d5357e66dfec9b329a64c88c04f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5MzczOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5817#discussion_r392693739", "bodyText": "I will look into this code. I will implement this, If I may.", "author": "infinyte7", "createdAt": "2020-03-15T17:18:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5MTU3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5MTU4MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5817#discussion_r392691581", "bodyText": "I don't think we provide the user with a method of obtaining the available number of buttons (or an array of the buttons themselves), but we should consider adding this since we don't yet have a mechanism to return data from a signal.\nAlso have something close to this logic sitting on my PC.\nCurrent implementation of providing data to a card from Android:\n\n  \n    \n      Anki-Android/AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java\n    \n    \n         Line 1112\n      in\n      86ef26c\n    \n    \n    \n    \n\n        \n          \n           public HashMap<String, String> _renderQA(Object[] data, String qfmt, String afmt) { \n        \n    \n  \n\n\nGet the count of buttons\n\n  \n    \n      Anki-Android/AnkiDroid/src/main/java/com/ichi2/libanki/Sched.java\n    \n    \n         Line 236\n      in\n      86ef26c\n    \n    \n    \n    \n\n        \n          \n           public int answerButtons(Card card) { \n        \n    \n  \n\n\nAn implementation of the logic, but we can do better.\n\n  \n    \n      Anki-Android/AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java\n    \n    \n         Line 1591\n      in\n      86ef26c\n    \n    \n    \n    \n\n        \n          \n           switch (buttonCount) {", "author": "david-allison-1", "createdAt": "2020-03-15T16:49:52Z", "path": "AnkiDroid/src/main/assets/scripts/card.js", "diffHunk": "@@ -64,6 +64,25 @@ function taFocus() {\n     window.location.href = \"signal:typefocus\";\n }\n \n+/*  Call displayCardAnswer() and answerCard() from anki deck template using javascript\n+ *  See also AbstractFlashcardViewer.\n+ */\n+function showAnswer() {\n+    window.location.href = \"signal:show_answer\";\n+}\n+function buttonAnswerEase1() {\n+    window.location.href = \"signal:answer_ease1\";", "originalCommit": "7c5ec74a43504d5357e66dfec9b329a64c88c04f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5MzYzMw==", "url": "https://github.com/ankidroid/Anki-Android/pull/5817#discussion_r392693633", "bodyText": "Okay, I have learned about this. Hoping your implementions in future release of Ankidroid.\nBecause I have to read more about java to implement. But I will try to implement it.", "author": "infinyte7", "createdAt": "2020-03-15T17:16:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5MTU4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5MjExNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5817#discussion_r392692115", "bodyText": "(nitpick) a few whitespace issues in a few files", "author": "david-allison-1", "createdAt": "2020-03-15T16:56:37Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java", "diffHunk": "@@ -676,7 +676,7 @@ private String typeAnsQuestionFilter(String buf) {\n             // These functions are defined in the JavaScript file assets/scripts/card.js. We get the text back in\n             // shouldOverrideUrlLoading() in createWebView() in this file.\n             sb.append(\"<center>\\n<input type=text name=typed id=typeans onfocus=\\\"taFocus();\\\" \" +\n-                      \"onblur=\\\"taBlur(this);\\\" onKeyPress=\\\"return taKey(this, event)\\\" autocomplete=\\\"off\\\" \");\n+                    \"onblur=\\\"taBlur(this);\\\" onKeyPress=\\\"return taKey(this, event)\\\" autocomplete=\\\"off\\\" \");", "originalCommit": "7c5ec74a43504d5357e66dfec9b329a64c88c04f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5MjE3MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5817#discussion_r392692171", "bodyText": "(nitpick) could be made more concise with string operations/regex.", "author": "david-allison-1", "createdAt": "2020-03-15T16:57:05Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java", "diffHunk": "@@ -1475,6 +1475,41 @@ private boolean filterUrl(String url) {\n                     mFlipCardLayout.setVisibility(View.GONE);\n                     return true;\n                 }\n+\n+                 /**\n+                  *  Call displayCardAnswer() and answerCard() from anki deck template using javascript\n+                  *  See card.js in assets/scripts folder\n+                  */\n+                if (\"signal:show_answer\".equals(url)) {\n+                    // display answer when showAnswer() called from card.js\n+                    if (!sDisplayAnswer) {\n+                        displayCardAnswer();\n+                    }\n+                    return true;\n+                }\n+                if (url.contains(\"signal:answer_ease\")) {\n+                    if (!sDisplayAnswer) {\n+                        displayCardAnswer();\n+                        return true;\n+                    } else {\n+                        switch (url) {", "originalCommit": "7c5ec74a43504d5357e66dfec9b329a64c88c04f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5NDEyMA==", "url": "https://github.com/ankidroid/Anki-Android/pull/5817#discussion_r392694120", "bodyText": "How can I do this?", "author": "infinyte7", "createdAt": "2020-03-15T17:23:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5MjE3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzI0OTg3Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/5817#discussion_r393249876", "bodyText": "Honestly, I don't like it as much as the above. Vote to ignore my previous comment.\nif (url.length() == \"signal:answer_ease\".length() + 1) {\n    char lastChar = url.charAt(url.length() - 1);\n    int ease = lastChar - '0';\n    if (ease < 1 || ease > 4) {\n        Timber.w(\"unhandled signal: %s\", url);\n    } else {\n        answerCard(ease);\n    }\n}", "author": "david-allison-1", "createdAt": "2020-03-16T19:01:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5MjE3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMzNzY1MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/5817#discussion_r393337650", "bodyText": "I will implement this. Thank you", "author": "infinyte7", "createdAt": "2020-03-16T22:11:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5MjE3MQ=="}], "type": "inlineReview"}, {"oid": "f8041a93bb3249736811d14659250d93a9c76ca4", "url": "https://github.com/ankidroid/Anki-Android/commit/f8041a93bb3249736811d14659250d93a9c76ca4", "message": "Update AbstractFlashcardViewer.java", "committedDate": "2020-03-15T18:25:09Z", "type": "commit"}, {"oid": "f0f9331b5e8d518d7cbad7ac48cb0443c9384559", "url": "https://github.com/ankidroid/Anki-Android/commit/f0f9331b5e8d518d7cbad7ac48cb0443c9384559", "message": "Update AbstractFlashcardViewer.java", "committedDate": "2020-03-15T18:36:30Z", "type": "commit"}, {"oid": "2f4df32f4fe9551691ebe4117059d301c55fd9b4", "url": "https://github.com/ankidroid/Anki-Android/commit/2f4df32f4fe9551691ebe4117059d301c55fd9b4", "message": "Merge branch 'master' of https://github.com/infinyte7/Anki-Android", "committedDate": "2020-03-15T18:36:57Z", "type": "commit"}]}