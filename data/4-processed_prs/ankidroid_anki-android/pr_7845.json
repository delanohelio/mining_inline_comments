{"pr_number": 7845, "pr_title": "Bump minSdkVersion to 21, purge related lower-API workarounds", "pr_createdAt": "2020-12-08T22:51:19Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/7845", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODk5OTI0MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7845#discussion_r538999240", "bodyText": "If you move the number to a constant, you may want to move the comment, to mention that 29 is Q (assuming it's the case)", "author": "Arthur-Milchior", "createdAt": "2020-12-09T04:35:30Z", "path": "AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/libanki/ModelTest.java", "diffHunk": "@@ -36,7 +36,7 @@ public void tearDown() {\n \n     @Test\n     public void bigQuery() {\n-        assumeTrue(\"This test is flaky on API29, ignoring\", Build.VERSION.SDK_INT != 29);\n+        assumeTrue(\"This test is flaky on API29, ignoring\", Build.VERSION.SDK_INT != Build.VERSION_CODES.Q);", "originalCommit": "4517b492a18152c58fc6e91203824c75b9d93a12", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTUxNzMyOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7845#discussion_r539517328", "bodyText": "I actually left this one there on purpose so that whenever we search for API29 or Q later (years from now...) there is now way we will miss this one for removal :-)", "author": "mikehardy", "createdAt": "2020-12-09T17:47:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODk5OTI0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODk5OTY4NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7845#discussion_r538999684", "bodyText": "Please remove the variable mIsDestroyed, it become unused", "author": "Arthur-Milchior", "createdAt": "2020-12-09T04:37:02Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/AnkiActivity.java", "diffHunk": "@@ -282,15 +281,6 @@ protected void disableViewAnimation(View view) {\n         view.clearAnimation();\n     }\n \n-    /** Compat shim for API 16 */\n-    public boolean wasDestroyed() {\n-        if (Build.VERSION.SDK_INT > Build.VERSION_CODES.JELLY_BEAN) {\n-            return super.isDestroyed();\n-        }\n-        return mIsDestroyed;\n-    }", "originalCommit": "4517b492a18152c58fc6e91203824c75b9d93a12", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTUxNzQ0Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7845#discussion_r539517443", "bodyText": "good catch", "author": "mikehardy", "createdAt": "2020-12-09T17:47:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODk5OTY4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTAwMjI4MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7845#discussion_r539002281", "bodyText": "How come this lead to adding more code? I don't understand the relation with this commit", "author": "Arthur-Milchior", "createdAt": "2020-12-09T04:45:14Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java", "diffHunk": "@@ -1079,6 +1075,78 @@ private void setWhiteboardEnabledState(boolean state) {\n         }\n     }\n \n+    private static final int FULLSCREEN_ALL_GONE = 2;\n+", "originalCommit": "4517b492a18152c58fc6e91203824c75b9d93a12", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMwNTE0MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7845#discussion_r539305140", "bodyText": "Every single bit of code was transplanted, there was no code added except the one about color schemes, no attempt was made to alter the code at all (on purpose), this was a pure move of API-related code without altering it", "author": "mikehardy", "createdAt": "2020-12-09T13:28:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTAwMjI4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMyMzI0NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7845#discussion_r539323245", "bodyText": "Could we temporarily move this to a new class with the responsibility (a lazy choice, rather than re-architecting),", "author": "david-allison-1", "createdAt": "2020-12-09T13:52:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTAwMjI4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTUxODQ1Nw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7845#discussion_r539518457", "bodyText": "I do not want to do that in this PR. This PR is tightly focused on moving working code from Compat to in-place execution (like this), or deleting it. Open to discussion on whether something is deleted or not (some of your other comments here) but I will not be making new objects anywhere", "author": "mikehardy", "createdAt": "2020-12-09T17:49:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTAwMjI4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMxNjUyMA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7845#discussion_r539316520", "bodyText": "Do we need this since we're running on x86 emulators now (and multidex is presumably implicitly enabled)?\nHappy to link as follow-on issue or ignore, no action required.", "author": "david-allison-1", "createdAt": "2020-12-09T13:44:08Z", "path": "AnkiDroid/build.gradle", "diffHunk": "@@ -43,20 +43,18 @@ android {\n         // needed for upgrades to be offered correctly.\n         versionCode=21500111\n         versionName=\"2.15alpha11\"\n-        minSdkVersion 16\n+        minSdkVersion 21\n         //noinspection OldTargetApi - also performed in api/build.fradle\n         targetSdkVersion 29 // change .travis.yml platform download at same time\n-        multiDexEnabled true\n         testApplicationId \"com.ichi2.anki.tests\"\n         vectorDrawables.useSupportLibrary = true\n-        // This is a custom class, in androidx to override package-level functions\n-        testInstrumentationRunner 'androidx.test.runner.MultiDexJUnitRunner'\n+        testInstrumentationRunner 'androidx.test.runner.AndroidJUnitRunner'\n \n         // This enables long timeouts required on slow ARM emulators, e.g. Travis\n         adbOptions {\n             //logLevel verbose // let's try to see what is happening\n             timeOutInMs 20 * 60 * 1000  // 20 minutes\n-            DdmPreferences.setTimeOut(120000) // apparently if not multidex you do this\n+            DdmPreferences.setTimeOut(120000)", "originalCommit": "4517b492a18152c58fc6e91203824c75b9d93a12", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTUyMjg3MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7845#discussion_r539522871", "bodyText": "Yeah, I wavered on this one but was trying to keep it very very focused as a pure code re-homing\nI'll log a second issue to keep this one clean", "author": "mikehardy", "createdAt": "2020-12-09T17:55:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMxNjUyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTUyMzQ5NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7845#discussion_r539523495", "bodyText": "#7852  done", "author": "mikehardy", "createdAt": "2020-12-09T17:56:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMxNjUyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMxNjc1NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7845#discussion_r539316754", "bodyText": "Thank goodness for that", "author": "david-allison-1", "createdAt": "2020-12-09T13:44:25Z", "path": "AnkiDroid/src/androidTest/java/androidx/test/internal/runner/MultiDexClassPathScanner.java", "diffHunk": "@@ -1,157 +0,0 @@\n-/*", "originalCommit": "4517b492a18152c58fc6e91203824c75b9d93a12", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTUxOTM3MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7845#discussion_r539519370", "bodyText": "I was actually just a little sad to see it go but that's just sunk cost (mal-)reasoning. That was a great hack.", "author": "mikehardy", "createdAt": "2020-12-09T17:50:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMxNjc1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMxNzcyNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7845#discussion_r539317725", "bodyText": "Optional:\nCan we keep a dummy user-defined class, inheriting the default Android implementation - I'm going to want to use it in a while, and having the infrastructure set up (rather than figuring it out again, or going through the git history) will be useful\nDoesn't have to be in the androidx namespace", "author": "david-allison-1", "createdAt": "2020-12-09T13:45:40Z", "path": "AnkiDroid/build.gradle", "diffHunk": "@@ -43,20 +43,18 @@ android {\n         // needed for upgrades to be offered correctly.\n         versionCode=21500111\n         versionName=\"2.15alpha11\"\n-        minSdkVersion 16\n+        minSdkVersion 21\n         //noinspection OldTargetApi - also performed in api/build.fradle\n         targetSdkVersion 29 // change .travis.yml platform download at same time\n-        multiDexEnabled true\n         testApplicationId \"com.ichi2.anki.tests\"\n         vectorDrawables.useSupportLibrary = true\n-        // This is a custom class, in androidx to override package-level functions\n-        testInstrumentationRunner 'androidx.test.runner.MultiDexJUnitRunner'\n+        testInstrumentationRunner 'androidx.test.runner.AndroidJUnitRunner'", "originalCommit": "4517b492a18152c58fc6e91203824c75b9d93a12", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTUyMDQ2Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/7845#discussion_r539520466", "bodyText": "I'd prefer to sunset this one and have any future need handled specifically vs speculatively. Tempered by the fact that now just by dent of having this discussion you'll remember exactly where to go in git history...", "author": "mikehardy", "createdAt": "2020-12-09T17:51:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMxNzcyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTUyOTk1OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7845#discussion_r539529958", "bodyText": "I will, that's fair.", "author": "david-allison-1", "createdAt": "2020-12-09T18:05:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMxNzcyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMyMTk5Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/7845#discussion_r539321996", "bodyText": "Optional: Might want to keep under compat - changes here for API 30", "author": "david-allison-1", "createdAt": "2020-12-09T13:51:23Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java", "diffHunk": "@@ -294,7 +292,7 @@ protected void onCollectionLoaded(Collection col) {\n \n         // Set full screen/immersive mode if needed\n         if (mPrefFullscreenReview) {\n-            CompatHelper.getCompat().setFullScreen(this);\n+            setFullScreen(this);", "originalCommit": "4517b492a18152c58fc6e91203824c75b9d93a12", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTUyMTAzNg==", "url": "https://github.com/ankidroid/Anki-Android/pull/7845#discussion_r539521036", "bodyText": "same as the last comment - I do not want speculative solutions, when we need to adapt it for API30, we should do so on purpose without prior baggage thinking", "author": "mikehardy", "createdAt": "2020-12-09T17:52:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMyMTk5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMyMzk1Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/7845#discussion_r539323952", "bodyText": "Yep - let's add a low priority issue for it,", "author": "david-allison-1", "createdAt": "2020-12-09T13:54:00Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/noteeditor/Toolbar.java", "diffHunk": "@@ -153,16 +152,13 @@ private int dpToPixels(int value) {\n \n \n     public View getClozeIcon() {\n-        // HACK until API 21\n+        // HACK until API 21 FIXME can this be altered now?", "originalCommit": "4517b492a18152c58fc6e91203824c75b9d93a12", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTUyMjIyNA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7845#discussion_r539522224", "bodyText": "done #7851", "author": "mikehardy", "createdAt": "2020-12-09T17:54:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMyMzk1Mg=="}], "type": "inlineReview"}, {"oid": "f4662321414cc4ba9892efe0226a8aa53240a5d3", "url": "https://github.com/ankidroid/Anki-Android/commit/f4662321414cc4ba9892efe0226a8aa53240a5d3", "message": "Bump minSdkVersion to 21, purge related lower-API workarounds\n\nFixes #7843", "committedDate": "2020-12-09T18:39:28Z", "type": "commit"}, {"oid": "f4662321414cc4ba9892efe0226a8aa53240a5d3", "url": "https://github.com/ankidroid/Anki-Android/commit/f4662321414cc4ba9892efe0226a8aa53240a5d3", "message": "Bump minSdkVersion to 21, purge related lower-API workarounds\n\nFixes #7843", "committedDate": "2020-12-09T18:39:28Z", "type": "forcePushed"}]}