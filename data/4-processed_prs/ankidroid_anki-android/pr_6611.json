{"pr_number": 6611, "pr_title": "Card browser show even on close", "pr_createdAt": "2020-07-04T16:25:29Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6611", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc4Nzc4Nw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6611#discussion_r449787787", "bodyText": "this comment seems related, and a little like a warning. what does shared access to mCards mean now if we continue using it in between onStop and onDestroy ? I am not sure it means anything and the change otherwise seems like it should be okay though", "author": "mikehardy", "createdAt": "2020-07-04T16:47:17Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -676,8 +676,6 @@ private void openNoteEditorForCurrentlySelectedNote() {\n     protected void onStop() {\n         Timber.d(\"onStop()\");\n         // cancel rendering the question and answer, which has shared access to mCards", "originalCommit": "34c69af67636aa087648777b67780393376223ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc4OTE0Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6611#discussion_r449789142", "bodyText": "The comment was introduced in 4743f60\nAt this time, the comment was in another method, and it has been copy/pasted here with the cancellation in in eee250a\n@timrae do you remember whether this comment you wrote in 2014 is supposed to warn us again anything ?\nmCards is a list of card. Here, a card is a map from column entry to their value, there seems to be no reason to worry that anything has access to this map. And even if the list gets changed at some point, a lot of change occured recently which ensure that we have no exception if a concurrent change occured on the list.\nI should note however that it was a mistake to leave this comment instead of copying it", "author": "Arthur-Milchior", "createdAt": "2020-07-04T17:06:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc4Nzc4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDExODAyMA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6611#discussion_r484118020", "bodyText": "Shared access in this case just meant that libanki had a reference to mCards and was concurrently modifying that data structure on the deck task thread, so you have to be careful. The code base might have changed significantly since then though.", "author": "timrae", "createdAt": "2020-09-06T21:53:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc4Nzc4Nw=="}], "type": "inlineReview"}, {"oid": "d16059f5fd2b385d7de356e63a31da65ec0a93c7", "url": "https://github.com/ankidroid/Anki-Android/commit/d16059f5fd2b385d7de356e63a31da65ec0a93c7", "message": "NF: alow to cancel Task_type_Check_Card_selection\n\nIt's kind of inneficient right now if we select all suspended\ncards. That's not a real trouble, but still useful to avoid leaving\nuseles computation in background", "committedDate": "2020-07-04T17:08:23Z", "type": "forcePushed"}, {"oid": "8262d9f0cd566847740ad0edefc8a9434fef7a9d", "url": "https://github.com/ankidroid/Anki-Android/commit/8262d9f0cd566847740ad0edefc8a9434fef7a9d", "message": "tmp", "committedDate": "2020-07-04T19:55:31Z", "type": "forcePushed"}, {"oid": "9df643e202ff553ab829a7059306a8ea1c7b057c", "url": "https://github.com/ankidroid/Anki-Android/commit/9df643e202ff553ab829a7059306a8ea1c7b057c", "message": "NF: remove getInstance\n\nIt is never used, and is probably a bad idea", "committedDate": "2020-07-04T20:15:29Z", "type": "forcePushed"}, {"oid": "7463d47c897c8a3bbdc97169c60dc99f020063f3", "url": "https://github.com/ankidroid/Anki-Android/commit/7463d47c897c8a3bbdc97169c60dc99f020063f3", "message": "NF: alow to cancel Task_type_Check_Card_selection\n\nIt's kind of inneficient right now if we select all suspended\ncards. That's not a real trouble, but still useful to avoid leaving\nuseles computation in background", "committedDate": "2020-07-04T20:15:27Z", "type": "forcePushed"}, {"oid": "1481e381551b090e4e839c9c145230b9fc8b0b85", "url": "https://github.com/ankidroid/Anki-Android/commit/1481e381551b090e4e839c9c145230b9fc8b0b85", "message": "NF: alow to cancel Task_type_Check_Card_selection\n\nIt's kind of inneficient right now if we select all suspended\ncards. That's not a real trouble, but still useful to avoid leaving\nuseles computation in background", "committedDate": "2020-07-05T15:22:47Z", "type": "forcePushed"}, {"oid": "07c9e7d53439b6a8b7e7475fe3cb96497246513d", "url": "https://github.com/ankidroid/Anki-Android/commit/07c9e7d53439b6a8b7e7475fe3cb96497246513d", "message": "NF: alow to cancel Task_type_Check_Card_selection\n\nIt's kind of inneficient right now if we select all suspended\ncards. That's not a real trouble, but still useful to avoid leaving\nuseles computation in background", "committedDate": "2020-07-05T19:46:23Z", "type": "forcePushed"}, {"oid": "edd972a8b6a3cab55f2de344f78bac3b8aeffa84", "url": "https://github.com/ankidroid/Anki-Android/commit/edd972a8b6a3cab55f2de344f78bac3b8aeffa84", "message": "NF: kill Task_Type_Count_Models when ModelBrowser close", "committedDate": "2020-07-05T23:44:15Z", "type": "forcePushed"}, {"oid": "59822264e6481a2fae8e620de6f94aa230f6c052", "url": "https://github.com/ankidroid/Anki-Android/commit/59822264e6481a2fae8e620de6f94aa230f6c052", "message": "NF: Model type", "committedDate": "2020-07-21T20:50:01Z", "type": "forcePushed"}, {"oid": "37007bde2b3de9a70fce7394bd6bd08b73ae4752", "url": "https://github.com/ankidroid/Anki-Android/commit/37007bde2b3de9a70fce7394bd6bd08b73ae4752", "message": "NF: alow to cancel Task_type_Check_Card_selection\n\nIt's kind of inneficient right now if we select all suspended\ncards. That's not a real trouble, but still useful to avoid leaving\nuseles computation in background", "committedDate": "2020-07-24T10:52:39Z", "type": "forcePushed"}, {"oid": "02af1aed4d04162feedaeeac1a90b33ceca34423", "url": "https://github.com/ankidroid/Anki-Android/commit/02af1aed4d04162feedaeeac1a90b33ceca34423", "message": "NF: alow to cancel Task_type_Check_Card_selection\n\nIt's kind of inneficient right now if we select all suspended\ncards. That's not a real trouble, but still useful to avoid leaving\nuseles computation in background", "committedDate": "2020-08-02T09:11:13Z", "type": "forcePushed"}, {"oid": "df8df4d15dc964cc499d2143be7523d4fcce26b5", "url": "https://github.com/ankidroid/Anki-Android/commit/df8df4d15dc964cc499d2143be7523d4fcce26b5", "message": "NF: alow to cancel Task_type_Check_Card_selection\n\nIt's kind of inneficient right now if we select all suspended\ncards. That's not a real trouble, but still useful to avoid leaving\nuseles computation in background", "committedDate": "2020-08-15T23:19:01Z", "type": "forcePushed"}, {"oid": "9c128fd927cbf024e3d531acc01aa1f22081c5df", "url": "https://github.com/ankidroid/Anki-Android/commit/9c128fd927cbf024e3d531acc01aa1f22081c5df", "message": "NF: alow to cancel Task_type_Check_Card_selection\n\nIt's kind of inneficient right now if we select all suspended\ncards. That's not a real trouble, but still useful to avoid leaving\nuseles computation in background", "committedDate": "2020-08-30T21:57:38Z", "type": "forcePushed"}, {"oid": "a993e993d29f7c0658c1cd787a7475ba95e7f454", "url": "https://github.com/ankidroid/Anki-Android/commit/a993e993d29f7c0658c1cd787a7475ba95e7f454", "message": "Cards are displayed in card browser after return from background\n\nThere is currently the following problem in ankidroid:\n* Search for a big number of card\n* quickly change app on android. The window should not be displayed anymore\n* wait some time\n* come back to AnkiDroid\n\nIt should show the list of card, or being processing. Instead it shows\nthere are 0 card found.\n\nThis is because, when the app change, onStop is called, and this\ncancel the search. Instead, the cancellation should occur in\nonDestroy, whene there the search is not used anymore.", "committedDate": "2020-09-06T20:58:42Z", "type": "commit"}, {"oid": "fd226fd80d65236453b1bd4467194b3ea9dfa6da", "url": "https://github.com/ankidroid/Anki-Android/commit/fd226fd80d65236453b1bd4467194b3ea9dfa6da", "message": "NF: alow to cancel Task_type_Check_Card_selection\n\nIt's kind of inneficient right now if we select all suspended\ncards. That's not a real trouble, but still useful to avoid leaving\nuseles computation in background", "committedDate": "2020-09-06T21:00:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDExNjE3MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6611#discussion_r484116170", "bodyText": "this did not ever return null before, should annotate the method as @Nullable now to see what falls out from that (if anything)\nThere is still the general idea from previous comments that I do not believe has been tested:\nfrom @david-allison-1:\n\nI believe that this PR introduces an unlikely path where this could happen (note editor card template editor -> delete card template).\nIf we're going to introduce this potential bug, we should ensure that the card browser will handle a deleted card correctly.\n\nfrom me:\n\nMaybe to be defensive, CardBrowser should just never trust state after delegating out to NoteEditor and should always invalidate itself/cancel tasks/research. For instance right now if you went CardBrowser -> NoteEditor -> CardTemplateEditor -> CardBrowserAppearance you are clearly interested in changing the way things look in the card browser right? But I don't think it will actually refresh when you return.", "author": "mikehardy", "createdAt": "2020-09-06T21:32:02Z", "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -1879,6 +1879,10 @@ public TaskData doInBackgroundCheckCardSelection(TaskData param) {\n         boolean hasUnsuspended = false;\n         boolean hasUnmarked = false;\n         for (CardBrowser.CardCache c: checkedCards) {\n+            if (isCancelled()) {\n+                Timber.v(\"doInBackgroundCheckCardSelection: cancelled.\");\n+                return null;", "originalCommit": "fd226fd80d65236453b1bd4467194b3ea9dfa6da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDExNzc1MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6611#discussion_r484117750", "bodyText": "(note editor card template editor -> delete card template).\n\nI just wrote that\n\nI've manually tested deleting a card type shown in the result set, and this did not lead to a bug.\n\nThis mean I (manually, I admit it) tested this path.\n\nCardBrowser should just never trust state after delegating out to NoteEditor\n\nI answered here\n\nActually, if the note editor state that the task was cancelled, no reason to invalidate I believe. Otherwise, it's already invalidating and doing a new search. That's the purpose of the call to search after the edit note activity\n\nThat is; I admit that you are generally quite right. If anything was done in card editor, the list should be rebuilt from scratch. And that is exactly what is already occurring. However,\u00a0I would believe that if no change were made in the card editor, then there is no reason to recompute the list. This seems especially important because it's easy to just misclick. Computing a search is expensive for big collection and slow phone, I'd like to avoid misclick to loose seconds.\nIf you disagree and think that even when the card editor state there is no change, we should still recompute, I can do it. But I'd prefer to see you answer my remark first, to know that you have considered this compromise and rejected it", "author": "Arthur-Milchior", "createdAt": "2020-09-06T21:50:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDExNjE3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDExNzgwOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6611#discussion_r484117809", "bodyText": "this did not ever return null before, should annotate the method as @Nullable now to see what falls out from that (if anything)\n\nRight. I added @nullable.", "author": "Arthur-Milchior", "createdAt": "2020-09-06T21:51:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDExNjE3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDExOTA2OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6611#discussion_r484119068", "bodyText": "Okay - if you tested it, my approval is still on here and we can merge it and go for 2.13-release branch cut", "author": "mikehardy", "createdAt": "2020-09-06T22:05:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDExNjE3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDEyMDUxOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6611#discussion_r484120518", "bodyText": "The reason the test works is because if there is a change in the card type, it is also noted as a change in the card, and so requires the search to be done from scratch", "author": "Arthur-Milchior", "createdAt": "2020-09-06T22:22:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDExNjE3MA=="}], "type": "inlineReview"}, {"oid": "9baa80463e9dc704c207c82683db1b6b9ba63217", "url": "https://github.com/ankidroid/Anki-Android/commit/9baa80463e9dc704c207c82683db1b6b9ba63217", "message": "NF: alow to cancel Task_type_Check_Card_selection\n\nIt's kind of inneficient right now if we select all suspended\ncards. That's not a real trouble, but still useful to avoid leaving\nuseles computation in background", "committedDate": "2020-09-06T21:46:10Z", "type": "commit"}, {"oid": "9baa80463e9dc704c207c82683db1b6b9ba63217", "url": "https://github.com/ankidroid/Anki-Android/commit/9baa80463e9dc704c207c82683db1b6b9ba63217", "message": "NF: alow to cancel Task_type_Check_Card_selection\n\nIt's kind of inneficient right now if we select all suspended\ncards. That's not a real trouble, but still useful to avoid leaving\nuseles computation in background", "committedDate": "2020-09-06T21:46:10Z", "type": "forcePushed"}]}