{"pr_number": 6663, "pr_title": "Protect against stale field info in CardTemplatePreviewer", "pr_createdAt": "2020-07-11T20:21:01Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6663", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI2NDgxOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6663#discussion_r453264819", "bodyText": "This doesn't finish() on certain cases.\nBrackets would make the logic more explicit", "author": "david-allison-1", "createdAt": "2020-07-12T04:15:58Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardTemplatePreviewer.java", "diffHunk": "@@ -136,6 +160,10 @@ public void onSaveInstanceState(Bundle outState) {\n     @Override\n     protected void onCollectionLoaded(Collection col) {\n         super.onCollectionLoaded(col);\n+        if (isFinishing() || (mCurrentCard == null) && (mCardList == null)) {\n+            Timber.d(\"onCollectionLoaded - incorrect state to load, closing\");", "originalCommit": "76490b580ab015f445fd5b61d5185fed4b1b2d32", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI2NTA3OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6663#discussion_r453265079", "bodyText": "This constant isn't used other than here. This seems to launch the activity twice.", "author": "david-allison-1", "createdAt": "2020-07-12T04:20:29Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java", "diffHunk": "@@ -936,6 +937,7 @@ public boolean onOptionsItemSelected(MenuItem item) {\n                 Bundle noteEditorBundle = new Bundle();\n                 onSaveInstanceState(noteEditorBundle);\n                 previewer.putExtra(\"noteEditorBundle\", noteEditorBundle);\n+                startActivityForResultWithoutAnimation(previewer, REQUEST_PREVIEW);", "originalCommit": "76490b580ab015f445fd5b61d5185fed4b1b2d32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzMyNTY5OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6663#discussion_r453325698", "bodyText": "the double-launch is a big deal although (usefully?) it pointed out several areas in CardTemplatePreviewer that needed hardening which I actually liked. I couldn't figure out the double-launch on quick inspection but I'll dig in more. The constant is only used once because I don't actually care in onActivityResult, as deleting temporary model is always safe so it doesn't really need a special case. Otherwise it would be used there", "author": "mikehardy", "createdAt": "2020-07-12T14:48:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI2NTA3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzk2Nzk3MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6663#discussion_r453967970", "bodyText": "OMG the double launch was literally right there. Sleep deprivation is a real thing.\nCleaned up the double-launch, was able to reproduce it and prove this fix worked, re-pushed", "author": "mikehardy", "createdAt": "2020-07-13T22:08:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI2NTA3OQ=="}], "type": "inlineReview"}, {"oid": "e29357fae38d8112038728aef3d149c7fb5f3d9e", "url": "https://github.com/ankidroid/Anki-Android/commit/e29357fae38d8112038728aef3d149c7fb5f3d9e", "message": "Protect against mis-matched field info in CardTemplatePreviewer\n\nIt is possible for the model and the preview bundle to\nbe out of sync, as NoteEditor preserves \"extra\" fields from old card types\nin case the user switches back, meaning we could be attempting to preview with\nmore field info than we have fields to show\n\nnow we won't populate fields off the end of the note's field array\n\nadditionally we will carefully clean up after\nCardTemplatePreviewer where before no cleanup was done", "committedDate": "2020-07-13T22:06:39Z", "type": "commit"}, {"oid": "e29357fae38d8112038728aef3d149c7fb5f3d9e", "url": "https://github.com/ankidroid/Anki-Android/commit/e29357fae38d8112038728aef3d149c7fb5f3d9e", "message": "Protect against mis-matched field info in CardTemplatePreviewer\n\nIt is possible for the model and the preview bundle to\nbe out of sync, as NoteEditor preserves \"extra\" fields from old card types\nin case the user switches back, meaning we could be attempting to preview with\nmore field info than we have fields to show\n\nnow we won't populate fields off the end of the note's field array\n\nadditionally we will carefully clean up after\nCardTemplatePreviewer where before no cleanup was done", "committedDate": "2020-07-13T22:06:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM3NTgwNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6663#discussion_r454375805", "bodyText": "Needs confirmation this still works with the CardTemplatePreviewer - I'd have expected this to be required for state restoration if it's too big for a bundle.", "author": "david-allison-1", "createdAt": "2020-07-14T13:57:22Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardTemplatePreviewer.java", "diffHunk": "@@ -89,11 +91,33 @@ protected void onResume() {\n         super.onResume();\n         if (mCurrentCard == null || mOrdinal < 0) {\n             Timber.e(\"CardTemplatePreviewer started with empty card list or invalid index\");\n-            finishWithoutAnimation();\n+            closeCardTemplatePreviewer();\n         }\n     }\n \n \n+    private void closeCardTemplatePreviewer() {\n+        Timber.d(\"CardTemplatePreviewer:: closeCardTemplatePreviewer()\");\n+        setResult(RESULT_OK);\n+        TemporaryModel.clearTempModelFiles();", "originalCommit": "e29357fae38d8112038728aef3d149c7fb5f3d9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM5NDM2MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6663#discussion_r454394361", "bodyText": "The NoteEditor does not do anything about it's own state being stored in a bundle, the addition of the TemporaryModel was 100% for communication with CardTemplatePreviewer, so when it returns it is always valid to clear TemporaryModel. If NoteEditor sees some preening in the future it may take advantage of TemporaryModel internally but right now it does not, and since on Preview there is no mutation possible, clearing on both sides (CardTemplatePreviewer.close / NoteEditor.onActivityResult) should be safe\nThis close pathway is not exercised on Activity restarts - where TemporaryModel is needed for restoration - so, also safe?", "author": "mikehardy", "createdAt": "2020-07-14T14:23:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM3NTgwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ0NzEzOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6663#discussion_r454447139", "bodyText": "Confirmed working with discard activities / across activity restarts. I think this is good to go", "author": "mikehardy", "createdAt": "2020-07-14T15:33:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM3NTgwNQ=="}], "type": "inlineReview"}]}