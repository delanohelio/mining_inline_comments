{"pr_number": 7474, "pr_title": "Remove useless conversions", "pr_createdAt": "2020-10-24T16:04:34Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/7474", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ4ODQxMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7474#discussion_r511488411", "bodyText": "is this correct? the SQL is asking for an id and you're feeding it a Long array, seems like it should just be the nid here?\nAny time I see SQL changing my first thought is: is this exercised by a test anywhere? I'd check the results of coverage output to see if this is indeed exercised to make sure the result is semantically the same. If it doesn't already have coverage I am nervous changing it without adding coverage first", "author": "mikehardy", "createdAt": "2020-10-24T16:17:55Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Models.java", "diffHunk": "@@ -921,7 +918,7 @@ private void _changeCards(long[] nids, Model oldModel, Model newModel, Map<Integ\n         int nflds = newModel.getJSONArray(\"tmpls\").length();\n         try {\n             cur = mCol.getDb().getDatabase().query(\n-                    \"select id, ord from cards where nid in \" + Utils.ids2str(nids), null);\n+                    \"select id, ord from cards where nid = ?\", new Long[]{nid});", "originalCommit": "2eaeaaefea2103ffc542b64e24823f76a6f451e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ5MjkzOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7474#discussion_r511492938", "bodyText": "Previous answer deleted.\nIt works. I guess it is more clear now that I use an array of Object that this is just an array of argument values for the query.\nSince there is a single nid to consider, testing equality is simpler and more efficient than testing whether the value is in the list", "author": "Arthur-Milchior", "createdAt": "2020-10-24T17:06:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ4ODQxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ5NDI0OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7474#discussion_r511494249", "bodyText": "This was the cause of a CI failure before, the SQL prepare statement did have a problem, not sure if it will really compile correctly as a SQL statement but CI will tell us", "author": "mikehardy", "createdAt": "2020-10-24T17:21:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ4ODQxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ4ODQzMw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7474#discussion_r511488433", "bodyText": "I suppose this should be \"_changeNote\" now?", "author": "mikehardy", "createdAt": "2020-10-24T16:18:08Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Models.java", "diffHunk": "@@ -871,48 +871,45 @@ private void _syncTemplates(Model m) {\n      */\n     public void change(Model m, long nid, Model newModel, Map<Integer, Integer> fmap, Map<Integer, Integer> cmap) throws ConfirmModSchemaException {\n         mCol.modSchema();\n-        long[] nids = new long[] {nid};\n         assert (newModel.getLong(\"id\") == m.getLong(\"id\")) || (fmap != null && cmap != null);\n         if (fmap != null) {\n-            _changeNotes(nids, newModel, fmap);\n+            _changeNotes(nid, newModel, fmap);\n         }\n         if (cmap != null) {\n-            _changeCards(nids, m, newModel, cmap);\n+            _changeCards(nid, m, newModel, cmap);\n         }\n+        long[] nids = new long[] {nid};\n         mCol.genCards(nids);\n     }\n \n-    private void _changeNotes(long[] nids, Model newModel, Map<Integer, Integer> map) {\n+    private void _changeNotes(long nid, Model newModel, Map<Integer, Integer> map) {", "originalCommit": "2eaeaaefea2103ffc542b64e24823f76a6f451e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ5MTYxNw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7474#discussion_r511491617", "bodyText": "Done", "author": "Arthur-Milchior", "createdAt": "2020-10-24T16:52:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ4ODQzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ4ODYzMw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7474#discussion_r511488633", "bodyText": "Does this work? Shouldn't it just be nid?", "author": "david-allison-1", "createdAt": "2020-10-24T16:20:03Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Models.java", "diffHunk": "@@ -920,7 +917,7 @@ private void _changeCards(long[] nids, Model oldModel, Model newModel, Map<Integ\n         int nflds = newModel.getJSONArray(\"tmpls\").length();\n         try {\n             cur = mCol.getDb().getDatabase().query(\n-                    \"select id, ord from cards where nid in \" + Utils.ids2str(nids), null);\n+                    \"select id, ord from cards where nid = ?\", new Long[]{nid});", "originalCommit": "b9bb304480d6a62633421892c5b7d16b12e96529", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ5MjY5Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/7474#discussion_r511492692", "bodyText": "I answered to Mike above", "author": "Arthur-Milchior", "createdAt": "2020-10-24T17:04:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ4ODYzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ4ODc0NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7474#discussion_r511488744", "bodyText": "Not any more", "author": "david-allison-1", "createdAt": "2020-10-24T16:21:22Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -720,26 +720,39 @@ public void _remNotes(java.util.Collection<Long> ids) {\n     /**\n      * Generate cards for non-empty templates, return ids to remove.\n      */\n-\tpublic ArrayList<Long> genCards(List<Long> nids) {\n-\t    return genCards(Utils.collection2Array(nids));\n+\tpublic ArrayList<Long> genCards(java.util.Collection<Long> nids) {\n+        String snids = Utils.ids2str(nids);\n+\t    return genCards(snids);\n \t}\n \n     public <T extends ProgressSender<TaskData> & CancelListener> ArrayList<Long> genCards(List<Long> nids, @Nullable T task) {\n-       return genCards(Utils.collection2Array(nids), task);\n+        String snids = Utils.ids2str(nids);\n+        return genCards(snids, task);\n     }\n \n-    public ArrayList<Long> genCards(long[] nids) {\n-       return genCards(nids, null);\n+    public ArrayList<Long> genCards(long nid) {\n+       return genCards(nid, null);\n     }\n \n     /**\n-     * @param nids All ids of nodes of a note type\n+     * @param nid All ids of nodes of a note type", "originalCommit": "b9bb304480d6a62633421892c5b7d16b12e96529", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ5MTkzOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7474#discussion_r511491938", "bodyText": "Thanks. You're right", "author": "Arthur-Milchior", "createdAt": "2020-10-24T16:55:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ4ODc0NA=="}], "type": "inlineReview"}, {"oid": "585670e6c5237057f29bd514f58127a49c05aec3", "url": "https://github.com/ankidroid/Anki-Android/commit/585670e6c5237057f29bd514f58127a49c05aec3", "message": "NF: Avoid useless conversion when possible", "committedDate": "2020-10-24T16:52:14Z", "type": "forcePushed"}, {"oid": "39b97947e30a32f7d5d23d148fa65967ab7a4d78", "url": "https://github.com/ankidroid/Anki-Android/commit/39b97947e30a32f7d5d23d148fa65967ab7a4d78", "message": "NF: Avoid useless conversion when possible", "committedDate": "2020-10-24T16:55:15Z", "type": "forcePushed"}, {"oid": "494cf790499374b1f74e21af7801d5c27bf3b12d", "url": "https://github.com/ankidroid/Anki-Android/commit/494cf790499374b1f74e21af7801d5c27bf3b12d", "message": "NF: Avoid useless conversion when possible", "committedDate": "2020-10-24T17:05:51Z", "type": "forcePushed"}, {"oid": "4f03037f6a762a4545425f02efca346d0674c9d9", "url": "https://github.com/ankidroid/Anki-Android/commit/4f03037f6a762a4545425f02efca346d0674c9d9", "message": "NF: Avoid useless conversion when possible", "committedDate": "2020-10-24T17:34:27Z", "type": "forcePushed"}, {"oid": "c236f523518b8d2a2d4d7934231b3e7532c014c0", "url": "https://github.com/ankidroid/Anki-Android/commit/c236f523518b8d2a2d4d7934231b3e7532c014c0", "message": "NF: Avoid useless conversion when possible", "committedDate": "2020-10-24T18:38:35Z", "type": "forcePushed"}, {"oid": "edd090f1c9bffb33f6a7c8c78e3f1882ea2dce93", "url": "https://github.com/ankidroid/Anki-Android/commit/edd090f1c9bffb33f6a7c8c78e3f1882ea2dce93", "message": "NF: Avoid useless conversion when possible", "committedDate": "2020-10-24T18:41:29Z", "type": "forcePushed"}, {"oid": "f991ec32dcd79bd8e38e3f9a39bf6840d7c6f252", "url": "https://github.com/ankidroid/Anki-Android/commit/f991ec32dcd79bd8e38e3f9a39bf6840d7c6f252", "message": "NF: Avoid useless conversion when possible", "committedDate": "2020-10-24T18:54:01Z", "type": "forcePushed"}, {"oid": "445b9ef554b803f9771cc72acf205df76752b876", "url": "https://github.com/ankidroid/Anki-Android/commit/445b9ef554b803f9771cc72acf205df76752b876", "message": "NF: Avoid useless conversion when possible", "committedDate": "2020-10-24T18:56:51Z", "type": "forcePushed"}, {"oid": "db63db24acbec3e4dfc591773c9fea7fee3ad174", "url": "https://github.com/ankidroid/Anki-Android/commit/db63db24acbec3e4dfc591773c9fea7fee3ad174", "message": "correct error", "committedDate": "2020-10-24T21:13:45Z", "type": "commit"}, {"oid": "b4847e1e5b4f0871555fffe3f0dd446076d88e7e", "url": "https://github.com/ankidroid/Anki-Android/commit/b4847e1e5b4f0871555fffe3f0dd446076d88e7e", "message": "NF: remove array with a single element", "committedDate": "2020-10-24T21:14:00Z", "type": "commit"}, {"oid": "6a8c3d5b87b9bf22609d2b5f3c09113dfa8b218d", "url": "https://github.com/ankidroid/Anki-Android/commit/6a8c3d5b87b9bf22609d2b5f3c09113dfa8b218d", "message": "NF: _changeCard takes a single nid", "committedDate": "2020-10-24T21:14:00Z", "type": "commit"}, {"oid": "32f4d238697679abd441ee0df63de6f8905287ae", "url": "https://github.com/ankidroid/Anki-Android/commit/32f4d238697679abd441ee0df63de6f8905287ae", "message": "NF: _changeNotes takes a single nid", "committedDate": "2020-10-24T21:14:00Z", "type": "commit"}, {"oid": "96f7f773e26467682b3abdc85b60b0f6f0c31c22", "url": "https://github.com/ankidroid/Anki-Android/commit/96f7f773e26467682b3abdc85b60b0f6f0c31c22", "message": "NF: remove a loop executed exactly once", "committedDate": "2020-10-24T21:14:00Z", "type": "commit"}, {"oid": "ff337da7e377816baf54ed4d2f113e94edd10807", "url": "https://github.com/ankidroid/Anki-Android/commit/ff337da7e377816baf54ed4d2f113e94edd10807", "message": "NF: genCards takes joined fields", "committedDate": "2020-10-24T21:14:00Z", "type": "commit"}, {"oid": "6cca8c0fd1219ef091e75a469ba0d60b0937c0a9", "url": "https://github.com/ankidroid/Anki-Android/commit/6cca8c0fd1219ef091e75a469ba0d60b0937c0a9", "message": "NF: split updateFieldCache", "committedDate": "2020-10-24T21:14:19Z", "type": "commit"}, {"oid": "e9586ffdfd7bf4af73ea4db2c7700ba61b4d98e9", "url": "https://github.com/ankidroid/Anki-Android/commit/e9586ffdfd7bf4af73ea4db2c7700ba61b4d98e9", "message": "NF: genCard accept singleton", "committedDate": "2020-10-24T21:14:20Z", "type": "commit"}, {"oid": "9c043b44183541fa44a3811372b6b61d77e5485b", "url": "https://github.com/ankidroid/Anki-Android/commit/9c043b44183541fa44a3811372b6b61d77e5485b", "message": "NF: genCard avoid an array", "committedDate": "2020-10-24T21:14:39Z", "type": "commit"}, {"oid": "815ae9f5dd65ec93c4031c009719ac49416fb302", "url": "https://github.com/ankidroid/Anki-Android/commit/815ae9f5dd65ec93c4031c009719ac49416fb302", "message": "NF: registerNotes takes Collection", "committedDate": "2020-10-24T21:14:40Z", "type": "commit"}, {"oid": "f82381dbd2f6d94993f980d74dd8d22720f2b269", "url": "https://github.com/ankidroid/Anki-Android/commit/f82381dbd2f6d94993f980d74dd8d22720f2b269", "message": "NF: array to scalar when array is never used", "committedDate": "2020-10-24T21:14:40Z", "type": "commit"}, {"oid": "9899a221ed997e15fb7c996eaec339f744f2e739", "url": "https://github.com/ankidroid/Anki-Android/commit/9899a221ed997e15fb7c996eaec339f744f2e739", "message": "NF: _syncTemplates avoid", "committedDate": "2020-10-24T21:15:49Z", "type": "commit"}, {"oid": "9899a221ed997e15fb7c996eaec339f744f2e739", "url": "https://github.com/ankidroid/Anki-Android/commit/9899a221ed997e15fb7c996eaec339f744f2e739", "message": "NF: _syncTemplates avoid", "committedDate": "2020-10-24T21:15:49Z", "type": "forcePushed"}]}