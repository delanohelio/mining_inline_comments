{"pr_number": 7291, "pr_title": "[BugFix] Card Browser Preview works after sorting", "pr_createdAt": "2020-09-27T17:31:07Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/7291", "timeline": [{"oid": "fd7f90d5d8be8aa49c908027c4052fe3dbba8262", "url": "https://github.com/ankidroid/Anki-Android/commit/fd7f90d5d8be8aa49c908027c4052fe3dbba8262", "message": "NF: Extract class CardCollection\n\nThere's an invariant to ensure that positions are updated with the collection\n\nThis is currently broken due to reverse(), but this keeps a refactor out\nof the code to fix the bug\n\nThe class also ensures that this will not occur again\n\nRelated: 7286", "committedDate": "2020-09-27T17:22:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU5ODMxMw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7291#discussion_r495598313", "bodyText": "\"sort field\" usually means \"the field from the note type that is used to sort cards and that can be displayed directly in browser\"\nSo I believe that \"the sort value in the card browser\" would be less confusing", "author": "Arthur-Milchior", "createdAt": "2020-09-27T17:59:25Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -227,35 +227,38 @@\n     private BroadcastReceiver mUnmountReceiver = null;\n \n     private final MaterialDialog.ListCallbackSingleChoice mOrderDialogListener =\n-            new MaterialDialog.ListCallbackSingleChoice() {\n-        @Override\n-        public boolean onSelection(MaterialDialog materialDialog, View view, int which,\n-                CharSequence charSequence) {\n-            if (which != mOrder) {\n-                mOrder = which;\n-                mOrderAsc = false;\n-                if (mOrder == 0) {\n-                    getCol().getConf().put(\"sortType\", fSortTypes[1]);\n-                    AnkiDroidApp.getSharedPrefs(getBaseContext()).edit()\n-                            .putBoolean(\"cardBrowserNoSorting\", true)\n-                            .commit();\n-                } else {\n-                    getCol().getConf().put(\"sortType\", fSortTypes[mOrder]);\n-                    AnkiDroidApp.getSharedPrefs(getBaseContext()).edit()\n-                            .putBoolean(\"cardBrowserNoSorting\", false)\n-                            .commit();\n-                }\n-                getCol().getConf().put(\"sortBackwards\", mOrderAsc);\n-                searchCards();\n-            } else if (which != CARD_ORDER_NONE) {\n-                mOrderAsc = !mOrderAsc;\n-                getCol().getConf().put(\"sortBackwards\", mOrderAsc);\n-                mCards.reverse();\n-                updateList();\n+            (materialDialog, view, which, charSequence) -> {\n+                changeCardOrder(which);\n+                return true;\n+            };\n+\n+\n+    protected void changeCardOrder(int which) {\n+        if (which != mOrder) {\n+            // if the sort field was changed, then perform a new search", "originalCommit": "2272fa552026eb74e0e00fe36ae1b8b777fc78c4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU5ODQ0Nw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7291#discussion_r495598447", "bodyText": "If it does not takes too much time, it would have been nice for review to have it in its own commit, since this part is trivial to check", "author": "Arthur-Milchior", "createdAt": "2020-09-27T18:00:45Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -1092,18 +1095,7 @@ public boolean onOptionsItemSelected(MenuItem item) {\n                 return true;\n \n             case R.id.action_preview: {\n-                Intent previewer = new Intent(CardBrowser.this, Previewer.class);\n-                if (mInMultiSelectMode && checkedCardCount() > 1) {\n-                    // Multiple cards have been explicitly selected, so preview only those cards\n-                    previewer.putExtra(\"index\", 0);\n-                    previewer.putExtra(\"cardList\", getSelectedCardIds());\n-                } else {\n-                    // Preview all cards, starting from the one that is currently selected\n-                    int startIndex = mCheckedCards.isEmpty() ? 0 : mCheckedCards.iterator().next().getPosition();\n-                    previewer.putExtra(\"index\", startIndex);\n-                    previewer.putExtra(\"cardList\", getAllCardIds());\n-                }\n-                startActivityForResultWithoutAnimation(previewer, PREVIEW_CARDS);\n+                onPreview();\n                 return true;", "originalCommit": "2272fa552026eb74e0e00fe36ae1b8b777fc78c4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ce62e52c216d50501d6c041a33f913c76ac85a9b", "url": "https://github.com/ankidroid/Anki-Android/commit/ce62e52c216d50501d6c041a33f913c76ac85a9b", "message": "NF: CardBrowser - Extract methods\n\nPrep for unit tests - requested to split this commit out in a review", "committedDate": "2020-09-27T18:59:16Z", "type": "commit"}, {"oid": "f179c5ff6d65d9ab0f9ffe4ac17e70e8031fbe56", "url": "https://github.com/ankidroid/Anki-Android/commit/f179c5ff6d65d9ab0f9ffe4ac17e70e8031fbe56", "message": "Regression Test: Browser - Preview after sorting\n\nCurrently fails due to 7286", "committedDate": "2020-09-27T18:59:17Z", "type": "commit"}, {"oid": "cf0caa62107571c86f8891083890cc00f8ba4bf4", "url": "https://github.com/ankidroid/Anki-Android/commit/cf0caa62107571c86f8891083890cc00f8ba4bf4", "message": "[BugFix] Preview reverse cards correctly\n\nPreviously, we did not reverse the positions in the collection\n\nFixes 7286", "committedDate": "2020-09-27T18:59:17Z", "type": "commit"}, {"oid": "b8b5b59a2b0a81b780bddf69a7f8784ffe2af6a1", "url": "https://github.com/ankidroid/Anki-Android/commit/b8b5b59a2b0a81b780bddf69a7f8784ffe2af6a1", "message": "NF: CardBrowser - Improve comments\n\nRenderBrowserQA: CardCache/CardCollection will keep positions consistent\n\nImproved changeCardOrder", "committedDate": "2020-09-27T18:59:17Z", "type": "commit"}, {"oid": "b8b5b59a2b0a81b780bddf69a7f8784ffe2af6a1", "url": "https://github.com/ankidroid/Anki-Android/commit/b8b5b59a2b0a81b780bddf69a7f8784ffe2af6a1", "message": "NF: CardBrowser - Improve comments\n\nRenderBrowserQA: CardCache/CardCollection will keep positions consistent\n\nImproved changeCardOrder", "committedDate": "2020-09-27T18:59:17Z", "type": "forcePushed"}]}