{"pr_number": 6249, "pr_title": "Add \"Browser Appearance\" Screen", "pr_createdAt": "2020-05-22T11:46:10Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6249", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM3MjYwMw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6249#discussion_r429372603", "bodyText": "I can see how this avoids passing the template between activities, which is a plus since that has known potential to overflow the Bundle but it seems like a tightly bound connection where template editor calls this activity for return, and as soon as it returns it asks this activity again for some processing to create an object, and then asks that object to do work on stuff the template editor has.\nI can also see how it would work fine, but I guess it seems like it would be clearer if you sent it the template for work, and it sent back the template when it's done (using a file pass like #5151 if needed, and no need to reinvent that so could just be marked as pending.\nHowever, another related thought, what is the user expectation with regards to save / discard status?\nState 1 Unedited template in CardTemplateEditor / Unedited in Appearance editor\nState 2 Unedited template in CardTemplateEditor / Edited in Appearance editor\nState 3 Edited / Unedited\nState 4 Edited / Edited\nCase 1: Save in Appearance editor / Discard in template editor\nCase 2: Save in appearance editor / Save in template editor\nCase 3: Discard / Discard\nCase 4: Discard / Save\nCase 1, Case 2 and Case 4 are the interesting cases, for states 2 and 4 I think. Those are situations where the user's mental model of things and their request, and the activity / template state might violate their expectations\nSolution could be just to expose the state and it's consequences to the user, explaining that they are just editing a part of the greater template, so they are only discarding the edits on the part, or that even if they save here they still need to save in the template editor or they won't actually be saved\n\ud83e\udd14", "author": "mikehardy", "createdAt": "2020-05-22T17:34:29Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardTemplateBrowserAppearanceEditor.java", "diffHunk": "@@ -0,0 +1,266 @@\n+/*\n+ Copyright (c) 2020 David Allison <davidallisongithub@gmail.com>\n+\n+ This program is free software; you can redistribute it and/or modify it under\n+ the terms of the GNU General Public License as published by the Free Software\n+ Foundation; either version 3 of the License, or (at your option) any later\n+ version.\n+\n+ This program is distributed in the hope that it will be useful, but WITHOUT ANY\n+ WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A\n+ PARTICULAR PURPOSE. See the GNU General Public License for more details.\n+\n+ You should have received a copy of the GNU General Public License along with\n+ this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package com.ichi2.anki;\n+\n+import android.content.Context;\n+import android.content.Intent;\n+import android.graphics.drawable.Drawable;\n+import android.os.Bundle;\n+import android.view.Menu;\n+import android.view.MenuItem;\n+import android.widget.EditText;\n+\n+import com.afollestad.materialdialogs.MaterialDialog;\n+import com.ichi2.anki.dialogs.DiscardChangesDialog;\n+import com.ichi2.utils.JSONObject;\n+\n+import org.jetbrains.annotations.Contract;\n+\n+import androidx.annotation.CheckResult;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.core.content.ContextCompat;\n+import timber.log.Timber;\n+\n+/** Allows specification of the Question and Answer format of a card template in the Card Browser\n+ * This is known as \"Browser Appearance\" in Anki\n+ * We do not allow the user to change fonts as Android only has a handful\n+ * We do not allow the user to change the font size as this can be done in the Appearance settings.\n+ */\n+public class CardTemplateBrowserAppearanceEditor extends AnkiActivity {\n+\n+    public static final String INTENT_QUESTION_FORMAT = \"bqfmt\";\n+    public static final String INTENT_ANSWER_FORMAT = \"bafmt\";\n+\n+    /** Specified the card browser should use the default template formatter */\n+    public static final String VALUE_USE_DEFAULT = \"\";\n+\n+    private EditText mQuestionEditText;\n+    private EditText mAnswerEditText;\n+\n+    @Override\n+    protected void onCreate(@Nullable Bundle savedInstanceState) {\n+        super.onCreate(savedInstanceState);\n+        Bundle bundle = savedInstanceState;\n+        if (bundle == null) {\n+            bundle = getIntent().getExtras();\n+        }\n+        if (bundle == null) {\n+            UIUtils.showThemedToast(this, getString(R.string.card_template_editor_card_browser_appearance_failed), true);\n+            finishActivityWithFade(this);\n+            return;\n+        }\n+        initializeUiFromBundle(bundle);\n+    }\n+\n+    @Override\n+    public boolean onCreateOptionsMenu(@NonNull Menu menu) {\n+        getMenuInflater().inflate(R.menu.card_template_browser_appearance_editor, menu);\n+        return true;\n+    }\n+\n+    @Override\n+    public boolean onOptionsItemSelected(@NonNull MenuItem item) {\n+        if (item.getItemId() == R.id.action_confirm) {\n+            Timber.i(\"Save pressed\");\n+            saveAndExit();\n+            return true;\n+        } else if (item.getItemId() == R.id.action_restore_default) {\n+            Timber.i(\"Restore Default pressed\");\n+            showRestoreDefaultDialog();\n+            return true;\n+        } else if (item.getItemId() == android.R.id.home) {\n+            Timber.i(\"Back Pressed\");\n+            closeWithDiscardWarning();\n+            return true;\n+        }\n+        return super.onOptionsItemSelected(item);\n+    }\n+\n+\n+    @Override\n+    public void onBackPressed() {\n+        Timber.i(\"Back Button Pressed\");\n+        closeWithDiscardWarning();\n+    }\n+\n+\n+    private void closeWithDiscardWarning() {\n+        if (hasChanges()) {\n+            Timber.i(\"Changes detected - displaying discard warning dialog\");\n+            showDiscardChangesDialog();\n+        } else {\n+            discardChangesAndClose();\n+        }\n+    }\n+\n+\n+    private void showDiscardChangesDialog() {\n+        DiscardChangesDialog\n+                .getDefault(this)\n+                .onPositive((dialog, which) -> discardChangesAndClose())\n+                .show();\n+    }\n+\n+\n+    private void showRestoreDefaultDialog() {\n+        MaterialDialog.Builder builder = new MaterialDialog.Builder(this)\n+                .positiveText(R.string.dialog_ok)\n+                .negativeText(R.string.cancel)\n+                .content(R.string.card_template_browser_appearance_restore_default_dialog)\n+                .onPositive((dialog, which) -> restoreDefaultAndClose());\n+        Drawable drawable = ContextCompat.getDrawable(this, R.drawable.ic_warning_white_36dp);\n+        if (drawable != null) {\n+            builder = builder.icon(drawable);\n+        }\n+        builder.show();\n+    }\n+\n+\n+    @Override\n+    public void onSaveInstanceState(@NonNull Bundle outState) {\n+        outState.putString(INTENT_QUESTION_FORMAT, getQuestionFormat());\n+        outState.putString(INTENT_ANSWER_FORMAT, getAnswerFormat());\n+        super.onSaveInstanceState(outState);\n+    }\n+\n+    private void initializeUiFromBundle(@NonNull Bundle bundle) {\n+        setContentView(R.layout.card_browser_appearance);\n+\n+        mQuestionEditText = findViewById(R.id.question_format);\n+        mQuestionEditText.setText(bundle.getString(INTENT_QUESTION_FORMAT));\n+\n+        mAnswerEditText = findViewById(R.id.answer_format);\n+        mAnswerEditText.setText(bundle.getString(INTENT_ANSWER_FORMAT));\n+\n+        enableToolbar();\n+    }\n+\n+    private boolean answerHasChanged(Intent intent) {\n+        return !intent.getStringExtra(INTENT_ANSWER_FORMAT).equals(getAnswerFormat());\n+    }\n+\n+    private boolean questionHasChanged(Intent intent) {\n+        return !intent.getStringExtra(INTENT_QUESTION_FORMAT).equals(getQuestionFormat());\n+    }\n+\n+    private String getQuestionFormat() {\n+        return getTextValue(mQuestionEditText);\n+    }\n+\n+    private String getAnswerFormat() {\n+        return getTextValue(mAnswerEditText);\n+    }\n+\n+    private String getTextValue(EditText editText) {\n+        return editText.getText().toString();\n+    }\n+\n+    private void restoreDefaultAndClose() {\n+        Timber.i(\"Restoring Default and Closing\");\n+        mQuestionEditText.setText(VALUE_USE_DEFAULT);\n+        mAnswerEditText.setText(VALUE_USE_DEFAULT);\n+        saveAndExit();\n+    }\n+\n+    private void discardChangesAndClose() {\n+        Timber.i(\"Closing and discarding changes\");\n+        setResult(RESULT_CANCELED);\n+        finishActivityWithFade(this);\n+    }\n+\n+    private void saveAndExit() {\n+        Timber.i(\"Save and Exit\");\n+        Intent data = new Intent();\n+        data.putExtra(INTENT_QUESTION_FORMAT, getQuestionFormat());\n+        data.putExtra(INTENT_ANSWER_FORMAT, getAnswerFormat());\n+        setResult(RESULT_OK, data);\n+        finishActivityWithFade(this);\n+    }\n+\n+    public boolean hasChanges() {\n+        try {\n+            Intent intent = getIntent();\n+            return questionHasChanged(intent) || answerHasChanged(intent);\n+        } catch (Exception e) {\n+            Timber.w(e, \"Failed to detect changes. Assuming true\");\n+            return true;\n+        }\n+    }\n+\n+    @NonNull @CheckResult\n+    public static Intent getIntentFromTemplate(@NonNull Context context, @NonNull JSONObject template) {\n+        String browserQuestionTemplate = template.getString(\"bqfmt\");\n+        String browserAnswerTemplate = template.getString(\"bafmt\");\n+        return CardTemplateBrowserAppearanceEditor.getIntent(context, browserQuestionTemplate, browserAnswerTemplate);\n+    }\n+\n+    @NonNull @CheckResult\n+    public static Intent getIntent(@NonNull Context context, @NonNull String questionFormat, @NonNull String answerFormat) {\n+        Intent intent = new Intent(context, CardTemplateBrowserAppearanceEditor.class);\n+        intent.putExtra(INTENT_QUESTION_FORMAT, questionFormat);\n+        intent.putExtra(INTENT_ANSWER_FORMAT, answerFormat);\n+        return intent;\n+    }\n+\n+    public static class Result {\n+        @NonNull\n+        private final String mQuestion;\n+        @NonNull\n+        private final String mAnswer;\n+\n+        private Result(String question, String answer) {\n+            this.mQuestion = question == null ? VALUE_USE_DEFAULT : question;\n+            this.mAnswer = answer == null ? VALUE_USE_DEFAULT : answer;\n+        }\n+\n+\n+        @Nullable\n+        @Contract(\"null -> null\")\n+        @SuppressWarnings(\"WeakerAccess\")\n+        public static Result fromIntent(@Nullable Intent intent) {\n+            if (intent == null) {\n+                return null;\n+            }\n+            try {\n+                String question = intent.getStringExtra(INTENT_QUESTION_FORMAT);\n+                String answer = intent.getStringExtra(INTENT_ANSWER_FORMAT);\n+                return new Result(question, answer);\n+            } catch (Exception e) {\n+                Timber.w(e, \"Could not read result from intent\");\n+                return null;\n+            }\n+        }\n+\n+        @NonNull\n+        public String getQuestion() {\n+            return mQuestion;\n+        }\n+\n+        @NonNull\n+        public String getAnswer() {\n+            return mAnswer;\n+        }\n+\n+\n+        @SuppressWarnings(\"WeakerAccess\")\n+        public void applyTo(@NonNull JSONObject template) {", "originalCommit": "88d76c6e534a01da57b915ae5b1efb558b6cb58b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU1ODU1OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6249#discussion_r429558558", "bodyText": "I can see how this avoids passing the template between activities, which is a plus since that has known potential to overflow the Bundle but it seems like a tightly bound connection where template editor calls this activity for return, and as soon as it returns it asks this activity again for some processing to create an object, and then asks that object to do work on stuff the template editor has.\nI can also see how it would work fine, but I guess it seems like it would be clearer if you sent it the template for work, and it sent back the template when it's done (using a file pass like #5151 if needed, and no need to reinvent that so could just be marked as pending.\n\nThis is what it does. This class handles the deserialisation from the Intent, and the application of the business logic stemming from that result. This data is not shared in memory between the activities, and does not fix the \"TransactionTooLarge\" - IMO it's unreasonable for a user to pass megabytes for the Card Browser as it's not rendered as HTML.\n\n...\nSolution could be just to expose the state and it's consequences to the user, explaining that they are just editing a part of the greater template, so they are only discarding the edits on the part, or that even if they save here they still need to save in the template editor or they won't actually be saved\n\nI'll add a TextView explaining this below the fields.", "author": "david-allison-1", "createdAt": "2020-05-23T16:11:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM3MjYwMw=="}], "type": "inlineReview"}, {"oid": "25676f7c3d89c8b9a85f49f10592ccb14d60665a", "url": "https://github.com/ankidroid/Anki-Android/commit/25676f7c3d89c8b9a85f49f10592ccb14d60665a", "message": "Add \"Browser Appearance\" Screen\n\nAs defined in Anki Desktop: A user can edit the format string which is\n used in the Card Browser to render a card template.\n\nThis allows them to mark the reverse side in a card, for example without\nit appearing in the UI, or removing JavaScript or media fields to reduce\nrendering time.\n\nThis adds:\n\n* UI with 2 textboxes\n* Reset to Default button\n* Save/Cancel buttons with logic\n\nFixes #5158", "committedDate": "2020-05-25T12:52:59Z", "type": "forcePushed"}, {"oid": "ebd5faab24ae07e4f451ea9e9d821f3e36aedf22", "url": "https://github.com/ankidroid/Anki-Android/commit/ebd5faab24ae07e4f451ea9e9d821f3e36aedf22", "message": "Add \"Browser Appearance\" Screen\n\nAs defined in Anki Desktop: A user can edit the format string which is\n used in the Card Browser to render a card template.\n\nThis allows them to mark the reverse side in a card, for example without\nit appearing in the UI, or removing JavaScript or media fields to reduce\nrendering time.\n\nThis adds:\n\n* UI with 2 textboxes\n* Reset to Default button\n* Save/Cancel buttons with logic\n\nFixes #5158", "committedDate": "2020-05-25T12:58:10Z", "type": "forcePushed"}, {"oid": "fdc5cdbf50b63a70b96b29c5fad4e2c9696425dd", "url": "https://github.com/ankidroid/Anki-Android/commit/fdc5cdbf50b63a70b96b29c5fad4e2c9696425dd", "message": "Add \"Browser Appearance\" Screen\n\nAs defined in Anki Desktop: A user can edit the format string which is\n used in the Card Browser to render a card template.\n\nThis allows them to mark the reverse side in a card, for example without\nit appearing in the UI, or removing JavaScript or media fields to reduce\nrendering time.\n\nThis adds:\n\n* UI with 2 textboxes\n* Reset to Default button\n* Save/Cancel buttons with logic\n\nFixes #5158", "committedDate": "2020-05-25T13:04:48Z", "type": "forcePushed"}, {"oid": "c7304bd225ab75c46a1c49d68021c74f2c69d7a2", "url": "https://github.com/ankidroid/Anki-Android/commit/c7304bd225ab75c46a1c49d68021c74f2c69d7a2", "message": "Add \"Browser Appearance\" Screen\n\nAs defined in Anki Desktop: A user can edit the format string which is\n used in the Card Browser to render a card template.\n\nThis allows them to mark the reverse side in a card, for example without\nit appearing in the UI, or removing JavaScript or media fields to reduce\nrendering time.\n\nThis adds:\n\n* UI with 2 textboxes\n* Reset to Default button\n* Save/Cancel buttons with logic\n\nFixes #5158", "committedDate": "2020-05-26T12:33:47Z", "type": "commit"}, {"oid": "c7304bd225ab75c46a1c49d68021c74f2c69d7a2", "url": "https://github.com/ankidroid/Anki-Android/commit/c7304bd225ab75c46a1c49d68021c74f2c69d7a2", "message": "Add \"Browser Appearance\" Screen\n\nAs defined in Anki Desktop: A user can edit the format string which is\n used in the Card Browser to render a card template.\n\nThis allows them to mark the reverse side in a card, for example without\nit appearing in the UI, or removing JavaScript or media fields to reduce\nrendering time.\n\nThis adds:\n\n* UI with 2 textboxes\n* Reset to Default button\n* Save/Cancel buttons with logic\n\nFixes #5158", "committedDate": "2020-05-26T12:33:47Z", "type": "forcePushed"}]}