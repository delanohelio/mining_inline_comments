{"pr_number": 6850, "pr_title": "Pre compute the next card's question", "pr_createdAt": "2020-08-08T02:03:39Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6850", "timeline": [{"oid": "7f326eb2b0b5a4ad318ff45fa48607b15635ca38", "url": "https://github.com/ankidroid/Anki-Android/commit/7f326eb2b0b5a4ad318ff45fa48607b15635ca38", "message": "NF: loadQA in card cache", "committedDate": "2020-08-13T00:31:45Z", "type": "forcePushed"}, {"oid": "15f2137c1d3e29362727a0641c952938733ae266", "url": "https://github.com/ankidroid/Anki-Android/commit/15f2137c1d3e29362727a0641c952938733ae266", "message": "NF: loadQA in card cache", "committedDate": "2020-08-13T00:36:12Z", "type": "forcePushed"}, {"oid": "a0136f169f66c2795b68b93eb2007abc9b09811c", "url": "https://github.com/ankidroid/Anki-Android/commit/a0136f169f66c2795b68b93eb2007abc9b09811c", "message": "NF: loadQA in card cache", "committedDate": "2020-08-13T01:44:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTgzODgwNA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6850#discussion_r469838804", "bodyText": "On failure, what do we want to do here?", "author": "david-allison-1", "createdAt": "2020-08-13T09:59:27Z", "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -1875,6 +1880,10 @@ public TaskData doInBackgroundCheckCardSelection(TaskData param) {\n         return new TaskData(new Object[] { hasUnsuspended, hasUnmarked});\n     }\n \n+    public void doInBackgroundPreloadNextCard() {\n+        getCol().getSched().preloadNextCard();", "originalCommit": "a0136f169f66c2795b68b93eb2007abc9b09811c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE2MDg1NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6850#discussion_r470160855", "bodyText": "Is there any reason to expect a failure here specifically ?\nIf there is no col or no sched there is no reason to do anything specifically that is not done everywhere else.\nI can't imagine any reason to fear that preloadNextCard would fail more than getCard, and we are not specifically looking for errors elsewhere. We try to precompute the next card by potentially pre-filling the queues and fetching the first card's question. If we can't find any non-empty queue, then we won't do anything. If there was actually a new card to consider and we didn't see it because of counts or something similar, then loading the next card will be potentially slow, but there is nothing I can do to prevent it", "author": "Arthur-Milchior", "createdAt": "2020-08-13T18:29:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTgzODgwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE2NjI1Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6850#discussion_r470166252", "bodyText": "I think this is an operation where if getCol.getSched() fails for example, then we're fine to log & ignore it, as answerCard will return the same card, just without caching.\nI'm not sure about the actual operation itself and how it handles exceptions.", "author": "david-allison-1", "createdAt": "2020-08-13T18:37:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTgzODgwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE4NzYxNA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6850#discussion_r470187614", "bodyText": "I added the same protection than the one on answer_card", "author": "Arthur-Milchior", "createdAt": "2020-08-13T19:13:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTgzODgwNA=="}], "type": "inlineReview"}, {"oid": "c2c92013146a70f97afa98a709b01e48d22e964e", "url": "https://github.com/ankidroid/Anki-Android/commit/c2c92013146a70f97afa98a709b01e48d22e964e", "message": "NF: loadQA in card cache", "committedDate": "2020-08-13T17:43:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE3MTc4OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6850#discussion_r470171789", "bodyText": "Why has this been added? What has been added that needs to be protected against?", "author": "david-allison-1", "createdAt": "2020-08-13T18:47:36Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sched/Sched.java", "diffHunk": "@@ -719,7 +746,7 @@ protected void _resetRevQueue() {\n \n \n     @Override\n-    protected boolean _fillRev(boolean allowSibling) {\n+    protected synchronized boolean _fillRev(boolean allowSibling) {", "originalCommit": "c2c92013146a70f97afa98a709b01e48d22e964e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE5MDU2MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6850#discussion_r470190561", "bodyText": "In practice, this \"synchronized\" is as useles as almost all other \"synchronized\" because we can never have multiple tasks in background simultaneously. And I believe the scheduler is only called in background.\nIn theory, _fillRev check if the rev queue is empty or not, if it is empty, it fills it, otherwise it states \"It's not empty, there is nothing to do here\". So you do not want two instances of _fillRev to be called simultaneously, because it would mean we are potentially filling it twice. Since they are really filling the same object, cards would be duplicate in the queue. That would not be a real trouble because they would be discarded due to self-day -spacing, but still, that's better avoided.\nI would agree that synchronizing on the queue would be better. That's actually feasible here, because the queue object never change. Do you want me to do it ?", "author": "Arthur-Milchior", "createdAt": "2020-08-13T19:18:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE3MTc4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIwNzI0OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6850#discussion_r470207248", "bodyText": "I think we should remove it, until we hit the point that we need to think about multithreading. I think we're taking on a performance loss and complexity gain for no material gain, and that's the opposite of what this PR should accomplish.", "author": "david-allison-1", "createdAt": "2020-08-13T19:49:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE3MTc4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIyOTgxNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6850#discussion_r470229815", "bodyText": "Done", "author": "Arthur-Milchior", "createdAt": "2020-08-13T20:30:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE3MTc4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE3MzgxOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6850#discussion_r470173818", "bodyText": "I don't get this logic? If cache 1 is empty, why would you not want to reload cache 2?", "author": "david-allison-1", "createdAt": "2020-08-13T18:51:17Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sched/SchedV2.java", "diffHunk": "@@ -674,6 +671,60 @@ protected Card _getCard() {\n         return _getLrnCard(true);\n     }\n \n+    /** similar to _getCard but only fill the queues without taking the card.\n+     * Returns lists that may contain the next cards.\n+     */\n+    protected List<? extends Card.Cache>[] _fillNextCard() {\n+        // learning card due?\n+        if (_preloadLrnCard(false)) {\n+            return new List[]{mLrnQueue};\n+        }\n+        // new first, or time for one?\n+        if (_timeForNewCard()) {\n+            if (_fillNew()) {\n+                return new List[]{mLrnQueue, mNewQueue};\n+            }\n+        }\n+        // Day learning first and card due?\n+        boolean dayLearnFirst = mCol.getConf().optBoolean(\"dayLearnFirst\", false);\n+        if (dayLearnFirst) {\n+            if (_fillLrnDay()) {\n+                return new List[]{mLrnQueue, mLrnDayQueue};\n+            }\n+        }\n+        // Card due for review?\n+        if (_fillRev()) {\n+            return new List[]{mLrnQueue, mRevQueue};\n+        }\n+        // day learning card due?\n+        if (!dayLearnFirst) {\n+            if (_fillLrnDay()) {\n+                return new List[]{mLrnQueue, mLrnDayQueue};\n+            }\n+        }\n+        // New cards left?\n+        if (_fillNew()) {\n+            return new List[]{mLrnQueue, mNewQueue};\n+        }\n+        // collapse or finish\n+        if (_preloadLrnCard(true)) {\n+            return new List[]{mLrnQueue};\n+        }\n+        return new List[]{};\n+    }\n+\n+    /** pre load the potential next card. It may loads many card because, depending on the time taken, the next card may\n+     * be a card in review or not. */\n+    public void preloadNextCard() {\n+        for (List<? extends Card.Cache> caches: _fillNextCard()) {\n+            if (caches.isEmpty()) {", "originalCommit": "c2c92013146a70f97afa98a709b01e48d22e964e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE5MTI0Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/6850#discussion_r470191246", "bodyText": "Thanks. My bad. In this case, it should have been \"continue\". I wrote it when I expected to return a single queue.\nCorrected", "author": "Arthur-Milchior", "createdAt": "2020-08-13T19:19:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE3MzgxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE3NDA3NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6850#discussion_r470174074", "bodyText": "Why was this changed?", "author": "david-allison-1", "createdAt": "2020-08-13T18:51:45Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sched/SchedV2.java", "diffHunk": "@@ -708,7 +759,7 @@ private void _resetNew() {\n     }\n \n     private void _resetNewQueue() {\n-        mNewDids = new LinkedList<>(mCol.getDecks().active());\n+        mNewDids = new LinkedList(mCol.getDecks().active());", "originalCommit": "c2c92013146a70f97afa98a709b01e48d22e964e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE5MjEwMA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6850#discussion_r470192100", "bodyText": "No reason I can remember.", "author": "Arthur-Milchior", "createdAt": "2020-08-13T19:21:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE3NDA3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE3NDkwOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6850#discussion_r470174909", "bodyText": "Alternate implementation: Bake the caching into the data structure, and then you don't complicate the API calls here", "author": "david-allison-1", "createdAt": "2020-08-13T18:53:20Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sched/SchedV2.java", "diffHunk": "@@ -3063,8 +3128,8 @@ public void setCurrentCard(@NonNull Card card) {\n         mCurrentCardParentsDid = currentCardParentsDid;\n         _burySiblings(card);\n         // if current card is next card or in the queue\n-        mRevQueue.remove(card.getId());\n-        mNewQueue.remove(card.getId());\n+        mRevQueue.remove(mCol.getCardCache(card.getId()));", "originalCommit": "c2c92013146a70f97afa98a709b01e48d22e964e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE5MjgxMw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6850#discussion_r470192813", "bodyText": "Which data structure ? The queue ?  I don't understand what change you want here", "author": "Arthur-Milchior", "createdAt": "2020-08-13T19:22:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE3NDkwOQ=="}], "type": "inlineReview"}, {"oid": "f83b66293eca08e6ef986e2893db82ef5f1fffc0", "url": "https://github.com/ankidroid/Anki-Android/commit/f83b66293eca08e6ef986e2893db82ef5f1fffc0", "message": "NF: Sched uses Card cache in queue", "committedDate": "2020-08-13T19:20:33Z", "type": "commit"}, {"oid": "81880a97eed1def11bbe5ba5e792af7982b66122", "url": "https://github.com/ankidroid/Anki-Android/commit/81880a97eed1def11bbe5ba5e792af7982b66122", "message": "NF: loadQA in card cache", "committedDate": "2020-08-13T19:20:33Z", "type": "forcePushed"}, {"oid": "7edd757af69a9eaebb111e4277e0df0d226e0f7e", "url": "https://github.com/ankidroid/Anki-Android/commit/7edd757af69a9eaebb111e4277e0df0d226e0f7e", "message": "NF: loadQA in card cache", "committedDate": "2020-08-13T20:30:22Z", "type": "commit"}, {"oid": "fb255d37a1620c87f90f0ca7752466fb6bf40561", "url": "https://github.com/ankidroid/Anki-Android/commit/fb255d37a1620c87f90f0ca7752466fb6bf40561", "message": "NF: CardQueue\n\nfactorizing some code so that getting head, loading first card, creating card cache and getting Card is easier", "committedDate": "2020-08-13T20:30:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIzNDM2NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6850#discussion_r470234365", "bodyText": "This should also be implemented in the card queue.\nWe need to assume that this does not return false. I'm not sure how", "author": "david-allison-1", "createdAt": "2020-08-13T20:39:40Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sched/SchedV2.java", "diffHunk": "@@ -3063,8 +3149,8 @@ public void setCurrentCard(@NonNull Card card) {\n         mCurrentCardParentsDid = currentCardParentsDid;\n         _burySiblings(card);\n         // if current card is next card or in the queue\n-        mRevQueue.remove(card.getId());\n-        mNewQueue.remove(card.getId());\n+        mRevQueue.remove(mCol.getCardCache(card.getId()));", "originalCommit": "fb255d37a1620c87f90f0ca7752466fb6bf40561", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIzODc1Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6850#discussion_r470238753", "bodyText": "Why do you need to assume it does not return false ?", "author": "Arthur-Milchior", "createdAt": "2020-08-13T20:47:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIzNDM2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIzODkyNA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6850#discussion_r470238924", "bodyText": "Added in the queue class", "author": "Arthur-Milchior", "createdAt": "2020-08-13T20:47:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIzNDM2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI0NDE5Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/6850#discussion_r470244196", "bodyText": "If it returns false, it's very likely a bug in the scheduler's logic - we shouldn't try to remove a card that doesn't exist.", "author": "david-allison-1", "createdAt": "2020-08-13T20:57:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIzNDM2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI0ODY3NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6850#discussion_r470248674", "bodyText": "I disagree. We are trying to remove the cards from both new and review queue. The current card may well be in the daily lrn queue or in the subday lrn queue. We don't want to remove cards in learning from the queue, so if we don't find the cards in the queue it only means that it is in learning.\nIt could also means that the queue had been reset in background and that setCurrentCard was executed after the reset and before the queue is filled", "author": "Arthur-Milchior", "createdAt": "2020-08-13T21:07:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIzNDM2NQ=="}], "type": "inlineReview"}, {"oid": "bf8cd0f5666b5c5f2c74731af6f556719c5a60fd", "url": "https://github.com/ankidroid/Anki-Android/commit/bf8cd0f5666b5c5f2c74731af6f556719c5a60fd", "message": "NF: CardQueue\n\nfactorizing some code so that getting head, loading first card, creating card cache and getting Card is easier", "committedDate": "2020-08-13T20:46:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI0MDkzNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6850#discussion_r470240935", "bodyText": "I think this is the final one", "author": "david-allison-1", "createdAt": "2020-08-13T20:51:15Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sched/SchedV2.java", "diffHunk": "@@ -2514,7 +2605,7 @@ protected void _burySiblings(Card card) {\n                 }\n                 // even if burying disabled, we still discard to give\n                 // same-day spacing\n-                queue_object.remove(cid);\n+                queue_object.remove(mCol.getCardCache(cid));", "originalCommit": "bf8cd0f5666b5c5f2c74731af6f556719c5a60fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI0MzYyOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6850#discussion_r470243628", "bodyText": "Done", "author": "Arthur-Milchior", "createdAt": "2020-08-13T20:56:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI0MDkzNQ=="}], "type": "inlineReview"}, {"oid": "ef5231f3f9c3b4fcb054c728dae2bb81a8645b69", "url": "https://github.com/ankidroid/Anki-Android/commit/ef5231f3f9c3b4fcb054c728dae2bb81a8645b69", "message": "NF: CardQueue\n\nfactorizing some code so that getting head, loading first card, creating card cache and getting Card is easier", "committedDate": "2020-08-13T20:56:25Z", "type": "commit"}, {"oid": "ef5231f3f9c3b4fcb054c728dae2bb81a8645b69", "url": "https://github.com/ankidroid/Anki-Android/commit/ef5231f3f9c3b4fcb054c728dae2bb81a8645b69", "message": "NF: CardQueue\n\nfactorizing some code so that getting head, loading first card, creating card cache and getting Card is easier", "committedDate": "2020-08-13T20:56:25Z", "type": "forcePushed"}]}