{"pr_number": 6180, "pr_title": "Iteratively render tags", "pr_createdAt": "2020-05-14T19:33:32Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6180", "timeline": [{"oid": "3d980426ffa3081ff99f8881d5220af49d73f0e1", "url": "https://github.com/ankidroid/Anki-Android/commit/3d980426ffa3081ff99f8881d5220af49d73f0e1", "message": "LINT: Template de-linting", "committedDate": "2020-05-14T19:27:19Z", "type": "commit"}, {"oid": "d944e2182b73625dea2dc79d28c7b5794046b1ee", "url": "https://github.com/ankidroid/Anki-Android/commit/d944e2182b73625dea2dc79d28c7b5794046b1ee", "message": "Template tag expansion must recur if needed\n\nThis is the same recursion patch needed for sections after the\nperformance change there - as tags may be replaced by tags\n\nFixes #6176", "committedDate": "2020-05-14T19:27:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQwNDI3Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/6180#discussion_r425404276", "bodyText": "I think that marking everything you can as final is a good practice.", "author": "mrozigor", "createdAt": "2020-05-14T20:16:02Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/template/Template.java", "diffHunk": "@@ -161,17 +154,34 @@ private String render_some_sections(@NonNull String template, @NonNull Map<Strin\n         return sb.toString();\n     }\n \n+    /**\n+     * Expands all tags, iteratively until all tags (even tags that are replaced by tags) are resolved.\n+     */\n+    private String render_tags(@NonNull String template, @NonNull Map<String, String> context) {\n+        /* Apply render_some_tags to the tags, until\n+           render_some_tags states that it does not find tags to replace anymore\n+           anymore. Return the last template state */\n+        String previous_template = null;\n+        while (template != null) {\n+            previous_template = template;\n+            template = render_some_tags(template, context);\n+        }\n+        return previous_template;\n+    }\n \n     /**\n-     * Renders all the tags in a template for a context.\n+     * Replaces all the tags in a template in a single pass for the values in the given context map.\n      */\n-    private String render_tags(String template, Map<String, String> context) {\n-        if (template.indexOf(ALT_HANDLEBAR_DIRECTIVE) != -1) {\n+    private String render_some_tags(String template, Map<String, String> context) {\n+        String ALT_HANDLEBAR_DIRECTIVE = \"{{=<% %>=}}\";\n+        if (template.contains(ALT_HANDLEBAR_DIRECTIVE)) {\n             template = template.replace(ALT_HANDLEBAR_DIRECTIVE, \"\").replace(\"<%\", \"{{\").replace(\"%>\", \"}}\");\n         }\n         StringBuffer sb = new StringBuffer();\n         Matcher match = sTag_re.matcher(template);\n+        boolean found = false;", "originalCommit": "d944e2182b73625dea2dc79d28c7b5794046b1ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQwODIxMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6180#discussion_r425408211", "bodyText": "Not if you're going to modify it. As we do with this one, it's not a constant.", "author": "mikehardy", "createdAt": "2020-05-14T20:23:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQwNDI3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQyODk0OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6180#discussion_r425428948", "bodyText": "Sorry, didn't wrote that it was general idea - as I can see a lot of code could be altered with final ;) But that's just some minor tweaks.", "author": "mrozigor", "createdAt": "2020-05-14T21:03:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQwNDI3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM4NzAwNw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6180#discussion_r425387007", "bodyText": "Can you make this @Nullable", "author": "david-allison-1", "createdAt": "2020-05-14T19:43:17Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/template/Template.java", "diffHunk": "@@ -161,17 +154,34 @@ private String render_some_sections(@NonNull String template, @NonNull Map<Strin\n         return sb.toString();\n     }\n \n+    /**\n+     * Expands all tags, iteratively until all tags (even tags that are replaced by tags) are resolved.\n+     */\n+    private String render_tags(@NonNull String template, @NonNull Map<String, String> context) {\n+        /* Apply render_some_tags to the tags, until\n+           render_some_tags states that it does not find tags to replace anymore\n+           anymore. Return the last template state */\n+        String previous_template = null;\n+        while (template != null) {\n+            previous_template = template;\n+            template = render_some_tags(template, context);\n+        }\n+        return previous_template;\n+    }\n \n     /**\n-     * Renders all the tags in a template for a context.\n+     * Replaces all the tags in a template in a single pass for the values in the given context map.\n      */\n-    private String render_tags(String template, Map<String, String> context) {\n-        if (template.indexOf(ALT_HANDLEBAR_DIRECTIVE) != -1) {\n+    private String render_some_tags(String template, Map<String, String> context) {", "originalCommit": "d944e2182b73625dea2dc79d28c7b5794046b1ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM4ODc3Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6180#discussion_r425388773", "bodyText": "again, @Nullable", "author": "david-allison-1", "createdAt": "2020-05-14T19:46:34Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/template/Template.java", "diffHunk": "@@ -59,38 +57,33 @@\n     private static final String sCtag = Pattern.quote(\"}}\");\n \n     // The regular expression used to find a #section\n-    private static final Pattern sSection_re = Pattern.compile(sOtag + \"[\\\\#|^]([^\\\\}]*)\" + sCtag + \"(.+?)\" + sOtag + \"/\\\\1\" + sCtag, Pattern.MULTILINE | Pattern.DOTALL);\n+    private static final Pattern sSection_re = Pattern.compile(sOtag + \"[#|^]([^}]*)\" + sCtag + \"(.+?)\" + sOtag + \"/\\\\1\" + sCtag, Pattern.MULTILINE | Pattern.DOTALL);\n \n     // The regular expression used to find a tag.\n-    private static final Pattern sTag_re = Pattern.compile(sOtag + \"(#|=|&|!|>|\\\\{)?(.+?)\\\\1?\" + sCtag + \"+\");\n+    private static final Pattern sTag_re = Pattern.compile(sOtag + \"([#=&!>{])?(.+?)\\\\1?\" + sCtag + \"+\");\n \n     // MathJax opening delimiters\n-    private static String sMathJaxOpenings[] = {\"\\\\(\", \"\\\\[\"};\n+    private static String[] sMathJaxOpenings = {\"\\\\(\", \"\\\\[\"};\n \n     // MathJax closing delimiters\n-    private static String sMathJaxClosings[] = {\"\\\\)\", \"\\\\]\"};\n+    private static String[] sMathJaxClosings = {\"\\\\)\", \"\\\\]\"};\n \n     private String mTemplate;\n     private Map<String, String> mContext;\n \n-    private static String ALT_HANDLEBAR_DIRECTIVE = \"{{=<% %>=}}\";\n \n     private static String get_or_attr(Map<String, String> obj, String name) {", "originalCommit": "d944e2182b73625dea2dc79d28c7b5794046b1ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5c4bbcbbfd9b406448ac98a000e3f635a8153c79", "url": "https://github.com/ankidroid/Anki-Android/commit/5c4bbcbbfd9b406448ac98a000e3f635a8153c79", "message": "LINT: add Nullable/NonNull annotations throughout Template\n\nThis pointed out that there was some dangerous variable passing in\nto methods that would have thrown NullPointerException in matchers\nor could violate their return contract - both patched up", "committedDate": "2020-05-14T21:27:04Z", "type": "commit"}, {"oid": "5c4bbcbbfd9b406448ac98a000e3f635a8153c79", "url": "https://github.com/ankidroid/Anki-Android/commit/5c4bbcbbfd9b406448ac98a000e3f635a8153c79", "message": "LINT: add Nullable/NonNull annotations throughout Template\n\nThis pointed out that there was some dangerous variable passing in\nto methods that would have thrown NullPointerException in matchers\nor could violate their return contract - both patched up", "committedDate": "2020-05-14T21:27:04Z", "type": "forcePushed"}]}