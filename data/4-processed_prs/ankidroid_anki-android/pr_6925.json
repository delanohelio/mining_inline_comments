{"pr_number": 6925, "pr_title": "Unit test for daily increase", "pr_createdAt": "2020-08-20T08:18:37Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6925", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg2OTk4NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6925#discussion_r473869984", "bodyText": "Could you rename this to assertNewCountIs. having test in the name implies that it's a test.", "author": "david-allison-1", "createdAt": "2020-08-20T10:40:11Z", "path": "AnkiDroid/src/test/java/com/ichi2/libanki/sched/AbstractSchedTest.java", "diffHunk": "@@ -203,4 +205,108 @@ public void siblingCorrectlyBuried() {\n         Card card = sched.getCard();\n         assertNull(card);\n     }\n+    private void testNewCount(long did, int expected) {", "originalCommit": "b60453f2f842388530ef8036060e85953be4d2fb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2a777ff3c4057ac3b1eb13ec3dcdb393455fe10f", "url": "https://github.com/ankidroid/Anki-Android/commit/2a777ff3c4057ac3b1eb13ec3dcdb393455fe10f", "message": "NF: test for daily increase of limit\n\nThis tries to deal with #6769 by reproducing the bug I understood and other similar feature\n\nIt also shows how propagating limit and daily increase may have strange behaviour that are still what is expected (but\nwe can't expect user to understand that without a good knowledge of datastructure)", "committedDate": "2020-08-20T10:43:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg3MTIxNA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6925#discussion_r473871214", "bodyText": "(Optional) I find it to be a good idea to move the private methods in a test class to below the tests - I'm not sure if we've formalised the rule, but I find it helps readability.", "author": "david-allison-1", "createdAt": "2020-08-20T10:41:49Z", "path": "AnkiDroid/src/test/java/com/ichi2/libanki/sched/AbstractSchedTest.java", "diffHunk": "@@ -203,4 +205,108 @@ public void siblingCorrectlyBuried() {\n         Card card = sched.getCard();\n         assertNull(card);\n     }\n+    private void testNewCount(long did, int expected) {\n+        getCol().getDecks().select(did);\n+        getCol().getSched().resetCounts();\n+        assertThat(getCol().getSched().counts()[0], is(expected));\n+    }\n+\n+    private void extendNew(long did) {", "originalCommit": "b60453f2f842388530ef8036060e85953be4d2fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg3NjQzOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6925#discussion_r473876438", "bodyText": "You want me to create an internal class ? I don't get your point.\nI would have thought it made things more complex.\nThe upside would be that it would allow to share variables without needing to sending them through the method call each time.", "author": "Arthur-Milchior", "createdAt": "2020-08-20T10:48:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg3MTIxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg4MjY3NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6925#discussion_r473882674", "bodyText": "Just moving the methods inside the class, no need for something internal.", "author": "david-allison-1", "createdAt": "2020-08-20T10:57:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg3MTIxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg3MTg4Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6925#discussion_r473871883", "bodyText": "Could you explain in the comment what Anki Desktop does at this point?", "author": "david-allison-1", "createdAt": "2020-08-20T10:42:43Z", "path": "AnkiDroid/src/test/java/com/ichi2/libanki/sched/AbstractSchedTest.java", "diffHunk": "@@ -203,4 +205,108 @@ public void siblingCorrectlyBuried() {\n         Card card = sched.getCard();\n         assertNull(card);\n     }\n+    private void testNewCount(long did, int expected) {\n+        getCol().getDecks().select(did);\n+        getCol().getSched().resetCounts();\n+        assertThat(getCol().getSched().counts()[0], is(expected));\n+    }\n+\n+    private void extendNew(long did) {\n+        getCol().getDecks().select(did);\n+        getCol().getSched().extendLimits(1, 0);\n+    }\n+\n+    @Test\n+    public void increaseToday() {\n+        Collection col = getCol();\n+        Decks decks = col.getDecks();\n+        Models models = col.getModels();\n+        AbstractSched sched = col.getSched();\n+\n+        DeckConfig dconf = col.getDecks().getConf(1);\n+        dconf.getJSONObject(\"new\").put(\"perDay\", 0);\n+        long aId = decks.id(\"A\");\n+        long bId = decks.id(\"A::B\");\n+        long cId = decks.id(\"A::B::C\");\n+        long dId = decks.id(\"A::B::D\");\n+\n+\n+        Model model = models.byName(\"Basic\");\n+        // The note is added in model's did. So change model's did.\n+        model.put(\"did\", cId);\n+        addNoteUsingBasicModel(\"foo\", \"bar\");\n+        addNoteUsingBasicModel(\"foo\", \"bar\");\n+        addNoteUsingBasicModel(\"foo\", \"bar\");\n+        model.put(\"did\", dId);\n+        addNoteUsingBasicModel(\"foo\", \"bar\");\n+        addNoteUsingBasicModel(\"foo\", \"bar\");\n+        addNoteUsingBasicModel(\"foo\", \"bar\");\n+        addNoteUsingBasicModel(\"foo\", \"bar\");\n+\n+        testNewCount(aId, 0);\n+        testNewCount(bId, 0);\n+        testNewCount(cId, 0);\n+        testNewCount(dId, 0);\n+\n+        extendNew(cId);\n+        testNewCount(aId, 1);\n+        testNewCount(bId, 1);\n+        testNewCount(cId, 1);\n+        testNewCount(dId, 0);\n+\n+        extendNew(aId);\n+        testNewCount(aId, 2);\n+        testNewCount(bId, 2);\n+        testNewCount(cId, 2);\n+        testNewCount(dId, 1);\n+\n+        extendNew(bId);\n+        testNewCount(aId, 3);\n+        testNewCount(bId, 3);\n+        testNewCount(cId, 3);\n+        testNewCount(dId, 2);\n+\n+        extendNew(dId);\n+        testNewCount(aId, 4);\n+        testNewCount(bId, 4);\n+        testNewCount(cId, 3);\n+        testNewCount(dId, 3);\n+\n+        extendNew(dId);\n+        testNewCount(aId, 5);\n+        testNewCount(bId, 5);\n+        testNewCount(cId, 3);\n+        testNewCount(dId, 4);\n+\n+        extendNew(cId);\n+        testNewCount(aId, 6);\n+        testNewCount(bId, 6);\n+        // I would have expected :\n+        // testNewCount(aId, 5);\n+        // But it seems that applying \"increase c\", while not actually increasing c (because there are no more new card)", "originalCommit": "b60453f2f842388530ef8036060e85953be4d2fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg4MzQ0Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6925#discussion_r473883443", "bodyText": "If you directly call those methods, it does exactly the same thing.\u00a0Not surprising, since we use the same code base.\nI should note that the GUI does not allow to add new card in a deck which have no more new card.\nSo to actually reproduce it, I need to either do:\nfrom aqt import mw\nc = mw.col.decks.byName(\"A::B::C\")\nmw.col.sched.extendLimits(1, 0)\nin the debugger\nOr to add a new card in A::B::C, increase limit, and then delete the card.\nWe apply no such restriction ourself", "author": "Arthur-Milchior", "createdAt": "2020-08-20T10:58:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg3MTg4Mw=="}], "type": "inlineReview"}, {"oid": "85642a956a79f440a17218894ac4263d14f818bb", "url": "https://github.com/ankidroid/Anki-Android/commit/85642a956a79f440a17218894ac4263d14f818bb", "message": "NF: test for daily increase of limit\n\nThis tries to deal with #6769 by reproducing the bug I understood and other similar feature\n\nIt also shows how propagating limit and daily increase may have strange behaviour that are still what is expected (but\nwe can't expect user to understand that without a good knowledge of datastructure)", "committedDate": "2020-08-20T11:26:23Z", "type": "forcePushed"}, {"oid": "523fa6f5b0ef186b40a7cf72fe7a128e299d1d8f", "url": "https://github.com/ankidroid/Anki-Android/commit/523fa6f5b0ef186b40a7cf72fe7a128e299d1d8f", "message": "NF: test for daily increase of limit\n\nThis tries to deal with #6769 by reproducing the bug I understood and other similar feature\n\nIt also shows how propagating limit and daily increase may have strange behaviour that are still what is expected (but\nwe can't expect user to understand that without a good knowledge of datastructure)", "committedDate": "2020-08-20T12:28:24Z", "type": "commit"}, {"oid": "523fa6f5b0ef186b40a7cf72fe7a128e299d1d8f", "url": "https://github.com/ankidroid/Anki-Android/commit/523fa6f5b0ef186b40a7cf72fe7a128e299d1d8f", "message": "NF: test for daily increase of limit\n\nThis tries to deal with #6769 by reproducing the bug I understood and other similar feature\n\nIt also shows how propagating limit and daily increase may have strange behaviour that are still what is expected (but\nwe can't expect user to understand that without a good knowledge of datastructure)", "committedDate": "2020-08-20T12:28:24Z", "type": "forcePushed"}]}