{"pr_number": 6506, "pr_title": "Deck import: Pre-validate zip file", "pr_createdAt": "2020-06-19T12:38:47Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6506", "timeline": [{"oid": "ae797bec726ed64e0a12b8d78f7c04f19a1c2191", "url": "https://github.com/ankidroid/Anki-Android/commit/ae797bec726ed64e0a12b8d78f7c04f19a1c2191", "message": "NF: Refactor import", "committedDate": "2020-06-19T11:49:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk1NzI1NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6506#discussion_r442957254", "bodyText": "Pretty much a nit but 'e' is for \"application has unknown state and we're basically a contained explosion at this point\", 'w' is for, input was unexpected and it definitely messes with what the user was trying to do, but internal state is fine, we know what's going on, we're good'\nThis is 'w' I think", "author": "mikehardy", "createdAt": "2020-06-19T17:14:35Z", "path": "AnkiDroid/src/main/java/com/ichi2/utils/ImportUtils.java", "diffHunk": "@@ -173,12 +174,32 @@ private String handleContentProviderFile(Context context, Intent intent, Uri dat\n                     AnkiDroidApp.sendExceptionReport(new RuntimeException(\"Error importing apkg file\"), \"IntentHandler.java\", \"apkg import failed\");\n                     return errorMessage;\n                 }\n+\n+                errorMessage = validateZipFile(context, tempOutDir);\n+                if (errorMessage != null) {\n+                    //noinspection ResultOfMethodCallIgnored\n+                    new File(tempOutDir).delete();\n+                    return errorMessage;\n+                }\n+\n                 sendShowImportFileDialogMsg(tempOutDir);\n                 return null;\n             }\n         }\n \n \n+        protected String validateZipFile(Context context, String filePath) {\n+            File file = new File(filePath);\n+            try {\n+                new ZipFile(file);\n+            } catch (Exception e) {\n+                Timber.e(e, \"Failed to validate zip\");", "originalCommit": "922ec108822cc1d5210961b8dcb89c6137e44ddc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3e58e32a0666f7c3a79471b79361337c2d62fbd0", "url": "https://github.com/ankidroid/Anki-Android/commit/3e58e32a0666f7c3a79471b79361337c2d62fbd0", "message": "Import: Fail early if zip is invalid\n\nThis means we clean up any invalid zip files and do not send exception reports\n\nFixes 6489", "committedDate": "2020-06-19T17:23:56Z", "type": "commit"}, {"oid": "3e58e32a0666f7c3a79471b79361337c2d62fbd0", "url": "https://github.com/ankidroid/Anki-Android/commit/3e58e32a0666f7c3a79471b79361337c2d62fbd0", "message": "Import: Fail early if zip is invalid\n\nThis means we clean up any invalid zip files and do not send exception reports\n\nFixes 6489", "committedDate": "2020-06-19T17:23:56Z", "type": "forcePushed"}]}