{"pr_number": 6362, "pr_title": "Improve Card Browser Performance: Time to view first card", "pr_createdAt": "2020-06-04T20:26:17Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6362", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU0MTU2NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6362#discussion_r435541565", "bodyText": "You can remove this comment now", "author": "david-allison-1", "createdAt": "2020-06-04T20:51:57Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Finder.java", "diffHunk": "@@ -1003,81 +998,4 @@ public static Integer ordForMid(Collection col, Map<Long, Integer> fields, long\n      * The methods below are not in LibAnki.", "originalCommit": "3b638b1e5356ea1642c12d14b517aec3b13c5c67", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU0OTMxNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6362#discussion_r435549315", "bodyText": "Right.\u00a0I didn't pay attention to it", "author": "Arthur-Milchior", "createdAt": "2020-06-04T21:07:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU0MTU2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU0MjUyMA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6362#discussion_r435542520", "bodyText": "Nit: Could you move to the top of the class and fix the spacing around the  =", "author": "david-allison-1", "createdAt": "2020-06-04T20:53:41Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -1481,7 +1481,9 @@ public void onClick(View v) {\n         }\n     };\n \n-    public static void updateSearchItemQA(Context context, Map<String, String> item, Card c) {\n+    private static Pattern sMarkedPattern= Pattern.compile(\".*[Mm]arked.*\");", "originalCommit": "3b638b1e5356ea1642c12d14b517aec3b13c5c67", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU0OTQyNg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6362#discussion_r435549426", "bodyText": "If you want. I find it better to have it close to its usage, but that's okay with me", "author": "Arthur-Milchior", "createdAt": "2020-06-04T21:07:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU0MjUyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU0OTU3Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/6362#discussion_r435549576", "bodyText": "Except that the change should occur in another PR. I'll do it there", "author": "Arthur-Milchior", "createdAt": "2020-06-04T21:07:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU0MjUyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU1NjEzNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6362#discussion_r435556135", "bodyText": "Except that the change should occur in another PR. I'll do it there\n\nThere's really no need unless you want to", "author": "david-allison-1", "createdAt": "2020-06-04T21:17:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU0MjUyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU3MzcyNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6362#discussion_r435573725", "bodyText": "My point was that sMarkedPattern was in #6358\nSo it's the natural place to follow your request. I actual force pushed this change on #6358", "author": "Arthur-Milchior", "createdAt": "2020-06-04T21:52:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU0MjUyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU0Mzc1OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6362#discussion_r435543759", "bodyText": "Further performance: Tags.join should be static", "author": "david-allison-1", "createdAt": "2020-06-04T20:56:01Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -1531,6 +1534,13 @@ public static void updateSearchItemQA(Context context, Map<String, String> item,\n         item.put(NOTE, c.model().optString(\"name\"));\n         item.put(QUESTION, formatQA(q, context));\n         item.put(REVIEWS, Integer.toString(c.getReps()));\n+        String tags = note.stringTags();", "originalCommit": "3b638b1e5356ea1642c12d14b517aec3b13c5c67", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU2MTkzMw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6362#discussion_r435561933", "bodyText": "I don't understand this remark", "author": "Arthur-Milchior", "createdAt": "2020-06-04T21:25:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU0Mzc1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU2MzQ5Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6362#discussion_r435563493", "bodyText": "note.stringTags is implemented as:\n        return mCol.getTags().join(mCol.getTags().canonify(mTags));\nThis can be simplified to\n        return Tags.join(mCol.getTags().canonify(mTags));\nas Tags.join refers to no instance variables.", "author": "david-allison-1", "createdAt": "2020-06-04T21:28:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU0Mzc1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU2Mzk3Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/6362#discussion_r435563976", "bodyText": "Actually... might be worth doing in a separate PR, as there's a few unrelated usages", "author": "david-allison-1", "createdAt": "2020-06-04T21:29:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU0Mzc1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU3NjY4MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6362#discussion_r435576680", "bodyText": "I don't think I've ever seen this one to be a bottle neck, but I'd certainly would be okay with such a change.", "author": "Arthur-Milchior", "createdAt": "2020-06-04T22:00:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU0Mzc1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU3NzU4Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/6362#discussion_r435577586", "bodyText": "It's a micro-optimisation that'll make the code easier to reason about, win-win :)", "author": "david-allison-1", "createdAt": "2020-06-04T22:02:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU0Mzc1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTYzMDk5OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6362#discussion_r435630999", "bodyText": "Let's leave this as TODO", "author": "david-allison-1", "createdAt": "2020-06-05T00:41:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU0Mzc1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU0NDM4Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6362#discussion_r435544382", "bodyText": "I don't get new Integer().toString() - is this validation as it'll throw otherwise?", "author": "david-allison-1", "createdAt": "2020-06-04T20:57:08Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -1531,6 +1534,13 @@ public static void updateSearchItemQA(Context context, Map<String, String> item,\n         item.put(NOTE, c.model().optString(\"name\"));\n         item.put(QUESTION, formatQA(q, context));\n         item.put(REVIEWS, Integer.toString(c.getReps()));\n+        String tags = note.stringTags();\n+        item.put(TAGS, tags);\n+        item.put(MARKED, (sMarkedPattern.matcher(item.get(TAGS)).matches())?\"marked\": null);\n+        item.put(FLAGS, (new Integer(c.getUserFlag())).toString());", "originalCommit": "3b638b1e5356ea1642c12d14b517aec3b13c5c67", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU2MzQ0MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6362#discussion_r435563441", "bodyText": "I honestly have no clue. I just copy-pasted the line\ncard.put(CardBrowser.FLAGS, (new Integer(Card.intToFlag(cur.getInt(5)))).toString());\n\nwhich already have the same strange line", "author": "Arthur-Milchior", "createdAt": "2020-06-04T21:28:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU0NDM4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU3MjEyMg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6362#discussion_r435572122", "bodyText": "Oh, it's because it's creating an Integer out of an int, and then transforming it into a string. It's not transforming a int from a string and then back to string", "author": "Arthur-Milchior", "createdAt": "2020-06-04T21:48:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU0NDM4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTYzMDMwMA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6362#discussion_r435630300", "bodyText": "card.put(FLAGS, Integer.toString(c.getUserFlag())) ?", "author": "david-allison-1", "createdAt": "2020-06-05T00:38:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU0NDM4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk2NDYwNg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6362#discussion_r435964606", "bodyText": "It is now deleted anyway", "author": "Arthur-Milchior", "createdAt": "2020-06-05T14:36:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU0NDM4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk3NDAxNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6362#discussion_r435974015", "bodyText": "Rebased to follow your advice", "author": "Arthur-Milchior", "createdAt": "2020-06-05T14:51:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU0NDM4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU0NzA2MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6362#discussion_r435547061", "bodyText": "Would be nice to Timber.d the count", "author": "david-allison-1", "createdAt": "2020-06-04T21:02:32Z", "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -895,11 +895,17 @@ private TaskData doInBackgroundSearchCards(TaskData... params) {\n         String query = (String) params[0].getObjArray()[0];\n         Boolean order = (Boolean) params[0].getObjArray()[1];\n         int numCardsToRender = (int) params[0].getObjArray()[2];\n-        List<Map<String,String>> searchResult = col.findCardsForCardBrowser(query, order);\n+        List<Long> searchResult_ = col.findCards(query, order);\n+        List<Map<String,String>> searchResult = new ArrayList<>(searchResult_.size());", "originalCommit": "3b638b1e5356ea1642c12d14b517aec3b13c5c67", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU3MzExNw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6362#discussion_r435573117", "bodyText": "Okay", "author": "Arthur-Milchior", "createdAt": "2020-06-04T21:51:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU0NzA2MQ=="}], "type": "inlineReview"}, {"oid": "fb983f23d1bdd251c2d5c8e28e1970ef5cbc0571", "url": "https://github.com/ankidroid/Anki-Android/commit/fb983f23d1bdd251c2d5c8e28e1970ef5cbc0571", "message": "Timber size of result of search", "committedDate": "2020-06-04T22:02:10Z", "type": "forcePushed"}, {"oid": "19a0e6bcff769fb2a79b4b0350d28774b7ceb335", "url": "https://github.com/ankidroid/Anki-Android/commit/19a0e6bcff769fb2a79b4b0350d28774b7ceb335", "message": "Timber size of result of search", "committedDate": "2020-06-04T23:00:59Z", "type": "forcePushed"}, {"oid": "783609ad81e5b933cd8b93bdc4a5d8ed0596029e", "url": "https://github.com/ankidroid/Anki-Android/commit/783609ad81e5b933cd8b93bdc4a5d8ed0596029e", "message": "checking which cards are marked is moved to CardBrowser\n\nCurrently, asking the browser to show the whole collection takes\nmultiple minutes. On a smaller deck, it takes 40 seconds, out of which\n15 are spent executing the regexp and looking for marked cards.\n\nMoving it to updateSearchItemQA ensure it is executed only for card we\nintend to display and save most of this time.\n\nSince \"marked\" is computed later, the color of the browser line is\ncomputed at the same time than the text, instead of being\npre-computed. So it makes the following difference:\n* before this commit, all lines are directly colored\n* after this commit, if you scroll quickly, all lines are white and\n  they become colored at the moment when they get their text.\n\n(To be even more precise, the text is filled or not depending on the\ncolumns. \"sort field\" is always filled while \"question\" is filled only\nafter the line appear on screen.)", "committedDate": "2020-06-05T11:30:27Z", "type": "commit"}, {"oid": "4570aeb1e44bd78877deee85d0b82019f355d1fb", "url": "https://github.com/ankidroid/Anki-Android/commit/4570aeb1e44bd78877deee85d0b82019f355d1fb", "message": "NF: compile pattern for marked cards", "committedDate": "2020-06-05T11:30:27Z", "type": "commit"}, {"oid": "7f3377f414da2c71ef50b87b1b6c209d0c8b2945", "url": "https://github.com/ankidroid/Anki-Android/commit/7f3377f414da2c71ef50b87b1b6c209d0c8b2945", "message": "NF: Finder._where is private", "committedDate": "2020-06-05T11:30:27Z", "type": "commit"}, {"oid": "3e276fc2272e917b7fec775761eda846b8f387fb", "url": "https://github.com/ankidroid/Anki-Android/commit/3e276fc2272e917b7fec775761eda846b8f387fb", "message": "NF: unused findCardsForCardBrowser with String", "committedDate": "2020-06-05T11:30:27Z", "type": "commit"}, {"oid": "6306e410f54d38069690d0bf7f784bbe853b3797", "url": "https://github.com/ankidroid/Anki-Android/commit/6306e410f54d38069690d0bf7f784bbe853b3797", "message": "NF: findCardsForCardBrowser removes an useless indirection", "committedDate": "2020-06-05T11:30:27Z", "type": "commit"}, {"oid": "c675255c2dd305af7da3b6d8730de04c9684ef91", "url": "https://github.com/ankidroid/Anki-Android/commit/c675255c2dd305af7da3b6d8730de04c9684ef91", "message": "NF: remove useless findCards", "committedDate": "2020-06-05T11:30:27Z", "type": "commit"}, {"oid": "f884e785d57513c684fa992df32dcd234078a385", "url": "https://github.com/ankidroid/Anki-Android/commit/f884e785d57513c684fa992df32dcd234078a385", "message": "NF: move computation of flag string to card browser", "committedDate": "2020-06-05T11:30:27Z", "type": "commit"}, {"oid": "4a178ba8419c9ca4da29fecd639f2e00c0ba141c", "url": "https://github.com/ankidroid/Anki-Android/commit/4a178ba8419c9ca4da29fecd639f2e00c0ba141c", "message": "NF: add variable note in updateSearchItemQA", "committedDate": "2020-06-05T11:30:27Z", "type": "commit"}, {"oid": "ba3088dca4876c86e1feb0f0335ce8b218bbafac", "url": "https://github.com/ankidroid/Anki-Android/commit/ba3088dca4876c86e1feb0f0335ce8b218bbafac", "message": "NF: tags put in cardbrowser and not finder", "committedDate": "2020-06-05T11:30:27Z", "type": "commit"}, {"oid": "654b5f00e2da527c2dea394210524cdce275a9ce", "url": "https://github.com/ankidroid/Anki-Android/commit/654b5f00e2da527c2dea394210524cdce275a9ce", "message": "NF: move suspended to cardbrowser", "committedDate": "2020-06-05T11:30:27Z", "type": "commit"}, {"oid": "e6e96b8a762942a18b24787a4ec3e91d6070479b", "url": "https://github.com/ankidroid/Anki-Android/commit/e6e96b8a762942a18b24787a4ec3e91d6070479b", "message": "NF: add col parameter to updateSearchItemQA", "committedDate": "2020-06-05T11:30:27Z", "type": "commit"}, {"oid": "d02c4af7f391992ac9ec3c7ed2d5e8113ad28f13", "url": "https://github.com/ankidroid/Anki-Android/commit/d02c4af7f391992ac9ec3c7ed2d5e8113ad28f13", "message": "NF: Deck name is put in card browser", "committedDate": "2020-06-05T11:30:27Z", "type": "commit"}, {"oid": "db867c9006c24de3f8ad5ea0e6f68e35fe13e66c", "url": "https://github.com/ankidroid/Anki-Android/commit/db867c9006c24de3f8ad5ea0e6f68e35fe13e66c", "message": "NF: SFLD put in cardbrowser and not Finder", "committedDate": "2020-06-05T11:30:27Z", "type": "commit"}, {"oid": "3bec1daed99ac459f39a7ab311ea6b85565b9fe1", "url": "https://github.com/ankidroid/Anki-Android/commit/3bec1daed99ac459f39a7ab311ea6b85565b9fe1", "message": "NF: remove place holders for Question/Answer\n\nSeems they are not checked anymore anyplace", "committedDate": "2020-06-05T11:30:27Z", "type": "commit"}, {"oid": "00e1bb835fd81d304cb4c709947e480725fe8bca", "url": "https://github.com/ankidroid/Anki-Android/commit/00e1bb835fd81d304cb4c709947e480725fe8bca", "message": "NF: find cards with boolean", "committedDate": "2020-06-05T11:30:27Z", "type": "commit"}, {"oid": "8293ad235b65d93695ed4d8eeb1b4b421d8c2d56", "url": "https://github.com/ankidroid/Anki-Android/commit/8293ad235b65d93695ed4d8eeb1b4b421d8c2d56", "message": "NF: uses findCards and not forCardBrowser", "committedDate": "2020-06-05T11:30:27Z", "type": "commit"}, {"oid": "d57fc520792964beb32dbd95761f30a48f2e39a4", "url": "https://github.com/ankidroid/Anki-Android/commit/d57fc520792964beb32dbd95761f30a48f2e39a4", "message": "NF: remove unused findCardsForCardBrowser", "committedDate": "2020-06-05T11:30:27Z", "type": "commit"}, {"oid": "085b1b0fcd928f4417b784d6874a51fcfbf26d25", "url": "https://github.com/ankidroid/Anki-Android/commit/085b1b0fcd928f4417b784d6874a51fcfbf26d25", "message": "NF: remove unused findCardsForCardBrowser", "committedDate": "2020-06-05T11:30:27Z", "type": "commit"}, {"oid": "baa0ac4c03547dec5b71c44cf30a88b79cac434a", "url": "https://github.com/ankidroid/Anki-Android/commit/baa0ac4c03547dec5b71c44cf30a88b79cac434a", "message": "NF: Remove unused _queryForCardBrowser", "committedDate": "2020-06-05T11:30:27Z", "type": "commit"}, {"oid": "7fccc05cde4e26216a73054bd61bd5278c507f6d", "url": "https://github.com/ankidroid/Anki-Android/commit/7fccc05cde4e26216a73054bd61bd5278c507f6d", "message": "NF: use enum for column", "committedDate": "2020-06-05T14:34:04Z", "type": "forcePushed"}, {"oid": "2114aeedad26a5384d6d6a46289f72e405f8c9e9", "url": "https://github.com/ankidroid/Anki-Android/commit/2114aeedad26a5384d6d6a46289f72e405f8c9e9", "message": "NF: Integer.toString instead of new Integer().toString", "committedDate": "2020-06-05T14:55:29Z", "type": "forcePushed"}, {"oid": "c47f1e596152a515866c87d7098d9d269709fea5", "url": "https://github.com/ankidroid/Anki-Android/commit/c47f1e596152a515866c87d7098d9d269709fea5", "message": "Timber size of result of search", "committedDate": "2020-06-05T15:13:37Z", "type": "commit"}, {"oid": "daa3086e96b6ef50a1e526f126920025a2c28c6f", "url": "https://github.com/ankidroid/Anki-Android/commit/daa3086e96b6ef50a1e526f126920025a2c28c6f", "message": "NF: Integer.toString instead of new Integer().toString", "committedDate": "2020-06-05T15:13:37Z", "type": "commit"}, {"oid": "daa3086e96b6ef50a1e526f126920025a2c28c6f", "url": "https://github.com/ankidroid/Anki-Android/commit/daa3086e96b6ef50a1e526f126920025a2c28c6f", "message": "NF: Integer.toString instead of new Integer().toString", "committedDate": "2020-06-05T15:13:37Z", "type": "forcePushed"}]}