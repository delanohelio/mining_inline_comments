{"pr_number": 7513, "pr_title": "Show partial result in browser before showing all", "pr_createdAt": "2020-10-25T14:52:25Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/7513", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjEwMjA3Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7513#discussion_r512102073", "bodyText": "typo mPositino -> mPosition but it won't let me make the suggestion", "author": "mikehardy", "createdAt": "2020-10-26T16:36:37Z", "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -1176,6 +1176,59 @@ private TaskData doInBackgroundUndo() {\n     }\n \n \n+    /**\n+     * A class allowing to send partial search result to the browser to display while the search ends\n+     */\n+    public class PartialSearch implements CancelListener, ProgressSender<List<Long>> {\n+        private final List<CardBrowser.CardCache> mCards;\n+        private int mPosition = 0;\n+        private final int mColumn1Index, mColumn2Index;\n+        private final int mNumCardsToRender;\n+\n+        public PartialSearch(List<CardBrowser.CardCache> cards, int columnIndex1, int columnIndex2, int numCardsToRender) {\n+            mCards = cards;\n+            mColumn1Index = columnIndex1;\n+            mColumn2Index = columnIndex2;\n+            mNumCardsToRender = numCardsToRender;\n+        }\n+\n+        @Override\n+        public boolean isCancelled() {\n+            return CollectionTask.this.isCancelled();\n+        }\n+\n+\n+        /**\n+         * @param cids Card ids to display in the browser. It is assumed that its length is at least `mPosition`, and that mCards[i].cid = cids[i].\n+         *             It add the cards in cids after `mPosition` to mCards\n+         */\n+        public void add(@NonNull List<Long> cids) {\n+            for (; mPosition < cids.size(); ++mPosition) {\n+                mCards.add(new CardBrowser.CardCache(cids.get(mPosition), getCol(), mPosition));\n+            }\n+            // At the end of the loop, mPositino is the size of cids, we want it to be the last position in cids", "originalCommit": "f81f4d15af88bf4dd85dac7e629f2c384f38accc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE2Mzc3NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7513#discussion_r512163775", "bodyText": "Done", "author": "Arthur-Milchior", "createdAt": "2020-10-26T18:02:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjEwMjA3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjEwMzgyNg==", "url": "https://github.com/ankidroid/Anki-Android/pull/7513#discussion_r512103826", "bodyText": "formatting here, missing 4-space indent", "author": "mikehardy", "createdAt": "2020-10-26T16:39:10Z", "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -1176,6 +1176,59 @@ private TaskData doInBackgroundUndo() {\n     }\n \n \n+    /**\n+     * A class allowing to send partial search result to the browser to display while the search ends\n+     */\n+    public class PartialSearch implements CancelListener, ProgressSender<List<Long>> {\n+        private final List<CardBrowser.CardCache> mCards;\n+        private int mPosition = 0;\n+        private final int mColumn1Index, mColumn2Index;\n+        private final int mNumCardsToRender;\n+\n+        public PartialSearch(List<CardBrowser.CardCache> cards, int columnIndex1, int columnIndex2, int numCardsToRender) {\n+            mCards = cards;\n+            mColumn1Index = columnIndex1;\n+            mColumn2Index = columnIndex2;\n+            mNumCardsToRender = numCardsToRender;\n+        }\n+\n+        @Override\n+        public boolean isCancelled() {\n+            return CollectionTask.this.isCancelled();\n+        }\n+\n+\n+        /**\n+         * @param cids Card ids to display in the browser. It is assumed that its length is at least `mPosition`, and that mCards[i].cid = cids[i].\n+         *             It add the cards in cids after `mPosition` to mCards\n+         */\n+        public void add(@NonNull List<Long> cids) {\n+            for (; mPosition < cids.size(); ++mPosition) {\n+                mCards.add(new CardBrowser.CardCache(cids.get(mPosition), getCol(), mPosition));\n+            }\n+            // At the end of the loop, mPositino is the size of cids, we want it to be the last position in cids\n+            mPosition--;\n+        }\n+\n+\n+        @Override\n+        public void doProgress(@NonNull List<Long>... values) {\n+            add(values[0]);\n+            for (CardBrowser.CardCache card : mCards) {\n+                if (isCancelled()) {\n+                Timber.d(\"doInBackgroundSearchCards was cancelled so return\u00ab\");", "originalCommit": "f81f4d15af88bf4dd85dac7e629f2c384f38accc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE2MzcyMw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7513#discussion_r512163723", "bodyText": "Done", "author": "Arthur-Milchior", "createdAt": "2020-10-26T18:02:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjEwMzgyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjEwNzg5MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7513#discussion_r512107890", "bodyText": "curious - if it's just one loop, why extract it? it seems more difficult to read this way, as it implies it might be used elsewhere (and thus update internal state) but it is only used in doProgress I think?", "author": "mikehardy", "createdAt": "2020-10-26T16:45:00Z", "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -1176,6 +1176,59 @@ private TaskData doInBackgroundUndo() {\n     }\n \n \n+    /**\n+     * A class allowing to send partial search result to the browser to display while the search ends\n+     */\n+    public class PartialSearch implements CancelListener, ProgressSender<List<Long>> {\n+        private final List<CardBrowser.CardCache> mCards;\n+        private int mPosition = 0;\n+        private final int mColumn1Index, mColumn2Index;\n+        private final int mNumCardsToRender;\n+\n+        public PartialSearch(List<CardBrowser.CardCache> cards, int columnIndex1, int columnIndex2, int numCardsToRender) {\n+            mCards = cards;\n+            mColumn1Index = columnIndex1;\n+            mColumn2Index = columnIndex2;\n+            mNumCardsToRender = numCardsToRender;\n+        }\n+\n+        @Override\n+        public boolean isCancelled() {\n+            return CollectionTask.this.isCancelled();\n+        }\n+\n+\n+        /**\n+         * @param cids Card ids to display in the browser. It is assumed that its length is at least `mPosition`, and that mCards[i].cid = cids[i].\n+         *             It add the cards in cids after `mPosition` to mCards\n+         */\n+        public void add(@NonNull List<Long> cids) {\n+            for (; mPosition < cids.size(); ++mPosition) {\n+                mCards.add(new CardBrowser.CardCache(cids.get(mPosition), getCol(), mPosition));\n+            }\n+            // At the end of the loop, mPositino is the size of cids, we want it to be the last position in cids\n+            mPosition--;\n+        }\n+\n+\n+        @Override\n+        public void doProgress(@NonNull List<Long>... values) {\n+            add(values[0]);", "originalCommit": "f81f4d15af88bf4dd85dac7e629f2c384f38accc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE3MDgxMg==", "url": "https://github.com/ankidroid/Anki-Android/pull/7513#discussion_r512170812", "bodyText": "No, the method add is also used in doInBackgroundSearchCards, where the end of the card list are also added", "author": "Arthur-Milchior", "createdAt": "2020-10-26T18:13:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjEwNzg5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE5NTUxMw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7513#discussion_r512195513", "bodyText": "Ah - okay, thanks", "author": "mikehardy", "createdAt": "2020-10-26T18:54:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjEwNzg5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjExMDQ5MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7513#discussion_r512110491", "bodyText": "I think you could eliminate the mPosition state here - if I'm reading correctly, mPosition is \"mCards.size() - 1\" at all times? Then this loop can be a standard iterator for (int i = (mCards - 1); i < cids.size(); i++), eliminating both the state and the more complicated for-loop construction?", "author": "mikehardy", "createdAt": "2020-10-26T16:47:57Z", "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -1176,6 +1176,59 @@ private TaskData doInBackgroundUndo() {\n     }\n \n \n+    /**\n+     * A class allowing to send partial search result to the browser to display while the search ends\n+     */\n+    public class PartialSearch implements CancelListener, ProgressSender<List<Long>> {\n+        private final List<CardBrowser.CardCache> mCards;\n+        private int mPosition = 0;\n+        private final int mColumn1Index, mColumn2Index;\n+        private final int mNumCardsToRender;\n+\n+        public PartialSearch(List<CardBrowser.CardCache> cards, int columnIndex1, int columnIndex2, int numCardsToRender) {\n+            mCards = cards;\n+            mColumn1Index = columnIndex1;\n+            mColumn2Index = columnIndex2;\n+            mNumCardsToRender = numCardsToRender;\n+        }\n+\n+        @Override\n+        public boolean isCancelled() {\n+            return CollectionTask.this.isCancelled();\n+        }\n+\n+\n+        /**\n+         * @param cids Card ids to display in the browser. It is assumed that its length is at least `mPosition`, and that mCards[i].cid = cids[i].\n+         *             It add the cards in cids after `mPosition` to mCards\n+         */\n+        public void add(@NonNull List<Long> cids) {\n+            for (; mPosition < cids.size(); ++mPosition) {", "originalCommit": "f81f4d15af88bf4dd85dac7e629f2c384f38accc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE2OTk5NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7513#discussion_r512169994", "bodyText": "You're right in the fact that mCards.size() can be used instead of mPosition and this is corrected. The correction is not exact, so I did not follow your loop", "author": "Arthur-Milchior", "createdAt": "2020-10-26T18:12:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjExMDQ5MQ=="}], "type": "inlineReview"}, {"oid": "607aef7f1398f5d67c8307d5efcdc66bce61a363", "url": "https://github.com/ankidroid/Anki-Android/commit/607aef7f1398f5d67c8307d5efcdc66bce61a363", "message": "NF: comment query", "committedDate": "2020-10-26T18:14:03Z", "type": "forcePushed"}, {"oid": "eafcf9466ad28fbb15aff87868183443b7e26b7a", "url": "https://github.com/ankidroid/Anki-Android/commit/eafcf9466ad28fbb15aff87868183443b7e26b7a", "message": "NF: comment query", "committedDate": "2020-10-26T20:52:18Z", "type": "forcePushed"}, {"oid": "0b0c48f73950e1d25cd0d2f4f70239ad6ace3c98", "url": "https://github.com/ankidroid/Anki-Android/commit/0b0c48f73950e1d25cd0d2f4f70239ad6ace3c98", "message": "Show partial result in browser before showing all", "committedDate": "2020-10-28T00:01:09Z", "type": "commit"}, {"oid": "de5e4cd325b2cc0bb52b1c9590f0060e5e2906e9", "url": "https://github.com/ankidroid/Anki-Android/commit/de5e4cd325b2cc0bb52b1c9590f0060e5e2906e9", "message": "NF: comment query", "committedDate": "2020-10-28T00:01:09Z", "type": "commit"}, {"oid": "de5e4cd325b2cc0bb52b1c9590f0060e5e2906e9", "url": "https://github.com/ankidroid/Anki-Android/commit/de5e4cd325b2cc0bb52b1c9590f0060e5e2906e9", "message": "NF: comment query", "committedDate": "2020-10-28T00:01:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzEwMzU1MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7513#discussion_r513103551", "bodyText": "Nit: encapsulate searchResult, and rename the other variable", "author": "david-allison-1", "createdAt": "2020-10-28T00:07:22Z", "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -1188,23 +1238,12 @@ private TaskData doInBackgroundSearchCards(TaskData param) {\n         }\n         int column1Index = (Integer) param.getObjArray()[3];\n         int column2Index = (Integer) param.getObjArray()[4];\n-        List<Long> searchResult_ = col.findCards(query, order, this);\n+        final List<CardBrowser.CardCache> searchResult = new ArrayList<>();\n+        PartialSearch partialSearch = new PartialSearch(searchResult, column1Index, column2Index, numCardsToRender);", "originalCommit": "de5e4cd325b2cc0bb52b1c9590f0060e5e2906e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM3OTMwNw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7513#discussion_r526379307", "bodyText": "Sorry, i missed your message.\nAlso sorry, I don't understand what you expect me to do. Where should I encapsulate it?", "author": "Arthur-Milchior", "createdAt": "2020-11-18T19:56:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzEwMzU1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU2MzcxMw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7513#discussion_r526563713", "bodyText": "Using searchResult and searchResult_ for different variables is confusing\nYou should be fine to inline searchResult as it doesn't appear to be used again, that lets you rename searchResult_ to searchResult", "author": "david-allison-1", "createdAt": "2020-11-19T03:09:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzEwMzU1MQ=="}], "type": "inlineReview"}]}