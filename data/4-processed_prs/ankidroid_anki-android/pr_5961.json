{"pr_number": 5961, "pr_title": "Collapsing a deck get quick", "pr_createdAt": "2020-04-09T14:53:32Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/5961", "timeline": [{"oid": "05cca4230482e01697dd2de80f48b7303e87efaf", "url": "https://github.com/ankidroid/Anki-Android/commit/05cca4230482e01697dd2de80f48b7303e87efaf", "message": "Collapsing a deck get quick\n\nCurrently, collapsing a deck calls `updateDeckList`. This methods\nrecompute the number of cards to review in each deck and subdecks. On\nmy collection, it's a 30 seconds long operation. This operation is\ntotally useless when decks get collapsed since this does not change\nthe deck hierarchy at all.\n\nI just took a part of the postExecute method which updates the view\nand put it in an external function `__renderPage`. The method\n`__renderPage` is called from `updateDeckList`'s `onPostExecute` and\nwhen a deck is (un)collapsed. This decrease collapsing down to under a\nsecond on my phone.\n\nIn order to allow `__renderPage` to do its computation, a variable\n`mDueTree` is added, which save the last due tree.\n\nThe name `mDueTree` and `__renderPage` are related to the variables\n`_dueTree` and `__renderPage`. in qt/deckbrowser.py", "committedDate": "2020-04-09T17:28:58Z", "type": "forcePushed"}, {"oid": "ba9314eb0ebf32d0c9f625a2152e21954b71843d", "url": "https://github.com/ankidroid/Anki-Android/commit/ba9314eb0ebf32d0c9f625a2152e21954b71843d", "message": "Collapsing a deck get quick\n\nCurrently, collapsing a deck calls `updateDeckList`. This methods\nrecompute the number of cards to review in each deck and subdecks. On\nmy collection, it's a 30 seconds long operation. This operation is\ntotally useless when decks get collapsed since this does not change\nthe deck hierarchy at all.\n\nI just took a part of the postExecute method which updates the view\nand put it in an external function `__renderPage`. The method\n`__renderPage` is called from `updateDeckList`'s `onPostExecute` and\nwhen a deck is (un)collapsed. This decrease collapsing down to under a\nsecond on my phone.\n\nIn order to allow `__renderPage` to do its computation, a variable\n`mDueTree` is added, which save the last due tree.\n\nThe name `mDueTree` and `__renderPage` are related to the variables\n`_dueTree` and `__renderPage`. in qt/deckbrowser.py", "committedDate": "2020-04-09T17:30:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQyNDAxNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5961#discussion_r406424015", "bodyText": "I worry about how this will work across activity restarts, mDueTree would be null unless it was saved/restored in onSaveInstance/onCreate (which we can't do because it is unbounded data and the Bundle for Activity save/restore has finite size).\nI think there should be a null check for mDueTree here and if it's null you'll have to forego the optimization and call updateDeckList from here then return\nRelated, are there any conditions where mDueTree should be invalidated where it is not? My analysis was that updateDeckList would always overwrite it when necessary, but it's worth a triple check to make sure you agree", "author": "mikehardy", "createdAt": "2020-04-09T19:20:45Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -2093,39 +2095,43 @@ public void onPostExecute(TaskData result) {\n                     showCollectionErrorDialog();\n                     return;\n                 }\n-                List<Sched.DeckDueTreeNode> nodes = (List<Sched.DeckDueTreeNode>) result.getObjArray()[0];\n-                mDeckListAdapter.buildDeckList(nodes, getCol());\n-\n-                // Set the \"x due in y minutes\" subtitle\n-                try {\n-                    int eta = mDeckListAdapter.getEta();\n-                    int due = mDeckListAdapter.getDue();\n-                    Resources res = getResources();\n-                    if (getCol().cardCount() != -1) {\n-                        String time = \"-\";\n-                        if (eta != -1) {\n-                            time = Utils.timeQuantity(AnkiDroidApp.getInstance(), eta*60);\n-                        }\n-                        if (getSupportActionBar() != null) {\n-                            getSupportActionBar().setSubtitle(res.getQuantityString(R.plurals.deckpicker_title, due, due, time));\n-                        }\n-                    }\n-                } catch (RuntimeException e) {\n-                    Timber.e(e, \"RuntimeException setting time remaining\");\n-                }\n-\n-                long current = getCol().getDecks().current().optLong(\"id\");\n-                if (mFocusedDeck != current) {\n-                    scrollDecklistToDeck(current);\n-                    mFocusedDeck = current;\n-                }\n+                mDueTree = (List<Sched.DeckDueTreeNode>) result.getObjArray()[0];\n \n+                __renderPage();\n                 // Update the mini statistics bar as well\n                 AnkiStatsTaskHandler.createReviewSummaryStatistics(getCol(), mReviewSummaryTextView);\n             }\n         });\n     }\n \n+    public void __renderPage() {\n+        mDeckListAdapter.buildDeckList(mDueTree, getCol());", "originalCommit": "ba9314eb0ebf32d0c9f625a2152e21954b71843d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQzMzE4Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/5961#discussion_r406433183", "bodyText": "Thanks. I really have trouble keeping my head around all of the specificity of a graphical user interface. I have not yet used ankidroid enough to see that it was a problem here.\nI pushed a correction", "author": "Arthur-Milchior", "createdAt": "2020-04-09T19:38:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQyNDAxNQ=="}], "type": "inlineReview"}, {"oid": "0f3cdf3332e0f0585b112cbd9dd97343039c0244", "url": "https://github.com/ankidroid/Anki-Android/commit/0f3cdf3332e0f0585b112cbd9dd97343039c0244", "message": "Collapsing a deck get quick\n\nCurrently, collapsing a deck calls `updateDeckList`. This methods\nrecompute the number of cards to review in each deck and subdecks. On\nmy collection, it's a 30 seconds long operation. This operation is\ntotally useless when decks get collapsed since this does not change\nthe deck hierarchy at all.\n\nI just took a part of the postExecute method which updates the view\nand put it in an external function `__renderPage`. The method\n`__renderPage` is called from `updateDeckList`'s `onPostExecute` and\nwhen a deck is (un)collapsed. This decrease collapsing down to under a\nsecond on my phone.\n\nIn order to allow `__renderPage` to do its computation, a variable\n`mDueTree` is added, which save the last due tree.\n\nThe name `mDueTree` and `__renderPage` are related to the variables\n`_dueTree` and `__renderPage`. in qt/deckbrowser.py", "committedDate": "2020-04-09T19:37:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ1MDM4OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5961#discussion_r406450389", "bodyText": "this is a good start but my comment contained the last bit as well \"then return\" - updateDeckList actually fires off an AsyncTask and only in that future timeline in the onPostExecute will mDueTree have a value, so we cannot proceed here on our timeline to use mDueTree, because it is still null. So after checking for null, we schedule that work but then we have to just call return here so we don't do anymore work. onPostExecute in updateDeckList will set mDueTree and call back into this code later, and we'll make it past this check and be able to do the work", "author": "mikehardy", "createdAt": "2020-04-09T20:12:03Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -2093,39 +2095,48 @@ public void onPostExecute(TaskData result) {\n                     showCollectionErrorDialog();\n                     return;\n                 }\n-                List<Sched.DeckDueTreeNode> nodes = (List<Sched.DeckDueTreeNode>) result.getObjArray()[0];\n-                mDeckListAdapter.buildDeckList(nodes, getCol());\n-\n-                // Set the \"x due in y minutes\" subtitle\n-                try {\n-                    int eta = mDeckListAdapter.getEta();\n-                    int due = mDeckListAdapter.getDue();\n-                    Resources res = getResources();\n-                    if (getCol().cardCount() != -1) {\n-                        String time = \"-\";\n-                        if (eta != -1) {\n-                            time = Utils.timeQuantity(AnkiDroidApp.getInstance(), eta*60);\n-                        }\n-                        if (getSupportActionBar() != null) {\n-                            getSupportActionBar().setSubtitle(res.getQuantityString(R.plurals.deckpicker_title, due, due, time));\n-                        }\n-                    }\n-                } catch (RuntimeException e) {\n-                    Timber.e(e, \"RuntimeException setting time remaining\");\n-                }\n-\n-                long current = getCol().getDecks().current().optLong(\"id\");\n-                if (mFocusedDeck != current) {\n-                    scrollDecklistToDeck(current);\n-                    mFocusedDeck = current;\n-                }\n+                mDueTree = (List<Sched.DeckDueTreeNode>) result.getObjArray()[0];\n \n+                __renderPage();\n                 // Update the mini statistics bar as well\n                 AnkiStatsTaskHandler.createReviewSummaryStatistics(getCol(), mReviewSummaryTextView);\n             }\n         });\n     }\n \n+    public void __renderPage() {\n+        if (mDueTree == null) {\n+            // mDueTree may be set back to null when the activity restart.\n+            // We may need to recompute it.\n+            updateDeckList();", "originalCommit": "0f3cdf3332e0f0585b112cbd9dd97343039c0244", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ1NDk4Nw==", "url": "https://github.com/ankidroid/Anki-Android/pull/5961#discussion_r406454987", "bodyText": "Yeah, of course returning make sens. I don't know what I was thinking in this change.", "author": "Arthur-Milchior", "createdAt": "2020-04-09T20:21:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ1MDM4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ1NTY3Nw==", "url": "https://github.com/ankidroid/Anki-Android/pull/5961#discussion_r406455677", "bodyText": "Pushed. Thanks for the explanation.", "author": "Arthur-Milchior", "createdAt": "2020-04-09T20:23:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ1MDM4OQ=="}], "type": "inlineReview"}, {"oid": "f74e827e166253197a2375b074f9fd337bcd29d2", "url": "https://github.com/ankidroid/Anki-Android/commit/f74e827e166253197a2375b074f9fd337bcd29d2", "message": "Collapsing a deck get quick\n\nCurrently, collapsing a deck calls `updateDeckList`. This methods\nrecompute the number of cards to review in each deck and subdecks. On\nmy collection, it's a 30 seconds long operation. This operation is\ntotally useless when decks get collapsed since this does not change\nthe deck hierarchy at all.\n\nI just took a part of the postExecute method which updates the view\nand put it in an external function `__renderPage`. The method\n`__renderPage` is called from `updateDeckList`'s `onPostExecute` and\nwhen a deck is (un)collapsed. This decrease collapsing down to under a\nsecond on my phone.\n\nIn order to allow `__renderPage` to do its computation, a variable\n`mDueTree` is added, which save the last due tree.\n\nThe name `mDueTree` and `__renderPage` are related to the variables\n`_dueTree` and `__renderPage`. in qt/deckbrowser.py", "committedDate": "2020-04-09T20:22:29Z", "type": "commit"}, {"oid": "f74e827e166253197a2375b074f9fd337bcd29d2", "url": "https://github.com/ankidroid/Anki-Android/commit/f74e827e166253197a2375b074f9fd337bcd29d2", "message": "Collapsing a deck get quick\n\nCurrently, collapsing a deck calls `updateDeckList`. This methods\nrecompute the number of cards to review in each deck and subdecks. On\nmy collection, it's a 30 seconds long operation. This operation is\ntotally useless when decks get collapsed since this does not change\nthe deck hierarchy at all.\n\nI just took a part of the postExecute method which updates the view\nand put it in an external function `__renderPage`. The method\n`__renderPage` is called from `updateDeckList`'s `onPostExecute` and\nwhen a deck is (un)collapsed. This decrease collapsing down to under a\nsecond on my phone.\n\nIn order to allow `__renderPage` to do its computation, a variable\n`mDueTree` is added, which save the last due tree.\n\nThe name `mDueTree` and `__renderPage` are related to the variables\n`_dueTree` and `__renderPage`. in qt/deckbrowser.py", "committedDate": "2020-04-09T20:22:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ1NjU3MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/5961#discussion_r406456570", "bodyText": "Issue found: The instance method name '__renderPage' doesn't match '[a-z][a-zA-Z0-9]*'", "author": "timrae", "createdAt": "2020-04-09T20:24:49Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -2093,39 +2095,49 @@ public void onPostExecute(TaskData result) {\n                     showCollectionErrorDialog();\n                     return;\n                 }\n-                List<Sched.DeckDueTreeNode> nodes = (List<Sched.DeckDueTreeNode>) result.getObjArray()[0];\n-                mDeckListAdapter.buildDeckList(nodes, getCol());\n-\n-                // Set the \"x due in y minutes\" subtitle\n-                try {\n-                    int eta = mDeckListAdapter.getEta();\n-                    int due = mDeckListAdapter.getDue();\n-                    Resources res = getResources();\n-                    if (getCol().cardCount() != -1) {\n-                        String time = \"-\";\n-                        if (eta != -1) {\n-                            time = Utils.timeQuantity(AnkiDroidApp.getInstance(), eta*60);\n-                        }\n-                        if (getSupportActionBar() != null) {\n-                            getSupportActionBar().setSubtitle(res.getQuantityString(R.plurals.deckpicker_title, due, due, time));\n-                        }\n-                    }\n-                } catch (RuntimeException e) {\n-                    Timber.e(e, \"RuntimeException setting time remaining\");\n-                }\n-\n-                long current = getCol().getDecks().current().optLong(\"id\");\n-                if (mFocusedDeck != current) {\n-                    scrollDecklistToDeck(current);\n-                    mFocusedDeck = current;\n-                }\n+                mDueTree = (List<Sched.DeckDueTreeNode>) result.getObjArray()[0];\n \n+                __renderPage();\n                 // Update the mini statistics bar as well\n                 AnkiStatsTaskHandler.createReviewSummaryStatistics(getCol(), mReviewSummaryTextView);\n             }\n         });\n     }\n \n+    public void __renderPage() {", "originalCommit": "f74e827e166253197a2375b074f9fd337bcd29d2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}