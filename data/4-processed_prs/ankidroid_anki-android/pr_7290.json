{"pr_number": 7290, "pr_title": "Empty card progress", "pr_createdAt": "2020-09-27T14:30:01Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/7290", "timeline": [{"oid": "289ea3805d630cdd4b8e477506a679dad36df021", "url": "https://github.com/ankidroid/Anki-Android/commit/289ea3805d630cdd4b8e477506a679dad36df021", "message": "Empty card is cancellable", "committedDate": "2020-09-27T14:31:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU3OTUyOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495579528", "bodyText": "If this is an update frequency issue, then we could perhaps still overwhelm the display if the math was correct and each percent was roughly real time. Perhaps better to have this \"update frequency reducer\" be based on time vs percents, and update once a second? (or similar)", "author": "mikehardy", "createdAt": "2020-09-27T14:37:16Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -2738,6 +2742,18 @@ public void actualOnPreExecute(@NonNull DeckPicker deckPicker) {\n                     deckPicker.getResources().getString(R.string.emtpy_cards_finding), false);\n         }\n \n+        @Override\n+        public void actualOnProgressUpdate(@NonNull DeckPicker deckPicker, @NonNull TaskData progress) {\n+            int lastCardSeenPercent = (int) ((cardSeen * 100) / numberCards);\n+            cardSeen += progress.getInt();\n+            int cardSeenPercent = (int) ((cardSeen * 100) / numberCards);\n+            if (lastCardSeenPercent != cardSeenPercent) {\n+                // Ensure we update at most 100 times. Updating in real time freeze the screen", "originalCommit": "0eb342fd3dbff9ac6f1657d27a924c3609619a2a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MDE5NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495580194", "bodyText": "Actually, it was not a real time issue. I discovered later that it was an issue that I kept displaying new box instead of updating the current one. Make sens, I'll do it", "author": "Arthur-Milchior", "createdAt": "2020-09-27T14:44:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU3OTUyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MDQ3OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495580479", "bodyText": "would be better to just update then ? :-) - I think there are patterns to follow with the sync progress and the database check dialog", "author": "mikehardy", "createdAt": "2020-09-27T14:47:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU3OTUyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MDY3MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495580671", "bodyText": "The second problem is going to be that if you want the numbers in the ressource, then we'll need to ask all translations to be done again. I'm not really fan of this idea.\nAt least, I'll wait until we have decided what numbers to show before creating a new string", "author": "Arthur-Milchior", "createdAt": "2020-09-27T14:49:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU3OTUyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MTA5MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495581091", "bodyText": "I removed this test. Now that I update the string, it works perfectly", "author": "Arthur-Milchior", "createdAt": "2020-09-27T14:54:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU3OTUyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU3OTY2NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495579664", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    deckPicker.getResources().getString(R.string.emtpy_cards_finding) + cardSeen + \" / \" + numberCards);\n          \n          \n            \n                                    deckPicker.getResources().getString(R.string.empty_cards_finding) + cardSeen + \" / \" + numberCards);\n          \n      \n    \n    \n  \n\nBut more problematically this does not work with RTL languages, the numbers should be interpolated into the string with a string format I think?\nAnd a minor note, but if the math is \"fuzzy\" (you mention that things might go up or down) then I think you could put a ~ sign or something before the numbers to indicate \"not exact but close\"", "author": "mikehardy", "createdAt": "2020-09-27T14:38:45Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -2738,6 +2742,18 @@ public void actualOnPreExecute(@NonNull DeckPicker deckPicker) {\n                     deckPicker.getResources().getString(R.string.emtpy_cards_finding), false);\n         }\n \n+        @Override\n+        public void actualOnProgressUpdate(@NonNull DeckPicker deckPicker, @NonNull TaskData progress) {\n+            int lastCardSeenPercent = (int) ((cardSeen * 100) / numberCards);\n+            cardSeen += progress.getInt();\n+            int cardSeenPercent = (int) ((cardSeen * 100) / numberCards);\n+            if (lastCardSeenPercent != cardSeenPercent) {\n+                // Ensure we update at most 100 times. Updating in real time freeze the screen\n+                deckPicker.mProgressDialog.setContent(\n+                        deckPicker.getResources().getString(R.string.emtpy_cards_finding) + cardSeen + \" / \" + numberCards);", "originalCommit": "0eb342fd3dbff9ac6f1657d27a924c3609619a2a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MDU4Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495580586", "bodyText": "I copied what we do for \"check collection\". You may be right, but in this case it means this is also incorrect.\nThe number shown are exact. The trouble is that both numbers counts different things.\nI.e. \"39691 /233434\" means \"We have checked that 39691\u00a0cards should be generated from your notes according to your collection, and for information your collection has 233434 cards\".\nThis is a good indication, because assuming that there are only a small number of cards to create/delete, then the numerator will almost reach the denominator.\nSo \"~\" seems really strange here.\nIf instead I showed percent, that would makes sens. But I like the idea to showing to the user their actual number of cards", "author": "Arthur-Milchior", "createdAt": "2020-09-27T14:48:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU3OTY2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MDk5Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495580992", "bodyText": "Why not use a progress bar capped at 100%?\nIntuition from reading the code a while back implies that our Progress Dialog supports it, and this removes the ambiguity from a user's point of view - a progress bar stuck at 100% isn't great, but it happens a lot in applications, and a user would expect it.", "author": "david-allison-1", "createdAt": "2020-09-27T14:52:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU3OTY2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MjE4MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495582181", "bodyText": "I tried to copy what I currently have. I like seeing the actual number of cards in the collection, I find it nice. But if you prefer any other UI, I'm fine with them too as long as it's not harder to code.", "author": "Arthur-Milchior", "createdAt": "2020-09-27T15:06:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU3OTY2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MjIwOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495582209", "bodyText": "Inexact progress bars drive me crazy personally (like, there is a numerator and a denominator but it is not really a fraction of work effort being represented...), and it seems that if we want to expose the actual counts we have all sorts of complexity with RTL and strings and stuff.\nLet's just do a percent 0 to 100 capped at 100, life will be easy :-)", "author": "mikehardy", "createdAt": "2020-09-27T15:06:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU3OTY2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4NzE3MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495587171", "bodyText": "I added a number with percent symbol, and a new string... not ideal because this new string contains a part of the old string. But let's go for it if that's what you prefer.\nI have little interest in UI I fear, and will do whatever I have to in order to get the feature I care about in the codebase. But I'll leave the beautiful UI to other if that's what they want to spend their time on.", "author": "Arthur-Milchior", "createdAt": "2020-09-27T15:59:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU3OTY2NA=="}], "type": "inlineReview"}, {"oid": "6b5fb7b1d87fdfc95a6c692fcf3a13ffd57cfd41", "url": "https://github.com/ankidroid/Anki-Android/commit/6b5fb7b1d87fdfc95a6c692fcf3a13ffd57cfd41", "message": "Empty card is cancellable", "committedDate": "2020-09-27T14:50:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MTM2NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495581365", "bodyText": "spacing changes", "author": "david-allison-1", "createdAt": "2020-09-27T14:57:00Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -1179,13 +1207,13 @@ public void updateFieldCache(long[] nids) {\n         return data;\n     }\n \n-\tpublic String _flagNameFromCardFlags(int flags){\n-\t\tint flag = flags & 0b111;\n-\t\tif (flag == 0) {\n-\t\t\treturn \"\";\n-\t\t}\n-\t\treturn \"flag\"+flag;\n-\t}\n+   public String _flagNameFromCardFlags(int flags){", "originalCommit": "6b5fb7b1d87fdfc95a6c692fcf3a13ffd57cfd41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4NjkyMA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495586920", "bodyText": "Removed. This'll wait for linting to automatically occurs", "author": "Arthur-Milchior", "createdAt": "2020-09-27T15:57:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MTM2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MTM2OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495581369", "bodyText": "spacing changes", "author": "david-allison-1", "createdAt": "2020-09-27T14:57:03Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -2033,8 +2061,8 @@ public synchronized Models getModels() {\n     /** Check if this collection is valid. */\n     @SuppressWarnings(\"BooleanMethodIsAlwaysInverted\")\n     public boolean validCollection() {\n-    \t//TODO: more validation code\n-    \treturn getModels().validateModel();\n+       //TODO: more validation code", "originalCommit": "6b5fb7b1d87fdfc95a6c692fcf3a13ffd57cfd41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MjMxMg==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495582312", "bodyText": "I had indeed a commit which correct the tabs to space before the commits making the actual change. It's easier to work on code well formatted.", "author": "Arthur-Milchior", "createdAt": "2020-09-27T15:08:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MTM2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MTQ1NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495581455", "bodyText": "Use an interface here - adding a dependency from libAnki -> CollectionTask isn't a good idea", "author": "david-allison-1", "createdAt": "2020-09-27T14:58:13Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -716,19 +716,40 @@ public void _remNotes(java.util.Collection<Long> ids) {\n     /**\n      * Generate cards for non-empty templates, return ids to remove.\n      */\n-\tpublic ArrayList<Long> genCards(List<Long> nids) {\n-\t    return genCards(Utils.collection2Array(nids));\n-\t}\n+   public ArrayList<Long> genCards(List<Long> nids) {\n+       return genCards(Utils.collection2Array(nids));\n+   }\n+\n+    public ArrayList<Long> genCards(List<Long> nids, CollectionTask task) {\n+       return genCards(Utils.collection2Array(nids), task);\n+    }\n+\n     public ArrayList<Long> genCards(long[] nids) {\n+       return genCards(nids, null);\n+    }\n+\n+    /**\n+     * @param nids All ids of nodes of a note type\n+     * @param task Task to check for cancellation and update number of card processed\n+     * @return Cards that should be removed because they should not be generated\n+     */\n+    public ArrayList<Long> genCards(long[] nids, CollectionTask task) {", "originalCommit": "6b5fb7b1d87fdfc95a6c692fcf3a13ffd57cfd41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MjQ3Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495582472", "bodyText": "An interface which contains what ?\nI want to send update and check whether it's cancelled, it seems to be exactly the point of collection task.\nThat's exactly what is already done in libanki to cancel the deck due tree computation for example.", "author": "Arthur-Milchior", "createdAt": "2020-09-27T15:09:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MTQ1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU5Njc5Nw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495596797", "bodyText": "An interface with a named method for sending progress which doesn't couple us directly to either CollectionTask or TaskData (this is useful as we can send multiple categories of progress notifications for this operation and the ideal would be to be able to differentiate them).\nIt's ideal to avoid circular dependencies when feasible.\nEspecially so in the case of CollectionTask, where know it requires both a hard reference to the Android framework, and when the underlying mechanism (AsyncTask) has been deprecated in the latest version of Android.", "author": "david-allison-1", "createdAt": "2020-09-27T17:42:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MTQ1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MTU3OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495581578", "bodyText": "If we stick with this, don't string concat", "author": "david-allison-1", "createdAt": "2020-09-27T14:59:51Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -2722,24 +2725,50 @@ public void onExtendStudyLimits() {\n     }\n \n     public void handleEmptyCards() {\n-        CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n+        emptyCardTask = CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n     }\n     private HandleEmptyCardListener handlerEmptyCardListener() {\n         return new HandleEmptyCardListener(this);\n     }\n     private static class HandleEmptyCardListener extends TaskListenerWithContext<DeckPicker> {\n+        private final int numberCards;\n+        private long cardSeen = 0;\n+\n         public HandleEmptyCardListener(DeckPicker deckPicker) {\n             super(deckPicker);\n+            numberCards = deckPicker.getCol().cardCount();\n         }\n \n         @Override\n         public void actualOnPreExecute(@NonNull DeckPicker deckPicker) {\n+            DialogInterface.OnCancelListener onCancel = (dialogInterface) -> {\n+                CollectionTask emptyCardTask = deckPicker.emptyCardTask;\n+                if (emptyCardTask != null) {\n+                    emptyCardTask.safeCancel();\n+                }};\n             deckPicker.mProgressDialog = StyledProgressDialog.show(deckPicker, \"\",\n-                    deckPicker.getResources().getString(R.string.emtpy_cards_finding), false);\n+                    deckPicker.getResources().getString(R.string.emtpy_cards_finding), true,\n+                    onCancel);\n         }\n \n         @Override\n-        public void actualOnPostExecute(@NonNull DeckPicker deckPicker, TaskData result) {\n+        public void actualOnProgressUpdate(@NonNull DeckPicker deckPicker, @NonNull TaskData progress) {\n+            cardSeen += progress.getInt();\n+            // Ensure we update at most 100 times. Updating in real time freeze the screen\n+            deckPicker.mProgressDialog.setContent(", "originalCommit": "6b5fb7b1d87fdfc95a6c692fcf3a13ffd57cfd41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MjU1NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495582555", "bodyText": "Can you please let me know what I should do instead ?", "author": "Arthur-Milchior", "createdAt": "2020-09-27T15:10:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MTU3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4ODA0OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495588049", "bodyText": "Going with a progress bar and no text seems like the consensus.\nnew MaterialDialog.Builder(context)\n                .progress(false, maxNumberOfElements)", "author": "david-allison-1", "createdAt": "2020-09-27T16:09:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MTU3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4ODI0Nw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495588247", "bodyText": "I don't think we actually have a progress bar dialog? Just percents.\nThe Material UI standards have moved and we shouldn't be using Dialogs anyway, we should use Progress bars in notifications and not block the UI but that's even farther from what we have now\nIf this does a dialog with percents I think that is our best practice in our app at the moment?", "author": "mikehardy", "createdAt": "2020-09-27T16:11:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MTU3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQzODAwMw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r496438003", "bodyText": "@mikehardy is the current version of the code okay for you, or do you want to change something else ? It's not clear to me whether I did something you objected to, or whether you are okay with this.", "author": "Arthur-Milchior", "createdAt": "2020-09-29T06:06:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MTU3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjcwMjYwNA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r496702604", "bodyText": "just hadn't had time to go review anything yesterday, I was in meetings most of the day. I liked the last screenshot you posted and just need to actually review now!", "author": "mikehardy", "createdAt": "2020-09-29T13:09:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MTU3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MTYxOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495581619", "bodyText": "Might want to move this code (safeCancel) into a utils class.", "author": "david-allison-1", "createdAt": "2020-09-27T15:00:18Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -2722,24 +2725,50 @@ public void onExtendStudyLimits() {\n     }\n \n     public void handleEmptyCards() {\n-        CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n+        emptyCardTask = CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n     }\n     private HandleEmptyCardListener handlerEmptyCardListener() {\n         return new HandleEmptyCardListener(this);\n     }\n     private static class HandleEmptyCardListener extends TaskListenerWithContext<DeckPicker> {\n+        private final int numberCards;\n+        private long cardSeen = 0;\n+\n         public HandleEmptyCardListener(DeckPicker deckPicker) {\n             super(deckPicker);\n+            numberCards = deckPicker.getCol().cardCount();\n         }\n \n         @Override\n         public void actualOnPreExecute(@NonNull DeckPicker deckPicker) {\n+            DialogInterface.OnCancelListener onCancel = (dialogInterface) -> {\n+                CollectionTask emptyCardTask = deckPicker.emptyCardTask;\n+                if (emptyCardTask != null) {", "originalCommit": "6b5fb7b1d87fdfc95a6c692fcf3a13ffd57cfd41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MzYwMA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495583600", "bodyText": "I don't see how to generalize it. If I was sure that I had access to the collection task inside of the task listener, it would be easy to do. But I may imagine that onPreExecute gets executed while mEmptyCardTask is still null. This is not a problem with this code, because we access mEmptyCardTask only when the task is cancelled. This would be a problem if I tried to access it is onPreExecute to send it to the util class", "author": "Arthur-Milchior", "createdAt": "2020-09-27T15:21:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MTYxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MTcwNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495581705", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    private final int numberCards;\n          \n          \n            \n                    private final int mNumberOfCards;", "author": "david-allison-1", "createdAt": "2020-09-27T15:01:14Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -2722,24 +2725,50 @@ public void onExtendStudyLimits() {\n     }\n \n     public void handleEmptyCards() {\n-        CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n+        emptyCardTask = CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n     }\n     private HandleEmptyCardListener handlerEmptyCardListener() {\n         return new HandleEmptyCardListener(this);\n     }\n     private static class HandleEmptyCardListener extends TaskListenerWithContext<DeckPicker> {\n+        private final int numberCards;", "originalCommit": "6b5fb7b1d87fdfc95a6c692fcf3a13ffd57cfd41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MzA4MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495583081", "bodyText": "Done", "author": "Arthur-Milchior", "createdAt": "2020-09-27T15:16:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MTcwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MTgzMA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495581830", "bodyText": "We never reset this to null after execution - do we want to?", "author": "david-allison-1", "createdAt": "2020-09-27T15:02:48Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -214,6 +215,8 @@\n \n     private String mExportFileName;\n \n+    private CollectionTask emptyCardTask = null;", "originalCommit": "6b5fb7b1d87fdfc95a6c692fcf3a13ffd57cfd41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MjgzMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495582831", "bodyText": "Corrected", "author": "Arthur-Milchior", "createdAt": "2020-09-27T15:13:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MTgzMA=="}], "type": "inlineReview"}, {"oid": "15703b1c8ed90a4a154136d1ebfc4f0df8c738bc", "url": "https://github.com/ankidroid/Anki-Android/commit/15703b1c8ed90a4a154136d1ebfc4f0df8c738bc", "message": "Don't cancel on touch\n\nOtherwise any touch on the screen cancel by acciddent", "committedDate": "2020-09-27T15:13:50Z", "type": "forcePushed"}, {"oid": "cf19df7f21c58abb221bd5e685e4552e1b0c7296", "url": "https://github.com/ankidroid/Anki-Android/commit/cf19df7f21c58abb221bd5e685e4552e1b0c7296", "message": "Don't cancel on touch\n\nOtherwise any touch on the screen cancel by acciddent", "committedDate": "2020-09-27T15:15:13Z", "type": "forcePushed"}, {"oid": "45f380ff942ca8c7e153fbc675f6c8e671375f69", "url": "https://github.com/ankidroid/Anki-Android/commit/45f380ff942ca8c7e153fbc675f6c8e671375f69", "message": "Ask for confirmation to cancel", "committedDate": "2020-09-27T15:56:49Z", "type": "forcePushed"}, {"oid": "854dba507e3534e87d2f67b6334697e727b2838c", "url": "https://github.com/ankidroid/Anki-Android/commit/854dba507e3534e87d2f67b6334697e727b2838c", "message": "Ask for confirmation to cancel", "committedDate": "2020-09-27T16:03:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4NzU4Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495587583", "bodyText": "I am also usually trying to do the minimum UI too, I will admit, this one in particular I was thinking percent only with no other info, like so:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                                              deckPicker.getResources().getString(R.string.empty_cards_finding_percent, percent) + cardSeen + \" / \" + mNumberOfCards);\n          \n          \n            \n                                                              deckPicker.getResources().getString(R.string.empty_cards_finding_percent, percent));\n          \n      \n    \n    \n  \n\nThat's how we avoid all the RTL language business - we can't do string concatenation in general because you never know where the language puts numbers naturally when doing translations. This way we have a percent and that's it", "author": "mikehardy", "createdAt": "2020-09-27T16:04:43Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -2722,24 +2725,66 @@ public void onExtendStudyLimits() {\n     }\n \n     public void handleEmptyCards() {\n-        CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n+        mEmptyCardTask = CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n     }\n     private HandleEmptyCardListener handlerEmptyCardListener() {\n         return new HandleEmptyCardListener(this);\n     }\n     private static class HandleEmptyCardListener extends TaskListenerWithContext<DeckPicker> {\n+        private final int mNumberOfCards;\n+        private long cardSeen = 0;\n+\n         public HandleEmptyCardListener(DeckPicker deckPicker) {\n             super(deckPicker);\n+            mNumberOfCards = deckPicker.getCol().cardCount();\n+        }\n+\n+        private void confirmCancel(DeckPicker deckPicker, CollectionTask task) {\n+            new MaterialDialog.Builder(deckPicker)\n+                    .content(deckPicker.getResources().getString(R.string.confirm_cancel))\n+                    .positiveText(deckPicker.getResources().getString(R.string.yes))\n+                    .negativeText(deckPicker.getResources().getString(R.string.no))\n+                    .onNegative((x, y) -> actualOnPreExecute(deckPicker))\n+                    .onPositive((x, y) -> task.safeCancel()).show()\n+                    ;\n         }\n \n         @Override\n         public void actualOnPreExecute(@NonNull DeckPicker deckPicker) {\n+            DialogInterface.OnCancelListener onCancel = (dialogInterface) -> {\n+                CollectionTask mEmptyCardTask = deckPicker.mEmptyCardTask;\n+                if (mEmptyCardTask != null) {\n+                    confirmCancel(deckPicker, mEmptyCardTask);\n+                }};\n             deckPicker.mProgressDialog = StyledProgressDialog.show(deckPicker, \"\",\n-                    deckPicker.getResources().getString(R.string.emtpy_cards_finding), false);\n+                    deckPicker.getResources().getString(R.string.emtpy_cards_finding), true,\n+                    onCancel);\n+            deckPicker.mProgressDialog.setCanceledOnTouchOutside(false);\n         }\n \n         @Override\n-        public void actualOnPostExecute(@NonNull DeckPicker deckPicker, TaskData result) {\n+        public void actualOnProgressUpdate(@NonNull DeckPicker deckPicker, @NonNull TaskData progress) {\n+            cardSeen += progress.getInt();\n+            int percent = Math.min(((int) (cardSeen * 100) / mNumberOfCards), 100);\n+            deckPicker.mProgressDialog.setContent(\n+                                                  deckPicker.getResources().getString(R.string.empty_cards_finding_percent, percent) + cardSeen + \" / \" + mNumberOfCards);", "originalCommit": "854dba507e3534e87d2f67b6334697e727b2838c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4Nzc2OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495587768", "bodyText": "Done. That was only an accident the remaining remained. It was already removed while you wrote this", "author": "Arthur-Milchior", "createdAt": "2020-09-27T16:06:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4NzU4Mw=="}], "type": "inlineReview"}, {"oid": "3dcac06f84fe9a64c66f2cfe465482478a438d43", "url": "https://github.com/ankidroid/Anki-Android/commit/3dcac06f84fe9a64c66f2cfe465482478a438d43", "message": "Ask for confirmation to cancel", "committedDate": "2020-09-27T16:05:46Z", "type": "forcePushed"}, {"oid": "61ee8dce64c19e5446c7c1fdd4018dd297f32f57", "url": "https://github.com/ankidroid/Anki-Android/commit/61ee8dce64c19e5446c7c1fdd4018dd297f32f57", "message": "Ask for confirmation to cancel", "committedDate": "2020-09-27T16:54:25Z", "type": "forcePushed"}, {"oid": "926ccc3f2010d5e9f186cf6b4bfc3a9460aa52b2", "url": "https://github.com/ankidroid/Anki-Android/commit/926ccc3f2010d5e9f186cf6b4bfc3a9460aa52b2", "message": "Ask for confirmation to cancel", "committedDate": "2020-09-27T17:15:17Z", "type": "forcePushed"}, {"oid": "a123aba592623f6c89b951bf5b8f745a13698006", "url": "https://github.com/ankidroid/Anki-Android/commit/a123aba592623f6c89b951bf5b8f745a13698006", "message": "Ask for confirmation to cancel", "committedDate": "2020-09-29T06:10:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU5NTk2Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495595963", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                <string name=\"confirm_cancel\">Do you want to cancel ?</string>\n          \n          \n            \n                <string name=\"confirm_cancel\">Do you want to cancel?</string>", "author": "david-allison-1", "createdAt": "2020-09-27T17:32:53Z", "path": "AnkiDroid/src/main/res/values/03-dialogs.xml", "diffHunk": "@@ -145,10 +145,12 @@\n \n     <!-- Empty cards -->\n     <string name=\"emtpy_cards_finding\">Finding empty cards\u2026</string>\n+    <string name=\"confirm_cancel\">Do you want to cancel ?</string>", "originalCommit": "926ccc3f2010d5e9f186cf6b4bfc3a9460aa52b2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY3MzEwMA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r500673100", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                <string name=\"confirm_cancel\">Do you want to cancel ?</string>\n          \n          \n            \n                <string name=\"confirm_cancel\">Do you want to cancel?</string>", "author": "david-allison-1", "createdAt": "2020-10-07T00:41:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU5NTk2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY3MzE1OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r500673159", "bodyText": "@mikehardy - yes/no is advised against in material guidelines, but I can't think of any better wording.\n\nDon\u2019t use action text that fails to indicate what the selection will do. \u201cCancel\u201d and \u201cDelete\u201d better indicate what will occur in this dialog.\n\nhttps://material.io/components/dialogs#alert-dialog\nCancel/Resume maybe?", "author": "david-allison-1", "createdAt": "2020-10-07T00:41:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU5NTk2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg3NjE3OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r500876178", "bodyText": "It would not be immediately clear whether \"cancel\" mean \"cancel the cancelling action\" or \"I confirm I want to cancel\", this is why I avoided it", "author": "Arthur-Milchior", "createdAt": "2020-10-07T09:39:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU5NTk2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU5NjMwMw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495596303", "bodyText": "As far as I know, this is an accessor for cancelable", "author": "david-allison-1", "createdAt": "2020-09-27T17:36:42Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -2722,24 +2726,66 @@ public void onExtendStudyLimits() {\n     }\n \n     public void handleEmptyCards() {\n-        CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n+        mEmptyCardTask = CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n     }\n     private HandleEmptyCardListener handlerEmptyCardListener() {\n         return new HandleEmptyCardListener(this);\n     }\n     private static class HandleEmptyCardListener extends TaskListenerWithContext<DeckPicker> {\n+        private final int mNumberOfCards;\n+        private long cardSeen = 0;\n+\n         public HandleEmptyCardListener(DeckPicker deckPicker) {\n             super(deckPicker);\n+            mNumberOfCards = deckPicker.getCol().cardCount();\n+        }\n+\n+        private void confirmCancel(DeckPicker deckPicker, CollectionTask task) {\n+            new MaterialDialog.Builder(deckPicker)\n+                    .content(deckPicker.getResources().getString(R.string.confirm_cancel))\n+                    .positiveText(deckPicker.getResources().getString(R.string.yes))\n+                    .negativeText(deckPicker.getResources().getString(R.string.no))\n+                    .onNegative((x, y) -> actualOnPreExecute(deckPicker))\n+                    .onPositive((x, y) -> task.safeCancel()).show()\n+                    ;\n         }\n \n         @Override\n         public void actualOnPreExecute(@NonNull DeckPicker deckPicker) {\n-            deckPicker.mProgressDialog = StyledProgressDialog.show(deckPicker, \"\",\n-                    deckPicker.getResources().getString(R.string.emtpy_cards_finding), false);\n+            DialogInterface.OnCancelListener onCancel = (dialogInterface) -> {\n+                CollectionTask mEmptyCardTask = deckPicker.mEmptyCardTask;\n+                if (mEmptyCardTask != null) {\n+                    confirmCancel(deckPicker, mEmptyCardTask);\n+                }};\n+            deckPicker.mProgressDialog = new MaterialDialog.Builder(deckPicker)\n+                    .progress(false, mNumberOfCards)\n+                    .title(R.string.emtpy_cards_finding)\n+                    .cancelable(true)\n+                    .show();\n+            deckPicker.mProgressDialog.setOnCancelListener(onCancel);\n+            deckPicker.mProgressDialog.setCanceledOnTouchOutside(false);", "originalCommit": "926ccc3f2010d5e9f186cf6b4bfc3a9460aa52b2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1NTQ0OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r496955448", "bodyText": "I am sorry, but I have no idea what this comment means.", "author": "Arthur-Milchior", "createdAt": "2020-09-29T18:36:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU5NjMwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk2NTI3NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r496965275", "bodyText": "From a quick skim of the code, this seems identical to cancelable(false), I'm possibly mistaken though.", "author": "david-allison-1", "createdAt": "2020-09-29T18:53:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU5NjMwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk2OTMyMw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r496969323", "bodyText": "Are you referring to the lines setCanceledOnTouchOutside ?\nBecause if so, I believe you're wrong.\nsetCanceledOnTouchOutside ask whether touching anything that is not the dialog trigger cancelling.\ncancelable(bool) ask whether the dialog is cancelable.\nSo cancelable(true) followed by setCanceledOnTouchOutside(false) means that you can cancel, but that it is cancelling only by pressing a \"back\" button and not by pressing any part of your screen by accident", "author": "Arthur-Milchior", "createdAt": "2020-09-29T19:01:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU5NjMwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU5NjM2MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495596360", "bodyText": "An explicit click on cancel no longer necessitates a dialog", "author": "david-allison-1", "createdAt": "2020-09-27T17:37:22Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -2722,24 +2726,66 @@ public void onExtendStudyLimits() {\n     }\n \n     public void handleEmptyCards() {\n-        CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n+        mEmptyCardTask = CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n     }\n     private HandleEmptyCardListener handlerEmptyCardListener() {\n         return new HandleEmptyCardListener(this);\n     }\n     private static class HandleEmptyCardListener extends TaskListenerWithContext<DeckPicker> {\n+        private final int mNumberOfCards;\n+        private long cardSeen = 0;\n+\n         public HandleEmptyCardListener(DeckPicker deckPicker) {\n             super(deckPicker);\n+            mNumberOfCards = deckPicker.getCol().cardCount();\n+        }\n+\n+        private void confirmCancel(DeckPicker deckPicker, CollectionTask task) {", "originalCommit": "926ccc3f2010d5e9f186cf6b4bfc3a9460aa52b2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1NjAyMA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r496956020", "bodyText": "There is no \"cancel\" button. Cancel occurs with pressing the return button of the phone.\nI believe that asking for confirmation is better, does not take a lot of time and ensure that time is not lost if you pressed by accident", "author": "Arthur-Milchior", "createdAt": "2020-09-29T18:37:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU5NjM2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1MDg1NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r496950855", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    private long cardSeen = 0;\n          \n          \n            \n                    private long mCardsSeen = 0;", "author": "david-allison-1", "createdAt": "2020-09-29T18:28:03Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -2742,24 +2746,66 @@ public void onExtendStudyLimits() {\n     }\n \n     public void handleEmptyCards() {\n-        CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n+        mEmptyCardTask = CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n     }\n     private HandleEmptyCardListener handlerEmptyCardListener() {\n         return new HandleEmptyCardListener(this);\n     }\n     private static class HandleEmptyCardListener extends TaskListenerWithContext<DeckPicker> {\n+        private final int mNumberOfCards;\n+        private long cardSeen = 0;", "originalCommit": "a123aba592623f6c89b951bf5b8f745a13698006", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI0NTgzNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r499245835", "bodyText": "Removed", "author": "Arthur-Milchior", "createdAt": "2020-10-04T13:17:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1MDg1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1MTM3Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r496951376", "bodyText": "Does this need a\nif (deckPicker.mProgressDialog != null && deckPicker.mProgressDialog.isShowing()) {\n deckPicker.mProgressDialog.dismiss();\n      }", "author": "david-allison-1", "createdAt": "2020-09-29T18:29:02Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -2742,24 +2746,66 @@ public void onExtendStudyLimits() {\n     }\n \n     public void handleEmptyCards() {\n-        CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n+        mEmptyCardTask = CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n     }\n     private HandleEmptyCardListener handlerEmptyCardListener() {\n         return new HandleEmptyCardListener(this);\n     }\n     private static class HandleEmptyCardListener extends TaskListenerWithContext<DeckPicker> {\n+        private final int mNumberOfCards;\n+        private long cardSeen = 0;\n+\n         public HandleEmptyCardListener(DeckPicker deckPicker) {\n             super(deckPicker);\n+            mNumberOfCards = deckPicker.getCol().cardCount();\n+        }\n+\n+        private void confirmCancel(@NonNull DeckPicker deckPicker, @NonNull CollectionTask task) {\n+            new MaterialDialog.Builder(deckPicker)\n+                    .content(deckPicker.getResources().getString(R.string.confirm_cancel))\n+                    .positiveText(deckPicker.getResources().getString(R.string.yes))\n+                    .negativeText(deckPicker.getResources().getString(R.string.no))\n+                    .onNegative((x, y) -> actualOnPreExecute(deckPicker))\n+                    .onPositive((x, y) -> task.safeCancel()).show()\n+                    ;\n         }\n \n         @Override\n         public void actualOnPreExecute(@NonNull DeckPicker deckPicker) {\n-            deckPicker.mProgressDialog = StyledProgressDialog.show(deckPicker, \"\",\n-                    deckPicker.getResources().getString(R.string.emtpy_cards_finding), false);\n+            DialogInterface.OnCancelListener onCancel = (dialogInterface) -> {\n+                CollectionTask mEmptyCardTask = deckPicker.mEmptyCardTask;\n+                if (mEmptyCardTask != null) {\n+                    confirmCancel(deckPicker, mEmptyCardTask);\n+                }};\n+            deckPicker.mProgressDialog = new MaterialDialog.Builder(deckPicker)\n+                    .progress(false, mNumberOfCards)\n+                    .title(R.string.emtpy_cards_finding)\n+                    .cancelable(true)\n+                    .show();\n+            deckPicker.mProgressDialog.setOnCancelListener(onCancel);\n+            deckPicker.mProgressDialog.setCanceledOnTouchOutside(false);\n         }\n \n         @Override\n-        public void actualOnPostExecute(@NonNull DeckPicker deckPicker, TaskData result) {\n+        public void actualOnProgressUpdate(@NonNull DeckPicker deckPicker, @NonNull TaskData progress) {\n+            deckPicker.mProgressDialog.incrementProgress(progress.getInt());\n+        }\n+\n+        @Override\n+        public void actualOnCancelled(@NonNull DeckPicker deckPicker) {\n+            deckPicker.mEmptyCardTask = null;", "originalCommit": "a123aba592623f6c89b951bf5b8f745a13698006", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1NzA2OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r496957068", "bodyText": "It seems that pressing the back button of the phone dismiss the dialog directly. I don't know whether it is the case on all device or whether it depends on device, version, api... if you tell me it depends, then I'll add it. But on my phone at least, it's useless", "author": "Arthur-Milchior", "createdAt": "2020-09-29T18:39:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1MTM3Ng=="}], "type": "inlineReview"}, {"oid": "3600eb6c369e0ee1732fe76b841ecff33f357029", "url": "https://github.com/ankidroid/Anki-Android/commit/3600eb6c369e0ee1732fe76b841ecff33f357029", "message": "Ask for confirmation to cancel", "committedDate": "2020-10-04T13:17:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY3MTQxMA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r500671410", "bodyText": "Nullable", "author": "david-allison-1", "createdAt": "2020-10-07T00:34:58Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -215,6 +217,8 @@\n \n     private String mExportFileName;\n \n+    private CollectionTask mEmptyCardTask = null;", "originalCommit": "3600eb6c369e0ee1732fe76b841ecff33f357029", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg3Njg3NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r500876874", "bodyText": "Done", "author": "Arthur-Milchior", "createdAt": "2020-10-07T09:40:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY3MTQxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY3MTU3Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r500671572", "bodyText": "You should be able to pass the IDs into this method directly", "author": "david-allison-1", "createdAt": "2020-10-07T00:35:33Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -2757,24 +2761,65 @@ public void onExtendStudyLimits() {\n     }\n \n     public void handleEmptyCards() {\n-        CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n+        mEmptyCardTask = CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n     }\n     private HandleEmptyCardListener handlerEmptyCardListener() {\n         return new HandleEmptyCardListener(this);\n     }\n     private static class HandleEmptyCardListener extends TaskListenerWithContext<DeckPicker> {\n+        private final int mNumberOfCards;\n+\n         public HandleEmptyCardListener(DeckPicker deckPicker) {\n             super(deckPicker);\n+            mNumberOfCards = deckPicker.getCol().cardCount();\n+        }\n+\n+        private void confirmCancel(@NonNull DeckPicker deckPicker, @NonNull CollectionTask task) {\n+            new MaterialDialog.Builder(deckPicker)\n+                    .content(deckPicker.getResources().getString(R.string.confirm_cancel))", "originalCommit": "3600eb6c369e0ee1732fe76b841ecff33f357029", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg3NzQ2Nw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r500877467", "bodyText": "Done", "author": "Arthur-Milchior", "createdAt": "2020-10-07T09:41:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY3MTU3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY3MTczMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r500671731", "bodyText": "(nit: add a blank line after  }}; for readability)", "author": "david-allison-1", "createdAt": "2020-10-07T00:36:14Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -2757,24 +2761,65 @@ public void onExtendStudyLimits() {\n     }\n \n     public void handleEmptyCards() {\n-        CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n+        mEmptyCardTask = CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n     }\n     private HandleEmptyCardListener handlerEmptyCardListener() {\n         return new HandleEmptyCardListener(this);\n     }\n     private static class HandleEmptyCardListener extends TaskListenerWithContext<DeckPicker> {\n+        private final int mNumberOfCards;\n+\n         public HandleEmptyCardListener(DeckPicker deckPicker) {\n             super(deckPicker);\n+            mNumberOfCards = deckPicker.getCol().cardCount();\n+        }\n+\n+        private void confirmCancel(@NonNull DeckPicker deckPicker, @NonNull CollectionTask task) {\n+            new MaterialDialog.Builder(deckPicker)\n+                    .content(deckPicker.getResources().getString(R.string.confirm_cancel))\n+                    .positiveText(deckPicker.getResources().getString(R.string.yes))\n+                    .negativeText(deckPicker.getResources().getString(R.string.no))\n+                    .onNegative((x, y) -> actualOnPreExecute(deckPicker))\n+                    .onPositive((x, y) -> task.safeCancel()).show()\n+                    ;\n         }\n \n         @Override\n         public void actualOnPreExecute(@NonNull DeckPicker deckPicker) {\n-            deckPicker.mProgressDialog = StyledProgressDialog.show(deckPicker, \"\",\n-                    deckPicker.getResources().getString(R.string.emtpy_cards_finding), false);\n+            DialogInterface.OnCancelListener onCancel = (dialogInterface) -> {\n+                CollectionTask mEmptyCardTask = deckPicker.mEmptyCardTask;\n+                if (mEmptyCardTask != null) {\n+                    confirmCancel(deckPicker, mEmptyCardTask);\n+                }};\n+            deckPicker.mProgressDialog = new MaterialDialog.Builder(deckPicker)", "originalCommit": "3600eb6c369e0ee1732fe76b841ecff33f357029", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg3ODEyOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r500878128", "bodyText": "Done", "author": "Arthur-Milchior", "createdAt": "2020-10-07T09:42:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY3MTczMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY3MjEyNw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r500672127", "bodyText": "Please abstract out CollectionTask into a progress/cancellable listener as mentioned in the previous reviews. We shouldn't have a circular dependency from CollectionTask to Collection", "author": "david-allison-1", "createdAt": "2020-10-07T00:37:50Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -720,16 +720,37 @@ public void _remNotes(java.util.Collection<Long> ids) {\n \tpublic ArrayList<Long> genCards(List<Long> nids) {\n \t    return genCards(Utils.collection2Array(nids));\n \t}\n+\n+    public ArrayList<Long> genCards(List<Long> nids, @Nullable CollectionTask task) {\n+       return genCards(Utils.collection2Array(nids), task);\n+    }\n+\n     public ArrayList<Long> genCards(long[] nids) {\n+       return genCards(nids, null);\n+    }\n+\n+    /**\n+     * @param nids All ids of nodes of a note type\n+     * @param task Task to check for cancellation and update number of card processed\n+     * @return Cards that should be removed because they should not be generated\n+     */\n+    public ArrayList<Long> genCards(long[] nids, @Nullable CollectionTask task) {", "originalCommit": "3600eb6c369e0ee1732fe76b841ecff33f357029", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg5NDE2NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r500894165", "bodyText": "I changed the uses of CancelTask in Scheduler at the same time", "author": "Arthur-Milchior", "createdAt": "2020-10-07T10:09:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY3MjEyNw=="}], "type": "inlineReview"}, {"oid": "3a4ef38cde61b09a01585eb86ff1b3477c61a2a0", "url": "https://github.com/ankidroid/Anki-Android/commit/3a4ef38cde61b09a01585eb86ff1b3477c61a2a0", "message": "Ask for confirmation to cancel", "committedDate": "2020-10-07T10:07:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk3NjkzMA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r500976930", "bodyText": "@FunctionalInterface", "author": "david-allison-1", "createdAt": "2020-10-07T12:37:54Z", "path": "AnkiDroid/src/main/java/com/ichi2/async/ProgressSender.java", "diffHunk": "@@ -0,0 +1,5 @@\n+package com.ichi2.async;\n+\n+public interface ProgressSender<T> {", "originalCommit": "3a4ef38cde61b09a01585eb86ff1b3477c61a2a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA2MTQ0NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r501061444", "bodyText": "Done", "author": "Arthur-Milchior", "createdAt": "2020-10-07T14:31:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk3NjkzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk3NzEzNA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r500977134", "bodyText": "@FunctionalInterface", "author": "david-allison-1", "createdAt": "2020-10-07T12:38:14Z", "path": "AnkiDroid/src/main/java/com/ichi2/async/CancelListener.java", "diffHunk": "@@ -0,0 +1,5 @@\n+package com.ichi2.async;\n+\n+public interface CancelListener {", "originalCommit": "3a4ef38cde61b09a01585eb86ff1b3477c61a2a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA2MTM3Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r501061372", "bodyText": "Done", "author": "Arthur-Milchior", "createdAt": "2020-10-07T14:31:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk3NzEzNA=="}], "type": "inlineReview"}, {"oid": "a0dea0f70216ea5ad971dd8c4038020ff98be6e7", "url": "https://github.com/ankidroid/Anki-Android/commit/a0dea0f70216ea5ad971dd8c4038020ff98be6e7", "message": "Ask for confirmation to cancel", "committedDate": "2020-10-07T14:31:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc4NjQ1Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r504786452", "bodyText": "Needs a copyright header", "author": "mikehardy", "createdAt": "2020-10-14T15:48:55Z", "path": "AnkiDroid/src/main/java/com/ichi2/async/CancelListener.java", "diffHunk": "@@ -0,0 +1,6 @@\n+package com.ichi2.async;", "originalCommit": "e1916fc304bb293db3c8322d3a4d07f3ad043da7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg4OTUyMA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r504889520", "bodyText": "Done", "author": "Arthur-Milchior", "createdAt": "2020-10-14T18:34:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc4NjQ1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc4NzMzMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r504787331", "bodyText": "copyright header here too", "author": "mikehardy", "createdAt": "2020-10-14T15:50:04Z", "path": "AnkiDroid/src/main/java/com/ichi2/async/ProgressSender.java", "diffHunk": "@@ -0,0 +1,6 @@\n+package com.ichi2.async;", "originalCommit": "f0d12096ae414f42613438d2d35b38755db278a7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg4OTU2MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r504889560", "bodyText": "Done", "author": "Arthur-Milchior", "createdAt": "2020-10-14T18:34:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc4NzMzMQ=="}], "type": "inlineReview"}, {"oid": "b5e4451826a8299a6199f1a36da82309ada672f1", "url": "https://github.com/ankidroid/Anki-Android/commit/b5e4451826a8299a6199f1a36da82309ada672f1", "message": "NF: comment genCards", "committedDate": "2020-10-14T18:32:49Z", "type": "commit"}, {"oid": "307ec031670d91603a2f1770b8598c796f678c5d", "url": "https://github.com/ankidroid/Anki-Android/commit/307ec031670d91603a2f1770b8598c796f678c5d", "message": "NF: CancelListener", "committedDate": "2020-10-14T18:33:46Z", "type": "commit"}, {"oid": "5f5130398bd793cb2818296523bea83179fe2530", "url": "https://github.com/ankidroid/Anki-Android/commit/5f5130398bd793cb2818296523bea83179fe2530", "message": "NF: ProgressSender", "committedDate": "2020-10-14T18:34:00Z", "type": "commit"}, {"oid": "d8d7c585917ef24ee2cdba056cddf57b70928449", "url": "https://github.com/ankidroid/Anki-Android/commit/d8d7c585917ef24ee2cdba056cddf57b70928449", "message": "Empty card update on number of card checked", "committedDate": "2020-10-14T18:34:01Z", "type": "commit"}, {"oid": "4d4d4fc167435b43963514cf4fe738c07bda8bf5", "url": "https://github.com/ankidroid/Anki-Android/commit/4d4d4fc167435b43963514cf4fe738c07bda8bf5", "message": "Empty card is cancellable", "committedDate": "2020-10-14T18:34:01Z", "type": "commit"}, {"oid": "2cabe7821886a89acb68ab259943cec5b3ed6c52", "url": "https://github.com/ankidroid/Anki-Android/commit/2cabe7821886a89acb68ab259943cec5b3ed6c52", "message": "Don't cancel on touch\n\nOtherwise any touch on the screen cancel by acciddent", "committedDate": "2020-10-14T18:34:01Z", "type": "commit"}, {"oid": "05705f16e404cd098e77566a9cf0868cc1868668", "url": "https://github.com/ankidroid/Anki-Android/commit/05705f16e404cd098e77566a9cf0868cc1868668", "message": "Ask for confirmation to cancel", "committedDate": "2020-10-14T18:34:01Z", "type": "commit"}, {"oid": "05705f16e404cd098e77566a9cf0868cc1868668", "url": "https://github.com/ankidroid/Anki-Android/commit/05705f16e404cd098e77566a9cf0868cc1868668", "message": "Ask for confirmation to cancel", "committedDate": "2020-10-14T18:34:01Z", "type": "forcePushed"}]}