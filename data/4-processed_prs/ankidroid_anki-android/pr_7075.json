{"pr_number": 7075, "pr_title": "Show useful error when col version is too high", "pr_createdAt": "2020-09-13T02:58:22Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/7075", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ3MzUxNw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7075#discussion_r487473517", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \n          \n          \n            \n            \n          \n          \n            \n                @Nullable", "author": "david-allison-1", "createdAt": "2020-09-13T02:58:58Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CollectionHelper.java", "diffHunk": "@@ -368,4 +370,20 @@ public static void loadCollectionComplete(Collection col) {\n         col.getModels();\n     }\n \n+    public static boolean isFutureAnkiDroidVersion(Context context) {\n+        Integer databaseVersion = getDatabaseVersion(context);\n+        return databaseVersion != null && databaseVersion > SCHEMA_VERSION;\n+    }\n+\n+", "originalCommit": "2cfa1e28608e36c67ea0bf4c7e277b65d4bfb465", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU0MjYwMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7075#discussion_r497542601", "bodyText": "As mentioned elsewhere, I'd prefer if the thing wasn't a possible null boxed value and was either a real value or a constant for unknown (-1) with actual exceptions and handling in case things are unrecoverably busted", "author": "mikehardy", "createdAt": "2020-09-30T14:12:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ3MzUxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ3MzUzNw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7075#discussion_r487473537", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                   // .itemsColor(ContextCompat.getColor(requireContext(), R.color.material_grey_500))", "author": "david-allison-1", "createdAt": "2020-09-13T02:59:16Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/dialogs/DatabaseErrorDialog.java", "diffHunk": "@@ -295,6 +300,31 @@ public MaterialDialog onCreateDialog(Bundle savedInstanceState) {\n                         .onPositive((inner_dialog, which) -> exit())\n                         .show();\n             }\n+            case DIALOG_DB_FUTURE_VERSION: {\n+                List<Integer> values = new ArrayList<>();\n+                CharSequence[] options = new CharSequence[] { UiUtil.makeBold(res.getString(R.string.backup_restore)), UiUtil.makeBold(res.getString(R.string.backup_full_sync_from_server)) };\n+                values.add(0);\n+                values.add(1);\n+                return builder\n+                        .cancelable(false)\n+                        .content(getMessage())\n+                        .iconAttr(R.attr.dialogErrorIcon)\n+                        .positiveText(res.getString(R.string.close))\n+                        .onPositive((inner_dialog, which) -> exit())\n+                        .items(options)\n+                       // .itemsColor(ContextCompat.getColor(requireContext(), R.color.material_grey_500))", "originalCommit": "2cfa1e28608e36c67ea0bf4c7e277b65d4bfb465", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ3MzU4OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7075#discussion_r487473588", "bodyText": "This might want a nicer abstraction as it's a rough copy of the same code in another method", "author": "david-allison-1", "createdAt": "2020-09-13T02:59:45Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/dialogs/DatabaseErrorDialog.java", "diffHunk": "@@ -295,6 +300,31 @@ public MaterialDialog onCreateDialog(Bundle savedInstanceState) {\n                         .onPositive((inner_dialog, which) -> exit())\n                         .show();\n             }\n+            case DIALOG_DB_FUTURE_VERSION: {\n+                List<Integer> values = new ArrayList<>();\n+                CharSequence[] options = new CharSequence[] { UiUtil.makeBold(res.getString(R.string.backup_restore)), UiUtil.makeBold(res.getString(R.string.backup_full_sync_from_server)) };", "originalCommit": "2cfa1e28608e36c67ea0bf4c7e277b65d4bfb465", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ3MzYwOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7075#discussion_r487473609", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                Timber.w(e, \"Failed to get database version\");\n          \n          \n            \n                                Timber.w(e, \"Failed to get database version, using -1\");", "author": "david-allison-1", "createdAt": "2020-09-13T03:00:00Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/dialogs/DatabaseErrorDialog.java", "diffHunk": "@@ -334,6 +364,14 @@ private String getMessage() {\n                 return res().getString(R.string.backup_full_sync_from_server_question);\n             case DIALOG_DB_LOCKED:\n                 return res().getString(R.string.database_locked_summary);\n+            case DIALOG_DB_FUTURE_VERSION:\n+                Integer databaseVersion = null;\n+                try {\n+                    databaseVersion = CollectionHelper.getDatabaseVersion(requireContext());\n+                } catch (Exception e) {\n+                    Timber.w(e, \"Failed to get database version\");", "originalCommit": "2cfa1e28608e36c67ea0bf4c7e277b65d4bfb465", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUzNDQwOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7075#discussion_r497534408", "bodyText": "I like the -1 addition", "author": "mikehardy", "createdAt": "2020-09-30T14:01:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ3MzYwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ3MzYzMw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7075#discussion_r487473633", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public Integer queryVer() {\n          \n          \n            \n                public int queryVer() {", "author": "david-allison-1", "createdAt": "2020-09-13T03:00:26Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -2134,6 +2134,10 @@ public Context getContext() {\n         return getDb().queryLongList(\"select id from cards where id in \" + Utils.ids2str(cards));\n     }\n \n+    public Integer queryVer() {", "originalCommit": "2cfa1e28608e36c67ea0bf4c7e277b65d4bfb465", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUzNDc2Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7075#discussion_r497534763", "bodyText": "I prefer types that can't go null personally", "author": "mikehardy", "createdAt": "2020-09-30T14:02:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ3MzYzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ3MzY3Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7075#discussion_r487473673", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                <string name=\"database_version_title\">Downgrade Required</string>\n          \n          \n            \n                <string name=\"database_downgrade_required_title\">Downgrade Required</string>", "author": "david-allison-1", "createdAt": "2020-09-13T03:01:04Z", "path": "AnkiDroid/src/main/res/values/03-dialogs.xml", "diffHunk": "@@ -185,6 +185,10 @@\n     <string name=\"database_locked_title\">Database Locked</string>\n     <string name=\"database_locked_summary\">The AnkiDroid database is in use by another application. Please close the other application then reopen AnkiDroid.</string>\n \n+\n+    <string name=\"database_version_title\">Downgrade Required</string>", "originalCommit": "2cfa1e28608e36c67ea0bf4c7e277b65d4bfb465", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUzODY3MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7075#discussion_r497538670", "bodyText": "The idea of \"database downgrade\" is non-sensical to the user in the AnkiDroid context. The AnkiDroid version and database version are locked right? We don't support multiple db versions in multiple app versions. So to be actionable I think the idea that the app must be downgraded is the thing to place front and center for the user. How to express that?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                <string name=\"database_version_title\">Downgrade Required</string>\n          \n          \n            \n                <string name=\"database_version_title\">Incompatible Database Version</string>", "author": "mikehardy", "createdAt": "2020-09-30T14:07:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ3MzY3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ3MzY4OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7075#discussion_r487473688", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                <string name=\"database_version_summary\">The AnkiDroid database must be downgraded, or AnkiDroid must be upgraded before it can be opened\\n\\nAnkiDroid version: %1$d\\nDatabase Version: %2$d\\n\\nPlease downgrade the database, or perform one of the following options</string>\n          \n          \n            \n                <string name=\"database_downgrade_required_summary\">The AnkiDroid database must be downgraded, or AnkiDroid must be upgraded before it can be opened\\n\\nAnkiDroid version: %1$d\\nDatabase Version: %2$d\\n\\nPlease downgrade the database, or perform one of the following options</string>", "author": "david-allison-1", "createdAt": "2020-09-13T03:01:15Z", "path": "AnkiDroid/src/main/res/values/03-dialogs.xml", "diffHunk": "@@ -185,6 +185,10 @@\n     <string name=\"database_locked_title\">Database Locked</string>\n     <string name=\"database_locked_summary\">The AnkiDroid database is in use by another application. Please close the other application then reopen AnkiDroid.</string>\n \n+\n+    <string name=\"database_version_title\">Downgrade Required</string>\n+    <string name=\"database_version_summary\">The AnkiDroid database must be downgraded, or AnkiDroid must be upgraded before it can be opened\\n\\nAnkiDroid version: %1$d\\nDatabase Version: %2$d\\n\\nPlease downgrade the database, or perform one of the following options</string>", "originalCommit": "2cfa1e28608e36c67ea0bf4c7e277b65d4bfb465", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUzNjM0OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7075#discussion_r497536348", "bodyText": "would prefer a constant -1 int unknown, and a real value here. It's a concrete thing the idea of a version, and seems like it should be strictly known as a real integer or a known constant (-1) that is unknown, with a real Exception if it's unrecoverably busted. I just don't like Nulls really, I'll admit it.", "author": "mikehardy", "createdAt": "2020-09-30T14:04:06Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Storage.java", "diffHunk": "@@ -45,6 +45,16 @@ public static Collection Collection(Context context, String path) {\n         return Collection(context, path, false, false);\n     }\n \n+    @Nullable\n+    public static Integer getDatabaseVersion(String path) {", "originalCommit": "2cfa1e28608e36c67ea0bf4c7e277b65d4bfb465", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU0MTczOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7075#discussion_r497541739", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                <string name=\"database_version_summary\">The AnkiDroid database must be downgraded, or AnkiDroid must be upgraded before it can be opened\\n\\nAnkiDroid version: %1$d\\nDatabase Version: %2$d\\n\\nPlease downgrade the database, or perform one of the following options</string>\n          \n          \n            \n                <string name=\"database_version_summary\">The database is a more advanced version than this version of AnkiDroid can work with. Upgrade AnkiDroid or downgrade the database to open it\\n\\nAnkiDroid version: %1$d\\nDatabase Version: %2$d. The following restore options will overwrite your current collection, possibly with a compatible database version:</string>", "author": "mikehardy", "createdAt": "2020-09-30T14:11:15Z", "path": "AnkiDroid/src/main/res/values/03-dialogs.xml", "diffHunk": "@@ -185,6 +185,10 @@\n     <string name=\"database_locked_title\">Database Locked</string>\n     <string name=\"database_locked_summary\">The AnkiDroid database is in use by another application. Please close the other application then reopen AnkiDroid.</string>\n \n+\n+    <string name=\"database_version_title\">Downgrade Required</string>\n+    <string name=\"database_version_summary\">The AnkiDroid database must be downgraded, or AnkiDroid must be upgraded before it can be opened\\n\\nAnkiDroid version: %1$d\\nDatabase Version: %2$d\\n\\nPlease downgrade the database, or perform one of the following options</string>", "originalCommit": "2cfa1e28608e36c67ea0bf4c7e277b65d4bfb465", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "98cd640b9336d4deb4cafa1d0fd9bc2d0a8ec036", "url": "https://github.com/ankidroid/Anki-Android/commit/98cd640b9336d4deb4cafa1d0fd9bc2d0a8ec036", "message": "Show useful error when col version is too high\n\nThis means that the database has been upgraded, and there is currently no\nway of downgrading from an earlier version\n\nFixes 7072", "committedDate": "2020-10-01T11:44:07Z", "type": "forcePushed"}, {"oid": "954feb3e0aa442d7bf1e337604c032d9795fe55a", "url": "https://github.com/ankidroid/Anki-Android/commit/954feb3e0aa442d7bf1e337604c032d9795fe55a", "message": "Show useful error when col version is too high\n\nThis means that the database has been upgraded, and there is currently no\nway of downgrading from an earlier version\n\nFixes 7072", "committedDate": "2020-10-01T13:45:48Z", "type": "forcePushed"}, {"oid": "0c74fccac1bd9cf79281bd2da548d8a7525c5d9d", "url": "https://github.com/ankidroid/Anki-Android/commit/0c74fccac1bd9cf79281bd2da548d8a7525c5d9d", "message": "Show useful error when col version is too high\n\nThis means that the database has been upgraded, and there is currently no\nway of downgrading from an earlier version\n\nFixes 7072", "committedDate": "2020-10-01T18:48:22Z", "type": "commit"}, {"oid": "0c74fccac1bd9cf79281bd2da548d8a7525c5d9d", "url": "https://github.com/ankidroid/Anki-Android/commit/0c74fccac1bd9cf79281bd2da548d8a7525c5d9d", "message": "Show useful error when col version is too high\n\nThis means that the database has been upgraded, and there is currently no\nway of downgrading from an earlier version\n\nFixes 7072", "committedDate": "2020-10-01T18:48:22Z", "type": "forcePushed"}]}