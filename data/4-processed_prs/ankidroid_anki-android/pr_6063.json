{"pr_number": 6063, "pr_title": "Allow preview of note edits", "pr_createdAt": "2020-04-22T00:47:27Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6063", "timeline": [{"oid": "753da7c27129477f5737f71d2c0fe8f92f21a126", "url": "https://github.com/ankidroid/Anki-Android/commit/753da7c27129477f5737f71d2c0fe8f92f21a126", "message": "Send NoteEditor edits through CardTemplateEditor to CardTemplatePreviewer\n\nThis allows the preview of the combination of note and template changes,\nwhile everything is still unsaved", "committedDate": "2020-04-28T04:12:37Z", "type": "forcePushed"}, {"oid": "98a922c887456ed9c4d31bb06a0b4207129b89f1", "url": "https://github.com/ankidroid/Anki-Android/commit/98a922c887456ed9c4d31bb06a0b4207129b89f1", "message": "Allow preview of note edits\n\nFixes #5644 / Obsoletes #5705", "committedDate": "2020-06-12T22:36:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY3NzQ2MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439677461", "bodyText": "Could you extract mCurrentCard.note(), it's fine from a performance standpoint, but makes me double-take.", "author": "david-allison-1", "createdAt": "2020-06-12T23:20:18Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardTemplatePreviewer.java", "diffHunk": "@@ -132,6 +135,30 @@ protected void onCollectionLoaded(Collection col) {\n         if (mCurrentCard == null) {\n             mCurrentCard = new PreviewerCard(col, mCardList[mOrdinal]);\n         }\n+\n+        if (mNoteEditorBundle != null) {\n+            mCurrentCard.setDid(mNoteEditorBundle.getLong(\"did\"));\n+\n+            // Clear out old tags, add current tags as that can affect render\n+            for (String tag : mCurrentCard.note().getTags()) {\n+                mCurrentCard.note().delTag(tag);", "originalCommit": "98a922c887456ed9c4d31bb06a0b4207129b89f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY3OTM2NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439679364", "bodyText": "This feels like it'll cause a ConcurrentModificationException. Could you do a defensive copy to ensure this won't happen.", "author": "david-allison-1", "createdAt": "2020-06-12T23:31:05Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardTemplatePreviewer.java", "diffHunk": "@@ -132,6 +135,30 @@ protected void onCollectionLoaded(Collection col) {\n         if (mCurrentCard == null) {\n             mCurrentCard = new PreviewerCard(col, mCardList[mOrdinal]);\n         }\n+\n+        if (mNoteEditorBundle != null) {\n+            mCurrentCard.setDid(mNoteEditorBundle.getLong(\"did\"));\n+\n+            // Clear out old tags, add current tags as that can affect render\n+            for (String tag : mCurrentCard.note().getTags()) {", "originalCommit": "98a922c887456ed9c4d31bb06a0b4207129b89f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY4NzQ2NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439687465", "bodyText": "Optional: Could extract to a method on note", "author": "david-allison-1", "createdAt": "2020-06-13T00:23:27Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardTemplatePreviewer.java", "diffHunk": "@@ -132,6 +135,30 @@ protected void onCollectionLoaded(Collection col) {\n         if (mCurrentCard == null) {\n             mCurrentCard = new PreviewerCard(col, mCardList[mOrdinal]);\n         }\n+\n+        if (mNoteEditorBundle != null) {\n+            mCurrentCard.setDid(mNoteEditorBundle.getLong(\"did\"));\n+\n+            // Clear out old tags, add current tags as that can affect render\n+            for (String tag : mCurrentCard.note().getTags()) {\n+                mCurrentCard.note().delTag(tag);\n+            }\n+            ArrayList<String> tags = mNoteEditorBundle.getStringArrayList(\"tags\");\n+            if (tags != null) {\n+                for (String tag : tags) {\n+                    if (!mCurrentCard.note().hasTag(tag)) {", "originalCommit": "98a922c887456ed9c4d31bb06a0b4207129b89f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTc2OTE3Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439769172", "bodyText": "Note is libanki, I won't alter it for optional", "author": "mikehardy", "createdAt": "2020-06-13T21:06:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY4NzQ2NQ=="}], "type": "inlineReview"}, {"oid": "117b86ea6f6d4998bd7adec13a99d8472ab1a477", "url": "https://github.com/ankidroid/Anki-Android/commit/117b86ea6f6d4998bd7adec13a99d8472ab1a477", "message": "NF: de-lint NoteEditor", "committedDate": "2020-06-13T20:26:01Z", "type": "commit"}, {"oid": "8cc3d499353737e7a3f67e631e82b58426729004", "url": "https://github.com/ankidroid/Anki-Android/commit/8cc3d499353737e7a3f67e631e82b58426729004", "message": "NF: de-lint CardTemplatePreviewer", "committedDate": "2020-06-13T20:39:18Z", "type": "commit"}, {"oid": "17ead7a528a4bb022073a9a6db959b795d51f1e0", "url": "https://github.com/ankidroid/Anki-Android/commit/17ead7a528a4bb022073a9a6db959b795d51f1e0", "message": "NF: Use concrete ArrayList for tags so Bundle put/get works", "committedDate": "2020-06-13T21:53:22Z", "type": "commit"}, {"oid": "2c813b2a4854a5c2e1a6937f22a2eda8989949c9", "url": "https://github.com/ankidroid/Anki-Android/commit/2c813b2a4854a5c2e1a6937f22a2eda8989949c9", "message": "Add Preview to NoteEditor, re-uses CardTtemplatePreviewer for display\n\nFixes #6544", "committedDate": "2020-06-13T21:53:26Z", "type": "commit"}, {"oid": "36604cf8081589aa134322416af4ff9125da99b3", "url": "https://github.com/ankidroid/Anki-Android/commit/36604cf8081589aa134322416af4ff9125da99b3", "message": "Stay in NoteEditor after template edit if in add note mode\n\nPreviously it would detect the \"current card\" as missing and close\nafter a template edit because you don't want to edit a card that goes\naway, but in add note mode there are no cards yet, and it's fine to\ncontinue editing", "committedDate": "2020-06-13T22:01:29Z", "type": "commit"}, {"oid": "36604cf8081589aa134322416af4ff9125da99b3", "url": "https://github.com/ankidroid/Anki-Android/commit/36604cf8081589aa134322416af4ff9125da99b3", "message": "Stay in NoteEditor after template edit if in add note mode\n\nPreviously it would detect the \"current card\" as missing and close\nafter a template edit because you don't want to edit a card that goes\naway, but in add note mode there are no cards yet, and it's fine to\ncontinue editing", "committedDate": "2020-06-13T22:01:29Z", "type": "forcePushed"}, {"oid": "2e584096a87dd6c15fd4ab5e3c4525d49cbcc199", "url": "https://github.com/ankidroid/Anki-Android/commit/2e584096a87dd6c15fd4ab5e3c4525d49cbcc199", "message": "NF: add test for preview of edit on existing note", "committedDate": "2020-06-13T22:56:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgzOTcyOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439839729", "bodyText": "the old name seems better (but it's not good).", "author": "david-allison-1", "createdAt": "2020-06-14T15:15:30Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java", "diffHunk": "@@ -1351,7 +1373,7 @@ private void initFieldEditText(FieldEditText editText, final int index, String[]\n             public void afterTextChanged(Editable arg0) {\n                 mFieldEdited = true;\n                 if (index == 0) {\n-                    duplicateCheck();\n+                    setDuplicateFieldStyles();", "originalCommit": "2e584096a87dd6c15fd4ab5e3c4525d49cbcc199", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg0NTE1Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439845156", "bodyText": "The old name had no indication it had side effects. Not it's a side-effecty verb. Changed on purpose, leaving", "author": "mikehardy", "createdAt": "2020-06-14T16:15:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgzOTcyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1MzQ4Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439853486", "bodyText": "Is there any particular reason to indicate which kinds of list is used everywhere ? Are we using any feature that is not available to standard list ?\nI'd assume that it would be better to leave types as generic as possible, in order to have the freedom to change implementation as easily as possible if we ever want it.", "author": "Arthur-Milchior", "createdAt": "2020-06-14T17:57:41Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java", "diffHunk": "@@ -176,7 +176,7 @@\n \n     private Note mEditorNote;\n     public static Card mCurrentEditedCard;\n-    private List<String> mSelectedTags;\n+    private ArrayList<String> mSelectedTags;", "originalCommit": "17ead7a528a4bb022073a9a6db959b795d51f1e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NDA2NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439854065", "bodyText": "Yes. Per the comment on the commit. The Bundle API can put/get ArrayList types but not generic List.", "author": "mikehardy", "createdAt": "2020-06-14T18:05:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1MzQ4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NDIwNA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439854204", "bodyText": "Any reason to transform it into an array before iterating ?\nI would expect it to be easier to iterate on the list directly. In particular it would avoid to create an array just to discard it after", "author": "Arthur-Milchior", "createdAt": "2020-06-14T18:06:43Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardTemplatePreviewer.java", "diffHunk": "@@ -135,6 +138,32 @@ protected void onCollectionLoaded(Collection col) {\n         if (mCurrentCard == null) {\n             mCurrentCard = new PreviewerCard(col, mCardList[mOrdinal]);\n         }\n+\n+        if (mNoteEditorBundle != null) {\n+            mCurrentCard.setDid(mNoteEditorBundle.getLong(\"did\"));\n+\n+            // Clear out old tags, add current tags as that can affect render\n+            Note currentNote = mCurrentCard.note();\n+            String[] currentTags = currentNote.getTags().toArray(new String[0]);\n+            for (String tag : currentTags) {\n+                currentNote.delTag(tag);\n+            }\n+            ArrayList<String> tagsList = mNoteEditorBundle.getStringArrayList(\"tags\");\n+            if (tagsList != null) {\n+                for (String tag : tagsList.toArray(new String[0])) {", "originalCommit": "2c813b2a4854a5c2e1a6937f22a2eda8989949c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NDI5NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439854294", "bodyText": "I may assume that you fear the list gets modified during execution, leading to an error, maybe a comment would make it more clear", "author": "Arthur-Milchior", "createdAt": "2020-06-14T18:07:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NDIwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NTgwNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439855805", "bodyText": "That is precisely it, David asked for a local copy to avoid ConcurrentModificationException. I'll add a comment.", "author": "mikehardy", "createdAt": "2020-06-14T18:27:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NDIwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NzI3Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439857273", "bodyText": "comment clarified", "author": "mikehardy", "createdAt": "2020-06-14T18:46:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NDIwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NDg3MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439854871", "bodyText": "Usually, you add a tag without checking whether it is already in the list of tag, so this is quite strange to read.\nI don't expect it to be a problem in any way, since there is not enough tag for the inefficiency to matter. I still would feel like that it would be clearer to put in Note.java a method setTags(List<String>); and leave this background task to Note.", "author": "Arthur-Milchior", "createdAt": "2020-06-14T18:15:08Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardTemplatePreviewer.java", "diffHunk": "@@ -135,6 +138,32 @@ protected void onCollectionLoaded(Collection col) {\n         if (mCurrentCard == null) {\n             mCurrentCard = new PreviewerCard(col, mCardList[mOrdinal]);\n         }\n+\n+        if (mNoteEditorBundle != null) {\n+            mCurrentCard.setDid(mNoteEditorBundle.getLong(\"did\"));\n+\n+            // Clear out old tags, add current tags as that can affect render\n+            Note currentNote = mCurrentCard.note();\n+            String[] currentTags = currentNote.getTags().toArray(new String[0]);\n+            for (String tag : currentTags) {\n+                currentNote.delTag(tag);\n+            }\n+            ArrayList<String> tagsList = mNoteEditorBundle.getStringArrayList(\"tags\");\n+            if (tagsList != null) {\n+                for (String tag : tagsList.toArray(new String[0])) {\n+                    if (!currentNote.hasTag(tag)) {", "originalCommit": "2c813b2a4854a5c2e1a6937f22a2eda8989949c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NTg5MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439855890", "bodyText": "I am not altering Note.java (which is in libanki, and I don't want to touch it) on purpose. The tag reset is done here because I want to make certain the tags sent to the webview (which I think are visible and thus may alter render) are exactly the tags that might be edited-but-not-saved in the NoteEditor", "author": "mikehardy", "createdAt": "2020-06-14T18:29:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NDg3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1ODU5MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439858590", "bodyText": "It did occur multiple time that a small code was added to a libanki method, at the end of the file, indicating this is a method for us.\nRemoving all tags one by one is usulessly slow, even if the number of tags made it not a real problem.\nAt least, I believe it would make sens to put this in a function in util, or someplace like that, so that it is clear that the whole part of the code does a single thing: replace the list of tags, and if it's ever needed again, it can be reused easily", "author": "Arthur-Milchior", "createdAt": "2020-06-14T19:04:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NDg3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg2NDE5Nw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439864197", "bodyText": "I'm not doing that in this PR.", "author": "mikehardy", "createdAt": "2020-06-14T20:21:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NDg3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NTQyNw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439855427", "bodyText": "I had trouble thinking how it could be true. mCurrentEditedCard was a card already existing, and card usually don't disappear unless you check for empty card. You are not supposed to be able to do it while you're reviewing.\nI then realized that it can be true if you change a note type. If I'm right, I believe a comment here would be nice to explain it. If I'm wrong, it shows explanation may help here.\nAs a side note, I don't really get the point. Even if the card did disappear, editing the note still makes sens. Either there are other cards and we may want to edit them. Or they are no other card, and in this case the fields won't be recoverable, and it's even more important to give a strong warning to user that they'll lose data.\nActually, I had to create an add-on for anki to warn when note would be deleted because it would generate no more card. It occured multiple time to me and was always an accident, a template I did badly edit. In all cases, I would have wanted anki to warn me instead of just deleting the note", "author": "Arthur-Milchior", "createdAt": "2020-06-14T18:22:25Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java", "diffHunk": "@@ -1136,9 +1136,13 @@ else if (fieldEditText.getText() != null) {\n                     mReloadRequired = true;\n                     mEditorNote.reloadModel();\n                     if (!mEditorNote.cards().contains(mCurrentEditedCard)) {", "originalCommit": "36604cf8081589aa134322416af4ff9125da99b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NjA4Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439856082", "bodyText": "I don't believe this functionality changed. Are you making a comment on my PR or is this a separate issue that should be logged as a separate defect?", "author": "mikehardy", "createdAt": "2020-06-14T18:31:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NTQyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NzQzNA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439857434", "bodyText": "Also worth noting that in #5151 there was much work done to make sure that deleting a card would orphan a note. We don't allow that. I don't think it has anything to do with this PR. 9777bee", "author": "mikehardy", "createdAt": "2020-06-14T18:48:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NTQyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg3NDY3NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439874674", "bodyText": "Sorry, didn't see the message, I didn't thought about expending resolved conversation.\nIndeed, this remark was related to the case you have not just introduced. I is not clear to me how it used to be possible. When you can enter this if branch.", "author": "Arthur-Milchior", "createdAt": "2020-06-14T22:40:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NTQyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg3NDk2MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439874961", "bodyText": "If I am in NoteEditor on for example 'Card 3', and I go to CardTemplateEditor and delete the Card 3 template, then save it and it returns to the NoteEditor, NoteEditor hits this case. And in general now it will just boot you out.\nHowever, if you are in NoteEditor in \"add note\" mode (so there is no current card) and you go to CardTemplatePreviewer, you will come back here and also be in this case. But in that specific situation it's okay, there was no card to begin with so we don't need to leave.", "author": "mikehardy", "createdAt": "2020-06-14T22:43:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NTQyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg3NTIxNA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439875214", "bodyText": "Thank you for the explanation.", "author": "Arthur-Milchior", "createdAt": "2020-06-14T22:46:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NTQyNw=="}], "type": "inlineReview"}, {"oid": "d443cf36ffe7e561bb7d919b109320f0ffb0bbf8", "url": "https://github.com/ankidroid/Anki-Android/commit/d443cf36ffe7e561bb7d919b109320f0ffb0bbf8", "message": "NF: comment clarification for tag copy in CardTemplatePreviewer", "committedDate": "2020-06-14T18:44:38Z", "type": "commit"}]}