{"pr_number": 725, "pr_title": "Use status index during status validation", "pr_createdAt": "2020-12-21T15:00:39Z", "pr_url": "https://github.com/RIPE-NCC/whois/pull/725", "timeline": [{"oid": "ee49c5b72a5cc3d41628bb70285dc740f6694975", "url": "https://github.com/RIPE-NCC/whois/commit/ee49c5b72a5cc3d41628bb70285dc740f6694975", "message": "Use the status index to find status of children, don't load entire objects", "committedDate": "2020-12-21T14:52:48Z", "type": "commit"}, {"oid": "9374d9942ab0a70d3a036d607379a01117a7adb3", "url": "https://github.com/RIPE-NCC/whois/commit/9374d9942ab0a70d3a036d607379a01117a7adb3", "message": "Use the status index to find status, don't load entire objects", "committedDate": "2020-12-21T15:08:34Z", "type": "commit"}, {"oid": "250ceeadef7762162d371092a943ab59ce9160db", "url": "https://github.com/RIPE-NCC/whois/commit/250ceeadef7762162d371092a943ab59ce9160db", "message": "Added StatusDao", "committedDate": "2020-12-21T22:28:48Z", "type": "commit"}, {"oid": "d09160b703eb96d64408575d4cdcd6dbacaf03a4", "url": "https://github.com/RIPE-NCC/whois/commit/d09160b703eb96d64408575d4cdcd6dbacaf03a4", "message": "Refactored StatusValidator (use StatusDao)", "committedDate": "2020-12-21T22:29:21Z", "type": "commit"}, {"oid": "ab7b426c9392e46348cf198cd26e094ec6cb9a51", "url": "https://github.com/RIPE-NCC/whois/commit/ab7b426c9392e46348cf198cd26e094ec6cb9a51", "message": "Separate inetnum and inet6num status validator classes", "committedDate": "2021-01-04T13:23:24Z", "type": "commit"}, {"oid": "4ef5a93f63b1513ede1b3da42efe60a84bfb0b82", "url": "https://github.com/RIPE-NCC/whois/commit/4ef5a93f63b1513ede1b3da42efe60a84bfb0b82", "message": "Use status index to retrieve all child inetnum status values.\n\nUsing a real worst-case example, for 100K children this now takes 2s.", "committedDate": "2021-01-04T17:06:03Z", "type": "commit"}, {"oid": "4b3dd0d3b7590b021c91ec20eb837916a8bef00c", "url": "https://github.com/RIPE-NCC/whois/commit/4b3dd0d3b7590b021c91ec20eb837916a8bef00c", "message": "Separated inetnum and inet6num strict validators", "committedDate": "2021-01-04T20:46:09Z", "type": "commit"}, {"oid": "90d983e57d89115dee9dd8e28b08bca6a84cf859", "url": "https://github.com/RIPE-NCC/whois/commit/90d983e57d89115dee9dd8e28b08bca6a84cf859", "message": "Use status index to lookup parent and child status", "committedDate": "2021-01-04T22:49:45Z", "type": "commit"}, {"oid": "7ad23b9452e9c7749d1ee4a67bf87a19f8ce43fc", "url": "https://github.com/RIPE-NCC/whois/commit/7ad23b9452e9c7749d1ee4a67bf87a19f8ce43fc", "message": "Fixed tests (ignore invalid status, re-ordered error messages)", "committedDate": "2021-01-04T23:49:48Z", "type": "commit"}, {"oid": "ad703b39fb81cee5edf788f51ffc56c6963e71a7", "url": "https://github.com/RIPE-NCC/whois/commit/ad703b39fb81cee5edf788f51ffc56c6963e71a7", "message": "Added tests", "committedDate": "2021-01-07T08:58:06Z", "type": "commit"}, {"oid": "016380dca3777333059ab50720f2618b184f3c63", "url": "https://github.com/RIPE-NCC/whois/commit/016380dca3777333059ab50720f2618b184f3c63", "message": "Merge branch 'master' into status_validator_index", "committedDate": "2021-01-07T15:41:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzQwODc4Mg==", "url": "https://github.com/RIPE-NCC/whois/pull/725#discussion_r553408782", "bodyText": "FYI some messages reversed order when I renamed / moved the validator classes", "author": "eshryane", "createdAt": "2021-01-07T15:43:19Z", "path": "whois-endtoend/src/test/groovy/net/ripe/db/whois/spec/update/InetnumSpec.groovy", "diffHunk": "@@ -1449,8 +1449,8 @@ class InetnumSpec extends BaseQueryUpdateSpec {\n         ack.countErrorWarnInfo(2, 0, 1)\n         ack.errors.any { it.operation == \"Create\" && it.key == \"[inetnum] 62.59.192.2 - 62.59.192.30\" }\n         ack.errorMessagesFor(\"Create\", \"[inetnum] 62.59.192.2 - 62.59.192.30\") ==\n-                [\"This range overlaps with 62.59.192.0 - 62.59.192.7\",\n-                \"Status ASSIGNED PA not allowed when more specific object '62.59.192.8 - 62.59.192.15' has status ALLOCATED PA\"]\n+                [\"Status ASSIGNED PA not allowed when more specific object '62.59.192.8 - 62.59.192.15' has status ALLOCATED PA\",", "originalCommit": "016380dca3777333059ab50720f2618b184f3c63", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d389277c54e65b97bfa0d332c8ea50b7dd755704", "url": "https://github.com/RIPE-NCC/whois/commit/d389277c54e65b97bfa0d332c8ea50b7dd755704", "message": "Removed @Ignore from fixed test (empty response body bug fixed by Jersey 2.22). (#730)", "committedDate": "2021-01-08T09:38:17Z", "type": "commit"}, {"oid": "7ce7d7d8ee26c375b0d2f37ee1f5dda631cde574", "url": "https://github.com/RIPE-NCC/whois/commit/7ce7d7d8ee26c375b0d2f37ee1f5dda631cde574", "message": "Aws (#721)\n\n* Create whois docker image.\r\n\r\n* Hardcoded config locations for now.\r\n\r\n* Push docker image to Gitlab container registry.\r\n\r\n* Use build image with docker client.\r\n\r\n* Use Gitlab ECS deployment template.\r\n\r\n* Deploy to AWS.\r\n\r\n* Deploy to AWS.\r\n\r\n* Use AWS CLI from whois-build image (as Gitlab's aws-ecs image does not provide docker).\r\n\r\n* Use AWS v2 CLI.\r\n\r\n* Need more debugging info.\r\n\r\n* Need more debugging info.\r\n\r\n* Don't need this.\r\n\r\n* Fiddling with ecs task definition format..\r\n\r\n* Remove script debugging.\r\n\r\n* Set deployment to manual.\r\n\r\n* Deploy aws (#654)\r\n\r\n* Use build image with docker client.\r\n\r\n* Use Gitlab ECS deployment template.\r\n\r\n* Deploy to AWS.\r\n\r\n* Deploy to AWS.\r\n\r\n* Use AWS CLI from whois-build image (as Gitlab's aws-ecs image does not provide docker).\r\n\r\n* Use AWS v2 CLI.\r\n\r\n* Need more debugging info.\r\n\r\n* Need more debugging info.\r\n\r\n* Don't need this.\r\n\r\n* Fiddling with ecs task definition format..\r\n\r\n* Remove script debugging.\r\n\r\n* Set deployment to manual.\r\n\r\n* Renamed whois-ecr docker registry to whois.\r\n\r\n* Aws ripe profile (#653)\r\n\r\n* use aws profile and ripe profile\r\n\r\n* add todo\r\n\r\n* remove propertysource for aws profile\r\n\r\n* basic refactoring\r\n\r\n* remove hard coded spring profile\r\n\r\n* use env variable for aws region\r\n\r\n* automate properties\r\n\r\n* use command line arguments\r\n\r\n* Pickup instance hostname to seperate instance filesystems.\r\n\r\n* Create any missing output directories.\r\n\r\n* Output dirs should already be created automatically.\r\n\r\n* Rewrites (#656)\r\n\r\n* Handle rewrites in AWS environment.\r\n\r\n* Use feature toggle for rewrites rather than tying it into AWS profile (easier to test).\r\nCorrected handler chaining.\r\n\r\n* Added integration tests\r\n\r\n* Fix syncupdates rewrite.\r\n\r\nCo-authored-by: Ed Shryane <eshryane@ripe.net>\r\n\r\n* Added UseContainerSupport.\r\n\r\n* added ability to deploy to aws for prepdev (#682)\r\n\r\n* Adding deploy_aws_prepdev job. Still needs configuration\r\n\r\n* logging  .gitlab-ci.yml\r\n\r\n* more logging in .gitlab-ci.yml\r\n\r\n* more logging in .gitlab-ci.yml\r\n\r\n* removed $\r\n\r\n* log\r\n\r\n* trying out setting the needed variable\r\n\r\n* trying out setting the needed variable\r\n\r\n* removed echo linne\r\n\r\n* trying out having the expot also in before_script\r\n\r\n* trying out staged scope variable\r\n\r\n* switching back to using export\r\n\r\nCo-authored-by: Dadepo Aderemi <daderemi@ripe.net>\r\n\r\n* aws ecs cluster swe -> whois.\r\n\r\n* Use latest whois-build image.\r\n\r\n* Run Java11.\r\n\r\n* genrify deploy template (#709)\r\n\r\n* genrify deploy template\r\n\r\n* use common template\r\n\r\n* syntax errort\r\n\r\n* Use latest deploy template.\r\n\r\nCo-authored-by: Sander Buskens <sbuskens@ripe.net>\r\n\r\n* Differentiate artifact dir.\r\n\r\n* Only build container in release phase.\r\n\r\nCo-authored-by: maggarwal13 <50230916+maggarwal13@users.noreply.github.com>\r\nCo-authored-by: mahesh aggarwal <maggarwal@ripe.net>\r\nCo-authored-by: Ed Shryane <eshryane@ripe.net>\r\nCo-authored-by: dadepo <dadepo@gmail.com>\r\nCo-authored-by: Dadepo Aderemi <daderemi@ripe.net>", "committedDate": "2021-01-08T09:38:17Z", "type": "commit"}, {"oid": "55328ad216eb1379a77a8af45fce5def6cd181f7", "url": "https://github.com/RIPE-NCC/whois/commit/55328ad216eb1379a77a8af45fce5def6cd181f7", "message": "Merge branch 'master' into status_validator_index", "committedDate": "2021-01-08T09:42:32Z", "type": "commit"}, {"oid": "d170666eba552df0ce9a5b3746a2c75619462440", "url": "https://github.com/RIPE-NCC/whois/commit/d170666eba552df0ce9a5b3746a2c75619462440", "message": "Merge branch 'master' into status_validator_index", "committedDate": "2021-02-15T09:56:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjEwMjkzOA==", "url": "https://github.com/RIPE-NCC/whois/pull/725#discussion_r576102938", "bodyText": "Use constant for the magic number.", "author": "sbusk", "createdAt": "2021-02-15T10:50:24Z", "path": "whois-commons/src/main/java/net/ripe/db/whois/common/dao/jdbc/JdbcStatusDao.java", "diffHunk": "@@ -0,0 +1,58 @@\n+package net.ripe.db.whois.common.dao.jdbc;\n+\n+import com.google.common.collect.Lists;\n+import com.google.common.collect.Maps;\n+import net.ripe.db.whois.common.aspects.RetryFor;\n+import net.ripe.db.whois.common.dao.StatusDao;\n+import net.ripe.db.whois.common.domain.CIString;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.dao.RecoverableDataAccessException;\n+import org.springframework.jdbc.core.JdbcTemplate;\n+import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;\n+import org.springframework.stereotype.Repository;\n+\n+import javax.sql.DataSource;\n+import java.util.List;\n+import java.util.Map;\n+\n+@Repository\n+@RetryFor(RecoverableDataAccessException.class)\n+public class JdbcStatusDao implements StatusDao {\n+\n+    private final NamedParameterJdbcTemplate namedParameterJdbcTemplate;\n+    private final JdbcTemplate jdbcTemplate;\n+\n+    @Autowired\n+    public JdbcStatusDao(@Qualifier(\"sourceAwareDataSource\") final DataSource dataSource) {\n+        this.jdbcTemplate = new JdbcTemplate(dataSource);\n+        this.namedParameterJdbcTemplate = new NamedParameterJdbcTemplate(jdbcTemplate);\n+    }\n+\n+    @Override\n+    public CIString getStatus(final int objectId) {\n+        return jdbcTemplate.queryForObject(\n+            \"SELECT status FROM status WHERE object_id = ?\",\n+            (rs, rowNum) -> CIString.ciString(rs.getString(1)),\n+            objectId);\n+    }\n+\n+    @Override\n+    public Map<Integer, CIString> getStatus(final List<Integer> objectIds) {\n+        final Map<Integer, CIString> results = Maps.newHashMap();\n+        final Map<String, Object> params = Maps.newHashMap();\n+\n+        // partition object ids to keep inside the max_packet_size limit for the IN clause\n+        for (List<Integer> partition : Lists.partition(objectIds, 10_000)) {", "originalCommit": "d170666eba552df0ce9a5b3746a2c75619462440", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjI0MjAxNA==", "url": "https://github.com/RIPE-NCC/whois/pull/725#discussion_r576242014", "bodyText": "Done, thanks!", "author": "eshryane", "createdAt": "2021-02-15T14:47:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjEwMjkzOA=="}], "type": "inlineReview"}, {"oid": "8d5b611914b74d0fa3680b882d334d66e82e4f64", "url": "https://github.com/RIPE-NCC/whois/commit/8d5b611914b74d0fa3680b882d334d66e82e4f64", "message": "Made magic number a constant.", "committedDate": "2021-02-15T14:44:56Z", "type": "commit"}]}