{"pr_number": 612, "pr_title": "Nrtm acl limit", "pr_createdAt": "2020-03-16T14:09:59Z", "pr_url": "https://github.com/RIPE-NCC/whois/pull/612", "timeline": [{"oid": "0eb8ace3dc19e5a624d0074ebe757cb2418e6d68", "url": "https://github.com/RIPE-NCC/whois/commit/0eb8ace3dc19e5a624d0074ebe757cb2418e6d68", "message": "add acl limit to nrtm", "committedDate": "2020-03-13T08:47:27Z", "type": "commit"}, {"oid": "828fc855ebd0a771b100f5dc735cea853a6bc5e3", "url": "https://github.com/RIPE-NCC/whois/commit/828fc855ebd0a771b100f5dc735cea853a6bc5e3", "message": "Merge branch 'master' into nrtm_acl_limit", "committedDate": "2020-03-13T09:14:10Z", "type": "commit"}, {"oid": "082677e9646f892b0ea68db27f84f18992b3cdbf", "url": "https://github.com/RIPE-NCC/whois/commit/082677e9646f892b0ea68db27f84f18992b3cdbf", "message": "add query application context in nrtm", "committedDate": "2020-03-13T09:52:15Z", "type": "commit"}, {"oid": "ae4f165300cfee6475ba3c6c4a5df9756b7cca0e", "url": "https://github.com/RIPE-NCC/whois/commit/ae4f165300cfee6475ba3c6c4a5df9756b7cca0e", "message": "add integration tests", "committedDate": "2020-03-13T11:40:37Z", "type": "commit"}, {"oid": "0f9aeb66a09259de5026a3e78440390edffbcd10", "url": "https://github.com/RIPE-NCC/whois/commit/0f9aeb66a09259de5026a3e78440390edffbcd10", "message": "inject only acl package in nrtm", "committedDate": "2020-03-16T09:58:39Z", "type": "commit"}, {"oid": "f36fddbc1d6a46861c48a78ce9c7d7550e3b81f8", "url": "https://github.com/RIPE-NCC/whois/commit/f36fddbc1d6a46861c48a78ce9c7d7550e3b81f8", "message": "include acl package from whois-query", "committedDate": "2020-03-16T14:08:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA1MTQzOQ==", "url": "https://github.com/RIPE-NCC/whois/pull/612#discussion_r393051439", "bodyText": "Please fix your IDE settings not to use \"star\" for imports, it's harder to diff changes", "author": "eshryane", "createdAt": "2020-03-16T14:13:40Z", "path": "whois-nrtm/src/test/java/net/ripe/db/whois/nrtm/NrtmConnectionPerIpLimitHandlerTest.java", "diffHunk": "@@ -11,14 +13,14 @@\n import org.junit.Test;\n import org.junit.runner.RunWith;\n import org.mockito.ArgumentMatcher;\n+import org.mockito.Matchers;\n import org.mockito.Mock;\n import org.mockito.runners.MockitoJUnitRunner;\n \n import java.net.Inet4Address;\n import java.net.InetSocketAddress;\n \n-import static org.mockito.Matchers.anyObject;\n-import static org.mockito.Matchers.argThat;\n+import static org.mockito.Matchers.*;", "originalCommit": "f36fddbc1d6a46861c48a78ce9c7d7550e3b81f8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA1MzI5NQ==", "url": "https://github.com/RIPE-NCC/whois/pull/612#discussion_r393053295", "bodyText": "This method is misleading, the name suggests there are no side-effects, but then it can close the connection. The method does multiple things, and it's only called once - I think it's clearer to inline it into the channelOpen method()?", "author": "eshryane", "createdAt": "2020-03-16T14:15:23Z", "path": "whois-nrtm/src/main/java/net/ripe/db/whois/nrtm/NrtmConnectionPerIpLimitHandler.java", "diffHunk": "@@ -70,4 +72,23 @@ private boolean connectionsExceeded(final InetAddress remoteAddresss) {\n         final Integer count = connectionCounter.increment(remoteAddresss);\n         return (count != null && count > maxConnectionsPerIp);\n     }\n+\n+    private boolean canOpenConnection(final Channel channel, final InetAddress remoteAddress) {", "originalCommit": "f36fddbc1d6a46861c48a78ce9c7d7550e3b81f8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA1NjkwOA==", "url": "https://github.com/RIPE-NCC/whois/pull/612#discussion_r393056908", "bodyText": "Can you move the ACL logic into a separate class? Look at the #596 PR for an example (there's a separate class for AccessControlList).  It's confusing that this Handler now also includes the ACL logic, it should be separate.", "author": "eshryane", "createdAt": "2020-03-16T14:18:49Z", "path": "whois-nrtm/src/main/java/net/ripe/db/whois/nrtm/NrtmConnectionPerIpLimitHandler.java", "diffHunk": "@@ -23,29 +23,31 @@\n @ChannelHandler.Sharable\n public class NrtmConnectionPerIpLimitHandler extends SimpleChannelUpstreamHandler {", "originalCommit": "f36fddbc1d6a46861c48a78ce9c7d7550e3b81f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA2OTUwNg==", "url": "https://github.com/RIPE-NCC/whois/pull/612#discussion_r393069506", "bodyText": "Earlier I thought of moving it to a different class but this class name is connection limit perIp handler and acl also works on per Ip limit so I put the logic in same class, but I not a big deal to put it in a seperate class if it makes it more readable", "author": "maggarwal13", "createdAt": "2020-03-16T14:32:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA1NjkwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA4OTI1Ng==", "url": "https://github.com/RIPE-NCC/whois/pull/612#discussion_r393089256", "bodyText": "Great, thanks!", "author": "eshryane", "createdAt": "2020-03-16T14:59:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA1NjkwOA=="}], "type": "inlineReview"}, {"oid": "dad1b86826312e1dc9d5d9e2ca4e15aa7f79a8ad", "url": "https://github.com/RIPE-NCC/whois/commit/dad1b86826312e1dc9d5d9e2ca4e15aa7f79a8ad", "message": "implementing Ed suggestions", "committedDate": "2020-03-16T15:08:44Z", "type": "commit"}, {"oid": "8188fc5423e13d6679bf0491bfc1f6854532cff0", "url": "https://github.com/RIPE-NCC/whois/commit/8188fc5423e13d6679bf0491bfc1f6854532cff0", "message": "Merge branch 'master' into nrtm_acl_limit", "committedDate": "2020-03-16T15:13:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzExNTg1MA==", "url": "https://github.com/RIPE-NCC/whois/pull/612#discussion_r393115850", "bodyText": "Can you add one \"success\" test, where the client isn't blocked or denied by ACL?", "author": "eshryane", "createdAt": "2020-03-16T15:37:07Z", "path": "whois-nrtm/src/test/java/net/ripe/db/whois/nrtm/integration/NrtmClientACLLimitTestIntegration.java", "diffHunk": "@@ -0,0 +1,103 @@\n+package net.ripe.db.whois.nrtm.integration;\n+\n+import com.jayway.awaitility.Awaitility;\n+import com.jayway.awaitility.Duration;\n+import net.ripe.db.whois.common.IntegrationTest;\n+import net.ripe.db.whois.common.dao.jdbc.DatabaseHelper;\n+import net.ripe.db.whois.common.rpsl.RpslObject;\n+import net.ripe.db.whois.common.source.SourceContext;\n+import net.ripe.db.whois.nrtm.NrtmServer;\n+import net.ripe.db.whois.nrtm.client.NrtmImporter;\n+import net.ripe.db.whois.query.acl.AccessControlListManager;\n+import net.ripe.db.whois.query.acl.IpResourceConfiguration;\n+import net.ripe.db.whois.query.support.TestPersonalObjectAccounting;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.test.annotation.DirtiesContext;\n+\n+import java.net.InetAddress;\n+\n+@Category(IntegrationTest.class)", "originalCommit": "8188fc5423e13d6679bf0491bfc1f6854532cff0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzE0MDY4Nw==", "url": "https://github.com/RIPE-NCC/whois/pull/612#discussion_r393140687", "bodyText": "Have added a success case in junit.\nActually this integration test does not make sense here. As we are just waiting for 5 seconds and checking the nrtm client thread count > 0, (copied from NrtmClientInvalidHostTestIntegration). We should be deleting this integration test and same for NrtmClientInvalidHostTestIntegration or find a different way to check if channel is open or not.\nInfact NrtmClientTestIntegration also does not do much of a testing or  am I missing something?", "author": "maggarwal13", "createdAt": "2020-03-16T16:12:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzExNTg1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU2NDMzOQ==", "url": "https://github.com/RIPE-NCC/whois/pull/612#discussion_r393564339", "bodyText": "for NrtmClientTestIntegration  we inject different jdbctemplate that is fine then", "author": "maggarwal13", "createdAt": "2020-03-17T10:01:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzExNTg1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzY5MDgzOA==", "url": "https://github.com/RIPE-NCC/whois/pull/612#discussion_r393690838", "bodyText": "Thanks for fixing the tests", "author": "eshryane", "createdAt": "2020-03-17T13:47:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzExNTg1MA=="}], "type": "inlineReview"}, {"oid": "286c6969177490e85ed2a9fd99e63c92ed321527", "url": "https://github.com/RIPE-NCC/whois/commit/286c6969177490e85ed2a9fd99e63c92ed321527", "message": "adding success case", "committedDate": "2020-03-16T16:01:52Z", "type": "commit"}, {"oid": "de59365d1fcab216936f3a5cbde8a67e30395b21", "url": "https://github.com/RIPE-NCC/whois/commit/de59365d1fcab216936f3a5cbde8a67e30395b21", "message": "Merge branch 'master' into nrtm_acl_limit", "committedDate": "2020-03-17T08:06:20Z", "type": "commit"}, {"oid": "fcd192982cc1550ce88f185a4b62b9b337e19c1d", "url": "https://github.com/RIPE-NCC/whois/commit/fcd192982cc1550ce88f185a4b62b9b337e19c1d", "message": "Merge branch 'master' into nrtm_acl_limit", "committedDate": "2020-03-17T08:32:37Z", "type": "commit"}, {"oid": "fd7a330907626c52eb4a321f6dbf2908b23a373f", "url": "https://github.com/RIPE-NCC/whois/commit/fd7a330907626c52eb4a321f6dbf2908b23a373f", "message": "fixing acl limit test case", "committedDate": "2020-03-17T10:51:52Z", "type": "commit"}, {"oid": "4ec095161a483a1831b8f7d675c8e07c515172ab", "url": "https://github.com/RIPE-NCC/whois/commit/4ec095161a483a1831b8f7d675c8e07c515172ab", "message": "Merge branch 'nrtm_acl_limit' of github.com:RIPE-NCC/whois into nrtm_acl_limit\n\n* 'nrtm_acl_limit' of github.com:RIPE-NCC/whois:\n  Restored failsafe config (re-ordered) and integration tests are passing (locally) (?)", "committedDate": "2020-03-17T10:52:05Z", "type": "commit"}, {"oid": "01e49a495715a906df758b73fbe91e51a9b60ece", "url": "https://github.com/RIPE-NCC/whois/commit/01e49a495715a906df758b73fbe91e51a9b60ece", "message": "refactor unit test case", "committedDate": "2020-03-17T11:30:58Z", "type": "commit"}, {"oid": "42aa31a8b4526c6c51b20c0a7e09f61c51491b82", "url": "https://github.com/RIPE-NCC/whois/commit/42aa31a8b4526c6c51b20c0a7e09f61c51491b82", "message": "refactor", "committedDate": "2020-03-17T11:35:20Z", "type": "commit"}, {"oid": "b5bf429d7bcfed341062a27a120bfebee66e22a6", "url": "https://github.com/RIPE-NCC/whois/commit/b5bf429d7bcfed341062a27a120bfebee66e22a6", "message": "unused injected beans", "committedDate": "2020-03-17T11:38:02Z", "type": "commit"}, {"oid": "8a997b04b6a4d6130c08b5b643cdfb599dc7af72", "url": "https://github.com/RIPE-NCC/whois/commit/8a997b04b6a4d6130c08b5b643cdfb599dc7af72", "message": "Merge branch 'master' into nrtm_acl_limit", "committedDate": "2020-03-17T11:40:12Z", "type": "commit"}, {"oid": "b41038d76f374156bb26c99e6602c1376c18f4ed", "url": "https://github.com/RIPE-NCC/whois/commit/b41038d76f374156bb26c99e6602c1376c18f4ed", "message": "Renamed class for consistency", "committedDate": "2020-03-17T13:39:46Z", "type": "commit"}]}