{"pr_number": 8350, "pr_title": "Add authorize() DSL method that accepts HttpMethod", "pr_createdAt": "2020-04-08T07:49:38Z", "pr_url": "https://github.com/spring-projects/spring-security/pull/8350", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc2ODQ0Mw==", "url": "https://github.com/spring-projects/spring-security/pull/8350#discussion_r405768443", "bodyText": "Please add an additional test where security is configured based on both HTTP method and servlet path.", "author": "eleftherias", "createdAt": "2020-04-08T19:41:08Z", "path": "config/src/test/kotlin/org/springframework/security/config/web/servlet/AuthorizeRequestsDslTests.kt", "diffHunk": "@@ -271,4 +274,43 @@ class AuthorizeRequestsDslTests {\n             }\n         }\n     }\n+", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc2ODY5NA==", "url": "https://github.com/spring-projects/spring-security/pull/8350#discussion_r405768694", "bodyText": "Small typo: metod -> method", "author": "eleftherias", "createdAt": "2020-04-08T19:41:30Z", "path": "config/src/test/kotlin/org/springframework/security/config/web/servlet/AuthorizeRequestsDslTests.kt", "diffHunk": "@@ -271,4 +274,43 @@ class AuthorizeRequestsDslTests {\n             }\n         }\n     }\n+\n+    @EnableWebSecurity\n+    @EnableWebMvc\n+    open class AuthorizeRequestsByMvcConfigWithHttpMethod : WebSecurityConfigurerAdapter() {\n+        override fun configure(http: HttpSecurity) {\n+            http {\n+                authorizeRequests {\n+                    authorize(HttpMethod.GET, \"/path\", permitAll)\n+                    authorize(HttpMethod.PUT, \"/path\", denyAll)\n+                }\n+            }\n+        }\n+\n+        @RestController\n+        internal class PathController {\n+            @GetMapping(\"/path\")\n+            fun permit() {\n+            }\n+\n+            @PutMapping(\"/path\")\n+            fun deny() {\n+            }\n+        }\n+    }\n+\n+    @Test\n+    fun `request when secured by mvc with http metod then responds`() {", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIzODAxMw==", "url": "https://github.com/spring-projects/spring-security/pull/8350#discussion_r406238013", "bodyText": "PUT requests should include a CSRF token\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    this.mockMvc.put(\"/path\")\n          \n          \n            \n                    this.mockMvc.put(\"/path\") {\n          \n          \n            \n                        with(csrf())\n          \n          \n            \n                    }", "author": "eleftherias", "createdAt": "2020-04-09T14:17:55Z", "path": "config/src/test/kotlin/org/springframework/security/config/web/servlet/AuthorizeRequestsDslTests.kt", "diffHunk": "@@ -271,4 +274,92 @@ class AuthorizeRequestsDslTests {\n             }\n         }\n     }\n+\n+    @EnableWebSecurity\n+    @EnableWebMvc\n+    open class AuthorizeRequestsByMvcConfigWithHttpMethod : WebSecurityConfigurerAdapter() {\n+        override fun configure(http: HttpSecurity) {\n+            http {\n+                authorizeRequests {\n+                    authorize(HttpMethod.GET, \"/path\", permitAll)\n+                    authorize(HttpMethod.PUT, \"/path\", denyAll)\n+                }\n+            }\n+        }\n+\n+        @RestController\n+        internal class PathController {\n+            @GetMapping(\"/path\")\n+            fun permit() {\n+            }\n+\n+            @PutMapping(\"/path\")\n+            fun deny() {\n+            }\n+        }\n+    }\n+\n+    @Test\n+    fun `request when secured by mvc with http method then responds`() {\n+        this.spring.register(AuthorizeRequestsByMvcConfigWithHttpMethod::class.java).autowire()\n+\n+        this.mockMvc.get(\"/path\")\n+            .andExpect {\n+                status { isOk }\n+            }\n+\n+        this.mockMvc.put(\"/path\")", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI0MTY2MA==", "url": "https://github.com/spring-projects/spring-security/pull/8350#discussion_r406241660", "bodyText": "I had a different test in mind when I mentioned using HTTP method and servlet path.\nWe should have a test similar to `request when secured by mvc with servlet path then responds based on servlet path`, but using the HTTP method.\nThe configuration would look something like\nhttp {\n    authorizeRequests {\n        authorize(HttpMethod.GET, \"/path\", \"/spring\", denyAll)\n    }\n}", "author": "eleftherias", "createdAt": "2020-04-09T14:23:19Z", "path": "config/src/test/kotlin/org/springframework/security/config/web/servlet/AuthorizeRequestsDslTests.kt", "diffHunk": "@@ -271,4 +274,92 @@ class AuthorizeRequestsDslTests {\n             }\n         }\n     }\n+\n+    @EnableWebSecurity\n+    @EnableWebMvc\n+    open class AuthorizeRequestsByMvcConfigWithHttpMethod : WebSecurityConfigurerAdapter() {\n+        override fun configure(http: HttpSecurity) {\n+            http {\n+                authorizeRequests {\n+                    authorize(HttpMethod.GET, \"/path\", permitAll)\n+                    authorize(HttpMethod.PUT, \"/path\", denyAll)\n+                }\n+            }\n+        }\n+\n+        @RestController\n+        internal class PathController {\n+            @GetMapping(\"/path\")\n+            fun permit() {\n+            }\n+\n+            @PutMapping(\"/path\")\n+            fun deny() {\n+            }\n+        }\n+    }\n+\n+    @Test\n+    fun `request when secured by mvc with http method then responds`() {\n+        this.spring.register(AuthorizeRequestsByMvcConfigWithHttpMethod::class.java).autowire()\n+\n+        this.mockMvc.get(\"/path\")\n+            .andExpect {\n+                status { isOk }\n+            }\n+\n+        this.mockMvc.put(\"/path\")\n+            .andExpect {\n+                status { isForbidden }\n+            }\n+    }\n+\n+    @EnableWebSecurity\n+    @EnableWebMvc\n+    open class AuthorizeRequestsByMvcConfigWithAndWithoutHttpMethod : WebSecurityConfigurerAdapter() {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMxNjM2MA==", "url": "https://github.com/spring-projects/spring-security/pull/8350#discussion_r406316360", "bodyText": "Sorry I misunderstood. I'll look at replacing the second test this weekend.\nAlso, I noticed that antMatchers() also has a version that accepts httpMethod, so I will add it for the antMatchers() case too. In fact, it's probably dangerous not to add it, because if the HTTP method is specified but MVC is not present, the specified method will be ignored in the implementation as it stands right now. Does that make sense to you?", "author": "adamu", "createdAt": "2020-04-09T16:11:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI0MTY2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ4NzU2OA==", "url": "https://github.com/spring-projects/spring-security/pull/8350#discussion_r407487568", "bodyText": "Absolutely, good catch.", "author": "eleftherias", "createdAt": "2020-04-13T13:50:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI0MTY2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI2NTY4MQ==", "url": "https://github.com/spring-projects/spring-security/pull/8350#discussion_r410265681", "bodyText": "It may be confusing to have a GET request calling \"/post\". It is best to rename the endpoint to something else.", "author": "eleftherias", "createdAt": "2020-04-17T14:36:22Z", "path": "config/src/test/kotlin/org/springframework/security/config/web/servlet/AuthorizeRequestsDslTests.kt", "diffHunk": "@@ -72,12 +76,29 @@ class AuthorizeRequestsDslTests {\n                 }\n     }\n \n+    @Test\n+    fun `request when allowed by regex matcher with http method then responds based on method`() {\n+        this.spring.register(AuthorizeRequestsByRegexConfig::class.java).autowire()\n+\n+        this.mockMvc.post(\"/post\") { with(csrf()) }\n+            .andExpect {\n+                status { isOk }\n+            }\n+\n+        this.mockMvc.get(\"/post\")\n+            .andExpect {\n+                status { isForbidden }\n+            }\n+    }\n+\n     @EnableWebSecurity\n     open class AuthorizeRequestsByRegexConfig : WebSecurityConfigurerAdapter() {\n         override fun configure(http: HttpSecurity) {\n             http {\n                 authorizeRequests {\n                     authorize(RegexRequestMatcher(\"/path\", null), permitAll)\n+                    authorize(RegexRequestMatcher(\"/post\", \"POST\"), permitAll)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDMyMjE2Mg==", "url": "https://github.com/spring-projects/spring-security/pull/8350#discussion_r410322162", "bodyText": "Renamed to /onlyPostPermitted", "author": "adamu", "createdAt": "2020-04-17T16:06:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI2NTY4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI2NzM3Ng==", "url": "https://github.com/spring-projects/spring-security/pull/8350#discussion_r410267376", "bodyText": "We should only use .antMatchers(HttpMethod, String) if httpMethod is not null, similar to mvcMatchers", "author": "eleftherias", "createdAt": "2020-04-17T14:38:56Z", "path": "config/src/main/kotlin/org/springframework/security/config/web/servlet/AuthorizeRequestsDsl.kt", "diffHunk": "@@ -152,9 +200,13 @@ class AuthorizeRequestsDsl : AbstractRequestMatcherDsl() {\n                     is MatcherAuthorizationRule -> requests.requestMatchers(rule.matcher).access(rule.rule)\n                     is PatternAuthorizationRule -> {\n                         when (rule.patternType) {\n-                            PatternType.ANT -> requests.antMatchers(rule.pattern).access(rule.rule)\n+                            PatternType.ANT -> requests.antMatchers(rule.httpMethod, rule.pattern).access(rule.rule)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDMxNTcxMg==", "url": "https://github.com/spring-projects/spring-security/pull/8350#discussion_r410315712", "bodyText": "I can do this, although I notice there is a discrepency between the docs for mvcMatchers() and antMatchers().\nThe documentation for antMatchers(HttpMethod httpMethod, String... antPatterns) says:\n\nmethod - the HttpMethod to use or null for any HttpMethod.\n\nAnd indeed, the non-HttpMethod version just calls the HttpMethod version with null.\nHowever, the documentation for mvcMatchers(HttpMethod method, String... mvcPatterns) does not contain the \"or null\" option for the method argument (maybe it should?):\n\nmethod - the HTTP method to match on\n\nAlthough, mvcMatchers(String... mvcPatterns) does internally use a protected method that documents the same behaviour.\nI think it's cleaner for them both to use the option to pass in null, as it is publicly documented behaviour and will remove the need for the conditional check here. But as it's not documented for mvcMatchers(), I'm hesitant. What do you think?\nI agree they should be unified, so happy to add the conditional check to antMatchers() too if you prefer that.", "author": "adamu", "createdAt": "2020-04-17T15:56:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI2NzM3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDMzMDQyMA==", "url": "https://github.com/spring-projects/spring-security/pull/8350#discussion_r410330420", "bodyText": "I pushed the version without the conditionals for now, so you can see what I mean.", "author": "adamu", "createdAt": "2020-04-17T16:20:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI2NzM3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY2NzAxMQ==", "url": "https://github.com/spring-projects/spring-security/pull/8350#discussion_r411667011", "bodyText": "Thanks that looks good to me.", "author": "eleftherias", "createdAt": "2020-04-20T20:23:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI2NzM3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY3MTkzNQ==", "url": "https://github.com/spring-projects/spring-security/pull/8350#discussion_r411671935", "bodyText": "I think we should keep the null check for servletPath.\nI can see that we have null checks in MvcRequestMatcher, but I consider this scenario to be different than the httpMethod.\nWe are never explicitly replacing an unset servletPath with null, as we did for httpMethod.", "author": "eleftherias", "createdAt": "2020-04-20T20:31:58Z", "path": "config/src/main/kotlin/org/springframework/security/config/web/servlet/AuthorizeRequestsDsl.kt", "diffHunk": "@@ -152,12 +200,10 @@ class AuthorizeRequestsDsl : AbstractRequestMatcherDsl() {\n                     is MatcherAuthorizationRule -> requests.requestMatchers(rule.matcher).access(rule.rule)\n                     is PatternAuthorizationRule -> {\n                         when (rule.patternType) {\n-                            PatternType.ANT -> requests.antMatchers(rule.pattern).access(rule.rule)\n-                            PatternType.MVC -> {\n-                                val mvcMatchersAuthorizeUrl = requests.mvcMatchers(rule.pattern)\n-                                rule.servletPath?.also { mvcMatchersAuthorizeUrl.servletPath(rule.servletPath) }\n-                                mvcMatchersAuthorizeUrl.access(rule.rule)\n-                            }\n+                            PatternType.ANT -> requests.antMatchers(rule.httpMethod, rule.pattern).access(rule.rule)\n+                            PatternType.MVC -> requests.mvcMatchers(rule.httpMethod, rule.pattern)\n+                                .servletPath(rule.servletPath)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYxNzE2Mw==", "url": "https://github.com/spring-projects/spring-security/pull/8350#discussion_r412617163", "bodyText": "I see. I removed it because:\n\nThe default value of servletPath on MvcRequestMatcher is null and the documentation for setServletPath() states \"The default is undefined which means any servlet path\". The use of the word \"undefined\" instead of null is a bit ambiguous, but this seems to be saying that null is equivalent to being unset, which means any servlet path.\nIn PatternAuthorizationRule, the default value is also null when unspecified. So we can take advantage of the above point to keep the code simpler here.\n\nWould you still like me to add the null check back?", "author": "adamu", "createdAt": "2020-04-22T02:11:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY3MTkzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYxOTM4MQ==", "url": "https://github.com/spring-projects/spring-security/pull/8350#discussion_r412619381", "bodyText": "I added it back, but I'm happy to take it out again if you prefer!", "author": "adamu", "createdAt": "2020-04-22T02:18:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY3MTkzNQ=="}], "type": "inlineReview"}, {"oid": "fa4b5ee253cd073511143de6c74a3e94a431e7be", "url": "https://github.com/spring-projects/spring-security/commit/fa4b5ee253cd073511143de6c74a3e94a431e7be", "message": "Extract pattern type in request matcher DSL", "committedDate": "2020-04-22T06:23:34Z", "type": "commit"}, {"oid": "a4b2c60176af52445799e14350fee9566d7c4383", "url": "https://github.com/spring-projects/spring-security/commit/a4b2c60176af52445799e14350fee9566d7c4383", "message": "Use named arguments in Kotlin authorization rule", "committedDate": "2020-04-22T06:23:34Z", "type": "commit"}, {"oid": "30e42c347ef4065bf8caa5802ffd23c6911f068e", "url": "https://github.com/spring-projects/spring-security/commit/30e42c347ef4065bf8caa5802ffd23c6911f068e", "message": "Add authorize() DSL method that accepts HttpMethod\n\nFixes: gh-8307", "committedDate": "2020-04-22T06:23:34Z", "type": "commit"}]}