{"pr_number": 6869, "pr_title": "[icloud] Fix JSON parsing and minor bugfixes", "pr_createdAt": "2020-01-19T00:01:15Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/6869", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI3NzMzNQ==", "url": "https://github.com/openhab/openhab-addons/pull/6869#discussion_r368277335", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR, \"Response = \" + json);\n          \n          \n            \n                            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR, \"iCloud response invalid: \" + e.getMessage());\n          \n      \n    \n    \n  \n\nAnd remove the logger. Thing status changes are logged anyway", "author": "J-N-K", "createdAt": "2020-01-19T09:03:48Z", "path": "bundles/org.openhab.binding.icloud/src/main/java/org/openhab/binding/icloud/internal/handler/ICloudAccountBridgeHandler.java", "diffHunk": "@@ -161,9 +162,9 @@ public void refreshData() {\n                 }\n \n                 logger.debug(\"iCloud bridge data refresh complete.\");\n-            } catch (NumberFormatException e) {\n-                logger.warn(\"iCloud returned an incorrect account status code : '{}'\",\n-                        iCloudData.getICloudAccountStatusCode());\n+            } catch (NumberFormatException | JsonSyntaxException e) {\n+                updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR, \"Response = \" + json);", "originalCommit": "e590a8898368dc01687d6d771f9b461aaeae7171", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "359c97a7dc9638240fbb15b1a0a96d8129467083", "url": "https://github.com/openhab/openhab-addons/commit/359c97a7dc9638240fbb15b1a0a96d8129467083", "message": "Fix iCloud JSON parsing\n\nSigned-off-by: Kristof Rado <rado.krisi@gmail.com>", "committedDate": "2020-01-19T14:54:57Z", "type": "commit"}, {"oid": "30242d449f25c382eda4927b01e28a9e6cc12767", "url": "https://github.com/openhab/openhab-addons/commit/30242d449f25c382eda4927b01e28a9e6cc12767", "message": "Added NonNullByDefault annotations\n\nSigned-off-by: Kristof Rado <rado.krisi@gmail.com>", "committedDate": "2020-01-19T14:54:57Z", "type": "commit"}, {"oid": "74257a214608306c0d28983861740b77674606f5", "url": "https://github.com/openhab/openhab-addons/commit/74257a214608306c0d28983861740b77674606f5", "message": "Removed logger\n\nSigned-off-by: Kristof Rado <rado.krisi@gmail.com>", "committedDate": "2020-01-19T14:54:58Z", "type": "commit"}, {"oid": "4c85c99d42c41b2b5ceabbdf84b5ffa5ec577984", "url": "https://github.com/openhab/openhab-addons/commit/4c85c99d42c41b2b5ceabbdf84b5ffa5ec577984", "message": "Update README.md\n\nSigned-off-by: Kristof Rado <rado.krisi@gmail.com>", "committedDate": "2020-01-19T14:54:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODMwMTkzNg==", "url": "https://github.com/openhab/openhab-addons/pull/6869#discussion_r368301936", "bodyText": "If there is a default, add it here (BTW: is it really needed that this is Integer instead of int?)\npublic Integer refreshTimeInMinutes = 5;\n\nelse annotate the with @Nullable:\npublic @Nullable String appleId;", "author": "J-N-K", "createdAt": "2020-01-19T15:23:59Z", "path": "bundles/org.openhab.binding.icloud/src/main/java/org/openhab/binding/icloud/internal/configuration/ICloudAccountThingConfiguration.java", "diffHunk": "@@ -12,12 +12,15 @@\n  */\n package org.openhab.binding.icloud.internal.configuration;\n \n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+\n /**\n  * Represents the configuration of an iCloud Account Thing.\n  *\n  * @author Patrik Gfeller - Initial Contribution\n  *\n  */\n+@NonNullByDefault\n public class ICloudAccountThingConfiguration {\n     public String appleId;", "originalCommit": "4c85c99d42c41b2b5ceabbdf84b5ffa5ec577984", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODMwMzA3NQ==", "url": "https://github.com/openhab/openhab-addons/pull/6869#discussion_r368303075", "bodyText": "I think it can be int. I will try to change it and see if the build will succeed.", "author": "radokristof", "createdAt": "2020-01-19T15:42:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODMwMTkzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODMwMjEyMg==", "url": "https://github.com/openhab/openhab-addons/pull/6869#discussion_r368302122", "bodyText": "I think adding @NonNullByDefault to DTO classes is not necessary and avoids your problems.", "author": "J-N-K", "createdAt": "2020-01-19T15:27:09Z", "path": "bundles/org.openhab.binding.icloud/src/main/java/org/openhab/binding/icloud/internal/json/response/ICloudAccountDataResponse.java", "diffHunk": "@@ -15,13 +15,15 @@\n import java.util.List;\n \n import com.google.gson.annotations.SerializedName;\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n \n /**\n  * Serializable class to parse the device information json response\n  * received from the Apple server.\n  *\n  * @author Patrik Gfeller - Initial Contribution\n  */\n+@NonNullByDefault", "originalCommit": "4c85c99d42c41b2b5ceabbdf84b5ffa5ec577984", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODMwMzAxNw==", "url": "https://github.com/openhab/openhab-addons/pull/6869#discussion_r368303017", "bodyText": "Ok I will remove these. I just added from the Travis warnings, didn't checked that it might be needed or not :)", "author": "radokristof", "createdAt": "2020-01-19T15:42:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODMwMjEyMg=="}], "type": "inlineReview"}, {"oid": "bbdbbe70be94907be7595f0a90fe2d2d030b1867", "url": "https://github.com/openhab/openhab-addons/commit/bbdbbe70be94907be7595f0a90fe2d2d030b1867", "message": "Fixed NonNull annotations\n\nSigned-off-by: Kristof Rado <rado.krisi@gmail.com>", "committedDate": "2020-01-19T15:47:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODMwMzcwMg==", "url": "https://github.com/openhab/openhab-addons/pull/6869#discussion_r368303702", "bodyText": "That won\u2018t work. Either provide a default and use int or @nullable and Integer.", "author": "J-N-K", "createdAt": "2020-01-19T15:51:11Z", "path": "bundles/org.openhab.binding.icloud/src/main/java/org/openhab/binding/icloud/internal/configuration/ICloudAccountThingConfiguration.java", "diffHunk": "@@ -22,7 +23,7 @@\n  */\n @NonNullByDefault\n public class ICloudAccountThingConfiguration {\n-    public String appleId;\n-    public String password;\n-    public Integer refreshTimeInMinutes;\n+    public @Nullable String appleId;\n+    public @Nullable String password;\n+    public @Nullable int refreshTimeInMinutes;", "originalCommit": "eebf04c832b8f185e9b7ac718970a6c55c0dd801", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODMwNDQ5Mg==", "url": "https://github.com/openhab/openhab-addons/pull/6869#discussion_r368304492", "bodyText": "I stayed with int and provided a default value.", "author": "radokristof", "createdAt": "2020-01-19T16:03:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODMwMzcwMg=="}], "type": "inlineReview"}, {"oid": "d1450b8319ddeece4b6aabe6fde2839e5af1f448", "url": "https://github.com/openhab/openhab-addons/commit/d1450b8319ddeece4b6aabe6fde2839e5af1f448", "message": "Fix annotation errors\n\nSigned-off-by: Kristof Rado <rado.krisi@gmail.com>", "committedDate": "2020-01-19T16:04:01Z", "type": "commit"}, {"oid": "9918814e5c10c76ba2edce1b63491718994e7a4a", "url": "https://github.com/openhab/openhab-addons/commit/9918814e5c10c76ba2edce1b63491718994e7a4a", "message": "Fixed NonNull annotations\n\nSigned-off-by: Kristof Rado <rado.krisi@gmail.com>", "committedDate": "2020-01-19T18:16:25Z", "type": "commit"}, {"oid": "4a7df7d6f8eff15e2fb96ac9963b7c7cc9dcc8a7", "url": "https://github.com/openhab/openhab-addons/commit/4a7df7d6f8eff15e2fb96ac9963b7c7cc9dcc8a7", "message": "More annotation fix\n\nSigned-off-by: Kristof Rado <rado.krisi@gmail.com>", "committedDate": "2020-01-19T18:16:25Z", "type": "commit"}, {"oid": "3aa5e97e1dca16d21d73e3cb84f0c55a20342360", "url": "https://github.com/openhab/openhab-addons/commit/3aa5e97e1dca16d21d73e3cb84f0c55a20342360", "message": "More annotation fix\n\nSigned-off-by: Kristof Rado <rado.krisi@gmail.com>", "committedDate": "2020-01-19T18:17:34Z", "type": "commit"}, {"oid": "73895a7c2a5e945da21afb376e1c5cc5d3eed5b2", "url": "https://github.com/openhab/openhab-addons/commit/73895a7c2a5e945da21afb376e1c5cc5d3eed5b2", "message": "Fix Travis build\n\nSigned-off-by: Kristof Rado <rado.krisi@gmail.com>", "committedDate": "2020-01-19T18:17:40Z", "type": "commit"}, {"oid": "7bdc612c1f9e80f57c8c93a038a627f9d03d730a", "url": "https://github.com/openhab/openhab-addons/commit/7bdc612c1f9e80f57c8c93a038a627f9d03d730a", "message": "spotless apply\n\nSigned-off-by: Kristof Rado <rado.krisi@gmail.com>", "committedDate": "2020-01-19T18:25:20Z", "type": "commit"}, {"oid": "e6b20b1c0718348069ea6b2f2e44029500f5f136", "url": "https://github.com/openhab/openhab-addons/commit/e6b20b1c0718348069ea6b2f2e44029500f5f136", "message": "Missing commit\n\nSigned-off-by: Kristof Rado <rado.krisi@gmail.com>", "committedDate": "2020-01-19T19:16:36Z", "type": "commit"}, {"oid": "2b46068bc8a3277c52abd9a4885ca5e428d646f0", "url": "https://github.com/openhab/openhab-addons/commit/2b46068bc8a3277c52abd9a4885ca5e428d646f0", "message": "Update fmipmobile cert\n\nSigned-off-by: Kristof Rado <rado.krisi@gmail.com>", "committedDate": "2020-01-21T11:52:22Z", "type": "commit"}, {"oid": "feb7bad14757d5a0a17e29ca7f5e55e11b3791d6", "url": "https://github.com/openhab/openhab-addons/commit/feb7bad14757d5a0a17e29ca7f5e55e11b3791d6", "message": "Fix feature line format\n\nSigned-off-by: Kristof Rado <rado.krisi@gmail.com>", "committedDate": "2020-01-22T18:25:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTczMTg1Mw==", "url": "https://github.com/openhab/openhab-addons/pull/6869#discussion_r369731853", "bodyText": "It doesn't make sense to provide any of these as null, right? You should make a null-check before instantiating ICloudConnection (found it in startHandler, if any of the required credentials is null, set the thing to OFFLINE/CONFIGURATION_ERROR with a message stating what is wrong)", "author": "J-N-K", "createdAt": "2020-01-22T18:35:20Z", "path": "bundles/org.openhab.binding.icloud/src/main/java/org/openhab/binding/icloud/internal/ICloudConnection.java", "diffHunk": "@@ -50,7 +53,7 @@\n     private final String iCloudDataRequestURL;\n     private final String iCloudFindMyDeviceURL;\n \n-    public ICloudConnection(String appleId, String password) throws URISyntaxException {\n+    public ICloudConnection(@Nullable String appleId, @Nullable String password) throws URISyntaxException {", "originalCommit": "feb7bad14757d5a0a17e29ca7f5e55e11b3791d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc0NDQ0Mw==", "url": "https://github.com/openhab/openhab-addons/pull/6869#discussion_r369744443", "bodyText": "Yes this makes sense. However if I add a null check for these parameters where this function is called, then this Nullable annotation can be removed right?\nWill the tests succeeds even if there is a NonNullByDefault annotation? So these tests are non-static tests right?", "author": "radokristof", "createdAt": "2020-01-22T19:00:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTczMTg1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc0NTE1Nw==", "url": "https://github.com/openhab/openhab-addons/pull/6869#discussion_r369745157", "bodyText": "Exactly, the @Nullable should be removed then. If the tests fail then, there is a bug.", "author": "J-N-K", "createdAt": "2020-01-22T19:02:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTczMTg1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTczMjU0MA==", "url": "https://github.com/openhab/openhab-addons/pull/6869#discussion_r369732540", "bodyText": "same here. calling findMyDevice with a id == null doesn't make sense.", "author": "J-N-K", "createdAt": "2020-01-22T18:36:43Z", "path": "bundles/org.openhab.binding.icloud/src/main/java/org/openhab/binding/icloud/internal/ICloudConnection.java", "diffHunk": "@@ -61,7 +64,7 @@ public ICloudConnection(String appleId, String password) throws URISyntaxExcepti\n      *\n      * @throws IOException\n      */\n-    public void findMyDevice(String id) throws IOException {\n+    public void findMyDevice(@Nullable String id) throws IOException {", "originalCommit": "feb7bad14757d5a0a17e29ca7f5e55e11b3791d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTczNTM2OA==", "url": "https://github.com/openhab/openhab-addons/pull/6869#discussion_r369735368", "bodyText": "see above. if deviceId is null, it doesn't make sense to call findmydevice", "author": "J-N-K", "createdAt": "2020-01-22T18:42:19Z", "path": "bundles/org.openhab.binding.icloud/src/main/java/org/openhab/binding/icloud/internal/handler/ICloudAccountBridgeHandler.java", "diffHunk": "@@ -110,7 +117,7 @@ public void dispose() {\n         super.dispose();\n     }\n \n-    public void findMyDevice(String deviceId) throws IOException {\n+    public void findMyDevice(@Nullable String deviceId) throws IOException {", "originalCommit": "feb7bad14757d5a0a17e29ca7f5e55e11b3791d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTczNTc3OA==", "url": "https://github.com/openhab/openhab-addons/pull/6869#discussion_r369735778", "bodyText": "since connection is @Nullable, please add a null-check here", "author": "J-N-K", "createdAt": "2020-01-22T18:43:11Z", "path": "bundles/org.openhab.binding.icloud/src/main/java/org/openhab/binding/icloud/internal/handler/ICloudAccountBridgeHandler.java", "diffHunk": "@@ -110,7 +117,7 @@ public void dispose() {\n         super.dispose();\n     }\n \n-    public void findMyDevice(String deviceId) throws IOException {\n+    public void findMyDevice(@Nullable String deviceId) throws IOException {\n         connection.findMyDevice(deviceId);", "originalCommit": "feb7bad14757d5a0a17e29ca7f5e55e11b3791d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTczNzEzNg==", "url": "https://github.com/openhab/openhab-addons/pull/6869#discussion_r369737136", "bodyText": "see above.", "author": "J-N-K", "createdAt": "2020-01-22T18:45:59Z", "path": "bundles/org.openhab.binding.icloud/src/main/java/org/openhab/binding/icloud/internal/json/request/ICloudFindMyDeviceRequest.java", "diffHunk": "@@ -14,19 +14,24 @@\n \n import static org.openhab.binding.icloud.internal.ICloudBindingConstants.FIND_MY_DEVICE_REQUEST_SUBJECT;\n \n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+\n import com.google.gson.annotations.SerializedName;\n \n /**\n  * Serializable class to create a \"Find My Device\" json request string.\n  *\n  * @author Patrik Gfeller - Initial Contribution\n  */\n+@NonNullByDefault\n public class ICloudFindMyDeviceRequest {\n     @SerializedName(\"device\")\n+    @Nullable\n     String deviceId;\n     final String subject = FIND_MY_DEVICE_REQUEST_SUBJECT;\n \n-    public ICloudFindMyDeviceRequest(String id) {\n+    public ICloudFindMyDeviceRequest(@Nullable String id) {", "originalCommit": "feb7bad14757d5a0a17e29ca7f5e55e11b3791d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTczNzgwNA==", "url": "https://github.com/openhab/openhab-addons/pull/6869#discussion_r369737804", "bodyText": "not sure here (didn't check the whole code): is there any useful case where key == null is possible? if not, check for null where this is instantiated.", "author": "J-N-K", "createdAt": "2020-01-22T18:47:28Z", "path": "bundles/org.openhab.binding.icloud/src/main/java/org/openhab/binding/icloud/internal/utilities/ICloudTextTranslator.java", "diffHunk": "@@ -35,12 +36,12 @@ public ICloudTextTranslator(Bundle bundle, TranslationProvider i18nProvider, Loc\n         this.localeProvider = localeProvider;\n     }\n \n-    public String getText(String key, Object... arguments) {\n+    public String getText(@Nullable String key, Object... arguments) {", "originalCommit": "feb7bad14757d5a0a17e29ca7f5e55e11b3791d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "254c357d3b05297b048a6bdbbbafa3f5889c3187", "url": "https://github.com/openhab/openhab-addons/commit/254c357d3b05297b048a6bdbbbafa3f5889c3187", "message": "Changes based on review\n\nSigned-off-by: Kristof Rado <rado.krisi@gmail.com>", "committedDate": "2020-01-22T19:21:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc3NDA0OQ==", "url": "https://github.com/openhab/openhab-addons/pull/6869#discussion_r369774049", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if(config.appleId != null || config.password != null) {\n          \n          \n            \n                        final String appleId = config.appleId;\n          \n          \n            \n                        final String password = config.password;\n          \n          \n            \n                        if(appleId != null || password != null) {\n          \n          \n            \n                            connection = new ICloudConnection(appleId, password);", "author": "J-N-K", "createdAt": "2020-01-22T20:01:07Z", "path": "bundles/org.openhab.binding.icloud/src/main/java/org/openhab/binding/icloud/internal/handler/ICloudAccountBridgeHandler.java", "diffHunk": "@@ -125,10 +135,14 @@ public void unregisterListener(ICloudDeviceInformationListener listener) {\n     private void startHandler() {\n         try {\n             logger.debug(\"iCloud bridge starting handler ...\");\n-            config = getConfigAs(ICloudAccountThingConfiguration.class);\n-\n-            connection = new ICloudConnection(config.appleId, config.password);\n-\n+            ICloudAccountThingConfiguration config = getConfigAs(ICloudAccountThingConfiguration.class);\n+            if(config.appleId != null || config.password != null) {", "originalCommit": "254c357d3b05297b048a6bdbbbafa3f5889c3187", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc3NDc4OA==", "url": "https://github.com/openhab/openhab-addons/pull/6869#discussion_r369774788", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                if(deviceId == null) {\n          \n          \n            \n                                final String deviceId = this.deviceId;\n          \n          \n            \n                                if (deviceId == null) {", "author": "J-N-K", "createdAt": "2020-01-22T20:02:49Z", "path": "bundles/org.openhab.binding.icloud/src/main/java/org/openhab/binding/icloud/internal/handler/ICloudDeviceHandler.java", "diffHunk": "@@ -127,6 +127,10 @@ public void handleCommand(ChannelUID channelUID, Command command) {\n         if (channelId.equals(FIND_MY_PHONE)) {\n             if (command == OnOffType.ON) {\n                 try {\n+                    if(deviceId == null) {", "originalCommit": "254c357d3b05297b048a6bdbbbafa3f5889c3187", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "61e57347bad1b79a943f8702fbfb9d03b013683b", "url": "https://github.com/openhab/openhab-addons/commit/61e57347bad1b79a943f8702fbfb9d03b013683b", "message": "Fix Travis tests\n\nSigned-off-by: Kristof Rado <rado.krisi@gmail.com>", "committedDate": "2020-01-22T20:38:36Z", "type": "commit"}]}