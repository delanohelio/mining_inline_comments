{"pr_number": 7496, "pr_title": "[weathercompany] Fix things file example", "pr_createdAt": "2020-04-28T11:30:38Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/7496", "timeline": [{"oid": "666bfe53fa806c3c51ca1fbb11c6c71c9df582f5", "url": "https://github.com/openhab/openhab-addons/commit/666bfe53fa806c3c51ca1fbb11c6c71c9df582f5", "message": "Fix things file example\n\nSigned-off-by: Mark Hilbush <mark@hilbush.com>", "committedDate": "2020-04-28T11:27:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI4NzU1MQ==", "url": "https://github.com/openhab/openhab-addons/pull/7496#discussion_r423287551", "bodyText": "I do not understand the idea behind this. Yes, the syntax is valid but imo the following is easier to understand:\nBridge weathercompany:account:bridge [ apiKey=\"0123456789\" ]\n    Thing weather-forecast forecast \"Local Forecast\" @ \"Home\" [locationType=\"postalCode\",postalCode=\"10001:US\",language=\"en-US\",refreshInterval=30]\t\n    ....\n}", "author": "cweitkamp", "createdAt": "2020-05-11T20:05:32Z", "path": "bundles/org.openhab.binding.weathercompany/README.md", "diffHunk": "@@ -146,13 +146,14 @@ The following channels will be translated to local language based on the languag\n ### Thing Example\n \n ```\n-Bridge weathercompany:account:bridge [ apiKey=\"734982347982374\" ] {\n-    Thing weathercompany:weather-forecast:forecast \"Local Forecast\" @ \"Home\" [locationType=\"postalCode\",postalCode=\"10001:US\",language=\"en-US\",refreshInterval=30]\n-    Thing weathercompany:weather-forecast:chitown \"Chicago Forecast\" @ \"Ohare Airport\" [apiKey=\"734982347982374\",locationType=\"iataCode\",iataCode=\"ORD\",language=\"en-US\",refreshInterval=30]\n-    Thing weathercompany:weather-forecast:miami \"Miami Weather\" @ \"South Beach\" [locationType=\"postalCode\",postalCode=\"33139:US\",language=\"es-US\",refreshInterval=30]\n-    Thing weathercompany:weather-observations:observations \"Local Observations\" @ \"Home\" [pwsStationId=\"KFLMIAMI208\",refreshInterval=30]\n-    Thing weathercompany:weather-observations:patagonia \"Torres del Paine Weather\" @ \"Patagonia\" [pwsStationId=\"IPUNTAAR4\",refreshInterval=30]\n-}\n+Bridge weathercompany:account:bridge [ apiKey=\"0123456789\" ]\n+\n+Thing weathercompany:weather-forecast:forecast \"Local Forecast\" (weathercompany:account:bridge) @ \"Home\" [locationType=\"postalCode\",postalCode=\"10001:US\",language=\"en-US\",refreshInterval=30]", "originalCommit": "666bfe53fa806c3c51ca1fbb11c6c71c9df582f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI5ODgyNg==", "url": "https://github.com/openhab/openhab-addons/pull/7496#discussion_r423298826", "bodyText": "Yes, that's true. However, the items example won't work with the things example because of how the Thing UID is formed when using the Bridge { Thing } approach.\nBy doing it this way, the items example will work whether you add the things using Paper UI, as well as with a .things file. It's the only way I could figure out how to make it work both ways.\nAnd, it is supported by the openHAB documentation.", "author": "mhilbush", "createdAt": "2020-05-11T20:27:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI4NzU1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMwMDk5Nw==", "url": "https://github.com/openhab/openhab-addons/pull/7496#discussion_r423300997", "bodyText": "I should add that it's not a dealbreaker for me if you want to keep it using the Bridge { Thing } approach. I was just trying to make it easy for users who use Paper UI and .things files.", "author": "mhilbush", "createdAt": "2020-05-11T20:30:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI4NzU1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM4MzAwNg==", "url": "https://github.com/openhab/openhab-addons/pull/7496#discussion_r425383006", "bodyText": "The fact I am worried about at most is that you want to use a ThingUID without the bridge ID as third segment.\nIs that a nasty bug of Paper UI when adding discovered Things having a Bridge? Or is this a more general problem of the discovery / inbox features? Do you have a clue?\nMaybe is will be fixed if you add it in the bindings discovery service (see e.g. DarkSky):\n\n  \n    \n      openhab-addons/bundles/org.openhab.binding.weathercompany/src/main/java/org/openhab/binding/weathercompany/internal/discovery/WeatherCompanyDiscoveryService.java\n    \n    \n        Lines 120 to 121\n      in\n      666bfe5\n    \n    \n    \n    \n\n        \n          \n           ThingUID localWeatherThing = new ThingUID(THING_TYPE_WEATHER_FORECAST, LOCAL); \n        \n\n        \n          \n           thingDiscovered(DiscoveryResultBuilder.create(localWeatherThing).withBridge(bridgeHandler.getThing().getUID()) \n        \n    \n  \n\n\nChange it to:\n        ThingUID bridgeUID = bridgeHandler.getThing().getUID();\n        ThingUID localWeatherThing = new ThingUID(THING_TYPE_WEATHER_FORECAST, bridgeUID, LOCAL);\n        thingDiscovered(DiscoveryResultBuilder.create(localWeatherThing).withBridge(bridgeUID)", "author": "cweitkamp", "createdAt": "2020-05-14T19:35:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI4NzU1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM5MDQ4MQ==", "url": "https://github.com/openhab/openhab-addons/pull/7496#discussion_r425390481", "bodyText": "It's completely unrelated to discovery. It happens when I add a thing manually using Paper UI.\nSo, for example, if I add a WeatherCompany thing manually using Paper UI (in the UI I I gave it a Thing ID of test and selected an existing Bridge Thing), it creates a thing whose Thing UID is weathercompany:weather-forecast:test.\nAlso, I'm not sure I see any functional difference between the existing code, and your suggested change. In both cases, withBridge is being called with the BridgeUID.", "author": "mhilbush", "createdAt": "2020-05-14T19:49:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI4NzU1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQwODI5Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7496#discussion_r425408296", "bodyText": "From my POV that's wrong. When creating a Thing related to a Bridge the resulting ThingUID should contain the Bridge Id.\nThingUID w/o Bridge:\n<bindingId>.<thingTypeId>.<thingId>\n\nThingUID with Bridge:\n<bindingId>.<thingTypeId>.<bridgeId>.<thingId>\n\nMy suggested change adds the Bridge Id to the ThingUID:\n        ThingUID localWeatherThing = new ThingUID(THING_TYPE_WEATHER_FORECAST, bridgeUID, LOCAL);", "author": "cweitkamp", "createdAt": "2020-05-14T20:23:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI4NzU1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQyMDA3NQ==", "url": "https://github.com/openhab/openhab-addons/pull/7496#discussion_r425420075", "bodyText": "Ah, I see what's different in your suggested change.\nI'm happy to make that change in the binding, but I don't see how that changes what Paper UI does when you manually add a thing. The binding discovery code never gets executed in that case, because Paper UI does all the thing creation using the REST API. Right?", "author": "mhilbush", "createdAt": "2020-05-14T20:46:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI4NzU1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQyNTgyMQ==", "url": "https://github.com/openhab/openhab-addons/pull/7496#discussion_r425425821", "bodyText": "Unfortunately, yes. Adding such Things manually via Paper UI results in wrong ThingUIDs. IMO we should not care much about Paper UI anymore. Hopefully the new UI does it better.\nI'd like to have @kaikreuzer opinion on this. Should we force ThingUIDs containing a Bridge Id or not?", "author": "cweitkamp", "createdAt": "2020-05-14T20:57:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI4NzU1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQzNDY4MA==", "url": "https://github.com/openhab/openhab-addons/pull/7496#discussion_r425434680", "bodyText": "Makes sense. I'll do whatever you guys want. It's just that the current documentation is wrong, and I'm anxious to get it fixed one way or the other.", "author": "mhilbush", "createdAt": "2020-05-14T21:14:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI4NzU1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTczNjYwMQ==", "url": "https://github.com/openhab/openhab-addons/pull/7496#discussion_r425736601", "bodyText": "I can understand @cweitkamp's confusion here, because my assumption was as well that the bridgeId(s) is/are always a mandatory part of the ThingUID.\nThe ThingUID class has the (not deprecated) method getBridgeIds, so this also hints at the fact that it is expected to contain those.\nTechnically, it is right that the Paper UI does not require to include the bridge id(s) in the ThingUID, but I agree that it should better do so.\nSo the question goes to @ghys here: Does the new UI create Things that have their bridgeID as part of the newly created Thing? If not, it would be lovely if it could be changed that way :-).", "author": "kaikreuzer", "createdAt": "2020-05-15T11:23:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI4NzU1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTc0MjY1Mg==", "url": "https://github.com/openhab/openhab-addons/pull/7496#discussion_r425742652", "bodyText": "Thanks for the explanation @kaikreuzer.\nIf it's a requirement that the ThingUID contain the Bridge Id, then shouldn't the framework enforce that requirement. But then, what would happen if the Bridge thing is deleted? Wouldn't the remaining things ThingUIDs contain a bridge Id that no longer exists? Or, does the framework currently not allow you to delete a Bridge Thing if there are Things that reference it?\nIrrespective of the above, I'll change my PR so that the ThingUIDs contain the Bridge Id.", "author": "mhilbush", "createdAt": "2020-05-15T11:36:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI4NzU1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTc1NDU1Mg==", "url": "https://github.com/openhab/openhab-addons/pull/7496#discussion_r425754552", "bodyText": "Things where the bridge is deleted are still defined, but will stay UNINITIALIZED. Once a bridge turns up, everything is fine.", "author": "kaikreuzer", "createdAt": "2020-05-15T12:02:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI4NzU1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTc1NjIyMw==", "url": "https://github.com/openhab/openhab-addons/pull/7496#discussion_r425756223", "bodyText": "So the question goes to @ghys here: Does the new UI create Things that have their bridgeID as part of the newly created Thing?\n\nNo it does not, I didn't know about that convention. The problem is, the user can delay assigning the bridge until after creating the thing, it's not mandatory to specify it at creation time, and it can even be updated later (and you can even switch a Thing from one bridge to another, not a common scenario, I'll grant you that, but I have actually done it once or twice to switch MQTT things from one broker to another). Note that Paper UI allowed that too IIRC.", "author": "ghys", "createdAt": "2020-05-15T12:06:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI4NzU1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTc1ODgxMw==", "url": "https://github.com/openhab/openhab-addons/pull/7496#discussion_r425758813", "bodyText": "Things where the bridge is deleted are still defined, but will stay UNINITIALIZED. Once a bridge turns up, everything is fine.\n\nI understand that. And, maybe I'm missing something. But, after a new bridge is created, there's no guarantee that the thing's ThingUID will contain the bridge Id of the new bridge it now references. The thing's ThingUID will contain the Bridge Id of the bridge that was deleted, which may or may not be the Bridge Id of the bridge it now references.", "author": "mhilbush", "createdAt": "2020-05-15T12:11:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI4NzU1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTc1OTM2Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7496#discussion_r425759366", "bodyText": "Yes, I think @ghys is saying what I was trying to say, albeit, I think he said it more clearly.", "author": "mhilbush", "createdAt": "2020-05-15T12:13:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI4NzU1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTc1OTU0Mg==", "url": "https://github.com/openhab/openhab-addons/pull/7496#discussion_r425759542", "bodyText": "That's a good argument, @ghys. The ThingUID should not be touched if the user reassigns it to another bridge. So we would have to stick to the same convention as we do for the thing type uid within the ThingUID: It is recommended to use it (especially when textually defining a thing), but there must not be any semantics being assumed within a ThingUID.", "author": "kaikreuzer", "createdAt": "2020-05-15T12:13:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI4NzU1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTc2MDU3Nw==", "url": "https://github.com/openhab/openhab-addons/pull/7496#discussion_r425760577", "bodyText": "To cut the discussion short: As we are talking about the textual configuration here, I very much support @cweitkamp's few that it should be done with the nested syntax, because this way openHAB will automatically make sure that the things reference the correct bridge and no typos can be in the way.", "author": "kaikreuzer", "createdAt": "2020-05-15T12:15:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI4NzU1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTc2OTk5OA==", "url": "https://github.com/openhab/openhab-addons/pull/7496#discussion_r425769998", "bodyText": "FYI I'm now noticing that for instance, the Hue binding seems to assign UIDs containing the bridge UID and a device ID, both of which can be changed:", "author": "ghys", "createdAt": "2020-05-15T12:34:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI4NzU1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk3NzU0MQ==", "url": "https://github.com/openhab/openhab-addons/pull/7496#discussion_r425977541", "bodyText": "Thank you all for wrapping this up and clarify on the topic.\n\nbut there must not be any semantics being assumed within a ThingUID.\n\nI think we can and should make one exception: automatic discovery. This is a framework feature and in this case the framework can and  should force the recommended semantic. Thus I propose to add a small check in the DiscoveryResultBuilder#withBridge() to validate on related BridgeUID and ThingUIDs.", "author": "cweitkamp", "createdAt": "2020-05-15T18:31:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI4NzU1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAwNTYyMg==", "url": "https://github.com/openhab/openhab-addons/pull/7496#discussion_r426005622", "bodyText": "Yes, what I meant was: Naming convention to define ThingUIDs (e.g. textually or by discovery) exactly this way (using thing type and bridge ids as segments), while nowhere in the code to expect being able to read any semantics out of a ThingID (because the user might have changed the bridge or the binding migrated the thing type to a different one or whatever might have been happened).", "author": "kaikreuzer", "createdAt": "2020-05-15T19:29:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI4NzU1MQ=="}], "type": "inlineReview"}, {"oid": "aa96cf161618ce01c8f3023326a4fdaadd538fe1", "url": "https://github.com/openhab/openhab-addons/commit/aa96cf161618ce01c8f3023326a4fdaadd538fe1", "message": "Rework example and fix discovery\n\nSigned-off-by: Mark Hilbush <mark@hilbush.com>", "committedDate": "2020-05-15T12:42:20Z", "type": "commit"}]}