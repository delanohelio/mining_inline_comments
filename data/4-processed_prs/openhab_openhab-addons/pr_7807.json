{"pr_number": 7807, "pr_title": "[netatmo] Add support for Presence camera events (#3059)", "pr_createdAt": "2020-05-27T18:18:30Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/7807", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk3MjQ3Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r433972476", "bodyText": "Maybe triggerEventChannels() and updateDataChannels() would be clearer ?", "author": "clinique", "createdAt": "2020-06-02T15:39:39Z", "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/handler/AbstractNetatmoThingHandler.java", "diffHunk": "@@ -137,16 +132,39 @@ protected State getNAThingProperty(String channelId) {\n     }\n \n     protected void updateChannels() {\n-        getThing().getChannels().stream().filter(channel -> channel.getKind() != ChannelKind.TRIGGER)\n+        updateNonTriggerChannels();\n+\n+        triggerTriggerChannels();", "originalCommit": "c305f68e3b7efa09a041447498d98e5ef83ca2ca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDExOTY0Mg==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r434119642", "bodyText": "ok, good suggestion\ndone", "author": "Novanic", "createdAt": "2020-06-02T19:16:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk3MjQ3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk3NDAyMg==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r433974022", "bodyText": "Usually @nullable is put on the same line than the property declaration :\nprivate @Nullable NAWelcomeEvent lastEvent;", "author": "clinique", "createdAt": "2020-06-02T15:41:35Z", "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java", "diffHunk": "@@ -29,36 +30,36 @@\n import org.eclipse.smarthome.io.net.http.HttpUtil;\n import org.openhab.binding.netatmo.internal.handler.AbstractNetatmoThingHandler;\n import org.openhab.binding.netatmo.internal.handler.NetatmoDeviceHandler;\n+import org.openhab.binding.netatmo.internal.webhook.NAWebhookCameraEvent;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import io.swagger.client.model.NAWelcomeEvent;\n-import io.swagger.client.model.NAWelcomeHome;\n-import io.swagger.client.model.NAWelcomeHomeData;\n-import io.swagger.client.model.NAWelcomeSnapshot;\n-\n /**\n  * {@link NAWelcomeHomeHandler} is the class used to handle the Welcome Home Data\n  *\n  * @author Ga\u00ebl L'hopital - Initial contribution\n  * @author Ing. Peter Weiss - Welcome camera implementation\n  *\n  */\n+@NonNullByDefault\n public class NAWelcomeHomeHandler extends NetatmoDeviceHandler<NAWelcomeHome> {\n-    private Logger logger = LoggerFactory.getLogger(NAWelcomeHomeHandler.class);\n+    private static final Logger logger = LoggerFactory.getLogger(NAWelcomeHomeHandler.class);\n \n     private int iPersons = -1;\n     private int iUnknowns = -1;\n+    @Nullable", "originalCommit": "c305f68e3b7efa09a041447498d98e5ef83ca2ca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDExOTU1Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r434119556", "bodyText": "ok, done", "author": "Novanic", "createdAt": "2020-06-02T19:16:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk3NDAyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE4ODUzOA==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436188538", "bodyText": "Based on the logic that calls this method, this parameter shouldn't be nullable.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static @Nullable NAWelcomeSubEvent findFirstSubEvent(@Nullable NAWelcomeEvent event) {\n          \n          \n            \n                private static @Nullable NAWelcomeSubEvent findFirstSubEvent(NAWelcomeEvent event) {", "author": "cpmeister", "createdAt": "2020-06-05T22:15:43Z", "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java", "diffHunk": "@@ -159,34 +159,111 @@ protected State getNAThingProperty(String channelId) {\n                 return lastEvent != null ? lastEvent.getIsArrival() != null ? OnOffType.ON : OnOffType.OFF\n                         : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_EVENT_MESSAGE:\n-                return lastEvent != null && lastEvent.getMessage() != null\n-                        ? new StringType(lastEvent.getMessage().replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n+                @Nullable String eventMessage = findEventMessage();\n+                return eventMessage != null\n+                        ? new StringType(eventMessage.replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n                         : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_EVENT_SUBTYPE:\n                 return lastEvent != null ? toDecimalType(lastEvent.getSubType()) : UnDefType.UNDEF;\n         }\n         return super.getNAThingProperty(channelId);\n     }\n \n+    @Override\n+    protected void triggerChannelIfRequired(String channelId) {\n+        if(isNewLastEvent) {\n+            if(CHANNEL_CAMERA_EVENT.equals(channelId)) {\n+                Set<String> detectedObjectTypes = findDetectedObjectTypes(lastEvent);\n+                for(String detectedType: detectedObjectTypes) {\n+                    triggerChannel(channelId, detectedType);\n+                }\n+            }\n+        }\n+        super.triggerChannelIfRequired(channelId);\n+    }\n+\n+    private static Set<String> findDetectedObjectTypes(@Nullable NAWelcomeEvent event) {\n+        Set<String> detectedObjectTypes = new TreeSet<>();\n+        if(event == null) {\n+            return detectedObjectTypes;\n+        }\n+\n+        if(event.getPersonId() != null) {\n+            detectedObjectTypes.add(CAMERA_EVENT_OPTION_HUMAN_DETECTED);\n+        }\n+\n+        if(NAWebhookCameraEvent.EventTypeEnum.MOVEMENT.toString().equals(event.getType())) {\n+            detectedObjectTypes.add(CAMERA_EVENT_OPTION_MOVEMENT_DETECTED);\n+        }\n+\n+        List<NAWelcomeSubEvent> subEvents = event.getEventList();\n+        for(NAWelcomeSubEvent subEvent: subEvents) {\n+            String detectedObjectType = translateDetectedObjectType(subEvent.getType());\n+            detectedObjectTypes.add(detectedObjectType);\n+        }\n+        return detectedObjectTypes;\n+    }\n+\n+    private static String translateDetectedObjectType(NAWelcomeSubEvent.TypeEnum type) {\n+        switch (type) {\n+            case HUMAN: return CAMERA_EVENT_OPTION_HUMAN_DETECTED;\n+            case ANIMAL: return CAMERA_EVENT_OPTION_ANIMAL_DETECTED;\n+            case VEHICLE: return CAMERA_EVENT_OPTION_VEHICLE_DETECTED;\n+            default: throw new IllegalArgumentException(\"Unknown detected object type!\");\n+        }\n+    }\n+\n+    private @Nullable String findEventMessage() {\n+        if(lastEvent != null) {\n+            @Nullable String message = lastEvent.getMessage();\n+            if(message == null) {\n+                @Nullable NAWelcomeSubEvent firstSubEvent = findFirstSubEvent(lastEvent);\n+                if(firstSubEvent != null) {\n+                    message = firstSubEvent.getMessage();\n+                }\n+            }\n+            return message;\n+        }\n+        return null;\n+    }\n+\n     /**\n      * Returns the Url of the picture\n      *\n      * @return Url of the picture or null\n      */\n-    protected String getSnapshotURL(NAWelcomeSnapshot snapshot) {\n-        String result = null;\n-\n-        if (snapshot != null && snapshot.getId() != null && snapshot.getKey() != null) {\n-            result = WELCOME_PICTURE_URL + \"?\" + WELCOME_PICTURE_IMAGEID + \"=\" + snapshot.getId() + \"&\"\n-                    + WELCOME_PICTURE_KEY + \"=\" + snapshot.getKey();\n-        } else {\n-            logger.debug(\"Unable to build snapshot url for Home : {}\", getId());\n+    protected @Nullable String findSnapshotURL() {\n+        if(lastEvent != null) {\n+            NAWelcomeSnapshot snapshot = lastEvent.getSnapshot();\n+            if (snapshot == null) {\n+                @Nullable NAWelcomeSubEvent firstSubEvent = findFirstSubEvent(lastEvent);\n+                if (firstSubEvent != null) {\n+                    snapshot = firstSubEvent.getSnapshot();\n+                }\n+            }\n+\n+            if (snapshot != null && snapshot.getId() != null && snapshot.getKey() != null) {\n+                return WELCOME_PICTURE_URL + \"?\" + WELCOME_PICTURE_IMAGEID + \"=\" + snapshot.getId() + \"&\"\n+                        + WELCOME_PICTURE_KEY + \"=\" + snapshot.getKey();\n+            } else {\n+                logger.debug(\"Unable to build snapshot url for Home : {}\", getId());\n+            }\n         }\n-        return result;\n+        return null;\n     }\n \n     @Override\n     protected @Nullable Integer getDataTimestamp() {\n         return dataTimeStamp;\n     }\n+\n+    private static @Nullable NAWelcomeSubEvent findFirstSubEvent(@Nullable NAWelcomeEvent event) {", "originalCommit": "4f84c5c52504168062eaf2118cc0946da571153b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI0NDM4OQ==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436244389", "bodyText": "This is what a said: \"... but I think the \"feature\" is also buggy. See method NAWelcomeHomeHandler#findFirstSubEvent(...). I had to make this method to be NULL-safe, but it is never called with NULL...\". It breaks the build because the member \"lastEvent\" is marked as nullable... That the variable is checked against NULL before isn't recognized... To get the build working again I had to make the method NULL-safe which is totally useless / produces useless code. Have I said before that I don't like this stupid broken Nullable/NonNull \"feature\"...? ;-)\nYou can try to apply your code change, it breaks the Maven build without showing a warning within the IDE / IntelliJ... ;-) \"Null type mismatch (type annotations): required '@nonnull NAWelcomeEvent' but this expression has type '@nullable NAWelcomeEvent'\"", "author": "Novanic", "createdAt": "2020-06-06T06:42:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE4ODUzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE4ODY3Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436188673", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Nullable private NAWelcomeEvent lastEvent;\n          \n          \n            \n                private boolean isNewLastEvent;\n          \n          \n            \n                @Nullable private Integer dataTimeStamp;\n          \n          \n            \n                private @Nullable NAWelcomeEvent lastEvent;\n          \n          \n            \n                private boolean isNewLastEvent;\n          \n          \n            \n                private @Nullable Integer dataTimeStamp;", "author": "cpmeister", "createdAt": "2020-06-05T22:16:09Z", "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java", "diffHunk": "@@ -29,36 +30,34 @@\n import org.eclipse.smarthome.io.net.http.HttpUtil;\n import org.openhab.binding.netatmo.internal.handler.AbstractNetatmoThingHandler;\n import org.openhab.binding.netatmo.internal.handler.NetatmoDeviceHandler;\n+import org.openhab.binding.netatmo.internal.webhook.NAWebhookCameraEvent;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import io.swagger.client.model.NAWelcomeEvent;\n-import io.swagger.client.model.NAWelcomeHome;\n-import io.swagger.client.model.NAWelcomeHomeData;\n-import io.swagger.client.model.NAWelcomeSnapshot;\n-\n /**\n  * {@link NAWelcomeHomeHandler} is the class used to handle the Welcome Home Data\n  *\n  * @author Ga\u00ebl L'hopital - Initial contribution\n  * @author Ing. Peter Weiss - Welcome camera implementation\n  *\n  */\n+@NonNullByDefault\n public class NAWelcomeHomeHandler extends NetatmoDeviceHandler<NAWelcomeHome> {\n-    private Logger logger = LoggerFactory.getLogger(NAWelcomeHomeHandler.class);\n+    private static final Logger logger = LoggerFactory.getLogger(NAWelcomeHomeHandler.class);\n \n     private int iPersons = -1;\n     private int iUnknowns = -1;\n-    private NAWelcomeEvent lastEvent;\n-    private Integer dataTimeStamp;\n+    @Nullable private NAWelcomeEvent lastEvent;\n+    private boolean isNewLastEvent;\n+    @Nullable private Integer dataTimeStamp;", "originalCommit": "4f84c5c52504168062eaf2118cc0946da571153b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI0NjM4OA==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436246388", "bodyText": "done", "author": "Novanic", "createdAt": "2020-06-06T07:16:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE4ODY3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE4OTYyNw==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436189627", "bodyText": "If you are going to add this, you should fix these as well:\n[WARNING] /home/travis/build/openhab/openhab-addons/bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java:[54,2066] The nullness annotation is redundant with a default that applies to this location\n[WARNING] /home/travis/build/openhab/openhab-addons/bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java:[87,3626] Potential null pointer access: this expression has a '@Nullable' type\n[WARNING] /home/travis/build/openhab/openhab-addons/bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java:[100,4006] Potential null pointer access: this expression has a '@Nullable' type\n[WARNING] /home/travis/build/openhab/openhab-addons/bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java:[102,4116] Potential null pointer access: this expression has a '@Nullable' type\n[WARNING] /home/travis/build/openhab/openhab-addons/bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java:[104,4264] Potential null pointer access: this expression has a '@Nullable' type\n[WARNING] /home/travis/build/openhab/openhab-addons/bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java:[106,4416] Potential null pointer access: this expression has a '@Nullable' type\n[WARNING] /home/travis/build/openhab/openhab-addons/bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java:[112,4844] Potential null pointer access: this expression has a '@Nullable' type\n[WARNING] /home/travis/build/openhab/openhab-addons/bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java:[114,4987] Potential null pointer access: this expression has a '@Nullable' type\n[WARNING] /home/travis/build/openhab/openhab-addons/bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java:[118,5244] Potential null pointer access: this expression has a '@Nullable' type\n[WARNING] /home/travis/build/openhab/openhab-addons/bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java:[126,5681] Potential null pointer access: this expression has a '@Nullable' type\n[WARNING] /home/travis/build/openhab/openhab-addons/bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java:[144,6520] Potential null pointer access: this expression has a '@Nullable' type\n[WARNING] /home/travis/build/openhab/openhab-addons/bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java:[145,6592] Potential null pointer access: this expression has a '@Nullable' type\n[WARNING] /home/travis/build/openhab/openhab-addons/bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java:[149,6937] Potential null pointer access: this expression has a '@Nullable' type\n[WARNING] /home/travis/build/openhab/openhab-addons/bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java:[157,7287] Potential null pointer access: this expression has a '@Nullable' type\n[WARNING] /home/travis/build/openhab/openhab-addons/bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java:[159,7427] Potential null pointer access: this expression has a '@Nullable' type\n[WARNING] /home/travis/build/openhab/openhab-addons/bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java:[167,7936] Potential null pointer access: this expression has a '@Nullable' type\n[WARNING] /home/travis/build/openhab/openhab-addons/bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java:[218,9922] Potential null pointer access: this expression has a '@Nullable' type\n[WARNING] /home/travis/build/openhab/openhab-addons/bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java:[237,10497] Potential null pointer access: this expression has a '@Nullable' type", "author": "cpmeister", "createdAt": "2020-06-05T22:19:38Z", "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java", "diffHunk": "@@ -29,36 +30,34 @@\n import org.eclipse.smarthome.io.net.http.HttpUtil;\n import org.openhab.binding.netatmo.internal.handler.AbstractNetatmoThingHandler;\n import org.openhab.binding.netatmo.internal.handler.NetatmoDeviceHandler;\n+import org.openhab.binding.netatmo.internal.webhook.NAWebhookCameraEvent;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import io.swagger.client.model.NAWelcomeEvent;\n-import io.swagger.client.model.NAWelcomeHome;\n-import io.swagger.client.model.NAWelcomeHomeData;\n-import io.swagger.client.model.NAWelcomeSnapshot;\n-\n /**\n  * {@link NAWelcomeHomeHandler} is the class used to handle the Welcome Home Data\n  *\n  * @author Ga\u00ebl L'hopital - Initial contribution\n  * @author Ing. Peter Weiss - Welcome camera implementation\n  *\n  */\n+@NonNullByDefault", "originalCommit": "4f84c5c52504168062eaf2118cc0946da571153b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI0NTczMQ==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436245731", "bodyText": "These are also false-positives / aren't solvable. This line can not produce a NullPointerException regarding lastEvent: \"if (lastEvent == null || lastEvent.getTime() < event.getTime())\"", "author": "Novanic", "createdAt": "2020-06-06T07:04:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE4OTYyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI0NTg4NQ==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436245885", "bodyText": "Only the first warning could get solved. All other warnings are false.", "author": "Novanic", "createdAt": "2020-06-06T07:07:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE4OTYyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk3NDI2OQ==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r433974269", "bodyText": "Cf supra.", "author": "clinique", "createdAt": "2020-06-02T15:41:49Z", "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java", "diffHunk": "@@ -29,36 +30,36 @@\n import org.eclipse.smarthome.io.net.http.HttpUtil;\n import org.openhab.binding.netatmo.internal.handler.AbstractNetatmoThingHandler;\n import org.openhab.binding.netatmo.internal.handler.NetatmoDeviceHandler;\n+import org.openhab.binding.netatmo.internal.webhook.NAWebhookCameraEvent;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import io.swagger.client.model.NAWelcomeEvent;\n-import io.swagger.client.model.NAWelcomeHome;\n-import io.swagger.client.model.NAWelcomeHomeData;\n-import io.swagger.client.model.NAWelcomeSnapshot;\n-\n /**\n  * {@link NAWelcomeHomeHandler} is the class used to handle the Welcome Home Data\n  *\n  * @author Ga\u00ebl L'hopital - Initial contribution\n  * @author Ing. Peter Weiss - Welcome camera implementation\n  *\n  */\n+@NonNullByDefault\n public class NAWelcomeHomeHandler extends NetatmoDeviceHandler<NAWelcomeHome> {\n-    private Logger logger = LoggerFactory.getLogger(NAWelcomeHomeHandler.class);\n+    private static final Logger logger = LoggerFactory.getLogger(NAWelcomeHomeHandler.class);\n \n     private int iPersons = -1;\n     private int iUnknowns = -1;\n+    @Nullable\n     private NAWelcomeEvent lastEvent;\n+    private boolean isNewLastEvent;\n+    @Nullable", "originalCommit": "c305f68e3b7efa09a041447498d98e5ef83ca2ca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2NTE2Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436265166", "bodyText": "\"Cf supra\"?", "author": "Novanic", "createdAt": "2020-06-06T12:29:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk3NDI2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2NjIyOQ==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436266229", "bodyText": "outdated", "author": "Novanic", "createdAt": "2020-06-06T12:43:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk3NDI2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk3NTY4Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r433975683", "bodyText": "Instead of using a @nullable function, you could switch to Optional :\nprotected Optional<NAWelcomeHome> updateReadings() {\n....", "author": "clinique", "createdAt": "2020-06-02T15:43:12Z", "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java", "diffHunk": "@@ -29,36 +30,36 @@\n import org.eclipse.smarthome.io.net.http.HttpUtil;\n import org.openhab.binding.netatmo.internal.handler.AbstractNetatmoThingHandler;\n import org.openhab.binding.netatmo.internal.handler.NetatmoDeviceHandler;\n+import org.openhab.binding.netatmo.internal.webhook.NAWebhookCameraEvent;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import io.swagger.client.model.NAWelcomeEvent;\n-import io.swagger.client.model.NAWelcomeHome;\n-import io.swagger.client.model.NAWelcomeHomeData;\n-import io.swagger.client.model.NAWelcomeSnapshot;\n-\n /**\n  * {@link NAWelcomeHomeHandler} is the class used to handle the Welcome Home Data\n  *\n  * @author Ga\u00ebl L'hopital - Initial contribution\n  * @author Ing. Peter Weiss - Welcome camera implementation\n  *\n  */\n+@NonNullByDefault\n public class NAWelcomeHomeHandler extends NetatmoDeviceHandler<NAWelcomeHome> {\n-    private Logger logger = LoggerFactory.getLogger(NAWelcomeHomeHandler.class);\n+    private static final Logger logger = LoggerFactory.getLogger(NAWelcomeHomeHandler.class);\n \n     private int iPersons = -1;\n     private int iUnknowns = -1;\n+    @Nullable\n     private NAWelcomeEvent lastEvent;\n+    private boolean isNewLastEvent;\n+    @Nullable\n     private Integer dataTimeStamp;\n \n     public NAWelcomeHomeHandler(@NonNull Thing thing) {\n         super(thing);\n     }\n \n     @Override\n-    protected NAWelcomeHome updateReadings() {\n-        NAWelcomeHome result = null;\n+    protected @Nullable NAWelcomeHome updateReadings() {", "originalCommit": "c305f68e3b7efa09a041447498d98e5ef83ca2ca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2ODU3Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436268573", "bodyText": "No, I won't do that. The method was there before my changes and it affects other classes. The Nullable/NonNull changes took already too much of my time, other people can refactor the existing code base.", "author": "Novanic", "createdAt": "2020-06-06T13:19:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk3NTY4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk3NjUxNg==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r433976516", "bodyText": "channelId should not be nullable", "author": "clinique", "createdAt": "2020-06-02T15:44:03Z", "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java", "diffHunk": "@@ -83,18 +84,21 @@ protected NAWelcomeHome updateReadings() {\n                     }\n                 });\n \n+                @Nullable NAWelcomeEvent previousLastEvent = lastEvent;\n                 result.getEvents().forEach(event -> {\n                     if (lastEvent == null || lastEvent.getTime() < event.getTime()) {\n                         lastEvent = event;\n                     }\n                 });\n+\n+                isNewLastEvent = previousLastEvent != null && !previousLastEvent.equals(lastEvent);\n             }\n         }\n         return result;\n     }\n \n     @Override\n-    protected State getNAThingProperty(String channelId) {\n+    protected State getNAThingProperty(@Nullable String channelId) {", "originalCommit": "c305f68e3b7efa09a041447498d98e5ef83ca2ca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2NjMzOQ==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436266339", "bodyText": "done (caused changes in many classes)", "author": "Novanic", "createdAt": "2020-06-06T12:45:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk3NjUxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk3Njk4MA==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r433976980", "bodyText": "Optional would be better.", "author": "clinique", "createdAt": "2020-06-02T15:44:32Z", "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java", "diffHunk": "@@ -159,34 +161,111 @@ protected State getNAThingProperty(String channelId) {\n                 return lastEvent != null ? lastEvent.getIsArrival() != null ? OnOffType.ON : OnOffType.OFF\n                         : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_EVENT_MESSAGE:\n-                return lastEvent != null && lastEvent.getMessage() != null\n-                        ? new StringType(lastEvent.getMessage().replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n+                @Nullable String eventMessage = findEventMessage();\n+                return eventMessage != null\n+                        ? new StringType(eventMessage.replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n                         : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_EVENT_SUBTYPE:\n                 return lastEvent != null ? toDecimalType(lastEvent.getSubType()) : UnDefType.UNDEF;\n         }\n         return super.getNAThingProperty(channelId);\n     }\n \n+    @Override\n+    protected void triggerChannelIfRequired(String channelId) {\n+        if(isNewLastEvent) {\n+            if(CHANNEL_CAMERA_EVENT.equals(channelId)) {\n+                Set<String> detectedObjectTypes = findDetectedObjectTypes(lastEvent);\n+                for(String detectedType: detectedObjectTypes) {\n+                    triggerChannel(channelId, detectedType);\n+                }\n+            }\n+        }\n+        super.triggerChannelIfRequired(channelId);\n+    }\n+\n+    private static Set<String> findDetectedObjectTypes(@Nullable NAWelcomeEvent event) {\n+        Set<String> detectedObjectTypes = new TreeSet<>();\n+        if(event == null) {\n+            return detectedObjectTypes;\n+        }\n+\n+        if(event.getPersonId() != null) {\n+            detectedObjectTypes.add(CAMERA_EVENT_OPTION_HUMAN_DETECTED);\n+        }\n+\n+        if(NAWebhookCameraEvent.EventTypeEnum.MOVEMENT.toString().equals(event.getType())) {\n+            detectedObjectTypes.add(CAMERA_EVENT_OPTION_MOVEMENT_DETECTED);\n+        }\n+\n+        List<NAWelcomeSubEvent> subEvents = event.getEventList();\n+        for(NAWelcomeSubEvent subEvent: subEvents) {\n+            String detectedObjectType = translateDetectedObjectType(subEvent.getType());\n+            detectedObjectTypes.add(detectedObjectType);\n+        }\n+        return detectedObjectTypes;\n+    }\n+\n+    private static String translateDetectedObjectType(NAWelcomeSubEvent.TypeEnum type) {\n+        switch (type) {\n+            case HUMAN: return CAMERA_EVENT_OPTION_HUMAN_DETECTED;\n+            case ANIMAL: return CAMERA_EVENT_OPTION_ANIMAL_DETECTED;\n+            case VEHICLE: return CAMERA_EVENT_OPTION_VEHICLE_DETECTED;\n+            default: throw new IllegalArgumentException(\"Unknown detected object type!\");\n+        }\n+    }\n+\n+    private @Nullable String findEventMessage() {", "originalCommit": "c305f68e3b7efa09a041447498d98e5ef83ca2ca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2ODUyNA==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436268524", "bodyText": "done", "author": "Novanic", "createdAt": "2020-06-06T13:18:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk3Njk4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk3NzIzNg==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r433977236", "bodyText": "Optional would be better.", "author": "clinique", "createdAt": "2020-06-02T15:44:47Z", "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java", "diffHunk": "@@ -159,34 +161,111 @@ protected State getNAThingProperty(String channelId) {\n                 return lastEvent != null ? lastEvent.getIsArrival() != null ? OnOffType.ON : OnOffType.OFF\n                         : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_EVENT_MESSAGE:\n-                return lastEvent != null && lastEvent.getMessage() != null\n-                        ? new StringType(lastEvent.getMessage().replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n+                @Nullable String eventMessage = findEventMessage();\n+                return eventMessage != null\n+                        ? new StringType(eventMessage.replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n                         : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_EVENT_SUBTYPE:\n                 return lastEvent != null ? toDecimalType(lastEvent.getSubType()) : UnDefType.UNDEF;\n         }\n         return super.getNAThingProperty(channelId);\n     }\n \n+    @Override\n+    protected void triggerChannelIfRequired(String channelId) {\n+        if(isNewLastEvent) {\n+            if(CHANNEL_CAMERA_EVENT.equals(channelId)) {\n+                Set<String> detectedObjectTypes = findDetectedObjectTypes(lastEvent);\n+                for(String detectedType: detectedObjectTypes) {\n+                    triggerChannel(channelId, detectedType);\n+                }\n+            }\n+        }\n+        super.triggerChannelIfRequired(channelId);\n+    }\n+\n+    private static Set<String> findDetectedObjectTypes(@Nullable NAWelcomeEvent event) {\n+        Set<String> detectedObjectTypes = new TreeSet<>();\n+        if(event == null) {\n+            return detectedObjectTypes;\n+        }\n+\n+        if(event.getPersonId() != null) {\n+            detectedObjectTypes.add(CAMERA_EVENT_OPTION_HUMAN_DETECTED);\n+        }\n+\n+        if(NAWebhookCameraEvent.EventTypeEnum.MOVEMENT.toString().equals(event.getType())) {\n+            detectedObjectTypes.add(CAMERA_EVENT_OPTION_MOVEMENT_DETECTED);\n+        }\n+\n+        List<NAWelcomeSubEvent> subEvents = event.getEventList();\n+        for(NAWelcomeSubEvent subEvent: subEvents) {\n+            String detectedObjectType = translateDetectedObjectType(subEvent.getType());\n+            detectedObjectTypes.add(detectedObjectType);\n+        }\n+        return detectedObjectTypes;\n+    }\n+\n+    private static String translateDetectedObjectType(NAWelcomeSubEvent.TypeEnum type) {\n+        switch (type) {\n+            case HUMAN: return CAMERA_EVENT_OPTION_HUMAN_DETECTED;\n+            case ANIMAL: return CAMERA_EVENT_OPTION_ANIMAL_DETECTED;\n+            case VEHICLE: return CAMERA_EVENT_OPTION_VEHICLE_DETECTED;\n+            default: throw new IllegalArgumentException(\"Unknown detected object type!\");\n+        }\n+    }\n+\n+    private @Nullable String findEventMessage() {\n+        if(lastEvent != null) {\n+            @Nullable String message = lastEvent.getMessage();\n+            if(message == null) {\n+                @Nullable NAWelcomeSubEvent firstSubEvent = findFirstSubEvent(lastEvent);\n+                if(firstSubEvent != null) {\n+                    message = firstSubEvent.getMessage();\n+                }\n+            }\n+            return message;\n+        }\n+        return null;\n+    }\n+\n     /**\n      * Returns the Url of the picture\n      *\n      * @return Url of the picture or null\n      */\n-    protected String getSnapshotURL(NAWelcomeSnapshot snapshot) {\n-        String result = null;\n-\n-        if (snapshot != null && snapshot.getId() != null && snapshot.getKey() != null) {\n-            result = WELCOME_PICTURE_URL + \"?\" + WELCOME_PICTURE_IMAGEID + \"=\" + snapshot.getId() + \"&\"\n-                    + WELCOME_PICTURE_KEY + \"=\" + snapshot.getKey();\n-        } else {\n-            logger.debug(\"Unable to build snapshot url for Home : {}\", getId());\n+    protected @Nullable String findSnapshotURL() {", "originalCommit": "c305f68e3b7efa09a041447498d98e5ef83ca2ca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2ODUxNw==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436268517", "bodyText": "done", "author": "Novanic", "createdAt": "2020-06-06T13:18:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk3NzIzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk3NzgyNg==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r433977826", "bodyText": "Optional would be better for the function, and parameter should not be nullable.", "author": "clinique", "createdAt": "2020-06-02T15:45:21Z", "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java", "diffHunk": "@@ -159,34 +161,111 @@ protected State getNAThingProperty(String channelId) {\n                 return lastEvent != null ? lastEvent.getIsArrival() != null ? OnOffType.ON : OnOffType.OFF\n                         : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_EVENT_MESSAGE:\n-                return lastEvent != null && lastEvent.getMessage() != null\n-                        ? new StringType(lastEvent.getMessage().replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n+                @Nullable String eventMessage = findEventMessage();\n+                return eventMessage != null\n+                        ? new StringType(eventMessage.replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n                         : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_EVENT_SUBTYPE:\n                 return lastEvent != null ? toDecimalType(lastEvent.getSubType()) : UnDefType.UNDEF;\n         }\n         return super.getNAThingProperty(channelId);\n     }\n \n+    @Override\n+    protected void triggerChannelIfRequired(String channelId) {\n+        if(isNewLastEvent) {\n+            if(CHANNEL_CAMERA_EVENT.equals(channelId)) {\n+                Set<String> detectedObjectTypes = findDetectedObjectTypes(lastEvent);\n+                for(String detectedType: detectedObjectTypes) {\n+                    triggerChannel(channelId, detectedType);\n+                }\n+            }\n+        }\n+        super.triggerChannelIfRequired(channelId);\n+    }\n+\n+    private static Set<String> findDetectedObjectTypes(@Nullable NAWelcomeEvent event) {\n+        Set<String> detectedObjectTypes = new TreeSet<>();\n+        if(event == null) {\n+            return detectedObjectTypes;\n+        }\n+\n+        if(event.getPersonId() != null) {\n+            detectedObjectTypes.add(CAMERA_EVENT_OPTION_HUMAN_DETECTED);\n+        }\n+\n+        if(NAWebhookCameraEvent.EventTypeEnum.MOVEMENT.toString().equals(event.getType())) {\n+            detectedObjectTypes.add(CAMERA_EVENT_OPTION_MOVEMENT_DETECTED);\n+        }\n+\n+        List<NAWelcomeSubEvent> subEvents = event.getEventList();\n+        for(NAWelcomeSubEvent subEvent: subEvents) {\n+            String detectedObjectType = translateDetectedObjectType(subEvent.getType());\n+            detectedObjectTypes.add(detectedObjectType);\n+        }\n+        return detectedObjectTypes;\n+    }\n+\n+    private static String translateDetectedObjectType(NAWelcomeSubEvent.TypeEnum type) {\n+        switch (type) {\n+            case HUMAN: return CAMERA_EVENT_OPTION_HUMAN_DETECTED;\n+            case ANIMAL: return CAMERA_EVENT_OPTION_ANIMAL_DETECTED;\n+            case VEHICLE: return CAMERA_EVENT_OPTION_VEHICLE_DETECTED;\n+            default: throw new IllegalArgumentException(\"Unknown detected object type!\");\n+        }\n+    }\n+\n+    private @Nullable String findEventMessage() {\n+        if(lastEvent != null) {\n+            @Nullable String message = lastEvent.getMessage();\n+            if(message == null) {\n+                @Nullable NAWelcomeSubEvent firstSubEvent = findFirstSubEvent(lastEvent);\n+                if(firstSubEvent != null) {\n+                    message = firstSubEvent.getMessage();\n+                }\n+            }\n+            return message;\n+        }\n+        return null;\n+    }\n+\n     /**\n      * Returns the Url of the picture\n      *\n      * @return Url of the picture or null\n      */\n-    protected String getSnapshotURL(NAWelcomeSnapshot snapshot) {\n-        String result = null;\n-\n-        if (snapshot != null && snapshot.getId() != null && snapshot.getKey() != null) {\n-            result = WELCOME_PICTURE_URL + \"?\" + WELCOME_PICTURE_IMAGEID + \"=\" + snapshot.getId() + \"&\"\n-                    + WELCOME_PICTURE_KEY + \"=\" + snapshot.getKey();\n-        } else {\n-            logger.debug(\"Unable to build snapshot url for Home : {}\", getId());\n+    protected @Nullable String findSnapshotURL() {\n+        if(lastEvent != null) {\n+            NAWelcomeSnapshot snapshot = lastEvent.getSnapshot();\n+            if (snapshot == null) {\n+                @Nullable NAWelcomeSubEvent firstSubEvent = findFirstSubEvent(lastEvent);\n+                if (firstSubEvent != null) {\n+                    snapshot = firstSubEvent.getSnapshot();\n+                }\n+            }\n+\n+            if (snapshot != null && snapshot.getId() != null && snapshot.getKey() != null) {\n+                return WELCOME_PICTURE_URL + \"?\" + WELCOME_PICTURE_IMAGEID + \"=\" + snapshot.getId() + \"&\"\n+                        + WELCOME_PICTURE_KEY + \"=\" + snapshot.getKey();\n+            } else {\n+                logger.debug(\"Unable to build snapshot url for Home : {}\", getId());\n+            }\n         }\n-        return result;\n+        return null;\n     }\n \n     @Override\n     protected @Nullable Integer getDataTimestamp() {\n         return dataTimeStamp;\n     }\n+\n+    private static @Nullable NAWelcomeSubEvent findFirstSubEvent(@Nullable NAWelcomeEvent event) {", "originalCommit": "c305f68e3b7efa09a041447498d98e5ef83ca2ca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2ODUwNQ==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436268505", "bodyText": "done", "author": "Novanic", "createdAt": "2020-06-06T13:18:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk3NzgyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3MDgyNA==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436270824", "bodyText": "logger is final but not static", "author": "clinique", "createdAt": "2020-06-06T13:54:31Z", "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java", "diffHunk": "@@ -15,50 +15,50 @@\n import static org.openhab.binding.netatmo.internal.ChannelTypeUtils.*;\n import static org.openhab.binding.netatmo.internal.NetatmoBindingConstants.*;\n \n-import java.util.Calendar;\n-import java.util.Optional;\n+import java.util.*;\n+import java.util.function.Function;\n \n-import org.eclipse.jdt.annotation.NonNull;\n+import io.swagger.client.model.*;\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n import org.eclipse.jdt.annotation.Nullable;\n import org.eclipse.smarthome.core.library.types.DecimalType;\n-import org.eclipse.smarthome.core.library.types.OnOffType;\n import org.eclipse.smarthome.core.library.types.StringType;\n import org.eclipse.smarthome.core.thing.Thing;\n import org.eclipse.smarthome.core.types.State;\n import org.eclipse.smarthome.core.types.UnDefType;\n import org.eclipse.smarthome.io.net.http.HttpUtil;\n+import org.openhab.binding.netatmo.internal.ChannelTypeUtils;\n import org.openhab.binding.netatmo.internal.handler.AbstractNetatmoThingHandler;\n import org.openhab.binding.netatmo.internal.handler.NetatmoDeviceHandler;\n+import org.openhab.binding.netatmo.internal.webhook.NAWebhookCameraEvent;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import io.swagger.client.model.NAWelcomeEvent;\n-import io.swagger.client.model.NAWelcomeHome;\n-import io.swagger.client.model.NAWelcomeHomeData;\n-import io.swagger.client.model.NAWelcomeSnapshot;\n-\n /**\n  * {@link NAWelcomeHomeHandler} is the class used to handle the Welcome Home Data\n  *\n  * @author Ga\u00ebl L'hopital - Initial contribution\n  * @author Ing. Peter Weiss - Welcome camera implementation\n  *\n  */\n+@NonNullByDefault\n public class NAWelcomeHomeHandler extends NetatmoDeviceHandler<NAWelcomeHome> {\n-    private Logger logger = LoggerFactory.getLogger(NAWelcomeHomeHandler.class);\n+    private static final Logger logger = LoggerFactory.getLogger(NAWelcomeHomeHandler.class);", "originalCommit": "af5e3832003de7d2ed7763e76b2c9dda7ca6877d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI4MDQ2OQ==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436280469", "bodyText": "both is valid and I'm familiar with static declared loggers. And both is used within OpenHAB (when you search for \"static final Logger\"): http://www.slf4j.org/faq.html#declared_static\nBut I change that, in the netatmo binding code it is really never declared as static.", "author": "Novanic", "createdAt": "2020-06-06T16:12:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3MDgyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5MzUwOQ==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436293509", "bodyText": "done", "author": "Novanic", "createdAt": "2020-06-06T19:16:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3MDgyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3MDkxMg==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436270912", "bodyText": "Could be done at declaration", "author": "clinique", "createdAt": "2020-06-06T13:55:22Z", "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java", "diffHunk": "@@ -15,50 +15,50 @@\n import static org.openhab.binding.netatmo.internal.ChannelTypeUtils.*;\n import static org.openhab.binding.netatmo.internal.NetatmoBindingConstants.*;\n \n-import java.util.Calendar;\n-import java.util.Optional;\n+import java.util.*;\n+import java.util.function.Function;\n \n-import org.eclipse.jdt.annotation.NonNull;\n+import io.swagger.client.model.*;\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n import org.eclipse.jdt.annotation.Nullable;\n import org.eclipse.smarthome.core.library.types.DecimalType;\n-import org.eclipse.smarthome.core.library.types.OnOffType;\n import org.eclipse.smarthome.core.library.types.StringType;\n import org.eclipse.smarthome.core.thing.Thing;\n import org.eclipse.smarthome.core.types.State;\n import org.eclipse.smarthome.core.types.UnDefType;\n import org.eclipse.smarthome.io.net.http.HttpUtil;\n+import org.openhab.binding.netatmo.internal.ChannelTypeUtils;\n import org.openhab.binding.netatmo.internal.handler.AbstractNetatmoThingHandler;\n import org.openhab.binding.netatmo.internal.handler.NetatmoDeviceHandler;\n+import org.openhab.binding.netatmo.internal.webhook.NAWebhookCameraEvent;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import io.swagger.client.model.NAWelcomeEvent;\n-import io.swagger.client.model.NAWelcomeHome;\n-import io.swagger.client.model.NAWelcomeHomeData;\n-import io.swagger.client.model.NAWelcomeSnapshot;\n-\n /**\n  * {@link NAWelcomeHomeHandler} is the class used to handle the Welcome Home Data\n  *\n  * @author Ga\u00ebl L'hopital - Initial contribution\n  * @author Ing. Peter Weiss - Welcome camera implementation\n  *\n  */\n+@NonNullByDefault\n public class NAWelcomeHomeHandler extends NetatmoDeviceHandler<NAWelcomeHome> {\n-    private Logger logger = LoggerFactory.getLogger(NAWelcomeHomeHandler.class);\n+    private static final Logger logger = LoggerFactory.getLogger(NAWelcomeHomeHandler.class);\n \n     private int iPersons = -1;\n     private int iUnknowns = -1;\n-    private NAWelcomeEvent lastEvent;\n-    private Integer dataTimeStamp;\n+    private Optional<NAWelcomeEvent> lastEvent;\n+    private boolean isNewLastEvent;\n+    private @Nullable Integer dataTimeStamp;\n \n-    public NAWelcomeHomeHandler(@NonNull Thing thing) {\n+    public NAWelcomeHomeHandler(Thing thing) {\n         super(thing);\n+        lastEvent = Optional.empty();", "originalCommit": "af5e3832003de7d2ed7763e76b2c9dda7ca6877d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5MzUyMQ==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436293521", "bodyText": "done", "author": "Novanic", "createdAt": "2020-06-06T19:17:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3MDkxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3MTM5Nw==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436271397", "bodyText": "space between if and '(' (doesn't the IDE format this automatically ?)", "author": "clinique", "createdAt": "2020-06-06T14:01:22Z", "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java", "diffHunk": "@@ -97,96 +100,164 @@ protected NAWelcomeHome updateReadings() {\n     protected State getNAThingProperty(String channelId) {\n         switch (channelId) {\n             case CHANNEL_WELCOME_HOME_CITY:\n-                return device != null ? toStringType(device.getPlace().getCity()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getCity);\n             case CHANNEL_WELCOME_HOME_COUNTRY:\n-                return device != null ? toStringType(device.getPlace().getCountry()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getCountry);\n             case CHANNEL_WELCOME_HOME_TIMEZONE:\n-                return device != null ? toStringType(device.getPlace().getTimezone()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getTimezone);\n             case CHANNEL_WELCOME_HOME_PERSONCOUNT:\n                 return iPersons != -1 ? new DecimalType(iPersons) : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_HOME_UNKNOWNCOUNT:\n                 return iUnknowns != -1 ? new DecimalType(iUnknowns) : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_EVENT_TYPE:\n-                return lastEvent != null ? toStringType(lastEvent.getType()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toStringType(e.getType())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_TIME:\n-                return lastEvent != null ? toDateTimeType(lastEvent.getTime()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toDateTimeType(e.getTime())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_CAMERAID:\n-                if (lastEvent != null) {\n+                if (lastEvent.isPresent()) {\n                     Optional<AbstractNetatmoThingHandler> camera = getBridgeHandler()\n-                            .findNAThing(lastEvent.getCameraId());\n+                            .findNAThing(lastEvent.get().getCameraId());\n                     return camera.map(c -> toStringType(c.getThing().getLabel())).orElse(UnDefType.UNDEF);\n                 } else {\n                     return UnDefType.UNDEF;\n                 }\n             case CHANNEL_WELCOME_EVENT_PERSONID:\n-                if (lastEvent != null) {\n+                if (lastEvent.isPresent()) {\n                     Optional<AbstractNetatmoThingHandler> person = getBridgeHandler()\n-                            .findNAThing(lastEvent.getPersonId());\n+                            .findNAThing(lastEvent.get().getPersonId());\n                     return person.map(p -> toStringType(p.getThing().getLabel())).orElse(UnDefType.UNDEF);\n                 } else {\n                     return UnDefType.UNDEF;\n                 }\n             case CHANNEL_WELCOME_EVENT_SNAPSHOT:\n-                if (lastEvent != null) {\n-                    String url = getSnapshotURL(lastEvent.getSnapshot());\n-                    return url != null ? HttpUtil.downloadImage(url) : UnDefType.UNDEF;\n-                } else {\n-                    return UnDefType.UNDEF;\n-                }\n+                return findSnapshotURL().map(url -> (State)HttpUtil.downloadImage(url)).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_SNAPSHOT_URL:\n-                if (lastEvent != null) {\n-                    String snapshotURL = getSnapshotURL(lastEvent.getSnapshot());\n-                    return toStringType(snapshotURL);\n-                } else {\n-                    return UnDefType.UNDEF;\n-                }\n+                return findSnapshotURL().map(ChannelTypeUtils::toStringType).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_VIDEO_URL:\n-                if (lastEvent != null && lastEvent.getVideoId() != null) {\n-                    String cameraId = lastEvent.getCameraId();\n+                if (lastEvent.isPresent() && lastEvent.get().getVideoId() != null) {\n+                    String cameraId = lastEvent.get().getCameraId();\n                     Optional<AbstractNetatmoThingHandler> thing = getBridgeHandler().findNAThing(cameraId);\n                     if (thing.isPresent()) {\n                         NAWelcomeCameraHandler eventCamera = (NAWelcomeCameraHandler) thing.get();\n-                        String streamUrl = eventCamera.getStreamURL(lastEvent.getVideoId());\n+                        String streamUrl = eventCamera.getStreamURL(lastEvent.get().getVideoId());\n                         if (streamUrl != null) {\n                             return new StringType(streamUrl);\n                         }\n                     }\n                 }\n                 return UnDefType.UNDEF;\n             case CHANNEL_WELCOME_EVENT_VIDEOSTATUS:\n-                return lastEvent != null ? toStringType(lastEvent.getVideoStatus()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toStringType(e.getVideoStatus())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_ISARRIVAL:\n-                return lastEvent != null ? lastEvent.getIsArrival() != null ? OnOffType.ON : OnOffType.OFF\n-                        : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toOnOffType(e.getIsArrival())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_MESSAGE:\n-                return lastEvent != null && lastEvent.getMessage() != null\n-                        ? new StringType(lastEvent.getMessage().replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n-                        : UnDefType.UNDEF;\n+                return findEventMessage().map(\n+                        m -> (State)new StringType(m.replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n+                ).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_SUBTYPE:\n-                return lastEvent != null ? toDecimalType(lastEvent.getSubType()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toDecimalType(e.getSubType())).orElse(UnDefType.UNDEF);\n         }\n         return super.getNAThingProperty(channelId);\n     }\n \n+    @Override\n+    protected void triggerChannelIfRequired(String channelId) {\n+        if(isNewLastEvent) {", "originalCommit": "af5e3832003de7d2ed7763e76b2c9dda7ca6877d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5MzY2Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436293666", "bodyText": "done", "author": "Novanic", "createdAt": "2020-06-06T19:18:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3MTM5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3MTM5OQ==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436271399", "bodyText": "space between if and '(' (doesn't the IDE format this automatically ?)", "author": "clinique", "createdAt": "2020-06-06T14:01:29Z", "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java", "diffHunk": "@@ -97,96 +100,164 @@ protected NAWelcomeHome updateReadings() {\n     protected State getNAThingProperty(String channelId) {\n         switch (channelId) {\n             case CHANNEL_WELCOME_HOME_CITY:\n-                return device != null ? toStringType(device.getPlace().getCity()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getCity);\n             case CHANNEL_WELCOME_HOME_COUNTRY:\n-                return device != null ? toStringType(device.getPlace().getCountry()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getCountry);\n             case CHANNEL_WELCOME_HOME_TIMEZONE:\n-                return device != null ? toStringType(device.getPlace().getTimezone()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getTimezone);\n             case CHANNEL_WELCOME_HOME_PERSONCOUNT:\n                 return iPersons != -1 ? new DecimalType(iPersons) : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_HOME_UNKNOWNCOUNT:\n                 return iUnknowns != -1 ? new DecimalType(iUnknowns) : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_EVENT_TYPE:\n-                return lastEvent != null ? toStringType(lastEvent.getType()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toStringType(e.getType())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_TIME:\n-                return lastEvent != null ? toDateTimeType(lastEvent.getTime()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toDateTimeType(e.getTime())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_CAMERAID:\n-                if (lastEvent != null) {\n+                if (lastEvent.isPresent()) {\n                     Optional<AbstractNetatmoThingHandler> camera = getBridgeHandler()\n-                            .findNAThing(lastEvent.getCameraId());\n+                            .findNAThing(lastEvent.get().getCameraId());\n                     return camera.map(c -> toStringType(c.getThing().getLabel())).orElse(UnDefType.UNDEF);\n                 } else {\n                     return UnDefType.UNDEF;\n                 }\n             case CHANNEL_WELCOME_EVENT_PERSONID:\n-                if (lastEvent != null) {\n+                if (lastEvent.isPresent()) {\n                     Optional<AbstractNetatmoThingHandler> person = getBridgeHandler()\n-                            .findNAThing(lastEvent.getPersonId());\n+                            .findNAThing(lastEvent.get().getPersonId());\n                     return person.map(p -> toStringType(p.getThing().getLabel())).orElse(UnDefType.UNDEF);\n                 } else {\n                     return UnDefType.UNDEF;\n                 }\n             case CHANNEL_WELCOME_EVENT_SNAPSHOT:\n-                if (lastEvent != null) {\n-                    String url = getSnapshotURL(lastEvent.getSnapshot());\n-                    return url != null ? HttpUtil.downloadImage(url) : UnDefType.UNDEF;\n-                } else {\n-                    return UnDefType.UNDEF;\n-                }\n+                return findSnapshotURL().map(url -> (State)HttpUtil.downloadImage(url)).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_SNAPSHOT_URL:\n-                if (lastEvent != null) {\n-                    String snapshotURL = getSnapshotURL(lastEvent.getSnapshot());\n-                    return toStringType(snapshotURL);\n-                } else {\n-                    return UnDefType.UNDEF;\n-                }\n+                return findSnapshotURL().map(ChannelTypeUtils::toStringType).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_VIDEO_URL:\n-                if (lastEvent != null && lastEvent.getVideoId() != null) {\n-                    String cameraId = lastEvent.getCameraId();\n+                if (lastEvent.isPresent() && lastEvent.get().getVideoId() != null) {\n+                    String cameraId = lastEvent.get().getCameraId();\n                     Optional<AbstractNetatmoThingHandler> thing = getBridgeHandler().findNAThing(cameraId);\n                     if (thing.isPresent()) {\n                         NAWelcomeCameraHandler eventCamera = (NAWelcomeCameraHandler) thing.get();\n-                        String streamUrl = eventCamera.getStreamURL(lastEvent.getVideoId());\n+                        String streamUrl = eventCamera.getStreamURL(lastEvent.get().getVideoId());\n                         if (streamUrl != null) {\n                             return new StringType(streamUrl);\n                         }\n                     }\n                 }\n                 return UnDefType.UNDEF;\n             case CHANNEL_WELCOME_EVENT_VIDEOSTATUS:\n-                return lastEvent != null ? toStringType(lastEvent.getVideoStatus()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toStringType(e.getVideoStatus())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_ISARRIVAL:\n-                return lastEvent != null ? lastEvent.getIsArrival() != null ? OnOffType.ON : OnOffType.OFF\n-                        : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toOnOffType(e.getIsArrival())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_MESSAGE:\n-                return lastEvent != null && lastEvent.getMessage() != null\n-                        ? new StringType(lastEvent.getMessage().replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n-                        : UnDefType.UNDEF;\n+                return findEventMessage().map(\n+                        m -> (State)new StringType(m.replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n+                ).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_SUBTYPE:\n-                return lastEvent != null ? toDecimalType(lastEvent.getSubType()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toDecimalType(e.getSubType())).orElse(UnDefType.UNDEF);\n         }\n         return super.getNAThingProperty(channelId);\n     }\n \n+    @Override\n+    protected void triggerChannelIfRequired(String channelId) {\n+        if(isNewLastEvent) {\n+            if(CHANNEL_CAMERA_EVENT.equals(channelId)) {", "originalCommit": "af5e3832003de7d2ed7763e76b2c9dda7ca6877d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5MzU1Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436293553", "bodyText": "done", "author": "Novanic", "createdAt": "2020-06-06T19:17:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3MTM5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3MTQ1NA==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436271454", "bodyText": "detectedObjectTypes.forEach() would be better.", "author": "clinique", "createdAt": "2020-06-06T14:02:37Z", "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java", "diffHunk": "@@ -97,96 +100,164 @@ protected NAWelcomeHome updateReadings() {\n     protected State getNAThingProperty(String channelId) {\n         switch (channelId) {\n             case CHANNEL_WELCOME_HOME_CITY:\n-                return device != null ? toStringType(device.getPlace().getCity()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getCity);\n             case CHANNEL_WELCOME_HOME_COUNTRY:\n-                return device != null ? toStringType(device.getPlace().getCountry()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getCountry);\n             case CHANNEL_WELCOME_HOME_TIMEZONE:\n-                return device != null ? toStringType(device.getPlace().getTimezone()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getTimezone);\n             case CHANNEL_WELCOME_HOME_PERSONCOUNT:\n                 return iPersons != -1 ? new DecimalType(iPersons) : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_HOME_UNKNOWNCOUNT:\n                 return iUnknowns != -1 ? new DecimalType(iUnknowns) : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_EVENT_TYPE:\n-                return lastEvent != null ? toStringType(lastEvent.getType()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toStringType(e.getType())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_TIME:\n-                return lastEvent != null ? toDateTimeType(lastEvent.getTime()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toDateTimeType(e.getTime())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_CAMERAID:\n-                if (lastEvent != null) {\n+                if (lastEvent.isPresent()) {\n                     Optional<AbstractNetatmoThingHandler> camera = getBridgeHandler()\n-                            .findNAThing(lastEvent.getCameraId());\n+                            .findNAThing(lastEvent.get().getCameraId());\n                     return camera.map(c -> toStringType(c.getThing().getLabel())).orElse(UnDefType.UNDEF);\n                 } else {\n                     return UnDefType.UNDEF;\n                 }\n             case CHANNEL_WELCOME_EVENT_PERSONID:\n-                if (lastEvent != null) {\n+                if (lastEvent.isPresent()) {\n                     Optional<AbstractNetatmoThingHandler> person = getBridgeHandler()\n-                            .findNAThing(lastEvent.getPersonId());\n+                            .findNAThing(lastEvent.get().getPersonId());\n                     return person.map(p -> toStringType(p.getThing().getLabel())).orElse(UnDefType.UNDEF);\n                 } else {\n                     return UnDefType.UNDEF;\n                 }\n             case CHANNEL_WELCOME_EVENT_SNAPSHOT:\n-                if (lastEvent != null) {\n-                    String url = getSnapshotURL(lastEvent.getSnapshot());\n-                    return url != null ? HttpUtil.downloadImage(url) : UnDefType.UNDEF;\n-                } else {\n-                    return UnDefType.UNDEF;\n-                }\n+                return findSnapshotURL().map(url -> (State)HttpUtil.downloadImage(url)).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_SNAPSHOT_URL:\n-                if (lastEvent != null) {\n-                    String snapshotURL = getSnapshotURL(lastEvent.getSnapshot());\n-                    return toStringType(snapshotURL);\n-                } else {\n-                    return UnDefType.UNDEF;\n-                }\n+                return findSnapshotURL().map(ChannelTypeUtils::toStringType).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_VIDEO_URL:\n-                if (lastEvent != null && lastEvent.getVideoId() != null) {\n-                    String cameraId = lastEvent.getCameraId();\n+                if (lastEvent.isPresent() && lastEvent.get().getVideoId() != null) {\n+                    String cameraId = lastEvent.get().getCameraId();\n                     Optional<AbstractNetatmoThingHandler> thing = getBridgeHandler().findNAThing(cameraId);\n                     if (thing.isPresent()) {\n                         NAWelcomeCameraHandler eventCamera = (NAWelcomeCameraHandler) thing.get();\n-                        String streamUrl = eventCamera.getStreamURL(lastEvent.getVideoId());\n+                        String streamUrl = eventCamera.getStreamURL(lastEvent.get().getVideoId());\n                         if (streamUrl != null) {\n                             return new StringType(streamUrl);\n                         }\n                     }\n                 }\n                 return UnDefType.UNDEF;\n             case CHANNEL_WELCOME_EVENT_VIDEOSTATUS:\n-                return lastEvent != null ? toStringType(lastEvent.getVideoStatus()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toStringType(e.getVideoStatus())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_ISARRIVAL:\n-                return lastEvent != null ? lastEvent.getIsArrival() != null ? OnOffType.ON : OnOffType.OFF\n-                        : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toOnOffType(e.getIsArrival())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_MESSAGE:\n-                return lastEvent != null && lastEvent.getMessage() != null\n-                        ? new StringType(lastEvent.getMessage().replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n-                        : UnDefType.UNDEF;\n+                return findEventMessage().map(\n+                        m -> (State)new StringType(m.replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n+                ).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_SUBTYPE:\n-                return lastEvent != null ? toDecimalType(lastEvent.getSubType()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toDecimalType(e.getSubType())).orElse(UnDefType.UNDEF);\n         }\n         return super.getNAThingProperty(channelId);\n     }\n \n+    @Override\n+    protected void triggerChannelIfRequired(String channelId) {\n+        if(isNewLastEvent) {\n+            if(CHANNEL_CAMERA_EVENT.equals(channelId)) {\n+                Set<String> detectedObjectTypes = findDetectedObjectTypes(lastEvent);\n+                for(String detectedType: detectedObjectTypes) {", "originalCommit": "af5e3832003de7d2ed7763e76b2c9dda7ca6877d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5MzU2Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436293563", "bodyText": "done", "author": "Novanic", "createdAt": "2020-06-06T19:17:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3MTQ1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3MTU4NQ==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436271585", "bodyText": "Couldn't you use directly the EventTypeEnum to define the various events ?", "author": "clinique", "createdAt": "2020-06-06T14:04:41Z", "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java", "diffHunk": "@@ -97,96 +100,164 @@ protected NAWelcomeHome updateReadings() {\n     protected State getNAThingProperty(String channelId) {\n         switch (channelId) {\n             case CHANNEL_WELCOME_HOME_CITY:\n-                return device != null ? toStringType(device.getPlace().getCity()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getCity);\n             case CHANNEL_WELCOME_HOME_COUNTRY:\n-                return device != null ? toStringType(device.getPlace().getCountry()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getCountry);\n             case CHANNEL_WELCOME_HOME_TIMEZONE:\n-                return device != null ? toStringType(device.getPlace().getTimezone()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getTimezone);\n             case CHANNEL_WELCOME_HOME_PERSONCOUNT:\n                 return iPersons != -1 ? new DecimalType(iPersons) : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_HOME_UNKNOWNCOUNT:\n                 return iUnknowns != -1 ? new DecimalType(iUnknowns) : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_EVENT_TYPE:\n-                return lastEvent != null ? toStringType(lastEvent.getType()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toStringType(e.getType())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_TIME:\n-                return lastEvent != null ? toDateTimeType(lastEvent.getTime()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toDateTimeType(e.getTime())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_CAMERAID:\n-                if (lastEvent != null) {\n+                if (lastEvent.isPresent()) {\n                     Optional<AbstractNetatmoThingHandler> camera = getBridgeHandler()\n-                            .findNAThing(lastEvent.getCameraId());\n+                            .findNAThing(lastEvent.get().getCameraId());\n                     return camera.map(c -> toStringType(c.getThing().getLabel())).orElse(UnDefType.UNDEF);\n                 } else {\n                     return UnDefType.UNDEF;\n                 }\n             case CHANNEL_WELCOME_EVENT_PERSONID:\n-                if (lastEvent != null) {\n+                if (lastEvent.isPresent()) {\n                     Optional<AbstractNetatmoThingHandler> person = getBridgeHandler()\n-                            .findNAThing(lastEvent.getPersonId());\n+                            .findNAThing(lastEvent.get().getPersonId());\n                     return person.map(p -> toStringType(p.getThing().getLabel())).orElse(UnDefType.UNDEF);\n                 } else {\n                     return UnDefType.UNDEF;\n                 }\n             case CHANNEL_WELCOME_EVENT_SNAPSHOT:\n-                if (lastEvent != null) {\n-                    String url = getSnapshotURL(lastEvent.getSnapshot());\n-                    return url != null ? HttpUtil.downloadImage(url) : UnDefType.UNDEF;\n-                } else {\n-                    return UnDefType.UNDEF;\n-                }\n+                return findSnapshotURL().map(url -> (State)HttpUtil.downloadImage(url)).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_SNAPSHOT_URL:\n-                if (lastEvent != null) {\n-                    String snapshotURL = getSnapshotURL(lastEvent.getSnapshot());\n-                    return toStringType(snapshotURL);\n-                } else {\n-                    return UnDefType.UNDEF;\n-                }\n+                return findSnapshotURL().map(ChannelTypeUtils::toStringType).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_VIDEO_URL:\n-                if (lastEvent != null && lastEvent.getVideoId() != null) {\n-                    String cameraId = lastEvent.getCameraId();\n+                if (lastEvent.isPresent() && lastEvent.get().getVideoId() != null) {\n+                    String cameraId = lastEvent.get().getCameraId();\n                     Optional<AbstractNetatmoThingHandler> thing = getBridgeHandler().findNAThing(cameraId);\n                     if (thing.isPresent()) {\n                         NAWelcomeCameraHandler eventCamera = (NAWelcomeCameraHandler) thing.get();\n-                        String streamUrl = eventCamera.getStreamURL(lastEvent.getVideoId());\n+                        String streamUrl = eventCamera.getStreamURL(lastEvent.get().getVideoId());\n                         if (streamUrl != null) {\n                             return new StringType(streamUrl);\n                         }\n                     }\n                 }\n                 return UnDefType.UNDEF;\n             case CHANNEL_WELCOME_EVENT_VIDEOSTATUS:\n-                return lastEvent != null ? toStringType(lastEvent.getVideoStatus()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toStringType(e.getVideoStatus())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_ISARRIVAL:\n-                return lastEvent != null ? lastEvent.getIsArrival() != null ? OnOffType.ON : OnOffType.OFF\n-                        : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toOnOffType(e.getIsArrival())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_MESSAGE:\n-                return lastEvent != null && lastEvent.getMessage() != null\n-                        ? new StringType(lastEvent.getMessage().replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n-                        : UnDefType.UNDEF;\n+                return findEventMessage().map(\n+                        m -> (State)new StringType(m.replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n+                ).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_SUBTYPE:\n-                return lastEvent != null ? toDecimalType(lastEvent.getSubType()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toDecimalType(e.getSubType())).orElse(UnDefType.UNDEF);\n         }\n         return super.getNAThingProperty(channelId);\n     }\n \n+    @Override\n+    protected void triggerChannelIfRequired(String channelId) {\n+        if(isNewLastEvent) {\n+            if(CHANNEL_CAMERA_EVENT.equals(channelId)) {\n+                Set<String> detectedObjectTypes = findDetectedObjectTypes(lastEvent);\n+                for(String detectedType: detectedObjectTypes) {\n+                    triggerChannel(channelId, detectedType);\n+                }\n+            }\n+        }\n+        super.triggerChannelIfRequired(channelId);\n+    }\n+\n+    private static Set<String> findDetectedObjectTypes(Optional<NAWelcomeEvent> eventOptional) {\n+        Set<String> detectedObjectTypes = new TreeSet<>();\n+        if(!eventOptional.isPresent()) {\n+            return detectedObjectTypes;\n+        }\n+\n+        NAWelcomeEvent event = eventOptional.get();\n+\n+        if(event.getPersonId() != null) {\n+            detectedObjectTypes.add(CAMERA_EVENT_OPTION_HUMAN_DETECTED);\n+        }\n+\n+        if(NAWebhookCameraEvent.EventTypeEnum.MOVEMENT.toString().equals(event.getType())) {", "originalCommit": "af5e3832003de7d2ed7763e76b2c9dda7ca6877d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5Mzc0NA==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436293744", "bodyText": "no, only MOVEMENT is available at EventTypeEnum. The others (human, animal and vehicle are at another enum). But I optimized the code a bit", "author": "Novanic", "createdAt": "2020-06-06T19:19:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3MTU4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3MTY0Mg==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436271642", "bodyText": "subEvents.forEach() would be better", "author": "clinique", "createdAt": "2020-06-06T14:05:33Z", "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java", "diffHunk": "@@ -97,96 +100,164 @@ protected NAWelcomeHome updateReadings() {\n     protected State getNAThingProperty(String channelId) {\n         switch (channelId) {\n             case CHANNEL_WELCOME_HOME_CITY:\n-                return device != null ? toStringType(device.getPlace().getCity()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getCity);\n             case CHANNEL_WELCOME_HOME_COUNTRY:\n-                return device != null ? toStringType(device.getPlace().getCountry()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getCountry);\n             case CHANNEL_WELCOME_HOME_TIMEZONE:\n-                return device != null ? toStringType(device.getPlace().getTimezone()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getTimezone);\n             case CHANNEL_WELCOME_HOME_PERSONCOUNT:\n                 return iPersons != -1 ? new DecimalType(iPersons) : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_HOME_UNKNOWNCOUNT:\n                 return iUnknowns != -1 ? new DecimalType(iUnknowns) : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_EVENT_TYPE:\n-                return lastEvent != null ? toStringType(lastEvent.getType()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toStringType(e.getType())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_TIME:\n-                return lastEvent != null ? toDateTimeType(lastEvent.getTime()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toDateTimeType(e.getTime())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_CAMERAID:\n-                if (lastEvent != null) {\n+                if (lastEvent.isPresent()) {\n                     Optional<AbstractNetatmoThingHandler> camera = getBridgeHandler()\n-                            .findNAThing(lastEvent.getCameraId());\n+                            .findNAThing(lastEvent.get().getCameraId());\n                     return camera.map(c -> toStringType(c.getThing().getLabel())).orElse(UnDefType.UNDEF);\n                 } else {\n                     return UnDefType.UNDEF;\n                 }\n             case CHANNEL_WELCOME_EVENT_PERSONID:\n-                if (lastEvent != null) {\n+                if (lastEvent.isPresent()) {\n                     Optional<AbstractNetatmoThingHandler> person = getBridgeHandler()\n-                            .findNAThing(lastEvent.getPersonId());\n+                            .findNAThing(lastEvent.get().getPersonId());\n                     return person.map(p -> toStringType(p.getThing().getLabel())).orElse(UnDefType.UNDEF);\n                 } else {\n                     return UnDefType.UNDEF;\n                 }\n             case CHANNEL_WELCOME_EVENT_SNAPSHOT:\n-                if (lastEvent != null) {\n-                    String url = getSnapshotURL(lastEvent.getSnapshot());\n-                    return url != null ? HttpUtil.downloadImage(url) : UnDefType.UNDEF;\n-                } else {\n-                    return UnDefType.UNDEF;\n-                }\n+                return findSnapshotURL().map(url -> (State)HttpUtil.downloadImage(url)).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_SNAPSHOT_URL:\n-                if (lastEvent != null) {\n-                    String snapshotURL = getSnapshotURL(lastEvent.getSnapshot());\n-                    return toStringType(snapshotURL);\n-                } else {\n-                    return UnDefType.UNDEF;\n-                }\n+                return findSnapshotURL().map(ChannelTypeUtils::toStringType).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_VIDEO_URL:\n-                if (lastEvent != null && lastEvent.getVideoId() != null) {\n-                    String cameraId = lastEvent.getCameraId();\n+                if (lastEvent.isPresent() && lastEvent.get().getVideoId() != null) {\n+                    String cameraId = lastEvent.get().getCameraId();\n                     Optional<AbstractNetatmoThingHandler> thing = getBridgeHandler().findNAThing(cameraId);\n                     if (thing.isPresent()) {\n                         NAWelcomeCameraHandler eventCamera = (NAWelcomeCameraHandler) thing.get();\n-                        String streamUrl = eventCamera.getStreamURL(lastEvent.getVideoId());\n+                        String streamUrl = eventCamera.getStreamURL(lastEvent.get().getVideoId());\n                         if (streamUrl != null) {\n                             return new StringType(streamUrl);\n                         }\n                     }\n                 }\n                 return UnDefType.UNDEF;\n             case CHANNEL_WELCOME_EVENT_VIDEOSTATUS:\n-                return lastEvent != null ? toStringType(lastEvent.getVideoStatus()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toStringType(e.getVideoStatus())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_ISARRIVAL:\n-                return lastEvent != null ? lastEvent.getIsArrival() != null ? OnOffType.ON : OnOffType.OFF\n-                        : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toOnOffType(e.getIsArrival())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_MESSAGE:\n-                return lastEvent != null && lastEvent.getMessage() != null\n-                        ? new StringType(lastEvent.getMessage().replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n-                        : UnDefType.UNDEF;\n+                return findEventMessage().map(\n+                        m -> (State)new StringType(m.replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n+                ).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_SUBTYPE:\n-                return lastEvent != null ? toDecimalType(lastEvent.getSubType()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toDecimalType(e.getSubType())).orElse(UnDefType.UNDEF);\n         }\n         return super.getNAThingProperty(channelId);\n     }\n \n+    @Override\n+    protected void triggerChannelIfRequired(String channelId) {\n+        if(isNewLastEvent) {\n+            if(CHANNEL_CAMERA_EVENT.equals(channelId)) {\n+                Set<String> detectedObjectTypes = findDetectedObjectTypes(lastEvent);\n+                for(String detectedType: detectedObjectTypes) {\n+                    triggerChannel(channelId, detectedType);\n+                }\n+            }\n+        }\n+        super.triggerChannelIfRequired(channelId);\n+    }\n+\n+    private static Set<String> findDetectedObjectTypes(Optional<NAWelcomeEvent> eventOptional) {\n+        Set<String> detectedObjectTypes = new TreeSet<>();\n+        if(!eventOptional.isPresent()) {\n+            return detectedObjectTypes;\n+        }\n+\n+        NAWelcomeEvent event = eventOptional.get();\n+\n+        if(event.getPersonId() != null) {\n+            detectedObjectTypes.add(CAMERA_EVENT_OPTION_HUMAN_DETECTED);\n+        }\n+\n+        if(NAWebhookCameraEvent.EventTypeEnum.MOVEMENT.toString().equals(event.getType())) {\n+            detectedObjectTypes.add(CAMERA_EVENT_OPTION_MOVEMENT_DETECTED);\n+        }\n+\n+        List<NAWelcomeSubEvent> subEvents = event.getEventList();\n+        for(NAWelcomeSubEvent subEvent: subEvents) {", "originalCommit": "af5e3832003de7d2ed7763e76b2c9dda7ca6877d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5Mzc1Nw==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436293757", "bodyText": "done", "author": "Novanic", "createdAt": "2020-06-06T19:19:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3MTY0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3MTcxMQ==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436271711", "bodyText": "Why not use directly the NAWelcomeSubEvent.TypeEnum ?", "author": "clinique", "createdAt": "2020-06-06T14:06:45Z", "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java", "diffHunk": "@@ -97,96 +100,164 @@ protected NAWelcomeHome updateReadings() {\n     protected State getNAThingProperty(String channelId) {\n         switch (channelId) {\n             case CHANNEL_WELCOME_HOME_CITY:\n-                return device != null ? toStringType(device.getPlace().getCity()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getCity);\n             case CHANNEL_WELCOME_HOME_COUNTRY:\n-                return device != null ? toStringType(device.getPlace().getCountry()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getCountry);\n             case CHANNEL_WELCOME_HOME_TIMEZONE:\n-                return device != null ? toStringType(device.getPlace().getTimezone()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getTimezone);\n             case CHANNEL_WELCOME_HOME_PERSONCOUNT:\n                 return iPersons != -1 ? new DecimalType(iPersons) : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_HOME_UNKNOWNCOUNT:\n                 return iUnknowns != -1 ? new DecimalType(iUnknowns) : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_EVENT_TYPE:\n-                return lastEvent != null ? toStringType(lastEvent.getType()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toStringType(e.getType())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_TIME:\n-                return lastEvent != null ? toDateTimeType(lastEvent.getTime()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toDateTimeType(e.getTime())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_CAMERAID:\n-                if (lastEvent != null) {\n+                if (lastEvent.isPresent()) {\n                     Optional<AbstractNetatmoThingHandler> camera = getBridgeHandler()\n-                            .findNAThing(lastEvent.getCameraId());\n+                            .findNAThing(lastEvent.get().getCameraId());\n                     return camera.map(c -> toStringType(c.getThing().getLabel())).orElse(UnDefType.UNDEF);\n                 } else {\n                     return UnDefType.UNDEF;\n                 }\n             case CHANNEL_WELCOME_EVENT_PERSONID:\n-                if (lastEvent != null) {\n+                if (lastEvent.isPresent()) {\n                     Optional<AbstractNetatmoThingHandler> person = getBridgeHandler()\n-                            .findNAThing(lastEvent.getPersonId());\n+                            .findNAThing(lastEvent.get().getPersonId());\n                     return person.map(p -> toStringType(p.getThing().getLabel())).orElse(UnDefType.UNDEF);\n                 } else {\n                     return UnDefType.UNDEF;\n                 }\n             case CHANNEL_WELCOME_EVENT_SNAPSHOT:\n-                if (lastEvent != null) {\n-                    String url = getSnapshotURL(lastEvent.getSnapshot());\n-                    return url != null ? HttpUtil.downloadImage(url) : UnDefType.UNDEF;\n-                } else {\n-                    return UnDefType.UNDEF;\n-                }\n+                return findSnapshotURL().map(url -> (State)HttpUtil.downloadImage(url)).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_SNAPSHOT_URL:\n-                if (lastEvent != null) {\n-                    String snapshotURL = getSnapshotURL(lastEvent.getSnapshot());\n-                    return toStringType(snapshotURL);\n-                } else {\n-                    return UnDefType.UNDEF;\n-                }\n+                return findSnapshotURL().map(ChannelTypeUtils::toStringType).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_VIDEO_URL:\n-                if (lastEvent != null && lastEvent.getVideoId() != null) {\n-                    String cameraId = lastEvent.getCameraId();\n+                if (lastEvent.isPresent() && lastEvent.get().getVideoId() != null) {\n+                    String cameraId = lastEvent.get().getCameraId();\n                     Optional<AbstractNetatmoThingHandler> thing = getBridgeHandler().findNAThing(cameraId);\n                     if (thing.isPresent()) {\n                         NAWelcomeCameraHandler eventCamera = (NAWelcomeCameraHandler) thing.get();\n-                        String streamUrl = eventCamera.getStreamURL(lastEvent.getVideoId());\n+                        String streamUrl = eventCamera.getStreamURL(lastEvent.get().getVideoId());\n                         if (streamUrl != null) {\n                             return new StringType(streamUrl);\n                         }\n                     }\n                 }\n                 return UnDefType.UNDEF;\n             case CHANNEL_WELCOME_EVENT_VIDEOSTATUS:\n-                return lastEvent != null ? toStringType(lastEvent.getVideoStatus()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toStringType(e.getVideoStatus())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_ISARRIVAL:\n-                return lastEvent != null ? lastEvent.getIsArrival() != null ? OnOffType.ON : OnOffType.OFF\n-                        : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toOnOffType(e.getIsArrival())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_MESSAGE:\n-                return lastEvent != null && lastEvent.getMessage() != null\n-                        ? new StringType(lastEvent.getMessage().replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n-                        : UnDefType.UNDEF;\n+                return findEventMessage().map(\n+                        m -> (State)new StringType(m.replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n+                ).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_SUBTYPE:\n-                return lastEvent != null ? toDecimalType(lastEvent.getSubType()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toDecimalType(e.getSubType())).orElse(UnDefType.UNDEF);\n         }\n         return super.getNAThingProperty(channelId);\n     }\n \n+    @Override\n+    protected void triggerChannelIfRequired(String channelId) {\n+        if(isNewLastEvent) {\n+            if(CHANNEL_CAMERA_EVENT.equals(channelId)) {\n+                Set<String> detectedObjectTypes = findDetectedObjectTypes(lastEvent);\n+                for(String detectedType: detectedObjectTypes) {\n+                    triggerChannel(channelId, detectedType);\n+                }\n+            }\n+        }\n+        super.triggerChannelIfRequired(channelId);\n+    }\n+\n+    private static Set<String> findDetectedObjectTypes(Optional<NAWelcomeEvent> eventOptional) {\n+        Set<String> detectedObjectTypes = new TreeSet<>();\n+        if(!eventOptional.isPresent()) {\n+            return detectedObjectTypes;\n+        }\n+\n+        NAWelcomeEvent event = eventOptional.get();\n+\n+        if(event.getPersonId() != null) {\n+            detectedObjectTypes.add(CAMERA_EVENT_OPTION_HUMAN_DETECTED);\n+        }\n+\n+        if(NAWebhookCameraEvent.EventTypeEnum.MOVEMENT.toString().equals(event.getType())) {\n+            detectedObjectTypes.add(CAMERA_EVENT_OPTION_MOVEMENT_DETECTED);\n+        }\n+\n+        List<NAWelcomeSubEvent> subEvents = event.getEventList();\n+        for(NAWelcomeSubEvent subEvent: subEvents) {\n+            String detectedObjectType = translateDetectedObjectType(subEvent.getType());\n+            detectedObjectTypes.add(detectedObjectType);\n+        }\n+        return detectedObjectTypes;\n+    }\n+\n+    private static String translateDetectedObjectType(NAWelcomeSubEvent.TypeEnum type) {\n+        switch (type) {", "originalCommit": "af5e3832003de7d2ed7763e76b2c9dda7ca6877d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5MDgzNw==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436290837", "bodyText": "yes, when the event option should be \"HUMAN_DETECTED\" instead of \"HUMAN\". But maybe \"HUMAN\" is sufficient, the welcomeHomeEvent has also an option named \"PERSON\" instead of \"PERSON_DETECTED\".\nOk, I will change that, that simplifies it.", "author": "Novanic", "createdAt": "2020-06-06T18:41:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3MTcxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5Mzc3Nw==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436293777", "bodyText": "done", "author": "Novanic", "createdAt": "2020-06-06T19:19:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3MTcxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3MTc1MA==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436271750", "bodyText": "space between if and '('", "author": "clinique", "createdAt": "2020-06-06T14:07:03Z", "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java", "diffHunk": "@@ -97,96 +100,164 @@ protected NAWelcomeHome updateReadings() {\n     protected State getNAThingProperty(String channelId) {\n         switch (channelId) {\n             case CHANNEL_WELCOME_HOME_CITY:\n-                return device != null ? toStringType(device.getPlace().getCity()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getCity);\n             case CHANNEL_WELCOME_HOME_COUNTRY:\n-                return device != null ? toStringType(device.getPlace().getCountry()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getCountry);\n             case CHANNEL_WELCOME_HOME_TIMEZONE:\n-                return device != null ? toStringType(device.getPlace().getTimezone()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getTimezone);\n             case CHANNEL_WELCOME_HOME_PERSONCOUNT:\n                 return iPersons != -1 ? new DecimalType(iPersons) : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_HOME_UNKNOWNCOUNT:\n                 return iUnknowns != -1 ? new DecimalType(iUnknowns) : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_EVENT_TYPE:\n-                return lastEvent != null ? toStringType(lastEvent.getType()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toStringType(e.getType())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_TIME:\n-                return lastEvent != null ? toDateTimeType(lastEvent.getTime()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toDateTimeType(e.getTime())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_CAMERAID:\n-                if (lastEvent != null) {\n+                if (lastEvent.isPresent()) {\n                     Optional<AbstractNetatmoThingHandler> camera = getBridgeHandler()\n-                            .findNAThing(lastEvent.getCameraId());\n+                            .findNAThing(lastEvent.get().getCameraId());\n                     return camera.map(c -> toStringType(c.getThing().getLabel())).orElse(UnDefType.UNDEF);\n                 } else {\n                     return UnDefType.UNDEF;\n                 }\n             case CHANNEL_WELCOME_EVENT_PERSONID:\n-                if (lastEvent != null) {\n+                if (lastEvent.isPresent()) {\n                     Optional<AbstractNetatmoThingHandler> person = getBridgeHandler()\n-                            .findNAThing(lastEvent.getPersonId());\n+                            .findNAThing(lastEvent.get().getPersonId());\n                     return person.map(p -> toStringType(p.getThing().getLabel())).orElse(UnDefType.UNDEF);\n                 } else {\n                     return UnDefType.UNDEF;\n                 }\n             case CHANNEL_WELCOME_EVENT_SNAPSHOT:\n-                if (lastEvent != null) {\n-                    String url = getSnapshotURL(lastEvent.getSnapshot());\n-                    return url != null ? HttpUtil.downloadImage(url) : UnDefType.UNDEF;\n-                } else {\n-                    return UnDefType.UNDEF;\n-                }\n+                return findSnapshotURL().map(url -> (State)HttpUtil.downloadImage(url)).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_SNAPSHOT_URL:\n-                if (lastEvent != null) {\n-                    String snapshotURL = getSnapshotURL(lastEvent.getSnapshot());\n-                    return toStringType(snapshotURL);\n-                } else {\n-                    return UnDefType.UNDEF;\n-                }\n+                return findSnapshotURL().map(ChannelTypeUtils::toStringType).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_VIDEO_URL:\n-                if (lastEvent != null && lastEvent.getVideoId() != null) {\n-                    String cameraId = lastEvent.getCameraId();\n+                if (lastEvent.isPresent() && lastEvent.get().getVideoId() != null) {\n+                    String cameraId = lastEvent.get().getCameraId();\n                     Optional<AbstractNetatmoThingHandler> thing = getBridgeHandler().findNAThing(cameraId);\n                     if (thing.isPresent()) {\n                         NAWelcomeCameraHandler eventCamera = (NAWelcomeCameraHandler) thing.get();\n-                        String streamUrl = eventCamera.getStreamURL(lastEvent.getVideoId());\n+                        String streamUrl = eventCamera.getStreamURL(lastEvent.get().getVideoId());\n                         if (streamUrl != null) {\n                             return new StringType(streamUrl);\n                         }\n                     }\n                 }\n                 return UnDefType.UNDEF;\n             case CHANNEL_WELCOME_EVENT_VIDEOSTATUS:\n-                return lastEvent != null ? toStringType(lastEvent.getVideoStatus()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toStringType(e.getVideoStatus())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_ISARRIVAL:\n-                return lastEvent != null ? lastEvent.getIsArrival() != null ? OnOffType.ON : OnOffType.OFF\n-                        : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toOnOffType(e.getIsArrival())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_MESSAGE:\n-                return lastEvent != null && lastEvent.getMessage() != null\n-                        ? new StringType(lastEvent.getMessage().replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n-                        : UnDefType.UNDEF;\n+                return findEventMessage().map(\n+                        m -> (State)new StringType(m.replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n+                ).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_SUBTYPE:\n-                return lastEvent != null ? toDecimalType(lastEvent.getSubType()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toDecimalType(e.getSubType())).orElse(UnDefType.UNDEF);\n         }\n         return super.getNAThingProperty(channelId);\n     }\n \n+    @Override\n+    protected void triggerChannelIfRequired(String channelId) {\n+        if(isNewLastEvent) {\n+            if(CHANNEL_CAMERA_EVENT.equals(channelId)) {\n+                Set<String> detectedObjectTypes = findDetectedObjectTypes(lastEvent);\n+                for(String detectedType: detectedObjectTypes) {\n+                    triggerChannel(channelId, detectedType);\n+                }\n+            }\n+        }\n+        super.triggerChannelIfRequired(channelId);\n+    }\n+\n+    private static Set<String> findDetectedObjectTypes(Optional<NAWelcomeEvent> eventOptional) {\n+        Set<String> detectedObjectTypes = new TreeSet<>();\n+        if(!eventOptional.isPresent()) {\n+            return detectedObjectTypes;\n+        }\n+\n+        NAWelcomeEvent event = eventOptional.get();\n+\n+        if(event.getPersonId() != null) {\n+            detectedObjectTypes.add(CAMERA_EVENT_OPTION_HUMAN_DETECTED);\n+        }\n+\n+        if(NAWebhookCameraEvent.EventTypeEnum.MOVEMENT.toString().equals(event.getType())) {\n+            detectedObjectTypes.add(CAMERA_EVENT_OPTION_MOVEMENT_DETECTED);\n+        }\n+\n+        List<NAWelcomeSubEvent> subEvents = event.getEventList();\n+        for(NAWelcomeSubEvent subEvent: subEvents) {\n+            String detectedObjectType = translateDetectedObjectType(subEvent.getType());\n+            detectedObjectTypes.add(detectedObjectType);\n+        }\n+        return detectedObjectTypes;\n+    }\n+\n+    private static String translateDetectedObjectType(NAWelcomeSubEvent.TypeEnum type) {\n+        switch (type) {\n+            case HUMAN: return CAMERA_EVENT_OPTION_HUMAN_DETECTED;\n+            case ANIMAL: return CAMERA_EVENT_OPTION_ANIMAL_DETECTED;\n+            case VEHICLE: return CAMERA_EVENT_OPTION_VEHICLE_DETECTED;\n+            default: throw new IllegalArgumentException(\"Unknown detected object type!\");\n+        }\n+    }\n+\n+    private Optional<String> findEventMessage() {\n+        if(lastEvent.isPresent()) {", "originalCommit": "af5e3832003de7d2ed7763e76b2c9dda7ca6877d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5Mzc4Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436293783", "bodyText": "done", "author": "Novanic", "createdAt": "2020-06-06T19:19:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3MTc1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3MTgwOQ==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436271809", "bodyText": "Is @nullable required here ?", "author": "clinique", "createdAt": "2020-06-06T14:07:46Z", "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java", "diffHunk": "@@ -97,96 +100,164 @@ protected NAWelcomeHome updateReadings() {\n     protected State getNAThingProperty(String channelId) {\n         switch (channelId) {\n             case CHANNEL_WELCOME_HOME_CITY:\n-                return device != null ? toStringType(device.getPlace().getCity()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getCity);\n             case CHANNEL_WELCOME_HOME_COUNTRY:\n-                return device != null ? toStringType(device.getPlace().getCountry()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getCountry);\n             case CHANNEL_WELCOME_HOME_TIMEZONE:\n-                return device != null ? toStringType(device.getPlace().getTimezone()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getTimezone);\n             case CHANNEL_WELCOME_HOME_PERSONCOUNT:\n                 return iPersons != -1 ? new DecimalType(iPersons) : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_HOME_UNKNOWNCOUNT:\n                 return iUnknowns != -1 ? new DecimalType(iUnknowns) : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_EVENT_TYPE:\n-                return lastEvent != null ? toStringType(lastEvent.getType()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toStringType(e.getType())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_TIME:\n-                return lastEvent != null ? toDateTimeType(lastEvent.getTime()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toDateTimeType(e.getTime())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_CAMERAID:\n-                if (lastEvent != null) {\n+                if (lastEvent.isPresent()) {\n                     Optional<AbstractNetatmoThingHandler> camera = getBridgeHandler()\n-                            .findNAThing(lastEvent.getCameraId());\n+                            .findNAThing(lastEvent.get().getCameraId());\n                     return camera.map(c -> toStringType(c.getThing().getLabel())).orElse(UnDefType.UNDEF);\n                 } else {\n                     return UnDefType.UNDEF;\n                 }\n             case CHANNEL_WELCOME_EVENT_PERSONID:\n-                if (lastEvent != null) {\n+                if (lastEvent.isPresent()) {\n                     Optional<AbstractNetatmoThingHandler> person = getBridgeHandler()\n-                            .findNAThing(lastEvent.getPersonId());\n+                            .findNAThing(lastEvent.get().getPersonId());\n                     return person.map(p -> toStringType(p.getThing().getLabel())).orElse(UnDefType.UNDEF);\n                 } else {\n                     return UnDefType.UNDEF;\n                 }\n             case CHANNEL_WELCOME_EVENT_SNAPSHOT:\n-                if (lastEvent != null) {\n-                    String url = getSnapshotURL(lastEvent.getSnapshot());\n-                    return url != null ? HttpUtil.downloadImage(url) : UnDefType.UNDEF;\n-                } else {\n-                    return UnDefType.UNDEF;\n-                }\n+                return findSnapshotURL().map(url -> (State)HttpUtil.downloadImage(url)).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_SNAPSHOT_URL:\n-                if (lastEvent != null) {\n-                    String snapshotURL = getSnapshotURL(lastEvent.getSnapshot());\n-                    return toStringType(snapshotURL);\n-                } else {\n-                    return UnDefType.UNDEF;\n-                }\n+                return findSnapshotURL().map(ChannelTypeUtils::toStringType).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_VIDEO_URL:\n-                if (lastEvent != null && lastEvent.getVideoId() != null) {\n-                    String cameraId = lastEvent.getCameraId();\n+                if (lastEvent.isPresent() && lastEvent.get().getVideoId() != null) {\n+                    String cameraId = lastEvent.get().getCameraId();\n                     Optional<AbstractNetatmoThingHandler> thing = getBridgeHandler().findNAThing(cameraId);\n                     if (thing.isPresent()) {\n                         NAWelcomeCameraHandler eventCamera = (NAWelcomeCameraHandler) thing.get();\n-                        String streamUrl = eventCamera.getStreamURL(lastEvent.getVideoId());\n+                        String streamUrl = eventCamera.getStreamURL(lastEvent.get().getVideoId());\n                         if (streamUrl != null) {\n                             return new StringType(streamUrl);\n                         }\n                     }\n                 }\n                 return UnDefType.UNDEF;\n             case CHANNEL_WELCOME_EVENT_VIDEOSTATUS:\n-                return lastEvent != null ? toStringType(lastEvent.getVideoStatus()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toStringType(e.getVideoStatus())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_ISARRIVAL:\n-                return lastEvent != null ? lastEvent.getIsArrival() != null ? OnOffType.ON : OnOffType.OFF\n-                        : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toOnOffType(e.getIsArrival())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_MESSAGE:\n-                return lastEvent != null && lastEvent.getMessage() != null\n-                        ? new StringType(lastEvent.getMessage().replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n-                        : UnDefType.UNDEF;\n+                return findEventMessage().map(\n+                        m -> (State)new StringType(m.replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n+                ).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_SUBTYPE:\n-                return lastEvent != null ? toDecimalType(lastEvent.getSubType()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toDecimalType(e.getSubType())).orElse(UnDefType.UNDEF);\n         }\n         return super.getNAThingProperty(channelId);\n     }\n \n+    @Override\n+    protected void triggerChannelIfRequired(String channelId) {\n+        if(isNewLastEvent) {\n+            if(CHANNEL_CAMERA_EVENT.equals(channelId)) {\n+                Set<String> detectedObjectTypes = findDetectedObjectTypes(lastEvent);\n+                for(String detectedType: detectedObjectTypes) {\n+                    triggerChannel(channelId, detectedType);\n+                }\n+            }\n+        }\n+        super.triggerChannelIfRequired(channelId);\n+    }\n+\n+    private static Set<String> findDetectedObjectTypes(Optional<NAWelcomeEvent> eventOptional) {\n+        Set<String> detectedObjectTypes = new TreeSet<>();\n+        if(!eventOptional.isPresent()) {\n+            return detectedObjectTypes;\n+        }\n+\n+        NAWelcomeEvent event = eventOptional.get();\n+\n+        if(event.getPersonId() != null) {\n+            detectedObjectTypes.add(CAMERA_EVENT_OPTION_HUMAN_DETECTED);\n+        }\n+\n+        if(NAWebhookCameraEvent.EventTypeEnum.MOVEMENT.toString().equals(event.getType())) {\n+            detectedObjectTypes.add(CAMERA_EVENT_OPTION_MOVEMENT_DETECTED);\n+        }\n+\n+        List<NAWelcomeSubEvent> subEvents = event.getEventList();\n+        for(NAWelcomeSubEvent subEvent: subEvents) {\n+            String detectedObjectType = translateDetectedObjectType(subEvent.getType());\n+            detectedObjectTypes.add(detectedObjectType);\n+        }\n+        return detectedObjectTypes;\n+    }\n+\n+    private static String translateDetectedObjectType(NAWelcomeSubEvent.TypeEnum type) {\n+        switch (type) {\n+            case HUMAN: return CAMERA_EVENT_OPTION_HUMAN_DETECTED;\n+            case ANIMAL: return CAMERA_EVENT_OPTION_ANIMAL_DETECTED;\n+            case VEHICLE: return CAMERA_EVENT_OPTION_VEHICLE_DETECTED;\n+            default: throw new IllegalArgumentException(\"Unknown detected object type!\");\n+        }\n+    }\n+\n+    private Optional<String> findEventMessage() {\n+        if(lastEvent.isPresent()) {\n+            @Nullable String message = lastEvent.get().getMessage();", "originalCommit": "af5e3832003de7d2ed7763e76b2c9dda7ca6877d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5MDYwMA==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436290600", "bodyText": "yes, the variable can be NULL (it is not NonNull)", "author": "Novanic", "createdAt": "2020-06-06T18:37:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3MTgwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3MTg2NA==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436271864", "bodyText": "space between if and '('", "author": "clinique", "createdAt": "2020-06-06T14:08:47Z", "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java", "diffHunk": "@@ -97,96 +100,164 @@ protected NAWelcomeHome updateReadings() {\n     protected State getNAThingProperty(String channelId) {\n         switch (channelId) {\n             case CHANNEL_WELCOME_HOME_CITY:\n-                return device != null ? toStringType(device.getPlace().getCity()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getCity);\n             case CHANNEL_WELCOME_HOME_COUNTRY:\n-                return device != null ? toStringType(device.getPlace().getCountry()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getCountry);\n             case CHANNEL_WELCOME_HOME_TIMEZONE:\n-                return device != null ? toStringType(device.getPlace().getTimezone()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getTimezone);\n             case CHANNEL_WELCOME_HOME_PERSONCOUNT:\n                 return iPersons != -1 ? new DecimalType(iPersons) : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_HOME_UNKNOWNCOUNT:\n                 return iUnknowns != -1 ? new DecimalType(iUnknowns) : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_EVENT_TYPE:\n-                return lastEvent != null ? toStringType(lastEvent.getType()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toStringType(e.getType())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_TIME:\n-                return lastEvent != null ? toDateTimeType(lastEvent.getTime()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toDateTimeType(e.getTime())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_CAMERAID:\n-                if (lastEvent != null) {\n+                if (lastEvent.isPresent()) {\n                     Optional<AbstractNetatmoThingHandler> camera = getBridgeHandler()\n-                            .findNAThing(lastEvent.getCameraId());\n+                            .findNAThing(lastEvent.get().getCameraId());\n                     return camera.map(c -> toStringType(c.getThing().getLabel())).orElse(UnDefType.UNDEF);\n                 } else {\n                     return UnDefType.UNDEF;\n                 }\n             case CHANNEL_WELCOME_EVENT_PERSONID:\n-                if (lastEvent != null) {\n+                if (lastEvent.isPresent()) {\n                     Optional<AbstractNetatmoThingHandler> person = getBridgeHandler()\n-                            .findNAThing(lastEvent.getPersonId());\n+                            .findNAThing(lastEvent.get().getPersonId());\n                     return person.map(p -> toStringType(p.getThing().getLabel())).orElse(UnDefType.UNDEF);\n                 } else {\n                     return UnDefType.UNDEF;\n                 }\n             case CHANNEL_WELCOME_EVENT_SNAPSHOT:\n-                if (lastEvent != null) {\n-                    String url = getSnapshotURL(lastEvent.getSnapshot());\n-                    return url != null ? HttpUtil.downloadImage(url) : UnDefType.UNDEF;\n-                } else {\n-                    return UnDefType.UNDEF;\n-                }\n+                return findSnapshotURL().map(url -> (State)HttpUtil.downloadImage(url)).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_SNAPSHOT_URL:\n-                if (lastEvent != null) {\n-                    String snapshotURL = getSnapshotURL(lastEvent.getSnapshot());\n-                    return toStringType(snapshotURL);\n-                } else {\n-                    return UnDefType.UNDEF;\n-                }\n+                return findSnapshotURL().map(ChannelTypeUtils::toStringType).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_VIDEO_URL:\n-                if (lastEvent != null && lastEvent.getVideoId() != null) {\n-                    String cameraId = lastEvent.getCameraId();\n+                if (lastEvent.isPresent() && lastEvent.get().getVideoId() != null) {\n+                    String cameraId = lastEvent.get().getCameraId();\n                     Optional<AbstractNetatmoThingHandler> thing = getBridgeHandler().findNAThing(cameraId);\n                     if (thing.isPresent()) {\n                         NAWelcomeCameraHandler eventCamera = (NAWelcomeCameraHandler) thing.get();\n-                        String streamUrl = eventCamera.getStreamURL(lastEvent.getVideoId());\n+                        String streamUrl = eventCamera.getStreamURL(lastEvent.get().getVideoId());\n                         if (streamUrl != null) {\n                             return new StringType(streamUrl);\n                         }\n                     }\n                 }\n                 return UnDefType.UNDEF;\n             case CHANNEL_WELCOME_EVENT_VIDEOSTATUS:\n-                return lastEvent != null ? toStringType(lastEvent.getVideoStatus()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toStringType(e.getVideoStatus())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_ISARRIVAL:\n-                return lastEvent != null ? lastEvent.getIsArrival() != null ? OnOffType.ON : OnOffType.OFF\n-                        : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toOnOffType(e.getIsArrival())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_MESSAGE:\n-                return lastEvent != null && lastEvent.getMessage() != null\n-                        ? new StringType(lastEvent.getMessage().replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n-                        : UnDefType.UNDEF;\n+                return findEventMessage().map(\n+                        m -> (State)new StringType(m.replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n+                ).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_SUBTYPE:\n-                return lastEvent != null ? toDecimalType(lastEvent.getSubType()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toDecimalType(e.getSubType())).orElse(UnDefType.UNDEF);\n         }\n         return super.getNAThingProperty(channelId);\n     }\n \n+    @Override\n+    protected void triggerChannelIfRequired(String channelId) {\n+        if(isNewLastEvent) {\n+            if(CHANNEL_CAMERA_EVENT.equals(channelId)) {\n+                Set<String> detectedObjectTypes = findDetectedObjectTypes(lastEvent);\n+                for(String detectedType: detectedObjectTypes) {\n+                    triggerChannel(channelId, detectedType);\n+                }\n+            }\n+        }\n+        super.triggerChannelIfRequired(channelId);\n+    }\n+\n+    private static Set<String> findDetectedObjectTypes(Optional<NAWelcomeEvent> eventOptional) {\n+        Set<String> detectedObjectTypes = new TreeSet<>();\n+        if(!eventOptional.isPresent()) {\n+            return detectedObjectTypes;\n+        }\n+\n+        NAWelcomeEvent event = eventOptional.get();\n+\n+        if(event.getPersonId() != null) {\n+            detectedObjectTypes.add(CAMERA_EVENT_OPTION_HUMAN_DETECTED);\n+        }\n+\n+        if(NAWebhookCameraEvent.EventTypeEnum.MOVEMENT.toString().equals(event.getType())) {\n+            detectedObjectTypes.add(CAMERA_EVENT_OPTION_MOVEMENT_DETECTED);\n+        }\n+\n+        List<NAWelcomeSubEvent> subEvents = event.getEventList();\n+        for(NAWelcomeSubEvent subEvent: subEvents) {\n+            String detectedObjectType = translateDetectedObjectType(subEvent.getType());\n+            detectedObjectTypes.add(detectedObjectType);\n+        }\n+        return detectedObjectTypes;\n+    }\n+\n+    private static String translateDetectedObjectType(NAWelcomeSubEvent.TypeEnum type) {\n+        switch (type) {\n+            case HUMAN: return CAMERA_EVENT_OPTION_HUMAN_DETECTED;\n+            case ANIMAL: return CAMERA_EVENT_OPTION_ANIMAL_DETECTED;\n+            case VEHICLE: return CAMERA_EVENT_OPTION_VEHICLE_DETECTED;\n+            default: throw new IllegalArgumentException(\"Unknown detected object type!\");\n+        }\n+    }\n+\n+    private Optional<String> findEventMessage() {\n+        if(lastEvent.isPresent()) {\n+            @Nullable String message = lastEvent.get().getMessage();\n+            if (message != null) {\n+                return Optional.of(message);\n+            }\n+\n+            return findFirstSubEvent(lastEvent).map(NAWelcomeSubEvent::getMessage);\n+        }\n+        return Optional.empty();\n+    }\n+\n     /**\n      * Returns the Url of the picture\n      *\n      * @return Url of the picture or null\n      */\n-    protected String getSnapshotURL(NAWelcomeSnapshot snapshot) {\n-        String result = null;\n-\n-        if (snapshot != null && snapshot.getId() != null && snapshot.getKey() != null) {\n-            result = WELCOME_PICTURE_URL + \"?\" + WELCOME_PICTURE_IMAGEID + \"=\" + snapshot.getId() + \"&\"\n-                    + WELCOME_PICTURE_KEY + \"=\" + snapshot.getKey();\n-        } else {\n-            logger.debug(\"Unable to build snapshot url for Home : {}\", getId());\n+    protected Optional<String> findSnapshotURL() {\n+        if(lastEvent.isPresent()) {", "originalCommit": "af5e3832003de7d2ed7763e76b2c9dda7ca6877d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5MzU5NQ==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436293595", "bodyText": "done", "author": "Novanic", "createdAt": "2020-06-06T19:17:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3MTg2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3MTg3NQ==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436271875", "bodyText": "Is nullable required ?", "author": "clinique", "createdAt": "2020-06-06T14:09:00Z", "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java", "diffHunk": "@@ -97,96 +100,164 @@ protected NAWelcomeHome updateReadings() {\n     protected State getNAThingProperty(String channelId) {\n         switch (channelId) {\n             case CHANNEL_WELCOME_HOME_CITY:\n-                return device != null ? toStringType(device.getPlace().getCity()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getCity);\n             case CHANNEL_WELCOME_HOME_COUNTRY:\n-                return device != null ? toStringType(device.getPlace().getCountry()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getCountry);\n             case CHANNEL_WELCOME_HOME_TIMEZONE:\n-                return device != null ? toStringType(device.getPlace().getTimezone()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getTimezone);\n             case CHANNEL_WELCOME_HOME_PERSONCOUNT:\n                 return iPersons != -1 ? new DecimalType(iPersons) : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_HOME_UNKNOWNCOUNT:\n                 return iUnknowns != -1 ? new DecimalType(iUnknowns) : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_EVENT_TYPE:\n-                return lastEvent != null ? toStringType(lastEvent.getType()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toStringType(e.getType())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_TIME:\n-                return lastEvent != null ? toDateTimeType(lastEvent.getTime()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toDateTimeType(e.getTime())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_CAMERAID:\n-                if (lastEvent != null) {\n+                if (lastEvent.isPresent()) {\n                     Optional<AbstractNetatmoThingHandler> camera = getBridgeHandler()\n-                            .findNAThing(lastEvent.getCameraId());\n+                            .findNAThing(lastEvent.get().getCameraId());\n                     return camera.map(c -> toStringType(c.getThing().getLabel())).orElse(UnDefType.UNDEF);\n                 } else {\n                     return UnDefType.UNDEF;\n                 }\n             case CHANNEL_WELCOME_EVENT_PERSONID:\n-                if (lastEvent != null) {\n+                if (lastEvent.isPresent()) {\n                     Optional<AbstractNetatmoThingHandler> person = getBridgeHandler()\n-                            .findNAThing(lastEvent.getPersonId());\n+                            .findNAThing(lastEvent.get().getPersonId());\n                     return person.map(p -> toStringType(p.getThing().getLabel())).orElse(UnDefType.UNDEF);\n                 } else {\n                     return UnDefType.UNDEF;\n                 }\n             case CHANNEL_WELCOME_EVENT_SNAPSHOT:\n-                if (lastEvent != null) {\n-                    String url = getSnapshotURL(lastEvent.getSnapshot());\n-                    return url != null ? HttpUtil.downloadImage(url) : UnDefType.UNDEF;\n-                } else {\n-                    return UnDefType.UNDEF;\n-                }\n+                return findSnapshotURL().map(url -> (State)HttpUtil.downloadImage(url)).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_SNAPSHOT_URL:\n-                if (lastEvent != null) {\n-                    String snapshotURL = getSnapshotURL(lastEvent.getSnapshot());\n-                    return toStringType(snapshotURL);\n-                } else {\n-                    return UnDefType.UNDEF;\n-                }\n+                return findSnapshotURL().map(ChannelTypeUtils::toStringType).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_VIDEO_URL:\n-                if (lastEvent != null && lastEvent.getVideoId() != null) {\n-                    String cameraId = lastEvent.getCameraId();\n+                if (lastEvent.isPresent() && lastEvent.get().getVideoId() != null) {\n+                    String cameraId = lastEvent.get().getCameraId();\n                     Optional<AbstractNetatmoThingHandler> thing = getBridgeHandler().findNAThing(cameraId);\n                     if (thing.isPresent()) {\n                         NAWelcomeCameraHandler eventCamera = (NAWelcomeCameraHandler) thing.get();\n-                        String streamUrl = eventCamera.getStreamURL(lastEvent.getVideoId());\n+                        String streamUrl = eventCamera.getStreamURL(lastEvent.get().getVideoId());\n                         if (streamUrl != null) {\n                             return new StringType(streamUrl);\n                         }\n                     }\n                 }\n                 return UnDefType.UNDEF;\n             case CHANNEL_WELCOME_EVENT_VIDEOSTATUS:\n-                return lastEvent != null ? toStringType(lastEvent.getVideoStatus()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toStringType(e.getVideoStatus())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_ISARRIVAL:\n-                return lastEvent != null ? lastEvent.getIsArrival() != null ? OnOffType.ON : OnOffType.OFF\n-                        : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toOnOffType(e.getIsArrival())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_MESSAGE:\n-                return lastEvent != null && lastEvent.getMessage() != null\n-                        ? new StringType(lastEvent.getMessage().replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n-                        : UnDefType.UNDEF;\n+                return findEventMessage().map(\n+                        m -> (State)new StringType(m.replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n+                ).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_SUBTYPE:\n-                return lastEvent != null ? toDecimalType(lastEvent.getSubType()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toDecimalType(e.getSubType())).orElse(UnDefType.UNDEF);\n         }\n         return super.getNAThingProperty(channelId);\n     }\n \n+    @Override\n+    protected void triggerChannelIfRequired(String channelId) {\n+        if(isNewLastEvent) {\n+            if(CHANNEL_CAMERA_EVENT.equals(channelId)) {\n+                Set<String> detectedObjectTypes = findDetectedObjectTypes(lastEvent);\n+                for(String detectedType: detectedObjectTypes) {\n+                    triggerChannel(channelId, detectedType);\n+                }\n+            }\n+        }\n+        super.triggerChannelIfRequired(channelId);\n+    }\n+\n+    private static Set<String> findDetectedObjectTypes(Optional<NAWelcomeEvent> eventOptional) {\n+        Set<String> detectedObjectTypes = new TreeSet<>();\n+        if(!eventOptional.isPresent()) {\n+            return detectedObjectTypes;\n+        }\n+\n+        NAWelcomeEvent event = eventOptional.get();\n+\n+        if(event.getPersonId() != null) {\n+            detectedObjectTypes.add(CAMERA_EVENT_OPTION_HUMAN_DETECTED);\n+        }\n+\n+        if(NAWebhookCameraEvent.EventTypeEnum.MOVEMENT.toString().equals(event.getType())) {\n+            detectedObjectTypes.add(CAMERA_EVENT_OPTION_MOVEMENT_DETECTED);\n+        }\n+\n+        List<NAWelcomeSubEvent> subEvents = event.getEventList();\n+        for(NAWelcomeSubEvent subEvent: subEvents) {\n+            String detectedObjectType = translateDetectedObjectType(subEvent.getType());\n+            detectedObjectTypes.add(detectedObjectType);\n+        }\n+        return detectedObjectTypes;\n+    }\n+\n+    private static String translateDetectedObjectType(NAWelcomeSubEvent.TypeEnum type) {\n+        switch (type) {\n+            case HUMAN: return CAMERA_EVENT_OPTION_HUMAN_DETECTED;\n+            case ANIMAL: return CAMERA_EVENT_OPTION_ANIMAL_DETECTED;\n+            case VEHICLE: return CAMERA_EVENT_OPTION_VEHICLE_DETECTED;\n+            default: throw new IllegalArgumentException(\"Unknown detected object type!\");\n+        }\n+    }\n+\n+    private Optional<String> findEventMessage() {\n+        if(lastEvent.isPresent()) {\n+            @Nullable String message = lastEvent.get().getMessage();\n+            if (message != null) {\n+                return Optional.of(message);\n+            }\n+\n+            return findFirstSubEvent(lastEvent).map(NAWelcomeSubEvent::getMessage);\n+        }\n+        return Optional.empty();\n+    }\n+\n     /**\n      * Returns the Url of the picture\n      *\n      * @return Url of the picture or null\n      */\n-    protected String getSnapshotURL(NAWelcomeSnapshot snapshot) {\n-        String result = null;\n-\n-        if (snapshot != null && snapshot.getId() != null && snapshot.getKey() != null) {\n-            result = WELCOME_PICTURE_URL + \"?\" + WELCOME_PICTURE_IMAGEID + \"=\" + snapshot.getId() + \"&\"\n-                    + WELCOME_PICTURE_KEY + \"=\" + snapshot.getKey();\n-        } else {\n-            logger.debug(\"Unable to build snapshot url for Home : {}\", getId());\n+    protected Optional<String> findSnapshotURL() {\n+        if(lastEvent.isPresent()) {\n+            @Nullable NAWelcomeSnapshot snapshot = lastEvent.get().getSnapshot();", "originalCommit": "af5e3832003de7d2ed7763e76b2c9dda7ca6877d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5MDUyNw==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436290527", "bodyText": "yes, otherwise this warning is shown: \"Expression 'findFirstSubEvent(lastEvent).map(NAWelcomeSubEvent::getSnapshot).orElse(null)' might evaluate to null but is assigned to a variable that is annotated with @NotNull\"", "author": "Novanic", "createdAt": "2020-06-06T18:36:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3MTg3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3MjAwOA==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436272008", "bodyText": "Can you change this to a StringBuilder or a String.format(\"....\") ?", "author": "clinique", "createdAt": "2020-06-06T14:10:42Z", "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java", "diffHunk": "@@ -97,96 +100,164 @@ protected NAWelcomeHome updateReadings() {\n     protected State getNAThingProperty(String channelId) {\n         switch (channelId) {\n             case CHANNEL_WELCOME_HOME_CITY:\n-                return device != null ? toStringType(device.getPlace().getCity()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getCity);\n             case CHANNEL_WELCOME_HOME_COUNTRY:\n-                return device != null ? toStringType(device.getPlace().getCountry()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getCountry);\n             case CHANNEL_WELCOME_HOME_TIMEZONE:\n-                return device != null ? toStringType(device.getPlace().getTimezone()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getTimezone);\n             case CHANNEL_WELCOME_HOME_PERSONCOUNT:\n                 return iPersons != -1 ? new DecimalType(iPersons) : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_HOME_UNKNOWNCOUNT:\n                 return iUnknowns != -1 ? new DecimalType(iUnknowns) : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_EVENT_TYPE:\n-                return lastEvent != null ? toStringType(lastEvent.getType()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toStringType(e.getType())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_TIME:\n-                return lastEvent != null ? toDateTimeType(lastEvent.getTime()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toDateTimeType(e.getTime())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_CAMERAID:\n-                if (lastEvent != null) {\n+                if (lastEvent.isPresent()) {\n                     Optional<AbstractNetatmoThingHandler> camera = getBridgeHandler()\n-                            .findNAThing(lastEvent.getCameraId());\n+                            .findNAThing(lastEvent.get().getCameraId());\n                     return camera.map(c -> toStringType(c.getThing().getLabel())).orElse(UnDefType.UNDEF);\n                 } else {\n                     return UnDefType.UNDEF;\n                 }\n             case CHANNEL_WELCOME_EVENT_PERSONID:\n-                if (lastEvent != null) {\n+                if (lastEvent.isPresent()) {\n                     Optional<AbstractNetatmoThingHandler> person = getBridgeHandler()\n-                            .findNAThing(lastEvent.getPersonId());\n+                            .findNAThing(lastEvent.get().getPersonId());\n                     return person.map(p -> toStringType(p.getThing().getLabel())).orElse(UnDefType.UNDEF);\n                 } else {\n                     return UnDefType.UNDEF;\n                 }\n             case CHANNEL_WELCOME_EVENT_SNAPSHOT:\n-                if (lastEvent != null) {\n-                    String url = getSnapshotURL(lastEvent.getSnapshot());\n-                    return url != null ? HttpUtil.downloadImage(url) : UnDefType.UNDEF;\n-                } else {\n-                    return UnDefType.UNDEF;\n-                }\n+                return findSnapshotURL().map(url -> (State)HttpUtil.downloadImage(url)).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_SNAPSHOT_URL:\n-                if (lastEvent != null) {\n-                    String snapshotURL = getSnapshotURL(lastEvent.getSnapshot());\n-                    return toStringType(snapshotURL);\n-                } else {\n-                    return UnDefType.UNDEF;\n-                }\n+                return findSnapshotURL().map(ChannelTypeUtils::toStringType).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_VIDEO_URL:\n-                if (lastEvent != null && lastEvent.getVideoId() != null) {\n-                    String cameraId = lastEvent.getCameraId();\n+                if (lastEvent.isPresent() && lastEvent.get().getVideoId() != null) {\n+                    String cameraId = lastEvent.get().getCameraId();\n                     Optional<AbstractNetatmoThingHandler> thing = getBridgeHandler().findNAThing(cameraId);\n                     if (thing.isPresent()) {\n                         NAWelcomeCameraHandler eventCamera = (NAWelcomeCameraHandler) thing.get();\n-                        String streamUrl = eventCamera.getStreamURL(lastEvent.getVideoId());\n+                        String streamUrl = eventCamera.getStreamURL(lastEvent.get().getVideoId());\n                         if (streamUrl != null) {\n                             return new StringType(streamUrl);\n                         }\n                     }\n                 }\n                 return UnDefType.UNDEF;\n             case CHANNEL_WELCOME_EVENT_VIDEOSTATUS:\n-                return lastEvent != null ? toStringType(lastEvent.getVideoStatus()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toStringType(e.getVideoStatus())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_ISARRIVAL:\n-                return lastEvent != null ? lastEvent.getIsArrival() != null ? OnOffType.ON : OnOffType.OFF\n-                        : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toOnOffType(e.getIsArrival())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_MESSAGE:\n-                return lastEvent != null && lastEvent.getMessage() != null\n-                        ? new StringType(lastEvent.getMessage().replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n-                        : UnDefType.UNDEF;\n+                return findEventMessage().map(\n+                        m -> (State)new StringType(m.replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n+                ).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_SUBTYPE:\n-                return lastEvent != null ? toDecimalType(lastEvent.getSubType()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toDecimalType(e.getSubType())).orElse(UnDefType.UNDEF);\n         }\n         return super.getNAThingProperty(channelId);\n     }\n \n+    @Override\n+    protected void triggerChannelIfRequired(String channelId) {\n+        if(isNewLastEvent) {\n+            if(CHANNEL_CAMERA_EVENT.equals(channelId)) {\n+                Set<String> detectedObjectTypes = findDetectedObjectTypes(lastEvent);\n+                for(String detectedType: detectedObjectTypes) {\n+                    triggerChannel(channelId, detectedType);\n+                }\n+            }\n+        }\n+        super.triggerChannelIfRequired(channelId);\n+    }\n+\n+    private static Set<String> findDetectedObjectTypes(Optional<NAWelcomeEvent> eventOptional) {\n+        Set<String> detectedObjectTypes = new TreeSet<>();\n+        if(!eventOptional.isPresent()) {\n+            return detectedObjectTypes;\n+        }\n+\n+        NAWelcomeEvent event = eventOptional.get();\n+\n+        if(event.getPersonId() != null) {\n+            detectedObjectTypes.add(CAMERA_EVENT_OPTION_HUMAN_DETECTED);\n+        }\n+\n+        if(NAWebhookCameraEvent.EventTypeEnum.MOVEMENT.toString().equals(event.getType())) {\n+            detectedObjectTypes.add(CAMERA_EVENT_OPTION_MOVEMENT_DETECTED);\n+        }\n+\n+        List<NAWelcomeSubEvent> subEvents = event.getEventList();\n+        for(NAWelcomeSubEvent subEvent: subEvents) {\n+            String detectedObjectType = translateDetectedObjectType(subEvent.getType());\n+            detectedObjectTypes.add(detectedObjectType);\n+        }\n+        return detectedObjectTypes;\n+    }\n+\n+    private static String translateDetectedObjectType(NAWelcomeSubEvent.TypeEnum type) {\n+        switch (type) {\n+            case HUMAN: return CAMERA_EVENT_OPTION_HUMAN_DETECTED;\n+            case ANIMAL: return CAMERA_EVENT_OPTION_ANIMAL_DETECTED;\n+            case VEHICLE: return CAMERA_EVENT_OPTION_VEHICLE_DETECTED;\n+            default: throw new IllegalArgumentException(\"Unknown detected object type!\");\n+        }\n+    }\n+\n+    private Optional<String> findEventMessage() {\n+        if(lastEvent.isPresent()) {\n+            @Nullable String message = lastEvent.get().getMessage();\n+            if (message != null) {\n+                return Optional.of(message);\n+            }\n+\n+            return findFirstSubEvent(lastEvent).map(NAWelcomeSubEvent::getMessage);\n+        }\n+        return Optional.empty();\n+    }\n+\n     /**\n      * Returns the Url of the picture\n      *\n      * @return Url of the picture or null\n      */\n-    protected String getSnapshotURL(NAWelcomeSnapshot snapshot) {\n-        String result = null;\n-\n-        if (snapshot != null && snapshot.getId() != null && snapshot.getKey() != null) {\n-            result = WELCOME_PICTURE_URL + \"?\" + WELCOME_PICTURE_IMAGEID + \"=\" + snapshot.getId() + \"&\"\n-                    + WELCOME_PICTURE_KEY + \"=\" + snapshot.getKey();\n-        } else {\n-            logger.debug(\"Unable to build snapshot url for Home : {}\", getId());\n+    protected Optional<String> findSnapshotURL() {\n+        if(lastEvent.isPresent()) {\n+            @Nullable NAWelcomeSnapshot snapshot = lastEvent.get().getSnapshot();\n+            if (snapshot == null) {\n+                snapshot = findFirstSubEvent(lastEvent).map(NAWelcomeSubEvent::getSnapshot).orElse(null);\n+            }\n+\n+            if (snapshot != null && snapshot.getId() != null && snapshot.getKey() != null) {\n+                return Optional.of(WELCOME_PICTURE_URL + \"?\" + WELCOME_PICTURE_IMAGEID + \"=\" + snapshot.getId() + \"&\"", "originalCommit": "af5e3832003de7d2ed7763e76b2c9dda7ca6877d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5MDI1Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436290253", "bodyText": "IntelliJ shows the warning \"'StringBuilder' can be replaced with 'String'\". I think to use StringBuilder isn't required anymore since Java 6, because the compiler optimizes it itself. It is more readable when the Strings are concat with \"+\" in this case (there are no conditions, just simple String concat).", "author": "Novanic", "createdAt": "2020-06-06T18:32:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3MjAwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5MDMwNw==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436290307", "bodyText": "It would look like this (+ linebreaks), but IntelliJ would show the warning, so I won't commit that:\n                return Optional.of(new StringBuilder() .append(WELCOME_PICTURE_URL) .append('?') .append(WELCOME_PICTURE_IMAGEID) .append('=') .append(snapshot.getId()) .append('&') .append(WELCOME_PICTURE_KEY) .append('=') .append(snapshot.getKey()) .toString());", "author": "Novanic", "createdAt": "2020-06-06T18:32:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3MjAwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3MjA3Nw==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436272077", "bodyText": "space between if and '('", "author": "clinique", "createdAt": "2020-06-06T14:11:53Z", "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java", "diffHunk": "@@ -97,96 +100,164 @@ protected NAWelcomeHome updateReadings() {\n     protected State getNAThingProperty(String channelId) {\n         switch (channelId) {\n             case CHANNEL_WELCOME_HOME_CITY:\n-                return device != null ? toStringType(device.getPlace().getCity()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getCity);\n             case CHANNEL_WELCOME_HOME_COUNTRY:\n-                return device != null ? toStringType(device.getPlace().getCountry()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getCountry);\n             case CHANNEL_WELCOME_HOME_TIMEZONE:\n-                return device != null ? toStringType(device.getPlace().getTimezone()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getTimezone);\n             case CHANNEL_WELCOME_HOME_PERSONCOUNT:\n                 return iPersons != -1 ? new DecimalType(iPersons) : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_HOME_UNKNOWNCOUNT:\n                 return iUnknowns != -1 ? new DecimalType(iUnknowns) : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_EVENT_TYPE:\n-                return lastEvent != null ? toStringType(lastEvent.getType()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toStringType(e.getType())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_TIME:\n-                return lastEvent != null ? toDateTimeType(lastEvent.getTime()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toDateTimeType(e.getTime())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_CAMERAID:\n-                if (lastEvent != null) {\n+                if (lastEvent.isPresent()) {\n                     Optional<AbstractNetatmoThingHandler> camera = getBridgeHandler()\n-                            .findNAThing(lastEvent.getCameraId());\n+                            .findNAThing(lastEvent.get().getCameraId());\n                     return camera.map(c -> toStringType(c.getThing().getLabel())).orElse(UnDefType.UNDEF);\n                 } else {\n                     return UnDefType.UNDEF;\n                 }\n             case CHANNEL_WELCOME_EVENT_PERSONID:\n-                if (lastEvent != null) {\n+                if (lastEvent.isPresent()) {\n                     Optional<AbstractNetatmoThingHandler> person = getBridgeHandler()\n-                            .findNAThing(lastEvent.getPersonId());\n+                            .findNAThing(lastEvent.get().getPersonId());\n                     return person.map(p -> toStringType(p.getThing().getLabel())).orElse(UnDefType.UNDEF);\n                 } else {\n                     return UnDefType.UNDEF;\n                 }\n             case CHANNEL_WELCOME_EVENT_SNAPSHOT:\n-                if (lastEvent != null) {\n-                    String url = getSnapshotURL(lastEvent.getSnapshot());\n-                    return url != null ? HttpUtil.downloadImage(url) : UnDefType.UNDEF;\n-                } else {\n-                    return UnDefType.UNDEF;\n-                }\n+                return findSnapshotURL().map(url -> (State)HttpUtil.downloadImage(url)).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_SNAPSHOT_URL:\n-                if (lastEvent != null) {\n-                    String snapshotURL = getSnapshotURL(lastEvent.getSnapshot());\n-                    return toStringType(snapshotURL);\n-                } else {\n-                    return UnDefType.UNDEF;\n-                }\n+                return findSnapshotURL().map(ChannelTypeUtils::toStringType).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_VIDEO_URL:\n-                if (lastEvent != null && lastEvent.getVideoId() != null) {\n-                    String cameraId = lastEvent.getCameraId();\n+                if (lastEvent.isPresent() && lastEvent.get().getVideoId() != null) {\n+                    String cameraId = lastEvent.get().getCameraId();\n                     Optional<AbstractNetatmoThingHandler> thing = getBridgeHandler().findNAThing(cameraId);\n                     if (thing.isPresent()) {\n                         NAWelcomeCameraHandler eventCamera = (NAWelcomeCameraHandler) thing.get();\n-                        String streamUrl = eventCamera.getStreamURL(lastEvent.getVideoId());\n+                        String streamUrl = eventCamera.getStreamURL(lastEvent.get().getVideoId());\n                         if (streamUrl != null) {\n                             return new StringType(streamUrl);\n                         }\n                     }\n                 }\n                 return UnDefType.UNDEF;\n             case CHANNEL_WELCOME_EVENT_VIDEOSTATUS:\n-                return lastEvent != null ? toStringType(lastEvent.getVideoStatus()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toStringType(e.getVideoStatus())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_ISARRIVAL:\n-                return lastEvent != null ? lastEvent.getIsArrival() != null ? OnOffType.ON : OnOffType.OFF\n-                        : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toOnOffType(e.getIsArrival())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_MESSAGE:\n-                return lastEvent != null && lastEvent.getMessage() != null\n-                        ? new StringType(lastEvent.getMessage().replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n-                        : UnDefType.UNDEF;\n+                return findEventMessage().map(\n+                        m -> (State)new StringType(m.replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n+                ).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_SUBTYPE:\n-                return lastEvent != null ? toDecimalType(lastEvent.getSubType()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toDecimalType(e.getSubType())).orElse(UnDefType.UNDEF);\n         }\n         return super.getNAThingProperty(channelId);\n     }\n \n+    @Override\n+    protected void triggerChannelIfRequired(String channelId) {\n+        if(isNewLastEvent) {\n+            if(CHANNEL_CAMERA_EVENT.equals(channelId)) {\n+                Set<String> detectedObjectTypes = findDetectedObjectTypes(lastEvent);\n+                for(String detectedType: detectedObjectTypes) {\n+                    triggerChannel(channelId, detectedType);\n+                }\n+            }\n+        }\n+        super.triggerChannelIfRequired(channelId);\n+    }\n+\n+    private static Set<String> findDetectedObjectTypes(Optional<NAWelcomeEvent> eventOptional) {\n+        Set<String> detectedObjectTypes = new TreeSet<>();\n+        if(!eventOptional.isPresent()) {\n+            return detectedObjectTypes;\n+        }\n+\n+        NAWelcomeEvent event = eventOptional.get();\n+\n+        if(event.getPersonId() != null) {\n+            detectedObjectTypes.add(CAMERA_EVENT_OPTION_HUMAN_DETECTED);\n+        }\n+\n+        if(NAWebhookCameraEvent.EventTypeEnum.MOVEMENT.toString().equals(event.getType())) {\n+            detectedObjectTypes.add(CAMERA_EVENT_OPTION_MOVEMENT_DETECTED);\n+        }\n+\n+        List<NAWelcomeSubEvent> subEvents = event.getEventList();\n+        for(NAWelcomeSubEvent subEvent: subEvents) {\n+            String detectedObjectType = translateDetectedObjectType(subEvent.getType());\n+            detectedObjectTypes.add(detectedObjectType);\n+        }\n+        return detectedObjectTypes;\n+    }\n+\n+    private static String translateDetectedObjectType(NAWelcomeSubEvent.TypeEnum type) {\n+        switch (type) {\n+            case HUMAN: return CAMERA_EVENT_OPTION_HUMAN_DETECTED;\n+            case ANIMAL: return CAMERA_EVENT_OPTION_ANIMAL_DETECTED;\n+            case VEHICLE: return CAMERA_EVENT_OPTION_VEHICLE_DETECTED;\n+            default: throw new IllegalArgumentException(\"Unknown detected object type!\");\n+        }\n+    }\n+\n+    private Optional<String> findEventMessage() {\n+        if(lastEvent.isPresent()) {\n+            @Nullable String message = lastEvent.get().getMessage();\n+            if (message != null) {\n+                return Optional.of(message);\n+            }\n+\n+            return findFirstSubEvent(lastEvent).map(NAWelcomeSubEvent::getMessage);\n+        }\n+        return Optional.empty();\n+    }\n+\n     /**\n      * Returns the Url of the picture\n      *\n      * @return Url of the picture or null\n      */\n-    protected String getSnapshotURL(NAWelcomeSnapshot snapshot) {\n-        String result = null;\n-\n-        if (snapshot != null && snapshot.getId() != null && snapshot.getKey() != null) {\n-            result = WELCOME_PICTURE_URL + \"?\" + WELCOME_PICTURE_IMAGEID + \"=\" + snapshot.getId() + \"&\"\n-                    + WELCOME_PICTURE_KEY + \"=\" + snapshot.getKey();\n-        } else {\n-            logger.debug(\"Unable to build snapshot url for Home : {}\", getId());\n+    protected Optional<String> findSnapshotURL() {\n+        if(lastEvent.isPresent()) {\n+            @Nullable NAWelcomeSnapshot snapshot = lastEvent.get().getSnapshot();\n+            if (snapshot == null) {\n+                snapshot = findFirstSubEvent(lastEvent).map(NAWelcomeSubEvent::getSnapshot).orElse(null);\n+            }\n+\n+            if (snapshot != null && snapshot.getId() != null && snapshot.getKey() != null) {\n+                return Optional.of(WELCOME_PICTURE_URL + \"?\" + WELCOME_PICTURE_IMAGEID + \"=\" + snapshot.getId() + \"&\"\n+                        + WELCOME_PICTURE_KEY + \"=\" + snapshot.getKey());\n+            } else {\n+                logger.debug(\"Unable to build snapshot url for Home : {}\", getId());\n+            }\n         }\n-        return result;\n+        return Optional.empty();\n     }\n \n     @Override\n     protected @Nullable Integer getDataTimestamp() {\n         return dataTimeStamp;\n     }\n+\n+    private State getPlaceInfo(Function<NAWelcomePlace, String> infoGetFunction) {\n+        return Optional.ofNullable(device).map(\n+                d -> toStringType(infoGetFunction.apply(d.getPlace()))\n+        ).orElse(UnDefType.UNDEF);\n+    }\n+\n+    private static Optional<NAWelcomeSubEvent> findFirstSubEvent(Optional<NAWelcomeEvent> event) {\n+        if(event.isPresent()) {", "originalCommit": "af5e3832003de7d2ed7763e76b2c9dda7ca6877d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5MzYyOA==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436293628", "bodyText": "done", "author": "Novanic", "createdAt": "2020-06-06T19:17:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI3MjA3Nw=="}], "type": "inlineReview"}, {"oid": "26c9dfd109de070a65ce5a49e450d2005353c323", "url": "https://github.com/openhab/openhab-addons/commit/26c9dfd109de070a65ce5a49e450d2005353c323", "message": "- Netatmo API updated (to support the sub-event structure which is used by the Presence events)\n- The message and snapshot data of the Presence events is now available at the home thing\n- New channels to the home thing added to report if a human, animal or vehicle was detected\n- Process of updating the Netatmo API simplified (the retrofit code generation is now embedded within the Maven build, therefore the netatmo-swagger-api project doesn't require an additional update and release anymore)\n\nSigned-off-by: Sven Strohschein <sven.strohschein@gmail.com>", "committedDate": "2020-06-06T19:16:15Z", "type": "commit"}, {"oid": "94e2511a7294028ca62cf48ebb9b9266b5216f80", "url": "https://github.com/openhab/openhab-addons/commit/94e2511a7294028ca62cf48ebb9b9266b5216f80", "message": "README extended for the Presence outdoor camera thing configuration example\n\nSigned-off-by: Sven Strohschein <sven.strohschein@gmail.com>", "committedDate": "2020-06-06T19:16:15Z", "type": "commit"}, {"oid": "c773af5c0d69de072a003276ae3d783968498711", "url": "https://github.com/openhab/openhab-addons/commit/c773af5c0d69de072a003276ae3d783968498711", "message": "NonNullByDefault is now used because it was mentioned in the code-review\n\nSigned-off-by: Sven Strohschein <sven.strohschein@gmail.com>", "committedDate": "2020-06-06T19:16:15Z", "type": "commit"}, {"oid": "c09fd2aee4ea15cafd96effa8ba3b5f5a4bed897", "url": "https://github.com/openhab/openhab-addons/commit/c09fd2aee4ea15cafd96effa8ba3b5f5a4bed897", "message": "NonNullByDefault is now used because it was mentioned in the code-review\n\nSigned-off-by: Sven Strohschein <sven.strohschein@gmail.com>", "committedDate": "2020-06-06T19:16:15Z", "type": "commit"}, {"oid": "7534b5eb22a35abc6dae178ab025095703b7bc9b", "url": "https://github.com/openhab/openhab-addons/commit/7534b5eb22a35abc6dae178ab025095703b7bc9b", "message": "The new 3 channels (for human, animal and vehicle detection) are now replaced by a trigger channel called \"cameraEvent\". Trigger channels are triggered after the other channels are updated (so a rule can react on a trigger and get the other event information from the other updated channels). Movement event option - A Presence camera reports also generic movements when a movement is not recognizable as a human, animal or vehicle.\n\nSigned-off-by: Sven Strohschein <sven.strohschein@gmail.com>", "committedDate": "2020-06-06T19:16:15Z", "type": "commit"}, {"oid": "ca146b7ac7e5ad1704933d94d5b16a2a98fc0e3f", "url": "https://github.com/openhab/openhab-addons/commit/ca146b7ac7e5ad1704933d94d5b16a2a98fc0e3f", "message": "Code optimization\n\nSigned-off-by: Sven Strohschein <sven.strohschein@gmail.com>", "committedDate": "2020-06-06T19:16:15Z", "type": "commit"}, {"oid": "2bd402f243e9d42871641ca2a560a67f96155226", "url": "https://github.com/openhab/openhab-addons/commit/2bd402f243e9d42871641ca2a560a67f96155226", "message": "Code optimization\n\nSigned-off-by: Sven Strohschein <sven.strohschein@gmail.com>", "committedDate": "2020-06-06T19:16:15Z", "type": "commit"}, {"oid": "5df268c1ab40e77b8c5e2068a43d9119bd553db1", "url": "https://github.com/openhab/openhab-addons/commit/5df268c1ab40e77b8c5e2068a43d9119bd553db1", "message": "Code optimization (usage of Optional to reduce @Nullable annotations)\n\nSigned-off-by: Sven Strohschein <sven.strohschein@gmail.com>", "committedDate": "2020-06-06T19:16:15Z", "type": "commit"}, {"oid": "813a0d6163353d8b4201426902bb8eedc1f5cbcf", "url": "https://github.com/openhab/openhab-addons/commit/813a0d6163353d8b4201426902bb8eedc1f5cbcf", "message": "Code optimization (channelId is now marked as NonNull)\n\nSigned-off-by: Sven Strohschein <sven.strohschein@gmail.com>", "committedDate": "2020-06-06T19:16:16Z", "type": "commit"}, {"oid": "324d35f783a9c307da6d83915b8da8d5ef6607bc", "url": "https://github.com/openhab/openhab-addons/commit/324d35f783a9c307da6d83915b8da8d5ef6607bc", "message": "Code optimization\n\nSigned-off-by: Sven Strohschein <sven.strohschein@gmail.com>", "committedDate": "2020-06-06T19:16:16Z", "type": "commit"}, {"oid": "1bfbeaa0f9cf528d96fbf4085778c39f3e831576", "url": "https://github.com/openhab/openhab-addons/commit/1bfbeaa0f9cf528d96fbf4085778c39f3e831576", "message": "Code optimization (usage of Optional to reduce @Nullable annotations)\n\nSigned-off-by: Sven Strohschein <sven.strohschein@gmail.com>", "committedDate": "2020-06-06T19:16:16Z", "type": "commit"}, {"oid": "40b86b9fdda025d3552f5d42996480e9a4379484", "url": "https://github.com/openhab/openhab-addons/commit/40b86b9fdda025d3552f5d42996480e9a4379484", "message": "Code optimization (usage of Optional to reduce @Nullable annotations)\n\nSigned-off-by: Sven Strohschein <sven.strohschein@gmail.com>", "committedDate": "2020-06-06T19:16:16Z", "type": "commit"}, {"oid": "806a75ac4b0f506cb8374fe66f6542abe2432432", "url": "https://github.com/openhab/openhab-addons/commit/806a75ac4b0f506cb8374fe66f6542abe2432432", "message": "Code optimization\n\nSigned-off-by: Sven Strohschein <sven.strohschein@gmail.com>", "committedDate": "2020-06-06T19:16:16Z", "type": "commit"}, {"oid": "66622c5fa36cc9913b5eb9c59c425852dbeb960c", "url": "https://github.com/openhab/openhab-addons/commit/66622c5fa36cc9913b5eb9c59c425852dbeb960c", "message": "\"_DETECTED\" removed from the event option names, that simplifies the code (mapping code could get removed)\n\nSigned-off-by: Sven Strohschein <sven.strohschein@gmail.com>", "committedDate": "2020-06-06T19:16:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMwMjIwOQ==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436302209", "bodyText": "This can be simplified to: lastEvent = result.getEvents().stream().min((e1, e2) -> e1.getTime() - e2.getTime());", "author": "cpmeister", "createdAt": "2020-06-06T21:32:10Z", "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java", "diffHunk": "@@ -83,11 +82,14 @@ protected NAWelcomeHome updateReadings() {\n                     }\n                 });\n \n+                Optional<NAWelcomeEvent> previousLastEvent = lastEvent;\n                 result.getEvents().forEach(event -> {\n-                    if (lastEvent == null || lastEvent.getTime() < event.getTime()) {\n-                        lastEvent = event;\n+                    if (!lastEvent.isPresent() || lastEvent.get().getTime() < event.getTime()) {\n+                        lastEvent = Optional.of(event);\n                     }\n                 });", "originalCommit": "66622c5fa36cc9913b5eb9c59c425852dbeb960c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMzODkyNw==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436338927", "bodyText": "done", "author": "Novanic", "createdAt": "2020-06-07T08:29:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMwMjIwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMwMjQzOQ==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436302439", "bodyText": "I think this should work.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (event.isPresent()) {\n          \n          \n            \n                        List<NAWelcomeSubEvent> subEvents = event.get().getEventList();\n          \n          \n            \n                        if (subEvents != null && !subEvents.isEmpty()) {\n          \n          \n            \n                            return Optional.of(subEvents.get(0));\n          \n          \n            \n                        }\n          \n          \n            \n                    }\n          \n          \n            \n                    return Optional.empty();\n          \n          \n            \n                    return event.map(NAWelcomeEvent::getEventList).flatMap(subEvents -> subEvents.stream().findFirst());", "author": "cpmeister", "createdAt": "2020-06-06T21:35:54Z", "path": "bundles/org.openhab.binding.netatmo/src/main/java/org/openhab/binding/netatmo/internal/welcome/NAWelcomeHomeHandler.java", "diffHunk": "@@ -97,96 +99,151 @@ protected NAWelcomeHome updateReadings() {\n     protected State getNAThingProperty(String channelId) {\n         switch (channelId) {\n             case CHANNEL_WELCOME_HOME_CITY:\n-                return device != null ? toStringType(device.getPlace().getCity()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getCity);\n             case CHANNEL_WELCOME_HOME_COUNTRY:\n-                return device != null ? toStringType(device.getPlace().getCountry()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getCountry);\n             case CHANNEL_WELCOME_HOME_TIMEZONE:\n-                return device != null ? toStringType(device.getPlace().getTimezone()) : UnDefType.UNDEF;\n+                return getPlaceInfo(NAWelcomePlace::getTimezone);\n             case CHANNEL_WELCOME_HOME_PERSONCOUNT:\n                 return iPersons != -1 ? new DecimalType(iPersons) : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_HOME_UNKNOWNCOUNT:\n                 return iUnknowns != -1 ? new DecimalType(iUnknowns) : UnDefType.UNDEF;\n             case CHANNEL_WELCOME_EVENT_TYPE:\n-                return lastEvent != null ? toStringType(lastEvent.getType()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toStringType(e.getType())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_TIME:\n-                return lastEvent != null ? toDateTimeType(lastEvent.getTime()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toDateTimeType(e.getTime())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_CAMERAID:\n-                if (lastEvent != null) {\n+                if (lastEvent.isPresent()) {\n                     Optional<AbstractNetatmoThingHandler> camera = getBridgeHandler()\n-                            .findNAThing(lastEvent.getCameraId());\n+                            .findNAThing(lastEvent.get().getCameraId());\n                     return camera.map(c -> toStringType(c.getThing().getLabel())).orElse(UnDefType.UNDEF);\n                 } else {\n                     return UnDefType.UNDEF;\n                 }\n             case CHANNEL_WELCOME_EVENT_PERSONID:\n-                if (lastEvent != null) {\n+                if (lastEvent.isPresent()) {\n                     Optional<AbstractNetatmoThingHandler> person = getBridgeHandler()\n-                            .findNAThing(lastEvent.getPersonId());\n+                            .findNAThing(lastEvent.get().getPersonId());\n                     return person.map(p -> toStringType(p.getThing().getLabel())).orElse(UnDefType.UNDEF);\n                 } else {\n                     return UnDefType.UNDEF;\n                 }\n             case CHANNEL_WELCOME_EVENT_SNAPSHOT:\n-                if (lastEvent != null) {\n-                    String url = getSnapshotURL(lastEvent.getSnapshot());\n-                    return url != null ? HttpUtil.downloadImage(url) : UnDefType.UNDEF;\n-                } else {\n-                    return UnDefType.UNDEF;\n-                }\n+                return findSnapshotURL().map(url -> (State)HttpUtil.downloadImage(url)).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_SNAPSHOT_URL:\n-                if (lastEvent != null) {\n-                    String snapshotURL = getSnapshotURL(lastEvent.getSnapshot());\n-                    return toStringType(snapshotURL);\n-                } else {\n-                    return UnDefType.UNDEF;\n-                }\n+                return findSnapshotURL().map(ChannelTypeUtils::toStringType).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_VIDEO_URL:\n-                if (lastEvent != null && lastEvent.getVideoId() != null) {\n-                    String cameraId = lastEvent.getCameraId();\n+                if (lastEvent.isPresent() && lastEvent.get().getVideoId() != null) {\n+                    String cameraId = lastEvent.get().getCameraId();\n                     Optional<AbstractNetatmoThingHandler> thing = getBridgeHandler().findNAThing(cameraId);\n                     if (thing.isPresent()) {\n                         NAWelcomeCameraHandler eventCamera = (NAWelcomeCameraHandler) thing.get();\n-                        String streamUrl = eventCamera.getStreamURL(lastEvent.getVideoId());\n+                        String streamUrl = eventCamera.getStreamURL(lastEvent.get().getVideoId());\n                         if (streamUrl != null) {\n                             return new StringType(streamUrl);\n                         }\n                     }\n                 }\n                 return UnDefType.UNDEF;\n             case CHANNEL_WELCOME_EVENT_VIDEOSTATUS:\n-                return lastEvent != null ? toStringType(lastEvent.getVideoStatus()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toStringType(e.getVideoStatus())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_ISARRIVAL:\n-                return lastEvent != null ? lastEvent.getIsArrival() != null ? OnOffType.ON : OnOffType.OFF\n-                        : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toOnOffType(e.getIsArrival())).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_MESSAGE:\n-                return lastEvent != null && lastEvent.getMessage() != null\n-                        ? new StringType(lastEvent.getMessage().replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n-                        : UnDefType.UNDEF;\n+                return findEventMessage().map(\n+                        m -> (State)new StringType(m.replace(\"<b>\", \"\").replace(\"</b>\", \"\"))\n+                ).orElse(UnDefType.UNDEF);\n             case CHANNEL_WELCOME_EVENT_SUBTYPE:\n-                return lastEvent != null ? toDecimalType(lastEvent.getSubType()) : UnDefType.UNDEF;\n+                return lastEvent.map(e -> toDecimalType(e.getSubType())).orElse(UnDefType.UNDEF);\n         }\n         return super.getNAThingProperty(channelId);\n     }\n \n+    @Override\n+    protected void triggerChannelIfRequired(String channelId) {\n+        if (isNewLastEvent) {\n+            if (CHANNEL_CAMERA_EVENT.equals(channelId)) {\n+                findDetectedObjectTypes(lastEvent).forEach(detectedType -> triggerChannel(channelId, detectedType));\n+            }\n+        }\n+        super.triggerChannelIfRequired(channelId);\n+    }\n+\n+    private static Set<String> findDetectedObjectTypes(Optional<NAWelcomeEvent> eventOptional) {\n+        Set<String> detectedObjectTypes = new TreeSet<>();\n+        if (!eventOptional.isPresent()) {\n+            return detectedObjectTypes;\n+        }\n+\n+        NAWelcomeEvent event = eventOptional.get();\n+\n+        if (event.getPersonId() != null) {\n+            detectedObjectTypes.add(NAWelcomeSubEvent.TypeEnum.HUMAN.name());\n+        }\n+\n+        if (NAWebhookCameraEvent.EventTypeEnum.MOVEMENT.toString().equals(event.getType())) {\n+            detectedObjectTypes.add(NAWebhookCameraEvent.EventTypeEnum.MOVEMENT.name());\n+        }\n+\n+        event.getEventList().forEach(subEvent -> {\n+            String detectedObjectType = subEvent.getType().name();\n+            detectedObjectTypes.add(detectedObjectType);\n+        });\n+        return detectedObjectTypes;\n+    }\n+\n+    private Optional<String> findEventMessage() {\n+        if (lastEvent.isPresent()) {\n+            @Nullable String message = lastEvent.get().getMessage();\n+            if (message != null) {\n+                return Optional.of(message);\n+            }\n+\n+            return findFirstSubEvent(lastEvent).map(NAWelcomeSubEvent::getMessage);\n+        }\n+        return Optional.empty();\n+    }\n+\n     /**\n      * Returns the Url of the picture\n      *\n      * @return Url of the picture or null\n      */\n-    protected String getSnapshotURL(NAWelcomeSnapshot snapshot) {\n-        String result = null;\n-\n-        if (snapshot != null && snapshot.getId() != null && snapshot.getKey() != null) {\n-            result = WELCOME_PICTURE_URL + \"?\" + WELCOME_PICTURE_IMAGEID + \"=\" + snapshot.getId() + \"&\"\n-                    + WELCOME_PICTURE_KEY + \"=\" + snapshot.getKey();\n-        } else {\n-            logger.debug(\"Unable to build snapshot url for Home : {}\", getId());\n+    protected Optional<String> findSnapshotURL() {\n+        if (lastEvent.isPresent()) {\n+            @Nullable NAWelcomeSnapshot snapshot = lastEvent.get().getSnapshot();\n+            if (snapshot == null) {\n+                snapshot = findFirstSubEvent(lastEvent).map(NAWelcomeSubEvent::getSnapshot).orElse(null);\n+            }\n+\n+            if (snapshot != null && snapshot.getId() != null && snapshot.getKey() != null) {\n+                return Optional.of(WELCOME_PICTURE_URL + \"?\" + WELCOME_PICTURE_IMAGEID + \"=\" + snapshot.getId() + \"&\"\n+                        + WELCOME_PICTURE_KEY + \"=\" + snapshot.getKey());\n+            } else {\n+                logger.debug(\"Unable to build snapshot url for Home : {}\", getId());\n+            }\n         }\n-        return result;\n+        return Optional.empty();\n     }\n \n     @Override\n     protected @Nullable Integer getDataTimestamp() {\n         return dataTimeStamp;\n     }\n+\n+    private State getPlaceInfo(Function<NAWelcomePlace, String> infoGetFunction) {\n+        return Optional.ofNullable(device).map(\n+                d -> toStringType(infoGetFunction.apply(d.getPlace()))\n+        ).orElse(UnDefType.UNDEF);\n+    }\n+\n+    private static Optional<NAWelcomeSubEvent> findFirstSubEvent(Optional<NAWelcomeEvent> event) {\n+        if (event.isPresent()) {\n+            List<NAWelcomeSubEvent> subEvents = event.get().getEventList();\n+            if (subEvents != null && !subEvents.isEmpty()) {\n+                return Optional.of(subEvents.get(0));\n+            }\n+        }\n+        return Optional.empty();", "originalCommit": "66622c5fa36cc9913b5eb9c59c425852dbeb960c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMzODkwMQ==", "url": "https://github.com/openhab/openhab-addons/pull/7807#discussion_r436338901", "bodyText": "done", "author": "Novanic", "createdAt": "2020-06-07T08:28:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMwMjQzOQ=="}], "type": "inlineReview"}, {"oid": "ac63b61774e73eb20c23ff6ed8198d77effce651", "url": "https://github.com/openhab/openhab-addons/commit/ac63b61774e73eb20c23ff6ed8198d77effce651", "message": "Code optimization\n\nSigned-off-by: Sven Strohschein <sven.strohschein@gmail.com>", "committedDate": "2020-06-07T08:28:07Z", "type": "commit"}]}