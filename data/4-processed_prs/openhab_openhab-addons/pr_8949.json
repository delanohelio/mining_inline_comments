{"pr_number": 8949, "pr_title": "[infrastructure] move infered nullness warnings to error and update EEA", "pr_createdAt": "2020-11-03T08:56:34Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/8949", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk1ODM0MQ==", "url": "https://github.com/openhab/openhab-addons/pull/8949#discussion_r516958341", "bodyText": "@wborn, do you think that having +inheritNullAnnot in -err AND -warn is correct? I would assume that it should be added only in one place.", "author": "J-N-K", "createdAt": "2020-11-03T21:12:31Z", "path": "pom.xml", "diffHunk": "@@ -289,8 +289,8 @@ Import-Package: \\\\\n               <classpath>${project.build.directory}/dependency</classpath>\n             </compilerArguments>\n             <compilerArgs>\n-              <arg>-err:+nullAnnot(org.eclipse.jdt.annotation.Nullable|org.eclipse.jdt.annotation.NonNull|org.eclipse.jdt.annotation.NonNullByDefault),+inheritNullAnnot,-nullUncheckedConversion</arg>\n-              <arg>-warn:+null,+inheritNullAnnot,+nullAnnotConflict,-nullUncheckedConversion,+nullAnnotRedundant,+nullDereference</arg>\n+              <arg>-err:+nullAnnot(org.eclipse.jdt.annotation.Nullable|org.eclipse.jdt.annotation.NonNull|org.eclipse.jdt.annotation.NonNullByDefault),+inheritNullAnnot,+nullAnnotConflict,-nullUncheckedConversion</arg>\n+              <arg>-warn:+null,+inheritNullAnnot,-nullUncheckedConversion,+nullAnnotRedundant,+nullDereference</arg>", "originalCommit": "920197757099f440f1f3569e5cf28821f4502203", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk2MDM4MQ==", "url": "https://github.com/openhab/openhab-addons/pull/8949#discussion_r516960381", "bodyText": "I also found it strange the errors arguments are also part of the warnings. But I didn't look into if there is also some kind of option where the compiler continues on errors but still logs these problems on warnings where such configuration might make sense. If this mode doesn't exist or not work this way I think they can be removed from the warnings. :-)", "author": "wborn", "createdAt": "2020-11-03T21:16:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk1ODM0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxMjkzOQ==", "url": "https://github.com/openhab/openhab-addons/pull/8949#discussion_r517612939", "bodyText": "What was wrong with this code that required this change?", "author": "cpmeister", "createdAt": "2020-11-04T20:29:42Z", "path": "bundles/org.openhab.binding.dsmr/src/main/java/org/openhab/binding/dsmr/internal/discovery/DSMRMeterDiscoveryService.java", "diffHunk": "@@ -148,8 +144,9 @@ private void validateConfiguredMeters(List<Thing> things, Set<DSMRMeterType> con\n                 .filter(DSMRMeterHandler.class::isInstance)\n                 .map(DSMRMeterHandler.class::cast)\n                 .map(h -> h == null ? null : h.getMeterDescriptor())\n-                .map(d -> d == null ? null : d.getMeterType())\n-                .filter(Objects::nonNull)\n+                .map(d -> Optional.ofNullable(d == null ? null : d.getMeterType()))\n+                .filter(Optional::isPresent)\n+                .map(Optional::get)", "originalCommit": "a02fe901828e0deb824feca2b1cb12490ee26d46", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyMzk5MQ==", "url": "https://github.com/openhab/openhab-addons/pull/8949#discussion_r517623991", "bodyText": "The null-checker is not able to detect that a Stream<@Nullable T> is converted to a Stream<@NonNull T> if .filter(Objects::nonNull) is applied.", "author": "J-N-K", "createdAt": "2020-11-04T20:51:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxMjkzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxNTA5Nw==", "url": "https://github.com/openhab/openhab-addons/pull/8949#discussion_r517615097", "bodyText": "I'd prefer to have the null checker disabled on testing classes than be required to add unnecessary checks like this in the test code.\n@wborn Can we just disable the null checker for test classes?", "author": "cpmeister", "createdAt": "2020-11-04T20:33:46Z", "path": "bundles/org.openhab.binding.foobot/src/test/java/org/openhab/binding/foobot/internal/handler/FoobotDeviceHandlerTest.java", "diffHunk": "@@ -53,6 +54,7 @@ public void testSensorDataToState() throws IOException, FoobotApiException {\n         final FoobotJsonData sensorData = connector.getSensorData(\"1234\");\n \n         assertNotNull(sensorData, \"No sensor data read\");\n+        Objects.requireNonNull(sensorData);", "originalCommit": "a02fe901828e0deb824feca2b1cb12490ee26d46", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyNjM1NQ==", "url": "https://github.com/openhab/openhab-addons/pull/8949#discussion_r517626355", "bodyText": "For me test code is not any different as any other code. It should be clean, spotless and NPE free.", "author": "wborn", "createdAt": "2020-11-04T20:56:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxNTA5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYzMDU2MA==", "url": "https://github.com/openhab/openhab-addons/pull/8949#discussion_r517630560", "bodyText": "I wonder if we annotate Mockito.assertNonNull the same as Objects.requireNonNull if that would work as well", "author": "J-N-K", "createdAt": "2020-11-04T21:04:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxNTA5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY2MDg0MA==", "url": "https://github.com/openhab/openhab-addons/pull/8949#discussion_r517660840", "bodyText": "I'd prefer to make the barriers to entry for testing as low as possible. The more requirements you add to test code the less test code people will write. Test code should not be held to the same standard as the regular code base other than readability and maintainability. I could care less about how robust testing code is.\nAlso the point of using a null checker is to prevent untested runtime errors. Any test code that runs successfully can be assumed to be NPE free (unless it is really poorly written).\nJust my 2 cents.", "author": "cpmeister", "createdAt": "2020-11-04T22:10:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxNTA5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkyNjcyNQ==", "url": "https://github.com/openhab/openhab-addons/pull/8949#discussion_r517926725", "bodyText": "Also the point of using a null checker is to prevent untested runtime errors. Any test code that runs successfully can be assumed to be NPE free (unless it is really poorly written).\n\nBased on timing due to server loads test code can also return null e.g. getService in itests. So tests can also behave differently at runtime. The null analysis triggers you to think about and investigate these possible null scenarios which makes tests more robust. As a result builds will less likely fail and contributors/maintainers have to spent less time debugging them and retriggering failing builds making them more happy. :-)", "author": "wborn", "createdAt": "2020-11-05T09:59:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxNTA5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk4NDk5Mw==", "url": "https://github.com/openhab/openhab-addons/pull/8949#discussion_r519984993", "bodyText": "Fair enough.", "author": "cpmeister", "createdAt": "2020-11-09T17:21:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxNTA5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxODMxOA==", "url": "https://github.com/openhab/openhab-addons/pull/8949#discussion_r517618318", "bodyText": "I'd try to avoid inline variable assignment if possible.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    String dimmerMax;\n          \n          \n            \n                    if (conf.getFeature().contains(\"dimmer\") && (dimmerMax = params.get(\"dimmermax\")) != null) {\n          \n          \n            \n                    String dimmerMax = params.get(\"dimmermax\");\n          \n          \n            \n                    if (conf.getFeature().contains(\"dimmer\") && dimmerMax != null) {", "author": "cpmeister", "createdAt": "2020-11-04T20:40:21Z", "path": "bundles/org.openhab.binding.insteon/src/main/java/org/openhab/binding/insteon/internal/device/CommandHandler.java", "diffHunk": "@@ -114,9 +114,9 @@ protected String nm() {\n \n     protected int getMaxLightLevel(InsteonChannelConfiguration conf, int defaultLevel) {\n         Map<String, @Nullable String> params = conf.getParameters();\n-        if (conf.getFeature().contains(\"dimmer\") && params.containsKey(\"dimmermax\")) {\n+        String dimmerMax;\n+        if (conf.getFeature().contains(\"dimmer\") && (dimmerMax = params.get(\"dimmermax\")) != null) {", "originalCommit": "a02fe901828e0deb824feca2b1cb12490ee26d46", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1fcf0fc1ad242e9776f41ed94cad994b4595ac17", "url": "https://github.com/openhab/openhab-addons/commit/1fcf0fc1ad242e9776f41ed94cad994b4595ac17", "message": "fixes\n\nSigned-off-by: Jan N. Klug <jan.n.klug@rub.de>", "committedDate": "2020-11-04T21:19:29Z", "type": "forcePushed"}, {"oid": "2a91a73293998756727badc31d6b85ee9eeab40d", "url": "https://github.com/openhab/openhab-addons/commit/2a91a73293998756727badc31d6b85ee9eeab40d", "message": "inferNullAnnot as error instead of warning\n\nSigned-off-by: Jan N. Klug <jan.n.klug@rub.de>", "committedDate": "2020-11-05T08:10:59Z", "type": "forcePushed"}, {"oid": "fe99c4f7d12b1896795aedea6535b89e2a5fd5af", "url": "https://github.com/openhab/openhab-addons/commit/fe99c4f7d12b1896795aedea6535b89e2a5fd5af", "message": "part 1\n\nSigned-off-by: Jan N. Klug <jan.n.klug@rub.de>", "committedDate": "2020-11-07T20:11:48Z", "type": "forcePushed"}, {"oid": "b4cd27d8b5dfc02784701c7c0ecb973e0333a5c9", "url": "https://github.com/openhab/openhab-addons/commit/b4cd27d8b5dfc02784701c7c0ecb973e0333a5c9", "message": "final fixes", "committedDate": "2020-11-09T18:27:25Z", "type": "forcePushed"}, {"oid": "417b10f58075a3180b2e43cc52a978343cd3e432", "url": "https://github.com/openhab/openhab-addons/commit/417b10f58075a3180b2e43cc52a978343cd3e432", "message": "inferNullAnnot as error instead of warning\n\nSigned-off-by: Jan N. Klug <jan.n.klug@rub.de>", "committedDate": "2020-11-09T18:47:37Z", "type": "forcePushed"}, {"oid": "f401015c197c96a1ce4c5dfb4e68cdd66fbb1daa", "url": "https://github.com/openhab/openhab-addons/commit/f401015c197c96a1ce4c5dfb4e68cdd66fbb1daa", "message": "inferNullAnnot as error instead of warning\n\nSigned-off-by: Jan N. Klug <jan.n.klug@rub.de>", "committedDate": "2020-11-12T11:24:22Z", "type": "commit"}, {"oid": "8d19e530c5a0594becc5be2e89e0c7dd68443164", "url": "https://github.com/openhab/openhab-addons/commit/8d19e530c5a0594becc5be2e89e0c7dd68443164", "message": "fix after rebase\n\nSigned-off-by: Jan N. Klug <jan.n.klug@rub.de>", "committedDate": "2020-11-12T11:24:23Z", "type": "commit"}, {"oid": "8d19e530c5a0594becc5be2e89e0c7dd68443164", "url": "https://github.com/openhab/openhab-addons/commit/8d19e530c5a0594becc5be2e89e0c7dd68443164", "message": "fix after rebase\n\nSigned-off-by: Jan N. Klug <jan.n.klug@rub.de>", "committedDate": "2020-11-12T11:24:23Z", "type": "forcePushed"}, {"oid": "e60fe4c36cc6a34e683bb215c382d2cc448d12a0", "url": "https://github.com/openhab/openhab-addons/commit/e60fe4c36cc6a34e683bb215c382d2cc448d12a0", "message": "fix\n\nSigned-off-by: Jan N. Klug <jan.n.klug@rub.de>", "committedDate": "2020-11-12T14:32:26Z", "type": "commit"}]}