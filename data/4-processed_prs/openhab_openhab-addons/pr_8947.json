{"pr_number": 8947, "pr_title": "[nest] Add support for Smart Device Management (SDM) API", "pr_createdAt": "2020-11-03T00:20:04Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/8947", "timeline": [{"oid": "1a85d83785e77c14ca466fe82cba36a6c6cbfa61", "url": "https://github.com/openhab/openhab-addons/commit/1a85d83785e77c14ca466fe82cba36a6c6cbfa61", "message": "Rework code so WWN and SDM are supported by existing binding\n\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2020-11-15T16:35:35Z", "type": "forcePushed"}, {"oid": "6b224b74d98f9f26efc16d6c8f44165681da6bc4", "url": "https://github.com/openhab/openhab-addons/commit/6b224b74d98f9f26efc16d6c8f44165681da6bc4", "message": "Rework code so WWN and SDM are supported by existing binding\n\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2020-11-16T21:23:11Z", "type": "forcePushed"}, {"oid": "1804d20ccad5f1885e46293095d737ef2b4b14b1", "url": "https://github.com/openhab/openhab-addons/commit/1804d20ccad5f1885e46293095d737ef2b4b14b1", "message": "Rework code so WWN and SDM are supported by existing binding\n\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2020-11-17T21:28:14Z", "type": "forcePushed"}, {"oid": "2d113e84817c8c61ca90277eb00df6c30c742c7c", "url": "https://github.com/openhab/openhab-addons/commit/2d113e84817c8c61ca90277eb00df6c30c742c7c", "message": "[nest] Add support for Smart Device Management (SDM) API\n\nPort nestdeviceaccess add-on to OH3 based on:\n\nhttps://github.com/bhigg-code/openhab-addons/tree/2.5.x/bundles/org.openhab.binding.nestdeviceaccess\n\nRework code so WWN and SDM are supported by existing binding\n\nFixes #8664\n\nAlso-by: Brian Higginbotham <brianhigginbothamtx@gmail.com>\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2020-11-29T22:12:49Z", "type": "forcePushed"}, {"oid": "e241a9a574c603ccb1ae294f317704116a997c69", "url": "https://github.com/openhab/openhab-addons/commit/e241a9a574c603ccb1ae294f317704116a997c69", "message": "[nest] Add support for Smart Device Management (SDM) API\n\nPort nestdeviceaccess add-on to OH3 based on:\n\nhttps://github.com/bhigg-code/openhab-addons/tree/2.5.x/bundles/org.openhab.binding.nestdeviceaccess\n\nRework code so WWN and SDM are supported by existing binding\n\nFixes #8664\n\nAlso-by: Brian Higginbotham <brianhigginbothamtx@gmail.com>\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2020-12-23T14:22:57Z", "type": "forcePushed"}, {"oid": "6723a3baeeba5a0045b54ab807e02b2575c8428d", "url": "https://github.com/openhab/openhab-addons/commit/6723a3baeeba5a0045b54ab807e02b2575c8428d", "message": "[nest] Add support for Smart Device Management (SDM) API\n\nPort nestdeviceaccess add-on to OH3 based on:\n\nhttps://github.com/bhigg-code/openhab-addons/tree/2.5.x/bundles/org.openhab.binding.nestdeviceaccess\n\nRework code so WWN and SDM are supported by existing binding\n\nFixes #8664\n\nAlso-by: Brian Higginbotham <brianhigginbothamtx@gmail.com>\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2021-01-10T20:40:49Z", "type": "forcePushed"}, {"oid": "8b401e71fc4463dc407299e62bb10c521985e01d", "url": "https://github.com/openhab/openhab-addons/commit/8b401e71fc4463dc407299e62bb10c521985e01d", "message": "[nest] Add support for Smart Device Management (SDM) API\n\nPort nestdeviceaccess add-on to OH3 based on:\n\nhttps://github.com/bhigg-code/openhab-addons/tree/2.5.x/bundles/org.openhab.binding.nestdeviceaccess\n\nRework code so WWN and SDM are supported by existing binding\n\nFixes #8664\n\nAlso-by: Brian Higginbotham <brianhigginbothamtx@gmail.com>\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2021-01-10T21:59:01Z", "type": "forcePushed"}, {"oid": "fa346c450512037d630d9b9ae202d9fe1f6fb726", "url": "https://github.com/openhab/openhab-addons/commit/fa346c450512037d630d9b9ae202d9fe1f6fb726", "message": "[nest] Add support for Smart Device Management (SDM) API\n\nPort nestdeviceaccess add-on to OH3 based on:\n\nhttps://github.com/bhigg-code/openhab-addons/tree/2.5.x/bundles/org.openhab.binding.nestdeviceaccess\n\nRework code so WWN and SDM are supported by existing binding\n\nFixes #8664\n\nAlso-by: Brian Higginbotham <brianhigginbothamtx@gmail.com>\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2021-01-23T13:01:14Z", "type": "forcePushed"}, {"oid": "65bb5004bef409fe598cd1dbcece1d35e8d233af", "url": "https://github.com/openhab/openhab-addons/commit/65bb5004bef409fe598cd1dbcece1d35e8d233af", "message": "[nest] Add support for Smart Device Management (SDM) API\n\nPort nestdeviceaccess add-on to OH3 based on:\n\nhttps://github.com/bhigg-code/openhab-addons/tree/2.5.x/bundles/org.openhab.binding.nestdeviceaccess\n\nRework code so WWN and SDM are supported by existing binding\n\nFixes #8664\n\nAlso-by: Brian Higginbotham <brianhigginbothamtx@gmail.com>\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2021-01-24T22:38:59Z", "type": "forcePushed"}, {"oid": "cfd39d6372f84095e8f4228c8b98c2f4021acb15", "url": "https://github.com/openhab/openhab-addons/commit/cfd39d6372f84095e8f4228c8b98c2f4021acb15", "message": "[nest] Add support for Smart Device Management (SDM) API\n\nPort nestdeviceaccess add-on to OH3 based on:\n\nhttps://github.com/bhigg-code/openhab-addons/tree/2.5.x/bundles/org.openhab.binding.nestdeviceaccess\n\nRework code so WWN and SDM are supported by existing binding\n\nFixes #8664\n\nAlso-by: Brian Higginbotham <brianhigginbothamtx@gmail.com>\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2021-02-01T23:21:39Z", "type": "forcePushed"}, {"oid": "bef9d3894718e1f369b4459fd48a619dc842f8aa", "url": "https://github.com/openhab/openhab-addons/commit/bef9d3894718e1f369b4459fd48a619dc842f8aa", "message": "[nest] Add support for Smart Device Management (SDM) API\n\nPort nestdeviceaccess add-on to OH3 based on:\n\nhttps://github.com/bhigg-code/openhab-addons/tree/2.5.x/bundles/org.openhab.binding.nestdeviceaccess\n\nRework code so WWN and SDM are supported by existing binding\n\nFixes #8664\n\nAlso-by: Brian Higginbotham <brianhigginbothamtx@gmail.com>\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2021-02-02T23:36:02Z", "type": "forcePushed"}, {"oid": "d719714f92e092ed06079c849b826d952c4b6c19", "url": "https://github.com/openhab/openhab-addons/commit/d719714f92e092ed06079c849b826d952c4b6c19", "message": "[nest] Add support for Smart Device Management (SDM) API\n\nPort nestdeviceaccess add-on to OH3 based on:\n\nhttps://github.com/bhigg-code/openhab-addons/tree/2.5.x/bundles/org.openhab.binding.nestdeviceaccess\n\nRework code so WWN and SDM are supported by existing binding\n\nFixes #8664\n\nAlso-by: Brian Higginbotham <brianhigginbothamtx@gmail.com>\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2021-02-03T22:13:36Z", "type": "forcePushed"}, {"oid": "95a9b0e617576b9df7586fb5f470f76e6b655c06", "url": "https://github.com/openhab/openhab-addons/commit/95a9b0e617576b9df7586fb5f470f76e6b655c06", "message": "[nest] Add support for Smart Device Management (SDM) API\n\nPort nestdeviceaccess add-on to OH3 based on:\n\nhttps://github.com/bhigg-code/openhab-addons/tree/2.5.x/bundles/org.openhab.binding.nestdeviceaccess\n\nRework code so WWN and SDM are supported by existing binding\n\nFixes #8664\n\nAlso-by: Brian Higginbotham <brianhigginbothamtx@gmail.com>\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2021-02-08T22:56:10Z", "type": "forcePushed"}, {"oid": "9d2e6d48d6cdfe8574bbefba11326affefb8b773", "url": "https://github.com/openhab/openhab-addons/commit/9d2e6d48d6cdfe8574bbefba11326affefb8b773", "message": "[nest] Add support for Smart Device Management (SDM) API\n\nPort nestdeviceaccess add-on to OH3 based on:\n\nhttps://github.com/bhigg-code/openhab-addons/tree/2.5.x/bundles/org.openhab.binding.nestdeviceaccess\n\nRework code so WWN and SDM are supported by existing binding\n\nFixes #8664\n\nAlso-by: Brian Higginbotham <brianhigginbothamtx@gmail.com>\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2021-02-20T22:09:14Z", "type": "forcePushed"}, {"oid": "e0aedda8d191cc2384af1fd51f422f72e2a38628", "url": "https://github.com/openhab/openhab-addons/commit/e0aedda8d191cc2384af1fd51f422f72e2a38628", "message": "[nest] Add support for Smart Device Management (SDM) API\n\nPort nestdeviceaccess add-on to OH3 based on:\n\nhttps://github.com/bhigg-code/openhab-addons/tree/2.5.x/bundles/org.openhab.binding.nestdeviceaccess\n\nRework code so WWN and SDM are supported by existing binding\n\nFixes #8664\n\nAlso-by: Brian Higginbotham <brianhigginbothamtx@gmail.com>\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2021-02-28T11:23:59Z", "type": "forcePushed"}, {"oid": "ae9c7370028e8965a1f21db1a8194a1fc0075caf", "url": "https://github.com/openhab/openhab-addons/commit/ae9c7370028e8965a1f21db1a8194a1fc0075caf", "message": "[nest] Add support for Smart Device Management (SDM) API\n\nPort nestdeviceaccess add-on to OH3 based on:\n\nhttps://github.com/bhigg-code/openhab-addons/tree/2.5.x/bundles/org.openhab.binding.nestdeviceaccess\n\nRework code so WWN and SDM are supported by existing binding\n\nFixes #8664\n\nAlso-by: Brian Higginbotham <brianhigginbothamtx@gmail.com>\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2021-03-03T19:43:53Z", "type": "forcePushed"}, {"oid": "64929949ab81db5b60fbbf4cb0e392d7b29e0c7f", "url": "https://github.com/openhab/openhab-addons/commit/64929949ab81db5b60fbbf4cb0e392d7b29e0c7f", "message": "[nest] Add support for Smart Device Management (SDM) API\n\nPort nestdeviceaccess add-on to OH3 based on:\n\nhttps://github.com/bhigg-code/openhab-addons/tree/2.5.x/bundles/org.openhab.binding.nestdeviceaccess\n\nRework code so WWN and SDM are supported by existing binding\n\nFixes #8664\n\nAlso-by: Brian Higginbotham <brianhigginbothamtx@gmail.com>\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2021-03-03T22:24:42Z", "type": "forcePushed"}, {"oid": "0bbc788f31fde1b94c236a51e1904aa6a77400bf", "url": "https://github.com/openhab/openhab-addons/commit/0bbc788f31fde1b94c236a51e1904aa6a77400bf", "message": "[nest] Add support for Smart Device Management (SDM) API\n\nPort nestdeviceaccess add-on to OH3 based on:\n\nhttps://github.com/bhigg-code/openhab-addons/tree/2.5.x/bundles/org.openhab.binding.nestdeviceaccess\n\nRework code so WWN and SDM are supported by existing binding\n\nFixes #8664\n\nAlso-by: Brian Higginbotham <brianhigginbothamtx@gmail.com>\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2021-03-04T19:49:52Z", "type": "forcePushed"}, {"oid": "1aecb8c46aaa78ccf0d0ff5296591dea3a01f0eb", "url": "https://github.com/openhab/openhab-addons/commit/1aecb8c46aaa78ccf0d0ff5296591dea3a01f0eb", "message": "[nest] Add support for Smart Device Management (SDM) API\n\nPort nestdeviceaccess add-on to OH3 based on:\n\nhttps://github.com/bhigg-code/openhab-addons/tree/2.5.x/bundles/org.openhab.binding.nestdeviceaccess\n\nRework code so WWN and SDM are supported by existing binding\n\nFixes #8664\n\nAlso-by: Brian Higginbotham <brianhigginbothamtx@gmail.com>\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2021-03-04T22:21:32Z", "type": "forcePushed"}, {"oid": "7df00a43327c281a0a9e3ea1f9e491f2810ddf97", "url": "https://github.com/openhab/openhab-addons/commit/7df00a43327c281a0a9e3ea1f9e491f2810ddf97", "message": "[nest] Add support for Smart Device Management (SDM) API\n\nPort nestdeviceaccess add-on to OH3 based on:\n\nhttps://github.com/bhigg-code/openhab-addons/tree/2.5.x/bundles/org.openhab.binding.nestdeviceaccess\n\nRework code so WWN and SDM are supported by existing binding\n\nFixes #8664\n\nAlso-by: Brian Higginbotham <brianhigginbothamtx@gmail.com>\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2021-04-01T10:33:34Z", "type": "forcePushed"}, {"oid": "4b72d2ff7f2506571d1d993ae2c9b2d2c02f0e22", "url": "https://github.com/openhab/openhab-addons/commit/4b72d2ff7f2506571d1d993ae2c9b2d2c02f0e22", "message": "[nest] Add support for Smart Device Management (SDM) API\n\nPort nestdeviceaccess add-on to OH3 based on:\n\nhttps://github.com/bhigg-code/openhab-addons/tree/2.5.x/bundles/org.openhab.binding.nestdeviceaccess\n\nRework code so WWN and SDM are supported by existing binding\n\nFixes #8664\n\nAlso-by: Brian Higginbotham <brianhigginbothamtx@gmail.com>\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2021-04-15T09:17:33Z", "type": "forcePushed"}, {"oid": "13f505784b30e1c93ad65efe3655dab3bc14cce3", "url": "https://github.com/openhab/openhab-addons/commit/13f505784b30e1c93ad65efe3655dab3bc14cce3", "message": "[nest] Add support for Smart Device Management (SDM) API\n\nPort nestdeviceaccess add-on to OH3 based on:\n\nhttps://github.com/bhigg-code/openhab-addons/tree/2.5.x/bundles/org.openhab.binding.nestdeviceaccess\n\nRework code so WWN and SDM are supported by existing binding\n\nFixes #8664\n\nAlso-by: Brian Higginbotham <brianhigginbothamtx@gmail.com>\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2021-05-04T22:56:15Z", "type": "forcePushed"}, {"oid": "2b3b3825f4467cb01af334402888ac9aa3194707", "url": "https://github.com/openhab/openhab-addons/commit/2b3b3825f4467cb01af334402888ac9aa3194707", "message": "[nest] Add support for Smart Device Management (SDM) API\n\nPort nestdeviceaccess add-on to OH3 based on:\n\nhttps://github.com/bhigg-code/openhab-addons/tree/2.5.x/bundles/org.openhab.binding.nestdeviceaccess\n\nRework code so WWN and SDM are supported by existing binding\n\nFixes #8664\n\nAlso-by: Brian Higginbotham <brianhigginbothamtx@gmail.com>\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2021-05-11T22:41:21Z", "type": "forcePushed"}, {"oid": "9ce5a88fec7d3d01175a8872bcd36deef598ab76", "url": "https://github.com/openhab/openhab-addons/commit/9ce5a88fec7d3d01175a8872bcd36deef598ab76", "message": "[nest] Add support for Smart Device Management (SDM) API\n\nPort nestdeviceaccess add-on to OH3 based on:\n\nhttps://github.com/bhigg-code/openhab-addons/tree/2.5.x/bundles/org.openhab.binding.nestdeviceaccess\n\nRework code so WWN and SDM are supported by existing binding\n\nFixes #8664\n\nAlso-by: Brian Higginbotham <brianhigginbothamtx@gmail.com>\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2021-05-22T09:19:05Z", "type": "forcePushed"}, {"oid": "0904f74e1c34bc753561fc4b9fb5a7f7d8e6c75b", "url": "https://github.com/openhab/openhab-addons/commit/0904f74e1c34bc753561fc4b9fb5a7f7d8e6c75b", "message": "[nest] Add support for Smart Device Management (SDM) API\n\nPort nestdeviceaccess add-on to OH3 based on:\n\nhttps://github.com/bhigg-code/openhab-addons/tree/2.5.x/bundles/org.openhab.binding.nestdeviceaccess\n\nRework code so WWN and SDM are supported by existing binding\n\nFixes #8664\n\nAlso-by: Brian Higginbotham <brianhigginbothamtx@gmail.com>\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2021-05-24T08:43:30Z", "type": "forcePushed"}, {"oid": "771154bdce6a084d453af6369e194e3b12c613c8", "url": "https://github.com/openhab/openhab-addons/commit/771154bdce6a084d453af6369e194e3b12c613c8", "message": "[nest] Add support for Smart Device Management (SDM) API\n\nPort nestdeviceaccess add-on to OH3 based on:\n\nhttps://github.com/bhigg-code/openhab-addons/tree/2.5.x/bundles/org.openhab.binding.nestdeviceaccess\n\nRework code so WWN and SDM are supported by existing binding\n\nFixes #8664\n\nAlso-by: Brian Higginbotham <brianhigginbothamtx@gmail.com>\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2021-05-24T23:37:50Z", "type": "forcePushed"}, {"oid": "00c17558b16211d363ed5d70cdc21b0898f0f740", "url": "https://github.com/openhab/openhab-addons/commit/00c17558b16211d363ed5d70cdc21b0898f0f740", "message": "[nest] Add support for Smart Device Management (SDM) API\n\nPort nestdeviceaccess add-on to OH3 based on:\n\nhttps://github.com/bhigg-code/openhab-addons/tree/2.5.x/bundles/org.openhab.binding.nestdeviceaccess\n\nRework code so WWN and SDM are supported by existing binding\n\nFixes #8664\n\nAlso-by: Brian Higginbotham <brianhigginbothamtx@gmail.com>\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2021-05-25T18:44:42Z", "type": "forcePushed"}, {"oid": "98ceb3a5926c0d6d51afcd82eabbbc84e32a1b63", "url": "https://github.com/openhab/openhab-addons/commit/98ceb3a5926c0d6d51afcd82eabbbc84e32a1b63", "message": "[nest] Add support for Smart Device Management (SDM) API\n\nPort nestdeviceaccess add-on to OH3 based on:\n\nhttps://github.com/bhigg-code/openhab-addons/tree/2.5.x/bundles/org.openhab.binding.nestdeviceaccess\n\nRework code so WWN and SDM are supported by existing binding\n\nFixes #8664\n\nAlso-by: Brian Higginbotham <brianhigginbothamtx@gmail.com>\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2021-05-25T21:57:02Z", "type": "forcePushed"}, {"oid": "8e2ada7753f6cee87e2526409e8e8e9b7eb767a5", "url": "https://github.com/openhab/openhab-addons/commit/8e2ada7753f6cee87e2526409e8e8e9b7eb767a5", "message": "[nest] Add support for Smart Device Management (SDM) API\n\n* Reworks WWN implementation so there the thing types have a wwn_ prefix and the classes have a WWN prefix and reside in a 'wwn' package\n* Adds an SDM implementation which is also based on: https://github.com/bhigg-code/openhab-addons/tree/2.5.x/bundles/org.openhab.binding.nestdeviceaccess\n* Adds unit tests for (de)serialization of the SDM and Pub/Sub API requests and responses\n* Updates the binding documentation for the changes and additions\n\nFixes #8664\n\nAlso-by: Brian Higginbotham <brianhigginbothamtx@gmail.com>\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2021-05-30T08:19:03Z", "type": "forcePushed"}, {"oid": "63d634c6318c4e3a0a23fa6489a040cf5d868bcf", "url": "https://github.com/openhab/openhab-addons/commit/63d634c6318c4e3a0a23fa6489a040cf5d868bcf", "message": "[nest] Add support for Smart Device Management (SDM) API\n\n* Reworks WWN implementation so that the thing types have a wwn_ prefix and the classes have a WWN prefix and reside in a 'wwn' package\n* Adds an SDM implementation which is also based on: https://github.com/bhigg-code/openhab-addons/tree/2.5.x/bundles/org.openhab.binding.nestdeviceaccess\n* Adds unit tests for (de)serialization of the SDM and Pub/Sub API requests and responses\n* Updates the binding documentation for the changes and additions\n\nFixes #8664\n\nAlso-by: Brian Higginbotham <brianhigginbothamtx@gmail.com>\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2021-05-30T08:23:35Z", "type": "commit"}, {"oid": "63d634c6318c4e3a0a23fa6489a040cf5d868bcf", "url": "https://github.com/openhab/openhab-addons/commit/63d634c6318c4e3a0a23fa6489a040cf5d868bcf", "message": "[nest] Add support for Smart Device Management (SDM) API\n\n* Reworks WWN implementation so that the thing types have a wwn_ prefix and the classes have a WWN prefix and reside in a 'wwn' package\n* Adds an SDM implementation which is also based on: https://github.com/bhigg-code/openhab-addons/tree/2.5.x/bundles/org.openhab.binding.nestdeviceaccess\n* Adds unit tests for (de)serialization of the SDM and Pub/Sub API requests and responses\n* Updates the binding documentation for the changes and additions\n\nFixes #8664\n\nAlso-by: Brian Higginbotham <brianhigginbothamtx@gmail.com>\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2021-05-30T08:23:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MjA5MTIwNw==", "url": "https://github.com/openhab/openhab-addons/pull/8947#discussion_r642091207", "bodyText": "Can you specify the encoding you expect? E.g. StandardCharsets.UTF_8", "author": "fwolter", "createdAt": "2021-05-30T15:20:17Z", "path": "bundles/org.openhab.binding.nest/src/main/java/org/openhab/binding/nest/internal/sdm/handler/SDMAccountHandler.java", "diffHunk": "@@ -0,0 +1,332 @@\n+/**\n+ * Copyright (c) 2010-2021 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.nest.internal.sdm.handler;\n+\n+import static java.util.function.Predicate.not;\n+import static org.openhab.binding.nest.internal.sdm.dto.SDMGson.GSON;\n+\n+import java.io.IOException;\n+import java.time.Duration;\n+import java.util.Base64;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.binding.nest.internal.sdm.api.PubSubAPI;\n+import org.openhab.binding.nest.internal.sdm.api.SDMAPI;\n+import org.openhab.binding.nest.internal.sdm.config.SDMAccountConfiguration;\n+import org.openhab.binding.nest.internal.sdm.discovery.SDMDiscoveryService;\n+import org.openhab.binding.nest.internal.sdm.dto.PubSubRequestsResponses.PubSubMessage;\n+import org.openhab.binding.nest.internal.sdm.dto.SDMEvent;\n+import org.openhab.binding.nest.internal.sdm.dto.SDMEvent.SDMResourceUpdate;\n+import org.openhab.binding.nest.internal.sdm.exception.FailedSendingPubSubDataException;\n+import org.openhab.binding.nest.internal.sdm.exception.FailedSendingSDMDataException;\n+import org.openhab.binding.nest.internal.sdm.exception.InvalidPubSubAccessTokenException;\n+import org.openhab.binding.nest.internal.sdm.exception.InvalidPubSubAuthorizationCodeException;\n+import org.openhab.binding.nest.internal.sdm.exception.InvalidSDMAccessTokenException;\n+import org.openhab.binding.nest.internal.sdm.exception.InvalidSDMAuthorizationCodeException;\n+import org.openhab.binding.nest.internal.sdm.listener.PubSubSubscriptionListener;\n+import org.openhab.binding.nest.internal.sdm.listener.SDMAPIRequestListener;\n+import org.openhab.binding.nest.internal.sdm.listener.SDMEventListener;\n+import org.openhab.core.auth.client.oauth2.OAuthFactory;\n+import org.openhab.core.config.core.Configuration;\n+import org.openhab.core.io.net.http.HttpClientFactory;\n+import org.openhab.core.thing.Bridge;\n+import org.openhab.core.thing.ChannelUID;\n+import org.openhab.core.thing.ThingStatus;\n+import org.openhab.core.thing.ThingStatusDetail;\n+import org.openhab.core.thing.binding.BaseBridgeHandler;\n+import org.openhab.core.thing.binding.ThingHandlerService;\n+import org.openhab.core.types.Command;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link SDMAccountHandler} provides the {@link SDMAPI} instance used by the device handlers.\n+ * The {@link SDMAPI} is used by device handlers for periodically refreshing device data and sending device commands.\n+ * When Pub/Sub is properly configured, the account handler also sends received {@link SDMEvent}s from the\n+ * {@link PubSubAPI} to the subscribed {@link SDMEventListener}s.\n+ *\n+ * @author Brian Higginbotham - Initial contribution\n+ * @author Wouter Born - Initial contribution\n+ */\n+@NonNullByDefault\n+public class SDMAccountHandler extends BaseBridgeHandler {\n+\n+    private static final String PUBSUB_TOPIC_NAME_PREFIX = \"projects/sdm-prod/topics/enterprise-\";\n+\n+    private final Logger logger = LoggerFactory.getLogger(SDMAccountHandler.class);\n+\n+    private HttpClientFactory httpClientFactory;\n+    private OAuthFactory oAuthFactory;\n+\n+    private @NonNullByDefault({}) SDMAccountConfiguration config;\n+    private @Nullable Future<?> initializeFuture;\n+\n+    private @Nullable PubSubAPI pubSubAPI;\n+    private @Nullable Exception pubSubException;\n+\n+    private @Nullable SDMAPI sdmAPI;\n+    private @Nullable Exception sdmException;\n+    private @Nullable Future<?> sdmCheckFuture;\n+    private final Duration sdmCheckDelay = Duration.ofMinutes(1);\n+\n+    private final Map<String, SDMEventListener> listeners = new ConcurrentHashMap<>();\n+\n+    private final SDMAPIRequestListener requestListener = new SDMAPIRequestListener() {\n+        @Override\n+        public void onError(Exception exception) {\n+            sdmException = exception;\n+            logger.debug(\"SDM exception occurred\");\n+            updateThingStatus();\n+\n+            Future<?> future = sdmCheckFuture;\n+            if (future == null || future.isDone()) {\n+                sdmCheckFuture = scheduler.scheduleWithFixedDelay(() -> {\n+                    SDMAPI localSDMAPI = sdmAPI;\n+                    if (localSDMAPI != null) {\n+                        try {\n+                            logger.debug(\"Checking SDM API\");\n+                            localSDMAPI.listDevices();\n+                        } catch (FailedSendingSDMDataException | InvalidSDMAccessTokenException e) {\n+                            logger.debug(\"SDM API check failed\");\n+                        }\n+                    }\n+                }, sdmCheckDelay.toNanos(), sdmCheckDelay.toNanos(), TimeUnit.NANOSECONDS);\n+                logger.debug(\"Scheduled SDM API check job\");\n+            }\n+        }\n+\n+        @Override\n+        public void onSuccess() {\n+            if (sdmException != null) {\n+                sdmException = null;\n+                logger.debug(\"SDM exception cleared\");\n+                updateThingStatus();\n+            }\n+\n+            Future<?> future = sdmCheckFuture;\n+            if (future != null) {\n+                future.cancel(true);\n+                sdmCheckFuture = null;\n+                logger.debug(\"Cancelled SDM API check job\");\n+            }\n+        }\n+    };\n+\n+    private final PubSubSubscriptionListener subscriptionListener = new PubSubSubscriptionListener() {\n+        @Override\n+        public void onError(Exception exception) {\n+            pubSubException = exception;\n+            logger.debug(\"Pub/Sub exception occurred\");\n+            updateThingStatus();\n+        }\n+\n+        @Override\n+        public void onMessage(PubSubMessage message) {\n+            if (pubSubException != null) {\n+                pubSubException = null;\n+                logger.debug(\"Pub/Sub exception cleared\");\n+                updateThingStatus();\n+            }\n+            handlePubSubMessage(message);\n+        }\n+\n+        @Override\n+        public void onNoNewMessages() {\n+            if (pubSubException != null) {\n+                pubSubException = null;\n+                logger.debug(\"Pub/Sub exception cleared\");\n+                updateThingStatus();\n+            }\n+        }\n+    };\n+\n+    public SDMAccountHandler(Bridge bridge, HttpClientFactory httpClientFactory, OAuthFactory oAuthFactory) {\n+        super(bridge);\n+        this.httpClientFactory = httpClientFactory;\n+        this.oAuthFactory = oAuthFactory;\n+    }\n+\n+    @Override\n+    public void handleCommand(ChannelUID channelUID, Command command) {\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        config = getConfigAs(SDMAccountConfiguration.class);\n+\n+        updateStatus(ThingStatus.UNKNOWN);\n+\n+        initializeFuture = scheduler.submit(() -> {\n+            sdmAPI = initializeSDMAPI();\n+            if (config.usePubSub()) {\n+                pubSubAPI = initializePubSubAPI();\n+            }\n+            updateThingStatus();\n+        });\n+    }\n+\n+    private @Nullable SDMAPI initializeSDMAPI() {\n+        SDMAPI sdmAPI = new SDMAPI(httpClientFactory, oAuthFactory, getThing().getUID().getAsString(),\n+                config.sdmProjectId, config.sdmClientId, config.sdmClientSecret);\n+        sdmException = null;\n+\n+        try {\n+            if (!config.sdmAuthorizationCode.isBlank()) {\n+                sdmAPI.authorizeClient(config.sdmAuthorizationCode);\n+\n+                Configuration configuration = editConfiguration();\n+                configuration.put(SDMAccountConfiguration.SDM_AUTHORIZATION_CODE, \"\");\n+                updateConfiguration(configuration);\n+            }\n+\n+            sdmAPI.checkAccessTokenValidity();\n+            sdmAPI.addRequestListener(requestListener);\n+\n+            return sdmAPI;\n+        } catch (InvalidSDMAccessTokenException | InvalidSDMAuthorizationCodeException | IOException e) {\n+            sdmException = e;\n+            return null;\n+        }\n+    }\n+\n+    private @Nullable PubSubAPI initializePubSubAPI() {\n+        PubSubAPI pubSubAPI = new PubSubAPI(httpClientFactory, oAuthFactory, getThing().getUID().getAsString(),\n+                config.pubsubProjectId, config.pubsubClientId, config.pubsubClientSecret);\n+        pubSubException = null;\n+\n+        try {\n+            if (!config.pubsubAuthorizationCode.isBlank()) {\n+                pubSubAPI.authorizeClient(config.pubsubAuthorizationCode);\n+\n+                Configuration configuration = editConfiguration();\n+                configuration.put(SDMAccountConfiguration.PUBSUB_AUTHORIZATION_CODE, \"\");\n+                updateConfiguration(configuration);\n+            }\n+\n+            pubSubAPI.checkAccessTokenValidity();\n+            pubSubAPI.createSubscription(config.pubsubSubscriptionId, PUBSUB_TOPIC_NAME_PREFIX + config.sdmProjectId);\n+            pubSubAPI.addSubscriptionListener(config.pubsubSubscriptionId, subscriptionListener);\n+\n+            return pubSubAPI;\n+        } catch (FailedSendingPubSubDataException | InvalidPubSubAccessTokenException\n+                | InvalidPubSubAuthorizationCodeException | IOException e) {\n+            pubSubException = e;\n+            return null;\n+        }\n+    }\n+\n+    @Override\n+    public void dispose() {\n+        Future<?> localFuture = initializeFuture;\n+        if (localFuture != null) {\n+            localFuture.cancel(true);\n+            initializeFuture = null;\n+        }\n+\n+        localFuture = sdmCheckFuture;\n+        if (localFuture != null) {\n+            localFuture.cancel(true);\n+            sdmCheckFuture = null;\n+        }\n+\n+        PubSubAPI localPubSubAPI = pubSubAPI;\n+        if (localPubSubAPI != null) {\n+            localPubSubAPI.dispose();\n+            pubSubAPI = null;\n+        }\n+\n+        SDMAPI localSDMAPI = sdmAPI;\n+        if (localSDMAPI != null) {\n+            localSDMAPI.dispose();\n+            sdmAPI = null;\n+        }\n+    }\n+\n+    @Override\n+    public Collection<Class<? extends ThingHandlerService>> getServices() {\n+        return List.of(SDMDiscoveryService.class);\n+    }\n+\n+    public void addThingDataListener(String deviceId, SDMEventListener listener) {\n+        listeners.put(deviceId, listener);\n+    }\n+\n+    public void removeThingDataListener(String deviceId, SDMEventListener listener) {\n+        listeners.remove(deviceId, listener);\n+    }\n+\n+    public @Nullable SDMAPI getAPI() {\n+        return sdmAPI;\n+    }\n+\n+    private void handlePubSubMessage(PubSubMessage message) {\n+        String messageId = message.messageId;\n+        String json = new String(Base64.getDecoder().decode(message.data));", "originalCommit": "63d634c6318c4e3a0a23fa6489a040cf5d868bcf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MjMwNDc3OA==", "url": "https://github.com/openhab/openhab-addons/pull/8947#discussion_r642304778", "bodyText": "Yes that's better. You never know what might happen on Windows. :-)", "author": "wborn", "createdAt": "2021-05-31T08:18:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MjA5MTIwNw=="}], "type": "inlineReview"}, {"oid": "ee410fe865fe9bd0759abe774acf7d944e8477ff", "url": "https://github.com/openhab/openhab-addons/commit/ee410fe865fe9bd0759abe774acf7d944e8477ff", "message": "Fix and improve documentation\n\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2021-05-30T15:49:02Z", "type": "commit"}, {"oid": "7c056e134e92b2282e6a934bf0cd36de73133b13", "url": "https://github.com/openhab/openhab-addons/commit/7c056e134e92b2282e6a934bf0cd36de73133b13", "message": "Always use UTF8 when decoding SDM events\n\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2021-05-31T08:17:01Z", "type": "commit"}]}