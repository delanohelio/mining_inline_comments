{"pr_number": 7659, "pr_title": "[shelly] Watchdog timer, new channel updateAvailable", "pr_createdAt": "2020-05-17T11:49:38Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/7659", "timeline": [{"oid": "e7d9d0c4b65f02e104507ea15687fcfeba0785af", "url": "https://github.com/openhab/openhab-addons/commit/e7d9d0c4b65f02e104507ea15687fcfeba0785af", "message": "#7275: Observe device availability, go OFFLINE when device does not\nrespond\n#7519: New channel device#updateAvailable (indicator for new firmware)\n#7654: Fix sensor channels are not created for Shelly Sense\n(confirmation open)\ndon't do an early-CoAP start for Shelly Sense (it's not battery powered)\n\nSigned-off-by: Markus Michels <markus7017@gmail.com>", "committedDate": "2020-05-17T11:38:50Z", "type": "commit"}, {"oid": "b220f88f70e1ada6cda6c7b19a920fcbb6723892", "url": "https://github.com/openhab/openhab-addons/commit/b220f88f70e1ada6cda6c7b19a920fcbb6723892", "message": "README updated\n\nSigned-off-by: Markus Michels <markus7017@gmail.com>", "committedDate": "2020-05-17T11:47:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMyMTY0Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7659#discussion_r426321643", "bodyText": "You seem to be using this to implement some kind of timeout. I wouldn't suggest using a StopWatch to accomplish this. A watchdog is typically implemented as a scheduled or periodic task. It also seems like you are using the watchdog for multiple purposes, both as an update timeout and to track the time between updates.\nThe watchdog should be single purpose otherwise you open yourself up to a lot of potential bugs.\nAnother issue is that your watchdog doesn't actually trigger anything on it's own, if the timeout expires nothing will happen until refreshStatus is called which unknown issues may prevent from happening in a timely manner. It might be better to implement your watchdog as a ScheduledFuture instead.", "author": "cpmeister", "createdAt": "2020-05-18T00:14:34Z", "path": "bundles/org.openhab.binding.shelly/src/main/java/org/openhab/binding/shelly/internal/handler/ShellyBaseHandler.java", "diffHunk": "@@ -90,6 +91,7 @@\n     private long lastUptime = 0;\n     private long lastAlarmTs = 0;\n     private long lastTimeoutErros = -1;\n+    private final StopWatch watchdog = new StopWatch();", "originalCommit": "b220f88f70e1ada6cda6c7b19a920fcbb6723892", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM3NjYwMQ==", "url": "https://github.com/openhab/openhab-addons/pull/7659#discussion_r426376601", "bodyText": "You seem to be using this to implement some kind of timeout. I wouldn't suggest using a StopWatch to accomplish this.  A watchdog is typically implemented as a scheduled or periodic task.\n\nexactly, that's the reason why watchdog is a StopWatch. I could rename the variable if that is clearer for you.\n\nIt also seems like you are using the watchdog for multiple purposes, both as an update timeout and to track the time between updates. The watchdog should be single purpose otherwise you open yourself up to a lot of potential bugs.\n\nI'm not ware of, where do you see this?\n\nAnother issue is that your watchdog doesn't actually trigger anything on it's own, if the timeout expires nothing will happen until refreshStatus is called which unknown issues may prevent from happening in a timely manner. It might be better to implement your watchdog as a ScheduledFuture instead.\n\nThere are good reasons why I implemented that way\n\nI want 1 central point of dealing with device timeouts - that's refreshStatus()\nThe device \"has a last chance\" to respond, this has a higher priority than setting it to OFFLINE, because of a timeout\nI don't want to have another periodic task to be synchronized - the watchdog affects the thing, that needs to be in sync\nThe watchdog is important to detect dead devices, but not critical, therefore it's ok it the condition gets processed somewhat later\n\nEven when thinking about it I still like the implementation. It's not invasive, users have confirmed that it works fine. As I said, I could rename the variable if this makes it clearer.", "author": "markus7017", "createdAt": "2020-05-18T05:27:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMyMTY0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM3ODU5MA==", "url": "https://github.com/openhab/openhab-addons/pull/7659#discussion_r426378590", "bodyText": "Well if you already took all my points into consideration already then I'm fine with leaving it as is.", "author": "cpmeister", "createdAt": "2020-05-18T05:36:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMyMTY0Mw=="}], "type": "inlineReview"}]}