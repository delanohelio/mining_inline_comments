{"pr_number": 6902, "pr_title": "[mqtt.generic] add trigger channel type", "pr_createdAt": "2020-01-25T17:48:58Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/6902", "timeline": [{"oid": "762abe943475351cc8a5c5d7c95d051f07629252", "url": "https://github.com/openhab/openhab-addons/commit/762abe943475351cc8a5c5d7c95d051f07629252", "message": "add possibility to make generic string/number channels triggers\n\nSigned-off-by: Jochen Klein <git@jochen.susca.de>", "committedDate": "2020-01-25T17:40:44Z", "type": "commit"}, {"oid": "472b60e2b1efab40d3a98f75dcebc0d2dd6906a7", "url": "https://github.com/openhab/openhab-addons/commit/472b60e2b1efab40d3a98f75dcebc0d2dd6906a7", "message": "witespace\n\nSigned-off-by: Jochen Klein <git@jochen.susca.de>", "committedDate": "2020-01-25T18:04:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk2MjYyMQ==", "url": "https://github.com/openhab/openhab-addons/pull/6902#discussion_r370962621", "bodyText": "I'm not sure if it make sense to treat a number channel as a trigger channel, because usually the number represent a state. Can you think about a use case in which a number doesn't reflect a state?", "author": "bodiroga", "createdAt": "2020-01-25T23:34:11Z", "path": "bundles/org.openhab.binding.mqtt.generic/src/main/resources/ESH-INF/config/number-channel-config.xml", "diffHunk": "@@ -102,5 +102,11 @@\n \t\t\t\tconverting incoming values (like from '\u00b0F' to '\u00b0C'). Examples: \"\u00b0C\", \"\u00b0F\"</description>\n \t\t\t<advanced>true</advanced>\n \t\t</parameter>\n+\t\t<parameter name=\"trigger\" type=\"boolean\">", "originalCommit": "472b60e2b1efab40d3a98f75dcebc0d2dd6906a7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAxNDA3OA==", "url": "https://github.com/openhab/openhab-addons/pull/6902#discussion_r371014078", "bodyText": "You are right.\nAfter thinking about it again, I made the trigger an own channel type.", "author": "jochen314", "createdAt": "2020-01-26T16:55:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk2MjYyMQ=="}], "type": "inlineReview"}, {"oid": "125b8ff4ee22c02fb06f447059f8ce9db0ac72a9", "url": "https://github.com/openhab/openhab-addons/commit/125b8ff4ee22c02fb06f447059f8ce9db0ac72a9", "message": "make trigger an own channel type\n\nSigned-off-by: Jochen Klein <git@jochen.susca.de>", "committedDate": "2020-01-26T16:54:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1NDM5OQ==", "url": "https://github.com/openhab/openhab-addons/pull/6902#discussion_r371654399", "bodyText": "A transformation doesn't make sense for a trigger", "author": "davidgraeff", "createdAt": "2020-01-28T08:08:45Z", "path": "bundles/org.openhab.binding.mqtt.generic/src/main/resources/ESH-INF/config/trigger-channel-config.xml", "diffHunk": "@@ -0,0 +1,31 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<config-description:config-descriptions\n+\txmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+\txmlns:config-description=\"https://openhab.org/schemas/config-description/v1.0.0\"\n+\txsi:schemaLocation=\"https://openhab.org/schemas/config-description/v1.0.0 https://openhab.org/schemas/config-description-1.0.0.xsd\">\n+\n+\t<config-description uri=\"thing-type:mqtt:trigger_channel\">\n+\t\t<parameter-group name=\"transformations\">\n+\t\t\t<label>Transform Values</label>\n+\t\t\t<description>These configuration parameters allow you to alter a value before it is published to MQTT or before a\n+\t\t\t\treceived value is used in the trigger.</description>\n+\t\t\t<advanced>true</advanced>\n+\t\t</parameter-group>\n+\n+\t\t<parameter name=\"stateTopic\" type=\"text\" required=\"true\">\n+\t\t\t<label>MQTT Trigger Topic</label>\n+\t\t\t<description>An MQTT topic that this thing will subscribe to, to receive the trigger</description>\n+\t\t</parameter>\n+\t\t<parameter name=\"transformationPattern\" type=\"text\" groupName=\"transformations\">", "originalCommit": "125b8ff4ee22c02fb06f447059f8ce9db0ac72a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjAyNTUyNQ==", "url": "https://github.com/openhab/openhab-addons/pull/6902#discussion_r372025525", "bodyText": "Why not?\nThe incoming transformations are apply before trigger is executed.\nSo one might want to map the incomming values of filter them using REGEX.", "author": "jochen314", "createdAt": "2020-01-28T20:00:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1NDM5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE5MDQyMA==", "url": "https://github.com/openhab/openhab-addons/pull/6902#discussion_r373190420", "bodyText": "Triggers don't have a value, there should only be a discrete set of trigger events. Using JSON and transforming it both seems very wrong here.", "author": "kaikreuzer", "createdAt": "2020-01-30T20:59:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1NDM5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIxMTk3MQ==", "url": "https://github.com/openhab/openhab-addons/pull/6902#discussion_r373211971", "bodyText": "Well, the idea would be, that the device sends different values for the different events of the trigger.\nAnd then it might very well be good to be able to MAP the values sent by the device to more 'standard' ones used be your rules.", "author": "jochen314", "createdAt": "2020-01-30T21:49:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1NDM5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc4NDMwMA==", "url": "https://github.com/openhab/openhab-addons/pull/6902#discussion_r376784300", "bodyText": "I tend to agree with @davidgraeff and @kaikreuzer. The idea of the payload is IMO is not to transport information recevived from the device but to present pre-defined values to the receiver.\nE.g. an alarm system could send ARMED or DISARMED as payload, so a notification can be send. for MQTT it would be more \"a value has been received\". If you are interested in the value itself, a state channel with changed in the rules should be used.", "author": "J-N-K", "createdAt": "2020-02-09T13:33:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1NDM5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc4NTk4OQ==", "url": "https://github.com/openhab/openhab-addons/pull/6902#discussion_r376785989", "bodyText": "Just so I understand you right:\nIf a device sends the value fired on different topics (e.g. ../trigger/armed or ../trigger/disarmed) then it would be ok to map it to an OH trigger.\nIf the device sends different values (e.g. armed, disarmed) on a single topic ../trigger then it is not ok to handle this as an OH trigger.\nThat does not resonate with me.\nAnd how is reaching out to zigbee and convinces them that they are doing it in a bad way ;-)", "author": "jochen314", "createdAt": "2020-02-09T13:55:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1NDM5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDgxMTg2Mw==", "url": "https://github.com/openhab/openhab-addons/pull/6902#discussion_r380811863", "bodyText": "I think the difference is: are these values pre-defined by the binding (like armed, disarmed in the case of the alarm system) or arbitrary values (like a temperature)?", "author": "J-N-K", "createdAt": "2020-02-18T17:08:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1NDM5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDkyNzU4OA==", "url": "https://github.com/openhab/openhab-addons/pull/6902#discussion_r380927588", "bodyText": "Yes, but this here would be the place to do the pre-defining, right?\nThen we should require a list of text values, which define the trigger options.\nAnd we would need to check for any of the defined values before we activate the trigger.\nBTW, this is also not done for the triggers created currently by homie. There we use just any property, which is sent as not retained to create a trigger.", "author": "jochen314", "createdAt": "2020-02-18T20:51:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1NDM5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAzMzk1OA==", "url": "https://github.com/openhab/openhab-addons/pull/6902#discussion_r386033958", "bodyText": "So you say the transformation should be used to reduce the number of values (e.g. 0-10 = LOW, 11-15 = OK, 16-= HIGH)? That makes sense. @kaikreuzer, WDYT?", "author": "J-N-K", "createdAt": "2020-02-29T15:06:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1NDM5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjEyODI1OQ==", "url": "https://github.com/openhab/openhab-addons/pull/6902#discussion_r386128259", "bodyText": "I could also be used to map different devices to the same events.\nLike one device sends the string 'clicked' while the other sends 'pushed'.\nThe rules listening for the triggers could then be independent of the these differences.\nI do not think about numbers here, but strings.", "author": "jochen314", "createdAt": "2020-03-01T18:11:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1NDM5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMxMDQxNA==", "url": "https://github.com/openhab/openhab-addons/pull/6902#discussion_r389310414", "bodyText": "Both examples like armed/disarmed and ranges of temperatures are actually states, so what isn't clear to me is why this isn't a state channel then? Triggers are only meant for the situations, where something like a button press occurs, which does not have any state. Triggers must not be misused for state change events.", "author": "kaikreuzer", "createdAt": "2020-03-07T20:36:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1NDM5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMxMjE3NQ==", "url": "https://github.com/openhab/openhab-addons/pull/6902#discussion_r389312175", "bodyText": "Please help me understand this!\n/**\n* System wide trigger {@link ChannelType} which triggers \"SHORT_PRESSED\", \"DOUBLE_PRESSED\" and \"LONG_PRESSED\"\n* events.\n*/\npublic static final ChannelType SYSTEM_BUTTON = ChannelTypeBuilder\n.trigger(new ChannelTypeUID(BINDING_ID, \"button\"), \"Button\")\n.withEventDescription(\nnew EventDescription(Arrays.asList(new EventOption(CommonTriggerEvents.SHORT_PRESSED, null),\nnew EventOption(CommonTriggerEvents.DOUBLE_PRESSED, null),\nnew EventOption(CommonTriggerEvents.LONG_PRESSED, null))))\n.build();\nA trigger take event options.\nThere is a trigger for the butten and the events are 'pressed', 'double pressed', and 'long pressed'.\nSo it does make sense for the mqtt trigger to use the value sent by the device as the event option, right?\nNow, why shouldn't we be able to map the values sent by differnt devices to common values?\nSuppose device one sends '0' for a click, '2' for a double click and '3' for a long press.\nSuppose another device sending 'click' for a click and 'hold' for a long press.\nWith a transformation we are able to map the event options of the different devices to common values, Then all the downstream components can handle the triggers without knowning different devices.", "author": "jochen314", "createdAt": "2020-03-07T21:06:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1NDM5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMxNDA0Mg==", "url": "https://github.com/openhab/openhab-addons/pull/6902#discussion_r389314042", "bodyText": "Yes, if we are talking about push buttons that are integrated via MQTT, triggers are fine. What I was saying above was that all arguments were done with examples that do NOT fit to a trigger. Likewise the example given in the code, which would clearly be better modelled as a state channel instead of a trigger.\nFurthermore, this parameter has \"state\" in its name, which hints at a state channel.", "author": "kaikreuzer", "createdAt": "2020-03-07T21:38:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1NDM5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMxNDQ1Ng==", "url": "https://github.com/openhab/openhab-addons/pull/6902#discussion_r389314456", "bodyText": "So its is the description...\nToo much copy and paste....", "author": "jochen314", "createdAt": "2020-03-07T21:45:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1NDM5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMxNDEyMw==", "url": "https://github.com/openhab/openhab-addons/pull/6902#discussion_r389314123", "bodyText": "\"before it is published to MQTT\"? A trigger channel cannot be used to send any information outwards - I guess this statement should be removed.", "author": "kaikreuzer", "createdAt": "2020-03-07T21:39:45Z", "path": "bundles/org.openhab.binding.mqtt.generic/src/main/resources/ESH-INF/config/trigger-channel-config.xml", "diffHunk": "@@ -0,0 +1,31 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<config-description:config-descriptions\n+\txmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+\txmlns:config-description=\"https://openhab.org/schemas/config-description/v1.0.0\"\n+\txsi:schemaLocation=\"https://openhab.org/schemas/config-description/v1.0.0 https://openhab.org/schemas/config-description-1.0.0.xsd\">\n+\n+\t<config-description uri=\"thing-type:mqtt:trigger_channel\">\n+\t\t<parameter-group name=\"transformations\">\n+\t\t\t<label>Transform Values</label>\n+\t\t\t<description>These configuration parameters allow you to alter a value before it is published to MQTT or before a", "originalCommit": "125b8ff4ee22c02fb06f447059f8ce9db0ac72a9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e0bb81498abe4f59c7aea5aa5298638cd7fbff28", "url": "https://github.com/openhab/openhab-addons/commit/e0bb81498abe4f59c7aea5aa5298638cd7fbff28", "message": "improve description\n\nSigned-off-by: Jochen Klein <git@jochen.susca.de>", "committedDate": "2020-03-07T21:45:02Z", "type": "commit"}, {"oid": "c7b414daa4454e0dd29a9c592692d24aa2d417d9", "url": "https://github.com/openhab/openhab-addons/commit/c7b414daa4454e0dd29a9c592692d24aa2d417d9", "message": "good point\n\nSigned-off-by: Jochen Klein <git@jochen.susca.de>", "committedDate": "2020-03-07T21:52:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMxNDgxOA==", "url": "https://github.com/openhab/openhab-addons/pull/6902#discussion_r389314818", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\tfor example, the MAP transformation \n          \n          \n            \n            \t\t\te.g. the MAP transformation.", "author": "kaikreuzer", "createdAt": "2020-03-07T21:51:59Z", "path": "bundles/org.openhab.binding.mqtt.generic/src/main/resources/ESH-INF/config/trigger-channel-config.xml", "diffHunk": "@@ -20,9 +19,9 @@\n \t\t\t<label>Incoming Value Transformations</label>\n \t\t\t<description><![CDATA[\n \t\t\tApplies transformations to an incoming MQTT topic value.\n-\t\t\tA transformation example for a received JSON would be \"JSONPATH:$.device.status.temperature\" for\n-\t\t\ta json {device: {status: { temperature: 23.2 }}}.\n-\n+\t\t\tThis can be used to map the events sent by the device to common values for all devices using,\n+\t\t\tfor example, the MAP transformation ", "originalCommit": "e0bb81498abe4f59c7aea5aa5298638cd7fbff28", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMxNDg4NQ==", "url": "https://github.com/openhab/openhab-addons/pull/6902#discussion_r389314885", "bodyText": "Sorry, had just deleted my first suggestion and replaced it while you were merging it \ud83d\ude1f. Never mind, all fine now, thanks.", "author": "kaikreuzer", "createdAt": "2020-03-07T21:53:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMxNDgxOA=="}], "type": "inlineReview"}, {"oid": "e113b342cfdd2d41b03b594fde5b97299eaa132d", "url": "https://github.com/openhab/openhab-addons/commit/e113b342cfdd2d41b03b594fde5b97299eaa132d", "message": "review\n\nSigned-off-by: Jochen Klein <git@jochen.susca.de>", "committedDate": "2020-03-07T21:54:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk5OTU2NA==", "url": "https://github.com/openhab/openhab-addons/pull/6902#discussion_r389999564", "bodyText": "Is this really the best place to be changing the config?", "author": "cpmeister", "createdAt": "2020-03-09T22:37:17Z", "path": "bundles/org.openhab.binding.mqtt.generic/src/main/java/org/openhab/binding/mqtt/generic/values/ValueFactory.java", "diffHunk": "@@ -67,6 +67,10 @@ public static Value createValueState(ChannelConfig config, String channelTypeID)\n             case MqttBindingConstants.ROLLERSHUTTER:\n                 value = new RollershutterValue(config.on, config.off, config.stop);\n                 break;\n+            case MqttBindingConstants.TRIGGER:\n+                config.trigger = true;", "originalCommit": "e113b342cfdd2d41b03b594fde5b97299eaa132d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYzODMyNA==", "url": "https://github.com/openhab/openhab-addons/pull/6902#discussion_r390638324", "bodyText": "I am not sure. Do you have a better idea?\nCan we define a hidden constant in the config.xml?", "author": "jochen314", "createdAt": "2020-03-10T22:05:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk5OTU2NA=="}], "type": "inlineReview"}]}