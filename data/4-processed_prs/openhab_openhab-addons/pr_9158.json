{"pr_number": 9158, "pr_title": "[miio] dynamically generate channelTypes", "pr_createdAt": "2020-11-28T13:18:06Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/9158", "timeline": [{"oid": "2dee069fbcb188aef03fa8ddf3bdc6ae1779ed03", "url": "https://github.com/openhab/openhab-addons/commit/2dee069fbcb188aef03fa8ddf3bdc6ae1779ed03", "message": "[miio] dynamically generate channelTypes\n\nSimplify the json database creation for new models and less chance for\nerrors\nRelated to #7276\n\nSigned-off-by: Marcel Verpaalen <marcel@verpaalen.com>", "committedDate": "2020-11-29T15:12:22Z", "type": "commit"}, {"oid": "c801f69962df1018f87093117d4a66cb6172604e", "url": "https://github.com/openhab/openhab-addons/commit/c801f69962df1018f87093117d4a66cb6172604e", "message": "[miio] add tags and category\n\nSigned-off-by: Marcel Verpaalen <marcel@verpaalen.com>", "committedDate": "2020-11-29T18:33:33Z", "type": "commit"}, {"oid": "c801f69962df1018f87093117d4a66cb6172604e", "url": "https://github.com/openhab/openhab-addons/commit/c801f69962df1018f87093117d4a66cb6172604e", "message": "[miio] add tags and category\n\nSigned-off-by: Marcel Verpaalen <marcel@verpaalen.com>", "committedDate": "2020-11-29T18:33:33Z", "type": "forcePushed"}, {"oid": "7cb90b0a3f81e123f3c696e4ad50b33c3626515f", "url": "https://github.com/openhab/openhab-addons/commit/7cb90b0a3f81e123f3c696e4ad50b33c3626515f", "message": "[miio] preserve sequence of tags as that is required in mainUI\n\nSigned-off-by: Marcel Verpaalen <marcel@verpaalen.com>", "committedDate": "2020-11-29T20:05:20Z", "type": "commit"}, {"oid": "1540857a4b75ee8d138b9cd51bd2bce1b960ff1e", "url": "https://github.com/openhab/openhab-addons/commit/1540857a4b75ee8d138b9cd51bd2bce1b960ff1e", "message": "[miio] use hashmap to prevent some re-initiation drama\n\nSigned-off-by: Marcel Verpaalen <marcel@verpaalen.com>", "committedDate": "2020-11-29T20:35:55Z", "type": "commit"}, {"oid": "d97e8164d7d2e187b52dc63b44e14be4337cf2df", "url": "https://github.com/openhab/openhab-addons/commit/d97e8164d7d2e187b52dc63b44e14be4337cf2df", "message": "[miio] change dewcription to label to be in line with regular DTO\n\nSigned-off-by: Marcel Verpaalen <marcel@verpaalen.com>", "committedDate": "2020-11-29T21:49:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAwOTgzMw==", "url": "https://github.com/openhab/openhab-addons/pull/9158#discussion_r533009833", "bodyText": "Just reorganizing the annotation order so it is a bit more readable.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @SerializedName(\"value\")\n          \n          \n            \n                @Expose\n          \n          \n            \n                @Nullable\n          \n          \n            \n                public String value;\n          \n          \n            \n                @Expose\n          \n          \n            \n                @SerializedName(\"value\")\n          \n          \n            \n                public @Nullable String value;", "author": "cpmeister", "createdAt": "2020-12-01T01:19:16Z", "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/basic/OptionsValueListDTO.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.miio.internal.basic;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+\n+import com.google.gson.annotations.Expose;\n+import com.google.gson.annotations.SerializedName;\n+\n+/**\n+ * Mapping properties from json for miot device info\n+ *\n+ * @author Marcel Verpaalen - Initial contribution\n+ */\n+@NonNullByDefault\n+public class OptionsValueListDTO {\n+\n+    @SerializedName(\"value\")\n+    @Expose\n+    @Nullable\n+    public String value;", "originalCommit": "d97e8164d7d2e187b52dc63b44e14be4337cf2df", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAwOTg5NA==", "url": "https://github.com/openhab/openhab-addons/pull/9158#discussion_r533009894", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @SerializedName(\"label\")\n          \n          \n            \n                @Expose\n          \n          \n            \n                @Nullable\n          \n          \n            \n                public String label;\n          \n          \n            \n                @Expose\n          \n          \n            \n                @SerializedName(\"label\")\n          \n          \n            \n                public @Nullable String label;", "author": "cpmeister", "createdAt": "2020-12-01T01:19:31Z", "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/basic/OptionsValueListDTO.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.miio.internal.basic;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+\n+import com.google.gson.annotations.Expose;\n+import com.google.gson.annotations.SerializedName;\n+\n+/**\n+ * Mapping properties from json for miot device info\n+ *\n+ * @author Marcel Verpaalen - Initial contribution\n+ */\n+@NonNullByDefault\n+public class OptionsValueListDTO {\n+\n+    @SerializedName(\"value\")\n+    @Expose\n+    @Nullable\n+    public String value;\n+    @SerializedName(\"label\")\n+    @Expose\n+    @Nullable\n+    public String label;", "originalCommit": "d97e8164d7d2e187b52dc63b44e14be4337cf2df", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2f99ebfdc5cb75d795da75b21c5b4e8cad931504", "url": "https://github.com/openhab/openhab-addons/commit/2f99ebfdc5cb75d795da75b21c5b4e8cad931504", "message": "[miio] update with review feedback\n\nCo-authored-by: Connor Petty <mistercpp2000@gmail.com>\nSigned-off-by: Marcel Verpaalen <marcel@verpaalen.com>", "committedDate": "2020-12-01T23:04:36Z", "type": "commit"}, {"oid": "b63fc891792da5b13210c43444e7cdfd73092867", "url": "https://github.com/openhab/openhab-addons/commit/b63fc891792da5b13210c43444e7cdfd73092867", "message": "[miio] minor cleanup and formatting\n\nSigned-off-by: Marcel Verpaalen <marcel@verpaalen.com>", "committedDate": "2020-12-02T11:50:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc3MzEzMg==", "url": "https://github.com/openhab/openhab-addons/pull/9158#discussion_r535773132", "bodyText": "I noticed in my own bindings that my channels would not show up in the UI if the channel types weren't available in the ChannelTypeProvider before the thing handler was started. Is there something special about your setup here or did you find some kind of workaround to prevent that issue?", "author": "cpmeister", "createdAt": "2020-12-04T01:41:28Z", "path": "bundles/org.openhab.binding.miio/src/main/java/org/openhab/binding/miio/internal/basic/BasicChannelTypeProvider.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.miio.internal.basic;\n+\n+import static org.openhab.binding.miio.internal.MiIoBindingConstants.BINDING_ID;\n+\n+import java.math.BigDecimal;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.LinkedHashSet;\n+import java.util.List;\n+import java.util.Locale;\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.core.thing.type.ChannelType;\n+import org.openhab.core.thing.type.ChannelTypeBuilder;\n+import org.openhab.core.thing.type.ChannelTypeProvider;\n+import org.openhab.core.thing.type.ChannelTypeUID;\n+import org.openhab.core.thing.type.StateChannelTypeBuilder;\n+import org.openhab.core.types.StateDescriptionFragmentBuilder;\n+import org.openhab.core.types.StateOption;\n+import org.osgi.service.component.annotations.Component;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Provide channelTypes for Mi IO Basic devices\n+ *\n+ * @author Marcel Verpaalen - Initial contribution\n+ */\n+@Component(service = { ChannelTypeProvider.class, BasicChannelTypeProvider.class })\n+@NonNullByDefault\n+public class BasicChannelTypeProvider implements ChannelTypeProvider {\n+    private final Map<String, ChannelType> channelTypes = new ConcurrentHashMap<>();\n+    private final Logger logger = LoggerFactory.getLogger(BasicChannelTypeProvider.class);\n+\n+    @Override\n+    public Collection<ChannelType> getChannelTypes(@Nullable Locale locale) {\n+        return channelTypes.values();\n+    }\n+\n+    @Override\n+    public @Nullable ChannelType getChannelType(ChannelTypeUID channelTypeUID, @Nullable Locale locale) {\n+        if (channelTypes.containsKey(channelTypeUID.getAsString())) {\n+            return channelTypes.get(channelTypeUID.getAsString());\n+        }\n+        return null;\n+    }\n+\n+    public void addChannelType(MiIoBasicChannel miChannel, String model) {", "originalCommit": "b63fc891792da5b13210c43444e7cdfd73092867", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTkwMTg2Ng==", "url": "https://github.com/openhab/openhab-addons/pull/9158#discussion_r535901866", "bodyText": "I have not experienced that. I'll do some specific testing on that.\nIt very well can be the case, but as the basicHandler changes the type from generic to basic after it did the identification it would have satisfied that requirement. But... I would need to check the code if it still does that when the type has already changed, I guess than indeed it may be an issue.\nI wonder how other bindings are doing this, as in many cases the channel definition is based on something that is loaded of the device.\nHow did you solve it?", "author": "marcelrv", "createdAt": "2020-12-04T07:54:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc3MzEzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTkwODIwMA==", "url": "https://github.com/openhab/openhab-addons/pull/9158#discussion_r535908200", "bodyText": "I ended up encoding all of the relevant channel information into the channel type name itself. And then reconstructed the channel type by decoding the information in the name on demand. Wish I didn't have to do that and that there was some way around it so that's why I was asking if you are experiencing the same issue.", "author": "cpmeister", "createdAt": "2020-12-04T08:06:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc3MzEzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMzNzcwMw==", "url": "https://github.com/openhab/openhab-addons/pull/9158#discussion_r536337703", "bodyText": "Strange. I don't see the behavior. If I change the model info on an existing thing, the new channels appear in the mainUI almost instant. No reloading of the page (I go from the code page to the channel page and the new channels are there)\nNo specific actions I take to handle the reloading the handler.", "author": "marcelrv", "createdAt": "2020-12-04T19:42:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc3MzEzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM3NjE1Nw==", "url": "https://github.com/openhab/openhab-addons/pull/9158#discussion_r536376157", "bodyText": "Well if it works for you then that is good enough to me. I'll sort out my own setup some other time.", "author": "cpmeister", "createdAt": "2020-12-04T20:59:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc3MzEzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MzI1NjU2OA==", "url": "https://github.com/openhab/openhab-addons/pull/9158#discussion_r583256568", "bodyText": "@cpmeister could you point out the code you've used so we can have a look (cc @markus7017)\nWe're having the same issue with a binding where the channels show up in the console but not in the UI on OH3, and it appears to be related to channel ChannelType. All works well in OH2.5\nThx!", "author": "fastlorenzo", "createdAt": "2021-02-25T22:45:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc3MzEzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MzI3MzI1Nw==", "url": "https://github.com/openhab/openhab-addons/pull/9158#discussion_r583273257", "bodyText": "As I mentioned before, I had to implement the ChannelTypeProvider such that the ChannelType information could be derived from the ChannelTypeUID without having a handler inject ChannelType definitions into the provider ahead of time.\nhttps://github.com/openhab/openhab-addons/blob/main/bundles/org.openhab.binding.bluetooth.generic/src/main/java/org/openhab/binding/bluetooth/generic/internal/CharacteristicChannelTypeProvider.java\n@fastlorenzo What binding are you having trouble with?", "author": "cpmeister", "createdAt": "2021-02-25T23:23:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc3MzEzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MzMwMDQzMg==", "url": "https://github.com/openhab/openhab-addons/pull/9158#discussion_r583300432", "bodyText": "Thanks for the quick reply!\nI ended up fixing it by checking in the ChannelTypeRegistry if the ChannelType exists before dynamically creating the channels.\nThis is the Carnet binding (interface with Audi/VW API), so all channels are taken from the car info, and are different even with the same car model (depending on options for example)\nhttps://github.com/markus7017/openhab-addons/pull/14/files", "author": "fastlorenzo", "createdAt": "2021-02-26T00:29:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc3MzEzMg=="}], "type": "inlineReview"}]}