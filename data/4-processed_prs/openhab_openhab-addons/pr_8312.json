{"pr_number": 8312, "pr_title": "[mqtt.generic] Add CIE xyY color support", "pr_createdAt": "2020-08-19T00:05:45Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/8312", "timeline": [{"oid": "31d0ec1c1047252c6e08506066d601b57c4c6095", "url": "https://github.com/openhab/openhab-addons/commit/31d0ec1c1047252c6e08506066d601b57c4c6095", "message": "[mqtt.generic] Add CIE xyY color support\n\nSigned-off-by: Aitor Iturrioz <riturrioz@gmail.com>", "committedDate": "2020-08-18T23:54:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk1MTUyMg==", "url": "https://github.com/openhab/openhab-addons/pull/8312#discussion_r472951522", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            <option value=\"xyY\">CIE xyY</option>\n          \n          \n            \n                            <option value=\"xyY\">CIE xyY (x, y, Brightness)</option>\n          \n      \n    \n    \n  \n\nWe should add the values for the xyY colorMode to the color-channel-config, so that people know which values they need for using this colorMode, since the third parameter is not the real Y.", "author": "nwpr", "createdAt": "2020-08-19T11:15:45Z", "path": "bundles/org.openhab.binding.mqtt.generic/src/main/resources/ESH-INF/config/color-channel-config.xml", "diffHunk": "@@ -11,6 +11,17 @@\n \t\t\t\treceived value is assigned to an item.</description>\n \t\t\t<advanced>true</advanced>\n \t\t</parameter-group>\n+\t\t\n+        <parameter name=\"colorMode\" type=\"text\">\n+            <label>Color Mode</label>\n+            <description>Defines the color representation format of the payload. \"HSB\" by default.</description>\n+            <options>\n+                <option value=\"hsb\">HSB (Hue, Saturation, Brightness)</option>\n+                <option value=\"rgb\">RGB (Red, Green, Blue)</option>\n+                <option value=\"xyY\">CIE xyY</option>", "originalCommit": "31d0ec1c1047252c6e08506066d601b57c4c6095", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA1OTU4OA==", "url": "https://github.com/openhab/openhab-addons/pull/8312#discussion_r473059588", "bodyText": "@nwpr, have you seen any device with a pure CIE xyY implementation (with the real Y)? I'm not sure if we should call the channel \"CIE xyY\", because it is not a 100% accurate implementation. Do you know if there is any other name for the \"(x, y, Brightness)\" representation? It seems that xyB is not used \ud83d\ude06 @J-N-K, what do you think about @nwpr's suggestion? Is that enough or should I rename all \"xyY\" references with another name? IMO, and knowing that the real \"Y\" is not even used in openHAB's core functions, we should be fine with CIE xyY (x, y, Brightness) \ud83d\udc4d", "author": "bodiroga", "createdAt": "2020-08-19T14:11:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk1MTUyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA5NTc1MQ==", "url": "https://github.com/openhab/openhab-addons/pull/8312#discussion_r473095751", "bodyText": "No, but I understand your concerns. On one hand xyY doesn't reflect the real function of this mode, but on the other hand the official name for this color space is indeed CIE 1931 xyY.\nI just searched for other implementations of this and found the following code in the Tradfri binding: TradfriColor.java. They just call it xy in their code.\nEdit: Please ignore the fact that they are using a range from 0 to 254 for the brightness. This is definitely wrong.\nEdit edit: Nevermind, we are just using percentage so we don't need to care.", "author": "nwpr", "createdAt": "2020-08-19T14:58:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk1MTUyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI1NjE5Mw==", "url": "https://github.com/openhab/openhab-addons/pull/8312#discussion_r473256193", "bodyText": "Alright, you've convinced me! \ud83d\ude09 Name changed to CIE xyY (x, y, Brightness), now we simply have to wait for the maintainer's opinion.", "author": "bodiroga", "createdAt": "2020-08-19T19:04:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjk1MTUyMg=="}], "type": "inlineReview"}, {"oid": "496a2e7b67fbbb3a0e424fb9d880fe03d2d8251d", "url": "https://github.com/openhab/openhab-addons/commit/496a2e7b67fbbb3a0e424fb9d880fe03d2d8251d", "message": "Address review comments\n\nSigned-off-by: Aitor Iturrioz <riturrioz@gmail.com>", "committedDate": "2020-08-19T18:53:25Z", "type": "commit"}, {"oid": "58d13e8b89e6f1755352695dd6313f4ebd9ee1a6", "url": "https://github.com/openhab/openhab-addons/commit/58d13e8b89e6f1755352695dd6313f4ebd9ee1a6", "message": "Update documentation\n\nSigned-off-by: Aitor Iturrioz <riturrioz@gmail.com>", "committedDate": "2020-08-20T01:03:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ0MDE5Nw==", "url": "https://github.com/openhab/openhab-addons/pull/8312#discussion_r477440197", "bodyText": "I would prefere to use an enum for the colorMode here.", "author": "jochen314", "createdAt": "2020-08-26T16:42:20Z", "path": "bundles/org.openhab.binding.mqtt.generic/src/main/java/org/openhab/binding/mqtt/generic/values/ColorValue.java", "diffHunk": "@@ -33,46 +37,44 @@\n  * Accepts user updates from a HSBType, OnOffType and StringType.\n  * </p>\n  * Accepts MQTT state updates as OnOffType and a\n- * StringType with comma separated HSB (\"h,s,b\"), RGB (\"r,g,b\") and on, off strings.\n+ * StringType with comma separated HSB (\"h,s,b\"), RGB (\"r,g,b\"), CIE xyY (\"x,y,Y\") and on, off strings.\n  * On, Off strings can be customized.\n  *\n  * @author David Graeff - Initial contribution\n+ * @author Aitor Iturrioz - Add CIE xyY colors support\n  */\n @NonNullByDefault\n public class ColorValue extends Value {\n-    private final boolean isRGB;\n+    private final Logger logger = LoggerFactory.getLogger(ColorValue.class);\n+    private final String colorMode;\n     private final String onValue;\n     private final String offValue;\n     private final int onBrightness;\n \n     /**\n      * Creates a non initialized color value.\n      *\n-     * @param isRGB True if this is an RGB color value instead of a HSB one.\n+     * @param colorMode The color mode: \"hsb\", \"rgb\" or \"xyY\".\n      * @param onValue The ON value string. This will be compared to MQTT messages.\n      * @param offValue The OFF value string. This will be compared to MQTT messages.\n      * @param onBrightness When receiving a ON command, the brightness percentage is set to this value\n      */\n-    public ColorValue(boolean isRGB, @Nullable String onValue, @Nullable String offValue, int onBrightness) {\n+    public ColorValue(String colorMode, @Nullable String onValue, @Nullable String offValue, int onBrightness) {", "originalCommit": "58d13e8b89e6f1755352695dd6313f4ebd9ee1a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ1MTMxNg==", "url": "https://github.com/openhab/openhab-addons/pull/8312#discussion_r477451316", "bodyText": "Agreed.", "author": "J-N-K", "createdAt": "2020-08-26T16:59:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ0MDE5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc2MDkzNg==", "url": "https://github.com/openhab/openhab-addons/pull/8312#discussion_r478760936", "bodyText": "Done!", "author": "bodiroga", "createdAt": "2020-08-28T00:08:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ0MDE5Nw=="}], "type": "inlineReview"}, {"oid": "d9f8e4140b2850e0eeed8c6b07c0b25585c4e809", "url": "https://github.com/openhab/openhab-addons/commit/d9f8e4140b2850e0eeed8c6b07c0b25585c4e809", "message": "Create enum for colorMode\n\nSigned-off-by: Aitor Iturrioz <riturrioz@gmail.com>", "committedDate": "2020-08-27T23:57:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc2MDg0MA==", "url": "https://github.com/openhab/openhab-addons/pull/8312#discussion_r478760840", "bodyText": "@J-N-K, @jochen314, should I name it COLOR_MODE or ColorMode? \ud83e\udd14", "author": "bodiroga", "createdAt": "2020-08-28T00:08:16Z", "path": "bundles/org.openhab.binding.mqtt.generic/src/main/java/org/openhab/binding/mqtt/generic/internal/MqttBindingConstants.java", "diffHunk": "@@ -42,4 +41,10 @@\n     public static final String DATETIME = \"datetime\";\n     public static final String ROLLERSHUTTER = \"rollershutter\";\n     public static final String TRIGGER = \"trigger\";\n+\n+    public static enum COLOR_MODE {", "originalCommit": "d9f8e4140b2850e0eeed8c6b07c0b25585c4e809", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTY2MjkzOA==", "url": "https://github.com/openhab/openhab-addons/pull/8312#discussion_r479662938", "bodyText": "Camelcase, and the static is not needed", "author": "jochen314", "createdAt": "2020-08-29T15:57:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc2MDg0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTY2MzI3OQ==", "url": "https://github.com/openhab/openhab-addons/pull/8312#discussion_r479663279", "bodyText": "Now it is an enum, so we can use ==", "author": "jochen314", "createdAt": "2020-08-29T16:00:26Z", "path": "bundles/org.openhab.binding.mqtt.generic/src/main/java/org/openhab/binding/mqtt/generic/values/ColorValue.java", "diffHunk": "@@ -116,17 +137,31 @@ public String getMQTTpublishValue(@Nullable String pattern) {\n \n         String formatPattern = pattern;\n         if (formatPattern == null || \"%s\".equals(formatPattern)) {\n-            formatPattern = \"%1$d,%2$d,%3$d\";\n+            if (this.colorMode.equals(COLOR_MODE.xyY)) {", "originalCommit": "d9f8e4140b2850e0eeed8c6b07c0b25585c4e809", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTY2MzQ4NA==", "url": "https://github.com/openhab/openhab-addons/pull/8312#discussion_r479663484", "bodyText": "We should throw an exception (fail fast).\nReturning an empty string will defere the error to a later stage and makes it harder to find the problem", "author": "jochen314", "createdAt": "2020-08-29T16:02:37Z", "path": "bundles/org.openhab.binding.mqtt.generic/src/main/java/org/openhab/binding/mqtt/generic/values/ColorValue.java", "diffHunk": "@@ -116,17 +137,31 @@ public String getMQTTpublishValue(@Nullable String pattern) {\n \n         String formatPattern = pattern;\n         if (formatPattern == null || \"%s\".equals(formatPattern)) {\n-            formatPattern = \"%1$d,%2$d,%3$d\";\n+            if (this.colorMode.equals(COLOR_MODE.xyY)) {\n+                formatPattern = \"%1$f,%2$f,%3$.2f\";\n+            } else {\n+                formatPattern = \"%1$d,%2$d,%3$d\";\n+            }\n         }\n-        // ignore the pattern. Don't know\n-        if (isRGB) {\n-            PercentType[] rgb = ((HSBType) state).toRGB();\n-            return String.format(formatPattern, rgb[0].toBigDecimal().multiply(factor).intValue(),\n-                    rgb[1].toBigDecimal().multiply(factor).intValue(),\n-                    rgb[2].toBigDecimal().multiply(factor).intValue());\n+\n+        HSBType hsb_state = (HSBType) state;\n+\n+        switch (this.colorMode) {\n+            case hsb:\n+                return String.format(formatPattern, hsb_state.getHue().intValue(), hsb_state.getSaturation().intValue(),\n+                        hsb_state.getBrightness().intValue());\n+            case rgb:\n+                PercentType[] rgb = hsb_state.toRGB();\n+                return String.format(formatPattern, rgb[0].toBigDecimal().multiply(factor).intValue(),\n+                        rgb[1].toBigDecimal().multiply(factor).intValue(),\n+                        rgb[2].toBigDecimal().multiply(factor).intValue());\n+            case xyY:\n+                PercentType[] xyY = hsb_state.toXY();\n+                return String.format(Locale.ROOT, formatPattern, xyY[0].floatValue() / 100.0f,\n+                        xyY[1].floatValue() / 100.0f, hsb_state.getBrightness().floatValue());\n+            default:\n+                logger.warn(\"Non supported color mode: {}\", this.colorMode);\n+                return \"\";", "originalCommit": "d9f8e4140b2850e0eeed8c6b07c0b25585c4e809", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE4MDY3Mw==", "url": "https://github.com/openhab/openhab-addons/pull/8312#discussion_r483180673", "bodyText": "Hi @jochen314!\nAn empty string is also returned by the getMQTTpublishValue method when the value state is UnDefType.UNDEF, but I will throw the exception anyway \ud83d\ude09", "author": "bodiroga", "createdAt": "2020-09-03T18:37:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTY2MzQ4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTY2OTg4Nw==", "url": "https://github.com/openhab/openhab-addons/pull/8312#discussion_r479669887", "bodyText": "Please use all upper-case for enum members. And as @jochen314 already mentioned: camel-case for the enum-name. Please move the enum to a separate file.", "author": "J-N-K", "createdAt": "2020-08-29T17:11:33Z", "path": "bundles/org.openhab.binding.mqtt.generic/src/main/java/org/openhab/binding/mqtt/generic/internal/MqttBindingConstants.java", "diffHunk": "@@ -42,8 +42,9 @@\n     public static final String ROLLERSHUTTER = \"rollershutter\";\n     public static final String TRIGGER = \"trigger\";\n \n-    // Color mode\n-    public static final String COLOR_MODE_HSB = \"hsb\";\n-    public static final String COLOR_MODE_RGB = \"rgb\";\n-    public static final String COLOR_MODE_XYY = \"xyY\";\n+    public static enum COLOR_MODE {\n+        hsb,", "originalCommit": "d9f8e4140b2850e0eeed8c6b07c0b25585c4e809", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ca09858c8c0969a31f2360dbdaf02f062e6a0481", "url": "https://github.com/openhab/openhab-addons/commit/ca09858c8c0969a31f2360dbdaf02f062e6a0481", "message": "Move ColorMode enum to its own class\n\nSigned-off-by: Aitor Iturrioz <riturrioz@gmail.com>", "committedDate": "2020-09-03T18:55:58Z", "type": "commit"}, {"oid": "7f5ba37efa6b814274dd9c368023542234461855", "url": "https://github.com/openhab/openhab-addons/commit/7f5ba37efa6b814274dd9c368023542234461855", "message": "Fix formatting issues\n\nSigned-off-by: Aitor Iturrioz <riturrioz@gmail.com>", "committedDate": "2020-09-05T13:08:07Z", "type": "commit"}, {"oid": "a71bb8079d24f682b8733b49702dc7e260a0df7f", "url": "https://github.com/openhab/openhab-addons/commit/a71bb8079d24f682b8733b49702dc7e260a0df7f", "message": "Move ColorMode enum to mapping package\n\nSigned-off-by: Aitor Iturrioz <riturrioz@gmail.com>", "committedDate": "2020-09-05T14:37:06Z", "type": "commit"}, {"oid": "5c6ebdd2fa7b6de04f4f2c6a5a9eb804d4ec8a47", "url": "https://github.com/openhab/openhab-addons/commit/5c6ebdd2fa7b6de04f4f2c6a5a9eb804d4ec8a47", "message": "Fix formatting issues again\n\nSigned-off-by: Aitor Iturrioz <riturrioz@gmail.com>", "committedDate": "2020-09-05T15:59:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk1OTAyNA==", "url": "https://github.com/openhab/openhab-addons/pull/8312#discussion_r484959024", "bodyText": "Does ColorMode.valueOf work without config.colorMode being converted to uppercase?", "author": "Hilbrand", "createdAt": "2020-09-08T14:21:19Z", "path": "bundles/org.openhab.binding.mqtt.generic/src/main/java/org/openhab/binding/mqtt/generic/values/ValueFactory.java", "diffHunk": "@@ -52,11 +53,8 @@ public static Value createValueState(ChannelConfig config, String channelTypeID)\n             case MqttBindingConstants.DIMMER:\n                 value = new PercentageValue(config.min, config.max, config.step, config.on, config.off);\n                 break;\n-            case MqttBindingConstants.COLOR_RGB:\n-                value = new ColorValue(true, config.on, config.off, config.onBrightness);\n-                break;\n-            case MqttBindingConstants.COLOR_HSB:\n-                value = new ColorValue(false, config.on, config.off, config.onBrightness);\n+            case MqttBindingConstants.COLOR:\n+                value = new ColorValue(ColorMode.valueOf(config.colorMode), config.on, config.off, config.onBrightness);", "originalCommit": "5c6ebdd2fa7b6de04f4f2c6a5a9eb804d4ec8a47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzMyMzU3NA==", "url": "https://github.com/openhab/openhab-addons/pull/8312#discussion_r487323574", "bodyText": "Good point, thanks! I have changed the colorMode parameter values and made them uppercase \ud83d\ude09", "author": "bodiroga", "createdAt": "2020-09-11T22:51:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk1OTAyNA=="}], "type": "inlineReview"}, {"oid": "e4557657d1939dccaac4eba2379bda3fb96b7f34", "url": "https://github.com/openhab/openhab-addons/commit/e4557657d1939dccaac4eba2379bda3fb96b7f34", "message": "Restore deprecated channels\n\nSigned-off-by: Aitor Iturrioz <riturrioz@gmail.com>", "committedDate": "2020-09-11T22:34:21Z", "type": "commit"}, {"oid": "06655b2efde627859d66643bebc49c7a376624a6", "url": "https://github.com/openhab/openhab-addons/commit/06655b2efde627859d66643bebc49c7a376624a6", "message": "Add file header to ColorMode enum\n\nSigned-off-by: Aitor Iturrioz <riturrioz@gmail.com>", "committedDate": "2020-09-12T11:22:50Z", "type": "commit"}]}