{"pr_number": 9206, "pr_title": "[openthermgateway] Fix for #9205 incorrect control setpoint override", "pr_createdAt": "2020-12-02T23:12:37Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/9206", "timeline": [{"oid": "a8e71052f8d24ec828fc0e79fa915beb7b4582b1", "url": "https://github.com/openhab/openhab-addons/commit/a8e71052f8d24ec828fc0e79fa915beb7b4582b1", "message": "Initial attempt to resolve issue with flickering statuses when override\npresent on OTGW\n\nSigned-off-by: James Melville <jamesmelville@gmail.com>", "committedDate": "2020-12-01T22:36:03Z", "type": "commit"}, {"oid": "b2a0392f6a1141541da2b8eb39ceb9e10055e1ea", "url": "https://github.com/openhab/openhab-addons/commit/b2a0392f6a1141541da2b8eb39ceb9e10055e1ea", "message": "apply spotless, fix enum usage\n\nSigned-off-by: James Melville <jamesmelville@gmail.com>", "committedDate": "2020-12-01T22:36:52Z", "type": "commit"}, {"oid": "7193dbd90bec29dac9b8e229642850d2edd316dc", "url": "https://github.com/openhab/openhab-addons/commit/7193dbd90bec29dac9b8e229642850d2edd316dc", "message": "Update readme\n\nSigned-off-by: James Melville <jamesmelville@gmail.com>", "committedDate": "2020-12-02T23:12:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTgwMTkzMw==", "url": "https://github.com/openhab/openhab-addons/pull/9206#discussion_r535801933", "bodyText": "Can you give these enum value more verbose names?", "author": "cpmeister", "createdAt": "2020-12-04T03:06:09Z", "path": "bundles/org.openhab.binding.openthermgateway/src/main/java/org/openhab/binding/openthermgateway/internal/CodeType.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.openthermgateway.internal;\n+\n+/**\n+ * The {@link CodeType} field is not part of OpenTherm specification, but added by OpenTherm Gateway.\n+ * It can be any of the following:\n+ *\n+ * T: Message received from the thermostat\n+ * B: Message received from the boiler\n+ * R: Request sent to the boiler\n+ * A: Response returned to the thermostat\n+ * E: Parity or stop bit error\n+ *\n+ * @author Arjen Korevaar - Initial contribution\n+ * @author James Melville - Introduced code filtering functionality\n+ */\n+public enum CodeType {\n+    /**\n+     * Message received from the thermostat\n+     */\n+    T,", "originalCommit": "7193dbd90bec29dac9b8e229642850d2edd316dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg3ODk2Nw==", "url": "https://github.com/openhab/openhab-addons/pull/9206#discussion_r535878967", "bodyText": "Hi cpmeister, some of the code of the OTGW binding is directly related to the OpenTherm or the OTGW specifications. While it is possible to use more verbose names, this would require extra mappings and in general obfuscates the relationship to the OpenTherm or OTGW specifications. I would prefer to stick with the values as they are used by the OTGW. The comments should provide sufficient explanation of each value.", "author": "ArjenKorevaar", "createdAt": "2020-12-04T07:02:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTgwMTkzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMwNTUzMw==", "url": "https://github.com/openhab/openhab-addons/pull/9206#discussion_r536305533", "bodyText": "It is possible for CodeType.valueOf(code); to throw an exception if the given code isn't one of the enum values. Since a constructor isn't really a suitable place to do exception handling I think is would be better if you changed the code parameter from String to CodeType so that you push the burden of exception handling to the caller instead.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public Message(String code, MessageType messageType, int id, String data) {\n          \n          \n            \n                public Message(CodeType code, MessageType messageType, int id, String data) {", "author": "cpmeister", "createdAt": "2020-12-04T18:47:28Z", "path": "bundles/org.openhab.binding.openthermgateway/src/main/java/org/openhab/binding/openthermgateway/internal/Message.java", "diffHunk": "@@ -149,7 +139,7 @@ public String toString() {\n     }\n \n     public Message(String code, MessageType messageType, int id, String data) {", "originalCommit": "7193dbd90bec29dac9b8e229642850d2edd316dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQwNzM1Mg==", "url": "https://github.com/openhab/openhab-addons/pull/9206#discussion_r536407352", "bodyText": "I've moved the evaluation of the CodeType into the parse() method, which uses a regexp to validate the code type is valid before parsing so won't error.", "author": "jamesmelville", "createdAt": "2020-12-04T21:57:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMwNTUzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMwNjg1Ng==", "url": "https://github.com/openhab/openhab-addons/pull/9206#discussion_r536306856", "bodyText": "Enum comparisons are one of the few instances in which reference comparing is safe.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            && (CodeType.R.equals(this.getCode()) || CodeType.A.equals(this.getCode()));\n          \n          \n            \n                            && (this.code == CodeType.R || this.code == CodeType.A);", "author": "cpmeister", "createdAt": "2020-12-04T18:49:52Z", "path": "bundles/org.openhab.binding.openthermgateway/src/main/java/org/openhab/binding/openthermgateway/internal/Message.java", "diffHunk": "@@ -140,7 +130,7 @@ public boolean overrides(@Nullable Message other) {\n         // thermostat, and it's ID is equal to the previous message, then this is an\n         // override sent by the OpenTherm Gateway\n         return other != null && this.getID() == other.getID()\n-                && (\"R\".equals(this.getCode()) || \"A\".equals(this.getCode()));\n+                && (CodeType.R.equals(this.getCode()) || CodeType.A.equals(this.getCode()));", "originalCommit": "7193dbd90bec29dac9b8e229642850d2edd316dc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "dd5a2dba16c079ff4230e5a3b9e86a045fd9ba05", "url": "https://github.com/openhab/openhab-addons/commit/dd5a2dba16c079ff4230e5a3b9e86a045fd9ba05", "message": "Refactor use of CodeType enum\n\nSigned-off-by: James Melville <jamesmelville@gmail.com>", "committedDate": "2020-12-04T21:55:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQxMTE3Ng==", "url": "https://github.com/openhab/openhab-addons/pull/9206#discussion_r536411176", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t<state readOnly=\"true\" pattern=\"%.1f %unit%\"></state>\n          \n          \n            \n            \t\t<state readOnly=\"true\" pattern=\"%.1f %unit%\" />", "author": "cpmeister", "createdAt": "2020-12-04T22:06:01Z", "path": "bundles/org.openhab.binding.openthermgateway/src/main/resources/OH-INF/thing/channels.xml", "diffHunk": "@@ -39,11 +39,27 @@\n \t<channel-type id=\"controlsetpoint\">\n \t\t<item-type>Number:Temperature</item-type>\n \t\t<label>Control Setpoint</label>\n-\t\t<description>Central heating water setpoint</description>\n+\t\t<description>Central heating water setpoint set at boiler</description>\n \t\t<category>Temperature</category>\n \t\t<state readOnly=\"true\" pattern=\"%.1f %unit%\"></state>\n \t</channel-type>\n \n+\t<channel-type id=\"controlsetpointrequested\">\n+\t\t<item-type>Number:Temperature</item-type>\n+\t\t<label>Control Setpoint Requested</label>\n+\t\t<description>Central heating water setpoint requested by Thermostat</description>\n+\t\t<category>Temperature</category>\n+\t\t<state readOnly=\"true\" pattern=\"%.1f %unit%\"></state>", "originalCommit": "dd5a2dba16c079ff4230e5a3b9e86a045fd9ba05", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzEyNDMyNg==", "url": "https://github.com/openhab/openhab-addons/pull/9206#discussion_r537124326", "bodyText": "I'd followed the pattern of the existing channels in the file, but I've reformatted them all now, and this was a good prompt for me to fix the Control Setpoint Override definition c47f416#diff-e2a0a39908dbee74cd599d47152756cafe01c6a3de9c5067f6fb700da720cd99R60", "author": "jamesmelville", "createdAt": "2020-12-06T21:11:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQxMTE3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQxMTI0Mw==", "url": "https://github.com/openhab/openhab-addons/pull/9206#discussion_r536411243", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t<state pattern=\"%.1f %unit%\"></state>\n          \n          \n            \n            \t\t<state pattern=\"%.1f %unit%\" />", "author": "cpmeister", "createdAt": "2020-12-04T22:06:11Z", "path": "bundles/org.openhab.binding.openthermgateway/src/main/resources/OH-INF/thing/channels.xml", "diffHunk": "@@ -39,11 +39,27 @@\n \t<channel-type id=\"controlsetpoint\">\n \t\t<item-type>Number:Temperature</item-type>\n \t\t<label>Control Setpoint</label>\n-\t\t<description>Central heating water setpoint</description>\n+\t\t<description>Central heating water setpoint set at boiler</description>\n \t\t<category>Temperature</category>\n \t\t<state readOnly=\"true\" pattern=\"%.1f %unit%\"></state>\n \t</channel-type>\n \n+\t<channel-type id=\"controlsetpointrequested\">\n+\t\t<item-type>Number:Temperature</item-type>\n+\t\t<label>Control Setpoint Requested</label>\n+\t\t<description>Central heating water setpoint requested by Thermostat</description>\n+\t\t<category>Temperature</category>\n+\t\t<state readOnly=\"true\" pattern=\"%.1f %unit%\"></state>\n+\t</channel-type>\n+\n+\t<channel-type id=\"controlsetpointoverride\">\n+\t\t<item-type>Number:Temperature</item-type>\n+\t\t<label>Control Setpoint Override</label>\n+\t\t<description>Central heating water setpoint configured on OTGW</description>\n+\t\t<category>Temperature</category>\n+\t\t<state pattern=\"%.1f %unit%\"></state>", "originalCommit": "dd5a2dba16c079ff4230e5a3b9e86a045fd9ba05", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQxMTgxMw==", "url": "https://github.com/openhab/openhab-addons/pull/9206#discussion_r536411813", "bodyText": "Should ControlSetpointOverride be a Setpoint?", "author": "cpmeister", "createdAt": "2020-12-04T22:07:23Z", "path": "bundles/org.openhab.binding.openthermgateway/README.md", "diffHunk": "@@ -114,6 +122,8 @@ sitemap demo label=\"Main Menu\" {\n         Setpoint item=\"TemporaryRoomSetpointOverride\" icon=\"temperature\" label=\"Temporary room setpoint override [%.1f \u00b0C]\" minValue=\"0\" maxValue=\"30\" step=\"0.1\"\n         Setpoint item=\"ConstantRoomSetpointOverride\" icon=\"temperature\" label=\"Constant room setpoint override [%.1f \u00b0C]\" minValue=\"0\" maxValue=\"30\" step=\"0.1\"\n         Text item=\"ControlSetpoint\" icon=\"temperature\" label=\"Control setpoint [%.1f \u00b0C]\"\n+        Text item=\"ControlSetpointRequested\" icon=\"temperature\" label=\"Control setpoint requested [%.1f \u00b0C]\"\n+        Text item=\"ControlSetpointOverride\" icon=\"temperature\" label=\"Control setpoint override [%.1f \u00b0C]\"", "originalCommit": "dd5a2dba16c079ff4230e5a3b9e86a045fd9ba05", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzEyNDUxNA==", "url": "https://github.com/openhab/openhab-addons/pull/9206#discussion_r537124514", "bodyText": "Yes, it should have been, corrected", "author": "jamesmelville", "createdAt": "2020-12-06T21:12:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQxMTgxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQxMjMxMA==", "url": "https://github.com/openhab/openhab-addons/pull/9206#discussion_r536412310", "bodyText": "All of these temperature channels should have their item type listed as Number:Temperature.", "author": "cpmeister", "createdAt": "2020-12-04T22:08:34Z", "path": "bundles/org.openhab.binding.openthermgateway/README.md", "diffHunk": "@@ -32,36 +32,40 @@ The configuration settings for the thing are Hostname/IP address and Port, which\n \n The OpenTherm Gateway binding supports the following channels:\n \n-| Channel Type ID      | Item Type | Description                                              | Read Only |\n-|----------------------|-----------|----------------------------------------------------------|-----------|\n-| roomtemp             | Number    | Current sensed room temperature                          | yes       |\n-| roomsetpoint         | Number    | Current room temperature setpoint                        | yes       |\n-| temperaturetemporary | Number    | Temporary override room temperature setpoint             | no        |\n-| temperatureconstant  | Number    | Constant override room temperature setpoint              | no        |\n-| controlsetpoint      | Number    | Central heating water setpoint                           | yes       |\n-| dhwtemp              | Number    | Domestic hot water temperature                           | yes       |\n-| tdhwset              | Number    | Domestic hot water temperature setpoint                  | yes       |\n-| overridedhwsetpoint  | Number    | Domestic hot water temperature setpoint override         | no        |\n-| flowtemp             | Number    | Boiler water temperature                                 | yes       |\n-| returntemp           | Number    | Return water temperature                                 | yes       |\n-| outsidetemp          | Number    | Outside temperature                                      | no        |\n-| waterpressure        | Number    | Central heating water pressure                           | yes       |\n-| ch_enable            | Switch    | Central heating enabled                                  | yes       |\n-| ch_mode              | Switch    | Central heating active                                   | yes       |\n-| dhw_enable           | Switch    | Domestic hot water enabled                               | yes       |\n-| dhw_mode             | Switch    | Domestic hot water active                                | yes       |\n-| flame                | Switch    | Burner active                                            | yes       |\n-| modulevel            | Number    | Relative modulation level                                | yes       |\n-| maxrelmdulevel       | Number    | Maximum relative modulation level                        | yes       |\n-| fault                | Switch    | Fault indication                                         | yes       |\n-| servicerequest       | Switch    | Service required                                         | yes       |\n-| lockout-reset        | Switch    | Lockout-reset enabled                                    | yes       |\n-| lowwaterpress        | Switch    | Low water pressure fault                                 | yes       |\n-| gasflamefault        | Switch    | Gas or flame fault                                       | yes       |\n-| airpressfault        | Switch    | Air pressure fault                                       | yes       |\n-| waterovtemp          | Switch    | Water over-temperature fault                             | yes       |\n-| oemfaultcode         | Switch    | OEM fault code                                           | yes       |\n-| sendcommand          | Text      | Channel to send commands to the OpenTherm Gateway device | no        |\n+| Channel Type ID          | Item Type | Description                                              | Read Only |\n+|--------------------------|-----------|----------------------------------------------------------|-----------|\n+| roomtemp                 | Number    | Current sensed room temperature                          | yes       |\n+| roomsetpoint             | Number    | Current room temperature setpoint                        | yes       |\n+| temperaturetemporary     | Number    | Temporary override room temperature setpoint             | no        |\n+| temperatureconstant      | Number    | Constant override room temperature setpoint              | no        |\n+| controlsetpoint          | Number    | Central heating water setpoint set at boiler             | yes       |\n+| controlsetpointrequested | Number    | Central heating water setpoint requested by thermostat   | yes       |\n+| controlsetpointoverride  | Number    | Central heating water setpoint configured at gateway     | yes       |\n+| dhwtemp                  | Number    | Domestic hot water temperature                           | yes       |\n+| tdhwset                  | Number    | Domestic hot water temperature setpoint                  | yes       |\n+| overridedhwsetpoint      | Number    | Domestic hot water temperature setpoint override         | no        |\n+| flowtemp                 | Number    | Boiler water temperature                                 | yes       |\n+| returntemp               | Number    | Return water temperature                                 | yes       |", "originalCommit": "dd5a2dba16c079ff4230e5a3b9e86a045fd9ba05", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzEyNDk2MA==", "url": "https://github.com/openhab/openhab-addons/pull/9206#discussion_r537124960", "bodyText": "Again, I'd followed the pattern of the existing file, but I've corrected all of these and added a couple of missing UOMs in state updates alongside this.", "author": "jamesmelville", "createdAt": "2020-12-06T21:15:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQxMjMxMA=="}], "type": "inlineReview"}, {"oid": "c47f416b576fb27ff7e93f1a5c929c1f7a601fbf", "url": "https://github.com/openhab/openhab-addons/commit/c47f416b576fb27ff7e93f1a5c929c1f7a601fbf", "message": "Update from review comments\n\nSigned-off-by: James Melville <jamesmelville@gmail.com>", "committedDate": "2020-12-06T21:09:07Z", "type": "commit"}, {"oid": "7d8597ae1e2089041eb127eacac1b0511cdd55ea", "url": "https://github.com/openhab/openhab-addons/commit/7d8597ae1e2089041eb127eacac1b0511cdd55ea", "message": "Update Units\n\nSigned-off-by: James Melville <jamesmelville@gmail.com>", "committedDate": "2020-12-07T21:09:37Z", "type": "commit"}]}