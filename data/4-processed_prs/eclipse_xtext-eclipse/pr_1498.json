{"pr_number": 1498, "pr_title": "[#1497] Provide the AbstractCodeMiningTest abstract base class.", "pr_createdAt": "2020-07-31T05:54:34Z", "pr_url": "https://github.com/eclipse/xtext-eclipse/pull/1498", "timeline": [{"oid": "1b3e0a121678d94b4eb58b9f180b87500cb8e759", "url": "https://github.com/eclipse/xtext-eclipse/commit/1b3e0a121678d94b4eb58b9f180b87500cb8e759", "message": "[#1497] Provide the AbstractCodeMiningTest abstract base class.\n\n- Extend the 'Xtext UI Testing' test infrastructure by the\nAbstractCodeMiningTest abstract class to provide a base infrastructure\nfor testing the code mining capabilities.\n- Extend the Xtext Examples by CodeMiningTest test cases to\ndemonstrate the usage of the AbstractCodeMiningTest class.\n\nSigned-off-by: Tamas Miklossy <miklossy@itemis.de>", "committedDate": "2020-07-31T05:57:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQzNDQ5NA==", "url": "https://github.com/eclipse/xtext-eclipse/pull/1498#discussion_r463434494", "bodyText": "does this work with multiple codeminings? does it work with multiple codeminings at the same place? does it work if the codeminings are not sorted by offset?", "author": "cdietrich", "createdAt": "2020-07-31T06:47:03Z", "path": "org.eclipse.xtext.ui.testing/src/org/eclipse/xtext/ui/testing/AbstractCodeMiningTest.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 itemis AG (http://www.itemis.eu) and others.\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0.\n+ * \n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+package org.eclipse.xtext.ui.testing;\n+\n+import java.util.List;\n+import java.util.concurrent.ExecutionException;\n+\n+import org.eclipse.core.resources.IFile;\n+import org.eclipse.core.runtime.NullProgressMonitor;\n+import org.eclipse.jface.text.codemining.ICodeMining;\n+import org.eclipse.jface.text.codemining.ICodeMiningProvider;\n+import org.eclipse.jface.text.codemining.LineHeaderCodeMining;\n+import org.eclipse.jface.text.source.ISourceViewer;\n+import org.eclipse.xtext.resource.FileExtensionProvider;\n+import org.eclipse.xtext.ui.editor.XtextEditor;\n+\n+import com.google.common.annotations.Beta;\n+import com.google.inject.Inject;\n+\n+/**\n+ * @author miklossy - Initial contribution and API\n+ * @since 2.23\n+ */\n+@Beta\n+public class AbstractCodeMiningTest extends AbstractEditorTest {\n+\n+\t@Inject protected FileExtensionProvider fileExtensionProvider;\n+\t@Inject protected ICodeMiningProvider codeMiningProvider;\n+\n+\t/**\n+\t * Test that the expected code minings are present on a given DSL text.\n+\t *\n+\t * @param The initial DSL text.\n+\t * @param expected The DSL text where the expected code minings are inserted on the right position.\n+\t */\n+\tpublic void testCodeMining(CharSequence initialText, String expected) {\n+\t\t// Given\n+\t\tIFile dslFile = dslFile(initialText);\n+\t\t// When\n+\t\tXtextEditor editor = openEditor(dslFile);\n+\t\t// Then\n+\t\tcodeMiningsArePresent(editor, expected);\n+\t}\n+\n+\t@Override\n+\tprotected XtextEditor openEditor(IFile dslFile) {\n+\t\ttry {\n+\t\t\tXtextEditor editor = super.openEditor(dslFile);\n+\t\t\tassertNotNull(editor);\n+\t\t\treturn editor;\n+\t\t} catch (Exception e) {\n+\t\t\tthrow new RuntimeException(e);\n+\t\t}\n+\t}\n+\n+\tprotected void codeMiningsArePresent(XtextEditor editor, String expected) {\n+\t\tString actual = insertCodeMinings(editor);\n+\t\tassertEquals(expected, actual);\n+\t}\n+\n+\tprotected String insertCodeMinings(XtextEditor editor) {\n+\t\tISourceViewer viewer = editor.getInternalSourceViewer();\n+\n+\t\tString text = editor.getDocument().get();\n+\t\tStringBuilder sb = new StringBuilder();\n+\n+\t\tList<? extends ICodeMining> codeMinings;\n+\t\ttry {\n+\t\t\tcodeMinings = codeMiningProvider.provideCodeMinings(viewer, new NullProgressMonitor()).get();\n+\t\t} catch (InterruptedException | ExecutionException e) {\n+\t\t\tthrow new RuntimeException(e);\n+\t\t}\n+\n+\t\tint currentOffset = 0;\n+\n+\t\tfor (ICodeMining codeMining : codeMinings) {", "originalCommit": "1b3e0a121678d94b4eb58b9f180b87500cb8e759", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQzOTc1Mw==", "url": "https://github.com/eclipse/xtext-eclipse/pull/1498#discussion_r463439753", "bodyText": "Multiple codeminings are already supported, see org.eclipse.xtext.example.arithmetics.ui.tests.codemining.CodeMiningTest test class in the PR:\n\nI think, the other corner cases you mentioned are not supported, but the user has the possibility to override the protected String insertCodeMinings(XtextEditor editor) method to provide a custom implementation for such cases.", "author": "miklossy", "createdAt": "2020-07-31T07:02:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQzNDQ5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ0MDA4OQ==", "url": "https://github.com/eclipse/xtext-eclipse/pull/1498#discussion_r463440089", "bodyText": "i dont think we should let that up to the user ....", "author": "cdietrich", "createdAt": "2020-07-31T07:03:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQzNDQ5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ0MjMwOA==", "url": "https://github.com/eclipse/xtext-eclipse/pull/1498#discussion_r463442308", "bodyText": "the usual algorithm is to sort codeminings by offset backwards (apply them from bottom to top)", "author": "cdietrich", "createdAt": "2020-07-31T07:09:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQzNDQ5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ1MTcxNA==", "url": "https://github.com/eclipse/xtext-eclipse/pull/1498#discussion_r463451714", "bodyText": "e.g. adding\n\t\tfor (Property f :  EcoreUtil2.eAllOfType(resource.getContents().get(0), Property.class)) {\n\t\t\tint endOffset = NodeModelUtils.findActualNodeFor(f).getEndOffset();\n\t\t\tacceptor.accept(createNewLineContentCodeMining(endOffset, \" Breaking Tamas Test\"));\n\t\t}\n\nto domain model code mining provider easily breaks your code", "author": "cdietrich", "createdAt": "2020-07-31T07:33:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQzNDQ5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzY0OTQ3OQ==", "url": "https://github.com/eclipse/xtext-eclipse/pull/1498#discussion_r463649479", "bodyText": "done", "author": "miklossy", "createdAt": "2020-07-31T14:37:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQzNDQ5NA=="}], "type": "inlineReview"}, {"oid": "4e07f18500fb5c0194690162936b8987a75a44f1", "url": "https://github.com/eclipse/xtext-eclipse/commit/4e07f18500fb5c0194690162936b8987a75a44f1", "message": "[#1497] Provide the AbstractCodeMiningTest abstract base class.\n\n- Extend the 'Xtext UI Testing' test infrastructure by the\nAbstractCodeMiningTest abstract class to provide a base infrastructure\nfor testing the code mining capabilities.\n- Extend the Xtext Examples by CodeMiningTest test cases to\ndemonstrate the usage of the AbstractCodeMiningTest class.\n\nSigned-off-by: Tamas Miklossy <miklossy@itemis.de>", "committedDate": "2020-07-31T11:36:12Z", "type": "forcePushed"}, {"oid": "2380d64165c06d8abef7ca842d1628fa5a71ceed", "url": "https://github.com/eclipse/xtext-eclipse/commit/2380d64165c06d8abef7ca842d1628fa5a71ceed", "message": "[#1497] Provide the AbstractCodeMiningTest abstract base class.\n\n- Extend the 'Xtext UI Testing' test infrastructure by the\nAbstractCodeMiningTest abstract class to provide a base infrastructure\nfor testing the code mining capabilities.\n- Extend the Xtext Examples by CodeMiningTest test cases to\ndemonstrate the usage of the AbstractCodeMiningTest class.\n\nSigned-off-by: Tamas Miklossy <miklossy@itemis.de>", "committedDate": "2020-07-31T13:26:11Z", "type": "forcePushed"}, {"oid": "22fdfe161ee49ee9e6d4f53b358a376012a08c8b", "url": "https://github.com/eclipse/xtext-eclipse/commit/22fdfe161ee49ee9e6d4f53b358a376012a08c8b", "message": "[#1497] Provide the AbstractCodeMiningTest abstract base class.\n\n- Extend the 'Xtext UI Testing' test infrastructure by the\nAbstractCodeMiningTest abstract class to provide a base infrastructure\nfor testing the code mining capabilities.\n- Extend the Xtext Examples by CodeMiningTest test cases to\ndemonstrate the usage of the AbstractCodeMiningTest class.\n\nSigned-off-by: Tamas Miklossy <miklossy@itemis.de>", "committedDate": "2020-07-31T13:30:46Z", "type": "forcePushed"}, {"oid": "1c5981352489e7fb93b0c613e1c6062864bb4d5d", "url": "https://github.com/eclipse/xtext-eclipse/commit/1c5981352489e7fb93b0c613e1c6062864bb4d5d", "message": "[#1497] Provide the AbstractCodeMiningTest abstract base class.\n\n- Extend the 'Xtext UI Testing' test infrastructure by the\nAbstractCodeMiningTest abstract class to provide a base infrastructure\nfor testing the code mining capabilities.\n- Extend the Xtext Examples by CodeMiningTest test cases to\ndemonstrate the usage of the AbstractCodeMiningTest class.\n\nSigned-off-by: Tamas Miklossy <miklossy@itemis.de>", "committedDate": "2020-07-31T14:18:35Z", "type": "forcePushed"}, {"oid": "858ea280366b20a65cfaa3c7f52832e3236cabb6", "url": "https://github.com/eclipse/xtext-eclipse/commit/858ea280366b20a65cfaa3c7f52832e3236cabb6", "message": "[#1497] Provide the AbstractCodeMiningTest abstract base class.\n\n- Extend the 'Xtext UI Testing' test infrastructure by the\nAbstractCodeMiningTest abstract class to provide a base infrastructure\nfor testing the code mining capabilities.\n- Extend the Xtext Examples by CodeMiningTest test cases to\ndemonstrate the usage of the AbstractCodeMiningTest class.\n\nSigned-off-by: Tamas Miklossy <miklossy@itemis.de>", "committedDate": "2020-07-31T14:21:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzY0MzM3NQ==", "url": "https://github.com/eclipse/xtext-eclipse/pull/1498#discussion_r463643375", "bodyText": "formatting", "author": "cdietrich", "createdAt": "2020-07-31T14:26:48Z", "path": "org.eclipse.xtext.ui.testing/src/org/eclipse/xtext/ui/testing/AbstractCodeMiningTest.java", "diffHunk": "@@ -0,0 +1,182 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 itemis AG (http://www.itemis.eu) and others.\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0.\n+ * \n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+package org.eclipse.xtext.ui.testing;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.ExecutionException;\n+\n+import org.eclipse.core.resources.IFile;\n+import org.eclipse.core.runtime.NullProgressMonitor;\n+import org.eclipse.jface.text.codemining.ICodeMining;\n+import org.eclipse.jface.text.codemining.ICodeMiningProvider;\n+import org.eclipse.jface.text.codemining.LineHeaderCodeMining;\n+import org.eclipse.jface.text.source.ISourceViewer;\n+import org.eclipse.xtext.resource.FileExtensionProvider;\n+import org.eclipse.xtext.ui.editor.XtextEditor;\n+\n+import com.google.common.annotations.Beta;\n+import com.google.inject.Inject;\n+\n+/**\n+ * @author miklossy - Initial contribution and API\n+ * @since 2.23\n+ */\n+@Beta\n+public class AbstractCodeMiningTest extends AbstractEditorTest {\n+\n+\t@Inject protected FileExtensionProvider fileExtensionProvider;\n+\t@Inject protected ICodeMiningProvider codeMiningProvider;\n+\n+\t/**\n+\t * Test that the expected code minings are present on a given DSL text.\n+\t *\n+\t * @param The initial DSL text.\n+\t * @param expected The DSL text where the expected code minings are inserted on the right position.\n+\t */\n+\tpublic void testCodeMining(CharSequence initialText, String expected) {\n+\t\t// Given\n+\t\tIFile dslFile = dslFile(initialText);\n+\t\t// When\n+\t\tXtextEditor editor = openEditor(dslFile);\n+\t\t// Then\n+\t\tcodeMiningsArePresent(editor, expected);\n+\t}\n+\n+\t@Override\n+\tprotected XtextEditor openEditor(IFile dslFile) {\n+\t\ttry {\n+\t\t\tXtextEditor editor = super.openEditor(dslFile);\n+\t\t\tassertNotNull(editor);\n+\t\t\treturn editor;\n+\t\t} catch (Exception e) {\n+\t\t\tthrow new RuntimeException(e);\n+\t\t}\n+\t}\n+\n+\tprotected void codeMiningsArePresent(XtextEditor editor, String expected) {\n+\t\tString actual = insertCodeMinings(editor);\n+\t\tassertEquals(expected, actual);\n+\t}\n+\n+\tprotected String insertCodeMinings(XtextEditor editor) {\n+\t\tISourceViewer viewer = editor.getInternalSourceViewer();\n+\n+\t\tString text = editor.getDocument().get();\n+\t\tStringBuilder sb = new StringBuilder();\n+\n+\t\tList<? extends ICodeMining> codeMinings;\n+\t\ttry {\n+\t\t\tcodeMinings = codeMiningProvider.provideCodeMinings(viewer, new NullProgressMonitor()).get();\n+\t\t} catch (InterruptedException | ExecutionException e) {\n+\t\t\tthrow new RuntimeException(e);\n+\t\t}\n+\n+\t\tfor (ICodeMining codeMining : codeMinings) {\n+\t\t\ttry {\n+\t\t\t\tcodeMining.resolve(viewer, new NullProgressMonitor()).get();\n+\t\t\t} catch (InterruptedException | ExecutionException e) {\n+\t\t\t\tthrow new RuntimeException(e);\n+\t\t\t}\n+\t\t\tassertTrue(\"CodeMining is not resolved!\", codeMining.isResolved());\n+\t\t}\n+\n+\t\tcodeMinings.sort((ICodeMining cm1, ICodeMining cm2) -> cm1.getPosition().getOffset() - cm2.getPosition().getOffset());\n+\n+\t\tint currentOffset = 0;\n+\t\tfor (int i=0; i<codeMinings.size(); i++) {\n+\n+\t\t\tICodeMining codeMining = codeMinings.get(i);\n+\n+\t\t\tint codeMiningOffset = codeMining.getPosition().getOffset();\n+\n+\t\t\tList<ICodeMining> codeMiningsOnTheSameOffset = getCodeMiningsByOffset(codeMinings, codeMiningOffset);\n+\n+\t\t\tString codeMiningsText = getCodeMiningsText(codeMiningsOnTheSameOffset);\n+\n+\t\t\tsb.append(text.substring(currentOffset, codeMiningOffset) + codeMiningsText);\n+\n+\t\t\tcurrentOffset = codeMiningOffset;\n+\t\t\tif (containsLineHeaderCodeMining(codeMiningsOnTheSameOffset)) {\n+\t\t\t\tsb.append(System.lineSeparator());\n+\t\t\t\tcurrentOffset--;\n+\t\t\t}\n+\n+\t\t\ti = getLastCodeMiningOnOffset(codeMinings, codeMiningOffset);\n+\t\t}\n+\n+\t\tsb.append(text.substring(currentOffset));\n+\t\treturn sb.toString();\n+\t}\n+\n+\tprotected List<ICodeMining> getCodeMiningsByOffset(List<? extends ICodeMining> codeMinings, int offset) {\n+\t\tList<ICodeMining> result = new ArrayList<ICodeMining>();\n+\t\tfor (ICodeMining codeMining : codeMinings) {\n+\t\t\tint codeMiningOffset = codeMining.getPosition().getOffset();\n+\t\t\tif (codeMiningOffset == offset) {\n+\t\t\t\tresult.add(codeMining);\n+\t\t\t}\n+\t\t}\n+\t\treturn result;\n+\t}\n+\t\n+\tprotected String getCodeMiningsText(List<? extends ICodeMining> codeMinings) {\n+\t\tStringBuilder result = new StringBuilder();\n+\n+\t\tint count = 0;\n+\t\tfor (ICodeMining codeMining : codeMinings) {\n+\t\t\tString codeMiningLabel = codeMining.getLabel();\n+\t\t\tif (codeMiningLabel != null) {\n+\t\t\t\tif (count != 0) {\n+\t\t\t\t\tresult.append(\" | \");\n+\t\t\t\t}\n+\t\t\t\tresult.append(codeMiningLabel);\n+\t\t\t}\n+\t\t\tcount++;\n+\t\t}\n+\t\treturn result.toString();\n+\t}\n+\n+\tprotected boolean containsLineHeaderCodeMining(List<ICodeMining> codeMinings) {\n+\t\tfor (ICodeMining codeMining : codeMinings) {\n+\t\t\tif (codeMining instanceof LineHeaderCodeMining) {\n+\t\t\t\treturn true;\n+\t\t\t}\n+\t\t}\n+\t\treturn false;\n+\t}\n+\n+\tprotected int getLastCodeMiningOnOffset(List<? extends ICodeMining> codeMinings, int offset) {\n+\t\tint i = 0;\n+\t\tfor(;i<codeMinings.size();i++) {", "originalCommit": "858ea280366b20a65cfaa3c7f52832e3236cabb6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzY0OTM2NA==", "url": "https://github.com/eclipse/xtext-eclipse/pull/1498#discussion_r463649364", "bodyText": "done", "author": "miklossy", "createdAt": "2020-07-31T14:37:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzY0MzM3NQ=="}], "type": "inlineReview"}, {"oid": "e482b78264a850e3a466f716e61420b40277373c", "url": "https://github.com/eclipse/xtext-eclipse/commit/e482b78264a850e3a466f716e61420b40277373c", "message": "[#1497] Provide the AbstractCodeMiningTest abstract base class.\n\n- Extend the 'Xtext UI Testing' test infrastructure by the\nAbstractCodeMiningTest abstract class to provide a base infrastructure\nfor testing the code mining capabilities.\n- Extend the Xtext Examples by CodeMiningTest test cases to\ndemonstrate the usage of the AbstractCodeMiningTest class.\n\nSigned-off-by: Tamas Miklossy <miklossy@itemis.de>", "committedDate": "2020-07-31T14:36:45Z", "type": "forcePushed"}, {"oid": "49b1316e1c19a58c442b76759d78332f46dd303c", "url": "https://github.com/eclipse/xtext-eclipse/commit/49b1316e1c19a58c442b76759d78332f46dd303c", "message": "[#1497] Provide the AbstractCodeMiningTest abstract base class.\n\n- Extend the 'Xtext UI Testing' test infrastructure by the\nAbstractCodeMiningTest abstract class to provide a base infrastructure\nfor testing the code mining capabilities.\n- Extend the Xtext Examples by CodeMiningTest test cases to\ndemonstrate the usage of the AbstractCodeMiningTest class.\n\nSigned-off-by: Tamas Miklossy <miklossy@itemis.de>", "committedDate": "2020-07-31T14:38:47Z", "type": "commit"}, {"oid": "49b1316e1c19a58c442b76759d78332f46dd303c", "url": "https://github.com/eclipse/xtext-eclipse/commit/49b1316e1c19a58c442b76759d78332f46dd303c", "message": "[#1497] Provide the AbstractCodeMiningTest abstract base class.\n\n- Extend the 'Xtext UI Testing' test infrastructure by the\nAbstractCodeMiningTest abstract class to provide a base infrastructure\nfor testing the code mining capabilities.\n- Extend the Xtext Examples by CodeMiningTest test cases to\ndemonstrate the usage of the AbstractCodeMiningTest class.\n\nSigned-off-by: Tamas Miklossy <miklossy@itemis.de>", "committedDate": "2020-07-31T14:38:47Z", "type": "forcePushed"}]}