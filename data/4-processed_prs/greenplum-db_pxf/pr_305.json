{"pr_number": 305, "pr_title": "pxf cluster init: enforce JAVA_HOME is set", "pr_createdAt": "2020-02-25T01:40:44Z", "pr_url": "https://github.com/greenplum-db/pxf/pull/305", "timeline": [{"oid": "63c5fc5065cce3409c280b78984fe3c9fa650ce9", "url": "https://github.com/greenplum-db/pxf/commit/63c5fc5065cce3409c280b78984fe3c9fa650ce9", "message": "pxf cluster init: enforce JAVA_HOME is set\n\nSometimes users want to use a specific version of Java with PXF. In the\ncurrent world, initializing PXF can become awkward. We would ask the\nuser to temporarily set `JAVA_HOME` in `~.bashrc` to perform the init\n(or `pxf-env-default.sh`, which users shouldn't touch). Then after init,\nwe would ask them to manually adjust `JAVA_HOME` in\n`$PXF_CONF/conf/pxf-env.sh` for their custom PXF value and optionally\nswitch back in `~/.bashrc`.\n\nThis PR proposes a better scenario where we enforce that JAVA_HOME is\nvalid in `pxf cluster init` by passing from the commands environment to\nthe remote hosts. Command then looks like this:\n\n`JAVA_HOME=/correct/java/home pxf cluster init`\n\nThe init script also edits $PXF_CONF/conf/pxf-env.sh to make sure that\nPXF will always have this correct value of `JAVA_HOME`. Users can have\nwhatever they like in their startup scripts, etc. for `JAVA_HOME`.\n\nAlso `pxf-service` stops telling users to edit `pxf-env-default.sh`.\n\nAuthored-by: Oliver Albertini <oalbertini@pivotal.io>", "committedDate": "2020-02-25T01:41:57Z", "type": "forcePushed"}, {"oid": "7f18040c8422fa387d6bedd3c3cd1d9337380fd7", "url": "https://github.com/greenplum-db/pxf/commit/7f18040c8422fa387d6bedd3c3cd1d9337380fd7", "message": "pxf cluster init: enforce JAVA_HOME is set\n\nSometimes users want to use a specific version of Java with PXF. In the\ncurrent world, initializing PXF can become awkward. We would ask the\nuser to temporarily set `JAVA_HOME` in `~/.bashrc` to perform the init\n(or `pxf-env-default.sh`, which users shouldn't touch). Then after init,\nwe would ask them to manually adjust `JAVA_HOME` in\n`$PXF_CONF/conf/pxf-env.sh` for their custom PXF value and optionally\nswitch back in `~/.bashrc`.\n\nThis PR proposes a better scenario where we enforce that `JAVA_HOME` is\nvalid in `pxf cluster init` by passing from the command's environment to\nthe remote hosts. Command then looks like this:\n\n`JAVA_HOME=/correct/java/home pxf cluster init`\n\nThe `pxf-service` script also edits `$PXF_CONF/conf/pxf-env.sh` to make\nsure that\nPXF will always have the correct value of `JAVA_HOME`. Users can thus\nhave\nwhatever they like in their startup scripts, etc. for `JAVA_HOME`.\n\nAlso `pxf-service` stops telling users to edit `pxf-env-default.sh`.\n\nAuthored-by: Oliver Albertini <oalbertini@pivotal.io>", "committedDate": "2020-02-25T01:46:36Z", "type": "forcePushed"}, {"oid": "b97848f29aea755c272b88b3ff85e2547544240e", "url": "https://github.com/greenplum-db/pxf/commit/b97848f29aea755c272b88b3ff85e2547544240e", "message": "pxf cluster init: enforce JAVA_HOME is set\n\nSometimes users want to use a specific version of Java with PXF. In the\ncurrent world, initializing PXF can become awkward. We would ask the\nuser to temporarily set JAVA_HOME in ~/.bashrc to perform the init (or\npxf-env-default.sh, which users shouldn't touch). Then after init, we\nwould ask them to manually adjust JAVA_HOME in $PXF_CONF/conf/pxf-env.sh\nfor their custom PXF value and optionally switch back in ~/.bashrc.\n\nThis PR proposes a better scenario where we enforce that JAVA_HOME is\nvalid in pxf cluster init by passing from the command's environment to\nthe remote hosts. Command then looks like this:\n\n`JAVA_HOME=/correct/java/home pxf cluster init`\n\nThe pxf-service script also edits $PXF_CONF/conf/pxf-env.sh to make sure\nthat PXF will always have the correct value of JAVA_HOME. Users can thus\nhave whatever they like in their startup scripts, etc. for JAVA_HOME.\n\nAlso pxf-service stops telling users to edit pxf-env-default.sh.\n\nAuthored-by: Oliver Albertini <oalbertini@pivotal.io>", "committedDate": "2020-02-25T04:40:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA0OTg4Nw==", "url": "https://github.com/greenplum-db/pxf/pull/305#discussion_r384049887", "bodyText": "consistency: other functions start with keyword function", "author": "denalex", "createdAt": "2020-02-25T18:38:22Z", "path": "server/pxf-service/src/scripts/pxf-service", "diffHunk": "@@ -107,7 +107,7 @@ checkJavaHome()\n {\n     # validate JAVA_HOME\n     if [[ ! -x ${JAVA_HOME}/bin/java ]]; then\n-        fail \"\\$JAVA_HOME=$JAVA_HOME is invalid. Set \\$JAVA_HOME in ~/.bashrc or $default_env_script on all Greenplum hosts.\"\n+        fail \"\\$JAVA_HOME=$JAVA_HOME is invalid. Set \\$JAVA_HOME in your environment before initializing PXF.\"", "originalCommit": "b97848f29aea755c272b88b3ff85e2547544240e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA0OTk2MQ==", "url": "https://github.com/greenplum-db/pxf/pull/305#discussion_r384049961", "bodyText": "consistency: other functions start with keyword function", "author": "denalex", "createdAt": "2020-02-25T18:38:29Z", "path": "server/pxf-service/src/scripts/pxf-service", "diffHunk": "@@ -371,12 +371,19 @@ function doInit()\n     checkJavaHome\n     generatePrivateClasspath || return 1\n     generateUserConfigs || return 1\n+    editPxfEnvSh || return 1\n     createInstance || return 1\n     deployWebapp || return 1\n     createLogsDir || return 1\n     createRunDir  || return 1\n }\n \n+editPxfEnvSh()", "originalCommit": "b97848f29aea755c272b88b3ff85e2547544240e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA1NDYyMA==", "url": "https://github.com/greenplum-db/pxf/pull/305#discussion_r384054620", "bodyText": "in the overall flow we call checkJavaHome (line 371) before calling this function, so we are guaranteed it is set to correct path and probably there's no need to check here again ?", "author": "denalex", "createdAt": "2020-02-25T18:47:03Z", "path": "server/pxf-service/src/scripts/pxf-service", "diffHunk": "@@ -371,12 +371,19 @@ function doInit()\n     checkJavaHome\n     generatePrivateClasspath || return 1\n     generateUserConfigs || return 1\n+    editPxfEnvSh || return 1\n     createInstance || return 1\n     deployWebapp || return 1\n     createLogsDir || return 1\n     createRunDir  || return 1\n }\n \n+editPxfEnvSh()\n+{\n+\t[[ -z ${JAVA_HOME} ]] && return 1", "originalCommit": "b97848f29aea755c272b88b3ff85e2547544240e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA3ODg4Ng==", "url": "https://github.com/greenplum-db/pxf/pull/305#discussion_r384078886", "bodyText": "yes, it's kind of overkill", "author": "oliverralbertini", "createdAt": "2020-02-25T19:31:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA1NDYyMA=="}], "type": "inlineReview"}, {"oid": "11fa36636b18bff9277858ee8da044a77c879f95", "url": "https://github.com/greenplum-db/pxf/commit/11fa36636b18bff9277858ee8da044a77c879f95", "message": "pxf cluster init: enforce JAVA_HOME is set\n\nSometimes users want to use a specific version of Java with PXF. In the\ncurrent world, initializing PXF can become awkward. We would ask the\nuser to temporarily set JAVA_HOME in ~/.bashrc to perform the init (or\npxf-env-default.sh, which users shouldn't touch). Then after init, we\nwould ask them to manually adjust JAVA_HOME in $PXF_CONF/conf/pxf-env.sh\nfor their custom PXF value and optionally switch back in ~/.bashrc.\n\nThis PR proposes a better scenario where we enforce that JAVA_HOME is\nvalid in pxf cluster init by passing from the command's environment to\nthe remote hosts. Command then looks like this:\n\n`JAVA_HOME=/correct/java/home pxf cluster init`\n\nThe pxf-service script also edits $PXF_CONF/conf/pxf-env.sh to make sure\nthat PXF will always have the correct value of JAVA_HOME. Users can thus\nhave whatever they like in their startup scripts, etc. for JAVA_HOME.\n\nAlso pxf-service stops telling users to edit pxf-env-default.sh.\n\nAuthored-by: Oliver Albertini <oalbertini@pivotal.io>", "committedDate": "2020-02-25T19:30:36Z", "type": "forcePushed"}, {"oid": "c2accbb3d14e632ee9472d5a1e644e3e595acf89", "url": "https://github.com/greenplum-db/pxf/commit/c2accbb3d14e632ee9472d5a1e644e3e595acf89", "message": "pxf cluster init: enforce JAVA_HOME is set\n\nSometimes users want to use a specific version of Java with PXF. In the\ncurrent world, initializing PXF can become awkward. We would ask the\nuser to temporarily set JAVA_HOME in ~/.bashrc to perform the init (or\npxf-env-default.sh, which users shouldn't touch). Then after init, we\nwould ask them to manually adjust JAVA_HOME in $PXF_CONF/conf/pxf-env.sh\nfor their custom PXF value and optionally switch back in ~/.bashrc.\n\nThis PR proposes a better scenario where we enforce that JAVA_HOME is\nvalid in pxf cluster init by passing from the command's environment to\nthe remote hosts. Command then looks like this:\n\n`JAVA_HOME=/correct/java/home pxf cluster init`\n\nThe pxf-service script also edits $PXF_CONF/conf/pxf-env.sh to make sure\nthat PXF will always have the correct value of JAVA_HOME. Users can thus\nhave whatever they like in their startup scripts, etc. for JAVA_HOME.\n\nAlso pxf-service stops telling users to edit pxf-env-default.sh.\n\nAuthored-by: Oliver Albertini <oalbertini@pivotal.io>", "committedDate": "2020-02-25T19:53:02Z", "type": "commit"}, {"oid": "c2accbb3d14e632ee9472d5a1e644e3e595acf89", "url": "https://github.com/greenplum-db/pxf/commit/c2accbb3d14e632ee9472d5a1e644e3e595acf89", "message": "pxf cluster init: enforce JAVA_HOME is set\n\nSometimes users want to use a specific version of Java with PXF. In the\ncurrent world, initializing PXF can become awkward. We would ask the\nuser to temporarily set JAVA_HOME in ~/.bashrc to perform the init (or\npxf-env-default.sh, which users shouldn't touch). Then after init, we\nwould ask them to manually adjust JAVA_HOME in $PXF_CONF/conf/pxf-env.sh\nfor their custom PXF value and optionally switch back in ~/.bashrc.\n\nThis PR proposes a better scenario where we enforce that JAVA_HOME is\nvalid in pxf cluster init by passing from the command's environment to\nthe remote hosts. Command then looks like this:\n\n`JAVA_HOME=/correct/java/home pxf cluster init`\n\nThe pxf-service script also edits $PXF_CONF/conf/pxf-env.sh to make sure\nthat PXF will always have the correct value of JAVA_HOME. Users can thus\nhave whatever they like in their startup scripts, etc. for JAVA_HOME.\n\nAlso pxf-service stops telling users to edit pxf-env-default.sh.\n\nAuthored-by: Oliver Albertini <oalbertini@pivotal.io>", "committedDate": "2020-02-25T19:53:02Z", "type": "forcePushed"}]}