{"pr_number": 396, "pr_title": "Address Feedback fix spring boot TODOs", "pr_createdAt": "2020-06-24T14:58:47Z", "pr_url": "https://github.com/greenplum-db/pxf/pull/396", "timeline": [{"oid": "2f39cdecf2a969ea1f65995e6d106141079d2267", "url": "https://github.com/greenplum-db/pxf/commit/2f39cdecf2a969ea1f65995e6d106141079d2267", "message": "Address Feedback fix spring boot TODOs\n\n- install-dev -> install-server\n- fix expected output on some files\n- refactor trace/hint information on the c-side\n- remove path from Writable/stream endpoint as it is no longer used\n- refactor PxfErrorAttributes\n- address spring_boot_todo\n- expose only a few endpoints (health, info, shutdown)", "committedDate": "2020-06-24T15:10:12Z", "type": "forcePushed"}, {"oid": "b01d6cd2fd2265dfb01492b76b1d4d886cdce479", "url": "https://github.com/greenplum-db/pxf/commit/b01d6cd2fd2265dfb01492b76b1d4d886cdce479", "message": "Address Feedback fix spring boot TODOs\n\n- install-dev -> install-server\n- fix expected output on some files\n- refactor trace/hint information on the c-side\n- remove path from Writable/stream endpoint as it is no longer used\n- refactor PxfErrorAttributes\n- address spring_boot_todo\n- expose only a few endpoints (health, info, shutdown)", "committedDate": "2020-06-24T15:11:31Z", "type": "commit"}, {"oid": "b01d6cd2fd2265dfb01492b76b1d4d886cdce479", "url": "https://github.com/greenplum-db/pxf/commit/b01d6cd2fd2265dfb01492b76b1d4d886cdce479", "message": "Address Feedback fix spring boot TODOs\n\n- install-dev -> install-server\n- fix expected output on some files\n- refactor trace/hint information on the c-side\n- remove path from Writable/stream endpoint as it is no longer used\n- refactor PxfErrorAttributes\n- address spring_boot_todo\n- expose only a few endpoints (health, info, shutdown)", "committedDate": "2020-06-24T15:11:31Z", "type": "forcePushed"}, {"oid": "273edaac04ffca972dba27ae9b4e221420bcf966", "url": "https://github.com/greenplum-db/pxf/commit/273edaac04ffca972dba27ae9b4e221420bcf966", "message": "PxfThreadPoolTaskExecutor: Create as a bean\n\nBy creating PxfThreadPoolTaskExecutor as a bean, we guarantee that the\nshutdown method will be closed when the application is shutting down,\nbecause beans have a destroy method, and in the case of\nPxfThreadPoolTaskExecutor the destroy method calls shutdown when the\napplication is shutting down.", "committedDate": "2020-06-24T17:16:17Z", "type": "commit"}, {"oid": "273edaac04ffca972dba27ae9b4e221420bcf966", "url": "https://github.com/greenplum-db/pxf/commit/273edaac04ffca972dba27ae9b4e221420bcf966", "message": "PxfThreadPoolTaskExecutor: Create as a bean\n\nBy creating PxfThreadPoolTaskExecutor as a bean, we guarantee that the\nshutdown method will be closed when the application is shutting down,\nbecause beans have a destroy method, and in the case of\nPxfThreadPoolTaskExecutor the destroy method calls shutdown when the\napplication is shutting down.", "committedDate": "2020-06-24T17:16:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA1ODQwMQ==", "url": "https://github.com/greenplum-db/pxf/pull/396#discussion_r445058401", "bodyText": "wonder why this was needed", "author": "denalex", "createdAt": "2020-06-24T17:32:50Z", "path": "external-table/src/libchurl.c", "diffHunk": "@@ -640,12 +640,12 @@ flush_internal_buffer(churl_context *context)\n \t\tmulti_perform(context);\n \t}\n \n+\tcheck_response(context);\n+", "originalCommit": "273edaac04ffca972dba27ae9b4e221420bcf966", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA3MjcwOQ==", "url": "https://github.com/greenplum-db/pxf/pull/396#discussion_r445072709", "bodyText": "in one case the response was closed by the server, but we already had a response in the buffer, so we could actually take some action in that case. For example, check the response code", "author": "frankgh", "createdAt": "2020-06-24T17:58:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA1ODQwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA2MTAyMg==", "url": "https://github.com/greenplum-db/pxf/pull/396#discussion_r445061022", "bodyText": "the comment above lines 21-24 is no longer relevant (registerSecurityServletFilter)", "author": "denalex", "createdAt": "2020-06-24T17:37:40Z", "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/PxfConfiguration.java", "diffHunk": "@@ -9,30 +10,64 @@\n import org.springframework.context.annotation.Bean;\n import org.springframework.context.annotation.Configuration;\n import org.springframework.context.annotation.Lazy;\n+import org.springframework.core.task.AsyncTaskExecutor;\n import org.springframework.core.task.TaskDecorator;\n+import org.springframework.core.task.TaskExecutor;\n import org.springframework.scheduling.annotation.AsyncAnnotationBeanPostProcessor;\n import org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;\n-\n-import static org.springframework.boot.autoconfigure.task.TaskExecutionAutoConfiguration.APPLICATION_TASK_EXECUTOR_BEAN_NAME;\n+import org.springframework.web.servlet.config.annotation.AsyncSupportConfigurer;\n+import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;\n \n /**\n  * Declares the registerSecurityServletFilter bean method to be processed by\n  * the Spring container\n  */\n @Configuration\n @EnableConfigurationProperties(PxfServerProperties.class)\n-public class PxfConfiguration {\n+public class PxfConfiguration implements WebMvcConfigurer {", "originalCommit": "273edaac04ffca972dba27ae9b4e221420bcf966", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA2MTQwNw==", "url": "https://github.com/greenplum-db/pxf/pull/396#discussion_r445061407", "bodyText": "I thought we did not want lazy init unless absolutely required", "author": "denalex", "createdAt": "2020-06-24T17:38:24Z", "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/PxfConfiguration.java", "diffHunk": "@@ -9,30 +10,64 @@\n import org.springframework.context.annotation.Bean;\n import org.springframework.context.annotation.Configuration;\n import org.springframework.context.annotation.Lazy;\n+import org.springframework.core.task.AsyncTaskExecutor;\n import org.springframework.core.task.TaskDecorator;\n+import org.springframework.core.task.TaskExecutor;\n import org.springframework.scheduling.annotation.AsyncAnnotationBeanPostProcessor;\n import org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;\n-\n-import static org.springframework.boot.autoconfigure.task.TaskExecutionAutoConfiguration.APPLICATION_TASK_EXECUTOR_BEAN_NAME;\n+import org.springframework.web.servlet.config.annotation.AsyncSupportConfigurer;\n+import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;\n \n /**\n  * Declares the registerSecurityServletFilter bean method to be processed by\n  * the Spring container\n  */\n @Configuration\n @EnableConfigurationProperties(PxfServerProperties.class)\n-public class PxfConfiguration {\n+public class PxfConfiguration implements WebMvcConfigurer {\n+\n+    /**\n+     * Bean name of PXF's {@link TaskExecutor}.\n+     */\n+    public static final String PXF_APPLICATION_TASK_EXECUTOR_BEAN_NAME = \"pxfApplicationTaskExecutor\";\n+\n+    private final ListableBeanFactory beanFactory;\n+\n+    /**\n+     * Constructs a PXF Configuration object with the provided\n+     * {@link ListableBeanFactory}\n+     *\n+     * @param beanFactory the beanFactory\n+     */\n+    public PxfConfiguration(ListableBeanFactory beanFactory) {\n+        this.beanFactory = beanFactory;\n+    }\n \n     /**\n-     * Configures the TaskExecutorBuilder to be used for async requests (i.e. Bridge\n+     * Configures the TaskExecutor to be used for async requests (i.e. Bridge\n      * Read).\n+     */\n+    @Override\n+    public void configureAsyncSupport(AsyncSupportConfigurer configurer) {\n+        Object taskExecutor = this.beanFactory\n+                .getBean(PXF_APPLICATION_TASK_EXECUTOR_BEAN_NAME);\n+        if (taskExecutor instanceof AsyncTaskExecutor) {\n+            configurer.setTaskExecutor(((AsyncTaskExecutor) taskExecutor));\n+        }\n+    }\n+\n+    /**\n+     * Configures and builds the {@link ThreadPoolTaskExecutor}\n      *\n-     * @return the {@link TaskExecutorBuilder} object\n+     * @return the {@link ThreadPoolTaskExecutor}\n      */\n-    @Bean\n-    public TaskExecutorBuilder taskExecutorBuilder(PxfServerProperties pxfServerProperties,\n-                                                   ObjectProvider<TaskExecutorCustomizer> taskExecutorCustomizers,\n-                                                   ObjectProvider<TaskDecorator> taskDecorator) {\n+    @Lazy", "originalCommit": "273edaac04ffca972dba27ae9b4e221420bcf966", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA3MzA0NA==", "url": "https://github.com/greenplum-db/pxf/pull/396#discussion_r445073044", "bodyText": "Yeah, I'll address it", "author": "frankgh", "createdAt": "2020-06-24T17:58:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA2MTQwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA2ODcxOQ==", "url": "https://github.com/greenplum-db/pxf/pull/396#discussion_r445068719", "bodyText": "can we fine-tune a name -- it is not executing any arbitrary pxf tasks, this is for async response streaming only, in other words we should not be submitting any arbitrary async work here, right ? Maybe pxfResponseStreamTaskExecutor or smith even simpler", "author": "denalex", "createdAt": "2020-06-24T17:50:59Z", "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/PxfConfiguration.java", "diffHunk": "@@ -9,30 +10,64 @@\n import org.springframework.context.annotation.Bean;\n import org.springframework.context.annotation.Configuration;\n import org.springframework.context.annotation.Lazy;\n+import org.springframework.core.task.AsyncTaskExecutor;\n import org.springframework.core.task.TaskDecorator;\n+import org.springframework.core.task.TaskExecutor;\n import org.springframework.scheduling.annotation.AsyncAnnotationBeanPostProcessor;\n import org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;\n-\n-import static org.springframework.boot.autoconfigure.task.TaskExecutionAutoConfiguration.APPLICATION_TASK_EXECUTOR_BEAN_NAME;\n+import org.springframework.web.servlet.config.annotation.AsyncSupportConfigurer;\n+import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;\n \n /**\n  * Declares the registerSecurityServletFilter bean method to be processed by\n  * the Spring container\n  */\n @Configuration\n @EnableConfigurationProperties(PxfServerProperties.class)\n-public class PxfConfiguration {\n+public class PxfConfiguration implements WebMvcConfigurer {\n+\n+    /**\n+     * Bean name of PXF's {@link TaskExecutor}.\n+     */\n+    public static final String PXF_APPLICATION_TASK_EXECUTOR_BEAN_NAME = \"pxfApplicationTaskExecutor\";", "originalCommit": "273edaac04ffca972dba27ae9b4e221420bcf966", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA2OTc5OA==", "url": "https://github.com/greenplum-db/pxf/pull/396#discussion_r445069798", "bodyText": "why if ? We expect our own bean here, so cast or let it fail the startup if somehow misconfigured", "author": "denalex", "createdAt": "2020-06-24T17:53:00Z", "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/PxfConfiguration.java", "diffHunk": "@@ -9,30 +10,64 @@\n import org.springframework.context.annotation.Bean;\n import org.springframework.context.annotation.Configuration;\n import org.springframework.context.annotation.Lazy;\n+import org.springframework.core.task.AsyncTaskExecutor;\n import org.springframework.core.task.TaskDecorator;\n+import org.springframework.core.task.TaskExecutor;\n import org.springframework.scheduling.annotation.AsyncAnnotationBeanPostProcessor;\n import org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;\n-\n-import static org.springframework.boot.autoconfigure.task.TaskExecutionAutoConfiguration.APPLICATION_TASK_EXECUTOR_BEAN_NAME;\n+import org.springframework.web.servlet.config.annotation.AsyncSupportConfigurer;\n+import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;\n \n /**\n  * Declares the registerSecurityServletFilter bean method to be processed by\n  * the Spring container\n  */\n @Configuration\n @EnableConfigurationProperties(PxfServerProperties.class)\n-public class PxfConfiguration {\n+public class PxfConfiguration implements WebMvcConfigurer {\n+\n+    /**\n+     * Bean name of PXF's {@link TaskExecutor}.\n+     */\n+    public static final String PXF_APPLICATION_TASK_EXECUTOR_BEAN_NAME = \"pxfApplicationTaskExecutor\";\n+\n+    private final ListableBeanFactory beanFactory;\n+\n+    /**\n+     * Constructs a PXF Configuration object with the provided\n+     * {@link ListableBeanFactory}\n+     *\n+     * @param beanFactory the beanFactory\n+     */\n+    public PxfConfiguration(ListableBeanFactory beanFactory) {\n+        this.beanFactory = beanFactory;\n+    }\n \n     /**\n-     * Configures the TaskExecutorBuilder to be used for async requests (i.e. Bridge\n+     * Configures the TaskExecutor to be used for async requests (i.e. Bridge\n      * Read).\n+     */\n+    @Override\n+    public void configureAsyncSupport(AsyncSupportConfigurer configurer) {\n+        Object taskExecutor = this.beanFactory\n+                .getBean(PXF_APPLICATION_TASK_EXECUTOR_BEAN_NAME);\n+        if (taskExecutor instanceof AsyncTaskExecutor) {", "originalCommit": "273edaac04ffca972dba27ae9b4e221420bcf966", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0082592a6544d20336e06a2de25829265fae4adb", "url": "https://github.com/greenplum-db/pxf/commit/0082592a6544d20336e06a2de25829265fae4adb", "message": "Change the hint to require set client_min_messages=DEBUG1\n\nAsk users to set client_min_messages=LOG instead, because DEBUG1 prints\nout too much information, and LOG seems like a good level where not too\nmuch is printed, but we print the stack trace", "committedDate": "2020-06-24T18:02:35Z", "type": "commit"}, {"oid": "8baaf859dcfa59f44bd894eb9b6b3ec62cc489d2", "url": "https://github.com/greenplum-db/pxf/commit/8baaf859dcfa59f44bd894eb9b6b3ec62cc489d2", "message": "Address PR feedback", "committedDate": "2020-06-24T18:07:24Z", "type": "commit"}, {"oid": "bf103042ae079efa1a93b9a57cb14f35c11a79b2", "url": "https://github.com/greenplum-db/pxf/commit/bf103042ae079efa1a93b9a57cb14f35c11a79b2", "message": "PXF_APPLICATION_TASK_EXECUTOR_BEAN_NAME -> PXF_RESPONSE_STREAM_TASK_EXECUTOR", "committedDate": "2020-06-24T19:30:51Z", "type": "commit"}]}