{"pr_number": 453, "pr_title": "Release UGI if there is an error during the filter execution", "pr_createdAt": "2020-09-22T14:54:30Z", "pr_url": "https://github.com/greenplum-db/pxf/pull/453", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkxNjgyNg==", "url": "https://github.com/greenplum-db/pxf/pull/453#discussion_r492916826", "bodyText": "I'd prefer to leave this line as before to capture the semantic meaning of the incoming header. we can tie it to releaseUGI logic elsewhere", "author": "denalex", "createdAt": "2020-09-22T17:37:31Z", "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/servlet/SecurityServletFilter.java", "diffHunk": "@@ -101,7 +101,7 @@ public void doFilter(final ServletRequest request, final ServletResponse respons\n         final String gpdbUser = getHeaderValue(request, USER_HEADER, true);\n         final String transactionId = getHeaderValue(request, TRANSACTION_ID_HEADER, true);\n         final Integer segmentId = getHeaderValueInt(request, SEGMENT_ID_HEADER, true);\n-        final boolean lastCallForSegment = getHeaderValueBoolean(request, LAST_FRAGMENT_HEADER, false);\n+        boolean releaseUgi = getHeaderValueBoolean(request, LAST_FRAGMENT_HEADER, false);", "originalCommit": "37beefa671d533141a6571645c2a020df0880a83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAyNDMzMw==", "url": "https://github.com/greenplum-db/pxf/pull/453#discussion_r493024333", "bodyText": "sure, makes sense", "author": "frankgh", "createdAt": "2020-09-22T20:48:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkxNjgyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkyMDMyOA==", "url": "https://github.com/greenplum-db/pxf/pull/453#discussion_r492920328", "bodyText": "this semantic is not clear now. It would log \"Last fragment call\" if that was indeed last request for fragment data. We don't want to have this printed on error, so maybe have 2 conditions for UGI release - last call and error ?", "author": "denalex", "createdAt": "2020-09-22T17:43:24Z", "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/servlet/SecurityServletFilter.java", "diffHunk": "@@ -157,20 +157,22 @@ public void doFilter(final ServletRequest request, final ServletResponse respons\n             // Execute the servlet chain as that user\n             userGroupInformation.doAs(action);\n         } catch (UndeclaredThrowableException ute) {\n+            releaseUgi = true;\n             // unwrap the real exception thrown by the action\n             throw new ServletException(ute.getCause());\n         } catch (InterruptedException ie) {\n+            releaseUgi = true;\n             throw new ServletException(ie);\n         } finally {\n             // Optimization to cleanup the cache if it is the last fragment\n             LOG.debug(\"Releasing proxy user for session: {}. {}\",\n-                    session, lastCallForSegment ? \" Last fragment call\" : \"\");\n+                    session, releaseUgi ? \" Last fragment call\" : \"\");", "originalCommit": "37beefa671d533141a6571645c2a020df0880a83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAyNDU3Mg==", "url": "https://github.com/greenplum-db/pxf/pull/453#discussion_r493024572", "bodyText": "I've addressed this issue. I think this wasn't clear in the past either, so I have updated the log message", "author": "frankgh", "createdAt": "2020-09-22T20:48:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkyMDMyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA2NTQ2Nw==", "url": "https://github.com/greenplum-db/pxf/pull/453#discussion_r493065467", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        releaseUgi = true;\n          \n          \n            \n                        exceptionDetected = true;", "author": "denalex", "createdAt": "2020-09-22T22:19:12Z", "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/servlet/SecurityServletFilter.java", "diffHunk": "@@ -157,20 +157,22 @@ public void doFilter(final ServletRequest request, final ServletResponse respons\n             // Execute the servlet chain as that user\n             userGroupInformation.doAs(action);\n         } catch (UndeclaredThrowableException ute) {\n+            releaseUgi = true;", "originalCommit": "b3a21957e1e74366e5a3c1e3fc155993591f404a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA2NTU0NA==", "url": "https://github.com/greenplum-db/pxf/pull/453#discussion_r493065544", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        releaseUgi = true;\n          \n          \n            \n                        exceptionDetected = true;", "author": "denalex", "createdAt": "2020-09-22T22:19:24Z", "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/servlet/SecurityServletFilter.java", "diffHunk": "@@ -157,20 +157,22 @@ public void doFilter(final ServletRequest request, final ServletResponse respons\n             // Execute the servlet chain as that user\n             userGroupInformation.doAs(action);\n         } catch (UndeclaredThrowableException ute) {\n+            releaseUgi = true;\n             // unwrap the real exception thrown by the action\n             throw new ServletException(ute.getCause());\n         } catch (InterruptedException ie) {\n+            releaseUgi = true;", "originalCommit": "b3a21957e1e74366e5a3c1e3fc155993591f404a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA2NjYxMg==", "url": "https://github.com/greenplum-db/pxf/pull/453#discussion_r493066612", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    boolean releaseUgi = lastCallForSegment;\n          \n          \n            \n                    boolean exceptionDetected = false;", "author": "denalex", "createdAt": "2020-09-22T22:22:11Z", "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/servlet/SecurityServletFilter.java", "diffHunk": "@@ -147,6 +146,7 @@ public void doFilter(final ServletRequest request, final ServletResponse respons\n             return true;\n         };\n \n+        boolean releaseUgi = lastCallForSegment;", "originalCommit": "b3a21957e1e74366e5a3c1e3fc155993591f404a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA2Njk4NA==", "url": "https://github.com/greenplum-db/pxf/pull/453#discussion_r493066984", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // Optimization to cleanup the cache if it is the last fragment\n          \n          \n            \n                        boolean releaseUgi = lastCallForSegment || exceptionDetected;\n          \n          \n            \n                        // Optimization to cleanup the cache if it is the last fragment", "author": "denalex", "createdAt": "2020-09-22T22:23:17Z", "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/servlet/SecurityServletFilter.java", "diffHunk": "@@ -157,20 +157,22 @@ public void doFilter(final ServletRequest request, final ServletResponse respons\n             // Execute the servlet chain as that user\n             userGroupInformation.doAs(action);\n         } catch (UndeclaredThrowableException ute) {\n+            releaseUgi = true;\n             // unwrap the real exception thrown by the action\n             throw new ServletException(ute.getCause());\n         } catch (InterruptedException ie) {\n+            releaseUgi = true;\n             throw new ServletException(ie);\n         } finally {\n             // Optimization to cleanup the cache if it is the last fragment", "originalCommit": "b3a21957e1e74366e5a3c1e3fc155993591f404a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA2NzcxMg==", "url": "https://github.com/greenplum-db/pxf/pull/453#discussion_r493067712", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        LOG.debug(\"Releasing proxy user for session: {}. {}\",\n          \n          \n            \n                        LOG.debug(\"Releasing UGI from cache for session: {}. {}\",", "author": "denalex", "createdAt": "2020-09-22T22:25:19Z", "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/servlet/SecurityServletFilter.java", "diffHunk": "@@ -157,20 +157,22 @@ public void doFilter(final ServletRequest request, final ServletResponse respons\n             // Execute the servlet chain as that user\n             userGroupInformation.doAs(action);\n         } catch (UndeclaredThrowableException ute) {\n+            releaseUgi = true;\n             // unwrap the real exception thrown by the action\n             throw new ServletException(ute.getCause());\n         } catch (InterruptedException ie) {\n+            releaseUgi = true;\n             throw new ServletException(ie);\n         } finally {\n             // Optimization to cleanup the cache if it is the last fragment\n             LOG.debug(\"Releasing proxy user for session: {}. {}\",", "originalCommit": "b3a21957e1e74366e5a3c1e3fc155993591f404a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA2Nzg4OQ==", "url": "https://github.com/greenplum-db/pxf/pull/453#discussion_r493067889", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            LOG.error(\"Error releasing UGICache for session: {}\", session, t);\n          \n          \n            \n                            LOG.error(\"Error releasing UGI from cache for session: {}\", session, t);", "author": "denalex", "createdAt": "2020-09-22T22:25:42Z", "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/servlet/SecurityServletFilter.java", "diffHunk": "@@ -157,20 +157,22 @@ public void doFilter(final ServletRequest request, final ServletResponse respons\n             // Execute the servlet chain as that user\n             userGroupInformation.doAs(action);\n         } catch (UndeclaredThrowableException ute) {\n+            releaseUgi = true;\n             // unwrap the real exception thrown by the action\n             throw new ServletException(ute.getCause());\n         } catch (InterruptedException ie) {\n+            releaseUgi = true;\n             throw new ServletException(ie);\n         } finally {\n             // Optimization to cleanup the cache if it is the last fragment\n             LOG.debug(\"Releasing proxy user for session: {}. {}\",\n-                    session, lastCallForSegment ? \" Last fragment call\" : \"\");\n+                    session, releaseUgi ? \" Cleaning UGI immediately from UGICache if there are no other references to this UGI entry.\" : \"\");\n             try {\n-                ugiCache.release(session, lastCallForSegment);\n+                ugiCache.release(session, releaseUgi);\n             } catch (Throwable t) {\n                 LOG.error(\"Error releasing UGICache for session: {}\", session, t);", "originalCommit": "b3a21957e1e74366e5a3c1e3fc155993591f404a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA2OTU4OQ==", "url": "https://github.com/greenplum-db/pxf/pull/453#discussion_r493069589", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                session, releaseUgi ? \" Cleaning UGI immediately from UGICache if there are no other references to this UGI entry.\" : \"\");\n          \n          \n            \n                                session, exceptionDetected ? \" Exception while processing\" : (lastCallForSegment ? \" Processed last fragment for segment\" : \"\"));", "author": "denalex", "createdAt": "2020-09-22T22:30:13Z", "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/servlet/SecurityServletFilter.java", "diffHunk": "@@ -157,20 +157,22 @@ public void doFilter(final ServletRequest request, final ServletResponse respons\n             // Execute the servlet chain as that user\n             userGroupInformation.doAs(action);\n         } catch (UndeclaredThrowableException ute) {\n+            releaseUgi = true;\n             // unwrap the real exception thrown by the action\n             throw new ServletException(ute.getCause());\n         } catch (InterruptedException ie) {\n+            releaseUgi = true;\n             throw new ServletException(ie);\n         } finally {\n             // Optimization to cleanup the cache if it is the last fragment\n             LOG.debug(\"Releasing proxy user for session: {}. {}\",\n-                    session, lastCallForSegment ? \" Last fragment call\" : \"\");\n+                    session, releaseUgi ? \" Cleaning UGI immediately from UGICache if there are no other references to this UGI entry.\" : \"\");", "originalCommit": "b3a21957e1e74366e5a3c1e3fc155993591f404a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA3MDE1NQ==", "url": "https://github.com/greenplum-db/pxf/pull/453#discussion_r493070155", "bodyText": "we don't need to explain in the DEBUG log statement, but we need to reflect which path our logic took for troubleshooting, so would like to know why we are calling this -- due to exception or receiving last fragment flag", "author": "denalex", "createdAt": "2020-09-22T22:31:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA2OTU4OQ=="}], "type": "inlineReview"}, {"oid": "2f8888cad39c3ccfd03ed0bc2fa60a9944216ec3", "url": "https://github.com/greenplum-db/pxf/commit/2f8888cad39c3ccfd03ed0bc2fa60a9944216ec3", "message": "Release UGI if there is an error during the filter execution\n\nWhen the filter execution fails, for example when accessing a\nnon-existing HCFS path, the fragmenter call will throw an\nInvalidInputException. This causes all segments to leave the UGI entry\navailable, and the FileSystem associated to the UGI does not get closed\nuntil the UGI entry is expired 15 minutes earlier. This commit eagerly\ncloses UGI resources when an exception occurs.", "committedDate": "2020-09-23T00:06:14Z", "type": "commit"}, {"oid": "b82f329da2dbe7825fed367a3570aff3aab6595e", "url": "https://github.com/greenplum-db/pxf/commit/b82f329da2dbe7825fed367a3570aff3aab6595e", "message": "Remove Configuration from SessionId\n\nThe Configuration in SessionId was only being used to check whether\nsecurity is enabled for the given server. But the Configuration being in\nthe SessionId brings a lot of issues, because when SessionIds are being\nkept in the UGICache, they would retain a lot of associated objects in\nmemory. This would cause in some cases hundreds of megabytes in memory\njust for the purpose of keeping a single field from Configuration. This\ncommit we only store the `isSecurityEnabled` boolean in the SessionId,\nas it is the only piece of information that we need to keep.", "committedDate": "2020-09-23T00:06:22Z", "type": "commit"}, {"oid": "b82f329da2dbe7825fed367a3570aff3aab6595e", "url": "https://github.com/greenplum-db/pxf/commit/b82f329da2dbe7825fed367a3570aff3aab6595e", "message": "Remove Configuration from SessionId\n\nThe Configuration in SessionId was only being used to check whether\nsecurity is enabled for the given server. But the Configuration being in\nthe SessionId brings a lot of issues, because when SessionIds are being\nkept in the UGICache, they would retain a lot of associated objects in\nmemory. This would cause in some cases hundreds of megabytes in memory\njust for the purpose of keeping a single field from Configuration. This\ncommit we only store the `isSecurityEnabled` boolean in the SessionId,\nas it is the only piece of information that we need to keep.", "committedDate": "2020-09-23T00:06:22Z", "type": "forcePushed"}]}