{"pr_number": 355, "pr_title": "Split dependencies tarball into 2 tarballs", "pr_createdAt": "2020-05-12T15:34:34Z", "pr_url": "https://github.com/greenplum-db/pxf/pull/355", "timeline": [{"oid": "7b21aa1167146c7d195869999123611e01932f09", "url": "https://github.com/greenplum-db/pxf/commit/7b21aa1167146c7d195869999123611e01932f09", "message": "Split dependencies tarball into 2 tarballs\n\n- 1 tarball for .gradle, .tomcat, .go\n- 1 tarball for .m2\n\nThese tarballs will be used in different jobs in different parts of the\npipeline", "committedDate": "2020-05-11T18:38:15Z", "type": "commit"}, {"oid": "9cab4619c6068f23f322eff6709f7b7921771fa8", "url": "https://github.com/greenplum-db/pxf/commit/9cab4619c6068f23f322eff6709f7b7921771fa8", "message": "dependency:go-offline -> make dev", "committedDate": "2020-05-11T20:53:03Z", "type": "commit"}, {"oid": "a4f77316332e97a48eb519f920809cc3bf29121a", "url": "https://github.com/greenplum-db/pxf/commit/a4f77316332e97a48eb519f920809cc3bf29121a", "message": "run test", "committedDate": "2020-05-12T12:57:24Z", "type": "commit"}, {"oid": "5aaf7927088107fba31795048a262ca50799800e", "url": "https://github.com/greenplum-db/pxf/commit/5aaf7927088107fba31795048a262ca50799800e", "message": "prep templates", "committedDate": "2020-05-12T14:21:26Z", "type": "commit"}, {"oid": "977532c8e011b155f46ff92a6492401ee957d670", "url": "https://github.com/greenplum-db/pxf/commit/977532c8e011b155f46ff92a6492401ee957d670", "message": "create dir", "committedDate": "2020-05-12T14:44:19Z", "type": "commit"}, {"oid": "428c87f595aab09d23a0cb9176717e996e411673", "url": "https://github.com/greenplum-db/pxf/commit/428c87f595aab09d23a0cb9176717e996e411673", "message": "remove /root/pxf", "committedDate": "2020-05-12T18:17:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkzNzA0OA==", "url": "https://github.com/greenplum-db/pxf/pull/355#discussion_r423937048", "bodyText": "should we remove /root/pxf?", "author": "oliverralbertini", "createdAt": "2020-05-12T18:14:21Z", "path": "concourse/docker/pxf-build-base/Dockerfile", "diffHunk": "@@ -27,11 +27,16 @@ RUN export BUILD_PARAMS=-Dorg.gradle.daemon=false && \\\n     for X in /tmp/pxf_src/server/build/stage/lib/pxf-*-[0-9]*.jar; do \\\n       ln -sf $X /root/automation_tmp_lib/`echo \\`basename $X\\` | sed -e 's/-[a-zA-Z0-9.]*.jar/.jar/'`; \\\n     done && touch /root/automation_tmp_lib/pxf-extras.jar && \\\n-    cd /tmp/pxf_src/automation && mvn dependency:go-offline -DexcludeGroupIds=org.greenplum && \\\n-    cd - && mkdir -p /tmp/output/.tomcat && \\\n+    make -C /tmp/pxf_src/automation dev && \\\n+    mkdir -p /root/pxf/servers/database/ && cp /tmp/pxf_src/server/pxf-service/src/templates/user/templates/jdbc-site.xml /root/pxf/servers/database/ && \\\n+    mkdir -p /root/pxf/servers/db-session-params/ && cp /tmp/pxf_src/server/pxf-service/src/templates/user/templates/jdbc-site.xml /root/pxf/servers/db-session-params/ && \\\n+    mkdir -p /root/pxf/servers/db-hive/ && cp /tmp/pxf_src/server/pxf-service/src/templates/user/templates/jdbc-site.xml /root/pxf/servers/db-hive/ && \\\n+    make -C /tmp/pxf_src/automation TEST=HdfsSmokeTest || true && \\\n+    mkdir -p /tmp/output/.tomcat && mkdir -p /tmp/automation && \\\n     mv /tmp/pxf_src/pxf_commit_sha /tmp/output/pxf_commit_sha && \\\n     mv /tmp/pxf_src/server/tomcat/build/apache-tomcat-*.tar.gz /tmp/output/.tomcat/ && \\\n     mv /tmp/pxf_src/cli/go/pkg/dep/sources /tmp/output/.go-dep-cached-sources && \\\n-    mv /root/.gradle /tmp/output && mv /root/.m2 /tmp/output && \\\n+    mv /root/.gradle /tmp/output && mv /root/.m2 /tmp/automation && \\\n     cd /tmp/output/ && tar -czf /tmp/pxf-build-dependencies.tar.gz . && \\\n-    rm -rf /tmp/output /tmp/pxf_src /root/.gradle /root/.m2\n+    cd /tmp/automation && tar -czf /tmp/pxf-automation-dependencies.tar.gz . && \\\n+    rm -rf /tmp/output /tmp/pxf_src /root/.gradle /root/.m2 /tmp/automation", "originalCommit": "977532c8e011b155f46ff92a6492401ee957d670", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkzODIwMg==", "url": "https://github.com/greenplum-db/pxf/pull/355#discussion_r423938202", "bodyText": "here and below, I prefer not to cd anywhere if we don't have to:\ntar -czf /tmp/pxf-build-dependencies.tar.gz -C /tmp/output . &&\ntar -czf /tmp/pxf-automation-dependencies.tar.gz -C /tmp/automation .\nMakes the script less error prone, and you don't have to remember to cd back before deleting the directory.", "author": "oliverralbertini", "createdAt": "2020-05-12T18:16:05Z", "path": "concourse/docker/pxf-build-base/Dockerfile", "diffHunk": "@@ -27,11 +27,16 @@ RUN export BUILD_PARAMS=-Dorg.gradle.daemon=false && \\\n     for X in /tmp/pxf_src/server/build/stage/lib/pxf-*-[0-9]*.jar; do \\\n       ln -sf $X /root/automation_tmp_lib/`echo \\`basename $X\\` | sed -e 's/-[a-zA-Z0-9.]*.jar/.jar/'`; \\\n     done && touch /root/automation_tmp_lib/pxf-extras.jar && \\\n-    cd /tmp/pxf_src/automation && mvn dependency:go-offline -DexcludeGroupIds=org.greenplum && \\\n-    cd - && mkdir -p /tmp/output/.tomcat && \\\n+    make -C /tmp/pxf_src/automation dev && \\\n+    mkdir -p /root/pxf/servers/database/ && cp /tmp/pxf_src/server/pxf-service/src/templates/user/templates/jdbc-site.xml /root/pxf/servers/database/ && \\\n+    mkdir -p /root/pxf/servers/db-session-params/ && cp /tmp/pxf_src/server/pxf-service/src/templates/user/templates/jdbc-site.xml /root/pxf/servers/db-session-params/ && \\\n+    mkdir -p /root/pxf/servers/db-hive/ && cp /tmp/pxf_src/server/pxf-service/src/templates/user/templates/jdbc-site.xml /root/pxf/servers/db-hive/ && \\\n+    make -C /tmp/pxf_src/automation TEST=HdfsSmokeTest || true && \\\n+    mkdir -p /tmp/output/.tomcat && mkdir -p /tmp/automation && \\\n     mv /tmp/pxf_src/pxf_commit_sha /tmp/output/pxf_commit_sha && \\\n     mv /tmp/pxf_src/server/tomcat/build/apache-tomcat-*.tar.gz /tmp/output/.tomcat/ && \\\n     mv /tmp/pxf_src/cli/go/pkg/dep/sources /tmp/output/.go-dep-cached-sources && \\\n-    mv /root/.gradle /tmp/output && mv /root/.m2 /tmp/output && \\\n+    mv /root/.gradle /tmp/output && mv /root/.m2 /tmp/automation && \\\n     cd /tmp/output/ && tar -czf /tmp/pxf-build-dependencies.tar.gz . && \\", "originalCommit": "977532c8e011b155f46ff92a6492401ee957d670", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk0MDM0Nw==", "url": "https://github.com/greenplum-db/pxf/pull/355#discussion_r423940347", "bodyText": "minor: here and above you might consider replacing * with {build,automation}", "author": "oliverralbertini", "createdAt": "2020-05-12T18:19:41Z", "path": "concourse/docker/pxf-build-base/cloudbuild.yaml", "diffHunk": "@@ -31,9 +31,14 @@ steps:\n   - '-c'\n   - |\n     mkdir /workspace/build\n-    docker run --rm -v /workspace/build:/tmp/build/ pxf-build-dev /bin/bash -c \"cp /tmp/pxf-build-dependencies.tar.gz /tmp/build/\"\n+    docker run --rm -v /workspace/build:/tmp/build/ pxf-build-dev /bin/bash -c \"cp /tmp/pxf-*-dependencies.tar.gz /tmp/build/\"", "originalCommit": "977532c8e011b155f46ff92a6492401ee957d670", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}