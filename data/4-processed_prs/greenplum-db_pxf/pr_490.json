{"pr_number": 490, "pr_title": "Update pxf-build-base dependency building after Spring Boot merge", "pr_createdAt": "2020-11-13T19:56:47Z", "pr_url": "https://github.com/greenplum-db/pxf/pull/490", "timeline": [{"oid": "d27f9565ecadb64da38ee08736dd454fa29688f0", "url": "https://github.com/greenplum-db/pxf/commit/d27f9565ecadb64da38ee08736dd454fa29688f0", "message": "Update pxf-build-base dependency building after Spring Boot merge", "committedDate": "2020-11-13T19:52:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMwNTk2Ng==", "url": "https://github.com/greenplum-db/pxf/pull/490#discussion_r526305966", "bodyText": "this will probably change when we move to Go modules instead of dep tool ?", "author": "denalex", "createdAt": "2020-11-18T17:58:06Z", "path": "concourse/docker/pxf-build-base/cloudbuild.yaml", "diffHunk": "@@ -5,40 +5,108 @@\n timeout: 1200s\n \n steps:\n-# Write the PXF commit SHA-1 to a file\n-- name: 'gcr.io/cloud-builders/docker'\n-  entrypoint: 'bash'\n-  args:\n-    - '-c'\n-    - |\n-      echo \"${COMMIT_SHA}\" > pxf_commit_sha\n-\n-# Build the docker image\n-- name: 'gcr.io/cloud-builders/docker'\n-  id: pxf-build-dependencies\n-  args:\n-  - 'build'\n-  - '--tag=pxf-build-dev'\n-  - '-f'\n-  - 'concourse/docker/pxf-build-base/Dockerfile'\n-  - '.'\n-\n-# Copy the pxf-build-dependencies.tar.gz to the host\n-- name: 'gcr.io/cloud-builders/docker'\n-  id: pxf-build-dependencies-copy\n-  entrypoint: 'bash'\n-  args:\n-  - '-c'\n-  - |\n-    mkdir /workspace/build\n-    docker run --rm -v /workspace/build:/tmp/build/ pxf-build-dev /bin/bash -c \"cp /tmp/pxf-{build,automation}-dependencies.tar.gz /tmp/build/\"\n-\n-# Push the pxf-build-dependencies.tar.gz tarball to Google Cloud Storage\n-- name: 'gcr.io/cloud-builders/gsutil'\n-  id: pxf-build-dependencies-tarball\n-  args: ['cp', '/workspace/build/pxf-build-dependencies.tar.gz', 'gs://${_PXF_BUILD_BUCKET}/build-dependencies/pxf-build-dependencies.tar.gz']\n-\n-# Push the pxf-automation-dependencies.tar.gz tarball to Google Cloud Storage\n-- name: 'gcr.io/cloud-builders/gsutil'\n-  id: pxf-automation-dependencies-tarball\n-  args: ['cp', '/workspace/build/pxf-automation-dependencies.tar.gz', 'gs://${_PXF_BUILD_BUCKET}/automation-dependencies/pxf-automation-dependencies.tar.gz']\n+  # download and extract the existing dependencies\n+  - name: 'gcr.io/cloud-builders/gsutil'\n+    id: retrieve-pxf-build-dependencies\n+    args: [ 'cp', 'gs://${_PXF_BUILD_BUCKET}/build-dependencies/pxf-build-dependencies.tar.gz', 'pxf-build-dependencies.tar.gz' ]\n+    waitFor: [ '-' ]\n+  - name: 'gcr.io/$PROJECT_ID/tar'\n+    id: untar-pxf-build-dependencies\n+    args: [ '-xzf', 'pxf-build-dependencies.tar.gz' ]\n+    waitFor: [ 'retrieve-pxf-build-dependencies' ]\n+\n+  - name: 'gcr.io/cloud-builders/gsutil'\n+    id: retrieve-pxf-automation-dependencies\n+    args: [ 'cp', 'gs://${_PXF_BUILD_BUCKET}/automation-dependencies/pxf-automation-dependencies.tar.gz', 'pxf-automation-dependencies.tar.gz' ]\n+    waitFor: [ '-' ]\n+  - name: 'gcr.io/$PROJECT_ID/tar'\n+    id: untar-pxf-automation-dependencies\n+    args: [ '-xzf', 'pxf-automation-dependencies.tar.gz' ]\n+    waitFor: [ 'retrieve-pxf-automation-dependencies' ]\n+\n+  # use gradle image with JDK8 to build the project\n+  - name: gradle:6.6.1-jdk8\n+    id: gradle-build\n+    entrypoint: gradle\n+    args: [ '--gradle-user-home=/workspace/.gradle', '-Dorg.gradle.daemon=false', '-b', './server/build.gradle', 'test', 'stage' ]\n+    waitFor: [ 'untar-pxf-build-dependencies' ]\n+\n+  - name: golang:1.15.3\n+    id: golang-build\n+    entrypoint: 'bash'\n+    args:\n+      - '-c'\n+      - |\n+        mkdir -p ./.go-dep-cached-sources\n+        cp ./.go-dep-cached-sources ./cli/go/pkg/dep/sources\n+        go get github.com/golang/dep/cmd/dep", "originalCommit": "d27f9565ecadb64da38ee08736dd454fa29688f0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM0MjE3NA==", "url": "https://github.com/greenplum-db/pxf/pull/490#discussion_r526342174", "bodyText": "correct. we don't need dep after that PR comes in", "author": "frankgh", "createdAt": "2020-11-18T18:55:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMwNTk2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMxNDc4MQ==", "url": "https://github.com/greenplum-db/pxf/pull/490#discussion_r526314781", "bodyText": "how would we solve the problem of getting rid of obsolete versions / dependencies, if we always download existing ones to start with ? Not essential, just wonder if we can think of smth.", "author": "denalex", "createdAt": "2020-11-18T18:11:55Z", "path": "concourse/docker/pxf-build-base/cloudbuild.yaml", "diffHunk": "@@ -5,40 +5,108 @@\n timeout: 1200s\n \n steps:\n-# Write the PXF commit SHA-1 to a file\n-- name: 'gcr.io/cloud-builders/docker'\n-  entrypoint: 'bash'\n-  args:\n-    - '-c'\n-    - |\n-      echo \"${COMMIT_SHA}\" > pxf_commit_sha\n-\n-# Build the docker image\n-- name: 'gcr.io/cloud-builders/docker'\n-  id: pxf-build-dependencies\n-  args:\n-  - 'build'\n-  - '--tag=pxf-build-dev'\n-  - '-f'\n-  - 'concourse/docker/pxf-build-base/Dockerfile'\n-  - '.'\n-\n-# Copy the pxf-build-dependencies.tar.gz to the host\n-- name: 'gcr.io/cloud-builders/docker'\n-  id: pxf-build-dependencies-copy\n-  entrypoint: 'bash'\n-  args:\n-  - '-c'\n-  - |\n-    mkdir /workspace/build\n-    docker run --rm -v /workspace/build:/tmp/build/ pxf-build-dev /bin/bash -c \"cp /tmp/pxf-{build,automation}-dependencies.tar.gz /tmp/build/\"\n-\n-# Push the pxf-build-dependencies.tar.gz tarball to Google Cloud Storage\n-- name: 'gcr.io/cloud-builders/gsutil'\n-  id: pxf-build-dependencies-tarball\n-  args: ['cp', '/workspace/build/pxf-build-dependencies.tar.gz', 'gs://${_PXF_BUILD_BUCKET}/build-dependencies/pxf-build-dependencies.tar.gz']\n-\n-# Push the pxf-automation-dependencies.tar.gz tarball to Google Cloud Storage\n-- name: 'gcr.io/cloud-builders/gsutil'\n-  id: pxf-automation-dependencies-tarball\n-  args: ['cp', '/workspace/build/pxf-automation-dependencies.tar.gz', 'gs://${_PXF_BUILD_BUCKET}/automation-dependencies/pxf-automation-dependencies.tar.gz']\n+  # download and extract the existing dependencies", "originalCommit": "d27f9565ecadb64da38ee08736dd454fa29688f0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM0Mjg4NQ==", "url": "https://github.com/greenplum-db/pxf/pull/490#discussion_r526342885", "bodyText": "good point, something to think about", "author": "frankgh", "createdAt": "2020-11-18T18:56:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMxNDc4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM1OTc5OA==", "url": "https://github.com/greenplum-db/pxf/pull/490#discussion_r526359798", "bodyText": "This looks like a bit of a bootstrap paradox -- we're using a tarball that is created by this cloudbuild. I know that this already existed from the previous workflow where it was created by scratch from the Dockerfile, but it took me a minute and looking at the diff to understand where it was coming from.\nMaybe it's worth keeping the Dockerfile that creates the tarball from scratch to avoid this confusion and address Alex's point about old deps.", "author": "bradfordb-vmware", "createdAt": "2020-11-18T19:24:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMxNDc4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM2MjYzMw==", "url": "https://github.com/greenplum-db/pxf/pull/490#discussion_r526362633", "bodyText": "this is the pattern we use across different projects, I kept it consistent for now, but we should address the issue mentioned above at some point", "author": "frankgh", "createdAt": "2020-11-18T19:28:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMxNDc4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMxNjA5OA==", "url": "https://github.com/greenplum-db/pxf/pull/490#discussion_r526316098", "bodyText": "I think this is ok for capturing dependencies, otherwise we probably should be using the Makefile to build the \"official\" product ?", "author": "denalex", "createdAt": "2020-11-18T18:14:04Z", "path": "concourse/docker/pxf-build-base/cloudbuild.yaml", "diffHunk": "@@ -5,40 +5,108 @@\n timeout: 1200s\n \n steps:\n-# Write the PXF commit SHA-1 to a file\n-- name: 'gcr.io/cloud-builders/docker'\n-  entrypoint: 'bash'\n-  args:\n-    - '-c'\n-    - |\n-      echo \"${COMMIT_SHA}\" > pxf_commit_sha\n-\n-# Build the docker image\n-- name: 'gcr.io/cloud-builders/docker'\n-  id: pxf-build-dependencies\n-  args:\n-  - 'build'\n-  - '--tag=pxf-build-dev'\n-  - '-f'\n-  - 'concourse/docker/pxf-build-base/Dockerfile'\n-  - '.'\n-\n-# Copy the pxf-build-dependencies.tar.gz to the host\n-- name: 'gcr.io/cloud-builders/docker'\n-  id: pxf-build-dependencies-copy\n-  entrypoint: 'bash'\n-  args:\n-  - '-c'\n-  - |\n-    mkdir /workspace/build\n-    docker run --rm -v /workspace/build:/tmp/build/ pxf-build-dev /bin/bash -c \"cp /tmp/pxf-{build,automation}-dependencies.tar.gz /tmp/build/\"\n-\n-# Push the pxf-build-dependencies.tar.gz tarball to Google Cloud Storage\n-- name: 'gcr.io/cloud-builders/gsutil'\n-  id: pxf-build-dependencies-tarball\n-  args: ['cp', '/workspace/build/pxf-build-dependencies.tar.gz', 'gs://${_PXF_BUILD_BUCKET}/build-dependencies/pxf-build-dependencies.tar.gz']\n-\n-# Push the pxf-automation-dependencies.tar.gz tarball to Google Cloud Storage\n-- name: 'gcr.io/cloud-builders/gsutil'\n-  id: pxf-automation-dependencies-tarball\n-  args: ['cp', '/workspace/build/pxf-automation-dependencies.tar.gz', 'gs://${_PXF_BUILD_BUCKET}/automation-dependencies/pxf-automation-dependencies.tar.gz']\n+  # download and extract the existing dependencies\n+  - name: 'gcr.io/cloud-builders/gsutil'\n+    id: retrieve-pxf-build-dependencies\n+    args: [ 'cp', 'gs://${_PXF_BUILD_BUCKET}/build-dependencies/pxf-build-dependencies.tar.gz', 'pxf-build-dependencies.tar.gz' ]\n+    waitFor: [ '-' ]\n+  - name: 'gcr.io/$PROJECT_ID/tar'\n+    id: untar-pxf-build-dependencies\n+    args: [ '-xzf', 'pxf-build-dependencies.tar.gz' ]\n+    waitFor: [ 'retrieve-pxf-build-dependencies' ]\n+\n+  - name: 'gcr.io/cloud-builders/gsutil'\n+    id: retrieve-pxf-automation-dependencies\n+    args: [ 'cp', 'gs://${_PXF_BUILD_BUCKET}/automation-dependencies/pxf-automation-dependencies.tar.gz', 'pxf-automation-dependencies.tar.gz' ]\n+    waitFor: [ '-' ]\n+  - name: 'gcr.io/$PROJECT_ID/tar'\n+    id: untar-pxf-automation-dependencies\n+    args: [ '-xzf', 'pxf-automation-dependencies.tar.gz' ]\n+    waitFor: [ 'retrieve-pxf-automation-dependencies' ]\n+\n+  # use gradle image with JDK8 to build the project\n+  - name: gradle:6.6.1-jdk8\n+    id: gradle-build\n+    entrypoint: gradle\n+    args: [ '--gradle-user-home=/workspace/.gradle', '-Dorg.gradle.daemon=false', '-b', './server/build.gradle', 'test', 'stage' ]", "originalCommit": "d27f9565ecadb64da38ee08736dd454fa29688f0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM0MzIwOA==", "url": "https://github.com/greenplum-db/pxf/pull/490#discussion_r526343208", "bodyText": "correct, this is only to capture dependencies.", "author": "frankgh", "createdAt": "2020-11-18T18:56:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMxNjA5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM1NDgyNA==", "url": "https://github.com/greenplum-db/pxf/pull/490#discussion_r526354824", "bodyText": "Is this a one of image that we've built? Would it be better for us to use an upstream base image like alpine or bash? One less thing that we need to own.", "author": "bradfordb-vmware", "createdAt": "2020-11-18T19:16:12Z", "path": "concourse/docker/pxf-build-base/cloudbuild.yaml", "diffHunk": "@@ -5,40 +5,108 @@\n timeout: 1200s\n \n steps:\n-# Write the PXF commit SHA-1 to a file\n-- name: 'gcr.io/cloud-builders/docker'\n-  entrypoint: 'bash'\n-  args:\n-    - '-c'\n-    - |\n-      echo \"${COMMIT_SHA}\" > pxf_commit_sha\n-\n-# Build the docker image\n-- name: 'gcr.io/cloud-builders/docker'\n-  id: pxf-build-dependencies\n-  args:\n-  - 'build'\n-  - '--tag=pxf-build-dev'\n-  - '-f'\n-  - 'concourse/docker/pxf-build-base/Dockerfile'\n-  - '.'\n-\n-# Copy the pxf-build-dependencies.tar.gz to the host\n-- name: 'gcr.io/cloud-builders/docker'\n-  id: pxf-build-dependencies-copy\n-  entrypoint: 'bash'\n-  args:\n-  - '-c'\n-  - |\n-    mkdir /workspace/build\n-    docker run --rm -v /workspace/build:/tmp/build/ pxf-build-dev /bin/bash -c \"cp /tmp/pxf-{build,automation}-dependencies.tar.gz /tmp/build/\"\n-\n-# Push the pxf-build-dependencies.tar.gz tarball to Google Cloud Storage\n-- name: 'gcr.io/cloud-builders/gsutil'\n-  id: pxf-build-dependencies-tarball\n-  args: ['cp', '/workspace/build/pxf-build-dependencies.tar.gz', 'gs://${_PXF_BUILD_BUCKET}/build-dependencies/pxf-build-dependencies.tar.gz']\n-\n-# Push the pxf-automation-dependencies.tar.gz tarball to Google Cloud Storage\n-- name: 'gcr.io/cloud-builders/gsutil'\n-  id: pxf-automation-dependencies-tarball\n-  args: ['cp', '/workspace/build/pxf-automation-dependencies.tar.gz', 'gs://${_PXF_BUILD_BUCKET}/automation-dependencies/pxf-automation-dependencies.tar.gz']\n+  # download and extract the existing dependencies\n+  - name: 'gcr.io/cloud-builders/gsutil'\n+    id: retrieve-pxf-build-dependencies\n+    args: [ 'cp', 'gs://${_PXF_BUILD_BUCKET}/build-dependencies/pxf-build-dependencies.tar.gz', 'pxf-build-dependencies.tar.gz' ]\n+    waitFor: [ '-' ]\n+  - name: 'gcr.io/$PROJECT_ID/tar'\n+    id: untar-pxf-build-dependencies\n+    args: [ '-xzf', 'pxf-build-dependencies.tar.gz' ]\n+    waitFor: [ 'retrieve-pxf-build-dependencies' ]\n+\n+  - name: 'gcr.io/cloud-builders/gsutil'\n+    id: retrieve-pxf-automation-dependencies\n+    args: [ 'cp', 'gs://${_PXF_BUILD_BUCKET}/automation-dependencies/pxf-automation-dependencies.tar.gz', 'pxf-automation-dependencies.tar.gz' ]\n+    waitFor: [ '-' ]\n+  - name: 'gcr.io/$PROJECT_ID/tar'", "originalCommit": "d27f9565ecadb64da38ee08736dd454fa29688f0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM2MTQ5OQ==", "url": "https://github.com/greenplum-db/pxf/pull/490#discussion_r526361499", "bodyText": "this is an image that we built. I think Alex has context on it.", "author": "frankgh", "createdAt": "2020-11-18T19:26:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM1NDgyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM1NjgxMg==", "url": "https://github.com/greenplum-db/pxf/pull/490#discussion_r526356812", "bodyText": "It looks like we are also updating the version of golang used to build PXF cli. Is that intentional?", "author": "bradfordb-vmware", "createdAt": "2020-11-18T19:19:28Z", "path": "concourse/docker/pxf-build-base/cloudbuild.yaml", "diffHunk": "@@ -5,40 +5,108 @@\n timeout: 1200s\n \n steps:\n-# Write the PXF commit SHA-1 to a file\n-- name: 'gcr.io/cloud-builders/docker'\n-  entrypoint: 'bash'\n-  args:\n-    - '-c'\n-    - |\n-      echo \"${COMMIT_SHA}\" > pxf_commit_sha\n-\n-# Build the docker image\n-- name: 'gcr.io/cloud-builders/docker'\n-  id: pxf-build-dependencies\n-  args:\n-  - 'build'\n-  - '--tag=pxf-build-dev'\n-  - '-f'\n-  - 'concourse/docker/pxf-build-base/Dockerfile'\n-  - '.'\n-\n-# Copy the pxf-build-dependencies.tar.gz to the host\n-- name: 'gcr.io/cloud-builders/docker'\n-  id: pxf-build-dependencies-copy\n-  entrypoint: 'bash'\n-  args:\n-  - '-c'\n-  - |\n-    mkdir /workspace/build\n-    docker run --rm -v /workspace/build:/tmp/build/ pxf-build-dev /bin/bash -c \"cp /tmp/pxf-{build,automation}-dependencies.tar.gz /tmp/build/\"\n-\n-# Push the pxf-build-dependencies.tar.gz tarball to Google Cloud Storage\n-- name: 'gcr.io/cloud-builders/gsutil'\n-  id: pxf-build-dependencies-tarball\n-  args: ['cp', '/workspace/build/pxf-build-dependencies.tar.gz', 'gs://${_PXF_BUILD_BUCKET}/build-dependencies/pxf-build-dependencies.tar.gz']\n-\n-# Push the pxf-automation-dependencies.tar.gz tarball to Google Cloud Storage\n-- name: 'gcr.io/cloud-builders/gsutil'\n-  id: pxf-automation-dependencies-tarball\n-  args: ['cp', '/workspace/build/pxf-automation-dependencies.tar.gz', 'gs://${_PXF_BUILD_BUCKET}/automation-dependencies/pxf-automation-dependencies.tar.gz']\n+  # download and extract the existing dependencies\n+  - name: 'gcr.io/cloud-builders/gsutil'\n+    id: retrieve-pxf-build-dependencies\n+    args: [ 'cp', 'gs://${_PXF_BUILD_BUCKET}/build-dependencies/pxf-build-dependencies.tar.gz', 'pxf-build-dependencies.tar.gz' ]\n+    waitFor: [ '-' ]\n+  - name: 'gcr.io/$PROJECT_ID/tar'\n+    id: untar-pxf-build-dependencies\n+    args: [ '-xzf', 'pxf-build-dependencies.tar.gz' ]\n+    waitFor: [ 'retrieve-pxf-build-dependencies' ]\n+\n+  - name: 'gcr.io/cloud-builders/gsutil'\n+    id: retrieve-pxf-automation-dependencies\n+    args: [ 'cp', 'gs://${_PXF_BUILD_BUCKET}/automation-dependencies/pxf-automation-dependencies.tar.gz', 'pxf-automation-dependencies.tar.gz' ]\n+    waitFor: [ '-' ]\n+  - name: 'gcr.io/$PROJECT_ID/tar'\n+    id: untar-pxf-automation-dependencies\n+    args: [ '-xzf', 'pxf-automation-dependencies.tar.gz' ]\n+    waitFor: [ 'retrieve-pxf-automation-dependencies' ]\n+\n+  # use gradle image with JDK8 to build the project\n+  - name: gradle:6.6.1-jdk8\n+    id: gradle-build\n+    entrypoint: gradle\n+    args: [ '--gradle-user-home=/workspace/.gradle', '-Dorg.gradle.daemon=false', '-b', './server/build.gradle', 'test', 'stage' ]\n+    waitFor: [ 'untar-pxf-build-dependencies' ]\n+\n+  - name: golang:1.15.3", "originalCommit": "d27f9565ecadb64da38ee08736dd454fa29688f0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM2MTk1NA==", "url": "https://github.com/greenplum-db/pxf/pull/490#discussion_r526361954", "bodyText": "we are actually matching the golang version we use to build: https://github.com/greenplum-db/pxf/blob/master/concourse/docker/pxf-dev-base/gpdb7/ubuntu18.04/Dockerfile#L7", "author": "frankgh", "createdAt": "2020-11-18T19:27:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM1NjgxMg=="}], "type": "inlineReview"}]}