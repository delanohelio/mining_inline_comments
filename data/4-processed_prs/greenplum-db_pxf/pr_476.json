{"pr_number": 476, "pr_title": "RPM: Install the $PXF_HOME/run directory during %posttran", "pr_createdAt": "2020-11-02T14:49:25Z", "pr_url": "https://github.com/greenplum-db/pxf/pull/476", "timeline": [{"oid": "f55de1a83c8649d13ae07805bbcb4b80391c836c", "url": "https://github.com/greenplum-db/pxf/commit/f55de1a83c8649d13ae07805bbcb4b80391c836c", "message": "RPM: Install the $PXF_HOME/run directory during %posttran\n\nPXF v5 RPM installation removes the run directory during the %preun\nstep. The lack of run directory prevents PXF v6+ from starting up. We\nfix the issue by installing the `$PXF_HOME/run` directory during the\n%posttran step. %posttrans of the new package is the only step that runs\nafter the %preun of the old package. Re-installing the `$PXF_HOME/run`\nduring the %posttrans step effectively restores the directory during\ninstallation.", "committedDate": "2020-11-02T14:21:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjExODQxOQ==", "url": "https://github.com/greenplum-db/pxf/pull/476#discussion_r516118419", "bodyText": "is this directory now also provisioned as part of installation of this RPM ? What happens on a clean install ?", "author": "denalex", "createdAt": "2020-11-02T17:01:04Z", "path": "package/pxf-gp5.spec", "diffHunk": "@@ -66,3 +66,10 @@ sed -i \"s|module_pathname =.*|module_pathname = '%{prefix}/gpextable/pxf'|g\" %{p\n # only applies for old installations (pre 6.0.0)\n %__rm -f %{prefix}/conf/pxf-private.classpath\n %__rm -rf %{prefix}/pxf-service\n+\n+%posttrans\n+# PXF v5 RPM installation removes the run directory during the %preun step.\n+# The lack of run directory prevents PXF v6+ from starting up.\n+# %posttrans of the new package is the only step that runs after the %preun\n+# of the old package\n+%{__install} -d -m 700 %{prefix}/run", "originalCommit": "71d1106609eeb39b3d055bffd073b49dba00f860", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE3NDA1Mg==", "url": "https://github.com/greenplum-db/pxf/pull/476#discussion_r516174052", "bodyText": "Is there a reason we're creating this directory in a scriptlet? If this directory is needed by pxf, should we have it be be created in the build step above? This will ensure that the package manager sees this directory as being owned by the package.\nI don't know if PXF supports SLES11 (or plans to), but I don't think %posttrans works with the version of RPM there.", "author": "bradfordb-vmware", "createdAt": "2020-11-02T18:28:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjExODQxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE3ODUzNA==", "url": "https://github.com/greenplum-db/pxf/pull/476#discussion_r516178534", "bodyText": "@denalex yes, all the directories we need for PXF to start are provided as part of the RPM installation. That includes the run directory. On a clean install, the run directory is created.", "author": "frankgh", "createdAt": "2020-11-02T18:36:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjExODQxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE3OTAzNw==", "url": "https://github.com/greenplum-db/pxf/pull/476#discussion_r516179037", "bodyText": "even if we create it as part of the spec, which is what @bradfordb-vmware suggests and what we should do, the current PX5 %postun will remove it, so we need to re-create it in the scriptlet again, unless there's a better way.", "author": "denalex", "createdAt": "2020-11-02T18:37:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjExODQxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE5Njc4Ng==", "url": "https://github.com/greenplum-db/pxf/pull/476#discussion_r516196786", "bodyText": "spoke to @bradfordb-vmware and we agreed that the %posttrans approach should be fine, so long SLES11 is not something we need to worry about. To answer Bradford's other question, the RPM includes the run directory, so this should be seen by the package manager as well. We verified that with this fix, running an rpm -V pxf-gp6 did not show the run directory as missing. The run directory was shown as missing in the RPM created in the spring-boot branch", "author": "frankgh", "createdAt": "2020-11-02T19:11:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjExODQxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjExOTY4MQ==", "url": "https://github.com/greenplum-db/pxf/pull/476#discussion_r516119681", "bodyText": "also, lines 64-68 -- %preun seems to be only for old stuff, should this be now in %prein or %postin to clean up before installing new RPM ?", "author": "denalex", "createdAt": "2020-11-02T17:02:44Z", "path": "package/pxf-gp5.spec", "diffHunk": "@@ -66,3 +66,10 @@ sed -i \"s|module_pathname =.*|module_pathname = '%{prefix}/gpextable/pxf'|g\" %{p\n # only applies for old installations (pre 6.0.0)\n %__rm -f %{prefix}/conf/pxf-private.classpath\n %__rm -rf %{prefix}/pxf-service\n+\n+%posttrans\n+# PXF v5 RPM installation removes the run directory during the %preun step.\n+# The lack of run directory prevents PXF v6+ from starting up.\n+# %posttrans of the new package is the only step that runs after the %preun\n+# of the old package\n+%{__install} -d -m 700 %{prefix}/run", "originalCommit": "71d1106609eeb39b3d055bffd073b49dba00f860", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE3NzMyMw==", "url": "https://github.com/greenplum-db/pxf/pull/476#discussion_r516177323", "bodyText": "yes, makes sense", "author": "frankgh", "createdAt": "2020-11-02T18:34:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjExOTY4MQ=="}], "type": "inlineReview"}, {"oid": "c7b79e9b06af100f7ea9916132869f6afb511fba", "url": "https://github.com/greenplum-db/pxf/commit/c7b79e9b06af100f7ea9916132869f6afb511fba", "message": "Address PR comment. preun -> pre", "committedDate": "2020-11-02T19:12:13Z", "type": "commit"}, {"oid": "c7b79e9b06af100f7ea9916132869f6afb511fba", "url": "https://github.com/greenplum-db/pxf/commit/c7b79e9b06af100f7ea9916132869f6afb511fba", "message": "Address PR comment. preun -> pre", "committedDate": "2020-11-02T19:12:13Z", "type": "forcePushed"}]}