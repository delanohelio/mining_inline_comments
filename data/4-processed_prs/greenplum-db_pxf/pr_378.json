{"pr_number": 378, "pr_title": "Improve error message display by leveraging Spring Boot JSON errors", "pr_createdAt": "2020-06-10T15:13:44Z", "pr_url": "https://github.com/greenplum-db/pxf/pull/378", "timeline": [{"oid": "eefe6b3b04345fd5351a1c1255a4d2b95e6de607", "url": "https://github.com/greenplum-db/pxf/commit/eefe6b3b04345fd5351a1c1255a4d2b95e6de607", "message": "Improve error message display by leveraging Spring Boot JSON errors\n\nSpring Boot provides JSON error messages by default, that are easier to\nparse on the PXF C-client. We add support for Spring Boot error\nmessages, and enhance error messages with error HINTs provided to the\nend user. This also gave us the opportunity to improve some of the error\nmessages and enhance them with useful hints.\n\nThis commit also fixes automation tests that have been neglected for a\nwhile, but now there's only 1 test that is failing 50% of the time\n(which we will address later). The failing test is\n`HdfsReadableTextTest.limit` which seems to be related to the fact that\nwe are doing limit.\n\nThis commit also makes sure that the TaskExecutorPool is correctly\nconfigured and is properly hooked to the ShutdownHook. Before this fix,\nthe application would take a long time to shutdown because of running\nthreads.\n\nAlso, we improve the doAs call. It turns out that for the Bridge\ncreation we also need to perform a doAs, this is specially critical in\na keberized environment.\n\nAs part of fixing the automation tests, we have started adding\ntransitive dependencies that were neglected for a while. We also make\nsure that they do not bring transitives themselves by marking them with\n`{ transitive = false }`.\n\nCo-authored-by: Francisco Guerrero <aguerrero@pivotal.io>\nCo-authored-by: Alexander Denissov <adenissov@pivotal.io>\nCo-authored-by: Lisa Owen <lowen@pivotal.io>", "committedDate": "2020-06-10T15:00:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk1ODM4NA==", "url": "https://github.com/greenplum-db/pxf/pull/378#discussion_r442958384", "bodyText": "call it install-server", "author": "frankgh", "createdAt": "2020-06-19T17:17:23Z", "path": "Makefile", "diffHunk": "@@ -39,6 +39,10 @@ install:\n \tmake -C cli/go/src/pxf-cli install\n \tmake -C server install\n \n+install-dev:", "originalCommit": "eefe6b3b04345fd5351a1c1255a4d2b95e6de607", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk2MDY3Mg==", "url": "https://github.com/greenplum-db/pxf/pull/378#discussion_r442960672", "bodyText": "we need tests for the output when we enable DEBUG1 for client_min_messages", "author": "frankgh", "createdAt": "2020-06-19T17:22:02Z", "path": "automation/tincrepo/main/pxf/features/cloud_access/no_server_credentials_no_config_with_hdfs/expected/query01.ans", "diffHunk": "@@ -25,5 +20,8 @@\n --\n -- end_matchsubs\n SELECT *  FROM cloudaccess_no_server_credentials_no_config_with_hdfs;\n-ERROR:  remote component error (500) from 'SOME_IP:SOME_PORT':  type  Exception SOME_EXCEPTION\n+ERROR:  PXF server error : profile 's3a' is not compatible with server's 'default' configuration ('hdfs')\n+-- start_ignore\n+HINT:  Ensure that 'server-dir' includes only the configuration files for profile 's3a'. Check the PXF logs located in the 'logs-dir' directory on host 'mdw' or 'set client_min_messages=DEBUG1' for additional details.", "originalCommit": "eefe6b3b04345fd5351a1c1255a4d2b95e6de607", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk2MTUwOA==", "url": "https://github.com/greenplum-db/pxf/pull/378#discussion_r442961508", "bodyText": "this needs to say in the 'log-dir' ...", "author": "frankgh", "createdAt": "2020-06-19T17:23:59Z", "path": "automation/tincrepo/main/pxf/features/general/outOfMemory/expected/query01.ans", "diffHunk": "@@ -26,7 +17,10 @@\n --\n -- end_matchsubs\n SELECT * from test_out_of_memory;\n-ERROR:  remote component error (500) from 'SOME_IP:SOME_PORT':  type  Exception java.lang.OutOfMemoryError: Java heap space\n+ERROR:  PXF server error : java.lang.OutOfMemoryError: Java heap space\n+-- start_ignore\n+HINT:  Check the PXF logs located in the '/Users/fguerrero/not-pxf/logs' directory on host 'fguerrero' or 'set client_min_messages=DEBUG1' for additional details.", "originalCommit": "eefe6b3b04345fd5351a1c1255a4d2b95e6de607", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk2NTIxOA==", "url": "https://github.com/greenplum-db/pxf/pull/378#discussion_r442965218", "bodyText": "show the stacktrace as a different err type (maybe errdetail).", "author": "frankgh", "createdAt": "2020-06-19T17:32:59Z", "path": "external-table/src/libchurl.c", "diffHunk": "@@ -966,29 +958,53 @@ check_response_code(churl_context *context)\n \t\t\t * response_text could be NULL in some cases. get_http_error_msg\n \t\t\t * checks for that.\n \t\t\t */\n-\t\t\thttp_error_msg = get_http_error_msg(response_code, response_text, context->curl_error_buffer);\n+\t\t\thttp_error_msg = get_http_error_msg(response_code, response_text, context->curl_error_buffer, &hint_msg, &trace_msg);\n \n-\t\t\t/*\n-\t\t\t * check for a specific confusing error, and replace with a\n-\t\t\t * clearer one\n-\t\t\t */\n-\t\t\tif (strstr(http_error_msg, \"instance does not contain any root resource classes\") != NULL)\n-\t\t\t{\n-\t\t\t\tappendStringInfo(&err, \" : PXF not correctly installed in CLASSPATH\");\n-\t\t\t}\n-\t\t\telse\n-\t\t\t{\n-\t\t\t\tappendStringInfo(&err, \": %s\", http_error_msg);\n-\t\t\t}\n+\t\t\tappendStringInfo(&err, \" : %s\", http_error_msg);\n \t\t}\n \n-\t\telog(ERROR, \"%s\", err.data);\n-\n+\t\tif (trace_msg != NULL || hint_msg != NULL)", "originalCommit": "eefe6b3b04345fd5351a1c1255a4d2b95e6de607", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk2NzQyMQ==", "url": "https://github.com/greenplum-db/pxf/pull/378#discussion_r442967421", "bodyText": "double check that the preuninstall is for this RPM version and not the previous RPM version.", "author": "frankgh", "createdAt": "2020-06-19T17:38:22Z", "path": "package/pxf-gp5.spec", "diffHunk": "@@ -39,6 +39,4 @@ fi\n \n %preun\n # cleanup files and directories created by 'pxf init' command\n-%__rm -f %{prefix}/conf/pxf-private.classpath", "originalCommit": "eefe6b3b04345fd5351a1c1255a4d2b95e6de607", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEzMDgzMw==", "url": "https://github.com/greenplum-db/pxf/pull/378#discussion_r443130833", "bodyText": "RPM %preun removes files of old package, and the %preun of the old package is run", "author": "frankgh", "createdAt": "2020-06-20T13:25:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk2NzQyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk2NzY1OA==", "url": "https://github.com/greenplum-db/pxf/pull/378#discussion_r442967658", "bodyText": "install-server", "author": "frankgh", "createdAt": "2020-06-19T17:39:01Z", "path": "server/Makefile", "diffHunk": "@@ -84,6 +84,14 @@ install: stage\n \tmkdir -p \"$(PXF_HOME)\"\n \tcp -R build/stage/pxf/* \"$(PXF_HOME)\"\n \n+.PHONY: install-dev\n+install-dev: stage-notest", "originalCommit": "eefe6b3b04345fd5351a1c1255a4d2b95e6de607", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk3MzgzOA==", "url": "https://github.com/greenplum-db/pxf/pull/378#discussion_r442973838", "bodyText": "this will share the pool within the application. so this is not what we intended to do", "author": "frankgh", "createdAt": "2020-06-19T17:53:15Z", "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/PxfConfiguration.java", "diffHunk": "@@ -48,11 +45,22 @@ public void configureAsyncSupport(AsyncSupportConfigurer configurer) {\n         builder = builder.awaitTermination(shutdown.isAwaitTermination());\n         builder = builder.awaitTerminationPeriod(shutdown.getAwaitTerminationPeriod());\n         builder = builder.threadNamePrefix(properties.getThreadNamePrefix());\n+        builder = builder.customizers(taskExecutorCustomizers.orderedStream()::iterator);\n+        builder = builder.taskDecorator(taskDecorator.getIfUnique());\n+        return builder;\n+    }\n \n-        ThreadPoolTaskExecutor taskExecutor = builder.build(PxfThreadPoolTaskExecutor.class);\n-\n-        taskExecutor.initialize();\n-        configurer.setTaskExecutor(taskExecutor);\n-\n+    /**\n+     * Builds the {@link ThreadPoolTaskExecutor} that has previously been\n+     * configured\n+     *\n+     * @param builder the {@link TaskExecutorBuilder} object\n+     * @return the {@link ThreadPoolTaskExecutor} that has previously been configured\n+     */\n+    @Lazy\n+    @Bean(name = {APPLICATION_TASK_EXECUTOR_BEAN_NAME,", "originalCommit": "eefe6b3b04345fd5351a1c1255a4d2b95e6de607", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTEyMzQzMg==", "url": "https://github.com/greenplum-db/pxf/pull/378#discussion_r445123432", "bodyText": "fixed", "author": "frankgh", "createdAt": "2020-06-24T19:32:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk3MzgzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk3NzM1Nw==", "url": "https://github.com/greenplum-db/pxf/pull/378#discussion_r442977357", "bodyText": "eager initialization is desired.", "author": "frankgh", "createdAt": "2020-06-19T18:01:34Z", "path": "server/pxf-service/src/main/resources/application.properties", "diffHunk": "@@ -1,15 +1,23 @@\n-# TODO: decide which endpoints are enabled\n+# TODO: spring_boot_todo decide which endpoints are exposed by default\n management.endpoints.web.exposure.include=*\n management.endpoints.enabled-by-default=true\n management.endpoint.shutdown.enabled=true\n \n server.port=${pxf.port:5888}\n server.tomcat.max-threads=${pxf.max.threads:200}\n \n-# Disable the whitelabel error page provided by spring boot and display the\n-# underlying tomcat error page which is more consistent with what PXF expects \n-server.error.whitelabel.enabled=false\n-spring.autoconfigure.exclude=org.springframework.boot.autoconfigure.web.servlet.error.ErrorMvcAutoConfiguration\n+# 1. Lazy initialization may reduce the number of beans created when the\n+#    application is starting \u2013 therefore, we can improve the startup time of\n+#    the application\n+# 2. As none of the beans are created until they are needed, we could mask\n+#    issues, getting them in run time instead of startup time\n+# 3. The issues can include out of memory errors, misconfigurations, or\n+#    class-definition-found errors\n+# 4. Also, when we're in a web context, triggering bean creation on demand will\n+#    increase the latency of HTTP requests \u2013 the bean creation will affect only\n+#    the first request, but this may have a negative impact in load-balancing\n+#    and auto-scaling.\n+spring.main.lazy-initialization=true", "originalCommit": "eefe6b3b04345fd5351a1c1255a4d2b95e6de607", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEzMTg3Ng==", "url": "https://github.com/greenplum-db/pxf/pull/378#discussion_r443131876", "bodyText": "added a todo to decide what to end up doing", "author": "frankgh", "createdAt": "2020-06-20T13:42:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk3NzM1Nw=="}], "type": "inlineReview"}]}