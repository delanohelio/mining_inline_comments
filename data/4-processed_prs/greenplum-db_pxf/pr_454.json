{"pr_number": 454, "pr_title": "Publish PXF binary tarballs", "pr_createdAt": "2020-09-24T21:32:51Z", "pr_url": "https://github.com/greenplum-db/pxf/pull/454", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYyNzcxMQ==", "url": "https://github.com/greenplum-db/pxf/pull/454#discussion_r494627711", "bodyText": "no MS please on OSS code", "author": "denalex", "createdAt": "2020-09-24T21:43:29Z", "path": "concourse/pipelines/templates/build_pipeline-tpl.yml", "diffHunk": "@@ -305,6 +301,21 @@ resources:\n     json_key: ((concourse-gcs-resources-service-account-key))\n     regexp: ((pxf-releng-odp-drop-path))/((pxf-odp-file-prefix))-(.*)-ODP.tar.gz\n \n+## ---------- RelEng Drop Artifacts for MS ----------", "originalCommit": "c56a291d5daa37fd133a57542881fb7388803856", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYzMDAyOQ==", "url": "https://github.com/greenplum-db/pxf/pull/454#discussion_r494630029", "bodyText": "we're not checking OSL file here", "author": "denalex", "createdAt": "2020-09-24T21:48:59Z", "path": "concourse/scripts/generate_tarball_from_rpm.bash", "diffHunk": "@@ -0,0 +1,62 @@\n+#!/usr/bin/env bash\n+\n+set -e\n+\n+: \"${GP_VER:?GP_VER must be set}\"\n+: \"${TARGET_OS_VERSION:?TARGET_OS_VERSION must be set}\"\n+\n+function fail() {\n+  echo \"Error: $1\"\n+  exit 1\n+}\n+\n+# check if directory with artifacts is available\n+[[ -d pxf_artifacts ]] || fail \"pxf_artifacts directory not found\"\n+\n+# check if the RPM for GP version and TARGET_OS_VERSION is available\n+rpm_file_name=$(find pxf_artifacts -type f -name \"pxf-gp${GP_VER}-*-2.el${TARGET_OS_VERSION}.x86_64.rpm\")\n+[[ -f ${rpm_file_name} ]] || fail \"pxf_artifacts/licensed/pxf-gp${GP_VER}-*-2.el${TARGET_OS_VERSION}.x86_64.rpm not found\"\n+\n+# attempt to determine the PXF version\n+if [[ ${rpm_file_name##*/} =~ pxf-gp${GP_VER}-([0-9.]+)-2[\\.-](.*\\.(deb|rpm)) ]]; then\n+  pxf_version=${BASH_REMATCH[1]}\n+  suffix=${BASH_REMATCH[2]}\n+  echo \"Determined PXF version number to be '${pxf_version}' with suffix '${suffix}'...\"\n+else\n+  echo \"Couldn't determine version number from file named '${rpm_file_name}'...\"\n+  exit 1\n+fi\n+\n+# install the new RPM, check that the OSL file is present", "originalCommit": "c56a291d5daa37fd133a57542881fb7388803856", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYzMDI5OA==", "url": "https://github.com/greenplum-db/pxf/pull/454#discussion_r494630298", "bodyText": "if you expect files in pxf_artifacts/licensed below, why not search there ?", "author": "denalex", "createdAt": "2020-09-24T21:49:38Z", "path": "concourse/scripts/generate_tarball_from_rpm.bash", "diffHunk": "@@ -0,0 +1,62 @@\n+#!/usr/bin/env bash\n+\n+set -e\n+\n+: \"${GP_VER:?GP_VER must be set}\"\n+: \"${TARGET_OS_VERSION:?TARGET_OS_VERSION must be set}\"\n+\n+function fail() {\n+  echo \"Error: $1\"\n+  exit 1\n+}\n+\n+# check if directory with artifacts is available\n+[[ -d pxf_artifacts ]] || fail \"pxf_artifacts directory not found\"\n+\n+# check if the RPM for GP version and TARGET_OS_VERSION is available\n+rpm_file_name=$(find pxf_artifacts -type f -name \"pxf-gp${GP_VER}-*-2.el${TARGET_OS_VERSION}.x86_64.rpm\")", "originalCommit": "c56a291d5daa37fd133a57542881fb7388803856", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYzMDQ4Nw==", "url": "https://github.com/greenplum-db/pxf/pull/454#discussion_r494630487", "bodyText": "we are not dealing with deb here", "author": "denalex", "createdAt": "2020-09-24T21:50:06Z", "path": "concourse/scripts/generate_tarball_from_rpm.bash", "diffHunk": "@@ -0,0 +1,62 @@\n+#!/usr/bin/env bash\n+\n+set -e\n+\n+: \"${GP_VER:?GP_VER must be set}\"\n+: \"${TARGET_OS_VERSION:?TARGET_OS_VERSION must be set}\"\n+\n+function fail() {\n+  echo \"Error: $1\"\n+  exit 1\n+}\n+\n+# check if directory with artifacts is available\n+[[ -d pxf_artifacts ]] || fail \"pxf_artifacts directory not found\"\n+\n+# check if the RPM for GP version and TARGET_OS_VERSION is available\n+rpm_file_name=$(find pxf_artifacts -type f -name \"pxf-gp${GP_VER}-*-2.el${TARGET_OS_VERSION}.x86_64.rpm\")\n+[[ -f ${rpm_file_name} ]] || fail \"pxf_artifacts/licensed/pxf-gp${GP_VER}-*-2.el${TARGET_OS_VERSION}.x86_64.rpm not found\"\n+\n+# attempt to determine the PXF version\n+if [[ ${rpm_file_name##*/} =~ pxf-gp${GP_VER}-([0-9.]+)-2[\\.-](.*\\.(deb|rpm)) ]]; then", "originalCommit": "c56a291d5daa37fd133a57542881fb7388803856", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYzMDY5OA==", "url": "https://github.com/greenplum-db/pxf/pull/454#discussion_r494630698", "bodyText": "why even bother if you gonna install the RPM, the version is in the version file", "author": "denalex", "createdAt": "2020-09-24T21:50:36Z", "path": "concourse/scripts/generate_tarball_from_rpm.bash", "diffHunk": "@@ -0,0 +1,62 @@\n+#!/usr/bin/env bash\n+\n+set -e\n+\n+: \"${GP_VER:?GP_VER must be set}\"\n+: \"${TARGET_OS_VERSION:?TARGET_OS_VERSION must be set}\"\n+\n+function fail() {\n+  echo \"Error: $1\"\n+  exit 1\n+}\n+\n+# check if directory with artifacts is available\n+[[ -d pxf_artifacts ]] || fail \"pxf_artifacts directory not found\"\n+\n+# check if the RPM for GP version and TARGET_OS_VERSION is available\n+rpm_file_name=$(find pxf_artifacts -type f -name \"pxf-gp${GP_VER}-*-2.el${TARGET_OS_VERSION}.x86_64.rpm\")\n+[[ -f ${rpm_file_name} ]] || fail \"pxf_artifacts/licensed/pxf-gp${GP_VER}-*-2.el${TARGET_OS_VERSION}.x86_64.rpm not found\"\n+\n+# attempt to determine the PXF version\n+if [[ ${rpm_file_name##*/} =~ pxf-gp${GP_VER}-([0-9.]+)-2[\\.-](.*\\.(deb|rpm)) ]]; then\n+  pxf_version=${BASH_REMATCH[1]}\n+  suffix=${BASH_REMATCH[2]}", "originalCommit": "c56a291d5daa37fd133a57542881fb7388803856", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYzMTIzNw==", "url": "https://github.com/greenplum-db/pxf/pull/454#discussion_r494631237", "bodyText": "so we're packaging the OSL file as well ?", "author": "denalex", "createdAt": "2020-09-24T21:51:58Z", "path": "concourse/scripts/generate_tarball_from_rpm.bash", "diffHunk": "@@ -0,0 +1,62 @@\n+#!/usr/bin/env bash\n+\n+set -e\n+\n+: \"${GP_VER:?GP_VER must be set}\"\n+: \"${TARGET_OS_VERSION:?TARGET_OS_VERSION must be set}\"\n+\n+function fail() {\n+  echo \"Error: $1\"\n+  exit 1\n+}\n+\n+# check if directory with artifacts is available\n+[[ -d pxf_artifacts ]] || fail \"pxf_artifacts directory not found\"\n+\n+# check if the RPM for GP version and TARGET_OS_VERSION is available\n+rpm_file_name=$(find pxf_artifacts -type f -name \"pxf-gp${GP_VER}-*-2.el${TARGET_OS_VERSION}.x86_64.rpm\")\n+[[ -f ${rpm_file_name} ]] || fail \"pxf_artifacts/licensed/pxf-gp${GP_VER}-*-2.el${TARGET_OS_VERSION}.x86_64.rpm not found\"\n+\n+# attempt to determine the PXF version\n+if [[ ${rpm_file_name##*/} =~ pxf-gp${GP_VER}-([0-9.]+)-2[\\.-](.*\\.(deb|rpm)) ]]; then\n+  pxf_version=${BASH_REMATCH[1]}\n+  suffix=${BASH_REMATCH[2]}\n+  echo \"Determined PXF version number to be '${pxf_version}' with suffix '${suffix}'...\"\n+else\n+  echo \"Couldn't determine version number from file named '${rpm_file_name}'...\"\n+  exit 1\n+fi\n+\n+# install the new RPM, check that the OSL file is present\n+rpm -ivh \"$rpm_file_name\"\n+echo \"listing installed directory /usr/local/pxf-gp${GP_VER}:\"\n+ls -al \"/usr/local/pxf-gp${GP_VER}\"\n+\n+# copy installed PXF into a staging directory\n+mkdir -p /tmp/pxf_tarball_repackage\n+cp -R \"/usr/local/pxf-gp${GP_VER}/\" /tmp/pxf_tarball_repackage/pxf\n+\n+# place gpextable into the appropriate locations when creating internal `pxf.tar.gz` tarball, so they are just extracted and no additional copying is required\n+mv /tmp/pxf_tarball_repackage/pxf/gpextable/* /tmp/pxf_tarball_repackage/\n+rm -rf /tmp/pxf_tarball_repackage/pxf/gpextable/\n+\n+# list staging directory\n+echo \"listing staging directory /tmp/pxf_tarball_repackage\"\n+ls -al /tmp/pxf_tarball_repackage\n+\n+# create the pxf.tar.gz that contains all files from the RPM installation\n+echo \"create the pxf tarball\"\n+mkdir -p /tmp/pxf_tarball\n+tar -czf /tmp/pxf_tarball/pxf.tar.gz -C /tmp/pxf_tarball_repackage .", "originalCommit": "c56a291d5daa37fd133a57542881fb7388803856", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYzNjEwMA==", "url": "https://github.com/greenplum-db/pxf/pull/454#discussion_r494636100", "bodyText": "yes, it's required, checked with releng", "author": "frankgh", "createdAt": "2020-09-24T22:03:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYzMTIzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYzMTk1OQ==", "url": "https://github.com/greenplum-db/pxf/pull/454#discussion_r494631959", "bodyText": "wouldn't you want to determine base_dir and prefix pxf.tar.gz with it so that the script can be called from anywhere ?", "author": "denalex", "createdAt": "2020-09-24T21:53:37Z", "path": "concourse/scripts/generate_tarball_from_rpm.bash", "diffHunk": "@@ -0,0 +1,62 @@\n+#!/usr/bin/env bash\n+\n+set -e\n+\n+: \"${GP_VER:?GP_VER must be set}\"\n+: \"${TARGET_OS_VERSION:?TARGET_OS_VERSION must be set}\"\n+\n+function fail() {\n+  echo \"Error: $1\"\n+  exit 1\n+}\n+\n+# check if directory with artifacts is available\n+[[ -d pxf_artifacts ]] || fail \"pxf_artifacts directory not found\"\n+\n+# check if the RPM for GP version and TARGET_OS_VERSION is available\n+rpm_file_name=$(find pxf_artifacts -type f -name \"pxf-gp${GP_VER}-*-2.el${TARGET_OS_VERSION}.x86_64.rpm\")\n+[[ -f ${rpm_file_name} ]] || fail \"pxf_artifacts/licensed/pxf-gp${GP_VER}-*-2.el${TARGET_OS_VERSION}.x86_64.rpm not found\"\n+\n+# attempt to determine the PXF version\n+if [[ ${rpm_file_name##*/} =~ pxf-gp${GP_VER}-([0-9.]+)-2[\\.-](.*\\.(deb|rpm)) ]]; then\n+  pxf_version=${BASH_REMATCH[1]}\n+  suffix=${BASH_REMATCH[2]}\n+  echo \"Determined PXF version number to be '${pxf_version}' with suffix '${suffix}'...\"\n+else\n+  echo \"Couldn't determine version number from file named '${rpm_file_name}'...\"\n+  exit 1\n+fi\n+\n+# install the new RPM, check that the OSL file is present\n+rpm -ivh \"$rpm_file_name\"\n+echo \"listing installed directory /usr/local/pxf-gp${GP_VER}:\"\n+ls -al \"/usr/local/pxf-gp${GP_VER}\"\n+\n+# copy installed PXF into a staging directory\n+mkdir -p /tmp/pxf_tarball_repackage\n+cp -R \"/usr/local/pxf-gp${GP_VER}/\" /tmp/pxf_tarball_repackage/pxf\n+\n+# place gpextable into the appropriate locations when creating internal `pxf.tar.gz` tarball, so they are just extracted and no additional copying is required\n+mv /tmp/pxf_tarball_repackage/pxf/gpextable/* /tmp/pxf_tarball_repackage/\n+rm -rf /tmp/pxf_tarball_repackage/pxf/gpextable/\n+\n+# list staging directory\n+echo \"listing staging directory /tmp/pxf_tarball_repackage\"\n+ls -al /tmp/pxf_tarball_repackage\n+\n+# create the pxf.tar.gz that contains all files from the RPM installation\n+echo \"create the pxf tarball\"\n+mkdir -p /tmp/pxf_tarball\n+tar -czf /tmp/pxf_tarball/pxf.tar.gz -C /tmp/pxf_tarball_repackage .\n+\n+# create the install_gpdb_component file\n+cat > /tmp/pxf_tarball/install_gpdb_component <<EOF\n+#!/bin/bash\n+set -x\n+: \"\\${GPHOME:?GPHOME must be set}\"\n+tar xvzf pxf.tar.gz -C \\$GPHOME", "originalCommit": "c56a291d5daa37fd133a57542881fb7388803856", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYzNjE4OQ==", "url": "https://github.com/greenplum-db/pxf/pull/454#discussion_r494636189", "bodyText": "sure", "author": "frankgh", "createdAt": "2020-09-24T22:03:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYzMTk1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY0MzM3NA==", "url": "https://github.com/greenplum-db/pxf/pull/454#discussion_r494643374", "bodyText": "@ashuka24 and I were working with bash regex earlier and the following pattern works:\nif ! [[ ${rpm_file_name##*/} =~ pxf-gp${GP_VER}-([0-9.]+)-2[\\.-](.*\\.(deb|rpm)) ]]; then\n  echo \"Couldn't determine version number from file named '${rpm_file_name}'...\"\n  exit 1\nfi\npxf_version=${BASH_REMATCH[1]}\nsuffix=${BASH_REMATCH[2]}\necho \"Determined PXF version number to be '${pxf_version}' with suffix '${suffix}'...\"\nI feel like it is marginally more readable by turning the if-condition into a guard clause.", "author": "bradfordb-vmware", "createdAt": "2020-09-24T22:23:06Z", "path": "concourse/scripts/generate_tarball_from_rpm.bash", "diffHunk": "@@ -0,0 +1,62 @@\n+#!/usr/bin/env bash\n+\n+set -e\n+\n+: \"${GP_VER:?GP_VER must be set}\"\n+: \"${TARGET_OS_VERSION:?TARGET_OS_VERSION must be set}\"\n+\n+function fail() {\n+  echo \"Error: $1\"\n+  exit 1\n+}\n+\n+# check if directory with artifacts is available\n+[[ -d pxf_artifacts ]] || fail \"pxf_artifacts directory not found\"\n+\n+# check if the RPM for GP version and TARGET_OS_VERSION is available\n+rpm_file_name=$(find pxf_artifacts -type f -name \"pxf-gp${GP_VER}-*-2.el${TARGET_OS_VERSION}.x86_64.rpm\")\n+[[ -f ${rpm_file_name} ]] || fail \"pxf_artifacts/licensed/pxf-gp${GP_VER}-*-2.el${TARGET_OS_VERSION}.x86_64.rpm not found\"\n+\n+# attempt to determine the PXF version\n+if [[ ${rpm_file_name##*/} =~ pxf-gp${GP_VER}-([0-9.]+)-2[\\.-](.*\\.(deb|rpm)) ]]; then", "originalCommit": "c56a291d5daa37fd133a57542881fb7388803856", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY0NDIwMw==", "url": "https://github.com/greenplum-db/pxf/pull/454#discussion_r494644203", "bodyText": "I went with Alex's suggestion of just getting the PXF version from the version file", "author": "frankgh", "createdAt": "2020-09-24T22:25:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY0MzM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY0NDI1OQ==", "url": "https://github.com/greenplum-db/pxf/pull/454#discussion_r494644259", "bodyText": "so no more if :(", "author": "frankgh", "createdAt": "2020-09-24T22:25:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY0MzM3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY0NDEyNw==", "url": "https://github.com/greenplum-db/pxf/pull/454#discussion_r494644127", "bodyText": "Since this is running in CI, I'd drop the -h option which prints a progress bar with # characters. I'd also consider dropping -v unless we want to have a list of the unpacked files printed to the screen.", "author": "bradfordb-vmware", "createdAt": "2020-09-24T22:25:04Z", "path": "concourse/scripts/generate_tarball_from_rpm.bash", "diffHunk": "@@ -0,0 +1,62 @@\n+#!/usr/bin/env bash\n+\n+set -e\n+\n+: \"${GP_VER:?GP_VER must be set}\"\n+: \"${TARGET_OS_VERSION:?TARGET_OS_VERSION must be set}\"\n+\n+function fail() {\n+  echo \"Error: $1\"\n+  exit 1\n+}\n+\n+# check if directory with artifacts is available\n+[[ -d pxf_artifacts ]] || fail \"pxf_artifacts directory not found\"\n+\n+# check if the RPM for GP version and TARGET_OS_VERSION is available\n+rpm_file_name=$(find pxf_artifacts -type f -name \"pxf-gp${GP_VER}-*-2.el${TARGET_OS_VERSION}.x86_64.rpm\")\n+[[ -f ${rpm_file_name} ]] || fail \"pxf_artifacts/licensed/pxf-gp${GP_VER}-*-2.el${TARGET_OS_VERSION}.x86_64.rpm not found\"\n+\n+# attempt to determine the PXF version\n+if [[ ${rpm_file_name##*/} =~ pxf-gp${GP_VER}-([0-9.]+)-2[\\.-](.*\\.(deb|rpm)) ]]; then\n+  pxf_version=${BASH_REMATCH[1]}\n+  suffix=${BASH_REMATCH[2]}\n+  echo \"Determined PXF version number to be '${pxf_version}' with suffix '${suffix}'...\"\n+else\n+  echo \"Couldn't determine version number from file named '${rpm_file_name}'...\"\n+  exit 1\n+fi\n+\n+# install the new RPM, check that the OSL file is present\n+rpm -ivh \"$rpm_file_name\"", "originalCommit": "c56a291d5daa37fd133a57542881fb7388803856", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY0NDg5Mw==", "url": "https://github.com/greenplum-db/pxf/pull/454#discussion_r494644893", "bodyText": "It looks like we are installing only to copy the files out of the rpm. I'd use rpm2cpio *.rpm | cpio -idm to extract in the current working directory. Although this won't run the installation scriptlets.", "author": "bradfordb-vmware", "createdAt": "2020-09-24T22:27:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY0NDEyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEyMzAyMQ==", "url": "https://github.com/greenplum-db/pxf/pull/454#discussion_r495123021", "bodyText": "for now, I'd like to keep rpm install, but we can revisit if requirements change", "author": "frankgh", "createdAt": "2020-09-25T17:10:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY0NDEyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTI0MzcwMw==", "url": "https://github.com/greenplum-db/pxf/pull/454#discussion_r495243703", "bodyText": "after some discussion, we think the rpm2cpio approach is more beneficial for the future", "author": "frankgh", "createdAt": "2020-09-25T21:28:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY0NDEyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY2OTk0OA==", "url": "https://github.com/greenplum-db/pxf/pull/454#discussion_r494669948", "bodyText": "Have we confirmed w/ RelEng if $GPHOME will be set when this is called? I can't remember.", "author": "bradfordb-vmware", "createdAt": "2020-09-24T23:46:34Z", "path": "concourse/scripts/generate_tarball_from_rpm.bash", "diffHunk": "@@ -0,0 +1,62 @@\n+#!/usr/bin/env bash\n+\n+set -e\n+\n+: \"${GP_VER:?GP_VER must be set}\"\n+: \"${TARGET_OS_VERSION:?TARGET_OS_VERSION must be set}\"\n+\n+function fail() {\n+  echo \"Error: $1\"\n+  exit 1\n+}\n+\n+# check if directory with artifacts is available\n+[[ -d pxf_artifacts ]] || fail \"pxf_artifacts directory not found\"\n+\n+# check if the RPM for GP version and TARGET_OS_VERSION is available\n+rpm_file_name=$(find pxf_artifacts -type f -name \"pxf-gp${GP_VER}-*-2.el${TARGET_OS_VERSION}.x86_64.rpm\")\n+[[ -f ${rpm_file_name} ]] || fail \"pxf_artifacts/licensed/pxf-gp${GP_VER}-*-2.el${TARGET_OS_VERSION}.x86_64.rpm not found\"\n+\n+# attempt to determine the PXF version\n+if [[ ${rpm_file_name##*/} =~ pxf-gp${GP_VER}-([0-9.]+)-2[\\.-](.*\\.(deb|rpm)) ]]; then\n+  pxf_version=${BASH_REMATCH[1]}\n+  suffix=${BASH_REMATCH[2]}\n+  echo \"Determined PXF version number to be '${pxf_version}' with suffix '${suffix}'...\"\n+else\n+  echo \"Couldn't determine version number from file named '${rpm_file_name}'...\"\n+  exit 1\n+fi\n+\n+# install the new RPM, check that the OSL file is present\n+rpm -ivh \"$rpm_file_name\"\n+echo \"listing installed directory /usr/local/pxf-gp${GP_VER}:\"\n+ls -al \"/usr/local/pxf-gp${GP_VER}\"\n+\n+# copy installed PXF into a staging directory\n+mkdir -p /tmp/pxf_tarball_repackage\n+cp -R \"/usr/local/pxf-gp${GP_VER}/\" /tmp/pxf_tarball_repackage/pxf\n+\n+# place gpextable into the appropriate locations when creating internal `pxf.tar.gz` tarball, so they are just extracted and no additional copying is required\n+mv /tmp/pxf_tarball_repackage/pxf/gpextable/* /tmp/pxf_tarball_repackage/\n+rm -rf /tmp/pxf_tarball_repackage/pxf/gpextable/\n+\n+# list staging directory\n+echo \"listing staging directory /tmp/pxf_tarball_repackage\"\n+ls -al /tmp/pxf_tarball_repackage\n+\n+# create the pxf.tar.gz that contains all files from the RPM installation\n+echo \"create the pxf tarball\"\n+mkdir -p /tmp/pxf_tarball\n+tar -czf /tmp/pxf_tarball/pxf.tar.gz -C /tmp/pxf_tarball_repackage .\n+\n+# create the install_gpdb_component file\n+cat > /tmp/pxf_tarball/install_gpdb_component <<EOF\n+#!/bin/bash\n+set -x\n+: \"\\${GPHOME:?GPHOME must be set}\"", "originalCommit": "c56a291d5daa37fd133a57542881fb7388803856", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY3NjU0Mw==", "url": "https://github.com/greenplum-db/pxf/pull/454#discussion_r494676543", "bodyText": "it was on the story as a requirement:\n\nWhen install_gpdb_component is run using the standard process of installing internal components it shall:\n\nCheck is $GPHOME is set, fail otherwise\n...", "author": "frankgh", "createdAt": "2020-09-25T00:09:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY2OTk0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTEyMjU5NQ==", "url": "https://github.com/greenplum-db/pxf/pull/454#discussion_r495122595", "bodyText": "thanks for checking @bradfordb-vmware . GPHOME is set to run the script.", "author": "frankgh", "createdAt": "2020-09-25T17:09:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY2OTk0OA=="}], "type": "inlineReview"}, {"oid": "f71db4de01663e10b56f085f7cac8396efb2c193", "url": "https://github.com/greenplum-db/pxf/commit/f71db4de01663e10b56f085f7cac8396efb2c193", "message": "CI: Publish GP5 artifacts to Google Cloud Storage\n\nRelease engineering has requested that we start publishing GP5 artifacts\nto Google Cloud Storage instead of S3. This commit changes the location\nwhere these artifacts are published.", "committedDate": "2020-09-25T18:47:18Z", "type": "forcePushed"}, {"oid": "b7338a53a9f2b7c588a5124b27a7f6a748a8c6c1", "url": "https://github.com/greenplum-db/pxf/commit/b7338a53a9f2b7c588a5124b27a7f6a748a8c6c1", "message": "Publish PXF binary tarballs\n\nSupport an internal component tarball for new PXF releases that fully\nsupport installation with no manual action. The\n`Publish_PXF-GP5_and_PXF-GP6_Artifacts_to_GP-RelEng` job in the\n`pxf-build` pipeline will now has two new tasks:\n- Generate PXF binary tarball from PXF-GP5 on RHEL6 RPM\n- Generate PXF binary tarball from PXF-GP6 on RHEL7 RPM\n\nThese tasks will produce a tarball with an installer script from a\nPXF RPM. The binary tarballs need to be created for both GP5 (RHEL6) and\nGP6 (RHEL7) only.\n\nThe script that is run by the task does the following:\n- Takes as input a `licensed` PXF RPM\n- Tars the content of the PXF RPM so it is laid out in $GPHOME upon\n  extraction\n- Tars the resulting tar from the previous step and an installer script\n- Provides an `install_gpdb_component` executable bash script that\n  installs PXF under GPHOME (GPHOME is mandatory)\n\nThe produced artifacts are then uploaded to Google Cloud Storage buckets\nto be consumed by release engineering.\n\nFinally, notify releng of the tarballs that have been published along\nwith RPM/deb/OSL/ODP.", "committedDate": "2020-09-26T12:43:00Z", "type": "commit"}, {"oid": "3c5d78bd70c811428a01139397492e0b8da8ce8d", "url": "https://github.com/greenplum-db/pxf/commit/3c5d78bd70c811428a01139397492e0b8da8ce8d", "message": "CI: Publish GP5 artifacts to Google Cloud Storage\n\nRelease engineering has requested that we start publishing GP5 artifacts\nto Google Cloud Storage instead of S3. This commit changes the location\nwhere these artifacts are published.", "committedDate": "2020-09-26T12:43:07Z", "type": "commit"}, {"oid": "3c5d78bd70c811428a01139397492e0b8da8ce8d", "url": "https://github.com/greenplum-db/pxf/commit/3c5d78bd70c811428a01139397492e0b8da8ce8d", "message": "CI: Publish GP5 artifacts to Google Cloud Storage\n\nRelease engineering has requested that we start publishing GP5 artifacts\nto Google Cloud Storage instead of S3. This commit changes the location\nwhere these artifacts are published.", "committedDate": "2020-09-26T12:43:07Z", "type": "forcePushed"}]}