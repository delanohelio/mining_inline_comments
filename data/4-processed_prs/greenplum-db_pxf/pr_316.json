{"pr_number": 316, "pr_title": "Address CVE-2020-1938", "pr_createdAt": "2020-03-11T20:31:14Z", "pr_url": "https://github.com/greenplum-db/pxf/pull/316", "timeline": [{"oid": "cde98c2448fa77ab2980f99e065cf42f3ffc40ce", "url": "https://github.com/greenplum-db/pxf/commit/cde98c2448fa77ab2980f99e065cf42f3ffc40ce", "message": "Address CVE-2020-1938\n\nThe AJP protocol is enabled by default in Tomcat versions < 7.0.100,\nwith the AJP connector listening in TCP port 8009 by default. This is\nlow impact on PXF because PXF should only be accessible from segments\ncollocated with the PXF Server. It is important to note that mitigation\nis only required if an AJP port is accessible to untrusted users.\n\nTomcat 7.0.100 disables AJP protocol by default", "committedDate": "2020-03-11T20:37:51Z", "type": "commit"}, {"oid": "cde98c2448fa77ab2980f99e065cf42f3ffc40ce", "url": "https://github.com/greenplum-db/pxf/commit/cde98c2448fa77ab2980f99e065cf42f3ffc40ce", "message": "Address CVE-2020-1938\n\nThe AJP protocol is enabled by default in Tomcat versions < 7.0.100,\nwith the AJP connector listening in TCP port 8009 by default. This is\nlow impact on PXF because PXF should only be accessible from segments\ncollocated with the PXF Server. It is important to note that mitigation\nis only required if an AJP port is accessible to untrusted users.\n\nTomcat 7.0.100 disables AJP protocol by default", "committedDate": "2020-03-11T20:37:51Z", "type": "forcePushed"}, {"oid": "ae57ca144509219ad8a35d66ca732d4802dba7f5", "url": "https://github.com/greenplum-db/pxf/commit/ae57ca144509219ad8a35d66ca732d4802dba7f5", "message": "URL decode custom header values when the X-GP-ENCODED-HEADER-VALUES is true\n\nStarting in Tomcat version 7.0.100, HTTP header validation was tightened\ndisallowing invalid header values. These changed in Tomcat were a side\neffect of fixes for CVE-2020-1935. This issue manifests when a table is\ncreated with non printable delimiters, for example:\n\n    CREATE EXTERNAL TABLE foo ()\n    LOCATION ('pxf://some/path?PROFILE=demo&SERVER=demo')\n    FORMAT 'CSV' ( DELIMITER E'\\x01' );\n\nThe delimiter value is passed to PXF Server in an HTTP header, however\nunencoded. This is causing Tomcat to drop headers with invalid header\nvalues, and causing PXF to behave incorrectly.\n\nIn this commit, we decode custom (X-GP-*) header values when the\nX-GP-ENCODED-HEADER-VALUES is true.", "committedDate": "2020-03-13T15:37:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMyMzA1Mw==", "url": "https://github.com/greenplum-db/pxf/pull/316#discussion_r392323053", "bodyText": "Shouldn't we ignore case on the value as well?", "author": "oliverralbertini", "createdAt": "2020-03-13T16:06:01Z", "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/HttpRequestParser.java", "diffHunk": "@@ -391,24 +394,51 @@ private int parsePositiveIntOrError(String s, String propName) {\n         private static final String PROP_PREFIX = \"X-GP-\";\n         private static final String USER_PROP_PREFIX = \"X-GP-OPTIONS-\";\n         private static final String USER_PROP_PREFIX_LOWERCASE = \"x-gp-options-\";\n+        private static final String ENCODED_HEADER_VALUES_NAME = PROP_PREFIX + \"ENCODED-HEADER-VALUES\";\n \n-        RequestMap(MultivaluedMap<String, String> requestHeaders) {\n+        RequestMap(MultivaluedMap<String, String> requestHeaders) throws UnsupportedEncodingException {\n             super(String.CASE_INSENSITIVE_ORDER);\n+\n+            boolean decodeHeaderValue = false;\n             for (Map.Entry<String, List<String>> entry : requestHeaders.entrySet()) {\n-                List<String> values = entry.getValue();\n-                if (values == null) continue;\n+                if (StringUtils.equalsIgnoreCase(ENCODED_HEADER_VALUES_NAME, entry.getKey())) {\n+                    String value = getValue(entry.getValue());\n+                    decodeHeaderValue = StringUtils.equals(\"true\", value);", "originalCommit": "ae57ca144509219ad8a35d66ca732d4802dba7f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQ4Nzk1Nw==", "url": "https://github.com/greenplum-db/pxf/pull/316#discussion_r392487957", "bodyText": "Did you make a change here?", "author": "oliverralbertini", "createdAt": "2020-03-13T21:25:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMyMzA1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU4OTQ4OQ==", "url": "https://github.com/greenplum-db/pxf/pull/316#discussion_r392589489", "bodyText": "it is equalsIgnoreCase now", "author": "frankgh", "createdAt": "2020-03-14T13:44:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjMyMzA1Mw=="}], "type": "inlineReview"}, {"oid": "c4efb73c4dfc07936ceb8c3e19eb9553e54eb15d", "url": "https://github.com/greenplum-db/pxf/commit/c4efb73c4dfc07936ceb8c3e19eb9553e54eb15d", "message": "URL decode custom header values when the X-GP-ENCODED-HEADER-VALUES is true\n\nStarting in Tomcat version 7.0.100, HTTP header validation was tightened\ndisallowing invalid header values. These changed in Tomcat were a side\neffect of fixes for CVE-2020-1935. This issue manifests when a table is\ncreated with non printable delimiters, for example:\n\n    CREATE EXTERNAL TABLE foo ()\n    LOCATION ('pxf://some/path?PROFILE=demo&SERVER=demo')\n    FORMAT 'CSV' ( DELIMITER E'\\x01' );\n\nThe delimiter value is passed to PXF Server in an HTTP header, however\nunencoded. This is causing Tomcat to drop headers with invalid header\nvalues, and causing PXF to behave incorrectly.\n\nIn this commit, we decode custom (X-GP-*) header values when the\nX-GP-ENCODED-HEADER-VALUES is true.", "committedDate": "2020-03-13T16:17:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxMjM5NQ==", "url": "https://github.com/greenplum-db/pxf/pull/316#discussion_r392512395", "bodyText": "why throw this exception ? We can't recover from it, might as well throw RuntimeException and simplify method signatures", "author": "denalex", "createdAt": "2020-03-13T22:24:46Z", "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/HttpRequestParser.java", "diffHunk": "@@ -391,24 +394,51 @@ private int parsePositiveIntOrError(String s, String propName) {\n         private static final String PROP_PREFIX = \"X-GP-\";\n         private static final String USER_PROP_PREFIX = \"X-GP-OPTIONS-\";\n         private static final String USER_PROP_PREFIX_LOWERCASE = \"x-gp-options-\";\n+        private static final String ENCODED_HEADER_VALUES_NAME = PROP_PREFIX + \"ENCODED-HEADER-VALUES\";\n \n-        RequestMap(MultivaluedMap<String, String> requestHeaders) {\n+        RequestMap(MultivaluedMap<String, String> requestHeaders) throws UnsupportedEncodingException {", "originalCommit": "c4efb73c4dfc07936ceb8c3e19eb9553e54eb15d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxOTc2Mw==", "url": "https://github.com/greenplum-db/pxf/pull/316#discussion_r392519763", "bodyText": "yeah, good point", "author": "frankgh", "createdAt": "2020-03-13T22:54:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxMjM5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxNDA3NQ==", "url": "https://github.com/greenplum-db/pxf/pull/316#discussion_r392514075", "bodyText": "should we have unit tests that test that we trigger the logic on the header value, case insensitive and that decoding is correct ?", "author": "denalex", "createdAt": "2020-03-13T22:31:05Z", "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/HttpRequestParser.java", "diffHunk": "@@ -391,24 +394,51 @@ private int parsePositiveIntOrError(String s, String propName) {\n         private static final String PROP_PREFIX = \"X-GP-\";\n         private static final String USER_PROP_PREFIX = \"X-GP-OPTIONS-\";\n         private static final String USER_PROP_PREFIX_LOWERCASE = \"x-gp-options-\";\n+        private static final String ENCODED_HEADER_VALUES_NAME = PROP_PREFIX + \"ENCODED-HEADER-VALUES\";\n \n-        RequestMap(MultivaluedMap<String, String> requestHeaders) {\n+        RequestMap(MultivaluedMap<String, String> requestHeaders) throws UnsupportedEncodingException {\n             super(String.CASE_INSENSITIVE_ORDER);\n+\n+            boolean decodeHeaderValue = false;\n             for (Map.Entry<String, List<String>> entry : requestHeaders.entrySet()) {\n-                List<String> values = entry.getValue();\n-                if (values == null) continue;\n+                if (StringUtils.equalsIgnoreCase(ENCODED_HEADER_VALUES_NAME, entry.getKey())) {\n+                    String value = getValue(entry.getValue());\n+                    decodeHeaderValue = StringUtils.equalsIgnoreCase(\"true\", value);\n+                    break;\n+                }\n+            }\n \n-                String value = values.size() > 1 ? StringUtils.join(values, \",\") : values.get(0);\n+            for (Map.Entry<String, List<String>> entry : requestHeaders.entrySet()) {\n+                String value = getValue(entry.getValue());\n                 if (value == null) continue;\n \n-                // Converting to value UTF-8 encoding\n                 String key = entry.getKey();\n-                value = new String(value.getBytes(StandardCharsets.ISO_8859_1), StandardCharsets.UTF_8);\n+                if (decodeHeaderValue && StringUtils.startsWithIgnoreCase(key, PROP_PREFIX)) {\n+                    value = URLDecoder.decode(value, StandardCharsets.UTF_8.name());\n+                }", "originalCommit": "c4efb73c4dfc07936ceb8c3e19eb9553e54eb15d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxOTcxMw==", "url": "https://github.com/greenplum-db/pxf/pull/316#discussion_r392519713", "bodyText": "yes! definitely", "author": "frankgh", "createdAt": "2020-03-13T22:54:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxNDA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUyMjI4Nw==", "url": "https://github.com/greenplum-db/pxf/pull/316#discussion_r392522287", "bodyText": "@denalex  I just added unit tests", "author": "frankgh", "createdAt": "2020-03-13T23:05:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUxNDA3NQ=="}], "type": "inlineReview"}, {"oid": "80dd87388e608ba5966fd35b166e60b43ff9553f", "url": "https://github.com/greenplum-db/pxf/commit/80dd87388e608ba5966fd35b166e60b43ff9553f", "message": "URL decode custom header values when the X-GP-ENCODED-HEADER-VALUES is true\n\nStarting in Tomcat version 7.0.100, HTTP header validation was tightened\ndisallowing invalid header values. These changed in Tomcat were a side\neffect of fixes for CVE-2020-1935. This issue manifests when a table is\ncreated with non printable delimiters, for example:\n\n    CREATE EXTERNAL TABLE foo ()\n    LOCATION ('pxf://some/path?PROFILE=demo&SERVER=demo')\n    FORMAT 'CSV' ( DELIMITER E'\\x01' );\n\nThe delimiter value is passed to PXF Server in an HTTP header, however\nunencoded. This is causing Tomcat to drop headers with invalid header\nvalues, and causing PXF to behave incorrectly.\n\nIn this commit, we decode custom (X-GP-*) header values when the\nX-GP-ENCODED-HEADER-VALUES is true.", "committedDate": "2020-03-13T23:05:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUyMzA0MA==", "url": "https://github.com/greenplum-db/pxf/pull/316#discussion_r392523040", "bodyText": "@oliverralbertini the logic was moved to the getValue method", "author": "frankgh", "createdAt": "2020-03-13T23:08:49Z", "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/HttpRequestParser.java", "diffHunk": "@@ -391,24 +393,55 @@ private int parsePositiveIntOrError(String s, String propName) {\n         private static final String PROP_PREFIX = \"X-GP-\";\n         private static final String USER_PROP_PREFIX = \"X-GP-OPTIONS-\";\n         private static final String USER_PROP_PREFIX_LOWERCASE = \"x-gp-options-\";\n+        private static final String ENCODED_HEADER_VALUES_NAME = PROP_PREFIX + \"ENCODED-HEADER-VALUES\";\n \n         RequestMap(MultivaluedMap<String, String> requestHeaders) {\n             super(String.CASE_INSENSITIVE_ORDER);\n+\n+            boolean decodeHeaderValue = false;\n             for (Map.Entry<String, List<String>> entry : requestHeaders.entrySet()) {\n-                List<String> values = entry.getValue();\n-                if (values == null) continue;\n+                if (StringUtils.equalsIgnoreCase(ENCODED_HEADER_VALUES_NAME, entry.getKey())) {\n+                    String value = getValue(entry.getValue());\n+                    decodeHeaderValue = StringUtils.equalsIgnoreCase(\"true\", value);\n+                    break;\n+                }\n+            }\n \n-                String value = values.size() > 1 ? StringUtils.join(values, \",\") : values.get(0);\n+            for (Map.Entry<String, List<String>> entry : requestHeaders.entrySet()) {\n+                String value = getValue(entry.getValue());", "originalCommit": "80dd87388e608ba5966fd35b166e60b43ff9553f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "679cfcbe48de9c19a2ffff3046fe4904218d4ecb", "url": "https://github.com/greenplum-db/pxf/commit/679cfcbe48de9c19a2ffff3046fe4904218d4ecb", "message": "URL decode custom header values when the X-GP-ENCODED-HEADER-VALUES is true\n\nStarting in Tomcat version 7.0.100, HTTP header validation was tightened\ndisallowing invalid header values. These changed in Tomcat were a side\neffect of fixes for CVE-2020-1935. This issue manifests when a table is\ncreated with non printable delimiters, for example:\n\n    CREATE EXTERNAL TABLE foo ()\n    LOCATION ('pxf://some/path?PROFILE=demo&SERVER=demo')\n    FORMAT 'CSV' ( DELIMITER E'\\x01' );\n\nThe delimiter value is passed to PXF Server in an HTTP header, however\nunencoded. This is causing Tomcat to drop headers with invalid header\nvalues, and causing PXF to behave incorrectly.\n\nIn this commit, we decode custom (X-GP-*) header values when the\nX-GP-ENCODED-HEADER-VALUES is true.", "committedDate": "2020-03-13T23:36:54Z", "type": "commit"}, {"oid": "679cfcbe48de9c19a2ffff3046fe4904218d4ecb", "url": "https://github.com/greenplum-db/pxf/commit/679cfcbe48de9c19a2ffff3046fe4904218d4ecb", "message": "URL decode custom header values when the X-GP-ENCODED-HEADER-VALUES is true\n\nStarting in Tomcat version 7.0.100, HTTP header validation was tightened\ndisallowing invalid header values. These changed in Tomcat were a side\neffect of fixes for CVE-2020-1935. This issue manifests when a table is\ncreated with non printable delimiters, for example:\n\n    CREATE EXTERNAL TABLE foo ()\n    LOCATION ('pxf://some/path?PROFILE=demo&SERVER=demo')\n    FORMAT 'CSV' ( DELIMITER E'\\x01' );\n\nThe delimiter value is passed to PXF Server in an HTTP header, however\nunencoded. This is causing Tomcat to drop headers with invalid header\nvalues, and causing PXF to behave incorrectly.\n\nIn this commit, we decode custom (X-GP-*) header values when the\nX-GP-ENCODED-HEADER-VALUES is true.", "committedDate": "2020-03-13T23:36:54Z", "type": "forcePushed"}]}