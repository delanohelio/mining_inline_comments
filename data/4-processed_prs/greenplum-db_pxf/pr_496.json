{"pr_number": 496, "pr_title": "Add PXF upgrade test", "pr_createdAt": "2020-11-17T20:45:59Z", "pr_url": "https://github.com/greenplum-db/pxf/pull/496", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM4Nzk1OQ==", "url": "https://github.com/greenplum-db/pxf/pull/496#discussion_r526387959", "bodyText": "Why was this not required before?", "author": "ashuka24", "createdAt": "2020-11-18T20:10:57Z", "path": "concourse/scripts/pxf_common.bash", "diffHunk": "@@ -442,6 +451,15 @@ function start_hadoop_services() {\n \tfi\n }\n \n+function init_pxf() {", "originalCommit": "fb8bbb2df775676969ad3b427fef41a19163423a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQwMjA2Nw==", "url": "https://github.com/greenplum-db/pxf/pull/496#discussion_r526402067", "bodyText": "we used to init for PXF 5.x, but we no longer do it. We are bringing the init step back for PXF 5.x installations", "author": "frankgh", "createdAt": "2020-11-18T20:32:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM4Nzk1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODkxMDczNA==", "url": "https://github.com/greenplum-db/pxf/pull/496#discussion_r528910734", "bodyText": "If we change this cat <<-EOF > /tmp/pxf_installer/install_component, then we can indent the here-document with tabs and they will be stripped. This would allow indenting in a natural fashion, although we would have a mix of tabs and spaces in the whole file.", "author": "bradfordb-vmware", "createdAt": "2020-11-23T18:27:03Z", "path": "concourse/scripts/install_pxf.bash", "diffHunk": "@@ -186,35 +227,55 @@ function run_pxf_installer_scripts() {\n \t\t\tgpstop -u\n \t\tfi &&\n \t\tsed -i '/edw/d' hostfile_all &&\n-\t\tgpscp -f ~gpadmin/hostfile_all -v -u centos ~gpadmin/install_pxf_dependencies.sh centos@=: &&\n+\t\tgpscp -f ~gpadmin/hostfile_all -v -u centos -r ~/pxf_installer ~gpadmin/install_pxf_dependencies.sh centos@=: &&\n \t\tgpssh -f ~gpadmin/hostfile_all -v -u centos -s -e 'sudo ~centos/install_pxf_dependencies.sh' &&\n-\t\tif [[ ${PXF_COMPONENT} == true ]]; then\n-\t\t\tgpscp -f ~gpadmin/hostfile_all -v -u centos -r ~/pxf_tarball centos@=: &&\n-\t\t\tgpssh -f ~gpadmin/hostfile_all -v -u centos -s -e 'tar -xzf ~centos/pxf_tarball/pxf-*.tar.gz -C /tmp'\n-\t\t\tgpssh -f ~gpadmin/hostfile_all -v -u centos -s -e 'sudo GPHOME=${GPHOME} /tmp/pxf*/install_component'\n-\t\t\tgpssh -f ~gpadmin/hostfile_all -v -u centos -s -e 'sudo chown -R gpadmin:gpadmin ${PXF_HOME}'\n+\t\tgpssh -f ~gpadmin/hostfile_all -v -u centos -s -e 'sudo GPHOME=${GPHOME} ~centos/pxf_installer/install_component'\n+\t\tgpssh -f ~gpadmin/hostfile_all -v -u centos -s -e 'sudo chown -R gpadmin:gpadmin ${PXF_HOME}'\n+\t\tif [[ ${PXF_VERSION} == 5 ]]; then\n+\t\t\tGPHOME=${GPHOME} PXF_CONF=${BASE_DIR} ${PXF_HOME}/bin/pxf cluster init\n \t\telse\n-\t\t\tgpscp -f ~gpadmin/hostfile_all -v -u gpadmin -r ~/pxf_tarball gpadmin@=: &&\n-\t\t\tgpssh -f ~gpadmin/hostfile_all -v -u gpadmin -s -e 'tar -xzf ~/pxf_tarball/pxf.tar.gz -C ${GPHOME}'\n+\t\t\t${PXF_HOME}/bin/pxf cluster register\n \t\tfi &&\n-\t\t${PXF_HOME}/bin/pxf cluster register &&\n \t\tif [[ -d ~/dataproc_env_files ]]; then\n \t\t\tgpscp -f ~gpadmin/hostfile_init -v -r -u gpadmin ~/dataproc_env_files =:\n \t\tfi &&\n \t\t~gpadmin/configure_pxf.sh &&\n \t\tgpssh -f ~gpadmin/hostfile_all -v -u centos -s -e \\\"sudo sed -i -e 's/edw0/edw0 hadoop/' /etc/hosts\\\" &&\n-\t\tPXF_BASE=${PXF_BASE_DIR} ${PXF_HOME}/bin/pxf cluster sync &&\n-\t\tPXF_BASE=${PXF_BASE_DIR} ${PXF_HOME}/bin/pxf cluster start &&\n+\t\t${PXF_HOME}/bin/pxf cluster sync &&\n+\t\t${PXF_HOME}/bin/pxf cluster start &&\n \t\tif [[ $INSTALL_GPHDFS == true ]]; then\n \t\t\tgpssh -f ~gpadmin/hostfile_all -v -u centos -s -e '\n-\t\t\t\tsudo cp ${PXF_BASE_DIR}/servers/default/{core,hdfs}-site.xml /etc/hadoop/conf\n+\t\t\t\tsudo cp ${BASE_DIR}/servers/default/{core,hdfs}-site.xml /etc/hadoop/conf\n \t\t\t'\n \t\tfi\n \t\"\n }\n \n function _main() {\n-\tlocal SCP_FILES=(pxf_tarball cluster_env_files/*)\n+\tmkdir -p /tmp/pxf_installer/\n+\tif [[ -d pxf_tarball ]]; then\n+\t\tif [[ ${PXF_COMPONENT} == true ]]; then\n+\t\t\tmkdir -p /tmp/pxf_inflate\n+\t\t\ttar -xzf pxf_tarball/pxf-*.tar.gz -C /tmp/pxf_inflate\n+\t\t\tcp /tmp/pxf_inflate/pxf*/* /tmp/pxf_installer/\n+\t\telse\n+\t\t\tcp pxf_tarball/pxf.tar.gz /tmp/pxf_installer\n+\t\t\tcat << EOF > /tmp/pxf_installer/install_component", "originalCommit": "fb8bbb2df775676969ad3b427fef41a19163423a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f3ec794309ae951d528e16bf3a32d714dc8da3b5", "url": "https://github.com/greenplum-db/pxf/commit/f3ec794309ae951d528e16bf3a32d714dc8da3b5", "message": "Add PXF upgrade test\n\nTest upgrading from the Latest released version of PXF 5 to the PXF 6\nversion in the multinode environment.", "committedDate": "2020-11-24T14:09:12Z", "type": "commit"}, {"oid": "f3ec794309ae951d528e16bf3a32d714dc8da3b5", "url": "https://github.com/greenplum-db/pxf/commit/f3ec794309ae951d528e16bf3a32d714dc8da3b5", "message": "Add PXF upgrade test\n\nTest upgrading from the Latest released version of PXF 5 to the PXF 6\nversion in the multinode environment.", "committedDate": "2020-11-24T14:09:12Z", "type": "forcePushed"}]}