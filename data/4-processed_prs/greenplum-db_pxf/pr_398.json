{"pr_number": 398, "pr_title": "Spring boot Performance", "pr_createdAt": "2020-06-30T15:51:59Z", "pr_url": "https://github.com/greenplum-db/pxf/pull/398", "timeline": [{"oid": "d0a2ff6a1b6cd6c586ae0e0393d113b351760a9c", "url": "https://github.com/greenplum-db/pxf/commit/d0a2ff6a1b6cd6c586ae0e0393d113b351760a9c", "message": "Add more information for performance testing", "committedDate": "2020-06-26T20:50:47Z", "type": "commit"}, {"oid": "943eaed41d51d8a062b19835b98f27f6fac46947", "url": "https://github.com/greenplum-db/pxf/commit/943eaed41d51d8a062b19835b98f27f6fac46947", "message": "set connection-timeout to -1", "committedDate": "2020-06-26T20:58:46Z", "type": "commit"}, {"oid": "4ef9ce22919f4a36a90a849cbd28517aa387b8e4", "url": "https://github.com/greenplum-db/pxf/commit/4ef9ce22919f4a36a90a849cbd28517aa387b8e4", "message": "120s for connection timeout", "committedDate": "2020-06-29T20:32:57Z", "type": "commit"}, {"oid": "6731b6beee011662655962faec1b0db7bf9ae5b4", "url": "https://github.com/greenplum-db/pxf/commit/6731b6beee011662655962faec1b0db7bf9ae5b4", "message": " 120s -> 240s", "committedDate": "2020-06-30T01:08:30Z", "type": "commit"}, {"oid": "c5856dd5109e3def529dddbf95d6eede535243bc", "url": "https://github.com/greenplum-db/pxf/commit/c5856dd5109e3def529dddbf95d6eede535243bc", "message": "600s", "committedDate": "2020-06-30T10:49:15Z", "type": "commit"}, {"oid": "f54380bac9a19fd716a4607ea5a8dccd91b3d36a", "url": "https://github.com/greenplum-db/pxf/commit/f54380bac9a19fd716a4607ea5a8dccd91b3d36a", "message": "600s -> 10m", "committedDate": "2020-06-30T15:08:23Z", "type": "commit"}, {"oid": "b76f640de7bd084f323bb353aef5fba18f007c10", "url": "https://github.com/greenplum-db/pxf/commit/b76f640de7bd084f323bb353aef5fba18f007c10", "message": "fix typo", "committedDate": "2020-06-30T15:48:22Z", "type": "commit"}, {"oid": "d65d7ddfa21849ccaae894e94dee01a3a9cf7586", "url": "https://github.com/greenplum-db/pxf/commit/d65d7ddfa21849ccaae894e94dee01a3a9cf7586", "message": "Graceful shutdown", "committedDate": "2020-06-30T16:33:53Z", "type": "commit"}, {"oid": "e4292b34ff1d296b1940a80dac208930d679dd62", "url": "https://github.com/greenplum-db/pxf/commit/e4292b34ff1d296b1940a80dac208930d679dd62", "message": "10m -> 5m", "committedDate": "2020-06-30T16:46:44Z", "type": "commit"}, {"oid": "b4e4357e7ab3aba74b65cb89f8f60b7640d95223", "url": "https://github.com/greenplum-db/pxf/commit/b4e4357e7ab3aba74b65cb89f8f60b7640d95223", "message": "Use PXF_CONNECTION_TIMEOUT to tune the connection timeout", "committedDate": "2020-06-30T19:15:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYyOTcwMw==", "url": "https://github.com/greenplum-db/pxf/pull/398#discussion_r448629703", "bodyText": "wonder, should we still log at WARN level here to be consistent. Extra context if debug is on is ok.", "author": "denalex", "createdAt": "2020-07-01T21:38:05Z", "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/rest/BridgeResponse.java", "diffHunk": "@@ -77,9 +77,9 @@ private Void writeToInternal(OutputStream out) throws IOException {\n             // Occurs whenever client (GPDB) decides to end the connection\n             if (LOG.isDebugEnabled()) {\n                 // Stacktrace in debug\n-                LOG.debug(\"Remote connection closed by GPDB\", e);\n+                LOG.debug(String.format(\"Remote connection closed by GPDB (segment %s)\", context.getSegmentId()), e);", "originalCommit": "b4e4357e7ab3aba74b65cb89f8f60b7640d95223", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzNTgxNw==", "url": "https://github.com/greenplum-db/pxf/pull/398#discussion_r448635817", "bodyText": "good point", "author": "frankgh", "createdAt": "2020-07-01T21:53:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYyOTcwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYyOTkwNw==", "url": "https://github.com/greenplum-db/pxf/pull/398#discussion_r448629907", "bodyText": "same question about WARN level.", "author": "denalex", "createdAt": "2020-07-01T21:38:39Z", "path": "server/pxf-service/src/main/java/org/greenplum/pxf/service/rest/WritableResource.java", "diffHunk": "@@ -160,9 +160,9 @@ public WritableResource(BridgeFactory bridgeFactory, SecurityService securitySer\n                 // Occurs whenever client (GPDB) decides to end the connection\n                 if (LOG.isDebugEnabled()) {\n                     // Stacktrace in debug\n-                    LOG.debug(\"Remote connection closed by GPDB\", cae);\n+                    LOG.debug(String.format(\"Remote connection closed by GPDB (segment %s)\", context.getSegmentId()), cae);", "originalCommit": "b4e4357e7ab3aba74b65cb89f8f60b7640d95223", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzMDUzNA==", "url": "https://github.com/greenplum-db/pxf/pull/398#discussion_r448630534", "bodyText": "do we only give the server 1s to fish up work and shutdown ? What about our thread pool, will threads have a chance to finish reading /writing ? that might take a while", "author": "denalex", "createdAt": "2020-07-01T21:40:12Z", "path": "server/pxf-service/src/main/resources/application.properties", "diffHunk": "@@ -7,7 +7,10 @@ management.endpoint.shutdown.enabled=true\n management.health.probes.enabled=true\n \n server.port=${pxf.port:5888}\n+server.shutdown=graceful\n+spring.lifecycle.timeout-per-shutdown-phase=1s", "originalCommit": "b4e4357e7ab3aba74b65cb89f8f60b7640d95223", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzNzIyMQ==", "url": "https://github.com/greenplum-db/pxf/pull/398#discussion_r448637221", "bodyText": "I wasn't sure about this one, I think what I wanted to achieve is to enable graceful shutdown, and then users can configure the timeout, but I didn't want to set it to a high number. Maybe we can add # export SPRING_LIFECYCLE_TIMEOUT_PER_SHUTDOWN_PHASE=1s in our pxf-env.sh and pxf-env-default.sh templates", "author": "frankgh", "createdAt": "2020-07-01T21:56:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzMDUzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY0Mzc2MQ==", "url": "https://github.com/greenplum-db/pxf/pull/398#discussion_r448643761", "bodyText": "seems like the default is 30 secs: https://docs.spring.io/spring/docs/3.2.4.RELEASE_to_4.0.0.M3/Spring%20Framework%203.2.4.RELEASE/org/springframework/context/support/DefaultLifecycleProcessor.html#setTimeoutPerShutdownPhase(long)\nI think we should discuss whether we need a graceful shutdown at all, it is not like we have a user-facing app with sub-second response time and want to preserve their session. If for us graceful shutdown means not to accept any new work but let existing queries finish, this might take minutes if not hours.", "author": "denalex", "createdAt": "2020-07-01T22:15:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzMDUzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzMTI5OA==", "url": "https://github.com/greenplum-db/pxf/pull/398#discussion_r448631298", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    # initialize PXF 6.x on a PXF 5.x installation that had already been\n          \n          \n            \n                    # initialize PXF 6.x using a pre-existing PXF 5.x configuration", "author": "denalex", "createdAt": "2020-07-01T21:41:59Z", "path": "server/pxf-service/src/scripts/pxf", "diffHunk": "@@ -214,6 +214,13 @@ function generateUserConfigs()\n     setup_conf_directory \"${PXF_CONF}/servers\"\n     setup_conf_directory \"${PXF_CONF}/servers/default\"\n     setup_conf_directory \"${PXF_CONF}/templates\" \"${PXF_HOME}/templates/user/templates\" 'override'\n+\n+    if [[ ! -f \"${PXF_CONF}/conf/pxf-log4j2.xml\" ]]; then\n+        # copy the new pxf-log4j2.xml if it doesn't exist. This allows us to\n+        # initialize PXF 6.x on a PXF 5.x installation that had already been", "originalCommit": "b4e4357e7ab3aba74b65cb89f8f60b7640d95223", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzMTg3MQ==", "url": "https://github.com/greenplum-db/pxf/pull/398#discussion_r448631871", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            # The number of milliseconds the server will wait, after accepting a\n          \n          \n            \n            # The time interval the server will wait, after accepting a\n          \n      \n    \n    \n  \n\nmessage was inconsistent with the value 5m", "author": "denalex", "createdAt": "2020-07-01T21:43:28Z", "path": "server/pxf-service/src/scripts/pxf-env-default.sh", "diffHunk": "@@ -47,6 +47,11 @@ export PXF_PORT=${PXF_PORT:=5888}\n # Memory\n export PXF_JVM_OPTS=${PXF_JVM_OPTS:='-Xmx2g -Xms1g'}\n \n+# The number of milliseconds the server will wait, after accepting a", "originalCommit": "b4e4357e7ab3aba74b65cb89f8f60b7640d95223", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzMjUyNg==", "url": "https://github.com/greenplum-db/pxf/pull/398#discussion_r448632526", "bodyText": "Also, this is too verbose, compared to other properties, maybe just Server connection timeout", "author": "denalex", "createdAt": "2020-07-01T21:45:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzMTg3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzMjc4MA==", "url": "https://github.com/greenplum-db/pxf/pull/398#discussion_r448632780", "bodyText": "same comment", "author": "denalex", "createdAt": "2020-07-01T21:45:35Z", "path": "server/pxf-service/src/templates/user/conf/pxf-env.sh", "diffHunk": "@@ -19,6 +19,11 @@ PXF_CONF=\"$( cd \"$( dirname \"${BASH_SOURCE[0]}\" )/..\" && pwd )\"\n # Memory\n # export PXF_JVM_OPTS=\"-Xmx2g -Xms1g\"\n \n+# The number of milliseconds the server will wait, after accepting a\n+# connection, for the request URI line to be presented. Use a value of -1 to\n+# indicate no (i.e. infinite) timeout.\n+# export PXF_CONNECTION_TIMEOUT=5m", "originalCommit": "b4e4357e7ab3aba74b65cb89f8f60b7640d95223", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f746932de44b791536fdb60e86e10af500896b76", "url": "https://github.com/greenplum-db/pxf/commit/f746932de44b791536fdb60e86e10af500896b76", "message": "Update server/pxf-service/src/scripts/pxf\n\nCo-authored-by: Alexander Denissov <denalex@users.noreply.github.com>", "committedDate": "2020-07-01T21:56:59Z", "type": "commit"}, {"oid": "607bee17bd054d4cc22410f02b631b9a31793de9", "url": "https://github.com/greenplum-db/pxf/commit/607bee17bd054d4cc22410f02b631b9a31793de9", "message": "Address PR feedback", "committedDate": "2020-07-01T21:58:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY0MTY1OQ==", "url": "https://github.com/greenplum-db/pxf/pull/398#discussion_r448641659", "bodyText": "this line is no longer needed", "author": "denalex", "createdAt": "2020-07-01T22:09:04Z", "path": "server/pxf-service/src/scripts/pxf", "diffHunk": "@@ -214,6 +214,13 @@ function generateUserConfigs()\n     setup_conf_directory \"${PXF_CONF}/servers\"\n     setup_conf_directory \"${PXF_CONF}/servers/default\"\n     setup_conf_directory \"${PXF_CONF}/templates\" \"${PXF_HOME}/templates/user/templates\" 'override'\n+\n+    if [[ ! -f \"${PXF_CONF}/conf/pxf-log4j2.xml\" ]]; then\n+        # copy the new pxf-log4j2.xml if it doesn't exist. This allows us to\n+        # initialize PXF 6.x using a pre-existing PXF 5.x configuration\n+        # initialized", "originalCommit": "607bee17bd054d4cc22410f02b631b9a31793de9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6ee91fee0e64c611657b7cf350783256ed9486ca", "url": "https://github.com/greenplum-db/pxf/commit/6ee91fee0e64c611657b7cf350783256ed9486ca", "message": "Address PR feedback. Add SPRING_LIFECYCLE_TIMEOUT_PER_SHUTDOWN_PHASE variable in pxf-env", "committedDate": "2020-07-01T22:14:30Z", "type": "commit"}, {"oid": "f8a88a602e787b62d326b86095a75d6978585034", "url": "https://github.com/greenplum-db/pxf/commit/f8a88a602e787b62d326b86095a75d6978585034", "message": "remove enabling graceful shutdown", "committedDate": "2020-07-01T22:28:52Z", "type": "commit"}]}