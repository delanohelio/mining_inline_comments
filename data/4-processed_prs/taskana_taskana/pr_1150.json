{"pr_number": 1150, "pr_title": "TSK-1275: Support select and claim in one API call", "pr_createdAt": "2020-06-26T12:25:29Z", "pr_url": "https://github.com/Taskana/taskana/pull/1150", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY0NDU4MQ==", "url": "https://github.com/Taskana/taskana/pull/1150#discussion_r446644581", "bodyText": "Please rework the naming and clarify which taskId is meant.\ne.g. @throws TaskNotFoundException if the taskQuery does not return any task", "author": "mustaphazorgati", "createdAt": "2020-06-28T12:27:49Z", "path": "lib/taskana-core/src/main/java/pro/taskana/task/api/TaskService.java", "diffHunk": "@@ -325,6 +325,21 @@ void deleteTask(String taskId)\n   void forceDeleteTask(String taskId)\n       throws TaskNotFoundException, InvalidStateException, NotAuthorizedException;\n \n+  /**\n+   * Selects and claims the first task which is returned by the task query.\n+   *\n+   * @param taskQuery the task query.\n+   * @return the task that got selected and claimed\n+   * @throws TaskNotFoundException if the task with taskId was not found\n+   * @throws InvalidStateException if the state of the task with taskId is not READY\n+   * @throws InvalidOwnerException if the task with taskId is claimed by someone else\n+   * @throws NotAuthorizedException if the current user has no read permission for the\n+   *     workbasket the task is in", "originalCommit": "f1991ad4316cd8de239ba6cd0cc57caa70f1bddb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY0NDY0NA==", "url": "https://github.com/Taskana/taskana/pull/1150#discussion_r446644644", "bodyText": "selectAndClaim does not work on db2? I think this is worth commenting. Something like \"the optimized query for db2 does not work with selectAndClaim because ...\"", "author": "mustaphazorgati", "createdAt": "2020-06-28T12:28:26Z", "path": "lib/taskana-core/src/main/java/pro/taskana/task/internal/TaskQueryImpl.java", "diffHunk": "@@ -1112,7 +1111,11 @@ public long count() {\n   }\n \n   public String getLinkToMapperScript() {\n-    return DB.DB2.dbProductId.equals(getDatabaseId()) ? LINK_TO_MAPPER_DB2 : LINK_TO_MAPPER;\n+    if (DB.DB2.dbProductId.equals(getDatabaseId()) && !selectAndClaim) {\n+      return LINK_TO_MAPPER_DB2;", "originalCommit": "f1991ad4316cd8de239ba6cd0cc57caa70f1bddb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY1MjUyMw==", "url": "https://github.com/Taskana/taskana/pull/1150#discussion_r446652523", "bodyText": "why SystemException? According to JavaDoc I expected a \"TaskNotFoundExeption\"", "author": "mustaphazorgati", "createdAt": "2020-06-28T13:40:30Z", "path": "lib/taskana-core/src/main/java/pro/taskana/task/internal/TaskServiceImpl.java", "diffHunk": "@@ -477,6 +477,37 @@ public void forceDeleteTask(String taskId)\n     deleteTask(taskId, true);\n   }\n \n+  @Override\n+  public Task selectAndClaim(TaskQuery taskQuery)\n+      throws TaskNotFoundException, NotAuthorizedException, InvalidStateException,\n+          InvalidOwnerException {\n+\n+    if (LOGGER.isDebugEnabled()) {\n+      LOGGER.debug(\"entry to selectAndClaim(taskQuery = {})\", taskQuery);\n+    }\n+\n+    try {\n+\n+      taskanaEngine.openConnection();\n+\n+      ((TaskQueryImpl) taskQuery).selectAndClaimEquals(true);\n+\n+      TaskSummary taskSummary = taskQuery.single();\n+\n+      if (taskSummary == null) {\n+        throw new SystemException(\n+            \"No tasks matched the specified filter and sorting options,\"\n+                + \" task query returned nothing!\");\n+      }", "originalCommit": "f1991ad4316cd8de239ba6cd0cc57caa70f1bddb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc4MTQ0MA==", "url": "https://github.com/Taskana/taskana/pull/1150#discussion_r446781440", "bodyText": "The TaskNotFoundException from JavaDoc is inherited from the claim() call. While I would agree that in case of a null return from the query a TaskNotFoundException seems logical, it needs an id, which we usually won't have here, we only got a query (assuming taskIdIn is not always set).", "author": "gitgoodjhe", "createdAt": "2020-06-29T05:33:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY1MjUyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY1MjcxOQ==", "url": "https://github.com/Taskana/taskana/pull/1150#discussion_r446652719", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                assertThat(selectedAndClaimedTasks.stream().map(Task::getId))\n          \n          \n            \n                assertThat(selectedAndClaimedTasks)\n          \n          \n            \n                    .extracting(Task::getId)", "author": "mustaphazorgati", "createdAt": "2020-06-28T13:42:33Z", "path": "lib/taskana-core/src/test/java/acceptance/task/SelectAndClaimTaskAccTest.java", "diffHunk": "@@ -0,0 +1,108 @@\n+package acceptance.task;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+import acceptance.AbstractAccTest;\n+import java.security.PrivilegedAction;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.function.Consumer;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+import javax.security.auth.Subject;\n+import org.assertj.core.api.ThrowableAssert.ThrowingCallable;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+\n+import pro.taskana.common.api.BaseQuery.SortDirection;\n+import pro.taskana.common.api.exceptions.SystemException;\n+import pro.taskana.common.internal.security.JaasExtension;\n+import pro.taskana.common.internal.security.UserPrincipal;\n+import pro.taskana.common.internal.security.WithAccessId;\n+import pro.taskana.common.internal.util.CheckedConsumer;\n+import pro.taskana.task.api.TaskQuery;\n+import pro.taskana.task.api.TaskService;\n+import pro.taskana.task.api.models.Task;\n+\n+@ExtendWith(JaasExtension.class)\n+class SelectAndClaimTaskAccTest extends AbstractAccTest {\n+\n+  @Test\n+  void should_claimDifferentTasks_For_ConcurrentSelectAndClaimCalls() throws Exception {\n+\n+    List<Task> selectedAndClaimedTasks = Collections.synchronizedList(new ArrayList<>());\n+\n+    List<String> accessIds =\n+        Collections.synchronizedList(\n+            Stream.of(\"admin\", \"teamlead-1\", \"teamlead-2\", \"taskadmin\")\n+                .collect(Collectors.toList()));\n+\n+    Runnable test = getRunnableTest(selectedAndClaimedTasks, accessIds);\n+\n+    Thread[] threads = new Thread[4];\n+    for (int i = 0; i < threads.length; i++) {\n+      threads[i] = new Thread(test);\n+      threads[i].start();\n+    }\n+    for (int i = 0; i < threads.length; i++) {\n+      threads[i].join();\n+    }\n+\n+    assertThat(selectedAndClaimedTasks.stream().map(Task::getId))", "originalCommit": "f1991ad4316cd8de239ba6cd0cc57caa70f1bddb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc4NDE5MA==", "url": "https://github.com/Taskana/taskana/pull/1150#discussion_r446784190", "bodyText": "thx :)", "author": "gitgoodjhe", "createdAt": "2020-06-29T05:43:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY1MjcxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY1Mjc3OA==", "url": "https://github.com/Taskana/taskana/pull/1150#discussion_r446652778", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                assertThat(selectedAndClaimedTasks.stream().map(Task::getOwner))\n          \n          \n            \n                assertThat(selectedAndClaimedTasks)\n          \n          \n            \n                    .extracting(Task::getOwner)", "author": "mustaphazorgati", "createdAt": "2020-06-28T13:43:01Z", "path": "lib/taskana-core/src/test/java/acceptance/task/SelectAndClaimTaskAccTest.java", "diffHunk": "@@ -0,0 +1,108 @@\n+package acceptance.task;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+import acceptance.AbstractAccTest;\n+import java.security.PrivilegedAction;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.function.Consumer;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+import javax.security.auth.Subject;\n+import org.assertj.core.api.ThrowableAssert.ThrowingCallable;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+\n+import pro.taskana.common.api.BaseQuery.SortDirection;\n+import pro.taskana.common.api.exceptions.SystemException;\n+import pro.taskana.common.internal.security.JaasExtension;\n+import pro.taskana.common.internal.security.UserPrincipal;\n+import pro.taskana.common.internal.security.WithAccessId;\n+import pro.taskana.common.internal.util.CheckedConsumer;\n+import pro.taskana.task.api.TaskQuery;\n+import pro.taskana.task.api.TaskService;\n+import pro.taskana.task.api.models.Task;\n+\n+@ExtendWith(JaasExtension.class)\n+class SelectAndClaimTaskAccTest extends AbstractAccTest {\n+\n+  @Test\n+  void should_claimDifferentTasks_For_ConcurrentSelectAndClaimCalls() throws Exception {\n+\n+    List<Task> selectedAndClaimedTasks = Collections.synchronizedList(new ArrayList<>());\n+\n+    List<String> accessIds =\n+        Collections.synchronizedList(\n+            Stream.of(\"admin\", \"teamlead-1\", \"teamlead-2\", \"taskadmin\")\n+                .collect(Collectors.toList()));\n+\n+    Runnable test = getRunnableTest(selectedAndClaimedTasks, accessIds);\n+\n+    Thread[] threads = new Thread[4];\n+    for (int i = 0; i < threads.length; i++) {\n+      threads[i] = new Thread(test);\n+      threads[i].start();\n+    }\n+    for (int i = 0; i < threads.length; i++) {\n+      threads[i].join();\n+    }\n+\n+    assertThat(selectedAndClaimedTasks.stream().map(Task::getId))\n+        .containsExactlyInAnyOrder(\n+            \"TKI:000000000000000000000000000000000003\",\n+            \"TKI:000000000000000000000000000000000004\",\n+            \"TKI:000000000000000000000000000000000005\",\n+            \"TKI:000000000000000000000000000000000006\");\n+\n+    assertThat(selectedAndClaimedTasks.stream().map(Task::getOwner))", "originalCommit": "f1991ad4316cd8de239ba6cd0cc57caa70f1bddb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY1Mjg0OA==", "url": "https://github.com/Taskana/taskana/pull/1150#discussion_r446652848", "bodyText": "Do we really want a system exception here?", "author": "mustaphazorgati", "createdAt": "2020-06-28T13:43:27Z", "path": "lib/taskana-core/src/test/java/acceptance/task/SelectAndClaimTaskAccTest.java", "diffHunk": "@@ -0,0 +1,108 @@\n+package acceptance.task;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+import acceptance.AbstractAccTest;\n+import java.security.PrivilegedAction;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.function.Consumer;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+import javax.security.auth.Subject;\n+import org.assertj.core.api.ThrowableAssert.ThrowingCallable;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+\n+import pro.taskana.common.api.BaseQuery.SortDirection;\n+import pro.taskana.common.api.exceptions.SystemException;\n+import pro.taskana.common.internal.security.JaasExtension;\n+import pro.taskana.common.internal.security.UserPrincipal;\n+import pro.taskana.common.internal.security.WithAccessId;\n+import pro.taskana.common.internal.util.CheckedConsumer;\n+import pro.taskana.task.api.TaskQuery;\n+import pro.taskana.task.api.TaskService;\n+import pro.taskana.task.api.models.Task;\n+\n+@ExtendWith(JaasExtension.class)\n+class SelectAndClaimTaskAccTest extends AbstractAccTest {\n+\n+  @Test\n+  void should_claimDifferentTasks_For_ConcurrentSelectAndClaimCalls() throws Exception {\n+\n+    List<Task> selectedAndClaimedTasks = Collections.synchronizedList(new ArrayList<>());\n+\n+    List<String> accessIds =\n+        Collections.synchronizedList(\n+            Stream.of(\"admin\", \"teamlead-1\", \"teamlead-2\", \"taskadmin\")\n+                .collect(Collectors.toList()));\n+\n+    Runnable test = getRunnableTest(selectedAndClaimedTasks, accessIds);\n+\n+    Thread[] threads = new Thread[4];\n+    for (int i = 0; i < threads.length; i++) {\n+      threads[i] = new Thread(test);\n+      threads[i].start();\n+    }\n+    for (int i = 0; i < threads.length; i++) {\n+      threads[i].join();\n+    }\n+\n+    assertThat(selectedAndClaimedTasks.stream().map(Task::getId))\n+        .containsExactlyInAnyOrder(\n+            \"TKI:000000000000000000000000000000000003\",\n+            \"TKI:000000000000000000000000000000000004\",\n+            \"TKI:000000000000000000000000000000000005\",\n+            \"TKI:000000000000000000000000000000000006\");\n+\n+    assertThat(selectedAndClaimedTasks.stream().map(Task::getOwner))\n+        .containsExactlyInAnyOrder(\"admin\", \"taskadmin\", \"teamlead-1\", \"teamlead-2\");\n+  }\n+\n+  @Test\n+  @WithAccessId(user = \"admin\")\n+  void should_ThrowException_When_TryingToSelectAndClaimNonExistingTask() throws Exception {\n+\n+    TaskQuery query = taskanaEngine.getTaskService().createTaskQuery();\n+    query.idIn(\"notexisting\");\n+    ThrowingCallable call =\n+        () -> {\n+          taskanaEngine.getTaskService().selectAndClaim(query);\n+        };\n+    assertThatThrownBy(call)\n+        .isInstanceOf(SystemException.class)\n+        .hasMessageContaining(\n+            \"No tasks matched the specified filter and sorting options, \"\n+                + \"task query returned nothing!\");\n+  }", "originalCommit": "f1991ad4316cd8de239ba6cd0cc57caa70f1bddb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjY1MzA2NQ==", "url": "https://github.com/Taskana/taskana/pull/1150#discussion_r446653065", "bodyText": "personally I think <= 16 is more readable :)", "author": "mustaphazorgati", "createdAt": "2020-06-28T13:45:14Z", "path": "rest/taskana-rest-spring/src/main/java/pro/taskana/task/rest/TaskController.java", "diffHunk": "@@ -414,8 +439,15 @@ private TaskQuery applyFilterParams(TaskQuery taskQuery, MultiValueMap<String, S\n       params.remove(EXTERNAL_ID);\n     }\n \n-    if (LOGGER.isDebugEnabled()) {\n-      LOGGER.debug(\"Exit from applyFilterParams(), returning {}\", taskQuery);\n+    for (int i = 1; i < 17; i++) {", "originalCommit": "f1991ad4316cd8de239ba6cd0cc57caa70f1bddb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7d0edb6ba219885935b7bc1a69b5af8ebc9c5862", "url": "https://github.com/Taskana/taskana/commit/7d0edb6ba219885935b7bc1a69b5af8ebc9c5862", "message": "TSK-1275: Support select and claim in one API call", "committedDate": "2020-06-30T11:19:02Z", "type": "commit"}, {"oid": "808d5e604539f2f4e5e13e86b00c627a78e1b762", "url": "https://github.com/Taskana/taskana/commit/808d5e604539f2f4e5e13e86b00c627a78e1b762", "message": "review Findings", "committedDate": "2020-06-30T12:39:49Z", "type": "commit"}]}