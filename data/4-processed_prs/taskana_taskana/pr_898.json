{"pr_number": 898, "pr_title": "TSK-991: Add more architecture tests", "pr_createdAt": "2020-02-04T14:58:55Z", "pr_url": "https://github.com/Taskana/taskana/pull/898", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDcyOTIwNQ==", "url": "https://github.com/Taskana/taskana/pull/898#discussion_r374729205", "bodyText": "Why \"pro.taskana.common.internal.(*)..\" twice?", "author": "gitgoodjhe", "createdAt": "2020-02-04T15:11:51Z", "path": "lib/taskana-core/src/test/java/pro/taskana/ArchitectureTest.java", "diffHunk": "@@ -84,20 +83,92 @@ void noClassShouldAccessStandardStreams() {\n     NO_CLASSES_SHOULD_ACCESS_STANDARD_STREAMS.check(importedClasses);\n   }\n \n-  @Test\n+  /**\n+   * Solution would be nice, but is not achievable without big changes\n+   * https://www.archunit.org/userguide/html/000_Index.html#_cycle_checks\n+   */\n   @Disabled\n+  @Test\n   void freeOfCycles() {\n-    ArchRule myRule = slices().matching(\"pro.taskana.(*)..\")\n-                          .should().beFreeOfCycles();\n+    ArchRule myRule = slices().matching(\"pro.taskana.(*)..\").should().beFreeOfCycles();\n     myRule.check(importedClasses);\n   }\n \n+  /**\n+   * Test for cycles with subpackages\n+   * https://www.archunit.org/userguide/html/000_Index.html#_cycle_checks\n+   */\n+  @TestFactory\n+  Collection<DynamicTest> freeOfCycles_subpackages() {\n+\n+    Stream<String> packagesToTest =\n+        Stream.of(\n+            \"pro.taskana.common.internal.(*)..\",\n+            \"pro.taskana.common.api.(*)..\",\n+            \"pro.taskana.common.internal.(*)..\",", "originalCommit": "52d7d47b75bb8412e0d277ab75c9460390580b3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE1MTAyNA==", "url": "https://github.com/Taskana/taskana/pull/898#discussion_r375151024", "bodyText": "safe is safe ...\njk. done.", "author": "benjamineckstein", "createdAt": "2020-02-05T09:44:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDcyOTIwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTA5NTkxMg==", "url": "https://github.com/Taskana/taskana/pull/898#discussion_r375095912", "bodyText": "Das Problem scheint zu sein, dass der DaysToWorkingDaysConverter, der aktuell im report package liegt, von TaskServiceImpl benutzt wird. Vielleicht sollten wir diesen in das common package refactoren.\nDann k\u00f6nnten wir diesen Test enablen...", "author": "BerndBreier", "createdAt": "2020-02-05T07:32:59Z", "path": "lib/taskana-core/src/test/java/pro/taskana/ArchitectureTest.java", "diffHunk": "@@ -84,20 +83,92 @@ void noClassShouldAccessStandardStreams() {\n     NO_CLASSES_SHOULD_ACCESS_STANDARD_STREAMS.check(importedClasses);\n   }\n \n-  @Test\n+  /**\n+   * Solution would be nice, but is not achievable without big changes\n+   * https://www.archunit.org/userguide/html/000_Index.html#_cycle_checks\n+   */\n   @Disabled\n+  @Test\n   void freeOfCycles() {\n-    ArchRule myRule = slices().matching(\"pro.taskana.(*)..\")\n-                          .should().beFreeOfCycles();\n+    ArchRule myRule = slices().matching(\"pro.taskana.(*)..\").should().beFreeOfCycles();\n     myRule.check(importedClasses);\n   }\n \n+  /**\n+   * Test for cycles with subpackages\n+   * https://www.archunit.org/userguide/html/000_Index.html#_cycle_checks\n+   */\n+  @TestFactory\n+  Collection<DynamicTest> freeOfCycles_subpackages() {\n+\n+    Stream<String> packagesToTest =\n+        Stream.of(\n+            \"pro.taskana.common.internal.(*)..\",\n+            \"pro.taskana.common.api.(*)..\",\n+            \"pro.taskana.common.internal.(*)..\",\n+            \"pro.taskana.classification.api.(*)..\",\n+            \"pro.taskana.classification.internal.(*)..\",\n+            \"pro.taskana.history.api.(*)..\",\n+            \"pro.taskana.history.internal.(*)..\",\n+            // to be fixed soon\n+            // \"pro.taskana.report.api.(*)..\",\n+            \"pro.taskana.report.internal.(*)..\",\n+            \"pro.taskana.task.api.(*)..\",\n+            \"pro.taskana.task.internal.(*)..\",\n+            \"pro.taskana.workbasket.api.(*)..\",\n+            \"pro.taskana.workbasket.internal.(*)..\");\n+    return packagesToTest\n+        .map(\n+            p ->\n+                dynamicTest(\n+                    p.replaceAll(Pattern.quote(\"pro.taskana.\"), \"\") + \" is free of cycles\",\n+                    () -> slices().matching(p).should().beFreeOfCycles().check(importedClasses)))\n+        .collect(Collectors.toList());\n+  }\n+\n+  @Disabled(\"TBD\")\n   @Test\n+  void commonClassesShouldNotDependOnOtherDomainClasses() {\n+    ArchRule myRule =\n+        noClasses()\n+            .that()\n+            .resideInAPackage(\"..common..\")\n+            .should()\n+            .dependOnClassesThat()\n+            .resideInAnyPackage(\n+                \"..classification..\", \"..history..\", \"..report..\", \"..task..\", \"..workbasket..\");\n+    myRule.check(importedClasses);\n+  }\n+\n   @Disabled\n-  void freeOfCyclicDependencies() {\n-    ArchRule myRule = slices().matching(\"pro.taskana.(*)..\").should()\n-                          .notDependOnEachOther();\n+  @Test\n+  void noClassesShouldDependOnReports() {", "originalCommit": "52d7d47b75bb8412e0d277ab75c9460390580b3e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTA5OTAwNA==", "url": "https://github.com/Taskana/taskana/pull/898#discussion_r375099004", "bodyText": "We could take the result of this test to improve the structure of the product, i.e.\n\nmove xxxCleanupJob classes into the domain packages\nexclude TaskanaEngine/TaskanaEngineImpl from the check\nand then enable the test again", "author": "BerndBreier", "createdAt": "2020-02-05T07:42:38Z", "path": "lib/taskana-core/src/test/java/pro/taskana/ArchitectureTest.java", "diffHunk": "@@ -84,20 +83,92 @@ void noClassShouldAccessStandardStreams() {\n     NO_CLASSES_SHOULD_ACCESS_STANDARD_STREAMS.check(importedClasses);\n   }\n \n-  @Test\n+  /**\n+   * Solution would be nice, but is not achievable without big changes\n+   * https://www.archunit.org/userguide/html/000_Index.html#_cycle_checks\n+   */\n   @Disabled\n+  @Test\n   void freeOfCycles() {\n-    ArchRule myRule = slices().matching(\"pro.taskana.(*)..\")\n-                          .should().beFreeOfCycles();\n+    ArchRule myRule = slices().matching(\"pro.taskana.(*)..\").should().beFreeOfCycles();\n     myRule.check(importedClasses);\n   }\n \n+  /**\n+   * Test for cycles with subpackages\n+   * https://www.archunit.org/userguide/html/000_Index.html#_cycle_checks\n+   */\n+  @TestFactory\n+  Collection<DynamicTest> freeOfCycles_subpackages() {\n+\n+    Stream<String> packagesToTest =\n+        Stream.of(\n+            \"pro.taskana.common.internal.(*)..\",\n+            \"pro.taskana.common.api.(*)..\",\n+            \"pro.taskana.common.internal.(*)..\",\n+            \"pro.taskana.classification.api.(*)..\",\n+            \"pro.taskana.classification.internal.(*)..\",\n+            \"pro.taskana.history.api.(*)..\",\n+            \"pro.taskana.history.internal.(*)..\",\n+            // to be fixed soon\n+            // \"pro.taskana.report.api.(*)..\",\n+            \"pro.taskana.report.internal.(*)..\",\n+            \"pro.taskana.task.api.(*)..\",\n+            \"pro.taskana.task.internal.(*)..\",\n+            \"pro.taskana.workbasket.api.(*)..\",\n+            \"pro.taskana.workbasket.internal.(*)..\");\n+    return packagesToTest\n+        .map(\n+            p ->\n+                dynamicTest(\n+                    p.replaceAll(Pattern.quote(\"pro.taskana.\"), \"\") + \" is free of cycles\",\n+                    () -> slices().matching(p).should().beFreeOfCycles().check(importedClasses)))\n+        .collect(Collectors.toList());\n+  }\n+\n+  @Disabled(\"TBD\")\n   @Test\n+  void commonClassesShouldNotDependOnOtherDomainClasses() {", "originalCommit": "52d7d47b75bb8412e0d277ab75c9460390580b3e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEwMTU1Mw==", "url": "https://github.com/Taskana/taskana/pull/898#discussion_r375101553", "bodyText": "we could refactor BulkOperationResults into Interface + implementation in order to comply with this test.\nProbably it would also be possible to restructure TaskanaHistoryEvent.\nIn addition, the test is disabled because there are violations in the report.api package. May be, we could refactor these classes to remove the violations", "author": "BerndBreier", "createdAt": "2020-02-05T07:50:30Z", "path": "lib/taskana-core/src/test/java/pro/taskana/ArchitectureTest.java", "diffHunk": "@@ -47,7 +47,7 @@ void apiClassesShouldNotDependOnInternalClasses() {\n             .and()\n             .haveSimpleNameNotEndingWith(\"BulkOperationResults\")", "originalCommit": "52d7d47b75bb8412e0d277ab75c9460390580b3e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6661ce6a3cd5fc0023e9fe866d9b6844f6b4ab96", "url": "https://github.com/Taskana/taskana/commit/6661ce6a3cd5fc0023e9fe866d9b6844f6b4ab96", "message": "TSK-991: Add more architecture tests\n\n(cherry picked from commit 760adb24b54d588e8a977853d092d5744781f496)", "committedDate": "2020-02-05T09:43:24Z", "type": "commit"}]}