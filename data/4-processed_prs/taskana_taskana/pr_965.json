{"pr_number": 965, "pr_title": "Tsk1152: using embedded ldap for integration tests", "pr_createdAt": "2020-03-05T09:19:44Z", "pr_url": "https://github.com/Taskana/taskana/pull/965", "timeline": [{"oid": "3c5076fc80e379ae9cfbed47eb513c5c76e932de", "url": "https://github.com/Taskana/taskana/commit/3c5076fc80e379ae9cfbed47eb513c5c76e932de", "message": "TSK-1052: added inmemory ldap server for int testing.", "committedDate": "2020-03-04T15:45:01Z", "type": "commit"}, {"oid": "84198cf44b4c5f786b340822c6cf72c916df9672", "url": "https://github.com/Taskana/taskana/commit/84198cf44b4c5f786b340822c6cf72c916df9672", "message": "TSK-1152: using embedded ldap for integration tests.", "committedDate": "2020-03-05T09:00:47Z", "type": "commit"}, {"oid": "81f9b8bec8d84caaff5a4c53e2ba628ff66ff669", "url": "https://github.com/Taskana/taskana/commit/81f9b8bec8d84caaff5a4c53e2ba628ff66ff669", "message": "TSK-1152: removed stacktrace from log for InvalidArgumentException.", "committedDate": "2020-03-05T09:18:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE2ODk4NQ==", "url": "https://github.com/Taskana/taskana/pull/965#discussion_r388168985", "bodyText": "Can you please create a ticket that we still have to find a solution for our formatter in xml?", "author": "mustaphazorgati", "createdAt": "2020-03-05T09:25:24Z", "path": "rest/taskana-rest-spring/pom.xml", "diffHunk": "@@ -1,196 +1,201 @@\n <project xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\r", "originalCommit": "81f9b8bec8d84caaff5a4c53e2ba628ff66ff669", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE2OTEzNQ==", "url": "https://github.com/Taskana/taskana/pull/965#discussion_r388169135", "bodyText": "This is the second time we get reminded :)", "author": "mustaphazorgati", "createdAt": "2020-03-05T09:25:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE2ODk4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE2OTM5OQ==", "url": "https://github.com/Taskana/taskana/pull/965#discussion_r388169399", "bodyText": "Very nice \ud83d\udc4d", "author": "mustaphazorgati", "createdAt": "2020-03-05T09:26:05Z", "path": "rest/taskana-rest-spring/src/main/java/pro/taskana/ldap/LdapClient.java", "diffHunk": "@@ -70,16 +68,15 @@\n     isInitOrFail();\n     testMinSearchForLength(name);\n \n-    List<AccessIdResource> accessIds = new ArrayList<>(searchUsersByName(name));\n-    accessIds.addAll(searchGroupsByName(name));\n-    // TODO: remove try/catch as once the fix is verified\n-    try {\n+    List<AccessIdResource> accessIds = new ArrayList<>();\n+    if (nameIsDn(name)) {\n       AccessIdResource groupByDn = searchGroupByDn(name);\n       if (groupByDn != null) {\n-        accessIds.add(searchGroupByDn(name));\n+        accessIds.add(groupByDn);", "originalCommit": "81f9b8bec8d84caaff5a4c53e2ba628ff66ff669", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE2OTc5Nw==", "url": "https://github.com/Taskana/taskana/pull/965#discussion_r388169797", "bodyText": "Should we test this?", "author": "mustaphazorgati", "createdAt": "2020-03-05T09:26:47Z", "path": "rest/taskana-rest-spring/src/main/java/pro/taskana/ldap/LdapClient.java", "diffHunk": "@@ -93,6 +90,10 @@\n     return result;\n   }\n \n+  private boolean nameIsDn(String name) {\n+    return name.toLowerCase().endsWith(getBaseDn().toLowerCase());", "originalCommit": "81f9b8bec8d84caaff5a4c53e2ba628ff66ff669", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE3MDIwNg==", "url": "https://github.com/Taskana/taskana/pull/965#discussion_r388170206", "bodyText": "This is now defiantly unit testable. Please create one or two test scenarios", "author": "mustaphazorgati", "createdAt": "2020-03-05T09:27:31Z", "path": "rest/taskana-rest-spring/src/main/java/pro/taskana/ldap/LdapClient.java", "diffHunk": "@@ -353,14 +354,19 @@ void testMinSearchForLength(final String name) throws InvalidArgumentException {\n     @Override\n     public AccessIdResource doMapFromContext(final DirContextOperations context) {\n       final AccessIdResource accessId = new AccessIdResource();\n-      LdapName dn = (LdapName) context.getDn();\n-      if (!dn.getRdn(0).toString().equalsIgnoreCase(getBaseDn())) {\n-        dn = LdapNameBuilder.newInstance(getBaseDn()).add(dn).build();\n-      }\n-      accessId.setAccessId(dn.toString()); // fully qualified dn\n+      String dn = getDnWithBaseDn(context);\n+      accessId.setAccessId(dn); // fully qualified dn\n       accessId.setName(context.getStringAttribute(getGroupNameAttribute()));\n       return accessId;\n     }\n+\n+    private String getDnWithBaseDn(final DirContextOperations context) {\n+      String dn = context.getDn().toString();", "originalCommit": "81f9b8bec8d84caaff5a4c53e2ba628ff66ff669", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE3MjQ2MA==", "url": "https://github.com/Taskana/taskana/pull/965#discussion_r388172460", "bodyText": "Something we missed during our spring-boot-update. This property is now deprecated and replaced with server.forward-headers-strategy. Should we create a new ticket to replace this property in all property files + check for further deprecation warnings?", "author": "mustaphazorgati", "createdAt": "2020-03-05T09:31:27Z", "path": "rest/taskana-rest-spring/src/test/resources/application-ldap.properties", "diffHunk": "@@ -0,0 +1,51 @@\n+logging.level.pro.taskana=INFO\n+### logging.level.org.springframework=DEBUG\n+######## Taskana DB #######\n+datasource.url=jdbc:h2:mem:taskana;IGNORECASE=TRUE;LOCK_MODE=0\n+datasource.driverClassName=org.h2.Driver\n+datasource.username=sa\n+datasource.password=sa\n+taskana.schemaName=TASKANA\n+####### property that control rest api security deploy use true for no security.\n+devMode=false\n+\n+####### Property that informs about the Taskana's version. This version is shown the application web\n+version=@project.version@\n+\n+####### control LDAP usage\n+taskana.ldap.useLdap=true\n+####### properties to connect to LDAP\n+taskana.ldap.serverUrl=ldap://localhost:10389\n+taskana.ldap.bindDn=uid=admin\n+taskana.ldap.bindPassword=secret\n+taskana.ldap.baseDn=ou=Test,O=TASKANA\n+####### properties that control search for users and groups\n+taskana.ldap.userSearchBase=cn=users\n+taskana.ldap.userSearchFilterName=objectclass\n+taskana.ldap.userSearchFilterValue=person\n+taskana.ldap.userFirstnameAttribute=givenName\n+taskana.ldap.userLastnameAttribute=sn\n+taskana.ldap.userIdAttribute=uid\n+taskana.ldap.groupSearchBase=cn=groups\n+taskana.ldap.groupSearchFilterName=objectclass\n+taskana.ldap.groupSearchFilterValue=groupOfUniqueNames\n+taskana.ldap.groupNameAttribute=cn\n+taskana.ldap.minSearchForLength=3\n+taskana.ldap.maxNumberOfReturnedAccessIds=50\n+taskana.ldap.groupsOfUser=memberUid\n+####### JobScheduler cron expression that specifies when the JobSchedler runs\n+taskana.jobscheduler.async.cron=0 0 * * * *\n+####### cache static resources properties\n+spring.resources.cache.cachecontrol.cache-private=true\n+spring.main.allow-bean-definition-overriding=true\n+####### tomcat is not detecting the x-forward headers from bluemix as a trustworthy proxy\n+server.tomcat.internal-proxies=.*\n+server.use-forward-headers=true", "originalCommit": "81f9b8bec8d84caaff5a4c53e2ba628ff66ff669", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE3MzE0Mw==", "url": "https://github.com/Taskana/taskana/pull/965#discussion_r388173143", "bodyText": "can we use the accessId instead? Personally I think people tend to change names more often than ids", "author": "mustaphazorgati", "createdAt": "2020-03-05T09:32:39Z", "path": "rest/taskana-rest-spring/src/test/java/pro/taskana/rest/AccessIdControllerIntTest.java", "diffHunk": "@@ -33,48 +35,52 @@ static void init() {\n \n   @Test\n   void testQueryGroupsByDn() {\n-    ResponseEntity<List<AccessIdResource>> response =\n+    ResponseEntity<AccessIdListResource> response =\n         template.exchange(\n             restHelper.toUrl(Mapping.URL_ACCESSID)\n-                + \"?search-for=cn=developersgroup,ou=groups,o=taskanatest\",\n+                + \"?search-for=cn=ksc-users,cn=groups,OU=Test,O=TASKANA\",\n             HttpMethod.GET,\n             restHelper.defaultRequest(),\n-            ParameterizedTypeReference.forType(List.class));\n+            ParameterizedTypeReference.forType(AccessIdListResource.class));\n     assertThat(response.getBody()).hasSize(1);\n+    assertThat(response.getBody().get(0).getAccessId())\n+        .isEqualToIgnoringCase(\"cn=ksc-users,cn=groups,OU=Test,O=TASKANA\");\n   }\n \n   @Test\n   void testQueryGroupsByCn() {\n-    ResponseEntity<List<AccessIdResource>> response =\n+    ResponseEntity<AccessIdListResource> response =\n         template.exchange(\n-            restHelper.toUrl(Mapping.URL_ACCESSID) + \"?search-for=developer\",\n+            restHelper.toUrl(Mapping.URL_ACCESSID) + \"?search-for=ksc\",\n             HttpMethod.GET,\n             restHelper.defaultRequest(),\n-            ParameterizedTypeReference.forType(List.class));\n+            ParameterizedTypeReference.forType(AccessIdListResource.class));\n     assertThat(response.getBody()).hasSize(1);\n+    assertThat(response.getBody().get(0).getAccessId())\n+        .isEqualToIgnoringCase(\"cn=ksc-users,cn=groups,OU=Test,O=TASKANA\");\n   }\n \n   @Test\n   void testGetMatches() {\n     ResponseEntity<List<AccessIdResource>> response =\n         template.exchange(\n-            restHelper.toUrl(Mapping.URL_ACCESSID) + \"?search-for=ali\",\n+            restHelper.toUrl(Mapping.URL_ACCESSID) + \"?search-for=rig\",\n             HttpMethod.GET,\n             restHelper.defaultRequest(),\n             ParameterizedTypeReference.forType(AccessIdListResource.class));\n \n     List<AccessIdResource> body = response.getBody();\n     assertThat(body).isNotNull();\n-    assertThat(body).hasSize(3);\n+    assertThat(body).hasSize(2);\n     assertThat(body)\n         .extracting(AccessIdResource::getName)\n-        .containsExactlyInAnyOrder(\"Tralisch, Thea\", \"Bert, Ali\", \"Mente, Ali\");\n+        .containsExactlyInAnyOrder(\"Schl\u00e4frig, Tim\", \"Eifrig, Elena\");", "originalCommit": "81f9b8bec8d84caaff5a4c53e2ba628ff66ff669", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6be95b1acce908e474b0a2151e3b5c96db178b98", "url": "https://github.com/Taskana/taskana/commit/6be95b1acce908e474b0a2151e3b5c96db178b98", "message": "TSK-1152: checkstyle fix.", "committedDate": "2020-03-05T09:43:42Z", "type": "commit"}, {"oid": "595470416bcaeb3836b6ad640271944372318dd2", "url": "https://github.com/Taskana/taskana/commit/595470416bcaeb3836b6ad640271944372318dd2", "message": "TSK-1152: added test coverage for util methods.", "committedDate": "2020-03-05T10:57:01Z", "type": "commit"}]}