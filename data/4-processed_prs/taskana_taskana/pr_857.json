{"pr_number": 857, "pr_title": "TSK-1021 persist timestamps in UTC representation", "pr_createdAt": "2020-01-22T12:35:40Z", "pr_url": "https://github.com/Taskana/taskana/pull/857", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUzNjkxNg==", "url": "https://github.com/Taskana/taskana/pull/857#discussion_r369536916", "bodyText": "Just out of curiosity:\nShould we instantiate the Handlers, so that mybatis doesnt do it via reflections?", "author": "mustaphazorgati", "createdAt": "2020-01-22T12:41:57Z", "path": "lib/taskana-core/src/main/java/pro/taskana/impl/TaskanaEngineImpl.java", "diffHunk": "@@ -232,6 +234,9 @@ protected SqlSessionManager createSqlSessionManager() {\n           e.getCause());\n     }\n \n+    // register type handlers\n+    configuration.getTypeHandlerRegistry().register(MapTypeHandler.class);\n+    configuration.getTypeHandlerRegistry().register(Instant.class, InstantTypeHandler.class);", "originalCommit": "9df1fbeb1db00bc4d05455e382a8cec554f9ac96", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUzNjk4NA==", "url": "https://github.com/Taskana/taskana/pull/857#discussion_r369536984", "bodyText": "Does that even matter?", "author": "mustaphazorgati", "createdAt": "2020-01-22T12:42:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUzNjkxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU0NDU5Nw==", "url": "https://github.com/Taskana/taskana/pull/857#discussion_r369544597", "bodyText": "I even don't know an interface that we could use to pass instantiated handlers to mybatis...", "author": "BerndBreier", "createdAt": "2020-01-22T13:00:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUzNjkxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU0NzA3Mw==", "url": "https://github.com/Taskana/taskana/pull/857#discussion_r369547073", "bodyText": "https://mybatis.org/mybatis-3/apidocs/reference/org/apache/ibatis/type/TypeHandlerRegistry.html\nwould be\nregister(TypeHandler typeHandler) for the MapTypeHandler\nand\nregister(Class javaType, TypeHandler<? extends T> typeHandler) for the InstantTypeHandler", "author": "mustaphazorgati", "createdAt": "2020-01-22T13:05:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUzNjkxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU0NzYzMg==", "url": "https://github.com/Taskana/taskana/pull/857#discussion_r369547632", "bodyText": "looking at the sourcecode of mybatis the register(Class ..) methods do some reflection magic and then call the regular register(TypeHandler<?> ..) methods. Do we want that reflection magic to happen?", "author": "mustaphazorgati", "createdAt": "2020-01-22T13:06:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUzNjkxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU0ODE0Mg==", "url": "https://github.com/Taskana/taskana/pull/857#discussion_r369548142", "bodyText": "I'll see whether this works also and if so, register the instantiated typehandlers ...", "author": "BerndBreier", "createdAt": "2020-01-22T13:08:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUzNjkxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU2NTc1NQ==", "url": "https://github.com/Taskana/taskana/pull/857#discussion_r369565755", "bodyText": "Works fine. I switched to the registration with instantiated handlers ...", "author": "BerndBreier", "createdAt": "2020-01-22T13:44:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUzNjkxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUzODg4OQ==", "url": "https://github.com/Taskana/taskana/pull/857#discussion_r369538889", "bodyText": "Since the timestamp behaviour should be done globally, do we need specific (complicated) test cases like this?\nCan't we just do it with one entity?", "author": "mustaphazorgati", "createdAt": "2020-01-22T12:46:37Z", "path": "lib/taskana-core/src/test/java/acceptance/persistence/UpdateObjectsUseUtcTimeStampsAccTest.java", "diffHunk": "@@ -0,0 +1,243 @@\n+package acceptance.persistence;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.core.IsEqual.equalTo;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+import acceptance.AbstractAccTest;\n+import java.sql.SQLException;\n+import java.time.Duration;\n+import java.time.Instant;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.TimeZone;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+\n+import pro.taskana.Classification;\n+import pro.taskana.ClassificationService;\n+import pro.taskana.JobService;\n+import pro.taskana.Task;\n+import pro.taskana.TaskService;\n+import pro.taskana.Workbasket;\n+import pro.taskana.WorkbasketAccessItem;\n+import pro.taskana.WorkbasketService;\n+import pro.taskana.WorkbasketType;\n+import pro.taskana.exceptions.AttachmentPersistenceException;\n+import pro.taskana.exceptions.ClassificationAlreadyExistException;\n+import pro.taskana.exceptions.ClassificationNotFoundException;\n+import pro.taskana.exceptions.ConcurrencyException;\n+import pro.taskana.exceptions.DomainNotFoundException;\n+import pro.taskana.exceptions.InvalidArgumentException;\n+import pro.taskana.exceptions.InvalidWorkbasketException;\n+import pro.taskana.exceptions.NotAuthorizedException;\n+import pro.taskana.exceptions.TaskAlreadyExistException;\n+import pro.taskana.exceptions.TaskNotFoundException;\n+import pro.taskana.exceptions.WorkbasketAlreadyExistException;\n+import pro.taskana.exceptions.WorkbasketNotFoundException;\n+import pro.taskana.impl.JobServiceImpl;\n+import pro.taskana.impl.TaskImpl;\n+import pro.taskana.jobs.ScheduledJob;\n+import pro.taskana.security.JaasExtension;\n+import pro.taskana.security.WithAccessId;\n+\n+/** Acceptance test for access to timestamps from different timezones. */\n+@ExtendWith(JaasExtension.class)\n+public class UpdateObjectsUseUtcTimeStampsAccTest extends AbstractAccTest {", "originalCommit": "9df1fbeb1db00bc4d05455e382a8cec554f9ac96", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU0NDEzNw==", "url": "https://github.com/Taskana/taskana/pull/857#discussion_r369544137", "bodyText": "This testcase was created when we had to annotate each individual timestamp field.\nHowever, I think I doesn't hurt to test the timestamps on all persistent objects...", "author": "BerndBreier", "createdAt": "2020-01-22T12:58:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUzODg4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU0NjI5Mw==", "url": "https://github.com/Taskana/taskana/pull/857#discussion_r369546293", "bodyText": "ok", "author": "mustaphazorgati", "createdAt": "2020-01-22T13:03:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUzODg4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUzOTQ4Nw==", "url": "https://github.com/Taskana/taskana/pull/857#discussion_r369539487", "bodyText": "ZonedDateTime.now()", "author": "mustaphazorgati", "createdAt": "2020-01-22T12:48:03Z", "path": "lib/taskana-data/src/main/java/pro/taskana/sampledata/SampleDataGenerator.java", "diffHunk": "@@ -33,18 +35,18 @@\n   private static final String CACHED_DROPDB = \"DROPDB\";\n   private static HashMap<String, List<String>> cachedScripts = new HashMap<>();\n   private final DataSource dataSource;\n-  private final LocalDateTime now;\n+  private final ZonedDateTime now;\n   /**\n    * This value cannot be automatically obtained by connection.getSchema(), because setting not yet\n    * existing schema will result into an SQL Exception.\n    */\n   private final String schema;\n \n   public SampleDataGenerator(DataSource dataSource, String schema) {\n-    this(dataSource, schema, LocalDateTime.now());\n+    this(dataSource, schema, Instant.now().atZone(ZoneId.of(\"UTC\")));", "originalCommit": "9df1fbeb1db00bc4d05455e382a8cec554f9ac96", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU0Mzc5MA==", "url": "https://github.com/Taskana/taskana/pull/857#discussion_r369543790", "bodyText": "ZonedDateTime.now() gives me the actual time in the current time zone, not in the UTC time zone. If I invoke ZonedDateTime.now() and print it, I see 2020-01-22 13:53:05, which is the current moment in the local time zone.\nIf I print at the same time the output of Instant.now().atZone(ZoneId.of(\"UTC\")), I see 2020-01-22 12:53:05 which is the current moment in UTC time zone.", "author": "BerndBreier", "createdAt": "2020-01-22T12:58:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUzOTQ4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU0ODIzMQ==", "url": "https://github.com/Taskana/taskana/pull/857#discussion_r369548231", "bodyText": "okay. Why did you use ZonedDateTime.now() in the SqlReplacerTests then? :)", "author": "mustaphazorgati", "createdAt": "2020-01-22T13:08:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUzOTQ4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU0ODc0Mg==", "url": "https://github.com/Taskana/taskana/pull/857#discussion_r369548742", "bodyText": "I was a little confused, because the change from LocalDateTime -> ZonedDateTime was not consistent. That's why I am asking \ud83d\udc4d", "author": "mustaphazorgati", "createdAt": "2020-01-22T13:09:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUzOTQ4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU1NzMyNg==", "url": "https://github.com/Taskana/taskana/pull/857#discussion_r369557326", "bodyText": "In the SqlReplacerTests, it doesn't matter if you are using local time or utc time. These times are not persisted, only the correct matching and correct relative calculations are checked. However, I can change this in the SqlReplacer, too.", "author": "BerndBreier", "createdAt": "2020-01-22T13:27:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUzOTQ4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU1NzYzNQ==", "url": "https://github.com/Taskana/taskana/pull/857#discussion_r369557635", "bodyText": "wanted to say \" ... change this in the SqlReplacerTests, too\"", "author": "BerndBreier", "createdAt": "2020-01-22T13:28:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUzOTQ4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU2MTk0MA==", "url": "https://github.com/Taskana/taskana/pull/857#discussion_r369561940", "bodyText": "If it doesn't matter then I dont care.", "author": "mustaphazorgati", "createdAt": "2020-01-22T13:37:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUzOTQ4Nw=="}], "type": "inlineReview"}, {"oid": "89ed11d0c5e3326091349dc8c7ba8ce0b45c0404", "url": "https://github.com/Taskana/taskana/commit/89ed11d0c5e3326091349dc8c7ba8ce0b45c0404", "message": "TSK-1021 persist timestamps in UTC representation", "committedDate": "2020-01-22T13:42:21Z", "type": "commit"}, {"oid": "568480f22db9bce93e05d3f7f49bd07611bcfa0e", "url": "https://github.com/Taskana/taskana/commit/568480f22db9bce93e05d3f7f49bd07611bcfa0e", "message": "TSK-1021 InstantTypeHandler Comments from Mustapha", "committedDate": "2020-01-22T13:42:21Z", "type": "commit"}, {"oid": "568480f22db9bce93e05d3f7f49bd07611bcfa0e", "url": "https://github.com/Taskana/taskana/commit/568480f22db9bce93e05d3f7f49bd07611bcfa0e", "message": "TSK-1021 InstantTypeHandler Comments from Mustapha", "committedDate": "2020-01-22T13:42:21Z", "type": "forcePushed"}]}