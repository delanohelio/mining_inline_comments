{"pr_number": 852, "pr_title": "Tsk1029 Deletion of workbasket as business admin not possible without explicit permissions", "pr_createdAt": "2020-01-20T18:23:51Z", "pr_url": "https://github.com/Taskana/taskana/pull/852", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODcyMjQ4MQ==", "url": "https://github.com/Taskana/taskana/pull/852#discussion_r368722481", "bodyText": "This only works if you do have a user called \"admin\" configured as admin in taskana.properties, doesn't it? I guess we have to think about this a bit more.", "author": "holgerhagen", "createdAt": "2020-01-20T20:53:51Z", "path": "lib/taskana-core/src/main/java/pro/taskana/security/CurrentUserContext.java", "diffHunk": "@@ -77,6 +79,31 @@ public static String getUserid() {\n     return accessIds;\n   }\n \n+  /**\n+   * This method is supposed to skip further permission checks if we are already in a secured\n+   * environment. With great power comes great responsibility.\n+   *\n+   * @param supplier will be executed with admin privileges\n+   * @param <T> defined with the supplier return value\n+   * @return output from supplier\n+   */\n+  public static <T> T runAsAdmin(Supplier<T> supplier) {\n+\n+    Subject subject = Subject.getSubject(AccessController.getContext());\n+    if (subject == null) {\n+      // dont add authorisation if none is available.\n+      return supplier.get();\n+    }\n+    Set<Principal> principals = subject.getPrincipals();\n+    Set<Object> privateCredentials = subject.getPrivateCredentials();\n+    Set<Object> publicCredentials = subject.getPublicCredentials();\n+\n+    principals.add(new GroupPrincipal(\"admin\"));", "originalCommit": "801873b004bae2a0060738447c76bbadf257cfc9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODcyMjk0OQ==", "url": "https://github.com/Taskana/taskana/pull/852#discussion_r368722949", "bodyText": "Don't we change the current Subject as well, if we do it this way? From my perspective it might be better to create a dedicated Subject from scratch instead of patching the current subject.", "author": "holgerhagen", "createdAt": "2020-01-20T20:55:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODcyMjQ4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODg5Mzg3Mg==", "url": "https://github.com/Taskana/taskana/pull/852#discussion_r368893872", "bodyText": "we could reuse method JobScheduler.getAdminSubject() that creates an admin subject.\nMay be, the method should be factored out, e.g. moved to InternalTaskanaEngine ...", "author": "BerndBreier", "createdAt": "2020-01-21T09:35:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODcyMjQ4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA4OTYwOQ==", "url": "https://github.com/Taskana/taskana/pull/852#discussion_r369089609", "bodyText": "I fixed that issue and added a test to verify that this works as intended", "author": "benjamineckstein", "createdAt": "2020-01-21T16:01:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODcyMjQ4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODcyMzUyMg==", "url": "https://github.com/Taskana/taskana/pull/852#discussion_r368723522", "bodyText": "testDeleteWorkbasketAsBusinessAdminWithoutExplicitReadPermission?", "author": "holgerhagen", "createdAt": "2020-01-20T20:58:03Z", "path": "rest/taskana-rest-spring/src/test/java/pro/taskana/rest/WorkbasketControllerIntTest.java", "diffHunk": "@@ -107,6 +108,25 @@ void testGetSecondPageSortedByKey() {\n     assertNotNull(response.getBody().getLink(Link.REL_PREVIOUS));\n   }\n \n+  /**\n+   * Bug Ticket TSK-1029.\n+   * Businessadmin is allowed to delete any workbasket ticket without user related access\n+   * restrictions.\n+   */\n+  @Test\n+  void testDeleteWorkbasketPermissionWithBusinessAdmin() {", "originalCommit": "801873b004bae2a0060738447c76bbadf257cfc9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA4OTAzMQ==", "url": "https://github.com/Taskana/taskana/pull/852#discussion_r369089031", "bodyText": "Done", "author": "benjamineckstein", "createdAt": "2020-01-21T16:00:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODcyMzUyMg=="}], "type": "inlineReview"}, {"oid": "1c0cf04e1d94defac2e7f5e6c7cf04fe0cb5d3f4", "url": "https://github.com/Taskana/taskana/commit/1c0cf04e1d94defac2e7f5e6c7cf04fe0cb5d3f4", "message": "TSK-1029: Add test to trigger permission bug", "committedDate": "2020-01-23T09:30:26Z", "type": "commit"}, {"oid": "bd043b92ee3c80eb0eb117e712eccf233f68e17d", "url": "https://github.com/Taskana/taskana/commit/bd043b92ee3c80eb0eb117e712eccf233f68e17d", "message": "TSK-1029: Fix deletion of workbasket as business admin not possible", "committedDate": "2020-01-23T09:30:26Z", "type": "commit"}, {"oid": "4f3a166f2700f2d706b0fba9528ab6661e621840", "url": "https://github.com/Taskana/taskana/commit/4f3a166f2700f2d706b0fba9528ab6661e621840", "message": "TSK-1029: Fix side effect of tests", "committedDate": "2020-01-23T09:30:27Z", "type": "commit"}, {"oid": "ef980bdbae6c8c29a58a2a9c6eaa3cae63e18c72", "url": "https://github.com/Taskana/taskana/commit/ef980bdbae6c8c29a58a2a9c6eaa3cae63e18c72", "message": "TSK-1029: Test and fix privilege for runasadmin is only temporary", "committedDate": "2020-01-23T09:30:27Z", "type": "commit"}, {"oid": "358caaf88087165873e9cd3cabd837adddc78b82", "url": "https://github.com/Taskana/taskana/commit/358caaf88087165873e9cd3cabd837adddc78b82", "message": "TSK-1029: Refactor runAsAdmin method and usage", "committedDate": "2020-01-23T10:01:58Z", "type": "commit"}]}