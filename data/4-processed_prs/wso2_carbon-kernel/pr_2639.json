{"pr_number": 2639, "pr_title": "Add support for secondary userstore password decryption-symmetric encryption", "pr_createdAt": "2020-03-20T16:39:22Z", "pr_url": "https://github.com/wso2/carbon-kernel/pull/2639", "timeline": [{"oid": "2d39c34a57e795da98eb0e7f3b52a5f19d3fb973", "url": "https://github.com/wso2/carbon-kernel/commit/2d39c34a57e795da98eb0e7f3b52a5f19d3fb973", "message": "Add support for symmetric decryption for secondary userstore password", "committedDate": "2020-03-20T16:34:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjE5MzIxOQ==", "url": "https://github.com/wso2/carbon-kernel/pull/2639#discussion_r396193219", "bodyText": "what will happen if cipherTransformation is null. Algorithm will be null and default on will be resolved from crypto service ?", "author": "malithie", "createdAt": "2020-03-23T03:08:02Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/config/UserStoreConfigXMLProcessor.java", "diffHunk": "@@ -430,56 +434,53 @@ private static PrivateKey getPrivateKey() {\n      * @throws BadPaddingException\n      * @throws IllegalBlockSizeException\n      */\n-    private String decryptProperty(String propValue)\n-            throws NoSuchPaddingException, NoSuchAlgorithmException, NoSuchProviderException,\n-            org.wso2.carbon.user.api.UserStoreException, InvalidKeyException, BadPaddingException,\n-            IllegalBlockSizeException {\n+    private String decryptProperty(String propValue) throws CryptoException {\n \n-        Cipher keyStoreCipher;\n         String cipherTransformation = System.getProperty(CIPHER_TRANSFORMATION_SYSTEM_PROPERTY);\n         byte[] cipherTextBytes = Base64.decode(propValue.trim());\n+        String algorithm = null;\n+        byte[] decryptedValue;\n \n-        privateKey = (privateKey == null) ? getPrivateKey() : privateKey;\n-        if (privateKey == null) {\n-            throw new org.wso2.carbon.user.api.UserStoreException(\n-                    \"Private key initialization failed. Cannot decrypt the userstore password.\");\n-        }\n+        CryptoService cryptoService = UserStoreMgtDataHolder.getInstance().getCryptoService();\n \n-        if(cipherTransformation != null) {\n+        if (cipherTransformation != null) {\n             // extract the original cipher if custom transformation is used configured in carbon.properties.\n-            CipherHolder cipherHolder = cipherTextToCipherHolder(cipherTextBytes);\n+            CipherMetaDataHolder cipherHolder = cipherTextToCipherHolder(cipherTextBytes);\n             if (cipherHolder != null) {\n                 // cipher with meta data.\n                 if (log.isDebugEnabled()) {\n                     log.debug(\"Cipher transformation for decryption : \" + cipherHolder.getTransformation());\n                 }\n-                keyStoreCipher = Cipher.getInstance(cipherHolder.getTransformation(), \"BC\");\n+                algorithm = cipherHolder.getTransformation();\n                 cipherTextBytes = cipherHolder.getCipherBase64Decoded();\n             } else {\n                 // If the ciphertext is not a self-contained, directly decrypt using transformation configured in\n                 // carbon.properties file\n-                keyStoreCipher = Cipher.getInstance(cipherTransformation, \"BC\");\n+                algorithm = cipherTransformation;\n+            }\n+        }\n+        if (cipherTextBytes.length == 0) {\n+            decryptedValue = StringUtils.EMPTY.getBytes();\n+            if (log.isDebugEnabled()) {\n+                log.debug(\"Ciphertext is empty. An empty array will be used as the plaintext bytes.\");\n             }\n         } else {\n-            // If reach here, user have removed org.wso2.CipherTransformation property or carbon.properties file\n-            // hence RSA is considered as default transformation\n-            keyStoreCipher = Cipher.getInstance(\"RSA\", \"BC\");\n+            decryptedValue = cryptoService.decrypt(cipherTextBytes, algorithm, CRYPTO_API_PROVIDER_BC);", "originalCommit": "2d39c34a57e795da98eb0e7f3b52a5f19d3fb973", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjIxNzc3MA==", "url": "https://github.com/wso2/carbon-kernel/pull/2639#discussion_r396217770", "bodyText": "Yes, default one will be resolved from the respective internal crypto provider in the crypto service", "author": "denuwanthi", "createdAt": "2020-03-23T05:18:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjE5MzIxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjE5MzQxNA==", "url": "https://github.com/wso2/carbon-kernel/pull/2639#discussion_r396193414", "bodyText": "Why we needed another meta data holder defined here.", "author": "malithie", "createdAt": "2020-03-23T03:09:01Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/config/UserStoreConfigXMLProcessor.java", "diffHunk": "@@ -494,7 +495,7 @@ private CipherHolder cipherTextToCipherHolder(byte[] cipherText) {\n      * IMPORTANT: this is copy of org.wso2.carbon.core.util.CipherHolder, what ever changes applied here need to update\n      *              on above\n      */\n-    private class CipherHolder {\n+    private class CipherMetaDataHolder {", "originalCommit": "2d39c34a57e795da98eb0e7f3b52a5f19d3fb973", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjIyNzQ3OQ==", "url": "https://github.com/wso2/carbon-kernel/pull/2639#discussion_r396227479", "bodyText": "Fixed with 39950c6", "author": "denuwanthi", "createdAt": "2020-03-23T06:01:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjE5MzQxNA=="}], "type": "inlineReview"}, {"oid": "39950c6a8d10d5c5723a817db9e0a05d0662761b", "url": "https://github.com/wso2/carbon-kernel/commit/39950c6a8d10d5c5723a817db9e0a05d0662761b", "message": "Use CipherMetaDataHoldder from crypto service", "committedDate": "2020-03-23T05:57:41Z", "type": "commit"}, {"oid": "c552f4e0a8e6592ffdb60fce6d4e805ab34291c3", "url": "https://github.com/wso2/carbon-kernel/commit/c552f4e0a8e6592ffdb60fce6d4e805ab34291c3", "message": "Add new data holder class to store crypto service from osgi startup", "committedDate": "2020-03-23T05:59:24Z", "type": "commit"}, {"oid": "7a63b1e6a18fdce656857af50c7c63d0ee913c87", "url": "https://github.com/wso2/carbon-kernel/commit/7a63b1e6a18fdce656857af50c7c63d0ee913c87", "message": "Refactor code", "committedDate": "2020-03-23T16:07:04Z", "type": "commit"}, {"oid": "d1672ec3ada1d4584d021a17d16d8e76bfa01f9a", "url": "https://github.com/wso2/carbon-kernel/commit/d1672ec3ada1d4584d021a17d16d8e76bfa01f9a", "message": "Remove commented out code", "committedDate": "2020-03-23T16:17:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkzNTExOQ==", "url": "https://github.com/wso2/carbon-kernel/pull/2639#discussion_r396935119", "bodyText": "Shall we remove the unnecessary new lines here?", "author": "ashensw", "createdAt": "2020-03-24T06:57:52Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/internal/UserStoreMgtDSComponent.java", "diffHunk": "@@ -171,6 +173,18 @@ protected void setClaimManagerFactory(ClaimManagerFactory claimManagerFactory) {\n \n     }\n \n+    @Reference(name = \"carbonCryptoService\", cardinality = ReferenceCardinality.OPTIONAL,\n+            policy = ReferencePolicy.DYNAMIC, unbind = \"unsetCarbonCryptoService\")\n+    protected void setCarbonCryptoService(CryptoService cryptoService){\n+        userStoreMgtDataHolder.setCryptoService(cryptoService);\n+    }\n+\n+    protected void unsetCarbonCryptoService(CryptoService cryptoService){\n+        userStoreMgtDataHolder.setCryptoService(null);\n+    }\n+\n+\n+", "originalCommit": "d1672ec3ada1d4584d021a17d16d8e76bfa01f9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk1NTUwMQ==", "url": "https://github.com/wso2/carbon-kernel/pull/2639#discussion_r396955501", "bodyText": "fixed with 8d1a059", "author": "denuwanthi", "createdAt": "2020-03-24T07:49:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkzNTExOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkzNjMyMw==", "url": "https://github.com/wso2/carbon-kernel/pull/2639#discussion_r396936323", "bodyText": "Shall we provide a debug log as well with this information?", "author": "ashensw", "createdAt": "2020-03-24T07:01:19Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/config/UserStoreConfigXMLProcessor.java", "diffHunk": "@@ -430,143 +427,139 @@ private static PrivateKey getPrivateKey() {\n      * @throws BadPaddingException\n      * @throws IllegalBlockSizeException\n      */\n-    private String decryptProperty(String propValue)\n-            throws NoSuchPaddingException, NoSuchAlgorithmException, NoSuchProviderException,\n-            org.wso2.carbon.user.api.UserStoreException, InvalidKeyException, BadPaddingException,\n-            IllegalBlockSizeException {\n+    private String decryptProperty(String propValue) throws CryptoException {\n \n-        Cipher keyStoreCipher;\n+        CryptoService cryptoService = UserStoreMgtDataHolder.getInstance().getCryptoService();\n         String cipherTransformation = System.getProperty(CIPHER_TRANSFORMATION_SYSTEM_PROPERTY);\n         byte[] cipherTextBytes = Base64.decode(propValue.trim());\n+        String algorithm = null;\n+        byte[] decryptedValue;\n+        boolean isInternalKeyStoreEncryptionEnabled = false;\n+        boolean isSymmetricKeyEncryptionEnabled = false;\n+        ServerConfigurationService config =\n+                UserStoreMgtDSComponent.getServerConfigurationService();\n+        if (config != null) {\n+            String encryptionKeyStore = config.getFirstProperty(ENCRYPTION_KEYSTORE);\n \n-        privateKey = (privateKey == null) ? getPrivateKey() : privateKey;\n-        if (privateKey == null) {\n-            throw new org.wso2.carbon.user.api.UserStoreException(\n-                    \"Private key initialization failed. Cannot decrypt the userstore password.\");\n+            if (INTERNAL_KEYSTORE.equalsIgnoreCase(encryptionKeyStore)) {\n+                isInternalKeyStoreEncryptionEnabled = true;\n+            }\n+            String cryptoProvider = config.getFirstProperty(CRYPTO_PROVIDER);\n+            if (SYMMETRIC_KEY_CRYPTO_PROVIDER.equalsIgnoreCase(cryptoProvider)) {\n+                isSymmetricKeyEncryptionEnabled = true;\n+            }\n         }\n \n-        if(cipherTransformation != null) {\n-            // extract the original cipher if custom transformation is used configured in carbon.properties.\n-            CipherHolder cipherHolder = cipherTextToCipherHolder(cipherTextBytes);\n-            if (cipherHolder != null) {\n-                // cipher with meta data.\n+        if (isInternalKeyStoreEncryptionEnabled && isSymmetricKeyEncryptionEnabled) {\n+\n+            throw new CryptoException(String.format(\"Userstore encryption can not be supported due to \" +\n+                    \"conflicting configurations: '%s' and '%s'. When using internal keystore, assymetric crypto \" +\n+                    \"provider should be used.\", INTERNAL_KEYSTORE, SYMMETRIC_KEY_CRYPTO_PROVIDER));\n+        } else if (isInternalKeyStoreEncryptionEnabled || isSymmetricKeyEncryptionEnabled) {\n+\n+            if (cipherTransformation != null) {\n+                // extract the original cipher if custom transformation is used configured in carbon.properties.\n+                CipherMetaDataHolder cipherHolder = cipherTextToCipherHolder(cipherTextBytes);\n+                if (cipherHolder != null) {\n+                    // cipher with meta data.\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(\"Cipher transformation for decryption : \" + cipherHolder.getTransformation());\n+                    }\n+                    algorithm = cipherHolder.getTransformation();\n+                    cipherTextBytes = cipherHolder.getCipherBase64Decoded();\n+                } else {\n+                    // If the ciphertext is not a self-contained, directly decrypt using transformation configured in\n+                    // carbon.properties file\n+                    algorithm = cipherTransformation;\n+                }\n+            }\n+            if (cipherTextBytes.length == 0) {\n+                decryptedValue = StringUtils.EMPTY.getBytes();\n                 if (log.isDebugEnabled()) {\n-                    log.debug(\"Cipher transformation for decryption : \" + cipherHolder.getTransformation());\n+                    log.debug(\"Ciphertext is empty. An empty array will be used as the plaintext bytes.\");\n                 }\n-                keyStoreCipher = Cipher.getInstance(cipherHolder.getTransformation(), \"BC\");\n-                cipherTextBytes = cipherHolder.getCipherBase64Decoded();\n             } else {\n-                // If the ciphertext is not a self-contained, directly decrypt using transformation configured in\n-                // carbon.properties file\n-                keyStoreCipher = Cipher.getInstance(cipherTransformation, \"BC\");\n+                decryptedValue = cryptoService.decrypt(cipherTextBytes, algorithm, CRYPTO_API_PROVIDER_BC);\n             }\n-        } else {\n-            // If reach here, user have removed org.wso2.CipherTransformation property or carbon.properties file\n-            // hence RSA is considered as default transformation\n-            keyStoreCipher = Cipher.getInstance(\"RSA\", \"BC\");\n-        }\n-        keyStoreCipher.init(Cipher.DECRYPT_MODE, privateKey);\n-        return new String(keyStoreCipher.doFinal(cipherTextBytes), Charset.defaultCharset());\n-    }\n+            return new String(decryptedValue);\n \n-    /**\n-     * Function to convert cipher byte array to {@link CipherHolder}.\n-     *\n-     * @param cipherText cipher text as a byte array\n-     * @return if cipher text is not a cipher with meta data\n-     */\n-    private CipherHolder cipherTextToCipherHolder(byte[] cipherText) {\n+        } else {\n+            return decryptWithPrimaryKeyStore(propValue);\n \n-        String cipherStr = new String(cipherText, Charset.defaultCharset());\n-        try {\n-            return gson.fromJson(cipherStr, CipherHolder.class);\n-        } catch (JsonSyntaxException e) {\n-            if (log.isDebugEnabled()) {\n-                log.debug(\"Deserialization failed since cipher string is not representing cipher with metadata\");\n-            }\n-            return null;\n         }\n-    }\n \n-    /**\n-     * Holds encrypted cipher with related metadata.\n-     *\n-     * IMPORTANT: this is copy of org.wso2.carbon.core.util.CipherHolder, what ever changes applied here need to update\n-     *              on above\n-     */\n-    private class CipherHolder {\n-\n-        // Base64 encoded ciphertext.\n-        private String c;\n+    }\n \n-        // Transformation used for encryption, default is \"RSA\".\n-        private String t = \"RSA\";\n+    private String decryptWithPrimaryKeyStore(String propValue) throws CryptoException {\n \n-        // Thumbprint of the certificate.\n-        private String tp;\n+        Cipher keyStoreCipher = null;\n+        String cipherTransformation = System.getProperty(CIPHER_TRANSFORMATION_SYSTEM_PROPERTY);\n+        byte[] cipherTextBytes = Base64.decode(propValue.trim());\n+        byte[] plainTextBytes = new byte[0];\n \n-        // Digest used to generate certificate thumbprint.\n-        private String tpd;\n+        privateKey = (privateKey == null) ? getPrivateKey() : privateKey;\n+        if (privateKey == null) {\n+            throw new CryptoException(\n+                    \"Private key initialization failed. Cannot decrypt the userstore password.\");\n+        }\n \n+        try {\n+            if (cipherTransformation != null) {\n+                // extract the original cipher if custom transformation is used configured in carbon.properties.\n+                CipherMetaDataHolder cipherHolder = cipherTextToCipherHolder(cipherTextBytes);\n+                if (cipherHolder != null) {\n+                    // cipher with meta data.\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(\"Cipher transformation for decryption : \" + cipherHolder.getTransformation());\n+                    }\n \n-        public String getTransformation() {\n-            return t;\n-        }\n+                    keyStoreCipher = Cipher.getInstance(cipherHolder.getTransformation(), \"BC\");\n \n-        public void setTransformation(String transformation) {\n-            this.t = transformation;\n-        }\n+                    cipherTextBytes = cipherHolder.getCipherBase64Decoded();\n+                } else {\n+                    // If the ciphertext is not a self-contained, directly decrypt using transformation configured in\n+                    // carbon.properties file\n \n-        public String getCipherText() {\n-            return c;\n-        }\n+                    keyStoreCipher = Cipher.getInstance(cipherTransformation, \"BC\");\n \n-        public byte[] getCipherBase64Decoded() {\n-            return Base64.decode(c);\n-        }\n+                }\n+            } else {\n+                // If reach here, user have removed org.wso2.CipherTransformation property or carbon.properties file\n+                // hence RSA is considered as default transformation", "originalCommit": "d1672ec3ada1d4584d021a17d16d8e76bfa01f9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk1NTU2OQ==", "url": "https://github.com/wso2/carbon-kernel/pull/2639#discussion_r396955569", "bodyText": "fixed with 8d1a059", "author": "denuwanthi", "createdAt": "2020-03-24T07:49:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkzNjMyMw=="}], "type": "inlineReview"}, {"oid": "8d1a059d01c4d955897f1834cc148dff8df0c730", "url": "https://github.com/wso2/carbon-kernel/commit/8d1a059d01c4d955897f1834cc148dff8df0c730", "message": "Fix PR comments to add debug logs", "committedDate": "2020-03-24T07:48:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk3NjEzOA==", "url": "https://github.com/wso2/carbon-kernel/pull/2639#discussion_r396976138", "bodyText": "If caron.properties is not present can 'cipherTransformation' be null\nAnd if so what happens.", "author": "malithie", "createdAt": "2020-03-24T08:30:35Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/config/UserStoreConfigXMLProcessor.java", "diffHunk": "@@ -430,143 +427,142 @@ private static PrivateKey getPrivateKey() {\n      * @throws BadPaddingException\n      * @throws IllegalBlockSizeException\n      */\n-    private String decryptProperty(String propValue)\n-            throws NoSuchPaddingException, NoSuchAlgorithmException, NoSuchProviderException,\n-            org.wso2.carbon.user.api.UserStoreException, InvalidKeyException, BadPaddingException,\n-            IllegalBlockSizeException {\n+    private String decryptProperty(String propValue) throws CryptoException {\n \n-        Cipher keyStoreCipher;\n+        CryptoService cryptoService = UserStoreMgtDataHolder.getInstance().getCryptoService();\n         String cipherTransformation = System.getProperty(CIPHER_TRANSFORMATION_SYSTEM_PROPERTY);\n         byte[] cipherTextBytes = Base64.decode(propValue.trim());\n+        String algorithm = null;\n+        byte[] decryptedValue;\n+        boolean isInternalKeyStoreEncryptionEnabled = false;\n+        boolean isSymmetricKeyEncryptionEnabled = false;\n+        ServerConfigurationService config =\n+                UserStoreMgtDSComponent.getServerConfigurationService();\n+        if (config != null) {\n+            String encryptionKeyStore = config.getFirstProperty(ENCRYPTION_KEYSTORE);\n \n-        privateKey = (privateKey == null) ? getPrivateKey() : privateKey;\n-        if (privateKey == null) {\n-            throw new org.wso2.carbon.user.api.UserStoreException(\n-                    \"Private key initialization failed. Cannot decrypt the userstore password.\");\n+            if (INTERNAL_KEYSTORE.equalsIgnoreCase(encryptionKeyStore)) {\n+                isInternalKeyStoreEncryptionEnabled = true;\n+            }\n+            String cryptoProvider = config.getFirstProperty(CRYPTO_PROVIDER);\n+            if (SYMMETRIC_KEY_CRYPTO_PROVIDER.equalsIgnoreCase(cryptoProvider)) {\n+                isSymmetricKeyEncryptionEnabled = true;\n+            }\n         }\n \n-        if(cipherTransformation != null) {\n-            // extract the original cipher if custom transformation is used configured in carbon.properties.\n-            CipherHolder cipherHolder = cipherTextToCipherHolder(cipherTextBytes);\n-            if (cipherHolder != null) {\n-                // cipher with meta data.\n+        if (isInternalKeyStoreEncryptionEnabled && isSymmetricKeyEncryptionEnabled) {\n+\n+            throw new CryptoException(String.format(\"Userstore encryption can not be supported due to \" +\n+                    \"conflicting configurations: '%s' and '%s'. When using internal keystore, assymetric crypto \" +\n+                    \"provider should be used.\", INTERNAL_KEYSTORE, SYMMETRIC_KEY_CRYPTO_PROVIDER));\n+        } else if (isInternalKeyStoreEncryptionEnabled || isSymmetricKeyEncryptionEnabled) {\n+\n+            if (cipherTransformation != null) {\n+                // extract the original cipher if custom transformation is used configured in carbon.properties.\n+                CipherMetaDataHolder cipherHolder = cipherTextToCipherHolder(cipherTextBytes);\n+                if (cipherHolder != null) {\n+                    // cipher with meta data.\n+                    if (log.isDebugEnabled()) {\n+                        log.debug(\"Cipher transformation for decryption : \" + cipherHolder.getTransformation());\n+                    }\n+                    algorithm = cipherHolder.getTransformation();\n+                    cipherTextBytes = cipherHolder.getCipherBase64Decoded();\n+                } else {\n+                    // If the ciphertext is not a self-contained, directly decrypt using transformation configured in\n+                    // carbon.properties file\n+                    algorithm = cipherTransformation;\n+                }\n+            }", "originalCommit": "8d1a059d01c4d955897f1834cc148dff8df0c730", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAzNTQ5Ng==", "url": "https://github.com/wso2/carbon-kernel/pull/2639#discussion_r397035496", "bodyText": "yes, cipherTransformation becomes null.\nThen the algorithm becomes null.\nIt will call the cryptoService.decrypt(cipherTextBytes, algorithm, CRYPTO_API_PROVIDER_BC); (line 482)with the null algorithm. But in cryptoservice it will assign the default algorithm if the incoming algorithm is null.", "author": "denuwanthi", "createdAt": "2020-03-24T10:07:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk3NjEzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA5NDk4NQ==", "url": "https://github.com/wso2/carbon-kernel/pull/2639#discussion_r397094985", "bodyText": "+1", "author": "malithie", "createdAt": "2020-03-24T11:53:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk3NjEzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk3NzcyMg==", "url": "https://github.com/wso2/carbon-kernel/pull/2639#discussion_r396977722", "bodyText": "Doesn't this skip the case where internal key store is not configured and symmetric is not enabled, which should switch to primary key store", "author": "malithie", "createdAt": "2020-03-24T08:33:28Z", "path": "core/org.wso2.carbon.user.core/src/main/java/org/wso2/carbon/user/core/config/UserStoreConfigXMLProcessor.java", "diffHunk": "@@ -430,143 +427,142 @@ private static PrivateKey getPrivateKey() {\n      * @throws BadPaddingException\n      * @throws IllegalBlockSizeException\n      */\n-    private String decryptProperty(String propValue)\n-            throws NoSuchPaddingException, NoSuchAlgorithmException, NoSuchProviderException,\n-            org.wso2.carbon.user.api.UserStoreException, InvalidKeyException, BadPaddingException,\n-            IllegalBlockSizeException {\n+    private String decryptProperty(String propValue) throws CryptoException {\n \n-        Cipher keyStoreCipher;\n+        CryptoService cryptoService = UserStoreMgtDataHolder.getInstance().getCryptoService();\n         String cipherTransformation = System.getProperty(CIPHER_TRANSFORMATION_SYSTEM_PROPERTY);\n         byte[] cipherTextBytes = Base64.decode(propValue.trim());\n+        String algorithm = null;\n+        byte[] decryptedValue;\n+        boolean isInternalKeyStoreEncryptionEnabled = false;\n+        boolean isSymmetricKeyEncryptionEnabled = false;\n+        ServerConfigurationService config =\n+                UserStoreMgtDSComponent.getServerConfigurationService();\n+        if (config != null) {\n+            String encryptionKeyStore = config.getFirstProperty(ENCRYPTION_KEYSTORE);\n \n-        privateKey = (privateKey == null) ? getPrivateKey() : privateKey;\n-        if (privateKey == null) {\n-            throw new org.wso2.carbon.user.api.UserStoreException(\n-                    \"Private key initialization failed. Cannot decrypt the userstore password.\");\n+            if (INTERNAL_KEYSTORE.equalsIgnoreCase(encryptionKeyStore)) {\n+                isInternalKeyStoreEncryptionEnabled = true;\n+            }\n+            String cryptoProvider = config.getFirstProperty(CRYPTO_PROVIDER);\n+            if (SYMMETRIC_KEY_CRYPTO_PROVIDER.equalsIgnoreCase(cryptoProvider)) {\n+                isSymmetricKeyEncryptionEnabled = true;\n+            }\n         }\n \n-        if(cipherTransformation != null) {\n-            // extract the original cipher if custom transformation is used configured in carbon.properties.\n-            CipherHolder cipherHolder = cipherTextToCipherHolder(cipherTextBytes);\n-            if (cipherHolder != null) {\n-                // cipher with meta data.\n+        if (isInternalKeyStoreEncryptionEnabled && isSymmetricKeyEncryptionEnabled) {\n+\n+            throw new CryptoException(String.format(\"Userstore encryption can not be supported due to \" +\n+                    \"conflicting configurations: '%s' and '%s'. When using internal keystore, assymetric crypto \" +\n+                    \"provider should be used.\", INTERNAL_KEYSTORE, SYMMETRIC_KEY_CRYPTO_PROVIDER));\n+        } else if (isInternalKeyStoreEncryptionEnabled || isSymmetricKeyEncryptionEnabled) {", "originalCommit": "8d1a059d01c4d955897f1834cc148dff8df0c730", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk5MDQ3Ng==", "url": "https://github.com/wso2/carbon-kernel/pull/2639#discussion_r396990476", "bodyText": "There is another else statement after this else if. It's handled there.\nelse {\nreturn decryptWithPrimaryKeyStore(propValue);\n}\nhttps://github.com/wso2/carbon-kernel/pull/2639/files#diff-889aa9c6d5d53b652ccbcfdb23b953a7R486", "author": "denuwanthi", "createdAt": "2020-03-24T08:56:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk3NzcyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAxOTk1OQ==", "url": "https://github.com/wso2/carbon-kernel/pull/2639#discussion_r397019959", "bodyText": "noted the condition is handled", "author": "malithie", "createdAt": "2020-03-24T09:43:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk3NzcyMg=="}], "type": "inlineReview"}]}