{"pr_number": 887, "pr_title": "FINERACT-830: Configuring Dockerfile to use Google Distroless base image", "pr_createdAt": "2020-05-14T03:58:16Z", "pr_url": "https://github.com/apache/fineract/pull/887", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk0Mzc3OQ==", "url": "https://github.com/apache/fineract/pull/887#discussion_r425943779", "bodyText": "This loss of the mysql-connector-java-8.0.19.jar is a problem for those who want to use that instead of Drizzle (e.g. I actually do, on https://www.fineract.dev...). It means e.g. that if you (quote) \"comment out lines in the docker-compose.yml illustrate how to do this\" it won't find it anymore after this PR.\n@ptuomola do you think we could keep somehow that? Unfortunately, you can't just add it to dependencies.gradle - because we cannot distribute an LGPL library with Fineract release ZIPs that can be downloaded from https://fineract.apache.org. I know and totally agree that this is a bit of a mess; ask for references if you want more details. I guess you could still keep the wget here, and add it to the classpath when launching the JAR? BTW I'm sure you've also come across posts suggesting that a bit of startup time can be gained by \"exploding\" (uncompressing) \"FAT JARs\", and directly specifying the main class. I don't know if that's something you would be willing to already do here? Or we could of course look into that later. It just occurred to me that it may go naturally together with adding an additional JAR.", "author": "vorburger", "createdAt": "2020-05-15T17:23:56Z", "path": "Dockerfile", "diffHunk": "@@ -32,30 +32,11 @@ COPY *LICENSE* fineract/\n COPY *NOTICE* fineract/\n \n WORKDIR fineract\n-# RUN find .\n-RUN ./gradlew clean -x rat -x test war\n+RUN ./gradlew clean -x rat -x test bootJar\n \n # =========================================\n \n-FROM bitnami/tomcat:9.0 as fineract\n+FROM gcr.io/distroless/java:11 as fineract\n \n-USER root\n-RUN apt-get update -qq && apt-get install -y wget\n-\n-COPY --from=builder /fineract/build/libs/fineract-provider.war /opt/bitnami/tomcat/webapps\n-\n-RUN keytool -genkey -keyalg RSA -alias tomcat -keystore /opt/bitnami/tomcat/tomcat.keystore -keypass xyz123 -storepass xyz123 -noprompt -dname \"CN=Fineract, OU=Fineract, O=Fineract, L=Unknown, ST=Unknown, C=Unknown\"\n-COPY ./docker/server.xml /opt/bitnami/tomcat/conf\n-RUN chmod 664 /opt/bitnami/tomcat/conf/server.xml\n-\n-WORKDIR /opt/bitnami/tomcat/lib\n-# org.drizzle.jdbc.DrizzleDriver is used by default for both the all tenants and demo tenant DB DataSource\n-RUN wget https://repo1.maven.org/maven2/org/drizzle/jdbc/drizzle-jdbc/1.4/drizzle-jdbc-1.4.jar\n-\n-# https://issues.apache.org/jira/browse/LEGAL-462\n-# https://issues.apache.org/jira/browse/FINERACT-762\n-# We include an alternative JDBC driver (which is faster, but not allowed to be default in Apache distribution)\n-# allowing implementations to switch the driver used by changing start-up parameters (for both tenants and each tenant DB)\n-# The commented out lines in the docker-compose.yml illustrate how to do this.\n-# To be sure that this instead of Drizlle is used, comment out wget above.\n-RUN wget https://repo1.maven.org/maven2/mysql/mysql-connector-java/8.0.19/mysql-connector-java-8.0.19.jar", "originalCommit": "c7e029b4fc5815ac2ef7443350e9ee72d303dece", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjEzNzk3Mw==", "url": "https://github.com/apache/fineract/pull/887#discussion_r426137973", "bodyText": "@ptuomola due to FINERACT-980 I have just created FINERACT-982 for future discussion on this front, if you want to chime in there. But in the very short term, to get this PR in, IMHO we should still keep this as is? Unless you have any better ideas...", "author": "vorburger", "createdAt": "2020-05-16T09:43:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk0Mzc3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU4MTEwNA==", "url": "https://github.com/apache/fineract/pull/887#discussion_r427581104", "bodyText": "To get MySQL driver option to work again, I've added in downloading the JAR for the driver back in. At the same time, I also exploded the JAR and changed Dockerfile to run the main class directly as suggested. Changes seem to work OK at least locally - tested with both Drizzle and MySQL connectors. Let me know if this looks ok...", "author": "ptuomola", "createdAt": "2020-05-19T20:30:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk0Mzc3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYxNTgyMw==", "url": "https://github.com/apache/fineract/pull/887#discussion_r427615823", "bodyText": "@ptuomola thanks! I'd love to manually test deploy this on https://www.fineract.dev before I merge it - I'll try to do that in the coming days, and assuming that it \"just works\" (which I expect that it will, just to be extra careful...), I'll merge it; hope that's OK.", "author": "vorburger", "createdAt": "2020-05-19T21:38:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk0Mzc3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYyNzMzOQ==", "url": "https://github.com/apache/fineract/pull/887#discussion_r427627339", "bodyText": "@xurror in the mean time, do you want to review this already, based on your comments I just saw in https://issues.apache.org/jira/browse/FINERACT-830 ? Please don't merge it yet, just review and LGTM - I'll merge it after I've tested it as described above - if it's LGTY.", "author": "vorburger", "createdAt": "2020-05-19T22:04:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk0Mzc3OQ=="}], "type": "inlineReview"}, {"oid": "ddb029e99451dd463386c82be273fb65441799fa", "url": "https://github.com/apache/fineract/commit/ddb029e99451dd463386c82be273fb65441799fa", "message": "FINERACT-830: Configuring Dockerfile to use Google Distroless base image", "committedDate": "2020-05-19T20:24:18Z", "type": "commit"}, {"oid": "ddb029e99451dd463386c82be273fb65441799fa", "url": "https://github.com/apache/fineract/commit/ddb029e99451dd463386c82be273fb65441799fa", "message": "FINERACT-830: Configuring Dockerfile to use Google Distroless base image", "committedDate": "2020-05-19T20:24:18Z", "type": "forcePushed"}]}