{"pr_number": 817, "pr_title": "Step 1 of improving SchedulerJobHelper to be more reliable and prevent flaky tests (FINERACT-922)", "pr_createdAt": "2020-05-03T22:54:40Z", "pr_url": "https://github.com/apache/fineract/pull/817", "timeline": [{"oid": "749a4f450c683ceca1612f06f155adaebb165764", "url": "https://github.com/apache/fineract/commit/749a4f450c683ceca1612f06f155adaebb165764", "message": "intro. SchedulerJobsHelper.executeAndAwaitJob() (solves FINERACT-922 ?)", "committedDate": "2020-05-03T23:26:19Z", "type": "forcePushed"}, {"oid": "57deb88b9641b126588821cde3ddc0790c33bd91", "url": "https://github.com/apache/fineract/commit/57deb88b9641b126588821cde3ddc0790c33bd91", "message": "replace my Awaitility inspired code by the real deal (FINERACT-922)", "committedDate": "2020-05-09T01:13:44Z", "type": "forcePushed"}, {"oid": "e39986e62090c9573dc19fb5e34bc84b1d51df48", "url": "https://github.com/apache/fineract/commit/e39986e62090c9573dc19fb5e34bc84b1d51df48", "message": "replace my Awaitility inspired code by the real deal (FINERACT-922)", "committedDate": "2020-05-09T15:13:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIxNjkxMg==", "url": "https://github.com/apache/fineract/pull/817#discussion_r426216912", "bodyText": "Shouldn't the first condition be comparing beforeExecuteTime and jobRunStartTime?", "author": "ptuomola", "createdAt": "2020-05-17T04:47:13Z", "path": "fineract-provider/src/integrationTest/java/org/apache/fineract/integrationtests/common/SchedulerJobHelper.java", "diffHunk": "@@ -122,45 +139,112 @@ private static String runSchedulerJobAsJSON() {\n         return runSchedulerJob;\n     }\n \n-    public void executeJob(String jobName) throws InterruptedException {\n-        List<Map> allSchedulerJobsData = getAllSchedulerJobs();\n-        Assert.assertNotNull(allSchedulerJobsData);\n-\n+    private int getSchedulerJobIdByName(String jobName) {\n+        List<Map<String, Object>> allSchedulerJobsData = getAllSchedulerJobs();\n         for (Integer jobIndex = 0; jobIndex < allSchedulerJobsData.size(); jobIndex++) {\n             if (allSchedulerJobsData.get(jobIndex).get(\"displayName\").equals(jobName)) {\n-                Integer jobId = (Integer) allSchedulerJobsData.get(jobIndex).get(\"jobId\");\n+                return (Integer) allSchedulerJobsData.get(jobIndex).get(\"jobId\");\n+            }\n+        }\n+        throw new IllegalArgumentException(\"No such named Job (see org.apache.fineract.infrastructure.jobs.service.JobName enum):\" + jobName);\n+    }\n \n-                // Executing Scheduler Job\n-                runSchedulerJob(this.requestSpec, jobId.toString());\n+    @Deprecated // FINERACT-922 TODO Gradually replace use of this method with new executeAndAwaitJob() below, if it proves to be more stable than this one\n+    public void executeJob(String jobName) throws InterruptedException {\n+        // Stop the Scheduler while we manually trigger execution of job, to avoid side effects and simplify debugging when readings logs\n+        updateSchedulerStatus(false);\n+\n+        int jobId = getSchedulerJobIdByName(jobName);\n \n-                // Retrieving Scheduler Job by ID\n-                Map schedulerJob = getSchedulerJobById(jobId);\n-                Assert.assertNotNull(schedulerJob);\n+        // Executing Scheduler Job\n+        runSchedulerJob(jobId);\n \n-                // Waiting for Job to complete\n-                while ((Boolean) schedulerJob.get(\"currentlyRunning\") == true) {\n-                    Thread.sleep(15000);\n-                    schedulerJob = getSchedulerJobById(jobId);\n-                    Assert.assertNotNull(schedulerJob);\n-                    System.out.println(\"Job is Still Running\");\n-                }\n+        // Retrieving Scheduler Job by ID\n+        Map<String, Object> schedulerJob = getSchedulerJobById(jobId);\n \n-                List<Map> jobHistoryData = getSchedulerJobHistory(jobId);\n+        // Waiting for Job to complete\n+        while ((Boolean) schedulerJob.get(\"currentlyRunning\") == true) {\n+            Thread.sleep(15000);\n+            schedulerJob = getSchedulerJobById(jobId);\n+            assertNotNull(schedulerJob);\n+            System.out.println(\"Job is Still Running\");\n+        }\n \n-                Assert.assertFalse(\"Job History is empty :(  Was it too slow? Failures in background job?\", jobHistoryData.isEmpty());\n+        List<Map<String, Object>> jobHistoryData = getSchedulerJobHistory(jobId);\n \n-                // print error associated with recent job failure (if any)\n-                System.out.println(\"Job run error message (printed only if the job fails: \"\n-                        + jobHistoryData.get(jobHistoryData.size() - 1).get(\"jobRunErrorMessage\"));\n-                System.out.println(\"Job failure error log (printed only if the job fails: \"\n-                        + jobHistoryData.get(jobHistoryData.size() - 1).get(\"jobRunErrorLog\"));\n+        assertFalse(\"Job History is empty :(  Was it too slow? Failures in background job?\", jobHistoryData.isEmpty());\n \n-                // Verifying the Status of the Recently executed Scheduler Job\n-                Assert.assertEquals(\"Verifying Last Scheduler Job Status\", \"success\",\n-                        jobHistoryData.get(jobHistoryData.size() - 1).get(\"status\"));\n+        // print error associated with recent job failure (if any)\n+        System.out.println(\"Job run error message (printed only if the job fails: \"\n+                + jobHistoryData.get(jobHistoryData.size() - 1).get(\"jobRunErrorMessage\"));\n+        System.out.println(\"Job failure error log (printed only if the job fails: \"\n+                + jobHistoryData.get(jobHistoryData.size() - 1).get(\"jobRunErrorLog\"));\n+\n+        // Verifying the Status of the Recently executed Scheduler Job\n+        assertEquals(\"Verifying Last Scheduler Job Status\", \"success\",\n+                jobHistoryData.get(jobHistoryData.size() - 1).get(\"status\"));\n+    }\n \n-                break;\n+    /**\n+     * Launches a Job and awaits its completion.\n+     * @param jobName displayName (see {@link org.apache.fineract.infrastructure.jobs.service.JobName}) of Scheduler Job\n+     *\n+     * @author Michael Vorburger.ch\n+     */\n+    public void executeAndAwaitJob(String jobName) {\n+        Duration TIMEOUT = Duration.ofSeconds(30);\n+        Duration PAUSE = Duration.ofMillis(500);\n+        DateTimeFormatter df = DateTimeFormatter.ISO_INSTANT; // FINERACT-926\n+        Instant beforeExecuteTime = now().truncatedTo(ChronoUnit.SECONDS);\n+\n+        // Stop the Scheduler while we manually trigger execution of job, to avoid side effects and simplify debugging when readings logs\n+        updateSchedulerStatus(false);\n+\n+        // Executing Scheduler Job\n+        int jobId = getSchedulerJobIdByName(jobName);\n+        runSchedulerJob(jobId);\n+\n+        // Await JobDetailData.lastRunHistory [JobDetailHistoryData] jobRunStartTime >= beforeExecuteTime (or timeout)\n+        await().atMost(TIMEOUT).pollInterval(PAUSE).until(jobLastRunHistorySupplier(jobId), lastRunHistory -> {\n+            String jobRunStartText = lastRunHistory.get(\"jobRunStartTime\");\n+            if (jobRunStartText == null) {\n+                return false;\n             }\n+            Instant jobRunStartTime = df.parse(jobRunStartText, Instant::from);\n+            return jobRunStartTime.equals(jobRunStartTime) || jobRunStartTime.isAfter(beforeExecuteTime);", "originalCommit": "e39986e62090c9573dc19fb5e34bc84b1d51df48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc3MjA4Mg==", "url": "https://github.com/apache/fineract/pull/817#discussion_r428772082", "bodyText": "@ptuomola thank you for having taken the time for a \"real\" (full, detailed - as opposed to just \"waving through\") code review - I appreciate that very much! So yeah testing that jobRunStartTime is equal to itself was definitely wrong here. But I don't think we want to beforeExecuteTime and jobRunStartTime either - that should always be the case (job should always have started just on or later than the test start). What I really wanted to do here is jobRunEndTime.equals(jobRunStartTime) || jobRunEndTime.isAfter(jobRunStartTime) - makes sense? Now so done. Please do ask if unclear!", "author": "vorburger", "createdAt": "2020-05-21T16:36:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIxNjkxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgyODI4Mw==", "url": "https://github.com/apache/fineract/pull/817#discussion_r428828283", "bodyText": "@vorburger I think the second check (row 228) is correct as you state (i.e. jobRunEndTime.equals(jobRunStartTime) || jobRunEndTime.isAfter(jobRunStartTime))\nBut the first check I was commenting on (row 217) would still make most sense to me as:\njobRunStartTime.equals(beforeExecuteTime) || jobRunStartTime.isAfter(beforeExecuteTime)\nin order to make sure that the job has had a chance to start, before we start looking at its history.\nIf we don't do this and go straight to comparing jobRunStartTime and jobRunEndTime, I think there's a risk of hitting the same issue as I observed earlier: i.e. that we started looking for the history before the job even had had a chance to start for this test.\nIn such case we would get the previous execution history of the job, jobRunEndTime would still be >= jobRunStartTime - but this would be the previous run of the job, not the current one we had triggered.\nOr am I missing something here?", "author": "ptuomola", "createdAt": "2020-05-21T18:16:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIxNjkxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkzNjU0Mw==", "url": "https://github.com/apache/fineract/pull/817#discussion_r428936543", "bodyText": "No you're not missing anything, I was just looking at the wrong line! Yes, absolutely agree - better now? However this actually now reveals a new real bug! See FINERACT-992... do you happen to have any interest in taking that? Just asking! I'm marking this PR Draft again after all, as we probably have to fix that issue before this can be merged.", "author": "vorburger", "createdAt": "2020-05-21T21:52:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIxNjkxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY2MTE2OQ==", "url": "https://github.com/apache/fineract/pull/817#discussion_r429661169", "bodyText": "@ptuomola I'm resolving this because I have just closed  FINERACT-992.\nPlease re-open if NOK for you.", "author": "vorburger", "createdAt": "2020-05-24T18:11:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIxNjkxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIxNzAzNQ==", "url": "https://github.com/apache/fineract/pull/817#discussion_r426217035", "bodyText": "Just a cosmetic comment: with this, the logging from the different requests is not uniform. All the other calls log the \"---  ---\" text, this one logs the response. Is there a reason for this?", "author": "ptuomola", "createdAt": "2020-05-17T04:49:45Z", "path": "fineract-provider/src/integrationTest/java/org/apache/fineract/integrationtests/common/SchedulerJobHelper.java", "diffHunk": "@@ -51,21 +60,28 @@ public SchedulerJobHelper(final RequestSpecification requestSpec, final Response\n         this.response202Spec = responseSpec;\n     }\n \n-    private List getAllSchedulerJobs() {\n+    private List<Map<String, Object>> getAllSchedulerJobs() {\n         final String GET_ALL_SCHEDULER_JOBS_URL = \"/fineract-provider/api/v1/jobs?\" + Utils.TENANT_IDENTIFIER;\n         System.out.println(\"------------------------ RETRIEVING ALL SCHEDULER JOBS -------------------------\");\n-        final ArrayList response = Utils.performServerGet(requestSpec, response200Spec, GET_ALL_SCHEDULER_JOBS_URL, \"\");\n+        List<Map<String, Object>> response = Utils.performServerGet(requestSpec, response200Spec, GET_ALL_SCHEDULER_JOBS_URL, \"\");\n+        assertNotNull(response);\n         return response;\n     }\n \n+    private <T> List<T> getAllSchedulerJobDetails(Function<Map<String, Object>, T> mapper) {\n+        return getAllSchedulerJobs().stream().map(mapper).collect(Collectors.toList());\n+    }\n+\n     public List<Integer> getAllSchedulerJobIds() {\n-        ToIntFunction<Map> mapper = map -> (Integer) map.get(\"jobId\");\n-        return getAllSchedulerJobs().stream().mapToInt(mapper).boxed().collect(Collectors.toList());\n+        return getAllSchedulerJobDetails(map -> (Integer) map.get(\"jobId\"));\n+    }\n+\n+    public List<String> getAllSchedulerJobNames() {\n+        return getAllSchedulerJobDetails(map -> (String) map.get(\"displayName\"));\n     }\n \n     public Map<String, Object> getSchedulerJobById(int jobId) {\n         final String GET_SCHEDULER_JOB_BY_ID_URL = \"/fineract-provider/api/v1/jobs/\" + jobId + \"?\" + Utils.TENANT_IDENTIFIER;\n-        System.out.println(\"------------------------ RETRIEVING SCHEDULER JOB BY ID -------------------------\");", "originalCommit": "e39986e62090c9573dc19fb5e34bc84b1d51df48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkzNjcyOQ==", "url": "https://github.com/apache/fineract/pull/817#discussion_r428936729", "bodyText": "It's just something that was useful while debugging.. as it's a test, let's keep it, if you don't mind. OK to resolve this point?", "author": "vorburger", "createdAt": "2020-05-21T21:53:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIxNzAzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTAyNzg0OA==", "url": "https://github.com/apache/fineract/pull/817#discussion_r429027848", "bodyText": "Yep - OK to resolve.", "author": "ptuomola", "createdAt": "2020-05-22T03:45:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIxNzAzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIxNzEyMA==", "url": "https://github.com/apache/fineract/pull/817#discussion_r426217120", "bodyText": "Should we not just replace the old implementation with the new, and skip with the gradual transition? Or are there concerns that the new one may not work in some cases?", "author": "ptuomola", "createdAt": "2020-05-17T04:50:44Z", "path": "fineract-provider/src/integrationTest/java/org/apache/fineract/integrationtests/common/SchedulerJobHelper.java", "diffHunk": "@@ -122,45 +139,112 @@ private static String runSchedulerJobAsJSON() {\n         return runSchedulerJob;\n     }\n \n-    public void executeJob(String jobName) throws InterruptedException {\n-        List<Map> allSchedulerJobsData = getAllSchedulerJobs();\n-        Assert.assertNotNull(allSchedulerJobsData);\n-\n+    private int getSchedulerJobIdByName(String jobName) {\n+        List<Map<String, Object>> allSchedulerJobsData = getAllSchedulerJobs();\n         for (Integer jobIndex = 0; jobIndex < allSchedulerJobsData.size(); jobIndex++) {\n             if (allSchedulerJobsData.get(jobIndex).get(\"displayName\").equals(jobName)) {\n-                Integer jobId = (Integer) allSchedulerJobsData.get(jobIndex).get(\"jobId\");\n+                return (Integer) allSchedulerJobsData.get(jobIndex).get(\"jobId\");\n+            }\n+        }\n+        throw new IllegalArgumentException(\"No such named Job (see org.apache.fineract.infrastructure.jobs.service.JobName enum):\" + jobName);\n+    }\n \n-                // Executing Scheduler Job\n-                runSchedulerJob(this.requestSpec, jobId.toString());\n+    @Deprecated // FINERACT-922 TODO Gradually replace use of this method with new executeAndAwaitJob() below, if it proves to be more stable than this one", "originalCommit": "e39986e62090c9573dc19fb5e34bc84b1d51df48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkzNjg2NQ==", "url": "https://github.com/apache/fineract/pull/817#discussion_r428936865", "bodyText": "When I tried that while originally creating this, it didn't \"just work\" yet, so I wanted to get this in, and then more gradually attempt to \"switch over\", one by one, and further investigate related problems. Wanna help? \ud83d\ude3a OK to resolve this point?", "author": "vorburger", "createdAt": "2020-05-21T21:53:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIxNzEyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTAyNzcwNQ==", "url": "https://github.com/apache/fineract/pull/817#discussion_r429027705", "bodyText": "Sounds good - OK to resolve.", "author": "ptuomola", "createdAt": "2020-05-22T03:45:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIxNzEyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIxNzY2OA==", "url": "https://github.com/apache/fineract/pull/817#discussion_r426217668", "bodyText": "Would be great to get rid of the SuppressWarnings... I wonder if there's any clever solution to achieve that?", "author": "ptuomola", "createdAt": "2020-05-17T05:01:57Z", "path": "fineract-provider/src/integrationTest/java/org/apache/fineract/integrationtests/common/SchedulerJobHelper.java", "diffHunk": "@@ -122,45 +139,112 @@ private static String runSchedulerJobAsJSON() {\n         return runSchedulerJob;\n     }\n \n-    public void executeJob(String jobName) throws InterruptedException {\n-        List<Map> allSchedulerJobsData = getAllSchedulerJobs();\n-        Assert.assertNotNull(allSchedulerJobsData);\n-\n+    private int getSchedulerJobIdByName(String jobName) {\n+        List<Map<String, Object>> allSchedulerJobsData = getAllSchedulerJobs();\n         for (Integer jobIndex = 0; jobIndex < allSchedulerJobsData.size(); jobIndex++) {\n             if (allSchedulerJobsData.get(jobIndex).get(\"displayName\").equals(jobName)) {\n-                Integer jobId = (Integer) allSchedulerJobsData.get(jobIndex).get(\"jobId\");\n+                return (Integer) allSchedulerJobsData.get(jobIndex).get(\"jobId\");\n+            }\n+        }\n+        throw new IllegalArgumentException(\"No such named Job (see org.apache.fineract.infrastructure.jobs.service.JobName enum):\" + jobName);\n+    }\n \n-                // Executing Scheduler Job\n-                runSchedulerJob(this.requestSpec, jobId.toString());\n+    @Deprecated // FINERACT-922 TODO Gradually replace use of this method with new executeAndAwaitJob() below, if it proves to be more stable than this one\n+    public void executeJob(String jobName) throws InterruptedException {\n+        // Stop the Scheduler while we manually trigger execution of job, to avoid side effects and simplify debugging when readings logs\n+        updateSchedulerStatus(false);\n+\n+        int jobId = getSchedulerJobIdByName(jobName);\n \n-                // Retrieving Scheduler Job by ID\n-                Map schedulerJob = getSchedulerJobById(jobId);\n-                Assert.assertNotNull(schedulerJob);\n+        // Executing Scheduler Job\n+        runSchedulerJob(jobId);\n \n-                // Waiting for Job to complete\n-                while ((Boolean) schedulerJob.get(\"currentlyRunning\") == true) {\n-                    Thread.sleep(15000);\n-                    schedulerJob = getSchedulerJobById(jobId);\n-                    Assert.assertNotNull(schedulerJob);\n-                    System.out.println(\"Job is Still Running\");\n-                }\n+        // Retrieving Scheduler Job by ID\n+        Map<String, Object> schedulerJob = getSchedulerJobById(jobId);\n \n-                List<Map> jobHistoryData = getSchedulerJobHistory(jobId);\n+        // Waiting for Job to complete\n+        while ((Boolean) schedulerJob.get(\"currentlyRunning\") == true) {\n+            Thread.sleep(15000);\n+            schedulerJob = getSchedulerJobById(jobId);\n+            assertNotNull(schedulerJob);\n+            System.out.println(\"Job is Still Running\");\n+        }\n \n-                Assert.assertFalse(\"Job History is empty :(  Was it too slow? Failures in background job?\", jobHistoryData.isEmpty());\n+        List<Map<String, Object>> jobHistoryData = getSchedulerJobHistory(jobId);\n \n-                // print error associated with recent job failure (if any)\n-                System.out.println(\"Job run error message (printed only if the job fails: \"\n-                        + jobHistoryData.get(jobHistoryData.size() - 1).get(\"jobRunErrorMessage\"));\n-                System.out.println(\"Job failure error log (printed only if the job fails: \"\n-                        + jobHistoryData.get(jobHistoryData.size() - 1).get(\"jobRunErrorLog\"));\n+        assertFalse(\"Job History is empty :(  Was it too slow? Failures in background job?\", jobHistoryData.isEmpty());\n \n-                // Verifying the Status of the Recently executed Scheduler Job\n-                Assert.assertEquals(\"Verifying Last Scheduler Job Status\", \"success\",\n-                        jobHistoryData.get(jobHistoryData.size() - 1).get(\"status\"));\n+        // print error associated with recent job failure (if any)\n+        System.out.println(\"Job run error message (printed only if the job fails: \"\n+                + jobHistoryData.get(jobHistoryData.size() - 1).get(\"jobRunErrorMessage\"));\n+        System.out.println(\"Job failure error log (printed only if the job fails: \"\n+                + jobHistoryData.get(jobHistoryData.size() - 1).get(\"jobRunErrorLog\"));\n+\n+        // Verifying the Status of the Recently executed Scheduler Job\n+        assertEquals(\"Verifying Last Scheduler Job Status\", \"success\",\n+                jobHistoryData.get(jobHistoryData.size() - 1).get(\"status\"));\n+    }\n \n-                break;\n+    /**\n+     * Launches a Job and awaits its completion.\n+     * @param jobName displayName (see {@link org.apache.fineract.infrastructure.jobs.service.JobName}) of Scheduler Job\n+     *\n+     * @author Michael Vorburger.ch\n+     */\n+    public void executeAndAwaitJob(String jobName) {\n+        Duration TIMEOUT = Duration.ofSeconds(30);\n+        Duration PAUSE = Duration.ofMillis(500);\n+        DateTimeFormatter df = DateTimeFormatter.ISO_INSTANT; // FINERACT-926\n+        Instant beforeExecuteTime = now().truncatedTo(ChronoUnit.SECONDS);\n+\n+        // Stop the Scheduler while we manually trigger execution of job, to avoid side effects and simplify debugging when readings logs\n+        updateSchedulerStatus(false);\n+\n+        // Executing Scheduler Job\n+        int jobId = getSchedulerJobIdByName(jobName);\n+        runSchedulerJob(jobId);\n+\n+        // Await JobDetailData.lastRunHistory [JobDetailHistoryData] jobRunStartTime >= beforeExecuteTime (or timeout)\n+        await().atMost(TIMEOUT).pollInterval(PAUSE).until(jobLastRunHistorySupplier(jobId), lastRunHistory -> {\n+            String jobRunStartText = lastRunHistory.get(\"jobRunStartTime\");\n+            if (jobRunStartText == null) {\n+                return false;\n             }\n+            Instant jobRunStartTime = df.parse(jobRunStartText, Instant::from);\n+            return jobRunStartTime.equals(jobRunStartTime) || jobRunStartTime.isAfter(beforeExecuteTime);\n+        });\n+\n+        // Await JobDetailData.lastRunHistory [JobDetailHistoryData] jobRunEndTime to be both set and >= jobRunStartTime (or timeout)\n+        Map<String, String> finalLastRunHistory = await().atMost(TIMEOUT).pollInterval(PAUSE).until(jobLastRunHistorySupplier(jobId), lastRunHistory -> {\n+            String jobRunEndText = lastRunHistory.get(\"jobRunEndTime\");\n+            if (jobRunEndText == null) {\n+                return false;\n+            }\n+            Instant jobRunEndTime = df.parse(jobRunEndText, Instant::from);\n+            Instant jobRunStartTime = df.parse(lastRunHistory.get(\"jobRunStartTime\"), Instant::from);\n+            return jobRunEndTime.equals(jobRunStartTime) || jobRunEndTime.isAfter(jobRunStartTime);\n+        });\n+\n+        // Verify triggerType\n+        assertThat(finalLastRunHistory.get(\"triggerType\"), is(\"application\"));\n+\n+        // Verify status & propagate jobRunErrorMessage and/or jobRunErrorLog (if any)\n+        String status = finalLastRunHistory.get(\"status\");\n+        if (!status.equals(\"success\")) {\n+            fail(\"Job status is not success: \" + finalLastRunHistory.toString());\n         }\n+\n+        // PS: Checking getSchedulerJobHistory() [/runhistory] is pointless, because the lastRunHistory JobDetailHistoryData is already part of JobDetailData anyway.\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")", "originalCommit": "e39986e62090c9573dc19fb5e34bc84b1d51df48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkzNjg1Mg==", "url": "https://github.com/apache/fineract/pull/817#discussion_r428936852", "bodyText": "As far as I can see, no, not easily unfortunately. Why? Vaguely related to what I blabbered on about in FINERACT-949 re. JSON mapping. I do want to think further about that some fine day, but not as part of this PR. OK to resolve this point?", "author": "vorburger", "createdAt": "2020-05-21T21:53:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIxNzY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTAyNzU5MA==", "url": "https://github.com/apache/fineract/pull/817#discussion_r429027590", "bodyText": "Of course - makes sense. One solution that I thought could work for FINERACT-949 in general would be to use the responseSpec for checking response correctness (instead of looking at return values). But let's continue the discussion under that issue. So OK to resolve.", "author": "ptuomola", "createdAt": "2020-05-22T03:44:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIxNzY2OA=="}], "type": "inlineReview"}, {"oid": "2f3df9a1e14ae9a767f29fd9eff6ece7a99319ad", "url": "https://github.com/apache/fineract/commit/2f3df9a1e14ae9a767f29fd9eff6ece7a99319ad", "message": "intro. SchedulerJobsHelper.executeAndAwaitJob() [FINERACT-922]", "committedDate": "2020-05-21T16:10:24Z", "type": "forcePushed"}, {"oid": "e1b3fe165588e5f4ada32669469bdfa208fb6c46", "url": "https://github.com/apache/fineract/commit/e1b3fe165588e5f4ada32669469bdfa208fb6c46", "message": "intro. SchedulerJobsHelper.executeAndAwaitJob() [FINERACT-922]", "committedDate": "2020-05-21T21:52:37Z", "type": "commit"}, {"oid": "e1b3fe165588e5f4ada32669469bdfa208fb6c46", "url": "https://github.com/apache/fineract/commit/e1b3fe165588e5f4ada32669469bdfa208fb6c46", "message": "intro. SchedulerJobsHelper.executeAndAwaitJob() [FINERACT-922]", "committedDate": "2020-05-21T21:52:37Z", "type": "forcePushed"}]}