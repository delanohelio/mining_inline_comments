{"pr_number": 807, "pr_title": "FINERACT-730: Fixing bootRun and removing embedded Tomcat", "pr_createdAt": "2020-05-03T07:12:15Z", "pr_url": "https://github.com/apache/fineract/pull/807", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA4NDM1Mw==", "url": "https://github.com/apache/fineract/pull/807#discussion_r419084353", "bodyText": "@ptuomola would you consider raising this change as a separate PR instead of as part of this one? Or we could try to make a real better fix, based on what you described in FINERACT-855...", "author": "vorburger", "createdAt": "2020-05-03T10:44:12Z", "path": "fineract-provider/src/integrationTest/java/org/apache/fineract/integrationtests/common/SchedulerJobHelper.java", "diffHunk": "@@ -115,6 +115,9 @@ public void executeJob(String jobName) throws InterruptedException {\n \n                 // Executing Scheduler Job\n                 runSchedulerJob(this.requestSpec, jobId.toString());\n+                \n+                // Need to give the job an opportunity to start - otherwise below might return false as job not yet started\n+                Thread.sleep(15000);", "originalCommit": "2460fc7b92f5810479b0390814fbf0c5a958545c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTExMzcwNQ==", "url": "https://github.com/apache/fineract/pull/807#discussion_r419113705", "bodyText": "Of course - will squash the commits and remove this. Based on the emails, I believe Awasum was going to send a fix to FINERACT-855.", "author": "ptuomola", "createdAt": "2020-05-03T14:46:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA4NDM1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEyNTQwNA==", "url": "https://github.com/apache/fineract/pull/807#discussion_r419125404", "bodyText": "@ptuomola, I am looking into it but I cannot seem to replicate the issue locally as when running ./gradlew integrationTest --tests ClientSavingsIntegrationTest \nEverything passes locally. Could it be that our Travis Vm is not powerful enough?\nIf you have time to get this done earlier than me. Do it.\nMy fix for FINERACT-855 involved doing something like this where we are accessing the jobHistoryData...like so:\nAssert.assertEquals(\"Verifying Last Scheduler Job Status\", \"success\", jobHistoryData.get(jobHistoryData.size() == 0 ? jobHistoryData.size() : jobHistoryData.size() - 1).get(\"status\"));\nSo that we stop getting the ArrayOutOfBounceException.\nThat may not be a good solution.", "author": "awasum", "createdAt": "2020-05-03T16:17:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA4NDM1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEyODI2Nw==", "url": "https://github.com/apache/fineract/pull/807#discussion_r419128267", "bodyText": "My suggestion would be that we wrap up this PR ASAP by strictly and naively \ud83d\udc7f  following the process outlined on https://github.com/apache/fineract#pull-requests ... @ptuomola just try to get this PR to fully pass the build by raising separate PRs, and then rebasing, for any tests that fail on you here. The \"full\" (proper) solution, whether Thread.sleep(15000) or something else, should IMHO be worked on completely separate from this PR.", "author": "vorburger", "createdAt": "2020-05-03T16:40:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA4NDM1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEyODQ2Mw==", "url": "https://github.com/apache/fineract/pull/807#discussion_r419128463", "bodyText": "You are right @vorburger . lets just get his green", "author": "awasum", "createdAt": "2020-05-03T16:42:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA4NDM1Mw=="}], "type": "inlineReview"}, {"oid": "70a81ec689e940dc3b7114a53a4325372c345713", "url": "https://github.com/apache/fineract/commit/70a81ec689e940dc3b7114a53a4325372c345713", "message": "FINERACT-730: Fixed dependencies, SSL config and main class etc to get bootRun to work. Migrated from Gradle Tomcat plugin to Cargo plugin to fix integration test", "committedDate": "2020-05-03T19:13:56Z", "type": "forcePushed"}, {"oid": "4e7108230b34384aaa67db4d8a8edbfb8fa0597c", "url": "https://github.com/apache/fineract/commit/4e7108230b34384aaa67db4d8a8edbfb8fa0597c", "message": "FINERACT-730: Fixed dependencies, SSL config and main class etc to get bootRun to work. Migrated from Gradle Tomcat plugin to Cargo plugin to fix integration test", "committedDate": "2020-05-03T19:35:12Z", "type": "forcePushed"}, {"oid": "b916037316a2ed3977e354866082279ead168189", "url": "https://github.com/apache/fineract/commit/b916037316a2ed3977e354866082279ead168189", "message": "FINERACT-730: Fixed dependencies, SSL config and main class etc to get bootRun to work. Migrated from Gradle Tomcat plugin to Cargo plugin to fix integration test", "committedDate": "2020-05-03T20:04:30Z", "type": "forcePushed"}, {"oid": "46b9d3b97e16a65bd4e50a7a74ab53c5ec634588", "url": "https://github.com/apache/fineract/commit/46b9d3b97e16a65bd4e50a7a74ab53c5ec634588", "message": "FINERACT-730: Fixed dependencies, SSL config and main class etc to get bootRun to work. Migrated from Gradle Tomcat plugin to Cargo plugin to fix integration test", "committedDate": "2020-05-04T07:14:37Z", "type": "forcePushed"}, {"oid": "dc76496f6aaeb15896d1ad4cf89073265f58864d", "url": "https://github.com/apache/fineract/commit/dc76496f6aaeb15896d1ad4cf89073265f58864d", "message": "FINERACT-730: Fixed dependencies, SSL config and main class etc to get bootRun to work. Migrated from Gradle Tomcat plugin to Cargo plugin to fix integration test", "committedDate": "2020-05-04T09:37:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk5MzM0MA==", "url": "https://github.com/apache/fineract/pull/807#discussion_r419993340", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            FROM bitnami/tomcat:latest as fineract\n          \n          \n            \n            FROM bitnami/tomcat:9.0 as fineract\n          \n      \n    \n    \n  \n\nbecause :latest is always dangerous (it could silently break us when Tomcat 10 is released)", "author": "vorburger", "createdAt": "2020-05-05T09:57:01Z", "path": "Dockerfile", "diffHunk": "@@ -37,18 +37,20 @@ RUN ./gradlew clean -x rat -x test war\n \n # =========================================\n \n-FROM bitnami/tomcat:7.0.94 as fineract\n+FROM bitnami/tomcat:latest as fineract", "originalCommit": "dc76496f6aaeb15896d1ad4cf89073265f58864d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM1MzEzMw==", "url": "https://github.com/apache/fineract/pull/807#discussion_r420353133", "bodyText": "@ptuomola did you mean to Commit Suggestion to accept this, or manually work this into your Commit? This Conversation was resolved, and as I was looking this over about to merge it, I've noticed that it hasn't actually been changed... or perhaps I'll just merge this, and raise a quick follow-up PR myself proposing to change it.", "author": "vorburger", "createdAt": "2020-05-05T19:27:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk5MzM0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM2MDA5Nw==", "url": "https://github.com/apache/fineract/pull/807#discussion_r420360097", "bodyText": "Sorry. I did Commit Suggestion to accept it, but then looks like when I pushed a new commit with the other changes you suggested (i.e. README.md etc) that got overwritten. I've now pushed a new commit that hopefully addresses all of the comments you raised. Thanks again for all the feedback!", "author": "ptuomola", "createdAt": "2020-05-05T19:40:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk5MzM0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk5NDY0MQ==", "url": "https://github.com/apache/fineract/pull/807#discussion_r419994641", "bodyText": "Hm, a \"magical\" \ud83d\udc7f secret... I doubt anyone uses the AJP Connector with Tomcat in a Container, and for better security than shipping with a default password (bad best practice) I suggest that we just remove (or at least comment out) this Connector entirely here, what do you think?", "author": "vorburger", "createdAt": "2020-05-05T09:59:20Z", "path": "docker/server.xml", "diffHunk": "@@ -108,7 +108,7 @@\n     -->\n \n     <!-- Define an AJP 1.3 Connector on port 8009 -->\n-    <Connector port=\"8009\" protocol=\"AJP/1.3\" redirectPort=\"8443\" />\n+    <Connector port=\"8009\" protocol=\"AJP/1.3\" redirectPort=\"8443\" secret=\"xyz123\" />", "originalCommit": "dc76496f6aaeb15896d1ad4cf89073265f58864d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDMyODE2Mw==", "url": "https://github.com/apache/fineract/pull/807#discussion_r420328163", "bodyText": "Thanks - that makes sense. I only added it to suppress an error message from Tomcat 9. But you're right that a better approach would be to disable the connector altogether. Will do that next.\nAnd the magical secret was reuse of the keystore password in the same config file :-)", "author": "ptuomola", "createdAt": "2020-05-05T18:43:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk5NDY0MQ=="}], "type": "inlineReview"}, {"oid": "1a9ec367471719dfbb1dd97c844e3197e7fc9935", "url": "https://github.com/apache/fineract/commit/1a9ec367471719dfbb1dd97c844e3197e7fc9935", "message": "FINERACT-730: Fixed dependencies, SSL config and main class etc to get bootRun to work. Migrated from Gradle Tomcat plugin to Cargo plugin to fix integration test", "committedDate": "2020-05-05T18:56:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM1MzgyNg==", "url": "https://github.com/apache/fineract/pull/807#discussion_r420353826", "bodyText": "@ptuomola partially out of curiosity, what's this for, being commented out? If it's not required, is cool to remove this? We can do this in a follow-up PR, just to get this one in... \ud83d\ude03", "author": "vorburger", "createdAt": "2020-05-05T19:28:45Z", "path": "Dockerfile", "diffHunk": "@@ -37,18 +37,20 @@ RUN ./gradlew clean -x rat -x test war\n \n # =========================================\n \n-FROM bitnami/tomcat:7.0.94 as fineract\n+FROM bitnami/tomcat:latest as fineract\n \n-ENV JAVA_HOME /usr/lib/jvm/java-8-openjdk-amd64/jre\n+ENV JAVA_HOME /usr/local/openjdk-8/jre\n \n USER root\n RUN apt-get update -qq && apt-get install -y wget\n \n COPY --from=builder /fineract/build/libs/fineract-provider.war /opt/bitnami/tomcat/webapps\n+COPY --from=builder /usr/local/openjdk-8/jre /usr/local/openjdk-8/jre\n \n RUN keytool -genkey -keyalg RSA -alias tomcat -keystore /opt/bitnami/tomcat/tomcat.keystore -keypass xyz123 -storepass xyz123 -noprompt -dname \"CN=Fineract, OU=Fineract, O=Fineract, L=Unknown, ST=Unknown, C=Unknown\"\n COPY ./docker/server.xml /opt/bitnami/tomcat/conf\n RUN chmod 664 /opt/bitnami/tomcat/conf/server.xml\n+#RUN chown -R tomcat /opt/bitnami/tomcat", "originalCommit": "1a9ec367471719dfbb1dd97c844e3197e7fc9935", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM1NzA2OQ==", "url": "https://github.com/apache/fineract/pull/807#discussion_r420357069", "bodyText": "There's a problem with the Docker image for Tomcat: the temp directory is owned by root rather than tomcat - which means Tomcat spits out an error message when starting.\nI was first going to fix it by changing owner of all of the directories to Tomcat (i.e. this line), but then realised there are actually two temp directories: /opt/bitnami/tomcat/tmp and /opt/bitnami/tomcat/temp.\n/opt/bitnami/tomcat/tmp has the right permissions & owner, but for some reason the environment variable for temp directory in the Bitnami image points to /opt/bitnami/tomcat/temp.\nI decided that this was probably worthy of a separate issue & PR, but looks like I forgot to remove the line. This could still be an acceptable solution but it might be better just to update the environment variable to point to the right directory - i.e. needs to be investigated. I will remove this now.", "author": "ptuomola", "createdAt": "2020-05-05T19:34:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM1MzgyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM1OTMwOQ==", "url": "https://github.com/apache/fineract/pull/807#discussion_r420359309", "bodyText": "Pushed a new commit with this removed", "author": "ptuomola", "createdAt": "2020-05-05T19:39:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM1MzgyNg=="}], "type": "inlineReview"}, {"oid": "61e4d0b57708f3f823a26d146d3cbbbb2db45d53", "url": "https://github.com/apache/fineract/commit/61e4d0b57708f3f823a26d146d3cbbbb2db45d53", "message": "FINERACT-730: Fixed dependencies, SSL config and main class etc to get bootRun to work. Migrated from Gradle Tomcat plugin to Cargo plugin to fix integration test", "committedDate": "2020-05-05T19:37:53Z", "type": "commit"}, {"oid": "61e4d0b57708f3f823a26d146d3cbbbb2db45d53", "url": "https://github.com/apache/fineract/commit/61e4d0b57708f3f823a26d146d3cbbbb2db45d53", "message": "FINERACT-730: Fixed dependencies, SSL config and main class etc to get bootRun to work. Migrated from Gradle Tomcat plugin to Cargo plugin to fix integration test", "committedDate": "2020-05-05T19:37:53Z", "type": "forcePushed"}]}