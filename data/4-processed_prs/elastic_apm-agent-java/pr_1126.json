{"pr_number": 1126, "pr_title": "Fix circuit breaker flaky test (race condition)", "pr_createdAt": "2020-04-07T16:43:54Z", "pr_url": "https://github.com/elastic/apm-agent-java/pull/1126", "timeline": [{"oid": "7e668b4977809a9b49d3286e14d2dfab48917af1", "url": "https://github.com/elastic/apm-agent-java/commit/7e668b4977809a9b49d3286e14d2dfab48917af1", "message": "fix flaky test (tricky race condition)", "committedDate": "2020-04-07T14:15:10Z", "type": "commit"}, {"oid": "fb851638613f0b9dbbe7bfe0b51f5a1f5c5ab9de", "url": "https://github.com/elastic/apm-agent-java/commit/fb851638613f0b9dbbe7bfe0b51f5a1f5c5ab9de", "message": "fix javadoc", "committedDate": "2020-04-07T14:15:39Z", "type": "commit"}, {"oid": "a1e8d25f34de54aa39ed6ff969f7d7e4e99e47b8", "url": "https://github.com/elastic/apm-agent-java/commit/a1e8d25f34de54aa39ed6ff969f7d7e4e99e47b8", "message": "increase test timeout a bit", "committedDate": "2020-04-07T16:40:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk1NzI3Ng==", "url": "https://github.com/elastic/apm-agent-java/pull/1126#discussion_r404957276", "bodyText": "cosmetic change, but makes reading a bit easier.", "author": "SylvainJuge", "createdAt": "2020-04-07T16:44:46Z", "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/impl/ElasticApmTracer.java", "diffHunk": "@@ -636,29 +636,31 @@ synchronized void start(List<LifecycleListener> lifecycleListeners) {\n \n     public synchronized void onStressDetected() {\n         currentlyUnderStress = true;\n-        pause();\n+        if (tracerState == TracerState.RUNNING) {\n+            pause();\n+        }\n     }\n \n     public synchronized void onStressRelieved() {\n         currentlyUnderStress = false;\n-        if (recordingConfigOptionSet) {\n+        if (tracerState == TracerState.PAUSED && recordingConfigOptionSet) {\n             resume();\n         }\n     }\n \n-    private synchronized void recordingConfigChanged(boolean wasRecording, boolean shouldBeRecording) {\n+    private synchronized void recordingConfigChanged(boolean oldValue, boolean newValue) {", "originalCommit": "a1e8d25f34de54aa39ed6ff969f7d7e4e99e47b8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk1OTYzOA==", "url": "https://github.com/elastic/apm-agent-java/pull/1126#discussion_r404959638", "bodyText": "This is the change what fixes the test flakyness, as it will now\n\nwait for all stress monitors to be polled, which will then update tracer state\nwait for all stress monitors to be polled at the beginning of steady paused state.\n\nAs tracer stress status isn't atomic, there is a race condition between \"all stress monitors has been polled\" and \"update tracer stress state\".", "author": "SylvainJuge", "createdAt": "2020-04-07T16:48:21Z", "path": "apm-agent-core/src/test/java/co/elastic/apm/agent/impl/circuitbreaker/CircuitBreakerTest.java", "diffHunk": "@@ -190,10 +190,13 @@ void testPauseThroughConfigThenResumeOnlyWhenStressRelieved() throws IOException\n \n         // 3 stress should keep it paused\n         monitor.simulateStress();\n+        // needs to poll all monitors otherwise tracer state might not be up-to-date within tracer (only updated once polling is over)\n+        assertAllMonitorsPolled(()->{}, monitor);\n         assertSteadyState(this::assertPaused, monitor);", "originalCommit": "a1e8d25f34de54aa39ed6ff969f7d7e4e99e47b8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk2MDI1MA==", "url": "https://github.com/elastic/apm-agent-java/pull/1126#discussion_r404960250", "bodyText": "also, it seems that some failures were due to timeout being too short, a few measurements showed that it sometimes took between 30ms, thus there wasn't a sufficient margin under system load.", "author": "SylvainJuge", "createdAt": "2020-04-07T16:49:12Z", "path": "apm-agent-core/src/test/java/co/elastic/apm/agent/impl/circuitbreaker/CircuitBreakerTest.java", "diffHunk": "@@ -274,7 +281,7 @@ private static void awaitAssert(ThrowingRunnable assertion) {\n     private static ConditionFactory doAwait() {\n         return await()\n             .pollInterval(1, TimeUnit.MILLISECONDS)\n-            .timeout(50, TimeUnit.MILLISECONDS);\n+            .timeout(200, TimeUnit.MILLISECONDS);", "originalCommit": "a1e8d25f34de54aa39ed6ff969f7d7e4e99e47b8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk2MDY0Ng==", "url": "https://github.com/elastic/apm-agent-java/pull/1126#discussion_r404960646", "bodyText": "this change has also already been applied to master directly in the mean time.", "author": "SylvainJuge", "createdAt": "2020-04-07T16:49:45Z", "path": "apm-agent-plugins/apm-grpc/apm-grpc-plugin/src/main/java/co/elastic/apm/agent/grpc/ServerCallListenerInstrumentation.java", "diffHunk": "@@ -42,7 +42,7 @@\n import static net.bytebuddy.matcher.ElementMatchers.named;\n \n /**\n- * Instruments implementations of {@link io.grpc.ServerCall.Listener} for runtime exceptions & transaction activation\n+ * Instruments implementations of {@link io.grpc.ServerCall.Listener} for runtime exceptions and transaction activation", "originalCommit": "a1e8d25f34de54aa39ed6ff969f7d7e4e99e47b8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e568225615ce89da33be2bd33b716a0526910bfd", "url": "https://github.com/elastic/apm-agent-java/commit/e568225615ce89da33be2bd33b716a0526910bfd", "message": "Merge branch 'master' into fix-flaky-circuit-breaker-season-2", "committedDate": "2020-04-09T13:22:14Z", "type": "commit"}]}