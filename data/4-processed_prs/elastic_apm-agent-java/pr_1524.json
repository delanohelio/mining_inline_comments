{"pr_number": 1524, "pr_title": "Fix spring resttemplate 3.0 support", "pr_createdAt": "2020-11-20T16:03:18Z", "pr_url": "https://github.com/elastic/apm-agent-java/pull/1524", "timeline": [{"oid": "3bc4b59343e355aa4b7e806c31f0d05870747083", "url": "https://github.com/elastic/apm-agent-java/commit/3bc4b59343e355aa4b7e806c31f0d05870747083", "message": "fix springgemplate for spring 3.0", "committedDate": "2020-11-20T10:33:15Z", "type": "commit"}, {"oid": "b2521536cb62b23624dd9e8173fe40cda8446c8d", "url": "https://github.com/elastic/apm-agent-java/commit/b2521536cb62b23624dd9e8173fe40cda8446c8d", "message": "fix compatibility with old spring-resttemplate", "committedDate": "2020-11-20T15:41:16Z", "type": "commit"}, {"oid": "f9d5ad610d709dee7a7376f1d020180b1ecf83e3", "url": "https://github.com/elastic/apm-agent-java/commit/f9d5ad610d709dee7a7376f1d020180b1ecf83e3", "message": "junit5-ify", "committedDate": "2020-11-20T15:47:55Z", "type": "commit"}, {"oid": "4e1943d84fa8bd53461e1af43d784cf7eedfe0c1", "url": "https://github.com/elastic/apm-agent-java/commit/4e1943d84fa8bd53461e1af43d784cf7eedfe0c1", "message": "log debug msg & avoid exception on unsupported version", "committedDate": "2020-11-20T15:57:50Z", "type": "commit"}, {"oid": "4c94f6ded5f03ed9915523b9b5371d7b21a25e53", "url": "https://github.com/elastic/apm-agent-java/commit/4c94f6ded5f03ed9915523b9b5371d7b21a25e53", "message": "update changelog", "committedDate": "2020-11-20T16:13:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgwMDgxOQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1524#discussion_r527800819", "bodyText": "Better to make sure we don't instrument Spring RestTemplate < 3.0.3", "author": "felixbarny", "createdAt": "2020-11-20T16:17:50Z", "path": "apm-agent-plugins/apm-spring-resttemplate/apm-spring-restemplate-plugin/src/main/java/co/elastic/apm/agent/resttemplate/SpringRestTemplateAdvice.java", "diffHunk": "@@ -46,11 +47,22 @@\n     @Advice.OnMethodEnter(suppress = Throwable.class, inline = false)\n     public static Object beforeExecute(@Advice.This ClientHttpRequest request) {\n         logger.trace(\"Enter advice for method {}#execute()\", request.getClass().getName());\n-        if (TracerAwareInstrumentation.tracer.getActive() == null) {\n+\n+        final AbstractSpan<?> parent = TracerAwareInstrumentation.tracer.getActive();\n+        if (parent == null) {\n             return null;\n         }\n-        final AbstractSpan<?> parent = TracerAwareInstrumentation.tracer.getActive();\n-        Span span = HttpClientHelper.startHttpClientSpan(parent, Objects.toString(request.getMethod()), request.getURI(), request.getURI().getHost());\n+        URI uri = null;\n+        String host = \"unknown\";\n+        try {\n+            uri = request.getURI();\n+        } catch (NoSuchMethodError ignored) {", "originalCommit": "4c94f6ded5f03ed9915523b9b5371d7b21a25e53", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg0MjkxOQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1524#discussion_r527842919", "bodyText": "fixed in the last commit.", "author": "SylvainJuge", "createdAt": "2020-11-20T17:20:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgwMDgxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgwMTI5MA==", "url": "https://github.com/elastic/apm-agent-java/pull/1524#discussion_r527801290", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            |3.0.6+\n          \n          \n            \n            |3.0.3+", "author": "felixbarny", "createdAt": "2020-11-20T16:18:39Z", "path": "docs/supported-technologies.asciidoc", "diffHunk": "@@ -252,7 +252,7 @@ The spans are named after the schema `<method> <host>`, for example `GET elastic\n | 1.6.0\n \n |Spring RestTemplate\n-|4+\n+|3.0.6+", "originalCommit": "4c94f6ded5f03ed9915523b9b5371d7b21a25e53", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "91a19329a603eb2341e1f07a87fa75694695f2af", "url": "https://github.com/elastic/apm-agent-java/commit/91a19329a603eb2341e1f07a87fa75694695f2af", "message": "Update docs/supported-technologies.asciidoc\n\nCo-authored-by: Felix Barnsteiner <felixbarny@users.noreply.github.com>", "committedDate": "2020-11-20T16:27:00Z", "type": "commit"}, {"oid": "e410eb08f775eb136396075152e62f209688c290", "url": "https://github.com/elastic/apm-agent-java/commit/e410eb08f775eb136396075152e62f209688c290", "message": "only instrument spring 3.0.3+", "committedDate": "2020-11-20T17:19:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUwMzI3MQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1524#discussion_r528503271", "bodyText": "Did you manually test 3.0.0 to see that the agent no-ops and does not throw exceptions?", "author": "felixbarny", "createdAt": "2020-11-23T07:13:55Z", "path": "apm-agent-plugins/apm-spring-resttemplate/apm-spring-resttemplate-test/src/test/java/co.elastic.apm.agent.resttemplate/SpringRestTemplateVersionsIT.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.resttemplate;\n+\n+import co.elastic.apm.agent.TestClassWithDependencyRunner;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.CsvSource;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+public class SpringRestTemplateVersionsIT {\n+\n+    @ParameterizedTest\n+    @CsvSource({\n+        \"3.0.3.RELEASE\", // lower versions are not supported", "originalCommit": "e410eb08f775eb136396075152e62f209688c290", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODYwOTg5Nw==", "url": "https://github.com/elastic/apm-agent-java/pull/1524#discussion_r528609897", "bodyText": "This is now checked with integration test, there is no exception thrown nor visible when executing with unsupported versions.", "author": "SylvainJuge", "createdAt": "2020-11-23T10:41:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUwMzI3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUwNDE2OA==", "url": "https://github.com/elastic/apm-agent-java/pull/1524#discussion_r528504168", "bodyText": "How can we make sure we're always testing against the latest spring version as they get released? Maybe use a version range here or update the spring version via dependabot?", "author": "felixbarny", "createdAt": "2020-11-23T07:16:20Z", "path": "apm-agent-plugins/apm-spring-resttemplate/apm-spring-restemplate-plugin/pom.xml", "diffHunk": "@@ -3,16 +3,16 @@\n     <modelVersion>4.0.0</modelVersion>\n \n     <parent>\n-        <artifactId>apm-agent-plugins</artifactId>\n         <groupId>co.elastic.apm</groupId>\n+        <artifactId>apm-spring-resttemplate</artifactId>\n         <version>1.19.1-SNAPSHOT</version>\n     </parent>\n \n     <artifactId>apm-spring-resttemplate-plugin</artifactId>\n     <name>${project.groupId}:${project.artifactId}</name>\n \n     <properties>\n-        <apm-agent-parent.base.dir>${project.basedir}/../..</apm-agent-parent.base.dir>\n+        <apm-agent-parent.base.dir>${project.basedir}/../../..</apm-agent-parent.base.dir>\n     </properties>\n ", "originalCommit": "e410eb08f775eb136396075152e62f209688c290", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODYxODMzMg==", "url": "https://github.com/elastic/apm-agent-java/pull/1524#discussion_r528618332", "bodyText": "We can use version ranges with Ivy, I've changed the version 5.3.0 in the integration test to use that, and as a result it's currently testing with version 5.3.1.", "author": "SylvainJuge", "createdAt": "2020-11-23T10:55:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUwNDE2OA=="}], "type": "inlineReview"}, {"oid": "e6bfb2c85e8ac3fcd79d07a3c34cdb8f2b562643", "url": "https://github.com/elastic/apm-agent-java/commit/e6bfb2c85e8ac3fcd79d07a3c34cdb8f2b562643", "message": "limit support to Spring 3.1.1+", "committedDate": "2020-11-23T10:25:56Z", "type": "commit"}, {"oid": "449e1c96fc171a134a87aa4991089288a78baee6", "url": "https://github.com/elastic/apm-agent-java/commit/449e1c96fc171a134a87aa4991089288a78baee6", "message": "update documentation", "committedDate": "2020-11-23T10:27:09Z", "type": "commit"}, {"oid": "e200372012bf8bdb8d6f051945023643a1b1b268", "url": "https://github.com/elastic/apm-agent-java/commit/e200372012bf8bdb8d6f051945023643a1b1b268", "message": "javadoc + cleanup", "committedDate": "2020-11-23T10:33:03Z", "type": "commit"}, {"oid": "4ca6bebda3ac7da364ca1b7a74741da6f5022ea1", "url": "https://github.com/elastic/apm-agent-java/commit/4ca6bebda3ac7da364ca1b7a74741da6f5022ea1", "message": "using version range to test latest versions", "committedDate": "2020-11-23T10:54:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQ1MzMzMw==", "url": "https://github.com/elastic/apm-agent-java/pull/1524#discussion_r529453333", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    <module>apm-spring-restemplate-plugin</module>\n          \n          \n            \n                    <module>apm-spring-resttemplate-plugin</module>", "author": "eyalkoren", "createdAt": "2020-11-24T10:56:50Z", "path": "apm-agent-plugins/apm-spring-resttemplate/pom.xml", "diffHunk": "@@ -0,0 +1,24 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <modelVersion>4.0.0</modelVersion>\n+\n+    <parent>\n+        <groupId>co.elastic.apm</groupId>\n+        <artifactId>apm-agent-plugins</artifactId>\n+        <version>1.19.1-SNAPSHOT</version>\n+    </parent>\n+\n+    <artifactId>apm-spring-resttemplate</artifactId>\n+    <name>${project.groupId}:${project.artifactId}</name>\n+    <packaging>pom</packaging>\n+\n+    <properties>\n+        <apm-agent-parent.base.dir>${project.basedir}/../..</apm-agent-parent.base.dir>\n+    </properties>\n+\n+    <modules>\n+        <module>apm-spring-restemplate-plugin</module>", "originalCommit": "4ca6bebda3ac7da364ca1b7a74741da6f5022ea1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c22f76f9babc220f46d8ca1c16929a0ba5f3085f", "url": "https://github.com/elastic/apm-agent-java/commit/c22f76f9babc220f46d8ca1c16929a0ba5f3085f", "message": "naming folders and package is hard", "committedDate": "2020-11-25T08:55:58Z", "type": "commit"}, {"oid": "58941c6185d35603c40293a823ab54ec73d926f5", "url": "https://github.com/elastic/apm-agent-java/commit/58941c6185d35603c40293a823ab54ec73d926f5", "message": "Merge branch 'master' of github.com:elastic/apm-agent-java into fix-springmvc-3.0-support", "committedDate": "2020-11-25T10:53:00Z", "type": "commit"}, {"oid": "fa382c931425710859803355676c04ade20c4871", "url": "https://github.com/elastic/apm-agent-java/commit/fa382c931425710859803355676c04ade20c4871", "message": "Merge branch 'master' of github.com:elastic/apm-agent-java into fix-springmvc-3.0-support", "committedDate": "2020-11-25T13:27:56Z", "type": "commit"}]}