{"pr_number": 1139, "pr_title": "Avoid side-effects of calling Statement.getUpdateCount", "pr_createdAt": "2020-04-14T14:40:23Z", "pr_url": "https://github.com/elastic/apm-agent-java/pull/1139", "timeline": [{"oid": "d7e99e49c9c3f9e49610e94de4e01d73711225fd", "url": "https://github.com/elastic/apm-agent-java/commit/d7e99e49c9c3f9e49610e94de4e01d73711225fd", "message": "make jdbc test compatible with Oracle", "committedDate": "2020-04-14T12:26:09Z", "type": "commit"}, {"oid": "b637487eb399f37ec754fd75d04c2afaa6e3e3ce", "url": "https://github.com/elastic/apm-agent-java/commit/b637487eb399f37ec754fd75d04c2afaa6e3e3ce", "message": "re-enable oracle for jdbc tests", "committedDate": "2020-04-14T12:36:59Z", "type": "commit"}, {"oid": "16846a29f300d63f94b07a71f21c288c1dd447d5", "url": "https://github.com/elastic/apm-agent-java/commit/16846a29f300d63f94b07a71f21c288c1dd447d5", "message": "implement & fix getUpdateCount side effect", "committedDate": "2020-04-14T14:19:46Z", "type": "commit"}, {"oid": "b39d8e687da81e35ae71d9907a872324ebb986e8", "url": "https://github.com/elastic/apm-agent-java/commit/b39d8e687da81e35ae71d9907a872324ebb986e8", "message": "update changelog", "committedDate": "2020-04-14T14:45:34Z", "type": "commit"}, {"oid": "2a4c6dcc5b4cb52b0c95b70309187823d031bcc0", "url": "https://github.com/elastic/apm-agent-java/commit/2a4c6dcc5b4cb52b0c95b70309187823d031bcc0", "message": "disable workaround for idempotent impl.", "committedDate": "2020-04-14T15:43:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE5NDIyMg==", "url": "https://github.com/elastic/apm-agent-java/pull/1139#discussion_r408194222", "bodyText": "Enter advice not needed when moving this to exit advice?", "author": "felixbarny", "createdAt": "2020-04-14T14:45:23Z", "path": "apm-agent-plugins/apm-jdbc-plugin/src/main/java/co/elastic/apm/agent/jdbc/StatementInstrumentation.java", "diffHunk": "@@ -413,4 +411,47 @@ public static void onAfterExecute(@Advice.This Statement statement,\n         }\n \n     }\n+\n+\n+    /**\n+     * Instruments:\n+     * <ul>\n+     *     <li>{@link Statement#getUpdateCount()}</li>\n+     * </ul>\n+     */\n+    public static class GetUpdateCountInstrumentation extends StatementInstrumentation {\n+\n+        public GetUpdateCountInstrumentation(ElasticApmTracer tracer) {\n+            super(tracer,\n+                named(\"getUpdateCount\")\n+                    .and(takesArguments(0))\n+                    .and(isPublic())\n+            );\n+        }\n+\n+        @Advice.OnMethodEnter(suppress = Throwable.class)\n+        private static int onEnter(@Advice.This Statement statement) {", "originalCommit": "16846a29f300d63f94b07a71f21c288c1dd447d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY3NzkxOA==", "url": "https://github.com/elastic/apm-agent-java/pull/1139#discussion_r408677918", "bodyText": "Good point, there would be no difference to move this to the exit advice.\nHowever, we could bypass the original method call when we have a stored value, just in case there are other side-effects of calling getUpdateCount further in the driver or DB implementation.", "author": "SylvainJuge", "createdAt": "2020-04-15T08:42:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE5NDIyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY5NTE4OA==", "url": "https://github.com/elastic/apm-agent-java/pull/1139#discussion_r408695188", "bodyText": "I've finally took the \"move everything to the exit advice\" path, we can still improve this implementation later only if needed, as skipping default method implementation brings some extra complexity, especially on testing side.", "author": "SylvainJuge", "createdAt": "2020-04-15T09:10:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE5NDIyMg=="}], "type": "inlineReview"}, {"oid": "0a31cf1be2641d129fa2ef78c40afe0924b0d460", "url": "https://github.com/elastic/apm-agent-java/commit/0a31cf1be2641d129fa2ef78c40afe0924b0d460", "message": "post-review changes", "committedDate": "2020-04-15T09:08:26Z", "type": "commit"}, {"oid": "f5c53e95210635e8fcc56d4e6e2c3f5713ba1fd9", "url": "https://github.com/elastic/apm-agent-java/commit/f5c53e95210635e8fcc56d4e6e2c3f5713ba1fd9", "message": "Merge branch 'master' into avoid-getUpdateCount-side-effects", "committedDate": "2020-04-16T08:02:41Z", "type": "commit"}]}