{"pr_number": 1593, "pr_title": "Add bootstrap checks", "pr_createdAt": "2020-12-28T11:09:08Z", "pr_url": "https://github.com/elastic/apm-agent-java/pull/1593", "timeline": [{"oid": "3eca9c1326f18a8de57c8a5f819a516075e5e287", "url": "https://github.com/elastic/apm-agent-java/commit/3eca9c1326f18a8de57c8a5f819a516075e5e287", "message": "Add bootstrap check for disabled bytecode verification", "committedDate": "2020-12-27T17:51:56Z", "type": "commit"}, {"oid": "9822de21c599b91e9409aa93aec60bee1f724020", "url": "https://github.com/elastic/apm-agent-java/commit/9822de21c599b91e9409aa93aec60bee1f724020", "message": "Add changelog", "committedDate": "2020-12-28T11:09:46Z", "type": "commit"}, {"oid": "2bbad0e18ea9be5e54dd2b77a16558d24b85ec2b", "url": "https://github.com/elastic/apm-agent-java/commit/2bbad0e18ea9be5e54dd2b77a16558d24b85ec2b", "message": "Fix Javadoc reference", "committedDate": "2020-12-28T11:28:17Z", "type": "commit"}, {"oid": "bc3f5891619fb5cb442344a467fd70c6bc78cdb5", "url": "https://github.com/elastic/apm-agent-java/commit/bc3f5891619fb5cb442344a467fd70c6bc78cdb5", "message": "Merge remote-tracking branch 'origin/master' into noverify-bootstrap-check", "committedDate": "2021-02-11T15:23:48Z", "type": "commit"}, {"oid": "5978db007a50e0491da18746e08bc5e029f9271f", "url": "https://github.com/elastic/apm-agent-java/commit/5978db007a50e0491da18746e08bc5e029f9271f", "message": "Add warning bootstrap checks", "committedDate": "2021-02-11T15:24:14Z", "type": "commit"}, {"oid": "cad4e1b0cd0cc080feb4180cec6d3b2bbffe7b7c", "url": "https://github.com/elastic/apm-agent-java/commit/cad4e1b0cd0cc080feb4180cec6d3b2bbffe7b7c", "message": "Fix test, update changelog", "committedDate": "2021-02-11T15:29:52Z", "type": "commit"}, {"oid": "eba135c2f218d2fab4c6a2eac85dca5fc633dbba", "url": "https://github.com/elastic/apm-agent-java/commit/eba135c2f218d2fab4c6a2eac85dca5fc633dbba", "message": "Merge remote-tracking branch 'origin/master' into noverify-bootstrap-check", "committedDate": "2021-02-11T15:30:39Z", "type": "commit"}, {"oid": "889bcef769031bbea586ce188bd0f6e2b5604199", "url": "https://github.com/elastic/apm-agent-java/commit/889bcef769031bbea586ce188bd0f6e2b5604199", "message": "Fix logic error", "committedDate": "2021-02-15T17:32:25Z", "type": "commit"}, {"oid": "94860f15e49ce6ecfef45e82a7445e336960f820", "url": "https://github.com/elastic/apm-agent-java/commit/94860f15e49ce6ecfef45e82a7445e336960f820", "message": "Fix javadoc error", "committedDate": "2021-02-16T06:41:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDMzODYxMQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1593#discussion_r594338611", "bodyText": "[question] so the current state here is that those JVM versions are not supported out of the box in JavaVersionBootstrapCheck, but just in case the bootstraps checks are disabled we still apply the startup delay.\nWould it make sense to have all those per-version checks all done in JavaVersionBootstrapCheck so that everything that is related to JVM version is within the same class ? (Might be enough as static method though).", "author": "SylvainJuge", "createdAt": "2021-03-15T13:34:46Z", "path": "apm-agent-premain/src/main/java/co/elastic/apm/agent/premain/AgentMain.java", "diffHunk": "@@ -130,12 +108,13 @@ public synchronized static void init(String agentArguments, Instrumentation inst\n      * @return {@code true} for any Java 7 and early Java 8 HotSpot JVMs, {@code false} for all others\n      */\n     static boolean shouldDelayOnPremain() {\n-        int majorVersion = JvmRuntimeInfo.getMajorVersion();\n+        JvmRuntimeInfo runtimeInfo = JvmRuntimeInfo.ofCurrentVM();\n+        int majorVersion = runtimeInfo.getMajorVersion();\n         return\n             (majorVersion == 7) ||\n             // In case bootstrap checks were disabled\n-            (majorVersion == 8 && JvmRuntimeInfo.isHpUx() && JvmRuntimeInfo.getUpdateVersion() < 2) ||\n-            (majorVersion == 8 && JvmRuntimeInfo.isHotSpot() && JvmRuntimeInfo.getUpdateVersion() < 40);\n+            (majorVersion == 8 && runtimeInfo.isHotSpot() && runtimeInfo.getUpdateVersion() < 2) ||\n+            (majorVersion == 8 && runtimeInfo.isHotSpot() && runtimeInfo.getUpdateVersion() < 40);", "originalCommit": "94860f15e49ce6ecfef45e82a7445e336960f820", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDM0MDYwMg==", "url": "https://github.com/elastic/apm-agent-java/pull/1593#discussion_r594340602", "bodyText": "[minor] could probably be made package-private.", "author": "SylvainJuge", "createdAt": "2021-03-15T13:37:15Z", "path": "apm-agent-premain/src/main/java/co/elastic/apm/agent/premain/JavaVersionBootstrapCheck.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.premain;\n+\n+import java.util.List;\n+\n+/**\n+ * Gracefully abort agent startup is better than unexpected failure down the road when we known a given JVM\n+ * version is not supported. Agent might trigger known JVM bugs causing JVM crashes, notably on early Java 8\n+ * versions (but fixed in later versions), given those versions are obsolete and agent can't have workarounds\n+ * for JVM internals, there is no other option but to use an up-to-date JVM instead.\n+ */\n+public class JavaVersionBootstrapCheck implements BootstrapCheck {\n+\n+    private final JvmRuntimeInfo runtimeInfo;\n+\n+    public JavaVersionBootstrapCheck(JvmRuntimeInfo runtimeInfo) {\n+        this.runtimeInfo = runtimeInfo;\n+    }\n+\n+    @Override\n+    public void doBootstrapCheck(BootstrapCheckResult result) {\n+        if (!isJavaVersionSupported()) {\n+            result.addError(String.format(\"JVM version not supported: %s\", runtimeInfo));\n+        }\n+    }\n+\n+    /**\n+     * Checks if a given version of the JVM is likely supported by this agent.\n+     * <br>\n+     * Supports values provided before and after https://openjdk.java.net/jeps/223, in case parsing fails due to an\n+     * unknown version format, we assume it's supported, thus this method might return false positives, but never false\n+     * negatives.\n+     *\n+     * @return true if the version is supported, false otherwise\n+     */\n+    public boolean isJavaVersionSupported() {", "originalCommit": "94860f15e49ce6ecfef45e82a7445e336960f820", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "23754c01d64c38c1eb4e1e0d339da2603bbf9aa3", "url": "https://github.com/elastic/apm-agent-java/commit/23754c01d64c38c1eb4e1e0d339da2603bbf9aa3", "message": "Merge branch 'master' into noverify-bootstrap-check", "committedDate": "2021-03-24T08:51:04Z", "type": "commit"}]}