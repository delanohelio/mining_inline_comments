{"pr_number": 1149, "pr_title": "TLS v1.3 Fallback for JDK bug", "pr_createdAt": "2020-04-21T10:15:44Z", "pr_url": "https://github.com/elastic/apm-agent-java/pull/1149", "timeline": [{"oid": "d83a409751e71c194561b243da68ecbd306878a0", "url": "https://github.com/elastic/apm-agent-java/commit/d83a409751e71c194561b243da68ecbd306878a0", "message": "add fallback for tls 1.3", "committedDate": "2020-04-21T09:27:08Z", "type": "commit"}, {"oid": "c624187998f17542d5eb428f46feb9d99df1eabc", "url": "https://github.com/elastic/apm-agent-java/commit/c624187998f17542d5eb428f46feb9d99df1eabc", "message": "remove java8 API", "committedDate": "2020-04-21T10:00:33Z", "type": "commit"}, {"oid": "9423864c3d9b9aeeade54b610a0ce0bbbbd3f943", "url": "https://github.com/elastic/apm-agent-java/commit/9423864c3d9b9aeeade54b610a0ce0bbbbd3f943", "message": "update changelog", "committedDate": "2020-04-21T10:17:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjY5ODI4Ng==", "url": "https://github.com/elastic/apm-agent-java/pull/1149#discussion_r412698286", "bodyText": "Seems like we're re-triggering this exception for every request to APM Server, right? Could we exclude TLSv1.3 if we know it triggers the bug on the current JVM?", "author": "felixbarny", "createdAt": "2020-04-22T06:14:22Z", "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/report/ssl/TLSFallbackSSLSocket.java", "diffHunk": "@@ -0,0 +1,408 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.report.ssl;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.net.ssl.HandshakeCompletedListener;\n+import javax.net.ssl.SSLHandshakeException;\n+import javax.net.ssl.SSLParameters;\n+import javax.net.ssl.SSLSession;\n+import javax.net.ssl.SSLSocket;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.net.InetAddress;\n+import java.net.Socket;\n+import java.net.SocketAddress;\n+import java.net.SocketException;\n+import java.net.SocketImplFactory;\n+import java.nio.channels.SocketChannel;\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+class TLSFallbackSSLSocket extends SSLSocket {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(TLSFallbackSSLSocket.class);\n+\n+    private static final String TLS_v_1_3 = \"TLSv1.3\";\n+\n+    private final TLSFallbackSSLSocketFactory socketFactory;\n+\n+    private SSLSocket socket;\n+\n+    TLSFallbackSSLSocket(SSLSocket socket, TLSFallbackSSLSocketFactory socketFactory) {\n+        this.socket = socket;\n+        this.socketFactory = socketFactory;\n+    }\n+\n+    @Override\n+    public void startHandshake() throws IOException {\n+\n+        // known JDK bug: JDK-8236039\n+        // automatically fallback to another protocol when triggered\n+        try {\n+            socket.startHandshake();\n+        } catch (SSLHandshakeException e) {\n+\n+            Set<String> enabledProtocols = new HashSet<>(Arrays.asList(socket.getEnabledProtocols()));\n+            if (enabledProtocols.contains(TLS_v_1_3) && e.getMessage().contains(\"should not be presented in\")) {\n+\n+                logger.warn(\"Workaround for JDK Bug JDK-8236039 applied, will connect without TLS v1.3\");", "originalCommit": "9423864c3d9b9aeeade54b610a0ce0bbbbd3f943", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjcyMTEwMA==", "url": "https://github.com/elastic/apm-agent-java/pull/1149#discussion_r412721100", "bodyText": "Maybe also suggest the user what to do when the exception occurs, like updating the JDK, or removing 1.3 for the server's setting (https://www.elastic.co/guide/en/apm/server/current/agent-server-ssl.html#_supported_protocols_2).", "author": "felixbarny", "createdAt": "2020-04-22T06:59:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjY5ODI4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjc2MjQ1OQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1149#discussion_r412762459", "bodyText": "I agree with both comments, having  a single warning is better, and an actionable message is definitely better than having to deal with that in an FAQ somewhere :-).", "author": "SylvainJuge", "createdAt": "2020-04-22T08:03:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjY5ODI4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjc2NjU0Mg==", "url": "https://github.com/elastic/apm-agent-java/pull/1149#discussion_r412766542", "bodyText": "Also, there would be the option to disable TLS 1.3 client side, but that would impact the whole JVM, or provide a configuration for agent, which implies some extra complexity for documentation/support.", "author": "SylvainJuge", "createdAt": "2020-04-22T08:09:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjY5ODI4Ng=="}], "type": "inlineReview"}, {"oid": "e5a057f906f1d634c61e1d9e8a070cd145c6f5ff", "url": "https://github.com/elastic/apm-agent-java/commit/e5a057f906f1d634c61e1d9e8a070cd145c6f5ff", "message": "post-review changes + add tests", "committedDate": "2020-04-22T09:46:21Z", "type": "commit"}, {"oid": "bedbd4e9e5f9fb129145494dd11c144aac14e7a2", "url": "https://github.com/elastic/apm-agent-java/commit/bedbd4e9e5f9fb129145494dd11c144aac14e7a2", "message": "reuse socket factories when possible", "committedDate": "2020-04-22T10:11:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjkxNjkxNw==", "url": "https://github.com/elastic/apm-agent-java/pull/1149#discussion_r412916917", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                logger.warn(\"Workaround for JDK Bug JDK-8236039 applied, will connect without TLS v1.3. Update JRE/JDK to fix this, or disable TLS v1.3 on apm-server as a workaround\");\n          \n          \n            \n                                logger.warn(\"Workaround for JDK Bug JDK-8236039 applied, will connect without TLS v1.3. Update JRE/JDK to fix this, or disable TLS v1.3 on APM Server as a workaround (apm-server.ssl.supported_protocols)\");", "author": "felixbarny", "createdAt": "2020-04-22T11:56:55Z", "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/report/ssl/TLSFallbackSSLSocket.java", "diffHunk": "@@ -0,0 +1,417 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.report.ssl;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.net.ssl.HandshakeCompletedListener;\n+import javax.net.ssl.SSLHandshakeException;\n+import javax.net.ssl.SSLParameters;\n+import javax.net.ssl.SSLSession;\n+import javax.net.ssl.SSLSocket;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.net.InetAddress;\n+import java.net.Socket;\n+import java.net.SocketAddress;\n+import java.net.SocketException;\n+import java.net.SocketImplFactory;\n+import java.nio.channels.SocketChannel;\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+class TLSFallbackSSLSocket extends SSLSocket {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(TLSFallbackSSLSocket.class);\n+\n+    static final String TLS_v_1_3 = \"TLSv1.3\";\n+\n+    private final TLSFallbackSSLSocketFactory socketFactory;\n+\n+    private SSLSocket socket;\n+\n+    TLSFallbackSSLSocket(SSLSocket socket, TLSFallbackSSLSocketFactory socketFactory) {\n+        this.socket = socket;\n+        this.socketFactory = socketFactory;\n+    }\n+\n+    @Override\n+    public void startHandshake() throws IOException {\n+\n+        // known JDK bug: JDK-8236039\n+        // automatically fallback to another protocol when triggered\n+\n+        Set<String> enabledProtocols = new HashSet<>(Arrays.asList(socket.getEnabledProtocols()));\n+        boolean hasTLS13 = enabledProtocols.contains(TLS_v_1_3);\n+        AtomicBoolean skipTLS13 = socketFactory.skipTLS13();\n+        if (hasTLS13 && skipTLS13.get()) {\n+            enabledProtocols.remove(TLS_v_1_3);\n+            socket.setEnabledProtocols(enabledProtocols.toArray(new String[0]));\n+            hasTLS13 = false;\n+        }\n+        try {\n+            socket.startHandshake();\n+        } catch (SSLHandshakeException e) {\n+\n+            if (hasTLS13 && e.getMessage().contains(\"should not be presented in\")) {\n+\n+                boolean hasBeenWarned = skipTLS13.getAndSet(true);\n+                if (!hasBeenWarned) {\n+                    logger.warn(\"Workaround for JDK Bug JDK-8236039 applied, will connect without TLS v1.3. Update JRE/JDK to fix this, or disable TLS v1.3 on apm-server as a workaround\");", "originalCommit": "bedbd4e9e5f9fb129145494dd11c144aac14e7a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjkxNzk4Mw==", "url": "https://github.com/elastic/apm-agent-java/pull/1149#discussion_r412917983", "bodyText": "Why don't we create our own SSLSocketFactory from scratch?", "author": "felixbarny", "createdAt": "2020-04-22T11:58:42Z", "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/report/ApmServerClient.java", "diffHunk": "@@ -121,6 +122,11 @@ private void setServerUrls(List<URL> serverUrls) {\n         return copy;\n     }\n \n+    private static void tlsFallback(HttpsURLConnection connection) {\n+        SSLSocketFactory newFactory = SslUtils.getTLSFallbackSocketFactory(connection.getSSLSocketFactory());", "originalCommit": "bedbd4e9e5f9fb129145494dd11c144aac14e7a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjkyNDAxNA==", "url": "https://github.com/elastic/apm-agent-java/pull/1149#discussion_r412924014", "bodyText": "You mean, why do we wrap the default SSLSocketFactory where we could just have created a new one ?\nFor me that's just a way to make sure that our implementation does not introduce obvious security bugs or unexpected behaviors here. Also, the default implementation is not public thus we can't inherit from it.", "author": "SylvainJuge", "createdAt": "2020-04-22T12:08:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjkxNzk4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjk0OTM5NQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1149#discussion_r412949395", "bodyText": "I mean similar to this: https://gist.github.com/fkrauthan/ac8624466a4dee4fd02f", "author": "felixbarny", "createdAt": "2020-04-22T12:45:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjkxNzk4Mw=="}], "type": "inlineReview"}, {"oid": "20f6e2878e92ae2ebbcfe8a4f6b189dabf122798", "url": "https://github.com/elastic/apm-agent-java/commit/20f6e2878e92ae2ebbcfe8a4f6b189dabf122798", "message": "Update apm-agent-core/src/main/java/co/elastic/apm/agent/report/ssl/TLSFallbackSSLSocket.java\n\nCo-Authored-By: Felix Barnsteiner <felixbarny@users.noreply.github.com>", "committedDate": "2020-04-22T12:03:36Z", "type": "commit"}, {"oid": "f3d187ae0a32ee904a9998b722d47bd2732cd599", "url": "https://github.com/elastic/apm-agent-java/commit/f3d187ae0a32ee904a9998b722d47bd2732cd599", "message": "remove weakmap & simpler factory init", "committedDate": "2020-04-23T08:50:55Z", "type": "commit"}, {"oid": "179edb3ef85f9f825c85f9c03f35db3f5d4cc7d1", "url": "https://github.com/elastic/apm-agent-java/commit/179edb3ef85f9f825c85f9c03f35db3f5d4cc7d1", "message": "Merge branch 'tls13-fallback' of github.com:SylvainJuge/apm-agent-java into tls13-fallback", "committedDate": "2020-04-23T08:52:57Z", "type": "commit"}, {"oid": "493d5d726bbf7daa3bc965a5129384f92706a3a0", "url": "https://github.com/elastic/apm-agent-java/commit/493d5d726bbf7daa3bc965a5129384f92706a3a0", "message": "do not use default factory for testing", "committedDate": "2020-04-23T09:11:23Z", "type": "commit"}, {"oid": "fdb8512c600fb95a9723201939c759fa65152ac2", "url": "https://github.com/elastic/apm-agent-java/commit/fdb8512c600fb95a9723201939c759fa65152ac2", "message": "fix failing test & revert to wrap without map", "committedDate": "2020-04-23T10:03:05Z", "type": "commit"}]}