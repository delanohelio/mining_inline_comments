{"pr_number": 1222, "pr_title": "added capturing of request body in Elasticsearch queries", "pr_createdAt": "2020-06-09T12:12:34Z", "pr_url": "https://github.com/elastic/apm-agent-java/pull/1222", "timeline": [{"oid": "70833403e0e78a3e22339989fe5a238836c7cf7c", "url": "https://github.com/elastic/apm-agent-java/commit/70833403e0e78a3e22339989fe5a238836c7cf7c", "message": "added capturing of request body in Elasticsearch queries: _msesarch, _count, _rollup_search, _msearch/tempalte, _search/template", "committedDate": "2020-06-09T19:09:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg3Njg4Ng==", "url": "https://github.com/elastic/apm-agent-java/pull/1222#discussion_r437876886", "bodyText": "Regex is rather expensive. Better use WildcardMatchers instead. Arrays.asList(WildcardMatcher.valueOf(\"*_search\", ...).\nTo match all, use WildcardMatcher::isAnyMatch", "author": "felixbarny", "createdAt": "2020-06-10T05:57:48Z", "path": "apm-agent-plugins/apm-es-restclient-plugin/apm-es-restclient-plugin-common/src/main/java/co/elastic/apm/agent/es/restclient/ElasticsearchRestClientInstrumentationHelperImpl.java", "diffHunk": "@@ -49,7 +49,7 @@\n \n     private static final Logger logger = LoggerFactory.getLogger(ElasticsearchRestClientInstrumentationHelperImpl.class);\n \n-    public static final String SEARCH_QUERY_PATH_SUFFIX = \"_search\";\n+    public static final String QUERY_REGEXP = \".*_((search|msearch)(\\\\/template)?|count)$\";", "originalCommit": "70833403e0e78a3e22339989fe5a238836c7cf7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzk2NDYwMg==", "url": "https://github.com/elastic/apm-agent-java/pull/1222#discussion_r437964602", "bodyText": "done", "author": "kananindzya", "createdAt": "2020-06-10T08:49:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg3Njg4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg3NzQ5Ng==", "url": "https://github.com/elastic/apm-agent-java/pull/1222#discussion_r437877496", "bodyText": "Please test the different endpoints in different test methods.", "author": "felixbarny", "createdAt": "2020-06-10T05:59:50Z", "path": "apm-agent-plugins/apm-es-restclient-plugin/apm-es-restclient-plugin-6_4/src/test/java/co/elastic/apm/agent/es/restclient/v6_4/AbstractEs6_4ClientInstrumentationTest.java", "diffHunk": "@@ -134,6 +143,99 @@ public void testDocumentScenario() throws Exception {\n         validateDbContextContent(searchSpan, \"{\\\"from\\\":0,\\\"size\\\":5,\\\"query\\\":{\\\"term\\\":{\\\"foo\\\":{\\\"value\\\":\\\"bar\\\",\\\"boost\\\":1.0}}}}\");\n \n         // Now update and re-search\n+        reporter.reset();\n+        // Do CountRequest", "originalCommit": "70833403e0e78a3e22339989fe5a238836c7cf7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzk2NDcwNA==", "url": "https://github.com/elastic/apm-agent-java/pull/1222#discussion_r437964704", "bodyText": "done", "author": "kananindzya", "createdAt": "2020-06-10T08:50:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg3NzQ5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA3OTkzMQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1222#discussion_r438079931", "bodyText": "What I meant was to create multiple @Test annotated methods for each type of query. Better to have multiple simple test cases than one big complex one so that the tests can be executed individually.", "author": "felixbarny", "createdAt": "2020-06-10T12:23:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg3NzQ5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU2MzQzNQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1222#discussion_r438563435", "bodyText": "fixed", "author": "kananindzya", "createdAt": "2020-06-11T06:12:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg3NzQ5Ng=="}], "type": "inlineReview"}, {"oid": "9d29fc4b2eeaac5c603c227f8c0667e32c897074", "url": "https://github.com/elastic/apm-agent-java/commit/9d29fc4b2eeaac5c603c227f8c0667e32c897074", "message": "fixed according to comments", "committedDate": "2020-06-14T19:13:32Z", "type": "forcePushed"}, {"oid": "4b78b8202c8c2417381a7dbc90412fff00e40210", "url": "https://github.com/elastic/apm-agent-java/commit/4b78b8202c8c2417381a7dbc90412fff00e40210", "message": "fixed according to comments", "committedDate": "2020-06-17T11:51:45Z", "type": "forcePushed"}, {"oid": "442960c0f9c094bb9a38ed4f83eddbf6e6bd7257", "url": "https://github.com/elastic/apm-agent-java/commit/442960c0f9c094bb9a38ed4f83eddbf6e6bd7257", "message": "added capturing of request body in Elasticsearch queries: _msesarch, _count, _rollup_search, _msearch/tempalte, _search/template", "committedDate": "2020-06-17T15:19:39Z", "type": "commit"}, {"oid": "2a46761908991c8f5f4a68e56371b69a8210612c", "url": "https://github.com/elastic/apm-agent-java/commit/2a46761908991c8f5f4a68e56371b69a8210612c", "message": "fixed according to comments", "committedDate": "2020-06-17T15:19:39Z", "type": "commit"}, {"oid": "b5dc648b49ad047f819c55a83f307d734be371b9", "url": "https://github.com/elastic/apm-agent-java/commit/b5dc648b49ad047f819c55a83f307d734be371b9", "message": "fixed according to comments", "committedDate": "2020-06-17T15:19:39Z", "type": "commit"}, {"oid": "9b4448541b009c3c3ae55e676411f7fe2cff75d7", "url": "https://github.com/elastic/apm-agent-java/commit/9b4448541b009c3c3ae55e676411f7fe2cff75d7", "message": "fixed changelog", "committedDate": "2020-06-17T15:20:19Z", "type": "commit"}, {"oid": "9b4448541b009c3c3ae55e676411f7fe2cff75d7", "url": "https://github.com/elastic/apm-agent-java/commit/9b4448541b009c3c3ae55e676411f7fe2cff75d7", "message": "fixed changelog", "committedDate": "2020-06-17T15:20:19Z", "type": "forcePushed"}, {"oid": "257ea283a52bcd86cb6f3ec2b044f284229194a4", "url": "https://github.com/elastic/apm-agent-java/commit/257ea283a52bcd86cb6f3ec2b044f284229194a4", "message": "Merge branch 'master' into issue-519-capture-elasticsearch-apis", "committedDate": "2020-06-25T08:30:06Z", "type": "commit"}]}