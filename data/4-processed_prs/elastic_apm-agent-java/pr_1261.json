{"pr_number": 1261, "pr_title": "Dynamic logger ecs reconfig", "pr_createdAt": "2020-06-30T04:47:44Z", "pr_url": "https://github.com/elastic/apm-agent-java/pull/1261", "timeline": [{"oid": "2c11027256053f79e78f1ad1635535e159309e41", "url": "https://github.com/elastic/apm-agent-java/commit/2c11027256053f79e78f1ad1635535e159309e41", "message": "Tail files and notify FileChangeListener", "committedDate": "2020-04-06T14:31:22Z", "type": "commit"}, {"oid": "1ad565608426e923d8c9ed668f59015e10f7ceb1", "url": "https://github.com/elastic/apm-agent-java/commit/1ad565608426e923d8c9ed668f59015e10f7ceb1", "message": "ApmServerLogShipper", "committedDate": "2020-04-07T12:57:49Z", "type": "commit"}, {"oid": "ddd348571f0fc902ff7ce0d7bbeb2b33b3ac2a5d", "url": "https://github.com/elastic/apm-agent-java/commit/ddd348571f0fc902ff7ce0d7bbeb2b33b3ac2a5d", "message": "Use log4j2 and ecs-logging-java as opposed to simple-logger\n\nTail that log and send to APM Server to the not yet existing\n/intake/v2/logs endpoint", "committedDate": "2020-04-08T12:24:14Z", "type": "commit"}, {"oid": "7677cd9c715ca30a6c9165b785c250429d7919ac", "url": "https://github.com/elastic/apm-agent-java/commit/7677cd9c715ca30a6c9165b785c250429d7919ac", "message": "Merge remote-tracking branch 'origin/master' into log-shipper", "committedDate": "2020-04-08T12:24:53Z", "type": "commit"}, {"oid": "38b20b1372f0cb918ee920a216d578a9e373300d", "url": "https://github.com/elastic/apm-agent-java/commit/38b20b1372f0cb918ee920a216d578a9e373300d", "message": "Set service.name and event.dataset in logs", "committedDate": "2020-04-08T13:04:40Z", "type": "commit"}, {"oid": "9a8f954ae969dff538648d410a137e79c78758a4", "url": "https://github.com/elastic/apm-agent-java/commit/9a8f954ae969dff538648d410a137e79c78758a4", "message": "Store and restore persistent state about file position", "committedDate": "2020-04-09T07:38:55Z", "type": "commit"}, {"oid": "13b8a2516d9bf067e2dfc0965f7eef04468f6d61", "url": "https://github.com/elastic/apm-agent-java/commit/13b8a2516d9bf067e2dfc0965f7eef04468f6d61", "message": "Store and restore persistent state about file position", "committedDate": "2020-04-09T14:27:06Z", "type": "commit"}, {"oid": "c23aee7caf4954966b3b0780c64270c06251474a", "url": "https://github.com/elastic/apm-agent-java/commit/c23aee7caf4954966b3b0780c64270c06251474a", "message": "Set rollover policy to size 50M max 2", "committedDate": "2020-04-09T14:27:07Z", "type": "commit"}, {"oid": "60db4435427c6e59ddce114b34df6abd4635ca24", "url": "https://github.com/elastic/apm-agent-java/commit/60db4435427c6e59ddce114b34df6abd4635ca24", "message": "Send file metadata", "committedDate": "2020-04-09T14:27:07Z", "type": "commit"}, {"oid": "52013bbdfa3a48ebbe286d98a0ff45b3ba38abc0", "url": "https://github.com/elastic/apm-agent-java/commit/52013bbdfa3a48ebbe286d98a0ff45b3ba38abc0", "message": "Ack/nak state", "committedDate": "2020-04-11T07:10:32Z", "type": "commit"}, {"oid": "350440e38c1971f80290345d31e6638781c53476", "url": "https://github.com/elastic/apm-agent-java/commit/350440e38c1971f80290345d31e6638781c53476", "message": "Look up file by inode if available", "committedDate": "2020-04-17T07:48:02Z", "type": "commit"}, {"oid": "15bc635a15187c8e4d895ff115605bc758c6018e", "url": "https://github.com/elastic/apm-agent-java/commit/15bc635a15187c8e4d895ff115605bc758c6018e", "message": "Add log_file_max_size option", "committedDate": "2020-04-17T07:48:27Z", "type": "commit"}, {"oid": "225b38971bc00faaa252d82b7f8c421e0dcbc15e", "url": "https://github.com/elastic/apm-agent-java/commit/225b38971bc00faaa252d82b7f8c421e0dcbc15e", "message": "No need to set service.name as it's sent in metadata", "committedDate": "2020-04-17T15:54:14Z", "type": "commit"}, {"oid": "eeb4aeb78100396fa65a4c971ed345f49b5633dc", "url": "https://github.com/elastic/apm-agent-java/commit/eeb4aeb78100396fa65a4c971ed345f49b5633dc", "message": "When logging to sout, ship temp log file", "committedDate": "2020-04-20T06:24:21Z", "type": "commit"}, {"oid": "b7c162ba4b8acb1c66e9ea9d3b748b26c9f031ed", "url": "https://github.com/elastic/apm-agent-java/commit/b7c162ba4b8acb1c66e9ea9d3b748b26c9f031ed", "message": "Merge remote-tracking branch 'origin/master' into log-shipper", "committedDate": "2020-04-20T06:24:46Z", "type": "commit"}, {"oid": "a2549ffc1c5e9dd24188af700423b6ce2bdc2d60", "url": "https://github.com/elastic/apm-agent-java/commit/a2549ffc1c5e9dd24188af700423b6ce2bdc2d60", "message": "Fix tests", "committedDate": "2020-04-22T06:22:49Z", "type": "commit"}, {"oid": "adc6f9d54a6135b7cc2c9d424c914308f2d409c8", "url": "https://github.com/elastic/apm-agent-java/commit/adc6f9d54a6135b7cc2c9d424c914308f2d409c8", "message": "Add shader infrastructure and support for Logback", "committedDate": "2020-04-23T10:48:51Z", "type": "commit"}, {"oid": "fd7eb755af64a6a99bf86b427241708f3d30c733", "url": "https://github.com/elastic/apm-agent-java/commit/fd7eb755af64a6a99bf86b427241708f3d30c733", "message": "Handling logging packages relocation", "committedDate": "2020-04-23T14:27:37Z", "type": "commit"}, {"oid": "9c0f3ba166365c7d5f593d5ba66ea348c9ace8db", "url": "https://github.com/elastic/apm-agent-java/commit/9c0f3ba166365c7d5f593d5ba66ea348c9ace8db", "message": "pom leftover", "committedDate": "2020-04-23T14:30:21Z", "type": "commit"}, {"oid": "1f3111503feb90987cb866a9f3c0875b760c5f86", "url": "https://github.com/elastic/apm-agent-java/commit/1f3111503feb90987cb866a9f3c0875b760c5f86", "message": "Merge remote-tracking branch 'upstream/master' into dynamic-logger-ecs-reconfig", "committedDate": "2020-06-30T04:14:53Z", "type": "commit"}, {"oid": "0c3f3bb3fead546059133d5007b3502da13812c5", "url": "https://github.com/elastic/apm-agent-java/commit/0c3f3bb3fead546059133d5007b3502da13812c5", "message": "fix-merge", "committedDate": "2020-06-30T04:39:59Z", "type": "commit"}, {"oid": "e7b39b7638d4432af674b91d8f7d6082f6740deb", "url": "https://github.com/elastic/apm-agent-java/commit/e7b39b7638d4432af674b91d8f7d6082f6740deb", "message": "Removing stale entries from configuration docs", "committedDate": "2020-06-30T07:18:39Z", "type": "commit"}, {"oid": "023b38dfbf11873145feb374643767a2d3c63b75", "url": "https://github.com/elastic/apm-agent-java/commit/023b38dfbf11873145feb374643767a2d3c63b75", "message": "Merge remote-tracking branch 'upstream/master' into dynamic-logger-ecs-reconfig", "committedDate": "2020-07-05T07:57:25Z", "type": "commit"}, {"oid": "4a4da402a43ba45363894ef74cc67a25bd7c2647", "url": "https://github.com/elastic/apm-agent-java/commit/4a4da402a43ba45363894ef74cc67a25bd7c2647", "message": "Update configuration.asciidoc", "committedDate": "2020-07-05T12:34:10Z", "type": "commit"}, {"oid": "fd3c98acfa1acd2799b91efdde8eefaab4b6e12c", "url": "https://github.com/elastic/apm-agent-java/commit/fd3c98acfa1acd2799b91efdde8eefaab4b6e12c", "message": "Add Logback ECS reformatting testing", "committedDate": "2020-07-05T15:04:51Z", "type": "commit"}, {"oid": "955a59576b5a374c80067e1e6467a5ea1f55392c", "url": "https://github.com/elastic/apm-agent-java/commit/955a59576b5a374c80067e1e6467a5ea1f55392c", "message": "Merge remote-tracking branch 'upstream/master' into dynamic-logger-ecs-reconfig", "committedDate": "2020-07-07T04:21:53Z", "type": "commit"}, {"oid": "c6b5292ec4848e40b3cee2ee9a3240af01f08a25", "url": "https://github.com/elastic/apm-agent-java/commit/c6b5292ec4848e40b3cee2ee9a3240af01f08a25", "message": "Add Log4j2", "committedDate": "2020-07-07T13:22:11Z", "type": "commit"}, {"oid": "2abc2e3bed679527253a7bcad6dfc6a3767914fe", "url": "https://github.com/elastic/apm-agent-java/commit/2abc2e3bed679527253a7bcad6dfc6a3767914fe", "message": "Making Log4j2 instrumentation suitable for 2.10.0+", "committedDate": "2020-07-08T13:30:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTYyNDc2Mg==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r451624762", "bodyText": "Use the new WeakMapSupplier.createMap(). Also, maybe type to <A, Object>?", "author": "felixbarny", "createdAt": "2020-07-08T15:16:35Z", "path": "apm-agent-plugins/apm-log-shader-plugin/src/main/java/co/elastic/apm/agent/log/shader/AbstractLogShadingHelper.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.log.shader;\n+\n+import co.elastic.apm.agent.configuration.CoreConfiguration;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+import com.blogspot.mydailyjava.weaklockfree.WeakConcurrentMap;\n+\n+import javax.annotation.Nullable;\n+\n+/**\n+ * The abstract Log shading helper- loaded as part of the agent core (agent CL / bootstrap CL / System CL)\n+ *\n+ * @param <A> logging-framework-specific Appender type\n+ */\n+public abstract class AbstractLogShadingHelper<A> {\n+\n+    private static final Object NULL_APPENDER = new Object();\n+\n+    private final ElasticApmTracer tracer;\n+    private final LoggingConfiguration loggingConfiguration;\n+    private final String serviceName;\n+\n+    public AbstractLogShadingHelper(ElasticApmTracer tracer) {\n+        this.tracer = tracer;\n+        loggingConfiguration = tracer.getConfig(LoggingConfiguration.class);\n+        serviceName = tracer.getConfig(CoreConfiguration.class).getServiceName();\n+    }\n+\n+    private static final WeakConcurrentMap<Object, Object> appenderToShadeAppender = new WeakConcurrentMap.WithInlinedExpunction<Object, Object>();", "originalCommit": "2abc2e3bed679527253a7bcad6dfc6a3767914fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU3MjU3Ng==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r461572576", "bodyText": "Changed to the new sdk API.\nAs for typing - this is a static map, so I cannot type to an instance generic type", "author": "eyalkoren", "createdAt": "2020-07-28T13:19:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTYyNDc2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTYyODYxMg==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r451628612", "bodyText": "you could do tracer.getMetaData().getService().getName()", "author": "felixbarny", "createdAt": "2020-07-08T15:21:57Z", "path": "apm-agent-plugins/apm-log-shader-plugin/src/main/java/co/elastic/apm/agent/log/shader/AbstractLogShadingHelper.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.log.shader;\n+\n+import co.elastic.apm.agent.configuration.CoreConfiguration;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+import com.blogspot.mydailyjava.weaklockfree.WeakConcurrentMap;\n+\n+import javax.annotation.Nullable;\n+\n+/**\n+ * The abstract Log shading helper- loaded as part of the agent core (agent CL / bootstrap CL / System CL)\n+ *\n+ * @param <A> logging-framework-specific Appender type\n+ */\n+public abstract class AbstractLogShadingHelper<A> {\n+\n+    private static final Object NULL_APPENDER = new Object();\n+\n+    private final ElasticApmTracer tracer;\n+    private final LoggingConfiguration loggingConfiguration;\n+    private final String serviceName;\n+\n+    public AbstractLogShadingHelper(ElasticApmTracer tracer) {\n+        this.tracer = tracer;\n+        loggingConfiguration = tracer.getConfig(LoggingConfiguration.class);\n+        serviceName = tracer.getConfig(CoreConfiguration.class).getServiceName();\n+    }\n+\n+    private static final WeakConcurrentMap<Object, Object> appenderToShadeAppender = new WeakConcurrentMap.WithInlinedExpunction<Object, Object>();\n+\n+    @Nullable\n+    public A getOrCreateShadeAppenderFor(A originalAppender) {\n+        if (isShadingAppender(originalAppender)) {\n+            return null;\n+        }\n+\n+        Object shadeAppender = appenderToShadeAppender.get(originalAppender);\n+        if (shadeAppender == null) {\n+            synchronized (appenderToShadeAppender) {\n+                if (!appenderToShadeAppender.containsKey(originalAppender)) {\n+                    A createdAppender = createAndConfigureAppender(originalAppender);\n+                    appenderToShadeAppender.put(originalAppender, createdAppender != null ? createdAppender : NULL_APPENDER);\n+                }\n+            }\n+            shadeAppender = appenderToShadeAppender.get(originalAppender);\n+        }\n+        return shadeAppender != NULL_APPENDER ? (A) shadeAppender : null;\n+    }\n+\n+    public void stopShading(A originalAppender) {\n+        synchronized (appenderToShadeAppender) {\n+            Object shadeAppender = appenderToShadeAppender.remove(originalAppender);\n+            if (shadeAppender != null) {\n+                closeShadeAppender((A) shadeAppender);\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Checks whether the given appender is a shading appender, so to avoid recursive shading\n+     * @return true if the provide appender is a shading appender; false otherwise\n+     */\n+    protected abstract boolean isShadingAppender(A appender);\n+\n+    @Nullable\n+    protected abstract A createAndConfigureAppender(A originalAppender);\n+\n+    // todo: find more accurate service name", "originalCommit": "2abc2e3bed679527253a7bcad6dfc6a3767914fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA4Mzg2Mw==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r462083863", "bodyText": "I used that, but what I was really looking for is a way to capture the actual service name of the relevant context. The problem is that ECS-lib layouts store the service name statically.\nWhat do you think of adding a way to register a ServiceNameProvider#getServiceName callback to the ECS layout that will be called when the logging event is serialized?", "author": "eyalkoren", "createdAt": "2020-07-29T07:06:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTYyODYxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEzNTk4Mw==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r462135983", "bodyText": "Actually, I think we don't need to set the service name on the ECS logger implementation. When sending the logs to APM Server, we're already sending it as part of the metadata: https://github.com/elastic/apm/blob/f5a3dbfd9bc731bbe6b920f31b4f9cd611cfb70d/docs/agents/log-shipper.md#metadata", "author": "felixbarny", "createdAt": "2020-07-29T08:40:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTYyODYxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE0OTI1MA==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r462149250", "bodyText": "When log correlation is on, the log events should have the right context - they will contain a trace.id and transcation.id that we may report separately with a different service name", "author": "eyalkoren", "createdAt": "2020-07-29T09:01:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTYyODYxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTYzMTM3MA==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r451631370", "bodyText": "have you considered migrating to indy plugins?", "author": "felixbarny", "createdAt": "2020-07-08T15:25:52Z", "path": "apm-agent-plugins/apm-log-shader-plugin/src/main/java/co/elastic/apm/agent/log/shader/log4j2/Log4j2LogShadingInstrumentation.java", "diffHunk": "@@ -0,0 +1,155 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.log.shader.log4j2;\n+\n+import co.elastic.apm.agent.bci.HelperClassManager;\n+import co.elastic.apm.agent.bci.VisibleForAdvice;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.log.shader.AbstractLogShadingHelper;\n+import co.elastic.apm.agent.log.shader.AbstractLogShadingInstrumentation;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.implementation.bytecode.assign.Assigner;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import org.apache.logging.log4j.core.LogEvent;\n+import org.apache.logging.log4j.core.appender.AbstractOutputStreamAppender;\n+import org.apache.logging.log4j.core.appender.FileAppender;\n+\n+import javax.annotation.Nullable;\n+import java.util.Collection;\n+\n+import static co.elastic.apm.agent.bci.bytebuddy.CustomElementMatchers.classLoaderCanLoadClass;\n+import static net.bytebuddy.matcher.ElementMatchers.isBootstrapClassLoader;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.not;\n+import static net.bytebuddy.matcher.ElementMatchers.takesArgument;\n+import static net.bytebuddy.matcher.ElementMatchers.takesArguments;\n+\n+public abstract class Log4j2LogShadingInstrumentation extends AbstractLogShadingInstrumentation {\n+\n+    // Logback class referencing is allowed thanks to type erasure\n+    @VisibleForAdvice\n+    @Nullable\n+    public static HelperClassManager<AbstractLogShadingHelper<AbstractOutputStreamAppender<?>>> helperClassManager;", "originalCommit": "2abc2e3bed679527253a7bcad6dfc6a3767914fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU3NDgxNA==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r461574814", "bodyText": "Yes, I assume I will migrate to that before I un-draft it", "author": "eyalkoren", "createdAt": "2020-07-28T13:22:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTYzMTM3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTYzNzkwMQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r451637901", "bodyText": "Although this makes it more readable it probably has to be set to false so it works with the logs intake API which is currently spec'd to assume ND-JSON", "author": "felixbarny", "createdAt": "2020-07-08T15:35:12Z", "path": "apm-agent-plugins/apm-log-shader-plugin/src/main/java/co/elastic/apm/agent/log/shader/log4j2/helper/Log4j2LogShadingHelper.java", "diffHunk": "@@ -0,0 +1,122 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.log.shader.log4j2.helper;\n+\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.log.shader.AbstractLogShadingHelper;\n+import co.elastic.apm.agent.log.shader.Utils;\n+import co.elastic.logging.log4j2.EcsLayout;\n+import org.apache.logging.log4j.core.appender.AbstractOutputStreamAppender;\n+import org.apache.logging.log4j.core.appender.RollingRandomAccessFileAppender;\n+import org.apache.logging.log4j.core.appender.rolling.DefaultRolloverStrategy;\n+import org.apache.logging.log4j.core.appender.rolling.RolloverStrategy;\n+import org.apache.logging.log4j.core.appender.rolling.SizeBasedTriggeringPolicy;\n+import org.apache.logging.log4j.core.appender.rolling.TriggeringPolicy;\n+import org.apache.logging.log4j.core.config.DefaultConfiguration;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.annotation.Nullable;\n+import java.lang.reflect.Method;\n+\n+\n+public class Log4j2LogShadingHelper extends AbstractLogShadingHelper<AbstractOutputStreamAppender<?>> {\n+\n+    public static final String ECS_SHADE_APPENDER = \"EcsShadeAppender\";\n+\n+    private static final Logger logger = LoggerFactory.getLogger(Log4j2LogShadingHelper.class);\n+\n+    public Log4j2LogShadingHelper(ElasticApmTracer tracer) {\n+        super(tracer);\n+    }\n+\n+    @Override\n+    protected boolean isShadingAppender(AbstractOutputStreamAppender<?> appender) {\n+        //noinspection StringEquality\n+        return appender.getName() == ECS_SHADE_APPENDER;\n+    }\n+\n+    @Override\n+    @Nullable\n+    protected AbstractOutputStreamAppender<?> createAndConfigureAppender(AbstractOutputStreamAppender<?> originalAppender) {\n+\n+        String logFile = null;\n+\n+        // Using class names and reflection in order to avoid version sensitivity\n+        String appenderClassName = originalAppender.getClass().getName();\n+        if (appenderClassName.equals(\"org.apache.logging.log4j.core.appender.FileAppender\") ||\n+            appenderClassName.equals(\"org.apache.logging.log4j.core.appender.RollingFileAppender\") ||\n+            appenderClassName.equals(\"org.apache.logging.log4j.core.appender.RandomAccessFileAppender\") ||\n+            appenderClassName.equals(\"org.apache.logging.log4j.core.appender.RollingRandomAccessFileAppender\") ||\n+            appenderClassName.equals(\"org.apache.logging.log4j.core.appender.MemoryMappedFileAppender\")) {\n+            try {\n+                Method getFileNameMethod = originalAppender.getClass().getDeclaredMethod(\"getFileName\");\n+                logFile = (String) getFileNameMethod.invoke(originalAppender);\n+            } catch (Exception e) {\n+                logger.error(\"Failed to obtain log file name from file appender\", e);\n+            }\n+        }\n+\n+        if (logFile == null) {\n+            return null;\n+        }\n+\n+        String shadeFile = Utils.computeShadeLogFilePath(logFile);\n+\n+        EcsLayout ecsLayout = EcsLayout.newBuilder()\n+            .setServiceName(getServiceName())\n+            .setIncludeMarkers(false)\n+            .setIncludeOrigin(false)\n+            .setStackTraceAsArray(true)", "originalCommit": "2abc2e3bed679527253a7bcad6dfc6a3767914fe", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTYzODI0MA==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r451638240", "bodyText": "probably better to set to false, see above", "author": "felixbarny", "createdAt": "2020-07-08T15:35:38Z", "path": "apm-agent-plugins/apm-log-shader-plugin/src/main/java/co/elastic/apm/agent/log/shader/logback/helper/LogbackLogShadingHelper.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.log.shader.logback.helper;\n+\n+import ch.qos.logback.classic.LoggerContext;\n+import ch.qos.logback.classic.spi.ILoggingEvent;\n+import ch.qos.logback.core.FileAppender;\n+import ch.qos.logback.core.rolling.FixedWindowRollingPolicy;\n+import ch.qos.logback.core.rolling.RollingFileAppender;\n+import ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy;\n+import ch.qos.logback.core.util.FileSize;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.log.shader.AbstractLogShadingHelper;\n+import co.elastic.apm.agent.log.shader.Utils;\n+import co.elastic.logging.logback.EcsEncoder;\n+\n+public class LogbackLogShadingHelper extends AbstractLogShadingHelper<FileAppender<ILoggingEvent>> {\n+\n+    private static final LoggerContext defaultLoggerContext = new LoggerContext();;\n+\n+    public LogbackLogShadingHelper(ElasticApmTracer tracer) {\n+        super(tracer);\n+    }\n+\n+    @Override\n+    protected boolean isShadingAppender(FileAppender<ILoggingEvent> appender) {\n+        return appender.getContext() == defaultLoggerContext;\n+    }\n+\n+    @Override\n+    protected FileAppender<ILoggingEvent> createAndConfigureAppender(FileAppender<ILoggingEvent> originalAppender) {\n+        RollingFileAppender<ILoggingEvent> shadeAppender = new RollingFileAppender<>();\n+        String shadeFile = Utils.computeShadeLogFilePath(originalAppender.getFile());\n+        shadeAppender.setFile(shadeFile);\n+\n+        EcsEncoder ecsEncoder = new EcsEncoder();\n+        ecsEncoder.setServiceName(getServiceName());\n+        // todo read from configuration??\n+        ecsEncoder.setIncludeMarkers(false);\n+        ecsEncoder.setIncludeOrigin(false);\n+        ecsEncoder.setStackTraceAsArray(true);", "originalCommit": "2abc2e3bed679527253a7bcad6dfc6a3767914fe", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "887cd5852605ac4ffc2a54f056befe2729888f85", "url": "https://github.com/elastic/apm-agent-java/commit/887cd5852605ac4ffc2a54f056befe2729888f85", "message": "Merge remote-tracking branch 'upstream/master' into dynamic-logger-ecs-reconfig", "committedDate": "2020-07-28T05:51:47Z", "type": "commit"}, {"oid": "f024fe1eddb7e44b3e4ea74a8b572f3a8ce6a736", "url": "https://github.com/elastic/apm-agent-java/commit/f024fe1eddb7e44b3e4ea74a8b572f3a8ce6a736", "message": "Merge remote-tracking branch 'upstream/master' into dynamic-logger-ecs-reconfig", "committedDate": "2020-07-30T02:06:29Z", "type": "commit"}, {"oid": "902b859d62769737709981a4914a75dc8f67ab48", "url": "https://github.com/elastic/apm-agent-java/commit/902b859d62769737709981a4914a75dc8f67ab48", "message": "Add support for log4j 1", "committedDate": "2020-07-30T02:31:33Z", "type": "commit"}, {"oid": "75086b63a7e28bba0bc12fc1445578e31ab244a1", "url": "https://github.com/elastic/apm-agent-java/commit/75086b63a7e28bba0bc12fc1445578e31ab244a1", "message": "Updated configuration.asciidoc", "committedDate": "2020-07-30T05:25:31Z", "type": "commit"}, {"oid": "8d1edadc10b6fe0c7a42e0e864e95ef1c65c98f2", "url": "https://github.com/elastic/apm-agent-java/commit/8d1edadc10b6fe0c7a42e0e864e95ef1c65c98f2", "message": "Merge remote-tracking branch 'upstream/master' into dynamic-logger-ecs-reconfig", "committedDate": "2020-08-23T07:39:13Z", "type": "commit"}, {"oid": "7eb64bad3eaf7eeb7a859938f3f65fa3c9b7e8d1", "url": "https://github.com/elastic/apm-agent-java/commit/7eb64bad3eaf7eeb7a859938f3f65fa3c9b7e8d1", "message": "Refactoring to Indy plugin and usage of new SDK APIs", "committedDate": "2020-08-23T14:14:05Z", "type": "commit"}, {"oid": "66a1e0dad97167ef70d220519fb2c27426afaea7", "url": "https://github.com/elastic/apm-agent-java/commit/66a1e0dad97167ef70d220519fb2c27426afaea7", "message": "Splitting plugin to modules", "committedDate": "2020-08-24T17:50:31Z", "type": "commit"}, {"oid": "32161b59ae6fb4c1a376916ae25a91c1c9d96833", "url": "https://github.com/elastic/apm-agent-java/commit/32161b59ae6fb4c1a376916ae25a91c1c9d96833", "message": "Fixing ECS shading", "committedDate": "2020-09-02T15:43:03Z", "type": "commit"}, {"oid": "b071aa315919beb2cc5b8ca97a7f8e742345b347", "url": "https://github.com/elastic/apm-agent-java/commit/b071aa315919beb2cc5b8ca97a7f8e742345b347", "message": "Merge remote-tracking branch 'upstream/master' into dynamic-logger-ecs-reconfig", "committedDate": "2020-09-13T07:43:33Z", "type": "commit"}, {"oid": "c58a5ce48fe625b6d7111fd35b24d4b146c7c32e", "url": "https://github.com/elastic/apm-agent-java/commit/c58a5ce48fe625b6d7111fd35b24d4b146c7c32e", "message": "Updating agent versions", "committedDate": "2020-09-13T10:14:59Z", "type": "commit"}, {"oid": "f00d6cc5fe060a09a8594ff9f62e7d9289449636", "url": "https://github.com/elastic/apm-agent-java/commit/f00d6cc5fe060a09a8594ff9f62e7d9289449636", "message": "Remove ThreadLocal delegator", "committedDate": "2020-09-14T09:39:49Z", "type": "commit"}, {"oid": "5b79cf6c97570325427d490ceed95c2fba0b13eb", "url": "https://github.com/elastic/apm-agent-java/commit/5b79cf6c97570325427d490ceed95c2fba0b13eb", "message": "Adding config options and tests", "committedDate": "2020-09-14T16:50:08Z", "type": "commit"}, {"oid": "40e0a7c8f3e61750e9ffd4beaa6f32e9dcd9491d", "url": "https://github.com/elastic/apm-agent-java/commit/40e0a7c8f3e61750e9ffd4beaa6f32e9dcd9491d", "message": "Updating configuration.asciidoc", "committedDate": "2020-09-16T07:13:50Z", "type": "commit"}, {"oid": "60d8f36a8e58b4235d375831c25d6e2381cfdcbf", "url": "https://github.com/elastic/apm-agent-java/commit/60d8f36a8e58b4235d375831c25d6e2381cfdcbf", "message": "Merge remote-tracking branch 'upstream/master' into dynamic-logger-ecs-reconfig", "committedDate": "2020-09-16T07:21:47Z", "type": "commit"}, {"oid": "333ded80587f58ffd2f4d66d23e0408b647f3ab2", "url": "https://github.com/elastic/apm-agent-java/commit/333ded80587f58ffd2f4d66d23e0408b647f3ab2", "message": "Config option changes and tests", "committedDate": "2020-09-16T12:54:04Z", "type": "commit"}, {"oid": "6a1830968b8f2a3cb80f6fbb5227cc76057b896e", "url": "https://github.com/elastic/apm-agent-java/commit/6a1830968b8f2a3cb80f6fbb5227cc76057b896e", "message": "Finalizing shade log rolling (disabled by default)", "committedDate": "2020-09-16T13:27:48Z", "type": "commit"}, {"oid": "8c20c59a3e2f5733e885cecd8a969255bbe03210", "url": "https://github.com/elastic/apm-agent-java/commit/8c20c59a3e2f5733e885cecd8a969255bbe03210", "message": "Fixing docs link", "committedDate": "2020-09-16T13:41:56Z", "type": "commit"}, {"oid": "e9b1286abc62cfc54f182366e6099a958778ad3c", "url": "https://github.com/elastic/apm-agent-java/commit/e9b1286abc62cfc54f182366e6099a958778ad3c", "message": "Merge remote-tracking branch 'upstream/master' into dynamic-logger-ecs-reconfig", "committedDate": "2020-10-18T08:36:35Z", "type": "commit"}, {"oid": "6943fa4ff9253dfdcaf0f232f76cdc4c6c59be09", "url": "https://github.com/elastic/apm-agent-java/commit/6943fa4ff9253dfdcaf0f232f76cdc4c6c59be09", "message": "Update version", "committedDate": "2020-10-18T08:56:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI4Mzc5NA==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r540283794", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        <version>0.4.0</version>\n          \n          \n            \n                        <version>1.0.0.RC1</version>", "author": "felixbarny", "createdAt": "2020-12-10T15:55:27Z", "path": "apm-agent-core/pom.xml", "diffHunk": "@@ -53,7 +53,7 @@\n         <dependency>\n             <groupId>co.elastic.logging</groupId>\n             <artifactId>log4j2-ecs-layout</artifactId>\n-            <version>0.3.0</version>\n+            <version>0.4.0</version>", "originalCommit": "6943fa4ff9253dfdcaf0f232f76cdc4c6c59be09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM3NzU2Nw==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r544377567", "bodyText": "This overlaps/conflicts with elastic/apm#373 as the replacement should not only happen for file appenders but for any appenders that use a plain-text formatter.\nWe might have to do that at the time the formatter is set on the appender as we need the appender name to set the event.dataset (${service.name}.${appender.name}). This implies that it would not work for runtime attachment. But I think that's fair as it ensures that there's no mix of plain-text and JSON logs.", "author": "felixbarny", "createdAt": "2020-12-16T15:12:04Z", "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/logging/LoggingConfiguration.java", "diffHunk": "@@ -159,8 +159,38 @@ public void assertValid(Boolean value) {\n         })\n         .buildWithDefault(false);\n \n+    private final ConfigurationOption<Boolean> logShadingEnabled = ConfigurationOption.booleanOption()\n+        .key(\"log_shading_enabled\")\n+        .configurationCategory(LOGGING_CATEGORY)\n+        .description(\"A boolean specifying whether the agent should automatically reformat application logs \\n\" +\n+            \"into ECS-compatible JSON files, suitable for ingestion into Elasticsearch for further analysis. \\n\" +\n+            \"If true, check out additional `log_shading` configurations options.\")\n+        .dynamic(true)\n+        .buildWithDefault(true);\n+\n+    private final ConfigurationOption<Boolean> logShadingReplace = ConfigurationOption.booleanOption()\n+        .key(\"log_shading_replace\")\n+        .configurationCategory(LOGGING_CATEGORY)\n+        .tags(\"performance\")\n+        .description(\"By default, when Log Shading is enabled, application logs will be duplicated so that the \\n\" +\n+            \"ECS-formatted logs are written to new files having the `.ecs.json` extension. In order to reduce the \\n\" +\n+            \"related overhead, set this option to true to replace the original log files with the ECS-compatible ones.\")\n+        .dynamic(false)\n+        .buildWithDefault(false);", "originalCommit": "6943fa4ff9253dfdcaf0f232f76cdc4c6c59be09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3OTk4ODI0NQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r579988245", "bodyText": "We decided on using a new config option called log_ecs_reformatting that will have multiple options:\n\nOFF\nSHADE - writing to an additional file in ECS format\nREPLACE - reformat to ECS like SHADE, but block writing the original log file\nOVERRIDE - use the same logger output stream, but override with ECS formatting (the option you are referring to, which will be relevant to non-file-appenders as well)\n\nThis way they will not overlap or conflict.", "author": "eyalkoren", "createdAt": "2021-02-22T05:12:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM3NzU2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM3ODM0Nw==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r544378347", "bodyText": "Let's make it clear in the docs that log shading is experimental and may be removed in future releases and that we recommend replacing the plain-text formatters with ECS formatters (elastic/apm#373).\nShould we make the log shading options internal?", "author": "felixbarny", "createdAt": "2020-12-16T15:12:56Z", "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/logging/LoggingConfiguration.java", "diffHunk": "@@ -159,8 +159,38 @@ public void assertValid(Boolean value) {\n         })\n         .buildWithDefault(false);\n \n+    private final ConfigurationOption<Boolean> logShadingEnabled = ConfigurationOption.booleanOption()", "originalCommit": "6943fa4ff9253dfdcaf0f232f76cdc4c6c59be09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3OTk4OTM0OA==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r579989348", "bodyText": "The new log_ecs_reformatting config will be marked experimental, so it will give us time to gather feedback on how useful these options are without worrying about removing them in the future.\nMy next task in this area will be the addition of the OVERRIDE option, where I can add a note that it is preferred if we decide so.", "author": "eyalkoren", "createdAt": "2021-02-22T05:16:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM3ODM0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM4NDYzMA==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r544384630", "bodyText": "An idea to make the test faster\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                     sleep();\n          \n          \n            \n                     await().untilAsserted(() -> new File(getShadeLogFilePath()).length() == 0);", "author": "felixbarny", "createdAt": "2020-12-16T15:20:37Z", "path": "apm-agent-plugins/apm-log-shader-plugin/apm-log-shader-plugin-common/src/test/java/co/elastic/apm/agent/log/shader/LogShadingInstrumentationTest.java", "diffHunk": "@@ -0,0 +1,241 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.log.shader;\n+\n+import co.elastic.apm.agent.AbstractInstrumentationTest;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.text.ParseException;\n+import java.text.SimpleDateFormat;\n+import java.util.ArrayList;\n+import java.util.Date;\n+import java.util.TimeZone;\n+import java.util.UUID;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.when;\n+\n+public abstract class LogShadingInstrumentationTest extends AbstractInstrumentationTest {\n+\n+    public static final String TRACE_MESSAGE = \"Trace-this\";\n+    public static final String DEBUG_MESSAGE = \"Debug-this\";\n+    public static final String WARN_MESSAGE = \"Warn-this\";\n+    public static final String ERROR_MESSAGE = \"Error-this\";\n+\n+    private final LoggerFacade logger;\n+    private ObjectMapper objectMapper;\n+\n+    public LogShadingInstrumentationTest() {\n+        logger = getLoggerFacade();\n+        objectMapper = new ObjectMapper();\n+    }\n+\n+    @Before\n+    public void setup() throws IOException {\n+        logger.open();\n+        Files.deleteIfExists(Paths.get(getShadeLogFilePath()));\n+    }\n+\n+    @After\n+    public void closeLogger() {\n+        logger.close();\n+    }\n+\n+    protected abstract LoggerFacade getLoggerFacade();\n+\n+    @Test\n+    public void testSimpleLogShading() throws IOException, ParseException {\n+        String traceId = UUID.randomUUID().toString();\n+        logger.putTraceIdToMdc(traceId);\n+        try {\n+            logger.trace(TRACE_MESSAGE);\n+            logger.debug(DEBUG_MESSAGE);\n+            logger.warn(WARN_MESSAGE);\n+            logger.error(ERROR_MESSAGE);\n+        } finally {\n+            logger.removeTraceIdFromMdc();\n+        }\n+\n+        ArrayList<String[]> rawLogLines = readRawLogLines();\n+        assertThat(rawLogLines).hasSize(4);\n+\n+        ArrayList<JsonNode> ecsLogLines = readShadeLogFile();\n+        assertThat(ecsLogLines).hasSize(4);\n+\n+        for (int i = 0; i < 4; i++) {\n+            verifyEcsFormat(rawLogLines.get(i), ecsLogLines.get(i), traceId);\n+        }\n+    }\n+\n+    @Test\n+    public void testShadingIntoConfiguredDir() throws IOException, ParseException {\n+        when(config.getConfig(LoggingConfiguration.class).getLogShadingDestinationDir()).thenReturn(\"shade_logs\");\n+        Files.deleteIfExists(Paths.get(getShadeLogFilePath()));\n+        testSimpleLogShading();\n+    }\n+\n+    @Test\n+    public void testLogShadingDisabled() throws IOException, ParseException {\n+        logger.trace(TRACE_MESSAGE);\n+        when(config.getConfig(LoggingConfiguration.class).isLogShadingEnabled()).thenReturn(false);\n+        logger.debug(DEBUG_MESSAGE);\n+        logger.warn(WARN_MESSAGE);\n+        when(config.getConfig(LoggingConfiguration.class).isLogShadingEnabled()).thenReturn(true);\n+        logger.error(ERROR_MESSAGE);\n+\n+        ArrayList<String[]> rawLogLines = readRawLogLines();\n+        assertThat(rawLogLines).hasSize(4);\n+\n+        ArrayList<JsonNode> ecsLogLines = readShadeLogFile();\n+        assertThat(ecsLogLines).hasSize(2);\n+        verifyEcsFormat(rawLogLines.get(0), ecsLogLines.get(0), null);\n+        verifyEcsFormat(rawLogLines.get(3), ecsLogLines.get(1), null);\n+    }\n+\n+    @Test\n+    public void testLogShadingReplaceOriginal() throws IOException {\n+        when(config.getConfig(LoggingConfiguration.class).isLogShadingReplaceEnabled()).thenReturn(true);\n+        logger.trace(TRACE_MESSAGE);\n+        logger.debug(DEBUG_MESSAGE);\n+        logger.warn(WARN_MESSAGE);\n+        logger.error(ERROR_MESSAGE);\n+\n+        assertThat(readRawLogLines()).isEmpty();\n+        ArrayList<JsonNode> shadeLogEvents = readShadeLogFile();\n+        assertThat(shadeLogEvents).hasSize(4);\n+        for (JsonNode ecsLogLineTree : shadeLogEvents) {\n+            assertThat(ecsLogLineTree.get(\"process.thread.name\")).isNotNull();\n+            assertThat(ecsLogLineTree.get(\"log.level\")).isNotNull();\n+            assertThat(ecsLogLineTree.get(\"log.logger\")).isNotNull();\n+            assertThat(ecsLogLineTree.get(\"message\")).isNotNull();\n+        }\n+    }\n+\n+    @Nonnull\n+    private ArrayList<JsonNode> readShadeLogFile() throws IOException {\n+        return readShadeLogFile(getShadeLogFilePath());\n+    }\n+\n+    @Nonnull\n+    private ArrayList<JsonNode> readShadeLogFile(String shadeLogFilePath) throws IOException {\n+        ArrayList<JsonNode> ecsLogLines = new ArrayList<>();\n+        try (Stream<String> stream = Files.lines(Paths.get(shadeLogFilePath))) {\n+            stream.forEach(line -> {\n+                try {\n+                    ecsLogLines.add(objectMapper.readTree(line));\n+                } catch (JsonProcessingException e) {\n+                    e.printStackTrace();\n+                }\n+            });\n+        }\n+        return ecsLogLines;\n+    }\n+\n+    @Nonnull\n+    private ArrayList<String[]> readRawLogLines() throws IOException {\n+        ArrayList<String[]> rawLogLines;\n+        try (Stream<String> stream = Files.lines(getOriginalLogFilePath())) {\n+            rawLogLines = stream.map(line -> line.split(\"\\\\s+\")).collect(Collectors.toCollection(ArrayList::new));\n+        }\n+        return rawLogLines;\n+    }\n+\n+    @Nonnull\n+    private Path getOriginalLogFilePath() {\n+        return Paths.get(logger.getLogFilePath());\n+    }\n+\n+    @Nonnull\n+    private String getShadeLogFilePath() {\n+        return Utils.computeShadeLogFilePath(logger.getLogFilePath());\n+    }\n+\n+    private void verifyEcsFormat(String[] splitRawLogLine, JsonNode ecsLogLineTree, @Nullable String traceId) throws ParseException {\n+        SimpleDateFormat timestampFormat = new SimpleDateFormat(\"yyyy-MM-dd'T'HH:mm:ss.SSS'Z'\");\n+        Date rawTimestamp = timestampFormat.parse(splitRawLogLine[0]);\n+        timestampFormat.setTimeZone(TimeZone.getTimeZone(\"UTC\"));\n+        Date ecsTimestamp = timestampFormat.parse(ecsLogLineTree.get(\"@timestamp\").textValue());\n+        assertThat(rawTimestamp).isEqualTo(ecsTimestamp);\n+        assertThat(splitRawLogLine[1]).isEqualTo(ecsLogLineTree.get(\"process.thread.name\").textValue());\n+        assertThat(splitRawLogLine[2]).isEqualTo(ecsLogLineTree.get(\"log.level\").textValue());\n+        assertThat(splitRawLogLine[3]).isEqualTo(ecsLogLineTree.get(\"log.logger\").textValue());\n+        assertThat(splitRawLogLine[4]).isEqualTo(ecsLogLineTree.get(\"message\").textValue());\n+        assertThat(ecsLogLineTree.get(\"service.name\").textValue()).isEqualTo(tracer.getMetaData().getService().getName());\n+        if (traceId != null) {\n+            assertThat(ecsLogLineTree.get(\"trace.id\").textValue()).isEqualTo(traceId);\n+        } else {\n+            assertThat(ecsLogLineTree.get(\"trace.id\")).isNull();\n+        }\n+    }\n+\n+    /**\n+     * Disabled by default, as this is a very slow test. Can be used for manual testing of shade file rolling.\n+     * Note: logback and log4j2 rollover before appending an event, which means the two log files will contain messages.\n+     * As opposed to those, log4j1 rolls over after appending an event, which means that the active log file (log4j1.log)\n+     * will be empty when the test ends.\n+     */\n+     //@Test\n+     public void testShadeLogRolling() throws IOException {\n+         when(config.getConfig(LoggingConfiguration.class).getLogFileSize()).thenReturn(100L);\n+         logger.trace(\"First line\");\n+         sleep();", "originalCommit": "6943fa4ff9253dfdcaf0f232f76cdc4c6c59be09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NzYzODYxOQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r577638619", "bodyText": "Unfortunately, this is only possible for log4j1, which rolls the file at the end of the event logging.\nIt is also possible in log4j2 if I set immediateFlush=false, but this fails all other tests. I used two different loggers, one for the rolling test (with immediateFlush==false) and one for the rest, but it ended up being very close in duration to using a sleep of 50ms, which seems safe in log4j2.\nLogback required a very long sleep, but it works well and fast with immediateFlush==false.\nEventually I got to a state where these tests take 200-600ms, which is good enough to enable by default. If they will prove to be flaky we can extend the sleep a bit or disable.", "author": "eyalkoren", "createdAt": "2021-02-17T14:08:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM4NDYzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NzY3MzI3Ng==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r577673276", "bodyText": "Already proved flaky in the first test \ud83d\ude41\nI raised sleep time to 4X. Let's see where it takes us.", "author": "eyalkoren", "createdAt": "2021-02-17T14:49:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM4NDYzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3ODQ2OTQ3MA==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r578469470", "bodyText": "This test was very useful for me to test our log file rolling configurations. It will be as useful in the future if we would like to change something like our rolling-decision strategy. However, it is not as important for continuous-integration testing, which is why I disabled it and still left it.\nIt now adds about 1.5 seconds to the build for the three logging frameworks combined, so as long as it is not flaky, we can leave it on and disable later if required.", "author": "eyalkoren", "createdAt": "2021-02-18T14:38:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM4NDYzMA=="}], "type": "inlineReview"}, {"oid": "eefb01b629e8f89451a592cfb94fa792d54a3998", "url": "https://github.com/elastic/apm-agent-java/commit/eefb01b629e8f89451a592cfb94fa792d54a3998", "message": "Merge remote-tracking branch 'upstream/master' into dynamic-logger-ecs-reconfig", "committedDate": "2021-02-17T10:17:39Z", "type": "commit"}, {"oid": "aaf629dddb181f18976b17b7ec205f0c98d935e1", "url": "https://github.com/elastic/apm-agent-java/commit/aaf629dddb181f18976b17b7ec205f0c98d935e1", "message": "Updage module versions", "committedDate": "2021-02-17T10:21:46Z", "type": "commit"}, {"oid": "ff786bde892306b0578d7210a2a59ac80b626489", "url": "https://github.com/elastic/apm-agent-java/commit/ff786bde892306b0578d7210a2a59ac80b626489", "message": "Adjusting to new metadata API and fixing docs", "committedDate": "2021-02-17T11:44:51Z", "type": "commit"}, {"oid": "ecd8b9b517d2f74da749ca63a60cfac4aced7cb1", "url": "https://github.com/elastic/apm-agent-java/commit/ecd8b9b517d2f74da749ca63a60cfac4aced7cb1", "message": "Enhancing and enabling rolling file tests", "committedDate": "2021-02-17T13:57:30Z", "type": "commit"}, {"oid": "3000133b6dec3da60aab730b7f57180845cd8979", "url": "https://github.com/elastic/apm-agent-java/commit/3000133b6dec3da60aab730b7f57180845cd8979", "message": "Extending sleep time in Logback test", "committedDate": "2021-02-17T14:48:38Z", "type": "commit"}, {"oid": "661243add0ca0afab4f964f69eb3c0e6d88c9755", "url": "https://github.com/elastic/apm-agent-java/commit/661243add0ca0afab4f964f69eb3c0e6d88c9755", "message": "Extend sleep even further :(", "committedDate": "2021-02-18T06:40:14Z", "type": "commit"}, {"oid": "3ab3fb9ef360d250326a0bc4251ae9ff54e42681", "url": "https://github.com/elastic/apm-agent-java/commit/3ab3fb9ef360d250326a0bc4251ae9ff54e42681", "message": "Adding rolling-file-test javadoc", "committedDate": "2021-02-18T15:30:58Z", "type": "commit"}, {"oid": "551c75fd0c8c11ec5c4794979cc35f8e799bb2c1", "url": "https://github.com/elastic/apm-agent-java/commit/551c75fd0c8c11ec5c4794979cc35f8e799bb2c1", "message": "Changing config options", "committedDate": "2021-02-21T18:03:13Z", "type": "commit"}, {"oid": "dcf25fd06df8cf1ab88246e7d1d64a78950c3db5", "url": "https://github.com/elastic/apm-agent-java/commit/dcf25fd06df8cf1ab88246e7d1d64a78950c3db5", "message": "Adding documentation", "committedDate": "2021-02-22T17:36:48Z", "type": "commit"}, {"oid": "81f7ed2c42115f8ffa3cf2218c7b301fcb60d558", "url": "https://github.com/elastic/apm-agent-java/commit/81f7ed2c42115f8ffa3cf2218c7b301fcb60d558", "message": "Merge remote-tracking branch 'upstream/master' into dynamic-logger-ecs-reconfig", "committedDate": "2021-02-22T17:36:59Z", "type": "commit"}, {"oid": "18f4887dec6bfe1e1391460a4f5011faf7945b80", "url": "https://github.com/elastic/apm-agent-java/commit/18f4887dec6bfe1e1391460a4f5011faf7945b80", "message": "Adding legacy Logback testing", "committedDate": "2021-02-24T20:24:19Z", "type": "commit"}, {"oid": "43bb909877f2b0807fdea33c25a34731a4329ab3", "url": "https://github.com/elastic/apm-agent-java/commit/43bb909877f2b0807fdea33c25a34731a4329ab3", "message": "Merge remote-tracking branch 'upstream/master' into dynamic-logger-ecs-reconfig", "committedDate": "2021-02-28T09:21:32Z", "type": "commit"}, {"oid": "b2be2ea2062b03b9b821756dc46480815d09ba1e", "url": "https://github.com/elastic/apm-agent-java/commit/b2be2ea2062b03b9b821756dc46480815d09ba1e", "message": "Updating gRPC test app version", "committedDate": "2021-03-02T05:15:04Z", "type": "commit"}, {"oid": "8cb920997b136c168549c80de69acfd512f3421b", "url": "https://github.com/elastic/apm-agent-java/commit/8cb920997b136c168549c80de69acfd512f3421b", "message": "Adding dedicated IndyPluginClassLoaderParent", "committedDate": "2021-03-02T09:01:55Z", "type": "commit"}, {"oid": "c7c21bdee6c3b80fd5adf6a3915fcfd83ebef198", "url": "https://github.com/elastic/apm-agent-java/commit/c7c21bdee6c3b80fd5adf6a3915fcfd83ebef198", "message": "Adding support for log4j2 2.6", "committedDate": "2021-03-02T10:31:28Z", "type": "commit"}, {"oid": "9e51e7d6c3c840a6ee98f3ae639c368079536e09", "url": "https://github.com/elastic/apm-agent-java/commit/9e51e7d6c3c840a6ee98f3ae639c368079536e09", "message": "Adding to supported technologies", "committedDate": "2021-03-02T11:12:42Z", "type": "commit"}, {"oid": "464ff4ba430bf3508b600568e9323af7fd2a10a8", "url": "https://github.com/elastic/apm-agent-java/commit/464ff4ba430bf3508b600568e9323af7fd2a10a8", "message": "Setting service name", "committedDate": "2021-03-02T14:35:44Z", "type": "commit"}, {"oid": "a682e11632c9cbc5bdc1b525d7c05ae550743c88", "url": "https://github.com/elastic/apm-agent-java/commit/a682e11632c9cbc5bdc1b525d7c05ae550743c88", "message": "Merge remote-tracking branch 'upstream/master' into dynamic-logger-ecs-reconfig", "committedDate": "2021-03-02T14:38:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTY0Mzg0Mg==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r585643842", "bodyText": "I have not tested the ref works but I think it makes sense to link to the ecs docs so people can learn more about it.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        \"into ECS-compatible JSON, suitable for ingestion into Elasticsearch for further Log analysis. \\n\" +\n          \n          \n            \n                        \"into {ecs-logging-ref}/index.html[ECS-compatible JSON], suitable for ingestion into Elasticsearch for further Log analysis. \\n\" +", "author": "felixbarny", "createdAt": "2021-03-02T15:07:11Z", "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/logging/LoggingConfiguration.java", "diffHunk": "@@ -159,8 +159,53 @@ public void assertValid(Boolean value) {\n         })\n         .buildWithDefault(false);\n \n+    private final ConfigurationOption<LogEcsReformatting> logEcsReformatting = ConfigurationOption.enumOption(LogEcsReformatting.class)\n+        .key(\"log_ecs_reformatting\")\n+        .configurationCategory(LOGGING_CATEGORY)\n+        .tags(\"added[1.22.0]\", \"experimental\")\n+        .description(\"Specifying whether and how the agent should automatically reformat application logs \\n\" +\n+            \"into ECS-compatible JSON, suitable for ingestion into Elasticsearch for further Log analysis. \\n\" +", "originalCommit": "a682e11632c9cbc5bdc1b525d7c05ae550743c88", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "78dd72766716790c8b6665b98b73b577ff6385ab", "url": "https://github.com/elastic/apm-agent-java/commit/78dd72766716790c8b6665b98b73b577ff6385ab", "message": "Some enhancements to IndyPluginClassLoaderParent", "committedDate": "2021-03-02T16:23:42Z", "type": "commit"}, {"oid": "27614da50053ee3237a2209dd2fcf67065d5c015", "url": "https://github.com/elastic/apm-agent-java/commit/27614da50053ee3237a2209dd2fcf67065d5c015", "message": "Registering the CL as parallel capable", "committedDate": "2021-03-03T08:10:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjMxMjM1Mg==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r586312352", "bodyText": "As this class has a dependency (LoggingConfiguration), I'd prefer it not to be a static utility class but to have a constructor argument for LoggingConfiguration.\nIt'd simplify UtilsTest (or at least make it more lightweight) in that it doesn't need to extend from AbstractInstrumentationTest and you could just inject a mock instance for  LoggingConfiguration.\nAlso, consider creating a constructor argument for LoggingConfiguration in AbstractLogShadingHelper. Instead of making the implementations singletons, have a look at co.elastic.apm.agent.jdbc.JdbcInstrumentation#getJdbcHelper.\nBy using that pattern, the fact that advices are static does not leak into the rest of the codebase which can use regular constructor-based \"dependency-injection\". I think it makes sense to follow a similar pattern throughout the codebase so that it's more cohesive and can serve as a reference for new plugins.", "author": "felixbarny", "createdAt": "2021-03-03T10:49:18Z", "path": "apm-agent-plugins/apm-log-shader-plugin/apm-log-shader-plugin-common/src/main/java/co/elastic/apm/agent/log/shader/Utils.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.log.shader;\n+\n+import co.elastic.apm.agent.impl.GlobalTracer;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+\n+import javax.annotation.Nullable;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+\n+public class Utils {\n+\n+    private static final String SHADE_FILE_EXTENSION = \".ecs.json\";\n+    private static final LoggingConfiguration config = GlobalTracer.requireTracerImpl().getConfig(LoggingConfiguration.class);", "originalCommit": "27614da50053ee3237a2209dd2fcf67065d5c015", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjMxNDc4Mg==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r586314782", "bodyText": "Actually, I think co.elastic.apm.agent.log4j2.Log4j2LogShadingHelper#instance can probably stay as-is and just change private static final Log4j2LogShadingHelper INSTANCE = new Log4j2LogShadingHelper(); to private static final Log4j2LogShadingHelper INSTANCE = new Log4j2LogShadingHelper(GlobalTracer.requireTracerImpl());\nI like the fact that it's a final field rather than a volatile field in JdbcInstrumentation", "author": "felixbarny", "createdAt": "2021-03-03T10:52:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjMxMjM1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjM1ODIzNw==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r586358237", "bodyText": "Utils is a static utility by its nature. The argument of having a \"dependency\" shouldn't interfere with that. Depending on the logging framework as in LoggerFactory.getLogger(), for example, would be the same but would not exclude a class from being a static utility.\nDoing what you suggest can create the exact opposite problem of enforcing the utility user to introduce this dependency, which it might don't even need for anything else. And given that it is a utility, this will affect multiple users.", "author": "eyalkoren", "createdAt": "2021-03-03T11:59:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjMxMjM1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjM4MTk4Mw==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r586381983", "bodyText": "IMHO, a static utility should not depend on another class that is stateful. But what do you think about just adding a String shadeFileDestinationDir parameter that the caller can read from config.getLogEcsFormattingDestinationDir()?", "author": "felixbarny", "createdAt": "2021-03-03T12:37:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjMxMjM1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MDM0MzczOQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r590343739", "bodyText": "There is such method already: https://github.com/elastic/apm-agent-java/pull/1261/files#diff-2f5c514f954a475ff220cebc3a8551dce7915534f14d15bcffa86021ad108403R322\nbut it only returns the configured value or null.\nThe documentation for the log_ecs_reformatting_dir config option says:\nIf `log_ecs_reformatting` is set to `SHADE` or `REPLACE`, \nthe shade log files will be written alongside \nthe original logs in the same directory by default. \nUse this configuration in order to write the shade logs \ninto an alternative destination. Omitting this config or \nsetting it to an empty string will restore the default \nbehavior. If relative path is used, this path will be used \nrelative to the original logs directory.\n\nIn order to support that, there is some logic required, as well as an input argument for the original log file, so I felt this is not very appropriate to be located within the config class.", "author": "eyalkoren", "createdAt": "2021-03-09T12:55:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjMxMjM1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjMyMjI4Ng==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r586322286", "bodyText": "Why not like this?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    configuredServiceName = new ServiceFactory().createService(tracer.getConfig(CoreConfiguration.class), \"\").getName();\n          \n          \n            \n                    configuredServiceName = tracer.getConfig(CoreConfiguration.class).getServiceName();", "author": "felixbarny", "createdAt": "2021-03-03T11:03:49Z", "path": "apm-agent-plugins/apm-log-shader-plugin/apm-log-shader-plugin-common/src/main/java/co/elastic/apm/agent/log/shader/AbstractLogShadingHelper.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.log.shader;\n+\n+import co.elastic.apm.agent.configuration.CoreConfiguration;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.impl.GlobalTracer;\n+import co.elastic.apm.agent.impl.payload.ServiceFactory;\n+import co.elastic.apm.agent.impl.transaction.AbstractSpan;\n+import co.elastic.apm.agent.logging.LogEcsReformatting;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+import co.elastic.apm.agent.sdk.state.GlobalState;\n+import co.elastic.apm.agent.sdk.weakmap.WeakMapSupplier;\n+import com.blogspot.mydailyjava.weaklockfree.WeakConcurrentMap;\n+\n+import javax.annotation.Nullable;\n+\n+/**\n+ * The abstract Log shading helper- loaded as part of the agent core (agent CL / bootstrap CL / System CL).\n+ * Annotated with {@link GlobalState} because it holds the global mapping from original appender to corresponding\n+ * shade-appender.\n+ *\n+ * @param <A> logging-framework-specific Appender type\n+ */\n+@GlobalState\n+public abstract class AbstractLogShadingHelper<A> {\n+\n+    public static final String ECS_SHADE_APPENDER_NAME = \"EcsShadeAppender\";\n+\n+    private static final Object NULL_APPENDER = new Object();\n+\n+    private final ElasticApmTracer tracer;\n+    private final LoggingConfiguration loggingConfiguration;\n+    @Nullable\n+    private final String configuredServiceName;\n+\n+    public AbstractLogShadingHelper() {\n+        this.tracer = GlobalTracer.requireTracerImpl();\n+        loggingConfiguration = tracer.getConfig(LoggingConfiguration.class);\n+        configuredServiceName = new ServiceFactory().createService(tracer.getConfig(CoreConfiguration.class), \"\").getName();", "originalCommit": "27614da50053ee3237a2209dd2fcf67065d5c015", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjM1OTQyMQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r586359421", "bodyText": "Because it is a bit more future-proof. I want to get here the exact same service name that is reported in the metadata, so if in the future we need to make it all-capital, or append a prefix, or apply any logic instead of only using the configured name as is, it will still remain in sync.", "author": "eyalkoren", "createdAt": "2021-03-03T12:01:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjMyMjI4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NzUyMzA2Nw==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r587523067", "bodyText": "Got it. I think to make it even more future-proof and to solve the issue about which service name to use, we should expose a ElasticApmTracer#getServiceName(ClassLoader) method. In contrast to what the existing private method does, it should get the service name from the MetaData if there's no override for the provided class loader. We can probably get the class loader of the application by calling Thread.currentThread().getContextClassLoader().\nOne complication is that the metadata is inside a future, but that should be resolvable as the service name doesn't depend on the cloud metadata.\nAnother issue is that the service name might not be known that early in the application startup. For example, the detection of the spring.application.name happens after the first event has been logged. But at least for spring boot, there seems to be a fix. We can instrument either org.springframework.boot.SpringApplication#prepareEnvironment or org.springframework.boot.context.config.ConfigFileApplicationListener#onApplicationEvent, or similar which allows us to read environment.getProperty(\"spring.application.name\") before the first event is logged.", "author": "felixbarny", "createdAt": "2021-03-04T14:38:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjMyMjI4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MDM3NjM3OQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r590376379", "bodyText": "I think we should be careful not to over-complicate this already-complicated feature.\nThe way I see it - we either make efforts to maintain service name in sync with APM events, or we decide that the most important is consistency across all log events. Once we decide it is the latter, it is less important (and even a disadvantage) to make it class-loader-dependent. It will introduce the same issue of being dependent on the thread that does causes the appender initialization. I rather take the configured name or the default if not configured.", "author": "eyalkoren", "createdAt": "2021-03-09T13:39:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjMyMjI4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MTYyMzY1MQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r591623651", "bodyText": "We decided to start with leaving it as it is now and see how we enhance it later on. In any case, when the user is setting the service_name explicitly, then it will work as expected.", "author": "eyalkoren", "createdAt": "2021-03-10T15:32:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjMyMjI4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjMyMjMyMg==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r586322322", "bodyText": "This may yield different service names for the same webapp depending on whether the log has been created inside or outside of an active transaction.\nNot sure what the alternative is, though.", "author": "felixbarny", "createdAt": "2021-03-03T11:03:51Z", "path": "apm-agent-plugins/apm-log-shader-plugin/apm-log-shader-plugin-common/src/main/java/co/elastic/apm/agent/log/shader/AbstractLogShadingHelper.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.log.shader;\n+\n+import co.elastic.apm.agent.configuration.CoreConfiguration;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.impl.GlobalTracer;\n+import co.elastic.apm.agent.impl.payload.ServiceFactory;\n+import co.elastic.apm.agent.impl.transaction.AbstractSpan;\n+import co.elastic.apm.agent.logging.LogEcsReformatting;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+import co.elastic.apm.agent.sdk.state.GlobalState;\n+import co.elastic.apm.agent.sdk.weakmap.WeakMapSupplier;\n+import com.blogspot.mydailyjava.weaklockfree.WeakConcurrentMap;\n+\n+import javax.annotation.Nullable;\n+\n+/**\n+ * The abstract Log shading helper- loaded as part of the agent core (agent CL / bootstrap CL / System CL).\n+ * Annotated with {@link GlobalState} because it holds the global mapping from original appender to corresponding\n+ * shade-appender.\n+ *\n+ * @param <A> logging-framework-specific Appender type\n+ */\n+@GlobalState\n+public abstract class AbstractLogShadingHelper<A> {\n+\n+    public static final String ECS_SHADE_APPENDER_NAME = \"EcsShadeAppender\";\n+\n+    private static final Object NULL_APPENDER = new Object();\n+\n+    private final ElasticApmTracer tracer;\n+    private final LoggingConfiguration loggingConfiguration;\n+    @Nullable\n+    private final String configuredServiceName;\n+\n+    public AbstractLogShadingHelper() {\n+        this.tracer = GlobalTracer.requireTracerImpl();\n+        loggingConfiguration = tracer.getConfig(LoggingConfiguration.class);\n+        configuredServiceName = new ServiceFactory().createService(tracer.getConfig(CoreConfiguration.class), \"\").getName();\n+    }\n+\n+    private static final WeakConcurrentMap<Object, Object> appenderToShadeAppender = WeakMapSupplier.createMap();\n+\n+    @Nullable\n+    public A getOrCreateShadeAppenderFor(A originalAppender) {\n+        if (isShadingAppender(originalAppender)) {\n+            return null;\n+        }\n+\n+        Object shadeAppender = appenderToShadeAppender.get(originalAppender);\n+        if (shadeAppender == null) {\n+            synchronized (appenderToShadeAppender) {\n+                if (!appenderToShadeAppender.containsKey(originalAppender)) {\n+                    A createdAppender = createAndConfigureAppender(originalAppender, ECS_SHADE_APPENDER_NAME);\n+                    appenderToShadeAppender.put(originalAppender, createdAppender != null ? createdAppender : NULL_APPENDER);\n+                }\n+            }\n+            shadeAppender = appenderToShadeAppender.get(originalAppender);\n+        }\n+        return shadeAppender != NULL_APPENDER ? (A) shadeAppender : null;\n+    }\n+\n+    public void stopShading(A originalAppender) {\n+        synchronized (appenderToShadeAppender) {\n+            Object shadeAppender = appenderToShadeAppender.remove(originalAppender);\n+            if (shadeAppender != null) {\n+                closeShadeAppender((A) shadeAppender);\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Checks whether we should skip {@code append()} invocations for log events for the given appender.\n+     * Log event appends should be skipped if they are replaced by ECS-formatted events, meaning if:\n+     *  - shading is enabled by configuration AND\n+     *  - replace is enabled by configuration AND\n+     *  - there is a shade appender for this appender (there isn't when this appender IS A shade appender or it is not a file appender)\n+     * @param appender the appender\n+     * @return true if log events should be ignored for the given appender; false otherwise\n+     */\n+    public boolean shouldSkipAppend(A appender) {\n+        return loggingConfiguration.getLogEcsReformatting() == LogEcsReformatting.REPLACE && getOrCreateShadeAppenderFor(appender) != null;\n+    }\n+\n+    public boolean isShadingEnabled() {\n+        LogEcsReformatting logEcsReformatting = loggingConfiguration.getLogEcsReformatting();\n+        return logEcsReformatting == LogEcsReformatting.SHADE || logEcsReformatting== LogEcsReformatting.REPLACE;\n+    }\n+\n+    /**\n+     * Checks whether the given appender is a shading appender, so to avoid recursive shading\n+     *\n+     * @return true if the provide appender is a shading appender; false otherwise\n+     */\n+    private boolean isShadingAppender(A appender) {\n+        //noinspection StringEquality\n+        return getAppenderName(appender) == ECS_SHADE_APPENDER_NAME;\n+    }\n+\n+    protected abstract String getAppenderName(A appender);\n+\n+    @Nullable\n+    protected abstract A createAndConfigureAppender(A originalAppender, String appenderName);\n+\n+    @Nullable\n+    protected String getServiceName() {\n+        String serviceName = configuredServiceName;\n+        AbstractSpan<?> active = tracer.getActive();\n+        if (active != null) {\n+            String runtimeServiceName = active.getTraceContext().getServiceName();", "originalCommit": "27614da50053ee3237a2209dd2fcf67065d5c015", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjM2MjI0NQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r586362245", "bodyText": "Yes, I am aware and agree this is not ideal. However, don't forget that when logging correlation is enabled, we also add trace.id and transaction.id. What I tried to do is keep these Log events in sync with the APM events that we report in that context. So I guess the question is: what's more important - the sync with APM events or the ability to aggregate for a single service name in the logging app?", "author": "eyalkoren", "createdAt": "2021-03-03T12:06:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjMyMjMyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjM2NDI2NQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r586364265", "bodyText": "(I honestly don't have an answer, I think you are in a better position to judge, so we'll go with what you think is better)", "author": "eyalkoren", "createdAt": "2021-03-03T12:09:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjMyMjMyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjM5MTE3NQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r586391175", "bodyText": "One thing I missed is that getServiceName only gets called in the context of co.elastic.apm.agent.log.shader.AbstractLogShadingHelper#createAndConfigureAppender which is only called once, when the first log after instrumenting the appender is logged.\nThis may or may not be within a transaction. Likely, it happens before the service name can be determined for a .war web application or before being able to detect the spring.application.name.\nIt's tricky. But at least, the service name should stay consistent throughout the lifetime of the application.", "author": "felixbarny", "createdAt": "2021-03-03T12:52:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjMyMjMyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjQyMjI5NQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r586422295", "bodyText": "That is correct, and now I recall we already had this discussion \ud83d\ude42\nIf we think it's important enough to maintain consistency (for future purposes as well), we can add the service name to the MDC and in the ECS logger first look for such key and only if it is not there, use the one configured during the appender configuration.\nReally, it's your call (sorry, I didn't understand from the last comment if you made this decision)", "author": "eyalkoren", "createdAt": "2021-03-03T13:37:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjMyMjMyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NzUyMzE5NQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r587523195", "bodyText": "I think it's important that the service name stays consistent regardless of whether or not a log is emitted during a transaction. So setting it once when creating the ecs formatter/encoder does make sense. But I think we can refine the way we gather the service name. See also https://github.com/elastic/apm-agent-java/pull/1261/files#r587523067", "author": "felixbarny", "createdAt": "2021-03-04T14:38:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjMyMjMyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjM5MzI2NA==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r586393264", "bodyText": "Javadoc links to the instrumented method would be helpful on all instrumentations \ud83d\ude42", "author": "felixbarny", "createdAt": "2021-03-03T12:55:35Z", "path": "apm-agent-plugins/apm-log-shader-plugin/apm-log4j1-plugin/src/main/java/co/elastic/apm/agent/log4j1/Log4j1LogShadingInstrumentation.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.log4j1;\n+\n+import co.elastic.apm.agent.log.shader.AbstractLogShadingInstrumentation;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+import java.util.Collection;\n+\n+import static co.elastic.apm.agent.bci.bytebuddy.CustomElementMatchers.classLoaderCanLoadClass;\n+import static net.bytebuddy.matcher.ElementMatchers.isBootstrapClassLoader;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.not;\n+import static net.bytebuddy.matcher.ElementMatchers.takesArgument;\n+import static net.bytebuddy.matcher.ElementMatchers.takesArguments;\n+\n+public abstract class Log4j1LogShadingInstrumentation extends AbstractLogShadingInstrumentation {\n+\n+    @Override\n+    public Collection<String> getInstrumentationGroupNames() {\n+        Collection<String> ret = super.getInstrumentationGroupNames();\n+        ret.add(\"log4j1\");\n+        return ret;\n+    }\n+\n+    @Override\n+    public ElementMatcher.Junction<ClassLoader> getClassLoaderMatcher() {\n+        return not(isBootstrapClassLoader())\n+            .and(classLoaderCanLoadClass(\"org.apache.log4j.WriterAppender\"));\n+    }\n+\n+    @Override\n+    public ElementMatcher<? super TypeDescription> getTypeMatcher() {\n+        return named(\"org.apache.log4j.WriterAppender\");\n+    }\n+\n+    public static class ShadingInstrumentation extends Log4j1LogShadingInstrumentation {\n+\n+        @Override\n+        public ElementMatcher<? super MethodDescription> getMethodMatcher() {\n+            return named(\"subAppend\").and(takesArgument(0, named(\"org.apache.log4j.spi.LoggingEvent\")));", "originalCommit": "27614da50053ee3237a2209dd2fcf67065d5c015", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjU0NzczMg==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r586547732", "bodyText": "why do we have to do the shading trick for slf4j on this module? could we just remove this portion of apm-logback-plugin-impl/pom.xml? It does not use any slf4j classes in a context where we need to reference the target cl's slf4j.\n<relocation>\n    <pattern>org.slf4j</pattern>\n    <shadedPattern>co.elastic.apm.agent.logshading.shaded.slf4j</shadedPattern>\n</relocation>", "author": "felixbarny", "createdAt": "2021-03-03T16:08:24Z", "path": "apm-agent-plugins/apm-log-shader-plugin/apm-logback-plugin/apm-logback-plugin-impl/src/main/java/co/elastic/apm/agent/logback/LogbackLogShadingHelper.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.logback;\n+\n+import ch.qos.logback.classic.LoggerContext;\n+import ch.qos.logback.classic.spi.ILoggingEvent;\n+import ch.qos.logback.core.FileAppender;\n+import ch.qos.logback.core.rolling.FixedWindowRollingPolicy;\n+import ch.qos.logback.core.rolling.RollingFileAppender;\n+import ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy;\n+import co.elastic.apm.agent.log.shader.AbstractLogShadingHelper;\n+import co.elastic.apm.agent.log.shader.Utils;\n+import co.elastic.logging.logback.EcsEncoder;\n+\n+class LogbackLogShadingHelper extends AbstractLogShadingHelper<FileAppender<ILoggingEvent>> {\n+\n+    private static final LoggerContext defaultLoggerContext = new LoggerContext();\n+\n+    private static final LogbackLogShadingHelper INSTANCE = new LogbackLogShadingHelper();\n+\n+    static LogbackLogShadingHelper instance() {\n+        return INSTANCE;\n+    }\n+\n+    private LogbackLogShadingHelper() {}\n+\n+    @Override\n+    protected String getAppenderName(FileAppender<ILoggingEvent> appender) {\n+        return appender.getName();\n+    }\n+\n+    @Override\n+    protected FileAppender<ILoggingEvent> createAndConfigureAppender(FileAppender<ILoggingEvent> originalAppender, String appenderName) {\n+        RollingFileAppender<ILoggingEvent> shadeAppender = new RollingFileAppender<>();\n+        String shadeFile = Utils.computeShadeLogFilePath(originalAppender.getFile());\n+        shadeAppender.setFile(shadeFile);\n+\n+        EcsEncoder ecsEncoder = new EcsEncoder();\n+        ecsEncoder.setServiceName(getServiceName());\n+        ecsEncoder.setIncludeMarkers(false);\n+        ecsEncoder.setIncludeOrigin(false);\n+        ecsEncoder.setStackTraceAsArray(false);\n+        shadeAppender.setEncoder(ecsEncoder);\n+\n+        FixedWindowRollingPolicy rollingPolicy = new FixedWindowRollingPolicy();\n+        rollingPolicy.setMinIndex(1);\n+        rollingPolicy.setMaxIndex(1);\n+        rollingPolicy.setFileNamePattern(shadeFile + \".%i\");\n+        rollingPolicy.setParent(shadeAppender);\n+        rollingPolicy.setContext(defaultLoggerContext);\n+        rollingPolicy.start();\n+        shadeAppender.setRollingPolicy(rollingPolicy);\n+\n+        SizeBasedTriggeringPolicy<ILoggingEvent> triggeringPolicy = new SizeBasedTriggeringPolicy<>();\n+        try {\n+            VersionUtils.setMaxFileSize(triggeringPolicy, getMaxLogFileSize());\n+        } catch (Throwable throwable) {\n+            // We cannot log here because this plugin escapes slf4j package reallocation.\n+            System.out.println(\"Failed to set max file size for log shader file-rolling strategy. Using the default \" +", "originalCommit": "27614da50053ee3237a2209dd2fcf67065d5c015", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MDM4MzkzMQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r590383931", "bodyText": "Not sure now, maybe just a copy+paste+easier-to-just-leave \ud83d\ude42\nI'll remove and see if anything breaks", "author": "eyalkoren", "createdAt": "2021-03-09T13:49:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjU0NzczMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MTYyMjc1Mw==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r591622753", "bodyText": "We cannot add an slf4j dependency in the logback module, but we will add a \"facade\" logging method in the abstract helper that the helper subclasses can use. The common module should be able to have this dependency", "author": "eyalkoren", "createdAt": "2021-03-10T15:31:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjU0NzczMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjU2NDkyNQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r586564925", "bodyText": "There's already a log4j instrumentation group name for Log4j2LoggerErrorCapturingInstrumentation. It's hard to know from just looking at this list what the difference between log4j and log4j1 is.", "author": "felixbarny", "createdAt": "2021-03-03T16:28:19Z", "path": "docs/configuration.asciidoc", "diffHunk": "@@ -702,7 +704,7 @@ you should add an additional entry to this list (make sure to also include the d\n ==== `disable_instrumentations` (added[1.0.0,Changing this value at runtime is possible since version 1.15.0])\n \n A list of instrumentations which should be disabled.\n-Valid options are `annotations`, `apache-commons-exec`, `apache-httpclient`, `asynchttpclient`, `bootdelegation`, `concurrent`, `dubbo`, `elasticsearch-restclient`, `exception-handler`, `executor`, `executor-collection`, `experimental`, `fork-join`, `grails`, `grpc`, `hibernate-search`, `http-client`, `jax-rs`, `jax-ws`, `jdbc`, `jdk-httpclient`, `jedis`, `jms`, `jsf`, `kafka`, `lettuce`, `log4j`, `logging`, `micrometer`, `mongodb-client`, `okhttp`, `opentracing`, `process`, `public-api`, `quartz`, `rabbitmq`, `redis`, `redisson`, `render`, `scala-future`, `scheduled`, `servlet-api`, `servlet-api-async`, `servlet-api-dispatch`, `servlet-input-stream`, `slf4j`, `spring-mvc`, `spring-resttemplate`, `spring-service-name`, `spring-view-render`, `ssl-context`, `timer-task`, `urlconnection`.\n+Valid options are `annotations`, `apache-commons-exec`, `apache-httpclient`, `asynchttpclient`, `bootdelegation`, `concurrent`, `dubbo`, `elasticsearch-restclient`, `exception-handler`, `executor`, `executor-collection`, `experimental`, `fork-join`, `grails`, `grpc`, `hibernate-search`, `http-client`, `jax-rs`, `jax-ws`, `jdbc`, `jdk-httpclient`, `jedis`, `jms`, `jsf`, `kafka`, `lettuce`, `log4j`, `log4j1`, `log4j2`, `logback`, `logging`, `micrometer`, `mongodb-client`, `okhttp`, `opentracing`, `process`, `public-api`, `quartz`, `rabbitmq`, `redis`, `redisson`, `render`, `scala-future`, `scheduled`, `servlet-api`, `servlet-api-async`, `servlet-api-dispatch`, `servlet-input-stream`, `slf4j`, `spring-mvc`, `spring-resttemplate`, `spring-service-name`, `spring-view-render`, `ssl-context`, `timer-task`, `urlconnection`.", "originalCommit": "27614da50053ee3237a2209dd2fcf67065d5c015", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MDM4NDI1MQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r590384251", "bodyText": "OK, I'll change both", "author": "eyalkoren", "createdAt": "2021-03-09T13:50:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjU2NDkyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjU3ODkxNw==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r586578917", "bodyText": "It's more of an idea or a thing to discuss but I think it makes sense to add the appenderName to the event dataset so that it's possible to filter by different log streams of an application.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            ecsLayout.setServiceName(getServiceName());\n          \n          \n            \n                            ecsLayout.setServiceName(getServiceName());\n          \n          \n            \n                            ecsLayout.setEventDataset(getServiceName() + \".\" + appenderName);", "author": "felixbarny", "createdAt": "2021-03-03T16:43:46Z", "path": "apm-agent-plugins/apm-log-shader-plugin/apm-log4j1-plugin/src/main/java/co/elastic/apm/agent/log4j1/Log4j1LogShadingHelper.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.log4j1;\n+\n+import co.elastic.apm.agent.log.shader.AbstractLogShadingHelper;\n+import co.elastic.apm.agent.log.shader.Utils;\n+\n+import co.elastic.logging.log4j.EcsLayout;\n+import org.apache.log4j.FileAppender;\n+import org.apache.log4j.RollingFileAppender;\n+import org.apache.log4j.WriterAppender;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.annotation.Nullable;\n+import java.io.IOException;\n+\n+class Log4j1LogShadingHelper extends AbstractLogShadingHelper<WriterAppender> {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(Log4j1LogShadingHelper.class);\n+\n+    private static final Log4j1LogShadingHelper INSTANCE = new Log4j1LogShadingHelper();\n+\n+    static Log4j1LogShadingHelper instance() {\n+        return INSTANCE;\n+    }\n+\n+    Log4j1LogShadingHelper() {}\n+\n+    @Override\n+    protected String getAppenderName(WriterAppender appender) {\n+        return appender.getName();\n+    }\n+\n+    @Override\n+    @Nullable\n+    protected WriterAppender createAndConfigureAppender(WriterAppender originalAppender, String appenderName) {\n+\n+        RollingFileAppender shadeAppender = null;\n+        if (originalAppender instanceof FileAppender) {\n+            try {\n+                FileAppender fileAppender = (FileAppender) originalAppender;\n+                String shadeFile = Utils.computeShadeLogFilePath(fileAppender.getFile());\n+\n+                EcsLayout ecsLayout = new EcsLayout();\n+                ecsLayout.setServiceName(getServiceName());", "originalCommit": "27614da50053ee3237a2209dd2fcf67065d5c015", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MDM4OTY0MA==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r590389640", "bodyText": "Yeah, good idea. I'll apply this suggestion, unless you want to think of an alternative. As long as this is experimental, I think it's OK to start with something that may change later.", "author": "eyalkoren", "createdAt": "2021-03-09T13:56:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjU3ODkxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MTYyNzQwNw==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r591627407", "bodyText": "If the name is null (not sure if that can be the case) use log instead of the appender name", "author": "eyalkoren", "createdAt": "2021-03-10T15:36:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjU3ODkxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NzM1Njc5Mw==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r587356793", "bodyText": "Also return null if the appender already uses an ECS encoder/layout.", "author": "felixbarny", "createdAt": "2021-03-04T10:42:31Z", "path": "apm-agent-plugins/apm-log-shader-plugin/apm-log-shader-plugin-common/src/main/java/co/elastic/apm/agent/log/shader/AbstractLogShadingHelper.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.log.shader;\n+\n+import co.elastic.apm.agent.configuration.CoreConfiguration;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import co.elastic.apm.agent.impl.GlobalTracer;\n+import co.elastic.apm.agent.impl.payload.ServiceFactory;\n+import co.elastic.apm.agent.impl.transaction.AbstractSpan;\n+import co.elastic.apm.agent.logging.LogEcsReformatting;\n+import co.elastic.apm.agent.logging.LoggingConfiguration;\n+import co.elastic.apm.agent.sdk.state.GlobalState;\n+import co.elastic.apm.agent.sdk.weakmap.WeakMapSupplier;\n+import com.blogspot.mydailyjava.weaklockfree.WeakConcurrentMap;\n+\n+import javax.annotation.Nullable;\n+\n+/**\n+ * The abstract Log shading helper- loaded as part of the agent core (agent CL / bootstrap CL / System CL).\n+ * Annotated with {@link GlobalState} because it holds the global mapping from original appender to corresponding\n+ * shade-appender.\n+ *\n+ * @param <A> logging-framework-specific Appender type\n+ */\n+@GlobalState\n+public abstract class AbstractLogShadingHelper<A> {\n+\n+    public static final String ECS_SHADE_APPENDER_NAME = \"EcsShadeAppender\";\n+\n+    private static final Object NULL_APPENDER = new Object();\n+\n+    private final ElasticApmTracer tracer;\n+    private final LoggingConfiguration loggingConfiguration;\n+    @Nullable\n+    private final String configuredServiceName;\n+\n+    public AbstractLogShadingHelper() {\n+        this.tracer = GlobalTracer.requireTracerImpl();\n+        loggingConfiguration = tracer.getConfig(LoggingConfiguration.class);\n+        configuredServiceName = new ServiceFactory().createService(tracer.getConfig(CoreConfiguration.class), \"\").getName();\n+    }\n+\n+    private static final WeakConcurrentMap<Object, Object> appenderToShadeAppender = WeakMapSupplier.createMap();\n+\n+    @Nullable\n+    public A getOrCreateShadeAppenderFor(A originalAppender) {\n+        if (isShadingAppender(originalAppender)) {", "originalCommit": "27614da50053ee3237a2209dd2fcf67065d5c015", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1ff28e48525152bc76b362f95b022ea191d369b6", "url": "https://github.com/elastic/apm-agent-java/commit/1ff28e48525152bc76b362f95b022ea191d369b6", "message": "Merge remote-tracking branch 'upstream/master' into dynamic-logger-ecs-reconfig", "committedDate": "2021-03-08T07:37:04Z", "type": "commit"}, {"oid": "21274dd7b45e82ec3f0761a26235174ae3405ddb", "url": "https://github.com/elastic/apm-agent-java/commit/21274dd7b45e82ec3f0761a26235174ae3405ddb", "message": "Adding a line break", "committedDate": "2021-03-09T14:02:31Z", "type": "commit"}, {"oid": "5055e7ce2cfb36013522cdf8b6fc06c7044254b8", "url": "https://github.com/elastic/apm-agent-java/commit/5055e7ce2cfb36013522cdf8b6fc06c7044254b8", "message": "Trying referencing to ecs-logging docs\n\nCo-authored-by: Felix Barnsteiner <felixbarny@users.noreply.github.com>", "committedDate": "2021-03-11T10:06:11Z", "type": "commit"}, {"oid": "b54bbc8379dcf4df32ba61e1f852c6e8a127d2fc", "url": "https://github.com/elastic/apm-agent-java/commit/b54bbc8379dcf4df32ba61e1f852c6e8a127d2fc", "message": "Merge remote-tracking branch 'eyalkoren/dynamic-logger-ecs-reconfig' into dynamic-logger-ecs-reconfig", "committedDate": "2021-03-11T10:08:22Z", "type": "commit"}, {"oid": "f41b9cbbbf5a2e9b16860ae70c3b33fcdf905347", "url": "https://github.com/elastic/apm-agent-java/commit/f41b9cbbbf5a2e9b16860ae70c3b33fcdf905347", "message": "Merge remote-tracking branch 'upstream/master' into dynamic-logger-ecs-reconfig", "committedDate": "2021-03-11T10:09:14Z", "type": "commit"}, {"oid": "65a913607c252554fb7bbeca649754c3e102ae69", "url": "https://github.com/elastic/apm-agent-java/commit/65a913607c252554fb7bbeca649754c3e102ae69", "message": "Removing dependency of Utils in LoggingConfiguration", "committedDate": "2021-03-11T10:31:55Z", "type": "commit"}, {"oid": "eb4135e1f822d6abfc40c87ebe340a98a7c0afcf", "url": "https://github.com/elastic/apm-agent-java/commit/eb4135e1f822d6abfc40c87ebe340a98a7c0afcf", "message": "Remove in-context service name usage", "committedDate": "2021-03-11T10:44:36Z", "type": "commit"}, {"oid": "d460449d12f497c60e74370f2479aa5cce8fc2aa", "url": "https://github.com/elastic/apm-agent-java/commit/d460449d12f497c60e74370f2479aa5cce8fc2aa", "message": "Changing instrumentation groups", "committedDate": "2021-03-11T13:21:25Z", "type": "commit"}, {"oid": "57d8aa65b5ddd53a246cdc872c9de94ebf0d300c", "url": "https://github.com/elastic/apm-agent-java/commit/57d8aa65b5ddd53a246cdc872c9de94ebf0d300c", "message": "Applying review suggestions", "committedDate": "2021-03-11T16:22:29Z", "type": "commit"}, {"oid": "d9937c3187cf0c8b493e51b9fcc3d9cdcbd01b53", "url": "https://github.com/elastic/apm-agent-java/commit/d9937c3187cf0c8b493e51b9fcc3d9cdcbd01b53", "message": "Fixing javadoc signature", "committedDate": "2021-03-11T17:11:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTI1NDUwMQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r595254501", "bodyText": "As I find it hard to recall what the difference between REPLACE  and OVERRIDE  is, just some ideas how we could maybe make it clearer.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                SHADE,\n          \n          \n            \n                REPLACE,\n          \n          \n            \n                // NOT IMPLEMENTED YET\n          \n          \n            \n                //OVERRIDE\n          \n          \n            \n                SHADE_FILE,\n          \n          \n            \n                REPLACE_FILE,\n          \n          \n            \n                // NOT IMPLEMENTED YET\n          \n          \n            \n                // REFORMAT\n          \n      \n    \n    \n  \n\nThe _FILE options only work for file appenders while REFORMAT works with potentially any appender.", "author": "felixbarny", "createdAt": "2021-03-16T15:00:12Z", "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/logging/LogEcsReformatting.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2021 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * \n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ * \n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.logging;\n+\n+public enum LogEcsReformatting {\n+    OFF,\n+    SHADE,\n+    REPLACE,\n+    // NOT IMPLEMENTED YET\n+    //OVERRIDE", "originalCommit": "d9937c3187cf0c8b493e51b9fcc3d9cdcbd01b53", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTczNDM5Nw==", "url": "https://github.com/elastic/apm-agent-java/pull/1261#discussion_r595734397", "bodyText": "I actually prefer the simplicity in enum names, especially ones you use for configuration, so I think these single-verb-word names make sense. I see what you say about the meaning of each, but I don't think this will make a big change - in any case you would read the documentation and this is where I put efforts to very clearly explain what each does.\nIn addition, shade is currently only applied for files because this is how I implemented it, but it may do the same for console/stdout appenders as well if required for the same reason (keep existing log stream but also ingest ECS format of it to ES).", "author": "eyalkoren", "createdAt": "2021-03-17T06:04:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTI1NDUwMQ=="}], "type": "inlineReview"}, {"oid": "aab2e17f48928a43c882abfc1c06237757de55f4", "url": "https://github.com/elastic/apm-agent-java/commit/aab2e17f48928a43c882abfc1c06237757de55f4", "message": "Fix log correlation config validation", "committedDate": "2021-03-17T16:34:18Z", "type": "commit"}, {"oid": "c6258c8e1afb07cf38ddfeb3786d5fd602c25623", "url": "https://github.com/elastic/apm-agent-java/commit/c6258c8e1afb07cf38ddfeb3786d5fd602c25623", "message": "Merge remote-tracking branch 'upstream/master' into dynamic-logger-ecs-reconfig", "committedDate": "2021-03-17T16:34:30Z", "type": "commit"}, {"oid": "d4622aac200002c1ce33e83602dbbb1327ab3018", "url": "https://github.com/elastic/apm-agent-java/commit/d4622aac200002c1ce33e83602dbbb1327ab3018", "message": "Adding to CHANGELOG", "committedDate": "2021-03-17T16:42:40Z", "type": "commit"}]}