{"pr_number": 1391, "pr_title": "Fix HttpUrlConnection instrumentation", "pr_createdAt": "2020-09-09T08:08:28Z", "pr_url": "https://github.com/elastic/apm-agent-java/pull/1391", "timeline": [{"oid": "71205a0794ea28df8d895bad4ae5cc1145bf97b2", "url": "https://github.com/elastic/apm-agent-java/commit/71205a0794ea28df8d895bad4ae5cc1145bf97b2", "message": "Fix HttpUrlConnection instrumentation", "committedDate": "2020-09-09T08:05:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQyNTUyMw==", "url": "https://github.com/elastic/apm-agent-java/pull/1391#discussion_r485425523", "bodyText": "Creating a subclass of ThreadLocal causes leaks. See also https://cwiki.apache.org/confluence/display/TOMCAT/MemoryLeakProtection#MemoryLeakProtection-customThreadLocal.\nEither use no initial value or use CallDepth which seems to be applicable to this case.", "author": "felixbarny", "createdAt": "2020-09-09T08:18:34Z", "path": "apm-agent-plugins/apm-urlconnection-plugin/src/main/java/co/elastic/apm/agent/urlconnection/HttpUrlConnectionInstrumentation.java", "diffHunk": "@@ -51,8 +50,15 @@\n \n public abstract class HttpUrlConnectionInstrumentation extends TracerAwareInstrumentation {\n \n-    @VisibleForAdvice\n-    public static final WeakConcurrentMap<HttpURLConnection, Span> inFlightSpans = WeakMapSupplier.createMap();\n+    private static final WeakConcurrentMap<HttpURLConnection, Span> inFlightSpans = WeakMapSupplier.createMap();\n+\n+    // Used instead of inspecting sun.net.www.protocol.http.HttpURLConnection.connecting which was added in Java 8\n+    private static final ThreadLocal<Boolean> connecting = new ThreadLocal<>() {", "originalCommit": "71205a0794ea28df8d895bad4ae5cc1145bf97b2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQ0MTEyOA==", "url": "https://github.com/elastic/apm-agent-java/pull/1391#discussion_r485441128", "bodyText": "Ahh, the anonymous class...\nThanks!", "author": "eyalkoren", "createdAt": "2020-09-09T08:42:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQyNTUyMw=="}], "type": "inlineReview"}, {"oid": "7768a0406b25358f76783e55778d782ccea576c2", "url": "https://github.com/elastic/apm-agent-java/commit/7768a0406b25358f76783e55778d782ccea576c2", "message": "Replacing ThreadLocal with CallDepth", "committedDate": "2020-09-09T08:52:18Z", "type": "commit"}, {"oid": "c81caaa1c1970f6bfeac7561f267a48f0756ba90", "url": "https://github.com/elastic/apm-agent-java/commit/c81caaa1c1970f6bfeac7561f267a48f0756ba90", "message": "Merge remote-tracking branch 'upstream/master' into HttpUrlConnection-instr-fix", "committedDate": "2020-09-09T11:54:25Z", "type": "commit"}, {"oid": "1741848ae2406104d03ba3c0ee103d513ecd218c", "url": "https://github.com/elastic/apm-agent-java/commit/1741848ae2406104d03ba3c0ee103d513ecd218c", "message": "Restore ThreadLocal loading restriction", "committedDate": "2020-09-09T12:51:33Z", "type": "commit"}, {"oid": "b07190424ba3327872520bc7a69827a1a29946b4", "url": "https://github.com/elastic/apm-agent-java/commit/b07190424ba3327872520bc7a69827a1a29946b4", "message": "Re-remove ThreadLocal and corresponding test", "committedDate": "2020-09-09T13:25:33Z", "type": "commit"}, {"oid": "864957b58284a1007c070bd4020fd594915759fb", "url": "https://github.com/elastic/apm-agent-java/commit/864957b58284a1007c070bd4020fd594915759fb", "message": "Removing UsingThreadLocal class from test", "committedDate": "2020-09-09T13:28:08Z", "type": "commit"}]}