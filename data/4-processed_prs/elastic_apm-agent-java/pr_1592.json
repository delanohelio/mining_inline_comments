{"pr_number": 1592, "pr_title": "CallTree recycling", "pr_createdAt": "2020-12-28T05:34:56Z", "pr_url": "https://github.com/elastic/apm-agent-java/pull/1592", "timeline": [{"oid": "83f65b10c6f8696f6c3f71626aaf88485db66763", "url": "https://github.com/elastic/apm-agent-java/commit/83f65b10c6f8696f6c3f71626aaf88485db66763", "message": "CallTree recycling", "committedDate": "2020-12-28T05:32:43Z", "type": "commit"}, {"oid": "ef943d6f9cf099d9039b50e67268df9ae667e612", "url": "https://github.com/elastic/apm-agent-java/commit/ef943d6f9cf099d9039b50e67268df9ae667e612", "message": "Some recycling refactoring and clear memory when tracer pauses", "committedDate": "2020-12-30T16:13:56Z", "type": "commit"}, {"oid": "9afc09f23d3d6fde095f45b14b88ab95baaabd8e", "url": "https://github.com/elastic/apm-agent-java/commit/9afc09f23d3d6fde095f45b14b88ab95baaabd8e", "message": "Check file channel is open before resetting", "committedDate": "2020-12-31T04:11:17Z", "type": "commit"}, {"oid": "ef08014856e669743d361783d48d665937e84357", "url": "https://github.com/elastic/apm-agent-java/commit/ef08014856e669743d361783d48d665937e84357", "message": "Creating a memory leak for testing", "committedDate": "2020-12-31T14:32:23Z", "type": "commit"}, {"oid": "bdd0ee05bb6a93ed0358251448b14cb48bdcad61", "url": "https://github.com/elastic/apm-agent-java/commit/bdd0ee05bb6a93ed0358251448b14cb48bdcad61", "message": "Reverting memory leak", "committedDate": "2020-12-31T14:33:01Z", "type": "commit"}, {"oid": "363f2fb19eef4e70065af9a7472fdccf6a0c76c4", "url": "https://github.com/elastic/apm-agent-java/commit/363f2fb19eef4e70065af9a7472fdccf6a0c76c4", "message": "Improve memory leak :)", "committedDate": "2020-12-31T16:39:07Z", "type": "commit"}, {"oid": "65faf5c9b8dd9f120d0f8e9668a7ae6651eb4fc7", "url": "https://github.com/elastic/apm-agent-java/commit/65faf5c9b8dd9f120d0f8e9668a7ae6651eb4fc7", "message": "Fix memory leak :))", "committedDate": "2020-12-31T16:43:45Z", "type": "commit"}, {"oid": "edaff6e7f8cc92d730633e779803388a7b1defc1", "url": "https://github.com/elastic/apm-agent-java/commit/edaff6e7f8cc92d730633e779803388a7b1defc1", "message": " Reverting memory leak", "committedDate": "2020-12-31T16:45:05Z", "type": "commit"}, {"oid": "b37789c08f09384c4d1a584c45a4dbc160bc4271", "url": "https://github.com/elastic/apm-agent-java/commit/b37789c08f09384c4d1a584c45a4dbc160bc4271", "message": "Merge remote-tracking branch 'upstream/master' into call-tree-memory-leak", "committedDate": "2021-01-06T12:57:32Z", "type": "commit"}, {"oid": "602776f93b62729ab4ccb48cb24121785c1e1ec3", "url": "https://github.com/elastic/apm-agent-java/commit/602776f93b62729ab4ccb48cb24121785c1e1ec3", "message": "Add to CHANGELOG", "committedDate": "2021-01-06T12:59:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjcxNzQ3Mg==", "url": "https://github.com/elastic/apm-agent-java/pull/1592#discussion_r552717472", "bodyText": "why not throw directly an IllegalArgumentException when called on a root node instead of an assertion that might be disabled ?", "author": "SylvainJuge", "createdAt": "2021-01-06T15:30:55Z", "path": "apm-agent-plugins/apm-profiling-plugin/src/main/java/co/elastic/apm/agent/profiler/CallTree.java", "diffHunk": "@@ -436,7 +436,16 @@ private void fillStackTrace(List<StackFrame> stackTrace) {\n         }\n     }\n \n-    public void recycle(ObjectPool<CallTree> pool) {\n+    /**\n+     * Recycles this subtree to the provided pool recursively.\n+     * Note that this method ends by recycling {@code this} node (i.e. - this subtree root), which means that\n+     * <b>the caller of this method should make sure that no reference to this object is held anywhere</b>.\n+     * <p>ALSO NOTE: MAKE SURE NOT TO CALL THIS METHOD FOR {@link CallTree.Root} INSTANCES.</p>\n+     *\n+     * @param pool the pool to which all subtree nodes are to be recycled\n+     */\n+    public final void recycle(ObjectPool<CallTree> pool) {\n+        assert !(this instanceof Root);", "originalCommit": "9f9260594ffcae07bbae33deb5ae01b2826d2002", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjczMTQ0MA==", "url": "https://github.com/elastic/apm-agent-java/pull/1592#discussion_r552731440", "bodyText": "I thought of avoiding the instanceof check overhead in production. Normally I think it is not something that would be specific for a unique corner case, our tests should find it if we try to recycle improperly", "author": "eyalkoren", "createdAt": "2021-01-06T15:46:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjcxNzQ3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjcxOTU5OA==", "url": "https://github.com/elastic/apm-agent-java/pull/1592#discussion_r552719598", "bodyText": "leftover TODO ?", "author": "SylvainJuge", "createdAt": "2021-01-06T15:34:11Z", "path": "apm-agent-plugins/apm-profiling-plugin/src/main/java/co/elastic/apm/agent/profiler/CallTree.java", "diffHunk": "@@ -735,6 +754,8 @@ public void resetState() {\n             super.resetState();\n             activeSpan = null;\n             activationTimestamp = -1;\n+            // todo - should we reset activeSpanSerialized?", "originalCommit": "9f9260594ffcae07bbae33deb5ae01b2826d2002", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjczMjQyNw==", "url": "https://github.com/elastic/apm-agent-java/pull/1592#discussion_r552732427", "bodyText": "Well, half leftover...\nDidn't want to look into it now, but wanted the reminder. But I will see if we need to something with it or leave it as is", "author": "eyalkoren", "createdAt": "2021-01-06T15:48:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjcxOTU5OA=="}], "type": "inlineReview"}, {"oid": "1f4f643d3712a415e1abc84a6f9e22fac1afff35", "url": "https://github.com/elastic/apm-agent-java/commit/1f4f643d3712a415e1abc84a6f9e22fac1afff35", "message": "Merge remote-tracking branch 'upstream/master' into call-tree-memory-leak", "committedDate": "2021-01-07T07:28:13Z", "type": "commit"}, {"oid": "c81c3d1a4d5623bfa01008b97d4ebab931c7212a", "url": "https://github.com/elastic/apm-agent-java/commit/c81c3d1a4d5623bfa01008b97d4ebab931c7212a", "message": "Completion of root recycling", "committedDate": "2021-01-07T07:31:55Z", "type": "commit"}, {"oid": "c81c3d1a4d5623bfa01008b97d4ebab931c7212a", "url": "https://github.com/elastic/apm-agent-java/commit/c81c3d1a4d5623bfa01008b97d4ebab931c7212a", "message": "Completion of root recycling", "committedDate": "2021-01-07T07:31:55Z", "type": "forcePushed"}, {"oid": "a11e6cbfaf32d222e42548c26f3bec8f012998ea", "url": "https://github.com/elastic/apm-agent-java/commit/a11e6cbfaf32d222e42548c26f3bec8f012998ea", "message": "Merge remote-tracking branch 'upstream/master' into call-tree-memory-leak", "committedDate": "2021-01-07T09:18:54Z", "type": "commit"}, {"oid": "8f5eab6eca6603ef20deb6e5a9718b406fc38777", "url": "https://github.com/elastic/apm-agent-java/commit/8f5eab6eca6603ef20deb6e5a9718b406fc38777", "message": "Capital letter again", "committedDate": "2021-01-07T09:19:26Z", "type": "commit"}, {"oid": "8f5eab6eca6603ef20deb6e5a9718b406fc38777", "url": "https://github.com/elastic/apm-agent-java/commit/8f5eab6eca6603ef20deb6e5a9718b406fc38777", "message": "Capital letter again", "committedDate": "2021-01-07T09:19:26Z", "type": "forcePushed"}]}