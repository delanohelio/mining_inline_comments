{"pr_number": 1058, "pr_title": "Fully-automated release process", "pr_createdAt": "2020-02-28T14:56:07Z", "pr_url": "https://github.com/elastic/apm-agent-java/pull/1058", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgwNTA4Mg==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r385805082", "bodyText": "What do you think to move this logic to a shell script?", "author": "v1v", "createdAt": "2020-02-28T16:49:25Z", "path": ".ci/release/Jenkinsfile", "diffHunk": "@@ -0,0 +1,235 @@\n+#!/usr/bin/env groovy\n+\n+@Library('apm@current') _\n+pipeline {\n+  agent { label 'linux && immutable' }\n+  environment {\n+    REPO = 'apm-agent-java'\n+    BASE_DIR = \"src/github.com/elastic/${env.REPO}\"\n+    NOTIFY_TO = credentials('notify-to')\n+    DOCKERHUB_SECRET = 'secret/apm-team/ci/elastic-observability-dockerhub'\n+    ELASTIC_DOCKER_SECRET = 'secret/apm-team/ci/docker-registry/prod'\n+    NEXUS_SECRET = 'secret/apm-team/ci/nexus'\n+    MAVEN_CONFIG = '-Dmaven.repo.local=.m2'\n+    OPBEANS_REPO = 'opbeans-java'\n+\n+  }\n+  options {\n+    timeout(time: 3, unit: 'HOURS')\n+    buildDiscarder(logRotator(numToKeepStr: '20', artifactNumToKeepStr: '20', daysToKeepStr: '30'))\n+    timestamps()\n+    ansiColor('xterm')\n+    durabilityHint('PERFORMANCE_OPTIMIZED')\n+\n+  }\n+  parameters {\n+    string(name: 'MAVEN_CONFIG', defaultValue: '-B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn', description: 'Additional maven options.')\n+    string(name: 'branch_specifier', defaultValue: 'master')\n+  }\n+\n+  stages {\n+    stage('Initializing'){\n+      options { skipDefaultCheckout() }\n+      environment {\n+        HOME = \"${env.WORKSPACE}\"\n+        JAVA_HOME = \"${env.HUDSON_HOME}/.java/java10\"\n+        PATH = \"${env.JAVA_HOME}/bin:${env.PATH}\"\n+        MAVEN_CONFIG = \"${params.MAVEN_CONFIG} ${env.MAVEN_CONFIG}\"\n+      }\n+      stages {\n+        /**\n+         Checkout the code\n+        */\n+        stage('Checkout') {\n+          steps {\n+            dir(\"${BASE_DIR}\") {\n+              // This is required to ensure that Maven is working with a real branch\n+              sh(script: \"git checkout -f {$branch_specifier}\")\n+            }\n+          }\n+        }\n+      }\n+    }\n+    stage('Release') {\n+      options { skipDefaultCheckout () }\n+      stages{\n+        // 1. Check to see if oss.sonatype.org is up. We throw an exception and fail the job if there is no response.\n+        stage('Check oss.sonatype.org') {\n+          steps {\n+            // If this fails, an exception should be thrown and execution will halt\n+            httpRequest(url: \"https://oss.sonatype.org/#welcome\")\n+          }\n+        }\n+        // 2. Review project version.\n+        stage('Review project version') {\n+          steps {\n+            script {\n+              // Show the select input modal\n+              def INPUT_PARAMS = input message: 'Do you wish to update the version?', ok: 'Next', parameters: [choice(name: 'UPDATE_CHOICE', choices:['Yes', 'No'], description: \"This will run `mvn release:update-versions`\")]\n+              if (INPUT_PARAMS == 'Yes') {\n+                  dir(\"${BASE_DIR}\") {\n+                    sh mvn release:update-versions\n+                  }\n+              } else {\n+                  echo 'Skipping version update'\n+              }\n+            }\n+          }\n+        }\n+        // 3. Execute the release Jenkins job on the internal ci server.\n+            // For now we assume that the release has been pushed to staging already on the internal CI\n+        // 4. Login to oss.sonatype.org, go to Staging Repositories, close and release the staged artifacts.\n+        stage('Nexus release') {\n+          steps {\n+            script {\n+              def spid = getVault('nexus')[\"staging-profile-id\"]\n+              dir(\"${BASE_DIR}\"){\n+                withEnvMask(vars: [[var: \"SPID\", password: spid]]){\n+                  def foundStagingId = nexusFindStagingId(stagingProfileId: \"${SPID}\", groupId: \"co.elastic.apm\")\n+                  nexusCloseStagingRepository(stagingProfileId: \"${SPID}\", stagingId: foundStagingId)\n+                  nexusReleaseStagingRepository(stagingProfileId: \"${SPID}\", stagingId: foundStagingId)\n+                }\n+\n+              }\n+            }\n+          }\n+        }\n+        // 5. Fetch and checkout the latest tag e.g. git fetch origin\n+          // We already have this :)\n+        // 6. If this was a major release, create a new branch for the major.\n+        stage('Branch creation') {\n+          steps {\n+            dir(\"${BASE_DIR}\") {\n+              script {\n+                def isMajor = sh(script: 'git tag|tail -1|cut -f2-3 -d \".\"|{ read ver; test $ver == \"0.0\"; }', returnStatus: true)\n+                if (isMajor == 0) {\n+                  // We need to create a new branch. First get the name of the branch\n+                  def newBranchName = sh(script: 'git tag|tail -1|sed s/v//|cut -f1 -d \".\"|awk \\'{print $1\".x\"}\\'', returnStdout: true)\n+                  echo \"This appears to be a major version. We are creating a new branch for $newBranchName in the apm-agent-java repo on GitHub.\"\n+                  // Now we need to branch\n+                  sh(script: \"git checkout -b $newBranchName\")", "originalCommit": "f668eabc167475153708ee930eab7cd48907c9c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU3Nzk5MQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r389577991", "bodyText": "Also, as an alternative, it might be easier to get project version from maven pom.xml rather than parsing it from git.", "author": "SylvainJuge", "createdAt": "2020-03-09T10:34:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgwNTA4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDMyMzY2MA==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r390323660", "bodyText": "Great idea! I have implemented this upstream and will update this pipeline to use the new functionality.", "author": "cachedout", "createdAt": "2020-03-10T13:46:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgwNTA4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgwNTYzNw==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r385805637", "bodyText": "Shell script that returns the URL?", "author": "v1v", "createdAt": "2020-02-28T16:50:28Z", "path": ".ci/release/Jenkinsfile", "diffHunk": "@@ -0,0 +1,235 @@\n+#!/usr/bin/env groovy\n+\n+@Library('apm@current') _\n+pipeline {\n+  agent { label 'linux && immutable' }\n+  environment {\n+    REPO = 'apm-agent-java'\n+    BASE_DIR = \"src/github.com/elastic/${env.REPO}\"\n+    NOTIFY_TO = credentials('notify-to')\n+    DOCKERHUB_SECRET = 'secret/apm-team/ci/elastic-observability-dockerhub'\n+    ELASTIC_DOCKER_SECRET = 'secret/apm-team/ci/docker-registry/prod'\n+    NEXUS_SECRET = 'secret/apm-team/ci/nexus'\n+    MAVEN_CONFIG = '-Dmaven.repo.local=.m2'\n+    OPBEANS_REPO = 'opbeans-java'\n+\n+  }\n+  options {\n+    timeout(time: 3, unit: 'HOURS')\n+    buildDiscarder(logRotator(numToKeepStr: '20', artifactNumToKeepStr: '20', daysToKeepStr: '30'))\n+    timestamps()\n+    ansiColor('xterm')\n+    durabilityHint('PERFORMANCE_OPTIMIZED')\n+\n+  }\n+  parameters {\n+    string(name: 'MAVEN_CONFIG', defaultValue: '-B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn', description: 'Additional maven options.')\n+    string(name: 'branch_specifier', defaultValue: 'master')\n+  }\n+\n+  stages {\n+    stage('Initializing'){\n+      options { skipDefaultCheckout() }\n+      environment {\n+        HOME = \"${env.WORKSPACE}\"\n+        JAVA_HOME = \"${env.HUDSON_HOME}/.java/java10\"\n+        PATH = \"${env.JAVA_HOME}/bin:${env.PATH}\"\n+        MAVEN_CONFIG = \"${params.MAVEN_CONFIG} ${env.MAVEN_CONFIG}\"\n+      }\n+      stages {\n+        /**\n+         Checkout the code\n+        */\n+        stage('Checkout') {\n+          steps {\n+            dir(\"${BASE_DIR}\") {\n+              // This is required to ensure that Maven is working with a real branch\n+              sh(script: \"git checkout -f {$branch_specifier}\")\n+            }\n+          }\n+        }\n+      }\n+    }\n+    stage('Release') {\n+      options { skipDefaultCheckout () }\n+      stages{\n+        // 1. Check to see if oss.sonatype.org is up. We throw an exception and fail the job if there is no response.\n+        stage('Check oss.sonatype.org') {\n+          steps {\n+            // If this fails, an exception should be thrown and execution will halt\n+            httpRequest(url: \"https://oss.sonatype.org/#welcome\")\n+          }\n+        }\n+        // 2. Review project version.\n+        stage('Review project version') {\n+          steps {\n+            script {\n+              // Show the select input modal\n+              def INPUT_PARAMS = input message: 'Do you wish to update the version?', ok: 'Next', parameters: [choice(name: 'UPDATE_CHOICE', choices:['Yes', 'No'], description: \"This will run `mvn release:update-versions`\")]\n+              if (INPUT_PARAMS == 'Yes') {\n+                  dir(\"${BASE_DIR}\") {\n+                    sh mvn release:update-versions\n+                  }\n+              } else {\n+                  echo 'Skipping version update'\n+              }\n+            }\n+          }\n+        }\n+        // 3. Execute the release Jenkins job on the internal ci server.\n+            // For now we assume that the release has been pushed to staging already on the internal CI\n+        // 4. Login to oss.sonatype.org, go to Staging Repositories, close and release the staged artifacts.\n+        stage('Nexus release') {\n+          steps {\n+            script {\n+              def spid = getVault('nexus')[\"staging-profile-id\"]\n+              dir(\"${BASE_DIR}\"){\n+                withEnvMask(vars: [[var: \"SPID\", password: spid]]){\n+                  def foundStagingId = nexusFindStagingId(stagingProfileId: \"${SPID}\", groupId: \"co.elastic.apm\")\n+                  nexusCloseStagingRepository(stagingProfileId: \"${SPID}\", stagingId: foundStagingId)\n+                  nexusReleaseStagingRepository(stagingProfileId: \"${SPID}\", stagingId: foundStagingId)\n+                }\n+\n+              }\n+            }\n+          }\n+        }\n+        // 5. Fetch and checkout the latest tag e.g. git fetch origin\n+          // We already have this :)\n+        // 6. If this was a major release, create a new branch for the major.\n+        stage('Branch creation') {\n+          steps {\n+            dir(\"${BASE_DIR}\") {\n+              script {\n+                def isMajor = sh(script: 'git tag|tail -1|cut -f2-3 -d \".\"|{ read ver; test $ver == \"0.0\"; }', returnStatus: true)\n+                if (isMajor == 0) {\n+                  // We need to create a new branch. First get the name of the branch\n+                  def newBranchName = sh(script: 'git tag|tail -1|sed s/v//|cut -f1 -d \".\"|awk \\'{print $1\".x\"}\\'', returnStdout: true)\n+                  echo \"This appears to be a major version. We are creating a new branch for $newBranchName in the apm-agent-java repo on GitHub.\"\n+                  // Now we need to branch\n+                  sh(script: \"git checkout -b $newBranchName\")\n+                  // And push\n+                  githubEnv()\n+                  gitPush() \n+                  // 6.1 Add the new branch to the conf.yaml in the docs repo\n+                  input message: \"This was a major version release. Please update the conf.yml in the docs repo before continuing\", ok \"Continue\"\n+                } else {  // This was a minor release\n+                  // 7. If this was a minor release, reset the current major branch (1.x, 2.x etc) to point to the current tag, e.g. git branch -f 1.x v1.1.0\n+                  // Determine current tag\n+                  def curTag = sh(script: \"git tag|tail -1\", returnStdout: true)\n+                  def targetBranch = sh(script: 'git tag|tail -1|sed s/v//|cut -f1 -d '.'|awk \\'{print $1\".x\"}\\'', returnStdout: true)\n+                  sh(script: \"git branch -f $targetBranch $curTag\")\n+                  gitPush()\n+                }\n+              }\n+              // Checkout the tag again!\n+              sh(\"git checkout ${BUILD_TAG}\")\n+            }\n+          }\n+        }\n+        // 8. Update CHANGELOG.asciidoc to reflect version release. Go over PRs or git log and add bug fixes and features. \n+        stage('Generate a proposed CHANGELOG') {\n+          steps {\n+            githubEnv()\n+            generateChangelog(repo: 'apm-agent-java')\n+          }\n+        }\n+        // 9. Go to elastic/apm-agent-java/releases and draft a new release. Provide a link to release notes in documentation as release description.\n+        stage('Create GitHub release draft') {\n+          steps {\n+            dir(\"${BASE_DIR}\"){\n+              script {\n+                def curTag = sh(script: \"git tag|tail -1\", returnStdout: true)\n+                // Construct the URL with anchor for the release notes\n+                // Ex: https://www.elastic.co/guide/en/apm/agent/java/current/release-notes-1.x.html#release-notes-1.13.0\n+                def baseUrl = \"https://www.elastic.co/guide/en/apm/agent/java/current/release-notes-\"\n+                def dotX = sh(script: 'git tag|tail -1|sed s/v//|cut -f1 -d \".\"|awk \\'{print $1\".x\"}\\'', returnStdout: true)\n+                def bareTag = sh(script: 'git tag|tail -1|sed s/v//', returnStdout: true)\n+                def finalUrl = sh(script: \"echo $baseUrl$dotX\\.html#release-notes-$bareTag\")", "originalCommit": "f668eabc167475153708ee930eab7cd48907c9c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQwOTEzOA==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r390409138", "bodyText": "Good suggestion! I have migrated this logic to a stand-alone shell script.", "author": "cachedout", "createdAt": "2020-03-10T15:38:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgwNTYzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgwNjk3Ng==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r385806976", "bodyText": "This should be tag-based, this pipeline is master based IIRC, therefore the tag conditional can be left as it was previously, what do you think?", "author": "v1v", "createdAt": "2020-02-28T16:53:03Z", "path": ".ci/release/Jenkinsfile", "diffHunk": "@@ -0,0 +1,235 @@\n+#!/usr/bin/env groovy\n+\n+@Library('apm@current') _\n+pipeline {\n+  agent { label 'linux && immutable' }\n+  environment {\n+    REPO = 'apm-agent-java'\n+    BASE_DIR = \"src/github.com/elastic/${env.REPO}\"\n+    NOTIFY_TO = credentials('notify-to')\n+    DOCKERHUB_SECRET = 'secret/apm-team/ci/elastic-observability-dockerhub'\n+    ELASTIC_DOCKER_SECRET = 'secret/apm-team/ci/docker-registry/prod'\n+    NEXUS_SECRET = 'secret/apm-team/ci/nexus'\n+    MAVEN_CONFIG = '-Dmaven.repo.local=.m2'\n+    OPBEANS_REPO = 'opbeans-java'\n+\n+  }\n+  options {\n+    timeout(time: 3, unit: 'HOURS')\n+    buildDiscarder(logRotator(numToKeepStr: '20', artifactNumToKeepStr: '20', daysToKeepStr: '30'))\n+    timestamps()\n+    ansiColor('xterm')\n+    durabilityHint('PERFORMANCE_OPTIMIZED')\n+\n+  }\n+  parameters {\n+    string(name: 'MAVEN_CONFIG', defaultValue: '-B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn', description: 'Additional maven options.')\n+    string(name: 'branch_specifier', defaultValue: 'master')\n+  }\n+\n+  stages {\n+    stage('Initializing'){\n+      options { skipDefaultCheckout() }\n+      environment {\n+        HOME = \"${env.WORKSPACE}\"\n+        JAVA_HOME = \"${env.HUDSON_HOME}/.java/java10\"\n+        PATH = \"${env.JAVA_HOME}/bin:${env.PATH}\"\n+        MAVEN_CONFIG = \"${params.MAVEN_CONFIG} ${env.MAVEN_CONFIG}\"\n+      }\n+      stages {\n+        /**\n+         Checkout the code\n+        */\n+        stage('Checkout') {\n+          steps {\n+            dir(\"${BASE_DIR}\") {\n+              // This is required to ensure that Maven is working with a real branch\n+              sh(script: \"git checkout -f {$branch_specifier}\")\n+            }\n+          }\n+        }\n+      }\n+    }\n+    stage('Release') {\n+      options { skipDefaultCheckout () }\n+      stages{\n+        // 1. Check to see if oss.sonatype.org is up. We throw an exception and fail the job if there is no response.\n+        stage('Check oss.sonatype.org') {\n+          steps {\n+            // If this fails, an exception should be thrown and execution will halt\n+            httpRequest(url: \"https://oss.sonatype.org/#welcome\")\n+          }\n+        }\n+        // 2. Review project version.\n+        stage('Review project version') {\n+          steps {\n+            script {\n+              // Show the select input modal\n+              def INPUT_PARAMS = input message: 'Do you wish to update the version?', ok: 'Next', parameters: [choice(name: 'UPDATE_CHOICE', choices:['Yes', 'No'], description: \"This will run `mvn release:update-versions`\")]\n+              if (INPUT_PARAMS == 'Yes') {\n+                  dir(\"${BASE_DIR}\") {\n+                    sh mvn release:update-versions\n+                  }\n+              } else {\n+                  echo 'Skipping version update'\n+              }\n+            }\n+          }\n+        }\n+        // 3. Execute the release Jenkins job on the internal ci server.\n+            // For now we assume that the release has been pushed to staging already on the internal CI\n+        // 4. Login to oss.sonatype.org, go to Staging Repositories, close and release the staged artifacts.\n+        stage('Nexus release') {\n+          steps {\n+            script {\n+              def spid = getVault('nexus')[\"staging-profile-id\"]\n+              dir(\"${BASE_DIR}\"){\n+                withEnvMask(vars: [[var: \"SPID\", password: spid]]){\n+                  def foundStagingId = nexusFindStagingId(stagingProfileId: \"${SPID}\", groupId: \"co.elastic.apm\")\n+                  nexusCloseStagingRepository(stagingProfileId: \"${SPID}\", stagingId: foundStagingId)\n+                  nexusReleaseStagingRepository(stagingProfileId: \"${SPID}\", stagingId: foundStagingId)\n+                }\n+\n+              }\n+            }\n+          }\n+        }\n+        // 5. Fetch and checkout the latest tag e.g. git fetch origin\n+          // We already have this :)\n+        // 6. If this was a major release, create a new branch for the major.\n+        stage('Branch creation') {\n+          steps {\n+            dir(\"${BASE_DIR}\") {\n+              script {\n+                def isMajor = sh(script: 'git tag|tail -1|cut -f2-3 -d \".\"|{ read ver; test $ver == \"0.0\"; }', returnStatus: true)\n+                if (isMajor == 0) {\n+                  // We need to create a new branch. First get the name of the branch\n+                  def newBranchName = sh(script: 'git tag|tail -1|sed s/v//|cut -f1 -d \".\"|awk \\'{print $1\".x\"}\\'', returnStdout: true)\n+                  echo \"This appears to be a major version. We are creating a new branch for $newBranchName in the apm-agent-java repo on GitHub.\"\n+                  // Now we need to branch\n+                  sh(script: \"git checkout -b $newBranchName\")\n+                  // And push\n+                  githubEnv()\n+                  gitPush() \n+                  // 6.1 Add the new branch to the conf.yaml in the docs repo\n+                  input message: \"This was a major version release. Please update the conf.yml in the docs repo before continuing\", ok \"Continue\"\n+                } else {  // This was a minor release\n+                  // 7. If this was a minor release, reset the current major branch (1.x, 2.x etc) to point to the current tag, e.g. git branch -f 1.x v1.1.0\n+                  // Determine current tag\n+                  def curTag = sh(script: \"git tag|tail -1\", returnStdout: true)\n+                  def targetBranch = sh(script: 'git tag|tail -1|sed s/v//|cut -f1 -d '.'|awk \\'{print $1\".x\"}\\'', returnStdout: true)\n+                  sh(script: \"git branch -f $targetBranch $curTag\")\n+                  gitPush()\n+                }\n+              }\n+              // Checkout the tag again!\n+              sh(\"git checkout ${BUILD_TAG}\")\n+            }\n+          }\n+        }\n+        // 8. Update CHANGELOG.asciidoc to reflect version release. Go over PRs or git log and add bug fixes and features. \n+        stage('Generate a proposed CHANGELOG') {\n+          steps {\n+            githubEnv()\n+            generateChangelog(repo: 'apm-agent-java')\n+          }\n+        }\n+        // 9. Go to elastic/apm-agent-java/releases and draft a new release. Provide a link to release notes in documentation as release description.\n+        stage('Create GitHub release draft') {\n+          steps {\n+            dir(\"${BASE_DIR}\"){\n+              script {\n+                def curTag = sh(script: \"git tag|tail -1\", returnStdout: true)\n+                // Construct the URL with anchor for the release notes\n+                // Ex: https://www.elastic.co/guide/en/apm/agent/java/current/release-notes-1.x.html#release-notes-1.13.0\n+                def baseUrl = \"https://www.elastic.co/guide/en/apm/agent/java/current/release-notes-\"\n+                def dotX = sh(script: 'git tag|tail -1|sed s/v//|cut -f1 -d \".\"|awk \\'{print $1\".x\"}\\'', returnStdout: true)\n+                def bareTag = sh(script: 'git tag|tail -1|sed s/v//', returnStdout: true)\n+                def finalUrl = sh(script: \"echo $baseUrl$dotX\\.html#release-notes-$bareTag\")\n+                def ret = githubReleaseCreate(draft: true, body: \"[Release Notes for $bareTag]($finalUrl)\")\n+                env.RELEASE_ID = ret['id']\n+              }\n+            }\n+\n+          }\n+        }\n+        // 10. Update cloudfoundry/index.yml\n+        // Needs to append a line such as the following:\n+        // 1.13.0: https://repo1.maven.org/maven2/co/elastic/apm/elastic-apm-agent/1.13.0/elastic-apm-agent-1.13.0.jar\n+        stage('Update Cloudfoundry') {\n+          steps {\n+            dir(\"${basedir}\") {\n+              script {\n+                sh(\"git checkout master\")\n+                def bareTag = sh(script: 'git tag|tail -1|sed s/v//', returnStdout: true)\n+                def baseUrl = \"https://repo1.maven.org/maven2/co/elastic/apm/elastic-apm-agent\"\n+                def lineToAppend = sh(script: \"echo '$baseUrl: $baseUrl/$bareTag/elastic-apm-agent-$bareTag\\.jar' >> cloudfoundry/index.yml \")\n+                gitPush()\n+              }\n+            }\n+          }\n+        }\n+        // 11. Wait for released package to be available in maven central\n+        stage('Wait for artifact to be available in Maven Central') {\n+          steps {\n+            dir(\"${BASE_DIR}\"){\n+              script {\n+                // We are looking for something like this:\n+                // https://oss.sonatype.org/service/local/repositories/releases/content/co/elastic/apm/apm-agent-java/1.1.12/apm-agent-java-1.1.12.pom\n+                def baseUrl = \"https://oss.sonatype.org/service/local/repositories/releases/content/co/elastic/apm/apm-agent-java\"\n+                def bareTag = sh(script: 'git tag|tail -1|sed s/v//', returnStdout: true)\n+                def fullUrl = sh(script: \"$baseUrl/$bareTag/apm-agent-java-$bareTag\\.pom\")\n+                waitUntil(initialRecurrencePeriod: 15000) {\n+                  script {\n+                    def ret = sh(script: \"curl -fs $fullUrl >/dev/null 2>&1\", returnStatus: true)\n+                    echo \"Waiting for the artifacts to be published on Sonatype\"\n+                    return ret == 0\n+                  }\n+                }\n+              }\n+            }\n+\n+          }\n+        }\n+        // 12. Publish release on Github. This will notify users watching repository.\n+        stage('Publish release on GitHub') {\n+          steps {\n+            githubReleasePublish(id: ${env.RELEASE_ID})\n+          }\n+        }\n+        // 13. Publish Docker images\n+        stage('Docker push') {\n+          when {\n+            beforeAgent true\n+            expression { return params.push_docker }\n+          }\n+          steps {\n+            sh(label: \"Build Docker image\", script: \"scripts/jenkins/build_docker.sh\")\n+            // Get Docker registry credentials\n+            dockerLogin(secret: \"${ELASTIC_DOCKER_SECRET}\", registry: 'docker.elastic.co')\n+            sh(label: \"Push Docker image\", script: \"scripts/jenkins/push_docker.sh\")\n+          }\n+        }\n+        // 14. Opbeans\n+        stage('Opbeans') {", "originalCommit": "f668eabc167475153708ee930eab7cd48907c9c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ1NzU3OQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r390457579", "bodyText": "@v1v Do you mean this this conditional specifically?\n      when {\n        tag pattern: 'v\\\\d+\\\\.\\\\d+\\\\.\\\\d+', comparator: 'REGEXP'\n      }", "author": "cachedout", "createdAt": "2020-03-10T16:45:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgwNjk3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ4MTE3OQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r390481179", "bodyText": "Let me clarify, I meant, this particular stage could be kept in the other CI Jenkinsfile. IIUC, this particular pipeline will be triggered for the master branch and as a consequence, it will create a tag/branch with the version.\nTherefore, the other CI Jenkinsfile could be kept as it was, it was configured to listen for branches/tags/PRs and the when condition in place will care of running that particular stage.\nI think it might help to simplify this pipeline. what do you think?", "author": "v1v", "createdAt": "2020-03-10T17:20:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgwNjk3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkyMzcwMQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r390923701", "bodyText": "Gotcha! I agree and have restored the original logic. Thanks!", "author": "cachedout", "createdAt": "2020-03-11T12:02:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgwNjk3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgwNzczMA==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r385807730", "bodyText": "nit:\nmaybe DEFAULT_MAVEN_CONFIG ?", "author": "v1v", "createdAt": "2020-02-28T16:54:20Z", "path": ".ci/release/Jenkinsfile", "diffHunk": "@@ -0,0 +1,235 @@\n+#!/usr/bin/env groovy\n+\n+@Library('apm@current') _\n+pipeline {\n+  agent { label 'linux && immutable' }\n+  environment {\n+    REPO = 'apm-agent-java'\n+    BASE_DIR = \"src/github.com/elastic/${env.REPO}\"\n+    NOTIFY_TO = credentials('notify-to')\n+    DOCKERHUB_SECRET = 'secret/apm-team/ci/elastic-observability-dockerhub'\n+    ELASTIC_DOCKER_SECRET = 'secret/apm-team/ci/docker-registry/prod'\n+    NEXUS_SECRET = 'secret/apm-team/ci/nexus'\n+    MAVEN_CONFIG = '-Dmaven.repo.local=.m2'", "originalCommit": "f668eabc167475153708ee930eab7cd48907c9c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgxMjIyNw==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r385812227", "bodyText": "I said nothing, that's how it's defined in the other Jenkinsfile!", "author": "v1v", "createdAt": "2020-02-28T17:03:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgwNzczMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjI5NzA3Mg==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r386297072", "bodyText": "Aye. I just moved it from there. :)", "author": "cachedout", "createdAt": "2020-03-02T10:03:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgwNzczMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU3MjI4Nw==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r389572287", "bodyText": "What are the use-cases of overriding maven config on a per build basis ? I'm pretty sure we haven't had to use this so far.", "author": "SylvainJuge", "createdAt": "2020-03-09T10:23:49Z", "path": ".ci/release/Jenkinsfile", "diffHunk": "@@ -0,0 +1,235 @@\n+#!/usr/bin/env groovy\n+\n+@Library('apm@current') _\n+pipeline {\n+  agent { label 'linux && immutable' }\n+  environment {\n+    REPO = 'apm-agent-java'\n+    BASE_DIR = \"src/github.com/elastic/${env.REPO}\"\n+    NOTIFY_TO = credentials('notify-to')\n+    DOCKERHUB_SECRET = 'secret/apm-team/ci/elastic-observability-dockerhub'\n+    ELASTIC_DOCKER_SECRET = 'secret/apm-team/ci/docker-registry/prod'\n+    NEXUS_SECRET = 'secret/apm-team/ci/nexus'\n+    MAVEN_CONFIG = '-Dmaven.repo.local=.m2'\n+    OPBEANS_REPO = 'opbeans-java'\n+\n+  }\n+  options {\n+    timeout(time: 3, unit: 'HOURS')\n+    buildDiscarder(logRotator(numToKeepStr: '20', artifactNumToKeepStr: '20', daysToKeepStr: '30'))\n+    timestamps()\n+    ansiColor('xterm')\n+    durabilityHint('PERFORMANCE_OPTIMIZED')\n+\n+  }\n+  parameters {\n+    string(name: 'MAVEN_CONFIG', defaultValue: '-B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn', description: 'Additional maven options.')", "originalCommit": "f668eabc167475153708ee930eab7cd48907c9c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU5MjQyNA==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r389592424", "bodyText": "Very good question. I used the original Jenkinsfile as a skeleton for this one and that's where this came from. I don't see where it would come into play in this workflow, however, so I think it is safe to remove.", "author": "cachedout", "createdAt": "2020-03-09T11:05:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU3MjI4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDMyMDE0OA==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r390320148", "bodyText": "I have consolidated this into a single step in this commit.", "author": "cachedout", "createdAt": "2020-03-10T13:41:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU3MjI4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU3NDUxOA==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r389574518", "bodyText": "we switched to using versions plugin instead in latest version of the release instructions https://github.com/elastic/apm-agent-java/blob/master/CONTRIBUTING.md#releasing", "author": "SylvainJuge", "createdAt": "2020-03-09T10:28:04Z", "path": ".ci/release/Jenkinsfile", "diffHunk": "@@ -0,0 +1,235 @@\n+#!/usr/bin/env groovy\n+\n+@Library('apm@current') _\n+pipeline {\n+  agent { label 'linux && immutable' }\n+  environment {\n+    REPO = 'apm-agent-java'\n+    BASE_DIR = \"src/github.com/elastic/${env.REPO}\"\n+    NOTIFY_TO = credentials('notify-to')\n+    DOCKERHUB_SECRET = 'secret/apm-team/ci/elastic-observability-dockerhub'\n+    ELASTIC_DOCKER_SECRET = 'secret/apm-team/ci/docker-registry/prod'\n+    NEXUS_SECRET = 'secret/apm-team/ci/nexus'\n+    MAVEN_CONFIG = '-Dmaven.repo.local=.m2'\n+    OPBEANS_REPO = 'opbeans-java'\n+\n+  }\n+  options {\n+    timeout(time: 3, unit: 'HOURS')\n+    buildDiscarder(logRotator(numToKeepStr: '20', artifactNumToKeepStr: '20', daysToKeepStr: '30'))\n+    timestamps()\n+    ansiColor('xterm')\n+    durabilityHint('PERFORMANCE_OPTIMIZED')\n+\n+  }\n+  parameters {\n+    string(name: 'MAVEN_CONFIG', defaultValue: '-B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn', description: 'Additional maven options.')\n+    string(name: 'branch_specifier', defaultValue: 'master')\n+  }\n+\n+  stages {\n+    stage('Initializing'){\n+      options { skipDefaultCheckout() }\n+      environment {\n+        HOME = \"${env.WORKSPACE}\"\n+        JAVA_HOME = \"${env.HUDSON_HOME}/.java/java10\"\n+        PATH = \"${env.JAVA_HOME}/bin:${env.PATH}\"\n+        MAVEN_CONFIG = \"${params.MAVEN_CONFIG} ${env.MAVEN_CONFIG}\"\n+      }\n+      stages {\n+        /**\n+         Checkout the code\n+        */\n+        stage('Checkout') {\n+          steps {\n+            dir(\"${BASE_DIR}\") {\n+              // This is required to ensure that Maven is working with a real branch\n+              sh(script: \"git checkout -f {$branch_specifier}\")\n+            }\n+          }\n+        }\n+      }\n+    }\n+    stage('Release') {\n+      options { skipDefaultCheckout () }\n+      stages{\n+        // 1. Check to see if oss.sonatype.org is up. We throw an exception and fail the job if there is no response.\n+        stage('Check oss.sonatype.org') {\n+          steps {\n+            // If this fails, an exception should be thrown and execution will halt\n+            httpRequest(url: \"https://oss.sonatype.org/#welcome\")\n+          }\n+        }\n+        // 2. Review project version.\n+        stage('Review project version') {\n+          steps {\n+            script {\n+              // Show the select input modal\n+              def INPUT_PARAMS = input message: 'Do you wish to update the version?', ok: 'Next', parameters: [choice(name: 'UPDATE_CHOICE', choices:['Yes', 'No'], description: \"This will run `mvn release:update-versions`\")]\n+              if (INPUT_PARAMS == 'Yes') {\n+                  dir(\"${BASE_DIR}\") {\n+                    sh mvn release:update-versions", "originalCommit": "f668eabc167475153708ee930eab7cd48907c9c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU5NzIwOA==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r389597208", "bodyText": "Ah! Glad you caught that. Thanks! I will make this change.", "author": "cachedout", "createdAt": "2020-03-09T11:15:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU3NDUxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTY1OTE1NA==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r389659154", "bodyText": "As mentioned in my comment, the change was mostly due to having the release plugin to change formatting in pom.xml, and not just update versions.", "author": "SylvainJuge", "createdAt": "2020-03-09T13:24:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU3NDUxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTAzNjE3NA==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r391036174", "bodyText": "I have updated this stage substantially. The new workflow is as follows:\n\n\nDisplay the current version present in pom.xml and ask the user if they would like to do an update. If they select \"no\", then execution continues to the next stage.\n\n\nIf \"yes\" has been selected, an additional dialog appears again displaying the current version along with an input field for the user to enter a new version.\n\n\nAfter submitting the new version, mvn versions:set -DnewVersion=${new_version} is run.\n\n\nExecution continues from there.", "author": "cachedout", "createdAt": "2020-03-11T15:01:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU3NDUxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU3NDkxMw==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r389574913", "bodyText": "does the #welcome part of the URL matters here ?", "author": "SylvainJuge", "createdAt": "2020-03-09T10:28:46Z", "path": ".ci/release/Jenkinsfile", "diffHunk": "@@ -0,0 +1,235 @@\n+#!/usr/bin/env groovy\n+\n+@Library('apm@current') _\n+pipeline {\n+  agent { label 'linux && immutable' }\n+  environment {\n+    REPO = 'apm-agent-java'\n+    BASE_DIR = \"src/github.com/elastic/${env.REPO}\"\n+    NOTIFY_TO = credentials('notify-to')\n+    DOCKERHUB_SECRET = 'secret/apm-team/ci/elastic-observability-dockerhub'\n+    ELASTIC_DOCKER_SECRET = 'secret/apm-team/ci/docker-registry/prod'\n+    NEXUS_SECRET = 'secret/apm-team/ci/nexus'\n+    MAVEN_CONFIG = '-Dmaven.repo.local=.m2'\n+    OPBEANS_REPO = 'opbeans-java'\n+\n+  }\n+  options {\n+    timeout(time: 3, unit: 'HOURS')\n+    buildDiscarder(logRotator(numToKeepStr: '20', artifactNumToKeepStr: '20', daysToKeepStr: '30'))\n+    timestamps()\n+    ansiColor('xterm')\n+    durabilityHint('PERFORMANCE_OPTIMIZED')\n+\n+  }\n+  parameters {\n+    string(name: 'MAVEN_CONFIG', defaultValue: '-B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn', description: 'Additional maven options.')\n+    string(name: 'branch_specifier', defaultValue: 'master')\n+  }\n+\n+  stages {\n+    stage('Initializing'){\n+      options { skipDefaultCheckout() }\n+      environment {\n+        HOME = \"${env.WORKSPACE}\"\n+        JAVA_HOME = \"${env.HUDSON_HOME}/.java/java10\"\n+        PATH = \"${env.JAVA_HOME}/bin:${env.PATH}\"\n+        MAVEN_CONFIG = \"${params.MAVEN_CONFIG} ${env.MAVEN_CONFIG}\"\n+      }\n+      stages {\n+        /**\n+         Checkout the code\n+        */\n+        stage('Checkout') {\n+          steps {\n+            dir(\"${BASE_DIR}\") {\n+              // This is required to ensure that Maven is working with a real branch\n+              sh(script: \"git checkout -f {$branch_specifier}\")\n+            }\n+          }\n+        }\n+      }\n+    }\n+    stage('Release') {\n+      options { skipDefaultCheckout () }\n+      stages{\n+        // 1. Check to see if oss.sonatype.org is up. We throw an exception and fail the job if there is no response.\n+        stage('Check oss.sonatype.org') {\n+          steps {\n+            // If this fails, an exception should be thrown and execution will halt\n+            httpRequest(url: \"https://oss.sonatype.org/#welcome\")", "originalCommit": "f668eabc167475153708ee930eab7cd48907c9c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU5NTYxNA==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r389595614", "bodyText": "It doesn't matter. The root of the site redirects here so I just put it in to avoid the (slight) overhead of the redirect.", "author": "cachedout", "createdAt": "2020-03-09T11:12:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU3NDkxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYyOTg1Ng==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r389629856", "bodyText": "For a future improvement: could we use this: https://status.maven.org/history.atom", "author": "felixbarny", "createdAt": "2020-03-09T12:30:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU3NDkxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDMxNjU5MQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r390316591", "bodyText": "A while ago I looked into using the Atom feed for this kind of thing but it's fraught with problems. Unfortunately, it's basically just free-text and there is no clear way to determine whether a given entry represents an ongoing outage, a recovery, an announcement, or free puppies. \ud83d\udc36 I have some ideas about how to do this kind of thing in the future with Github since they have enabled webhooks. My current plan is to get that working and then see if Sonatype is open to the possibility of using webhooks on their page as well.", "author": "cachedout", "createdAt": "2020-03-10T13:36:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU3NDkxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU3OTc3Mg==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r389579772", "bodyText": "probably worth having a non-obscure credentials ID and/or a proper env variable for this.", "author": "SylvainJuge", "createdAt": "2020-03-09T10:38:15Z", "path": ".ci/release/Jenkinsfile", "diffHunk": "@@ -0,0 +1,235 @@\n+#!/usr/bin/env groovy\n+\n+@Library('apm@current') _\n+pipeline {\n+  agent { label 'linux && immutable' }\n+  environment {\n+    REPO = 'apm-agent-java'\n+    BASE_DIR = \"src/github.com/elastic/${env.REPO}\"\n+    NOTIFY_TO = credentials('notify-to')\n+    DOCKERHUB_SECRET = 'secret/apm-team/ci/elastic-observability-dockerhub'\n+    ELASTIC_DOCKER_SECRET = 'secret/apm-team/ci/docker-registry/prod'\n+    NEXUS_SECRET = 'secret/apm-team/ci/nexus'\n+    MAVEN_CONFIG = '-Dmaven.repo.local=.m2'\n+    OPBEANS_REPO = 'opbeans-java'\n+\n+  }\n+  options {\n+    timeout(time: 3, unit: 'HOURS')\n+    buildDiscarder(logRotator(numToKeepStr: '20', artifactNumToKeepStr: '20', daysToKeepStr: '30'))\n+    timestamps()\n+    ansiColor('xterm')\n+    durabilityHint('PERFORMANCE_OPTIMIZED')\n+\n+  }\n+  parameters {\n+    string(name: 'MAVEN_CONFIG', defaultValue: '-B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn', description: 'Additional maven options.')\n+    string(name: 'branch_specifier', defaultValue: 'master')\n+  }\n+\n+  stages {\n+    stage('Initializing'){\n+      options { skipDefaultCheckout() }\n+      environment {\n+        HOME = \"${env.WORKSPACE}\"\n+        JAVA_HOME = \"${env.HUDSON_HOME}/.java/java10\"\n+        PATH = \"${env.JAVA_HOME}/bin:${env.PATH}\"\n+        MAVEN_CONFIG = \"${params.MAVEN_CONFIG} ${env.MAVEN_CONFIG}\"\n+      }\n+      stages {\n+        /**\n+         Checkout the code\n+        */\n+        stage('Checkout') {\n+          steps {\n+            dir(\"${BASE_DIR}\") {\n+              // This is required to ensure that Maven is working with a real branch\n+              sh(script: \"git checkout -f {$branch_specifier}\")\n+            }\n+          }\n+        }\n+      }\n+    }\n+    stage('Release') {\n+      options { skipDefaultCheckout () }\n+      stages{\n+        // 1. Check to see if oss.sonatype.org is up. We throw an exception and fail the job if there is no response.\n+        stage('Check oss.sonatype.org') {\n+          steps {\n+            // If this fails, an exception should be thrown and execution will halt\n+            httpRequest(url: \"https://oss.sonatype.org/#welcome\")\n+          }\n+        }\n+        // 2. Review project version.\n+        stage('Review project version') {\n+          steps {\n+            script {\n+              // Show the select input modal\n+              def INPUT_PARAMS = input message: 'Do you wish to update the version?', ok: 'Next', parameters: [choice(name: 'UPDATE_CHOICE', choices:['Yes', 'No'], description: \"This will run `mvn release:update-versions`\")]\n+              if (INPUT_PARAMS == 'Yes') {\n+                  dir(\"${BASE_DIR}\") {\n+                    sh mvn release:update-versions\n+                  }\n+              } else {\n+                  echo 'Skipping version update'\n+              }\n+            }\n+          }\n+        }\n+        // 3. Execute the release Jenkins job on the internal ci server.\n+            // For now we assume that the release has been pushed to staging already on the internal CI\n+        // 4. Login to oss.sonatype.org, go to Staging Repositories, close and release the staged artifacts.\n+        stage('Nexus release') {\n+          steps {\n+            script {\n+              def spid = getVault('nexus')[\"staging-profile-id\"]\n+              dir(\"${BASE_DIR}\"){\n+                withEnvMask(vars: [[var: \"SPID\", password: spid]]){\n+                  def foundStagingId = nexusFindStagingId(stagingProfileId: \"${SPID}\", groupId: \"co.elastic.apm\")\n+                  nexusCloseStagingRepository(stagingProfileId: \"${SPID}\", stagingId: foundStagingId)\n+                  nexusReleaseStagingRepository(stagingProfileId: \"${SPID}\", stagingId: foundStagingId)\n+                }\n+\n+              }\n+            }\n+          }\n+        }\n+        // 5. Fetch and checkout the latest tag e.g. git fetch origin\n+          // We already have this :)\n+        // 6. If this was a major release, create a new branch for the major.\n+        stage('Branch creation') {\n+          steps {\n+            dir(\"${BASE_DIR}\") {\n+              script {\n+                def isMajor = sh(script: 'git tag|tail -1|cut -f2-3 -d \".\"|{ read ver; test $ver == \"0.0\"; }', returnStatus: true)\n+                if (isMajor == 0) {\n+                  // We need to create a new branch. First get the name of the branch\n+                  def newBranchName = sh(script: 'git tag|tail -1|sed s/v//|cut -f1 -d \".\"|awk \\'{print $1\".x\"}\\'', returnStdout: true)\n+                  echo \"This appears to be a major version. We are creating a new branch for $newBranchName in the apm-agent-java repo on GitHub.\"\n+                  // Now we need to branch\n+                  sh(script: \"git checkout -b $newBranchName\")\n+                  // And push\n+                  githubEnv()\n+                  gitPush() \n+                  // 6.1 Add the new branch to the conf.yaml in the docs repo\n+                  input message: \"This was a major version release. Please update the conf.yml in the docs repo before continuing\", ok \"Continue\"\n+                } else {  // This was a minor release\n+                  // 7. If this was a minor release, reset the current major branch (1.x, 2.x etc) to point to the current tag, e.g. git branch -f 1.x v1.1.0\n+                  // Determine current tag\n+                  def curTag = sh(script: \"git tag|tail -1\", returnStdout: true)\n+                  def targetBranch = sh(script: 'git tag|tail -1|sed s/v//|cut -f1 -d '.'|awk \\'{print $1\".x\"}\\'', returnStdout: true)\n+                  sh(script: \"git branch -f $targetBranch $curTag\")\n+                  gitPush()\n+                }\n+              }\n+              // Checkout the tag again!\n+              sh(\"git checkout ${BUILD_TAG}\")\n+            }\n+          }\n+        }\n+        // 8. Update CHANGELOG.asciidoc to reflect version release. Go over PRs or git log and add bug fixes and features. \n+        stage('Generate a proposed CHANGELOG') {\n+          steps {\n+            githubEnv()\n+            generateChangelog(repo: 'apm-agent-java')\n+          }\n+        }\n+        // 9. Go to elastic/apm-agent-java/releases and draft a new release. Provide a link to release notes in documentation as release description.\n+        stage('Create GitHub release draft') {\n+          steps {\n+            dir(\"${BASE_DIR}\"){\n+              script {\n+                def curTag = sh(script: \"git tag|tail -1\", returnStdout: true)\n+                // Construct the URL with anchor for the release notes\n+                // Ex: https://www.elastic.co/guide/en/apm/agent/java/current/release-notes-1.x.html#release-notes-1.13.0\n+                def baseUrl = \"https://www.elastic.co/guide/en/apm/agent/java/current/release-notes-\"\n+                def dotX = sh(script: 'git tag|tail -1|sed s/v//|cut -f1 -d \".\"|awk \\'{print $1\".x\"}\\'', returnStdout: true)\n+                def bareTag = sh(script: 'git tag|tail -1|sed s/v//', returnStdout: true)\n+                def finalUrl = sh(script: \"echo $baseUrl$dotX\\.html#release-notes-$bareTag\")\n+                def ret = githubReleaseCreate(draft: true, body: \"[Release Notes for $bareTag]($finalUrl)\")\n+                env.RELEASE_ID = ret['id']\n+              }\n+            }\n+\n+          }\n+        }\n+        // 10. Update cloudfoundry/index.yml\n+        // Needs to append a line such as the following:\n+        // 1.13.0: https://repo1.maven.org/maven2/co/elastic/apm/elastic-apm-agent/1.13.0/elastic-apm-agent-1.13.0.jar\n+        stage('Update Cloudfoundry') {\n+          steps {\n+            dir(\"${basedir}\") {\n+              script {\n+                sh(\"git checkout master\")\n+                def bareTag = sh(script: 'git tag|tail -1|sed s/v//', returnStdout: true)\n+                def baseUrl = \"https://repo1.maven.org/maven2/co/elastic/apm/elastic-apm-agent\"\n+                def lineToAppend = sh(script: \"echo '$baseUrl: $baseUrl/$bareTag/elastic-apm-agent-$bareTag\\.jar' >> cloudfoundry/index.yml \")\n+                gitPush()\n+              }\n+            }\n+          }\n+        }\n+        // 11. Wait for released package to be available in maven central\n+        stage('Wait for artifact to be available in Maven Central') {\n+          steps {\n+            dir(\"${BASE_DIR}\"){\n+              script {\n+                // We are looking for something like this:\n+                // https://oss.sonatype.org/service/local/repositories/releases/content/co/elastic/apm/apm-agent-java/1.1.12/apm-agent-java-1.1.12.pom\n+                def baseUrl = \"https://oss.sonatype.org/service/local/repositories/releases/content/co/elastic/apm/apm-agent-java\"\n+                def bareTag = sh(script: 'git tag|tail -1|sed s/v//', returnStdout: true)\n+                def fullUrl = sh(script: \"$baseUrl/$bareTag/apm-agent-java-$bareTag\\.pom\")\n+                waitUntil(initialRecurrencePeriod: 15000) {\n+                  script {\n+                    def ret = sh(script: \"curl -fs $fullUrl >/dev/null 2>&1\", returnStatus: true)\n+                    echo \"Waiting for the artifacts to be published on Sonatype\"\n+                    return ret == 0\n+                  }\n+                }\n+              }\n+            }\n+\n+          }\n+        }\n+        // 12. Publish release on Github. This will notify users watching repository.\n+        stage('Publish release on GitHub') {\n+          steps {\n+            githubReleasePublish(id: ${env.RELEASE_ID})\n+          }\n+        }\n+        // 13. Publish Docker images\n+        stage('Docker push') {\n+          when {\n+            beforeAgent true\n+            expression { return params.push_docker }\n+          }\n+          steps {\n+            sh(label: \"Build Docker image\", script: \"scripts/jenkins/build_docker.sh\")\n+            // Get Docker registry credentials\n+            dockerLogin(secret: \"${ELASTIC_DOCKER_SECRET}\", registry: 'docker.elastic.co')\n+            sh(label: \"Push Docker image\", script: \"scripts/jenkins/push_docker.sh\")\n+          }\n+        }\n+        // 14. Opbeans\n+        stage('Opbeans') {\n+          environment {\n+            REPO_NAME = \"${OPBEANS_REPO}\"\n+          }\n+          steps {\n+            deleteDir()\n+            dir(\"${OPBEANS_REPO}\"){\n+              git credentialsId: 'f6c7695a-671e-4f4f-a331-acdce44ff9ba',", "originalCommit": "f668eabc167475153708ee930eab7cd48907c9c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU5Njk3NA==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r389596974", "bodyText": "Using this method, we can use Jenkins secure credentials storage to ensure that we don't leak credentials to the log. Could you please elaborate on your reason for wanting this not to be obscured?", "author": "cachedout", "createdAt": "2020-03-09T11:15:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU3OTc3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTY2MDU1OA==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r389660558", "bodyText": "There is no special reason, I was just surprised to not have something referred by a human-friendly name here.", "author": "SylvainJuge", "createdAt": "2020-03-09T13:25:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU3OTc3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU4MDUzNg==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r389580536", "bodyText": "What controls params.push_docker value ? Isn't it always true for release pipeline ?", "author": "SylvainJuge", "createdAt": "2020-03-09T10:39:56Z", "path": ".ci/release/Jenkinsfile", "diffHunk": "@@ -0,0 +1,235 @@\n+#!/usr/bin/env groovy\n+\n+@Library('apm@current') _\n+pipeline {\n+  agent { label 'linux && immutable' }\n+  environment {\n+    REPO = 'apm-agent-java'\n+    BASE_DIR = \"src/github.com/elastic/${env.REPO}\"\n+    NOTIFY_TO = credentials('notify-to')\n+    DOCKERHUB_SECRET = 'secret/apm-team/ci/elastic-observability-dockerhub'\n+    ELASTIC_DOCKER_SECRET = 'secret/apm-team/ci/docker-registry/prod'\n+    NEXUS_SECRET = 'secret/apm-team/ci/nexus'\n+    MAVEN_CONFIG = '-Dmaven.repo.local=.m2'\n+    OPBEANS_REPO = 'opbeans-java'\n+\n+  }\n+  options {\n+    timeout(time: 3, unit: 'HOURS')\n+    buildDiscarder(logRotator(numToKeepStr: '20', artifactNumToKeepStr: '20', daysToKeepStr: '30'))\n+    timestamps()\n+    ansiColor('xterm')\n+    durabilityHint('PERFORMANCE_OPTIMIZED')\n+\n+  }\n+  parameters {\n+    string(name: 'MAVEN_CONFIG', defaultValue: '-B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn', description: 'Additional maven options.')\n+    string(name: 'branch_specifier', defaultValue: 'master')\n+  }\n+\n+  stages {\n+    stage('Initializing'){\n+      options { skipDefaultCheckout() }\n+      environment {\n+        HOME = \"${env.WORKSPACE}\"\n+        JAVA_HOME = \"${env.HUDSON_HOME}/.java/java10\"\n+        PATH = \"${env.JAVA_HOME}/bin:${env.PATH}\"\n+        MAVEN_CONFIG = \"${params.MAVEN_CONFIG} ${env.MAVEN_CONFIG}\"\n+      }\n+      stages {\n+        /**\n+         Checkout the code\n+        */\n+        stage('Checkout') {\n+          steps {\n+            dir(\"${BASE_DIR}\") {\n+              // This is required to ensure that Maven is working with a real branch\n+              sh(script: \"git checkout -f {$branch_specifier}\")\n+            }\n+          }\n+        }\n+      }\n+    }\n+    stage('Release') {\n+      options { skipDefaultCheckout () }\n+      stages{\n+        // 1. Check to see if oss.sonatype.org is up. We throw an exception and fail the job if there is no response.\n+        stage('Check oss.sonatype.org') {\n+          steps {\n+            // If this fails, an exception should be thrown and execution will halt\n+            httpRequest(url: \"https://oss.sonatype.org/#welcome\")\n+          }\n+        }\n+        // 2. Review project version.\n+        stage('Review project version') {\n+          steps {\n+            script {\n+              // Show the select input modal\n+              def INPUT_PARAMS = input message: 'Do you wish to update the version?', ok: 'Next', parameters: [choice(name: 'UPDATE_CHOICE', choices:['Yes', 'No'], description: \"This will run `mvn release:update-versions`\")]\n+              if (INPUT_PARAMS == 'Yes') {\n+                  dir(\"${BASE_DIR}\") {\n+                    sh mvn release:update-versions\n+                  }\n+              } else {\n+                  echo 'Skipping version update'\n+              }\n+            }\n+          }\n+        }\n+        // 3. Execute the release Jenkins job on the internal ci server.\n+            // For now we assume that the release has been pushed to staging already on the internal CI\n+        // 4. Login to oss.sonatype.org, go to Staging Repositories, close and release the staged artifacts.\n+        stage('Nexus release') {\n+          steps {\n+            script {\n+              def spid = getVault('nexus')[\"staging-profile-id\"]\n+              dir(\"${BASE_DIR}\"){\n+                withEnvMask(vars: [[var: \"SPID\", password: spid]]){\n+                  def foundStagingId = nexusFindStagingId(stagingProfileId: \"${SPID}\", groupId: \"co.elastic.apm\")\n+                  nexusCloseStagingRepository(stagingProfileId: \"${SPID}\", stagingId: foundStagingId)\n+                  nexusReleaseStagingRepository(stagingProfileId: \"${SPID}\", stagingId: foundStagingId)\n+                }\n+\n+              }\n+            }\n+          }\n+        }\n+        // 5. Fetch and checkout the latest tag e.g. git fetch origin\n+          // We already have this :)\n+        // 6. If this was a major release, create a new branch for the major.\n+        stage('Branch creation') {\n+          steps {\n+            dir(\"${BASE_DIR}\") {\n+              script {\n+                def isMajor = sh(script: 'git tag|tail -1|cut -f2-3 -d \".\"|{ read ver; test $ver == \"0.0\"; }', returnStatus: true)\n+                if (isMajor == 0) {\n+                  // We need to create a new branch. First get the name of the branch\n+                  def newBranchName = sh(script: 'git tag|tail -1|sed s/v//|cut -f1 -d \".\"|awk \\'{print $1\".x\"}\\'', returnStdout: true)\n+                  echo \"This appears to be a major version. We are creating a new branch for $newBranchName in the apm-agent-java repo on GitHub.\"\n+                  // Now we need to branch\n+                  sh(script: \"git checkout -b $newBranchName\")\n+                  // And push\n+                  githubEnv()\n+                  gitPush() \n+                  // 6.1 Add the new branch to the conf.yaml in the docs repo\n+                  input message: \"This was a major version release. Please update the conf.yml in the docs repo before continuing\", ok \"Continue\"\n+                } else {  // This was a minor release\n+                  // 7. If this was a minor release, reset the current major branch (1.x, 2.x etc) to point to the current tag, e.g. git branch -f 1.x v1.1.0\n+                  // Determine current tag\n+                  def curTag = sh(script: \"git tag|tail -1\", returnStdout: true)\n+                  def targetBranch = sh(script: 'git tag|tail -1|sed s/v//|cut -f1 -d '.'|awk \\'{print $1\".x\"}\\'', returnStdout: true)\n+                  sh(script: \"git branch -f $targetBranch $curTag\")\n+                  gitPush()\n+                }\n+              }\n+              // Checkout the tag again!\n+              sh(\"git checkout ${BUILD_TAG}\")\n+            }\n+          }\n+        }\n+        // 8. Update CHANGELOG.asciidoc to reflect version release. Go over PRs or git log and add bug fixes and features. \n+        stage('Generate a proposed CHANGELOG') {\n+          steps {\n+            githubEnv()\n+            generateChangelog(repo: 'apm-agent-java')\n+          }\n+        }\n+        // 9. Go to elastic/apm-agent-java/releases and draft a new release. Provide a link to release notes in documentation as release description.\n+        stage('Create GitHub release draft') {\n+          steps {\n+            dir(\"${BASE_DIR}\"){\n+              script {\n+                def curTag = sh(script: \"git tag|tail -1\", returnStdout: true)\n+                // Construct the URL with anchor for the release notes\n+                // Ex: https://www.elastic.co/guide/en/apm/agent/java/current/release-notes-1.x.html#release-notes-1.13.0\n+                def baseUrl = \"https://www.elastic.co/guide/en/apm/agent/java/current/release-notes-\"\n+                def dotX = sh(script: 'git tag|tail -1|sed s/v//|cut -f1 -d \".\"|awk \\'{print $1\".x\"}\\'', returnStdout: true)\n+                def bareTag = sh(script: 'git tag|tail -1|sed s/v//', returnStdout: true)\n+                def finalUrl = sh(script: \"echo $baseUrl$dotX\\.html#release-notes-$bareTag\")\n+                def ret = githubReleaseCreate(draft: true, body: \"[Release Notes for $bareTag]($finalUrl)\")\n+                env.RELEASE_ID = ret['id']\n+              }\n+            }\n+\n+          }\n+        }\n+        // 10. Update cloudfoundry/index.yml\n+        // Needs to append a line such as the following:\n+        // 1.13.0: https://repo1.maven.org/maven2/co/elastic/apm/elastic-apm-agent/1.13.0/elastic-apm-agent-1.13.0.jar\n+        stage('Update Cloudfoundry') {\n+          steps {\n+            dir(\"${basedir}\") {\n+              script {\n+                sh(\"git checkout master\")\n+                def bareTag = sh(script: 'git tag|tail -1|sed s/v//', returnStdout: true)\n+                def baseUrl = \"https://repo1.maven.org/maven2/co/elastic/apm/elastic-apm-agent\"\n+                def lineToAppend = sh(script: \"echo '$baseUrl: $baseUrl/$bareTag/elastic-apm-agent-$bareTag\\.jar' >> cloudfoundry/index.yml \")\n+                gitPush()\n+              }\n+            }\n+          }\n+        }\n+        // 11. Wait for released package to be available in maven central\n+        stage('Wait for artifact to be available in Maven Central') {\n+          steps {\n+            dir(\"${BASE_DIR}\"){\n+              script {\n+                // We are looking for something like this:\n+                // https://oss.sonatype.org/service/local/repositories/releases/content/co/elastic/apm/apm-agent-java/1.1.12/apm-agent-java-1.1.12.pom\n+                def baseUrl = \"https://oss.sonatype.org/service/local/repositories/releases/content/co/elastic/apm/apm-agent-java\"\n+                def bareTag = sh(script: 'git tag|tail -1|sed s/v//', returnStdout: true)\n+                def fullUrl = sh(script: \"$baseUrl/$bareTag/apm-agent-java-$bareTag\\.pom\")\n+                waitUntil(initialRecurrencePeriod: 15000) {\n+                  script {\n+                    def ret = sh(script: \"curl -fs $fullUrl >/dev/null 2>&1\", returnStatus: true)\n+                    echo \"Waiting for the artifacts to be published on Sonatype\"\n+                    return ret == 0\n+                  }\n+                }\n+              }\n+            }\n+\n+          }\n+        }\n+        // 12. Publish release on Github. This will notify users watching repository.\n+        stage('Publish release on GitHub') {\n+          steps {\n+            githubReleasePublish(id: ${env.RELEASE_ID})\n+          }\n+        }\n+        // 13. Publish Docker images\n+        stage('Docker push') {\n+          when {\n+            beforeAgent true\n+            expression { return params.push_docker }", "originalCommit": "f668eabc167475153708ee930eab7cd48907c9c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU5NjUwOQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r389596509", "bodyText": "You are right. This came from the previous Jenkinsfile where it was gated, but that gate should not be necessary here. I will remove it. Thanks!", "author": "cachedout", "createdAt": "2020-03-09T11:14:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU4MDUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDMyNzQ0Ng==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r390327446", "bodyText": "This has been removed. Thanks for catching this!", "author": "cachedout", "createdAt": "2020-03-10T13:52:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU4MDUzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYzMTkzNg==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r389631936", "bodyText": "what happens if there are multiple staging repos (for example a leftover from a failed release)?", "author": "felixbarny", "createdAt": "2020-03-09T12:35:12Z", "path": ".ci/release/Jenkinsfile", "diffHunk": "@@ -0,0 +1,235 @@\n+#!/usr/bin/env groovy\n+\n+@Library('apm@current') _\n+pipeline {\n+  agent { label 'linux && immutable' }\n+  environment {\n+    REPO = 'apm-agent-java'\n+    BASE_DIR = \"src/github.com/elastic/${env.REPO}\"\n+    NOTIFY_TO = credentials('notify-to')\n+    DOCKERHUB_SECRET = 'secret/apm-team/ci/elastic-observability-dockerhub'\n+    ELASTIC_DOCKER_SECRET = 'secret/apm-team/ci/docker-registry/prod'\n+    NEXUS_SECRET = 'secret/apm-team/ci/nexus'\n+    MAVEN_CONFIG = '-Dmaven.repo.local=.m2'\n+    OPBEANS_REPO = 'opbeans-java'\n+\n+  }\n+  options {\n+    timeout(time: 3, unit: 'HOURS')\n+    buildDiscarder(logRotator(numToKeepStr: '20', artifactNumToKeepStr: '20', daysToKeepStr: '30'))\n+    timestamps()\n+    ansiColor('xterm')\n+    durabilityHint('PERFORMANCE_OPTIMIZED')\n+\n+  }\n+  parameters {\n+    string(name: 'MAVEN_CONFIG', defaultValue: '-B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn', description: 'Additional maven options.')\n+    string(name: 'branch_specifier', defaultValue: 'master')\n+  }\n+\n+  stages {\n+    stage('Initializing'){\n+      options { skipDefaultCheckout() }\n+      environment {\n+        HOME = \"${env.WORKSPACE}\"\n+        JAVA_HOME = \"${env.HUDSON_HOME}/.java/java10\"\n+        PATH = \"${env.JAVA_HOME}/bin:${env.PATH}\"\n+        MAVEN_CONFIG = \"${params.MAVEN_CONFIG} ${env.MAVEN_CONFIG}\"\n+      }\n+      stages {\n+        /**\n+         Checkout the code\n+        */\n+        stage('Checkout') {\n+          steps {\n+            dir(\"${BASE_DIR}\") {\n+              // This is required to ensure that Maven is working with a real branch\n+              sh(script: \"git checkout -f {$branch_specifier}\")\n+            }\n+          }\n+        }\n+      }\n+    }\n+    stage('Release') {\n+      options { skipDefaultCheckout () }\n+      stages{\n+        // 1. Check to see if oss.sonatype.org is up. We throw an exception and fail the job if there is no response.\n+        stage('Check oss.sonatype.org') {\n+          steps {\n+            // If this fails, an exception should be thrown and execution will halt\n+            httpRequest(url: \"https://oss.sonatype.org/#welcome\")\n+          }\n+        }\n+        // 2. Review project version.\n+        stage('Review project version') {\n+          steps {\n+            script {\n+              // Show the select input modal\n+              def INPUT_PARAMS = input message: 'Do you wish to update the version?', ok: 'Next', parameters: [choice(name: 'UPDATE_CHOICE', choices:['Yes', 'No'], description: \"This will run `mvn release:update-versions`\")]\n+              if (INPUT_PARAMS == 'Yes') {\n+                  dir(\"${BASE_DIR}\") {\n+                    sh mvn release:update-versions\n+                  }\n+              } else {\n+                  echo 'Skipping version update'\n+              }\n+            }\n+          }\n+        }\n+        // 3. Execute the release Jenkins job on the internal ci server.\n+            // For now we assume that the release has been pushed to staging already on the internal CI\n+        // 4. Login to oss.sonatype.org, go to Staging Repositories, close and release the staged artifacts.\n+        stage('Nexus release') {\n+          steps {\n+            script {\n+              def spid = getVault('nexus')[\"staging-profile-id\"]\n+              dir(\"${BASE_DIR}\"){\n+                withEnvMask(vars: [[var: \"SPID\", password: spid]]){\n+                  def foundStagingId = nexusFindStagingId(stagingProfileId: \"${SPID}\", groupId: \"co.elastic.apm\")", "originalCommit": "f668eabc167475153708ee930eab7cd48907c9c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM3NjE1MQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r390376151", "bodyText": "At present, we consider this an error requiring manual intervention.", "author": "cachedout", "createdAt": "2020-03-10T14:55:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYzMTkzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYzMjM5MQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r389632391", "bodyText": "Closing can take a minute or two. Does this return after triggering the close or after the close is finished?", "author": "felixbarny", "createdAt": "2020-03-09T12:36:08Z", "path": ".ci/release/Jenkinsfile", "diffHunk": "@@ -0,0 +1,235 @@\n+#!/usr/bin/env groovy\n+\n+@Library('apm@current') _\n+pipeline {\n+  agent { label 'linux && immutable' }\n+  environment {\n+    REPO = 'apm-agent-java'\n+    BASE_DIR = \"src/github.com/elastic/${env.REPO}\"\n+    NOTIFY_TO = credentials('notify-to')\n+    DOCKERHUB_SECRET = 'secret/apm-team/ci/elastic-observability-dockerhub'\n+    ELASTIC_DOCKER_SECRET = 'secret/apm-team/ci/docker-registry/prod'\n+    NEXUS_SECRET = 'secret/apm-team/ci/nexus'\n+    MAVEN_CONFIG = '-Dmaven.repo.local=.m2'\n+    OPBEANS_REPO = 'opbeans-java'\n+\n+  }\n+  options {\n+    timeout(time: 3, unit: 'HOURS')\n+    buildDiscarder(logRotator(numToKeepStr: '20', artifactNumToKeepStr: '20', daysToKeepStr: '30'))\n+    timestamps()\n+    ansiColor('xterm')\n+    durabilityHint('PERFORMANCE_OPTIMIZED')\n+\n+  }\n+  parameters {\n+    string(name: 'MAVEN_CONFIG', defaultValue: '-B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn', description: 'Additional maven options.')\n+    string(name: 'branch_specifier', defaultValue: 'master')\n+  }\n+\n+  stages {\n+    stage('Initializing'){\n+      options { skipDefaultCheckout() }\n+      environment {\n+        HOME = \"${env.WORKSPACE}\"\n+        JAVA_HOME = \"${env.HUDSON_HOME}/.java/java10\"\n+        PATH = \"${env.JAVA_HOME}/bin:${env.PATH}\"\n+        MAVEN_CONFIG = \"${params.MAVEN_CONFIG} ${env.MAVEN_CONFIG}\"\n+      }\n+      stages {\n+        /**\n+         Checkout the code\n+        */\n+        stage('Checkout') {\n+          steps {\n+            dir(\"${BASE_DIR}\") {\n+              // This is required to ensure that Maven is working with a real branch\n+              sh(script: \"git checkout -f {$branch_specifier}\")\n+            }\n+          }\n+        }\n+      }\n+    }\n+    stage('Release') {\n+      options { skipDefaultCheckout () }\n+      stages{\n+        // 1. Check to see if oss.sonatype.org is up. We throw an exception and fail the job if there is no response.\n+        stage('Check oss.sonatype.org') {\n+          steps {\n+            // If this fails, an exception should be thrown and execution will halt\n+            httpRequest(url: \"https://oss.sonatype.org/#welcome\")\n+          }\n+        }\n+        // 2. Review project version.\n+        stage('Review project version') {\n+          steps {\n+            script {\n+              // Show the select input modal\n+              def INPUT_PARAMS = input message: 'Do you wish to update the version?', ok: 'Next', parameters: [choice(name: 'UPDATE_CHOICE', choices:['Yes', 'No'], description: \"This will run `mvn release:update-versions`\")]\n+              if (INPUT_PARAMS == 'Yes') {\n+                  dir(\"${BASE_DIR}\") {\n+                    sh mvn release:update-versions\n+                  }\n+              } else {\n+                  echo 'Skipping version update'\n+              }\n+            }\n+          }\n+        }\n+        // 3. Execute the release Jenkins job on the internal ci server.\n+            // For now we assume that the release has been pushed to staging already on the internal CI\n+        // 4. Login to oss.sonatype.org, go to Staging Repositories, close and release the staged artifacts.\n+        stage('Nexus release') {\n+          steps {\n+            script {\n+              def spid = getVault('nexus')[\"staging-profile-id\"]\n+              dir(\"${BASE_DIR}\"){\n+                withEnvMask(vars: [[var: \"SPID\", password: spid]]){\n+                  def foundStagingId = nexusFindStagingId(stagingProfileId: \"${SPID}\", groupId: \"co.elastic.apm\")\n+                  nexusCloseStagingRepository(stagingProfileId: \"${SPID}\", stagingId: foundStagingId)", "originalCommit": "f668eabc167475153708ee930eab7cd48907c9c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQxNDc0NA==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r390414744", "bodyText": "We attempt to poll the repo for the actual close event, so this should block until the close actually happens.", "author": "cachedout", "createdAt": "2020-03-10T15:46:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYzMjM5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYzNTM1Mw==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r389635353", "bodyText": "let's to this after the Wait for artifact to be available in Maven Central step", "author": "felixbarny", "createdAt": "2020-03-09T12:42:29Z", "path": ".ci/release/Jenkinsfile", "diffHunk": "@@ -0,0 +1,235 @@\n+#!/usr/bin/env groovy\n+\n+@Library('apm@current') _\n+pipeline {\n+  agent { label 'linux && immutable' }\n+  environment {\n+    REPO = 'apm-agent-java'\n+    BASE_DIR = \"src/github.com/elastic/${env.REPO}\"\n+    NOTIFY_TO = credentials('notify-to')\n+    DOCKERHUB_SECRET = 'secret/apm-team/ci/elastic-observability-dockerhub'\n+    ELASTIC_DOCKER_SECRET = 'secret/apm-team/ci/docker-registry/prod'\n+    NEXUS_SECRET = 'secret/apm-team/ci/nexus'\n+    MAVEN_CONFIG = '-Dmaven.repo.local=.m2'\n+    OPBEANS_REPO = 'opbeans-java'\n+\n+  }\n+  options {\n+    timeout(time: 3, unit: 'HOURS')\n+    buildDiscarder(logRotator(numToKeepStr: '20', artifactNumToKeepStr: '20', daysToKeepStr: '30'))\n+    timestamps()\n+    ansiColor('xterm')\n+    durabilityHint('PERFORMANCE_OPTIMIZED')\n+\n+  }\n+  parameters {\n+    string(name: 'MAVEN_CONFIG', defaultValue: '-B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn', description: 'Additional maven options.')\n+    string(name: 'branch_specifier', defaultValue: 'master')\n+  }\n+\n+  stages {\n+    stage('Initializing'){\n+      options { skipDefaultCheckout() }\n+      environment {\n+        HOME = \"${env.WORKSPACE}\"\n+        JAVA_HOME = \"${env.HUDSON_HOME}/.java/java10\"\n+        PATH = \"${env.JAVA_HOME}/bin:${env.PATH}\"\n+        MAVEN_CONFIG = \"${params.MAVEN_CONFIG} ${env.MAVEN_CONFIG}\"\n+      }\n+      stages {\n+        /**\n+         Checkout the code\n+        */\n+        stage('Checkout') {\n+          steps {\n+            dir(\"${BASE_DIR}\") {\n+              // This is required to ensure that Maven is working with a real branch\n+              sh(script: \"git checkout -f {$branch_specifier}\")\n+            }\n+          }\n+        }\n+      }\n+    }\n+    stage('Release') {\n+      options { skipDefaultCheckout () }\n+      stages{\n+        // 1. Check to see if oss.sonatype.org is up. We throw an exception and fail the job if there is no response.\n+        stage('Check oss.sonatype.org') {\n+          steps {\n+            // If this fails, an exception should be thrown and execution will halt\n+            httpRequest(url: \"https://oss.sonatype.org/#welcome\")\n+          }\n+        }\n+        // 2. Review project version.\n+        stage('Review project version') {\n+          steps {\n+            script {\n+              // Show the select input modal\n+              def INPUT_PARAMS = input message: 'Do you wish to update the version?', ok: 'Next', parameters: [choice(name: 'UPDATE_CHOICE', choices:['Yes', 'No'], description: \"This will run `mvn release:update-versions`\")]\n+              if (INPUT_PARAMS == 'Yes') {\n+                  dir(\"${BASE_DIR}\") {\n+                    sh mvn release:update-versions\n+                  }\n+              } else {\n+                  echo 'Skipping version update'\n+              }\n+            }\n+          }\n+        }\n+        // 3. Execute the release Jenkins job on the internal ci server.\n+            // For now we assume that the release has been pushed to staging already on the internal CI\n+        // 4. Login to oss.sonatype.org, go to Staging Repositories, close and release the staged artifacts.\n+        stage('Nexus release') {\n+          steps {\n+            script {\n+              def spid = getVault('nexus')[\"staging-profile-id\"]\n+              dir(\"${BASE_DIR}\"){\n+                withEnvMask(vars: [[var: \"SPID\", password: spid]]){\n+                  def foundStagingId = nexusFindStagingId(stagingProfileId: \"${SPID}\", groupId: \"co.elastic.apm\")\n+                  nexusCloseStagingRepository(stagingProfileId: \"${SPID}\", stagingId: foundStagingId)\n+                  nexusReleaseStagingRepository(stagingProfileId: \"${SPID}\", stagingId: foundStagingId)\n+                }\n+\n+              }\n+            }\n+          }\n+        }\n+        // 5. Fetch and checkout the latest tag e.g. git fetch origin\n+          // We already have this :)\n+        // 6. If this was a major release, create a new branch for the major.\n+        stage('Branch creation') {\n+          steps {\n+            dir(\"${BASE_DIR}\") {\n+              script {\n+                def isMajor = sh(script: 'git tag|tail -1|cut -f2-3 -d \".\"|{ read ver; test $ver == \"0.0\"; }', returnStatus: true)\n+                if (isMajor == 0) {\n+                  // We need to create a new branch. First get the name of the branch\n+                  def newBranchName = sh(script: 'git tag|tail -1|sed s/v//|cut -f1 -d \".\"|awk \\'{print $1\".x\"}\\'', returnStdout: true)\n+                  echo \"This appears to be a major version. We are creating a new branch for $newBranchName in the apm-agent-java repo on GitHub.\"\n+                  // Now we need to branch\n+                  sh(script: \"git checkout -b $newBranchName\")\n+                  // And push\n+                  githubEnv()\n+                  gitPush() \n+                  // 6.1 Add the new branch to the conf.yaml in the docs repo\n+                  input message: \"This was a major version release. Please update the conf.yml in the docs repo before continuing\", ok \"Continue\"\n+                } else {  // This was a minor release\n+                  // 7. If this was a minor release, reset the current major branch (1.x, 2.x etc) to point to the current tag, e.g. git branch -f 1.x v1.1.0\n+                  // Determine current tag\n+                  def curTag = sh(script: \"git tag|tail -1\", returnStdout: true)\n+                  def targetBranch = sh(script: 'git tag|tail -1|sed s/v//|cut -f1 -d '.'|awk \\'{print $1\".x\"}\\'', returnStdout: true)\n+                  sh(script: \"git branch -f $targetBranch $curTag\")\n+                  gitPush()\n+                }\n+              }\n+              // Checkout the tag again!\n+              sh(\"git checkout ${BUILD_TAG}\")\n+            }\n+          }\n+        }\n+        // 8. Update CHANGELOG.asciidoc to reflect version release. Go over PRs or git log and add bug fixes and features. \n+        stage('Generate a proposed CHANGELOG') {\n+          steps {\n+            githubEnv()\n+            generateChangelog(repo: 'apm-agent-java')\n+          }\n+        }\n+        // 9. Go to elastic/apm-agent-java/releases and draft a new release. Provide a link to release notes in documentation as release description.\n+        stage('Create GitHub release draft') {\n+          steps {\n+            dir(\"${BASE_DIR}\"){\n+              script {\n+                def curTag = sh(script: \"git tag|tail -1\", returnStdout: true)\n+                // Construct the URL with anchor for the release notes\n+                // Ex: https://www.elastic.co/guide/en/apm/agent/java/current/release-notes-1.x.html#release-notes-1.13.0\n+                def baseUrl = \"https://www.elastic.co/guide/en/apm/agent/java/current/release-notes-\"\n+                def dotX = sh(script: 'git tag|tail -1|sed s/v//|cut -f1 -d \".\"|awk \\'{print $1\".x\"}\\'', returnStdout: true)\n+                def bareTag = sh(script: 'git tag|tail -1|sed s/v//', returnStdout: true)\n+                def finalUrl = sh(script: \"echo $baseUrl$dotX\\.html#release-notes-$bareTag\")\n+                def ret = githubReleaseCreate(draft: true, body: \"[Release Notes for $bareTag]($finalUrl)\")\n+                env.RELEASE_ID = ret['id']\n+              }\n+            }\n+\n+          }\n+        }\n+        // 10. Update cloudfoundry/index.yml\n+        // Needs to append a line such as the following:\n+        // 1.13.0: https://repo1.maven.org/maven2/co/elastic/apm/elastic-apm-agent/1.13.0/elastic-apm-agent-1.13.0.jar\n+        stage('Update Cloudfoundry') {", "originalCommit": "f668eabc167475153708ee930eab7cd48907c9c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk0MzA4MQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r390943081", "bodyText": "I've moved this. Thanks!", "author": "cachedout", "createdAt": "2020-03-11T12:43:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYzNTM1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYzNjA3NQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r389636075", "bodyText": "what's the title of the release? So far, we did \"Release $version\".", "author": "felixbarny", "createdAt": "2020-03-09T12:43:59Z", "path": ".ci/release/Jenkinsfile", "diffHunk": "@@ -0,0 +1,235 @@\n+#!/usr/bin/env groovy\n+\n+@Library('apm@current') _\n+pipeline {\n+  agent { label 'linux && immutable' }\n+  environment {\n+    REPO = 'apm-agent-java'\n+    BASE_DIR = \"src/github.com/elastic/${env.REPO}\"\n+    NOTIFY_TO = credentials('notify-to')\n+    DOCKERHUB_SECRET = 'secret/apm-team/ci/elastic-observability-dockerhub'\n+    ELASTIC_DOCKER_SECRET = 'secret/apm-team/ci/docker-registry/prod'\n+    NEXUS_SECRET = 'secret/apm-team/ci/nexus'\n+    MAVEN_CONFIG = '-Dmaven.repo.local=.m2'\n+    OPBEANS_REPO = 'opbeans-java'\n+\n+  }\n+  options {\n+    timeout(time: 3, unit: 'HOURS')\n+    buildDiscarder(logRotator(numToKeepStr: '20', artifactNumToKeepStr: '20', daysToKeepStr: '30'))\n+    timestamps()\n+    ansiColor('xterm')\n+    durabilityHint('PERFORMANCE_OPTIMIZED')\n+\n+  }\n+  parameters {\n+    string(name: 'MAVEN_CONFIG', defaultValue: '-B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn', description: 'Additional maven options.')\n+    string(name: 'branch_specifier', defaultValue: 'master')\n+  }\n+\n+  stages {\n+    stage('Initializing'){\n+      options { skipDefaultCheckout() }\n+      environment {\n+        HOME = \"${env.WORKSPACE}\"\n+        JAVA_HOME = \"${env.HUDSON_HOME}/.java/java10\"\n+        PATH = \"${env.JAVA_HOME}/bin:${env.PATH}\"\n+        MAVEN_CONFIG = \"${params.MAVEN_CONFIG} ${env.MAVEN_CONFIG}\"\n+      }\n+      stages {\n+        /**\n+         Checkout the code\n+        */\n+        stage('Checkout') {\n+          steps {\n+            dir(\"${BASE_DIR}\") {\n+              // This is required to ensure that Maven is working with a real branch\n+              sh(script: \"git checkout -f {$branch_specifier}\")\n+            }\n+          }\n+        }\n+      }\n+    }\n+    stage('Release') {\n+      options { skipDefaultCheckout () }\n+      stages{\n+        // 1. Check to see if oss.sonatype.org is up. We throw an exception and fail the job if there is no response.\n+        stage('Check oss.sonatype.org') {\n+          steps {\n+            // If this fails, an exception should be thrown and execution will halt\n+            httpRequest(url: \"https://oss.sonatype.org/#welcome\")\n+          }\n+        }\n+        // 2. Review project version.\n+        stage('Review project version') {\n+          steps {\n+            script {\n+              // Show the select input modal\n+              def INPUT_PARAMS = input message: 'Do you wish to update the version?', ok: 'Next', parameters: [choice(name: 'UPDATE_CHOICE', choices:['Yes', 'No'], description: \"This will run `mvn release:update-versions`\")]\n+              if (INPUT_PARAMS == 'Yes') {\n+                  dir(\"${BASE_DIR}\") {\n+                    sh mvn release:update-versions\n+                  }\n+              } else {\n+                  echo 'Skipping version update'\n+              }\n+            }\n+          }\n+        }\n+        // 3. Execute the release Jenkins job on the internal ci server.\n+            // For now we assume that the release has been pushed to staging already on the internal CI\n+        // 4. Login to oss.sonatype.org, go to Staging Repositories, close and release the staged artifacts.\n+        stage('Nexus release') {\n+          steps {\n+            script {\n+              def spid = getVault('nexus')[\"staging-profile-id\"]\n+              dir(\"${BASE_DIR}\"){\n+                withEnvMask(vars: [[var: \"SPID\", password: spid]]){\n+                  def foundStagingId = nexusFindStagingId(stagingProfileId: \"${SPID}\", groupId: \"co.elastic.apm\")\n+                  nexusCloseStagingRepository(stagingProfileId: \"${SPID}\", stagingId: foundStagingId)\n+                  nexusReleaseStagingRepository(stagingProfileId: \"${SPID}\", stagingId: foundStagingId)\n+                }\n+\n+              }\n+            }\n+          }\n+        }\n+        // 5. Fetch and checkout the latest tag e.g. git fetch origin\n+          // We already have this :)\n+        // 6. If this was a major release, create a new branch for the major.\n+        stage('Branch creation') {\n+          steps {\n+            dir(\"${BASE_DIR}\") {\n+              script {\n+                def isMajor = sh(script: 'git tag|tail -1|cut -f2-3 -d \".\"|{ read ver; test $ver == \"0.0\"; }', returnStatus: true)\n+                if (isMajor == 0) {\n+                  // We need to create a new branch. First get the name of the branch\n+                  def newBranchName = sh(script: 'git tag|tail -1|sed s/v//|cut -f1 -d \".\"|awk \\'{print $1\".x\"}\\'', returnStdout: true)\n+                  echo \"This appears to be a major version. We are creating a new branch for $newBranchName in the apm-agent-java repo on GitHub.\"\n+                  // Now we need to branch\n+                  sh(script: \"git checkout -b $newBranchName\")\n+                  // And push\n+                  githubEnv()\n+                  gitPush() \n+                  // 6.1 Add the new branch to the conf.yaml in the docs repo\n+                  input message: \"This was a major version release. Please update the conf.yml in the docs repo before continuing\", ok \"Continue\"\n+                } else {  // This was a minor release\n+                  // 7. If this was a minor release, reset the current major branch (1.x, 2.x etc) to point to the current tag, e.g. git branch -f 1.x v1.1.0\n+                  // Determine current tag\n+                  def curTag = sh(script: \"git tag|tail -1\", returnStdout: true)\n+                  def targetBranch = sh(script: 'git tag|tail -1|sed s/v//|cut -f1 -d '.'|awk \\'{print $1\".x\"}\\'', returnStdout: true)\n+                  sh(script: \"git branch -f $targetBranch $curTag\")\n+                  gitPush()\n+                }\n+              }\n+              // Checkout the tag again!\n+              sh(\"git checkout ${BUILD_TAG}\")\n+            }\n+          }\n+        }\n+        // 8. Update CHANGELOG.asciidoc to reflect version release. Go over PRs or git log and add bug fixes and features. \n+        stage('Generate a proposed CHANGELOG') {\n+          steps {\n+            githubEnv()\n+            generateChangelog(repo: 'apm-agent-java')\n+          }\n+        }\n+        // 9. Go to elastic/apm-agent-java/releases and draft a new release. Provide a link to release notes in documentation as release description.\n+        stage('Create GitHub release draft') {\n+          steps {\n+            dir(\"${BASE_DIR}\"){\n+              script {\n+                def curTag = sh(script: \"git tag|tail -1\", returnStdout: true)\n+                // Construct the URL with anchor for the release notes\n+                // Ex: https://www.elastic.co/guide/en/apm/agent/java/current/release-notes-1.x.html#release-notes-1.13.0\n+                def baseUrl = \"https://www.elastic.co/guide/en/apm/agent/java/current/release-notes-\"\n+                def dotX = sh(script: 'git tag|tail -1|sed s/v//|cut -f1 -d \".\"|awk \\'{print $1\".x\"}\\'', returnStdout: true)\n+                def bareTag = sh(script: 'git tag|tail -1|sed s/v//', returnStdout: true)\n+                def finalUrl = sh(script: \"echo $baseUrl$dotX\\.html#release-notes-$bareTag\")\n+                def ret = githubReleaseCreate(draft: true, body: \"[Release Notes for $bareTag]($finalUrl)\")", "originalCommit": "f668eabc167475153708ee930eab7cd48907c9c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc0MDIzNQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r389740235", "bodyText": "Right now, we don't specify a name when we call the GitHub API but this is easy to change. I will make a change upstream in the APM Pipeline library to support this behavior.", "author": "cachedout", "createdAt": "2020-03-09T14:50:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYzNjA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkwNzc5Nw==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r389907797", "bodyText": "This change is now merged. I will update this call to use the new functionality.", "author": "cachedout", "createdAt": "2020-03-09T19:20:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYzNjA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM2NzkxNw==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r390367917", "bodyText": "The call has been updated. Thanks for the suggestion!", "author": "cachedout", "createdAt": "2020-03-10T14:45:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYzNjA3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYzNzE5Mg==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r389637192", "bodyText": "Does that mean it first starts to try after 15 sec? Is there a timeout? It usually takes around 10 min.", "author": "felixbarny", "createdAt": "2020-03-09T12:46:28Z", "path": ".ci/release/Jenkinsfile", "diffHunk": "@@ -0,0 +1,235 @@\n+#!/usr/bin/env groovy\n+\n+@Library('apm@current') _\n+pipeline {\n+  agent { label 'linux && immutable' }\n+  environment {\n+    REPO = 'apm-agent-java'\n+    BASE_DIR = \"src/github.com/elastic/${env.REPO}\"\n+    NOTIFY_TO = credentials('notify-to')\n+    DOCKERHUB_SECRET = 'secret/apm-team/ci/elastic-observability-dockerhub'\n+    ELASTIC_DOCKER_SECRET = 'secret/apm-team/ci/docker-registry/prod'\n+    NEXUS_SECRET = 'secret/apm-team/ci/nexus'\n+    MAVEN_CONFIG = '-Dmaven.repo.local=.m2'\n+    OPBEANS_REPO = 'opbeans-java'\n+\n+  }\n+  options {\n+    timeout(time: 3, unit: 'HOURS')\n+    buildDiscarder(logRotator(numToKeepStr: '20', artifactNumToKeepStr: '20', daysToKeepStr: '30'))\n+    timestamps()\n+    ansiColor('xterm')\n+    durabilityHint('PERFORMANCE_OPTIMIZED')\n+\n+  }\n+  parameters {\n+    string(name: 'MAVEN_CONFIG', defaultValue: '-B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn', description: 'Additional maven options.')\n+    string(name: 'branch_specifier', defaultValue: 'master')\n+  }\n+\n+  stages {\n+    stage('Initializing'){\n+      options { skipDefaultCheckout() }\n+      environment {\n+        HOME = \"${env.WORKSPACE}\"\n+        JAVA_HOME = \"${env.HUDSON_HOME}/.java/java10\"\n+        PATH = \"${env.JAVA_HOME}/bin:${env.PATH}\"\n+        MAVEN_CONFIG = \"${params.MAVEN_CONFIG} ${env.MAVEN_CONFIG}\"\n+      }\n+      stages {\n+        /**\n+         Checkout the code\n+        */\n+        stage('Checkout') {\n+          steps {\n+            dir(\"${BASE_DIR}\") {\n+              // This is required to ensure that Maven is working with a real branch\n+              sh(script: \"git checkout -f {$branch_specifier}\")\n+            }\n+          }\n+        }\n+      }\n+    }\n+    stage('Release') {\n+      options { skipDefaultCheckout () }\n+      stages{\n+        // 1. Check to see if oss.sonatype.org is up. We throw an exception and fail the job if there is no response.\n+        stage('Check oss.sonatype.org') {\n+          steps {\n+            // If this fails, an exception should be thrown and execution will halt\n+            httpRequest(url: \"https://oss.sonatype.org/#welcome\")\n+          }\n+        }\n+        // 2. Review project version.\n+        stage('Review project version') {\n+          steps {\n+            script {\n+              // Show the select input modal\n+              def INPUT_PARAMS = input message: 'Do you wish to update the version?', ok: 'Next', parameters: [choice(name: 'UPDATE_CHOICE', choices:['Yes', 'No'], description: \"This will run `mvn release:update-versions`\")]\n+              if (INPUT_PARAMS == 'Yes') {\n+                  dir(\"${BASE_DIR}\") {\n+                    sh mvn release:update-versions\n+                  }\n+              } else {\n+                  echo 'Skipping version update'\n+              }\n+            }\n+          }\n+        }\n+        // 3. Execute the release Jenkins job on the internal ci server.\n+            // For now we assume that the release has been pushed to staging already on the internal CI\n+        // 4. Login to oss.sonatype.org, go to Staging Repositories, close and release the staged artifacts.\n+        stage('Nexus release') {\n+          steps {\n+            script {\n+              def spid = getVault('nexus')[\"staging-profile-id\"]\n+              dir(\"${BASE_DIR}\"){\n+                withEnvMask(vars: [[var: \"SPID\", password: spid]]){\n+                  def foundStagingId = nexusFindStagingId(stagingProfileId: \"${SPID}\", groupId: \"co.elastic.apm\")\n+                  nexusCloseStagingRepository(stagingProfileId: \"${SPID}\", stagingId: foundStagingId)\n+                  nexusReleaseStagingRepository(stagingProfileId: \"${SPID}\", stagingId: foundStagingId)\n+                }\n+\n+              }\n+            }\n+          }\n+        }\n+        // 5. Fetch and checkout the latest tag e.g. git fetch origin\n+          // We already have this :)\n+        // 6. If this was a major release, create a new branch for the major.\n+        stage('Branch creation') {\n+          steps {\n+            dir(\"${BASE_DIR}\") {\n+              script {\n+                def isMajor = sh(script: 'git tag|tail -1|cut -f2-3 -d \".\"|{ read ver; test $ver == \"0.0\"; }', returnStatus: true)\n+                if (isMajor == 0) {\n+                  // We need to create a new branch. First get the name of the branch\n+                  def newBranchName = sh(script: 'git tag|tail -1|sed s/v//|cut -f1 -d \".\"|awk \\'{print $1\".x\"}\\'', returnStdout: true)\n+                  echo \"This appears to be a major version. We are creating a new branch for $newBranchName in the apm-agent-java repo on GitHub.\"\n+                  // Now we need to branch\n+                  sh(script: \"git checkout -b $newBranchName\")\n+                  // And push\n+                  githubEnv()\n+                  gitPush() \n+                  // 6.1 Add the new branch to the conf.yaml in the docs repo\n+                  input message: \"This was a major version release. Please update the conf.yml in the docs repo before continuing\", ok \"Continue\"\n+                } else {  // This was a minor release\n+                  // 7. If this was a minor release, reset the current major branch (1.x, 2.x etc) to point to the current tag, e.g. git branch -f 1.x v1.1.0\n+                  // Determine current tag\n+                  def curTag = sh(script: \"git tag|tail -1\", returnStdout: true)\n+                  def targetBranch = sh(script: 'git tag|tail -1|sed s/v//|cut -f1 -d '.'|awk \\'{print $1\".x\"}\\'', returnStdout: true)\n+                  sh(script: \"git branch -f $targetBranch $curTag\")\n+                  gitPush()\n+                }\n+              }\n+              // Checkout the tag again!\n+              sh(\"git checkout ${BUILD_TAG}\")\n+            }\n+          }\n+        }\n+        // 8. Update CHANGELOG.asciidoc to reflect version release. Go over PRs or git log and add bug fixes and features. \n+        stage('Generate a proposed CHANGELOG') {\n+          steps {\n+            githubEnv()\n+            generateChangelog(repo: 'apm-agent-java')\n+          }\n+        }\n+        // 9. Go to elastic/apm-agent-java/releases and draft a new release. Provide a link to release notes in documentation as release description.\n+        stage('Create GitHub release draft') {\n+          steps {\n+            dir(\"${BASE_DIR}\"){\n+              script {\n+                def curTag = sh(script: \"git tag|tail -1\", returnStdout: true)\n+                // Construct the URL with anchor for the release notes\n+                // Ex: https://www.elastic.co/guide/en/apm/agent/java/current/release-notes-1.x.html#release-notes-1.13.0\n+                def baseUrl = \"https://www.elastic.co/guide/en/apm/agent/java/current/release-notes-\"\n+                def dotX = sh(script: 'git tag|tail -1|sed s/v//|cut -f1 -d \".\"|awk \\'{print $1\".x\"}\\'', returnStdout: true)\n+                def bareTag = sh(script: 'git tag|tail -1|sed s/v//', returnStdout: true)\n+                def finalUrl = sh(script: \"echo $baseUrl$dotX\\.html#release-notes-$bareTag\")\n+                def ret = githubReleaseCreate(draft: true, body: \"[Release Notes for $bareTag]($finalUrl)\")\n+                env.RELEASE_ID = ret['id']\n+              }\n+            }\n+\n+          }\n+        }\n+        // 10. Update cloudfoundry/index.yml\n+        // Needs to append a line such as the following:\n+        // 1.13.0: https://repo1.maven.org/maven2/co/elastic/apm/elastic-apm-agent/1.13.0/elastic-apm-agent-1.13.0.jar\n+        stage('Update Cloudfoundry') {\n+          steps {\n+            dir(\"${basedir}\") {\n+              script {\n+                sh(\"git checkout master\")\n+                def bareTag = sh(script: 'git tag|tail -1|sed s/v//', returnStdout: true)\n+                def baseUrl = \"https://repo1.maven.org/maven2/co/elastic/apm/elastic-apm-agent\"\n+                def lineToAppend = sh(script: \"echo '$baseUrl: $baseUrl/$bareTag/elastic-apm-agent-$bareTag\\.jar' >> cloudfoundry/index.yml \")\n+                gitPush()\n+              }\n+            }\n+          }\n+        }\n+        // 11. Wait for released package to be available in maven central\n+        stage('Wait for artifact to be available in Maven Central') {\n+          steps {\n+            dir(\"${BASE_DIR}\"){\n+              script {\n+                // We are looking for something like this:\n+                // https://oss.sonatype.org/service/local/repositories/releases/content/co/elastic/apm/apm-agent-java/1.1.12/apm-agent-java-1.1.12.pom\n+                def baseUrl = \"https://oss.sonatype.org/service/local/repositories/releases/content/co/elastic/apm/apm-agent-java\"\n+                def bareTag = sh(script: 'git tag|tail -1|sed s/v//', returnStdout: true)\n+                def fullUrl = sh(script: \"$baseUrl/$bareTag/apm-agent-java-$bareTag\\.pom\")\n+                waitUntil(initialRecurrencePeriod: 15000) {", "originalCommit": "f668eabc167475153708ee930eab7cd48907c9c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTczMjg4NA==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r389732884", "bodyText": "cURL has its own time-out, and after it expires, it will trigger the retry in the waitUntil. which will retry every 15 seconds, starting immediately, with a back-off.\nI think that we can improve this with the following changes:\n\nSleep first for ~10 minutes before we enter the re-try loop.\nBump the initial re-try up to 1 minute from 15s.", "author": "cachedout", "createdAt": "2020-03-09T14:39:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYzNzE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM0Mzg4MA==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r390343880", "bodyText": "The above strategy is now implemented. Thanks for the feedback!", "author": "cachedout", "createdAt": "2020-03-10T14:15:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYzNzE5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYzOTkzNA==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r389639934", "bodyText": "How does the release job get triggered?", "author": "felixbarny", "createdAt": "2020-03-09T12:51:49Z", "path": ".ci/release/Jenkinsfile", "diffHunk": "@@ -0,0 +1,235 @@\n+#!/usr/bin/env groovy\n+\n+@Library('apm@current') _\n+pipeline {\n+  agent { label 'linux && immutable' }\n+  environment {\n+    REPO = 'apm-agent-java'\n+    BASE_DIR = \"src/github.com/elastic/${env.REPO}\"\n+    NOTIFY_TO = credentials('notify-to')\n+    DOCKERHUB_SECRET = 'secret/apm-team/ci/elastic-observability-dockerhub'\n+    ELASTIC_DOCKER_SECRET = 'secret/apm-team/ci/docker-registry/prod'\n+    NEXUS_SECRET = 'secret/apm-team/ci/nexus'\n+    MAVEN_CONFIG = '-Dmaven.repo.local=.m2'\n+    OPBEANS_REPO = 'opbeans-java'\n+\n+  }\n+  options {\n+    timeout(time: 3, unit: 'HOURS')\n+    buildDiscarder(logRotator(numToKeepStr: '20', artifactNumToKeepStr: '20', daysToKeepStr: '30'))\n+    timestamps()\n+    ansiColor('xterm')\n+    durabilityHint('PERFORMANCE_OPTIMIZED')\n+\n+  }\n+  parameters {\n+    string(name: 'MAVEN_CONFIG', defaultValue: '-B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn', description: 'Additional maven options.')\n+    string(name: 'branch_specifier', defaultValue: 'master')\n+  }\n+\n+  stages {\n+    stage('Initializing'){\n+      options { skipDefaultCheckout() }\n+      environment {\n+        HOME = \"${env.WORKSPACE}\"\n+        JAVA_HOME = \"${env.HUDSON_HOME}/.java/java10\"\n+        PATH = \"${env.JAVA_HOME}/bin:${env.PATH}\"\n+        MAVEN_CONFIG = \"${params.MAVEN_CONFIG} ${env.MAVEN_CONFIG}\"\n+      }\n+      stages {\n+        /**\n+         Checkout the code\n+        */\n+        stage('Checkout') {\n+          steps {\n+            dir(\"${BASE_DIR}\") {\n+              // This is required to ensure that Maven is working with a real branch\n+              sh(script: \"git checkout -f {$branch_specifier}\")\n+            }\n+          }\n+        }\n+      }\n+    }\n+    stage('Release') {\n+      options { skipDefaultCheckout () }\n+      stages{\n+        // 1. Check to see if oss.sonatype.org is up. We throw an exception and fail the job if there is no response.\n+        stage('Check oss.sonatype.org') {\n+          steps {\n+            // If this fails, an exception should be thrown and execution will halt\n+            httpRequest(url: \"https://oss.sonatype.org/#welcome\")\n+          }\n+        }\n+        // 2. Review project version.\n+        stage('Review project version') {\n+          steps {\n+            script {\n+              // Show the select input modal\n+              def INPUT_PARAMS = input message: 'Do you wish to update the version?', ok: 'Next', parameters: [choice(name: 'UPDATE_CHOICE', choices:['Yes', 'No'], description: \"This will run `mvn release:update-versions`\")]\n+              if (INPUT_PARAMS == 'Yes') {\n+                  dir(\"${BASE_DIR}\") {\n+                    sh mvn release:update-versions\n+                  }\n+              } else {\n+                  echo 'Skipping version update'\n+              }\n+            }\n+          }\n+        }\n+        // 3. Execute the release Jenkins job on the internal ci server.\n+            // For now we assume that the release has been pushed to staging already on the internal CI", "originalCommit": "f668eabc167475153708ee930eab7cd48907c9c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcyNTUwNg==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r389725506", "bodyText": "By hand. I could probably improve this description but what I meant to indicate here is that this pipeline should be run after the existing release job is run.", "author": "cachedout", "createdAt": "2020-03-09T14:28:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYzOTkzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTgxMDY3Nw==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r389810677", "bodyText": "maybe open a dialog describing what to do which should be closed after the release job is done?", "author": "felixbarny", "createdAt": "2020-03-09T16:33:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYzOTkzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTgzMzk2OA==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r389833968", "bodyText": "BTW, I love that this just delegates to the existing and battle-tested release job instead of re-inventing this step which is definitely the most critical piece.", "author": "felixbarny", "createdAt": "2020-03-09T17:10:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYzOTkzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM3MjE3Ng==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r394372176", "bodyText": "Or we could trigger the release job when a new tag is created. That way, we don't have a direct dependency to actively trigger the build in the internal CI form the public CI.\nThe public CI  would execute the release:prepare phase of the maven release plugin which updates the versions and creates a new tag.\nThe creation of the tag triggers the release job on the internal CI which executes the release:perform phase of the release plugin.\nThis does not have to, and probably shouldn't, be in the first iteration of the automated release.", "author": "felixbarny", "createdAt": "2020-03-18T14:07:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYzOTkzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc3OTU1Ng==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r400779556", "bodyText": "I agree that this is a good long-term goal and I also agree that we shouldn't try to achieve this in the first iteration. Therefore, I'm going to resolve this comment because it's becoming a bit tricky to track all the feedback in this PR but we'll come back to it after we have this PR merged. Thanks, @felixbarny ! :)", "author": "cachedout", "createdAt": "2020-03-31T09:44:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYzOTkzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTgxODYxNw==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r389818617", "bodyText": "Instead of updating the version here, I wonder if we should instead require the release version to be set in the release job. See https://maven.apache.org/maven-release/maven-release-plugin/examples/non-interactive-release.html\nWe could then also require to set the next dev version. The release plugin offers system properties for the release and next dev version: -DreleaseVersion=1.2.0  -DdevelopmentVersion=1.3.0-SNAPSHOT.\n@eyalkoren @SylvainJuge WDYT?", "author": "felixbarny", "createdAt": "2020-03-09T16:46:23Z", "path": ".ci/release/Jenkinsfile", "diffHunk": "@@ -0,0 +1,235 @@\n+#!/usr/bin/env groovy\n+\n+@Library('apm@current') _\n+pipeline {\n+  agent { label 'linux && immutable' }\n+  environment {\n+    REPO = 'apm-agent-java'\n+    BASE_DIR = \"src/github.com/elastic/${env.REPO}\"\n+    NOTIFY_TO = credentials('notify-to')\n+    DOCKERHUB_SECRET = 'secret/apm-team/ci/elastic-observability-dockerhub'\n+    ELASTIC_DOCKER_SECRET = 'secret/apm-team/ci/docker-registry/prod'\n+    NEXUS_SECRET = 'secret/apm-team/ci/nexus'\n+    MAVEN_CONFIG = '-Dmaven.repo.local=.m2'\n+    OPBEANS_REPO = 'opbeans-java'\n+\n+  }\n+  options {\n+    timeout(time: 3, unit: 'HOURS')\n+    buildDiscarder(logRotator(numToKeepStr: '20', artifactNumToKeepStr: '20', daysToKeepStr: '30'))\n+    timestamps()\n+    ansiColor('xterm')\n+    durabilityHint('PERFORMANCE_OPTIMIZED')\n+\n+  }\n+  parameters {\n+    string(name: 'MAVEN_CONFIG', defaultValue: '-B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn', description: 'Additional maven options.')\n+    string(name: 'branch_specifier', defaultValue: 'master')\n+  }\n+\n+  stages {\n+    stage('Initializing'){\n+      options { skipDefaultCheckout() }\n+      environment {\n+        HOME = \"${env.WORKSPACE}\"\n+        JAVA_HOME = \"${env.HUDSON_HOME}/.java/java10\"\n+        PATH = \"${env.JAVA_HOME}/bin:${env.PATH}\"\n+        MAVEN_CONFIG = \"${params.MAVEN_CONFIG} ${env.MAVEN_CONFIG}\"\n+      }\n+      stages {\n+        /**\n+         Checkout the code\n+        */\n+        stage('Checkout') {\n+          steps {\n+            dir(\"${BASE_DIR}\") {\n+              // This is required to ensure that Maven is working with a real branch\n+              sh(script: \"git checkout -f {$branch_specifier}\")\n+            }\n+          }\n+        }\n+      }\n+    }\n+    stage('Release') {\n+      options { skipDefaultCheckout () }\n+      stages{\n+        // 1. Check to see if oss.sonatype.org is up. We throw an exception and fail the job if there is no response.\n+        stage('Check oss.sonatype.org') {\n+          steps {\n+            // If this fails, an exception should be thrown and execution will halt\n+            httpRequest(url: \"https://oss.sonatype.org/#welcome\")\n+          }\n+        }\n+        // 2. Review project version.\n+        stage('Review project version') {\n+          steps {\n+            script {\n+              // Show the select input modal\n+              def INPUT_PARAMS = input message: 'Do you wish to update the version?', ok: 'Next', parameters: [choice(name: 'UPDATE_CHOICE', choices:['Yes', 'No'], description: \"This will run `mvn release:update-versions`\")]", "originalCommit": "f668eabc167475153708ee930eab7cd48907c9c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTgzNTYyNQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r389835625", "bodyText": "I'm not really sure to understand how this would be different: do we make the release job just \"release current version\", which is read from pom.xml ?\nWhat if we keep having this prompt for release version and the default value is read from pom.xml, if a different value is set just updates version before executing release ?\nHaving this version set/bump done at CI level allows to avoid running any local git command, which is one less opportunity for human errors.\nI'm also ok for doing an increment on the minor version number, but would rather use mvn versions:set and not mvn:release plugin. for the reason I mentioned above (which I can definitely get by).", "author": "SylvainJuge", "createdAt": "2020-03-09T17:13:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTgxODYxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg2NDc5MQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r389864791", "bodyText": "but would rather use mvn versions:set and not mvn:release plugin\n\nDuring a release:prepare and after a release:perform the versions get updated by the release plugin anyways.\nSo in the current state of this PR, we would update the version in step 2, then once again in on internal-ci via the release:prepare stage (it removes the -SNAPSHOT) and finally after the release is done, after the release:perform stage (increments the patch version and adds -SNAPSHOT, in most cases we actually want to increment the minor version).\nWhat I'm suggesting is to modify the version 2 times instead of 3.", "author": "felixbarny", "createdAt": "2020-03-09T17:59:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTgxODYxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjk2MDQ4Mg==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r412960482", "bodyText": "Hi @felixbarny and @SylvainJuge We've let this discussion sit for a while. I don't have any strong opinions on the way we handle this, but I'd like to come to a consensus so we can get this merged. What's the best way to find a path forward here?", "author": "cachedout", "createdAt": "2020-04-22T13:00:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTgxODYxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzA0NzkyMw==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r413047923", "bodyText": "don't see this as blocking the PR, that's something we can always improve later on", "author": "felixbarny", "createdAt": "2020-04-22T14:46:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTgxODYxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTgzNTM4Nw==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r389835387", "bodyText": "Could we add a step that checks whether the current build on master is green?\n(Not required for the first version)", "author": "felixbarny", "createdAt": "2020-03-09T17:13:04Z", "path": ".ci/release/Jenkinsfile", "diffHunk": "@@ -0,0 +1,235 @@\n+#!/usr/bin/env groovy\n+\n+@Library('apm@current') _\n+pipeline {\n+  agent { label 'linux && immutable' }\n+  environment {\n+    REPO = 'apm-agent-java'\n+    BASE_DIR = \"src/github.com/elastic/${env.REPO}\"\n+    NOTIFY_TO = credentials('notify-to')\n+    DOCKERHUB_SECRET = 'secret/apm-team/ci/elastic-observability-dockerhub'\n+    ELASTIC_DOCKER_SECRET = 'secret/apm-team/ci/docker-registry/prod'\n+    NEXUS_SECRET = 'secret/apm-team/ci/nexus'\n+    MAVEN_CONFIG = '-Dmaven.repo.local=.m2'\n+    OPBEANS_REPO = 'opbeans-java'\n+\n+  }\n+  options {\n+    timeout(time: 3, unit: 'HOURS')\n+    buildDiscarder(logRotator(numToKeepStr: '20', artifactNumToKeepStr: '20', daysToKeepStr: '30'))\n+    timestamps()\n+    ansiColor('xterm')\n+    durabilityHint('PERFORMANCE_OPTIMIZED')\n+\n+  }\n+  parameters {\n+    string(name: 'MAVEN_CONFIG', defaultValue: '-B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn', description: 'Additional maven options.')\n+    string(name: 'branch_specifier', defaultValue: 'master')\n+  }\n+\n+  stages {\n+    stage('Initializing'){\n+      options { skipDefaultCheckout() }\n+      environment {\n+        HOME = \"${env.WORKSPACE}\"\n+        JAVA_HOME = \"${env.HUDSON_HOME}/.java/java10\"\n+        PATH = \"${env.JAVA_HOME}/bin:${env.PATH}\"\n+        MAVEN_CONFIG = \"${params.MAVEN_CONFIG} ${env.MAVEN_CONFIG}\"\n+      }\n+      stages {\n+        /**\n+         Checkout the code\n+        */\n+        stage('Checkout') {\n+          steps {\n+            dir(\"${BASE_DIR}\") {\n+              // This is required to ensure that Maven is working with a real branch\n+              sh(script: \"git checkout -f {$branch_specifier}\")\n+            }\n+          }\n+        }\n+      }\n+    }\n+    stage('Release') {\n+      options { skipDefaultCheckout () }\n+      stages{\n+        // 1. Check to see if oss.sonatype.org is up. We throw an exception and fail the job if there is no response.\n+        stage('Check oss.sonatype.org') {\n+          steps {\n+            // If this fails, an exception should be thrown and execution will halt\n+            httpRequest(url: \"https://oss.sonatype.org/#welcome\")\n+          }\n+        }\n+        // 2. Review project version.", "originalCommit": "f668eabc167475153708ee930eab7cd48907c9c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkwMjU2Mg==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r390902562", "bodyText": "Good idea! I have introduced this capability upstream in this PR.", "author": "cachedout", "createdAt": "2020-03-11T11:19:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTgzNTM4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTA1MDg2NQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r391050865", "bodyText": "I have introduced a step into this pipeline that warns if the master build is not passing and presents the user with an input asking if they would like to abort the build or continue.", "author": "cachedout", "createdAt": "2020-03-11T15:21:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTgzNTM4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE0Njg0Mw==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r390146843", "bodyText": "The GH release contains a link to a release-notes URL calculated in the Create GitHub release draft stage. This link will be available after the relevant branch gets built, after pushing the new tag in the Branch creation phase.\nIt takes time, so this step needs to block until the release-notes URL is available, otherwise we will publish a Release with a broken link.", "author": "eyalkoren", "createdAt": "2020-03-10T08:10:03Z", "path": ".ci/release/Jenkinsfile", "diffHunk": "@@ -0,0 +1,235 @@\n+#!/usr/bin/env groovy\n+\n+@Library('apm@current') _\n+pipeline {\n+  agent { label 'linux && immutable' }\n+  environment {\n+    REPO = 'apm-agent-java'\n+    BASE_DIR = \"src/github.com/elastic/${env.REPO}\"\n+    NOTIFY_TO = credentials('notify-to')\n+    DOCKERHUB_SECRET = 'secret/apm-team/ci/elastic-observability-dockerhub'\n+    ELASTIC_DOCKER_SECRET = 'secret/apm-team/ci/docker-registry/prod'\n+    NEXUS_SECRET = 'secret/apm-team/ci/nexus'\n+    MAVEN_CONFIG = '-Dmaven.repo.local=.m2'\n+    OPBEANS_REPO = 'opbeans-java'\n+\n+  }\n+  options {\n+    timeout(time: 3, unit: 'HOURS')\n+    buildDiscarder(logRotator(numToKeepStr: '20', artifactNumToKeepStr: '20', daysToKeepStr: '30'))\n+    timestamps()\n+    ansiColor('xterm')\n+    durabilityHint('PERFORMANCE_OPTIMIZED')\n+\n+  }\n+  parameters {\n+    string(name: 'MAVEN_CONFIG', defaultValue: '-B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn', description: 'Additional maven options.')\n+    string(name: 'branch_specifier', defaultValue: 'master')\n+  }\n+\n+  stages {\n+    stage('Initializing'){\n+      options { skipDefaultCheckout() }\n+      environment {\n+        HOME = \"${env.WORKSPACE}\"\n+        JAVA_HOME = \"${env.HUDSON_HOME}/.java/java10\"\n+        PATH = \"${env.JAVA_HOME}/bin:${env.PATH}\"\n+        MAVEN_CONFIG = \"${params.MAVEN_CONFIG} ${env.MAVEN_CONFIG}\"\n+      }\n+      stages {\n+        /**\n+         Checkout the code\n+        */\n+        stage('Checkout') {\n+          steps {\n+            dir(\"${BASE_DIR}\") {\n+              // This is required to ensure that Maven is working with a real branch\n+              sh(script: \"git checkout -f {$branch_specifier}\")\n+            }\n+          }\n+        }\n+      }\n+    }\n+    stage('Release') {\n+      options { skipDefaultCheckout () }\n+      stages{\n+        // 1. Check to see if oss.sonatype.org is up. We throw an exception and fail the job if there is no response.\n+        stage('Check oss.sonatype.org') {\n+          steps {\n+            // If this fails, an exception should be thrown and execution will halt\n+            httpRequest(url: \"https://oss.sonatype.org/#welcome\")\n+          }\n+        }\n+        // 2. Review project version.\n+        stage('Review project version') {\n+          steps {\n+            script {\n+              // Show the select input modal\n+              def INPUT_PARAMS = input message: 'Do you wish to update the version?', ok: 'Next', parameters: [choice(name: 'UPDATE_CHOICE', choices:['Yes', 'No'], description: \"This will run `mvn release:update-versions`\")]\n+              if (INPUT_PARAMS == 'Yes') {\n+                  dir(\"${BASE_DIR}\") {\n+                    sh mvn release:update-versions\n+                  }\n+              } else {\n+                  echo 'Skipping version update'\n+              }\n+            }\n+          }\n+        }\n+        // 3. Execute the release Jenkins job on the internal ci server.\n+            // For now we assume that the release has been pushed to staging already on the internal CI\n+        // 4. Login to oss.sonatype.org, go to Staging Repositories, close and release the staged artifacts.\n+        stage('Nexus release') {\n+          steps {\n+            script {\n+              def spid = getVault('nexus')[\"staging-profile-id\"]\n+              dir(\"${BASE_DIR}\"){\n+                withEnvMask(vars: [[var: \"SPID\", password: spid]]){\n+                  def foundStagingId = nexusFindStagingId(stagingProfileId: \"${SPID}\", groupId: \"co.elastic.apm\")\n+                  nexusCloseStagingRepository(stagingProfileId: \"${SPID}\", stagingId: foundStagingId)\n+                  nexusReleaseStagingRepository(stagingProfileId: \"${SPID}\", stagingId: foundStagingId)\n+                }\n+\n+              }\n+            }\n+          }\n+        }\n+        // 5. Fetch and checkout the latest tag e.g. git fetch origin\n+          // We already have this :)\n+        // 6. If this was a major release, create a new branch for the major.\n+        stage('Branch creation') {\n+          steps {\n+            dir(\"${BASE_DIR}\") {\n+              script {\n+                def isMajor = sh(script: 'git tag|tail -1|cut -f2-3 -d \".\"|{ read ver; test $ver == \"0.0\"; }', returnStatus: true)\n+                if (isMajor == 0) {\n+                  // We need to create a new branch. First get the name of the branch\n+                  def newBranchName = sh(script: 'git tag|tail -1|sed s/v//|cut -f1 -d \".\"|awk \\'{print $1\".x\"}\\'', returnStdout: true)\n+                  echo \"This appears to be a major version. We are creating a new branch for $newBranchName in the apm-agent-java repo on GitHub.\"\n+                  // Now we need to branch\n+                  sh(script: \"git checkout -b $newBranchName\")\n+                  // And push\n+                  githubEnv()\n+                  gitPush() \n+                  // 6.1 Add the new branch to the conf.yaml in the docs repo\n+                  input message: \"This was a major version release. Please update the conf.yml in the docs repo before continuing\", ok \"Continue\"\n+                } else {  // This was a minor release\n+                  // 7. If this was a minor release, reset the current major branch (1.x, 2.x etc) to point to the current tag, e.g. git branch -f 1.x v1.1.0\n+                  // Determine current tag\n+                  def curTag = sh(script: \"git tag|tail -1\", returnStdout: true)\n+                  def targetBranch = sh(script: 'git tag|tail -1|sed s/v//|cut -f1 -d '.'|awk \\'{print $1\".x\"}\\'', returnStdout: true)\n+                  sh(script: \"git branch -f $targetBranch $curTag\")\n+                  gitPush()\n+                }\n+              }\n+              // Checkout the tag again!\n+              sh(\"git checkout ${BUILD_TAG}\")\n+            }\n+          }\n+        }\n+        // 8. Update CHANGELOG.asciidoc to reflect version release. Go over PRs or git log and add bug fixes and features. \n+        stage('Generate a proposed CHANGELOG') {\n+          steps {\n+            githubEnv()\n+            generateChangelog(repo: 'apm-agent-java')\n+          }\n+        }\n+        // 9. Go to elastic/apm-agent-java/releases and draft a new release. Provide a link to release notes in documentation as release description.\n+        stage('Create GitHub release draft') {\n+          steps {\n+            dir(\"${BASE_DIR}\"){\n+              script {\n+                def curTag = sh(script: \"git tag|tail -1\", returnStdout: true)\n+                // Construct the URL with anchor for the release notes\n+                // Ex: https://www.elastic.co/guide/en/apm/agent/java/current/release-notes-1.x.html#release-notes-1.13.0\n+                def baseUrl = \"https://www.elastic.co/guide/en/apm/agent/java/current/release-notes-\"\n+                def dotX = sh(script: 'git tag|tail -1|sed s/v//|cut -f1 -d \".\"|awk \\'{print $1\".x\"}\\'', returnStdout: true)\n+                def bareTag = sh(script: 'git tag|tail -1|sed s/v//', returnStdout: true)\n+                def finalUrl = sh(script: \"echo $baseUrl$dotX\\.html#release-notes-$bareTag\")\n+                def ret = githubReleaseCreate(draft: true, body: \"[Release Notes for $bareTag]($finalUrl)\")\n+                env.RELEASE_ID = ret['id']\n+              }\n+            }\n+\n+          }\n+        }\n+        // 10. Update cloudfoundry/index.yml\n+        // Needs to append a line such as the following:\n+        // 1.13.0: https://repo1.maven.org/maven2/co/elastic/apm/elastic-apm-agent/1.13.0/elastic-apm-agent-1.13.0.jar\n+        stage('Update Cloudfoundry') {\n+          steps {\n+            dir(\"${basedir}\") {\n+              script {\n+                sh(\"git checkout master\")\n+                def bareTag = sh(script: 'git tag|tail -1|sed s/v//', returnStdout: true)\n+                def baseUrl = \"https://repo1.maven.org/maven2/co/elastic/apm/elastic-apm-agent\"\n+                def lineToAppend = sh(script: \"echo '$baseUrl: $baseUrl/$bareTag/elastic-apm-agent-$bareTag\\.jar' >> cloudfoundry/index.yml \")\n+                gitPush()\n+              }\n+            }\n+          }\n+        }\n+        // 11. Wait for released package to be available in maven central\n+        stage('Wait for artifact to be available in Maven Central') {\n+          steps {\n+            dir(\"${BASE_DIR}\"){\n+              script {\n+                // We are looking for something like this:\n+                // https://oss.sonatype.org/service/local/repositories/releases/content/co/elastic/apm/apm-agent-java/1.1.12/apm-agent-java-1.1.12.pom\n+                def baseUrl = \"https://oss.sonatype.org/service/local/repositories/releases/content/co/elastic/apm/apm-agent-java\"\n+                def bareTag = sh(script: 'git tag|tail -1|sed s/v//', returnStdout: true)\n+                def fullUrl = sh(script: \"$baseUrl/$bareTag/apm-agent-java-$bareTag\\.pom\")\n+                waitUntil(initialRecurrencePeriod: 15000) {\n+                  script {\n+                    def ret = sh(script: \"curl -fs $fullUrl >/dev/null 2>&1\", returnStatus: true)\n+                    echo \"Waiting for the artifacts to be published on Sonatype\"\n+                    return ret == 0\n+                  }\n+                }\n+              }\n+            }\n+\n+          }\n+        }\n+        // 12. Publish release on Github. This will notify users watching repository.\n+        stage('Publish release on GitHub') {\n+          steps {\n+            githubReleasePublish(id: ${env.RELEASE_ID})", "originalCommit": "f668eabc167475153708ee930eab7cd48907c9c0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE1OTM5NA==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r390159394", "bodyText": "We have added another step since you have started working on this regarding documentation:\n\nUpdate CHANGELOG.asciidoc to reflect the new version release:\nGo over PRs or git log and add bug fixes and features.\nMove release notes from the Unreleased sub-heading to the correct [[release-notes-{major}.x]] sub-heading (Example PR for 1.13.0 release).\n\nThis step seems a bit tricky to automate. But we could instead just show this instruction in an input. When done with manually reviewing and adjusting the release notes, the automated release continues.", "author": "felixbarny", "createdAt": "2020-03-10T08:38:14Z", "path": ".ci/release/Jenkinsfile", "diffHunk": "@@ -0,0 +1,235 @@\n+#!/usr/bin/env groovy\n+\n+@Library('apm@current') _\n+pipeline {\n+  agent { label 'linux && immutable' }\n+  environment {\n+    REPO = 'apm-agent-java'\n+    BASE_DIR = \"src/github.com/elastic/${env.REPO}\"\n+    NOTIFY_TO = credentials('notify-to')\n+    DOCKERHUB_SECRET = 'secret/apm-team/ci/elastic-observability-dockerhub'\n+    ELASTIC_DOCKER_SECRET = 'secret/apm-team/ci/docker-registry/prod'\n+    NEXUS_SECRET = 'secret/apm-team/ci/nexus'\n+    MAVEN_CONFIG = '-Dmaven.repo.local=.m2'\n+    OPBEANS_REPO = 'opbeans-java'\n+\n+  }\n+  options {\n+    timeout(time: 3, unit: 'HOURS')\n+    buildDiscarder(logRotator(numToKeepStr: '20', artifactNumToKeepStr: '20', daysToKeepStr: '30'))\n+    timestamps()\n+    ansiColor('xterm')\n+    durabilityHint('PERFORMANCE_OPTIMIZED')\n+\n+  }\n+  parameters {\n+    string(name: 'MAVEN_CONFIG', defaultValue: '-B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn', description: 'Additional maven options.')\n+    string(name: 'branch_specifier', defaultValue: 'master')\n+  }\n+\n+  stages {\n+    stage('Initializing'){\n+      options { skipDefaultCheckout() }\n+      environment {\n+        HOME = \"${env.WORKSPACE}\"\n+        JAVA_HOME = \"${env.HUDSON_HOME}/.java/java10\"\n+        PATH = \"${env.JAVA_HOME}/bin:${env.PATH}\"\n+        MAVEN_CONFIG = \"${params.MAVEN_CONFIG} ${env.MAVEN_CONFIG}\"\n+      }\n+      stages {\n+        /**\n+         Checkout the code\n+        */\n+        stage('Checkout') {\n+          steps {\n+            dir(\"${BASE_DIR}\") {\n+              // This is required to ensure that Maven is working with a real branch\n+              sh(script: \"git checkout -f {$branch_specifier}\")\n+            }\n+          }\n+        }\n+      }\n+    }\n+    stage('Release') {\n+      options { skipDefaultCheckout () }\n+      stages{\n+        // 1. Check to see if oss.sonatype.org is up. We throw an exception and fail the job if there is no response.\n+        stage('Check oss.sonatype.org') {\n+          steps {\n+            // If this fails, an exception should be thrown and execution will halt", "originalCommit": "f668eabc167475153708ee930eab7cd48907c9c0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDE1MTI5MQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r400151291", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                OPBEANS_REPO = 'opbeans-java'", "author": "v1v", "createdAt": "2020-03-30T12:27:56Z", "path": ".ci/release/Jenkinsfile", "diffHunk": "@@ -0,0 +1,238 @@\n+#!/usr/bin/env groovy\n+\n+@Library('apm@current') _\n+pipeline {\n+  agent { label 'linux && immutable' }\n+  environment {\n+    REPO = 'apm-agent-java'\n+    BASE_DIR = \"src/github.com/elastic/${env.REPO}\"\n+    NOTIFY_TO = credentials('notify-to')\n+    DOCKERHUB_SECRET = 'secret/apm-team/ci/elastic-observability-dockerhub'\n+    ELASTIC_DOCKER_SECRET = 'secret/apm-team/ci/docker-registry/prod'\n+    NEXUS_SECRET = 'secret/apm-team/ci/nexus'\n+    MAVEN_CONFIG = '-B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn -Dmaven.repo.local=.m2'\n+    OPBEANS_REPO = 'opbeans-java'\n+", "originalCommit": "cb9ea08b73db9687fb70a1ea7a78abf993df369a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDE1MjY3Mw==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r400152673", "bodyText": "These env variables are only defined in the top-level Initializing stage that it's only used in the nested checkout stage. Is this required for the other stages?", "author": "v1v", "createdAt": "2020-03-30T12:30:09Z", "path": ".ci/release/Jenkinsfile", "diffHunk": "@@ -0,0 +1,238 @@\n+#!/usr/bin/env groovy\n+\n+@Library('apm@current') _\n+pipeline {\n+  agent { label 'linux && immutable' }\n+  environment {\n+    REPO = 'apm-agent-java'\n+    BASE_DIR = \"src/github.com/elastic/${env.REPO}\"\n+    NOTIFY_TO = credentials('notify-to')\n+    DOCKERHUB_SECRET = 'secret/apm-team/ci/elastic-observability-dockerhub'\n+    ELASTIC_DOCKER_SECRET = 'secret/apm-team/ci/docker-registry/prod'\n+    NEXUS_SECRET = 'secret/apm-team/ci/nexus'\n+    MAVEN_CONFIG = '-B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn -Dmaven.repo.local=.m2'\n+    OPBEANS_REPO = 'opbeans-java'\n+\n+  }\n+  options {\n+    timeout(time: 3, unit: 'HOURS')\n+    buildDiscarder(logRotator(numToKeepStr: '20', artifactNumToKeepStr: '20', daysToKeepStr: '30'))\n+    timestamps()\n+    ansiColor('xterm')\n+    durabilityHint('PERFORMANCE_OPTIMIZED')\n+\n+  }\n+  parameters {\n+    string(name: 'branch_specifier', defaultValue: 'master')\n+  }\n+\n+  stages {\n+    stage('Initializing'){\n+      options { skipDefaultCheckout() }\n+      environment {\n+        HOME = \"${env.WORKSPACE}\"\n+        JAVA_HOME = \"${env.HUDSON_HOME}/.java/java10\"\n+        PATH = \"${env.JAVA_HOME}/bin:${env.PATH}\"", "originalCommit": "cb9ea08b73db9687fb70a1ea7a78abf993df369a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc4NjgwNw==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r400786807", "bodyText": "Good catch. I moved them up to the top level where they belong.", "author": "cachedout", "createdAt": "2020-03-31T09:56:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDE1MjY3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDE1MzIxNQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r400153215", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                          sh(script: \"git checkout -f {$branch_specifier}\")\n          \n          \n            \n                          sh(script: \"git checkout -f ${branch_specifier}\")", "author": "v1v", "createdAt": "2020-03-30T12:31:03Z", "path": ".ci/release/Jenkinsfile", "diffHunk": "@@ -0,0 +1,238 @@\n+#!/usr/bin/env groovy\n+\n+@Library('apm@current') _\n+pipeline {\n+  agent { label 'linux && immutable' }\n+  environment {\n+    REPO = 'apm-agent-java'\n+    BASE_DIR = \"src/github.com/elastic/${env.REPO}\"\n+    NOTIFY_TO = credentials('notify-to')\n+    DOCKERHUB_SECRET = 'secret/apm-team/ci/elastic-observability-dockerhub'\n+    ELASTIC_DOCKER_SECRET = 'secret/apm-team/ci/docker-registry/prod'\n+    NEXUS_SECRET = 'secret/apm-team/ci/nexus'\n+    MAVEN_CONFIG = '-B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn -Dmaven.repo.local=.m2'\n+    OPBEANS_REPO = 'opbeans-java'\n+\n+  }\n+  options {\n+    timeout(time: 3, unit: 'HOURS')\n+    buildDiscarder(logRotator(numToKeepStr: '20', artifactNumToKeepStr: '20', daysToKeepStr: '30'))\n+    timestamps()\n+    ansiColor('xterm')\n+    durabilityHint('PERFORMANCE_OPTIMIZED')\n+\n+  }\n+  parameters {\n+    string(name: 'branch_specifier', defaultValue: 'master')\n+  }\n+\n+  stages {\n+    stage('Initializing'){\n+      options { skipDefaultCheckout() }\n+      environment {\n+        HOME = \"${env.WORKSPACE}\"\n+        JAVA_HOME = \"${env.HUDSON_HOME}/.java/java10\"\n+        PATH = \"${env.JAVA_HOME}/bin:${env.PATH}\"\n+      }\n+      stages {\n+        /**\n+         Checkout the code\n+        */\n+        stage('Checkout') {\n+          steps {\n+            dir(\"${BASE_DIR}\") {\n+              // This is required to ensure that Maven is working with a real branch\n+              sh(script: \"git checkout -f {$branch_specifier}\")", "originalCommit": "cb9ea08b73db9687fb70a1ea7a78abf993df369a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDE1NDg0Mw==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r400154843", "bodyText": "Moved to the script closure\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // 2.1 Fetch the current version from pom.xml\n          \n          \n            \n                        def ver = mvnVersion(showQualifiers: true)\n          \n          \n            \n                        // 2.2 Raise a prompt asking if the version is correct or if they wish to update\n          \n          \n            \n                        script {\n          \n          \n            \n                          def should_continue = input(message: \"Current version is ${ver}\", parameters: [\n          \n          \n            \n                        script {\n          \n          \n            \n                          // 2.1 Fetch the current version from pom.xml\n          \n          \n            \n                          def ver = mvnVersion(showQualifiers: true)\n          \n          \n            \n                          // 2.2 Raise a prompt asking if the version is correct or if they wish to update\n          \n          \n            \n                          def should_continue = input(message: \"Current version is ${ver}\", parameters: [", "author": "v1v", "createdAt": "2020-03-30T12:33:57Z", "path": ".ci/release/Jenkinsfile", "diffHunk": "@@ -0,0 +1,238 @@\n+#!/usr/bin/env groovy\n+\n+@Library('apm@current') _\n+pipeline {\n+  agent { label 'linux && immutable' }\n+  environment {\n+    REPO = 'apm-agent-java'\n+    BASE_DIR = \"src/github.com/elastic/${env.REPO}\"\n+    NOTIFY_TO = credentials('notify-to')\n+    DOCKERHUB_SECRET = 'secret/apm-team/ci/elastic-observability-dockerhub'\n+    ELASTIC_DOCKER_SECRET = 'secret/apm-team/ci/docker-registry/prod'\n+    NEXUS_SECRET = 'secret/apm-team/ci/nexus'\n+    MAVEN_CONFIG = '-B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn -Dmaven.repo.local=.m2'\n+    OPBEANS_REPO = 'opbeans-java'\n+\n+  }\n+  options {\n+    timeout(time: 3, unit: 'HOURS')\n+    buildDiscarder(logRotator(numToKeepStr: '20', artifactNumToKeepStr: '20', daysToKeepStr: '30'))\n+    timestamps()\n+    ansiColor('xterm')\n+    durabilityHint('PERFORMANCE_OPTIMIZED')\n+\n+  }\n+  parameters {\n+    string(name: 'branch_specifier', defaultValue: 'master')\n+  }\n+\n+  stages {\n+    stage('Initializing'){\n+      options { skipDefaultCheckout() }\n+      environment {\n+        HOME = \"${env.WORKSPACE}\"\n+        JAVA_HOME = \"${env.HUDSON_HOME}/.java/java10\"\n+        PATH = \"${env.JAVA_HOME}/bin:${env.PATH}\"\n+      }\n+      stages {\n+        /**\n+         Checkout the code\n+        */\n+        stage('Checkout') {\n+          steps {\n+            dir(\"${BASE_DIR}\") {\n+              // This is required to ensure that Maven is working with a real branch\n+              sh(script: \"git checkout -f {$branch_specifier}\")\n+            }\n+          }\n+        }\n+      }\n+    }\n+    stage('Release') {\n+      options { skipDefaultCheckout () }\n+      stages{\n+        // 1. Check to see if oss.sonatype.org is up. We throw an exception and fail the job if there is no response.\n+        stage('Check oss.sonatype.org') {\n+          steps {\n+            // If this fails, an exception should be thrown and execution will halt\n+            httpRequest(url: \"https://oss.sonatype.org/#welcome\")\n+          }\n+        }\n+        // 1.1 Check to ensure the build is green. Require confirmation if it is not.\n+        stage('Check master build status') {\n+          steps {\n+            script {\n+              // If this build is not green: https://apm-ci.elastic.co/job/apm-agent-java/job/apm-agent-java-mbp/job/master/\n+              if(!buildStatus(host: 'apm-ci.elastic.co', job: ['apm-agent-java', 'apm-agent-java-mbp', 'master'], return_boolean: true)) {\n+                input(message: \"WARNING! The master build is not passing. Do you wish to continue?\")\n+              }\n+            }\n+          }\n+        }\n+        // 2. Review project version.\n+        stage('Review project version') {\n+          steps {\n+            // 2.1 Fetch the current version from pom.xml\n+            def ver = mvnVersion(showQualifiers: true)\n+            // 2.2 Raise a prompt asking if the version is correct or if they wish to update\n+            script {\n+              def should_continue = input(message: \"Current version is ${ver}\", parameters: [", "originalCommit": "cb9ea08b73db9687fb70a1ea7a78abf993df369a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzAxODg3OA==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r413018878", "bodyText": "A few comments regarding the git commands\n\nIs it possible to use the gitCheckout step instead the sh step? If so, then we can remove the githubEnv references\nCan we use the withGitRelease step before pushing with the command gitPush?\nCan we use the setupAPMGitEmail step to configure the user.email and user.name?", "author": "v1v", "createdAt": "2020-04-22T14:12:40Z", "path": ".ci/release/Jenkinsfile", "diffHunk": "@@ -0,0 +1,255 @@\n+#!/usr/bin/env groovy\n+\n+@Library('apm@current') _\n+pipeline {\n+  agent { label 'linux && immutable' }\n+  environment {\n+    REPO = 'apm-agent-java'\n+    BASE_DIR = \"src/github.com/elastic/${env.REPO}\"\n+    NOTIFY_TO = credentials('notify-to')\n+    DOCKERHUB_SECRET = 'secret/apm-team/ci/elastic-observability-dockerhub'\n+    ELASTIC_DOCKER_SECRET = 'secret/apm-team/ci/docker-registry/prod'\n+    NEXUS_SECRET = 'secret/apm-team/ci/nexus'\n+    MAVEN_CONFIG = '-B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn -Dmaven.repo.local=.m2'\n+    HOME = \"${env.WORKSPACE}\"\n+    JAVA_HOME = \"${env.HUDSON_HOME}/.java/java10\"\n+    PATH = \"${env.JAVA_HOME}/bin:${env.PATH}\"\n+  }\n+  options {\n+    timeout(time: 3, unit: 'HOURS')\n+    buildDiscarder(logRotator(numToKeepStr: '20', artifactNumToKeepStr: '20', daysToKeepStr: '30'))\n+    timestamps()\n+    ansiColor('xterm')\n+    durabilityHint('PERFORMANCE_OPTIMIZED')\n+\n+  }\n+  parameters {\n+    string(name: 'branch_specifier', defaultValue: 'master')\n+  }\n+\n+  stages {\n+    stage('Initializing'){\n+      options { skipDefaultCheckout() }\n+      stages {\n+        /**\n+         Checkout the code\n+        */\n+        stage('Checkout') {\n+          steps {\n+            dir(\"${BASE_DIR}\") {\n+              // This is required to ensure that Maven is working with a real branch\n+              sh(script: \"git checkout -f ${branch_specifier}\")", "originalCommit": "d93fe965503acc9a8b8b9d876c28b02ececa2688", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIwNDQ5NA==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r417204494", "bodyText": "See #1058 (comment)\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                          setupAPMGitEmail()", "author": "v1v", "createdAt": "2020-04-29T10:08:07Z", "path": ".ci/release/Jenkinsfile", "diffHunk": "@@ -0,0 +1,229 @@\n+#!/usr/bin/env groovy\n+\n+@Library('apm@current') _\n+pipeline {\n+  agent { label 'linux && immutable' }\n+  environment {\n+    REPO = 'apm-agent-java'\n+    BASE_DIR = \"src/github.com/elastic/${env.REPO}\"\n+    NOTIFY_TO = credentials('notify-to')\n+    DOCKERHUB_SECRET = 'secret/apm-team/ci/elastic-observability-dockerhub'\n+    ELASTIC_DOCKER_SECRET = 'secret/apm-team/ci/docker-registry/prod'\n+    NEXUS_SECRET = 'secret/apm-team/ci/nexus'\n+    MAVEN_CONFIG = '-B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn -Dmaven.repo.local=.m2'\n+    HOME = \"${env.WORKSPACE}\"\n+    JAVA_HOME = \"${env.HUDSON_HOME}/.java/java10\"\n+    PATH = \"${env.JAVA_HOME}/bin:${env.PATH}\"\n+  }\n+  options {\n+    timeout(time: 3, unit: 'HOURS')\n+    buildDiscarder(logRotator(numToKeepStr: '20', artifactNumToKeepStr: '20', daysToKeepStr: '30'))\n+    timestamps()\n+    ansiColor('xterm')\n+    durabilityHint('PERFORMANCE_OPTIMIZED')\n+\n+  }\n+  parameters {\n+    string(name: 'branch_specifier', defaultValue: 'master')\n+  }\n+\n+  stages {\n+    stage('Initializing'){\n+      options { skipDefaultCheckout() }\n+      stages {\n+        stage('Checkout') {\n+          steps {\n+            gitCheckout(\n+                basedir: \"${BASE_DIR}\",\n+                branch: 'master',\n+                repo: 'git@github.com:elastic/apm-agent-java.git',\n+                credentialsId: 'f6c7695a-671e-4f4f-a331-acdce44ff9ba',\n+                shallow: false\n+            )\n+            stash(allowEmpty: true, name: 'source', useDefaultExcludes: false)\n+            dir(\"${BASE_DIR}\") {\n+              setupAPMGitEmail()\n+              script {\n+                env.TAG_BARE = sh(script: \"git tag | tail -1\", returnStdout: true)\n+                env.TAG_VER = sh(script: \"git tag | tail -1 | sed s/v//\", returnStdout: true)\n+                env.TAG_DOT_X = sh(script: 'git tag|tail -1|sed s/v//|cut -f1 -d \".\"|awk \\'{print $1\".x\"}\\'', returnStdout: true)\n+              }\n+            }\n+          }\n+        }\n+      }\n+    }\n+    stage('Release') {\n+      options { skipDefaultCheckout () }\n+      stages{\n+        stage('Check oss.sonatype.org') {\n+          steps {\n+            // If this fails, an exception should be thrown and execution will halt\n+            script {\n+              def r = sh(label: \"Check Maven status\", script: \"scripts/jenkins/check_maven.sh -u https://status.maven.org/api/v2/summary.json --component OSSRH\", returnStatus: true)\n+              if (r == 1) {\n+                error(\"Failing release build because Maven is the OSSRH component is not fully operational. See https://status.maven.org/ for more details.\")\n+              }\n+            }\n+          }\n+        }\n+        stage('Check master build status') {\n+          steps {\n+            script {\n+              // If this build is not green: https://apm-ci.elastic.co/job/apm-agent-java/job/apm-agent-java-mbp/job/master/\n+              if(!buildStatus(host: 'apm-ci.elastic.co', job: ['apm-agent-java', 'apm-agent-java-mbp', 'master'], return_boolean: true)) {\n+                input(message: \"WARNING! The master build is not passing. Do you wish to continue?\")\n+              }\n+            }\n+          }\n+        }\n+        stage('Require confirmation that CHANGELOG.asciidoc has been updated') {\n+          steps {\n+            input(message: \"\"\"\n+            Update CHANGELOG.asciidoc to reflect the new version release:\n+            Go over PRs or git log and add bug fixes and features.\n+            Move release notes from the Unreleased sub-heading to the correct [[release-notes-{major}.x]] sub-heading (Example PR for 1.13.0 release).\n+\n+            Click 'Proceed' to confirm that this step has been completed or Abort to stop the build in order to complete this step.\n+            \"\"\"\n+            )\n+          }\n+        }\n+        stage('Review project version') {\n+          steps {\n+            script {\n+              def ver = mvnVersion(showQualifiers: true)\n+              def should_continue = input(message: \"Current version is ${ver}\", parameters: [\n+                [\n+                  $class: 'ChoiceParameterDefinition',\n+                  name: \"Do you wish to update the version?\",\n+                  \"choices\": [\"Yes\", \"No\"],\n+                  description: \"Selecting 'Yes' will allow you to select the new version in the next step.\"\n+                ]\n+              ])\n+              if (should_continue == 'Yes'){\n+                def new_version = input(message: \"Please enter version to change to:\", parameters:\n+                  [\n+                    [\n+                      $class: 'StringParameterDefinition',\n+                      defaultValue: \"${ver}\",\n+                      description: 'We will run mvn versions:set -DnewVersion=<NEW_VERSION>', name: 'New Version'\n+                    ]\n+                  ]\n+                )\n+                sh(name: \"mavenVersionUpdate\", script: \"mvn versions:set -DnewVersion=${new_version}\")\n+              } else {\n+                echo \"Skipping version update\"\n+              }\n+            }\n+          }\n+        }\n+        stage('Nexus release') {\n+          steps {\n+            script {\n+              def spid = getVault('nexus')[\"staging-profile-id\"]\n+              dir(\"${BASE_DIR}\"){\n+                withEnvMask(vars: [[var: \"SPID\", password: spid]]){\n+                  def foundStagingId = nexusFindStagingId(stagingProfileId: \"${SPID}\", groupId: \"co.elastic.apm\")\n+                  nexusCloseStagingRepository(stagingProfileId: \"${SPID}\", stagingId: foundStagingId)\n+                  nexusReleaseStagingRepository(stagingProfileId: \"${SPID}\", stagingId: foundStagingId)\n+                }\n+              }\n+            }\n+          }\n+        }\n+        stage('Branch creation') {\n+          steps {\n+            dir(\"${BASE_DIR}\") {\n+              setupAPMGitEmail()", "originalCommit": "a8504adaec5b4dad26a8b5f549be795831e96b3f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIwNzk4OA==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r417207988", "bodyText": "What do you think to move the setupAPMGitEmail before the stash? Then all the other calls afteeward are not required:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        stash(allowEmpty: true, name: 'source', useDefaultExcludes: false)\n          \n          \n            \n                        dir(\"${BASE_DIR}\") {\n          \n          \n            \n                          setupAPMGitEmail()\n          \n          \n            \n                          script {\n          \n          \n            \n                            env.TAG_BARE = sh(script: \"git tag | tail -1\", returnStdout: true)\n          \n          \n            \n                            env.TAG_VER = sh(script: \"git tag | tail -1 | sed s/v//\", returnStdout: true)\n          \n          \n            \n                            env.TAG_DOT_X = sh(script: 'git tag|tail -1|sed s/v//|cut -f1 -d \".\"|awk \\'{print $1\".x\"}\\'', returnStdout: true)\n          \n          \n            \n                          }\n          \n          \n            \n                        }\n          \n          \n            \n                        dir(\"${BASE_DIR}\") {\n          \n          \n            \n                          setupAPMGitEmail()\n          \n          \n            \n                        }\n          \n          \n            \n                        stash(allowEmpty: true, name: 'source', useDefaultExcludes: false)\n          \n          \n            \n                        dir(\"${BASE_DIR}\") {\n          \n          \n            \n                          script {\n          \n          \n            \n                            env.TAG_BARE = sh(script: \"git tag | tail -1\", returnStdout: true)\n          \n          \n            \n                            env.TAG_VER = sh(script: \"git tag | tail -1 | sed s/v//\", returnStdout: true)\n          \n          \n            \n                            env.TAG_DOT_X = sh(script: 'git tag|tail -1|sed s/v//|cut -f1 -d \".\"|awk \\'{print $1\".x\"}\\'', returnStdout: true)\n          \n          \n            \n                          }\n          \n          \n            \n                        }", "author": "v1v", "createdAt": "2020-04-29T10:14:51Z", "path": ".ci/release/Jenkinsfile", "diffHunk": "@@ -0,0 +1,229 @@\n+#!/usr/bin/env groovy\n+\n+@Library('apm@current') _\n+pipeline {\n+  agent { label 'linux && immutable' }\n+  environment {\n+    REPO = 'apm-agent-java'\n+    BASE_DIR = \"src/github.com/elastic/${env.REPO}\"\n+    NOTIFY_TO = credentials('notify-to')\n+    DOCKERHUB_SECRET = 'secret/apm-team/ci/elastic-observability-dockerhub'\n+    ELASTIC_DOCKER_SECRET = 'secret/apm-team/ci/docker-registry/prod'\n+    NEXUS_SECRET = 'secret/apm-team/ci/nexus'\n+    MAVEN_CONFIG = '-B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn -Dmaven.repo.local=.m2'\n+    HOME = \"${env.WORKSPACE}\"\n+    JAVA_HOME = \"${env.HUDSON_HOME}/.java/java10\"\n+    PATH = \"${env.JAVA_HOME}/bin:${env.PATH}\"\n+  }\n+  options {\n+    timeout(time: 3, unit: 'HOURS')\n+    buildDiscarder(logRotator(numToKeepStr: '20', artifactNumToKeepStr: '20', daysToKeepStr: '30'))\n+    timestamps()\n+    ansiColor('xterm')\n+    durabilityHint('PERFORMANCE_OPTIMIZED')\n+\n+  }\n+  parameters {\n+    string(name: 'branch_specifier', defaultValue: 'master')\n+  }\n+\n+  stages {\n+    stage('Initializing'){\n+      options { skipDefaultCheckout() }\n+      stages {\n+        stage('Checkout') {\n+          steps {\n+            gitCheckout(\n+                basedir: \"${BASE_DIR}\",\n+                branch: 'master',\n+                repo: 'git@github.com:elastic/apm-agent-java.git',\n+                credentialsId: 'f6c7695a-671e-4f4f-a331-acdce44ff9ba',\n+                shallow: false\n+            )\n+            stash(allowEmpty: true, name: 'source', useDefaultExcludes: false)\n+            dir(\"${BASE_DIR}\") {\n+              setupAPMGitEmail()\n+              script {\n+                env.TAG_BARE = sh(script: \"git tag | tail -1\", returnStdout: true)\n+                env.TAG_VER = sh(script: \"git tag | tail -1 | sed s/v//\", returnStdout: true)\n+                env.TAG_DOT_X = sh(script: 'git tag|tail -1|sed s/v//|cut -f1 -d \".\"|awk \\'{print $1\".x\"}\\'', returnStdout: true)\n+              }\n+            }", "originalCommit": "a8504adaec5b4dad26a8b5f549be795831e96b3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIxNjAzMg==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r417216032", "bodyText": "I was wondering about that. I was just being extra-cautious here since there isn't much harm in setting it multiple times but if it will work this way than that's even better.", "author": "cachedout", "createdAt": "2020-04-29T10:30:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIwNzk4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIwODY2OQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r417208669", "bodyText": "See #1058 (comment) and #1058 (comment)\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                          script {\n          \n          \n            \n                            env.BRANCH_NAME = \"master\"\n          \n          \n            \n                          }\n          \n          \n            \n                          withGitRelease() {\n          \n          \n            \n                            setupAPMGitEmail()\n          \n          \n            \n                          withGitRelease() {", "author": "v1v", "createdAt": "2020-04-29T10:16:16Z", "path": ".ci/release/Jenkinsfile", "diffHunk": "@@ -0,0 +1,229 @@\n+#!/usr/bin/env groovy\n+\n+@Library('apm@current') _\n+pipeline {\n+  agent { label 'linux && immutable' }\n+  environment {\n+    REPO = 'apm-agent-java'\n+    BASE_DIR = \"src/github.com/elastic/${env.REPO}\"\n+    NOTIFY_TO = credentials('notify-to')\n+    DOCKERHUB_SECRET = 'secret/apm-team/ci/elastic-observability-dockerhub'\n+    ELASTIC_DOCKER_SECRET = 'secret/apm-team/ci/docker-registry/prod'\n+    NEXUS_SECRET = 'secret/apm-team/ci/nexus'\n+    MAVEN_CONFIG = '-B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn -Dmaven.repo.local=.m2'\n+    HOME = \"${env.WORKSPACE}\"\n+    JAVA_HOME = \"${env.HUDSON_HOME}/.java/java10\"\n+    PATH = \"${env.JAVA_HOME}/bin:${env.PATH}\"\n+  }\n+  options {\n+    timeout(time: 3, unit: 'HOURS')\n+    buildDiscarder(logRotator(numToKeepStr: '20', artifactNumToKeepStr: '20', daysToKeepStr: '30'))\n+    timestamps()\n+    ansiColor('xterm')\n+    durabilityHint('PERFORMANCE_OPTIMIZED')\n+\n+  }\n+  parameters {\n+    string(name: 'branch_specifier', defaultValue: 'master')\n+  }\n+\n+  stages {\n+    stage('Initializing'){\n+      options { skipDefaultCheckout() }\n+      stages {\n+        stage('Checkout') {\n+          steps {\n+            gitCheckout(\n+                basedir: \"${BASE_DIR}\",\n+                branch: 'master',\n+                repo: 'git@github.com:elastic/apm-agent-java.git',\n+                credentialsId: 'f6c7695a-671e-4f4f-a331-acdce44ff9ba',\n+                shallow: false\n+            )\n+            stash(allowEmpty: true, name: 'source', useDefaultExcludes: false)\n+            dir(\"${BASE_DIR}\") {\n+              setupAPMGitEmail()\n+              script {\n+                env.TAG_BARE = sh(script: \"git tag | tail -1\", returnStdout: true)\n+                env.TAG_VER = sh(script: \"git tag | tail -1 | sed s/v//\", returnStdout: true)\n+                env.TAG_DOT_X = sh(script: 'git tag|tail -1|sed s/v//|cut -f1 -d \".\"|awk \\'{print $1\".x\"}\\'', returnStdout: true)\n+              }\n+            }\n+          }\n+        }\n+      }\n+    }\n+    stage('Release') {\n+      options { skipDefaultCheckout () }\n+      stages{\n+        stage('Check oss.sonatype.org') {\n+          steps {\n+            // If this fails, an exception should be thrown and execution will halt\n+            script {\n+              def r = sh(label: \"Check Maven status\", script: \"scripts/jenkins/check_maven.sh -u https://status.maven.org/api/v2/summary.json --component OSSRH\", returnStatus: true)\n+              if (r == 1) {\n+                error(\"Failing release build because Maven is the OSSRH component is not fully operational. See https://status.maven.org/ for more details.\")\n+              }\n+            }\n+          }\n+        }\n+        stage('Check master build status') {\n+          steps {\n+            script {\n+              // If this build is not green: https://apm-ci.elastic.co/job/apm-agent-java/job/apm-agent-java-mbp/job/master/\n+              if(!buildStatus(host: 'apm-ci.elastic.co', job: ['apm-agent-java', 'apm-agent-java-mbp', 'master'], return_boolean: true)) {\n+                input(message: \"WARNING! The master build is not passing. Do you wish to continue?\")\n+              }\n+            }\n+          }\n+        }\n+        stage('Require confirmation that CHANGELOG.asciidoc has been updated') {\n+          steps {\n+            input(message: \"\"\"\n+            Update CHANGELOG.asciidoc to reflect the new version release:\n+            Go over PRs or git log and add bug fixes and features.\n+            Move release notes from the Unreleased sub-heading to the correct [[release-notes-{major}.x]] sub-heading (Example PR for 1.13.0 release).\n+\n+            Click 'Proceed' to confirm that this step has been completed or Abort to stop the build in order to complete this step.\n+            \"\"\"\n+            )\n+          }\n+        }\n+        stage('Review project version') {\n+          steps {\n+            script {\n+              def ver = mvnVersion(showQualifiers: true)\n+              def should_continue = input(message: \"Current version is ${ver}\", parameters: [\n+                [\n+                  $class: 'ChoiceParameterDefinition',\n+                  name: \"Do you wish to update the version?\",\n+                  \"choices\": [\"Yes\", \"No\"],\n+                  description: \"Selecting 'Yes' will allow you to select the new version in the next step.\"\n+                ]\n+              ])\n+              if (should_continue == 'Yes'){\n+                def new_version = input(message: \"Please enter version to change to:\", parameters:\n+                  [\n+                    [\n+                      $class: 'StringParameterDefinition',\n+                      defaultValue: \"${ver}\",\n+                      description: 'We will run mvn versions:set -DnewVersion=<NEW_VERSION>', name: 'New Version'\n+                    ]\n+                  ]\n+                )\n+                sh(name: \"mavenVersionUpdate\", script: \"mvn versions:set -DnewVersion=${new_version}\")\n+              } else {\n+                echo \"Skipping version update\"\n+              }\n+            }\n+          }\n+        }\n+        stage('Nexus release') {\n+          steps {\n+            script {\n+              def spid = getVault('nexus')[\"staging-profile-id\"]\n+              dir(\"${BASE_DIR}\"){\n+                withEnvMask(vars: [[var: \"SPID\", password: spid]]){\n+                  def foundStagingId = nexusFindStagingId(stagingProfileId: \"${SPID}\", groupId: \"co.elastic.apm\")\n+                  nexusCloseStagingRepository(stagingProfileId: \"${SPID}\", stagingId: foundStagingId)\n+                  nexusReleaseStagingRepository(stagingProfileId: \"${SPID}\", stagingId: foundStagingId)\n+                }\n+              }\n+            }\n+          }\n+        }\n+        stage('Branch creation') {\n+          steps {\n+            dir(\"${BASE_DIR}\") {\n+              setupAPMGitEmail()\n+              script {\n+                env.BRANCH_NAME = \"tags/${env.TAG_BARE}\"\n+              }\n+              withGitRelease() {\n+                script {\n+                  def curVer = mvnVersion()\n+                  sh(script: \"./scripts/jenkins/branch_creation.sh ${curVer}\")\n+                  def isMajor = sh(script: \"./scripts/jenkins/is_major.sh ${curVer}\", returnStatus: true)\n+                  if (isMajor == 0) {\n+                    input message: \"This was a major version release. Please update the conf.yml in the docs repo before continuing\", ok \"Continue\"\n+                  }\n+                }\n+                gitPush()\n+              } \n+            }\n+          }\n+        }\n+        stage('Create GitHub release draft') {\n+          steps {\n+            deleteDir()\n+            unstash 'source'\n+            dir(\"${BASE_DIR}\"){\n+              script {\n+                def curVer = mvnVersion(showQualifiers: false)\n+                // Construct the URL with anchor for the release notes\n+                // Ex: https://www.elastic.co/guide/en/apm/agent/java/current/release-notes-1.x.html#release-notes-1.13.0\n+                def finalUrl = sh(script: \"scripts/jenkins/generate_release_notes_url.sh ${curVer}\", , returnStdout: true)\n+                def ret = githubReleaseCreate(draft: true, name: \"Release ${curVer}\", body: \"[Release Notes for ${curVer}](${finalUrl})\")\n+                env.RELEASE_ID = ret['id']\n+                env.RELEASE_NOTES_URL = finalUrl\n+              }\n+            }\n+\n+          }\n+        }\n+        stage('Wait for artifact to be available in Maven Central') {\n+          steps {\n+            script {\n+              def fullUrl = sh(script: \"./scripts/jenkins/maven_artifact_url.sh \")\n+              echo \"Sleeping for ten minutes to wait for Sonatype\"\n+              sleep(time: 10, unit: \"MINUTES\")\n+              waitUntil(initialRecurrencePeriod: 60000) {\n+                script {\n+                  def ret = sh(script: \"curl -fs $fullUrl >/dev/null 2>&1\", returnStatus: true)\n+                  echo \"Waiting for the artifacts to be published on Sonatype\"\n+                  return ret == 0\n+                }\n+              }\n+            }\n+          }\n+        }\n+        stage('Update Cloudfoundry') {\n+          steps {\n+            deleteDir()\n+            unstash 'source'\n+            dir(\"${BASE_DIR}\"){\n+              script {\n+                env.BRANCH_NAME = \"master\"\n+              }\n+              withGitRelease() {\n+                setupAPMGitEmail()", "originalCommit": "a8504adaec5b4dad26a8b5f549be795831e96b3f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIxMDg0Nw==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r417210847", "bodyText": "IIRC, BRANCH_NAME is a read only env variable, withEnv could help to change the value for the release context, what do you think?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                          script {\n          \n          \n            \n                            env.BRANCH_NAME = \"tags/${env.TAG_BARE}\"\n          \n          \n            \n                          }\n          \n          \n            \n                          withGitRelease() {\n          \n          \n            \n                            script {\n          \n          \n            \n                              def curVer = mvnVersion()\n          \n          \n            \n                              sh(script: \"./scripts/jenkins/branch_creation.sh ${curVer}\")\n          \n          \n            \n                              def isMajor = sh(script: \"./scripts/jenkins/is_major.sh ${curVer}\", returnStatus: true)\n          \n          \n            \n                              if (isMajor == 0) {\n          \n          \n            \n                                input message: \"This was a major version release. Please update the conf.yml in the docs repo before continuing\", ok \"Continue\"\n          \n          \n            \n                              }\n          \n          \n            \n                            }\n          \n          \n            \n                            gitPush()\n          \n          \n            \n                          } \n          \n          \n            \n                          withEnv([\"BRANCH_NAME=tags/${env.TAG_BARE}\"]){\n          \n          \n            \n                            withGitRelease() {\n          \n          \n            \n                              script {\n          \n          \n            \n                                def curVer = mvnVersion()\n          \n          \n            \n                                sh(script: \"./scripts/jenkins/branch_creation.sh ${curVer}\")\n          \n          \n            \n                                def isMajor = sh(script: \"./scripts/jenkins/is_major.sh ${curVer}\", returnStatus: true)\n          \n          \n            \n                                if (isMajor == 0) {\n          \n          \n            \n                                  input message: \"This was a major version release. Please update the conf.yml in the docs repo before continuing\", ok \"Continue\"\n          \n          \n            \n                                }\n          \n          \n            \n                              }\n          \n          \n            \n                              gitPush()\n          \n          \n            \n                            }\n          \n          \n            \n                          }", "author": "v1v", "createdAt": "2020-04-29T10:20:49Z", "path": ".ci/release/Jenkinsfile", "diffHunk": "@@ -0,0 +1,229 @@\n+#!/usr/bin/env groovy\n+\n+@Library('apm@current') _\n+pipeline {\n+  agent { label 'linux && immutable' }\n+  environment {\n+    REPO = 'apm-agent-java'\n+    BASE_DIR = \"src/github.com/elastic/${env.REPO}\"\n+    NOTIFY_TO = credentials('notify-to')\n+    DOCKERHUB_SECRET = 'secret/apm-team/ci/elastic-observability-dockerhub'\n+    ELASTIC_DOCKER_SECRET = 'secret/apm-team/ci/docker-registry/prod'\n+    NEXUS_SECRET = 'secret/apm-team/ci/nexus'\n+    MAVEN_CONFIG = '-B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn -Dmaven.repo.local=.m2'\n+    HOME = \"${env.WORKSPACE}\"\n+    JAVA_HOME = \"${env.HUDSON_HOME}/.java/java10\"\n+    PATH = \"${env.JAVA_HOME}/bin:${env.PATH}\"\n+  }\n+  options {\n+    timeout(time: 3, unit: 'HOURS')\n+    buildDiscarder(logRotator(numToKeepStr: '20', artifactNumToKeepStr: '20', daysToKeepStr: '30'))\n+    timestamps()\n+    ansiColor('xterm')\n+    durabilityHint('PERFORMANCE_OPTIMIZED')\n+\n+  }\n+  parameters {\n+    string(name: 'branch_specifier', defaultValue: 'master')\n+  }\n+\n+  stages {\n+    stage('Initializing'){\n+      options { skipDefaultCheckout() }\n+      stages {\n+        stage('Checkout') {\n+          steps {\n+            gitCheckout(\n+                basedir: \"${BASE_DIR}\",\n+                branch: 'master',\n+                repo: 'git@github.com:elastic/apm-agent-java.git',\n+                credentialsId: 'f6c7695a-671e-4f4f-a331-acdce44ff9ba',\n+                shallow: false\n+            )\n+            stash(allowEmpty: true, name: 'source', useDefaultExcludes: false)\n+            dir(\"${BASE_DIR}\") {\n+              setupAPMGitEmail()\n+              script {\n+                env.TAG_BARE = sh(script: \"git tag | tail -1\", returnStdout: true)\n+                env.TAG_VER = sh(script: \"git tag | tail -1 | sed s/v//\", returnStdout: true)\n+                env.TAG_DOT_X = sh(script: 'git tag|tail -1|sed s/v//|cut -f1 -d \".\"|awk \\'{print $1\".x\"}\\'', returnStdout: true)\n+              }\n+            }\n+          }\n+        }\n+      }\n+    }\n+    stage('Release') {\n+      options { skipDefaultCheckout () }\n+      stages{\n+        stage('Check oss.sonatype.org') {\n+          steps {\n+            // If this fails, an exception should be thrown and execution will halt\n+            script {\n+              def r = sh(label: \"Check Maven status\", script: \"scripts/jenkins/check_maven.sh -u https://status.maven.org/api/v2/summary.json --component OSSRH\", returnStatus: true)\n+              if (r == 1) {\n+                error(\"Failing release build because Maven is the OSSRH component is not fully operational. See https://status.maven.org/ for more details.\")\n+              }\n+            }\n+          }\n+        }\n+        stage('Check master build status') {\n+          steps {\n+            script {\n+              // If this build is not green: https://apm-ci.elastic.co/job/apm-agent-java/job/apm-agent-java-mbp/job/master/\n+              if(!buildStatus(host: 'apm-ci.elastic.co', job: ['apm-agent-java', 'apm-agent-java-mbp', 'master'], return_boolean: true)) {\n+                input(message: \"WARNING! The master build is not passing. Do you wish to continue?\")\n+              }\n+            }\n+          }\n+        }\n+        stage('Require confirmation that CHANGELOG.asciidoc has been updated') {\n+          steps {\n+            input(message: \"\"\"\n+            Update CHANGELOG.asciidoc to reflect the new version release:\n+            Go over PRs or git log and add bug fixes and features.\n+            Move release notes from the Unreleased sub-heading to the correct [[release-notes-{major}.x]] sub-heading (Example PR for 1.13.0 release).\n+\n+            Click 'Proceed' to confirm that this step has been completed or Abort to stop the build in order to complete this step.\n+            \"\"\"\n+            )\n+          }\n+        }\n+        stage('Review project version') {\n+          steps {\n+            script {\n+              def ver = mvnVersion(showQualifiers: true)\n+              def should_continue = input(message: \"Current version is ${ver}\", parameters: [\n+                [\n+                  $class: 'ChoiceParameterDefinition',\n+                  name: \"Do you wish to update the version?\",\n+                  \"choices\": [\"Yes\", \"No\"],\n+                  description: \"Selecting 'Yes' will allow you to select the new version in the next step.\"\n+                ]\n+              ])\n+              if (should_continue == 'Yes'){\n+                def new_version = input(message: \"Please enter version to change to:\", parameters:\n+                  [\n+                    [\n+                      $class: 'StringParameterDefinition',\n+                      defaultValue: \"${ver}\",\n+                      description: 'We will run mvn versions:set -DnewVersion=<NEW_VERSION>', name: 'New Version'\n+                    ]\n+                  ]\n+                )\n+                sh(name: \"mavenVersionUpdate\", script: \"mvn versions:set -DnewVersion=${new_version}\")\n+              } else {\n+                echo \"Skipping version update\"\n+              }\n+            }\n+          }\n+        }\n+        stage('Nexus release') {\n+          steps {\n+            script {\n+              def spid = getVault('nexus')[\"staging-profile-id\"]\n+              dir(\"${BASE_DIR}\"){\n+                withEnvMask(vars: [[var: \"SPID\", password: spid]]){\n+                  def foundStagingId = nexusFindStagingId(stagingProfileId: \"${SPID}\", groupId: \"co.elastic.apm\")\n+                  nexusCloseStagingRepository(stagingProfileId: \"${SPID}\", stagingId: foundStagingId)\n+                  nexusReleaseStagingRepository(stagingProfileId: \"${SPID}\", stagingId: foundStagingId)\n+                }\n+              }\n+            }\n+          }\n+        }\n+        stage('Branch creation') {\n+          steps {\n+            dir(\"${BASE_DIR}\") {\n+              setupAPMGitEmail()\n+              script {\n+                env.BRANCH_NAME = \"tags/${env.TAG_BARE}\"\n+              }\n+              withGitRelease() {\n+                script {\n+                  def curVer = mvnVersion()\n+                  sh(script: \"./scripts/jenkins/branch_creation.sh ${curVer}\")\n+                  def isMajor = sh(script: \"./scripts/jenkins/is_major.sh ${curVer}\", returnStatus: true)\n+                  if (isMajor == 0) {\n+                    input message: \"This was a major version release. Please update the conf.yml in the docs repo before continuing\", ok \"Continue\"\n+                  }\n+                }\n+                gitPush()\n+              } ", "originalCommit": "a8504adaec5b4dad26a8b5f549be795831e96b3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIxNTUyNg==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r417215526", "bodyText": "Interesting. I had no problems in setting it directly when I was testing it locally but I agree that if we can use a context-based approach that it is much cleaner. Thanks for pointing this out. I wasn't familiar with withEnv.", "author": "cachedout", "createdAt": "2020-04-29T10:29:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIxMDg0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIxNzczOQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r417217739", "bodyText": "An issue with versions:set is that it creates a pom.xml.versionsBackup file for every pom.xml in the project.\nI think mvn --batch-mode release:update-versions -DdevelopmentVersion=${new_version} would be the better option.\nAlso, I don't see the new changes being committed in this step, is that correct?", "author": "felixbarny", "createdAt": "2020-04-29T10:33:55Z", "path": ".ci/release/Jenkinsfile", "diffHunk": "@@ -0,0 +1,229 @@\n+#!/usr/bin/env groovy\n+\n+@Library('apm@current') _\n+pipeline {\n+  agent { label 'linux && immutable' }\n+  environment {\n+    REPO = 'apm-agent-java'\n+    BASE_DIR = \"src/github.com/elastic/${env.REPO}\"\n+    NOTIFY_TO = credentials('notify-to')\n+    DOCKERHUB_SECRET = 'secret/apm-team/ci/elastic-observability-dockerhub'\n+    ELASTIC_DOCKER_SECRET = 'secret/apm-team/ci/docker-registry/prod'\n+    NEXUS_SECRET = 'secret/apm-team/ci/nexus'\n+    MAVEN_CONFIG = '-B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn -Dmaven.repo.local=.m2'\n+    HOME = \"${env.WORKSPACE}\"\n+    JAVA_HOME = \"${env.HUDSON_HOME}/.java/java10\"\n+    PATH = \"${env.JAVA_HOME}/bin:${env.PATH}\"\n+  }\n+  options {\n+    timeout(time: 3, unit: 'HOURS')\n+    buildDiscarder(logRotator(numToKeepStr: '20', artifactNumToKeepStr: '20', daysToKeepStr: '30'))\n+    timestamps()\n+    ansiColor('xterm')\n+    durabilityHint('PERFORMANCE_OPTIMIZED')\n+\n+  }\n+  parameters {\n+    string(name: 'branch_specifier', defaultValue: 'master')\n+  }\n+\n+  stages {\n+    stage('Initializing'){\n+      options { skipDefaultCheckout() }\n+      stages {\n+        stage('Checkout') {\n+          steps {\n+            gitCheckout(\n+                basedir: \"${BASE_DIR}\",\n+                branch: 'master',\n+                repo: 'git@github.com:elastic/apm-agent-java.git',\n+                credentialsId: 'f6c7695a-671e-4f4f-a331-acdce44ff9ba',\n+                shallow: false\n+            )\n+            stash(allowEmpty: true, name: 'source', useDefaultExcludes: false)\n+            dir(\"${BASE_DIR}\") {\n+              setupAPMGitEmail()\n+              script {\n+                env.TAG_BARE = sh(script: \"git tag | tail -1\", returnStdout: true)\n+                env.TAG_VER = sh(script: \"git tag | tail -1 | sed s/v//\", returnStdout: true)\n+                env.TAG_DOT_X = sh(script: 'git tag|tail -1|sed s/v//|cut -f1 -d \".\"|awk \\'{print $1\".x\"}\\'', returnStdout: true)\n+              }\n+            }\n+          }\n+        }\n+      }\n+    }\n+    stage('Release') {\n+      options { skipDefaultCheckout () }\n+      stages{\n+        stage('Check oss.sonatype.org') {\n+          steps {\n+            // If this fails, an exception should be thrown and execution will halt\n+            script {\n+              def r = sh(label: \"Check Maven status\", script: \"scripts/jenkins/check_maven.sh -u https://status.maven.org/api/v2/summary.json --component OSSRH\", returnStatus: true)\n+              if (r == 1) {\n+                error(\"Failing release build because Maven is the OSSRH component is not fully operational. See https://status.maven.org/ for more details.\")\n+              }\n+            }\n+          }\n+        }\n+        stage('Check master build status') {\n+          steps {\n+            script {\n+              // If this build is not green: https://apm-ci.elastic.co/job/apm-agent-java/job/apm-agent-java-mbp/job/master/\n+              if(!buildStatus(host: 'apm-ci.elastic.co', job: ['apm-agent-java', 'apm-agent-java-mbp', 'master'], return_boolean: true)) {\n+                input(message: \"WARNING! The master build is not passing. Do you wish to continue?\")\n+              }\n+            }\n+          }\n+        }\n+        stage('Require confirmation that CHANGELOG.asciidoc has been updated') {\n+          steps {\n+            input(message: \"\"\"\n+            Update CHANGELOG.asciidoc to reflect the new version release:\n+            Go over PRs or git log and add bug fixes and features.\n+            Move release notes from the Unreleased sub-heading to the correct [[release-notes-{major}.x]] sub-heading (Example PR for 1.13.0 release).\n+\n+            Click 'Proceed' to confirm that this step has been completed or Abort to stop the build in order to complete this step.\n+            \"\"\"\n+            )\n+          }\n+        }\n+        stage('Review project version') {\n+          steps {\n+            script {\n+              def ver = mvnVersion(showQualifiers: true)\n+              def should_continue = input(message: \"Current version is ${ver}\", parameters: [\n+                [\n+                  $class: 'ChoiceParameterDefinition',\n+                  name: \"Do you wish to update the version?\",\n+                  \"choices\": [\"Yes\", \"No\"],\n+                  description: \"Selecting 'Yes' will allow you to select the new version in the next step.\"\n+                ]\n+              ])\n+              if (should_continue == 'Yes'){\n+                def new_version = input(message: \"Please enter version to change to:\", parameters:\n+                  [\n+                    [\n+                      $class: 'StringParameterDefinition',\n+                      defaultValue: \"${ver}\",\n+                      description: 'We will run mvn versions:set -DnewVersion=<NEW_VERSION>', name: 'New Version'\n+                    ]\n+                  ]\n+                )\n+                sh(name: \"mavenVersionUpdate\", script: \"mvn versions:set -DnewVersion=${new_version}\")", "originalCommit": "be87cdc1696b633db6f7c306e4dc7468f89a83e4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIzOTUzMQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r417239531", "bodyText": "Thanks, @felixbarny. I have updated the mvn call per your suggestion. I have also added a git commit. Let me know if it looks good to you.", "author": "cachedout", "createdAt": "2020-04-29T11:18:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIxNzczOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIxOTkzOA==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r417219938", "bodyText": "Add a step that just prints a message like.\nStart the release job on the internal CI. Click proceed once the job has succeeded. Click cancel if the release has failed and manually undo the release.", "author": "felixbarny", "createdAt": "2020-04-29T10:38:19Z", "path": ".ci/release/Jenkinsfile", "diffHunk": "@@ -0,0 +1,226 @@\n+#!/usr/bin/env groovy\n+\n+@Library('apm@current') _\n+pipeline {\n+  agent { label 'linux && immutable' }\n+  environment {\n+    REPO = 'apm-agent-java'\n+    BASE_DIR = \"src/github.com/elastic/${env.REPO}\"\n+    NOTIFY_TO = credentials('notify-to')\n+    DOCKERHUB_SECRET = 'secret/apm-team/ci/elastic-observability-dockerhub'\n+    ELASTIC_DOCKER_SECRET = 'secret/apm-team/ci/docker-registry/prod'\n+    NEXUS_SECRET = 'secret/apm-team/ci/nexus'\n+    MAVEN_CONFIG = '-B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn -Dmaven.repo.local=.m2'\n+    HOME = \"${env.WORKSPACE}\"\n+    JAVA_HOME = \"${env.HUDSON_HOME}/.java/java10\"\n+    PATH = \"${env.JAVA_HOME}/bin:${env.PATH}\"\n+  }\n+  options {\n+    timeout(time: 3, unit: 'HOURS')\n+    buildDiscarder(logRotator(numToKeepStr: '20', artifactNumToKeepStr: '20', daysToKeepStr: '30'))\n+    timestamps()\n+    ansiColor('xterm')\n+    durabilityHint('PERFORMANCE_OPTIMIZED')\n+\n+  }\n+  parameters {\n+    string(name: 'branch_specifier', defaultValue: 'master')\n+  }\n+\n+  stages {\n+    stage('Initializing'){\n+      options { skipDefaultCheckout() }\n+      stages {\n+        stage('Checkout') {\n+          steps {\n+            gitCheckout(\n+                basedir: \"${BASE_DIR}\",\n+                branch: 'master',\n+                repo: 'git@github.com:elastic/apm-agent-java.git',\n+                credentialsId: 'f6c7695a-671e-4f4f-a331-acdce44ff9ba',\n+                shallow: false\n+            )\n+            dir(\"${BASE_DIR}\") {\n+              setupAPMGitEmail()\n+            }\n+            stash(allowEmpty: true, name: 'source', useDefaultExcludes: false)\n+            dir(\"${BASE_DIR}\") {\n+              script {\n+                env.TAG_BARE = sh(script: \"git tag | tail -1\", returnStdout: true)\n+                env.TAG_VER = sh(script: \"git tag | tail -1 | sed s/v//\", returnStdout: true)\n+                env.TAG_DOT_X = sh(script: 'git tag|tail -1|sed s/v//|cut -f1 -d \".\"|awk \\'{print $1\".x\"}\\'', returnStdout: true)\n+              }\n+            }\n+          }\n+        }\n+      }\n+    }\n+    stage('Release') {\n+      options { skipDefaultCheckout () }\n+      stages{\n+        stage('Check oss.sonatype.org') {\n+          steps {\n+            // If this fails, an exception should be thrown and execution will halt\n+            script {\n+              def r = sh(label: \"Check Maven status\", script: \"scripts/jenkins/check_maven.sh -u https://status.maven.org/api/v2/summary.json --component OSSRH\", returnStatus: true)\n+              if (r == 1) {\n+                error(\"Failing release build because Maven is the OSSRH component is not fully operational. See https://status.maven.org/ for more details.\")\n+              }\n+            }\n+          }\n+        }\n+        stage('Check master build status') {\n+          steps {\n+            script {\n+              // If this build is not green: https://apm-ci.elastic.co/job/apm-agent-java/job/apm-agent-java-mbp/job/master/\n+              if(!buildStatus(host: 'apm-ci.elastic.co', job: ['apm-agent-java', 'apm-agent-java-mbp', 'master'], return_boolean: true)) {\n+                input(message: \"WARNING! The master build is not passing. Do you wish to continue?\")\n+              }\n+            }\n+          }\n+        }\n+        stage('Require confirmation that CHANGELOG.asciidoc has been updated') {\n+          steps {\n+            input(message: \"\"\"\n+            Update CHANGELOG.asciidoc to reflect the new version release:\n+            Go over PRs or git log and add bug fixes and features.\n+            Move release notes from the Unreleased sub-heading to the correct [[release-notes-{major}.x]] sub-heading (Example PR for 1.13.0 release).\n+\n+            Click 'Proceed' to confirm that this step has been completed or Abort to stop the build in order to complete this step.\n+            \"\"\"\n+            )\n+          }\n+        }\n+        stage('Review project version') {\n+          steps {\n+            script {\n+              def ver = mvnVersion(showQualifiers: true)\n+              def should_continue = input(message: \"Current version is ${ver}\", parameters: [\n+                [\n+                  $class: 'ChoiceParameterDefinition',\n+                  name: \"Do you wish to update the version?\",\n+                  \"choices\": [\"Yes\", \"No\"],\n+                  description: \"Selecting 'Yes' will allow you to select the new version in the next step.\"\n+                ]\n+              ])\n+              if (should_continue == 'Yes'){\n+                def new_version = input(message: \"Please enter version to change to:\", parameters:\n+                  [\n+                    [\n+                      $class: 'StringParameterDefinition',\n+                      defaultValue: \"${ver}\",\n+                      description: 'We will run mvn versions:set -DnewVersion=<NEW_VERSION>', name: 'New Version'\n+                    ]\n+                  ]\n+                )\n+                sh(name: \"mavenVersionUpdate\", script: \"mvn versions:set -DnewVersion=${new_version}\")\n+              } else {\n+                echo \"Skipping version update\"\n+              }\n+            }\n+          }\n+        }", "originalCommit": "b8a2b5c6ac5e7c3f8ac152421386d7b23efe3c2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIzNDkwNA==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r417234904", "bodyText": "Good call! Step added.", "author": "cachedout", "createdAt": "2020-04-29T11:08:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzIxOTkzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI0MzA4NA==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r417243084", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                  description: 'We will run mvn versions:set -DnewVersion=<NEW_VERSION>', name: 'New Version'\n          \n          \n            \n                                  description: 'We will update the project version in all pom.xml files. Set this to your desired <release-version>-SNAPSHOT (for example 1.2.3-SNAPSHOT if you want to release version 1.2.3).', name: 'New Version'", "author": "felixbarny", "createdAt": "2020-04-29T11:25:21Z", "path": ".ci/release/Jenkinsfile", "diffHunk": "@@ -0,0 +1,234 @@\n+#!/usr/bin/env groovy\n+\n+@Library('apm@current') _\n+pipeline {\n+  agent { label 'linux && immutable' }\n+  environment {\n+    REPO = 'apm-agent-java'\n+    BASE_DIR = \"src/github.com/elastic/${env.REPO}\"\n+    NOTIFY_TO = credentials('notify-to')\n+    DOCKERHUB_SECRET = 'secret/apm-team/ci/elastic-observability-dockerhub'\n+    ELASTIC_DOCKER_SECRET = 'secret/apm-team/ci/docker-registry/prod'\n+    NEXUS_SECRET = 'secret/apm-team/ci/nexus'\n+    MAVEN_CONFIG = '-B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn -Dmaven.repo.local=.m2'\n+    HOME = \"${env.WORKSPACE}\"\n+    JAVA_HOME = \"${env.HUDSON_HOME}/.java/java10\"\n+    PATH = \"${env.JAVA_HOME}/bin:${env.PATH}\"\n+  }\n+  options {\n+    timeout(time: 3, unit: 'HOURS')\n+    buildDiscarder(logRotator(numToKeepStr: '20', artifactNumToKeepStr: '20', daysToKeepStr: '30'))\n+    timestamps()\n+    ansiColor('xterm')\n+    durabilityHint('PERFORMANCE_OPTIMIZED')\n+\n+  }\n+  parameters {\n+    string(name: 'branch_specifier', defaultValue: 'master')\n+  }\n+\n+  stages {\n+    stage('Initializing'){\n+      options { skipDefaultCheckout() }\n+      stages {\n+        stage('Checkout') {\n+          steps {\n+            gitCheckout(\n+                basedir: \"${BASE_DIR}\",\n+                branch: 'master',\n+                repo: 'git@github.com:elastic/apm-agent-java.git',\n+                credentialsId: 'f6c7695a-671e-4f4f-a331-acdce44ff9ba',\n+                shallow: false\n+            )\n+            dir(\"${BASE_DIR}\") {\n+              setupAPMGitEmail()\n+            }\n+            stash(allowEmpty: true, name: 'source', useDefaultExcludes: false)\n+            dir(\"${BASE_DIR}\") {\n+              script {\n+                env.TAG_BARE = sh(script: \"git tag | tail -1\", returnStdout: true)\n+                env.TAG_VER = sh(script: \"git tag | tail -1 | sed s/v//\", returnStdout: true)\n+                env.TAG_DOT_X = sh(script: 'git tag|tail -1|sed s/v//|cut -f1 -d \".\"|awk \\'{print $1\".x\"}\\'', returnStdout: true)\n+              }\n+            }\n+          }\n+        }\n+      }\n+    }\n+    stage('Release') {\n+      options { skipDefaultCheckout () }\n+      stages{\n+        stage('Check oss.sonatype.org') {\n+          steps {\n+            // If this fails, an exception should be thrown and execution will halt\n+            script {\n+              def r = sh(label: \"Check Maven status\", script: \"scripts/jenkins/check_maven.sh -u https://status.maven.org/api/v2/summary.json --component OSSRH\", returnStatus: true)\n+              if (r == 1) {\n+                error(\"Failing release build because Maven is the OSSRH component is not fully operational. See https://status.maven.org/ for more details.\")\n+              }\n+            }\n+          }\n+        }\n+        stage('Check master build status') {\n+          steps {\n+            script {\n+              // If this build is not green: https://apm-ci.elastic.co/job/apm-agent-java/job/apm-agent-java-mbp/job/master/\n+              if(!buildStatus(host: 'apm-ci.elastic.co', job: ['apm-agent-java', 'apm-agent-java-mbp', 'master'], return_boolean: true)) {\n+                input(message: \"WARNING! The master build is not passing. Do you wish to continue?\")\n+              }\n+            }\n+          }\n+        }\n+        stage('Require confirmation that CHANGELOG.asciidoc has been updated') {\n+          steps {\n+            input(message: \"\"\"\n+            Update CHANGELOG.asciidoc to reflect the new version release:\n+            Go over PRs or git log and add bug fixes and features.\n+            Move release notes from the Unreleased sub-heading to the correct [[release-notes-{major}.x]] sub-heading (Example PR for 1.13.0 release).\n+\n+            Click 'Proceed' to confirm that this step has been completed or Abort to stop the build in order to complete this step.\n+            \"\"\"\n+            )\n+          }\n+        }\n+        stage('Review project version') {\n+          steps {\n+            script {\n+              def ver = mvnVersion(showQualifiers: true)\n+              def should_continue = input(message: \"Current version is ${ver}\", parameters: [\n+                [\n+                  $class: 'ChoiceParameterDefinition',\n+                  name: \"Do you wish to update the version?\",\n+                  \"choices\": [\"Yes\", \"No\"],\n+                  description: \"Selecting 'Yes' will allow you to select the new version in the next step.\"\n+                ]\n+              ])\n+              if (should_continue == 'Yes'){\n+                def new_version = input(message: \"Please enter version to change to:\", parameters:\n+                  [\n+                    [\n+                      $class: 'StringParameterDefinition',\n+                      defaultValue: \"${ver}\",\n+                      description: 'We will run mvn versions:set -DnewVersion=<NEW_VERSION>', name: 'New Version'", "originalCommit": "da9a4d9c7ef5644357f4055ec12372c5b743fbca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI0NDI3OA==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r417244278", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                              name: \"Do you wish to update the version?\",\n          \n          \n            \n                              name: \"You are about to release version ${ver - '-SNAPSHOT'}. Do you wish to update the version?\",", "author": "felixbarny", "createdAt": "2020-04-29T11:27:49Z", "path": ".ci/release/Jenkinsfile", "diffHunk": "@@ -0,0 +1,234 @@\n+#!/usr/bin/env groovy\n+\n+@Library('apm@current') _\n+pipeline {\n+  agent { label 'linux && immutable' }\n+  environment {\n+    REPO = 'apm-agent-java'\n+    BASE_DIR = \"src/github.com/elastic/${env.REPO}\"\n+    NOTIFY_TO = credentials('notify-to')\n+    DOCKERHUB_SECRET = 'secret/apm-team/ci/elastic-observability-dockerhub'\n+    ELASTIC_DOCKER_SECRET = 'secret/apm-team/ci/docker-registry/prod'\n+    NEXUS_SECRET = 'secret/apm-team/ci/nexus'\n+    MAVEN_CONFIG = '-B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn -Dmaven.repo.local=.m2'\n+    HOME = \"${env.WORKSPACE}\"\n+    JAVA_HOME = \"${env.HUDSON_HOME}/.java/java10\"\n+    PATH = \"${env.JAVA_HOME}/bin:${env.PATH}\"\n+  }\n+  options {\n+    timeout(time: 3, unit: 'HOURS')\n+    buildDiscarder(logRotator(numToKeepStr: '20', artifactNumToKeepStr: '20', daysToKeepStr: '30'))\n+    timestamps()\n+    ansiColor('xterm')\n+    durabilityHint('PERFORMANCE_OPTIMIZED')\n+\n+  }\n+  parameters {\n+    string(name: 'branch_specifier', defaultValue: 'master')\n+  }\n+\n+  stages {\n+    stage('Initializing'){\n+      options { skipDefaultCheckout() }\n+      stages {\n+        stage('Checkout') {\n+          steps {\n+            gitCheckout(\n+                basedir: \"${BASE_DIR}\",\n+                branch: 'master',\n+                repo: 'git@github.com:elastic/apm-agent-java.git',\n+                credentialsId: 'f6c7695a-671e-4f4f-a331-acdce44ff9ba',\n+                shallow: false\n+            )\n+            dir(\"${BASE_DIR}\") {\n+              setupAPMGitEmail()\n+            }\n+            stash(allowEmpty: true, name: 'source', useDefaultExcludes: false)\n+            dir(\"${BASE_DIR}\") {\n+              script {\n+                env.TAG_BARE = sh(script: \"git tag | tail -1\", returnStdout: true)\n+                env.TAG_VER = sh(script: \"git tag | tail -1 | sed s/v//\", returnStdout: true)\n+                env.TAG_DOT_X = sh(script: 'git tag|tail -1|sed s/v//|cut -f1 -d \".\"|awk \\'{print $1\".x\"}\\'', returnStdout: true)\n+              }\n+            }\n+          }\n+        }\n+      }\n+    }\n+    stage('Release') {\n+      options { skipDefaultCheckout () }\n+      stages{\n+        stage('Check oss.sonatype.org') {\n+          steps {\n+            // If this fails, an exception should be thrown and execution will halt\n+            script {\n+              def r = sh(label: \"Check Maven status\", script: \"scripts/jenkins/check_maven.sh -u https://status.maven.org/api/v2/summary.json --component OSSRH\", returnStatus: true)\n+              if (r == 1) {\n+                error(\"Failing release build because Maven is the OSSRH component is not fully operational. See https://status.maven.org/ for more details.\")\n+              }\n+            }\n+          }\n+        }\n+        stage('Check master build status') {\n+          steps {\n+            script {\n+              // If this build is not green: https://apm-ci.elastic.co/job/apm-agent-java/job/apm-agent-java-mbp/job/master/\n+              if(!buildStatus(host: 'apm-ci.elastic.co', job: ['apm-agent-java', 'apm-agent-java-mbp', 'master'], return_boolean: true)) {\n+                input(message: \"WARNING! The master build is not passing. Do you wish to continue?\")\n+              }\n+            }\n+          }\n+        }\n+        stage('Require confirmation that CHANGELOG.asciidoc has been updated') {\n+          steps {\n+            input(message: \"\"\"\n+            Update CHANGELOG.asciidoc to reflect the new version release:\n+            Go over PRs or git log and add bug fixes and features.\n+            Move release notes from the Unreleased sub-heading to the correct [[release-notes-{major}.x]] sub-heading (Example PR for 1.13.0 release).\n+\n+            Click 'Proceed' to confirm that this step has been completed or Abort to stop the build in order to complete this step.\n+            \"\"\"\n+            )\n+          }\n+        }\n+        stage('Review project version') {\n+          steps {\n+            script {\n+              def ver = mvnVersion(showQualifiers: true)\n+              def should_continue = input(message: \"Current version is ${ver}\", parameters: [\n+                [\n+                  $class: 'ChoiceParameterDefinition',\n+                  name: \"Do you wish to update the version?\",", "originalCommit": "da9a4d9c7ef5644357f4055ec12372c5b743fbca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI0NTQ4MA==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r417245480", "bodyText": "don't forget to push :)", "author": "felixbarny", "createdAt": "2020-04-29T11:30:22Z", "path": ".ci/release/Jenkinsfile", "diffHunk": "@@ -0,0 +1,234 @@\n+#!/usr/bin/env groovy\n+\n+@Library('apm@current') _\n+pipeline {\n+  agent { label 'linux && immutable' }\n+  environment {\n+    REPO = 'apm-agent-java'\n+    BASE_DIR = \"src/github.com/elastic/${env.REPO}\"\n+    NOTIFY_TO = credentials('notify-to')\n+    DOCKERHUB_SECRET = 'secret/apm-team/ci/elastic-observability-dockerhub'\n+    ELASTIC_DOCKER_SECRET = 'secret/apm-team/ci/docker-registry/prod'\n+    NEXUS_SECRET = 'secret/apm-team/ci/nexus'\n+    MAVEN_CONFIG = '-B -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn -Dmaven.repo.local=.m2'\n+    HOME = \"${env.WORKSPACE}\"\n+    JAVA_HOME = \"${env.HUDSON_HOME}/.java/java10\"\n+    PATH = \"${env.JAVA_HOME}/bin:${env.PATH}\"\n+  }\n+  options {\n+    timeout(time: 3, unit: 'HOURS')\n+    buildDiscarder(logRotator(numToKeepStr: '20', artifactNumToKeepStr: '20', daysToKeepStr: '30'))\n+    timestamps()\n+    ansiColor('xterm')\n+    durabilityHint('PERFORMANCE_OPTIMIZED')\n+\n+  }\n+  parameters {\n+    string(name: 'branch_specifier', defaultValue: 'master')\n+  }\n+\n+  stages {\n+    stage('Initializing'){\n+      options { skipDefaultCheckout() }\n+      stages {\n+        stage('Checkout') {\n+          steps {\n+            gitCheckout(\n+                basedir: \"${BASE_DIR}\",\n+                branch: 'master',\n+                repo: 'git@github.com:elastic/apm-agent-java.git',\n+                credentialsId: 'f6c7695a-671e-4f4f-a331-acdce44ff9ba',\n+                shallow: false\n+            )\n+            dir(\"${BASE_DIR}\") {\n+              setupAPMGitEmail()\n+            }\n+            stash(allowEmpty: true, name: 'source', useDefaultExcludes: false)\n+            dir(\"${BASE_DIR}\") {\n+              script {\n+                env.TAG_BARE = sh(script: \"git tag | tail -1\", returnStdout: true)\n+                env.TAG_VER = sh(script: \"git tag | tail -1 | sed s/v//\", returnStdout: true)\n+                env.TAG_DOT_X = sh(script: 'git tag|tail -1|sed s/v//|cut -f1 -d \".\"|awk \\'{print $1\".x\"}\\'', returnStdout: true)\n+              }\n+            }\n+          }\n+        }\n+      }\n+    }\n+    stage('Release') {\n+      options { skipDefaultCheckout () }\n+      stages{\n+        stage('Check oss.sonatype.org') {\n+          steps {\n+            // If this fails, an exception should be thrown and execution will halt\n+            script {\n+              def r = sh(label: \"Check Maven status\", script: \"scripts/jenkins/check_maven.sh -u https://status.maven.org/api/v2/summary.json --component OSSRH\", returnStatus: true)\n+              if (r == 1) {\n+                error(\"Failing release build because Maven is the OSSRH component is not fully operational. See https://status.maven.org/ for more details.\")\n+              }\n+            }\n+          }\n+        }\n+        stage('Check master build status') {\n+          steps {\n+            script {\n+              // If this build is not green: https://apm-ci.elastic.co/job/apm-agent-java/job/apm-agent-java-mbp/job/master/\n+              if(!buildStatus(host: 'apm-ci.elastic.co', job: ['apm-agent-java', 'apm-agent-java-mbp', 'master'], return_boolean: true)) {\n+                input(message: \"WARNING! The master build is not passing. Do you wish to continue?\")\n+              }\n+            }\n+          }\n+        }\n+        stage('Require confirmation that CHANGELOG.asciidoc has been updated') {\n+          steps {\n+            input(message: \"\"\"\n+            Update CHANGELOG.asciidoc to reflect the new version release:\n+            Go over PRs or git log and add bug fixes and features.\n+            Move release notes from the Unreleased sub-heading to the correct [[release-notes-{major}.x]] sub-heading (Example PR for 1.13.0 release).\n+\n+            Click 'Proceed' to confirm that this step has been completed or Abort to stop the build in order to complete this step.\n+            \"\"\"\n+            )\n+          }\n+        }\n+        stage('Review project version') {\n+          steps {\n+            script {\n+              def ver = mvnVersion(showQualifiers: true)\n+              def should_continue = input(message: \"Current version is ${ver}\", parameters: [\n+                [\n+                  $class: 'ChoiceParameterDefinition',\n+                  name: \"Do you wish to update the version?\",\n+                  \"choices\": [\"Yes\", \"No\"],\n+                  description: \"Selecting 'Yes' will allow you to select the new version in the next step.\"\n+                ]\n+              ])\n+              if (should_continue == 'Yes'){\n+                def new_version = input(message: \"Please enter version to change to:\", parameters:\n+                  [\n+                    [\n+                      $class: 'StringParameterDefinition',\n+                      defaultValue: \"${ver}\",\n+                      description: 'We will run mvn versions:set -DnewVersion=<NEW_VERSION>', name: 'New Version'\n+                    ]\n+                  ]\n+                )\n+                sh(name: \"mavenVersionUpdate\", script: \"mvn --batch-mode release:update-versions -DdevelopmentVersion=${new_version}\")\n+                withGitRelease() {\n+                  sh(script: \"git commit -a -m 'Version bump'\")", "originalCommit": "da9a4d9c7ef5644357f4055ec12372c5b743fbca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI0Njk4Ng==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r417246986", "bodyText": "The reason I didn't push here is that it happens in the step shortly after. Do you think we should have a push here as well? I'm fine with either. :)", "author": "cachedout", "createdAt": "2020-04-29T11:33:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI0NTQ4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI1NDMwNQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r417254305", "bodyText": "If we don't push here, the internal CI doesn't see the changes", "author": "felixbarny", "createdAt": "2020-04-29T11:47:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI0NTQ4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI1ODcyNQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1058#discussion_r417258725", "bodyText": "Ah! You're right of course. I'll make this change.", "author": "cachedout", "createdAt": "2020-04-29T11:56:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI0NTQ4MA=="}], "type": "inlineReview"}, {"oid": "b560832c01c3a7d8022840fbb6ad19d4bcb2ebe0", "url": "https://github.com/elastic/apm-agent-java/commit/b560832c01c3a7d8022840fbb6ad19d4bcb2ebe0", "message": "Partially complete release pipeline", "committedDate": "2020-06-11T07:55:52Z", "type": "commit"}, {"oid": "f86271146d507a3a6e48742990ac3aebfad2dcc0", "url": "https://github.com/elastic/apm-agent-java/commit/f86271146d507a3a6e48742990ac3aebfad2dcc0", "message": "More release process", "committedDate": "2020-06-11T07:55:52Z", "type": "commit"}, {"oid": "77c1cf60f852bf24c1a6749a1fd627c8127d3f86", "url": "https://github.com/elastic/apm-agent-java/commit/77c1cf60f852bf24c1a6749a1fd627c8127d3f86", "message": "Move into discrete stages", "committedDate": "2020-06-11T07:55:52Z", "type": "commit"}, {"oid": "b019417f82f28dea0aea3cc67b494a13d8f26404", "url": "https://github.com/elastic/apm-agent-java/commit/b019417f82f28dea0aea3cc67b494a13d8f26404", "message": "Modify some comments", "committedDate": "2020-06-11T07:55:52Z", "type": "commit"}, {"oid": "eda1447f74384fb22cbf74a34fbe51b7176b67ff", "url": "https://github.com/elastic/apm-agent-java/commit/eda1447f74384fb22cbf74a34fbe51b7176b67ff", "message": "Refactor into separate release Jenkinsfile", "committedDate": "2020-06-11T07:55:53Z", "type": "commit"}, {"oid": "27f4a7213168a83e9daa8302be9815b83e923ee0", "url": "https://github.com/elastic/apm-agent-java/commit/27f4a7213168a83e9daa8302be9815b83e923ee0", "message": "Move release code out of main jenkinsfile", "committedDate": "2020-06-11T07:55:53Z", "type": "commit"}, {"oid": "c47cec6ad9aec570fc32b966fea583a2308e1fbf", "url": "https://github.com/elastic/apm-agent-java/commit/c47cec6ad9aec570fc32b966fea583a2308e1fbf", "message": "Set working directories correctly and move post-release steps into post-release pipeline", "committedDate": "2020-06-11T07:55:53Z", "type": "commit"}, {"oid": "105a5c9444005d2541df47262228d500017aafe0", "url": "https://github.com/elastic/apm-agent-java/commit/105a5c9444005d2541df47262228d500017aafe0", "message": "Sub in Vault variables", "committedDate": "2020-06-11T07:55:53Z", "type": "commit"}, {"oid": "19f3e8c2f59bb2245341bcba361b0d5ab2d7172d", "url": "https://github.com/elastic/apm-agent-java/commit/19f3e8c2f59bb2245341bcba361b0d5ab2d7172d", "message": "Add branch_specifier", "committedDate": "2020-06-11T07:55:53Z", "type": "commit"}, {"oid": "dd2c59df39fd2552a797be4d7ee706dbdd5acc2c", "url": "https://github.com/elastic/apm-agent-java/commit/dd2c59df39fd2552a797be4d7ee706dbdd5acc2c", "message": "Remove incorrect comment", "committedDate": "2020-06-11T07:55:53Z", "type": "commit"}, {"oid": "7ca7c91f7466963727739029eb02556486b8535c", "url": "https://github.com/elastic/apm-agent-java/commit/7ca7c91f7466963727739029eb02556486b8535c", "message": "Remove unused param", "committedDate": "2020-06-11T07:55:53Z", "type": "commit"}, {"oid": "c68c3acba5e89473e81648fa4c14cb8ecc49634d", "url": "https://github.com/elastic/apm-agent-java/commit/c68c3acba5e89473e81648fa4c14cb8ecc49634d", "message": "Consolodate MAVEN_CONFIG into a single fixed str", "committedDate": "2020-06-11T07:55:53Z", "type": "commit"}, {"oid": "8af41426c39e392b75237c931b23da3a31b58255", "url": "https://github.com/elastic/apm-agent-java/commit/8af41426c39e392b75237c931b23da3a31b58255", "message": "Remove Docker gate", "committedDate": "2020-06-11T07:55:53Z", "type": "commit"}, {"oid": "641bdd4b38c054ec23bea889e890e08d626a8bc9", "url": "https://github.com/elastic/apm-agent-java/commit/641bdd4b38c054ec23bea889e890e08d626a8bc9", "message": "Sleep before retry", "committedDate": "2020-06-11T07:55:53Z", "type": "commit"}, {"oid": "835af449bbd1fadde44fccbc39ed15b8d60a7207", "url": "https://github.com/elastic/apm-agent-java/commit/835af449bbd1fadde44fccbc39ed15b8d60a7207", "message": "Add name to GitHub release call", "committedDate": "2020-06-11T07:55:53Z", "type": "commit"}, {"oid": "232e900ebefc2fc5dc40a335f47f098eddc9e228", "url": "https://github.com/elastic/apm-agent-java/commit/232e900ebefc2fc5dc40a335f47f098eddc9e228", "message": "Move changelog URL detection to stand-alone sh", "committedDate": "2020-06-11T07:55:53Z", "type": "commit"}, {"oid": "c4c91db141b154a0c379840e3236590436c8834d", "url": "https://github.com/elastic/apm-agent-java/commit/c4c91db141b154a0c379840e3236590436c8834d", "message": "Restore opbeans to original Jenkinsfile", "committedDate": "2020-06-11T07:55:53Z", "type": "commit"}, {"oid": "645f15999a9201da6f6f010e417b963ce7efa493", "url": "https://github.com/elastic/apm-agent-java/commit/645f15999a9201da6f6f010e417b963ce7efa493", "message": "Move cloudfoundry down one stage", "committedDate": "2020-06-11T07:55:53Z", "type": "commit"}, {"oid": "3df503fcd05f929cfd29f5169e72c2cd951cdc37", "url": "https://github.com/elastic/apm-agent-java/commit/3df503fcd05f929cfd29f5169e72c2cd951cdc37", "message": "Dialogs for version updating", "committedDate": "2020-06-11T07:55:53Z", "type": "commit"}, {"oid": "657bf62cbc1f25c093950a86c843162f87273446", "url": "https://github.com/elastic/apm-agent-java/commit/657bf62cbc1f25c093950a86c843162f87273446", "message": "Warn and give option to abort if master build is failing", "committedDate": "2020-06-11T07:55:53Z", "type": "commit"}, {"oid": "6a413d8627ee0034ea0e88ff0a09c918e55336bd", "url": "https://github.com/elastic/apm-agent-java/commit/6a413d8627ee0034ea0e88ff0a09c918e55336bd", "message": "Move shell logic into dedicated scripts and use mvnversion", "committedDate": "2020-06-11T07:55:53Z", "type": "commit"}, {"oid": "d3280f035e350cc8f39231efc4fcee163f42c78b", "url": "https://github.com/elastic/apm-agent-java/commit/d3280f035e350cc8f39231efc4fcee163f42c78b", "message": "put in finalurl", "committedDate": "2020-06-11T07:55:53Z", "type": "commit"}, {"oid": "14be6f5b67dad21dc419e4db8d6faf6c988ae0db", "url": "https://github.com/elastic/apm-agent-java/commit/14be6f5b67dad21dc419e4db8d6faf6c988ae0db", "message": "Update .ci/release/Jenkinsfile\n\nCo-Authored-By: Victor Martinez <victormartinezrubio@gmail.com>", "committedDate": "2020-06-11T07:55:53Z", "type": "commit"}, {"oid": "4a4b3d514b0bc6f3862c1ed83f71ca2db458300d", "url": "https://github.com/elastic/apm-agent-java/commit/4a4b3d514b0bc6f3862c1ed83f71ca2db458300d", "message": "Update .ci/release/Jenkinsfile\n\nCo-Authored-By: Victor Martinez <victormartinezrubio@gmail.com>", "committedDate": "2020-06-11T07:55:53Z", "type": "commit"}, {"oid": "f64c8411e33c91154c55d0010de4de73727606b9", "url": "https://github.com/elastic/apm-agent-java/commit/f64c8411e33c91154c55d0010de4de73727606b9", "message": "Block GH release on release notes", "committedDate": "2020-06-11T07:55:53Z", "type": "commit"}, {"oid": "43cc93f3f5b4171565446614783aa92dc0b33b67", "url": "https://github.com/elastic/apm-agent-java/commit/43cc93f3f5b4171565446614783aa92dc0b33b67", "message": "Update .ci/release/Jenkinsfile\n\nCo-Authored-By: Victor Martinez <victormartinezrubio@gmail.com>", "committedDate": "2020-06-11T07:55:53Z", "type": "commit"}, {"oid": "b7a3c9a0c845fcd4a63dc6df3be90cab61b114bc", "url": "https://github.com/elastic/apm-agent-java/commit/b7a3c9a0c845fcd4a63dc6df3be90cab61b114bc", "message": "changelog confirmation", "committedDate": "2020-06-11T07:55:53Z", "type": "commit"}, {"oid": "0019f9e8e0d8eb46eaf4f8645ab9a0c4239fdcf5", "url": "https://github.com/elastic/apm-agent-java/commit/0019f9e8e0d8eb46eaf4f8645ab9a0c4239fdcf5", "message": "Move all env vars to top-level", "committedDate": "2020-06-11T07:55:53Z", "type": "commit"}, {"oid": "6d1142bf55d08315e8cc64d22ca9e73c5dc7439a", "url": "https://github.com/elastic/apm-agent-java/commit/6d1142bf55d08315e8cc64d22ca9e73c5dc7439a", "message": "Add better downtime detection for Maven", "committedDate": "2020-06-11T07:55:53Z", "type": "commit"}, {"oid": "f3d9508bcd71652ffb3ff87004926a8eff42278c", "url": "https://github.com/elastic/apm-agent-java/commit/f3d9508bcd71652ffb3ff87004926a8eff42278c", "message": "Typo", "committedDate": "2020-06-11T07:55:53Z", "type": "commit"}, {"oid": "990147044be2cba882685b99a40aefcf538c9ad5", "url": "https://github.com/elastic/apm-agent-java/commit/990147044be2cba882685b99a40aefcf538c9ad5", "message": "Application to check release notes status", "committedDate": "2020-06-11T07:55:53Z", "type": "commit"}, {"oid": "d22a2be90fe960be01ea8cd9629fa2ea2fa6b3d0", "url": "https://github.com/elastic/apm-agent-java/commit/d22a2be90fe960be01ea8cd9629fa2ea2fa6b3d0", "message": "Encapsulate cloudfoundry step in shell script", "committedDate": "2020-06-11T07:55:53Z", "type": "commit"}, {"oid": "f6e35193da4e5bd7d36c0d0122cf738489e56eb9", "url": "https://github.com/elastic/apm-agent-java/commit/f6e35193da4e5bd7d36c0d0122cf738489e56eb9", "message": "Move Maven URL generation logic to script", "committedDate": "2020-06-11T07:55:54Z", "type": "commit"}, {"oid": "bae8f142b180ad0b6e376cca5e56660f4c0a3926", "url": "https://github.com/elastic/apm-agent-java/commit/bae8f142b180ad0b6e376cca5e56660f4c0a3926", "message": "Remove automatic changelog generation per review comments", "committedDate": "2020-06-11T07:55:54Z", "type": "commit"}, {"oid": "d60a5d0ca8e4ed549bf61b34b0935d3d12667fd0", "url": "https://github.com/elastic/apm-agent-java/commit/d60a5d0ca8e4ed549bf61b34b0935d3d12667fd0", "message": "Move branch creation logic to script", "committedDate": "2020-06-11T07:55:54Z", "type": "commit"}, {"oid": "5a62a8693fe79f58191afb6e6c4c7a60c35cdf39", "url": "https://github.com/elastic/apm-agent-java/commit/5a62a8693fe79f58191afb6e6c4c7a60c35cdf39", "message": "Fix regex", "committedDate": "2020-06-11T07:55:54Z", "type": "commit"}, {"oid": "5bcd7b74596d47a07d9007b0c5c27e2fa1ebf55c", "url": "https://github.com/elastic/apm-agent-java/commit/5bcd7b74596d47a07d9007b0c5c27e2fa1ebf55c", "message": "Add docs check script", "committedDate": "2020-06-11T07:55:54Z", "type": "commit"}, {"oid": "001e1487314aebcb988d9cc3a5fcb8afee5446ab", "url": "https://github.com/elastic/apm-agent-java/commit/001e1487314aebcb988d9cc3a5fcb8afee5446ab", "message": "Simplify tag/version detection", "committedDate": "2020-06-11T07:55:54Z", "type": "commit"}, {"oid": "56d8308ac86e18034c66ed22860052a53b83dab8", "url": "https://github.com/elastic/apm-agent-java/commit/56d8308ac86e18034c66ed22860052a53b83dab8", "message": "Use doc check script before GH release", "committedDate": "2020-06-11T07:55:54Z", "type": "commit"}, {"oid": "42fbbbc2552b3c8681830f6c9b4e9effed511d54", "url": "https://github.com/elastic/apm-agent-java/commit/42fbbbc2552b3c8681830f6c9b4e9effed511d54", "message": "Newlines", "committedDate": "2020-06-11T07:55:54Z", "type": "commit"}, {"oid": "e15b5ceb3d4c704e034859ebef4d40cf4c448179", "url": "https://github.com/elastic/apm-agent-java/commit/e15b5ceb3d4c704e034859ebef4d40cf4c448179", "message": "Remove unnecessary dir calls", "committedDate": "2020-06-11T07:55:54Z", "type": "commit"}, {"oid": "7fff87aae4ac6da9363d019d0e7f874ed3d88b23", "url": "https://github.com/elastic/apm-agent-java/commit/7fff87aae4ac6da9363d019d0e7f874ed3d88b23", "message": "Fix repo typo", "committedDate": "2020-06-11T07:55:54Z", "type": "commit"}, {"oid": "9bf950fde72f82b4124281da4f5b11ffe202e3da", "url": "https://github.com/elastic/apm-agent-java/commit/9bf950fde72f82b4124281da4f5b11ffe202e3da", "message": "switch to gitcheckout", "committedDate": "2020-06-11T07:55:54Z", "type": "commit"}, {"oid": "b046f401b6b180d22f97085f1f77f58c54c5316b", "url": "https://github.com/elastic/apm-agent-java/commit/b046f401b6b180d22f97085f1f77f58c54c5316b", "message": "Remove comment scaffolding", "committedDate": "2020-06-11T07:55:54Z", "type": "commit"}, {"oid": "2dc05690d1eddb85c4b31d33e9250edb2a9b3b58", "url": "https://github.com/elastic/apm-agent-java/commit/2dc05690d1eddb85c4b31d33e9250edb2a9b3b58", "message": "More changes to git", "committedDate": "2020-06-11T07:55:54Z", "type": "commit"}, {"oid": "00e3645deab4a90df2f5b2e00076e98d71a44873", "url": "https://github.com/elastic/apm-agent-java/commit/00e3645deab4a90df2f5b2e00076e98d71a44873", "message": "Use gitrelease and gitpush in branch creation", "committedDate": "2020-06-11T07:55:54Z", "type": "commit"}, {"oid": "52719751583f3a94e309283496f58c110cf956bf", "url": "https://github.com/elastic/apm-agent-java/commit/52719751583f3a94e309283496f58c110cf956bf", "message": "Use git steps in CF", "committedDate": "2020-06-11T07:55:54Z", "type": "commit"}, {"oid": "9514d1642769caa936033ca70bcdf86bc3bbca44", "url": "https://github.com/elastic/apm-agent-java/commit/9514d1642769caa936033ca70bcdf86bc3bbca44", "message": "Fix typos", "committedDate": "2020-06-11T07:55:54Z", "type": "commit"}, {"oid": "bf106da57d7031b07f346681cd43752740eddadd", "url": "https://github.com/elastic/apm-agent-java/commit/bf106da57d7031b07f346681cd43752740eddadd", "message": "Fix detected lint error", "committedDate": "2020-06-11T07:55:54Z", "type": "commit"}, {"oid": "c41889ec43aee230f4d458dcc3c31bc2d677ba27", "url": "https://github.com/elastic/apm-agent-java/commit/c41889ec43aee230f4d458dcc3c31bc2d677ba27", "message": "Minor cleanup", "committedDate": "2020-06-11T07:55:54Z", "type": "commit"}, {"oid": "d882791dd6641c96728871982659b8762bffc9bb", "url": "https://github.com/elastic/apm-agent-java/commit/d882791dd6641c96728871982659b8762bffc9bb", "message": "Add confirmation step for internal CI", "committedDate": "2020-06-11T07:55:54Z", "type": "commit"}, {"oid": "06c0784668972a0cc43f930383be47bdf44dd28a", "url": "https://github.com/elastic/apm-agent-java/commit/06c0784668972a0cc43f930383be47bdf44dd28a", "message": "Update .ci/release/Jenkinsfile\n\nCo-Authored-By: Victor Martinez <victormartinezrubio@gmail.com>", "committedDate": "2020-06-11T07:55:54Z", "type": "commit"}, {"oid": "0aee5acd5f9e41de94dffb413af9352bc60ac6a9", "url": "https://github.com/elastic/apm-agent-java/commit/0aee5acd5f9e41de94dffb413af9352bc60ac6a9", "message": "Update .ci/release/Jenkinsfile\n\nCo-Authored-By: Victor Martinez <victormartinezrubio@gmail.com>", "committedDate": "2020-06-11T07:55:54Z", "type": "commit"}, {"oid": "e1d63151634320518c13f918ebfb6265fc3ea16d", "url": "https://github.com/elastic/apm-agent-java/commit/e1d63151634320518c13f918ebfb6265fc3ea16d", "message": "Update .ci/release/Jenkinsfile\n\nCo-Authored-By: Victor Martinez <victormartinezrubio@gmail.com>", "committedDate": "2020-06-11T07:55:54Z", "type": "commit"}, {"oid": "b70eb776880ad8ef3a3f75cad70dd7afddb4d573", "url": "https://github.com/elastic/apm-agent-java/commit/b70eb776880ad8ef3a3f75cad70dd7afddb4d573", "message": "Update .ci/release/Jenkinsfile\n\nCo-Authored-By: Victor Martinez <victormartinezrubio@gmail.com>", "committedDate": "2020-06-11T07:55:54Z", "type": "commit"}, {"oid": "cf30f7f22dc89427fcdd2b73a5525cd0ca788225", "url": "https://github.com/elastic/apm-agent-java/commit/cf30f7f22dc89427fcdd2b73a5525cd0ca788225", "message": "Change maven command per review comment", "committedDate": "2020-06-11T07:55:54Z", "type": "commit"}, {"oid": "c370546266ad209aa349e23154af2c9a074a7c8c", "url": "https://github.com/elastic/apm-agent-java/commit/c370546266ad209aa349e23154af2c9a074a7c8c", "message": "Add git commit after version bump", "committedDate": "2020-06-11T07:55:54Z", "type": "commit"}, {"oid": "23080b095acd0c2eb8c5b89075db7b8fde661776", "url": "https://github.com/elastic/apm-agent-java/commit/23080b095acd0c2eb8c5b89075db7b8fde661776", "message": "Update .ci/release/Jenkinsfile\n\nCo-Authored-By: Felix Barnsteiner <felixbarny@users.noreply.github.com>", "committedDate": "2020-06-11T07:55:54Z", "type": "commit"}, {"oid": "5e106024f53c2c543f6f5953ec80e9a3d4328807", "url": "https://github.com/elastic/apm-agent-java/commit/5e106024f53c2c543f6f5953ec80e9a3d4328807", "message": "Update .ci/release/Jenkinsfile\n\nCo-Authored-By: Felix Barnsteiner <felixbarny@users.noreply.github.com>", "committedDate": "2020-06-11T07:55:54Z", "type": "commit"}, {"oid": "b60b5d38740ecec0d2144798f7f4db076738274d", "url": "https://github.com/elastic/apm-agent-java/commit/b60b5d38740ecec0d2144798f7f4db076738274d", "message": "Add git push", "committedDate": "2020-06-11T07:55:54Z", "type": "commit"}, {"oid": "b60b5d38740ecec0d2144798f7f4db076738274d", "url": "https://github.com/elastic/apm-agent-java/commit/b60b5d38740ecec0d2144798f7f4db076738274d", "message": "Add git push", "committedDate": "2020-06-11T07:55:54Z", "type": "forcePushed"}]}