{"pr_number": 1322, "pr_title": "Silencing log4j StatusLogger during initialization", "pr_createdAt": "2020-08-02T17:34:58Z", "pr_url": "https://github.com/elastic/apm-agent-java/pull/1322", "timeline": [{"oid": "33b21b7dd5c23e7e685a59c7d608e465e41a9d1f", "url": "https://github.com/elastic/apm-agent-java/commit/33b21b7dd5c23e7e685a59c7d608e465e41a9d1f", "message": "Silencing log4j StatusLogger during initialization", "committedDate": "2020-08-02T17:32:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI0MDE0OA==", "url": "https://github.com/elastic/apm-agent-java/pull/1322#discussion_r464240148", "bodyText": "Reset the system properties to their previous state so that we don't affect the application loggers", "author": "felixbarny", "createdAt": "2020-08-03T07:30:39Z", "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/logging/LoggingConfiguration.java", "diffHunk": "@@ -195,7 +197,23 @@ public void assertValid(Boolean value) {\n         .buildWithDefault(LogFormat.PLAIN_TEXT);\n \n     public static void init(List<ConfigurationSource> sources, String ephemeralId) {\n-        Configurator.initialize(new Log4j2ConfigurationFactory(sources, ephemeralId).getConfiguration());\n+        // The initialization of log4j may produce errors if the traced application uses log4j settings (for\n+        // example - through file in the classpath or System properties) that configures specific properties for\n+        // loading classes by name. Since we shade our usage of log4j, such non-shaded classes may not (and should not)\n+        // be found on the classpath.\n+        // All handled Exceptions should not prevent us from using log4j further, as the system falls back to a default\n+        // which we expect anyway. We take a calculated risk of ignoring such errors only through initialization time,\n+        // assuming that errors that will make the logging system non-usable won't be handled.\n+        System.setProperty(\"log4j2.StatusLogger.level\", \"OFF\");\n+        System.setProperty(\"org.apache.logging.log4j.simplelog.StatusLogger.level\", \"OFF\");\n+        System.setProperty(\"Log4jDefaultStatusLevel\", \"OFF\");\n+        try {\n+            Configurator.initialize(new Log4j2ConfigurationFactory(sources, ephemeralId).getConfiguration());\n+        } catch (Throwable throwable) {\n+            System.err.println(\"Failure during initialization of agent's log4j system: \" + throwable.getMessage());\n+        } finally {\n+            StatusLogger.getLogger().setLevel(Level.ERROR);", "originalCommit": "33b21b7dd5c23e7e685a59c7d608e465e41a9d1f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQxODY2MQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1322#discussion_r464418661", "bodyText": "\ud83d\udc4d Good point, I only thought about ours \ud83d\ude44", "author": "eyalkoren", "createdAt": "2020-08-03T13:38:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI0MDE0OA=="}], "type": "inlineReview"}, {"oid": "ffc94431acf6fb97344697441ca7227017f2eac7", "url": "https://github.com/elastic/apm-agent-java/commit/ffc94431acf6fb97344697441ca7227017f2eac7", "message": "Apply review suggestion and add to CHANGELOG", "committedDate": "2020-08-03T13:58:39Z", "type": "commit"}, {"oid": "f410acdc58a3669a2ef314b15b306e3697241b4a", "url": "https://github.com/elastic/apm-agent-java/commit/f410acdc58a3669a2ef314b15b306e3697241b4a", "message": "Small fix to CHANGELOG", "committedDate": "2020-08-03T13:59:40Z", "type": "commit"}, {"oid": "1862381705f00f68c5e762e71aae74c1c0681c0b", "url": "https://github.com/elastic/apm-agent-java/commit/1862381705f00f68c5e762e71aae74c1c0681c0b", "message": "Fix access error", "committedDate": "2020-08-03T14:02:45Z", "type": "commit"}]}