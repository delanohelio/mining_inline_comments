{"pr_number": 999, "pr_title": "JMS fix: transfer header on non-sampled traces", "pr_createdAt": "2020-01-22T08:39:44Z", "pr_url": "https://github.com/elastic/apm-agent-java/pull/999", "timeline": [{"oid": "5aeeb7f3f26c10b4e48986afe303f5cb2c3e1d7b", "url": "https://github.com/elastic/apm-agent-java/commit/5aeeb7f3f26c10b4e48986afe303f5cb2c3e1d7b", "message": "Transfer JMS header on non-sampled traces", "committedDate": "2020-01-22T08:33:31Z", "type": "commit"}, {"oid": "684a7e3d41c684fd57bc2fae4faac33cd70ad7dd", "url": "https://github.com/elastic/apm-agent-java/commit/684a7e3d41c684fd57bc2fae4faac33cd70ad7dd", "message": "Remove public setSampled", "committedDate": "2020-01-22T12:11:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU5NjkzOQ==", "url": "https://github.com/elastic/apm-agent-java/pull/999#discussion_r369596939", "bodyText": "does it means that we will provide tracing headers even if the transaction itself is not being sampled ?\nIf so, does it means that we need to make sure that all instrumentations that might propagate context should still work even if sampling is not enabled ?", "author": "SylvainJuge", "createdAt": "2020-01-22T14:38:04Z", "path": "apm-agent-plugins/apm-jms-plugin/src/main/java/co/elastic/apm/agent/jms/JmsInstrumentationHelperImpl.java", "diffHunk": "@@ -97,8 +97,8 @@ public Span startJmsSendSpan(Destination destination, Message message) {\n             .activate();\n \n         try {\n+            message.setStringProperty(JMS_TRACE_PARENT_PROPERTY, span.getTraceContext().getOutgoingTraceParentHeader().toString());", "originalCommit": "684a7e3d41c684fd57bc2fae4faac33cd70ad7dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk2MDMxMQ==", "url": "https://github.com/elastic/apm-agent-java/pull/999#discussion_r369960311", "bodyText": "YES! If we don't, it is a bug as we are expected to (which is what this PR is about). This is what we use the flags part of the traceparent header- it is how we tell downstream transactions whether they should be sampled-in or out.", "author": "eyalkoren", "createdAt": "2020-01-23T07:17:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU5NjkzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTYxNjI5Nw==", "url": "https://github.com/elastic/apm-agent-java/pull/999#discussion_r369616297", "bodyText": "why do we need to reset the reporter here ?", "author": "SylvainJuge", "createdAt": "2020-01-22T15:09:30Z", "path": "apm-agent-plugins/apm-jms-plugin/src/test/java/co/elastic/apm/agent/jms/JmsInstrumentationIT.java", "diffHunk": "@@ -208,6 +219,25 @@ public void testQueueSendReceiveOnNonTracedThread() throws Exception {\n         doTestSendReceiveOnNonTracedThread(() -> brokerFacade.receive(queue, 10), queue, false);\n     }\n \n+    @SuppressWarnings(\"ConstantConditions\")\n+    @Test\n+    public void testQueueSendReceiveOnNonTracedThread_NonSampledTransaction() throws Exception {\n+        final Queue queue = createTestQueue();\n+\n+        // End current transaction and start a non-sampled one\n+        tracer.currentTransaction().deactivate().end();\n+        reporter.reset();", "originalCommit": "684a7e3d41c684fd57bc2fae4faac33cd70ad7dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk1ODY1OA==", "url": "https://github.com/elastic/apm-agent-java/pull/999#discussion_r369958658", "bodyText": "Because we end a transaction just above, which means it is reported, but soon after I use reporter.getFirstTransaction(), which I want to return my tested transaction and not this one", "author": "eyalkoren", "createdAt": "2020-01-23T07:09:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTYxNjI5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTYxODk3Mg==", "url": "https://github.com/elastic/apm-agent-java/pull/999#discussion_r369618972", "bodyText": "what about having the annotation directly on isSampled method in order to avoid duplicates of //noinspection ConstantConditions ?", "author": "SylvainJuge", "createdAt": "2020-01-22T15:13:57Z", "path": "apm-agent-plugins/apm-jms-plugin/src/test/java/co/elastic/apm/agent/jms/JmsInstrumentationIT.java", "diffHunk": "@@ -386,7 +416,10 @@ private void verifyQueueSendReceiveOnNonTracedThread(Queue queue)\n         Message incomingMessage = resultQ.poll(2, TimeUnit.SECONDS);\n         assertThat(incomingMessage).isNotNull();\n         verifyMessage(message, incomingMessage);\n-        verifySendReceiveOnNonTracedThread(queue.getQueueName(), outgoingMessage);\n+        //noinspection ConstantConditions\n+        if (tracer.currentTransaction().isSampled()) {", "originalCommit": "684a7e3d41c684fd57bc2fae4faac33cd70ad7dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk1OTMxNw==", "url": "https://github.com/elastic/apm-agent-java/pull/999#discussion_r369959317", "bodyText": "Not sure what you mean. This removes the warning about tracer.currentTransaction() potentially returning null", "author": "eyalkoren", "createdAt": "2020-01-23T07:12:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTYxODk3Mg=="}], "type": "inlineReview"}, {"oid": "9af31f574b0942aaee4f7318df6bb2fae049211f", "url": "https://github.com/elastic/apm-agent-java/commit/9af31f574b0942aaee4f7318df6bb2fae049211f", "message": "Merge remote-tracking branch 'upstream/master' into jms-context-transfer", "committedDate": "2020-01-23T07:21:00Z", "type": "commit"}, {"oid": "be0a4ff124ee89d9b430d7322d303bdafce2a04c", "url": "https://github.com/elastic/apm-agent-java/commit/be0a4ff124ee89d9b430d7322d303bdafce2a04c", "message": "Add to CHANGELOG", "committedDate": "2020-01-23T07:23:47Z", "type": "commit"}]}