{"pr_number": 3479, "pr_title": "Feature/3238/lambda error messages", "pr_createdAt": "2020-05-19T17:44:07Z", "pr_url": "https://github.com/dockstore/dockstore/pull/3479", "timeline": [{"oid": "23e28394b61f887663b4372d1e029607e4ff812a", "url": "https://github.com/dockstore/dockstore/commit/23e28394b61f887663b4372d1e029607e4ff812a", "message": "basic class for storing lambda events", "committedDate": "2020-05-13T20:44:17Z", "type": "commit"}, {"oid": "b72a474b2b84b2984f31d27fa58e50dc33e66857", "url": "https://github.com/dockstore/dockstore/commit/b72a474b2b84b2984f31d27fa58e50dc33e66857", "message": "store lambda events; also some dao functions", "committedDate": "2020-05-14T15:20:46Z", "type": "commit"}, {"oid": "10efda9007c33a41eb7ea4c6f9dac5d07801d133", "url": "https://github.com/dockstore/dockstore/commit/10efda9007c33a41eb7ea4c6f9dac5d07801d133", "message": "delete event for gh apps now includes username", "committedDate": "2020-05-14T15:49:29Z", "type": "commit"}, {"oid": "3aacbf891ebda37c15760d8a7b4999da190b30d7", "url": "https://github.com/dockstore/dockstore/commit/3aacbf891ebda37c15760d8a7b4999da190b30d7", "message": "adds event for installation", "committedDate": "2020-05-14T18:08:33Z", "type": "commit"}, {"oid": "a584afc11b8dd1a4b9d603af7ff7e35428b9b59c", "url": "https://github.com/dockstore/dockstore/commit/a584afc11b8dd1a4b9d603af7ff7e35428b9b59c", "message": "endpoint for grabbing all github events for a user", "committedDate": "2020-05-14T19:30:48Z", "type": "commit"}, {"oid": "df236e9d0cb1ec5766b63683379e51de5639b9c3", "url": "https://github.com/dockstore/dockstore/commit/df236e9d0cb1ec5766b63683379e51de5639b9c3", "message": "forgot to add new dao file", "committedDate": "2020-05-14T19:42:11Z", "type": "commit"}, {"oid": "a9dfc1b98202b43b5fcc11ccb44a4699ac5096bb", "url": "https://github.com/dockstore/dockstore/commit/a9dfc1b98202b43b5fcc11ccb44a4699ac5096bb", "message": "change some endpoints to use openapi", "committedDate": "2020-05-14T19:57:26Z", "type": "commit"}, {"oid": "da5b34a1c5198645d9e42611080c5db26d5f9123", "url": "https://github.com/dockstore/dockstore/commit/da5b34a1c5198645d9e42611080c5db26d5f9123", "message": "update travis postgres service", "committedDate": "2020-05-19T13:57:32Z", "type": "commit"}, {"oid": "88c5d7ac8800789858e483e9fffc3190b62ee17a", "url": "https://github.com/dockstore/dockstore/commit/88c5d7ac8800789858e483e9fffc3190b62ee17a", "message": "tests for lambda error messages", "committedDate": "2020-05-19T16:32:02Z", "type": "commit"}, {"oid": "00b0fa6fe01c4a1a28c2ec57d178d4bb5a101e48", "url": "https://github.com/dockstore/dockstore/commit/00b0fa6fe01c4a1a28c2ec57d178d4bb5a101e48", "message": "attempt to fix travis issue", "committedDate": "2020-05-19T17:58:56Z", "type": "commit"}, {"oid": "1839ef68138f4ead2a936a115a61137656681303", "url": "https://github.com/dockstore/dockstore/commit/1839ef68138f4ead2a936a115a61137656681303", "message": "Merge branch 'develop' into feature/3238/lambda-error-messages", "committedDate": "2020-05-19T20:48:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU5MTkyOQ==", "url": "https://github.com/dockstore/dockstore/pull/3479#discussion_r427591929", "bodyText": "FYI, defaults to eager", "author": "denis-yuen", "createdAt": "2020-05-19T20:51:05Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/core/LambdaEvent.java", "diffHunk": "@@ -0,0 +1,175 @@\n+package io.dockstore.webservice.core;\n+\n+import java.sql.Timestamp;\n+\n+import javax.persistence.Column;\n+import javax.persistence.Entity;\n+import javax.persistence.EnumType;\n+import javax.persistence.Enumerated;\n+import javax.persistence.GeneratedValue;\n+import javax.persistence.GenerationType;\n+import javax.persistence.Id;\n+import javax.persistence.JoinColumn;\n+import javax.persistence.ManyToOne;\n+import javax.persistence.NamedQueries;\n+import javax.persistence.NamedQuery;\n+import javax.persistence.Table;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import io.swagger.annotations.ApiModel;\n+import io.swagger.annotations.ApiModelProperty;\n+import org.hibernate.annotations.CreationTimestamp;\n+import org.hibernate.annotations.UpdateTimestamp;\n+\n+/**\n+ * This describes events triggered by GitHub webhooks\n+ */\n+@ApiModel(\"LambdaEvent\")\n+@Entity\n+@Table(name = \"LambdaEvent\")\n+@NamedQueries({\n+        @NamedQuery(name = \"io.dockstore.webservice.core.LambdaEvent.findByRepository\", query = \"SELECT lambdaEvent FROM LambdaEvent lambdaEvent WHERE lambdaEvent.repository = :repository\"),\n+        @NamedQuery(name = \"io.dockstore.webservice.core.LambdaEvent.findByUsername\", query = \"SELECT lambdaEvent FROM LambdaEvent lambdaEvent WHERE lambdaEvent.username = :username\"),\n+        @NamedQuery(name = \"io.dockstore.webservice.core.LambdaEvent.findByUser\", query = \"SELECT lambdaEvent FROM LambdaEvent lambdaEvent WHERE lambdaEvent.user = :user\"),\n+})\n+@SuppressWarnings(\"checkstyle:magicnumber\")\n+public class LambdaEvent {\n+    @Id\n+    @GeneratedValue(strategy = GenerationType.IDENTITY)\n+    @ApiModelProperty(value = \"Unique ID of the event.\", position = 0)\n+    private long id;\n+\n+    @Column(columnDefinition = \"TEXT\")\n+    @ApiModelProperty(value = \"The repository from the event.\", required = true, position = 1)\n+    private String repository;\n+\n+    @Column(columnDefinition = \"TEXT\")\n+    @ApiModelProperty(value = \"The name of the user on GitHub that triggers the event.\", required = true, position = 2)\n+    private String username;\n+\n+    @Column(columnDefinition = \"TEXT\")\n+    @ApiModelProperty(value = \"The git reference from the event.\", required = true, position = 3)\n+    private String reference;\n+\n+    @Column(nullable = false, columnDefinition = \"boolean default true\")\n+    @ApiModelProperty(value = \"Whether or not the event was successful.\", position = 4)\n+    private boolean success = true;\n+\n+    @Column(columnDefinition = \"TEXT\")\n+    @ApiModelProperty(value = \"The message associated with the event.\", position = 5)\n+    private String message;\n+\n+    @Column(nullable = false, columnDefinition = \"boolean default false\")\n+    @ApiModelProperty(value = \"Whether or not the user has dismissed the event.\", position = 6)\n+    private boolean dismissed = false;\n+\n+    @Column\n+    @Enumerated(EnumType.STRING)\n+    @ApiModelProperty(value = \"The type of event.\", required = true, position = 7)\n+    private LambdaEventType type;\n+\n+    @ManyToOne", "originalCommit": "1839ef68138f4ead2a936a115a61137656681303", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU5MjU5OA==", "url": "https://github.com/dockstore/dockstore/pull/3479#discussion_r427592598", "bodyText": "A little wary of this in production code, why is this necessary and has this pattern been used before?", "author": "denis-yuen", "createdAt": "2020-05-19T20:52:22Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java", "diffHunk": "@@ -267,14 +271,21 @@ private WorkflowVersion updateDBVersionSourceFilesWithRemoteVersionSourceFiles(W\n      * - Delete version for corresponding service and workflow\n      * @param repository Repository path (ex. dockstore/dockstore-ui2)\n      * @param gitReference Git reference from GitHub (ex. refs/tags/1.0)\n+     * @param username Git user who triggered the event\n+     * @param installationId GitHub App installation ID\n      * @return List of updated workflows\n      */\n-    protected List<Workflow> githubWebhookDelete(String repository, String gitReference) {\n+    protected List<Workflow> githubWebhookDelete(String repository, String gitReference, String username, String installationId) {\n         // Retrieve name from gitReference\n         Optional<String> gitReferenceName = GitHelper.parseGitHubReference(gitReference);\n         if (gitReferenceName.isEmpty()) {\n             String msg = \"Reference \" + gitReference + \" is not of the valid form\";\n             LOG.error(msg);\n+            LambdaEvent lambdaEvent = createBasicEvent(repository, gitReference, username, installationId, LambdaEvent.LambdaEventType.DELETE);\n+            lambdaEvent.setMessage(msg);\n+            lambdaEvent.setSuccess(false);\n+            lambdaEventDAO.create(lambdaEvent);\n+            sessionFactory.getCurrentSession().getTransaction().commit();", "originalCommit": "1839ef68138f4ead2a936a115a61137656681303", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYwMDA2MA==", "url": "https://github.com/dockstore/dockstore/pull/3479#discussion_r427600060", "bodyText": "Since an error is being thrown, the transaction is rolled back, so the message would never be written. We have used this once before for Zenodo I believe.", "author": "agduncan94", "createdAt": "2020-05-19T21:06:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU5MjU5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA1MTM4OQ==", "url": "https://github.com/dockstore/dockstore/pull/3479#discussion_r428051389", "bodyText": "What if I clear the session before updating (sessionFactory.getCurrentSession().clear()). From what I understand this would mean that no unexpected things would be saved, only the lambda event.", "author": "agduncan94", "createdAt": "2020-05-20T14:19:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU5MjU5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA1MjIzNw==", "url": "https://github.com/dockstore/dockstore/pull/3479#discussion_r428052237", "bodyText": "The docs say that a clear\n\n... cancel all pending saves, updates and deletions.", "author": "agduncan94", "createdAt": "2020-05-20T14:20:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU5MjU5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMxNjc2MQ==", "url": "https://github.com/dockstore/dockstore/pull/3479#discussion_r428316761", "bodyText": "That does sound a bit safer", "author": "denis-yuen", "createdAt": "2020-05-20T21:26:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU5MjU5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU5MjgzOA==", "url": "https://github.com/dockstore/dockstore/pull/3479#discussion_r427592838", "bodyText": "Ditto", "author": "denis-yuen", "createdAt": "2020-05-19T20:52:44Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java", "diffHunk": "@@ -317,19 +332,48 @@ private WorkflowVersion updateDBVersionSourceFilesWithRemoteVersionSourceFiles(W\n                     gitHubSourceCodeRepo, user, dockstoreYml));\n             workflows.addAll(createBioWorkflowsAndVersionsFromDockstoreYml(dockstoreYaml12.getWorkflows(), repository, gitReference,\n                     gitHubSourceCodeRepo, user, dockstoreYml));\n+            lambdaEventDAO.create(lambdaEvent);\n             return workflows;\n         } catch (CustomWebApplicationException | ClassCastException | DockstoreYamlHelper.DockstoreYamlException ex) {\n-            // TODO: Eventually want to record something to the database so that the user can know the type of lambda errors run into\n             String msg = \"User \" + username + \": Error handling push event for repository \" + repository + \" and reference \" + gitReference + \"\\n\" + ex.getMessage();\n             LOG.info(msg, ex);\n+            lambdaEvent.setSuccess(false);\n+            lambdaEvent.setMessage(ex.getMessage());\n+            lambdaEventDAO.create(lambdaEvent);\n+            sessionFactory.getCurrentSession().getTransaction().commit();\n             throw new CustomWebApplicationException(msg, LAMBDA_FAILURE);\n-        } catch (NullPointerException ex) {\n+        } catch (Exception ex) {\n             String msg = \"User \" + username + \": Unhandled error while handling push event for repository \" + repository + \" and reference \" + gitReference + \"\\n\" + ex.getMessage();\n             LOG.error(msg, ex);\n+            lambdaEvent.setSuccess(false);\n+            lambdaEvent.setMessage(ex.getMessage());\n+            lambdaEventDAO.create(lambdaEvent);\n+            sessionFactory.getCurrentSession().getTransaction().commit();", "originalCommit": "1839ef68138f4ead2a936a115a61137656681303", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU5NDMxMg==", "url": "https://github.com/dockstore/dockstore/pull/3479#discussion_r427594312", "bodyText": "Might have lost context, why is there a new endpoint for this as opposed to the existing  release endpoint.\nIs this only for reporting lambda installs?", "author": "denis-yuen", "createdAt": "2020-05-19T20:55:23Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java", "diffHunk": "@@ -1935,14 +1936,41 @@ public void deleteWorkflow(@ApiParam(hidden = true) @Parameter(hidden = true, na\n     @ApiOperation(value = \"Handle a release of a repository on GitHub. Will create a workflow/service and version when necessary.\", authorizations = {\n         @Authorization(value = JWT_SECURITY_DEFINITION_NAME) }, response = Workflow.class, responseContainer = \"List\")\n     public List<Workflow> handleGitHubRelease(@ApiParam(hidden = true) @Parameter(hidden = true, name = \"user\", in = ParameterIn.HEADER) @Auth User user,\n-        @ApiParam(value = \"Repository path (ex. dockstore/dockstore-ui2)\", required = true) @FormParam(\"repository\") String repository,\n-        @ApiParam(value = \"Username of user on GitHub who triggered action\", required = true) @FormParam(\"username\") String username,\n-        @ApiParam(value = \"Full git reference for a GitHub branch/tag. Ex. refs/heads/master or refs/tags/v1.0\", required = true) @FormParam(\"gitReference\") String gitReference,\n-        @ApiParam(value = \"GitHub installation ID\", required = true) @FormParam(\"installationId\") String installationId) {\n+        @Parameter(name = \"Repository path (ex. dockstore/dockstore-ui2)\", required = true) @FormParam(\"repository\") String repository,\n+        @Parameter(name = \"Username of user on GitHub who triggered action\", required = true) @FormParam(\"username\") String username,\n+        @Parameter(name = \"Full git reference for a GitHub branch/tag. Ex. refs/heads/master or refs/tags/v1.0\", required = true) @FormParam(\"gitReference\") String gitReference,\n+        @Parameter(name = \"GitHub installation ID\", required = true) @FormParam(\"installationId\") String installationId) {\n         LOG.info(\"Branch/tag \" + gitReference + \" pushed to \" + repository + \"(\" + username + \")\");\n         return githubWebhookRelease(repository, username, gitReference, installationId);\n     }\n \n+    @POST\n+    @Path(\"/github/install\")\n+    @Timed\n+    @Consumes(MediaType.APPLICATION_FORM_URLENCODED)\n+    @UnitOfWork\n+    @RolesAllowed({ \"curator\", \"admin\" })\n+    @Operation(description = \"Handle the installation of our GitHub app onto a repository or organization.\", security = @SecurityRequirement(name = OPENAPI_JWT_SECURITY_DEFINITION_NAME), responses = @ApiResponse(responseCode = \"418\", description = \"This code tells AWS Lambda not to retry.\"))", "originalCommit": "1839ef68138f4ead2a936a115a61137656681303", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYwMDY4Mg==", "url": "https://github.com/dockstore/dockstore/pull/3479#discussion_r427600682", "bodyText": "Ya, this is purely for reporting lambda installs. Users could technically see on GitHub which repos they have the app installed on, but thought they might want to know dockstore knows too.", "author": "agduncan94", "createdAt": "2020-05-19T21:07:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU5NDMxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU5NDcyMw==", "url": "https://github.com/dockstore/dockstore/pull/3479#discussion_r427594723", "bodyText": "I realise this is just a draft, but this will quickly need pagination or something to cut things down. Plus sorting", "author": "denis-yuen", "createdAt": "2020-05-19T20:56:08Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/UserResource.java", "diffHunk": "@@ -762,6 +766,17 @@ public Limits setUserLimits(@ApiParam(hidden = true) @Auth User authUser,\n         return getStrippedWorkflowsAndServices(userDAO.findById(user.getId()));\n     }\n \n+    @GET\n+    @Timed\n+    @UnitOfWork(readOnly = true)\n+    @Path(\"/github/events\")\n+    @Operation(operationId = \"getUserGitHubEvents\", description = \"Get all of the GitHub Events for the logged in user.\", security = @SecurityRequirement(name = \"bearer\"))\n+    @ApiOperation(value = \"See OpenApi for details\")\n+    public List<LambdaEvent> getUserGitHubEvents(@ApiParam(hidden = true) @Parameter(hidden = true, name = \"user\", in = ParameterIn.HEADER) @Auth User authUser) {\n+        final User user = userDAO.findById(authUser.getId());\n+        return lambdaEventDAO.findByUser(user);", "originalCommit": "1839ef68138f4ead2a936a115a61137656681303", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA5NjEzOA==", "url": "https://github.com/dockstore/dockstore/pull/3479#discussion_r428096138", "bodyText": "Do you know of a good endpoint that has pagination?", "author": "agduncan94", "createdAt": "2020-05-20T15:16:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU5NDcyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMxODU5MQ==", "url": "https://github.com/dockstore/dockstore/pull/3479#discussion_r428318591", "bodyText": "Offset and limit control pagination in DB here\nhttps://github.com/dockstore/dockstore/blob/develop/dockstore-webservice/src/main/java/io/dockstore/webservice/jdbi/EntryDAO.java#L176\nLooks like its used by the old tools and workflows pages that paginate", "author": "denis-yuen", "createdAt": "2020-05-20T21:30:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU5NDcyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI4MTYxNA==", "url": "https://github.com/dockstore/dockstore/pull/3479#discussion_r428281614", "bodyText": "If we surface this event to multiple users, then this would need to be an array/list of userids.", "author": "coverbeck", "createdAt": "2020-05-20T20:15:02Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/core/LambdaEvent.java", "diffHunk": "@@ -0,0 +1,175 @@\n+package io.dockstore.webservice.core;\n+\n+import java.sql.Timestamp;\n+\n+import javax.persistence.Column;\n+import javax.persistence.Entity;\n+import javax.persistence.EnumType;\n+import javax.persistence.Enumerated;\n+import javax.persistence.GeneratedValue;\n+import javax.persistence.GenerationType;\n+import javax.persistence.Id;\n+import javax.persistence.JoinColumn;\n+import javax.persistence.ManyToOne;\n+import javax.persistence.NamedQueries;\n+import javax.persistence.NamedQuery;\n+import javax.persistence.Table;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import io.swagger.annotations.ApiModel;\n+import io.swagger.annotations.ApiModelProperty;\n+import org.hibernate.annotations.CreationTimestamp;\n+import org.hibernate.annotations.UpdateTimestamp;\n+\n+/**\n+ * This describes events triggered by GitHub webhooks\n+ */\n+@ApiModel(\"LambdaEvent\")\n+@Entity\n+@Table(name = \"LambdaEvent\")\n+@NamedQueries({\n+        @NamedQuery(name = \"io.dockstore.webservice.core.LambdaEvent.findByRepository\", query = \"SELECT lambdaEvent FROM LambdaEvent lambdaEvent WHERE lambdaEvent.repository = :repository\"),\n+        @NamedQuery(name = \"io.dockstore.webservice.core.LambdaEvent.findByUsername\", query = \"SELECT lambdaEvent FROM LambdaEvent lambdaEvent WHERE lambdaEvent.username = :username\"),\n+        @NamedQuery(name = \"io.dockstore.webservice.core.LambdaEvent.findByUser\", query = \"SELECT lambdaEvent FROM LambdaEvent lambdaEvent WHERE lambdaEvent.user = :user\"),\n+})\n+@SuppressWarnings(\"checkstyle:magicnumber\")\n+public class LambdaEvent {\n+    @Id\n+    @GeneratedValue(strategy = GenerationType.IDENTITY)\n+    @ApiModelProperty(value = \"Unique ID of the event.\", position = 0)\n+    private long id;\n+\n+    @Column(columnDefinition = \"TEXT\")\n+    @ApiModelProperty(value = \"The repository from the event.\", required = true, position = 1)\n+    private String repository;\n+\n+    @Column(columnDefinition = \"TEXT\")\n+    @ApiModelProperty(value = \"The name of the user on GitHub that triggers the event.\", required = true, position = 2)\n+    private String username;\n+\n+    @Column(columnDefinition = \"TEXT\")\n+    @ApiModelProperty(value = \"The git reference from the event.\", required = true, position = 3)\n+    private String reference;\n+\n+    @Column(nullable = false, columnDefinition = \"boolean default true\")\n+    @ApiModelProperty(value = \"Whether or not the event was successful.\", position = 4)\n+    private boolean success = true;\n+\n+    @Column(columnDefinition = \"TEXT\")\n+    @ApiModelProperty(value = \"The message associated with the event.\", position = 5)\n+    private String message;\n+\n+    @Column(nullable = false, columnDefinition = \"boolean default false\")\n+    @ApiModelProperty(value = \"Whether or not the user has dismissed the event.\", position = 6)", "originalCommit": "1839ef68138f4ead2a936a115a61137656681303", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg5NzQxMA==", "url": "https://github.com/dockstore/dockstore/pull/3479#discussion_r428897410", "bodyText": "Based on a discussion with Denis, this will only track the user who triggered the event. For other users to be able to see the events, we will use an endpoint which if a user has access, will show all events for a GitHub organisation. This way we don't need to keep track of all the users.", "author": "agduncan94", "createdAt": "2020-05-21T20:31:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI4MTYxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM2Mzk2Mg==", "url": "https://github.com/dockstore/dockstore/pull/3479#discussion_r431363962", "bodyText": "When other users see events, will they be able to dismiss them? Will you record it? Or are you saying the other endpoint will handle that?", "author": "coverbeck", "createdAt": "2020-05-27T18:43:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI4MTYxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM2Njk3NA==", "url": "https://github.com/dockstore/dockstore/pull/3479#discussion_r431366974", "bodyText": "Following on, if all users in the org can see the event, it seems that we won't be able to track it with one boolean (I'm ok with not tracking this)", "author": "denis-yuen", "createdAt": "2020-05-27T18:49:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI4MTYxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjIwMDgxNg==", "url": "https://github.com/dockstore/dockstore/pull/3479#discussion_r432200816", "bodyText": "Depending on how intrusive the UI will be, I think its fair not to dismiss the event or track which users have seen it. The error should disappear when a new change is pushed (and hopefully fixed). We don't track or dismiss the validation error messages on the files tab for example.", "author": "Ldcabansay", "createdAt": "2020-05-29T00:52:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI4MTYxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI4Nzc2Mg==", "url": "https://github.com/dockstore/dockstore/pull/3479#discussion_r428287762", "bodyText": "I'm a big fan of methods returning Optional if null could be returned, but if you have a method that already returns a null, I think it's more complicated to create an Optional just to see if it's empty -- I would either just directly do a null check here, or change UserDAO.findByGitHubUsername to return an Optional. We don't have the DAOs returning Optionals, so I would lean towards the former.", "author": "coverbeck", "createdAt": "2020-05-20T20:27:23Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java", "diffHunk": "@@ -317,19 +332,48 @@ private WorkflowVersion updateDBVersionSourceFilesWithRemoteVersionSourceFiles(W\n                     gitHubSourceCodeRepo, user, dockstoreYml));\n             workflows.addAll(createBioWorkflowsAndVersionsFromDockstoreYml(dockstoreYaml12.getWorkflows(), repository, gitReference,\n                     gitHubSourceCodeRepo, user, dockstoreYml));\n+            lambdaEventDAO.create(lambdaEvent);\n             return workflows;\n         } catch (CustomWebApplicationException | ClassCastException | DockstoreYamlHelper.DockstoreYamlException ex) {\n-            // TODO: Eventually want to record something to the database so that the user can know the type of lambda errors run into\n             String msg = \"User \" + username + \": Error handling push event for repository \" + repository + \" and reference \" + gitReference + \"\\n\" + ex.getMessage();\n             LOG.info(msg, ex);\n+            lambdaEvent.setSuccess(false);\n+            lambdaEvent.setMessage(ex.getMessage());\n+            lambdaEventDAO.create(lambdaEvent);\n+            sessionFactory.getCurrentSession().getTransaction().commit();\n             throw new CustomWebApplicationException(msg, LAMBDA_FAILURE);\n-        } catch (NullPointerException ex) {\n+        } catch (Exception ex) {\n             String msg = \"User \" + username + \": Unhandled error while handling push event for repository \" + repository + \" and reference \" + gitReference + \"\\n\" + ex.getMessage();\n             LOG.error(msg, ex);\n+            lambdaEvent.setSuccess(false);\n+            lambdaEvent.setMessage(ex.getMessage());\n+            lambdaEventDAO.create(lambdaEvent);\n+            sessionFactory.getCurrentSession().getTransaction().commit();\n             throw new CustomWebApplicationException(msg, LAMBDA_FAILURE);\n         }\n     }\n \n+    /**\n+     * Create a basic lambda event\n+     * @param repository repository path\n+     * @param gitReference full git reference (ex. refs/heads/master)\n+     * @param username Username of GitHub user who triggered the event\n+     * @param installationId The GitHub App Installation ID\n+     * @param type Event type\n+     * @return New lambda event\n+     */\n+    private LambdaEvent createBasicEvent(String repository, String gitReference, String username, String installationId, LambdaEvent.LambdaEventType type) {\n+        LambdaEvent lambdaEvent = new LambdaEvent();\n+        lambdaEvent.setRepository(repository);\n+        lambdaEvent.setReference(gitReference);\n+        lambdaEvent.setUsername(username);\n+        lambdaEvent.setType(type);\n+        lambdaEvent.setInstallationId(installationId);\n+        Optional<User> user = Optional.ofNullable(userDAO.findByGitHubUsername(username));", "originalCommit": "1839ef68138f4ead2a936a115a61137656681303", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM0MjU1Mw==", "url": "https://github.com/dockstore/dockstore/pull/3479#discussion_r428342553", "bodyText": "I think the name of this should be something like gitHubUsername. I at first started to put comments about it thinking it was the Dockstore username, until I read you annotations.", "author": "coverbeck", "createdAt": "2020-05-20T22:25:27Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/core/LambdaEvent.java", "diffHunk": "@@ -0,0 +1,175 @@\n+package io.dockstore.webservice.core;\n+\n+import java.sql.Timestamp;\n+\n+import javax.persistence.Column;\n+import javax.persistence.Entity;\n+import javax.persistence.EnumType;\n+import javax.persistence.Enumerated;\n+import javax.persistence.GeneratedValue;\n+import javax.persistence.GenerationType;\n+import javax.persistence.Id;\n+import javax.persistence.JoinColumn;\n+import javax.persistence.ManyToOne;\n+import javax.persistence.NamedQueries;\n+import javax.persistence.NamedQuery;\n+import javax.persistence.Table;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import io.swagger.annotations.ApiModel;\n+import io.swagger.annotations.ApiModelProperty;\n+import org.hibernate.annotations.CreationTimestamp;\n+import org.hibernate.annotations.UpdateTimestamp;\n+\n+/**\n+ * This describes events triggered by GitHub webhooks\n+ */\n+@ApiModel(\"LambdaEvent\")\n+@Entity\n+@Table(name = \"LambdaEvent\")\n+@NamedQueries({\n+        @NamedQuery(name = \"io.dockstore.webservice.core.LambdaEvent.findByRepository\", query = \"SELECT lambdaEvent FROM LambdaEvent lambdaEvent WHERE lambdaEvent.repository = :repository\"),\n+        @NamedQuery(name = \"io.dockstore.webservice.core.LambdaEvent.findByUsername\", query = \"SELECT lambdaEvent FROM LambdaEvent lambdaEvent WHERE lambdaEvent.username = :username\"),\n+        @NamedQuery(name = \"io.dockstore.webservice.core.LambdaEvent.findByUser\", query = \"SELECT lambdaEvent FROM LambdaEvent lambdaEvent WHERE lambdaEvent.user = :user\"),\n+})\n+@SuppressWarnings(\"checkstyle:magicnumber\")\n+public class LambdaEvent {\n+    @Id\n+    @GeneratedValue(strategy = GenerationType.IDENTITY)\n+    @ApiModelProperty(value = \"Unique ID of the event.\", position = 0)\n+    private long id;\n+\n+    @Column(columnDefinition = \"TEXT\")\n+    @ApiModelProperty(value = \"The repository from the event.\", required = true, position = 1)\n+    private String repository;\n+\n+    @Column(columnDefinition = \"TEXT\")\n+    @ApiModelProperty(value = \"The name of the user on GitHub that triggers the event.\", required = true, position = 2)\n+    private String username;", "originalCommit": "1839ef68138f4ead2a936a115a61137656681303", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM0MzQzOA==", "url": "https://github.com/dockstore/dockstore/pull/3479#discussion_r428343438", "bodyText": "Isn't this semi-secret? Probably not, but just double-checking.", "author": "coverbeck", "createdAt": "2020-05-20T22:27:29Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/core/LambdaEvent.java", "diffHunk": "@@ -0,0 +1,175 @@\n+package io.dockstore.webservice.core;\n+\n+import java.sql.Timestamp;\n+\n+import javax.persistence.Column;\n+import javax.persistence.Entity;\n+import javax.persistence.EnumType;\n+import javax.persistence.Enumerated;\n+import javax.persistence.GeneratedValue;\n+import javax.persistence.GenerationType;\n+import javax.persistence.Id;\n+import javax.persistence.JoinColumn;\n+import javax.persistence.ManyToOne;\n+import javax.persistence.NamedQueries;\n+import javax.persistence.NamedQuery;\n+import javax.persistence.Table;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import io.swagger.annotations.ApiModel;\n+import io.swagger.annotations.ApiModelProperty;\n+import org.hibernate.annotations.CreationTimestamp;\n+import org.hibernate.annotations.UpdateTimestamp;\n+\n+/**\n+ * This describes events triggered by GitHub webhooks\n+ */\n+@ApiModel(\"LambdaEvent\")\n+@Entity\n+@Table(name = \"LambdaEvent\")\n+@NamedQueries({\n+        @NamedQuery(name = \"io.dockstore.webservice.core.LambdaEvent.findByRepository\", query = \"SELECT lambdaEvent FROM LambdaEvent lambdaEvent WHERE lambdaEvent.repository = :repository\"),\n+        @NamedQuery(name = \"io.dockstore.webservice.core.LambdaEvent.findByUsername\", query = \"SELECT lambdaEvent FROM LambdaEvent lambdaEvent WHERE lambdaEvent.username = :username\"),\n+        @NamedQuery(name = \"io.dockstore.webservice.core.LambdaEvent.findByUser\", query = \"SELECT lambdaEvent FROM LambdaEvent lambdaEvent WHERE lambdaEvent.user = :user\"),\n+})\n+@SuppressWarnings(\"checkstyle:magicnumber\")\n+public class LambdaEvent {\n+    @Id\n+    @GeneratedValue(strategy = GenerationType.IDENTITY)\n+    @ApiModelProperty(value = \"Unique ID of the event.\", position = 0)\n+    private long id;\n+\n+    @Column(columnDefinition = \"TEXT\")\n+    @ApiModelProperty(value = \"The repository from the event.\", required = true, position = 1)\n+    private String repository;\n+\n+    @Column(columnDefinition = \"TEXT\")\n+    @ApiModelProperty(value = \"The name of the user on GitHub that triggers the event.\", required = true, position = 2)\n+    private String username;\n+\n+    @Column(columnDefinition = \"TEXT\")\n+    @ApiModelProperty(value = \"The git reference from the event.\", required = true, position = 3)\n+    private String reference;\n+\n+    @Column(nullable = false, columnDefinition = \"boolean default true\")\n+    @ApiModelProperty(value = \"Whether or not the event was successful.\", position = 4)\n+    private boolean success = true;\n+\n+    @Column(columnDefinition = \"TEXT\")\n+    @ApiModelProperty(value = \"The message associated with the event.\", position = 5)\n+    private String message;\n+\n+    @Column(nullable = false, columnDefinition = \"boolean default false\")\n+    @ApiModelProperty(value = \"Whether or not the user has dismissed the event.\", position = 6)\n+    private boolean dismissed = false;\n+\n+    @Column\n+    @Enumerated(EnumType.STRING)\n+    @ApiModelProperty(value = \"The type of event.\", required = true, position = 7)\n+    private LambdaEventType type;\n+\n+    @ManyToOne\n+    @JoinColumn(name = \"userId\", referencedColumnName = \"id\")\n+    @ApiModelProperty(value = \"User that the event is acting on (if exists in Dockstore).\", position = 8)\n+    @JsonIgnore\n+    private User user;\n+\n+    @Column(columnDefinition = \"TEXT\")\n+    @ApiModelProperty(value = \"The installation ID of the event.\", position = 9)", "originalCommit": "1839ef68138f4ead2a936a115a61137656681303", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgwMDI2Nw==", "url": "https://github.com/dockstore/dockstore/pull/3479#discussion_r428800267", "bodyText": "Not entirely sure, will investigate.", "author": "agduncan94", "createdAt": "2020-05-21T17:25:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM0MzQzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTIzNzkwNQ==", "url": "https://github.com/dockstore/dockstore/pull/3479#discussion_r429237905", "bodyText": "After investigating I am not entirely sure, though I think it is ok just to remove it since it is not a requirement. We don't do anything with it, so I am just going to remove it.", "author": "agduncan94", "createdAt": "2020-05-22T13:13:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM0MzQzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM0NDE3MA==", "url": "https://github.com/dockstore/dockstore/pull/3479#discussion_r428344170", "bodyText": "Should this be lazy?", "author": "coverbeck", "createdAt": "2020-05-20T22:29:23Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/core/LambdaEvent.java", "diffHunk": "@@ -0,0 +1,175 @@\n+package io.dockstore.webservice.core;\n+\n+import java.sql.Timestamp;\n+\n+import javax.persistence.Column;\n+import javax.persistence.Entity;\n+import javax.persistence.EnumType;\n+import javax.persistence.Enumerated;\n+import javax.persistence.GeneratedValue;\n+import javax.persistence.GenerationType;\n+import javax.persistence.Id;\n+import javax.persistence.JoinColumn;\n+import javax.persistence.ManyToOne;\n+import javax.persistence.NamedQueries;\n+import javax.persistence.NamedQuery;\n+import javax.persistence.Table;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import io.swagger.annotations.ApiModel;\n+import io.swagger.annotations.ApiModelProperty;\n+import org.hibernate.annotations.CreationTimestamp;\n+import org.hibernate.annotations.UpdateTimestamp;\n+\n+/**\n+ * This describes events triggered by GitHub webhooks\n+ */\n+@ApiModel(\"LambdaEvent\")\n+@Entity\n+@Table(name = \"LambdaEvent\")\n+@NamedQueries({\n+        @NamedQuery(name = \"io.dockstore.webservice.core.LambdaEvent.findByRepository\", query = \"SELECT lambdaEvent FROM LambdaEvent lambdaEvent WHERE lambdaEvent.repository = :repository\"),\n+        @NamedQuery(name = \"io.dockstore.webservice.core.LambdaEvent.findByUsername\", query = \"SELECT lambdaEvent FROM LambdaEvent lambdaEvent WHERE lambdaEvent.username = :username\"),\n+        @NamedQuery(name = \"io.dockstore.webservice.core.LambdaEvent.findByUser\", query = \"SELECT lambdaEvent FROM LambdaEvent lambdaEvent WHERE lambdaEvent.user = :user\"),\n+})\n+@SuppressWarnings(\"checkstyle:magicnumber\")\n+public class LambdaEvent {\n+    @Id\n+    @GeneratedValue(strategy = GenerationType.IDENTITY)\n+    @ApiModelProperty(value = \"Unique ID of the event.\", position = 0)\n+    private long id;\n+\n+    @Column(columnDefinition = \"TEXT\")\n+    @ApiModelProperty(value = \"The repository from the event.\", required = true, position = 1)\n+    private String repository;\n+\n+    @Column(columnDefinition = \"TEXT\")\n+    @ApiModelProperty(value = \"The name of the user on GitHub that triggers the event.\", required = true, position = 2)\n+    private String username;\n+\n+    @Column(columnDefinition = \"TEXT\")\n+    @ApiModelProperty(value = \"The git reference from the event.\", required = true, position = 3)\n+    private String reference;\n+\n+    @Column(nullable = false, columnDefinition = \"boolean default true\")\n+    @ApiModelProperty(value = \"Whether or not the event was successful.\", position = 4)\n+    private boolean success = true;\n+\n+    @Column(columnDefinition = \"TEXT\")\n+    @ApiModelProperty(value = \"The message associated with the event.\", position = 5)\n+    private String message;\n+\n+    @Column(nullable = false, columnDefinition = \"boolean default false\")\n+    @ApiModelProperty(value = \"Whether or not the user has dismissed the event.\", position = 6)\n+    private boolean dismissed = false;\n+\n+    @Column\n+    @Enumerated(EnumType.STRING)\n+    @ApiModelProperty(value = \"The type of event.\", required = true, position = 7)\n+    private LambdaEventType type;\n+\n+    @ManyToOne\n+    @JoinColumn(name = \"userId\", referencedColumnName = \"id\")\n+    @ApiModelProperty(value = \"User that the event is acting on (if exists in Dockstore).\", position = 8)\n+    @JsonIgnore\n+    private User user;", "originalCommit": "1839ef68138f4ead2a936a115a61137656681303", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg5OTYyNA==", "url": "https://github.com/dockstore/dockstore/pull/3479#discussion_r428899624", "bodyText": "Yes, it is now, just forgot to push changes.", "author": "agduncan94", "createdAt": "2020-05-21T20:35:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM0NDE3MA=="}], "type": "inlineReview"}, {"oid": "95fabb35a4319f2dbf2e896b02b4e65a17674aa4", "url": "https://github.com/dockstore/dockstore/commit/95fabb35a4319f2dbf2e896b02b4e65a17674aa4", "message": "some suggestions from PR", "committedDate": "2020-05-21T12:51:06Z", "type": "commit"}, {"oid": "1af63fe31b4f516e9879302ac3b337398dd0d7f5", "url": "https://github.com/dockstore/dockstore/commit/1af63fe31b4f516e9879302ac3b337398dd0d7f5", "message": "more suggestions from pr", "committedDate": "2020-05-22T12:26:11Z", "type": "commit"}, {"oid": "b3b4761e91738966b8596e96515c7314472ab295", "url": "https://github.com/dockstore/dockstore/commit/b3b4761e91738966b8596e96515c7314472ab295", "message": "remove installation id; add endpoint to get all lambda events for a given org", "committedDate": "2020-05-22T15:15:28Z", "type": "commit"}, {"oid": "14d3d6e3188c234e4b8389007968e32386b46124", "url": "https://github.com/dockstore/dockstore/commit/14d3d6e3188c234e4b8389007968e32386b46124", "message": "small if fix", "committedDate": "2020-05-22T15:16:07Z", "type": "commit"}, {"oid": "7c98220fd457baeb4944fb233b0156af882e6e34", "url": "https://github.com/dockstore/dockstore/commit/7c98220fd457baeb4944fb233b0156af882e6e34", "message": "added test for new lambda events endpoint", "committedDate": "2020-05-22T16:21:22Z", "type": "commit"}, {"oid": "53a6173e032b9d7d86ba4b0dd4709bd8101d7e4e", "url": "https://github.com/dockstore/dockstore/commit/53a6173e032b9d7d86ba4b0dd4709bd8101d7e4e", "message": "added pagination to getLambdaEventsByOrganization", "committedDate": "2020-05-22T20:19:40Z", "type": "commit"}, {"oid": "4ae8b6303c9b82d069cd22c68a2211f76efec2a4", "url": "https://github.com/dockstore/dockstore/commit/4ae8b6303c9b82d069cd22c68a2211f76efec2a4", "message": "add pagination to other endpoint", "committedDate": "2020-05-25T14:11:34Z", "type": "commit"}, {"oid": "73deb2a3ab0918162a589641ad20fc71ea592089", "url": "https://github.com/dockstore/dockstore/commit/73deb2a3ab0918162a589641ad20fc71ea592089", "message": "more testing for pagination", "committedDate": "2020-05-25T15:14:23Z", "type": "commit"}, {"oid": "20e0a50f5162e798c8c6b98d5f0bbfac347fbb4d", "url": "https://github.com/dockstore/dockstore/commit/20e0a50f5162e798c8c6b98d5f0bbfac347fbb4d", "message": "Merge branch 'develop' into feature/3238/lambda-error-messages", "committedDate": "2020-05-25T17:20:44Z", "type": "commit"}, {"oid": "446f13a41255c6f67df8a6c3b567b6d9cdd7ccff", "url": "https://github.com/dockstore/dockstore/commit/446f13a41255c6f67df8a6c3b567b6d9cdd7ccff", "message": "Merge branch 'develop' into feature/3238/lambda-error-messages", "committedDate": "2020-05-25T18:43:51Z", "type": "commit"}, {"oid": "b4e97e2bc140bb8a0980a848c6495d1066d01e68", "url": "https://github.com/dockstore/dockstore/commit/b4e97e2bc140bb8a0980a848c6495d1066d01e68", "message": "converted test to open API, required converting some endpoints to support open API as well", "committedDate": "2020-05-26T20:01:57Z", "type": "commit"}, {"oid": "3dc65d3a5a08adc09dc226ed24319cfb78ecf8e4", "url": "https://github.com/dockstore/dockstore/commit/3dc65d3a5a08adc09dc226ed24319cfb78ecf8e4", "message": "some open api fixes", "committedDate": "2020-05-27T15:46:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM2MjUwOQ==", "url": "https://github.com/dockstore/dockstore/pull/3479#discussion_r431362509", "bodyText": "This may be overkill, but I wonder if this should be GitHubLambdaEvent? In case we ever add the GitHub apps equivalent for BitBucket and/ GitLab, or we ever add Lambdas for some other feature that I can't envision right now?\nOTOH, you could rename it if/when we get there.", "author": "coverbeck", "createdAt": "2020-05-27T18:41:11Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/core/LambdaEvent.java", "diffHunk": "@@ -0,0 +1,165 @@\n+package io.dockstore.webservice.core;\n+\n+import java.sql.Timestamp;\n+\n+import javax.persistence.Column;\n+import javax.persistence.Entity;\n+import javax.persistence.EnumType;\n+import javax.persistence.Enumerated;\n+import javax.persistence.FetchType;\n+import javax.persistence.GeneratedValue;\n+import javax.persistence.GenerationType;\n+import javax.persistence.Id;\n+import javax.persistence.JoinColumn;\n+import javax.persistence.ManyToOne;\n+import javax.persistence.NamedQueries;\n+import javax.persistence.NamedQuery;\n+import javax.persistence.Table;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnore;\n+import io.swagger.annotations.ApiModel;\n+import io.swagger.annotations.ApiModelProperty;\n+import org.hibernate.annotations.CreationTimestamp;\n+import org.hibernate.annotations.UpdateTimestamp;\n+\n+/**\n+ * This describes events triggered by GitHub webhooks\n+ */\n+@ApiModel(\"LambdaEvent\")\n+@Entity\n+@Table(name = \"LambdaEvent\")\n+@NamedQueries({\n+        @NamedQuery(name = \"io.dockstore.webservice.core.LambdaEvent.findByRepository\", query = \"SELECT lambdaEvent FROM LambdaEvent lambdaEvent WHERE lambdaEvent.repository = :repository\"),\n+        @NamedQuery(name = \"io.dockstore.webservice.core.LambdaEvent.findByOrganization\", query = \"SELECT lambdaEvent FROM LambdaEvent lambdaEvent WHERE lambdaEvent.repository like :organization\"),\n+        @NamedQuery(name = \"io.dockstore.webservice.core.LambdaEvent.findByUsername\", query = \"SELECT lambdaEvent FROM LambdaEvent lambdaEvent WHERE lambdaEvent.githubUsername = :username\"),\n+        @NamedQuery(name = \"io.dockstore.webservice.core.LambdaEvent.findByUser\", query = \"SELECT lambdaEvent FROM LambdaEvent lambdaEvent WHERE lambdaEvent.user = :user\"),\n+})\n+@SuppressWarnings(\"checkstyle:magicnumber\")\n+public class LambdaEvent {", "originalCommit": "3dc65d3a5a08adc09dc226ed24319cfb78ecf8e4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQzOTE0NQ==", "url": "https://github.com/dockstore/dockstore/pull/3479#discussion_r431439145", "bodyText": "I think I am ok just renaming later if the need ever comes up.", "author": "agduncan94", "createdAt": "2020-05-27T21:00:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM2MjUwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM2ODI5NQ==", "url": "https://github.com/dockstore/dockstore/pull/3479#discussion_r431368295", "bodyText": "Should be 401 status code, not 400.", "author": "coverbeck", "createdAt": "2020-05-27T18:51:43Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/LambdaEventResource.java", "diffHunk": "@@ -0,0 +1,74 @@\n+package io.dockstore.webservice.resources;\n+\n+import java.util.List;\n+import java.util.Objects;\n+\n+import javax.ws.rs.DefaultValue;\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.PathParam;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.QueryParam;\n+import javax.ws.rs.core.MediaType;\n+\n+import com.codahale.metrics.annotation.Timed;\n+import io.dockstore.common.SourceControl;\n+import io.dockstore.webservice.CustomWebApplicationException;\n+import io.dockstore.webservice.core.LambdaEvent;\n+import io.dockstore.webservice.core.User;\n+import io.dockstore.webservice.core.Workflow;\n+import io.dockstore.webservice.jdbi.LambdaEventDAO;\n+import io.dockstore.webservice.jdbi.WorkflowDAO;\n+import io.dropwizard.auth.Auth;\n+import io.dropwizard.hibernate.UnitOfWork;\n+import io.swagger.annotations.Api;\n+import io.swagger.annotations.ApiOperation;\n+import io.swagger.annotations.ApiParam;\n+import io.swagger.v3.oas.annotations.Operation;\n+import io.swagger.v3.oas.annotations.Parameter;\n+import io.swagger.v3.oas.annotations.enums.ParameterIn;\n+import io.swagger.v3.oas.annotations.security.SecurityRequirement;\n+import io.swagger.v3.oas.annotations.tags.Tag;\n+import org.apache.http.HttpStatus;\n+import org.hibernate.SessionFactory;\n+\n+import static io.dockstore.webservice.resources.ResourceConstants.PAGINATION_LIMIT;\n+import static io.dockstore.webservice.resources.ResourceConstants.PAGINATION_LIMIT_TEXT;\n+import static io.dockstore.webservice.resources.ResourceConstants.PAGINATION_OFFSET_TEXT;\n+\n+@Path(\"/lambdaEvents\")\n+@Api(\"/lambdaEvents\")\n+@Produces(MediaType.APPLICATION_JSON)\n+@Tag(name = \"lambdaEvents\", description = ResourceConstants.LAMBDAEVENTS)\n+public class LambdaEventResource {\n+    private final LambdaEventDAO lambdaEventDAO;\n+    private final WorkflowDAO workflowDAO;\n+    private SessionFactory sessionFactory;\n+\n+    public LambdaEventResource(SessionFactory sessionFactory) {\n+        this.sessionFactory = sessionFactory;\n+        this.lambdaEventDAO = new LambdaEventDAO(sessionFactory);\n+        this.workflowDAO = new WorkflowDAO(sessionFactory);\n+    }\n+\n+    @GET\n+    @Timed\n+    @UnitOfWork(readOnly = true)\n+    @Path(\"/{organization}\")\n+    @Operation(operationId = \"getLambdaEventsByOrganization\", description = \"Get all of the Lambda Events for the given GitHub organization.\", security = @SecurityRequirement(name = ResourceConstants.OPENAPI_JWT_SECURITY_DEFINITION_NAME))\n+    @ApiOperation(value = \"See OpenApi for details\")\n+    public List<LambdaEvent> getLambdaEventsByOrganization(@ApiParam(hidden = true) @Parameter(hidden = true, name = \"user\", in = ParameterIn.HEADER) @Auth User user,\n+            @ApiParam(value = \"organization\", required = true) @PathParam(\"organization\") String organization,\n+            @ApiParam(value = PAGINATION_OFFSET_TEXT) @QueryParam(\"offset\") @DefaultValue(\"0\") String offset,\n+            @ApiParam(value = PAGINATION_LIMIT_TEXT, allowableValues = \"range[1,100]\", defaultValue = PAGINATION_LIMIT) @DefaultValue(PAGINATION_LIMIT) @QueryParam(\"limit\") Integer limit) {\n+        // To ensure a user has access to an organization, check that they have at least one workflow from that organization\n+        List<Workflow> workflows = workflowDAO.findMyEntries(user.getId());\n+        boolean canAccessOrganization = workflows.stream().anyMatch(workflow -> Objects.equals(workflow.getOrganization(), organization) && Objects.equals(workflow.getSourceControl(),\n+                SourceControl.GITHUB));\n+        if (!canAccessOrganization) {\n+            throw new CustomWebApplicationException(\"You do not have access to the GitHub organization '\" + organization + \"'\", HttpStatus.SC_BAD_REQUEST);", "originalCommit": "3dc65d3a5a08adc09dc226ed24319cfb78ecf8e4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM3Mjk3Nw==", "url": "https://github.com/dockstore/dockstore/pull/3479#discussion_r431372977", "bodyText": "There is a workflowDAO.findPublishedByOrganization; you could tweak a findByOrganzation copy of it. Or you could go even further and create a named query that returns a count/boolean, e.g., hasWorkflowInOrganization.\nThis could be overkill, especially the second suggestion, given the upcoming changes for lazy sourcefiles and whatnot, but for certain users this will cause workflows with 600+ versions to be fetched just to see if you belong to an org.", "author": "coverbeck", "createdAt": "2020-05-27T18:59:51Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/LambdaEventResource.java", "diffHunk": "@@ -0,0 +1,74 @@\n+package io.dockstore.webservice.resources;\n+\n+import java.util.List;\n+import java.util.Objects;\n+\n+import javax.ws.rs.DefaultValue;\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.PathParam;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.QueryParam;\n+import javax.ws.rs.core.MediaType;\n+\n+import com.codahale.metrics.annotation.Timed;\n+import io.dockstore.common.SourceControl;\n+import io.dockstore.webservice.CustomWebApplicationException;\n+import io.dockstore.webservice.core.LambdaEvent;\n+import io.dockstore.webservice.core.User;\n+import io.dockstore.webservice.core.Workflow;\n+import io.dockstore.webservice.jdbi.LambdaEventDAO;\n+import io.dockstore.webservice.jdbi.WorkflowDAO;\n+import io.dropwizard.auth.Auth;\n+import io.dropwizard.hibernate.UnitOfWork;\n+import io.swagger.annotations.Api;\n+import io.swagger.annotations.ApiOperation;\n+import io.swagger.annotations.ApiParam;\n+import io.swagger.v3.oas.annotations.Operation;\n+import io.swagger.v3.oas.annotations.Parameter;\n+import io.swagger.v3.oas.annotations.enums.ParameterIn;\n+import io.swagger.v3.oas.annotations.security.SecurityRequirement;\n+import io.swagger.v3.oas.annotations.tags.Tag;\n+import org.apache.http.HttpStatus;\n+import org.hibernate.SessionFactory;\n+\n+import static io.dockstore.webservice.resources.ResourceConstants.PAGINATION_LIMIT;\n+import static io.dockstore.webservice.resources.ResourceConstants.PAGINATION_LIMIT_TEXT;\n+import static io.dockstore.webservice.resources.ResourceConstants.PAGINATION_OFFSET_TEXT;\n+\n+@Path(\"/lambdaEvents\")\n+@Api(\"/lambdaEvents\")\n+@Produces(MediaType.APPLICATION_JSON)\n+@Tag(name = \"lambdaEvents\", description = ResourceConstants.LAMBDAEVENTS)\n+public class LambdaEventResource {\n+    private final LambdaEventDAO lambdaEventDAO;\n+    private final WorkflowDAO workflowDAO;\n+    private SessionFactory sessionFactory;\n+\n+    public LambdaEventResource(SessionFactory sessionFactory) {\n+        this.sessionFactory = sessionFactory;\n+        this.lambdaEventDAO = new LambdaEventDAO(sessionFactory);\n+        this.workflowDAO = new WorkflowDAO(sessionFactory);\n+    }\n+\n+    @GET\n+    @Timed\n+    @UnitOfWork(readOnly = true)\n+    @Path(\"/{organization}\")\n+    @Operation(operationId = \"getLambdaEventsByOrganization\", description = \"Get all of the Lambda Events for the given GitHub organization.\", security = @SecurityRequirement(name = ResourceConstants.OPENAPI_JWT_SECURITY_DEFINITION_NAME))\n+    @ApiOperation(value = \"See OpenApi for details\")\n+    public List<LambdaEvent> getLambdaEventsByOrganization(@ApiParam(hidden = true) @Parameter(hidden = true, name = \"user\", in = ParameterIn.HEADER) @Auth User user,\n+            @ApiParam(value = \"organization\", required = true) @PathParam(\"organization\") String organization,\n+            @ApiParam(value = PAGINATION_OFFSET_TEXT) @QueryParam(\"offset\") @DefaultValue(\"0\") String offset,\n+            @ApiParam(value = PAGINATION_LIMIT_TEXT, allowableValues = \"range[1,100]\", defaultValue = PAGINATION_LIMIT) @DefaultValue(PAGINATION_LIMIT) @QueryParam(\"limit\") Integer limit) {\n+        // To ensure a user has access to an organization, check that they have at least one workflow from that organization\n+        List<Workflow> workflows = workflowDAO.findMyEntries(user.getId());", "originalCommit": "3dc65d3a5a08adc09dc226ed24319cfb78ecf8e4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQzOTg2Ng==", "url": "https://github.com/dockstore/dockstore/pull/3479#discussion_r431439866", "bodyText": "I like this idea, I'll try one of the approaches.", "author": "agduncan94", "createdAt": "2020-05-27T21:01:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM3Mjk3Nw=="}], "type": "inlineReview"}, {"oid": "27e6d0e444fb19bcc9db7c367990126ce6dca959", "url": "https://github.com/dockstore/dockstore/commit/27e6d0e444fb19bcc9db7c367990126ce6dca959", "message": "remove dismissed attribute", "committedDate": "2020-05-27T20:26:35Z", "type": "commit"}, {"oid": "2237b48df80654f1bfa3fbe26a05f8dc240eab98", "url": "https://github.com/dockstore/dockstore/commit/2237b48df80654f1bfa3fbe26a05f8dc240eab98", "message": "changes recommended in PR", "committedDate": "2020-05-28T14:00:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg3NDY2Mg==", "url": "https://github.com/dockstore/dockstore/pull/3479#discussion_r431874662", "bodyText": "This cuts down data loaded in memory from all workflows to an organization's workflows, which is a lot better.\nBut can still be better by avoiding loading workflows at all since checking that the user has access can be done purely by query or checking with GitHub that the user had access to the organization directly in the case that the user has not been added to a workflow in the org yet would be more efficient\n.\nPlease add as as a code comment (TODO) and ticket", "author": "denis-yuen", "createdAt": "2020-05-28T14:24:01Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/LambdaEventResource.java", "diffHunk": "@@ -62,11 +65,12 @@ public LambdaEventResource(SessionFactory sessionFactory) {\n             @ApiParam(value = PAGINATION_OFFSET_TEXT) @QueryParam(\"offset\") @DefaultValue(\"0\") String offset,\n             @ApiParam(value = PAGINATION_LIMIT_TEXT, allowableValues = \"range[1,100]\", defaultValue = PAGINATION_LIMIT) @DefaultValue(PAGINATION_LIMIT) @QueryParam(\"limit\") Integer limit) {\n         // To ensure a user has access to an organization, check that they have at least one workflow from that organization\n-        List<Workflow> workflows = workflowDAO.findMyEntries(user.getId());\n-        boolean canAccessOrganization = workflows.stream().anyMatch(workflow -> Objects.equals(workflow.getOrganization(), organization) && Objects.equals(workflow.getSourceControl(),\n+        User authUser = userDAO.findById(user.getId());\n+        List<Workflow> workflows = workflowDAO.findByOrganization(organization);", "originalCommit": "2237b48df80654f1bfa3fbe26a05f8dc240eab98", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk0NjQwMw==", "url": "https://github.com/dockstore/dockstore/pull/3479#discussion_r431946403", "bodyText": "I ended up just changing it to call the GitHub API, much cleaner now.", "author": "agduncan94", "createdAt": "2020-05-28T15:56:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg3NDY2Mg=="}], "type": "inlineReview"}, {"oid": "4cb2bdfd106369acfa1ea3747ba894958a515da4", "url": "https://github.com/dockstore/dockstore/commit/4cb2bdfd106369acfa1ea3747ba894958a515da4", "message": "use github api to check if user has access to an org", "committedDate": "2020-05-28T15:43:01Z", "type": "commit"}, {"oid": "502a8dc821f4d3fce7b05764abb55ef3367f0067", "url": "https://github.com/dockstore/dockstore/commit/502a8dc821f4d3fce7b05764abb55ef3367f0067", "message": "Merge branch 'develop' into feature/3238/lambda-error-messages", "committedDate": "2020-05-28T19:35:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjIwMzM5Nw==", "url": "https://github.com/dockstore/dockstore/pull/3479#discussion_r432203397", "bodyText": "This seems like a high limit to me. Can always adjust later though.", "author": "Ldcabansay", "createdAt": "2020-05-29T01:03:44Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/ResourceConstants.java", "diffHunk": "@@ -33,7 +33,13 @@\n     public static final String ORGANIZATIONS = \"Operations on Dockstore organizations\";\n     public static final String CURATION = \"List and modify notifications for users of Dockstore\";\n     public static final String NIHDATACOMMONS = \"Needed for SmartAPI compatibility apparantly, might be cargo cult behaviour\";\n+    public static final String LAMBDAEVENTS = \"Query lambda events triggered by GitHub Apps\";\n     public static final String OPENAPI_JWT_SECURITY_DEFINITION_NAME = \"bearer\";\n+    public static final String PAGINATION_LIMIT = \"100\";", "originalCommit": "502a8dc821f4d3fce7b05764abb55ef3367f0067", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjAxNjczMw==", "url": "https://github.com/dockstore/dockstore/pull/3479#discussion_r432016733", "bodyText": "is this needed?", "author": "garyluu", "createdAt": "2020-05-28T17:51:01Z", "path": ".travis.yml", "diffHunk": "@@ -1,5 +1,6 @@\n services:\n - docker\n+- postgresql", "originalCommit": "4cb2bdfd106369acfa1ea3747ba894958a515da4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjA2OTQ2OA==", "url": "https://github.com/dockstore/dockstore/pull/3479#discussion_r432069468", "bodyText": "not really RESTful but if you don't forsee anyone querying by anything other that organization, then it doesn't matter", "author": "garyluu", "createdAt": "2020-05-28T19:28:40Z", "path": "dockstore-webservice/src/main/resources/swagger.yaml", "diffHunk": "@@ -2697,6 +2698,46 @@ paths:\n               $ref: \"#/definitions/Event\"\n       security:\n       - BEARER: []\n+  /lambdaEvents/{organization}:", "originalCommit": "4cb2bdfd106369acfa1ea3747ba894958a515da4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjA3MDE3OQ==", "url": "https://github.com/dockstore/dockstore/pull/3479#discussion_r432070179", "bodyText": "Is this the only response?", "author": "garyluu", "createdAt": "2020-05-28T19:30:04Z", "path": "dockstore-webservice/src/main/resources/openapi3/openapi.yaml", "diffHunk": "@@ -4165,6 +4266,34 @@ paths:\n       - bearer: []\n       tags:\n       - workflows\n+  /workflows/github/install:\n+    post:\n+      description: Handle the installation of our GitHub app onto a repository or\n+        organization.\n+      operationId: handleGitHubInstallation\n+      requestBody:\n+        content:\n+          application/x-www-form-urlencoded:\n+            schema:\n+              properties:\n+                installationId:\n+                  type: string\n+                repositories:\n+                  type: string\n+                username:\n+                  type: string\n+              required:\n+              - installationId\n+              - repositories\n+              - username\n+              type: object\n+      responses:\n+        \"418\":", "originalCommit": "4cb2bdfd106369acfa1ea3747ba894958a515da4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}