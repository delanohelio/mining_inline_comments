{"pr_number": 3257, "pr_title": "Constrain unique version names for workflow versions plus tags", "pr_createdAt": "2020-02-21T21:05:59Z", "pr_url": "https://github.com/dockstore/dockstore/pull/3257", "timeline": [{"oid": "8717843fcaa09108db18c370784caf3aaba2ec36", "url": "https://github.com/dockstore/dockstore/commit/8717843fcaa09108db18c370784caf3aaba2ec36", "message": "WIP", "committedDate": "2020-02-21T15:35:19Z", "type": "commit"}, {"oid": "0c157f2c2f142f5d5b135c10690dff0c422f1ab6", "url": "https://github.com/dockstore/dockstore/commit/0c157f2c2f142f5d5b135c10690dff0c422f1ab6", "message": "Locally working db changes\n\n* addresses duplicate workflow versions\n* no way to not touch tags at the same time due to inheritance\n* will need to test well for side-effects\n* particularly refresh/upsert/etc", "committedDate": "2020-02-21T21:02:11Z", "type": "commit"}, {"oid": "4151582f527d26780e1113458b72bfa701662cfe", "url": "https://github.com/dockstore/dockstore/commit/4151582f527d26780e1113458b72bfa701662cfe", "message": "Remove constraint for version due to inheritance", "committedDate": "2020-02-21T21:53:54Z", "type": "commit"}, {"oid": "8ce552e6779411a48a25430514194ac6918a7de4", "url": "https://github.com/dockstore/dockstore/commit/8ce552e6779411a48a25430514194ac6918a7de4", "message": "Delete less content in migration due to services", "committedDate": "2020-02-21T22:09:24Z", "type": "commit"}, {"oid": "8b03a7143725f56c9611541026529976ee8bd694", "url": "https://github.com/dockstore/dockstore/commit/8b03a7143725f56c9611541026529976ee8bd694", "message": "Some patches for edge cases, probably need more", "committedDate": "2020-02-24T19:58:07Z", "type": "commit"}, {"oid": "04399624b0b5cb43130e55362320b3a10cd1cdf3", "url": "https://github.com/dockstore/dockstore/commit/04399624b0b5cb43130e55362320b3a10cd1cdf3", "message": "validation fixes", "committedDate": "2020-02-24T20:54:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY1NjE4MQ==", "url": "https://github.com/dockstore/dockstore/pull/3257#discussion_r383656181", "bodyText": "Do you need or want to delete the now orphaned source files as well? Or handle that after this shakes out?", "author": "coverbeck", "createdAt": "2020-02-25T04:44:51Z", "path": "dockstore-webservice/src/main/resources/migrations.1.8.0.xml", "diffHunk": "@@ -181,4 +181,85 @@\n         <addNotNullConstraint tableName=\"tag\" columnName=\"dbcreatedate\"/>\n         <addNotNullConstraint tableName=\"tag\" columnName=\"dbupdatedate\"/>\n     </changeSet>\n+\n+    <changeSet author=\"dyuen\" id=\"restructure_workflowversions\">\n+        <addColumn tableName=\"tag\">\n+            <column name=\"parentid\" type=\"int8\">\n+            </column>\n+        </addColumn>\n+        <addColumn tableName=\"workflowversion\">\n+            <column name=\"parentid\" type=\"int8\">\n+            </column>\n+        </addColumn>\n+        <!-- migrate data -->\n+        <sql dbms=\"postgresql\">\n+            update workflowversion set parentid = wwv.workflowid from workflowversion as wv join workflow_workflowversion as wwv on wv.id = wwv.workflowversionid where workflowversion.id = wv.id;\n+            update tag set parentid = tt.toolid from tag as t join tool_tag as tt on t.id = tt.tagid where tag.id = t.id;\n+        </sql>\n+\n+        <!-- clean-up -->\n+        <dropForeignKeyConstraint baseTableName=\"tool_tag\" constraintName=\"fkjkn6qubuvn25bun52eqjleyl6\"/>\n+        <dropForeignKeyConstraint baseTableName=\"tool_tag\" constraintName=\"fkjtsjg6jdnwxoeicd27ujmeeaj\"/>\n+        <dropForeignKeyConstraint baseTableName=\"workflow_workflowversion\" constraintName=\"fkibmeux3552ua8dwnqdb8w6991\"/>\n+        <dropUniqueConstraint constraintName=\"uk_encl8hnebnkcaxj9tlugr9cxh\" tableName=\"workflow_workflowversion\"/>\n+        <dropTable tableName=\"workflow_workflowversion\"/>\n+        <dropTable tableName=\"tool_tag\"/>\n+    </changeSet>\n+\n+    <changeSet author=\"dyuen\" id=\"cleanup invalid content\">\n+        <!-- need to investigate whether too much content is being dropped and whether the right content is being dropped -->\n+        <comment>some orphaned versions are protected by security</comment>\n+        <sql dbms=\"postgresql\">\n+            alter table workflowversion disable row level security;\n+            alter table tag disable row level security;\n+        </sql>\n+\n+        <comment>delete the versions that are orphaned already</comment>", "originalCommit": "8b03a7143725f56c9611541026529976ee8bd694", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzk2NjMyOQ==", "url": "https://github.com/dockstore/dockstore/pull/3257#discussion_r383966329", "bodyText": "I think that would be reasonable to do, I'll add it to the TODO when this spawns new tickets", "author": "denis-yuen", "createdAt": "2020-02-25T15:50:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY1NjE4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY1OTQ0MQ==", "url": "https://github.com/dockstore/dockstore/pull/3257#discussion_r383659441", "bodyText": "I don't understand the need for this -- on line 214 you've already verified that the map does not contain the name. How could the map now contain the name? Can line 221/223 change the name? Otherwise this seems redundant. Or I'm missing something.", "author": "coverbeck", "createdAt": "2020-02-25T05:00:52Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/AbstractWorkflowResource.java", "diffHunk": "@@ -217,11 +217,17 @@ protected void updateDBWorkflowWithSourceControlWorkflow(Workflow workflow, Work\n                 }\n                 workflowVersionFromDB.update(version);\n             } else {\n-                // create a new one and replace the old one\n+                // attach real workflow\n+                workflow.addWorkflowVersion(version);\n+\n                 final long workflowVersionId = workflowVersionDAO.create(version);\n                 releaseCreated = true;\n                 workflowVersionFromDB = workflowVersionDAO.findById(workflowVersionId);\n                 workflow.getWorkflowVersions().add(workflowVersionFromDB);\n+                // create a new one and replace the old one if it exists\n+                if (existingVersionMap.containsKey(workflowVersionFromDB.getName())) {", "originalCommit": "8b03a7143725f56c9611541026529976ee8bd694", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzk3NzQ2OQ==", "url": "https://github.com/dockstore/dockstore/pull/3257#discussion_r383977469", "bodyText": "I think it should be redundant, I probably had something else in mind.", "author": "denis-yuen", "createdAt": "2020-02-25T16:06:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzY1OTQ0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU3Nzk0MQ==", "url": "https://github.com/dockstore/dockstore/pull/3257#discussion_r383577941", "bodyText": "constraint names", "author": "garyluu", "createdAt": "2020-02-24T23:35:50Z", "path": "dockstore-webservice/src/main/resources/migrations.1.8.0.xml", "diffHunk": "@@ -181,4 +181,85 @@\n         <addNotNullConstraint tableName=\"tag\" columnName=\"dbcreatedate\"/>\n         <addNotNullConstraint tableName=\"tag\" columnName=\"dbupdatedate\"/>\n     </changeSet>\n+\n+    <changeSet author=\"dyuen\" id=\"restructure_workflowversions\">\n+        <addColumn tableName=\"tag\">\n+            <column name=\"parentid\" type=\"int8\">\n+            </column>\n+        </addColumn>\n+        <addColumn tableName=\"workflowversion\">\n+            <column name=\"parentid\" type=\"int8\">\n+            </column>\n+        </addColumn>\n+        <!-- migrate data -->\n+        <sql dbms=\"postgresql\">\n+            update workflowversion set parentid = wwv.workflowid from workflowversion as wv join workflow_workflowversion as wwv on wv.id = wwv.workflowversionid where workflowversion.id = wv.id;\n+            update tag set parentid = tt.toolid from tag as t join tool_tag as tt on t.id = tt.tagid where tag.id = t.id;\n+        </sql>\n+\n+        <!-- clean-up -->\n+        <dropForeignKeyConstraint baseTableName=\"tool_tag\" constraintName=\"fkjkn6qubuvn25bun52eqjleyl6\"/>", "originalCommit": "8b03a7143725f56c9611541026529976ee8bd694", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzk4MTAyNg==", "url": "https://github.com/dockstore/dockstore/pull/3257#discussion_r383981026", "bodyText": "I might not follow, but unfortunately they do appear to have these names in prod", "author": "denis-yuen", "createdAt": "2020-02-25T16:11:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU3Nzk0MQ=="}], "type": "inlineReview"}, {"oid": "7d73182c9884431e7ee3ac2527db2d93211a0a29", "url": "https://github.com/dockstore/dockstore/commit/7d73182c9884431e7ee3ac2527db2d93211a0a29", "message": "PR feedback", "committedDate": "2020-02-25T16:12:00Z", "type": "commit"}, {"oid": "6bc0d2dc45e5300c996f6fd7f4f5388e55546fd1", "url": "https://github.com/dockstore/dockstore/commit/6bc0d2dc45e5300c996f6fd7f4f5388e55546fd1", "message": "Travis-CI update?\n\nhttps://changelog.travis-ci.com/", "committedDate": "2020-02-25T16:22:46Z", "type": "commit"}]}