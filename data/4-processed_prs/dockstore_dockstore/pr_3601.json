{"pr_number": 3601, "pr_title": "Exit sortOpenAPIYaml.sh with more useful message when yq missing (#3561)", "pr_createdAt": "2020-06-23T17:49:43Z", "pr_url": "https://github.com/dockstore/dockstore/pull/3601", "timeline": [{"oid": "74b1468e28d66a4ae86fca70063e9d2c434cd534", "url": "https://github.com/dockstore/dockstore/commit/74b1468e28d66a4ae86fca70063e9d2c434cd534", "message": "Exit sortOpenAPIYaml.sh with more useful message when yq missing (#3561)", "committedDate": "2020-06-23T17:39:38Z", "type": "commit"}, {"oid": "7a8c2a7c95677653d08516ba97c56a6f22f618f2", "url": "https://github.com/dockstore/dockstore/commit/7a8c2a7c95677653d08516ba97c56a6f22f618f2", "message": "Merge branch 'develop' into feature/3561/missing-yq-build-errmsg", "committedDate": "2020-06-23T18:24:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ2ODczMQ==", "url": "https://github.com/dockstore/dockstore/pull/3601#discussion_r444468731", "bodyText": "Seems odd/redundant that this needs to be done in script.\nIt is more \"Maveny\" to configure this in the Maven exec plugin and the plugin should fail if this script exits non-zero.\nhttps://www.mojohaus.org/exec-maven-plugin/exec-mojo.html#successCodes", "author": "denis-yuen", "createdAt": "2020-06-23T19:51:40Z", "path": "dockstore-webservice/scripts/sortOpenAPIYaml.sh", "diffHunk": "@@ -3,4 +3,10 @@ set -o errexit\n set -o pipefail\n set -o nounset\n # https://github.com/mikefarah/yq Require version 3.1.2.  Newer version will likely also work.\n-yq r --tojson src/main/resources/openapi3/unsortedopenapi.yaml | yq r - -P > src/main/resources/openapi3/openapi.yaml\n+yq r --tojson src/main/resources/openapi3/unsortedopenapi.yaml | yq r - -P > src/main/resources/openapi3/openapi.yaml || {", "originalCommit": "7a8c2a7c95677653d08516ba97c56a6f22f618f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ3MDQxNQ==", "url": "https://github.com/dockstore/dockstore/pull/3601#discussion_r444470415", "bodyText": "doesn't it already do that?\n[INFO] --- exec-maven-plugin:1.6.0:exec (Sort OpenAPI.yaml) @ dockstore-webservice ---\nDownloading from central: https://repo.maven.apache.org/maven2/org/apache/commons/commons-exec/1.3/commons-exec-1.3.jar\nDownloaded from central: https://repo.maven.apache.org/maven2/org/apache/commons/commons-exec/1.3/commons-exec-1.3.jar (0 B at 0 B/s)\n/dockstore-webservice/scripts/sortOpenAPIYaml.sh: line 6: yq: command not found\n/dockstore-webservice/scripts/sortOpenAPIYaml.sh: line 6: yq: command not found\n[ERROR] Command execution failed.\norg.apache.commons.exec.ExecuteException: Process exited with an error: 127 (Exit value: 127)\n    at org.apache.commons.exec.DefaultExecutor.executeInternal (DefaultExecutor.java:404)\n    at org.apache.commons.exec.DefaultExecutor.execute (DefaultExecutor.java:166)\n    at org.codehaus.mojo.exec.ExecMojo.executeCommandLine (ExecMojo.java:804)\n    at org.codehaus.mojo.exec.ExecMojo.executeCommandLine (ExecMojo.java:751)\n    at org.codehaus.mojo.exec.ExecMojo.execute (ExecMojo.java:313)\n    at org.apache.maven.plugin.DefaultBuildPluginManager.executeMojo (DefaultBuildPluginManager.java:137)\n    at org.apache.maven.lifecycle.internal.MojoExecutor.execute (MojoExecutor.java:210)\n    at org.apache.maven.lifecycle.internal.MojoExecutor.execute (MojoExecutor.java:156)\n    at org.apache.maven.lifecycle.internal.MojoExecutor.execute (MojoExecutor.java:148)\n    at org.apache.maven.lifecycle.internal.LifecycleModuleBuilder.buildProject (LifecycleModuleBuilder.java:117)\n    at org.apache.maven.lifecycle.internal.LifecycleModuleBuilder.buildProject (LifecycleModuleBuilder.java:81)\n    at org.apache.maven.lifecycle.internal.builder.singlethreaded.SingleThreadedBuilder.build (SingleThreadedBuilder.java:56)\n    at org.apache.maven.lifecycle.internal.LifecycleStarter.execute (LifecycleStarter.java:128)\n    at org.apache.maven.DefaultMaven.doExecute (DefaultMaven.java:305)\n    at org.apache.maven.DefaultMaven.doExecute (DefaultMaven.java:192)\n    at org.apache.maven.DefaultMaven.execute (DefaultMaven.java:105)\n    at org.apache.maven.cli.MavenCli.execute (MavenCli.java:956)\n    at org.apache.maven.cli.MavenCli.doMain (MavenCli.java:288)\n    at org.apache.maven.cli.MavenCli.main (MavenCli.java:192)\n    at jdk.internal.reflect.NativeMethodAccessorImpl.invoke0 (Native Method)\n    at jdk.internal.reflect.NativeMethodAccessorImpl.invoke (NativeMethodAccessorImpl.java:62)\n    at jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke (DelegatingMethodAccessorImpl.java:43)\n    at java.lang.reflect.Method.invoke (Method.java:566)\n    at org.codehaus.plexus.classworlds.launcher.Launcher.launchEnhanced (Launcher.java:282)\n    at org.codehaus.plexus.classworlds.launcher.Launcher.launch (Launcher.java:225)\n    at org.codehaus.plexus.classworlds.launcher.Launcher.mainWithExitCode (Launcher.java:406)\n    at org.codehaus.plexus.classworlds.launcher.Launcher.main (Launcher.java:347)\n[INFO] ------------------------------------------------------------------------\n[INFO] Reactor Summary for dockstore 1.9.0-beta.1-SNAPSHOT:\n[INFO]\n[INFO] dockstore .......................................... SUCCESS [10:50 min]\n[INFO] dockstore-common ................................... SUCCESS [ 43.637 s]\n[INFO] dockstore-language-plugin-parent ................... SUCCESS [  5.659 s]\n[INFO] swagger-java-quay-client ........................... SUCCESS [ 25.420 s]\n[INFO] swagger-java-sam-client ............................ SUCCESS [ 11.226 s]\n[INFO] swagger-java-bitbucket-client ...................... SUCCESS [ 22.629 s]\n[INFO] swagger-java-discourse-client ...................... SUCCESS [ 14.118 s]\n[INFO] swagger-java-zenodo-client ......................... SUCCESS [  9.545 s]\n[INFO] dockstore-webservice ............................... FAILURE [01:08 min]\n[INFO] swagger-java-client ................................ SKIPPED\n[INFO] openapi-java-client ................................ SKIPPED\n[INFO] dockstore-integration-testing ...................... SKIPPED\n[INFO] dockstore-event-consumer ........................... SKIPPED\n[INFO] reports ............................................ SKIPPED\n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD FAILURE\n[INFO] ------------------------------------------------------------------------\n[INFO] Total time:  14:32 min\n[INFO] Finished at: 2020-06-23T18:25:48Z\n[INFO] ------------------------------------------------------------------------\n[ERROR] Failed to execute goal org.codehaus.mojo:exec-maven-plugin:1.6.0:exec (Sort OpenAPI.yaml) on project dockstore-webservice: Command execution failed.: Process exited with an error: 127 (Exit value: 127) -> [Help 1]\n[ERROR]\n[ERROR] To see the full stack trace of the errors, re-run Maven with the -e switch.\n[ERROR] Re-run Maven using the -X switch to enable full debug logging.\n[ERROR]\n[ERROR] For more information about the errors and possible solutions, please read the following articles:\n[ERROR] [Help 1] http://cwiki.apache.org/confluence/display/MAVEN/MojoExecutionException\n[ERROR]\n[ERROR] After correcting the problems, you can resume the build with the command\n[ERROR]   mvn <args> -rf :dockstore-webservice\nThe command '/bin/sh -c mvn clean install -DskipTests' returned a non-zero code: 1", "author": "garyluu", "createdAt": "2020-06-23T19:54:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ2ODczMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ3MzM3MQ==", "url": "https://github.com/dockstore/dockstore/pull/3601#discussion_r444473371", "bodyText": "I was under the impression no, it seemed like Maven got past it in https://oicr.slack.com/archives/C16ET3CF4/p1591799974401000 but maybe there is something special about that environment?", "author": "denis-yuen", "createdAt": "2020-06-23T20:00:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ2ODczMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ3NTEwMQ==", "url": "https://github.com/dockstore/dockstore/pull/3601#discussion_r444475101", "bodyText": "this is from the Dockerfile at root btw (with the yq part commented out)", "author": "garyluu", "createdAt": "2020-06-23T20:03:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ2ODczMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ5Mzk5Nw==", "url": "https://github.com/dockstore/dockstore/pull/3601#discussion_r444493997", "bodyText": "@denis-yuen So that error snippet I shared in that slack link is actually the result of me attempting to build without yq twice in a row. A side-effect of yq missing is wiping the contents of openapi.yaml (see line 6 above), so that resulted in the different error log.\nThe crux of this issue was a combination of me being new to maven & incorrect assumptions about the build process. The intent of this new build message is to make it explicitly clear that yq missing wasn't the build's fault.\nAlso the reason why I made this a Bash code change rather than a \"Maveny\" change was that I couldn't see any other way to include such a message via https://www.mojohaus.org/exec-maven-plugin/exec-mojo.html which runs the script.", "author": "GFJHogue", "createdAt": "2020-06-23T20:41:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ2ODczMQ=="}], "type": "inlineReview"}]}