{"pr_number": 3126, "pr_title": "Feature/2803/version metadata update", "pr_createdAt": "2020-01-10T17:36:38Z", "pr_url": "https://github.com/dockstore/dockstore/pull/3126", "timeline": [{"oid": "e62bf75de8d7a8bffd9268fd0b0189a46676f2f2", "url": "https://github.com/dockstore/dockstore/commit/e62bf75de8d7a8bffd9268fd0b0189a46676f2f2", "message": "Fix for updating version metadata when it already exists", "committedDate": "2020-01-10T17:37:48Z", "type": "commit"}, {"oid": "0e252c435165090d11c22d730894d6799e1fc54d", "url": "https://github.com/dockstore/dockstore/commit/0e252c435165090d11c22d730894d6799e1fc54d", "message": "Update test", "committedDate": "2020-01-10T17:37:48Z", "type": "commit"}, {"oid": "0e252c435165090d11c22d730894d6799e1fc54d", "url": "https://github.com/dockstore/dockstore/commit/0e252c435165090d11c22d730894d6799e1fc54d", "message": "Update test", "committedDate": "2020-01-10T17:37:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ1MjU3MQ==", "url": "https://github.com/dockstore/dockstore/pull/3126#discussion_r365452571", "bodyText": "Would this just pass if there was no workflow with a name of v1.0?", "author": "denis-yuen", "createdAt": "2020-01-10T22:17:25Z", "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/ExtendedNextflowIT.java", "diffHunk": "@@ -110,15 +110,39 @@ public void testBitbucketNextflowWorkflow() throws Exception {\n         workflowByPathBitbucket.setWorkflowPath(\"/nextflow.config\");\n         workflowByPathBitbucket.setDescriptorType(Workflow.DescriptorTypeEnum.NFL);\n         workflowApi.updateWorkflow(workflowByPathBitbucket.getId(), workflowByPathBitbucket);\n-        final String partialReadmeDescription = \"AMPA-NF is a pipeline for assessing the antimicrobial domains of proteins,\";\n-        final String descriptorDescription = \"Fast automated prediction of protein antimicrobial regions\";\n         workflowByPathBitbucket = workflowApi.getWorkflowByPath(DOCKSTORE_TEST_USER_NEXTFLOW_BITBUCKET_WORKFLOW, null, false);\n         final Workflow bitbucketWorkflow = workflowApi.refresh(workflowByPathBitbucket.getId());\n+        Workflow byPathWorkflow = workflowApi.getWorkflowByPath(DOCKSTORE_TEST_USER_NEXTFLOW_BITBUCKET_WORKFLOW, null, false);\n         // There are 3 versions: master, v1.0, and v2.0\n         // master and v2.0 has a nextflow.config file that has description and author, v1.0 does not\n         // v1.0 will pull description from README instead but the others will use nextflow.config\n-        Assert.assertEquals(descriptorDescription, bitbucketWorkflow.getDescription());\n-        bitbucketWorkflow.getWorkflowVersions().forEach(workflowVersion -> {\n+        testWorkflowVersionMetadata(bitbucketWorkflow);\n+        testWorkflowVersionMetadata(byPathWorkflow);\n+        // Purposely mess up the metadata to test if it can be updated through refresh\n+        testingPostgres.runUpdateStatement(\"update version_metadata set email='bad_potato'\");\n+        testingPostgres.runUpdateStatement(\"update version_metadata set author='bad_potato'\");\n+        testingPostgres.runUpdateStatement(\"update version_metadata set description='bad_potato'\");\n+        final Workflow refreshedBitbucketWorkflow = workflowApi.refresh(workflowByPathBitbucket.getId());\n+        byPathWorkflow = workflowApi.getWorkflowByPath(DOCKSTORE_TEST_USER_NEXTFLOW_BITBUCKET_WORKFLOW, null, false);\n+        // This tests if it can fix outdated metadata\n+        testWorkflowVersionMetadata(refreshedBitbucketWorkflow);\n+        testWorkflowVersionMetadata(byPathWorkflow);\n+        List<SourceFile> sourceFileList = new ArrayList<>(\n+            bitbucketWorkflow.getWorkflowVersions().stream().filter(version -> version.getName().equals(\"v2.0\")).findFirst().get()\n+                .getSourceFiles());\n+        Assert.assertEquals(4, sourceFileList.size());\n+    }\n+\n+    /**\n+     * This tests the DOCKSTORE_TEST_USER_NEXTFLOW_BITBUCKET_WORKFLOW metadata is correct after a refresh\n+     * @param workflow  The DOCKSTORE_TEST_USER_NEXTFLOW_BITBUCKET_WORKFLOW workflow\n+     */\n+    private void testWorkflowVersionMetadata(Workflow workflow) {\n+        final String partialReadmeDescription = \"AMPA-NF is a pipeline for assessing the antimicrobial domains of proteins,\";\n+        final String descriptorDescription = \"Fast automated prediction of protein antimicrobial regions\";\n+        Assert.assertEquals(descriptorDescription, workflow.getDescription());\n+        Assert.assertEquals(descriptorDescription, workflow.getDescription());\n+        workflow.getWorkflowVersions().forEach(workflowVersion -> {", "originalCommit": "0e252c435165090d11c22d730894d6799e1fc54d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5c140cd8717fb7ab7ee830653999e9c618bec612", "url": "https://github.com/dockstore/dockstore/commit/5c140cd8717fb7ab7ee830653999e9c618bec612", "message": "Enhance test", "committedDate": "2020-01-13T15:12:08Z", "type": "commit"}]}