{"pr_number": 3930, "pr_title": "filter workflows using criteria builder on TRS endpoint", "pr_createdAt": "2020-11-17T00:38:07Z", "pr_url": "https://github.com/dockstore/dockstore/pull/3930", "timeline": [{"oid": "efff435905bde55e39b51521c9668a43d04acbe1", "url": "https://github.com/dockstore/dockstore/commit/efff435905bde55e39b51521c9668a43d04acbe1", "message": "filter workflows using criteria builder on TRS endpoint", "committedDate": "2020-11-17T00:34:01Z", "type": "commit"}, {"oid": "3871255aab4b29e34e0ce51c456fad3f03e10f9b", "url": "https://github.com/dockstore/dockstore/commit/3871255aab4b29e34e0ce51c456fad3f03e10f9b", "message": "log level: error to info", "committedDate": "2020-11-17T00:38:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg1ODUwNQ==", "url": "https://github.com/dockstore/dockstore/pull/3930#discussion_r524858505", "bodyText": "Pretty sure you can just invoke DescriptorLanguage.convertShortStringToEnum (although you'll need to catch the exception).", "author": "coverbeck", "createdAt": "2020-11-17T03:17:26Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/jdbi/WorkflowDAO.java", "diffHunk": "@@ -175,6 +178,73 @@ public WorkflowDAO(SessionFactory factory) {\n         return filteredWorkflows.size() == 1 ? Optional.of(filteredWorkflows.get(0)) : Optional.empty();\n     }\n \n+    @SuppressWarnings({\"checkstyle:ParameterNumber\"})\n+    public List<Workflow> filterTrsToolsGet(String descriptorType, String registry, String organization, String name, String toolname,\n+            String description, String author, Boolean checker) {\n+\n+        SourceControlConverter converter = new SourceControlConverter();\n+        CriteriaBuilder cb = currentSession().getCriteriaBuilder();\n+        CriteriaQuery<Workflow> q = cb.createQuery(Workflow.class);\n+        Root<Workflow> entryRoot = q.from(Workflow.class);\n+\n+        List<Predicate> predicates = new ArrayList<>();\n+        predicates.add(cb.isTrue(entryRoot.get(\"isPublished\")));\n+        Predicate predicate = cb.isTrue(entryRoot.get(\"isPublished\"));\n+\n+        predicate = andLike(cb, predicate, entryRoot.get(\"organization\"), Optional.ofNullable(organization));\n+        predicate = andLike(cb, predicate, entryRoot.get(\"repository\"), Optional.ofNullable(name));\n+        predicate = andLike(cb, predicate, entryRoot.get(\"workflowName\"), Optional.ofNullable(toolname));\n+        predicate = andLike(cb, predicate, entryRoot.get(\"description\"), Optional.ofNullable(description));\n+        predicate = andLike(cb, predicate, entryRoot.get(\"author\"), Optional.ofNullable(author));\n+        predicate = andEqualDescriptorType(cb, predicate, entryRoot.get(\"descriptorType\"), Optional.ofNullable(descriptorType));\n+\n+        if (registry != null) {\n+            predicate = cb.and(predicate, cb.equal(entryRoot.get(\"sourceControl\"), converter.convertToEntityAttribute(registry)));\n+        }\n+\n+        if (checker != null) {\n+            predicate = cb.and(predicate, cb.isTrue(entryRoot.get(\"isChecker\")));\n+        }\n+\n+        q.where(predicate);\n+        TypedQuery<Workflow> query = currentSession().createQuery(q);\n+\n+        List<Workflow> workflows = query.getResultList();\n+        return workflows;\n+    }\n+\n+    private Predicate andLike(CriteriaBuilder cb, Predicate existingPredicate, Path<String> column, Optional<String> value) {\n+        return value.map(val -> cb.and(existingPredicate, cb.like(column, wildcardLike(val))))\n+                .orElse(existingPredicate);\n+    }\n+\n+    private String wildcardLike(String value) {\n+        return '%' + value + '%';\n+    }\n+\n+    private Predicate andEqualDescriptorType(CriteriaBuilder cb, Predicate existingPredicate, Path<String> column, Optional<String> value) {\n+        DescriptorLanguage descriptorLanguage;\n+        if (value.isPresent()) {\n+            String descriptorValue = value.get();", "originalCommit": "3871255aab4b29e34e0ce51c456fad3f03e10f9b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg1OTMzNw==", "url": "https://github.com/dockstore/dockstore/pull/3930#discussion_r524859337", "bodyText": "This would be a little bit hackish, but if the descriptorType is NextFlow or Galaxy, we could skip this step. You could hard-code, with a TODO, although ideally DescriptorLanguage would have something that indicates whether the language supports tools (not sure if that has API implications though).", "author": "coverbeck", "createdAt": "2020-11-17T03:20:22Z", "path": "dockstore-webservice/src/main/java/io/openapi/api/impl/ToolsApiServiceImpl.java", "diffHunk": "@@ -292,20 +292,16 @@ public Response toolsGet(String id, String alias, String toolClass, String descr\n                 all.addAll(toolDAO.findAllPublished());", "originalCommit": "3871255aab4b29e34e0ce51c456fad3f03e10f9b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg2MTA5MQ==", "url": "https://github.com/dockstore/dockstore/pull/3930#discussion_r524861091", "bodyText": "I don't think you need this nor the previous line.", "author": "coverbeck", "createdAt": "2020-11-17T03:26:55Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/jdbi/WorkflowDAO.java", "diffHunk": "@@ -175,6 +178,73 @@ public WorkflowDAO(SessionFactory factory) {\n         return filteredWorkflows.size() == 1 ? Optional.of(filteredWorkflows.get(0)) : Optional.empty();\n     }\n \n+    @SuppressWarnings({\"checkstyle:ParameterNumber\"})\n+    public List<Workflow> filterTrsToolsGet(String descriptorType, String registry, String organization, String name, String toolname,\n+            String description, String author, Boolean checker) {\n+\n+        SourceControlConverter converter = new SourceControlConverter();\n+        CriteriaBuilder cb = currentSession().getCriteriaBuilder();\n+        CriteriaQuery<Workflow> q = cb.createQuery(Workflow.class);\n+        Root<Workflow> entryRoot = q.from(Workflow.class);\n+\n+        List<Predicate> predicates = new ArrayList<>();\n+        predicates.add(cb.isTrue(entryRoot.get(\"isPublished\")));", "originalCommit": "3871255aab4b29e34e0ce51c456fad3f03e10f9b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI2MTY5Ng==", "url": "https://github.com/dockstore/dockstore/pull/3930#discussion_r525261696", "bodyText": "To potentially clarify, I think you need this in general (the query should only return published workflows) but I think this is currently unused which means that this might be returning unpublished content which is not good.", "author": "denis-yuen", "createdAt": "2020-11-17T15:40:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg2MTA5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTMyNTMwMQ==", "url": "https://github.com/dockstore/dockstore/pull/3930#discussion_r525325301", "bodyText": "As I read it, the next line does do the isPublished, so I think these lines are redundant (and not even used)", "author": "coverbeck", "createdAt": "2020-11-17T16:59:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg2MTA5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg2MTcyOA==", "url": "https://github.com/dockstore/dockstore/pull/3930#discussion_r524861728", "bodyText": "For line 47/51, was like this, but message is wrong; not a token type but a SourceControl", "author": "coverbeck", "createdAt": "2020-11-17T03:29:30Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/core/SourceControlConverter.java", "diffHunk": "@@ -39,6 +39,10 @@ public String convertToDatabaseColumn(SourceControl attribute) {\n \n     @Override\n     public SourceControl convertToEntityAttribute(String dbData) {\n+        if (dbData == null || dbData.isEmpty()) {\n+            LOG.info(\"Cannot convert null or empty source control\");\n+            return null;\n+        }", "originalCommit": "3871255aab4b29e34e0ce51c456fad3f03e10f9b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg2MjAyOA==", "url": "https://github.com/dockstore/dockstore/pull/3930#discussion_r524862028", "bodyText": "Suggest finals, except for line 192, which you can't.", "author": "coverbeck", "createdAt": "2020-11-17T03:30:33Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/jdbi/WorkflowDAO.java", "diffHunk": "@@ -175,6 +178,73 @@ public WorkflowDAO(SessionFactory factory) {\n         return filteredWorkflows.size() == 1 ? Optional.of(filteredWorkflows.get(0)) : Optional.empty();\n     }\n \n+    @SuppressWarnings({\"checkstyle:ParameterNumber\"})\n+    public List<Workflow> filterTrsToolsGet(String descriptorType, String registry, String organization, String name, String toolname,\n+            String description, String author, Boolean checker) {\n+\n+        SourceControlConverter converter = new SourceControlConverter();", "originalCommit": "3871255aab4b29e34e0ce51c456fad3f03e10f9b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTMzMDM5OA==", "url": "https://github.com/dockstore/dockstore/pull/3930#discussion_r525330398", "bodyText": "On further reflection, I don't think this is right. If the user specifies a descriptorType, you should return all the the workflows that match the descriptorType. If none match, e.g., because the descriptorType doesn't exist, then the query should return no results. Instead you're ignoring the query element.\nI think you should short-circuit things and move this (or the shortened version) to the beginning of ToolsApiServiceImpl.toolsGet -- if there is a descriptorType query param and it doesn't resolve to a valid descriptor, just return an empty list.\nIn addition, you could use that DescriptorType to skip tools per my other suggestion.", "author": "coverbeck", "createdAt": "2020-11-17T17:04:58Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/jdbi/WorkflowDAO.java", "diffHunk": "@@ -175,6 +178,73 @@ public WorkflowDAO(SessionFactory factory) {\n         return filteredWorkflows.size() == 1 ? Optional.of(filteredWorkflows.get(0)) : Optional.empty();\n     }\n \n+    @SuppressWarnings({\"checkstyle:ParameterNumber\"})\n+    public List<Workflow> filterTrsToolsGet(String descriptorType, String registry, String organization, String name, String toolname,\n+            String description, String author, Boolean checker) {\n+\n+        SourceControlConverter converter = new SourceControlConverter();\n+        CriteriaBuilder cb = currentSession().getCriteriaBuilder();\n+        CriteriaQuery<Workflow> q = cb.createQuery(Workflow.class);\n+        Root<Workflow> entryRoot = q.from(Workflow.class);\n+\n+        List<Predicate> predicates = new ArrayList<>();\n+        predicates.add(cb.isTrue(entryRoot.get(\"isPublished\")));\n+        Predicate predicate = cb.isTrue(entryRoot.get(\"isPublished\"));\n+\n+        predicate = andLike(cb, predicate, entryRoot.get(\"organization\"), Optional.ofNullable(organization));\n+        predicate = andLike(cb, predicate, entryRoot.get(\"repository\"), Optional.ofNullable(name));\n+        predicate = andLike(cb, predicate, entryRoot.get(\"workflowName\"), Optional.ofNullable(toolname));\n+        predicate = andLike(cb, predicate, entryRoot.get(\"description\"), Optional.ofNullable(description));\n+        predicate = andLike(cb, predicate, entryRoot.get(\"author\"), Optional.ofNullable(author));\n+        predicate = andEqualDescriptorType(cb, predicate, entryRoot.get(\"descriptorType\"), Optional.ofNullable(descriptorType));\n+\n+        if (registry != null) {\n+            predicate = cb.and(predicate, cb.equal(entryRoot.get(\"sourceControl\"), converter.convertToEntityAttribute(registry)));\n+        }\n+\n+        if (checker != null) {\n+            predicate = cb.and(predicate, cb.isTrue(entryRoot.get(\"isChecker\")));\n+        }\n+\n+        q.where(predicate);\n+        TypedQuery<Workflow> query = currentSession().createQuery(q);\n+\n+        List<Workflow> workflows = query.getResultList();\n+        return workflows;\n+    }\n+\n+    private Predicate andLike(CriteriaBuilder cb, Predicate existingPredicate, Path<String> column, Optional<String> value) {\n+        return value.map(val -> cb.and(existingPredicate, cb.like(column, wildcardLike(val))))\n+                .orElse(existingPredicate);\n+    }\n+\n+    private String wildcardLike(String value) {\n+        return '%' + value + '%';\n+    }\n+\n+    private Predicate andEqualDescriptorType(CriteriaBuilder cb, Predicate existingPredicate, Path<String> column, Optional<String> value) {\n+        DescriptorLanguage descriptorLanguage;\n+        if (value.isPresent()) {\n+            String descriptorValue = value.get();\n+            if (\"galaxy\".equalsIgnoreCase(descriptorValue)) {\n+                descriptorLanguage = DescriptorLanguage.GXFORMAT2;\n+            } else if (descriptorValue.equals(DescriptorLanguage.CWL.getShortName())) {\n+                descriptorLanguage = DescriptorLanguage.CWL;\n+            } else if (descriptorValue.equals(DescriptorLanguage.WDL.getShortName())) {\n+                descriptorLanguage = DescriptorLanguage.WDL;\n+            } else if (descriptorValue.equals(DescriptorLanguage.NEXTFLOW.getShortName())) {\n+                descriptorLanguage = DescriptorLanguage.NEXTFLOW;\n+            } else if (descriptorValue.equals(DescriptorLanguage.SERVICE.getShortName())) {\n+                descriptorLanguage = DescriptorLanguage.SERVICE;\n+            } else {\n+                LOG.info(\"Cannot match descriptor type\");\n+                return existingPredicate;", "originalCommit": "3871255aab4b29e34e0ce51c456fad3f03e10f9b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "979b31a706839a956e36f79d32ef487ce01cd81f", "url": "https://github.com/dockstore/dockstore/commit/979b31a706839a956e36f79d32ef487ce01cd81f", "message": "Don't return entries is descriptor language isn't found, use final, only add tools if wdl/cwl", "committedDate": "2020-11-19T00:09:39Z", "type": "commit"}, {"oid": "b4b892caa6c9ac7f8793aebd4b7f75de6ce3d536", "url": "https://github.com/dockstore/dockstore/commit/b4b892caa6c9ac7f8793aebd4b7f75de6ce3d536", "message": "checkstyle", "committedDate": "2020-11-19T00:24:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU3MjQ1MA==", "url": "https://github.com/dockstore/dockstore/pull/3930#discussion_r526572450", "bodyText": "This is nit-picking, but this is a very long condition and hard to understand\n\nYou already know if the descriptorLanguage has been found by virtue of it being null or not. I don't think you need the descriptorLanguageFound variable, although you can argue it enhances readability.\nWith enums, you can use ==\n\nI would suggest two nested if statements for readability. But that's my bias.", "author": "coverbeck", "createdAt": "2020-11-19T03:34:12Z", "path": "dockstore-webservice/src/main/java/io/openapi/api/impl/ToolsApiServiceImpl.java", "diffHunk": "@@ -288,24 +289,41 @@ public Response toolsGet(String id, String alias, String toolClass, String descr\n         } else if (alias != null) {\n             all.add(toolDAO.getGenericEntryByAlias(alias));\n         } else {\n-            if (toolClass == null || COMMAND_LINE_TOOL.equalsIgnoreCase(toolClass)) {\n+            // If there is no matching descriptor language, then do not add any tools or workflows.\n+            DescriptorLanguage descriptorLanguage = null;\n+            boolean descriptorLanguageFound = true;\n+\n+            // Tricky case for GALAXY because it doesn't match the rules of the other languages\n+            if (\"galaxy\".equalsIgnoreCase(descriptorType)) {\n+                descriptorType = DescriptorLanguage.GXFORMAT2.getShortName();\n+            }\n+\n+            if (descriptorType != null) {\n+                try {\n+                    descriptorLanguage = DescriptorLanguage.convertShortStringToEnum(descriptorType);\n+                } catch (UnsupportedOperationException ex) {\n+                    LOG.info(ex.getMessage());\n+                    descriptorLanguageFound = false;\n+                }\n+            }\n+\n+            // TODO: Have DescriptorLanguage indicate whether the language supports tools. Make this less hack-ish\n+            // Only WDL and CWL tools are supported on Dockstore.\n+            if (descriptorLanguageFound && (toolClass == null || COMMAND_LINE_TOOL.equalsIgnoreCase(toolClass))", "originalCommit": "b4b892caa6c9ac7f8793aebd4b7f75de6ce3d536", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA5MTc1MA==", "url": "https://github.com/dockstore/dockstore/pull/3930#discussion_r527091750", "bodyText": "Yeah the name and how it's being used doesn't match completely.\nThe user provides the descriptorType which could be null,  a string that matches one of the languages we support, or a string that doesn't match. I set descriptorLanguageFound to be true unless we are unable to match a string with the language we support. So, if they didn't provide one (null) or it matches, it will stay true and the tools/workflows will be added.\nI will try to improve the readability since it is confusing.", "author": "NatalieEO", "createdAt": "2020-11-19T18:04:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU3MjQ1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzEwNjAwOA==", "url": "https://github.com/dockstore/dockstore/pull/3930#discussion_r527106008", "bodyText": "Ah, I see, so I was wrong about line 316 -- it would still execute...\nI would suggest if there is a an invalid descriptor language, just short-circuit and return Collections.emptyList(). Then it simplifies your logic downstream.", "author": "coverbeck", "createdAt": "2020-11-19T18:26:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU3MjQ1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU3MzI3OA==", "url": "https://github.com/dockstore/dockstore/pull/3930#discussion_r526573278", "bodyText": "This could go inside the if on line 301, where you know descriptorType is not null. More from a readability perspective", "author": "coverbeck", "createdAt": "2020-11-19T03:36:56Z", "path": "dockstore-webservice/src/main/java/io/openapi/api/impl/ToolsApiServiceImpl.java", "diffHunk": "@@ -288,24 +289,41 @@ public Response toolsGet(String id, String alias, String toolClass, String descr\n         } else if (alias != null) {\n             all.add(toolDAO.getGenericEntryByAlias(alias));\n         } else {\n-            if (toolClass == null || COMMAND_LINE_TOOL.equalsIgnoreCase(toolClass)) {\n+            // If there is no matching descriptor language, then do not add any tools or workflows.\n+            DescriptorLanguage descriptorLanguage = null;\n+            boolean descriptorLanguageFound = true;\n+\n+            // Tricky case for GALAXY because it doesn't match the rules of the other languages\n+            if (\"galaxy\".equalsIgnoreCase(descriptorType)) {", "originalCommit": "b4b892caa6c9ac7f8793aebd4b7f75de6ce3d536", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU3NTA5Nw==", "url": "https://github.com/dockstore/dockstore/pull/3930#discussion_r526575097", "bodyText": "You always want to do this even if descriptorLanguage is not found.", "author": "coverbeck", "createdAt": "2020-11-19T03:43:54Z", "path": "dockstore-webservice/src/main/java/io/openapi/api/impl/ToolsApiServiceImpl.java", "diffHunk": "@@ -288,24 +289,41 @@ public Response toolsGet(String id, String alias, String toolClass, String descr\n         } else if (alias != null) {\n             all.add(toolDAO.getGenericEntryByAlias(alias));\n         } else {\n-            if (toolClass == null || COMMAND_LINE_TOOL.equalsIgnoreCase(toolClass)) {\n+            // If there is no matching descriptor language, then do not add any tools or workflows.\n+            DescriptorLanguage descriptorLanguage = null;\n+            boolean descriptorLanguageFound = true;\n+\n+            // Tricky case for GALAXY because it doesn't match the rules of the other languages\n+            if (\"galaxy\".equalsIgnoreCase(descriptorType)) {\n+                descriptorType = DescriptorLanguage.GXFORMAT2.getShortName();\n+            }\n+\n+            if (descriptorType != null) {\n+                try {\n+                    descriptorLanguage = DescriptorLanguage.convertShortStringToEnum(descriptorType);\n+                } catch (UnsupportedOperationException ex) {\n+                    LOG.info(ex.getMessage());\n+                    descriptorLanguageFound = false;\n+                }\n+            }\n+\n+            // TODO: Have DescriptorLanguage indicate whether the language supports tools. Make this less hack-ish\n+            // Only WDL and CWL tools are supported on Dockstore.\n+            if (descriptorLanguageFound && (toolClass == null || COMMAND_LINE_TOOL.equalsIgnoreCase(toolClass))\n+                    && (DescriptorLanguage.WDL.equals(descriptorLanguage) || DescriptorLanguage.CWL.equals(descriptorLanguage) || descriptorType == null)) {\n                 all.addAll(toolDAO.findAllPublished());\n             }\n-            if (toolClass == null || WORKFLOW.equalsIgnoreCase(toolClass)) {\n-                all.addAll(workflowDAO.findAllPublished());\n+            if (descriptorLanguageFound && (toolClass == null || WORKFLOW.equalsIgnoreCase(toolClass))) {", "originalCommit": "b4b892caa6c9ac7f8793aebd4b7f75de6ce3d536", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "04807641af8d9c86aa665d0d9b404b57c66f0653", "url": "https://github.com/dockstore/dockstore/commit/04807641af8d9c86aa665d0d9b404b57c66f0653", "message": "make less confusing, add test", "committedDate": "2020-11-20T00:04:39Z", "type": "commit"}]}