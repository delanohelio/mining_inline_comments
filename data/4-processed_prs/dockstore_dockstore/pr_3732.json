{"pr_number": 3732, "pr_title": "Fix/seab 1502/lazy versions", "pr_createdAt": "2020-08-11T21:58:46Z", "pr_url": "https://github.com/dockstore/dockstore/pull/3732", "timeline": [{"oid": "0c7b0979a9a7e349c85ba89df3fb2d72c4e32912", "url": "https://github.com/dockstore/dockstore/commit/0c7b0979a9a7e349c85ba89df3fb2d72c4e32912", "message": "See what breaks", "committedDate": "2020-08-06T19:38:18Z", "type": "commit"}, {"oid": "e378a8abc758daea9b36c7bb2f8198267f146ac2", "url": "https://github.com/dockstore/dockstore/commit/e378a8abc758daea9b36c7bb2f8198267f146ac2", "message": "Fix some tests", "committedDate": "2020-08-06T21:16:04Z", "type": "commit"}, {"oid": "edd5dbc8c183ca79948a8d13069ae1c07864f2d0", "url": "https://github.com/dockstore/dockstore/commit/edd5dbc8c183ca79948a8d13069ae1c07864f2d0", "message": "Fix?", "committedDate": "2020-08-07T01:06:56Z", "type": "commit"}, {"oid": "a50a97ba37f6c69f34910b0a253092942091ac50", "url": "https://github.com/dockstore/dockstore/commit/a50a97ba37f6c69f34910b0a253092942091ac50", "message": "Fix", "committedDate": "2020-08-07T01:49:37Z", "type": "commit"}, {"oid": "a83885848615bd7c06c7342d9d4ac850188e3c26", "url": "https://github.com/dockstore/dockstore/commit/a83885848615bd7c06c7342d9d4ac850188e3c26", "message": "Revert weird removal", "committedDate": "2020-08-07T17:13:15Z", "type": "commit"}, {"oid": "a9dde9c64626fee677b7c9606c7e1fc510a4831d", "url": "https://github.com/dockstore/dockstore/commit/a9dde9c64626fee677b7c9606c7e1fc510a4831d", "message": "Increase size, add firstResult", "committedDate": "2020-08-07T17:13:48Z", "type": "commit"}, {"oid": "eeb54aa22322f7f87fcef203b19f7b53a3335fed", "url": "https://github.com/dockstore/dockstore/commit/eeb54aa22322f7f87fcef203b19f7b53a3335fed", "message": "Fix checkstyle", "committedDate": "2020-08-07T17:22:27Z", "type": "commit"}, {"oid": "fe222dc4291113f8d95e9acbc7200638e70f3442", "url": "https://github.com/dockstore/dockstore/commit/fe222dc4291113f8d95e9acbc7200638e70f3442", "message": "Add comment about pagination limit", "committedDate": "2020-08-07T19:28:13Z", "type": "commit"}, {"oid": "910b6df33bc58c634b64c2f83d99a79bbb61f967", "url": "https://github.com/dockstore/dockstore/commit/910b6df33bc58c634b64c2f83d99a79bbb61f967", "message": "Add versionName query parameter", "committedDate": "2020-08-10T21:29:40Z", "type": "commit"}, {"oid": "051691622508c1d20740a1053d67746aff339ad4", "url": "https://github.com/dockstore/dockstore/commit/051691622508c1d20740a1053d67746aff339ad4", "message": "Don't paginate unnecessary endpoints", "committedDate": "2020-08-11T14:57:52Z", "type": "commit"}, {"oid": "08b33615dc3abf8e86f71a520a9e1b14471049e2", "url": "https://github.com/dockstore/dockstore/commit/08b33615dc3abf8e86f71a520a9e1b14471049e2", "message": "Fix tests", "committedDate": "2020-08-11T16:06:06Z", "type": "commit"}, {"oid": "71456015e7fb55ddb9fa0c2094689c4356c69059", "url": "https://github.com/dockstore/dockstore/commit/71456015e7fb55ddb9fa0c2094689c4356c69059", "message": "Handle unknown version name", "committedDate": "2020-08-11T20:21:32Z", "type": "commit"}, {"oid": "c69b1ce05e27c89cc391e1ab744a5950d8ea0ca0", "url": "https://github.com/dockstore/dockstore/commit/c69b1ce05e27c89cc391e1ab744a5950d8ea0ca0", "message": "Move queries around, use named queries", "committedDate": "2020-08-11T21:39:08Z", "type": "commit"}, {"oid": "aebd0d56ca60a16e80a1c1d4285b538479273546", "url": "https://github.com/dockstore/dockstore/commit/aebd0d56ca60a16e80a1c1d4285b538479273546", "message": "Update openapi/swagger", "committedDate": "2020-08-11T21:39:42Z", "type": "commit"}, {"oid": "2b30c4322e4930a762a63f99488ffc17053a6f07", "url": "https://github.com/dockstore/dockstore/commit/2b30c4322e4930a762a63f99488ffc17053a6f07", "message": "Fix", "committedDate": "2020-08-11T22:00:05Z", "type": "commit"}, {"oid": "825c5b903e3f2724d62a56e6f46f3f862ee59f38", "url": "https://github.com/dockstore/dockstore/commit/825c5b903e3f2724d62a56e6f46f3f862ee59f38", "message": "Fix queries", "committedDate": "2020-08-12T14:55:03Z", "type": "commit"}, {"oid": "55ef1aa802b407bd9b971f9a50054ead9c64353a", "url": "https://github.com/dockstore/dockstore/commit/55ef1aa802b407bd9b971f9a50054ead9c64353a", "message": "One last namedQuery", "committedDate": "2020-08-12T17:00:45Z", "type": "commit"}, {"oid": "be439400706248d7fce19282761515c71a760840", "url": "https://github.com/dockstore/dockstore/commit/be439400706248d7fce19282761515c71a760840", "message": "Fix", "committedDate": "2020-08-12T17:01:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUyMzU5Ng==", "url": "https://github.com/dockstore/dockstore/pull/3732#discussion_r469523596", "bodyText": "200 should be constant", "author": "denis-yuen", "createdAt": "2020-08-12T20:32:40Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/WorkflowResource.java", "diffHunk": "@@ -931,11 +931,29 @@ public Workflow getWorkflowByPath(@ApiParam(hidden = true) @Parameter(hidden = t\n         Workflow workflow = workflowDAO.findByPath(path, false, targetClass).orElse(null);\n         checkEntry(workflow);\n         checkCanRead(user, workflow);\n-\n-        initializeAdditionalFields(include, workflow);\n         Hibernate.initialize(workflow.getAliases());\n+        initializeAdditionalFields(include, workflow);\n         return workflow;\n     }\n+    @SuppressWarnings(\"checkstyle:MagicNumber\")\n+    private void setWorkflowVersionSubset(Workflow workflow, String include, String versionName) {\n+        sessionFactory.getCurrentSession().detach(workflow);\n+\n+        // Almost all observed workflows have under 200 version, this number should be lowered once the frontend actually supports pagination\n+        List<WorkflowVersion> ids = this.workflowVersionDAO.getWorkflowVersionsByWorkflowId(workflow.getId(), 200, 0);", "originalCommit": "be439400706248d7fce19282761515c71a760840", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUyNzIyNQ==", "url": "https://github.com/dockstore/dockstore/pull/3732#discussion_r469527225", "bodyText": "Think you can assume this is one or none due to \"unique_workflowversion_names\" UNIQUE CONSTRAINT, btree (parentid, name)", "author": "denis-yuen", "createdAt": "2020-08-12T20:35:31Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/jdbi/WorkflowVersionDAO.java", "diffHunk": "@@ -31,4 +34,20 @@ public WorkflowVersionDAO(SessionFactory sessionFactory) {\n     public WorkflowVersion findByAlias(String alias) {\n         return uniqueResult(namedQuery(\"io.dockstore.webservice.core.WorkflowVersion.getByAlias\").setParameter(\"alias\", alias));\n     }\n+\n+    public List<WorkflowVersion> getWorkflowVersionsByWorkflowId(Long workflowId, int size, int firstResult) {\n+        Query query = namedQuery(\"io.dockstore.webservice.core.WorkflowVersion.getByWorkflowId\");\n+        query.setParameter(\"id\", workflowId);\n+        query.setFirstResult(firstResult);\n+        query.setMaxResults(size);\n+        List<WorkflowVersion> workflowVersionIds = query.getResultList();\n+        return workflowVersionIds;\n+    }\n+\n+    public List<WorkflowVersion> getWorkflowVersionByWorkflowIdAndVersionName(Long workflowId, String name) {", "originalCommit": "be439400706248d7fce19282761515c71a760840", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUzNjc0OA==", "url": "https://github.com/dockstore/dockstore/pull/3732#discussion_r469536748", "bodyText": "throws exception when it's none and using singleResult, avoiding exception by using list. it's what i had originally 7145601  i prefered this to catching the exception", "author": "garyluu", "createdAt": "2020-08-12T20:46:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUyNzIyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU0NzE0NQ==", "url": "https://github.com/dockstore/dockstore/pull/3732#discussion_r469547145", "bodyText": "Double-check classpath maybe, I have\n\tdefault R getSingleResult() {\n\t\treturn uniqueResult();\n\t}\n\nwhich goes to\n\t/**\n\t * Convenience method to return a single instance that matches\n\t * the query, or {@code null} if the query returns no results.\n\t *\n\t * @return the single result or <tt>null</tt>\n\t *\n\t * @throws NonUniqueResultException if there is more than one matching result\n\t */\n\nin hibernate-core:5.2.8-Final", "author": "denis-yuen", "createdAt": "2020-08-12T21:06:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUyNzIyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU3ODIxOQ==", "url": "https://github.com/dockstore/dockstore/pull/3732#discussion_r469578219", "bodyText": "will try again", "author": "garyluu", "createdAt": "2020-08-12T22:18:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUyNzIyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU4NTcyNw==", "url": "https://github.com/dockstore/dockstore/pull/3732#discussion_r469585727", "bodyText": "i still don't see that, the only place I see that comment is from the deprecated https://github.com/hibernate/hibernate-orm/blob/5.2.8/hibernate-core/src/main/java/org/hibernate/Query.java\nthough uniqueResult will work", "author": "garyluu", "createdAt": "2020-08-12T22:38:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUyNzIyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUyODIyNg==", "url": "https://github.com/dockstore/dockstore/pull/3732#discussion_r469528226", "bodyText": "If I understand correctly, this is only used internally so should not be exposed to API users", "author": "denis-yuen", "createdAt": "2020-08-12T20:36:21Z", "path": "dockstore-webservice/src/main/resources/openapi3/openapi.yaml", "diffHunk": "@@ -1517,6 +1517,12 @@ components:\n             $ref: '#/components/schemas/WorkflowVersion'\n           type: array\n           uniqueItems: true\n+        workflowVersionsOverride:", "originalCommit": "be439400706248d7fce19282761515c71a760840", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "741edec869e2a740a630d6146387921c76e61986", "url": "https://github.com/dockstore/dockstore/commit/741edec869e2a740a630d6146387921c76e61986", "message": "PR changes", "committedDate": "2020-08-12T20:48:27Z", "type": "commit"}, {"oid": "1e91f531532e3fb03669d7b0f09a0277e8155bfb", "url": "https://github.com/dockstore/dockstore/commit/1e91f531532e3fb03669d7b0f09a0277e8155bfb", "message": "Use unique result", "committedDate": "2020-08-12T22:45:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU5MjA5MQ==", "url": "https://github.com/dockstore/dockstore/pull/3732#discussion_r469592091", "bodyText": "Does it make a difference if you do select count(v.id)..., or is JPA already smart enough not to load all the  version objects?", "author": "coverbeck", "createdAt": "2020-08-12T22:56:17Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/core/Version.java", "diffHunk": "@@ -73,7 +73,8 @@\n \n // Ensure that the version requested belongs to a workflow a user has access to.\n @NamedQueries({\n-        @NamedQuery(name = \"io.dockstore.webservice.core.Version.findVersionInEntry\", query = \"SELECT v FROM Version v WHERE :entryId = v.parent.id AND :versionId = v.id\")\n+        @NamedQuery(name = \"io.dockstore.webservice.core.Version.findVersionInEntry\", query = \"SELECT v FROM Version v WHERE :entryId = v.parent.id AND :versionId = v.id\"),\n+        @NamedQuery(name = \"io.dockstore.webservice.core.Version.getCountByEntryId\", query = \"SELECT Count(v) FROM Version v WHERE v.parent.id = :id\")", "originalCommit": "1e91f531532e3fb03669d7b0f09a0277e8155bfb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU5NTc5MA==", "url": "https://github.com/dockstore/dockstore/pull/3732#discussion_r469595790", "bodyText": "i'll double check", "author": "garyluu", "createdAt": "2020-08-12T23:07:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU5MjA5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYwMzIzMw==", "url": "https://github.com/dockstore/dockstore/pull/3732#discussion_r469603233", "bodyText": "the resulting sql is identical:\norg.hibernate.SQL: /* io.dockstore.webservice.core.Version.getCountByEntryId */ select count(version0_.id) as col_0_0_ from ( select id, commitID, dbCreateDate, dbUpdateDate, dirtyBit, frozen, name, reference, referenceType, valid, parentid, versionEditor_id, automated, cwlPath, dockerfilePath, imageId, lastBuilt, size, wdlPath, null::varchar as dagJson, null::boolean as isLegacyVersion, null::timestamp as lastModified, null::int4 as subClass, null::varchar as toolTableJson, null::varchar as workflowPath, 1 as clazz_ from tag union all select id, commitID, dbCreateDate, dbUpdateDate, dirtyBit, frozen, name, reference, referenceType, valid, parentid, versionEditor_id, null::boolean as automated, null::varchar as cwlPath, null::varchar as dockerfilePath, null::varchar as imageId, null::timestamp as lastBuilt, null::int8 as size, null::varchar as wdlPath, dagJson, isLegacyVersion, lastModified, subClass, toolTableJson, workflowPath, 2 as clazz_ from workflowversion ) version0_ where version0_.parentid=?", "author": "garyluu", "createdAt": "2020-08-12T23:30:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU5MjA5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYyMDk1OQ==", "url": "https://github.com/dockstore/dockstore/pull/3732#discussion_r469620959", "bodyText": "That's lame.  Is that all of the SQL for this, or are they also fetching all the sourcefiles subsequently, since those aren't lazy loaded in this branch?\nYou'd probably need something like select count(*) from (select v.id from Version v where... and I'm not even sure you can do a nested query like that in JPQL.\nJust commenting, I did approve.", "author": "coverbeck", "createdAt": "2020-08-13T00:21:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU5MjA5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk4NzkwNw==", "url": "https://github.com/dockstore/dockstore/pull/3732#discussion_r469987907", "bodyText": "i have a feeling that would make it worse", "author": "garyluu", "createdAt": "2020-08-13T14:20:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU5MjA5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU5NTQ5OQ==", "url": "https://github.com/dockstore/dockstore/pull/3732#discussion_r469595499", "bodyText": "So if you detach, it executes for the versions that are present and doesn't fetch any more? Sounds like it, just wanted to confirm.", "author": "coverbeck", "createdAt": "2020-08-12T23:06:32Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/core/Entry.java", "diffHunk": "@@ -455,12 +455,14 @@ public void setMetadataFromVersion(Version version) {\n         this.email = version.getEmail();\n     }\n \n+    // This will force EAGER workflowVersions UNLESS the entry entity was detached prior to endpoint return", "originalCommit": "1e91f531532e3fb03669d7b0f09a0277e8155bfb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU5NjI4Nw==", "url": "https://github.com/dockstore/dockstore/pull/3732#discussion_r469596287", "bodyText": "From what I can tell, it's lazy loaded all the way to the end of the resource endpoint function.  when it's about to serialize, it checks that it needs to get the versions (in order to figure out the output/input file formats), and then it loads it. so yes, in the case i detach, it doesn't try to load it during the usual time", "author": "garyluu", "createdAt": "2020-08-12T23:08:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU5NTQ5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYwNjEwNA==", "url": "https://github.com/dockstore/dockstore/pull/3732#discussion_r469606104", "bodyText": "do these need to be Long? these cannot be null", "author": "denis-yuen", "createdAt": "2020-08-12T23:39:51Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/jdbi/WorkflowVersionDAO.java", "diffHunk": "@@ -31,4 +34,20 @@ public WorkflowVersionDAO(SessionFactory sessionFactory) {\n     public WorkflowVersion findByAlias(String alias) {\n         return uniqueResult(namedQuery(\"io.dockstore.webservice.core.WorkflowVersion.getByAlias\").setParameter(\"alias\", alias));\n     }\n+\n+    public List<WorkflowVersion> getWorkflowVersionsByWorkflowId(Long workflowId, int size, int firstResult) {", "originalCommit": "1e91f531532e3fb03669d7b0f09a0277e8155bfb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYwNjEzOA==", "url": "https://github.com/dockstore/dockstore/pull/3732#discussion_r469606138", "bodyText": "ditto", "author": "denis-yuen", "createdAt": "2020-08-12T23:39:56Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/jdbi/WorkflowVersionDAO.java", "diffHunk": "@@ -31,4 +34,20 @@ public WorkflowVersionDAO(SessionFactory sessionFactory) {\n     public WorkflowVersion findByAlias(String alias) {\n         return uniqueResult(namedQuery(\"io.dockstore.webservice.core.WorkflowVersion.getByAlias\").setParameter(\"alias\", alias));\n     }\n+\n+    public List<WorkflowVersion> getWorkflowVersionsByWorkflowId(Long workflowId, int size, int firstResult) {\n+        Query query = namedQuery(\"io.dockstore.webservice.core.WorkflowVersion.getByWorkflowId\");\n+        query.setParameter(\"id\", workflowId);\n+        query.setFirstResult(firstResult);\n+        query.setMaxResults(size);\n+        List<WorkflowVersion> workflowVersionIds = query.getResultList();\n+        return workflowVersionIds;\n+    }\n+\n+    public WorkflowVersion getWorkflowVersionByWorkflowIdAndVersionName(Long workflowId, String name) {", "originalCommit": "1e91f531532e3fb03669d7b0f09a0277e8155bfb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYwNzA4OQ==", "url": "https://github.com/dockstore/dockstore/pull/3732#discussion_r469607089", "bodyText": "ditto for parameter\nfor the return type, might want to consider Optional<Long> to make the caller handle the case when the result is null (the entry doesn't exist) which is distinct from 0 (entry exists, but legitimately has no versions)", "author": "denis-yuen", "createdAt": "2020-08-12T23:43:16Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/jdbi/VersionDAO.java", "diffHunk": "@@ -44,4 +45,11 @@ public void delete(T version) {\n     public Version<T> findVersionInEntry(Long entryId, Long versionId) {\n         return uniqueResult(namedQuery(\"io.dockstore.webservice.core.Version.findVersionInEntry\").setParameter(\"entryId\", entryId).setParameter(\"versionId\", versionId));\n     }\n+\n+    // Currently not used for anything, will be used for paginated versions\n+    public Long getVersionsCount(Long entryId) {", "originalCommit": "1e91f531532e3fb03669d7b0f09a0277e8155bfb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c27a5bf392f45f219f00b9bc0d7491bcc5d78b58", "url": "https://github.com/dockstore/dockstore/commit/c27a5bf392f45f219f00b9bc0d7491bcc5d78b58", "message": "Change to long", "committedDate": "2020-08-12T23:58:50Z", "type": "commit"}]}