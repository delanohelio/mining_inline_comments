{"pr_number": 3376, "pr_title": "Display ORCID for organization members", "pr_createdAt": "2020-04-03T21:36:16Z", "pr_url": "https://github.com/dockstore/dockstore/pull/3376", "timeline": [{"oid": "958868a2fd77c4f70e12748f1b2933ce42e36731", "url": "https://github.com/dockstore/dockstore/commit/958868a2fd77c4f70e12748f1b2933ce42e36731", "message": "#3371 store user ORCID in enduser table when linked", "committedDate": "2020-04-03T17:14:16Z", "type": "commit"}, {"oid": "d475d92618e4728db86b0dbbdb183e21bb5afe2c", "url": "https://github.com/dockstore/dockstore/commit/d475d92618e4728db86b0dbbdb183e21bb5afe2c", "message": "add new API yamls so I can run the UI using this branch", "committedDate": "2020-04-03T18:30:31Z", "type": "commit"}, {"oid": "59d2d0a809c2c40367d2fc2756df64d9a15c2b2f", "url": "https://github.com/dockstore/dockstore/commit/59d2d0a809c2c40367d2fc2756df64d9a15c2b2f", "message": "persist to database working", "committedDate": "2020-04-03T20:31:42Z", "type": "commit"}, {"oid": "c3f9296ca6e84cf4bda3d743fd5c282666bbd64d", "url": "https://github.com/dockstore/dockstore/commit/c3f9296ca6e84cf4bda3d743fd5c282666bbd64d", "message": "store ORCID in user profile as well", "committedDate": "2020-04-03T21:31:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM0OTE2Ng==", "url": "https://github.com/dockstore/dockstore/pull/3376#discussion_r403349166", "bodyText": "Included two possible solutions here. First is adding an ORCID column to the enduser table and storing it there. Second is storing it in a user profile.", "author": "emlys", "createdAt": "2020-04-03T21:38:43Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/TokenResource.java", "diffHunk": "@@ -658,15 +659,29 @@ public Token addOrcidToken(@ApiParam(hidden = true) @Parameter(hidden = true, na\n             accessToken = tokenResponse.getAccessToken();\n             refreshToken = tokenResponse.getRefreshToken();\n \n-            // ORCID API returns the user's ORCID username in the \"name\" property\n+            // ORCID API returns the username and orcid id along with the tokens\n+            // get them to store in the token and user tables\n             username = tokenResponse.get(\"name\").toString();\n+            orcid = tokenResponse.get(\"orcid\").toString();\n \n         } catch (IOException e) {\n             LOG.error(\"Retrieving accessToken was unsuccessful\" + e.getMessage());\n             throw new CustomWebApplicationException(e.getMessage(), HttpStatus.SC_BAD_REQUEST);\n         }\n \n         if (user != null) {\n+            // save the ORCID to the enduser table", "originalCommit": "c3f9296ca6e84cf4bda3d743fd5c282666bbd64d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE3NDMwNg==", "url": "https://github.com/dockstore/dockstore/pull/3376#discussion_r404174306", "bodyText": "I like adding it to the user profile. Though currently your username is hardcoded.", "author": "agduncan94", "createdAt": "2020-04-06T15:18:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM0OTE2Ng=="}], "type": "inlineReview"}, {"oid": "2e5a079067e5e4cc4680945b9cdec25e2cdb2e16", "url": "https://github.com/dockstore/dockstore/commit/2e5a079067e5e4cc4680945b9cdec25e2cdb2e16", "message": "Merge branch 'develop' into feature/organizations-orcid", "committedDate": "2020-04-03T21:49:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM5NjEyMg==", "url": "https://github.com/dockstore/dockstore/pull/3376#discussion_r403396122", "bodyText": "Was like this, but log the exception", "author": "coverbeck", "createdAt": "2020-04-04T00:33:11Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/TokenResource.java", "diffHunk": "@@ -658,15 +659,29 @@ public Token addOrcidToken(@ApiParam(hidden = true) @Parameter(hidden = true, na\n             accessToken = tokenResponse.getAccessToken();\n             refreshToken = tokenResponse.getRefreshToken();\n \n-            // ORCID API returns the user's ORCID username in the \"name\" property\n+            // ORCID API returns the username and orcid id along with the tokens\n+            // get them to store in the token and user tables\n             username = tokenResponse.get(\"name\").toString();\n+            orcid = tokenResponse.get(\"orcid\").toString();\n \n         } catch (IOException e) {\n             LOG.error(\"Retrieving accessToken was unsuccessful\" + e.getMessage());", "originalCommit": "2e5a079067e5e4cc4680945b9cdec25e2cdb2e16", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c698904f0c040fc26f098d992b7090e5ff782910", "url": "https://github.com/dockstore/dockstore/commit/c698904f0c040fc26f098d992b7090e5ff782910", "message": "delete ORCID id when token is deleted", "committedDate": "2020-04-06T19:59:50Z", "type": "commit"}, {"oid": "e0aa24bb64e4b9c6a937d821de9e7d164e3d497f", "url": "https://github.com/dockstore/dockstore/commit/e0aa24bb64e4b9c6a937d821de9e7d164e3d497f", "message": "Merge branch 'feature/organizations-orcid' of https://github.com/dockstore/dockstore into feature/organizations-orcid", "committedDate": "2020-04-06T20:00:18Z", "type": "commit"}, {"oid": "3f2e975f50fab8e2001c0854986ad31e31a1bcb8", "url": "https://github.com/dockstore/dockstore/commit/3f2e975f50fab8e2001c0854986ad31e31a1bcb8", "message": "cleanup, generated changeset", "committedDate": "2020-04-06T21:00:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM4NzI3OQ==", "url": "https://github.com/dockstore/dockstore/pull/3376#discussion_r404387279", "bodyText": "was better with a descriptive id (used when debugging migrations in a live instance)", "author": "denis-yuen", "createdAt": "2020-04-06T21:04:33Z", "path": "dockstore-webservice/src/main/resources/migrations.1.9.0.xml", "diffHunk": "@@ -97,4 +97,10 @@\n             <column name=\"os\" type=\"varchar(255 BYTE)\"/>\n         </addColumn>\n     </changeSet>\n+\n+    <changeSet author=\"esoth (generated)\" id=\"1586206601202-8\">", "originalCommit": "3f2e975f50fab8e2001c0854986ad31e31a1bcb8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM4ODgxOA==", "url": "https://github.com/dockstore/dockstore/pull/3376#discussion_r404388818", "bodyText": "No real performance difference gain when using length-constrained column.\nUnlikely to be attack vector either\nSee tip https://www.postgresql.org/docs/9.3/datatype-character.html", "author": "denis-yuen", "createdAt": "2020-04-06T21:07:40Z", "path": "dockstore-webservice/src/main/resources/migrations.1.9.0.xml", "diffHunk": "@@ -97,4 +97,10 @@\n             <column name=\"os\" type=\"varchar(255 BYTE)\"/>\n         </addColumn>\n     </changeSet>\n+\n+    <changeSet author=\"esoth (generated)\" id=\"1586206601202-8\">\n+        <addColumn tableName=\"enduser\">\n+            <column name=\"orcid\" type=\"varchar(255 BYTE)\"/>", "originalCommit": "3f2e975f50fab8e2001c0854986ad31e31a1bcb8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5b071a2c1c53e5b383e797ea63210c53f521efb7", "url": "https://github.com/dockstore/dockstore/commit/5b071a2c1c53e5b383e797ea63210c53f521efb7", "message": "descriptive id for changeset", "committedDate": "2020-04-06T21:12:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDUzNDMxMA==", "url": "https://github.com/dockstore/dockstore/pull/3376#discussion_r404534310", "bodyText": "I think this should be null, not an empty string.", "author": "coverbeck", "createdAt": "2020-04-07T04:54:18Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/resources/TokenResource.java", "diffHunk": "@@ -237,6 +237,12 @@ public Response deleteToken(@ApiParam(hidden = true) @Auth User user,\n \n         tokenDAO.delete(token);\n \n+        // also erase the user's ORCID id if deleting an ORCID token\n+        if (token.getTokenSource() == TokenType.ORCID_ORG) {\n+            User byId = userDAO.findById(user.getId());\n+            byId.setOrcid(\"\");", "originalCommit": "5b071a2c1c53e5b383e797ea63210c53f521efb7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "46837396eed9d65326b71a6c075c14ad1065e819", "url": "https://github.com/dockstore/dockstore/commit/46837396eed9d65326b71a6c075c14ad1065e819", "message": "set user orcid to null when token is deleted", "committedDate": "2020-04-08T16:12:24Z", "type": "commit"}]}