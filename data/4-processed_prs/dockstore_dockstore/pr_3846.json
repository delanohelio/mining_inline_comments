{"pr_number": 3846, "pr_title": "Feature/seab 1637/collection entry version db", "pr_createdAt": "2020-10-05T17:21:01Z", "pr_url": "https://github.com/dockstore/dockstore/pull/3846", "timeline": [{"oid": "268257e894051121726c962ba63a89c975809d48", "url": "https://github.com/dockstore/dockstore/commit/268257e894051121726c962ba63a89c975809d48", "message": "Add versionId column", "committedDate": "2020-10-01T17:52:05Z", "type": "commit"}, {"oid": "0e5e9e2500411894a202ae07ffcf590273be57f2", "url": "https://github.com/dockstore/dockstore/commit/0e5e9e2500411894a202ae07ffcf590273be57f2", "message": "Fixes", "committedDate": "2020-10-01T19:39:02Z", "type": "commit"}, {"oid": "e0b4fd49d54f313378f262f32c6979ad87959103", "url": "https://github.com/dockstore/dockstore/commit/e0b4fd49d54f313378f262f32c6979ad87959103", "message": "Fix cast error", "committedDate": "2020-10-01T19:42:11Z", "type": "commit"}, {"oid": "ba4ca34bc2dc365e201f8645d99d7d7ed9627596", "url": "https://github.com/dockstore/dockstore/commit/ba4ca34bc2dc365e201f8645d99d7d7ed9627596", "message": "Fix the fix", "committedDate": "2020-10-01T19:51:40Z", "type": "commit"}, {"oid": "b9ffe3b0a25e400b482263bf99c078dfa5adf199", "url": "https://github.com/dockstore/dockstore/commit/b9ffe3b0a25e400b482263bf99c078dfa5adf199", "message": "Another iteration", "committedDate": "2020-10-02T00:36:14Z", "type": "commit"}, {"oid": "c3bd9cefed35710584ee67f77012b04be8d529b4", "url": "https://github.com/dockstore/dockstore/commit/c3bd9cefed35710584ee67f77012b04be8d529b4", "message": "Make some columns non-null", "committedDate": "2020-10-02T15:39:12Z", "type": "commit"}, {"oid": "9607169fc93306d10a1bac0c328a1f97d4ae402e", "url": "https://github.com/dockstore/dockstore/commit/9607169fc93306d10a1bac0c328a1f97d4ae402e", "message": "Simplify", "committedDate": "2020-10-02T16:10:39Z", "type": "commit"}, {"oid": "12696ff18e732516ae09b5ca0df08ecfc7cc6b60", "url": "https://github.com/dockstore/dockstore/commit/12696ff18e732516ae09b5ca0df08ecfc7cc6b60", "message": "Rename table", "committedDate": "2020-10-02T16:24:56Z", "type": "commit"}, {"oid": "6d3ded18e0da4d2fd1ac5c4da06c7355fd29b7e8", "url": "https://github.com/dockstore/dockstore/commit/6d3ded18e0da4d2fd1ac5c4da06c7355fd29b7e8", "message": "Rename table, cleanup, add test, change HQL", "committedDate": "2020-10-02T20:04:47Z", "type": "commit"}, {"oid": "c5f3d78a0c40fab1cd5788997edab6ebdb3e7cc8", "url": "https://github.com/dockstore/dockstore/commit/c5f3d78a0c40fab1cd5788997edab6ebdb3e7cc8", "message": "Add version to response", "committedDate": "2020-10-02T21:51:51Z", "type": "commit"}, {"oid": "7286e0792d0ba344c3d38f7a14d2c44628b7c29d", "url": "https://github.com/dockstore/dockstore/commit/7286e0792d0ba344c3d38f7a14d2c44628b7c29d", "message": "Use versionName", "committedDate": "2020-10-05T14:49:56Z", "type": "commit"}, {"oid": "4dc3d7557410a19f9e849c63b74fbb363e3d5cde", "url": "https://github.com/dockstore/dockstore/commit/4dc3d7557410a19f9e849c63b74fbb363e3d5cde", "message": "Add test", "committedDate": "2020-10-05T15:31:26Z", "type": "commit"}, {"oid": "6f65691215cdf7324f7559d630101f67895d44f0", "url": "https://github.com/dockstore/dockstore/commit/6f65691215cdf7324f7559d630101f67895d44f0", "message": "Update swagger/openapi", "committedDate": "2020-10-05T15:44:25Z", "type": "commit"}, {"oid": "0c543ee52d2ef51d928735653b95fcc5c563eae2", "url": "https://github.com/dockstore/dockstore/commit/0c543ee52d2ef51d928735653b95fcc5c563eae2", "message": "Merge branch 'develop' into feature/SEAB-1637/CollectionEntryVersionDB", "committedDate": "2020-10-05T17:21:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTEzODQ3Mw==", "url": "https://github.com/dockstore/dockstore/pull/3846#discussion_r501138473", "bodyText": "Can you have a unique constraint on all 3 columns together (entry_id, version_id, collection_id)? The problem is that version_id is nullable; I don't know if that will work.\nMaybe this: https://stackoverflow.com/questions/8289100/create-unique-constraint-with-null-columns", "author": "coverbeck", "createdAt": "2020-10-07T16:12:52Z", "path": "dockstore-webservice/src/main/resources/migrations.1.10.0.xml", "diffHunk": "@@ -77,4 +77,22 @@\n     <changeSet author=\"nolwarre (generated)\" id=\"notificationsCharLimit\">\n         <modifyDataType columnName=\"message\" newDataType=\"varchar(1024)\" tableName=\"notification\"/>\n     </changeSet>\n+    <changeSet author=\"gluu (generated)\" id=\"1601569350016-13\">\n+        <createTable tableName=\"collection_entry_version\">", "originalCommit": "0c543ee52d2ef51d928735653b95fcc5c563eae2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMwNzM4NA==", "url": "https://github.com/dockstore/dockstore/pull/3846#discussion_r501307384", "bodyText": "We did this before to enforce the nullable but unique workflow names", "author": "denis-yuen", "createdAt": "2020-10-07T21:01:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTEzODQ3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAwNzY1NQ==", "url": "https://github.com/dockstore/dockstore/pull/3846#discussion_r502007655", "bodyText": "Done", "author": "garyluu", "createdAt": "2020-10-08T20:56:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTEzODQ3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMwODMyNQ==", "url": "https://github.com/dockstore/dockstore/pull/3846#discussion_r501308325", "bodyText": "Bike-shedding, but really not a fan of this formatting style in Java", "author": "denis-yuen", "createdAt": "2020-10-07T21:02:54Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/core/Collection.java", "diffHunk": "@@ -85,10 +87,16 @@\n     @Schema(description = \"Short description of the collection\", required = true, example = \"A collection of alignment algorithms\")\n     private String topic;\n \n-    @ManyToMany(fetch = FetchType.LAZY)\n-    @JoinTable(name = \"collection_entry\", joinColumns = @JoinColumn(name = \"collectionid\"), inverseJoinColumns = @JoinColumn(name = \"entryid\"))\n+    @OneToMany(", "originalCommit": "0c543ee52d2ef51d928735653b95fcc5c563eae2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMxMDUyNg==", "url": "https://github.com/dockstore/dockstore/pull/3846#discussion_r501310526", "bodyText": "Why does this join table have its own id (possible inspiration from user_entry or organization_user which don't have their own id.", "author": "denis-yuen", "createdAt": "2020-10-07T21:07:24Z", "path": "dockstore-webservice/src/main/resources/migrations.1.10.0.xml", "diffHunk": "@@ -77,4 +77,22 @@\n     <changeSet author=\"nolwarre (generated)\" id=\"notificationsCharLimit\">\n         <modifyDataType columnName=\"message\" newDataType=\"varchar(1024)\" tableName=\"notification\"/>\n     </changeSet>\n+    <changeSet author=\"gluu (generated)\" id=\"1601569350016-13\">\n+        <createTable tableName=\"collection_entry_version\">\n+            <column autoIncrement=\"true\" name=\"id\" type=\"SERIAL\">", "originalCommit": "0c543ee52d2ef51d928735653b95fcc5c563eae2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg3NjEyMg==", "url": "https://github.com/dockstore/dockstore/pull/3846#discussion_r501876122", "bodyText": "Other tables don't need an ID because they use a composite key (based on all their non-nullable) columns, since version id is null-able, it isn't possible.", "author": "garyluu", "createdAt": "2020-10-08T17:04:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMxMDUyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA0NjkxMA==", "url": "https://github.com/dockstore/dockstore/pull/3846#discussion_r502046910", "bodyText": "interesting", "author": "denis-yuen", "createdAt": "2020-10-08T22:27:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMxMDUyNg=="}], "type": "inlineReview"}, {"oid": "8b8d89b94e054f625f97e4003490db18a5845774", "url": "https://github.com/dockstore/dockstore/commit/8b8d89b94e054f625f97e4003490db18a5845774", "message": "PR changes", "committedDate": "2020-10-08T17:36:11Z", "type": "commit"}, {"oid": "74b37d08c10aea8d1539ce7e5cf6f8b8f3b9a644", "url": "https://github.com/dockstore/dockstore/commit/74b37d08c10aea8d1539ce7e5cf6f8b8f3b9a644", "message": "Assert equals", "committedDate": "2020-10-08T17:57:10Z", "type": "commit"}, {"oid": "11b5efd2eabc459526da52f737059f6128bf4bc9", "url": "https://github.com/dockstore/dockstore/commit/11b5efd2eabc459526da52f737059f6128bf4bc9", "message": "Merge branch 'develop' into feature/SEAB-1637/CollectionEntryVersionDB", "committedDate": "2020-10-08T17:57:23Z", "type": "commit"}, {"oid": "cc4a8b2f0204b1dff145c2432400a1abd84ae943", "url": "https://github.com/dockstore/dockstore/commit/cc4a8b2f0204b1dff145c2432400a1abd84ae943", "message": "Merge branch 'develop' into feature/SEAB-1637/CollectionEntryVersionDB", "committedDate": "2020-10-08T17:57:37Z", "type": "commit"}, {"oid": "54d615ca4d395627fe408da4d4ff99c64ed90f73", "url": "https://github.com/dockstore/dockstore/commit/54d615ca4d395627fe408da4d4ff99c64ed90f73", "message": "Random fixes", "committedDate": "2020-10-08T18:50:06Z", "type": "commit"}, {"oid": "1827310df08b52be7ec3b2c7d86e4f5a0df69911", "url": "https://github.com/dockstore/dockstore/commit/1827310df08b52be7ec3b2c7d86e4f5a0df69911", "message": "Fix migration", "committedDate": "2020-10-08T20:29:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAxMzk5Mw==", "url": "https://github.com/dockstore/dockstore/pull/3846#discussion_r502013993", "bodyText": "Missing newline per GitHub", "author": "coverbeck", "createdAt": "2020-10-08T21:09:34Z", "path": "dockstore-webservice/src/main/resources/import.sql", "diffHunk": "@@ -38,3 +38,6 @@ ALTER TABLE workflowversion ADD CONSTRAINT fk_workflowVersionMetadata FOREIGN KE\n \n -- cannot seem to define these due to inheritance\n ALTER TABLE tag ADD CONSTRAINT parentid_constraint FOREIGN KEY(parentid) REFERENCES tool (id) DEFERRABLE INITIALLY DEFERRED;\n+\n+CREATE UNIQUE INDEX unique_collection_entry ON collection_entry_version USING btree (collection_id, entry_id) WHERE version_id IS NULL;\n+CREATE UNIQUE INDEX unique_collection_entry_version ON collection_entry_version USING btree (collection_id, entry_id, version_id) WHERE version_id IS NOT NULL;", "originalCommit": "1827310df08b52be7ec3b2c7d86e4f5a0df69911", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAxNjQ3MQ==", "url": "https://github.com/dockstore/dockstore/pull/3846#discussion_r502016471", "bodyText": "What is this file for again? This SQL is already in the migrations XML..", "author": "coverbeck", "createdAt": "2020-10-08T21:14:46Z", "path": "dockstore-webservice/src/main/resources/import.sql", "diffHunk": "@@ -38,3 +38,6 @@ ALTER TABLE workflowversion ADD CONSTRAINT fk_workflowVersionMetadata FOREIGN KE\n \n -- cannot seem to define these due to inheritance\n ALTER TABLE tag ADD CONSTRAINT parentid_constraint FOREIGN KEY(parentid) REFERENCES tool (id) DEFERRABLE INITIALLY DEFERRED;\n+\n+CREATE UNIQUE INDEX unique_collection_entry ON collection_entry_version USING btree (collection_id, entry_id) WHERE version_id IS NULL;", "originalCommit": "1827310df08b52be7ec3b2c7d86e4f5a0df69911", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzODA1NA==", "url": "https://github.com/dockstore/dockstore/pull/3846#discussion_r502038054", "bodyText": "I just discovered this file today.  So what happens is if I just do the migrations in the usual place, liquibase will complain and try to drop the constraint. So I had to put it here to in order to override it. I'm guessing it's what the file is for", "author": "garyluu", "createdAt": "2020-10-08T22:03:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAxNjQ3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA0NTc3Ng==", "url": "https://github.com/dockstore/dockstore/pull/3846#discussion_r502045776", "bodyText": "there's a comment above\n-- this file is a last chance to modify any database schema in hibernate (hbm2ddl) create mode with postgres-specific\n-- changes not possible in JPA\n\nbasically, if you can't create something (like partial indexes) in JPA because they're postgres specific, create them here and in migrations", "author": "denis-yuen", "createdAt": "2020-10-08T22:24:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAxNjQ3MQ=="}], "type": "inlineReview"}, {"oid": "6e1668102050c227d692ec43170d3a1f9fda2ad6", "url": "https://github.com/dockstore/dockstore/commit/6e1668102050c227d692ec43170d3a1f9fda2ad6", "message": "New line", "committedDate": "2020-10-08T22:08:50Z", "type": "commit"}, {"oid": "5f1de120fc16d7586111a28be72b002b2f84457a", "url": "https://github.com/dockstore/dockstore/commit/5f1de120fc16d7586111a28be72b002b2f84457a", "message": "Merge branch 'develop' into feature/SEAB-1637/CollectionEntryVersionDB", "committedDate": "2020-10-09T17:45:41Z", "type": "commit"}, {"oid": "ecc7691c1c40a6ae60e8f80dec84da93da71c8f7", "url": "https://github.com/dockstore/dockstore/commit/ecc7691c1c40a6ae60e8f80dec84da93da71c8f7", "message": "Fix merge", "committedDate": "2020-10-09T18:13:09Z", "type": "commit"}, {"oid": "2f9cd621345293455b49b502b28693a77370e48d", "url": "https://github.com/dockstore/dockstore/commit/2f9cd621345293455b49b502b28693a77370e48d", "message": "Merge branch 'develop' into feature/SEAB-1637/CollectionEntryVersionDB", "committedDate": "2020-10-09T19:26:07Z", "type": "commit"}, {"oid": "5aff7e13c6f4ab8506532117c33c9761be30bd1b", "url": "https://github.com/dockstore/dockstore/commit/5aff7e13c6f4ab8506532117c33c9761be30bd1b", "message": "Merge branch 'develop' into feature/SEAB-1637/CollectionEntryVersionDB", "committedDate": "2020-10-09T21:20:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY4MDkyOQ==", "url": "https://github.com/dockstore/dockstore/pull/3846#discussion_r502680929", "bodyText": "Codacy found an issue: '9L' is a magic number.", "author": "denis-yuen", "createdAt": "2020-10-09T21:33:36Z", "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/OrganizationIT.java", "diffHunk": "@@ -1314,6 +1312,25 @@ public void testBasicCollections() {\n             fail(\"Was able to reject an approved collection\");\n         }\n \n+        // version 8 and 9 belong to entryId 2\n+        long versionId = 9L;", "originalCommit": "5aff7e13c6f4ab8506532117c33c9761be30bd1b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY4MDk0NA==", "url": "https://github.com/dockstore/dockstore/pull/3846#discussion_r502680944", "bodyText": "Codacy found an issue: '3' is a magic number.", "author": "denis-yuen", "createdAt": "2020-10-09T21:33:39Z", "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/OrganizationIT.java", "diffHunk": "@@ -1314,6 +1312,25 @@ public void testBasicCollections() {\n             fail(\"Was able to reject an approved collection\");\n         }\n \n+        // version 8 and 9 belong to entryId 2\n+        long versionId = 9L;\n+\n+        // Add tool and specific version to collection\n+        organizationsApi.addEntryToCollection(organization.getId(), collectionId, entryId, versionId);\n+        organizationsApi.addEntryToCollection(organization.getId(), collectionId, entryId, null);\n+\n+        // There should now be two entries for collection with ID 1 (one with version, one without), 3 entries in total\n+        collectionById = organizationsApi.getCollectionById(organizationID, collectionId);\n+        assertEquals(3, collectionById.getEntries().size());", "originalCommit": "5aff7e13c6f4ab8506532117c33c9761be30bd1b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}