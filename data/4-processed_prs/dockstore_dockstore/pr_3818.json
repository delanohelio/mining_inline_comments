{"pr_number": 3818, "pr_title": "db migration script update for docker", "pr_createdAt": "2020-09-21T17:10:23Z", "pr_url": "https://github.com/dockstore/dockstore/pull/3818", "timeline": [{"oid": "db21a5126b15b90fb4a288694a0dec326384e4b0", "url": "https://github.com/dockstore/dockstore/commit/db21a5126b15b90fb4a288694a0dec326384e4b0", "message": "add docker support\n\naddition non-timeout command", "committedDate": "2020-09-21T17:07:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIxOTIyMw==", "url": "https://github.com/dockstore/dockstore/pull/3818#discussion_r492219223", "bodyText": "previous comment is probably sufficient rather than duplicating the command.", "author": "Ldcabansay", "createdAt": "2020-09-21T17:13:06Z", "path": "propose_migration.sh", "diffHunk": "@@ -13,18 +13,28 @@ if [ \"${CIRCLECI-false}\" = \"true\" ]; then\n     createdb -U postgres webservice_test_proposed || true\n     rm dockstore-webservice/target/detected-migrations.xml || true\n else\n+    ## uncomment/comment this section if database is running locally on postgres\n     sudo -i -u postgres dropdb webservice_test || true\n     sudo -i -u postgres dropdb webservice_test_proposed || true\n     sudo -i -u postgres createdb webservice_test || true\n     sudo -i -u postgres createdb webservice_test_proposed || true\n     rm dockstore-webservice/target/detected-migrations.xml || true\n+    ## uncomment/comment this section if running on docker\n+#    docker exec -it -u postgres -e PGPASSWORD=dockstore postgres1 dropdb webservice_test || true\n+#    docker exec -it -u postgres -e PGPASSWORD=dockstore postgres1 dropdb webservice_test_proposed || true\n+#    docker exec -it -u postgres -e PGPASSWORD=dockstore postgres1 psql -c \"create database webservice_test with owner = dockstore;\" || true\n+#    docker exec -it -u postgres -e PGPASSWORD=dockstore postgres1 psql -c \"create database webservice_test_proposed with owner = dockstore;\" || true\n+#    rm dockstore-webservice/target/detected-migrations.xml || true\n fi\n \n ## load up the old database based on current migration\n rm dockstore-webservice/target/dockstore-webservice-*sources.jar || true\n java -jar dockstore-webservice/target/dockstore-webservice-*.jar db migrate dockstore-integration-testing/src/test/resources/dockstore.yml --include 1.3.0.generated,1.4.0,1.5.0,1.6.0,1.7.0,1.8.0,1.9.0,1.10.0\n+\n ## create the new database based on JPA (ugly, should really create a proper dw command if this works)\n+## remove timeout for mac devices by commenting that line and uncomment the following line, will have to stop manually\n timeout 15 java -Ddw.database.url=jdbc:postgresql://localhost:5432/webservice_test_proposed -Ddw.database.properties.hibernate.hbm2ddl.auto=create -jar dockstore-webservice/target/dockstore-webservice-*.jar server dockstore-integration-testing/src/test/resources/dockstore.yml || true\n+#java -Ddw.database.url=jdbc:postgresql://localhost:5432/webservice_test_proposed -Ddw.database.properties.hibernate.hbm2ddl.auto=create -jar dockstore-webservice/target/dockstore-webservice-*.jar server dockstore-integration-testing/src/test/resources/dockstore.yml || true", "originalCommit": "db21a5126b15b90fb4a288694a0dec326384e4b0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6bd61f941967cdb45a2cf1d30bc6e072d478cb54", "url": "https://github.com/dockstore/dockstore/commit/6bd61f941967cdb45a2cf1d30bc6e072d478cb54", "message": "Remove duplicate line\n\nClarify comment", "committedDate": "2020-09-21T17:30:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIzMzU0OA==", "url": "https://github.com/dockstore/dockstore/pull/3818#discussion_r492233548", "bodyText": "Or install and use gtimeout. But probably not worth getting into here.", "author": "coverbeck", "createdAt": "2020-09-21T17:36:53Z", "path": "propose_migration.sh", "diffHunk": "@@ -13,17 +13,26 @@ if [ \"${CIRCLECI-false}\" = \"true\" ]; then\n     createdb -U postgres webservice_test_proposed || true\n     rm dockstore-webservice/target/detected-migrations.xml || true\n else\n+    ## uncomment/comment this section if database is running locally on postgres\n     sudo -i -u postgres dropdb webservice_test || true\n     sudo -i -u postgres dropdb webservice_test_proposed || true\n     sudo -i -u postgres createdb webservice_test || true\n     sudo -i -u postgres createdb webservice_test_proposed || true\n     rm dockstore-webservice/target/detected-migrations.xml || true\n+    ## uncomment/comment this section if running on docker\n+#    docker exec -it -u postgres -e PGPASSWORD=dockstore postgres1 dropdb webservice_test || true\n+#    docker exec -it -u postgres -e PGPASSWORD=dockstore postgres1 dropdb webservice_test_proposed || true\n+#    docker exec -it -u postgres -e PGPASSWORD=dockstore postgres1 psql -c \"create database webservice_test with owner = dockstore;\" || true\n+#    docker exec -it -u postgres -e PGPASSWORD=dockstore postgres1 psql -c \"create database webservice_test_proposed with owner = dockstore;\" || true\n+#    rm dockstore-webservice/target/detected-migrations.xml || true\n fi\n \n ## load up the old database based on current migration\n rm dockstore-webservice/target/dockstore-webservice-*sources.jar || true\n java -jar dockstore-webservice/target/dockstore-webservice-*.jar db migrate dockstore-integration-testing/src/test/resources/dockstore.yml --include 1.3.0.generated,1.4.0,1.5.0,1.6.0,1.7.0,1.8.0,1.9.0,1.10.0\n+\n ## create the new database based on JPA (ugly, should really create a proper dw command if this works)\n+## remove timeout for mac devices, will have to break manually", "originalCommit": "6bd61f941967cdb45a2cf1d30bc6e072d478cb54", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5b70dd69a8feb875fc98fa595aad9453adc2d131", "url": "https://github.com/dockstore/dockstore/commit/5b70dd69a8feb875fc98fa595aad9453adc2d131", "message": "Merge branch 'develop' into feature/SEAB-1726/db-migration-docker", "committedDate": "2020-09-21T19:31:51Z", "type": "commit"}]}