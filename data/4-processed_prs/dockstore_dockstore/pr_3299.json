{"pr_number": 3299, "pr_title": "Feature/1232/migrate existing workflow to d yml", "pr_createdAt": "2020-03-05T15:19:32Z", "pr_url": "https://github.com/dockstore/dockstore/pull/3299", "timeline": [{"oid": "f9dcc347e41a86b7f12cf228a08b1d36218682a7", "url": "https://github.com/dockstore/dockstore/commit/f9dcc347e41a86b7f12cf228a08b1d36218682a7", "message": "add new column to version table to keep track of if a version is legacy", "committedDate": "2020-03-03T20:51:11Z", "type": "commit"}, {"oid": "5765bf5943a47fcab836db11916e28ad42e28eac", "url": "https://github.com/dockstore/dockstore/commit/5765bf5943a47fcab836db11916e28ad42e28eac", "message": "convert workflow path to dockstore.yml", "committedDate": "2020-03-04T14:15:46Z", "type": "commit"}, {"oid": "c75c3ada3934dc260d77f59272a4fad563b297de", "url": "https://github.com/dockstore/dockstore/commit/c75c3ada3934dc260d77f59272a4fad563b297de", "message": "improve description of new column for open api", "committedDate": "2020-03-04T14:33:23Z", "type": "commit"}, {"oid": "a11aea81626695cd4fc1ea08301547393fb560ad", "url": "https://github.com/dockstore/dockstore/commit/a11aea81626695cd4fc1ea08301547393fb560ad", "message": "fix migration for legacy version column", "committedDate": "2020-03-04T15:10:08Z", "type": "commit"}, {"oid": "4594490319e395bf5220131ef8c88ab41dbcb1b2", "url": "https://github.com/dockstore/dockstore/commit/4594490319e395bf5220131ef8c88ab41dbcb1b2", "message": "tests for legacyversion", "committedDate": "2020-03-05T13:29:51Z", "type": "commit"}, {"oid": "6a70403745768499f4c8f8a7db43901db3b4cd09", "url": "https://github.com/dockstore/dockstore/commit/6a70403745768499f4c8f8a7db43901db3b4cd09", "message": "no longer allow refresh of dockstore.yml workflows and services", "committedDate": "2020-03-05T13:45:48Z", "type": "commit"}, {"oid": "963f3f650d87c99fef1d9908606fc028cf19312c", "url": "https://github.com/dockstore/dockstore/commit/963f3f650d87c99fef1d9908606fc028cf19312c", "message": "added tests for migrations", "committedDate": "2020-03-05T14:12:39Z", "type": "commit"}, {"oid": "6eac9e6f1602e4c8b7c8807057c043176e0e6227", "url": "https://github.com/dockstore/dockstore/commit/6eac9e6f1602e4c8b7c8807057c043176e0e6227", "message": "fix failing tests", "committedDate": "2020-03-05T14:25:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQzODA4Ng==", "url": "https://github.com/dockstore/dockstore/pull/3299#discussion_r388438086", "bodyText": "I don't understand the whole code flow here, but it is confusing that we have a method named getWorkflow, whose JavaDoc says it creates or updates a workflow, and whose error message says it cannot refresh the workflow. :)\nThis may not be easily actionable, but just wanted to note it.", "author": "coverbeck", "createdAt": "2020-03-05T17:12:02Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/SourceCodeRepoInterface.java", "diffHunk": "@@ -223,15 +225,20 @@ public Workflow getWorkflow(String repositoryId, Optional<Workflow> existingWork\n             workflow.setDescriptorType(DescriptorLanguage.CWL);\n             return workflow;\n         }\n+\n+        if (Objects.equals(existingWorkflow.get().getMode(), WorkflowMode.DOCKSTORE_YML)) {\n+            String msg = \"Cannot refresh .dockstore.yml workflows\";", "originalCommit": "6eac9e6f1602e4c8b7c8807057c043176e0e6227", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ2MzE0NA==", "url": "https://github.com/dockstore/dockstore/pull/3299#discussion_r388463144", "bodyText": "Ya I agree it is a bit strange. Get workflow is actually only called on refresh all/individual and will either add a new workflow or update an existing one based on the GitHub repository. I'll be updating this area very soon while working on individual version refresh, so I will make sure to update the function names/descriptions.", "author": "agduncan94", "createdAt": "2020-03-05T17:57:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQzODA4Ng=="}], "type": "inlineReview"}, {"oid": "0813e4c8d62c7b61fc15866d32b841be74ffaef5", "url": "https://github.com/dockstore/dockstore/commit/0813e4c8d62c7b61fc15866d32b841be74ffaef5", "message": "fix codacy", "committedDate": "2020-03-05T17:58:50Z", "type": "commit"}, {"oid": "808f49d469a9f8356e813b62371e0316f7c74e94", "url": "https://github.com/dockstore/dockstore/commit/808f49d469a9f8356e813b62371e0316f7c74e94", "message": "missed codacy thing", "committedDate": "2020-03-05T18:02:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ3MTkyOA==", "url": "https://github.com/dockstore/dockstore/pull/3299#discussion_r388471928", "bodyText": "Double-check, this seems to set all versions of workflows in mode DOCKSTORE_YML to not be in legacy mode.\nWill this be true while people are migrating from one to another?\nMaybe it doesn't matter if this runs before people have access to workflows via GitHub apps, but then why set anyone to false?", "author": "denis-yuen", "createdAt": "2020-03-05T18:13:22Z", "path": "dockstore-webservice/src/main/resources/migrations.1.9.0.xml", "diffHunk": "@@ -41,4 +41,14 @@\n             </column>\n         </addColumn>\n     </changeSet>\n+    <changeSet author=\"aduncan (generated)\" id=\"addLegacyVersionColumn\">\n+        <addColumn tableName=\"workflowversion\">\n+            <column name=\"islegacyversion\" type=\"bool\"/>\n+        </addColumn>\n+        <sql dbms=\"postgresql\">\n+            UPDATE workflowversion SET islegacyversion=true;\n+            UPDATE workflowversion SET islegacyversion=false WHERE id IN (SELECT wv.id FROM workflowversion wv JOIN workflow_workflowversion wwv ON wv.id=wwv.workflowversionid WHERE wwv.workflowid IN (SELECT id FROM workflow WHERE mode='DOCKSTORE_YML'));", "originalCommit": "808f49d469a9f8356e813b62371e0316f7c74e94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ3OTY0Mg==", "url": "https://github.com/dockstore/dockstore/pull/3299#discussion_r388479642", "bodyText": "This is only true before anyone has migrated. The goal is that before any migrations happen, all dockstore.yml versions are set to false and all other versions are set to true. Once people can migrate, then there is the case where a dockstore.yml workflow has both legacy and new versions.\nThe purpose of this field is so that for migrated workflows we know which versions are legacy and which are new, in order to distinguish them in the future (especially useful if we end up with the bot for making PRs).", "author": "agduncan94", "createdAt": "2020-03-05T18:27:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ3MTkyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ5MzExNQ==", "url": "https://github.com/dockstore/dockstore/pull/3299#discussion_r388493115", "bodyText": "Just noticed this... This is going to have to be updated for #3257, where the workflow_workflowversion table no longer exists.", "author": "coverbeck", "createdAt": "2020-03-05T18:53:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ3MTkyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU0MzcyOQ==", "url": "https://github.com/dockstore/dockstore/pull/3299#discussion_r388543729", "bodyText": ":'(", "author": "agduncan94", "createdAt": "2020-03-05T20:24:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ3MTkyOA=="}], "type": "inlineReview"}, {"oid": "d55bd4f9b0ccd6e814207d2a7cda8aea2cbcc754", "url": "https://github.com/dockstore/dockstore/commit/d55bd4f9b0ccd6e814207d2a7cda8aea2cbcc754", "message": "Merge branch 'develop' into feature/1232/migrate-existing-workflow-to-d-yml", "committedDate": "2020-03-06T13:18:30Z", "type": "commit"}, {"oid": "3c998b018a6f4380f252278514aa549151535a64", "url": "https://github.com/dockstore/dockstore/commit/3c998b018a6f4380f252278514aa549151535a64", "message": "fix issue with gitlab api and files", "committedDate": "2020-03-06T15:15:00Z", "type": "commit"}, {"oid": "682a0854820555d575bc35755a3892ca87cfe994", "url": "https://github.com/dockstore/dockstore/commit/682a0854820555d575bc35755a3892ca87cfe994", "message": "another attempt to fix gitlab", "committedDate": "2020-03-06T16:11:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTAwNDAwNg==", "url": "https://github.com/dockstore/dockstore/pull/3299#discussion_r389004006", "bodyText": "form", "author": "garyluu", "createdAt": "2020-03-06T16:28:20Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/helpers/GitLabSourceCodeRepo.java", "diffHunk": "@@ -227,9 +227,11 @@ public String getMainBranch(Entry entry, String repositoryId) {\n      */\n     @Override\n     public SourceFile getSourceFile(String path, String id, String branch, DescriptorLanguage.FileType type) {\n+        // Need to remove root slash form path", "originalCommit": "682a0854820555d575bc35755a3892ca87cfe994", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "266668e4221c5b8ae3aa75cc56cf762e705eae72", "url": "https://github.com/dockstore/dockstore/commit/266668e4221c5b8ae3aa75cc56cf762e705eae72", "message": "fix typo", "committedDate": "2020-03-06T16:29:46Z", "type": "commit"}]}