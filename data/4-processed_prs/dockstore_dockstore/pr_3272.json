{"pr_number": 3272, "pr_title": "Feature/local recursive import", "pr_createdAt": "2020-02-26T22:22:12Z", "pr_url": "https://github.com/dockstore/dockstore/pull/3272", "timeline": [{"oid": "417c75e1954f64423ee84468cfc0b8193c0999fe", "url": "https://github.com/dockstore/dockstore/commit/417c75e1954f64423ee84468cfc0b8193c0999fe", "message": "add local recursive import check to validation", "committedDate": "2020-02-25T23:45:35Z", "type": "commit"}, {"oid": "13fc40c6e9d09c4e6b3a5cd62f4e9b67634d376e", "url": "https://github.com/dockstore/dockstore/commit/13fc40c6e9d09c4e6b3a5cd62f4e9b67634d376e", "message": "add check for and test for local recursive import", "committedDate": "2020-02-26T22:18:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg1MDc2OQ==", "url": "https://github.com/dockstore/dockstore/pull/3272#discussion_r384850769", "bodyText": "If instead of validation.getMessage().entrySet... you did validation.getMessage.values()... and it would make your code a little less complicated.", "author": "coverbeck", "createdAt": "2020-02-27T00:35:45Z", "path": "dockstore-webservice/src/test/java/core/WDLParseTest.java", "diffHunk": "@@ -130,6 +134,49 @@ private static SourceFile getSourceFile2() {\n     }\n \n \n+    /**\n+     * Tests that Dockstore can handle a workflow with locally recursive imports\n+     */\n+    @Test\n+    public void testLocallyRecursiveImport() {\n+        String type = \"workflow\";\n+        File recursiveWDL = new File(ResourceHelpers.resourceFilePath(\"local-recursive-import/localrecursive.wdl\"));\n+        //String primaryDescriptorFilePath = recursiveWDL.getAbsolutePath();\n+        String primaryDescriptorFilePath = \"localrecursive.wdl\";\n+        SourceFile sourceFile = new SourceFile();\n+\n+        File recursiveimportWDL = new File(ResourceHelpers.resourceFilePath(\"local-recursive-import/first-import.wdl\"));\n+        SourceFile importsourceFile = new SourceFile();\n+\n+        try {\n+            sourceFile.setContent(FileUtils.readFileToString(recursiveWDL, StandardCharsets.UTF_8));\n+            sourceFile.setAbsolutePath(\"/localrecursive.wdl\");\n+            sourceFile.setPath(\"localrecursive.wdl\");\n+            sourceFile.setType(DescriptorLanguage.FileType.DOCKSTORE_WDL);\n+\n+            importsourceFile.setContent(FileUtils.readFileToString(recursiveimportWDL, StandardCharsets.UTF_8));\n+            importsourceFile.setAbsolutePath(\"/first-import.wdl\");\n+            importsourceFile.setPath(\"first-import.wdl\");\n+            importsourceFile.setType(DescriptorLanguage.FileType.DOCKSTORE_WDL);\n+\n+            Set<SourceFile> sourceFileSet = new HashSet<>();\n+            sourceFileSet.add(sourceFile);\n+\n+            sourceFileSet.add(importsourceFile);\n+\n+            WDLHandler wdlHandler = new WDLHandler();\n+            VersionTypeValidation validation = wdlHandler.validateEntrySet(sourceFileSet, primaryDescriptorFilePath, type);\n+            Assert.assertFalse(validation.isValid());\n+            // Go through message part and verify it says 'Recursive local import detected'\n+            Optional<Map.Entry<String, String>> validationEntryMap = validation.getMessage().entrySet().stream()", "originalCommit": "13fc40c6e9d09c4e6b3a5cd62f4e9b67634d376e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQyNTg0NA==", "url": "https://github.com/dockstore/dockstore/pull/3272#discussion_r385425844", "bodyText": "fixed", "author": "wshands", "createdAt": "2020-02-27T23:16:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg1MDc2OQ=="}], "type": "inlineReview"}, {"oid": "bd85dc59208f78e9fc6acf5533de444bc8ba1418", "url": "https://github.com/dockstore/dockstore/commit/bd85dc59208f78e9fc6acf5533de444bc8ba1418", "message": "simplify java stream command", "committedDate": "2020-02-27T23:15:30Z", "type": "commit"}, {"oid": "de19fe1cb7fa70c3229831e0f2099241487c2056", "url": "https://github.com/dockstore/dockstore/commit/de19fe1cb7fa70c3229831e0f2099241487c2056", "message": "fix assert", "committedDate": "2020-02-28T00:02:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgyMDM5MQ==", "url": "https://github.com/dockstore/dockstore/pull/3272#discussion_r385820391", "bodyText": "No need to change, but FYI, if you change findAny to anyMatch you directly get a boolean and makes your life slightly easier.", "author": "coverbeck", "createdAt": "2020-02-28T17:18:08Z", "path": "dockstore-webservice/src/test/java/core/WDLParseTest.java", "diffHunk": "@@ -130,6 +134,49 @@ private static SourceFile getSourceFile2() {\n     }\n \n \n+    /**\n+     * Tests that Dockstore can handle a workflow with locally recursive imports\n+     */\n+    @Test\n+    public void testLocallyRecursiveImport() {\n+        String type = \"workflow\";\n+        File recursiveWDL = new File(ResourceHelpers.resourceFilePath(\"local-recursive-import/localrecursive.wdl\"));\n+        //String primaryDescriptorFilePath = recursiveWDL.getAbsolutePath();\n+        String primaryDescriptorFilePath = \"localrecursive.wdl\";\n+        SourceFile sourceFile = new SourceFile();\n+\n+        File recursiveimportWDL = new File(ResourceHelpers.resourceFilePath(\"local-recursive-import/first-import.wdl\"));\n+        SourceFile importsourceFile = new SourceFile();\n+\n+        try {\n+            sourceFile.setContent(FileUtils.readFileToString(recursiveWDL, StandardCharsets.UTF_8));\n+            sourceFile.setAbsolutePath(\"/localrecursive.wdl\");\n+            sourceFile.setPath(\"localrecursive.wdl\");\n+            sourceFile.setType(DescriptorLanguage.FileType.DOCKSTORE_WDL);\n+\n+            importsourceFile.setContent(FileUtils.readFileToString(recursiveimportWDL, StandardCharsets.UTF_8));\n+            importsourceFile.setAbsolutePath(\"/first-import.wdl\");\n+            importsourceFile.setPath(\"first-import.wdl\");\n+            importsourceFile.setType(DescriptorLanguage.FileType.DOCKSTORE_WDL);\n+\n+            Set<SourceFile> sourceFileSet = new HashSet<>();\n+            sourceFileSet.add(sourceFile);\n+\n+            sourceFileSet.add(importsourceFile);\n+\n+            WDLHandler wdlHandler = new WDLHandler();\n+            VersionTypeValidation validation = wdlHandler.validateEntrySet(sourceFileSet, primaryDescriptorFilePath, type);\n+            assertFalse(validation.isValid());\n+            // Go through message part and verify it says 'Recursive local import detected'\n+            Optional<String> validationEntryMap = validation.getMessage().values().stream()\n+                    .filter(msg -> StringUtils.contains(msg, \"Recursive local import detected\")).findAny();", "originalCommit": "de19fe1cb7fa70c3229831e0f2099241487c2056", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjczMTYzNg==", "url": "https://github.com/dockstore/dockstore/pull/3272#discussion_r386731636", "bodyText": "changed findAny to anyMatch", "author": "wshands", "createdAt": "2020-03-03T00:24:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgyMDM5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgzMDg1Mg==", "url": "https://github.com/dockstore/dockstore/pull/3272#discussion_r385830852", "bodyText": "This code mostly duplicates similary code in parseWorkflowContent. Could you create a new function and call from both places?", "author": "coverbeck", "createdAt": "2020-02-28T17:39:53Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/WDLHandler.java", "diffHunk": "@@ -226,6 +226,16 @@ public VersionTypeValidation validateEntrySet(Set<SourceFile> sourcefiles, Strin\n                 String content = FileUtils.readFileToString(tempMainDescriptor, StandardCharsets.UTF_8);\n                 checkForRecursiveHTTPImports(content, new HashSet<>());\n \n+                // Check for local recursive imports in the WDL files", "originalCommit": "de19fe1cb7fa70c3229831e0f2099241487c2056", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk1MTI5OA==", "url": "https://github.com/dockstore/dockstore/pull/3272#discussion_r385951298", "bodyText": "Other thought: If this is similar to parseWorkflowContent, does it mean we end up looking through all the imports twice?\nIs there a way to avoid this?", "author": "denis-yuen", "createdAt": "2020-02-28T22:27:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgzMDg1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjczMTcwMA==", "url": "https://github.com/dockstore/dockstore/pull/3272#discussion_r386731700", "bodyText": "added a new function", "author": "wshands", "createdAt": "2020-03-03T00:24:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgzMDg1Mg=="}], "type": "inlineReview"}, {"oid": "88e5ae0e36a7206777da3505b87b07a9875f9f34", "url": "https://github.com/dockstore/dockstore/commit/88e5ae0e36a7206777da3505b87b07a9875f9f34", "message": "add new local recursive check function", "committedDate": "2020-03-03T00:22:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjgxNjYwOQ==", "url": "https://github.com/dockstore/dockstore/pull/3272#discussion_r386816609", "bodyText": "This feels wrong to either append the result to an existing map or create a new map -- it's not very functional.\nI would suggest changing this method to just return an Optional, then have the caller append to the result to the map, if present. The caller will have the key.", "author": "coverbeck", "createdAt": "2020-03-03T06:12:19Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/WDLHandler.java", "diffHunk": "@@ -173,6 +171,31 @@ public Version parseWorkflowContent(String filepath, String content, Set<SourceF\n         return version;\n     }\n \n+\n+    /**\n+     * A common helper method for checking for local recursive imports\n+     * @param primaryDescriptorContent content of primary descriptor\n+     * @param sourcefiles Set of sourcefiles to validate\n+     * @param primaryDescriptorFilePath Path of primary descriptor\n+     * @param validationMessageObject Object in which to store messages\n+     * @return an optional validationMessageObject\n+     */\n+    public Optional<Map<String, String>>  reportValidationForLocalRecursiveImports(String primaryDescriptorContent, Set<SourceFile> sourcefiles,\n+            String primaryDescriptorFilePath, Map<String, String> validationMessageObject) {\n+        try {\n+            String parent = primaryDescriptorFilePath.startsWith(\"/\") ? new File(primaryDescriptorFilePath).getParent() : \"/\";\n+            checkForRecursiveLocalImports(primaryDescriptorContent, sourcefiles, new HashSet<>(), parent);\n+        } catch (ParseException e) {\n+            LOG.error(\"Recursive local imports found: \", e);\n+            if (validationMessageObject == null) {", "originalCommit": "88e5ae0e36a7206777da3505b87b07a9875f9f34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3MzA2MQ==", "url": "https://github.com/dockstore/dockstore/pull/3272#discussion_r387973061", "bodyText": "fixed; now returns an Optional String", "author": "wshands", "createdAt": "2020-03-04T22:28:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjgxNjYwOQ=="}], "type": "inlineReview"}, {"oid": "8fd27c81874e4d222bb0180a0d6867d8cc89209c", "url": "https://github.com/dockstore/dockstore/commit/8fd27c81874e4d222bb0180a0d6867d8cc89209c", "message": "fix recursive import check to return just an optional", "committedDate": "2020-03-04T00:10:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ1MDgxOQ==", "url": "https://github.com/dockstore/dockstore/pull/3272#discussion_r388450819", "bodyText": "Returns a string", "author": "coverbeck", "createdAt": "2020-03-05T17:34:39Z", "path": "dockstore-webservice/src/main/java/io/dockstore/webservice/languages/WDLHandler.java", "diffHunk": "@@ -173,6 +173,26 @@ public Version parseWorkflowContent(String filepath, String content, Set<SourceF\n         return version;\n     }\n \n+\n+    /**\n+     * A common helper method for checking for local recursive imports\n+     * @param primaryDescriptorContent content of primary descriptor\n+     * @param sourcefiles Set of sourcefiles to validate\n+     * @param primaryDescriptorFilePath Path of primary descriptor\n+     * @return an optional validationMessageObject", "originalCommit": "8fd27c81874e4d222bb0180a0d6867d8cc89209c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODY0MDk5MA==", "url": "https://github.com/dockstore/dockstore/pull/3272#discussion_r388640990", "bodyText": "Fixed", "author": "wshands", "createdAt": "2020-03-06T00:22:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ1MDgxOQ=="}], "type": "inlineReview"}, {"oid": "7155be2eee1d2392951a30179c1b9c91c9a0866d", "url": "https://github.com/dockstore/dockstore/commit/7155be2eee1d2392951a30179c1b9c91c9a0866d", "message": "fix parameter comment", "committedDate": "2020-03-06T00:21:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkwODM3NQ==", "url": "https://github.com/dockstore/dockstore/pull/3272#discussion_r388908375", "bodyText": "If keeping this commented code in the PR I would add a note saying why it is there.", "author": "agduncan94", "createdAt": "2020-03-06T13:42:24Z", "path": "dockstore-webservice/src/test/java/core/WDLParseTest.java", "diffHunk": "@@ -130,6 +134,47 @@ private static SourceFile getSourceFile2() {\n     }\n \n \n+    /**\n+     * Tests that Dockstore can handle a workflow with locally recursive imports\n+     */\n+    @Test\n+    public void testLocallyRecursiveImport() {\n+        String type = \"workflow\";\n+        File recursiveWDL = new File(ResourceHelpers.resourceFilePath(\"local-recursive-import/localrecursive.wdl\"));\n+        //String primaryDescriptorFilePath = recursiveWDL.getAbsolutePath();", "originalCommit": "7155be2eee1d2392951a30179c1b9c91c9a0866d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTAxMTQzOA==", "url": "https://github.com/dockstore/dockstore/pull/3272#discussion_r389011438", "bodyText": "fixed removed commented code", "author": "wshands", "createdAt": "2020-03-06T16:39:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkwODM3NQ=="}], "type": "inlineReview"}, {"oid": "460a66db2618fc4f20de3d65bd53e71766a8fbd6", "url": "https://github.com/dockstore/dockstore/commit/460a66db2618fc4f20de3d65bd53e71766a8fbd6", "message": "remove commented code", "committedDate": "2020-03-06T16:38:18Z", "type": "commit"}, {"oid": "f1a14af41b345ae6a14c0f199e3c4b04c70e8010", "url": "https://github.com/dockstore/dockstore/commit/f1a14af41b345ae6a14c0f199e3c4b04c70e8010", "message": "Merge branch 'develop' into feature/local-recursive-import", "committedDate": "2020-03-10T16:18:21Z", "type": "commit"}]}