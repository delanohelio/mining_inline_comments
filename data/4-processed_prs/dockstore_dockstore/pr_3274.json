{"pr_number": 3274, "pr_title": "hook up checksums to trs", "pr_createdAt": "2020-02-26T23:51:44Z", "pr_url": "https://github.com/dockstore/dockstore/pull/3274", "timeline": [{"oid": "0de78bf27751f0ecd84d1c2ad03301314ba267bd", "url": "https://github.com/dockstore/dockstore/commit/0de78bf27751f0ecd84d1c2ad03301314ba267bd", "message": "hook up checksums to trs", "committedDate": "2020-02-26T23:50:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0MTk3MA==", "url": "https://github.com/dockstore/dockstore/pull/3274#discussion_r384841970", "bodyText": "I think you should restore this line, change it to toolVersion.setIsProduction(version.isFrozen()), then get rid of the else on line 162.", "author": "coverbeck", "createdAt": "2020-02-27T00:07:05Z", "path": "dockstore-webservice/src/main/java/io/swagger/api/impl/ToolsImplCommon.java", "diffHunk": "@@ -155,7 +156,12 @@ public static Tool convertEntryToTool(Entry<?, ?> container, DockstoreWebservice\n             //TODO: would hook up identified tools that form workflows here\n             toolVersion.setIncludedApps(MoreObjects.firstNonNull(toolVersion.getIncludedApps(), Lists.newArrayList()));\n             //TODO: hook up snapshot and checksum behaviour here\n-            toolVersion.setIsProduction(false);", "originalCommit": "0de78bf27751f0ecd84d1c2ad03301314ba267bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0MjYyOA==", "url": "https://github.com/dockstore/dockstore/pull/3274#discussion_r384842628", "bodyText": "It doesn't look like procesImageDataforWorkflowVersions returns a null (nor should it), so this line is unnecessary.", "author": "coverbeck", "createdAt": "2020-02-27T00:09:11Z", "path": "dockstore-webservice/src/main/java/io/swagger/api/impl/ToolsImplCommon.java", "diffHunk": "@@ -155,7 +156,12 @@ public static Tool convertEntryToTool(Entry<?, ?> container, DockstoreWebservice\n             //TODO: would hook up identified tools that form workflows here\n             toolVersion.setIncludedApps(MoreObjects.firstNonNull(toolVersion.getIncludedApps(), Lists.newArrayList()));\n             //TODO: hook up snapshot and checksum behaviour here\n-            toolVersion.setIsProduction(false);\n+            if (version.isFrozen()) {\n+                List<ImageData> trsImages = processImageDataForWorkflowVersions(version, toolVersion);\n+                toolVersion.setImages(MoreObjects.firstNonNull(trsImages, Lists.newArrayList()));", "originalCommit": "0de78bf27751f0ecd84d1c2ad03301314ba267bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0MzM1NQ==", "url": "https://github.com/dockstore/dockstore/pull/3274#discussion_r384843355", "bodyText": "I would get rid of this (see above comment). This is a side-effect and generally not a recommended practice -- I would expect a method with a signature like this to return a List, not return a List and modify an object.", "author": "coverbeck", "createdAt": "2020-02-27T00:11:28Z", "path": "dockstore-webservice/src/main/java/io/swagger/api/impl/ToolsImplCommon.java", "diffHunk": "@@ -230,6 +236,32 @@ public static Tool convertEntryToTool(Entry<?, ?> container, DockstoreWebservice\n         return tool;\n     }\n \n+    private static List<ImageData> processImageDataForWorkflowVersions(final Version version, final ToolVersion toolVersion) {\n+        toolVersion.setIsProduction(true);", "originalCommit": "0de78bf27751f0ecd84d1c2ad03301314ba267bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0NDQ0Ng==", "url": "https://github.com/dockstore/dockstore/pull/3274#discussion_r384844446", "bodyText": "This is fine, but in the future you might want to look at using map instead as an alternative and slightly more functional way (fix not required). And also for the outer loop.", "author": "coverbeck", "createdAt": "2020-02-27T00:15:22Z", "path": "dockstore-webservice/src/main/java/io/swagger/api/impl/ToolsImplCommon.java", "diffHunk": "@@ -230,6 +236,32 @@ public static Tool convertEntryToTool(Entry<?, ?> container, DockstoreWebservice\n         return tool;\n     }\n \n+    private static List<ImageData> processImageDataForWorkflowVersions(final Version version, final ToolVersion toolVersion) {\n+        toolVersion.setIsProduction(true);\n+        Set<Image> images = version.getImages();\n+        List<ImageData> trsImages = new ArrayList<>();\n+\n+        for (Image image : images) {\n+            ImageData imageData = new ImageData();\n+            imageData.setImageType(ImageType.DOCKER);\n+            //TODO: For workflows, it's just quay for now, but that'll change. Should add column in image table to store registry.\n+            imageData.setRegistryHost(\"quay.io\");\n+            imageData.setImageName(constructName(Arrays.asList(image.getRepository(), image.getTag())));\n+            List<Checksum> trsChecksums = new ArrayList<>();\n+            List<io.dockstore.webservice.core.Checksum> checksumList = image.getChecksums();\n+\n+            for (io.dockstore.webservice.core.Checksum checksum : checksumList) {", "originalCommit": "0de78bf27751f0ecd84d1c2ad03301314ba267bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0NDk4OQ==", "url": "https://github.com/dockstore/dockstore/pull/3274#discussion_r384844989", "bodyText": "I know it's for now, but this sort of scares me if we get distracted and don't come back to it. Is there a ticket for this?", "author": "coverbeck", "createdAt": "2020-02-27T00:17:06Z", "path": "dockstore-webservice/src/main/java/io/swagger/api/impl/ToolsImplCommon.java", "diffHunk": "@@ -230,6 +236,32 @@ public static Tool convertEntryToTool(Entry<?, ?> container, DockstoreWebservice\n         return tool;\n     }\n \n+    private static List<ImageData> processImageDataForWorkflowVersions(final Version version, final ToolVersion toolVersion) {\n+        toolVersion.setIsProduction(true);\n+        Set<Image> images = version.getImages();\n+        List<ImageData> trsImages = new ArrayList<>();\n+\n+        for (Image image : images) {\n+            ImageData imageData = new ImageData();\n+            imageData.setImageType(ImageType.DOCKER);\n+            //TODO: For workflows, it's just quay for now, but that'll change. Should add column in image table to store registry.\n+            imageData.setRegistryHost(\"quay.io\");", "originalCommit": "0de78bf27751f0ecd84d1c2ad03301314ba267bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg1MTk0Mw==", "url": "https://github.com/dockstore/dockstore/pull/3274#discussion_r384851943", "bodyText": "It was something I realized while doing this PR, so just made an issue here #3275", "author": "NatalieEO", "createdAt": "2020-02-27T00:39:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0NDk4OQ=="}], "type": "inlineReview"}, {"oid": "867843968c4ab4dde380703904dbd9e6914d4cea", "url": "https://github.com/dockstore/dockstore/commit/867843968c4ab4dde380703904dbd9e6914d4cea", "message": "pr request changes", "committedDate": "2020-02-27T00:55:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTE5MDMyOQ==", "url": "https://github.com/dockstore/dockstore/pull/3274#discussion_r385190329", "bodyText": "Will pass if something horribly breaks and there are no versions, should have an assert that this is working as expected and that there are versions (and if I understand the intent, that that one of them should be the snapShottedVersionName)", "author": "denis-yuen", "createdAt": "2020-02-27T15:34:47Z", "path": "dockstore-integration-testing/src/test/java/io/dockstore/client/cli/WorkflowIT.java", "diffHunk": "@@ -867,6 +877,20 @@ public void testGettingImagesFromQuay() {\n         WorkflowVersion versionWithDuplicateImages = snapshotWorkflowVersion(workflowsApi, \"dockstore-testing/zhanghj-8555114\", \"/main.cwl\", \"1.0\");\n         assertEquals(\"Should have grabbed 3 images\", 3, versionWithDuplicateImages.getImages().size());\n         verifyChecksumsAreSaved(versionWithDuplicateImages);\n+        versions = ga4Ghv20Api.toolsIdVersionsGet(\"#workflow/github.com/dockstore-testing/zhanghj-8555114\");\n+        testTRSConversion(versions, \"1.0\", 3);\n+    }\n+\n+    private void testTRSConversion(final List<ToolVersion> versions, String snapShottedVersionName, final int numImages) {\n+        for (ToolVersion trsVersion : versions) {", "originalCommit": "867843968c4ab4dde380703904dbd9e6914d4cea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0a7b04ce8dfb6a06321489d27c2150bf3e43936c", "url": "https://github.com/dockstore/dockstore/commit/0a7b04ce8dfb6a06321489d27c2150bf3e43936c", "message": "check for versions in test", "committedDate": "2020-02-27T17:10:54Z", "type": "commit"}, {"oid": "5ff66460efcac18fd7dcf7750c11106e3e6c19a1", "url": "https://github.com/dockstore/dockstore/commit/5ff66460efcac18fd7dcf7750c11106e3e6c19a1", "message": "codacy suggestions", "committedDate": "2020-02-27T19:51:46Z", "type": "commit"}, {"oid": "9b9d91e9d8cbc9252af255d378423cf01f854a2c", "url": "https://github.com/dockstore/dockstore/commit/9b9d91e9d8cbc9252af255d378423cf01f854a2c", "message": "codacy suggestions", "committedDate": "2020-02-27T19:52:08Z", "type": "commit"}]}