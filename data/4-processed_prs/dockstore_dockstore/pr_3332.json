{"pr_number": 3332, "pr_title": "hook up checksums to trs", "pr_createdAt": "2020-03-18T23:13:53Z", "pr_url": "https://github.com/dockstore/dockstore/pull/3332", "timeline": [{"oid": "d8b91ee714b711138097e7f8755c702fcfd411d8", "url": "https://github.com/dockstore/dockstore/commit/d8b91ee714b711138097e7f8755c702fcfd411d8", "message": "hook up checksums to trs, getDockerPath for registry", "committedDate": "2020-03-18T23:03:16Z", "type": "commit"}, {"oid": "1cfb107d82e52dde0871830cd928e45555bf6b0a", "url": "https://github.com/dockstore/dockstore/commit/1cfb107d82e52dde0871830cd928e45555bf6b0a", "message": "forgot to commit these files", "committedDate": "2020-03-18T23:11:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcxODMwNg==", "url": "https://github.com/dockstore/dockstore/pull/3332#discussion_r394718306", "bodyText": "Isn't the Dockerfile the... Dockerfile? Isn't this supposed to be for the descriptor files? I guess Descriptor is overloaded, but I was thinking of it in terms of source file descriptors.", "author": "coverbeck", "createdAt": "2020-03-19T00:22:40Z", "path": "dockstore-webservice/src/main/java/io/openapi/api/impl/ToolsApiServiceImpl.java", "diffHunk": "@@ -515,7 +517,7 @@ private Response getFileByToolVersionID(String registryId, String versionIdParam\n                 if (potentialDockerfile.isPresent()) {\n                     ExtendedFileWrapper dockerfile = new ExtendedFileWrapper();\n                     //TODO: hook up file checksum here\n-                    dockerfile.setChecksum(Lists.newArrayList());\n+                    dockerfile.setChecksum(getFileDescriptorChecksumsForTrs(potentialDockerfile.get()));", "originalCommit": "1cfb107d82e52dde0871830cd928e45555bf6b0a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU4NjE5OQ==", "url": "https://github.com/dockstore/dockstore/pull/3332#discussion_r396586199", "bodyText": "I haven't implemented calculating the checksum for tool dockerfiles/descriptor files. I hooked this up in advance since I was already in the area, but it should continue returning an empty arraylist for now. As for whether we should or not, I'm not sure. I supposed @denis-yuen wanted it because he left the to-do, but maybe it was accidental.", "author": "NatalieEO", "createdAt": "2020-03-23T16:31:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcxODMwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYyMjI4MQ==", "url": "https://github.com/dockstore/dockstore/pull/3332#discussion_r396622281", "bodyText": "I don't see much harm in getting checksums for everything and sorting it out later.", "author": "denis-yuen", "createdAt": "2020-03-23T17:21:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcxODMwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY3MjE3NQ==", "url": "https://github.com/dockstore/dockstore/pull/3332#discussion_r396672175", "bodyText": "I think you should rename this method to getSourceFileChecksums or getSourceFileChecksumsForTrs (I prefer the former). I think this caused the confusion on my other comment -- you're calling a method that says get file descriptor checksums, but then pass it a Dockerfile.", "author": "coverbeck", "createdAt": "2020-03-23T18:35:04Z", "path": "dockstore-webservice/src/main/java/io/openapi/api/impl/ToolsApiServiceImpl.java", "diffHunk": "@@ -567,6 +569,19 @@ private Response getFileByToolVersionID(String registryId, String versionIdParam\n         return Response.status(status).build();\n     }\n \n+    public static List<Checksum> getFileDescriptorChecksumsForTrs(final SourceFile sourceFile) {", "originalCommit": "1cfb107d82e52dde0871830cd928e45555bf6b0a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjczMTY1Ng==", "url": "https://github.com/dockstore/dockstore/pull/3332#discussion_r396731656", "bodyText": "On further reflection, ...forTrs is OK; I skimmed it the first time, not realizing the checksum is represented in two ways.", "author": "coverbeck", "createdAt": "2020-03-23T20:19:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY3MjE3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY3MzY1Ng==", "url": "https://github.com/dockstore/dockstore/pull/3332#discussion_r396673656", "bodyText": "If sourceFile.getChecksums() returns a non-empty value, this method will return an empty ArrayList, which on line 520 you will use to overwrite the existing checksums.", "author": "coverbeck", "createdAt": "2020-03-23T18:37:25Z", "path": "dockstore-webservice/src/main/java/io/openapi/api/impl/ToolsApiServiceImpl.java", "diffHunk": "@@ -567,6 +569,19 @@ private Response getFileByToolVersionID(String registryId, String versionIdParam\n         return Response.status(status).build();\n     }\n \n+    public static List<Checksum> getFileDescriptorChecksumsForTrs(final SourceFile sourceFile) {\n+        List<Checksum> trsChecksums = new ArrayList<>();\n+        if (sourceFile.getChecksums() != null && !sourceFile.getChecksums().isEmpty()) {", "originalCommit": "1cfb107d82e52dde0871830cd928e45555bf6b0a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjczMjg4MQ==", "url": "https://github.com/dockstore/dockstore/pull/3332#discussion_r396732881", "bodyText": "My comment was wrong about line 520; you are using it with a new Dockerfile, so there won't be an existing checksum that gets overridden.", "author": "coverbeck", "createdAt": "2020-03-23T20:21:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY3MzY1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjczNDk3Ng==", "url": "https://github.com/dockstore/dockstore/pull/3332#discussion_r396734976", "bodyText": "At this point it's not an issue, but what if we end up storing an MD5 checksum?", "author": "coverbeck", "createdAt": "2020-03-23T20:25:54Z", "path": "dockstore-webservice/src/main/java/io/openapi/api/impl/ToolsApiServiceImpl.java", "diffHunk": "@@ -567,6 +569,19 @@ private Response getFileByToolVersionID(String registryId, String versionIdParam\n         return Response.status(status).build();\n     }\n \n+    public static List<Checksum> getFileDescriptorChecksumsForTrs(final SourceFile sourceFile) {\n+        List<Checksum> trsChecksums = new ArrayList<>();\n+        if (sourceFile.getChecksums() != null && !sourceFile.getChecksums().isEmpty()) {\n+            sourceFile.getChecksums().stream().forEach(checksum -> {\n+                Checksum trsChecksum = new Checksum();\n+                trsChecksum.setType(DESCRIPTOR_FILE_SHA_TYPE_FOR_TRS);", "originalCommit": "1cfb107d82e52dde0871830cd928e45555bf6b0a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjczOTQ5Ng==", "url": "https://github.com/dockstore/dockstore/pull/3332#discussion_r396739496", "bodyText": "yeah, I'd have to write a smarter converter. TRS wants the type to match a certain format, but when doing the checksum calculation in java the type doesn't match. Denis prefers we keep the java version as what we store in our db, and just do the conversion for what trs wants here.", "author": "NatalieEO", "createdAt": "2020-03-23T20:33:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjczNDk3Ng=="}], "type": "inlineReview"}, {"oid": "65300f080007e6e3b7d831317ac1246d54768444", "url": "https://github.com/dockstore/dockstore/commit/65300f080007e6e3b7d831317ac1246d54768444", "message": "rename function", "committedDate": "2020-03-23T20:35:28Z", "type": "commit"}]}