{"pr_number": 1228, "pr_title": "Dockerhub images", "pr_createdAt": "2020-04-22T12:23:36Z", "pr_url": "https://github.com/kframework/k/pull/1228", "timeline": [{"oid": "5dd5a75fd805a0785bbcb9bf51bec0bfaf99173c", "url": "https://github.com/kframework/k/commit/5dd5a75fd805a0785bbcb9bf51bec0bfaf99173c", "message": "package/docker/Dockerfile.ubuntu-bionic: no need for sudo before switching users", "committedDate": "2020-04-22T13:38:46Z", "type": "forcePushed"}, {"oid": "490cebd7d2154b4e500904ec785f713431e46c84", "url": "https://github.com/kframework/k/commit/490cebd7d2154b4e500904ec785f713431e46c84", "message": "!!! Jenkinsfile: debugging", "committedDate": "2020-04-22T13:49:07Z", "type": "forcePushed"}, {"oid": "42fe9490b74bdf5f162ac7836fc15c06366cee21", "url": "https://github.com/kframework/k/commit/42fe9490b74bdf5f162ac7836fc15c06366cee21", "message": "!!! Jenkinsfile: debugging", "committedDate": "2020-04-22T15:33:48Z", "type": "forcePushed"}, {"oid": "0cb86d35914ac7244c430a94c1183ec3ff808ce4", "url": "https://github.com/kframework/k/commit/0cb86d35914ac7244c430a94c1183ec3ff808ce4", "message": "!!! Jenkinsfile: debugging", "committedDate": "2020-04-22T16:22:32Z", "type": "forcePushed"}, {"oid": "6f2f4d3babc79284c9087997701c21737b453209", "url": "https://github.com/kframework/k/commit/6f2f4d3babc79284c9087997701c21737b453209", "message": "package/docker/Dockerfile.ubuntu-bionic: set timezone", "committedDate": "2020-04-23T11:54:44Z", "type": "forcePushed"}, {"oid": "6f5db996a94a29e35227556f90840552aa9c8317", "url": "https://github.com/kframework/k/commit/6f5db996a94a29e35227556f90840552aa9c8317", "message": "Merge branch 'packaging-subdirectory' into dockerhub-images", "committedDate": "2020-04-23T12:27:49Z", "type": "forcePushed"}, {"oid": "5a479c9cafb4d82f14436dcc8f03681b98e18685", "url": "https://github.com/kframework/k/commit/5a479c9cafb4d82f14436dcc8f03681b98e18685", "message": "package/docker/Dockerfile.ubuntu-bionic: do all installation at once", "committedDate": "2020-04-24T09:05:50Z", "type": "forcePushed"}, {"oid": "8a15b8f4664fd61408e3933e97186177d8e655f8", "url": "https://github.com/kframework/k/commit/8a15b8f4664fd61408e3933e97186177d8e655f8", "message": "package/docker/Dockerfile.ubuntu-bionic: do all installation at once", "committedDate": "2020-04-24T09:21:32Z", "type": "forcePushed"}, {"oid": "cd677ec35460175c4a3e511b34e4a5a8b0137ebd", "url": "https://github.com/kframework/k/commit/cd677ec35460175c4a3e511b34e4a5a8b0137ebd", "message": "Jenkinsfile, package/docker: use focal fossa distribution", "committedDate": "2020-04-27T15:27:18Z", "type": "forcePushed"}, {"oid": "5988d1c101836a9ad9c66b0498635ffdf6a17b6a", "url": "https://github.com/kframework/k/commit/5988d1c101836a9ad9c66b0498635ffdf6a17b6a", "message": "!!! Jenkinsfile: debugging", "committedDate": "2020-04-27T15:20:59Z", "type": "forcePushed"}, {"oid": "c221f49e641b3677aa90448a25a582f344e8c53c", "url": "https://github.com/kframework/k/commit/c221f49e641b3677aa90448a25a582f344e8c53c", "message": "Dockerfile, Jenkinsfile, package/docker/Dockerfile.ubuntu-bionic: build dockerhub image of bionic package", "committedDate": "2020-04-27T16:45:16Z", "type": "commit"}, {"oid": "bc07f2f08fd36389b8695afe8196bbeea0e27043", "url": "https://github.com/kframework/k/commit/bc07f2f08fd36389b8695afe8196bbeea0e27043", "message": "package/docker/Dockerfile.ubuntu-bionic: take advantage of WORKDIR", "committedDate": "2020-04-27T16:45:16Z", "type": "commit"}, {"oid": "c1bec32985ab004149534c4dddc11f0d076491f7", "url": "https://github.com/kframework/k/commit/c1bec32985ab004149534c4dddc11f0d076491f7", "message": "package/docker/Dockerfile.ubuntu-bionic: no need for K_VERSION", "committedDate": "2020-04-27T16:45:16Z", "type": "commit"}, {"oid": "37de9b53ac46006d442d43323aef750c4f50ab64", "url": "https://github.com/kframework/k/commit/37de9b53ac46006d442d43323aef750c4f50ab64", "message": "package/docker/Dockerfile.ubuntu-bionic: no need for sudo before switching users", "committedDate": "2020-04-27T16:45:16Z", "type": "commit"}, {"oid": "91e35ff8994ae374ae28d29b0158dfd9941e37df", "url": "https://github.com/kframework/k/commit/91e35ff8994ae374ae28d29b0158dfd9941e37df", "message": "Jenkinsfile: common Deploy phase", "committedDate": "2020-04-27T16:45:16Z", "type": "commit"}, {"oid": "a37afe38e037f45d0af3a8815c3dc83d2f9cd10c", "url": "https://github.com/kframework/k/commit/a37afe38e037f45d0af3a8815c3dc83d2f9cd10c", "message": "Dockerfile: add sudo", "committedDate": "2020-04-27T16:45:16Z", "type": "commit"}, {"oid": "2b96e8e05671c37bc65e9b12521163a9d209a3fa", "url": "https://github.com/kframework/k/commit/2b96e8e05671c37bc65e9b12521163a9d209a3fa", "message": "Jenkinsfile: make sure we can talk to host docker agent", "committedDate": "2020-04-27T16:45:16Z", "type": "commit"}, {"oid": "b646e85359c86a8b3a633a7f33d666549076c3b7", "url": "https://github.com/kframework/k/commit/b646e85359c86a8b3a633a7f33d666549076c3b7", "message": "package/docker/Dockerfile.ubuntu-bionic: correct local path", "committedDate": "2020-04-27T16:45:16Z", "type": "commit"}, {"oid": "c6d22c2e093974993fdf6323e8f3809965d6fbeb", "url": "https://github.com/kframework/k/commit/c6d22c2e093974993fdf6323e8f3809965d6fbeb", "message": "Jenkinsfile: login to dockerhub before attempting push", "committedDate": "2020-04-27T16:45:16Z", "type": "commit"}, {"oid": "2eeaebd8342a1fc7d734057dd87634358d6cba5b", "url": "https://github.com/kframework/k/commit/2eeaebd8342a1fc7d734057dd87634358d6cba5b", "message": "Jenkinsfile: sudo before docker login", "committedDate": "2020-04-27T16:45:16Z", "type": "commit"}, {"oid": "01212bc67724739c88869258338e1fdfe7372263", "url": "https://github.com/kframework/k/commit/01212bc67724739c88869258338e1fdfe7372263", "message": "Jenkinsfile: use ehildenbs token for now", "committedDate": "2020-04-27T16:45:16Z", "type": "commit"}, {"oid": "92ebb02b96d1693a2f41ea39fd67f82a3c9d7db1", "url": "https://github.com/kframework/k/commit/92ebb02b96d1693a2f41ea39fd67f82a3c9d7db1", "message": "Jenkinsfile: correct bionic_tag name", "committedDate": "2020-04-27T16:45:16Z", "type": "commit"}, {"oid": "6895ab3a4f1234e406e1bc88341dde6947d4d6ea", "url": "https://github.com/kframework/k/commit/6895ab3a4f1234e406e1bc88341dde6947d4d6ea", "message": "Jenkinsfile: correct tag-name login for new repo", "committedDate": "2020-04-27T16:45:16Z", "type": "commit"}, {"oid": "a5b748966c29b122dbd0de5e9a05d8ad72a3c64d", "url": "https://github.com/kframework/k/commit/a5b748966c29b122dbd0de5e9a05d8ad72a3c64d", "message": "Jenkinsfile: correctly tag image", "committedDate": "2020-04-27T16:45:16Z", "type": "commit"}, {"oid": "fe48240e0206af3c3c556fca3c4ce4bbace9dbb1", "url": "https://github.com/kframework/k/commit/fe48240e0206af3c3c556fca3c4ce4bbace9dbb1", "message": "package/docker/Dockerfile.ubuntu-bionic: install z3-4.8.6", "committedDate": "2020-04-27T16:45:16Z", "type": "commit"}, {"oid": "0f6697522ee9afaf547b3a1ef3b33f1564742624", "url": "https://github.com/kframework/k/commit/0f6697522ee9afaf547b3a1ef3b33f1564742624", "message": "package/docker/Dockerfile.ubuntu-bionic: set timezone", "committedDate": "2020-04-27T16:45:16Z", "type": "commit"}, {"oid": "c94e740e7335a849bd6be3c6207c15ca613a9c23", "url": "https://github.com/kframework/k/commit/c94e740e7335a849bd6be3c6207c15ca613a9c23", "message": "Jenkinsfile: use SHORT_REV variable", "committedDate": "2020-04-27T16:45:16Z", "type": "commit"}, {"oid": "23fe8a22a10ace1c734cc628abdfeb4e2b9f8517", "url": "https://github.com/kframework/k/commit/23fe8a22a10ace1c734cc628abdfeb4e2b9f8517", "message": "package/docker/Dockerfile.ubuntu-bionic: add git", "committedDate": "2020-04-27T16:45:16Z", "type": "commit"}, {"oid": "2165772f7be9b8629d6701d8364ea9a731aa54a1", "url": "https://github.com/kframework/k/commit/2165772f7be9b8629d6701d8364ea9a731aa54a1", "message": "package/docker/Dockerfile.ubuntu-bionic: needed dependencies for building Z3 from scratch", "committedDate": "2020-04-27T16:45:16Z", "type": "commit"}, {"oid": "41d64ecf418904f1f013dd361914f01355544dbc", "url": "https://github.com/kframework/k/commit/41d64ecf418904f1f013dd361914f01355544dbc", "message": "package/docker/Dockerfile.ubuntu-bionic: do all installation at once", "committedDate": "2020-04-27T16:45:16Z", "type": "commit"}, {"oid": "525ff4a023f0414f999eee9b658eb995338fecb7", "url": "https://github.com/kframework/k/commit/525ff4a023f0414f999eee9b658eb995338fecb7", "message": "Jenkinsfile: remove beforeAgent", "committedDate": "2020-04-27T16:45:16Z", "type": "commit"}, {"oid": "cb9fed821774501266fa9ae36348241bb7fc6894", "url": "https://github.com/kframework/k/commit/cb9fed821774501266fa9ae36348241bb7fc6894", "message": "!!! Jenkinsfile: debugging", "committedDate": "2020-04-27T16:45:16Z", "type": "forcePushed"}, {"oid": "5f5bb6b6176c76a90f14c13d18e278772d1479ac", "url": "https://github.com/kframework/k/commit/5f5bb6b6176c76a90f14c13d18e278772d1479ac", "message": "k-distribution/INSTALL: mention docker hub containers", "committedDate": "2020-04-27T18:39:13Z", "type": "commit"}, {"oid": "5f5bb6b6176c76a90f14c13d18e278772d1479ac", "url": "https://github.com/kframework/k/commit/5f5bb6b6176c76a90f14c13d18e278772d1479ac", "message": "k-distribution/INSTALL: mention docker hub containers", "committedDate": "2020-04-27T18:39:13Z", "type": "forcePushed"}, {"oid": "a57aae61c288d5247c8734c4fadd9e43e64ac11d", "url": "https://github.com/kframework/k/commit/a57aae61c288d5247c8734c4fadd9e43e64ac11d", "message": "Jenkinsfile: deploy docker image before GitHub release", "committedDate": "2020-04-27T20:40:01Z", "type": "commit"}, {"oid": "451e6d117283ad8b2d84c6a11604e749ce11f578", "url": "https://github.com/kframework/k/commit/451e6d117283ad8b2d84c6a11604e749ce11f578", "message": "Jenkinsfile, k-distribution/INSTALL: also update the latest master tag every time", "committedDate": "2020-04-27T20:46:26Z", "type": "commit"}, {"oid": "8bf9f5436405f265acebe59e3a98020975872b78", "url": "https://github.com/kframework/k/commit/8bf9f5436405f265acebe59e3a98020975872b78", "message": "Merge branch 'master' into dockerhub-images", "committedDate": "2020-04-28T07:31:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjcyMzUzNA==", "url": "https://github.com/kframework/k/pull/1228#discussion_r416723534", "bodyText": "please move this back where it was, immediately before its use. moving it to the top reduces caching in the dockerfile.", "author": "dwightguth", "createdAt": "2020-04-28T15:47:14Z", "path": "Dockerfile", "diffHunk": "@@ -1,12 +1,16 @@\n FROM ubuntu:bionic\n \n+ARG USER_ID=1000", "originalCommit": "8bf9f5436405f265acebe59e3a98020975872b78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc0OTYyMw==", "url": "https://github.com/kframework/k/pull/1228#discussion_r416749623", "bodyText": "I don't think this will reduce any cacheing, actually may improve it since these lines are more stable than the next lines (installing a bunch of stuff).\nI mostly just like having all the arguments at the top for scanability. I can move it back if you really want, but don't see the need.", "author": "ehildenb", "createdAt": "2020-04-28T16:22:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjcyMzUzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk4MDk3OQ==", "url": "https://github.com/kframework/k/pull/1228#discussion_r417980979", "bodyText": "Everything after the ARG line depends on the value of the argument, so if the user id changes, we will have to reinstall all the debian packages and stack.", "author": "dwightguth", "createdAt": "2020-04-30T12:44:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjcyMzUzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk4NTMyMA==", "url": "https://github.com/kframework/k/pull/1228#discussion_r417985320", "bodyText": "Ok, I moved it back.", "author": "ehildenb", "createdAt": "2020-04-30T12:51:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjcyMzUzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjcyNDE4MQ==", "url": "https://github.com/kframework/k/pull/1228#discussion_r416724181", "bodyText": "why did you remove the beforeAgent line?", "author": "dwightguth", "createdAt": "2020-04-28T15:48:04Z", "path": "Jenkinsfile", "diffHunk": "@@ -364,15 +364,20 @@ pipeline {\n       }\n     }\n     stage('Deploy') {\n+      when { branch 'master' }", "originalCommit": "8bf9f5436405f265acebe59e3a98020975872b78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc1NDE1OQ==", "url": "https://github.com/kframework/k/pull/1228#discussion_r416754159", "bodyText": "I put it back.", "author": "ehildenb", "createdAt": "2020-04-28T16:28:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjcyNDE4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjcyNDQ4Mg==", "url": "https://github.com/kframework/k/pull/1228#discussion_r416724482", "bodyText": "what is this doing?", "author": "dwightguth", "createdAt": "2020-04-28T15:48:29Z", "path": "Jenkinsfile", "diffHunk": "@@ -364,15 +364,20 @@ pipeline {\n       }\n     }\n     stage('Deploy') {\n+      when { branch 'master' }\n       agent {\n         dockerfile {\n           additionalBuildArgs '--build-arg USER_ID=$(id -u) --build-arg GROUP_ID=$(id -g)'\n+          args '-v /var/run/docker.sock:/var/run/docker.sock'", "originalCommit": "8bf9f5436405f265acebe59e3a98020975872b78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc1MDY3OQ==", "url": "https://github.com/kframework/k/pull/1228#discussion_r416750679", "bodyText": "This allows this docker container to speak to the LXC container docker daemon directly. Launching a docker daemon inside a docker container is strongly discouraged (see https://jpetazzo.github.io/2015/09/03/do-not-use-docker-in-docker-for-ci/), instead you are supposed to launch it using the hosts docker daemon, which this enables.\nNote this is better for cacheing the images that are build inside this container too.", "author": "ehildenb", "createdAt": "2020-04-28T16:23:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjcyNDQ4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjcyNTQwMw==", "url": "https://github.com/kframework/k/pull/1228#discussion_r416725403", "bodyText": "is this storing your password on Jenkins? we probably should not use your user account.", "author": "dwightguth", "createdAt": "2020-04-28T15:49:40Z", "path": "Jenkinsfile", "diffHunk": "@@ -381,54 +386,70 @@ pipeline {\n         GITHUB_TOKEN          = credentials('rv-jenkins')\n         GIT_SSH_COMMAND       = 'ssh -o StrictHostKeyChecking=accept-new'\n       }\n-      steps {\n-        unstash \"src\"\n-        unstash \"binary\"\n-        dir('bionic') { unstash 'bionic' }\n-        dir('buster') { unstash 'buster' }\n-        dir('arch')   { unstash 'arch'   }\n-        dir('mojave') { unstash 'mojave' }\n-        sshagent(['2b3d8d6b-0855-4b59-864a-6b3ddf9c9d1a']) {\n-          sh '''\n-            git remote add release 'ssh://github.com/kframework/k.git'\n-            git tag \"${K_RELEASE_TAG}\" \"${SHORT_REV}\"\n-            git push release \"${K_RELEASE_TAG}\"\n-\n-            mv bionic/kframework_${VERSION}_amd64.deb bionic/kframework_${VERSION}_amd64_bionic.deb\n-            mv buster/kframework_${VERSION}_amd64.deb buster/kframework_${VERSION}_amd64_buster.deb\n-            LOCAL_BOTTLE_NAME=$(echo mojave/kframework--${VERSION}.mojave.bottle*.tar.gz)\n-            BOTTLE_NAME=`cd mojave && echo kframework--${VERSION}.mojave.bottle*.tar.gz | sed 's!kframework--!kframework-!'`\n-            mv $LOCAL_BOTTLE_NAME mojave/$BOTTLE_NAME\n-            echo \"K Framework Release ${K_RELEASE_TAG}\"  > release.md\n-            echo \"\"                                     >> release.md\n-            cat k-distribution/INSTALL.md               >> release.md\n-            hub release create                                                                         \\\n-                --attach kframework-${VERSION}-src.tar.gz\"#Source tar.gz\"                              \\\n-                --attach bionic/kframework_${VERSION}_amd64_bionic.deb\"#Ubuntu Bionic (18.04) Package\" \\\n-                --attach buster/kframework_${VERSION}_amd64_buster.deb\"#Debian Buster (10) Package\"    \\\n-                --attach arch/kframework-git-${VERSION}-1-x86_64.pkg.tar.xz\"#Arch Package\"             \\\n-                --attach mojave/$BOTTLE_NAME\"#Mac OS X Homebrew Bottle\"                                \\\n-                --attach k-nightly.tar.gz\"#Platform Indepdendent K Binary\"                             \\\n-                --file release.md \"${K_RELEASE_TAG}\"\n-          '''\n-        }\n-        dir(\"homebrew-k\") {\n-          git url: 'git@github.com:kframework/homebrew-k.git', branch: 'brew-release-kframework'\n-          sshagent(['2b3d8d6b-0855-4b59-864a-6b3ddf9c9d1a']) {\n+      stages {\n+        stage('DockerHub Images') {\n+          environment { DOCKERHUB_TOKEN = credentials('dockerhub-ehildenb') }\n+          steps {\n+            dir('bionic') { unstash 'bionic' }\n             sh '''\n-              git checkout master\n-              git merge brew-release-$PACKAGE\n-              git push origin master\n-              git push origin -d brew-release-$PACKAGE\n+                sudo docker login --username ehildenb --password \"${DOCKERHUB_TOKEN}\"", "originalCommit": "8bf9f5436405f265acebe59e3a98020975872b78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkzODA4NQ==", "url": "https://github.com/kframework/k/pull/1228#discussion_r416938085", "bodyText": "Switched to rvdockerhub.", "author": "ehildenb", "createdAt": "2020-04-28T21:35:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjcyNTQwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjcyNjA3MQ==", "url": "https://github.com/kframework/k/pull/1228#discussion_r416726071", "bodyText": "running docker as root should not be necessary if you use an unprivileged container.", "author": "dwightguth", "createdAt": "2020-04-28T15:50:39Z", "path": "Jenkinsfile", "diffHunk": "@@ -381,54 +386,70 @@ pipeline {\n         GITHUB_TOKEN          = credentials('rv-jenkins')\n         GIT_SSH_COMMAND       = 'ssh -o StrictHostKeyChecking=accept-new'\n       }\n-      steps {\n-        unstash \"src\"\n-        unstash \"binary\"\n-        dir('bionic') { unstash 'bionic' }\n-        dir('buster') { unstash 'buster' }\n-        dir('arch')   { unstash 'arch'   }\n-        dir('mojave') { unstash 'mojave' }\n-        sshagent(['2b3d8d6b-0855-4b59-864a-6b3ddf9c9d1a']) {\n-          sh '''\n-            git remote add release 'ssh://github.com/kframework/k.git'\n-            git tag \"${K_RELEASE_TAG}\" \"${SHORT_REV}\"\n-            git push release \"${K_RELEASE_TAG}\"\n-\n-            mv bionic/kframework_${VERSION}_amd64.deb bionic/kframework_${VERSION}_amd64_bionic.deb\n-            mv buster/kframework_${VERSION}_amd64.deb buster/kframework_${VERSION}_amd64_buster.deb\n-            LOCAL_BOTTLE_NAME=$(echo mojave/kframework--${VERSION}.mojave.bottle*.tar.gz)\n-            BOTTLE_NAME=`cd mojave && echo kframework--${VERSION}.mojave.bottle*.tar.gz | sed 's!kframework--!kframework-!'`\n-            mv $LOCAL_BOTTLE_NAME mojave/$BOTTLE_NAME\n-            echo \"K Framework Release ${K_RELEASE_TAG}\"  > release.md\n-            echo \"\"                                     >> release.md\n-            cat k-distribution/INSTALL.md               >> release.md\n-            hub release create                                                                         \\\n-                --attach kframework-${VERSION}-src.tar.gz\"#Source tar.gz\"                              \\\n-                --attach bionic/kframework_${VERSION}_amd64_bionic.deb\"#Ubuntu Bionic (18.04) Package\" \\\n-                --attach buster/kframework_${VERSION}_amd64_buster.deb\"#Debian Buster (10) Package\"    \\\n-                --attach arch/kframework-git-${VERSION}-1-x86_64.pkg.tar.xz\"#Arch Package\"             \\\n-                --attach mojave/$BOTTLE_NAME\"#Mac OS X Homebrew Bottle\"                                \\\n-                --attach k-nightly.tar.gz\"#Platform Indepdendent K Binary\"                             \\\n-                --file release.md \"${K_RELEASE_TAG}\"\n-          '''\n-        }\n-        dir(\"homebrew-k\") {\n-          git url: 'git@github.com:kframework/homebrew-k.git', branch: 'brew-release-kframework'\n-          sshagent(['2b3d8d6b-0855-4b59-864a-6b3ddf9c9d1a']) {\n+      stages {\n+        stage('DockerHub Images') {\n+          environment { DOCKERHUB_TOKEN = credentials('dockerhub-ehildenb') }\n+          steps {\n+            dir('bionic') { unstash 'bionic' }\n             sh '''\n-              git checkout master\n-              git merge brew-release-$PACKAGE\n-              git push origin master\n-              git push origin -d brew-release-$PACKAGE\n+                sudo docker login --username ehildenb --password \"${DOCKERHUB_TOKEN}\"\n+\n+                bionic_commit_tag=\"ubuntu-bionic-${SHORT_REV}\"\n+                kframework_k_docker_repo=\"runtimeverificationinc/kframework-k\"\n+                mv bionic/kframework_${VERSION}_amd64.deb kframework_amd64_bionic.deb\n+                sudo docker image build . --file package/docker/Dockerfile.ubuntu-bionic --tag \"${kframework_k_docker_repo}:${bionic_commit_tag}\"", "originalCommit": "8bf9f5436405f265acebe59e3a98020975872b78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc1NDQ1MA==", "url": "https://github.com/kframework/k/pull/1228#discussion_r416754450", "bodyText": "I added the user to the docker group, and removed use of sudo. Need to test that it works.", "author": "ehildenb", "createdAt": "2020-04-28T16:29:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjcyNjA3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc4MjcwMA==", "url": "https://github.com/kframework/k/pull/1228#discussion_r416782700", "bodyText": "It appears not to work. I think the issue is that the docker group inside the container does not map to the same gid as the docker group on the lxc host. See this thread for a similar issue seen with Azure containers microsoft/azure-pipelines-agent#2056.\nI don't think it's really worth it investigating how to get the group maps to work, since I don't think using sudo in the main CI file is that much of a problem.", "author": "ehildenb", "createdAt": "2020-04-28T17:11:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjcyNjA3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk4NDA5Ng==", "url": "https://github.com/kframework/k/pull/1228#discussion_r417984096", "bodyText": "Doesn't running docker with sudo mean that the root user inside the container has root access outside the container? Isn't that a security problem?", "author": "dwightguth", "createdAt": "2020-04-30T12:49:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjcyNjA3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjczMDA5Ng==", "url": "https://github.com/kframework/k/pull/1228#discussion_r416730096", "bodyText": "the same problem with ARG exists here.", "author": "dwightguth", "createdAt": "2020-04-28T15:55:56Z", "path": "package/docker/Dockerfile.ubuntu-bionic", "diffHunk": "@@ -0,0 +1,36 @@\n+FROM ubuntu:bionic\n+\n+ARG USER_ID=1000", "originalCommit": "8bf9f5436405f265acebe59e3a98020975872b78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc1MTEwMg==", "url": "https://github.com/kframework/k/pull/1228#discussion_r416751102", "bodyText": "Same response. I like arguments at the top of the file, and don't think this will reduce cacheing.", "author": "ehildenb", "createdAt": "2020-04-28T16:24:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjczMDA5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk4NTQxNg==", "url": "https://github.com/kframework/k/pull/1228#discussion_r417985416", "bodyText": "Moved it back.", "author": "ehildenb", "createdAt": "2020-04-30T12:51:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjczMDA5Ng=="}], "type": "inlineReview"}, {"oid": "dc272e533767f77de20feb8948877ea1876c0c6a", "url": "https://github.com/kframework/k/commit/dc272e533767f77de20feb8948877ea1876c0c6a", "message": "Jenkinsfile: add back beforeAgent", "committedDate": "2020-04-28T16:26:18Z", "type": "commit"}, {"oid": "baffecf00b54e909fa7218321d7e32aaf86074fd", "url": "https://github.com/kframework/k/commit/baffecf00b54e909fa7218321d7e32aaf86074fd", "message": "Jenkinsfile, Dockerfile: avoid use of sudo for docker container", "committedDate": "2020-04-28T16:26:18Z", "type": "commit"}, {"oid": "933983ddc7f38d0ede87f697d7d51b5a18b1e568", "url": "https://github.com/kframework/k/commit/933983ddc7f38d0ede87f697d7d51b5a18b1e568", "message": "Jenkinsfile: formatting", "committedDate": "2020-04-28T16:27:10Z", "type": "commit"}, {"oid": "e23cdd41451dc8269d7e298a63e011e2f87cf541", "url": "https://github.com/kframework/k/commit/e23cdd41451dc8269d7e298a63e011e2f87cf541", "message": "!!! Jenkinsfile: debugging", "committedDate": "2020-04-28T16:28:04Z", "type": "commit"}, {"oid": "e449ce686d0e471178124c76563ae5be8496d10d", "url": "https://github.com/kframework/k/commit/e449ce686d0e471178124c76563ae5be8496d10d", "message": "Revert \"Jenkinsfile, Dockerfile: avoid use of sudo for docker container\"\n\nThis reverts commit baffecf00b54e909fa7218321d7e32aaf86074fd.", "committedDate": "2020-04-28T17:24:52Z", "type": "commit"}, {"oid": "143a9865050b96249302211f40b8268cb6477669", "url": "https://github.com/kframework/k/commit/143a9865050b96249302211f40b8268cb6477669", "message": "Jenkinsfile: use rvdockerhub account", "committedDate": "2020-04-28T20:42:29Z", "type": "commit"}, {"oid": "ee90cf0a00107c4ee6faeaae6029573eb2a87b76", "url": "https://github.com/kframework/k/commit/ee90cf0a00107c4ee6faeaae6029573eb2a87b76", "message": "Jenkinsfile: use correct user/password for DOCKERHUB_TOKEN", "committedDate": "2020-04-28T21:16:38Z", "type": "commit"}, {"oid": "1c32d083d2f40e9656b7e25bf64f1ef39a6895ad", "url": "https://github.com/kframework/k/commit/1c32d083d2f40e9656b7e25bf64f1ef39a6895ad", "message": "Revert \"!!! Jenkinsfile: debugging\"\n\nThis reverts commit e23cdd41451dc8269d7e298a63e011e2f87cf541.", "committedDate": "2020-04-28T21:33:53Z", "type": "commit"}, {"oid": "fb01b7f9c656b020dcc7046ccf1c2d9e8971b153", "url": "https://github.com/kframework/k/commit/fb01b7f9c656b020dcc7046ccf1c2d9e8971b153", "message": "Merge remote-tracking branch 'upstream/master' into dockerhub-images", "committedDate": "2020-04-28T21:34:31Z", "type": "commit"}, {"oid": "c97fd82b4f72b774e8e955b3920864d757957feb", "url": "https://github.com/kframework/k/commit/c97fd82b4f72b774e8e955b3920864d757957feb", "message": "Jenkinsfile: unconditionally push up to BRANCH_NAME on docker hub", "committedDate": "2020-04-29T10:53:50Z", "type": "commit"}, {"oid": "d2d4da066df4c2cbaf6a173c884c4078ec6bf9bc", "url": "https://github.com/kframework/k/commit/d2d4da066df4c2cbaf6a173c884c4078ec6bf9bc", "message": "Merge remote-tracking branch 'upstream/master' into dockerhub-images", "committedDate": "2020-04-30T12:49:45Z", "type": "commit"}, {"oid": "f71db8e27383ecacc42556db2f80d720c10ad7e5", "url": "https://github.com/kframework/k/commit/f71db8e27383ecacc42556db2f80d720c10ad7e5", "message": "Dockerfile, package/docker/Dockerfile.ubuntu-bionic: move USER_ID and GROUP_ID to where they are used", "committedDate": "2020-04-30T12:50:59Z", "type": "commit"}, {"oid": "0d32970687b6b74eef6a0652da915124d04acc12", "url": "https://github.com/kframework/k/commit/0d32970687b6b74eef6a0652da915124d04acc12", "message": "Jenkinsfile: only expose docker.sock when exactly needed", "committedDate": "2020-04-30T17:14:25Z", "type": "commit"}, {"oid": "3955107816418c0b557ef174a4f87ba86a39b1aa", "url": "https://github.com/kframework/k/commit/3955107816418c0b557ef174a4f87ba86a39b1aa", "message": "Dockerfile, Jenkinsfile: ensure that we have access to docker.sock outside container", "committedDate": "2020-04-30T17:15:51Z", "type": "commit"}, {"oid": "4db6f0d4ab9662623e239b8022697c2b934e5ca2", "url": "https://github.com/kframework/k/commit/4db6f0d4ab9662623e239b8022697c2b934e5ca2", "message": "Merge remote-tracking branch 'upstream/master' into dockerhub-images", "committedDate": "2020-04-30T17:18:32Z", "type": "commit"}, {"oid": "d1360b45dffbe218c83616426b699393e153ae3f", "url": "https://github.com/kframework/k/commit/d1360b45dffbe218c83616426b699393e153ae3f", "message": "Jenkinsfile: localize post step", "committedDate": "2020-04-30T17:27:39Z", "type": "commit"}, {"oid": "8833c4f7999fccc9281abb0d88b2cce6c033d083", "url": "https://github.com/kframework/k/commit/8833c4f7999fccc9281abb0d88b2cce6c033d083", "message": "!!! Jenkinsfile: debugging", "committedDate": "2020-04-30T17:27:39Z", "type": "commit"}, {"oid": "8833c4f7999fccc9281abb0d88b2cce6c033d083", "url": "https://github.com/kframework/k/commit/8833c4f7999fccc9281abb0d88b2cce6c033d083", "message": "!!! Jenkinsfile: debugging", "committedDate": "2020-04-30T17:27:39Z", "type": "forcePushed"}, {"oid": "88a20de3dbeeafae92cfb63dbd0890723fce1a51", "url": "https://github.com/kframework/k/commit/88a20de3dbeeafae92cfb63dbd0890723fce1a51", "message": "Merge remote-tracking branch 'upstream/master' into dockerhub-images", "committedDate": "2020-04-30T19:28:12Z", "type": "commit"}, {"oid": "96ac8f882ed9a3df4a4b8986baece65908b7efca", "url": "https://github.com/kframework/k/commit/96ac8f882ed9a3df4a4b8986baece65908b7efca", "message": "Dockerfile: group name with dash", "committedDate": "2020-04-30T19:29:26Z", "type": "commit"}, {"oid": "36fdc6e483cc79365d23131f1c7a32ab3501ac2c", "url": "https://github.com/kframework/k/commit/36fdc6e483cc79365d23131f1c7a32ab3501ac2c", "message": "Dockerfile: set default DOCKERISH_GROUP_ID", "committedDate": "2020-05-01T08:18:05Z", "type": "commit"}, {"oid": "36fdc6e483cc79365d23131f1c7a32ab3501ac2c", "url": "https://github.com/kframework/k/commit/36fdc6e483cc79365d23131f1c7a32ab3501ac2c", "message": "Dockerfile: set default DOCKERISH_GROUP_ID", "committedDate": "2020-05-01T08:18:05Z", "type": "forcePushed"}, {"oid": "f8a6217b826ead4da37be3a26a99f02f3d0dd99c", "url": "https://github.com/kframework/k/commit/f8a6217b826ead4da37be3a26a99f02f3d0dd99c", "message": "Jenkinsfile, Dockerfile: try adding docker group before installing docker", "committedDate": "2020-05-01T09:49:15Z", "type": "commit"}, {"oid": "f8a6217b826ead4da37be3a26a99f02f3d0dd99c", "url": "https://github.com/kframework/k/commit/f8a6217b826ead4da37be3a26a99f02f3d0dd99c", "message": "Jenkinsfile, Dockerfile: try adding docker group before installing docker", "committedDate": "2020-05-01T09:49:15Z", "type": "forcePushed"}, {"oid": "5c18a167104e360c4b6dbb199b856d61e613b632", "url": "https://github.com/kframework/k/commit/5c18a167104e360c4b6dbb199b856d61e613b632", "message": "Jenkinsfile, Dockerfile: run docker image build on LXC container directly", "committedDate": "2020-05-01T11:52:46Z", "type": "commit"}, {"oid": "24cda4674fff4d0d86e8101ffc7cd506d35e582b", "url": "https://github.com/kframework/k/commit/24cda4674fff4d0d86e8101ffc7cd506d35e582b", "message": "Revert \"!!! Jenkinsfile: debugging\"\n\nThis reverts commit 8833c4f7999fccc9281abb0d88b2cce6c033d083.", "committedDate": "2020-05-01T12:16:08Z", "type": "commit"}, {"oid": "e43a0060fcb48c44ed5abbce6c730506de5f4fcc", "url": "https://github.com/kframework/k/commit/e43a0060fcb48c44ed5abbce6c730506de5f4fcc", "message": "Jenkinsfile: build docker images earlier and test them", "committedDate": "2020-05-01T15:25:46Z", "type": "commit"}, {"oid": "5e4679a44c8bdd07193628ceca8147f464009c6d", "url": "https://github.com/kframework/k/commit/5e4679a44c8bdd07193628ceca8147f464009c6d", "message": "Jenkinsfile: formatting", "committedDate": "2020-05-01T15:27:05Z", "type": "commit"}, {"oid": "4d3312a04cc2fce3a54606f822ccd51ec3b96eda", "url": "https://github.com/kframework/k/commit/4d3312a04cc2fce3a54606f822ccd51ec3b96eda", "message": "Jenkinsfile: correct location for DockerHub steps", "committedDate": "2020-05-01T15:29:53Z", "type": "commit"}, {"oid": "6601cb72269e2f9fdf8dcbbbbd0c953fe656f0ff", "url": "https://github.com/kframework/k/commit/6601cb72269e2f9fdf8dcbbbbd0c953fe656f0ff", "message": "!!! Jenkinsfile: debugging", "committedDate": "2020-05-01T15:30:17Z", "type": "commit"}, {"oid": "39353b0e5e0bc15c65b75535d7b53674cb460f44", "url": "https://github.com/kframework/k/commit/39353b0e5e0bc15c65b75535d7b53674cb460f44", "message": "Merge remote-tracking branch 'upstream/master' into dockerhub-images", "committedDate": "2020-05-01T15:31:19Z", "type": "commit"}, {"oid": "f07c5dfd70d24d017c2786c014ed868e32ee8c98", "url": "https://github.com/kframework/k/commit/f07c5dfd70d24d017c2786c014ed868e32ee8c98", "message": "Revert \"!!! Jenkinsfile: debugging\"\n\nThis reverts commit 6601cb72269e2f9fdf8dcbbbbd0c953fe656f0ff.", "committedDate": "2020-05-01T16:32:29Z", "type": "commit"}]}