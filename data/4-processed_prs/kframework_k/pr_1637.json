{"pr_number": 1637, "pr_title": "Better defined ARRAY Lookup", "pr_createdAt": "2020-11-10T19:04:49Z", "pr_url": "https://github.com/kframework/k/pull/1637", "timeline": [{"oid": "a32b826c588c7e6134e7eba88c042ef476a014f6", "url": "https://github.com/kframework/k/commit/a32b826c588c7e6134e7eba88c042ef476a014f6", "message": "domains.md: Make ARRAY lookup semantics better defined", "committedDate": "2020-11-10T18:57:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwNzYwMw==", "url": "https://github.com/kframework/k/pull/1637#discussion_r520807603", "bodyText": "I think for completeness you need to say 0 <=Int IDX andBool IDX <Int size(L)", "author": "ehildenb", "createdAt": "2020-11-10T19:06:09Z", "path": "k-distribution/include/kframework/builtin/domains.md", "diffHunk": "@@ -159,7 +159,8 @@ of any of the syntax defined in any of these modules.\n \n   rule makeArray(I::Int, D::KItem) => arr(.List, I, D)\n \n-  rule arr(L::List, _, D::KItem) [ IDX::Int ] => #if IDX >=Int size(L) #then D #else L[IDX] #fi\n+  rule arr(L::List, _, _       ) [ IDX::Int ] => L[IDX] requires IDX <Int size(L)", "originalCommit": "a32b826c588c7e6134e7eba88c042ef476a014f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "aeef8b27bb69db8269bbb25dd8c13ba48aa3c205", "url": "https://github.com/kframework/k/commit/aeef8b27bb69db8269bbb25dd8c13ba48aa3c205", "message": "domains.md: Require positive index for array lookup", "committedDate": "2020-11-10T19:15:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgxNTQ4OQ==", "url": "https://github.com/kframework/k/pull/1637#discussion_r520815489", "bodyText": "These rules don't cover the case that IDX <Int 0 though, which we should cover I think to keep it total. I would stick with the owise rule.", "author": "ehildenb", "createdAt": "2020-11-10T19:19:56Z", "path": "k-distribution/include/kframework/builtin/domains.md", "diffHunk": "@@ -159,8 +159,8 @@ of any of the syntax defined in any of these modules.\n \n   rule makeArray(I::Int, D::KItem) => arr(.List, I, D)\n \n-  rule arr(L::List, _, _       ) [ IDX::Int ] => L[IDX] requires IDX <Int size(L)\n-  rule arr(_      , _, D::KItem) [ _        ] => D      [owise]\n+  rule arr(L::List, _, _       ) [ IDX::Int ] => L[IDX] requires 0 <=Int IDX andBool IDX  <Int size(L)\n+  rule arr(L::List, _, D::KItem) [ IDX::Int ] => D      requires 0 <=Int IDX andBool IDX >=Int size(L)", "originalCommit": "aeef8b27bb69db8269bbb25dd8c13ba48aa3c205", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7ebf961bebd4fe71d207b607cc71a81ca6e058ca", "url": "https://github.com/kframework/k/commit/7ebf961bebd4fe71d207b607cc71a81ca6e058ca", "message": "domains.md: Allow negative indices into an array", "committedDate": "2020-11-10T19:28:14Z", "type": "commit"}, {"oid": "4670caf886df5a0e5a70e342d83362d386301d62", "url": "https://github.com/kframework/k/commit/4670caf886df5a0e5a70e342d83362d386301d62", "message": "k-distrubition/tests/regression-new: Add haskell tests for arrays", "committedDate": "2020-11-10T19:47:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg1MjM0MA==", "url": "https://github.com/kframework/k/pull/1637#discussion_r520852340", "bodyText": "Should we look up the size from the second argument of arr instead? Computing size(L) is O(log n).", "author": "ttuegel", "createdAt": "2020-11-10T20:25:25Z", "path": "k-distribution/include/kframework/builtin/domains.md", "diffHunk": "@@ -159,7 +159,8 @@ of any of the syntax defined in any of these modules.\n \n   rule makeArray(I::Int, D::KItem) => arr(.List, I, D)\n \n-  rule arr(L::List, _, D::KItem) [ IDX::Int ] => #if IDX >=Int size(L) #then D #else L[IDX] #fi\n+  rule arr(L::List, _, _       ) [ IDX::Int ] => L[IDX] requires 0 <=Int IDX andBool IDX  <Int size(L)", "originalCommit": "4670caf886df5a0e5a70e342d83362d386301d62", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg3NTc5Mw==", "url": "https://github.com/kframework/k/pull/1637#discussion_r520875793", "bodyText": "I don't think the second argument represent the length of the list, it's the length of the array.", "author": "gtrepta", "createdAt": "2020-11-10T21:10:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg1MjM0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg4MjUyOA==", "url": "https://github.com/kframework/k/pull/1637#discussion_r520882528", "bodyText": "If it's the logical length of the array, then it should probably be taken into account? Because the list may be longer than the logical length of the array.\nMaybe if you store 10 elements, then remove the last 5, it just doesn't bother removing the last 5 but instead just makes the second parameter 5 less?\nNot sure, probably need some clarity from @dwightguth on how the Array works", "author": "ehildenb", "createdAt": "2020-11-10T21:23:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg1MjM0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTUzNjAyNg==", "url": "https://github.com/kframework/k/pull/1637#discussion_r521536026", "bodyText": "so, the idea is that you can specify a length for an array but the List only creates elements up to the highest offset that was actually accessed. It's a lazy initialization. So the length of the array and the length of the list are not necessarily the same, but the list ought to never be longer than the array.", "author": "dwightguth", "createdAt": "2020-11-11T17:53:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg1MjM0MA=="}], "type": "inlineReview"}, {"oid": "d09619c8a50f0cce38bb46124c2a0d9195b03c77", "url": "https://github.com/kframework/k/commit/d09619c8a50f0cce38bb46124c2a0d9195b03c77", "message": "Merge branch 'master' into array_frontend", "committedDate": "2020-11-11T20:50:18Z", "type": "commit"}]}