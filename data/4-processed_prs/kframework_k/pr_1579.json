{"pr_number": 1579, "pr_title": "Check that constructors of builtin sorts are not declared", "pr_createdAt": "2020-10-01T21:09:32Z", "pr_url": "https://github.com/kframework/k/pull/1579", "timeline": [{"oid": "f47badf598158abe9c288bb0f356a65c281fae79", "url": "https://github.com/kframework/k/commit/f47badf598158abe9c288bb0f356a65c281fae79", "message": "allow bracket productions", "committedDate": "2020-11-11T20:36:44Z", "type": "forcePushed"}, {"oid": "a959bb4be0c62eadb39a468e0ad041339ec3f026", "url": "https://github.com/kframework/k/commit/a959bb4be0c62eadb39a468e0ad041339ec3f026", "message": "fix whitespace", "committedDate": "2020-11-16T19:57:35Z", "type": "forcePushed"}, {"oid": "0018e098774d62418af9b176d0fb26add8d39176", "url": "https://github.com/kframework/k/commit/0018e098774d62418af9b176d0fb26add8d39176", "message": "delete irredeemably ill-formed test", "committedDate": "2020-12-01T20:32:04Z", "type": "forcePushed"}, {"oid": "d075f2d7a405937ec19237392f15509e5235301f", "url": "https://github.com/kframework/k/commit/d075f2d7a405937ec19237392f15509e5235301f", "message": "add tests", "committedDate": "2020-12-03T20:35:47Z", "type": "commit"}, {"oid": "452f38330c9722ccc8547923bb9ea8dc6da14cb1", "url": "https://github.com/kframework/k/commit/452f38330c9722ccc8547923bb9ea8dc6da14cb1", "message": "add check", "committedDate": "2020-12-03T20:35:47Z", "type": "commit"}, {"oid": "e582ed3aac668d7cbb5bf8c67ad036165b4a77cb", "url": "https://github.com/kframework/k/commit/e582ed3aac668d7cbb5bf8c67ad036165b4a77cb", "message": "fix bugs in tests/equiv", "committedDate": "2020-12-03T20:35:47Z", "type": "commit"}, {"oid": "574b48454c9638f53dc02663bc02412680831ddb", "url": "https://github.com/kframework/k/commit/574b48454c9638f53dc02663bc02412680831ddb", "message": "add bug fix for issue with cell collection", "committedDate": "2020-12-03T20:35:47Z", "type": "commit"}, {"oid": "b59847b993d4ead8f7a8d507c68eb21aa80762e7", "url": "https://github.com/kframework/k/commit/b59847b993d4ead8f7a8d507c68eb21aa80762e7", "message": "fix macro case", "committedDate": "2020-12-03T20:35:47Z", "type": "commit"}, {"oid": "05a84b292c0a6c2f37c8be6d6fa66d5663fbe897", "url": "https://github.com/kframework/k/commit/05a84b292c0a6c2f37c8be6d6fa66d5663fbe897", "message": "allow bracket productions", "committedDate": "2020-12-03T20:35:47Z", "type": "commit"}, {"oid": "b6b162af8c8ea0ba8eba68bf1d7b09b880d4fdad", "url": "https://github.com/kframework/k/commit/b6b162af8c8ea0ba8eba68bf1d7b09b880d4fdad", "message": "fix whitespace", "committedDate": "2020-12-03T20:35:47Z", "type": "commit"}, {"oid": "6dd95495a13fdd7d76ac0272424561e50cd72099", "url": "https://github.com/kframework/k/commit/6dd95495a13fdd7d76ac0272424561e50cd72099", "message": "remove stale ill formed test", "committedDate": "2020-12-03T20:35:47Z", "type": "commit"}, {"oid": "393171da60ea5d8f1cda7a6fee7ffa2136947fe1", "url": "https://github.com/kframework/k/commit/393171da60ea5d8f1cda7a6fee7ffa2136947fe1", "message": "add missing function attribute", "committedDate": "2020-12-03T20:35:47Z", "type": "commit"}, {"oid": "8b4364dbfde29305f11c5afdd3e8f61b1578421a", "url": "https://github.com/kframework/k/commit/8b4364dbfde29305f11c5afdd3e8f61b1578421a", "message": "fix test", "committedDate": "2020-12-03T20:35:47Z", "type": "commit"}, {"oid": "a3fd462a5ff0b61a1ff4e7c899bc82755fc0df16", "url": "https://github.com/kframework/k/commit/a3fd462a5ff0b61a1ff4e7c899bc82755fc0df16", "message": "delete irredeemably ill-formed test", "committedDate": "2020-12-03T20:35:47Z", "type": "commit"}, {"oid": "5766744c68b05c635af5e6d33f0d9bc893bf358e", "url": "https://github.com/kframework/k/commit/5766744c68b05c635af5e6d33f0d9bc893bf358e", "message": "fix test", "committedDate": "2020-12-03T20:37:12Z", "type": "commit"}, {"oid": "5766744c68b05c635af5e6d33f0d9bc893bf358e", "url": "https://github.com/kframework/k/commit/5766744c68b05c635af5e6d33f0d9bc893bf358e", "message": "fix test", "committedDate": "2020-12-03T20:37:12Z", "type": "forcePushed"}, {"oid": "245a0b7603c30b60d6eb514e256cce7e88ccdefe", "url": "https://github.com/kframework/k/commit/245a0b7603c30b60d6eb514e256cce7e88ccdefe", "message": "exclude kvar on java backend from check", "committedDate": "2020-12-04T20:16:56Z", "type": "commit"}, {"oid": "0a29106f653f8813076c769bed584199707d03b3", "url": "https://github.com/kframework/k/commit/0a29106f653f8813076c769bed584199707d03b3", "message": "Merge branch 'master' into hook", "committedDate": "2020-12-07T18:24:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkxNDM3Mw==", "url": "https://github.com/kframework/k/pull/1579#discussion_r537914373", "bodyText": "Can we instead have a pass which runs before this and does:\n\nThe same check, and if it passes adds the constructor attribute if it determines that the production is an attribute.\nThen this check is changed to loop over all productions with constructor attribute and make sure none of them are targeting builtin sorts.\n\nThis has the benefit of (i) clearly defining what we call a \"constructor\", and (ii) adding the attribute to productions in case it's useful to the other various tools/backends.", "author": "ehildenb", "createdAt": "2020-12-07T23:29:47Z", "path": "kernel/src/main/java/org/kframework/compile/checks/CheckAtt.java", "diffHunk": "@@ -3,28 +3,57 @@\n \n import org.kframework.attributes.Att;\n import org.kframework.attributes.HasLocation;\n+import org.kframework.builtin.Sorts;\n+import org.kframework.compile.ExpandMacros;\n import org.kframework.definition.Module;\n+import org.kframework.definition.Production;\n import org.kframework.definition.Rule;\n import org.kframework.definition.Sentence;\n+import org.kframework.kore.KLabel;\n import org.kframework.utils.errorsystem.KEMException;\n \n import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import static org.kframework.Collections.*;\n \n /**\n  * Created by dwightguth on 1/25/16.\n  */\n public class CheckAtt {\n+    private final Set<KLabel> macros;\n     private final Set<KEMException> errors;\n     private final Module m;\n+    private final boolean isSymbolicKast;\n \n-    public CheckAtt(Set<KEMException> errors, Module m) {\n+    public CheckAtt(Set<KEMException> errors, Module m, boolean isSymbolicKast) {\n         this.errors = errors;\n         this.m = m;\n+        this.isSymbolicKast = isSymbolicKast;\n+        this.macros = stream(m.rulesFor()).filter(e -> stream(e._2()).filter(r -> ExpandMacros.isMacro(r)).findAny().isPresent()).map(e -> e._1()).collect(Collectors.toSet());\n     }\n \n     public void check(Sentence sentence) {\n         if (sentence instanceof Rule) {\n             check(((Rule) sentence).att(), sentence);\n+        } else if (sentence instanceof Production) {\n+            check((Production) sentence);\n+        }\n+    }\n+\n+    private void check(Production prod) {\n+        if (!prod.sort().equals(Sorts.KItem())) {\n+            Att sortAtt =  m.sortAttributesFor().getOrElse(prod.sort().head(), () -> Att.empty());\n+            if (sortAtt.contains(Att.HOOK()) && !sortAtt.get(Att.HOOK()).equals(\"ARRAY.Array\") && !(sortAtt.get(Att.HOOK()).equals(\"KVAR.KVar\") && isSymbolicKast)) {\n+                if (!prod.att().contains(Att.FUNCTION()) && !prod.att().contains(Att.BRACKET()) &&\n+                    !prod.att().contains(\"token\") && !(prod.klabel().isDefined() && macros.contains(prod.klabel().get()))) {\n+                    if (!(prod.sort().equals(Sorts.K()) && ((prod.klabel().isDefined() && (prod.klabel().get().name().equals(\"#EmptyK\") || prod.klabel().get().name().equals(\"#KSequence\"))) || prod.isSubsort()))) {\n+                        if (!(sortAtt.contains(\"cellCollection\") && prod.isSubsort())) {\n+                            errors.add(KEMException.compilerError(\"Cannot add new constructors to hooked sort \" + prod.sort(), prod));\n+                        }\n+                    }\n+                }\n+            }", "originalCommit": "0a29106f653f8813076c769bed584199707d03b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODYyMjEzOA==", "url": "https://github.com/kframework/k/pull/1579#discussion_r538622138", "bodyText": "There are several problems with this approach:\n\nThe checks normally happen before any transformation happens to the k definition. We might be able to change this, but it would be a substantial architectural change and I'd rather not make such a fundamental change on a completely ad-hoc basis. If we're going to do something like this, it would be better to have an explicit semantic analysis phase and lay oiut exactly how it should work and convey information.\nTransformers that only add attributes to sentences don't really work. I've tried repeatedly to try to bypass this restriction and it's never gone well. It's well outside the scope of this change.\nYour proposed solution would disallow sentences that aren't constructors that the user put the constructor attribute on in built-in sorts, which would be a breaking change (albeit one probably not exercised by anything). But it would be very confusing.", "author": "dwightguth", "createdAt": "2020-12-08T17:16:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkxNDM3Mw=="}], "type": "inlineReview"}, {"oid": "d7e464bd2cd4c274710dc84b27a8d4a4b379bc18", "url": "https://github.com/kframework/k/commit/d7e464bd2cd4c274710dc84b27a8d4a4b379bc18", "message": "Merge branch 'master' into hook", "committedDate": "2020-12-08T17:49:43Z", "type": "commit"}]}