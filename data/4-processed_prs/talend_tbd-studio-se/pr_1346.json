{"pr_number": 1346, "pr_title": "fix(TBD-10095): Sqoop issue with parquet format with EMR 5.15(2.8.3)", "pr_createdAt": "2020-03-31T07:41:00Z", "pr_url": "https://github.com/Talend/tbd-studio-se/pull/1346", "timeline": [{"oid": "146488e775cdbb5145cb7fd35464e10d83d28646", "url": "https://github.com/Talend/tbd-studio-se/commit/146488e775cdbb5145cb7fd35464e10d83d28646", "message": "TBD-10095: jar loading order fixed", "committedDate": "2020-03-31T07:37:38Z", "type": "commit"}, {"oid": "fb9cfafd286df68c0bf5fb067e88e15a55e29221", "url": "https://github.com/Talend/tbd-studio-se/commit/fb9cfafd286df68c0bf5fb067e88e15a55e29221", "message": "Merge branch 'master' of https://github.com/Talend/tbd-studio-se", "committedDate": "2020-03-31T07:38:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDczMjY5OQ==", "url": "https://github.com/Talend/tbd-studio-se/pull/1346#discussion_r400732699", "bodyText": "What is the diff between parquet-sqoop-1.4.7.jar and sqoop-1.4.7.jar ?", "author": "lbourgeois", "createdAt": "2020-03-31T08:29:05Z", "path": "main/plugins/org.talend.hadoop.distribution.emr5150/plugin.xml", "diffHunk": "@@ -298,9 +298,9 @@\n         <!-- Sqoop libraries -->\n         <libraryNeeded\n             context=\"plugin:org.talend.hadoop.distribution.emr5150\"\n-            id=\"parquet-sqoop-1.4.7.jar\"\n-            name=\"parquet-sqoop-1.4.7.jar\"\n-            mvn_uri=\"mvn:org.talend.libraries/parquet-sqoop-1.4.7/6.0.0\"/>\n+            id=\"sqoop-1.4.7.jar\"\n+            name=\"sqoop-1.4.7.jar\"\n+            mvn_uri=\"mvn:org.apache.sqoop/sqoop/1.4.7\"/>", "originalCommit": "fb9cfafd286df68c0bf5fb067e88e15a55e29221", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgyNzYzMw==", "url": "https://github.com/Talend/tbd-studio-se/pull/1346#discussion_r400827633", "bodyText": "Just in name. Actually, parquet-sqoop-1.4.7 is renamed sqoop-1.4.7. SqoopImport in java API mode generates additional jar dependencies searching jars starting with 'avro-' or 'parquet-' depending on selected format. To add sqoop library to parquet, I have to renamed it to 'parquet-sqoop-...'", "author": "mtuhai", "createdAt": "2020-03-31T11:08:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDczMjY5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg0NTY5OQ==", "url": "https://github.com/Talend/tbd-studio-se/pull/1346#discussion_r400845699", "bodyText": "But here you are renaming from parquet-sqoop-1.4.7.jar to sqoop-1.4.7.jar ?", "author": "lbourgeois", "createdAt": "2020-03-31T11:42:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDczMjY5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg5NTkyMg==", "url": "https://github.com/Talend/tbd-studio-se/pull/1346#discussion_r400895922", "bodyText": "Yes, because I have refused this approach. As it was demonstrated by Judy Liu, it does not work.\nOld approach was:\n\n\nWe have SQOOP common library group. This group was used for all sqoop file formats in java api mode (including parquet). This group contained shaded sqoop version dedicated to avro format (avro-sqoop-uber.jar)\n\n\nWe have PARQUET-SQOOP library group. Libraries from this group were additionally added to parquet file format in java api mode. This group contained renamed but clean sqoop (parquet-sqoop-1.4.7.jar)\n\n\nJars wih \"avro-\" or \"parquet-\" prefixes should be registered firstly when appropriate file format is choosed. So, when we choose parquet, clean sqoop should be loaded in first order (parquet-sqoop-1.4.7.jar). When we choose avro, shaded sqoop should be used (avro-sqoop-uber.jar). As it appears, this conclusion does not work. Shaded avro sqoop still simultaneously loading in parquet cases.\n\n\nSo, new fix works in such way:\n\nWe have AVRO library group, which contains shaded avro sqoop and which is used ONLY for avro format.\nWe have NON-AVRO library group, which is used for all other file formats. This group contains clean sqoop (sqoop-1.4.7).\nIt contains parquet kite-* libraries as well. I do not think there is a reason to split this group to several  smaller groups to build smaller job bundle. Additionally, I do not know how to realize condition in EMR5150SqoopModuleGroup class in this case.", "author": "mtuhai", "createdAt": "2020-03-31T13:04:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDczMjY5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDkyNzcwNg==", "url": "https://github.com/Talend/tbd-studio-se/pull/1346#discussion_r400927706", "bodyText": "ok thanks for clarification", "author": "lbourgeois", "createdAt": "2020-03-31T13:48:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDczMjY5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDczNjY2NQ==", "url": "https://github.com/Talend/tbd-studio-se/pull/1346#discussion_r400736665", "bodyText": "You changed the condition from equal PARQUET to not equal AVRO. Is it equivalent. Don't we have other txt formats ?", "author": "lbourgeois", "createdAt": "2020-03-31T08:35:30Z", "path": "main/plugins/org.talend.hadoop.distribution.emr5150/src/main/java/org/talend/hadoop/distribution/emr5150/modulegroup/EMR5150SqoopModuleGroup.java", "diffHunk": "@@ -31,10 +31,15 @@\n         hs.add(new DistributionModuleGroup(EMR5150Constant.MAPREDUCE_MODULE_GROUP.getModuleName()));\n         hs.add(new DistributionModuleGroup(EMR5150Constant.HDFS_MODULE_GROUP.getModuleName()));\n         ComponentCondition parquetOutputCondition =\n-                new SimpleComponentCondition(new BasicExpression(SqoopConstant.FILE_FORMAT, EqualityOperator.EQ,\n-                        SqoopConstant.PAQUET_OUTPUT_FORMAT));\n+                new SimpleComponentCondition(new BasicExpression(SqoopConstant.FILE_FORMAT, EqualityOperator.NOT_EQ,", "originalCommit": "fb9cfafd286df68c0bf5fb067e88e15a55e29221", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgyODY2NA==", "url": "https://github.com/Talend/tbd-studio-se/pull/1346#discussion_r400828664", "bodyText": "No, this is not equal condition. In fact, it is what you just have mentioned: it covers all others (not avro) txt formats", "author": "mtuhai", "createdAt": "2020-03-31T11:10:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDczNjY2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg0NzU4NQ==", "url": "https://github.com/Talend/tbd-studio-se/pull/1346#discussion_r400847585", "bodyText": "What is not clear here is that you will import SQOOP_PARQUET_MODULE_GROUP even for text formats", "author": "lbourgeois", "createdAt": "2020-03-31T11:45:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDczNjY2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg5ODQyMA==", "url": "https://github.com/Talend/tbd-studio-se/pull/1346#discussion_r400898420", "bodyText": "Yes, job bundle for all file formats except avro, will contain parquet kite-* libraries. I do not think there is a reason to split non-avro group to several smaller groups to build smaller job bundle, as these jars are not conflicting. Additionally, I do not know how to realize condition in EMR5150SqoopModuleGroup class in this case.", "author": "mtuhai", "createdAt": "2020-03-31T13:08:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDczNjY2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDkyMzIzMw==", "url": "https://github.com/Talend/tbd-studio-se/pull/1346#discussion_r400923233", "bodyText": "I was a bit confused to see a group called PARQUET imported even for non parquet files (text files) and maybe you can't rename without impacting other distros. It won't help clarity for future maintenance.\nReguarding condition I can't see the issue to test each format independently", "author": "lbourgeois", "createdAt": "2020-03-31T13:42:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDczNjY2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI5OTAzOA==", "url": "https://github.com/Talend/tbd-studio-se/pull/1346#discussion_r401299038", "bodyText": "Split non-avro groups to text-, sequence- and parquet- groups", "author": "mtuhai", "createdAt": "2020-04-01T01:01:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDczNjY2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDczNzAwMw==", "url": "https://github.com/Talend/tbd-studio-se/pull/1346#discussion_r400737003", "bodyText": "Is this constant still needed ?", "author": "lbourgeois", "createdAt": "2020-03-31T08:36:03Z", "path": "main/plugins/org.talend.hadoop.distribution/src/main/java/org/talend/hadoop/distribution/constants/SqoopConstant.java", "diffHunk": "@@ -28,4 +28,6 @@\n \n     public static final String PAQUET_OUTPUT_FORMAT = \"parquetfile\";//$NON-NLS-1$", "originalCommit": "fb9cfafd286df68c0bf5fb067e88e15a55e29221", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgzMDAyNw==", "url": "https://github.com/Talend/tbd-studio-se/pull/1346#discussion_r400830027", "bodyText": "It is used in many other distros", "author": "mtuhai", "createdAt": "2020-03-31T11:12:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDczNzAwMw=="}], "type": "inlineReview"}, {"oid": "5485e8a41637f4b5b07861f2d7946399b2604441", "url": "https://github.com/Talend/tbd-studio-se/commit/5485e8a41637f4b5b07861f2d7946399b2604441", "message": "fine grained groups added", "committedDate": "2020-04-01T00:59:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM5NjA5NQ==", "url": "https://github.com/Talend/tbd-studio-se/pull/1346#discussion_r401396095", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    <!-- jackson jars are defined localprovider plugin.xml -->\n          \n          \n            \n                    <!-- jackson jars are defined inside the localprovider plugin.xml -->", "author": "lbourgeois", "createdAt": "2020-04-01T07:02:07Z", "path": "main/plugins/org.talend.hadoop.distribution.emr5150/plugin.xml", "diffHunk": "@@ -1986,9 +1986,34 @@\n                 id=\"SQOOP-LIB-EMR_5_15_0_LATEST\"\n                 name=\"SQOOP-LIB-EMR_5_15_0_LATEST\">\n             <library id=\"commons-lang3-3.5.jar\"/>\n+        </libraryNeededGroup>\n+\n+        <!-- Sqoop Avro group -->\n+        <libraryNeededGroup\n+                description=\"Sqoop Avro libraries for EMR 5.15.0\"\n+                id=\"SQOOP-AVRO-LIB-EMR_5_15_0_LATEST\"\n+                name=\"SQOOP-AVRO-LIB-EMR_5_15_0_LATEST\">\n             <library id=\"avro-sqoop-uber.jar\"/>\n         </libraryNeededGroup>\n \n+        <!-- Sqoop Text group -->\n+        <!-- jackson jars are defined localprovider plugin.xml -->", "originalCommit": "5485e8a41637f4b5b07861f2d7946399b2604441", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM5NjI1Mg==", "url": "https://github.com/Talend/tbd-studio-se/pull/1346#discussion_r401396252", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    <!-- jackson jars are defined localprovider plugin.xml -->\n          \n          \n            \n                    <!-- jackson jars are defined inside the localprovider plugin.xml -->", "author": "lbourgeois", "createdAt": "2020-04-01T07:02:33Z", "path": "main/plugins/org.talend.hadoop.distribution.emr5150/plugin.xml", "diffHunk": "@@ -1986,9 +1986,34 @@\n                 id=\"SQOOP-LIB-EMR_5_15_0_LATEST\"\n                 name=\"SQOOP-LIB-EMR_5_15_0_LATEST\">\n             <library id=\"commons-lang3-3.5.jar\"/>\n+        </libraryNeededGroup>\n+\n+        <!-- Sqoop Avro group -->\n+        <libraryNeededGroup\n+                description=\"Sqoop Avro libraries for EMR 5.15.0\"\n+                id=\"SQOOP-AVRO-LIB-EMR_5_15_0_LATEST\"\n+                name=\"SQOOP-AVRO-LIB-EMR_5_15_0_LATEST\">\n             <library id=\"avro-sqoop-uber.jar\"/>\n         </libraryNeededGroup>\n \n+        <!-- Sqoop Text group -->\n+        <!-- jackson jars are defined localprovider plugin.xml -->\n+        <libraryNeededGroup\n+                description=\"Sqoop Text libraries for EMR 5.15.0\"\n+                id=\"SQOOP-TEXT-LIB-EMR_5_15_0_LATEST\"\n+                name=\"SQOOP-TEXT-LIB-EMR_5_15_0_LATEST\">\n+            <library id=\"sqoop-1.4.7.jar\"/>\n+        </libraryNeededGroup>\n+\n+        <!-- Sqoop Text group -->\n+        <!-- jackson jars are defined localprovider plugin.xml -->", "originalCommit": "5485e8a41637f4b5b07861f2d7946399b2604441", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f7bffe889ea23d5a9dee1d2717726ecd2173f676", "url": "https://github.com/Talend/tbd-studio-se/commit/f7bffe889ea23d5a9dee1d2717726ecd2173f676", "message": "Merge branch 'master' into fix/TBD-10095_jar_loading_order", "committedDate": "2020-04-01T07:03:39Z", "type": "commit"}, {"oid": "8a20de438160d189505849bdd4f27364edac7118", "url": "https://github.com/Talend/tbd-studio-se/commit/8a20de438160d189505849bdd4f27364edac7118", "message": "minor comments", "committedDate": "2020-04-01T10:24:19Z", "type": "commit"}, {"oid": "b7e884ad7152afcd601a5055acfb9035e4a7cf1d", "url": "https://github.com/Talend/tbd-studio-se/commit/b7e884ad7152afcd601a5055acfb9035e4a7cf1d", "message": "Merge branch 'fix/TBD-10095_jar_loading_order' of https://github.com/Talend/tbd-studio-se into fix/TBD-10095_jar_loading_order", "committedDate": "2020-04-01T10:26:22Z", "type": "commit"}, {"oid": "042de2ee2c5cd216a2683c90c1327396c97cd1cc", "url": "https://github.com/Talend/tbd-studio-se/commit/042de2ee2c5cd216a2683c90c1327396c97cd1cc", "message": "Merge branch 'master' into fix/TBD-10095_jar_loading_order", "committedDate": "2020-04-02T08:56:20Z", "type": "commit"}, {"oid": "0f40ca038c8203b6fce927ed2c7dc96f612e1336", "url": "https://github.com/Talend/tbd-studio-se/commit/0f40ca038c8203b6fce927ed2c7dc96f612e1336", "message": "Sqoop tests fixed", "committedDate": "2020-04-03T09:26:17Z", "type": "commit"}, {"oid": "491fd23e916625260d9232de865eab92a60a7662", "url": "https://github.com/Talend/tbd-studio-se/commit/491fd23e916625260d9232de865eab92a60a7662", "message": "Merge branch 'fix/TBD-10095_jar_loading_order' of https://github.com/Talend/tbd-studio-se into fix/TBD-10095_jar_loading_order", "committedDate": "2020-04-03T09:27:42Z", "type": "commit"}, {"oid": "820be78539eecb514be925e9cadd58d8e42f157c", "url": "https://github.com/Talend/tbd-studio-se/commit/820be78539eecb514be925e9cadd58d8e42f157c", "message": "Merge branch 'master' into fix/TBD-10095_jar_loading_order", "committedDate": "2020-04-03T10:30:04Z", "type": "commit"}]}