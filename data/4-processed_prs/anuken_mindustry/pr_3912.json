{"pr_number": 3912, "pr_title": "Conveyor upgrade system", "pr_createdAt": "2020-12-10T19:08:40Z", "pr_url": "https://github.com/Anuken/Mindustry/pull/3912", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQzMDg0Nw==", "url": "https://github.com/Anuken/Mindustry/pull/3912#discussion_r540430847", "bodyText": "these don't seem to be used anywhere other than the if right below it`:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            Tile start = world.tile(startX, startY);\n          \n          \n            \n                            Tile end = world.tile(endX, endY);\n          \n          \n            \n                            if(start.block() instanceof Conveyor && end.block() instanceof Conveyor){\n          \n          \n            \n                                points = Placement.upgradeConveyorLine(startX, startY, endX, endY);\n          \n          \n            \n                            }else{\n          \n          \n            \n                                points = Placement.pathfindLine(true, startX, startY, endX, endY);\n          \n          \n            \n                            }\n          \n          \n            \n                            if(world.tile(startX, startY).block() instanceof Conveyor && world.tile(endX, endY).block() instanceof Conveyor){\n          \n          \n            \n                                points = Placement.upgradeConveyorLine(startX, startY, endX, endY);\n          \n          \n            \n                            }else{\n          \n          \n            \n                                points = Placement.pathfindLine(true, startX, startY, endX, endY);\n          \n          \n            \n                            }", "author": "Quezler", "createdAt": "2020-12-10T19:16:46Z", "path": "core/src/mindustry/input/InputHandler.java", "diffHunk": "@@ -1161,7 +1162,17 @@ void iterateLine(int startX, int startY, int endX, int endY, Cons<PlaceLine> con\n         }\n \n         if(diagonal){\n-            points = Placement.pathfindLine(block != null && block.conveyorPlacement, startX, startY, endX, endY);\n+            if(block != null && block instanceof Conveyor){\n+                Tile start = world.tile(startX, startY);\n+                Tile end = world.tile(endX, endY);\n+                if(start.block() instanceof Conveyor && end.block() instanceof Conveyor){\n+                    points = Placement.upgradeConveyorLine(startX, startY, endX, endY);\n+                }else{\n+                    points = Placement.pathfindLine(true, startX, startY, endX, endY);\n+                }", "originalCommit": "4f8338d9f3e97f27f4774f59dec2ff6fa335406e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTY1NDE5Nw==", "url": "https://github.com/Anuken/Mindustry/pull/3912#discussion_r541654197", "bodyText": "These two functions are nearly the same, and use conduit/conveyor-specific implementation details. This isn't acceptable.", "author": "Anuken", "createdAt": "2020-12-12T16:33:28Z", "path": "core/src/mindustry/input/Placement.java", "diffHunk": "@@ -54,6 +55,32 @@\n         return points;\n     }\n \n+    public static Seq<Point2> upgradeConveyorLine(int startX, int startY, int endX, int endY){", "originalCommit": "4245d5900c0290af7f1df038c82638a805311020", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTY1OTY1OQ==", "url": "https://github.com/Anuken/Mindustry/pull/3912#discussion_r541659659", "bodyText": "Yeah but Conduit and Conveyor is not the same thing. And also there won't be any new such blocks.", "author": "Slava0135", "createdAt": "2020-12-12T16:44:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTY1NDE5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTY1NDQ5Nw==", "url": "https://github.com/Anuken/Mindustry/pull/3912#discussion_r541654497", "bodyText": "Conduits/conveyors should not be hardcoded into the system with special functions to handle them. The logic for each type of block is practically identical.", "author": "Anuken", "createdAt": "2020-12-12T16:34:08Z", "path": "core/src/mindustry/input/InputHandler.java", "diffHunk": "@@ -1161,7 +1163,15 @@ void iterateLine(int startX, int startY, int endX, int endY, Cons<PlaceLine> con\n         }\n \n         if(diagonal){\n-            points = Placement.pathfindLine(block != null && block.conveyorPlacement, startX, startY, endX, endY);\n+            Tile start = world.tile(startX, startY);\n+            Tile end = world.tile(endX, endY);\n+            if(block != null && block instanceof Conveyor && start.block() instanceof Conveyor && end.block() instanceof Conveyor && start.block() != block){", "originalCommit": "4245d5900c0290af7f1df038c82638a805311020", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTY2MDA4Nw==", "url": "https://github.com/Anuken/Mindustry/pull/3912#discussion_r541660087", "bodyText": "I really don't know how to put them under one roof. Perhaps do something with AutoTiler?", "author": "Slava0135", "createdAt": "2020-12-12T16:45:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTY1NDQ5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTY2OTg0OQ==", "url": "https://github.com/Anuken/Mindustry/pull/3912#discussion_r541669849", "bodyText": "add it to an interface", "author": "DeltaNedas", "createdAt": "2020-12-12T17:04:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTY1NDQ5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTY3MTQ4Mw==", "url": "https://github.com/Anuken/Mindustry/pull/3912#discussion_r541671483", "bodyText": "All this could be shortened by using ternary:\nreturn next != null && next.build instanceof ConduitBuild ? (ConduitBuild) next.build : null;", "author": "joshuaptfan", "createdAt": "2020-12-12T17:07:31Z", "path": "core/src/mindustry/world/blocks/liquid/Conduit.java", "diffHunk": "@@ -119,6 +119,16 @@ public void onProximityUpdate(){\n             blending = bits[4];\n         }\n \n+        @Nullable\n+        public ConduitBuild nextConduit(){\n+            Tile next = tile.nearby(rotation);\n+            if(next != null && next.build instanceof ConduitBuild){\n+                return (ConduitBuild) next.build;\n+            }else{\n+                return null;\n+            }", "originalCommit": "4245d5900c0290af7f1df038c82638a805311020", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTc2MDk0Mg==", "url": "https://github.com/Anuken/Mindustry/pull/3912#discussion_r541760942", "bodyText": "Actually this line is kinda redundant but idk if's good for performance or not. (start.block() != block)", "author": "Slava0135", "createdAt": "2020-12-12T19:50:11Z", "path": "core/src/mindustry/input/InputHandler.java", "diffHunk": "@@ -1165,10 +1164,13 @@ void iterateLine(int startX, int startY, int endX, int endY, Cons<PlaceLine> con\n         if(diagonal){\n             Tile start = world.tile(startX, startY);\n             Tile end = world.tile(endX, endY);\n-            if(block != null && block instanceof Conveyor && start.block() instanceof Conveyor && end.block() instanceof Conveyor && start.block() != block){\n-                points = Placement.upgradeConveyorLine(startX, startY, endX, endY);\n-            }else if(block != null && block instanceof Conduit && start.block() instanceof Conduit && end.block() instanceof Conduit && start.block() != block){\n-                points = Placement.upgradeConduitLine(startX, startY, endX, endY);\n+            if(block != null && block instanceof Autotiler\n+                    && start.block() != block", "originalCommit": "faf638a11f6b154854d0a6524e8cb751d2ca56c6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c2518acf0aa90251d751102fe222ff238fbdb4ef", "url": "https://github.com/Anuken/Mindustry/commit/c2518acf0aa90251d751102fe222ff238fbdb4ef", "message": "conveyor/conduit upgrading system", "committedDate": "2020-12-13T15:22:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEwODQ5Mw==", "url": "https://github.com/Anuken/Mindustry/pull/3912#discussion_r542108493", "bodyText": "Why is this called AutotilerBuilding when it has nothing to do with tiling itself...?", "author": "Anuken", "createdAt": "2020-12-14T04:45:06Z", "path": "core/src/mindustry/world/blocks/distribution/AutotilerBuilding.java", "diffHunk": "@@ -0,0 +1,9 @@\n+package mindustry.world.blocks.distribution;\n+\n+import mindustry.gen.Building;\n+import mindustry.world.Block;\n+\n+public interface AutotilerBuilding{", "originalCommit": "c2518acf0aa90251d751102fe222ff238fbdb4ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE2NDI5OA==", "url": "https://github.com/Anuken/Mindustry/pull/3912#discussion_r542164298", "bodyText": "Because I check if block is Autotiler in InputHandler. Both conduits and conveyors are inherited from it.", "author": "Slava0135", "createdAt": "2020-12-14T07:28:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEwODQ5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEwODU1Nw==", "url": "https://github.com/Anuken/Mindustry/pull/3912#discussion_r542108557", "bodyText": "Why not just use build.block?", "author": "Anuken", "createdAt": "2020-12-14T04:45:19Z", "path": "core/src/mindustry/world/blocks/distribution/AutotilerBuilding.java", "diffHunk": "@@ -0,0 +1,9 @@\n+package mindustry.world.blocks.distribution;\n+\n+import mindustry.gen.Building;\n+import mindustry.world.Block;\n+\n+public interface AutotilerBuilding{\n+    Building next();\n+    Block getBlockBasedOn();", "originalCommit": "c2518acf0aa90251d751102fe222ff238fbdb4ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEwODY1OQ==", "url": "https://github.com/Anuken/Mindustry/pull/3912#discussion_r542108659", "bodyText": "unnecessary space before cast", "author": "Anuken", "createdAt": "2020-12-14T04:45:42Z", "path": "core/src/mindustry/input/Placement.java", "diffHunk": "@@ -54,6 +55,20 @@\n         return points;\n     }\n \n+    public static Seq<Point2> upgradeLine(int startX, int startY, int endX, int endY){\n+        Pools.freeAll(points);\n+        points.clear();\n+        Building building = world.tile(startX, startY).build;\n+        points.add(Pools.obtain(Point2.class, Point2::new).set(startX, startY));\n+        while((building.tile.x != endX || building.tile.y != endY)){\n+            AutotilerBuilding autotiler = (AutotilerBuilding) building;", "originalCommit": "c2518acf0aa90251d751102fe222ff238fbdb4ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEwODcwOA==", "url": "https://github.com/Anuken/Mindustry/pull/3912#discussion_r542108708", "bodyText": "imports should be *", "author": "Anuken", "createdAt": "2020-12-14T04:45:53Z", "path": "core/src/mindustry/input/Placement.java", "diffHunk": "@@ -5,7 +5,9 @@\n import arc.math.geom.*;\n import arc.struct.*;\n import arc.util.pooling.*;\n+import mindustry.gen.Building;\n import mindustry.world.*;\n+import mindustry.world.blocks.distribution.AutotilerBuilding;", "originalCommit": "c2518acf0aa90251d751102fe222ff238fbdb4ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjEwODc0Ng==", "url": "https://github.com/Anuken/Mindustry/pull/3912#discussion_r542108746", "bodyText": "unnecessary spaces before cast, line below too", "author": "Anuken", "createdAt": "2020-12-14T04:46:01Z", "path": "core/src/mindustry/input/InputHandler.java", "diffHunk": "@@ -1161,7 +1162,18 @@ void iterateLine(int startX, int startY, int endX, int endY, Cons<PlaceLine> con\n         }\n \n         if(diagonal){\n-            points = Placement.pathfindLine(block != null && block.conveyorPlacement, startX, startY, endX, endY);\n+            Tile start = world.tile(startX, startY);\n+            Tile end = world.tile(endX, endY);\n+            if(block != null && block instanceof Autotiler\n+                    && start.block() != block\n+                    && start.build instanceof AutotilerBuilding\n+                    && end.build instanceof AutotilerBuilding\n+                    && block.canReplace(((AutotilerBuilding) end.build).getBlockBasedOn())", "originalCommit": "c2518acf0aa90251d751102fe222ff238fbdb4ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1e5b1c2ac0f1513684999ce7ceacbe35cdcf0875", "url": "https://github.com/Anuken/Mindustry/commit/1e5b1c2ac0f1513684999ce7ceacbe35cdcf0875", "message": "conveyor/conduit upgrading system", "committedDate": "2020-12-14T09:21:04Z", "type": "commit"}, {"oid": "1e5b1c2ac0f1513684999ce7ceacbe35cdcf0875", "url": "https://github.com/Anuken/Mindustry/commit/1e5b1c2ac0f1513684999ce7ceacbe35cdcf0875", "message": "conveyor/conduit upgrading system", "committedDate": "2020-12-14T09:21:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwNjY5Mg==", "url": "https://github.com/Anuken/Mindustry/pull/3912#discussion_r542306692", "bodyText": "why place double brackets here?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    while((building.tile.x != endX || building.tile.y != endY)){\n          \n          \n            \n                    while(building.tile.x != endX || building.tile.y != endY){", "author": "summetdev", "createdAt": "2020-12-14T11:18:31Z", "path": "core/src/mindustry/input/Placement.java", "diffHunk": "@@ -54,6 +55,20 @@\n         return points;\n     }\n \n+    public static Seq<Point2> upgradeLine(int startX, int startY, int endX, int endY){\n+        Pools.freeAll(points);\n+        points.clear();\n+        Building building = world.tile(startX, startY).build;\n+        points.add(Pools.obtain(Point2.class, Point2::new).set(startX, startY));\n+        while((building.tile.x != endX || building.tile.y != endY)){", "originalCommit": "1e5b1c2ac0f1513684999ce7ceacbe35cdcf0875", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwNzAyMA==", "url": "https://github.com/Anuken/Mindustry/pull/3912#discussion_r542307020", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import mindustry.gen.Building;\n          \n          \n            \n            import mindustry.gen.*;", "author": "summetdev", "createdAt": "2020-12-14T11:19:05Z", "path": "core/src/mindustry/input/Placement.java", "diffHunk": "@@ -5,7 +5,9 @@\n import arc.math.geom.*;\n import arc.struct.*;\n import arc.util.pooling.*;\n+import mindustry.gen.Building;", "originalCommit": "1e5b1c2ac0f1513684999ce7ceacbe35cdcf0875", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwNzIwMg==", "url": "https://github.com/Anuken/Mindustry/pull/3912#discussion_r542307202", "bodyText": "imports should be *\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import mindustry.world.blocks.distribution.ChainedBuilding;\n          \n          \n            \n            import mindustry.world.blocks.distribution.*;", "author": "summetdev", "createdAt": "2020-12-14T11:19:24Z", "path": "core/src/mindustry/input/InputHandler.java", "diffHunk": "@@ -32,6 +32,7 @@\n import mindustry.world.*;\n import mindustry.world.blocks.*;\n import mindustry.world.blocks.ConstructBlock.*;\n+import mindustry.world.blocks.distribution.ChainedBuilding;", "originalCommit": "1e5b1c2ac0f1513684999ce7ceacbe35cdcf0875", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwNzY3MQ==", "url": "https://github.com/Anuken/Mindustry/pull/3912#discussion_r542307671", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import mindustry.gen.Building;\n          \n          \n            \n            import mindustry.gen.*;", "author": "summetdev", "createdAt": "2020-12-14T11:20:07Z", "path": "core/src/mindustry/world/blocks/distribution/ChainedBuilding.java", "diffHunk": "@@ -0,0 +1,7 @@\n+package mindustry.world.blocks.distribution;\n+\n+import mindustry.gen.Building;", "originalCommit": "1e5b1c2ac0f1513684999ce7ceacbe35cdcf0875", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwNzk3Nw==", "url": "https://github.com/Anuken/Mindustry/pull/3912#discussion_r542307977", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import mindustry.world.blocks.distribution.ChainedBuilding;\n          \n          \n            \n            import mindustry.world.blocks.distribution.*;", "author": "summetdev", "createdAt": "2020-12-14T11:20:38Z", "path": "core/src/mindustry/world/blocks/liquid/Conduit.java", "diffHunk": "@@ -16,6 +16,7 @@\n import mindustry.type.*;\n import mindustry.world.*;\n import mindustry.world.blocks.*;\n+import mindustry.world.blocks.distribution.ChainedBuilding;", "originalCommit": "1e5b1c2ac0f1513684999ce7ceacbe35cdcf0875", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "43a97a8e365309bde787f6314b8fd3cb54e74273", "url": "https://github.com/Anuken/Mindustry/commit/43a97a8e365309bde787f6314b8fd3cb54e74273", "message": "style", "committedDate": "2020-12-14T14:11:13Z", "type": "commit"}]}