{"pr_number": 2701, "pr_title": "Adding functionality to create a manifest list from a list of built images", "pr_createdAt": "2020-08-14T14:29:28Z", "pr_url": "https://github.com/GoogleContainerTools/jib/pull/2701", "timeline": [{"oid": "1e92ad23687b2c35ba71a65e4ed29fd20c73133a", "url": "https://github.com/GoogleContainerTools/jib/commit/1e92ad23687b2c35ba71a65e4ed29fd20c73133a", "message": "Adding fnctionality to build a manifest list", "committedDate": "2020-08-12T18:01:09Z", "type": "commit"}, {"oid": "6f43bebaf5bf3e107f2635c4b9bfa453fc8206e5", "url": "https://github.com/GoogleContainerTools/jib/commit/6f43bebaf5bf3e107f2635c4b9bfa453fc8206e5", "message": "Removing one platform restriction", "committedDate": "2020-08-12T19:28:46Z", "type": "commit"}, {"oid": "6c24f34496a8181ddd90985f15d4ef1f90d5b225", "url": "https://github.com/GoogleContainerTools/jib/commit/6c24f34496a8181ddd90985f15d4ef1f90d5b225", "message": "Progress Dispatcher has been fixed", "committedDate": "2020-08-13T15:18:59Z", "type": "commit"}, {"oid": "dfe28d970934e016de7177ab25ce6af4129b527d", "url": "https://github.com/GoogleContainerTools/jib/commit/dfe28d970934e016de7177ab25ce6af4129b527d", "message": "Fix child progress dispatcher factory (#2699)\n\n* Fixing concurrent progress dispatcher\r\n\r\n* Removing un-related changes\r\n\r\n* Add multiple progress dispatchers for concurrent build processes\r\n\r\n* Progress Dispatcher Fix", "committedDate": "2020-08-13T15:27:06Z", "type": "commit"}, {"oid": "1771c269ec62b894123bbe0a14833a84f95443a7", "url": "https://github.com/GoogleContainerTools/jib/commit/1771c269ec62b894123bbe0a14833a84f95443a7", "message": "Commit for debugging Java I/O error", "committedDate": "2020-08-13T19:29:37Z", "type": "commit"}, {"oid": "55c7e640ac989644e5891804644eee8fd524beb9", "url": "https://github.com/GoogleContainerTools/jib/commit/55c7e640ac989644e5891804644eee8fd524beb9", "message": " manifest creation done", "committedDate": "2020-08-13T23:17:47Z", "type": "commit"}, {"oid": "206da0192feed33d263b1090fea60b519047395b", "url": "https://github.com/GoogleContainerTools/jib/commit/206da0192feed33d263b1090fea60b519047395b", "message": "Style Fixes", "committedDate": "2020-08-14T14:26:45Z", "type": "commit"}, {"oid": "cff0915ffb64493451daf466450c802861677187", "url": "https://github.com/GoogleContainerTools/jib/commit/cff0915ffb64493451daf466450c802861677187", "message": "Removing Pom.xml", "committedDate": "2020-08-14T14:37:42Z", "type": "commit"}, {"oid": "ca9d2653fee8ac7c6cfdfa3a1d757fcf53c3b44f", "url": "https://github.com/GoogleContainerTools/jib/commit/ca9d2653fee8ac7c6cfdfa3a1d757fcf53c3b44f", "message": "Merge remote-tracking branch 'origin' into createManifestList", "committedDate": "2020-08-14T14:41:51Z", "type": "commit"}, {"oid": "b4a2edb918a899be3b6340969d02eff027efe262", "url": "https://github.com/GoogleContainerTools/jib/commit/b4a2edb918a899be3b6340969d02eff027efe262", "message": "Extending Jib to support multiple archs", "committedDate": "2020-08-14T15:00:54Z", "type": "commit"}, {"oid": "36c3fe0636e3bd2348d3bf7ea62adf50b6abc8ad", "url": "https://github.com/GoogleContainerTools/jib/commit/36c3fe0636e3bd2348d3bf7ea62adf50b6abc8ad", "message": "Adding Javadoc Comments", "committedDate": "2020-08-14T15:29:50Z", "type": "commit"}, {"oid": "6c381c7d62050ccc60f404ccfb2d14a2bc7a3e2b", "url": "https://github.com/GoogleContainerTools/jib/commit/6c381c7d62050ccc60f404ccfb2d14a2bc7a3e2b", "message": "Adding Javadocs", "committedDate": "2020-08-14T16:11:21Z", "type": "commit"}, {"oid": "776ab69e584661fd266050642b921a6962dccfa1", "url": "https://github.com/GoogleContainerTools/jib/commit/776ab69e584661fd266050642b921a6962dccfa1", "message": "Fix Styles", "committedDate": "2020-08-14T17:03:22Z", "type": "commit"}, {"oid": "3713769ec829da396cde013398252c46e95ea7c6", "url": "https://github.com/GoogleContainerTools/jib/commit/3713769ec829da396cde013398252c46e95ea7c6", "message": "Style Fix", "committedDate": "2020-08-14T17:11:11Z", "type": "commit"}, {"oid": "17b63bdbdb6497a3c35566e074f28761024ce5f6", "url": "https://github.com/GoogleContainerTools/jib/commit/17b63bdbdb6497a3c35566e074f28761024ce5f6", "message": "Return the one platform specification restriction", "committedDate": "2020-08-14T18:08:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc3NTcyNA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r470775724", "bodyText": "super-nit: we've been saying \"Building ...\" for others. Let's go for consistency.", "author": "chanseokoh", "createdAt": "2020-08-14T18:04:32Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/BuildManifestListStep.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.builder.steps;\n+\n+import com.google.cloud.tools.jib.api.LogEvent;\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.blob.Blobs;\n+import com.google.cloud.tools.jib.builder.ProgressEventDispatcher;\n+import com.google.cloud.tools.jib.builder.TimerEventDispatcher;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.event.EventHandlers;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.json.ImageToJsonTranslator;\n+import com.google.cloud.tools.jib.image.json.ManifestListGenerator;\n+import com.google.cloud.tools.jib.image.json.ManifestTemplate;\n+import com.google.cloud.tools.jib.json.JsonTemplate;\n+import com.google.common.io.ByteStreams;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.concurrent.Callable;\n+\n+/** Creates a manifest list. */\n+class BuildManifestListStep implements Callable<ManifestTemplate> {\n+\n+  private static final String DESCRIPTION = \"Creating a manifest list\";", "originalCommit": "3713769ec829da396cde013398252c46e95ea7c6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc3NTk3NA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r470775974", "bodyText": "\"building ...\"", "author": "chanseokoh", "createdAt": "2020-08-14T18:05:04Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/BuildManifestListStep.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.builder.steps;\n+\n+import com.google.cloud.tools.jib.api.LogEvent;\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.blob.Blobs;\n+import com.google.cloud.tools.jib.builder.ProgressEventDispatcher;\n+import com.google.cloud.tools.jib.builder.TimerEventDispatcher;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.event.EventHandlers;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.json.ImageToJsonTranslator;\n+import com.google.cloud.tools.jib.image.json.ManifestListGenerator;\n+import com.google.cloud.tools.jib.image.json.ManifestTemplate;\n+import com.google.cloud.tools.jib.json.JsonTemplate;\n+import com.google.common.io.ByteStreams;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.concurrent.Callable;\n+\n+/** Creates a manifest list. */\n+class BuildManifestListStep implements Callable<ManifestTemplate> {\n+\n+  private static final String DESCRIPTION = \"Creating a manifest list\";\n+\n+  private final BuildContext buildContext;\n+  private final ProgressEventDispatcher.Factory progressEventDispatcherFactory;\n+  private final List<Image> builtImages;\n+\n+  BuildManifestListStep(\n+      BuildContext buildContext,\n+      ProgressEventDispatcher.Factory progressEventDispatcherFactory,\n+      List<Image> builtImages) {\n+    this.buildContext = buildContext;\n+    this.progressEventDispatcherFactory = progressEventDispatcherFactory;\n+    this.builtImages = builtImages;\n+  }\n+\n+  @Override\n+  public ManifestTemplate call() throws IOException {\n+\n+    EventHandlers eventHandlers = buildContext.getEventHandlers();\n+    try (TimerEventDispatcher ignored = new TimerEventDispatcher(eventHandlers, DESCRIPTION);\n+        ProgressEventDispatcher ignored2 =\n+            progressEventDispatcherFactory.create(\"creating a manifest list\", 1)) {\n+      eventHandlers.dispatch(LogEvent.info(\"Creating a manifest list\"));", "originalCommit": "3713769ec829da396cde013398252c46e95ea7c6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc3NjUwNw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r470776507", "bodyText": "Put everything into the try-resources block.\n  try (TimerEventDispatcher ...) {\n    ...\n    return new ManifestListGenator(...);\n  }\nAnd actually, I think we can use\nBlobDescriptor configDescriptor = Digests.computeDigest(containerConfig);\ninstead of Blobs.from(...).writeTo(). I am not sure why we used it that way in other places.\nAnd I think we can simply this to\n    if (builtImages.size() == 1) {\n      ImageToJsonTranslator imageTranslator = new ImageToJsonTranslator(builtImages.get(0));\n      BlobDescriptor configDescriptor =\n          Digests.computeDigest(imageTranslator.getContainerConfiguration());\n      return imageTranslator.getManifestTemplate(buildContext.getTargetFormat(), configDescriptor);\n    }\n\n    return new ManifestListGenerator(...);", "author": "chanseokoh", "createdAt": "2020-08-14T18:06:17Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/BuildManifestListStep.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.builder.steps;\n+\n+import com.google.cloud.tools.jib.api.LogEvent;\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.blob.Blobs;\n+import com.google.cloud.tools.jib.builder.ProgressEventDispatcher;\n+import com.google.cloud.tools.jib.builder.TimerEventDispatcher;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.event.EventHandlers;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.json.ImageToJsonTranslator;\n+import com.google.cloud.tools.jib.image.json.ManifestListGenerator;\n+import com.google.cloud.tools.jib.image.json.ManifestTemplate;\n+import com.google.cloud.tools.jib.json.JsonTemplate;\n+import com.google.common.io.ByteStreams;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.concurrent.Callable;\n+\n+/** Creates a manifest list. */\n+class BuildManifestListStep implements Callable<ManifestTemplate> {\n+\n+  private static final String DESCRIPTION = \"Creating a manifest list\";\n+\n+  private final BuildContext buildContext;\n+  private final ProgressEventDispatcher.Factory progressEventDispatcherFactory;\n+  private final List<Image> builtImages;\n+\n+  BuildManifestListStep(\n+      BuildContext buildContext,\n+      ProgressEventDispatcher.Factory progressEventDispatcherFactory,\n+      List<Image> builtImages) {\n+    this.buildContext = buildContext;\n+    this.progressEventDispatcherFactory = progressEventDispatcherFactory;\n+    this.builtImages = builtImages;\n+  }\n+\n+  @Override\n+  public ManifestTemplate call() throws IOException {\n+\n+    EventHandlers eventHandlers = buildContext.getEventHandlers();\n+    try (TimerEventDispatcher ignored = new TimerEventDispatcher(eventHandlers, DESCRIPTION);\n+        ProgressEventDispatcher ignored2 =\n+            progressEventDispatcherFactory.create(\"creating a manifest list\", 1)) {\n+      eventHandlers.dispatch(LogEvent.info(\"Creating a manifest list\"));\n+    }\n+    if (builtImages.size() == 1) {\n+      JsonTemplate containerConfiguration =\n+          new ImageToJsonTranslator(builtImages.get(0)).getContainerConfiguration();\n+      BlobDescriptor configDescriptor =\n+          Blobs.from(containerConfiguration).writeTo(ByteStreams.nullOutputStream());\n+\n+      return new ImageToJsonTranslator(builtImages.get(0))\n+          .getManifestTemplate(buildContext.getTargetFormat(), configDescriptor);\n+    }\n+\n+    return new ManifestListGenerator(this.buildContext, this.builtImages).getManifestListTemplate();", "originalCommit": "3713769ec829da396cde013398252c46e95ea7c6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc4Mzc5OQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r470783799", "bodyText": "buildManifestListOrSingleManifest", "author": "chanseokoh", "createdAt": "2020-08-14T18:18:10Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -423,6 +426,21 @@ private void buildImages() {\n             });\n   }\n \n+  private void buildManifestList() {", "originalCommit": "17b63bdbdb6497a3c35566e074f28761024ce5f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc4NjAzMA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r470786030", "bodyText": "This is confusing\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        () -> {\n          \n          \n            \n                          List<Future<Image>> builtImages = new ArrayList<>();\n          \n          \n            \n                          builtImages.addAll(results.builtImagesAndBaseImages.get().keySet());\n          \n          \n            \n                          return new BuildManifestListStep(\n          \n          \n            \n                                  buildContext, childProgressDispatcherFactory, realizeFutures(builtImages))\n          \n          \n            \n                              .call();\n          \n          \n            \n                        });\n          \n          \n            \n                        () ->\n          \n          \n            \n                          new BuildManifestListStep(\n          \n          \n            \n                                  buildContext,\n          \n          \n            \n                                  childProgressDispatcherFactory,\n          \n          \n            \n                                  realizeFutures(results.builtImagesAndBaseImages.get().keySet()))\n          \n          \n            \n                              .call());", "author": "chanseokoh", "createdAt": "2020-08-14T18:20:47Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -423,6 +426,21 @@ private void buildImages() {\n             });\n   }\n \n+  private void buildManifestList() {\n+    ProgressEventDispatcher.Factory childProgressDispatcherFactory =\n+        Verify.verifyNotNull(rootProgressDispatcher).newChildProducer();\n+\n+    results.manifestListOrSingleManifest =\n+        executorService.submit(\n+            () -> {\n+              List<Future<Image>> builtImages = new ArrayList<>();\n+              builtImages.addAll(results.builtImagesAndBaseImages.get().keySet());\n+              return new BuildManifestListStep(\n+                      buildContext, childProgressDispatcherFactory, realizeFutures(builtImages))\n+                  .call();\n+            });", "originalCommit": "17b63bdbdb6497a3c35566e074f28761024ce5f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgyNTYyNA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r470825624", "bodyText": "We need to convert the keySet() to an ArrayList before using the realizeFutures .\n new BuildManifestListOrSingleManifestStep(\n                        buildContext,\n                        childProgressDispatcherFactory,\n                        realizeFutures(\n                            new ArrayList<>(results.builtImagesAndBaseImages.get().keySet())))\n                    .call());\n\nThis might be better", "author": "louismurerwa", "createdAt": "2020-08-14T19:26:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc4NjAzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgyODAwNg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r470828006", "bodyText": "Aha, I think we should change realizeFutures() instead. From\n  private static <E> List<E> realizeFutures(List<Future<E>> futures)\nto\n  private static <E> List<E> realizeFutures(Collection<Future<E>> futures)\n. Set, List, Vector, etc. all implement Collection.", "author": "chanseokoh", "createdAt": "2020-08-14T19:32:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc4NjAzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgzMDI0Mw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r470830243", "bodyText": "Sounds Good I will do a small PR to change realizeFutures", "author": "louismurerwa", "createdAt": "2020-08-14T19:37:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc4NjAzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg0MDcxNg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r470840716", "bodyText": "It will be a one-line change. If you prefer, you can do it here.", "author": "chanseokoh", "createdAt": "2020-08-14T20:03:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc4NjAzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc4NjczMA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r470786730", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            /** Translates a list of {@link Image} into a manifest list. */\n          \n          \n            \n            /** Generator a manifest list for {@link Image}s. */", "author": "chanseokoh", "createdAt": "2020-08-14T18:21:37Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/image/json/ManifestListGenerator.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.image.json;\n+\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.blob.Blobs;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.json.V22ManifestListTemplate.ManifestDescriptorTemplate;\n+import com.google.cloud.tools.jib.json.JsonTemplate;\n+import com.google.common.io.ByteStreams;\n+import java.io.IOException;\n+import java.util.List;\n+\n+/** Translates a list of {@link Image} into a manifest list. */", "originalCommit": "17b63bdbdb6497a3c35566e074f28761024ce5f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc4OTA0Ng==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r470789046", "bodyText": "ManifestListGenerator doesn't and shouldn't care what the images are. It's an isolated class.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private final List<Image> builtImages;\n          \n          \n            \n              private final List<Image> images;", "author": "chanseokoh", "createdAt": "2020-08-14T18:24:24Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/image/json/ManifestListGenerator.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.image.json;\n+\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.blob.Blobs;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.json.V22ManifestListTemplate.ManifestDescriptorTemplate;\n+import com.google.cloud.tools.jib.json.JsonTemplate;\n+import com.google.common.io.ByteStreams;\n+import java.io.IOException;\n+import java.util.List;\n+\n+/** Translates a list of {@link Image} into a manifest list. */\n+public class ManifestListGenerator {\n+\n+  private final BuildContext buildContext;\n+  private final List<Image> builtImages;", "originalCommit": "17b63bdbdb6497a3c35566e074f28761024ce5f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc4OTE2OA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r470789168", "bodyText": "From the API design perspective, it shouldn't know anything about BuildContext. It's an isolated class and shouldn't be coupled.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public ManifestListGenerator(BuildContext buildContext, List<Image> builtImages) {\n          \n          \n            \n              public ManifestListGenerator(... imageFormat, List<Image> images) {", "author": "chanseokoh", "createdAt": "2020-08-14T18:24:33Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/image/json/ManifestListGenerator.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.image.json;\n+\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.blob.Blobs;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.json.V22ManifestListTemplate.ManifestDescriptorTemplate;\n+import com.google.cloud.tools.jib.json.JsonTemplate;\n+import com.google.common.io.ByteStreams;\n+import java.io.IOException;\n+import java.util.List;\n+\n+/** Translates a list of {@link Image} into a manifest list. */\n+public class ManifestListGenerator {\n+\n+  private final BuildContext buildContext;\n+  private final List<Image> builtImages;\n+\n+  public ManifestListGenerator(BuildContext buildContext, List<Image> builtImages) {", "originalCommit": "17b63bdbdb6497a3c35566e074f28761024ce5f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc5MTE0NQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r470791145", "bodyText": "No period at the end\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * @return ManifestTemplate a JSON representation of list of {@link Image}.\n          \n          \n            \n               * @return a manifest list JSON", "author": "chanseokoh", "createdAt": "2020-08-14T18:26:51Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/image/json/ManifestListGenerator.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.image.json;\n+\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.blob.Blobs;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.json.V22ManifestListTemplate.ManifestDescriptorTemplate;\n+import com.google.cloud.tools.jib.json.JsonTemplate;\n+import com.google.common.io.ByteStreams;\n+import java.io.IOException;\n+import java.util.List;\n+\n+/** Translates a list of {@link Image} into a manifest list. */\n+public class ManifestListGenerator {\n+\n+  private final BuildContext buildContext;\n+  private final List<Image> builtImages;\n+\n+  public ManifestListGenerator(BuildContext buildContext, List<Image> builtImages) {\n+    this.buildContext = buildContext;\n+    this.builtImages = builtImages;\n+  }\n+\n+  /**\n+   * Translates a list of {@link Image} into a manifestTemplate.\n+   *\n+   * @return ManifestTemplate a JSON representation of list of {@link Image}.", "originalCommit": "17b63bdbdb6497a3c35566e074f28761024ce5f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc5MTkyNg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r470791926", "bodyText": "Generates a manifest list JSON for the given {@link Image}s.", "author": "chanseokoh", "createdAt": "2020-08-14T18:27:45Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/image/json/ManifestListGenerator.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.image.json;\n+\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.blob.Blobs;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.json.V22ManifestListTemplate.ManifestDescriptorTemplate;\n+import com.google.cloud.tools.jib.json.JsonTemplate;\n+import com.google.common.io.ByteStreams;\n+import java.io.IOException;\n+import java.util.List;\n+\n+/** Translates a list of {@link Image} into a manifest list. */\n+public class ManifestListGenerator {\n+\n+  private final BuildContext buildContext;\n+  private final List<Image> builtImages;\n+\n+  public ManifestListGenerator(BuildContext buildContext, List<Image> builtImages) {\n+    this.buildContext = buildContext;\n+    this.builtImages = builtImages;\n+  }\n+\n+  /**\n+   * Translates a list of {@link Image} into a manifestTemplate.", "originalCommit": "17b63bdbdb6497a3c35566e074f28761024ce5f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc5MjU4OQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r470792589", "bodyText": "ditto", "author": "chanseokoh", "createdAt": "2020-08-14T18:28:36Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/image/json/ManifestListGenerator.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.image.json;\n+\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.blob.Blobs;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.json.V22ManifestListTemplate.ManifestDescriptorTemplate;\n+import com.google.cloud.tools.jib.json.JsonTemplate;\n+import com.google.common.io.ByteStreams;\n+import java.io.IOException;\n+import java.util.List;\n+\n+/** Translates a list of {@link Image} into a manifest list. */\n+public class ManifestListGenerator {\n+\n+  private final BuildContext buildContext;\n+  private final List<Image> builtImages;\n+\n+  public ManifestListGenerator(BuildContext buildContext, List<Image> builtImages) {\n+    this.buildContext = buildContext;\n+    this.builtImages = builtImages;\n+  }\n+\n+  /**\n+   * Translates a list of {@link Image} into a manifestTemplate.\n+   *\n+   * @return ManifestTemplate a JSON representation of list of {@link Image}.\n+   */\n+  public ManifestTemplate getManifestListTemplate() {\n+\n+    try {\n+      V22ManifestListTemplate manifestList = new V22ManifestListTemplate();\n+\n+      for (Image builtImage : builtImages) {\n+        JsonTemplate containerConfiguration =\n+            new ImageToJsonTranslator(builtImage).getContainerConfiguration();\n+        BlobDescriptor configDescriptor =\n+            Blobs.from(containerConfiguration).writeTo(ByteStreams.nullOutputStream());", "originalCommit": "17b63bdbdb6497a3c35566e074f28761024ce5f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc5MzYzNA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r470793634", "bodyText": "I need to think about this. Probably not the right way.", "author": "chanseokoh", "createdAt": "2020-08-14T18:29:49Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/image/json/ManifestListGenerator.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.image.json;\n+\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.blob.Blobs;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.json.V22ManifestListTemplate.ManifestDescriptorTemplate;\n+import com.google.cloud.tools.jib.json.JsonTemplate;\n+import com.google.common.io.ByteStreams;\n+import java.io.IOException;\n+import java.util.List;\n+\n+/** Translates a list of {@link Image} into a manifest list. */\n+public class ManifestListGenerator {\n+\n+  private final BuildContext buildContext;\n+  private final List<Image> builtImages;\n+\n+  public ManifestListGenerator(BuildContext buildContext, List<Image> builtImages) {\n+    this.buildContext = buildContext;\n+    this.builtImages = builtImages;\n+  }\n+\n+  /**\n+   * Translates a list of {@link Image} into a manifestTemplate.\n+   *\n+   * @return ManifestTemplate a JSON representation of list of {@link Image}.\n+   */\n+  public ManifestTemplate getManifestListTemplate() {\n+\n+    try {\n+      V22ManifestListTemplate manifestList = new V22ManifestListTemplate();\n+\n+      for (Image builtImage : builtImages) {\n+        JsonTemplate containerConfiguration =\n+            new ImageToJsonTranslator(builtImage).getContainerConfiguration();\n+        BlobDescriptor configDescriptor =\n+            Blobs.from(containerConfiguration).writeTo(ByteStreams.nullOutputStream());\n+\n+        BuildableManifestTemplate manifestTemplate =\n+            new ImageToJsonTranslator(builtImage)\n+                .getManifestTemplate(buildContext.getTargetFormat(), configDescriptor);\n+        BlobDescriptor manifestDescriptor =\n+            Blobs.from(manifestTemplate).writeTo(ByteStreams.nullOutputStream());\n+\n+        ManifestDescriptorTemplate manifest = new ManifestDescriptorTemplate();\n+        manifest.setMediaType(manifestTemplate.getManifestMediaType());\n+        manifest.setSize(manifestDescriptor.getSize());\n+        manifest.setDigest(manifestDescriptor.getDigest().toString());\n+        manifest.setPlatform(builtImage.getArchitecture(), builtImage.getOs());\n+        manifestList.addManifest(manifest);\n+      }\n+      return manifestList;\n+\n+    } catch (IOException ex) {", "originalCommit": "17b63bdbdb6497a3c35566e074f28761024ce5f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcxMDM5Mw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r471710393", "bodyText": "I think this method should not catch this exception. Let's just throw it.", "author": "chanseokoh", "createdAt": "2020-08-17T18:53:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc5MzYzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc5NDE1MQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r470794151", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Adds a manifest to the manifestList.\n          \n          \n            \n               * Adds a manifest.", "author": "chanseokoh", "createdAt": "2020-08-14T18:30:21Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/image/json/V22ManifestListTemplate.java", "diffHunk": "@@ -68,13 +70,32 @@\n       \"application/vnd.docker.distribution.manifest.list.v2+json\";\n   private static final int SCHEMA_VERSION = 2;\n \n+  private final int schemaVersion = SCHEMA_VERSION;\n+  private final String mediaType = MANIFEST_MEDIA_TYPE;\n+\n   @Override\n   public int getSchemaVersion() {\n-    return SCHEMA_VERSION;\n+    return schemaVersion;\n+  }\n+\n+  public String getMediaType() {\n+    return mediaType;\n   }\n \n   @Nullable private List<ManifestDescriptorTemplate> manifests;\n \n+  /**\n+   * Adds a manifest to the manifestList.", "originalCommit": "17b63bdbdb6497a3c35566e074f28761024ce5f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc5OTE4Nw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r470799187", "bodyText": "This class shouldn't mention Image. The class is totally unrelated. I think we can just go with\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * @param manifest a JSON representation of an {@link Image}\n          \n          \n            \n               * @param manifest a manifest descriptor", "author": "chanseokoh", "createdAt": "2020-08-14T18:36:17Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/image/json/V22ManifestListTemplate.java", "diffHunk": "@@ -68,13 +70,32 @@\n       \"application/vnd.docker.distribution.manifest.list.v2+json\";\n   private static final int SCHEMA_VERSION = 2;\n \n+  private final int schemaVersion = SCHEMA_VERSION;\n+  private final String mediaType = MANIFEST_MEDIA_TYPE;\n+\n   @Override\n   public int getSchemaVersion() {\n-    return SCHEMA_VERSION;\n+    return schemaVersion;\n+  }\n+\n+  public String getMediaType() {\n+    return mediaType;\n   }\n \n   @Nullable private List<ManifestDescriptorTemplate> manifests;\n \n+  /**\n+   * Adds a manifest to the manifestList.\n+   *\n+   * @param manifest a JSON representation of an {@link Image}", "originalCommit": "17b63bdbdb6497a3c35566e074f28761024ce5f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "33ab89abacf5b1b0ce3c246297c189e2f1e2e66b", "url": "https://github.com/GoogleContainerTools/jib/commit/33ab89abacf5b1b0ce3c246297c189e2f1e2e66b", "message": "Fixing Styles", "committedDate": "2020-08-14T20:34:42Z", "type": "commit"}, {"oid": "5d65f6847a80d174e45f5dfc8dfd347ee84b93f0", "url": "https://github.com/GoogleContainerTools/jib/commit/5d65f6847a80d174e45f5dfc8dfd347ee84b93f0", "message": "Fixing Javadoc", "committedDate": "2020-08-14T20:38:38Z", "type": "commit"}, {"oid": "9274896a89afd09c98d71a8319496bc1bf10ed98", "url": "https://github.com/GoogleContainerTools/jib/commit/9274896a89afd09c98d71a8319496bc1bf10ed98", "message": "Adding missing file", "committedDate": "2020-08-14T20:43:24Z", "type": "commit"}, {"oid": "47f91a393f0129af5e4f39bb04d1d36170d7ef25", "url": "https://github.com/GoogleContainerTools/jib/commit/47f91a393f0129af5e4f39bb04d1d36170d7ef25", "message": "Minor Style Fix", "committedDate": "2020-08-14T23:16:41Z", "type": "commit"}, {"oid": "d7b908a69615f410936dc02f0b9a35ecb142cd41", "url": "https://github.com/GoogleContainerTools/jib/commit/d7b908a69615f410936dc02f0b9a35ecb142cd41", "message": "Adding tests for BuildManifestListOrSingleManifestStepTest", "committedDate": "2020-08-17T17:26:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTExOTkzOQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r471119939", "bodyText": "Let's not add this here. I think we will have it in a different place when everything is properly implemented.", "author": "chanseokoh", "createdAt": "2020-08-16T14:32:58Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -206,6 +209,7 @@ public BuildResult run() throws ExecutionException, InterruptedException {\n       rootProgressDispatcher = progressEventDispatcher;\n \n       stepsToRun.forEach(Runnable::run);\n+      realizeFutures(results.buildResults.get());", "originalCommit": "47f91a393f0129af5e4f39bb04d1d36170d7ef25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcxNDAxNw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r471714017", "bodyText": "Sounds good let me remove it.", "author": "louismurerwa", "createdAt": "2020-08-17T19:00:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTExOTkzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcxMzQ1OA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r471713458", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  return new ManifestListGenerator(this.builtImages)\n          \n          \n            \n                      .getManifestListTemplate(this.buildContext.getTargetFormat());\n          \n          \n            \n                  return new ManifestListGenerator(builtImages)\n          \n          \n            \n                      .getManifestListTemplate(buildContext.getTargetFormat());", "author": "chanseokoh", "createdAt": "2020-08-17T18:59:07Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/BuildManifestListOrSingleManifestStep.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.builder.steps;\n+\n+import com.google.cloud.tools.jib.api.LogEvent;\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.builder.ProgressEventDispatcher;\n+import com.google.cloud.tools.jib.builder.TimerEventDispatcher;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.event.EventHandlers;\n+import com.google.cloud.tools.jib.hash.Digests;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.json.ImageToJsonTranslator;\n+import com.google.cloud.tools.jib.image.json.ManifestListGenerator;\n+import com.google.cloud.tools.jib.image.json.ManifestTemplate;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.concurrent.Callable;\n+\n+/** Builds a manifest list or a single manifest. */\n+class BuildManifestListOrSingleManifestStep implements Callable<ManifestTemplate> {\n+\n+  private static final String DESCRIPTION = \"Building a manifest list or a single manifest\";\n+\n+  private final BuildContext buildContext;\n+  private final ProgressEventDispatcher.Factory progressEventDispatcherFactory;\n+  private final List<Image> builtImages;\n+\n+  BuildManifestListOrSingleManifestStep(\n+      BuildContext buildContext,\n+      ProgressEventDispatcher.Factory progressEventDispatcherFactory,\n+      List<Image> builtImages) {\n+    this.buildContext = buildContext;\n+    this.progressEventDispatcherFactory = progressEventDispatcherFactory;\n+    this.builtImages = builtImages;\n+  }\n+\n+  @Override\n+  public ManifestTemplate call() throws IOException {\n+\n+    EventHandlers eventHandlers = buildContext.getEventHandlers();\n+    try (TimerEventDispatcher ignored = new TimerEventDispatcher(eventHandlers, DESCRIPTION);\n+        ProgressEventDispatcher ignored2 =\n+            progressEventDispatcherFactory.create(\n+                \"building a manifest list or a single manifest\", 1)) {\n+\n+      if (builtImages.size() == 1) {\n+        eventHandlers.dispatch(LogEvent.info(\"Building a single manifest\"));\n+        ImageToJsonTranslator imageTranslator = new ImageToJsonTranslator(builtImages.get(0));\n+        BlobDescriptor configDescriptor =\n+            Digests.computeDigest(imageTranslator.getContainerConfiguration());\n+        return imageTranslator.getManifestTemplate(\n+            buildContext.getTargetFormat(), configDescriptor);\n+      }\n+\n+      eventHandlers.dispatch(LogEvent.info(\"Building a manifest list\"));\n+      return new ManifestListGenerator(this.builtImages)\n+          .getManifestListTemplate(this.buildContext.getTargetFormat());", "originalCommit": "47f91a393f0129af5e4f39bb04d1d36170d7ef25", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1028972f006c08dd6c6003a1e9e3d8628e96fc4e", "url": "https://github.com/GoogleContainerTools/jib/commit/1028972f006c08dd6c6003a1e9e3d8628e96fc4e", "message": "Create manifest list test chanseok (#2706)\n\n* Clean up code\r\n\r\n* Rename test methods\r\n\r\nCo-authored-by: Chanseok Oh <chanseok@google.com>", "committedDate": "2020-08-17T22:53:48Z", "type": "commit"}, {"oid": "2452f176adf83eb0be648a9a30835f54646db070", "url": "https://github.com/GoogleContainerTools/jib/commit/2452f176adf83eb0be648a9a30835f54646db070", "message": "Fixing BuildManifestList test", "committedDate": "2020-08-18T14:59:01Z", "type": "commit"}, {"oid": "23d977907a3da24fa64f5429f10a4a217a70d7db", "url": "https://github.com/GoogleContainerTools/jib/commit/23d977907a3da24fa64f5429f10a4a217a70d7db", "message": "Fixing Json Templates", "committedDate": "2020-08-18T15:02:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI2OTI2OA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472269268", "bodyText": "Javadoc comments (starting with /** using double asterisks) are basically for machine processing to generate a nice-looking manual for external users using a library. This is an internal code comment, so we should use // code comment. And no HTML formatting, and no need to follow the Javadoc convention. I also suggest proper indentation for readability.\n// Expected manifest JSON:\n// {\n//   \"schemaVersion\":2,\n//   \"mediaType\":\"application/vnd.docker.distribution.manifest.v2+json\",", "author": "chanseokoh", "createdAt": "2020-08-18T15:06:56Z", "path": "jib-core/src/test/java/com/google/cloud/tools/jib/builder/steps/BuildManifestListOrSingleManifestStepTest.java", "diffHunk": "@@ -0,0 +1,157 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.builder.steps;\n+\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.builder.ProgressEventDispatcher;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.event.EventHandlers;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.Layer;\n+import com.google.cloud.tools.jib.image.json.ManifestTemplate;\n+import com.google.cloud.tools.jib.image.json.V22ManifestListTemplate;\n+import com.google.cloud.tools.jib.image.json.V22ManifestTemplate;\n+import java.io.IOException;\n+import java.util.Arrays;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.junit.MockitoJUnitRunner;\n+\n+/** Tests for {@link BuildManifestListOrSingleManifest}. */\n+@RunWith(MockitoJUnitRunner.class)\n+public class BuildManifestListOrSingleManifestStepTest {\n+\n+  @Mock private ProgressEventDispatcher.Factory progressDispatcherFactory;\n+  @Mock private BuildContext buildContext;\n+  @Mock private Layer layer;\n+\n+  private Image image1;\n+  private Image image2;\n+\n+  @Before\n+  public void setUp() {\n+    Mockito.when(buildContext.getEventHandlers()).thenReturn(EventHandlers.NONE);\n+    Mockito.doReturn(V22ManifestTemplate.class).when(buildContext).getTargetFormat();\n+    Mockito.when(layer.getBlobDescriptor()).thenReturn(new BlobDescriptor(0, null));\n+\n+    image1 =\n+        Image.builder(V22ManifestTemplate.class)\n+            .setArchitecture(\"amd64\")\n+            .setOs(\"linux\")\n+            .addLayer(new PreparedLayer.Builder(layer).setName(\"resources\").build())\n+            .build();\n+    image2 =\n+        Image.builder(V22ManifestTemplate.class)\n+            .setArchitecture(\"arm64\")\n+            .setOs(\"ubuntu\")\n+            .addLayer(new PreparedLayer.Builder(layer).setName(\"classes\").build())\n+            .build();\n+  }\n+\n+  @Test\n+  public void testCall_singleManifest() throws IOException {\n+    /**\n+     * Expected manifest JSON:\n+     *\n+     * <pre>{@code\n+     * {\n+     * \"schemaVersion\":2,\n+     * \"mediaType\":\"application/vnd.docker.distribution.manifest.v2+json\",\n+     * \"config\":{\n+     * \"mediaType\":\"application/vnd.docker.container.image.v1+json\",\n+     * \"digest\":\"sha256:1b2ff280940537177565443144a81319ad48528fd35d1cdc38cbde07f24f6912\",\n+     * \"size\":158\n+     * },\n+     * \"layers\":[\n+     * {\n+     * \"mediaType\":\"application/vnd.docker.image.rootfs.diff.tar.gzip\",\n+     * \"size\":0\n+     * }\n+     * ]\n+     * }\n+     * }</pre>\n+     */", "originalCommit": "23d977907a3da24fa64f5429f10a4a217a70d7db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMwNTgwMA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472305800", "bodyText": "Yes this is the issue I was asking about in the meeting.I'l remove the java doc format and use code comments instead.", "author": "louismurerwa", "createdAt": "2020-08-18T15:58:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI2OTI2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI3MjE1Nw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472272157", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        .addLayer(new PreparedLayer.Builder(layer).setName(\"resources\").build())\n          \n          \n            \n                        .addLayer(layer)", "author": "chanseokoh", "createdAt": "2020-08-18T15:11:08Z", "path": "jib-core/src/test/java/com/google/cloud/tools/jib/builder/steps/BuildManifestListOrSingleManifestStepTest.java", "diffHunk": "@@ -0,0 +1,157 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.builder.steps;\n+\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.builder.ProgressEventDispatcher;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.event.EventHandlers;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.Layer;\n+import com.google.cloud.tools.jib.image.json.ManifestTemplate;\n+import com.google.cloud.tools.jib.image.json.V22ManifestListTemplate;\n+import com.google.cloud.tools.jib.image.json.V22ManifestTemplate;\n+import java.io.IOException;\n+import java.util.Arrays;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.junit.MockitoJUnitRunner;\n+\n+/** Tests for {@link BuildManifestListOrSingleManifest}. */\n+@RunWith(MockitoJUnitRunner.class)\n+public class BuildManifestListOrSingleManifestStepTest {\n+\n+  @Mock private ProgressEventDispatcher.Factory progressDispatcherFactory;\n+  @Mock private BuildContext buildContext;\n+  @Mock private Layer layer;\n+\n+  private Image image1;\n+  private Image image2;\n+\n+  @Before\n+  public void setUp() {\n+    Mockito.when(buildContext.getEventHandlers()).thenReturn(EventHandlers.NONE);\n+    Mockito.doReturn(V22ManifestTemplate.class).when(buildContext).getTargetFormat();\n+    Mockito.when(layer.getBlobDescriptor()).thenReturn(new BlobDescriptor(0, null));\n+\n+    image1 =\n+        Image.builder(V22ManifestTemplate.class)\n+            .setArchitecture(\"amd64\")\n+            .setOs(\"linux\")\n+            .addLayer(new PreparedLayer.Builder(layer).setName(\"resources\").build())", "originalCommit": "23d977907a3da24fa64f5429f10a4a217a70d7db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI3MjE4OQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472272189", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        .addLayer(new PreparedLayer.Builder(layer).setName(\"classes\").build())\n          \n          \n            \n                        .addLayer(layer)", "author": "chanseokoh", "createdAt": "2020-08-18T15:11:11Z", "path": "jib-core/src/test/java/com/google/cloud/tools/jib/builder/steps/BuildManifestListOrSingleManifestStepTest.java", "diffHunk": "@@ -0,0 +1,157 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.builder.steps;\n+\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.builder.ProgressEventDispatcher;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.event.EventHandlers;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.Layer;\n+import com.google.cloud.tools.jib.image.json.ManifestTemplate;\n+import com.google.cloud.tools.jib.image.json.V22ManifestListTemplate;\n+import com.google.cloud.tools.jib.image.json.V22ManifestTemplate;\n+import java.io.IOException;\n+import java.util.Arrays;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.junit.MockitoJUnitRunner;\n+\n+/** Tests for {@link BuildManifestListOrSingleManifest}. */\n+@RunWith(MockitoJUnitRunner.class)\n+public class BuildManifestListOrSingleManifestStepTest {\n+\n+  @Mock private ProgressEventDispatcher.Factory progressDispatcherFactory;\n+  @Mock private BuildContext buildContext;\n+  @Mock private Layer layer;\n+\n+  private Image image1;\n+  private Image image2;\n+\n+  @Before\n+  public void setUp() {\n+    Mockito.when(buildContext.getEventHandlers()).thenReturn(EventHandlers.NONE);\n+    Mockito.doReturn(V22ManifestTemplate.class).when(buildContext).getTargetFormat();\n+    Mockito.when(layer.getBlobDescriptor()).thenReturn(new BlobDescriptor(0, null));\n+\n+    image1 =\n+        Image.builder(V22ManifestTemplate.class)\n+            .setArchitecture(\"amd64\")\n+            .setOs(\"linux\")\n+            .addLayer(new PreparedLayer.Builder(layer).setName(\"resources\").build())\n+            .build();\n+    image2 =\n+        Image.builder(V22ManifestTemplate.class)\n+            .setArchitecture(\"arm64\")\n+            .setOs(\"ubuntu\")\n+            .addLayer(new PreparedLayer.Builder(layer).setName(\"classes\").build())", "originalCommit": "23d977907a3da24fa64f5429f10a4a217a70d7db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI3OTU5Mw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472279593", "bodyText": "I see we always create a Docker manifest list, which is another limitation of multi-platform image building. Note that there are 2 avenues for considering OCI vs Docker format.\n\nBase image: we take care of this automatically, and the format is transparent to the user.\nTarget image(s): user-configurable with <format>OCI or <format>Docker.\n\nThat is, Jib will be broken when <format>OCI is specified (because we will build OCI manifests while a Docker manifest). We should add another item to fix. Please add this to your tracking list.", "author": "chanseokoh", "createdAt": "2020-08-18T15:21:35Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/image/json/ManifestListGenerator.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.image.json;\n+\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.hash.Digests;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.json.V22ManifestListTemplate.ManifestDescriptorTemplate;\n+import java.io.IOException;\n+import java.util.List;\n+\n+/** Generates a manifest list for {@link Image}s. */\n+public class ManifestListGenerator {\n+\n+  private final List<Image> images;\n+\n+  public ManifestListGenerator(List<Image> images) {\n+    this.images = images;\n+  }\n+\n+  /**\n+   * Generates a manifest list JSON for the given {@link Image}s.\n+   *\n+   * @param <T> child type of {@link BuildableManifestTemplate}\n+   * @param manifestTemplateClass the JSON template to translate the image to\n+   * @return a manifest list JSON\n+   */\n+  public <T extends BuildableManifestTemplate> ManifestTemplate getManifestListTemplate(\n+      Class<T> manifestTemplateClass) {\n+    try {\n+      V22ManifestListTemplate manifestList = new V22ManifestListTemplate();", "originalCommit": "23d977907a3da24fa64f5429f10a4a217a70d7db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI5ODAwMw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472298003", "bodyText": "Note that support OCI for target images is much more important: most registries can just convert OCI to Docker on-the-fly, so not accepting an OCI base image manifest isn't really a problem in practice. OTOH, specifying <format>OCI will outright breaking Jib image building (in the multi-platform case).", "author": "chanseokoh", "createdAt": "2020-08-18T15:46:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI3OTU5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM2ODc0OQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472368749", "bodyText": "Added", "author": "louismurerwa", "createdAt": "2020-08-18T17:37:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI3OTU5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI4NDA5Mw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472284093", "bodyText": "nit: let's say \"windows\" to eliminate any potential misunderstanding. (Ubuntu is linux).", "author": "chanseokoh", "createdAt": "2020-08-18T15:27:31Z", "path": "jib-core/src/test/java/com/google/cloud/tools/jib/builder/steps/BuildManifestListOrSingleManifestStepTest.java", "diffHunk": "@@ -0,0 +1,157 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.builder.steps;\n+\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.builder.ProgressEventDispatcher;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.event.EventHandlers;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.Layer;\n+import com.google.cloud.tools.jib.image.json.ManifestTemplate;\n+import com.google.cloud.tools.jib.image.json.V22ManifestListTemplate;\n+import com.google.cloud.tools.jib.image.json.V22ManifestTemplate;\n+import java.io.IOException;\n+import java.util.Arrays;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.junit.MockitoJUnitRunner;\n+\n+/** Tests for {@link BuildManifestListOrSingleManifest}. */\n+@RunWith(MockitoJUnitRunner.class)\n+public class BuildManifestListOrSingleManifestStepTest {\n+\n+  @Mock private ProgressEventDispatcher.Factory progressDispatcherFactory;\n+  @Mock private BuildContext buildContext;\n+  @Mock private Layer layer;\n+\n+  private Image image1;\n+  private Image image2;\n+\n+  @Before\n+  public void setUp() {\n+    Mockito.when(buildContext.getEventHandlers()).thenReturn(EventHandlers.NONE);\n+    Mockito.doReturn(V22ManifestTemplate.class).when(buildContext).getTargetFormat();\n+    Mockito.when(layer.getBlobDescriptor()).thenReturn(new BlobDescriptor(0, null));\n+\n+    image1 =\n+        Image.builder(V22ManifestTemplate.class)\n+            .setArchitecture(\"amd64\")\n+            .setOs(\"linux\")\n+            .addLayer(new PreparedLayer.Builder(layer).setName(\"resources\").build())\n+            .build();\n+    image2 =\n+        Image.builder(V22ManifestTemplate.class)\n+            .setArchitecture(\"arm64\")\n+            .setOs(\"ubuntu\")", "originalCommit": "23d977907a3da24fa64f5429f10a4a217a70d7db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2d94db6403996845dbc373f13426536635dcba24", "url": "https://github.com/GoogleContainerTools/jib/commit/2d94db6403996845dbc373f13426536635dcba24", "message": "Testing", "committedDate": "2020-08-18T15:34:53Z", "type": "commit"}, {"oid": "3f93d87b8d6e45437322d072ff30be35d3314628", "url": "https://github.com/GoogleContainerTools/jib/commit/3f93d87b8d6e45437322d072ff30be35d3314628", "message": "Respond to feedback", "committedDate": "2020-08-18T17:39:19Z", "type": "commit"}, {"oid": "82408256cfa12b4794fd099a43407efa89e53800", "url": "https://github.com/GoogleContainerTools/jib/commit/82408256cfa12b4794fd099a43407efa89e53800", "message": "Removing a file", "committedDate": "2020-08-18T17:47:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM3ODYzNg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472378636", "bodyText": "We should keep this. Will be handy going forward.", "author": "chanseokoh", "createdAt": "2020-08-18T17:54:20Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -481,7 +498,6 @@ private void checkImageInTargetRegistry() {\n     results.manifestCheckResult =\n         executorService.submit(\n             () -> {\n-              Verify.verify(results.builtImagesAndBaseImages.get().size() == 1);", "originalCommit": "82408256cfa12b4794fd099a43407efa89e53800", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQyNDA3MQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472424071", "bodyText": "Why do we need to keep this ?", "author": "louismurerwa", "createdAt": "2020-08-18T19:18:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM3ODYzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQzNzgyNw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472437827", "bodyText": "Our code is broken at HEAD if results.builtImagesAndBaseImages.get().size() != 1, so I think keeping as many checks as possible helps while we fix our code.", "author": "chanseokoh", "createdAt": "2020-08-18T19:44:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM3ODYzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM3OTc3MA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472379770", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * @throws IOException IOException\n          \n          \n            \n               * @throws IOException if generating a manifest list fails due to an I/O error when computing digests", "author": "chanseokoh", "createdAt": "2020-08-18T17:56:08Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/image/json/ManifestListGenerator.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.image.json;\n+\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.hash.Digests;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.json.V22ManifestListTemplate.ManifestDescriptorTemplate;\n+import java.io.IOException;\n+import java.util.List;\n+\n+/** Generates a manifest list for {@link Image}s. */\n+public class ManifestListGenerator {\n+\n+  private final List<Image> images;\n+\n+  public ManifestListGenerator(List<Image> images) {\n+    this.images = images;\n+  }\n+\n+  /**\n+   * Generates a manifest list JSON for the given {@link Image}s.\n+   *\n+   * @param <T> child type of {@link BuildableManifestTemplate}\n+   * @param manifestTemplateClass the JSON template to translate the image to\n+   * @return a manifest list JSON\n+   * @throws IOException IOException", "originalCommit": "82408256cfa12b4794fd099a43407efa89e53800", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM4MTg1OQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472381859", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \n          \n          \n            \n                Preconditions.checkArgument(manifestTemplateClass == V22ManifestTemplate.class, \"Build an OCI image index is not yet supported\"); \n          \n      \n    \n    \n  \n\nAnd super-nit: I see you often put a blank line when starting a method, but we've not been doing that in our repo.", "author": "chanseokoh", "createdAt": "2020-08-18T17:59:39Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/image/json/ManifestListGenerator.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.image.json;\n+\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.hash.Digests;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.json.V22ManifestListTemplate.ManifestDescriptorTemplate;\n+import java.io.IOException;\n+import java.util.List;\n+\n+/** Generates a manifest list for {@link Image}s. */\n+public class ManifestListGenerator {\n+\n+  private final List<Image> images;\n+\n+  public ManifestListGenerator(List<Image> images) {\n+    this.images = images;\n+  }\n+\n+  /**\n+   * Generates a manifest list JSON for the given {@link Image}s.\n+   *\n+   * @param <T> child type of {@link BuildableManifestTemplate}\n+   * @param manifestTemplateClass the JSON template to translate the image to\n+   * @return a manifest list JSON\n+   * @throws IOException IOException\n+   */\n+  public <T extends BuildableManifestTemplate> ManifestTemplate getManifestListTemplate(\n+      Class<T> manifestTemplateClass) throws IOException {\n+", "originalCommit": "82408256cfa12b4794fd099a43407efa89e53800", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQxMTE5OA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472411198", "bodyText": "I usually put it for readability but I'l make sure to remove the spaces now", "author": "louismurerwa", "createdAt": "2020-08-18T18:53:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM4MTg1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM4MjcxOA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472382718", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // \"schemaVersion\":2,\n          \n          \n            \n                //  \"schemaVersion\":2,", "author": "chanseokoh", "createdAt": "2020-08-18T18:01:11Z", "path": "jib-core/src/test/java/com/google/cloud/tools/jib/builder/steps/BuildManifestListOrSingleManifestStepTest.java", "diffHunk": "@@ -0,0 +1,150 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.builder.steps;\n+\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.builder.ProgressEventDispatcher;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.event.EventHandlers;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.Layer;\n+import com.google.cloud.tools.jib.image.json.ManifestTemplate;\n+import com.google.cloud.tools.jib.image.json.V22ManifestListTemplate;\n+import com.google.cloud.tools.jib.image.json.V22ManifestTemplate;\n+import java.io.IOException;\n+import java.util.Arrays;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.junit.MockitoJUnitRunner;\n+\n+/** Tests for {@link BuildManifestListOrSingleManifest}. */\n+@RunWith(MockitoJUnitRunner.class)\n+public class BuildManifestListOrSingleManifestStepTest {\n+\n+  @Mock private ProgressEventDispatcher.Factory progressDispatcherFactory;\n+  @Mock private BuildContext buildContext;\n+  @Mock private Layer layer;\n+\n+  private Image image1;\n+  private Image image2;\n+\n+  @Before\n+  public void setUp() {\n+    Mockito.when(buildContext.getEventHandlers()).thenReturn(EventHandlers.NONE);\n+    Mockito.doReturn(V22ManifestTemplate.class).when(buildContext).getTargetFormat();\n+    Mockito.when(layer.getBlobDescriptor()).thenReturn(new BlobDescriptor(0, null));\n+\n+    image1 =\n+        Image.builder(V22ManifestTemplate.class)\n+            .setArchitecture(\"amd64\")\n+            .setOs(\"linux\")\n+            .addLayer(layer)\n+            .build();\n+    image2 =\n+        Image.builder(V22ManifestTemplate.class)\n+            .setArchitecture(\"arm64\")\n+            .setOs(\"windows\")\n+            .addLayer(layer)\n+            .build();\n+  }\n+\n+  @Test\n+  public void testCall_singleManifest() throws IOException {\n+\n+    // Expected manifest JSON\n+    //  {\n+    // \"schemaVersion\":2,", "originalCommit": "82408256cfa12b4794fd099a43407efa89e53800", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM4Mjg4MA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472382880", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // \"schemaVersion\":2,\n          \n          \n            \n                //  \"schemaVersion\":2,", "author": "chanseokoh", "createdAt": "2020-08-18T18:01:29Z", "path": "jib-core/src/test/java/com/google/cloud/tools/jib/builder/steps/BuildManifestListOrSingleManifestStepTest.java", "diffHunk": "@@ -0,0 +1,150 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.builder.steps;\n+\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.builder.ProgressEventDispatcher;\n+import com.google.cloud.tools.jib.configuration.BuildContext;\n+import com.google.cloud.tools.jib.event.EventHandlers;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.Layer;\n+import com.google.cloud.tools.jib.image.json.ManifestTemplate;\n+import com.google.cloud.tools.jib.image.json.V22ManifestListTemplate;\n+import com.google.cloud.tools.jib.image.json.V22ManifestTemplate;\n+import java.io.IOException;\n+import java.util.Arrays;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.junit.MockitoJUnitRunner;\n+\n+/** Tests for {@link BuildManifestListOrSingleManifest}. */\n+@RunWith(MockitoJUnitRunner.class)\n+public class BuildManifestListOrSingleManifestStepTest {\n+\n+  @Mock private ProgressEventDispatcher.Factory progressDispatcherFactory;\n+  @Mock private BuildContext buildContext;\n+  @Mock private Layer layer;\n+\n+  private Image image1;\n+  private Image image2;\n+\n+  @Before\n+  public void setUp() {\n+    Mockito.when(buildContext.getEventHandlers()).thenReturn(EventHandlers.NONE);\n+    Mockito.doReturn(V22ManifestTemplate.class).when(buildContext).getTargetFormat();\n+    Mockito.when(layer.getBlobDescriptor()).thenReturn(new BlobDescriptor(0, null));\n+\n+    image1 =\n+        Image.builder(V22ManifestTemplate.class)\n+            .setArchitecture(\"amd64\")\n+            .setOs(\"linux\")\n+            .addLayer(layer)\n+            .build();\n+    image2 =\n+        Image.builder(V22ManifestTemplate.class)\n+            .setArchitecture(\"arm64\")\n+            .setOs(\"windows\")\n+            .addLayer(layer)\n+            .build();\n+  }\n+\n+  @Test\n+  public void testCall_singleManifest() throws IOException {\n+\n+    // Expected manifest JSON\n+    //  {\n+    // \"schemaVersion\":2,\n+    //  \"mediaType\":\"application/vnd.docker.distribution.manifest.v2+json\",\n+    //  \"config\":{\n+    //    \"mediaType\":\"application/vnd.docker.container.image.v1+json\",\n+    //    \"digest\":\"sha256:1b2ff280940537177565443144a81319ad48528fd35d1cdc38cbde07f24f6912\",\n+    //    \"size\":158\n+    //  },\n+    //  \"layers\":[\n+    //    {\n+    //      \"mediaType\":\"application/vnd.docker.image.rootfs.diff.tar.gzip\",\n+    //      \"size\":0\n+    //    }\n+    //  ]\n+    // }\n+\n+    ManifestTemplate manifestTemplate =\n+        new BuildManifestListOrSingleManifestStep(\n+                buildContext, progressDispatcherFactory, Arrays.asList(image1))\n+            .call();\n+\n+    Assert.assertTrue(manifestTemplate instanceof V22ManifestTemplate);\n+    V22ManifestTemplate manifest = (V22ManifestTemplate) manifestTemplate;\n+    Assert.assertEquals(2, manifest.getSchemaVersion());\n+    Assert.assertEquals(\n+        \"application/vnd.docker.distribution.manifest.v2+json\", manifest.getManifestMediaType());\n+    Assert.assertEquals(\n+        \"sha256:1b2ff280940537177565443144a81319ad48528fd35d1cdc38cbde07f24f6912\",\n+        manifest.getContainerConfiguration().getDigest().toString());\n+    Assert.assertEquals(0, manifest.getLayers().get(0).getSize());\n+    Assert.assertEquals(158, manifest.getContainerConfiguration().getSize());\n+  }\n+\n+  @Test\n+  public void testCall_manifestList() throws IOException {\n+\n+    // Expected Manifest List JSON\n+    //  {\n+    // \"schemaVersion\":2,", "originalCommit": "82408256cfa12b4794fd099a43407efa89e53800", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM4MzI0NQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472383245", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // \"schemaVersion\":2,\n          \n          \n            \n                //  \"schemaVersion\":2,", "author": "chanseokoh", "createdAt": "2020-08-18T18:02:10Z", "path": "jib-core/src/test/java/com/google/cloud/tools/jib/image/json/ManifestListGeneratorTest.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.image.json;\n+\n+import com.google.cloud.tools.jib.image.Image;\n+import java.io.IOException;\n+import java.util.Arrays;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+/** Tests for {@link ManifestListGenerator}. */\n+public class ManifestListGeneratorTest {\n+\n+  private Image image1;\n+  private Image image2;\n+  private ManifestListGenerator manifestListGenerator;\n+\n+  private void setUp(Class<? extends BuildableManifestTemplate> imageFormat) {\n+    image1 = Image.builder(imageFormat).setArchitecture(\"amd64\").setOs(\"linux\").build();\n+    image2 = Image.builder(imageFormat).setArchitecture(\"arm64\").setOs(\"windows\").build();\n+    manifestListGenerator = new ManifestListGenerator(Arrays.asList(image1, image2));\n+  }\n+\n+  @Test\n+  public void testGetManifest_v22() throws IOException {\n+    setUp(V22ManifestTemplate.class);\n+    testGetManifestListTemplate(V22ManifestTemplate.class);\n+  }\n+\n+  /** Tests translation of image to {@link BuildableManifestTemplate}. */\n+  private <T extends BuildableManifestTemplate> void testGetManifestListTemplate(\n+      Class<T> manifestTemplateClass) throws IOException {\n+\n+    // Expected Manifest List JSON\n+    //  {\n+    // \"schemaVersion\":2,", "originalCommit": "82408256cfa12b4794fd099a43407efa89e53800", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM4MzUyNA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472383524", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private void setUp(Class<? extends BuildableManifestTemplate> imageFormat) {\n          \n          \n            \n              @Before\n          \n          \n            \n              private void setUp() {", "author": "chanseokoh", "createdAt": "2020-08-18T18:02:38Z", "path": "jib-core/src/test/java/com/google/cloud/tools/jib/image/json/ManifestListGeneratorTest.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.image.json;\n+\n+import com.google.cloud.tools.jib.image.Image;\n+import java.io.IOException;\n+import java.util.Arrays;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+/** Tests for {@link ManifestListGenerator}. */\n+public class ManifestListGeneratorTest {\n+\n+  private Image image1;\n+  private Image image2;\n+  private ManifestListGenerator manifestListGenerator;\n+\n+  private void setUp(Class<? extends BuildableManifestTemplate> imageFormat) {", "originalCommit": "82408256cfa12b4794fd099a43407efa89e53800", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM4Mzk2Ng==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472383966", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              @Test\n          \n          \n            \n              public void testGetManifest_v22() throws IOException {\n          \n          \n            \n                setUp(V22ManifestTemplate.class);\n          \n          \n            \n                testGetManifestListTemplate(V22ManifestTemplate.class);\n          \n          \n            \n              }\n          \n          \n            \n            \n          \n          \n            \n              /** Tests translation of image to {@link BuildableManifestTemplate}. */\n          \n          \n            \n              private <T extends BuildableManifestTemplate> void testGetManifestListTemplate(\n          \n          \n            \n              @Test\n          \n          \n            \n              public void testGetManifestListTemplate(", "author": "chanseokoh", "createdAt": "2020-08-18T18:03:31Z", "path": "jib-core/src/test/java/com/google/cloud/tools/jib/image/json/ManifestListGeneratorTest.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.image.json;\n+\n+import com.google.cloud.tools.jib.image.Image;\n+import java.io.IOException;\n+import java.util.Arrays;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+/** Tests for {@link ManifestListGenerator}. */\n+public class ManifestListGeneratorTest {\n+\n+  private Image image1;\n+  private Image image2;\n+  private ManifestListGenerator manifestListGenerator;\n+\n+  private void setUp(Class<? extends BuildableManifestTemplate> imageFormat) {\n+    image1 = Image.builder(imageFormat).setArchitecture(\"amd64\").setOs(\"linux\").build();\n+    image2 = Image.builder(imageFormat).setArchitecture(\"arm64\").setOs(\"windows\").build();\n+    manifestListGenerator = new ManifestListGenerator(Arrays.asList(image1, image2));\n+  }\n+\n+  @Test\n+  public void testGetManifest_v22() throws IOException {\n+    setUp(V22ManifestTemplate.class);\n+    testGetManifestListTemplate(V22ManifestTemplate.class);\n+  }\n+\n+  /** Tests translation of image to {@link BuildableManifestTemplate}. */\n+  private <T extends BuildableManifestTemplate> void testGetManifestListTemplate(", "originalCommit": "82408256cfa12b4794fd099a43407efa89e53800", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM4NDE2Ng==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472384166", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                //  ]\n          \n          \n            \n                //   ]", "author": "chanseokoh", "createdAt": "2020-08-18T18:03:52Z", "path": "jib-core/src/test/java/com/google/cloud/tools/jib/image/json/ManifestListGeneratorTest.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.image.json;\n+\n+import com.google.cloud.tools.jib.image.Image;\n+import java.io.IOException;\n+import java.util.Arrays;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+/** Tests for {@link ManifestListGenerator}. */\n+public class ManifestListGeneratorTest {\n+\n+  private Image image1;\n+  private Image image2;\n+  private ManifestListGenerator manifestListGenerator;\n+\n+  private void setUp(Class<? extends BuildableManifestTemplate> imageFormat) {\n+    image1 = Image.builder(imageFormat).setArchitecture(\"amd64\").setOs(\"linux\").build();\n+    image2 = Image.builder(imageFormat).setArchitecture(\"arm64\").setOs(\"windows\").build();\n+    manifestListGenerator = new ManifestListGenerator(Arrays.asList(image1, image2));\n+  }\n+\n+  @Test\n+  public void testGetManifest_v22() throws IOException {\n+    setUp(V22ManifestTemplate.class);\n+    testGetManifestListTemplate(V22ManifestTemplate.class);\n+  }\n+\n+  /** Tests translation of image to {@link BuildableManifestTemplate}. */\n+  private <T extends BuildableManifestTemplate> void testGetManifestListTemplate(\n+      Class<T> manifestTemplateClass) throws IOException {\n+\n+    // Expected Manifest List JSON\n+    //  {\n+    // \"schemaVersion\":2,\n+    //  \"mediaType\":\"application/vnd.docker.distribution.manifest.list.v2+json\",\n+    //  \"manifests\":[\n+    //    {\n+    //      \"mediaType\":\"application/vnd.docker.distribution.manifest.v2+json\",\n+    //      \"digest\":\"sha256:1f25787aab4669d252bdae09a72b9c345d2a7b8c64c8dbfba4c82af4834dbccc\",\n+    //      \"size\":264,\n+    //      \"platform\":{\n+    //        \"architecture\":\"amd64\",\n+    //        \"os\":\"linux\"\n+    //      }\n+    //    },\n+    //    {\n+    //      \"mediaType\":\"application/vnd.docker.distribution.manifest.v2+json\",\n+    //      \"digest\":\"sha256:51038a7a91c0e8f747e05dd84c3b0393a7016ec312ce384fc945356778497ae3\",\n+    //      \"size\":264,\n+    //      \"platform\":{\n+    //        \"architecture\":\"arm64\",\n+    //        \"os\":\"windows\"\n+    //      }\n+    //    }\n+    //  ]", "originalCommit": "82408256cfa12b4794fd099a43407efa89e53800", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "07c1d84cd6a153827ebcd123ab41cafead5b5234", "url": "https://github.com/GoogleContainerTools/jib/commit/07c1d84cd6a153827ebcd123ab41cafead5b5234", "message": "Style Fixes", "committedDate": "2020-08-18T19:15:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ0OTA1Mg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472449052", "bodyText": "Oh, we should consider the boundary condition when images is empty. I think it makes sense to just fail\nPreconditions.checkState(!images.isEmpty(), \"no images given\");\n\nand add a test for this. (It's important to test boundary conditions.) It also makes sense to add the same test in BuildManifestListOrSingleManifestStepTest to see if the exception is properly propagated to that level too.", "author": "chanseokoh", "createdAt": "2020-08-18T20:04:25Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/image/json/ManifestListGenerator.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.image.json;\n+\n+import com.google.api.client.util.Preconditions;\n+import com.google.cloud.tools.jib.blob.BlobDescriptor;\n+import com.google.cloud.tools.jib.hash.Digests;\n+import com.google.cloud.tools.jib.image.Image;\n+import com.google.cloud.tools.jib.image.json.V22ManifestListTemplate.ManifestDescriptorTemplate;\n+import java.io.IOException;\n+import java.util.List;\n+\n+/** Generates a manifest list for {@link Image}s. */\n+public class ManifestListGenerator {\n+\n+  private final List<Image> images;\n+\n+  public ManifestListGenerator(List<Image> images) {\n+    this.images = images;\n+  }\n+\n+  /**\n+   * Generates a manifest list JSON for the given {@link Image}s.\n+   *\n+   * @param <T> child type of {@link BuildableManifestTemplate}\n+   * @param manifestTemplateClass the JSON template to translate the image to\n+   * @return a manifest list JSON\n+   * @throws IOException if generating a manifest list fails due to an I/O error when computing\n+   *     digests\n+   */\n+  public <T extends BuildableManifestTemplate> ManifestTemplate getManifestListTemplate(\n+      Class<T> manifestTemplateClass) throws IOException {\n+    Preconditions.checkArgument(\n+        manifestTemplateClass == V22ManifestTemplate.class,\n+        \"Build an OCI image index is not yet supported\");", "originalCommit": "07c1d84cd6a153827ebcd123ab41cafead5b5234", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ1OTA4Mg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472459082", "bodyText": "That makes sense , I was thinking about these cases from the StepsRunner standpoint. Since steps runner always ensures the !images.isEmpty()  we should be good but I am now realizing that these libraries can be called from anywhere in Jib so we actually need to check the parameters also inside the libraries themselves.", "author": "louismurerwa", "createdAt": "2020-08-18T20:15:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ0OTA1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ2MTI4Mg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2701#discussion_r472461282", "bodyText": "Exactly. The class is independent of StepsRunner (or anything else unrelated). And as soon as we have the class, other parts of the Jib repo will pick it up and start using it. The implementation should be self-sufficient and error-tolerant.", "author": "chanseokoh", "createdAt": "2020-08-18T20:18:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ0OTA1Mg=="}], "type": "inlineReview"}, {"oid": "566e155b17d3ab9394f562bbefc2704c285fb48d", "url": "https://github.com/GoogleContainerTools/jib/commit/566e155b17d3ab9394f562bbefc2704c285fb48d", "message": "Adding Testing", "committedDate": "2020-08-19T15:05:31Z", "type": "commit"}, {"oid": "743933c5f1fe6ec53a371d74191808082c7cd03b", "url": "https://github.com/GoogleContainerTools/jib/commit/743933c5f1fe6ec53a371d74191808082c7cd03b", "message": "Triggering Tests", "committedDate": "2020-08-19T15:35:53Z", "type": "commit"}]}