{"pr_number": 2670, "pr_title": "Update FAQ and plugin reference docs about selecting base image platform from a manifest list", "pr_createdAt": "2020-08-06T18:57:57Z", "pr_url": "https://github.com/GoogleContainerTools/jib/pull/2670", "timeline": [{"oid": "512c21e0e20247a0ffe1656e828adf1e233753f2", "url": "https://github.com/GoogleContainerTools/jib/commit/512c21e0e20247a0ffe1656e828adf1e233753f2", "message": "Update FAQ about specifying a base image platform", "committedDate": "2020-08-06T18:54:01Z", "type": "commit"}, {"oid": "2277db302fe14ed5e9bcd03461156e2eff896d49", "url": "https://github.com/GoogleContainerTools/jib/commit/2277db302fe14ed5e9bcd03461156e2eff896d49", "message": "Update doc", "committedDate": "2020-08-06T18:55:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYyMjc0Mg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2670#discussion_r466622742", "bodyText": "@louismurerwa what happens as of now if the user is currently specifying a manifest (as opposed to a manifest list) of a non-default platform with Jib 2.4.0 and upgrades to 2.5.0? Will it fail or just shows a warning?", "author": "chanseokoh", "createdAt": "2020-08-06T18:59:56Z", "path": "docs/faq.md", "diffHunk": "@@ -469,18 +469,46 @@ To inspect the image that is produced from the build using Docker, you can use c\n \n ### How do I specify a platform in the manifest list (or OCI index) of a base image?\n \n-By design, if the target image reference is a [manifest list](https://docs.docker.com/registry/spec/manifest-v2-2/#manifest-list), Jib will always select an image for the platform `amd64/linux`. If you need to specify a different image from a manifest list you must specify the digest for the platform you are targeting.\n+Jib 2.5.0 added an _incubating feature_ that provides limited support for selecting a base image with the desired platform from a manifest list. For example,\n \n-To view a manifest, [enable experimental docker CLI](https://docs.docker.com/engine/reference/commandline/cli/#experimental-features) features and then run the [manifest inspect](https://docs.docker.com/engine/reference/commandline/manifest_inspect/) command.\n+```xml\n+  <from>\n+    <image>... image reference to a manifest list ...</image>\n+    <platforms>\n+      <platform>\n+        <architecture>arm64</architecture>\n+        <os>linux</os>\n+      </platform>\n+    </platforms>\n+  </from>\n ```\n-$ docker manifest inspect openjdk:8\n+\n+```gradle\n+jib.from {\n+  image = '... image reference to a manifest list ...'\n+  platforms {\n+    platform {\n+      architecture = 'arm64'\n+      os = 'linux'\n+    }\n+  }\n+}\n ```\n \n-You can then inspect the output for the specific image you want (in this example an image for the platform `arm64/linux`)\n-```java\n+The default platform is \"amd64/linux\" if not specified, whose behavior is backward-compatible.\n+\n+As an incubating feature, there are certain limitations:\n+- OCI image indices are not supported (as opposed to Docker manifest lists).\n+- Supports specifying only one platform.\n+- Only `architecture` and `os` are supported. If there are multiple base images with given architecture and os, the first image will be selected.\n+\n+Make sure to specify a manifest _list_ in `<from><image>` (whether by a tag name or a digest (`@sha256:...`)). For troubleshooting, you may want to check what platforms a manifest list contains. To view a manifest, [enable experimental docker CLI](https://docs.docker.com/engine/reference/commandline/cli/#experimental-features) features and then run the [manifest inspect](https://docs.docker.com/engine/reference/commandline/manifest_inspect/) command.", "originalCommit": "2277db302fe14ed5e9bcd03461156e2eff896d49", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE0ODY2OA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2670#discussion_r467148668", "bodyText": "User specifies a manifest of a non-default platform\nJib 2.4.0 - This is the old Jib - it just builds using the manifest it found - it doesnt care about the platform of the manifest\nJib 2.5.0 - This is the the new Jib release - It also builds using the manifest it finds - It is not checking whether the specified manifest matches the default platform.\n\n  \n    \n      jib/jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/PullBaseImageStep.java\n    \n    \n         Line 234\n      in\n      4fae9f1\n    \n    \n    \n    \n\n        \n          \n           return Collections.singletonList( \n        \n    \n  \n\n\nShould I create an issue about this?", "author": "louismurerwa", "createdAt": "2020-08-07T16:37:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYyMjc0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE2ODE2OQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2670#discussion_r467168169", "bodyText": "I see. So there's no change on that front; no warning or error, right? I know you've been keeping tracking of tasks to do in a separate doc. If you prefer, you can use GitHub as a tracking tool by creating issues. But eventually, I planned to have you file issues anyway.", "author": "chanseokoh", "createdAt": "2020-08-07T17:16:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYyMjc0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE3MDE3NA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2670#discussion_r467170174", "bodyText": "Awesome I will track this in the doc and file an issue at the end of the summer if I don't manage to fix it then.", "author": "louismurerwa", "createdAt": "2020-08-07T17:20:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYyMjc0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE3Mjk4Ng==", "url": "https://github.com/GoogleContainerTools/jib/pull/2670#discussion_r467172986", "bodyText": "Sounds good. Other than that, do the overall doc changes look OK?", "author": "chanseokoh", "createdAt": "2020-08-07T17:26:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYyMjc0Mg=="}], "type": "inlineReview"}, {"oid": "fdddf46321a0a23976c78de7daab560c159643dd", "url": "https://github.com/GoogleContainerTools/jib/commit/fdddf46321a0a23976c78de7daab560c159643dd", "message": "Add jib.from.platforms reference doc", "committedDate": "2020-08-06T19:56:03Z", "type": "commit"}, {"oid": "ea1efabba558bf6341de6104dbf86733ecf7dae7", "url": "https://github.com/GoogleContainerTools/jib/commit/ea1efabba558bf6341de6104dbf86733ecf7dae7", "message": "consistency", "committedDate": "2020-08-06T20:00:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIzNDEyNg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2670#discussion_r467234126", "bodyText": "Updating this line to ->\nOnly architecture and os are supported. If there are multiple base images with given architecture and os in the manifest list, the first image will be selected.", "author": "louismurerwa", "createdAt": "2020-08-07T19:39:19Z", "path": "docs/faq.md", "diffHunk": "@@ -469,18 +469,46 @@ To inspect the image that is produced from the build using Docker, you can use c\n \n ### How do I specify a platform in the manifest list (or OCI index) of a base image?\n \n-By design, if the target image reference is a [manifest list](https://docs.docker.com/registry/spec/manifest-v2-2/#manifest-list), Jib will always select an image for the platform `amd64/linux`. If you need to specify a different image from a manifest list you must specify the digest for the platform you are targeting.\n+Jib 2.5.0 added an _incubating feature_ that provides limited support for selecting a base image with the desired platform from a manifest list. For example,\n \n-To view a manifest, [enable experimental docker CLI](https://docs.docker.com/engine/reference/commandline/cli/#experimental-features) features and then run the [manifest inspect](https://docs.docker.com/engine/reference/commandline/manifest_inspect/) command.\n+```xml\n+  <from>\n+    <image>... image reference to a manifest list ...</image>\n+    <platforms>\n+      <platform>\n+        <architecture>arm64</architecture>\n+        <os>linux</os>\n+      </platform>\n+    </platforms>\n+  </from>\n ```\n-$ docker manifest inspect openjdk:8\n+\n+```gradle\n+jib.from {\n+  image = '... image reference to a manifest list ...'\n+  platforms {\n+    platform {\n+      architecture = 'arm64'\n+      os = 'linux'\n+    }\n+  }\n+}\n ```\n \n-You can then inspect the output for the specific image you want (in this example an image for the platform `arm64/linux`)\n-```java\n+The default platform is \"amd64/linux\" if not specified, whose behavior is backward-compatible.\n+\n+As an incubating feature, there are certain limitations:\n+- OCI image indices are not supported (as opposed to Docker manifest lists).\n+- Supports specifying only one platform.\n+- Only `architecture` and `os` are supported. If there are multiple base images with given architecture and os, the first image will be selected.", "originalCommit": "ea1efabba558bf6341de6104dbf86733ecf7dae7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c139356adc848b9ed4bb84388bd225b19a6f7c58", "url": "https://github.com/GoogleContainerTools/jib/commit/c139356adc848b9ed4bb84388bd225b19a6f7c58", "message": "\"If the base image manifest list contains multiple images with the given architecture and os, the first image will be selected.\"", "committedDate": "2020-08-07T19:46:04Z", "type": "commit"}]}