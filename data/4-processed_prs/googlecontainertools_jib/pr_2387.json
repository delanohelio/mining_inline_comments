{"pr_number": 2387, "pr_title": "Proposal: Control the pushing of tags on existing images in target registry", "pr_createdAt": "2020-04-06T14:15:55Z", "pr_url": "https://github.com/GoogleContainerTools/jib/pull/2387", "timeline": [{"oid": "81dd88496527fe2e27ac61b55f24623d30f59177", "url": "https://github.com/GoogleContainerTools/jib/commit/81dd88496527fe2e27ac61b55f24623d30f59177", "message": "Adds proposal to control the pushing of tags on existing images in target registry.", "committedDate": "2020-04-06T14:15:00Z", "type": "commit"}, {"oid": "9eaf43bc9b05540afe487039408c0bf6a26a9a4c", "url": "https://github.com/GoogleContainerTools/jib/commit/9eaf43bc9b05540afe487039408c0bf6a26a9a4c", "message": "Updates proposal with more detail.", "committedDate": "2020-04-14T12:01:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM1MTYzNg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2387#discussion_r408351636", "bodyText": "We will have to see, but I feel like this step should return a manifest (as currently built in PushImageStep.makeList()) too, so that PushImageStep accepts the manifest. May need to create a \"struct\" class to contain manifest, imageDigest, and imageId. I think we can return imageDigest and imageId as separate fields instead of putting them into a BuildResult struct.\nBut I think these kinds of details can be sorted out when we actually work on a PR. I don't want too much bike-shedding in this proposal.", "author": "chanseokoh", "createdAt": "2020-04-14T18:35:34Z", "path": "proposals/tags-on-existing-images.md", "diffHunk": "@@ -0,0 +1,33 @@\n+# Proposal: Control the pushing of tags on existing images in target registry\n+\n+Relevant issues: [#2360](https://github.com/GoogleContainerTools/jib/issues/2360)\n+\n+## Motivation\n+Currently Jib pushes tags for all built images, irrelevant of whether the image is already \n+present on the target registry. \n+\n+As highlighted by @loosebazooka [#2360](https://github.com/GoogleContainerTools/jib/issues/2360) \n+this can be particularly annoying if some automated orchestrator is monitoring the registry\n+and releases any new tags found. This issue is especially prevalent in cases where the tags are\n+auto-generated by CI systems and added with every triggered build.\n+\n+## Proposal\n+The idea is to give the user the ability to control this functionality by means of a switch/option. \n+There might be use-cases where the current behaviour is preferable, eg, where the tags follow semantic \n+versioning, or where the tags are not automatically generated. Hence, adding a switch seems to be \n+a better solution rather than changing the current behaviour.\n+\n+## Proposed changes\n+A new system property is to be added to control this new behaviour:\n+`-Djib.skipExistingImages`\n+\n+A new step is created with the below signature:\n+`class CheckImageStep implements Callable<BuildResult>`, where its `call()` function performs a ", "originalCommit": "9eaf43bc9b05540afe487039408c0bf6a26a9a4c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM1MjYxNA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2387#discussion_r408352614", "bodyText": "I saw in your original PR you just used RegistryClient.pullManifest(). What's the reason you changed your mind to create a new ManifestChecker?", "author": "chanseokoh", "createdAt": "2020-04-14T18:37:20Z", "path": "proposals/tags-on-existing-images.md", "diffHunk": "@@ -0,0 +1,33 @@\n+# Proposal: Control the pushing of tags on existing images in target registry\n+\n+Relevant issues: [#2360](https://github.com/GoogleContainerTools/jib/issues/2360)\n+\n+## Motivation\n+Currently Jib pushes tags for all built images, irrelevant of whether the image is already \n+present on the target registry. \n+\n+As highlighted by @loosebazooka [#2360](https://github.com/GoogleContainerTools/jib/issues/2360) \n+this can be particularly annoying if some automated orchestrator is monitoring the registry\n+and releases any new tags found. This issue is especially prevalent in cases where the tags are\n+auto-generated by CI systems and added with every triggered build.\n+\n+## Proposal\n+The idea is to give the user the ability to control this functionality by means of a switch/option. \n+There might be use-cases where the current behaviour is preferable, eg, where the tags follow semantic \n+versioning, or where the tags are not automatically generated. Hence, adding a switch seems to be \n+a better solution rather than changing the current behaviour.\n+\n+## Proposed changes\n+A new system property is to be added to control this new behaviour:\n+`-Djib.skipExistingImages`\n+\n+A new step is created with the below signature:\n+`class CheckImageStep implements Callable<BuildResult>`, where its `call()` function performs a \n+call to the `RegistryClient`. This step is executed in the `StepsRunner.pushImages()` method, \n+before the `PushImageStep.makeList()` part, only if the `skipExistingImages` flag is set to true. \n+Depending on the `BuildResult` of this new step, the `PushImageStep` futures are then created (or not).\n+\n+The registry call used in `CheckImageStep` can be implemented in various ways. It is being \n+proposed that a new `checkManifest` function is added in `RegistryClient`. This should execute \n+a `ManifestChecker`, also a new class. The `ManifestChecker`'s `handleHttpResponseException` class", "originalCommit": "9eaf43bc9b05540afe487039408c0bf6a26a9a4c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM3MTc2Nw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2387#discussion_r408371767", "bodyText": "pullManifest throws an exception if the manifest does not exist. If used directly in the step, some exception handling would be needed. Anyone making the same check elsewhere would need to handle the same exception, possibly repeating code.\nThe ManifestChecker seems more inline with the current code structure, eg, checkBlob using BlobChecker. Alternatively if it seems like over engineered, the pullManifest can be used within the checkManifest in the RegistryClient, and exception handling is centralized in the RegistryClient. The latter was my original choice, however it seems much cleaner handling the exception within the handleHttpResponseException method rather than a singluar try-catch block.", "author": "karlmuscat", "createdAt": "2020-04-14T19:10:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM1MjYxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM3OTY3MQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2387#discussion_r408379671", "bodyText": "Alright, let's go with ManfiestChecker. I looked at the pullManifest code, and now I think we do need a way to distinguish \"manifest not found\" from other errors.", "author": "chanseokoh", "createdAt": "2020-04-14T19:24:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM1MjYxNA=="}], "type": "inlineReview"}]}