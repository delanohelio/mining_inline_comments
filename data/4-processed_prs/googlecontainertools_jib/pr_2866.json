{"pr_number": 2866, "pr_title": "Add option to expand wildcard in entrypoint runtime classpath", "pr_createdAt": "2020-10-26T22:23:09Z", "pr_url": "https://github.com/GoogleContainerTools/jib/pull/2866", "timeline": [{"oid": "17308cb290ba03b22106e44a12359726fe9554cd", "url": "https://github.com/GoogleContainerTools/jib/commit/17308cb290ba03b22106e44a12359726fe9554cd", "message": "Expand wildcard in entrypoint runtime classpath", "committedDate": "2020-10-26T22:20:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQzNTY3OQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2866#discussion_r512435679", "bodyText": "I realize this is a draft, but I'm not super fond of this name. I sometimes think preserveClasspathOrder is a decent name, but i'm not sure.", "author": "loosebazooka", "createdAt": "2020-10-27T06:04:56Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/global/JibSystemProperties.java", "diffHunk": "@@ -32,10 +33,12 @@\n   public static final String SEND_CREDENTIALS_OVER_HTTP = \"sendCredentialsOverHttp\";\n   public static final String SERIALIZE = \"jib.serialize\";\n \n-  private static final String DISABLE_USER_AGENT = \"_JIB_DISABLE_USER_AGENT\";\n-\n   @VisibleForTesting public static final String SKIP_EXISTING_IMAGES = \"jib.skipExistingImages\";\n \n+  @VisibleForTesting\n+  static final String USE_WILDCARD_FOR_DEPENDENCY_CLASSPATH =\n+      \"jib.useWildcardForDependencyClasspath\";", "originalCommit": "17308cb290ba03b22106e44a12359726fe9554cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjcyODk2OQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2866#discussion_r512728969", "bodyText": "Sounds good. And this made me realize that JibSystemProperties is for jib-core. The property should be in jib-plugins-common.", "author": "chanseokoh", "createdAt": "2020-10-27T14:15:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQzNTY3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjc0MTU5NA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2866#discussion_r512741594", "bodyText": "I think it's natural to negate the name, such as noClasspathOrderPreserving. The PropertyNames class only defines property names, and Boolean.getBoolean() doesn't have a way to return true as default (which I think makes sense to avoid confusion).", "author": "chanseokoh", "createdAt": "2020-10-27T14:30:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQzNTY3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjc1MDEwNg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2866#discussion_r512750106", "bodyText": "Hrmm.. maybe in that case, your naming makes more sense. useClasspathWildcard is similar but shorter?\nAlso any idea if we would include this as a config option rather than system property?", "author": "loosebazooka", "createdAt": "2020-10-27T14:40:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQzNTY3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjc1MTI1MQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2866#discussion_r512751251", "bodyText": "Actually maybe the full name is necessary", "author": "loosebazooka", "createdAt": "2020-10-27T14:41:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQzNTY3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjc5MDA4Ng==", "url": "https://github.com/GoogleContainerTools/jib/pull/2866#discussion_r512790086", "bodyText": "The idea was to have the flag as a temporary escape hatch that will go away soon once we don't get any report from the user. But I think I was too naive. Previous I speculated that we don't have to worry about the argument length limit (#2733 (comment), #2471 (comment)). However, after searching \"argument list too long\" on the Internet today, I completely lost my previous confidence. Now I think the length limit is real and this change is not safe. For example: gradle/gradle#5754.\nSo it would be safer to have this as an opt-in feature. But that's really really unfortunate, because issues from a different library order are very cryptic and difficult to identify the cause. I really wish Java 8 supported the @-argument file feature.\nAnyways, if we do this, now I think we should have it as a config option (and additionally a system property). But the question as to whether we expand it by default or not remains.\nBut ideally, for Java 9+, I think we should really use the @-argument file feature; we can always preserve the classpath order while never hitting the system argument length limit. This is going to be a lot bigger change.\nIn sum, perhaps\n\nJava 9+: always use a @-argument file. (preserveClasspathOrder is irrelevant.)\nJava <=8: expand or not based on preserveClasspathOrder. Not decisive on if it should be true by default.", "author": "chanseokoh", "createdAt": "2020-10-27T15:27:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQzNTY3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjc5Nzc0OA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2866#discussion_r512797748", "bodyText": "I think false by default works (as it is the current behavior) for java8-", "author": "loosebazooka", "createdAt": "2020-10-27T15:36:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQzNTY3OQ=="}], "type": "inlineReview"}, {"oid": "022de85cf579076c0ddcee7368cbcc7678151c16", "url": "https://github.com/GoogleContainerTools/jib/commit/022de85cf579076c0ddcee7368cbcc7678151c16", "message": "Update CHANGELOG", "committedDate": "2020-10-27T14:37:49Z", "type": "commit"}, {"oid": "86042e816b1aee259e36a6a72927b7a183dcc1d2", "url": "https://github.com/GoogleContainerTools/jib/commit/86042e816b1aee259e36a6a72927b7a183dcc1d2", "message": "Update and migrate system property", "committedDate": "2020-10-27T14:38:07Z", "type": "commit"}, {"oid": "2881777513a255e1ce29ff8892dceafcbcc2aed6", "url": "https://github.com/GoogleContainerTools/jib/commit/2881777513a255e1ce29ff8892dceafcbcc2aed6", "message": "Rename config to \"expandClasspathDependencies\" and flip default", "committedDate": "2020-11-02T16:52:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE4MTEyMg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2866#discussion_r516181122", "bodyText": "GradleProjectProperties also checks if the dependency is a jar whereas this does not. Is this intentional?", "author": "mpeddada1", "createdAt": "2020-11-02T18:41:24Z", "path": "jib-maven-plugin/src/main/java/com/google/cloud/tools/jib/maven/MavenProjectProperties.java", "diffHunk": "@@ -350,6 +350,15 @@ public JibContainerBuilder createJibContainerBuilder(\n     return new DirectoryWalker(Paths.get(project.getBuild().getOutputDirectory())).walk().asList();\n   }\n \n+  @Override\n+  public List<Path> getDependencies() {\n+    return project\n+        .getArtifacts()\n+        .stream()\n+        .map(artifact -> artifact.getFile().toPath())", "originalCommit": "2881777513a255e1ce29ff8892dceafcbcc2aed6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE4OTIzMg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2866#discussion_r516189232", "bodyText": "Good point. I am not sure if all the artifacts from project.getArtifacts() will always be .jar files, but I think usually they will be .jar files for typical Java projects.\nI've checked the MavenProjectProperties code gain, and I can tell at least that we always put all the files from project.getArtifacts() into /app/libs. (All of them are added as dependencies and only them.)\n\n  \n    \n      jib/jib-maven-plugin/src/main/java/com/google/cloud/tools/jib/maven/MavenProjectProperties.java\n    \n    \n        Lines 291 to 299\n      in\n      a720aa1\n    \n    \n    \n    \n\n        \n          \n           Map<LayerType, List<Path>> classifiedDependencies = \n        \n\n        \n          \n               classifyDependencies(project.getArtifacts(), getProjectDependencies()); \n        \n\n        \n          \n            \n        \n\n        \n          \n           javaContainerBuilder.addDependencies( \n        \n\n        \n          \n               Preconditions.checkNotNull(classifiedDependencies.get(LayerType.DEPENDENCIES))); \n        \n\n        \n          \n           javaContainerBuilder.addSnapshotDependencies( \n        \n\n        \n          \n               Preconditions.checkNotNull(classifiedDependencies.get(LayerType.SNAPSHOT_DEPENDENCIES))); \n        \n\n        \n          \n           javaContainerBuilder.addProjectDependencies( \n        \n\n        \n          \n               Preconditions.checkNotNull(classifiedDependencies.get(LayerType.PROJECT_DEPENDENCIES))); \n        \n    \n  \n\n\n(classifyDependencies(...) classifies project.getArtifacts() into project, snapshot, and third-party dependencies.)\nSo, doing this should match the actual dependencies we put.", "author": "chanseokoh", "createdAt": "2020-11-02T18:56:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE4MTEyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE5MTUwMw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2866#discussion_r516191503", "bodyText": "And for Gradle, checking .jar is a bit different behavior to obtain dependencies than we current do in GradleProjectProperties.createJibContainerBuilder(); it doesn't strictly follow the logic there. However, I think this should work.", "author": "chanseokoh", "createdAt": "2020-11-02T19:01:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE4MTEyMg=="}], "type": "inlineReview"}, {"oid": "880124d2e8331aea6ef425baf386dd5a0cdb63c6", "url": "https://github.com/GoogleContainerTools/jib/commit/880124d2e8331aea6ef425baf386dd5a0cdb63c6", "message": "Document potential failure in CHANGELOG", "committedDate": "2020-11-02T19:11:51Z", "type": "commit"}]}