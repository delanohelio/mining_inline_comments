{"pr_number": 2912, "pr_title": "Improve integration tests", "pr_createdAt": "2020-12-03T17:27:51Z", "pr_url": "https://github.com/GoogleContainerTools/jib/pull/2912", "timeline": [{"oid": "708bb2a36ca70b34a9773bcf78c6cc0ce5a76fc0", "url": "https://github.com/GoogleContainerTools/jib/commit/708bb2a36ca70b34a9773bcf78c6cc0ce5a76fc0", "message": "Improve tests", "committedDate": "2020-12-03T17:21:03Z", "type": "commit"}, {"oid": "faf3c9410dcc7ca4fe0a790be71d3018471c8abf", "url": "https://github.com/GoogleContainerTools/jib/commit/faf3c9410dcc7ca4fe0a790be71d3018471c8abf", "message": "Fix incomplete progress", "committedDate": "2020-12-03T20:33:18Z", "type": "commit"}, {"oid": "33f89dd9a2f143317b7a1fe735ab449a6534f944", "url": "https://github.com/GoogleContainerTools/jib/commit/33f89dd9a2f143317b7a1fe735ab449a6534f944", "message": "Merge branch 'master' into fix-progress-completion", "committedDate": "2020-12-03T20:37:42Z", "type": "commit"}, {"oid": "581188b3f094757dea4f92c03f3d6b21ee27784f", "url": "https://github.com/GoogleContainerTools/jib/commit/581188b3f094757dea4f92c03f3d6b21ee27784f", "message": "Merge branch 'master' into improve-integ-tests", "committedDate": "2020-12-03T20:40:05Z", "type": "commit"}, {"oid": "055bd8c71b62a8269362ad00974775e03346673e", "url": "https://github.com/GoogleContainerTools/jib/commit/055bd8c71b62a8269362ad00974775e03346673e", "message": "Merge branch 'fix-progress-completion' into improve-integ-tests", "committedDate": "2020-12-03T20:40:17Z", "type": "commit"}, {"oid": "4a2fd37648fa73af212fc59550315f231d09ff2c", "url": "https://github.com/GoogleContainerTools/jib/commit/4a2fd37648fa73af212fc59550315f231d09ff2c", "message": "Merge branch 'master' into improve-integ-tests", "committedDate": "2020-12-04T15:12:07Z", "type": "commit"}, {"oid": "34d86a5b7ae0ec24dbb6e256090f5d75e9159284", "url": "https://github.com/GoogleContainerTools/jib/commit/34d86a5b7ae0ec24dbb6e256090f5d75e9159284", "message": "cleanups", "committedDate": "2020-12-04T15:37:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODY3OTI2Mg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2912#discussion_r538679262", "bodyText": "Do we want to enable caching for the other tests as well?", "author": "mpeddada1", "createdAt": "2020-12-08T18:10:40Z", "path": "jib-core/src/integration-test/java/com/google/cloud/tools/jib/api/ContainerizerIntegrationTest.java", "diffHunk": "@@ -149,35 +149,43 @@ private static void assertLayerSize(int expected, String imageReference)\n \n   @Rule public final TemporaryFolder temporaryFolder = new TemporaryFolder();\n \n-  private final ProgressChecker progressChecker = new ProgressChecker();\n+  private ProgressChecker progressChecker = new ProgressChecker();\n \n   @Test\n   public void testSteps_forBuildToDockerRegistry()\n       throws IOException, InterruptedException, ExecutionException, RegistryException,\n-          CacheDirectoryCreationException {\n+          CacheDirectoryCreationException, InvalidImageReferenceException {\n+    System.setProperty(\"jib.alwaysCacheBaseImage\", \"true\");\n+    String imageReference = \"localhost:5000/testimage:testtag\";\n+    Path cacheDirectory = temporaryFolder.newFolder().toPath();", "originalCommit": "34d86a5b7ae0ec24dbb6e256090f5d75e9159284", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODY4ODc2Mw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2912#discussion_r538688763", "bodyText": "Or make line 157 and line 160 part of setUp()", "author": "mpeddada1", "createdAt": "2020-12-08T18:19:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODY3OTI2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc5NjcyMg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2912#discussion_r538796722", "bodyText": "Caching is always enabled. It's just that this particular test purposely gives a new empty directory to not reuse any existing cache. (The test times consecutive builds to ensure the second build runs faster due to caching from the first run.)", "author": "chanseokoh", "createdAt": "2020-12-08T20:51:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODY3OTI2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg0OTUxMw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2912#discussion_r538849513", "bodyText": "Oh gotcha, that makes a lot of sense. Thanks!", "author": "mpeddada1", "createdAt": "2020-12-08T22:17:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODY3OTI2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODY4NDE4Mw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2912#discussion_r538684183", "bodyText": "I know these methods were not introduced in this PR but since we are using a helper for the assert statements, could we make the name a bit more detailed? Something along the lines of assertThatExpectedLayerSizeReturned or assertThatExpectedDockerInspectOutputReturned.", "author": "mpeddada1", "createdAt": "2020-12-08T18:15:35Z", "path": "jib-core/src/integration-test/java/com/google/cloud/tools/jib/api/ContainerizerIntegrationTest.java", "diffHunk": "@@ -283,54 +288,38 @@ public void testBuildToDockerRegistry_dockerHubBaseImage()\n   }\n \n   @Test\n-  public void testBuildToDockerDaemon()\n+  public void testBuildToDockerDaemon_multipleTags()\n       throws IOException, InterruptedException, ExecutionException, RegistryException,\n-          CacheDirectoryCreationException {\n-    buildDockerDaemonImage(\n+          CacheDirectoryCreationException, InvalidImageReferenceException {\n+    buildImage(\n         ImageReference.of(\"gcr.io\", \"distroless/java\", DISTROLESS_DIGEST),\n-        ImageReference.of(null, \"testdocker\", null),\n-        Collections.emptyList());\n+        Containerizer.to(DockerDaemonImage.named(\"testdocker\")),\n+        Arrays.asList(\"testtag2\", \"testtag3\"));\n \n     progressChecker.checkCompletion();\n \n-    assertDockerInspect(\"testdocker\");\n     assertLayerSize(7, \"testdocker\");\n+    assertDockerInspect(\"testdocker\");", "originalCommit": "34d86a5b7ae0ec24dbb6e256090f5d75e9159284", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc5Njc0OQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2912#discussion_r538796749", "bodyText": "I wish I could, but assertDockerInspect checks a lot of image metadata, including labels, ports, environment variables, and history.", "author": "chanseokoh", "createdAt": "2020-12-08T20:51:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODY4NDE4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODY4NjcxNA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2912#discussion_r538686714", "bodyText": "Nice, I'm guessing this fixes the compatibility issue and also results in a smaller image:)", "author": "mpeddada1", "createdAt": "2020-12-08T18:18:03Z", "path": "jib-core/src/integration-test/java/com/google/cloud/tools/jib/api/ContainerizerIntegrationTest.java", "diffHunk": "@@ -271,9 +276,9 @@ public void testSteps_forBuildToDockerRegistry_skipExistingDigest()\n   public void testBuildToDockerRegistry_dockerHubBaseImage()\n       throws InvalidImageReferenceException, IOException, InterruptedException, ExecutionException,\n           RegistryException, CacheDirectoryCreationException {\n-    buildRegistryImage(\n-        ImageReference.parse(\"openjdk:8-jre-alpine\"),\n-        ImageReference.of(\"localhost:5000\", \"testimage\", \"testtag\"),\n+    buildImage(\n+        ImageReference.parse(\"openjdk:8-jre-slim\"),", "originalCommit": "34d86a5b7ae0ec24dbb6e256090f5d75e9159284", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg0MDk5NQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2912#discussion_r538840995", "bodyText": "so now we're just using the system default cache?", "author": "loosebazooka", "createdAt": "2020-12-08T22:03:02Z", "path": "jib-core/src/integration-test/java/com/google/cloud/tools/jib/api/ContainerizerIntegrationTest.java", "diffHunk": "@@ -383,10 +345,7 @@ private JibContainer buildImage(\n             .setLabels(ImmutableMap.of(\"key1\", \"value1\", \"key2\", \"value2\"))\n             .setFileEntriesLayers(fakeLayerConfigurations);\n \n-    Path cacheDirectory = temporaryFolder.newFolder().toPath();\n     containerizer", "originalCommit": "34d86a5b7ae0ec24dbb6e256090f5d75e9159284", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg0NTY0NA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2912#discussion_r538845644", "bodyText": "Yeah, the usual place for base images. I think that's fine. We've been not setting cache directories in other integration tests.", "author": "chanseokoh", "createdAt": "2020-12-08T22:11:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg0MDk5NQ=="}], "type": "inlineReview"}]}