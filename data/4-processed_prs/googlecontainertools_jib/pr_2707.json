{"pr_number": 2707, "pr_title": "Prepare JSON template classes for new manifest cache design", "pr_createdAt": "2020-08-18T15:02:40Z", "pr_url": "https://github.com/GoogleContainerTools/jib/pull/2707", "timeline": [{"oid": "595bd1962921f5b59ea5ecf1049b12a6e5610860", "url": "https://github.com/GoogleContainerTools/jib/commit/595bd1962921f5b59ea5ecf1049b12a6e5610860", "message": "Add manifest+config cache JSON template", "committedDate": "2020-08-18T14:29:48Z", "type": "commit"}, {"oid": "5e2c6bcf688b5df766f6535fd950a7655196a404", "url": "https://github.com/GoogleContainerTools/jib/commit/5e2c6bcf688b5df766f6535fd950a7655196a404", "message": "Fix tests", "committedDate": "2020-08-18T14:44:31Z", "type": "commit"}, {"oid": "a53417dd8f1fc9808d3b0edae23f2b09001582e0", "url": "https://github.com/GoogleContainerTools/jib/commit/a53417dd8f1fc9808d3b0edae23f2b09001582e0", "message": "Update code comment", "committedDate": "2020-08-18T17:36:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ4OTg2Ng==", "url": "https://github.com/GoogleContainerTools/jib/pull/2707#discussion_r473489866", "bodyText": "Do we need to persist a V21 manifest? Don't we do conversions of this to V22?", "author": "loosebazooka", "createdAt": "2020-08-20T00:56:16Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/image/json/ManifestAndConfigTemplate.java", "diffHunk": "@@ -16,16 +16,32 @@\n \n package com.google.cloud.tools.jib.image.json;\n \n-import java.util.Optional;\n+import com.fasterxml.jackson.annotation.JsonSubTypes;\n+import com.fasterxml.jackson.annotation.JsonTypeInfo;\n+import com.google.cloud.tools.jib.json.JsonTemplate;\n import javax.annotation.Nullable;\n \n /** Stores a manifest and container config. */\n-public class ManifestAndConfig {\n+public class ManifestAndConfigTemplate implements JsonTemplate {\n \n-  private final ManifestTemplate manifest;\n-  @Nullable private final ContainerConfigurationTemplate config;\n+  @JsonTypeInfo(\n+      use = JsonTypeInfo.Id.CLASS,\n+      include = JsonTypeInfo.As.PROPERTY,\n+      property = \"@class\")\n+  @JsonSubTypes({\n+    @JsonSubTypes.Type(value = OciManifestTemplate.class),\n+    @JsonSubTypes.Type(value = V21ManifestTemplate.class),", "originalCommit": "a53417dd8f1fc9808d3b0edae23f2b09001582e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzk4NDAwNQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2707#discussion_r473984005", "bodyText": "We don't actually do a JSON-to-JSON conversion. We are currently persisting V21ManifestTemplate in the cache.\nIt's just that we can properly instantiate a Java Image instance from both V21 and V22.", "author": "chanseokoh", "createdAt": "2020-08-20T13:39:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ4OTg2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ5OTM0OA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2707#discussion_r473499348", "bodyText": "It seems strange that we would generate a JsonTemplate type from separately parsed out jsonTemplates? Is this something that we would need to change eventually?\nCan we go directly to ManifestAndConfigTemplate directly from file?", "author": "loosebazooka", "createdAt": "2020-08-20T01:10:55Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/cache/CacheStorageReader.java", "diffHunk": "@@ -110,7 +110,7 @@\n \n       if (schemaVersion == 1) {\n         return Optional.of(\n-            new ManifestAndConfig(\n+            new ManifestAndConfigTemplate(", "originalCommit": "a53417dd8f1fc9808d3b0edae23f2b09001582e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzk4NzA3NQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2707#discussion_r473987075", "bodyText": "In the next PR, all of these parsing and conversion operations will be gone, and this retrieveMetadata() will directly de-serialize and return ImageMetadataTemplate without any processing.", "author": "chanseokoh", "createdAt": "2020-08-20T13:42:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ5OTM0OA=="}], "type": "inlineReview"}]}