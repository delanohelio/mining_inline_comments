{"pr_number": 2833, "pr_title": "Create symlinks for symlink entries in tar when extracting", "pr_createdAt": "2020-10-16T19:33:01Z", "pr_url": "https://github.com/GoogleContainerTools/jib/pull/2833", "timeline": [{"oid": "5a6418664b705c60bc6b42aa2af29efc992e1e06", "url": "https://github.com/GoogleContainerTools/jib/commit/5a6418664b705c60bc6b42aa2af29efc992e1e06", "message": "Create symlinks for symlink entries in tar", "committedDate": "2020-10-16T19:28:45Z", "type": "commit"}, {"oid": "6bc161fe94a489c03da785152c386a5c7a94ae83", "url": "https://github.com/GoogleContainerTools/jib/commit/6bc161fe94a489c03da785152c386a5c7a94ae83", "message": "CHANGELOG", "committedDate": "2020-10-16T19:37:46Z", "type": "commit"}, {"oid": "6ea39542ac70b41d2f1775d3d4667b1c2f0bb75a", "url": "https://github.com/GoogleContainerTools/jib/commit/6ea39542ac70b41d2f1775d3d4667b1c2f0bb75a", "message": "Merge branch 'master' into i2829-tar-extract-symlinks", "committedDate": "2020-10-16T20:45:39Z", "type": "commit"}, {"oid": "d1c677a491fbfd8039038f15d76e46c9b7c0800d", "url": "https://github.com/GoogleContainerTools/jib/commit/d1c677a491fbfd8039038f15d76e46c9b7c0800d", "message": "Update test", "committedDate": "2020-10-16T21:17:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjczMTU0Nw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2833#discussion_r506731547", "bodyText": "Does this mean if the same layer is being cached twice?", "author": "mpeddada1", "createdAt": "2020-10-16T21:35:12Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/cache/CacheStorageWriter.java", "diffHunk": "@@ -120,8 +120,8 @@ private static void moveIfDoesNotExist(Path source, Path destination) throws IOE\n                 () -> {\n                   if (Files.exists(destination)) {\n                     // If the file already exists, we skip renaming and use the existing file.\n-                    // This happens if a new layer happens to have the same content as a\n-                    // previously-cached layer.\n+                    // This happens, e.g., if a new layer happens to have the same content as a\n+                    // previously-cached layer or the same layer is being cached concurrently.", "originalCommit": "d1c677a491fbfd8039038f15d76e46c9b7c0800d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjczNTE0Ng==", "url": "https://github.com/GoogleContainerTools/jib/pull/2833#discussion_r506735146", "bodyText": "Yes. To be strict, multiple threads may be attempting to cache the same layer more than once (whether almost at the same time or apart). They will all write files at their own temporary location. In the end, all of them will try to rename the temp directory to the final one, which is unique. Then, only one rename will succeed, and other will see that the directory already exists.", "author": "chanseokoh", "createdAt": "2020-10-16T21:46:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjczMTU0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjczNDA2Mw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2833#discussion_r506734063", "bodyText": "Can we use entry.isSymbolicLink?", "author": "loosebazooka", "createdAt": "2020-10-16T21:42:53Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/tar/TarExtractor.java", "diffHunk": "@@ -61,8 +63,14 @@ public static void extract(Path source, Path destination) throws IOException {\n           if (entryPath.getParent() != null) {\n             Files.createDirectories(entryPath.getParent());\n           }\n-          try (OutputStream out = new BufferedOutputStream(Files.newOutputStream(entryPath))) {\n-            ByteStreams.copy(tarArchiveInputStream, out);\n+\n+          String linkName = entry.getLinkName();", "originalCommit": "d1c677a491fbfd8039038f15d76e46c9b7c0800d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjczNjk1Nw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2833#discussion_r506736957", "bodyText": "Oh, absolutely. Nice catch.", "author": "chanseokoh", "createdAt": "2020-10-16T21:52:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjczNDA2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjczNDMzMQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2833#discussion_r506734331", "bodyText": "So what happens when we then process this layer? Do we lose this symlink?", "author": "loosebazooka", "createdAt": "2020-10-16T21:43:49Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/tar/TarExtractor.java", "diffHunk": "@@ -61,8 +63,14 @@ public static void extract(Path source, Path destination) throws IOException {\n           if (entryPath.getParent() != null) {\n             Files.createDirectories(entryPath.getParent());\n           }\n-          try (OutputStream out = new BufferedOutputStream(Files.newOutputStream(entryPath))) {\n-            ByteStreams.copy(tarArchiveInputStream, out);\n+\n+          String linkName = entry.getLinkName();\n+          if (!Strings.isNullOrEmpty(linkName)) {\n+            Files.createSymbolicLink(entryPath, Paths.get(linkName));", "originalCommit": "d1c677a491fbfd8039038f15d76e46c9b7c0800d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjczNjk0OQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2833#discussion_r506736949", "bodyText": "The .extract() method is only used when using a local tar or Docker daemon base image. It's to explode the contents of docker save or a local tar image. Then we'll read layer tarballs from the exploded directory to cache them in our base image cache. And we'll see a symlink only when there are duplicate layers. I learned that when our code reads through a symlink, it actually reads the original file. It's not possible that you open and read \"something\" out of the symlink itself.", "author": "chanseokoh", "createdAt": "2020-10-16T21:52:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjczNDMzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc3NzU1Mw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2833#discussion_r506777553", "bodyText": "Ah right, so we only see symlinks to the layer tar (but we never expand out those layer tars).", "author": "loosebazooka", "createdAt": "2020-10-17T01:20:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjczNDMzMQ=="}], "type": "inlineReview"}, {"oid": "7d734a6be68145de716fb23f0ef940e10b854426", "url": "https://github.com/GoogleContainerTools/jib/commit/7d734a6be68145de716fb23f0ef940e10b854426", "message": "Use entry.isSymbolicLink", "committedDate": "2020-10-16T21:52:13Z", "type": "commit"}]}