{"pr_number": 2914, "pr_title": "Fix incomplete progress dispatching in PullBaseImageStep", "pr_createdAt": "2020-12-03T20:36:30Z", "pr_url": "https://github.com/GoogleContainerTools/jib/pull/2914", "timeline": [{"oid": "faf3c9410dcc7ca4fe0a790be71d3018471c8abf", "url": "https://github.com/GoogleContainerTools/jib/commit/faf3c9410dcc7ca4fe0a790be71d3018471c8abf", "message": "Fix incomplete progress", "committedDate": "2020-12-03T20:33:18Z", "type": "commit"}, {"oid": "33f89dd9a2f143317b7a1fe735ab449a6534f944", "url": "https://github.com/GoogleContainerTools/jib/commit/33f89dd9a2f143317b7a1fe735ab449a6534f944", "message": "Merge branch 'master' into fix-progress-completion", "committedDate": "2020-12-03T20:37:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU4NDM2OA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2914#discussion_r535584368", "bodyText": "BTW, looks like the current allocation units (2) isn't correct, but I'm not addressing this here.", "author": "chanseokoh", "createdAt": "2020-12-03T20:39:46Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/PullBaseImageStep.java", "diffHunk": "@@ -95,47 +95,48 @@ public ImagesAndRegistryClient call()\n           LayerCountMismatchException, BadContainerConfigurationFormatException,\n           CacheCorruptedException, CredentialRetrievalException {\n     EventHandlers eventHandlers = buildContext.getEventHandlers();\n-    // Skip this step if this is a scratch image\n-    ImageReference imageReference = buildContext.getBaseImageConfiguration().getImage();\n-    if (imageReference.isScratch()) {\n-      Set<Platform> platforms = buildContext.getContainerConfiguration().getPlatforms();\n-      Verify.verify(!platforms.isEmpty());\n-\n-      eventHandlers.dispatch(LogEvent.progress(\"Getting scratch base image...\"));\n-      ImmutableList.Builder<Image> images = ImmutableList.builder();\n-      for (Platform platform : platforms) {\n-        Image.Builder imageBuilder = Image.builder(buildContext.getTargetFormat());\n-        imageBuilder.setArchitecture(platform.getArchitecture()).setOs(platform.getOs());\n-        images.add(imageBuilder.build());\n+    try (ProgressEventDispatcher progressEventDispatcher =\n+            progressEventDispatcherFactory.create(\"pulling base image manifest\", 2);", "originalCommit": "33f89dd9a2f143317b7a1fe735ab449a6534f944", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTczMzM2Mw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2914#discussion_r535733363", "bodyText": "minor formatting: need to move line 136 up.", "author": "mpeddada1", "createdAt": "2020-12-03T23:55:21Z", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/PullBaseImageStep.java", "diffHunk": "@@ -95,47 +95,48 @@ public ImagesAndRegistryClient call()\n           LayerCountMismatchException, BadContainerConfigurationFormatException,\n           CacheCorruptedException, CredentialRetrievalException {\n     EventHandlers eventHandlers = buildContext.getEventHandlers();\n-    // Skip this step if this is a scratch image\n-    ImageReference imageReference = buildContext.getBaseImageConfiguration().getImage();\n-    if (imageReference.isScratch()) {\n-      Set<Platform> platforms = buildContext.getContainerConfiguration().getPlatforms();\n-      Verify.verify(!platforms.isEmpty());\n-\n-      eventHandlers.dispatch(LogEvent.progress(\"Getting scratch base image...\"));\n-      ImmutableList.Builder<Image> images = ImmutableList.builder();\n-      for (Platform platform : platforms) {\n-        Image.Builder imageBuilder = Image.builder(buildContext.getTargetFormat());\n-        imageBuilder.setArchitecture(platform.getArchitecture()).setOs(platform.getOs());\n-        images.add(imageBuilder.build());\n+    try (ProgressEventDispatcher progressEventDispatcher =\n+            progressEventDispatcherFactory.create(\"pulling base image manifest\", 2);\n+        TimerEventDispatcher ignored1 = new TimerEventDispatcher(eventHandlers, DESCRIPTION)) {\n+\n+      // Skip this step if this is a scratch image\n+      ImageReference imageReference = buildContext.getBaseImageConfiguration().getImage();\n+      if (imageReference.isScratch()) {\n+        Set<Platform> platforms = buildContext.getContainerConfiguration().getPlatforms();\n+        Verify.verify(!platforms.isEmpty());\n+\n+        eventHandlers.dispatch(LogEvent.progress(\"Getting scratch base image...\"));\n+        ImmutableList.Builder<Image> images = ImmutableList.builder();\n+        for (Platform platform : platforms) {\n+          Image.Builder imageBuilder = Image.builder(buildContext.getTargetFormat());\n+          imageBuilder.setArchitecture(platform.getArchitecture()).setOs(platform.getOs());\n+          images.add(imageBuilder.build());\n+        }\n+        return new ImagesAndRegistryClient(images.build(), null);\n       }\n-      return new ImagesAndRegistryClient(images.build(), null);\n-    }\n \n-    eventHandlers.dispatch(\n-        LogEvent.progress(\"Getting manifest for base image \" + imageReference + \"...\"));\n+      eventHandlers.dispatch(\n+          LogEvent.progress(\"Getting manifest for base image \" + imageReference + \"...\"));\n \n-    if (buildContext.isOffline()) {\n-      List<Image> images = getCachedBaseImages();\n-      if (!images.isEmpty()) {\n-        return new ImagesAndRegistryClient(images, null);\n-      }\n-      throw new IOException(\n-          \"Cannot run Jib in offline mode; \" + imageReference + \" not found in local Jib cache\");\n-\n-    } else if (imageReference.getDigest().isPresent()) {\n-      List<Image> images = getCachedBaseImages();\n-      if (!images.isEmpty()) {\n-        RegistryClient noAuthRegistryClient =\n-            buildContext.newBaseImageRegistryClientFactory().newRegistryClient();\n-        // TODO: passing noAuthRegistryClient may be problematic. It may return 401 unauthorized if\n-        // layers have to be downloaded. https://github.com/GoogleContainerTools/jib/issues/2220\n-        return new ImagesAndRegistryClient(images, noAuthRegistryClient);\n+      if (buildContext.isOffline()) {\n+        List<Image> images = getCachedBaseImages();\n+        if (!images.isEmpty()) {\n+          return new ImagesAndRegistryClient(images, null);\n+        }\n+        throw new IOException(\n+            \"Cannot run Jib in offline mode; \" + imageReference + \" not found in local Jib cache\");\n+\n+      } else if (imageReference.getDigest().isPresent()) {\n+        List<Image> images = getCachedBaseImages();\n+        if (!images.isEmpty()) {\n+          RegistryClient noAuthRegistryClient =\n+              buildContext.newBaseImageRegistryClientFactory().newRegistryClient();\n+          // TODO: passing noAuthRegistryClient may be problematic. It may return 401 unauthorized\n+          // if\n+          // layers have to be downloaded. https://github.com/GoogleContainerTools/jib/issues/2220", "originalCommit": "33f89dd9a2f143317b7a1fe735ab449a6534f944", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc3ODA5Mw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2914#discussion_r535778093", "bodyText": "Done. The auto-formatter puts the link on the third line though.", "author": "chanseokoh", "createdAt": "2020-12-04T01:55:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTczMzM2Mw=="}], "type": "inlineReview"}, {"oid": "5618e9b9208268503bdb75614512c9ddf7db93dc", "url": "https://github.com/GoogleContainerTools/jib/commit/5618e9b9208268503bdb75614512c9ddf7db93dc", "message": "Format comment", "committedDate": "2020-12-04T01:53:20Z", "type": "commit"}]}