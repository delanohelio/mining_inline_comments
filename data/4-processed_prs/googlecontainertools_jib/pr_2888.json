{"pr_number": 2888, "pr_title": "Implement packaged mode for standard jar.", "pr_createdAt": "2020-11-09T15:11:12Z", "pr_url": "https://github.com/GoogleContainerTools/jib/pull/2888", "timeline": [{"oid": "80123dc8587545d350f7ee041ba227761d9f6a1a", "url": "https://github.com/GoogleContainerTools/jib/commit/80123dc8587545d350f7ee041ba227761d9f6a1a", "message": "Add integration testing for jib cli jar command", "committedDate": "2020-11-05T16:53:53Z", "type": "commit"}, {"oid": "f4ebcb7466c8acf24fa1f1394fe1e253200e032a", "url": "https://github.com/GoogleContainerTools/jib/commit/f4ebcb7466c8acf24fa1f1394fe1e253200e032a", "message": "formatting and call method to terminate executor service", "committedDate": "2020-11-05T19:07:46Z", "type": "commit"}, {"oid": "2a71454d49f07524c5fb6d03567f992ad602b96c", "url": "https://github.com/GoogleContainerTools/jib/commit/2a71454d49f07524c5fb6d03567f992ad602b96c", "message": "modify javadoc", "committedDate": "2020-11-05T19:20:09Z", "type": "commit"}, {"oid": "d0c3c361f4dba7d91de5581f459562878cbe1b0e", "url": "https://github.com/GoogleContainerTools/jib/commit/d0c3c361f4dba7d91de5581f459562878cbe1b0e", "message": "modify test", "committedDate": "2020-11-05T19:22:46Z", "type": "commit"}, {"oid": "2bb2202235832c9772975c822a83bb6063ac354b", "url": "https://github.com/GoogleContainerTools/jib/commit/2bb2202235832c9772975c822a83bb6063ac354b", "message": "renaming variable in test", "committedDate": "2020-11-05T20:59:02Z", "type": "commit"}, {"oid": "ac17e8f382f51ca65f3aa0860b23d94621969497", "url": "https://github.com/GoogleContainerTools/jib/commit/ac17e8f382f51ca65f3aa0860b23d94621969497", "message": "Merge branch 'master' of github.com:GoogleContainerTools/jib into jar-integration-test", "committedDate": "2020-11-06T02:02:00Z", "type": "commit"}, {"oid": "a102c1db8902da4d709f6604c7068a95c631fb7f", "url": "https://github.com/GoogleContainerTools/jib/commit/a102c1db8902da4d709f6604c7068a95c631fb7f", "message": "packaged mode", "committedDate": "2020-11-06T02:06:49Z", "type": "commit"}, {"oid": "cd2ac6a7e17bd2fb6c50ebcdf5f77a01edb1f940", "url": "https://github.com/GoogleContainerTools/jib/commit/cd2ac6a7e17bd2fb6c50ebcdf5f77a01edb1f940", "message": "make tests use PrintWriter", "committedDate": "2020-11-06T23:28:01Z", "type": "commit"}, {"oid": "1a3048a995d5b07c813cdc36ae1a49c19f1e0976", "url": "https://github.com/GoogleContainerTools/jib/commit/1a3048a995d5b07c813cdc36ae1a49c19f1e0976", "message": "Add packaged mode for standard jar", "committedDate": "2020-11-09T14:56:38Z", "type": "commit"}, {"oid": "69b83434a9e2ac7bf056d0b894ad4872f22cead0", "url": "https://github.com/GoogleContainerTools/jib/commit/69b83434a9e2ac7bf056d0b894ad4872f22cead0", "message": "fixing method name and commenting", "committedDate": "2020-11-09T15:03:15Z", "type": "commit"}, {"oid": "8636a53246532d266a759cfebeaf90483ae1afe3", "url": "https://github.com/GoogleContainerTools/jib/commit/8636a53246532d266a759cfebeaf90483ae1afe3", "message": "Merge branch 'jar-integration-test' of github.com:GoogleContainerTools/jib into packaged-mode-jar", "committedDate": "2020-11-09T15:12:42Z", "type": "commit"}, {"oid": "bd02ab2d1252337fc1e7cee5f19b8f07f3bd71f7", "url": "https://github.com/GoogleContainerTools/jib/commit/bd02ab2d1252337fc1e7cee5f19b8f07f3bd71f7", "message": "cleanup", "committedDate": "2020-11-09T16:32:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTkzNDI3Mw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2888#discussion_r519934273", "bodyText": "I think this will be what the user will see on the command-line with the help usage. Should include what values are available.\nThat said, take a look at the --vebosity and --console options.\n  @Option(\n      names = \"--verbosity\",\n      paramLabel = \"<level>\",\n      defaultValue = \"lifecycle\",\n      description =\n          \"set logging verbosity, candidates: ${COMPLETION-CANDIDATES}, default: ${DEFAULT-VALUE}\")\n  @SuppressWarnings(\"NullAway.Init\") // initialized by picocli\n  private Verbosity verbosity;\n\n  @Option(\n      names = \"--console\",\n      paramLabel = \"<type>\",\n      defaultValue = \"auto\",\n      description =\n          \"set console output type, candidates: ${COMPLETION-CANDIDATES}, default: ${DEFAULT-VALUE}\")\n  @SuppressWarnings(\"NullAway.Init\") // initialized by picocli\n  private ConsoleOutput consoleOutput;", "author": "chanseokoh", "createdAt": "2020-11-09T16:14:53Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/cli2/Jar.java", "diffHunk": "@@ -43,6 +44,14 @@\n   @SuppressWarnings(\"NullAway.Init\") // initialized by picocli\n   private Path jarFile;\n \n+  @CommandLine.Option(\n+      names = \"--mode\",\n+      defaultValue = \"exploded\",\n+      paramLabel = \"<mode>\",\n+      description = \"The processing mode\")", "originalCommit": "8636a53246532d266a759cfebeaf90483ae1afe3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk0Mjc0MQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2888#discussion_r519942741", "bodyText": "I missed this. jib jar will fail if running from a different directory (e.g., jib ... jar ../my.jar). Perhaps the first argument to addEntry should be jarPath.resolve(path)?", "author": "chanseokoh", "createdAt": "2020-11-09T16:26:22Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/jar/JarModeProcessor.java", "diffHunk": "@@ -191,4 +208,47 @@ private static FileEntriesLayer addDirectoryContentsToLayer(\n             });\n     return builder.build();\n   }\n+\n+  private static List<FileEntriesLayer> getDependenciesLayers(Path jarPath) throws IOException {\n+    List<FileEntriesLayer> layers = new ArrayList<>();\n+    String classPath = null;\n+\n+    // Get dependencies from Class-Path in the jar's manifest and add a layer each for non-snapshot\n+    // and snapshot dependencies. If Class-Path is not present in the jar's manifest then skip\n+    // adding the dependencies layers.\n+    try (JarFile jarFile = new JarFile(jarPath.toFile())) {\n+      classPath = jarFile.getManifest().getMainAttributes().getValue(Attributes.Name.CLASS_PATH);\n+    }\n+    if (classPath != null) {\n+      Predicate<String> isSnapshot = name -> name.contains(\"SNAPSHOT\");\n+      List<String> allDependencies = Splitter.onPattern(\"\\\\s+\").splitToList(classPath.trim());\n+      List<Path> nonSnapshotDependencies =\n+          allDependencies\n+              .stream()\n+              .filter(isSnapshot.negate())\n+              .map(Paths::get)\n+              .collect(Collectors.toList());\n+      List<Path> snapshotDependencies =\n+          allDependencies.stream().filter(isSnapshot).map(Paths::get).collect(Collectors.toList());\n+      if (!nonSnapshotDependencies.isEmpty()) {\n+        FileEntriesLayer.Builder nonSnapshotDependenciesLayerBuilder =\n+            FileEntriesLayer.builder().setName(DEPENDENCIES);\n+        nonSnapshotDependencies.forEach(\n+            path ->\n+                nonSnapshotDependenciesLayerBuilder.addEntry(\n+                    path, APP_ROOT.resolve(RelativeUnixPath.get(\"dependencies\")).resolve(path)));", "originalCommit": "8636a53246532d266a759cfebeaf90483ae1afe3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4ODI3NA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2888#discussion_r520188274", "bodyText": "Ah great catch. Could you give me an example for this scenario? Not sure if I fully understand how it will fail if the command is run from a different directory.", "author": "mpeddada1", "createdAt": "2020-11-09T23:33:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk0Mjc0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI1NTY2Mg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2888#discussion_r520255662", "bodyText": "I actually tried this. The command works at ~/A but fails at ~ in the following example where C.jar is using the guava dependency.\n~/A$ pwd\n/home/chanseok/A\n~/A$ ls C.jar guava-20.0.jar \nC.jar  guava-20.0.jar\n~/A$ jib --target=docker://foo jar C.jar\n[WARN] Base image 'gcr.io/distroless/java' does not use a specific image digest - build may not be reproducible\nUsing base image with digest: sha256:90596f62a8ec0701d00845b85dfccf7f53b5e0bb3c49e275d7f19ea6c3e4565d\n\nContainer entrypoint set to [java, -cp, /app/explodedJar:/app/dependencies/*, C]\nExecuting tasks:\n[==============================] 100.0% complete\n\n~/A$ cd ..\n~$ jib --target=docker://foo jar A/C.jar\n[WARN] Base image 'gcr.io/distroless/java' does not use a specific image digest - build may not be reproducible\nUsing base image with digest: sha256:90596f62a8ec0701d00845b85dfccf7f53b5e0bb3c49e275d7f19ea6c3e4565d\nExecuting tasks:\n[==================            ] 60.0% complete\n> scheduling building manifests\n\njava.nio.file.NoSuchFileException: guava-20.0.jar\n\nAnd yeah, perhaps the source path should be something like jarPath.getParent().resolve(path)?", "author": "chanseokoh", "createdAt": "2020-11-10T03:00:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk0Mjc0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY3Njc2OA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2888#discussion_r520676768", "bodyText": "Just tried this out - I see what you mean. Thank you!", "author": "mpeddada1", "createdAt": "2020-11-10T16:00:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk0Mjc0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk0NjcxMA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2888#discussion_r519946710", "bodyText": "In this case, I think it's fine to have\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                layers.addAll(getDependenciesLayers(jarPath));\n          \n          \n            \n                List<FileEntriesLayer> layers = getDependenciesLayers(jarPath);", "author": "chanseokoh", "createdAt": "2020-11-09T16:31:50Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/jar/JarModeProcessor.java", "diffHunk": "@@ -86,47 +87,13 @@ static JarType determineJarType(Path jarPath) throws IOException {\n    */\n   static List<FileEntriesLayer> createExplodedModeLayersForStandardJar(\n       Path jarPath, Path tempDirPath) throws IOException {\n-    Path localExplodedJarRoot = tempDirPath;\n-    ZipUtil.unzip(jarPath, localExplodedJarRoot);\n     List<FileEntriesLayer> layers = new ArrayList<>();\n \n-    // Get dependencies from Class-Path in the jar's manifest and add a layer each for non-snapshot\n-    // and snapshot dependencies. If Class-Path is not present in the jar's manifest then skip\n-    // adding the dependencies layers.\n-    String classPath = null;\n-    try (JarFile jarFile = new JarFile(jarPath.toFile())) {\n-      classPath = jarFile.getManifest().getMainAttributes().getValue(Attributes.Name.CLASS_PATH);\n-    }\n-    if (classPath != null) {\n-      Predicate<String> isSnapshot = name -> name.contains(\"SNAPSHOT\");\n-      List<String> allDependencies = Splitter.onPattern(\"\\\\s+\").splitToList(classPath.trim());\n-      List<Path> nonSnapshotDependencies =\n-          allDependencies\n-              .stream()\n-              .filter(isSnapshot.negate())\n-              .map(Paths::get)\n-              .collect(Collectors.toList());\n-      List<Path> snapshotDependencies =\n-          allDependencies.stream().filter(isSnapshot).map(Paths::get).collect(Collectors.toList());\n-      if (!nonSnapshotDependencies.isEmpty()) {\n-        FileEntriesLayer.Builder nonSnapshotDependenciesLayerBuilder =\n-            FileEntriesLayer.builder().setName(DEPENDENCIES);\n-        nonSnapshotDependencies.forEach(\n-            path ->\n-                nonSnapshotDependenciesLayerBuilder.addEntry(\n-                    path, APP_ROOT.resolve(RelativeUnixPath.get(\"dependencies\")).resolve(path)));\n-        layers.add(nonSnapshotDependenciesLayerBuilder.build());\n-      }\n-      if (!snapshotDependencies.isEmpty()) {\n-        FileEntriesLayer.Builder snapshotDependenciesLayerBuilder =\n-            FileEntriesLayer.builder().setName(SNAPSHOT_DEPENDENCIES);\n-        snapshotDependencies.forEach(\n-            path ->\n-                snapshotDependenciesLayerBuilder.addEntry(\n-                    path, APP_ROOT.resolve(RelativeUnixPath.get(\"dependencies\")).resolve(path)));\n-        layers.add(snapshotDependenciesLayerBuilder.build());\n-      }\n-    }\n+    // Add dependencies layers.\n+    layers.addAll(getDependenciesLayers(jarPath));", "originalCommit": "8636a53246532d266a759cfebeaf90483ae1afe3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk1MDQ2Nw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2888#discussion_r519950467", "bodyText": "Not that I care, but just FYI, this doc stylizes the archive as \"JAR.\" It stands for \"Java\u2122 Archive (JAR)\" files.", "author": "chanseokoh", "createdAt": "2020-11-09T16:37:14Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/jar/JarModeProcessor.java", "diffHunk": "@@ -173,6 +168,28 @@ static JarType determineJarType(Path jarPath) throws IOException {\n     }\n   }\n \n+  /**\n+   * Computes the entrypoint for a standard jar in packaged mode.\n+   *\n+   * @param jarPath path to jar file\n+   * @return list of {@link String} representing entrypoint\n+   * @throws IOException if I/O error occurs when opening the jar file\n+   */\n+  static ImmutableList<String> computeEntrypointForPackagedStandard(Path jarPath)\n+      throws IOException {\n+    try (JarFile jarFile = new JarFile(jarPath.toFile())) {\n+      String mainClass =\n+          jarFile.getManifest().getMainAttributes().getValue(Attributes.Name.MAIN_CLASS);\n+      if (mainClass == null) {\n+        throw new IllegalArgumentException(\n+            \"`Main-Class:` attribute for an application main class not defined in the input Jar's \"", "originalCommit": "8636a53246532d266a759cfebeaf90483ae1afe3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY4MjEyNA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2888#discussion_r520682124", "bodyText": "Oh nice, I will follow the convention in that case.", "author": "mpeddada1", "createdAt": "2020-11-10T16:07:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk1MDQ2Nw=="}], "type": "inlineReview"}, {"oid": "df578e761a9e76f9a25f3b38d275b6e1bb1dbca5", "url": "https://github.com/GoogleContainerTools/jib/commit/df578e761a9e76f9a25f3b38d275b6e1bb1dbca5", "message": "fix test to use root directory instead of empty directory", "committedDate": "2020-11-09T22:40:40Z", "type": "commit"}, {"oid": "0d9f5b77abc755c70d821fa4fe3a2d1f6101c604", "url": "https://github.com/GoogleContainerTools/jib/commit/0d9f5b77abc755c70d821fa4fe3a2d1f6101c604", "message": "Merge branch 'jar-integration-test' of github.com:GoogleContainerTools/jib into packaged-mode-jar", "committedDate": "2020-11-09T23:03:13Z", "type": "commit"}, {"oid": "686efa79697e803eea5014008d8e37eb87f49f73", "url": "https://github.com/GoogleContainerTools/jib/commit/686efa79697e803eea5014008d8e37eb87f49f73", "message": "refactoring and fix dependency addition", "committedDate": "2020-11-10T15:54:21Z", "type": "commit"}, {"oid": "f40557d0083ee34e15d3035b58748737cfeadf63", "url": "https://github.com/GoogleContainerTools/jib/commit/f40557d0083ee34e15d3035b58748737cfeadf63", "message": "use JAR instead of jar", "committedDate": "2020-11-10T15:59:54Z", "type": "commit"}, {"oid": "3c07e34bd88793fe56b4bac0b5f1e3b6f6033515", "url": "https://github.com/GoogleContainerTools/jib/commit/3c07e34bd88793fe56b4bac0b5f1e3b6f6033515", "message": "pull in changes in master", "committedDate": "2020-11-10T16:27:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgyNTQ3Ng==", "url": "https://github.com/GoogleContainerTools/jib/pull/2888#discussion_r520825476", "bodyText": "Remove all these @Ignores.", "author": "chanseokoh", "createdAt": "2020-11-10T19:37:13Z", "path": "jib-cli/src/test/java/com/google/cloud/tools/jib/cli/jar/JarFilesTest.java", "diffHunk": "@@ -43,11 +44,13 @@\n   @Rule public final TemporaryFolder temporaryFolder = new TemporaryFolder();\n \n   @Test\n-  public void testToJibContainerBuilder_basicInfo()\n+  @Ignore", "originalCommit": "3c07e34bd88793fe56b4bac0b5f1e3b6f6033515", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg0ODAyMw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2888#discussion_r520848023", "bodyText": "Oh, I remember we decided to do java -jar. In that case, we should retain the directory structure for the dependencies given in Class-Path: in MANIFEST.MF.", "author": "chanseokoh", "createdAt": "2020-11-10T20:16:59Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/jar/JarModeProcessor.java", "diffHunk": "@@ -151,6 +116,32 @@ static JarType determineJarType(Path jarPath) throws IOException {\n     return layers;\n   }\n \n+  /**\n+   * Creates layers for dependencies, snapshot dependencies and the jar itself on container for a\n+   * standard jar.\n+   *\n+   * @param jarPath path to jar file\n+   * @return list of {@link FileEntriesLayer}\n+   * @throws IOException if I/O error occurs when opening the jar file\n+   */\n+  static List<FileEntriesLayer> createPackagedModeLayersForStandardJar(Path jarPath)\n+      throws IOException {\n+    // Add dependencies layers.\n+    List<FileEntriesLayer> layers = getDependenciesLayers(jarPath);\n+\n+    // Add layer for jar.\n+    FileEntriesLayer jarLayer =\n+        FileEntriesLayer.builder()\n+            .setName(JAR)\n+            .addEntry(\n+                jarPath,\n+                APP_ROOT.resolve(RelativeUnixPath.get(\"jar\")).resolve(jarPath.getFileName()))", "originalCommit": "3c07e34bd88793fe56b4bac0b5f1e3b6f6033515", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg4ODQ4Mw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2888#discussion_r520888483", "bodyText": "Actually, I do believe the dependency directory structure will be retained under /app/dependencies. But for the java -jar to work, the easiest solution is to put the main JAR under /app/dependencies. But then, the directory name /app/dependencies doesn't make much sense. Maybe we should place the main JAR and other dependency JARs (while retaining the directory structure) at /app?\nThat said, it's worth having a test that has Class-Path:, e.g., Class-Path: foo.jar nested/bar.jar.", "author": "chanseokoh", "createdAt": "2020-11-10T21:35:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg0ODAyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg4Njc0MA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2888#discussion_r520886740", "bodyText": "Why not creating a dedicated type and have the descriptions like other options?\n\"set console output type, candidates: ${COMPLETION-CANDIDATES}, default: ${DEFAULT-VALUE}\")\n\nI think it will take care of validation for us too.", "author": "chanseokoh", "createdAt": "2020-11-10T21:31:57Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/cli2/Jar.java", "diffHunk": "@@ -44,6 +44,14 @@\n   @SuppressWarnings(\"NullAway.Init\") // initialized by picocli\n   private Path jarFile;\n \n+  @CommandLine.Option(\n+      names = \"--mode\",\n+      defaultValue = \"exploded\",\n+      paramLabel = \"<mode>\",\n+      description = \"The jar processing mode, candidates: packaged, default: exploded\")", "originalCommit": "3c07e34bd88793fe56b4bac0b5f1e3b6f6033515", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkwMDQ1Mg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2888#discussion_r520900452", "bodyText": "I just tried my C.jar example, but it throws an NPE. In this case, jarPath is simply C.jar (not an absolute path) and jarPath.getParent() returns null.\n~/A$ jib --target=docker://foo --stacktrace jar C.jar\njava.lang.NullPointerException\n        at com.google.cloud.tools.jib.cli.jar.JarModeProcessor.lambda$getDependenciesLayers$6(JarModeProcessor.java:236)\n        at java.util.ArrayList.forEach(ArrayList.java:1257)\n        at com.google.cloud.tools.jib.cli.jar.JarModeProcessor.getDependenciesLayers(JarModeProcessor.java:233)\n\nMaybe it can be\n      Path jarParent = jarPath.getParent() == null ? Paths.get(\"\") : jarPath.getParent();", "author": "chanseokoh", "createdAt": "2020-11-10T21:59:06Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/jar/JarModeProcessor.java", "diffHunk": "@@ -191,4 +204,50 @@ private static FileEntriesLayer addDirectoryContentsToLayer(\n             });\n     return builder.build();\n   }\n+\n+  private static List<FileEntriesLayer> getDependenciesLayers(Path jarPath) throws IOException {\n+    List<FileEntriesLayer> layers = new ArrayList<>();\n+    String classPath = null;\n+\n+    // Get dependencies from Class-Path in the jar's manifest and add a layer each for non-snapshot\n+    // and snapshot dependencies. If Class-Path is not present in the jar's manifest then skip\n+    // adding the dependencies layers.\n+    try (JarFile jarFile = new JarFile(jarPath.toFile())) {\n+      classPath = jarFile.getManifest().getMainAttributes().getValue(Attributes.Name.CLASS_PATH);\n+    }\n+    if (classPath != null) {\n+      Predicate<String> isSnapshot = name -> name.contains(\"SNAPSHOT\");\n+      List<String> allDependencies = Splitter.onPattern(\"\\\\s+\").splitToList(classPath.trim());\n+      List<Path> nonSnapshotDependencies =\n+          allDependencies\n+              .stream()\n+              .filter(isSnapshot.negate())\n+              .map(Paths::get)\n+              .collect(Collectors.toList());\n+      List<Path> snapshotDependencies =\n+          allDependencies.stream().filter(isSnapshot).map(Paths::get).collect(Collectors.toList());\n+      Path jarParent = jarPath.getParent();\n+      if (!nonSnapshotDependencies.isEmpty()) {\n+        FileEntriesLayer.Builder nonSnapshotDependenciesLayerBuilder =\n+            FileEntriesLayer.builder().setName(DEPENDENCIES);\n+        nonSnapshotDependencies.forEach(\n+            path ->\n+                nonSnapshotDependenciesLayerBuilder.addEntry(\n+                    jarParent.resolve(path),", "originalCommit": "3c07e34bd88793fe56b4bac0b5f1e3b6f6033515", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkwODc1Mw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2888#discussion_r520908753", "bodyText": "I ran into the same issue, you're right. Okay I will fix this and add some tests for jars that use dependencies.", "author": "mpeddada1", "createdAt": "2020-11-10T22:15:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkwMDQ1Mg=="}], "type": "inlineReview"}, {"oid": "1f2fa573b1b15ba8eed4d18fa3ff7eeccaaac211", "url": "https://github.com/GoogleContainerTools/jib/commit/1f2fa573b1b15ba8eed4d18fa3ff7eeccaaac211", "message": "modify mode, fix npe and issue with dependency paths", "committedDate": "2020-11-12T15:03:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjE5MjE2OQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2888#discussion_r522192169", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public void testJar_unknownMode_toDocker() throws URISyntaxException {\n          \n          \n            \n              public void testJar_unknownMode() throws URISyntaxException {", "author": "chanseokoh", "createdAt": "2020-11-12T15:27:26Z", "path": "jib-cli/src/integration-test/java/com/google/cloud/tools/jib/cli/cli2/JarCommandTest.java", "diffHunk": "@@ -57,20 +57,52 @@ public void testErrorLogging_directoryGiven() throws URISyntaxException {\n     assertThat(exitCode).isEqualTo(1);\n     assertThat(stringWriter.toString())\n         .isEqualTo(\n-            \"[ERROR] The file path provided is for a directory. Please provide a path to a jar file: \"\n+            \"[ERROR] The file path provided is for a directory. Please provide a path to a JAR: \"\n                 + jarFile.toString()\n                 + \"\\n\");\n   }\n \n   @Test\n-  public void testJar_toDocker() throws IOException, InterruptedException, URISyntaxException {\n-    Path jarFile = Paths.get(Resources.getResource(\"simpleJar.jar\").toURI());\n+  public void testJar_explodedMode_toDocker()\n+      throws IOException, InterruptedException, URISyntaxException {\n+    Path jarFile = Paths.get(Resources.getResource(\"jarTest/jarWithCp.jar\").toURI());\n     Integer exitCode =\n         new CommandLine(new JibCli())\n             .execute(\"--target\", \"docker://jib-cli-image\", \"jar\", jarFile.toString());\n     String output = new Command(\"docker\", \"run\", \"--rm\", \"jib-cli-image\").run();\n \n     assertThat(exitCode).isEqualTo(0);\n-    assertThat(output).isEqualTo(\"Hello World\");\n+    assertThat(output).isEqualTo(\"HelloWorld\");\n+  }\n+\n+  @Test\n+  public void testJar_packagedMode_toDocker()\n+      throws IOException, InterruptedException, URISyntaxException {\n+    Path jarFile = Paths.get(Resources.getResource(\"jarTest/jarWithCp.jar\").toURI());\n+    Integer exitCode =\n+        new CommandLine(new JibCli())\n+            .execute(\n+                \"--target\", \"docker://jib-cli-image\", \"jar\", jarFile.toString(), \"--mode=packaged\");\n+    String output = new Command(\"docker\", \"run\", \"--rm\", \"jib-cli-image\").run();\n+\n+    assertThat(exitCode).isEqualTo(0);\n+    assertThat(output).isEqualTo(\"HelloWorld\");\n+  }\n+\n+  @Test\n+  public void testJar_unknownMode_toDocker() throws URISyntaxException {", "originalCommit": "1f2fa573b1b15ba8eed4d18fa3ff7eeccaaac211", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjE5MzAwMA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2888#discussion_r522193000", "bodyText": "Perhaps we don't even need to pass a jar file?", "author": "chanseokoh", "createdAt": "2020-11-12T15:28:26Z", "path": "jib-cli/src/integration-test/java/com/google/cloud/tools/jib/cli/cli2/JarCommandTest.java", "diffHunk": "@@ -57,20 +57,52 @@ public void testErrorLogging_directoryGiven() throws URISyntaxException {\n     assertThat(exitCode).isEqualTo(1);\n     assertThat(stringWriter.toString())\n         .isEqualTo(\n-            \"[ERROR] The file path provided is for a directory. Please provide a path to a jar file: \"\n+            \"[ERROR] The file path provided is for a directory. Please provide a path to a JAR: \"\n                 + jarFile.toString()\n                 + \"\\n\");\n   }\n \n   @Test\n-  public void testJar_toDocker() throws IOException, InterruptedException, URISyntaxException {\n-    Path jarFile = Paths.get(Resources.getResource(\"simpleJar.jar\").toURI());\n+  public void testJar_explodedMode_toDocker()\n+      throws IOException, InterruptedException, URISyntaxException {\n+    Path jarFile = Paths.get(Resources.getResource(\"jarTest/jarWithCp.jar\").toURI());\n     Integer exitCode =\n         new CommandLine(new JibCli())\n             .execute(\"--target\", \"docker://jib-cli-image\", \"jar\", jarFile.toString());\n     String output = new Command(\"docker\", \"run\", \"--rm\", \"jib-cli-image\").run();\n \n     assertThat(exitCode).isEqualTo(0);\n-    assertThat(output).isEqualTo(\"Hello World\");\n+    assertThat(output).isEqualTo(\"HelloWorld\");\n+  }\n+\n+  @Test\n+  public void testJar_packagedMode_toDocker()\n+      throws IOException, InterruptedException, URISyntaxException {\n+    Path jarFile = Paths.get(Resources.getResource(\"jarTest/jarWithCp.jar\").toURI());\n+    Integer exitCode =\n+        new CommandLine(new JibCli())\n+            .execute(\n+                \"--target\", \"docker://jib-cli-image\", \"jar\", jarFile.toString(), \"--mode=packaged\");\n+    String output = new Command(\"docker\", \"run\", \"--rm\", \"jib-cli-image\").run();\n+\n+    assertThat(exitCode).isEqualTo(0);\n+    assertThat(output).isEqualTo(\"HelloWorld\");\n+  }\n+\n+  @Test\n+  public void testJar_unknownMode_toDocker() throws URISyntaxException {\n+    CommandLine jibCli = new CommandLine(new JibCli());\n+    StringWriter stringWriter = new StringWriter();\n+    jibCli.setErr(new PrintWriter(stringWriter));\n+\n+    Path jarFile = Paths.get(Resources.getResource(\"jarTest/jarWithCp.jar\").toURI());", "originalCommit": "1f2fa573b1b15ba8eed4d18fa3ff7eeccaaac211", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjE5NDMwOA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2888#discussion_r522194308", "bodyText": "Let's have exploded (default mode) come first.", "author": "chanseokoh", "createdAt": "2020-11-12T15:30:02Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/jar/ProcessingMode.java", "diffHunk": "@@ -0,0 +1,22 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.cli.jar;\n+\n+public enum ProcessingMode {\n+  packaged,", "originalCommit": "1f2fa573b1b15ba8eed4d18fa3ff7eeccaaac211", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjE5NjQ3OQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2888#discussion_r522196479", "bodyText": "Maybe we can be consistent with the names. Given that the class name is already JarModeProcessor,\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  layers = JarModeProcessor.createPackagedModeLayersForStandardJar(jarPath);\n          \n          \n            \n                  entrypoint = JarModeProcessor.computeEntrypointForPackagedStandard(jarPath);\n          \n          \n            \n                  layers = JarModeProcessor.createLayersForPackagedStandard(jarPath);\n          \n          \n            \n                  entrypoint = JarModeProcessor.computeEntrypointForPackagedStandard(jarPath);\n          \n      \n    \n    \n  \n\nAnd unfortunately, renaming a method means renaming test methods too.", "author": "chanseokoh", "createdAt": "2020-11-12T15:32:45Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/jar/JarFiles.java", "diffHunk": "@@ -33,20 +33,28 @@\n    * @param jarPath path to the jar file\n    * @param tempDirPath path to a temporary directory which will be used store the exploded jar's\n    *     contents\n+   * @param mode mode for processing jar\n    * @return JibContainerBuilder\n    * @throws IOException if I/O error occurs when opening the jar file or if temporary directory\n    *     provided doesn't exist\n    * @throws InvalidImageReferenceException if the base image reference is invalid\n    */\n-  public static JibContainerBuilder toJibContainerBuilder(Path jarPath, Path tempDirPath)\n+  public static JibContainerBuilder toJibContainerBuilder(\n+      Path jarPath, Path tempDirPath, ProcessingMode mode)\n       throws IOException, InvalidImageReferenceException {\n \n     // Use distroless as the base image.\n     JibContainerBuilder containerBuilder = Jib.from(\"gcr.io/distroless/java\");\n \n-    List<FileEntriesLayer> layers =\n-        JarModeProcessor.createExplodedModeLayersForStandardJar(jarPath, tempDirPath);\n-    List<String> entrypoint = JarModeProcessor.computeEntrypointForExplodedStandard(jarPath);\n+    List<FileEntriesLayer> layers;\n+    List<String> entrypoint;\n+    if (mode.equals(ProcessingMode.packaged)) {\n+      layers = JarModeProcessor.createPackagedModeLayersForStandardJar(jarPath);\n+      entrypoint = JarModeProcessor.computeEntrypointForPackagedStandard(jarPath);", "originalCommit": "1f2fa573b1b15ba8eed4d18fa3ff7eeccaaac211", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjIwMzczOQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2888#discussion_r522203739", "bodyText": "Now that we have refactored out this logic to this method, short-circuiting is possible, and I think it helps readability. And now I think it should be fine to expand the try block until the end. For example,\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                try (JarFile jarFile = new JarFile(jarPath.toFile())) {\n          \n          \n            \n                  classPath = jarFile.getManifest().getMainAttributes().getValue(Attributes.Name.CLASS_PATH);\n          \n          \n            \n                }\n          \n          \n            \n                if (classPath != null) {\n          \n          \n            \n                  Predicate<String> isSnapshot = name -> name.contains(\"SNAPSHOT\");\n          \n          \n            \n                try (JarFile jarFile = new JarFile(jarPath.toFile())) {\n          \n          \n            \n                  String classPath = jarFile.getManifest().getMainAttributes().getValue(Attributes.Name.CLASS_PATH);\n          \n          \n            \n                  if (classPath == null) {\n          \n          \n            \n                    return new ArrayList<>();\n          \n          \n            \n                  }\n          \n          \n            \n            \n          \n          \n            \n                  List<FileEntriesLayer> layers = new ArrayList<>();\n          \n          \n            \n                  ...\n          \n          \n            \n                }", "author": "chanseokoh", "createdAt": "2020-11-12T15:41:54Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/jar/JarModeProcessor.java", "diffHunk": "@@ -191,4 +202,49 @@ private static FileEntriesLayer addDirectoryContentsToLayer(\n             });\n     return builder.build();\n   }\n+\n+  private static List<FileEntriesLayer> getDependenciesLayers(\n+      Path jarPath, AbsoluteUnixPath pathOnContainer) throws IOException {\n+    List<FileEntriesLayer> layers = new ArrayList<>();\n+    String classPath = null;\n+\n+    // Get dependencies from Class-Path in the jar's manifest and add a layer each for non-snapshot\n+    // and snapshot dependencies. If Class-Path is not present in the jar's manifest then skip\n+    // adding the dependencies layers.\n+    try (JarFile jarFile = new JarFile(jarPath.toFile())) {\n+      classPath = jarFile.getManifest().getMainAttributes().getValue(Attributes.Name.CLASS_PATH);\n+    }\n+    if (classPath != null) {\n+      Predicate<String> isSnapshot = name -> name.contains(\"SNAPSHOT\");", "originalCommit": "1f2fa573b1b15ba8eed4d18fa3ff7eeccaaac211", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjIwNjIxOQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2888#discussion_r522206219", "bodyText": "super nit: I think in this local scope, it's fine to name it nonSnapshotLayer. I think it'll help reduce cognitive load when reading the code block.", "author": "chanseokoh", "createdAt": "2020-11-12T15:44:57Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/jar/JarModeProcessor.java", "diffHunk": "@@ -191,4 +202,49 @@ private static FileEntriesLayer addDirectoryContentsToLayer(\n             });\n     return builder.build();\n   }\n+\n+  private static List<FileEntriesLayer> getDependenciesLayers(\n+      Path jarPath, AbsoluteUnixPath pathOnContainer) throws IOException {\n+    List<FileEntriesLayer> layers = new ArrayList<>();\n+    String classPath = null;\n+\n+    // Get dependencies from Class-Path in the jar's manifest and add a layer each for non-snapshot\n+    // and snapshot dependencies. If Class-Path is not present in the jar's manifest then skip\n+    // adding the dependencies layers.\n+    try (JarFile jarFile = new JarFile(jarPath.toFile())) {\n+      classPath = jarFile.getManifest().getMainAttributes().getValue(Attributes.Name.CLASS_PATH);\n+    }\n+    if (classPath != null) {\n+      Predicate<String> isSnapshot = name -> name.contains(\"SNAPSHOT\");\n+      List<String> allDependencies = Splitter.onPattern(\"\\\\s+\").splitToList(classPath.trim());\n+      List<Path> nonSnapshotDependencies =\n+          allDependencies\n+              .stream()\n+              .filter(isSnapshot.negate())\n+              .map(Paths::get)\n+              .collect(Collectors.toList());\n+      List<Path> snapshotDependencies =\n+          allDependencies.stream().filter(isSnapshot).map(Paths::get).collect(Collectors.toList());\n+      Path jarParent = jarPath.getParent() == null ? Paths.get(\"\") : jarPath.getParent();\n+      if (!nonSnapshotDependencies.isEmpty()) {\n+        FileEntriesLayer.Builder nonSnapshotDependenciesLayerBuilder =", "originalCommit": "1f2fa573b1b15ba8eed4d18fa3ff7eeccaaac211", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjIwNjQ5NA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2888#discussion_r522206494", "bodyText": "Likewise, snapshotLayer.", "author": "chanseokoh", "createdAt": "2020-11-12T15:45:17Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/jar/JarModeProcessor.java", "diffHunk": "@@ -191,4 +202,49 @@ private static FileEntriesLayer addDirectoryContentsToLayer(\n             });\n     return builder.build();\n   }\n+\n+  private static List<FileEntriesLayer> getDependenciesLayers(\n+      Path jarPath, AbsoluteUnixPath pathOnContainer) throws IOException {\n+    List<FileEntriesLayer> layers = new ArrayList<>();\n+    String classPath = null;\n+\n+    // Get dependencies from Class-Path in the jar's manifest and add a layer each for non-snapshot\n+    // and snapshot dependencies. If Class-Path is not present in the jar's manifest then skip\n+    // adding the dependencies layers.\n+    try (JarFile jarFile = new JarFile(jarPath.toFile())) {\n+      classPath = jarFile.getManifest().getMainAttributes().getValue(Attributes.Name.CLASS_PATH);\n+    }\n+    if (classPath != null) {\n+      Predicate<String> isSnapshot = name -> name.contains(\"SNAPSHOT\");\n+      List<String> allDependencies = Splitter.onPattern(\"\\\\s+\").splitToList(classPath.trim());\n+      List<Path> nonSnapshotDependencies =\n+          allDependencies\n+              .stream()\n+              .filter(isSnapshot.negate())\n+              .map(Paths::get)\n+              .collect(Collectors.toList());\n+      List<Path> snapshotDependencies =\n+          allDependencies.stream().filter(isSnapshot).map(Paths::get).collect(Collectors.toList());\n+      Path jarParent = jarPath.getParent() == null ? Paths.get(\"\") : jarPath.getParent();\n+      if (!nonSnapshotDependencies.isEmpty()) {\n+        FileEntriesLayer.Builder nonSnapshotDependenciesLayerBuilder =\n+            FileEntriesLayer.builder().setName(DEPENDENCIES);\n+        nonSnapshotDependencies.forEach(\n+            path ->\n+                nonSnapshotDependenciesLayerBuilder.addEntry(\n+                    jarParent.resolve(path), pathOnContainer.resolve(path)));\n+        layers.add(nonSnapshotDependenciesLayerBuilder.build());\n+      }\n+      if (!snapshotDependencies.isEmpty()) {\n+        FileEntriesLayer.Builder snapshotDependenciesLayerBuilder =", "originalCommit": "1f2fa573b1b15ba8eed4d18fa3ff7eeccaaac211", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjIwOTU0Mg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2888#discussion_r522209542", "bodyText": "jarLayer().getEntries().get(0).getExtractionPath()?\nAnd before this, also assert that the size of jarLayer().getEntries() is 1.", "author": "chanseokoh", "createdAt": "2020-11-12T15:49:00Z", "path": "jib-cli/src/test/java/com/google/cloud/tools/jib/cli/jar/JarModeProcessorTest.java", "diffHunk": "@@ -326,6 +326,125 @@ public void testExplodedMode_standard_computeEntrypoint_noMainClass() throws URI\n     assertThat(ex)\n         .hasMessageThat()\n         .isEqualTo(\n-            \"`Main-Class:` attribute for an application main class not defined in the input Jar's manifest (`META-INF/MANIFEST.MF` in the Jar).\");\n+            \"`Main-Class:` attribute for an application main class not defined in the input JAR's manifest (`META-INF/MANIFEST.MF` in the JAR).\");\n+  }\n+\n+  @Test\n+  public void testCreatePackagedModeLayersForStandardJar_emptyJar()\n+      throws IOException, URISyntaxException {\n+    Path standardJar = Paths.get(Resources.getResource(STANDARD_JAR_EMPTY).toURI());\n+    List<FileEntriesLayer> layers =\n+        JarModeProcessor.createPackagedModeLayersForStandardJar(standardJar);\n+\n+    assertThat(layers.size()).isEqualTo(1);\n+\n+    FileEntriesLayer jarLayer = layers.get(0);\n+    assertThat(jarLayer.getName()).isEqualTo(\"jar\");\n+    assertThat(\n+            jarLayer\n+                .getEntries()\n+                .stream()\n+                .map(FileEntry::getExtractionPath)\n+                .collect(Collectors.toList())\n+                .get(0))", "originalCommit": "1f2fa573b1b15ba8eed4d18fa3ff7eeccaaac211", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjIxMDUwMA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2888#discussion_r522210500", "bodyText": "ditto\nBut this test is identical to the one above. May be remove this test?", "author": "chanseokoh", "createdAt": "2020-11-12T15:50:09Z", "path": "jib-cli/src/test/java/com/google/cloud/tools/jib/cli/jar/JarModeProcessorTest.java", "diffHunk": "@@ -326,6 +326,125 @@ public void testExplodedMode_standard_computeEntrypoint_noMainClass() throws URI\n     assertThat(ex)\n         .hasMessageThat()\n         .isEqualTo(\n-            \"`Main-Class:` attribute for an application main class not defined in the input Jar's manifest (`META-INF/MANIFEST.MF` in the Jar).\");\n+            \"`Main-Class:` attribute for an application main class not defined in the input JAR's manifest (`META-INF/MANIFEST.MF` in the JAR).\");\n+  }\n+\n+  @Test\n+  public void testCreatePackagedModeLayersForStandardJar_emptyJar()\n+      throws IOException, URISyntaxException {\n+    Path standardJar = Paths.get(Resources.getResource(STANDARD_JAR_EMPTY).toURI());\n+    List<FileEntriesLayer> layers =\n+        JarModeProcessor.createPackagedModeLayersForStandardJar(standardJar);\n+\n+    assertThat(layers.size()).isEqualTo(1);\n+\n+    FileEntriesLayer jarLayer = layers.get(0);\n+    assertThat(jarLayer.getName()).isEqualTo(\"jar\");\n+    assertThat(\n+            jarLayer\n+                .getEntries()\n+                .stream()\n+                .map(FileEntry::getExtractionPath)\n+                .collect(Collectors.toList())\n+                .get(0))\n+        .isEqualTo(AbsoluteUnixPath.get(\"/app/emptyStandardJar.jar\"));\n+  }\n+\n+  @Test\n+  public void testCreatePackagedModeLayersForStandardJar_withoutClassPathInManifest()\n+      throws IOException, URISyntaxException {\n+    Path standardJar =\n+        Paths.get(Resources.getResource(STANDARD_JAR_WITHOUT_CLASS_PATH_MANIFEST).toURI());\n+    List<FileEntriesLayer> layers =\n+        JarModeProcessor.createPackagedModeLayersForStandardJar(standardJar);\n+\n+    assertThat(layers.size()).isEqualTo(1);\n+\n+    FileEntriesLayer jarLayer = layers.get(0);\n+\n+    assertThat(jarLayer.getName()).isEqualTo(\"jar\");\n+    assertThat(", "originalCommit": "1f2fa573b1b15ba8eed4d18fa3ff7eeccaaac211", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjIxODg2MA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2888#discussion_r522218860", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    getDependenciesLayers(jarPath, APP_ROOT.resolve(RelativeUnixPath.get(\"dependencies\")));\n          \n          \n            \n                    getDependenciesLayers(jarPath, APP_ROOT.resolve(\"dependencies\"));", "author": "chanseokoh", "createdAt": "2020-11-12T16:00:35Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/jar/JarModeProcessor.java", "diffHunk": "@@ -86,47 +87,12 @@ static JarType determineJarType(Path jarPath) throws IOException {\n    */\n   static List<FileEntriesLayer> createExplodedModeLayersForStandardJar(\n       Path jarPath, Path tempDirPath) throws IOException {\n+    // Add dependencies layers.\n+    List<FileEntriesLayer> layers =\n+        getDependenciesLayers(jarPath, APP_ROOT.resolve(RelativeUnixPath.get(\"dependencies\")));", "originalCommit": "1f2fa573b1b15ba8eed4d18fa3ff7eeccaaac211", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d1249db3cb5d2f26f8935ffdaf877fb66f1c74b1", "url": "https://github.com/GoogleContainerTools/jib/commit/d1249db3cb5d2f26f8935ffdaf877fb66f1c74b1", "message": "Renaming JarModeProcessor methods", "committedDate": "2020-11-12T17:54:56Z", "type": "commit"}, {"oid": "8b42f0e1a5b362008d2dc87c09245c7294c7226c", "url": "https://github.com/GoogleContainerTools/jib/commit/8b42f0e1a5b362008d2dc87c09245c7294c7226c", "message": "simplify test for unknown mode", "committedDate": "2020-11-12T18:08:59Z", "type": "commit"}, {"oid": "f3ee2875eef1adf0b482ebf1730472f55f7e6e40", "url": "https://github.com/GoogleContainerTools/jib/commit/f3ee2875eef1adf0b482ebf1730472f55f7e6e40", "message": "remove repetitive test", "committedDate": "2020-11-12T18:16:31Z", "type": "commit"}, {"oid": "369bf2fa4c8e370d0f4cf2d41cbef68242d24ff3", "url": "https://github.com/GoogleContainerTools/jib/commit/369bf2fa4c8e370d0f4cf2d41cbef68242d24ff3", "message": "clean up packaged mode unit test", "committedDate": "2020-11-12T18:20:29Z", "type": "commit"}, {"oid": "68c64a84999ed44f600c205fb5274d676b7db006", "url": "https://github.com/GoogleContainerTools/jib/commit/68c64a84999ed44f600c205fb5274d676b7db006", "message": "Merge branch 'master' of github.com:GoogleContainerTools/jib into packaged-mode-jar", "committedDate": "2020-11-13T03:09:00Z", "type": "commit"}, {"oid": "2bde515b179d0427cb581f8450f57c85a846ea10", "url": "https://github.com/GoogleContainerTools/jib/commit/2bde515b179d0427cb581f8450f57c85a846ea10", "message": "Pull in changes in master", "committedDate": "2020-11-18T02:32:08Z", "type": "commit"}, {"oid": "d371318c97eb5962c49139303788e00cbbae816f", "url": "https://github.com/GoogleContainerTools/jib/commit/d371318c97eb5962c49139303788e00cbbae816f", "message": "create helper for getting snapshot and non-snapshot dependencies from classpath", "committedDate": "2020-11-18T03:27:31Z", "type": "commit"}, {"oid": "e0827cd313ffa26667f14bcfb004b38b99876f88", "url": "https://github.com/GoogleContainerTools/jib/commit/e0827cd313ffa26667f14bcfb004b38b99876f88", "message": "rename test methods", "committedDate": "2020-11-18T03:33:22Z", "type": "commit"}, {"oid": "4bb15b1dfc002bc8eb6717a7369358b75a8fba90", "url": "https://github.com/GoogleContainerTools/jib/commit/4bb15b1dfc002bc8eb6717a7369358b75a8fba90", "message": "formatting", "committedDate": "2020-11-18T03:39:07Z", "type": "commit"}, {"oid": "3998396b8f44f323afbdd3df787c16e024aba4d2", "url": "https://github.com/GoogleContainerTools/jib/commit/3998396b8f44f323afbdd3df787c16e024aba4d2", "message": "add test for jar with no dependencies for packaged mode and assert on classpath", "committedDate": "2020-11-18T03:50:16Z", "type": "commit"}, {"oid": "1324bb8f71cc24bd509c1c686de4e8be17d1211d", "url": "https://github.com/GoogleContainerTools/jib/commit/1324bb8f71cc24bd509c1c686de4e8be17d1211d", "message": "clean up unit test", "committedDate": "2020-11-18T03:54:43Z", "type": "commit"}, {"oid": "bb042325b919b64cbd28bd58a9897a94264320f9", "url": "https://github.com/GoogleContainerTools/jib/commit/bb042325b919b64cbd28bd58a9897a94264320f9", "message": "remove redundant test", "committedDate": "2020-11-18T04:02:11Z", "type": "commit"}, {"oid": "1cdcba9f86e06428a29c5070fa465fcf71df8406", "url": "https://github.com/GoogleContainerTools/jib/commit/1cdcba9f86e06428a29c5070fa465fcf71df8406", "message": "remove unnecesary file", "committedDate": "2020-11-18T04:06:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM1ODc1Ng==", "url": "https://github.com/GoogleContainerTools/jib/pull/2888#discussion_r526358756", "bodyText": "I'm not a big fan of using a map for the purpose of returning more than one value. How about creating a private inner class? For this purpose, I think we don't even need getters and setters.\nprivate static class LocalDependencies {\n  private final List<Path> snapshots;\n  private final List<Path> nonSnapshots;\n\n  private LocalDependencies(List<Path> snapshots, List<Path> nonSnapshots) {\n    this.snapshots = snapshots;\n    this.nonSnapshots = nonSnapshots;\n  }\n}\nBut is it not possible for this method to return built layers? (I remember the original code worked in that way, and I liked it.) In that way, I think we can remove duplicate code between the exploded mode and the packaged mode?", "author": "chanseokoh", "createdAt": "2020-11-18T19:22:29Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/jar/JarModeProcessor.java", "diffHunk": "@@ -163,14 +223,51 @@ static JarType determineJarType(Path jarPath) throws IOException {\n           jarFile.getManifest().getMainAttributes().getValue(Attributes.Name.MAIN_CLASS);\n       if (mainClass == null) {\n         throw new IllegalArgumentException(\n-            \"`Main-Class:` attribute for an application main class not defined in the input Jar's \"\n-                + \"manifest (`META-INF/MANIFEST.MF` in the Jar).\");\n+            \"`Main-Class:` attribute for an application main class not defined in the input JAR's \"\n+                + \"manifest (`META-INF/MANIFEST.MF` in the JAR).\");\n       }\n       String classpath = APP_ROOT + \"/explodedJar:\" + APP_ROOT + \"/dependencies/*\";\n       return ImmutableList.of(\"java\", \"-cp\", classpath, mainClass);\n     }\n   }\n \n+  /**\n+   * Computes the entrypoint for a standard jar in packaged mode.\n+   *\n+   * @param jarPath path to jar file\n+   * @return list of {@link String} representing entrypoint\n+   * @throws IOException if I/O error occurs when opening the jar file\n+   */\n+  static ImmutableList<String> computeEntrypointForPackagedStandard(Path jarPath)\n+      throws IOException {\n+    try (JarFile jarFile = new JarFile(jarPath.toFile())) {\n+      String mainClass =\n+          jarFile.getManifest().getMainAttributes().getValue(Attributes.Name.MAIN_CLASS);\n+      if (mainClass == null) {\n+        throw new IllegalArgumentException(\n+            \"`Main-Class:` attribute for an application main class not defined in the input JAR's \"\n+                + \"manifest (`META-INF/MANIFEST.MF` in the JAR).\");\n+      }\n+      return ImmutableList.of(\"java\", \"-jar\", APP_ROOT + \"/\" + jarPath.getFileName().toString());\n+    }\n+  }\n+\n+  private static ImmutableMap<String, List<Path>> getSnapshotAndNonSnapshotDependencies(", "originalCommit": "1cdcba9f86e06428a29c5070fa465fcf71df8406", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM2MjUzMA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2888#discussion_r526362530", "bodyText": "Assert that buildPlan.getLayers() is of size 2 before this.", "author": "chanseokoh", "createdAt": "2020-11-18T19:28:40Z", "path": "jib-cli/src/test/java/com/google/cloud/tools/jib/cli/jar/JarFilesTest.java", "diffHunk": "@@ -106,4 +107,41 @@ public void testToJibContainerBuilder_basicInfo()\n                 .build()\n                 .getEntries());\n   }\n+\n+  @Test\n+  public void testToJibContainerBuilder_packagedStandard_basicInfo()\n+      throws IOException, URISyntaxException, InvalidImageReferenceException {\n+    Path standardJar = Paths.get(Resources.getResource(SIMPLE_STANDARD_JAR).toURI());\n+    Path destDir = temporaryFolder.getRoot().toPath();\n+    JibContainerBuilder containerBuilder =\n+        JarFiles.toJibContainerBuilder(standardJar, destDir, ProcessingMode.packaged);\n+    ContainerBuildPlan buildPlan = containerBuilder.toContainerBuildPlan();\n+\n+    assertThat(buildPlan.getBaseImage()).isEqualTo(\"gcr.io/distroless/java\");\n+    assertThat(buildPlan.getPlatforms()).isEqualTo(ImmutableSet.of(new Platform(\"amd64\", \"linux\")));\n+    assertThat(buildPlan.getCreationTime()).isEqualTo(Instant.EPOCH);\n+    assertThat(buildPlan.getFormat()).isEqualTo(ImageFormat.Docker);\n+    assertThat(buildPlan.getEnvironment()).isEmpty();\n+    assertThat(buildPlan.getLabels()).isEmpty();\n+    assertThat(buildPlan.getVolumes()).isEmpty();\n+    assertThat(buildPlan.getExposedPorts()).isEmpty();\n+    assertThat(buildPlan.getUser()).isNull();\n+    assertThat(buildPlan.getWorkingDirectory()).isNull();\n+    assertThat(buildPlan.getEntrypoint())\n+        .isEqualTo(ImmutableList.of(\"java\", \"-jar\", \"/app/basicStandardJar.jar\"));\n+    assertThat(((FileEntriesLayer) buildPlan.getLayers().get(0)).getEntries())", "originalCommit": "1cdcba9f86e06428a29c5070fa465fcf71df8406", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM2MzE3OQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2888#discussion_r526363179", "bodyText": "Probably no one throws URISyntaxException. Try removing it.", "author": "chanseokoh", "createdAt": "2020-11-18T19:29:42Z", "path": "jib-cli/src/test/java/com/google/cloud/tools/jib/cli/jar/JarModeProcessorTest.java", "diffHunk": "@@ -295,7 +294,21 @@ public void testCreateExplodedModeLayersForStandardJar_dependencyDoesNotExist()\n   }\n \n   @Test\n-  public void testExplodeMode_standard_computeEntrypoint_allLayersPresent()\n+  public void testComputeEntrypointForExplodedStandard_noMainClass() throws URISyntaxException {", "originalCommit": "1cdcba9f86e06428a29c5070fa465fcf71df8406", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c67731c9ca10930a9a176cf03ea05d191e81f169", "url": "https://github.com/GoogleContainerTools/jib/commit/c67731c9ca10930a9a176cf03ea05d191e81f169", "message": "Refactor test to use helper", "committedDate": "2020-11-18T21:22:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ1MzQ5NA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2888#discussion_r526453494", "bodyText": "We have the enum class defined in this Java package (c.g.c.t.jib.cli.jar.ProcessingMode). Why not use it?", "author": "chanseokoh", "createdAt": "2020-11-18T22:04:41Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/jar/JarModeProcessor.java", "diffHunk": "@@ -83,58 +84,16 @@ static JarType determineJarType(Path jarPath) throws IOException {\n    * @throws IOException if I/O error occurs when opening the jar file or if temporary directory\n    *     provided doesn't exist\n    */\n-  static List<FileEntriesLayer> createExplodedModeLayersForStandardJar(\n-      Path jarPath, Path tempDirPath) throws IOException, IllegalArgumentException {\n-    Path localExplodedJarRoot = tempDirPath;\n-    ZipUtil.unzip(jarPath, localExplodedJarRoot);\n-    List<FileEntriesLayer> layers = new ArrayList<>();\n-\n-    // Get dependencies from Class-Path in the jar's manifest and add a layer each for non-snapshot\n-    // and snapshot dependencies. If Class-Path is not present in the jar's manifest then skip\n-    // adding the dependencies layers.\n-    String classPath = null;\n-    try (JarFile jarFile = new JarFile(jarPath.toFile())) {\n-      classPath = jarFile.getManifest().getMainAttributes().getValue(Attributes.Name.CLASS_PATH);\n-    }\n-    if (classPath != null) {\n-      Predicate<String> isSnapshot = name -> name.contains(\"SNAPSHOT\");\n-      List<String> allDependencies = Splitter.onPattern(\"\\\\s+\").splitToList(classPath.trim());\n-      List<Path> nonSnapshotDependencies =\n-          allDependencies\n-              .stream()\n-              .filter(isSnapshot.negate())\n-              .map(Paths::get)\n-              .collect(Collectors.toList());\n-      List<Path> snapshotDependencies =\n-          allDependencies.stream().filter(isSnapshot).map(Paths::get).collect(Collectors.toList());\n-      Path jarParent = jarPath.getParent() == null ? Paths.get(\"\") : jarPath.getParent();\n-      if (!nonSnapshotDependencies.isEmpty()) {\n-        FileEntriesLayer.Builder nonSnapshotDependenciesLayerBuilder =\n-            FileEntriesLayer.builder().setName(DEPENDENCIES);\n-        nonSnapshotDependencies.forEach(\n-            path ->\n-                addDependency(\n-                    nonSnapshotDependenciesLayerBuilder,\n-                    jarParent.resolve(path),\n-                    APP_ROOT.resolve(\"dependencies\").resolve(path.getFileName())));\n-        layers.add(nonSnapshotDependenciesLayerBuilder.build());\n-      }\n-      if (!snapshotDependencies.isEmpty()) {\n-        FileEntriesLayer.Builder snapshotDependenciesLayerBuilder =\n-            FileEntriesLayer.builder().setName(SNAPSHOT_DEPENDENCIES);\n-        snapshotDependencies.forEach(\n-            path ->\n-                addDependency(\n-                    snapshotDependenciesLayerBuilder,\n-                    jarParent.resolve(path),\n-                    APP_ROOT.resolve(\"dependencies\").resolve(path.getFileName())));\n-        layers.add(snapshotDependenciesLayerBuilder.build());\n-      }\n-    }\n+  static List<FileEntriesLayer> createLayersForExplodedStandard(Path jarPath, Path tempDirPath)\n+      throws IOException {\n+    // Add dependencies layers.\n+    List<FileEntriesLayer> layers = getDependenciesLayers(jarPath, \"exploded\");", "originalCommit": "c67731c9ca10930a9a176cf03ea05d191e81f169", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ5OTQ1NA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2888#discussion_r526499454", "bodyText": "Oh yes, good idea!", "author": "mpeddada1", "createdAt": "2020-11-18T23:51:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ1MzQ5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ1NDQxNg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2888#discussion_r526454416", "bodyText": "I think short-circuiting will help readability.\n      if (classPath == null) {  // should flip the comparison\n        return new ArrayList<>();\n      }\n      List<FileEntriesLayer> layers = new ArrayList<>();", "author": "chanseokoh", "createdAt": "2020-11-18T22:06:28Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/jar/JarModeProcessor.java", "diffHunk": "@@ -163,14 +145,92 @@ static JarType determineJarType(Path jarPath) throws IOException {\n           jarFile.getManifest().getMainAttributes().getValue(Attributes.Name.MAIN_CLASS);\n       if (mainClass == null) {\n         throw new IllegalArgumentException(\n-            \"`Main-Class:` attribute for an application main class not defined in the input Jar's \"\n-                + \"manifest (`META-INF/MANIFEST.MF` in the Jar).\");\n+            \"`Main-Class:` attribute for an application main class not defined in the input JAR's \"\n+                + \"manifest (`META-INF/MANIFEST.MF` in the JAR).\");\n       }\n       String classpath = APP_ROOT + \"/explodedJar:\" + APP_ROOT + \"/dependencies/*\";\n       return ImmutableList.of(\"java\", \"-cp\", classpath, mainClass);\n     }\n   }\n \n+  /**\n+   * Computes the entrypoint for a standard jar in packaged mode.\n+   *\n+   * @param jarPath path to jar file\n+   * @return list of {@link String} representing entrypoint\n+   * @throws IOException if I/O error occurs when opening the jar file\n+   */\n+  static ImmutableList<String> computeEntrypointForPackagedStandard(Path jarPath)\n+      throws IOException {\n+    try (JarFile jarFile = new JarFile(jarPath.toFile())) {\n+      String mainClass =\n+          jarFile.getManifest().getMainAttributes().getValue(Attributes.Name.MAIN_CLASS);\n+      if (mainClass == null) {\n+        throw new IllegalArgumentException(\n+            \"`Main-Class:` attribute for an application main class not defined in the input JAR's \"\n+                + \"manifest (`META-INF/MANIFEST.MF` in the JAR).\");\n+      }\n+      return ImmutableList.of(\"java\", \"-jar\", APP_ROOT + \"/\" + jarPath.getFileName().toString());\n+    }\n+  }\n+\n+  private static List<FileEntriesLayer> getDependenciesLayers(Path jarPath, String mode)\n+      throws IOException {\n+    List<FileEntriesLayer> layers = new ArrayList<>();\n+\n+    // Get dependencies from Class-Path in the jar's manifest and add a layer each for non-snapshot\n+    // and snapshot dependencies. If Class-Path is not present in the jar's manifest then skip\n+    // adding the dependencies layers.\n+    try (JarFile jarFile = new JarFile(jarPath.toFile())) {\n+      String classPath =\n+          jarFile.getManifest().getMainAttributes().getValue(Attributes.Name.CLASS_PATH);\n+      if (classPath != null) {", "originalCommit": "c67731c9ca10930a9a176cf03ea05d191e81f169", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ1NTU0Ng==", "url": "https://github.com/GoogleContainerTools/jib/pull/2888#discussion_r526455546", "bodyText": "nit: let's just call these nonShapshots.", "author": "chanseokoh", "createdAt": "2020-11-18T22:08:40Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/jar/JarModeProcessor.java", "diffHunk": "@@ -163,14 +145,92 @@ static JarType determineJarType(Path jarPath) throws IOException {\n           jarFile.getManifest().getMainAttributes().getValue(Attributes.Name.MAIN_CLASS);\n       if (mainClass == null) {\n         throw new IllegalArgumentException(\n-            \"`Main-Class:` attribute for an application main class not defined in the input Jar's \"\n-                + \"manifest (`META-INF/MANIFEST.MF` in the Jar).\");\n+            \"`Main-Class:` attribute for an application main class not defined in the input JAR's \"\n+                + \"manifest (`META-INF/MANIFEST.MF` in the JAR).\");\n       }\n       String classpath = APP_ROOT + \"/explodedJar:\" + APP_ROOT + \"/dependencies/*\";\n       return ImmutableList.of(\"java\", \"-cp\", classpath, mainClass);\n     }\n   }\n \n+  /**\n+   * Computes the entrypoint for a standard jar in packaged mode.\n+   *\n+   * @param jarPath path to jar file\n+   * @return list of {@link String} representing entrypoint\n+   * @throws IOException if I/O error occurs when opening the jar file\n+   */\n+  static ImmutableList<String> computeEntrypointForPackagedStandard(Path jarPath)\n+      throws IOException {\n+    try (JarFile jarFile = new JarFile(jarPath.toFile())) {\n+      String mainClass =\n+          jarFile.getManifest().getMainAttributes().getValue(Attributes.Name.MAIN_CLASS);\n+      if (mainClass == null) {\n+        throw new IllegalArgumentException(\n+            \"`Main-Class:` attribute for an application main class not defined in the input JAR's \"\n+                + \"manifest (`META-INF/MANIFEST.MF` in the JAR).\");\n+      }\n+      return ImmutableList.of(\"java\", \"-jar\", APP_ROOT + \"/\" + jarPath.getFileName().toString());\n+    }\n+  }\n+\n+  private static List<FileEntriesLayer> getDependenciesLayers(Path jarPath, String mode)\n+      throws IOException {\n+    List<FileEntriesLayer> layers = new ArrayList<>();\n+\n+    // Get dependencies from Class-Path in the jar's manifest and add a layer each for non-snapshot\n+    // and snapshot dependencies. If Class-Path is not present in the jar's manifest then skip\n+    // adding the dependencies layers.\n+    try (JarFile jarFile = new JarFile(jarPath.toFile())) {\n+      String classPath =\n+          jarFile.getManifest().getMainAttributes().getValue(Attributes.Name.CLASS_PATH);\n+      if (classPath != null) {\n+        Path jarParent = jarPath.getParent() == null ? Paths.get(\"\") : jarPath.getParent();\n+        Predicate<String> isSnapshot = name -> name.contains(\"SNAPSHOT\");\n+        List<String> allDependencies = Splitter.onPattern(\"\\\\s+\").splitToList(classPath.trim());\n+        List<Path> nonSnapshotDependencies =", "originalCommit": "c67731c9ca10930a9a176cf03ea05d191e81f169", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ1NTgxMA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2888#discussion_r526455810", "bodyText": "nit: nonSnapshotLayer", "author": "chanseokoh", "createdAt": "2020-11-18T22:09:11Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/jar/JarModeProcessor.java", "diffHunk": "@@ -163,14 +145,92 @@ static JarType determineJarType(Path jarPath) throws IOException {\n           jarFile.getManifest().getMainAttributes().getValue(Attributes.Name.MAIN_CLASS);\n       if (mainClass == null) {\n         throw new IllegalArgumentException(\n-            \"`Main-Class:` attribute for an application main class not defined in the input Jar's \"\n-                + \"manifest (`META-INF/MANIFEST.MF` in the Jar).\");\n+            \"`Main-Class:` attribute for an application main class not defined in the input JAR's \"\n+                + \"manifest (`META-INF/MANIFEST.MF` in the JAR).\");\n       }\n       String classpath = APP_ROOT + \"/explodedJar:\" + APP_ROOT + \"/dependencies/*\";\n       return ImmutableList.of(\"java\", \"-cp\", classpath, mainClass);\n     }\n   }\n \n+  /**\n+   * Computes the entrypoint for a standard jar in packaged mode.\n+   *\n+   * @param jarPath path to jar file\n+   * @return list of {@link String} representing entrypoint\n+   * @throws IOException if I/O error occurs when opening the jar file\n+   */\n+  static ImmutableList<String> computeEntrypointForPackagedStandard(Path jarPath)\n+      throws IOException {\n+    try (JarFile jarFile = new JarFile(jarPath.toFile())) {\n+      String mainClass =\n+          jarFile.getManifest().getMainAttributes().getValue(Attributes.Name.MAIN_CLASS);\n+      if (mainClass == null) {\n+        throw new IllegalArgumentException(\n+            \"`Main-Class:` attribute for an application main class not defined in the input JAR's \"\n+                + \"manifest (`META-INF/MANIFEST.MF` in the JAR).\");\n+      }\n+      return ImmutableList.of(\"java\", \"-jar\", APP_ROOT + \"/\" + jarPath.getFileName().toString());\n+    }\n+  }\n+\n+  private static List<FileEntriesLayer> getDependenciesLayers(Path jarPath, String mode)\n+      throws IOException {\n+    List<FileEntriesLayer> layers = new ArrayList<>();\n+\n+    // Get dependencies from Class-Path in the jar's manifest and add a layer each for non-snapshot\n+    // and snapshot dependencies. If Class-Path is not present in the jar's manifest then skip\n+    // adding the dependencies layers.\n+    try (JarFile jarFile = new JarFile(jarPath.toFile())) {\n+      String classPath =\n+          jarFile.getManifest().getMainAttributes().getValue(Attributes.Name.CLASS_PATH);\n+      if (classPath != null) {\n+        Path jarParent = jarPath.getParent() == null ? Paths.get(\"\") : jarPath.getParent();\n+        Predicate<String> isSnapshot = name -> name.contains(\"SNAPSHOT\");\n+        List<String> allDependencies = Splitter.onPattern(\"\\\\s+\").splitToList(classPath.trim());\n+        List<Path> nonSnapshotDependencies =\n+            allDependencies\n+                .stream()\n+                .filter(isSnapshot.negate())\n+                .map(Paths::get)\n+                .collect(Collectors.toList());\n+        List<Path> snapshotDependencies =\n+            allDependencies\n+                .stream()\n+                .filter(isSnapshot)\n+                .map(Paths::get)\n+                .collect(Collectors.toList());\n+        if (!nonSnapshotDependencies.isEmpty()) {\n+          FileEntriesLayer.Builder nonSnapshotDependenciesLayerBuilder =", "originalCommit": "c67731c9ca10930a9a176cf03ea05d191e81f169", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9fd01f7e5f649b96397298ff8b238b02b4e88ca6", "url": "https://github.com/GoogleContainerTools/jib/commit/9fd01f7e5f649b96397298ff8b238b02b4e88ca6", "message": "changes to helper", "committedDate": "2020-11-18T23:51:04Z", "type": "commit"}, {"oid": "0f216a67499a4e69c3dacd0434d3fc33b45d1a88", "url": "https://github.com/GoogleContainerTools/jib/commit/0f216a67499a4e69c3dacd0434d3fc33b45d1a88", "message": "Merge branch 'master' of github.com:GoogleContainerTools/jib into packaged-mode-jar", "committedDate": "2020-11-19T15:53:31Z", "type": "commit"}]}