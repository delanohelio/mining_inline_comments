{"pr_number": 2890, "pr_title": "Fix ordering of options in Jib Cli", "pr_createdAt": "2020-11-10T21:46:55Z", "pr_url": "https://github.com/GoogleContainerTools/jib/pull/2890", "timeline": [{"oid": "0875562b16d5150948c9a43d2bbc2b67b3c8bf7a", "url": "https://github.com/GoogleContainerTools/jib/commit/0875562b16d5150948c9a43d2bbc2b67b3c8bf7a", "message": "add scope to target option in order to be used by subcommand", "committedDate": "2020-11-10T21:43:24Z", "type": "commit"}, {"oid": "36df0f4184c2e8e0febe34c5a7d5742aa971701d", "url": "https://github.com/GoogleContainerTools/jib/commit/36df0f4184c2e8e0febe34c5a7d5742aa971701d", "message": "Add scope for other parameters", "committedDate": "2020-11-11T15:24:04Z", "type": "commit"}, {"oid": "5a6f9488119e3f7457e85d76c4472bcf3ddc8369", "url": "https://github.com/GoogleContainerTools/jib/commit/5a6f9488119e3f7457e85d76c4472bcf3ddc8369", "message": "add scope for additional tags option", "committedDate": "2020-11-11T15:34:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQ0NzM4Ng==", "url": "https://github.com/GoogleContainerTools/jib/pull/2890#discussion_r521447386", "bodyText": "Should we also move context, build-file and parameter to Build.java?", "author": "mpeddada1", "createdAt": "2020-11-11T15:41:50Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/cli2/JibCli.java", "diffHunk": "@@ -83,7 +85,8 @@\n       required = true,\n       paramLabel = \"<target-image>\",\n       description =\n-          \"The destination image reference or jib style url,%nexamples:%n gcr.io/project/image,%n registry://image-ref,%n docker://image,%n tar://path\")\n+          \"The destination image reference or jib style url,%nexamples:%n gcr.io/project/image,%n registry://image-ref,%n docker://image,%n tar://path\",\n+      scope = CommandLine.ScopeType.INHERIT)\n   @SuppressWarnings(\"NullAway.Init\") // initialized by picocli\n   private String targetImage;\n ", "originalCommit": "5a6f9488119e3f7457e85d76c4472bcf3ddc8369", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQ2NzI1Ng==", "url": "https://github.com/GoogleContainerTools/jib/pull/2890#discussion_r521467256", "bodyText": "Good question. By parameters, you mean the three hidden parameters? I think they should be shared. And for context and build-file, it makes sense to move to Build.java, since we are not using them in Jar.java at the moment.", "author": "chanseokoh", "createdAt": "2020-11-11T16:10:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQ0NzM4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQ3ODk4Ng==", "url": "https://github.com/GoogleContainerTools/jib/pull/2890#discussion_r521478986", "bodyText": "Sounds good! Oh sorry by parameter, I meant the templating parameter.", "author": "mpeddada1", "createdAt": "2020-11-11T16:27:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQ0NzM4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY5MjkyMg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2890#discussion_r521692922", "bodyText": "I don't think I'll comb through all the options. Just make sure to move options only specific to the build command (like those three) to Build.java.\nBTW, the doc says that INHERIT cannot be used in @ArgGroup, which we have in some places. But I guess it's irrelevant to us?", "author": "chanseokoh", "createdAt": "2020-11-11T23:11:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQ0NzM4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTczMzcxOA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2890#discussion_r521733718", "bodyText": "Ah good point. Applying the INHERIT feature for the @ArgGroup  still seems to be a work in progress. Currently, using INHERIT on the options in the arg group allows those options to be inherited by all the subcommands but it doesn't let the other arg group attributes to be inherited (for example, validation for exclusivity). This might be something that we need when we are handling credentials for the jar and build subcommands. Hm it is probably better to use Mixins for now as support for INHERIT is still a little new.", "author": "mpeddada1", "createdAt": "2020-11-12T00:32:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQ0NzM4Ng=="}], "type": "inlineReview"}, {"oid": "fe2152da77e12777863db5ce3f6f20384c802c09", "url": "https://github.com/GoogleContainerTools/jib/commit/fe2152da77e12777863db5ce3f6f20384c802c09", "message": "wip", "committedDate": "2020-11-18T19:43:04Z", "type": "commit"}, {"oid": "5772850174dc1bd08b4ab7980d0a626469dd05be", "url": "https://github.com/GoogleContainerTools/jib/commit/5772850174dc1bd08b4ab7980d0a626469dd05be", "message": "wip", "committedDate": "2020-11-18T23:38:51Z", "type": "commit"}, {"oid": "8560e2e8283be6f5eb264f9d69cf6e80ed12d6cc", "url": "https://github.com/GoogleContainerTools/jib/commit/8560e2e8283be6f5eb264f9d69cf6e80ed12d6cc", "message": "Move all common options to separate class and create separate tests for build and jar subcommands", "committedDate": "2020-11-19T02:59:36Z", "type": "commit"}, {"oid": "dd673820a1c5449b1292dbb1903dabebc1654734", "url": "https://github.com/GoogleContainerTools/jib/commit/dd673820a1c5449b1292dbb1903dabebc1654734", "message": "Move all common options to separate class and create separate tests for build and jar subcommands", "committedDate": "2020-11-19T03:09:31Z", "type": "commit"}, {"oid": "5da0eab26164897e86e63aa986ba88d1a0c2ebe0", "url": "https://github.com/GoogleContainerTools/jib/commit/5da0eab26164897e86e63aa986ba88d1a0c2ebe0", "message": "add tests for jar subcommand", "committedDate": "2020-11-19T15:38:37Z", "type": "commit"}, {"oid": "92032c90b0fb633f9298abbd819c9a55ffd8d3eb", "url": "https://github.com/GoogleContainerTools/jib/commit/92032c90b0fb633f9298abbd819c9a55ffd8d3eb", "message": "Pull in changes from master", "committedDate": "2020-11-19T15:49:54Z", "type": "commit"}, {"oid": "aceff28d3102b091a2cf767e92fa3af986d8adb9", "url": "https://github.com/GoogleContainerTools/jib/commit/aceff28d3102b091a2cf767e92fa3af986d8adb9", "message": "remove change to build.gradle", "committedDate": "2020-11-19T15:58:43Z", "type": "commit"}, {"oid": "fc35d4f7b3af15031be118f690af6e892a286a66", "url": "https://github.com/GoogleContainerTools/jib/commit/fc35d4f7b3af15031be118f690af6e892a286a66", "message": "remove unused parameter", "committedDate": "2020-11-19T16:03:50Z", "type": "commit"}, {"oid": "1f5ea8093aa3893fc60d5e587920127264be4d5b", "url": "https://github.com/GoogleContainerTools/jib/commit/1f5ea8093aa3893fc60d5e587920127264be4d5b", "message": "pull in changes from master", "committedDate": "2020-11-23T18:22:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzcwMDU4Nw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2890#discussion_r533700587", "bodyText": "Can this be private? Or @VisibleForTesting if required?", "author": "chanseokoh", "createdAt": "2020-12-01T20:28:12Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/cli2/Build.java", "diffHunk": "@@ -38,24 +43,73 @@\n \n   @CommandLine.Spec private CommandSpec spec = CommandSpec.create();\n \n+  @CommandLine.Mixin\n+  @SuppressWarnings(\"NullAway.Init\") // initialized by picocli\n+  CommonCliOptions commonCliOptions;", "originalCommit": "1f5ea8093aa3893fc60d5e587920127264be4d5b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUxMjY5Mw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2890#discussion_r534512693", "bodyText": "Oh yes, thanks for pointing it out.", "author": "mpeddada1", "createdAt": "2020-12-02T22:04:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzcwMDU4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzcwMzAzOQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2890#discussion_r533703039", "bodyText": "Maybe we can remove this field? JibCli doesn't have any options anymore, right?", "author": "chanseokoh", "createdAt": "2020-12-01T20:32:35Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/cli2/Build.java", "diffHunk": "@@ -38,24 +43,73 @@\n \n   @CommandLine.Spec private CommandSpec spec = CommandSpec.create();\n \n+  @CommandLine.Mixin\n+  @SuppressWarnings(\"NullAway.Init\") // initialized by picocli\n+  CommonCliOptions commonCliOptions;\n+\n   @CommandLine.ParentCommand\n   @SuppressWarnings(\"NullAway.Init\") // initialized by picocli\n   protected JibCli globalOptions;", "originalCommit": "1f5ea8093aa3893fc60d5e587920127264be4d5b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUxMjM5MA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2890#discussion_r534512390", "bodyText": "Good catch.", "author": "mpeddada1", "createdAt": "2020-12-02T22:04:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzcwMzAzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzcwMzY3Mw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2890#discussion_r533703673", "bodyText": "commonCliOptions.validate()?", "author": "chanseokoh", "createdAt": "2020-12-01T20:33:51Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/cli2/Build.java", "diffHunk": "@@ -38,24 +43,73 @@\n \n   @CommandLine.Spec private CommandSpec spec = CommandSpec.create();\n \n+  @CommandLine.Mixin\n+  @SuppressWarnings(\"NullAway.Init\") // initialized by picocli\n+  CommonCliOptions commonCliOptions;\n+\n   @CommandLine.ParentCommand\n   @SuppressWarnings(\"NullAway.Init\") // initialized by picocli\n   protected JibCli globalOptions;\n \n+  @CommandLine.Option(\n+      names = {\"-c\", \"--context\"},\n+      defaultValue = \".\",\n+      paramLabel = \"<project-root>\",\n+      description = \"The context root directory of the build (ex: path/to/my/build/things)\")\n+  @SuppressWarnings(\"NullAway.Init\") // initialized by picocli\n+  private Path contextRoot;\n+\n+  @CommandLine.Option(\n+      names = {\"-b\", \"--build-file\"},\n+      paramLabel = \"<build-file>\",\n+      description = \"The path to the build file (ex: path/to/other-jib.yaml)\")\n+  @SuppressWarnings(\"NullAway.Init\") // initialized by picocli\n+  private Path buildFile;\n+\n+  @CommandLine.Option(\n+      names = {\"-p\", \"--parameter\"},\n+      paramLabel = \"<name>=<value>\",\n+      description =\n+          \"templating parameter to inject into build file, replace $${<name>} with <value> (repeatable)\")\n+  @SuppressWarnings(\"NullAway.Init\") // initialized by picocli\n+  private Map<String, String> templateParameters = new HashMap<>();\n+\n+  public Path getContextRoot() {\n+    Verify.verifyNotNull(contextRoot);\n+    return contextRoot;\n+  }\n+\n+  /**\n+   * Returns a user configured Path to a buildfile and if none is configured returns jib.yaml in\n+   * {@link #getContextRoot()}.\n+   *\n+   * @return a path to a bulidfile\n+   */\n+  public Path getBuildFile() {\n+    if (buildFile == null) {\n+      return getContextRoot().resolve(\"jib.yaml\");\n+    }\n+    return buildFile;\n+  }\n+\n+  public Map<String, String> getTemplateParameters() {\n+    Verify.verifyNotNull(templateParameters);\n+    return templateParameters;\n+  }\n+\n   @Override\n   public Integer call() {\n-    globalOptions.validate();\n+    validate();", "originalCommit": "1f5ea8093aa3893fc60d5e587920127264be4d5b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzcwMzg4MA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2890#discussion_r533703880", "bodyText": "No need to duplicate the method if we call commonCliOptions.validate() above?", "author": "chanseokoh", "createdAt": "2020-12-01T20:34:15Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/cli2/Build.java", "diffHunk": "@@ -86,4 +139,14 @@ public Integer call() {\n     }\n     return 0;\n   }\n+\n+  /** Validates parameters defined in this class that could not be done declaratively. */\n+  public void validate() {", "originalCommit": "1f5ea8093aa3893fc60d5e587920127264be4d5b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzcwNDI5OQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2890#discussion_r533704299", "bodyText": "private or @VisibleForTesting?", "author": "chanseokoh", "createdAt": "2020-12-01T20:34:59Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/cli2/Jar.java", "diffHunk": "@@ -41,6 +43,10 @@\n   @SuppressWarnings(\"NullAway.Init\") // initialized by picocli\n   protected JibCli globalOptions;\n \n+  @CommandLine.Mixin\n+  @SuppressWarnings(\"NullAway.Init\") // initialized by picocli\n+  CommonCliOptions commonCliOptions;", "originalCommit": "1f5ea8093aa3893fc60d5e587920127264be4d5b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzcwNDQzMw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2890#discussion_r533704433", "bodyText": "ditto?", "author": "chanseokoh", "createdAt": "2020-12-01T20:35:11Z", "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/cli2/Jar.java", "diffHunk": "@@ -97,4 +103,14 @@ public Integer call() {\n     }\n     return 0;\n   }\n+\n+  /** Validates parameters defined in this class that could not be done declaratively. */\n+  public void validate() {", "originalCommit": "1f5ea8093aa3893fc60d5e587920127264be4d5b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e1d711576e3f18e939c4ad638605e91bf3dc4bfa", "url": "https://github.com/GoogleContainerTools/jib/commit/e1d711576e3f18e939c4ad638605e91bf3dc4bfa", "message": "Simplify test code", "committedDate": "2020-12-01T21:35:25Z", "type": "commit"}, {"oid": "f50f0a1f1430db2750c1a49a368882d424224a32", "url": "https://github.com/GoogleContainerTools/jib/commit/f50f0a1f1430db2750c1a49a368882d424224a32", "message": "adding VisibleForTesting and moving validate to commonclioptions", "committedDate": "2020-12-02T22:03:14Z", "type": "commit"}, {"oid": "1073046d9406d3f01298d7ffba2b6d2b38df3bcf", "url": "https://github.com/GoogleContainerTools/jib/commit/1073046d9406d3f01298d7ffba2b6d2b38df3bcf", "message": "pull in changes from remote", "committedDate": "2020-12-02T22:07:05Z", "type": "commit"}]}