{"pr_number": 2402, "pr_title": "Respect DOCKER_CONFIG environment variable when finding credentials", "pr_createdAt": "2020-04-14T15:55:18Z", "pr_url": "https://github.com/GoogleContainerTools/jib/pull/2402", "timeline": [{"oid": "89ef61fb56930af7d35be05c5ff114d5995672e7", "url": "https://github.com/GoogleContainerTools/jib/commit/89ef61fb56930af7d35be05c5ff114d5995672e7", "message": "Respect DOCKER_CONFIG environment variable when finding credentials", "committedDate": "2020-04-14T15:53:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1MDExMA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2402#discussion_r408250110", "bodyText": "should \".docker\" be a const?", "author": "loosebazooka", "createdAt": "2020-04-14T15:57:12Z", "path": "jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/DefaultCredentialRetrievers.java", "diffHunk": "@@ -166,10 +166,23 @@ public DefaultCredentialRetrievers setCredentialHelper(@Nullable String credenti\n       credentialRetrievers.add(inferredCredentialRetriever);\n     }\n \n+    String dockerConfigEnv = environment.get(\"DOCKER_CONFIG\");\n+    if (dockerConfigEnv != null) {\n+      Path dockerConfigsPath = Paths.get(dockerConfigEnv);\n+      credentialRetrievers.add(\n+          credentialRetrieverFactory.dockerConfig(dockerConfigsPath.resolve(DOCKER_CONFIG_FILE)));\n+      credentialRetrievers.add(\n+          credentialRetrieverFactory.dockerConfig(\n+              dockerConfigsPath.resolve(KUBERNETES_DOCKER_CONFIG_FILE)));\n+      credentialRetrievers.add(\n+          credentialRetrieverFactory.legacyDockerConfig(\n+              dockerConfigsPath.resolve(LEGACY_DOCKER_CONFIG_FILE)));\n+    }\n+\n     String homeProperty = systemProperties.getProperty(\"user.home\");\n     String homeEnvVar = environment.get(\"HOME\");\n     if (homeProperty != null) {\n-      Path home = Paths.get(homeProperty);\n+      Path home = Paths.get(homeProperty).resolve(\".docker\");", "originalCommit": "89ef61fb56930af7d35be05c5ff114d5995672e7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1MjAzNA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2402#discussion_r408252034", "bodyText": "can we share this code by determining the dockerConfigsPath once by analyzing:\n\ndockerConfigEvn\nhomeProperty\nhomeEnvVar\n\nand then run this block of code for the value of dockerConfigsPath?", "author": "loosebazooka", "createdAt": "2020-04-14T15:59:48Z", "path": "jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/DefaultCredentialRetrievers.java", "diffHunk": "@@ -166,10 +166,23 @@ public DefaultCredentialRetrievers setCredentialHelper(@Nullable String credenti\n       credentialRetrievers.add(inferredCredentialRetriever);\n     }\n \n+    String dockerConfigEnv = environment.get(\"DOCKER_CONFIG\");\n+    if (dockerConfigEnv != null) {\n+      Path dockerConfigsPath = Paths.get(dockerConfigEnv);\n+      credentialRetrievers.add(\n+          credentialRetrieverFactory.dockerConfig(dockerConfigsPath.resolve(DOCKER_CONFIG_FILE)));\n+      credentialRetrievers.add(\n+          credentialRetrieverFactory.dockerConfig(\n+              dockerConfigsPath.resolve(KUBERNETES_DOCKER_CONFIG_FILE)));\n+      credentialRetrievers.add(\n+          credentialRetrieverFactory.legacyDockerConfig(\n+              dockerConfigsPath.resolve(LEGACY_DOCKER_CONFIG_FILE)));", "originalCommit": "89ef61fb56930af7d35be05c5ff114d5995672e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1NTY2Ng==", "url": "https://github.com/GoogleContainerTools/jib/pull/2402#discussion_r408255666", "bodyText": "I could pull some of this out into a helper method probably, but I think we do want to add all 9 paths to the credential retriever list, since we want to fall back to as many options as possible if retrieving the credentials fails on one source.", "author": "TadCordle", "createdAt": "2020-04-14T16:04:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1MjAzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1ODgwNA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2402#discussion_r408258804", "bodyText": "oh yeah you're right, I didn't realize we could add them all.", "author": "loosebazooka", "createdAt": "2020-04-14T16:09:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1MjAzNA=="}], "type": "inlineReview"}, {"oid": "990b22ade8aa257ca76a0232232b3e27eb45f3db", "url": "https://github.com/GoogleContainerTools/jib/commit/990b22ade8aa257ca76a0232232b3e27eb45f3db", "message": "Changelog", "committedDate": "2020-04-14T16:01:21Z", "type": "commit"}, {"oid": "cd2b5819efd4eaaff7ffca502d9a94fa78da6d5f", "url": "https://github.com/GoogleContainerTools/jib/commit/cd2b5819efd4eaaff7ffca502d9a94fa78da6d5f", "message": "Code compression", "committedDate": "2020-04-14T16:11:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI2Nzk3NQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2402#discussion_r408267975", "bodyText": "How about elaborate on this to message that DOCKER_CONFIG should be a directory containing a Docker config file?", "author": "chanseokoh", "createdAt": "2020-04-14T16:22:34Z", "path": "jib-gradle-plugin/CHANGELOG.md", "diffHunk": "@@ -7,6 +7,7 @@ All notable changes to this project will be documented in this file.\n \n - Glob pattern support for `jib.extraDirectories.permissions`. ([#1200](https://github.com/GoogleContainerTools/jib/issues/1200))\n - Support for image references with both a tag and a digest. ([#1481](https://github.com/GoogleContainerTools/jib/issues/1481))\n+- The `DOCKER_CONFIG` environment variable is now checked for retrieving credentials from the docker config. ([#1618](https://github.com/GoogleContainerTools/jib/issues/1618))", "originalCommit": "cd2b5819efd4eaaff7ffca502d9a94fa78da6d5f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI3NTI4OA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2402#discussion_r408275288", "bodyText": "Do you think it's worth avoiding duplicates by checking if Paths.get(homeProperty).resolve(DOCKER_DIRECTORY) is same as Paths.get(dockerConfigEnv)? Or not? We've been comparing homeEnvVar and homeProperty. I just want some consistency for future readers of the code who might assume there is a reason for the inconsistency.", "author": "chanseokoh", "createdAt": "2020-04-14T16:32:54Z", "path": "jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/DefaultCredentialRetrievers.java", "diffHunk": "@@ -166,29 +166,33 @@ public DefaultCredentialRetrievers setCredentialHelper(@Nullable String credenti\n       credentialRetrievers.add(inferredCredentialRetriever);\n     }\n \n+    String dockerConfigEnv = environment.get(\"DOCKER_CONFIG\");\n+    if (dockerConfigEnv != null) {\n+      addDockerFiles(credentialRetrievers, Paths.get(dockerConfigEnv));\n+    }\n+\n     String homeProperty = systemProperties.getProperty(\"user.home\");\n-    String homeEnvVar = environment.get(\"HOME\");\n     if (homeProperty != null) {", "originalCommit": "cd2b5819efd4eaaff7ffca502d9a94fa78da6d5f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI5OTUyNw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2402#discussion_r408299527", "bodyText": "I think we can do it. It adds a little extra complexity but it's still straightforward enough.", "author": "TadCordle", "createdAt": "2020-04-14T17:10:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI3NTI4OA=="}], "type": "inlineReview"}, {"oid": "7855ef3e0ac3cd958f6ee4a3d619ff28d23a4630", "url": "https://github.com/GoogleContainerTools/jib/commit/7855ef3e0ac3cd958f6ee4a3d619ff28d23a4630", "message": "Feedback", "committedDate": "2020-04-14T17:24:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM4ODY1NA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2402#discussion_r408388654", "bodyText": "With checkedDockerDirs, I think this can be just if (homeEnvVar) {?", "author": "chanseokoh", "createdAt": "2020-04-14T19:40:41Z", "path": "jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/DefaultCredentialRetrievers.java", "diffHunk": "@@ -166,29 +166,43 @@ public DefaultCredentialRetrievers setCredentialHelper(@Nullable String credenti\n       credentialRetrievers.add(inferredCredentialRetriever);\n     }\n \n+    List<Path> checkedDockerDirs = new ArrayList<>();\n+    String dockerConfigEnv = environment.get(\"DOCKER_CONFIG\");\n+    if (dockerConfigEnv != null) {\n+      Path dockerConfigEnvPath = Paths.get(dockerConfigEnv);\n+      addDockerFiles(credentialRetrievers, Paths.get(dockerConfigEnv));\n+      checkedDockerDirs.add(dockerConfigEnvPath);\n+    }\n+\n     String homeProperty = systemProperties.getProperty(\"user.home\");\n-    String homeEnvVar = environment.get(\"HOME\");\n     if (homeProperty != null) {\n-      Path home = Paths.get(homeProperty);\n-      credentialRetrievers.add(\n-          credentialRetrieverFactory.dockerConfig(home.resolve(DOCKER_CONFIG_FILE)));\n-      credentialRetrievers.add(\n-          credentialRetrieverFactory.dockerConfig(home.resolve(KUBERNETES_DOCKER_CONFIG_FILE)));\n-      credentialRetrievers.add(\n-          credentialRetrieverFactory.legacyDockerConfig(home.resolve(LEGACY_DOCKER_CONFIG_FILE)));\n+      Path homePropertyPath = Paths.get(homeProperty).resolve(DOCKER_DIRECTORY);\n+      if (!checkedDockerDirs.contains(homePropertyPath)) {\n+        addDockerFiles(credentialRetrievers, homePropertyPath);\n+        checkedDockerDirs.add(homePropertyPath);\n+      }\n     }\n+\n+    String homeEnvVar = environment.get(\"HOME\");\n     if (homeEnvVar != null && !homeEnvVar.equals(homeProperty)) {", "originalCommit": "7855ef3e0ac3cd958f6ee4a3d619ff28d23a4630", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bf33b16816333d9a45d1c1bddb2d228fe5e4923d", "url": "https://github.com/GoogleContainerTools/jib/commit/bf33b16816333d9a45d1c1bddb2d228fe5e4923d", "message": "Fix", "committedDate": "2020-04-14T19:59:22Z", "type": "commit"}]}