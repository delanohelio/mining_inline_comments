{"pr_number": 2461, "pr_title": "Add gradle extra directory target configuration", "pr_createdAt": "2020-05-11T18:02:51Z", "pr_url": "https://github.com/GoogleContainerTools/jib/pull/2461", "timeline": [{"oid": "7dafaba3499d74891e3e00a26f6a0439232fa007", "url": "https://github.com/GoogleContainerTools/jib/commit/7dafaba3499d74891e3e00a26f6a0439232fa007", "message": "Progress", "committedDate": "2020-05-08T20:07:32Z", "type": "commit"}, {"oid": "b415e79fd030a281abdb4faef81a78cd07b454ca", "url": "https://github.com/GoogleContainerTools/jib/commit/b415e79fd030a281abdb4faef81a78cd07b454ca", "message": "Fix unit tests", "committedDate": "2020-05-11T17:25:30Z", "type": "commit"}, {"oid": "18e88f6e11e4754e0d4c7f47c28761b38207a1fa", "url": "https://github.com/GoogleContainerTools/jib/commit/18e88f6e11e4754e0d4c7f47c28761b38207a1fa", "message": "Changelog", "committedDate": "2020-05-11T17:28:27Z", "type": "commit"}, {"oid": "f916256cd2dea85787550056bf146585108ce6b5", "url": "https://github.com/GoogleContainerTools/jib/commit/f916256cd2dea85787550056bf146585108ce6b5", "message": "Add integration test", "committedDate": "2020-05-11T17:53:46Z", "type": "commit"}, {"oid": "4d34609426984423e9a20ba7bdeb57023d9231fc", "url": "https://github.com/GoogleContainerTools/jib/commit/4d34609426984423e9a20ba7bdeb57023d9231fc", "message": "Validate from configured", "committedDate": "2020-05-11T18:14:08Z", "type": "commit"}, {"oid": "786f52de7a57289ba1acf085a41746353e6b5ae4", "url": "https://github.com/GoogleContainerTools/jib/commit/786f52de7a57289ba1acf085a41746353e6b5ae4", "message": "Unnecessary absolute file", "committedDate": "2020-05-11T18:17:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM2NjQ2Nw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2461#discussion_r423366467", "bodyText": "Instead of providing the default here, I think we can initialize paths to src/main/jib in the constructor. (I have never tried this though.)\n-    paths = project.getObjects().listProperty(ExtraDirectoryParameters.class).empty();\n+    paths = project.getObjects().listProperty(ExtraDirectoryParameters.class);\n+    paths.set(Collections.singletonList(new ExtraDirectoryParameters(...)));", "author": "chanseokoh", "createdAt": "2020-05-11T22:57:58Z", "path": "jib-gradle-plugin/src/main/java/com/google/cloud/tools/jib/gradle/ExtraDirectoriesParameters.java", "diffHunk": "@@ -35,34 +37,51 @@\n \n   private final Project project;\n \n-  private List<Path> paths;\n+  private ListProperty<ExtraDirectoryParameters> paths;\n+  private ExtraDirectoryParametersSpec spec;\n   private Map<String, String> permissions = Collections.emptyMap();\n \n   @Inject\n   public ExtraDirectoriesParameters(Project project) {\n     this.project = project;\n-    paths =\n-        Collections.singletonList(\n-            project.getProjectDir().toPath().resolve(\"src\").resolve(\"main\").resolve(\"jib\"));\n+    paths = project.getObjects().listProperty(ExtraDirectoryParameters.class).empty();\n+    spec = project.getObjects().newInstance(ExtraDirectoryParametersSpec.class, project, paths);\n+  }\n+\n+  public void paths(Action<? super ExtraDirectoryParametersSpec> action) {\n+    action.execute(spec);\n   }\n \n   @Input\n   public List<String> getPathStrings() {\n     // Gradle warns about @Input annotations on File objects, so we have to expose a getter for a\n     // String to make them go away.\n-    return getPaths().stream().map(Path::toString).collect(Collectors.toList());\n+    return getPaths()\n+        .stream()\n+        .map(extraDirectoryParameters -> extraDirectoryParameters.getFrom().toString())\n+        .collect(Collectors.toList());\n   }\n \n   @Internal\n-  public List<Path> getPaths() {\n+  public List<ExtraDirectoryParameters> getPaths() {\n     // Gradle warns about @Input annotations on File objects, so we have to expose a getter for a\n     // String to make them go away.\n     String property = System.getProperty(PropertyNames.EXTRA_DIRECTORIES_PATHS);\n     if (property != null) {\n       List<String> pathStrings = ConfigurationPropertyValidator.parseListProperty(property);\n-      return pathStrings.stream().map(Paths::get).collect(Collectors.toList());\n+      return pathStrings\n+          .stream()\n+          .map(path -> new ExtraDirectoryParameters(project, Paths.get(path), \"/\"))\n+          .collect(Collectors.toList());\n     }\n-    return paths;\n+    if (paths.get().isEmpty()) {", "originalCommit": "786f52de7a57289ba1acf085a41746353e6b5ae4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg5Mzg5Mg==", "url": "https://github.com/GoogleContainerTools/jib/pull/2461#discussion_r423893892", "bodyText": "The reason I did it this way was because, if this is set in the constructor, calls to jib.extraDirectories.paths { path {...} } will end up adding paths along with src/main/jib instead of replacing the default.", "author": "TadCordle", "createdAt": "2020-05-12T17:04:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM2NjQ2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg5Nzk2NA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2461#discussion_r423897964", "bodyText": "I guess maybe I can reset this in ExtraDirectoryParametersSpec. Nevermind, that would overwrite previous path {...} entries if someone configured multiple.", "author": "TadCordle", "createdAt": "2020-05-12T17:10:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM2NjQ2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk1MDg2NA==", "url": "https://github.com/GoogleContainerTools/jib/pull/2461#discussion_r423950864", "bodyText": "will end up adding paths along with src/main/jib\n\nAha, good catch.", "author": "chanseokoh", "createdAt": "2020-05-12T18:37:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM2NjQ2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM2NzIzNw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2461#discussion_r423367237", "bodyText": "Instead of recreating an empty list, I think you can call paths.set()?", "author": "chanseokoh", "createdAt": "2020-05-11T23:00:16Z", "path": "jib-gradle-plugin/src/main/java/com/google/cloud/tools/jib/gradle/ExtraDirectoriesParameters.java", "diffHunk": "@@ -72,8 +91,12 @@ public ExtraDirectoriesParameters(Project project) {\n    * @param paths paths to set.\n    */\n   public void setPaths(Object paths) {\n-    this.paths =\n+    List<Path> froms =\n         project.files(paths).getFiles().stream().map(File::toPath).collect(Collectors.toList());\n+    this.paths = project.getObjects().listProperty(ExtraDirectoryParameters.class).empty();", "originalCommit": "786f52de7a57289ba1acf085a41746353e6b5ae4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3d74cc5b746892f1ce217da813dbe74b9645fbca", "url": "https://github.com/GoogleContainerTools/jib/commit/3d74cc5b746892f1ce217da813dbe74b9645fbca", "message": "Use paths.set", "committedDate": "2020-05-12T17:12:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk1MjUyNQ==", "url": "https://github.com/GoogleContainerTools/jib/pull/2461#discussion_r423952525", "bodyText": "Can this be\nproject.files(paths).getFiles().stream().map(file -> new ExtraDirectoryParameters(project, file.toPath(), \"/\")).collect(Collectors.toList());\n?", "author": "chanseokoh", "createdAt": "2020-05-12T18:40:36Z", "path": "jib-gradle-plugin/src/main/java/com/google/cloud/tools/jib/gradle/ExtraDirectoriesParameters.java", "diffHunk": "@@ -72,8 +91,13 @@ public ExtraDirectoriesParameters(Project project) {\n    * @param paths paths to set.\n    */\n   public void setPaths(Object paths) {\n-    this.paths =\n+    List<Path> froms =", "originalCommit": "3d74cc5b746892f1ce217da813dbe74b9645fbca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk1Mzk0Mw==", "url": "https://github.com/GoogleContainerTools/jib/pull/2461#discussion_r423953943", "bodyText": "Instead of initializing here, how about initializing them in the field definitions? Other ...Parameters follow this convention. This also ensures they are always initialized even when using a potentially different constructor.", "author": "chanseokoh", "createdAt": "2020-05-12T18:42:59Z", "path": "jib-gradle-plugin/src/main/java/com/google/cloud/tools/jib/gradle/ExtraDirectoryParameters.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package com.google.cloud.tools.jib.gradle;\n+\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import javax.inject.Inject;\n+import org.gradle.api.Project;\n+import org.gradle.api.tasks.Input;\n+import org.gradle.api.tasks.Internal;\n+\n+/** Configuration of an extra directory. */\n+public class ExtraDirectoryParameters {\n+\n+  private Project project;\n+  private Path from;\n+  private String into;\n+\n+  @Inject\n+  public ExtraDirectoryParameters(Project project) {\n+    this.project = project;\n+    from = Paths.get(\"\");\n+    into = \"/\";", "originalCommit": "3d74cc5b746892f1ce217da813dbe74b9645fbca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "df0c1bc23436ed28c348606681106a3f2d5f07cd", "url": "https://github.com/GoogleContainerTools/jib/commit/df0c1bc23436ed28c348606681106a3f2d5f07cd", "message": "Feedback", "committedDate": "2020-05-12T21:15:51Z", "type": "commit"}]}