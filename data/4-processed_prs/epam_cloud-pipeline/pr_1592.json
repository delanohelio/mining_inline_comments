{"pr_number": 1592, "pr_title": "Issue #1404: Implemented tests for IssueApiService", "pr_createdAt": "2020-11-23T12:55:57Z", "pr_url": "https://github.com/epam/cloud-pipeline/pull/1592", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTYzMjk4Ng==", "url": "https://github.com/epam/cloud-pipeline/pull/1592#discussion_r529632986", "bodyText": "Let's put it somewhere else. Probably SecurityCreatorUtils is nice place to move it.", "author": "tcibinan", "createdAt": "2020-11-24T15:26:43Z", "path": "api/src/test/java/com/epam/pipeline/test/creator/issue/IssueCreatorUtils.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.test.creator.issue;\n+\n+import com.epam.pipeline.controller.vo.EntityVO;\n+import com.epam.pipeline.controller.vo.IssueCommentVO;\n+import com.epam.pipeline.controller.vo.IssueVO;\n+import com.epam.pipeline.entity.issue.Issue;\n+import com.epam.pipeline.entity.issue.IssueComment;\n+import com.epam.pipeline.entity.security.acl.AclClass;\n+\n+public final class IssueCreatorUtils {\n+\n+    private IssueCreatorUtils() {\n+\n+    }\n+\n+    public static EntityVO getEntityVO(final Long id, final AclClass aclClass) {", "originalCommit": "fc04a5a4c9a3dcda90a71cf71ec2bdcca0b89bcd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE3MzI0NA==", "url": "https://github.com/epam/cloud-pipeline/pull/1592#discussion_r530173244", "bodyText": "Could you please delete all the test cases in the class that is covered by the new test class?\nAdditionally check if the remaining test cases (probably only testIssueOwnerCRUD) are covered by IssueManagerTest. If not please try to migrate the remaining methods to IssueManagerTest.", "author": "tcibinan", "createdAt": "2020-11-25T08:04:20Z", "path": "api/src/test/java/com/epam/pipeline/manager/issue/IssueApiServiceTest.java", "diffHunk": "@@ -16,6 +16,7 @@\n ", "originalCommit": "fc04a5a4c9a3dcda90a71cf71ec2bdcca0b89bcd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE3NTkxOA==", "url": "https://github.com/epam/cloud-pipeline/pull/1592#discussion_r530175918", "bodyText": "Let's change the filed's type and name to something more common like AbstractSecuredEntity entity. This way we declare that any entity can be used not only s3 storages.", "author": "tcibinan", "createdAt": "2020-11-25T08:09:26Z", "path": "api/src/test/java/com/epam/pipeline/acl/issue/IssueApiServiceTest.java", "diffHunk": "@@ -0,0 +1,329 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.issue;\n+\n+import com.epam.pipeline.controller.vo.EntityVO;\n+import com.epam.pipeline.controller.vo.IssueCommentVO;\n+import com.epam.pipeline.controller.vo.IssueVO;\n+import com.epam.pipeline.entity.datastorage.aws.S3bucketDataStorage;\n+import com.epam.pipeline.entity.issue.Issue;\n+import com.epam.pipeline.entity.issue.IssueComment;\n+import com.epam.pipeline.entity.security.acl.AclClass;\n+import com.epam.pipeline.manager.EntityManager;\n+import com.epam.pipeline.manager.issue.IssueManager;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.datastorage.DatastorageCreatorUtils;\n+import com.epam.pipeline.test.creator.issue.IssueCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID;\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class IssueApiServiceTest extends AbstractAclTest {\n+\n+    private final EntityVO entityVO = IssueCreatorUtils.getEntityVO(ID, AclClass.DATA_STORAGE);\n+    private final Issue issue = IssueCreatorUtils.getIssue(entityVO, SIMPLE_USER);\n+    private final IssueVO issueVO = IssueCreatorUtils.getIssueVO(entityVO);\n+    private final S3bucketDataStorage s3bucket = DatastorageCreatorUtils.getS3bucketDataStorage(ID, OWNER_USER);", "originalCommit": "fc04a5a4c9a3dcda90a71cf71ec2bdcca0b89bcd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE3NjYwNg==", "url": "https://github.com/epam/cloud-pipeline/pull/1592#discussion_r530176606", "bodyText": "Similarly let's extract the acl class to a field and refer to it as just ACL_CLASS or ENTITY_ACL_CLASS.", "author": "tcibinan", "createdAt": "2020-11-25T08:10:38Z", "path": "api/src/test/java/com/epam/pipeline/acl/issue/IssueApiServiceTest.java", "diffHunk": "@@ -0,0 +1,329 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.issue;\n+\n+import com.epam.pipeline.controller.vo.EntityVO;\n+import com.epam.pipeline.controller.vo.IssueCommentVO;\n+import com.epam.pipeline.controller.vo.IssueVO;\n+import com.epam.pipeline.entity.datastorage.aws.S3bucketDataStorage;\n+import com.epam.pipeline.entity.issue.Issue;\n+import com.epam.pipeline.entity.issue.IssueComment;\n+import com.epam.pipeline.entity.security.acl.AclClass;\n+import com.epam.pipeline.manager.EntityManager;\n+import com.epam.pipeline.manager.issue.IssueManager;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.datastorage.DatastorageCreatorUtils;\n+import com.epam.pipeline.test.creator.issue.IssueCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID;\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class IssueApiServiceTest extends AbstractAclTest {\n+\n+    private final EntityVO entityVO = IssueCreatorUtils.getEntityVO(ID, AclClass.DATA_STORAGE);\n+    private final Issue issue = IssueCreatorUtils.getIssue(entityVO, SIMPLE_USER);\n+    private final IssueVO issueVO = IssueCreatorUtils.getIssueVO(entityVO);\n+    private final S3bucketDataStorage s3bucket = DatastorageCreatorUtils.getS3bucketDataStorage(ID, OWNER_USER);\n+    private final List<Issue> issueList = Collections.singletonList(issue);\n+    private final IssueComment issueComment = IssueCreatorUtils.getIssueComment(SIMPLE_USER);\n+    private final IssueCommentVO issueCommentVO = IssueCreatorUtils.getIssueCommentVO();\n+\n+    @Autowired\n+    private IssueApiService issueApiService;\n+\n+    @Autowired\n+    private IssueManager mockIssueManager;\n+\n+    @Autowired\n+    private EntityManager mockEntityManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldCreateIssueForAdmin() {\n+        doReturn(issue).when(mockIssueManager).createIssue(issueVO);\n+\n+        assertThat(issueApiService.createIssue(issueVO)).isEqualTo(issue);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldCreateIssueWhenPermissionIsGranted() {\n+        initAclEntity(s3bucket, AclPermission.READ);\n+        doReturn(issue).when(mockIssueManager).createIssue(issueVO);\n+        doReturn(s3bucket).when(mockEntityManager).load(AclClass.DATA_STORAGE, ID);", "originalCommit": "fc04a5a4c9a3dcda90a71cf71ec2bdcca0b89bcd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg5ODE4MA==", "url": "https://github.com/epam/cloud-pipeline/pull/1592#discussion_r530898180", "bodyText": "Please rename the field to entity as well.", "author": "tcibinan", "createdAt": "2020-11-26T09:44:44Z", "path": "api/src/test/java/com/epam/pipeline/acl/issue/IssueApiServiceTest.java", "diffHunk": "@@ -39,16 +41,19 @@\n import java.util.List;\n \n import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_INT;\n import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Mockito.doReturn;\n \n public class IssueApiServiceTest extends AbstractAclTest {\n \n-    private final EntityVO entityVO = IssueCreatorUtils.getEntityVO(ID, AclClass.DATA_STORAGE);\n+    private static final AclClass ENTITY_ACL_CLASS = AclClass.DATA_STORAGE;\n+\n+    private final EntityVO entityVO = SecurityCreatorUtils.getEntityVO(ID, ENTITY_ACL_CLASS);\n     private final Issue issue = IssueCreatorUtils.getIssue(entityVO, SIMPLE_USER);\n     private final IssueVO issueVO = IssueCreatorUtils.getIssueVO(entityVO);\n-    private final S3bucketDataStorage s3bucket = DatastorageCreatorUtils.getS3bucketDataStorage(ID, OWNER_USER);\n+    private final AbstractSecuredEntity s3bucket = DatastorageCreatorUtils.getS3bucketDataStorage(ID, OWNER_USER);", "originalCommit": "58e9181efa24d5cf47bcdf5ab66982c4fc71ffd6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDkwMDk3Nw==", "url": "https://github.com/epam/cloud-pipeline/pull/1592#discussion_r530900977", "bodyText": "Please extract the pagedResult field and add line break between mocking and asserting.", "author": "tcibinan", "createdAt": "2020-11-26T09:49:02Z", "path": "api/src/test/java/com/epam/pipeline/acl/issue/IssueApiServiceTest.java", "diffHunk": "@@ -326,4 +331,12 @@ public void shouldDenyDeleteCommentWhenPermissionIsNotGranted() {\n \n         assertThrows(AccessDeniedException.class, () -> issueApiService.deleteComment(ID, ID));\n     }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldLoadMyPagedResultListIssue() {\n+        final PagedResult<List<Issue>> pagedResult = IssueCreatorUtils.getPagedListIssue();\n+        doReturn(pagedResult).when(mockIssueManager).loadMy(ID, TEST_INT);\n+        assertThat(issueApiService.loadMy(ID, TEST_INT)).isEqualTo(pagedResult);", "originalCommit": "58e9181efa24d5cf47bcdf5ab66982c4fc71ffd6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDkwNjYyMw==", "url": "https://github.com/epam/cloud-pipeline/pull/1592#discussion_r530906623", "bodyText": "These tests basically don't check anything. It looks like the proper place for them is AttachmentFileManagerTest. But the tests should be rewritten without Spring being used. See other tests in AttachmentFileManagerTest.", "author": "tcibinan", "createdAt": "2020-11-26T09:57:12Z", "path": "api/src/test/java/com/epam/pipeline/manager/issue/IssueManagerTest.java", "diffHunk": "@@ -410,6 +417,22 @@ public void updateCommentWithAttachments() throws InterruptedException {\n                                                                             Mockito.anyList(), Mockito.anyBoolean());\n     }\n \n+    @Test(expected = AccessDeniedException.class)\n+    @Transactional(propagation = Propagation.REQUIRES_NEW, rollbackFor = Throwable.class)\n+    @WithMockUser(username = TEST_USER)\n+    public void testDeleteAttachmentFail() {\n+        attachmentFileManager.deleteAttachment(testAttachment.getId());\n+    }\n+\n+    @Test\n+    @Transactional(propagation = Propagation.REQUIRES_NEW, rollbackFor = Throwable.class)\n+    @WithMockUser(username = AUTHOR)\n+    public void testDeleteAttachment() {\n+        final AttachmentFileManager mockAttachmentFileManager = mock(AttachmentFileManager.class);\n+        mockAttachmentFileManager.deleteAttachment(testAttachment.getId());\n+        verify(mockAttachmentFileManager).deleteAttachment(testAttachment.getId());\n+    }\n+", "originalCommit": "58e9181efa24d5cf47bcdf5ab66982c4fc71ffd6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQ1MDUwOQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1592#discussion_r532450509", "bodyText": "It looks like the test only checks if admin is able to delete the attachment. At the same time if we look at the original test it tests the behavior for an attachment owner. In order to be sure that we test the same functionality and even more we should cover the lost test scenario.\nLet's keep the test but add another one with attachment deletion for attachment owner.", "author": "tcibinan", "createdAt": "2020-11-30T09:23:49Z", "path": "api/src/test/java/com/epam/pipeline/manager/issue/AttachmentFileManagerTest.java", "diffHunk": "@@ -130,4 +134,18 @@ public void testDownloadAttachment() {\n         verify(attachmentManager).load(1L);\n         verify(dataStorageManager).getStreamingContent(testSystemDataStorage.getId(), TEST_ATTACHMENT_PATH, null);\n     }\n+\n+    @Test\n+    public void testDeleteAttachment() {\n+        doReturn(true).when(authManager).isAdmin();\n+\n+        attachmentFileManager.deleteAttachment(anyLong());\n+\n+        verify(attachmentManager).load(anyLong());\n+    }", "originalCommit": "c8389a01ac303e8bf31983b442afe17df42c91ed", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a24997a2e68fc877ee519e26d450384fb371f067", "url": "https://github.com/epam/cloud-pipeline/commit/a24997a2e68fc877ee519e26d450384fb371f067", "message": "Issue #1404: Implemented tests for IssueApiService\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-12-08T09:22:27Z", "type": "commit"}, {"oid": "83af8761f311cf5dace8eb48c4dcd1d2f65a6240", "url": "https://github.com/epam/cloud-pipeline/commit/83af8761f311cf5dace8eb48c4dcd1d2f65a6240", "message": "Issue #1405: Improvements and fixes in accordance with comments\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-12-08T09:23:54Z", "type": "commit"}, {"oid": "385e84ad66a24c48e5c986aa29f7f65debfbef1a", "url": "https://github.com/epam/cloud-pipeline/commit/385e84ad66a24c48e5c986aa29f7f65debfbef1a", "message": "Issue #1404: Minor fixes, two tests replaced\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-12-08T09:23:55Z", "type": "commit"}, {"oid": "f9161b48a533fb0cd9b2bdf0ff71efd314544158", "url": "https://github.com/epam/cloud-pipeline/commit/f9161b48a533fb0cd9b2bdf0ff71efd314544158", "message": "Issue #1404: One more test added to the AttachmentFileManagerTest\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-12-08T09:23:55Z", "type": "commit"}, {"oid": "8ffd497871223d311c8318fb2bc38a09d06af391", "url": "https://github.com/epam/cloud-pipeline/commit/8ffd497871223d311c8318fb2bc38a09d06af391", "message": "Issue #1404: Branch rebased, merge conflicts resolved\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-12-08T09:39:24Z", "type": "commit"}, {"oid": "8ffd497871223d311c8318fb2bc38a09d06af391", "url": "https://github.com/epam/cloud-pipeline/commit/8ffd497871223d311c8318fb2bc38a09d06af391", "message": "Issue #1404: Branch rebased, merge conflicts resolved\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-12-08T09:39:24Z", "type": "forcePushed"}]}