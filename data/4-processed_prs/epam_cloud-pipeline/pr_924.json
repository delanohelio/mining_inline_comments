{"pr_number": 924, "pr_title": "Issue #857 Historical resources utilization: reports", "pr_createdAt": "2020-01-29T11:46:16Z", "pr_url": "https://github.com/epam/cloud-pipeline/pull/924", "timeline": [{"oid": "9b8d857cfd17cad3078be0120f6714e79d79a024", "url": "https://github.com/epam/cloud-pipeline/commit/9b8d857cfd17cad3078be0120f6714e79d79a024", "message": "Issue #857 MonitoringStatsWriter implementation", "committedDate": "2020-01-29T10:56:55Z", "type": "commit"}, {"oid": "e2efefddfb3b9f6acffee19334f854d7f45f6e16", "url": "https://github.com/epam/cloud-pipeline/commit/e2efefddfb3b9f6acffee19334f854d7f45f6e16", "message": "Issue #857 Export implementation (1): provide necessary changes in controller and underlying layers, implement required method for ESMonitoringManager", "committedDate": "2020-01-29T10:57:11Z", "type": "commit"}, {"oid": "5e7e9e857e2c05329abff936df17c627807caf9c", "url": "https://github.com/epam/cloud-pipeline/commit/5e7e9e857e2c05329abff936df17c627807caf9c", "message": "Issue #857 Refactoring: CAdvisor exception message, adjust requested report interval", "committedDate": "2020-01-29T11:43:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzM5OTk4MA==", "url": "https://github.com/epam/cloud-pipeline/pull/924#discussion_r373399980", "bodyText": "Name in the PreAuthorize section must match argument name: #nodeName -> #name", "author": "mzueva", "createdAt": "2020-01-31T10:01:33Z", "path": "api/src/main/java/com/epam/pipeline/manager/cluster/ClusterApiService.java", "diffHunk": "@@ -74,6 +76,12 @@ public NodeInstance terminateNode(String name) {\n         return usageMonitoringManager.getStatsForNode(nodeName, from, to);\n     }\n \n+    @PreAuthorize(\"hasRole('ADMIN') OR @grantPermissionManager.nodePermission(#nodeName, 'READ')\")", "originalCommit": "5e7e9e857e2c05329abff936df17c627807caf9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ3MDY3OQ==", "url": "https://github.com/epam/cloud-pipeline/pull/924#discussion_r373470679", "bodyText": "Done", "author": "Wedds", "createdAt": "2020-01-31T13:08:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzM5OTk4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQwMDk4MQ==", "url": "https://github.com/epam/cloud-pipeline/pull/924#discussion_r373400981", "bodyText": "Move error message to MessageConstants", "author": "mzueva", "createdAt": "2020-01-31T10:03:52Z", "path": "api/src/main/java/com/epam/pipeline/manager/cluster/performancemonitoring/ESMonitoringManager.java", "diffHunk": "@@ -67,11 +71,34 @@\n         final LocalDateTime oldestMonitoring = oldestMonitoringDate();\n         final LocalDateTime start = requestedStart.isAfter(oldestMonitoring) ? requestedStart : oldestMonitoring;\n         final LocalDateTime end = Optional.ofNullable(to).orElseGet(DateUtils::nowUTC);\n+        final Duration interval = interval(start, end);\n         return end.isAfter(start) && end.isAfter(oldestMonitoring)\n-                ? getStats(nodeName, start, end)\n+                ? getStats(nodeName, start, end, interval)\n                 : Collections.emptyList();\n     }\n \n+    @Override\n+    public InputStream getStatsForNodeAsInputStream(final String nodeName,\n+                                                    final LocalDateTime from,\n+                                                    final LocalDateTime to,\n+                                                    final Duration interval) {\n+        final LocalDateTime requestedStart = Optional.ofNullable(from).orElseGet(() -> creationDate(nodeName));\n+        final LocalDateTime oldestMonitoring = oldestMonitoringDate();\n+        final LocalDateTime start = requestedStart.isAfter(oldestMonitoring) ? requestedStart : oldestMonitoring;\n+        final LocalDateTime end = Optional.ofNullable(to).orElseGet(DateUtils::nowUTC);\n+        final Duration minDuration = minimalDuration();\n+        final Duration adjustedDuration = interval.compareTo(minDuration) < 0\n+                                          ? minDuration\n+                                          : interval;\n+        final List<MonitoringStats> monitoringStats = getStats(nodeName, start, end, adjustedDuration);\n+        final MonitoringStatsWriter statsWriter = new MonitoringStatsWriter();\n+        try {\n+            return new StringInputStream(statsWriter.convertStatsToCsvString(monitoringStats));\n+        } catch (IOException e) {\n+            throw new IllegalStateException(\"Written csv stats file encoding differs from UTF-8.\", e);", "originalCommit": "5e7e9e857e2c05329abff936df17c627807caf9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ3MDY0MA==", "url": "https://github.com/epam/cloud-pipeline/pull/924#discussion_r373470640", "bodyText": "Done", "author": "Wedds", "createdAt": "2020-01-31T13:08:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQwMDk4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQwMzk3Nw==", "url": "https://github.com/epam/cloud-pipeline/pull/924#discussion_r373403977", "bodyText": "In order to remove hardcoded indices, I'd suggest to use List to build CSV line and then convert it to array", "author": "mzueva", "createdAt": "2020-01-31T10:11:08Z", "path": "api/src/main/java/com/epam/pipeline/manager/cluster/writer/MonitoringStatsWriter.java", "diffHunk": "@@ -0,0 +1,150 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.manager.cluster.writer;\n+\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.opencsv.CSVWriter;\n+import lombok.NoArgsConstructor;\n+import lombok.Value;\n+\n+import java.io.StringWriter;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+@NoArgsConstructor\n+public class MonitoringStatsWriter {\n+\n+    private static final List<String> COMMON_STATS_HEADER =\n+        Arrays.asList(\"Timestamp\", \"CPU_cores\", \"CPU_usage[%]\", \"MEM_capacity[bytes]\", \"MEM_usage[%]\");\n+    private static final String DISK_TOTAL_HEADER_TEMPLATE = \"%s_total[bytes]\";\n+    private static final String DISK_USAGE_HEADER_TEMPLATE = \"%s_usage[%%]\";\n+    private static final String NETWORK_USAGE_IN_HEADER_TEMPLATE = \"%s_in[bytes]\";\n+    private static final String NETWORK_USAGE_OUT_HEADER_TEMPLATE = \"%s_out[bytes]\";\n+    private static final double HUNDRED_PERCENTS = 100.0;\n+\n+    public String convertStatsToCsvString(final List<MonitoringStats> stats) {\n+        final StringWriter stringWriter = new StringWriter();\n+        final CSVWriter csvWriter = new CSVWriter(stringWriter);\n+        final List<String[]> allLines = extractTable(stats);\n+        csvWriter.writeAll(allLines);\n+        return stringWriter.toString();\n+    }\n+\n+    private List<String[]> extractTable(final List<MonitoringStats> stats) {\n+        final List<String[]> allLines = new ArrayList<>();\n+        final MonitoringStatsHeader header = extractHeader(stats);\n+        if (!header.getColumnNames().isEmpty()) {\n+            allLines.add(header.getColumnNames().toArray(new String[0]));\n+            final List<String[]> entities = stats.stream()\n+                .map(stat -> createNewLine(header, stat))\n+                .collect(Collectors.toList());\n+            allLines.addAll(entities);\n+            return allLines;\n+        } else {\n+            return Collections.emptyList();\n+        }\n+    }\n+\n+    private MonitoringStatsHeader extractHeader(final List<MonitoringStats> stats) {\n+        if (stats.size() == 0) {\n+            return MonitoringStatsHeader.EMPTY_HEADER;\n+        }\n+        final List<String> headerColumns = new ArrayList<>(COMMON_STATS_HEADER);\n+        final List<String> disks = stats.stream()\n+            .map(MonitoringStats::getDisksUsage)\n+            .map(MonitoringStats.DisksUsage::getStatsByDevices)\n+            .map(Map::keySet)\n+            .flatMap(Set::stream)\n+            .distinct()\n+            .sorted()\n+            .peek(disk -> {\n+                headerColumns.add(String.format(DISK_TOTAL_HEADER_TEMPLATE, disk));\n+                headerColumns.add(String.format(DISK_USAGE_HEADER_TEMPLATE, disk));\n+            })\n+            .collect(Collectors.toList());\n+        final List<String> networkInterfaces = stats.stream()\n+            .map(MonitoringStats::getNetworkUsage)\n+            .map(MonitoringStats.NetworkUsage::getStatsByInterface)\n+            .map(Map::keySet)\n+            .flatMap(Set::stream)\n+            .distinct()\n+            .sorted()\n+            .peek(netInterface -> {\n+                headerColumns.add(String.format(NETWORK_USAGE_IN_HEADER_TEMPLATE, netInterface));\n+                headerColumns.add(String.format(NETWORK_USAGE_OUT_HEADER_TEMPLATE, netInterface));\n+            })\n+            .collect(Collectors.toList());\n+        return new MonitoringStatsHeader(disks, networkInterfaces, headerColumns);\n+    }\n+\n+    private String[] createNewLine(final MonitoringStatsHeader header, final MonitoringStats stat) {\n+        final String[] newLine = new String[header.getColumnNames().size()];", "originalCommit": "5e7e9e857e2c05329abff936df17c627807caf9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ3MDU5OA==", "url": "https://github.com/epam/cloud-pipeline/pull/924#discussion_r373470598", "bodyText": "Done", "author": "Wedds", "createdAt": "2020-01-31T13:08:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQwMzk3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQwNDI4MA==", "url": "https://github.com/epam/cloud-pipeline/pull/924#discussion_r373404280", "bodyText": "It is always better to use CollectionUtils.isEmpty for such checks", "author": "mzueva", "createdAt": "2020-01-31T10:11:52Z", "path": "api/src/main/java/com/epam/pipeline/manager/cluster/writer/MonitoringStatsWriter.java", "diffHunk": "@@ -0,0 +1,150 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.manager.cluster.writer;\n+\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.opencsv.CSVWriter;\n+import lombok.NoArgsConstructor;\n+import lombok.Value;\n+\n+import java.io.StringWriter;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+@NoArgsConstructor\n+public class MonitoringStatsWriter {\n+\n+    private static final List<String> COMMON_STATS_HEADER =\n+        Arrays.asList(\"Timestamp\", \"CPU_cores\", \"CPU_usage[%]\", \"MEM_capacity[bytes]\", \"MEM_usage[%]\");\n+    private static final String DISK_TOTAL_HEADER_TEMPLATE = \"%s_total[bytes]\";\n+    private static final String DISK_USAGE_HEADER_TEMPLATE = \"%s_usage[%%]\";\n+    private static final String NETWORK_USAGE_IN_HEADER_TEMPLATE = \"%s_in[bytes]\";\n+    private static final String NETWORK_USAGE_OUT_HEADER_TEMPLATE = \"%s_out[bytes]\";\n+    private static final double HUNDRED_PERCENTS = 100.0;\n+\n+    public String convertStatsToCsvString(final List<MonitoringStats> stats) {\n+        final StringWriter stringWriter = new StringWriter();\n+        final CSVWriter csvWriter = new CSVWriter(stringWriter);\n+        final List<String[]> allLines = extractTable(stats);\n+        csvWriter.writeAll(allLines);\n+        return stringWriter.toString();\n+    }\n+\n+    private List<String[]> extractTable(final List<MonitoringStats> stats) {\n+        final List<String[]> allLines = new ArrayList<>();\n+        final MonitoringStatsHeader header = extractHeader(stats);\n+        if (!header.getColumnNames().isEmpty()) {\n+            allLines.add(header.getColumnNames().toArray(new String[0]));\n+            final List<String[]> entities = stats.stream()\n+                .map(stat -> createNewLine(header, stat))\n+                .collect(Collectors.toList());\n+            allLines.addAll(entities);\n+            return allLines;\n+        } else {\n+            return Collections.emptyList();\n+        }\n+    }\n+\n+    private MonitoringStatsHeader extractHeader(final List<MonitoringStats> stats) {\n+        if (stats.size() == 0) {", "originalCommit": "5e7e9e857e2c05329abff936df17c627807caf9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ3MDU1NA==", "url": "https://github.com/epam/cloud-pipeline/pull/924#discussion_r373470554", "bodyText": "Removed during refactoring: now checking if the whole stats list is empty at the beginning of convertStatsToCsvString", "author": "Wedds", "createdAt": "2020-01-31T13:08:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQwNDI4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQwNTA5NQ==", "url": "https://github.com/epam/cloud-pipeline/pull/924#discussion_r373405095", "bodyText": "You can wrap collections into ListUtils.emptyIfNull", "author": "mzueva", "createdAt": "2020-01-31T10:13:42Z", "path": "api/src/main/java/com/epam/pipeline/manager/cluster/writer/MonitoringStatsWriter.java", "diffHunk": "@@ -0,0 +1,150 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.manager.cluster.writer;\n+\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.opencsv.CSVWriter;\n+import lombok.NoArgsConstructor;\n+import lombok.Value;\n+\n+import java.io.StringWriter;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+@NoArgsConstructor\n+public class MonitoringStatsWriter {\n+\n+    private static final List<String> COMMON_STATS_HEADER =\n+        Arrays.asList(\"Timestamp\", \"CPU_cores\", \"CPU_usage[%]\", \"MEM_capacity[bytes]\", \"MEM_usage[%]\");\n+    private static final String DISK_TOTAL_HEADER_TEMPLATE = \"%s_total[bytes]\";\n+    private static final String DISK_USAGE_HEADER_TEMPLATE = \"%s_usage[%%]\";\n+    private static final String NETWORK_USAGE_IN_HEADER_TEMPLATE = \"%s_in[bytes]\";\n+    private static final String NETWORK_USAGE_OUT_HEADER_TEMPLATE = \"%s_out[bytes]\";\n+    private static final double HUNDRED_PERCENTS = 100.0;\n+\n+    public String convertStatsToCsvString(final List<MonitoringStats> stats) {\n+        final StringWriter stringWriter = new StringWriter();\n+        final CSVWriter csvWriter = new CSVWriter(stringWriter);\n+        final List<String[]> allLines = extractTable(stats);\n+        csvWriter.writeAll(allLines);\n+        return stringWriter.toString();\n+    }\n+\n+    private List<String[]> extractTable(final List<MonitoringStats> stats) {\n+        final List<String[]> allLines = new ArrayList<>();\n+        final MonitoringStatsHeader header = extractHeader(stats);\n+        if (!header.getColumnNames().isEmpty()) {", "originalCommit": "5e7e9e857e2c05329abff936df17c627807caf9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ3MDU4MA==", "url": "https://github.com/epam/cloud-pipeline/pull/924#discussion_r373470580", "bodyText": "Removed during refactoring: now checking if the whole stats list is empty at the beginning of convertStatsToCsvString", "author": "Wedds", "createdAt": "2020-01-31T13:08:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQwNTA5NQ=="}], "type": "inlineReview"}, {"oid": "27e935bb7dbfbb1b7f3db86b151189d3cf059175", "url": "https://github.com/epam/cloud-pipeline/commit/27e935bb7dbfbb1b7f3db86b151189d3cf059175", "message": "Issue #857 PR issues fixes", "committedDate": "2020-01-31T13:01:16Z", "type": "commit"}]}