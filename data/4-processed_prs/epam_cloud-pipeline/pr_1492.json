{"pr_number": 1492, "pr_title": "Issue #1404: Implemented tests for Configuration Api Services", "pr_createdAt": "2020-10-13T12:32:11Z", "pr_url": "https://github.com/epam/cloud-pipeline/pull/1492", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE2Nzc4Nw==", "url": "https://github.com/epam/cloud-pipeline/pull/1492#discussion_r509167787", "bodyText": "Probably these changes have nothing to do with the pull request.", "author": "tcibinan", "createdAt": "2020-10-21T10:29:35Z", "path": "api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java", "diffHunk": "@@ -17,8 +17,10 @@\n package com.epam.pipeline.test.acl;", "originalCommit": "dcdf3acd1348aa9080a030bcabaa37695cf5c328", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDAyMTMwMw==", "url": "https://github.com/epam/cloud-pipeline/pull/1492#discussion_r510021303", "bodyText": "The change allows user to specify any owner in the request body therefore possibly gaining access to any run configuration. Let's not do that.", "author": "tcibinan", "createdAt": "2020-10-22T09:37:02Z", "path": "api/src/main/java/com/epam/pipeline/controller/vo/configuration/RunConfigurationVO.java", "diffHunk": "@@ -35,12 +35,14 @@\n     private Long id;\n     private String name;\n     private String description;\n+    private String owner;\n     private List<AbstractRunConfigurationEntry> entries;\n \n     public RunConfiguration toEntity() {\n         RunConfiguration configuration = new RunConfiguration();\n         configuration.setId(getId());\n         configuration.setName(getName());\n+        configuration.setOwner(getOwner());", "originalCommit": "dcdf3acd1348aa9080a030bcabaa37695cf5c328", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDAyMTg4Nw==", "url": "https://github.com/epam/cloud-pipeline/pull/1492#discussion_r510021887", "bodyText": "Please replace the field with the common constant.", "author": "tcibinan", "createdAt": "2020-10-22T09:37:56Z", "path": "api/src/test/java/com/epam/pipeline/acl/configuration/RunConfigurationApiServiceTest.java", "diffHunk": "@@ -0,0 +1,288 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.configuration;\n+\n+import com.epam.pipeline.controller.vo.configuration.RunConfigurationVO;\n+import com.epam.pipeline.entity.configuration.RunConfiguration;\n+import com.epam.pipeline.entity.configuration.RunConfigurationEntry;\n+import com.epam.pipeline.entity.pipeline.Folder;\n+import com.epam.pipeline.manager.configuration.RunConfigurationManager;\n+import com.epam.pipeline.manager.pipeline.runner.ConfigurationProviderManager;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.configuration.ConfigurationCreatorUtils;\n+import com.epam.pipeline.test.creator.folder.FolderCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class RunConfigurationApiServiceTest extends AbstractAclTest {\n+\n+    private final String TEST_STRING = \"Test\";", "originalCommit": "dcdf3acd1348aa9080a030bcabaa37695cf5c328", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDAyMzAwNg==", "url": "https://github.com/epam/cloud-pipeline/pull/1492#discussion_r510023006", "bodyText": "Let's create an overloaded version of the method with only two arguments.", "author": "tcibinan", "createdAt": "2020-10-22T09:39:33Z", "path": "api/src/test/java/com/epam/pipeline/acl/configuration/RunConfigurationApiServiceTest.java", "diffHunk": "@@ -0,0 +1,288 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.configuration;\n+\n+import com.epam.pipeline.controller.vo.configuration.RunConfigurationVO;\n+import com.epam.pipeline.entity.configuration.RunConfiguration;\n+import com.epam.pipeline.entity.configuration.RunConfigurationEntry;\n+import com.epam.pipeline.entity.pipeline.Folder;\n+import com.epam.pipeline.manager.configuration.RunConfigurationManager;\n+import com.epam.pipeline.manager.pipeline.runner.ConfigurationProviderManager;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.configuration.ConfigurationCreatorUtils;\n+import com.epam.pipeline.test.creator.folder.FolderCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class RunConfigurationApiServiceTest extends AbstractAclTest {\n+\n+    private final String TEST_STRING = \"Test\";\n+    private final RunConfiguration runConfiguration =\n+            ConfigurationCreatorUtils.getRunConfiguration(1L, SIMPLE_USER, null);", "originalCommit": "dcdf3acd1348aa9080a030bcabaa37695cf5c328", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDAyNzI2MA==", "url": "https://github.com/epam/cloud-pipeline/pull/1492#discussion_r510027260", "bodyText": "And also use common constant for id as well.", "author": "tcibinan", "createdAt": "2020-10-22T09:45:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDAyMzAwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDAzOTExOQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1492#discussion_r510039119", "bodyText": "Let's use ANOTHER_SIMPLE_USER constant in abstract class for such cases. Currently it is pretty hard to read. In the context of the method TEST_STRING is the user name but the code reader doesn't know that.", "author": "tcibinan", "createdAt": "2020-10-22T10:05:19Z", "path": "api/src/test/java/com/epam/pipeline/acl/configuration/RunConfigurationApiServiceTest.java", "diffHunk": "@@ -0,0 +1,288 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.configuration;\n+\n+import com.epam.pipeline.controller.vo.configuration.RunConfigurationVO;\n+import com.epam.pipeline.entity.configuration.RunConfiguration;\n+import com.epam.pipeline.entity.configuration.RunConfigurationEntry;\n+import com.epam.pipeline.entity.pipeline.Folder;\n+import com.epam.pipeline.manager.configuration.RunConfigurationManager;\n+import com.epam.pipeline.manager.pipeline.runner.ConfigurationProviderManager;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.configuration.ConfigurationCreatorUtils;\n+import com.epam.pipeline.test.creator.folder.FolderCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class RunConfigurationApiServiceTest extends AbstractAclTest {\n+\n+    private final String TEST_STRING = \"Test\";\n+    private final RunConfiguration runConfiguration =\n+            ConfigurationCreatorUtils.getRunConfiguration(1L, SIMPLE_USER, null);\n+    private final RunConfigurationVO runConfigurationVO =\n+            ConfigurationCreatorUtils.getRunConfigurationVO(1L, SIMPLE_USER);\n+    private final RunConfigurationEntry runConfigurationEntry = ConfigurationCreatorUtils.getRunConfigurationEntry();\n+    private final Folder folder = FolderCreatorUtils.getFolder(1L, SIMPLE_USER);\n+\n+    @Autowired\n+    private RunConfigurationApiService runConfigurationApiService;\n+\n+    @Autowired\n+    private RunConfigurationManager mockRunConfigurationManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private ConfigurationProviderManager mockConfigurationProviderManager;\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldSaveRunConfigurationForAdmin() {\n+        initAclEntity(folder);\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).create(runConfigurationVO);\n+\n+        assertThat(runConfigurationApiService.save(runConfigurationVO)).isEqualTo(runConfiguration);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER, roles = CONFIGURATION_MANAGER_ROLE)\n+    public void shouldSaveRunConfigurationWhenPermissionIsGranted() {\n+        RunConfiguration runConfiguration =\n+                ConfigurationCreatorUtils.getRunConfiguration(1L, TEST_STRING, null);", "originalCommit": "dcdf3acd1348aa9080a030bcabaa37695cf5c328", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDA1NjQwNQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1492#discussion_r510056405", "bodyText": "And also please add final keyword.", "author": "tcibinan", "createdAt": "2020-10-22T10:34:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDAzOTExOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDAzOTczNQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1492#discussion_r510039735", "bodyText": "Let's instantiate a new instance for run configuration vo just the same way you did in the test above. Please do the same for all similar cases below.", "author": "tcibinan", "createdAt": "2020-10-22T10:06:26Z", "path": "api/src/test/java/com/epam/pipeline/acl/configuration/RunConfigurationApiServiceTest.java", "diffHunk": "@@ -0,0 +1,288 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.configuration;\n+\n+import com.epam.pipeline.controller.vo.configuration.RunConfigurationVO;\n+import com.epam.pipeline.entity.configuration.RunConfiguration;\n+import com.epam.pipeline.entity.configuration.RunConfigurationEntry;\n+import com.epam.pipeline.entity.pipeline.Folder;\n+import com.epam.pipeline.manager.configuration.RunConfigurationManager;\n+import com.epam.pipeline.manager.pipeline.runner.ConfigurationProviderManager;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.configuration.ConfigurationCreatorUtils;\n+import com.epam.pipeline.test.creator.folder.FolderCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class RunConfigurationApiServiceTest extends AbstractAclTest {\n+\n+    private final String TEST_STRING = \"Test\";\n+    private final RunConfiguration runConfiguration =\n+            ConfigurationCreatorUtils.getRunConfiguration(1L, SIMPLE_USER, null);\n+    private final RunConfigurationVO runConfigurationVO =\n+            ConfigurationCreatorUtils.getRunConfigurationVO(1L, SIMPLE_USER);\n+    private final RunConfigurationEntry runConfigurationEntry = ConfigurationCreatorUtils.getRunConfigurationEntry();\n+    private final Folder folder = FolderCreatorUtils.getFolder(1L, SIMPLE_USER);\n+\n+    @Autowired\n+    private RunConfigurationApiService runConfigurationApiService;\n+\n+    @Autowired\n+    private RunConfigurationManager mockRunConfigurationManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private ConfigurationProviderManager mockConfigurationProviderManager;\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldSaveRunConfigurationForAdmin() {\n+        initAclEntity(folder);\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).create(runConfigurationVO);\n+\n+        assertThat(runConfigurationApiService.save(runConfigurationVO)).isEqualTo(runConfiguration);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER, roles = CONFIGURATION_MANAGER_ROLE)\n+    public void shouldSaveRunConfigurationWhenPermissionIsGranted() {\n+        RunConfiguration runConfiguration =\n+                ConfigurationCreatorUtils.getRunConfiguration(1L, TEST_STRING, null);\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(folder, AclPermission.WRITE);\n+        initAclEntity(runConfiguration, AclPermission.WRITE);\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).create(runConfigurationVO);\n+\n+        final RunConfiguration returnedRunConfiguration = runConfigurationApiService.save(runConfigurationVO);\n+\n+        assertThat(returnedRunConfiguration).isEqualTo(runConfiguration);\n+        assertThat(returnedRunConfiguration.getMask()).isEqualTo(2);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = CONFIGURATION_MANAGER_ROLE)\n+    public void shouldDenySavingRunConfigurationWhenParentIdIsNull() {\n+        runConfigurationVO.setParentId(null);", "originalCommit": "dcdf3acd1348aa9080a030bcabaa37695cf5c328", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDA0OTk2NA==", "url": "https://github.com/epam/cloud-pipeline/pull/1492#discussion_r510049964", "bodyText": "I'm thinking about making it more explicit like shouldDenySavingRunConfigurationWhenParentPermissionIsNotGranted.", "author": "tcibinan", "createdAt": "2020-10-22T10:23:47Z", "path": "api/src/test/java/com/epam/pipeline/acl/configuration/RunConfigurationApiServiceTest.java", "diffHunk": "@@ -0,0 +1,288 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.configuration;\n+\n+import com.epam.pipeline.controller.vo.configuration.RunConfigurationVO;\n+import com.epam.pipeline.entity.configuration.RunConfiguration;\n+import com.epam.pipeline.entity.configuration.RunConfigurationEntry;\n+import com.epam.pipeline.entity.pipeline.Folder;\n+import com.epam.pipeline.manager.configuration.RunConfigurationManager;\n+import com.epam.pipeline.manager.pipeline.runner.ConfigurationProviderManager;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.configuration.ConfigurationCreatorUtils;\n+import com.epam.pipeline.test.creator.folder.FolderCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class RunConfigurationApiServiceTest extends AbstractAclTest {\n+\n+    private final String TEST_STRING = \"Test\";\n+    private final RunConfiguration runConfiguration =\n+            ConfigurationCreatorUtils.getRunConfiguration(1L, SIMPLE_USER, null);\n+    private final RunConfigurationVO runConfigurationVO =\n+            ConfigurationCreatorUtils.getRunConfigurationVO(1L, SIMPLE_USER);\n+    private final RunConfigurationEntry runConfigurationEntry = ConfigurationCreatorUtils.getRunConfigurationEntry();\n+    private final Folder folder = FolderCreatorUtils.getFolder(1L, SIMPLE_USER);\n+\n+    @Autowired\n+    private RunConfigurationApiService runConfigurationApiService;\n+\n+    @Autowired\n+    private RunConfigurationManager mockRunConfigurationManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private ConfigurationProviderManager mockConfigurationProviderManager;\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldSaveRunConfigurationForAdmin() {\n+        initAclEntity(folder);\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).create(runConfigurationVO);\n+\n+        assertThat(runConfigurationApiService.save(runConfigurationVO)).isEqualTo(runConfiguration);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER, roles = CONFIGURATION_MANAGER_ROLE)\n+    public void shouldSaveRunConfigurationWhenPermissionIsGranted() {\n+        RunConfiguration runConfiguration =\n+                ConfigurationCreatorUtils.getRunConfiguration(1L, TEST_STRING, null);\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(folder, AclPermission.WRITE);\n+        initAclEntity(runConfiguration, AclPermission.WRITE);\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).create(runConfigurationVO);\n+\n+        final RunConfiguration returnedRunConfiguration = runConfigurationApiService.save(runConfigurationVO);\n+\n+        assertThat(returnedRunConfiguration).isEqualTo(runConfiguration);\n+        assertThat(returnedRunConfiguration.getMask()).isEqualTo(2);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = CONFIGURATION_MANAGER_ROLE)\n+    public void shouldDenySavingRunConfigurationWhenParentIdIsNull() {\n+        runConfigurationVO.setParentId(null);\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(folder, AclPermission.WRITE);\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).create(runConfigurationVO);\n+\n+        assertThrows(AccessDeniedException.class, () -> runConfigurationApiService.save(runConfigurationVO));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDenySavingRunConfigurationWithInvalidRole() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(folder, AclPermission.WRITE);\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).create(runConfigurationVO);\n+\n+        assertThrows(AccessDeniedException.class, () -> runConfigurationApiService.save(runConfigurationVO));\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = CONFIGURATION_MANAGER_ROLE)\n+    public void shouldDenySavingRunConfigurationWithInvalidAclPermission() {", "originalCommit": "dcdf3acd1348aa9080a030bcabaa37695cf5c328", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDA1Njc3Ng==", "url": "https://github.com/epam/cloud-pipeline/pull/1492#discussion_r510056776", "bodyText": "Please extract EXECUTE along with other permissions to abstract class fields.", "author": "tcibinan", "createdAt": "2020-10-22T10:35:00Z", "path": "api/src/test/java/com/epam/pipeline/acl/configuration/RunConfigurationApiServiceTest.java", "diffHunk": "@@ -0,0 +1,288 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.configuration;\n+\n+import com.epam.pipeline.controller.vo.configuration.RunConfigurationVO;\n+import com.epam.pipeline.entity.configuration.RunConfiguration;\n+import com.epam.pipeline.entity.configuration.RunConfigurationEntry;\n+import com.epam.pipeline.entity.pipeline.Folder;\n+import com.epam.pipeline.manager.configuration.RunConfigurationManager;\n+import com.epam.pipeline.manager.pipeline.runner.ConfigurationProviderManager;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.configuration.ConfigurationCreatorUtils;\n+import com.epam.pipeline.test.creator.folder.FolderCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class RunConfigurationApiServiceTest extends AbstractAclTest {\n+\n+    private final String TEST_STRING = \"Test\";\n+    private final RunConfiguration runConfiguration =\n+            ConfigurationCreatorUtils.getRunConfiguration(1L, SIMPLE_USER, null);\n+    private final RunConfigurationVO runConfigurationVO =\n+            ConfigurationCreatorUtils.getRunConfigurationVO(1L, SIMPLE_USER);\n+    private final RunConfigurationEntry runConfigurationEntry = ConfigurationCreatorUtils.getRunConfigurationEntry();\n+    private final Folder folder = FolderCreatorUtils.getFolder(1L, SIMPLE_USER);\n+\n+    @Autowired\n+    private RunConfigurationApiService runConfigurationApiService;\n+\n+    @Autowired\n+    private RunConfigurationManager mockRunConfigurationManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private ConfigurationProviderManager mockConfigurationProviderManager;\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldSaveRunConfigurationForAdmin() {\n+        initAclEntity(folder);\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).create(runConfigurationVO);\n+\n+        assertThat(runConfigurationApiService.save(runConfigurationVO)).isEqualTo(runConfiguration);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER, roles = CONFIGURATION_MANAGER_ROLE)\n+    public void shouldSaveRunConfigurationWhenPermissionIsGranted() {\n+        RunConfiguration runConfiguration =\n+                ConfigurationCreatorUtils.getRunConfiguration(1L, TEST_STRING, null);\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(folder, AclPermission.WRITE);\n+        initAclEntity(runConfiguration, AclPermission.WRITE);\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).create(runConfigurationVO);\n+\n+        final RunConfiguration returnedRunConfiguration = runConfigurationApiService.save(runConfigurationVO);\n+\n+        assertThat(returnedRunConfiguration).isEqualTo(runConfiguration);\n+        assertThat(returnedRunConfiguration.getMask()).isEqualTo(2);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = CONFIGURATION_MANAGER_ROLE)\n+    public void shouldDenySavingRunConfigurationWhenParentIdIsNull() {\n+        runConfigurationVO.setParentId(null);\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(folder, AclPermission.WRITE);\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).create(runConfigurationVO);\n+\n+        assertThrows(AccessDeniedException.class, () -> runConfigurationApiService.save(runConfigurationVO));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDenySavingRunConfigurationWithInvalidRole() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(folder, AclPermission.WRITE);\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).create(runConfigurationVO);\n+\n+        assertThrows(AccessDeniedException.class, () -> runConfigurationApiService.save(runConfigurationVO));\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = CONFIGURATION_MANAGER_ROLE)\n+    public void shouldDenySavingRunConfigurationWithInvalidAclPermission() {\n+        folder.setOwner(TEST_STRING);\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(folder);\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).create(runConfigurationVO);\n+\n+        assertThrows(AccessDeniedException.class, () -> runConfigurationApiService.save(runConfigurationVO));\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = CONFIGURATION_MANAGER_ROLE)\n+    public void shouldDenySavingRunConfigurationWithInvalidPermissionToConfiguration() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(folder, AclPermission.WRITE);\n+        doReturn(true).when(mockConfigurationProviderManager)\n+                .hasNoPermission(runConfigurationEntry, \"EXECUTE\");", "originalCommit": "dcdf3acd1348aa9080a030bcabaa37695cf5c328", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDA1ODExNw==", "url": "https://github.com/epam/cloud-pipeline/pull/1492#discussion_r510058117", "bodyText": "Please replace all the 1L with ID constant as well.", "author": "tcibinan", "createdAt": "2020-10-22T10:37:23Z", "path": "api/src/test/java/com/epam/pipeline/acl/configuration/RunConfigurationApiServiceTest.java", "diffHunk": "@@ -0,0 +1,288 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.configuration;\n+\n+import com.epam.pipeline.controller.vo.configuration.RunConfigurationVO;\n+import com.epam.pipeline.entity.configuration.RunConfiguration;\n+import com.epam.pipeline.entity.configuration.RunConfigurationEntry;\n+import com.epam.pipeline.entity.pipeline.Folder;\n+import com.epam.pipeline.manager.configuration.RunConfigurationManager;\n+import com.epam.pipeline.manager.pipeline.runner.ConfigurationProviderManager;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.configuration.ConfigurationCreatorUtils;\n+import com.epam.pipeline.test.creator.folder.FolderCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class RunConfigurationApiServiceTest extends AbstractAclTest {\n+\n+    private final String TEST_STRING = \"Test\";\n+    private final RunConfiguration runConfiguration =\n+            ConfigurationCreatorUtils.getRunConfiguration(1L, SIMPLE_USER, null);\n+    private final RunConfigurationVO runConfigurationVO =\n+            ConfigurationCreatorUtils.getRunConfigurationVO(1L, SIMPLE_USER);\n+    private final RunConfigurationEntry runConfigurationEntry = ConfigurationCreatorUtils.getRunConfigurationEntry();\n+    private final Folder folder = FolderCreatorUtils.getFolder(1L, SIMPLE_USER);\n+\n+    @Autowired\n+    private RunConfigurationApiService runConfigurationApiService;\n+\n+    @Autowired\n+    private RunConfigurationManager mockRunConfigurationManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private ConfigurationProviderManager mockConfigurationProviderManager;\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldSaveRunConfigurationForAdmin() {\n+        initAclEntity(folder);\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).create(runConfigurationVO);\n+\n+        assertThat(runConfigurationApiService.save(runConfigurationVO)).isEqualTo(runConfiguration);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER, roles = CONFIGURATION_MANAGER_ROLE)\n+    public void shouldSaveRunConfigurationWhenPermissionIsGranted() {\n+        RunConfiguration runConfiguration =\n+                ConfigurationCreatorUtils.getRunConfiguration(1L, TEST_STRING, null);\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(folder, AclPermission.WRITE);\n+        initAclEntity(runConfiguration, AclPermission.WRITE);\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).create(runConfigurationVO);\n+\n+        final RunConfiguration returnedRunConfiguration = runConfigurationApiService.save(runConfigurationVO);\n+\n+        assertThat(returnedRunConfiguration).isEqualTo(runConfiguration);\n+        assertThat(returnedRunConfiguration.getMask()).isEqualTo(2);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = CONFIGURATION_MANAGER_ROLE)\n+    public void shouldDenySavingRunConfigurationWhenParentIdIsNull() {\n+        runConfigurationVO.setParentId(null);\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(folder, AclPermission.WRITE);\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).create(runConfigurationVO);\n+\n+        assertThrows(AccessDeniedException.class, () -> runConfigurationApiService.save(runConfigurationVO));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDenySavingRunConfigurationWithInvalidRole() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(folder, AclPermission.WRITE);\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).create(runConfigurationVO);\n+\n+        assertThrows(AccessDeniedException.class, () -> runConfigurationApiService.save(runConfigurationVO));\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = CONFIGURATION_MANAGER_ROLE)\n+    public void shouldDenySavingRunConfigurationWithInvalidAclPermission() {\n+        folder.setOwner(TEST_STRING);\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(folder);\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).create(runConfigurationVO);\n+\n+        assertThrows(AccessDeniedException.class, () -> runConfigurationApiService.save(runConfigurationVO));\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = CONFIGURATION_MANAGER_ROLE)\n+    public void shouldDenySavingRunConfigurationWithInvalidPermissionToConfiguration() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(folder, AclPermission.WRITE);\n+        doReturn(true).when(mockConfigurationProviderManager)\n+                .hasNoPermission(runConfigurationEntry, \"EXECUTE\");\n+\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).create(runConfigurationVO);\n+\n+        assertThrows(AccessDeniedException.class, () -> runConfigurationApiService.save(runConfigurationVO));\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldUpdateRunConfigurationForAdmin() {\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).update(runConfigurationVO);\n+\n+        assertThat(runConfigurationApiService.update(runConfigurationVO)).isEqualTo(runConfiguration);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldUpdateRunConfigurationWhenPermissionIsGranted() {\n+        RunConfiguration runConfiguration =\n+                ConfigurationCreatorUtils.getRunConfiguration(1L, TEST_STRING, null);\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(runConfiguration, AclPermission.WRITE);\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).update(runConfigurationVO);\n+\n+        final RunConfiguration returnedRunConfiguration = runConfigurationApiService.update(runConfigurationVO);\n+\n+        assertThat(returnedRunConfiguration).isEqualTo(runConfiguration);\n+        assertThat(returnedRunConfiguration.getMask()).isEqualTo(2);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDenyUpdateRunConfigurationWhenPermissionIsNotGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(runConfiguration);\n+        doReturn(true).when(mockConfigurationProviderManager)\n+                .hasNoPermission(runConfigurationEntry, \"EXECUTE\");\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).update(runConfigurationVO);\n+\n+        assertThrows(AccessDeniedException.class, () -> runConfigurationApiService.update(runConfigurationVO));\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldDeleteRunConfigurationForAdmin() {\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).delete(1L);", "originalCommit": "dcdf3acd1348aa9080a030bcabaa37695cf5c328", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDA2MDI0OQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1492#discussion_r510060249", "bodyText": "Let's extract common mocking to the class private methods.", "author": "tcibinan", "createdAt": "2020-10-22T10:41:15Z", "path": "api/src/test/java/com/epam/pipeline/acl/configuration/RunConfigurationApiServiceTest.java", "diffHunk": "@@ -0,0 +1,288 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.configuration;\n+\n+import com.epam.pipeline.controller.vo.configuration.RunConfigurationVO;\n+import com.epam.pipeline.entity.configuration.RunConfiguration;\n+import com.epam.pipeline.entity.configuration.RunConfigurationEntry;\n+import com.epam.pipeline.entity.pipeline.Folder;\n+import com.epam.pipeline.manager.configuration.RunConfigurationManager;\n+import com.epam.pipeline.manager.pipeline.runner.ConfigurationProviderManager;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.configuration.ConfigurationCreatorUtils;\n+import com.epam.pipeline.test.creator.folder.FolderCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class RunConfigurationApiServiceTest extends AbstractAclTest {\n+\n+    private final String TEST_STRING = \"Test\";\n+    private final RunConfiguration runConfiguration =\n+            ConfigurationCreatorUtils.getRunConfiguration(1L, SIMPLE_USER, null);\n+    private final RunConfigurationVO runConfigurationVO =\n+            ConfigurationCreatorUtils.getRunConfigurationVO(1L, SIMPLE_USER);\n+    private final RunConfigurationEntry runConfigurationEntry = ConfigurationCreatorUtils.getRunConfigurationEntry();\n+    private final Folder folder = FolderCreatorUtils.getFolder(1L, SIMPLE_USER);\n+\n+    @Autowired\n+    private RunConfigurationApiService runConfigurationApiService;\n+\n+    @Autowired\n+    private RunConfigurationManager mockRunConfigurationManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private ConfigurationProviderManager mockConfigurationProviderManager;\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldSaveRunConfigurationForAdmin() {\n+        initAclEntity(folder);\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).create(runConfigurationVO);\n+\n+        assertThat(runConfigurationApiService.save(runConfigurationVO)).isEqualTo(runConfiguration);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER, roles = CONFIGURATION_MANAGER_ROLE)\n+    public void shouldSaveRunConfigurationWhenPermissionIsGranted() {\n+        RunConfiguration runConfiguration =\n+                ConfigurationCreatorUtils.getRunConfiguration(1L, TEST_STRING, null);\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(folder, AclPermission.WRITE);\n+        initAclEntity(runConfiguration, AclPermission.WRITE);\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).create(runConfigurationVO);\n+\n+        final RunConfiguration returnedRunConfiguration = runConfigurationApiService.save(runConfigurationVO);\n+\n+        assertThat(returnedRunConfiguration).isEqualTo(runConfiguration);\n+        assertThat(returnedRunConfiguration.getMask()).isEqualTo(2);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = CONFIGURATION_MANAGER_ROLE)\n+    public void shouldDenySavingRunConfigurationWhenParentIdIsNull() {\n+        runConfigurationVO.setParentId(null);\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(folder, AclPermission.WRITE);\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).create(runConfigurationVO);\n+\n+        assertThrows(AccessDeniedException.class, () -> runConfigurationApiService.save(runConfigurationVO));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDenySavingRunConfigurationWithInvalidRole() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(folder, AclPermission.WRITE);\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).create(runConfigurationVO);\n+\n+        assertThrows(AccessDeniedException.class, () -> runConfigurationApiService.save(runConfigurationVO));\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = CONFIGURATION_MANAGER_ROLE)\n+    public void shouldDenySavingRunConfigurationWithInvalidAclPermission() {\n+        folder.setOwner(TEST_STRING);\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(folder);\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).create(runConfigurationVO);\n+\n+        assertThrows(AccessDeniedException.class, () -> runConfigurationApiService.save(runConfigurationVO));\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = CONFIGURATION_MANAGER_ROLE)\n+    public void shouldDenySavingRunConfigurationWithInvalidPermissionToConfiguration() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(folder, AclPermission.WRITE);\n+        doReturn(true).when(mockConfigurationProviderManager)\n+                .hasNoPermission(runConfigurationEntry, \"EXECUTE\");\n+\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).create(runConfigurationVO);\n+\n+        assertThrows(AccessDeniedException.class, () -> runConfigurationApiService.save(runConfigurationVO));\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldUpdateRunConfigurationForAdmin() {\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).update(runConfigurationVO);\n+\n+        assertThat(runConfigurationApiService.update(runConfigurationVO)).isEqualTo(runConfiguration);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldUpdateRunConfigurationWhenPermissionIsGranted() {\n+        RunConfiguration runConfiguration =\n+                ConfigurationCreatorUtils.getRunConfiguration(1L, TEST_STRING, null);\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(runConfiguration, AclPermission.WRITE);\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).update(runConfigurationVO);\n+\n+        final RunConfiguration returnedRunConfiguration = runConfigurationApiService.update(runConfigurationVO);\n+\n+        assertThat(returnedRunConfiguration).isEqualTo(runConfiguration);\n+        assertThat(returnedRunConfiguration.getMask()).isEqualTo(2);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDenyUpdateRunConfigurationWhenPermissionIsNotGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(runConfiguration);\n+        doReturn(true).when(mockConfigurationProviderManager)\n+                .hasNoPermission(runConfigurationEntry, \"EXECUTE\");\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).update(runConfigurationVO);\n+\n+        assertThrows(AccessDeniedException.class, () -> runConfigurationApiService.update(runConfigurationVO));\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldDeleteRunConfigurationForAdmin() {\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).delete(1L);\n+\n+        assertThat(runConfigurationApiService.delete(1L)).isEqualTo(runConfiguration);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER, roles = CONFIGURATION_MANAGER_ROLE)\n+    public void shouldDeleteRunConfigurationWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(runConfiguration, AclPermission.WRITE);\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).delete(1L);\n+\n+        assertThat(runConfigurationApiService.delete(1L)).isEqualTo(runConfiguration);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDenyDeletionRunConfigurationWhenPermissionIsNotGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(runConfiguration);\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).delete(1L);\n+\n+        assertThrows(AccessDeniedException.class, () -> runConfigurationApiService.delete(1L));\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldLoadRunConfigurationForAdmin() {\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).load(1L);\n+\n+        assertThat(runConfigurationApiService.load(1L)).isEqualTo(runConfiguration);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldLoadRunConfigurationWhenPermissionIsGranted() {\n+        RunConfiguration runConfiguration =\n+                ConfigurationCreatorUtils.getRunConfiguration(1L, TEST_STRING, null);\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(runConfiguration, AclPermission.READ);\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).load(1L);\n+\n+        final RunConfiguration returnedRunConfiguration = runConfigurationApiService.load(1L);\n+\n+        assertThat(returnedRunConfiguration).isEqualTo(runConfiguration);\n+        assertThat(returnedRunConfiguration.getMask()).isEqualTo(1);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDenyLoadingRunConfigurationWhenPermissionIsNotGranted() {\n+        runConfiguration.setOwner(TEST_STRING);\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(runConfiguration);\n+\n+        doReturn(runConfiguration).when(mockRunConfigurationManager).load(1L);\n+\n+        assertThrows(AccessDeniedException.class, () -> runConfigurationApiService.load(1L));\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldLoadAllRunConfigurationForAdmin() {\n+        doReturn(initSingleRunConfigurationList()).when(mockRunConfigurationManager).loadAll();\n+\n+        assertThat(runConfigurationApiService.loadAll()).hasSize(1).contains(runConfiguration);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldLoadAllRunConfigurationWhenPermissionIsGranted() {\n+        RunConfiguration runConfiguration =\n+                ConfigurationCreatorUtils.getRunConfiguration(1L, TEST_STRING, null);\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(runConfiguration, AclPermission.READ);\n+        doReturn(initSingleRunConfigurationList()).when(mockRunConfigurationManager).loadAll();\n+\n+        final List<RunConfiguration> returnedRunConfiguration = runConfigurationApiService.loadAll();\n+\n+        assertThat(returnedRunConfiguration).hasSize(1).contains(runConfiguration);\n+        assertThat(returnedRunConfiguration.get(0).getMask()).isEqualTo(1);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldLoadAllRunConfigurationWhichPermissionIsGranted() {\n+        final RunConfiguration runConfigurationWithoutPermission =\n+                ConfigurationCreatorUtils.getRunConfiguration(2L, TEST_STRING, null);\n+        final List<RunConfiguration> twoRunConfigurationsList = new ArrayList<>();\n+        twoRunConfigurationsList.add(runConfiguration);\n+        twoRunConfigurationsList.add(runConfigurationWithoutPermission);\n+\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(runConfiguration, AclPermission.READ);\n+        initAclEntity(runConfigurationWithoutPermission);\n+        doReturn(twoRunConfigurationsList).when(mockRunConfigurationManager).loadAll();\n+\n+        assertThat(runConfigurationApiService.loadAll()).hasSize(1).contains(runConfiguration);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDenyLoadingAllRunConfigurationWhichPermissionIsNotGranted() {\n+        runConfiguration.setOwner(TEST_STRING);\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();", "originalCommit": "dcdf3acd1348aa9080a030bcabaa37695cf5c328", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDA2MjMyNw==", "url": "https://github.com/epam/cloud-pipeline/pull/1492#discussion_r510062327", "bodyText": "It looks like some of the tests in the class fail. Could you please check? My guess would be the tests execution order which is not method declarations order.", "author": "tcibinan", "createdAt": "2020-10-22T10:45:10Z", "path": "api/src/test/java/com/epam/pipeline/acl/configuration/ServerlessConfigurationApiServiceTest.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.configuration;\n+\n+import com.epam.pipeline.controller.vo.configuration.RunConfigurationVO;\n+import com.epam.pipeline.entity.configuration.RunConfiguration;\n+import com.epam.pipeline.manager.configuration.RunConfigurationManager;\n+import com.epam.pipeline.manager.configuration.ServerlessConfigurationManager;\n+import com.epam.pipeline.manager.pipeline.runner.ConfigurationProviderManager;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.configuration.ConfigurationCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.mock.web.MockHttpServletRequest;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import javax.servlet.http.HttpServletRequest;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.anyLong;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ServerlessConfigurationApiServiceTest extends AbstractAclTest {", "originalCommit": "dcdf3acd1348aa9080a030bcabaa37695cf5c328", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDA2NzU4NA==", "url": "https://github.com/epam/cloud-pipeline/pull/1492#discussion_r510067584", "bodyText": "But at the same time it looks like the bug in ACL. Could you please fix the acl (replacing configuration with id) and recheck that the tests execution order is fine.", "author": "tcibinan", "createdAt": "2020-10-22T10:54:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDA2MjMyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDcyMDQzNQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1492#discussion_r510720435", "bodyText": "Could you please remove the rule from config/pmd/pmd-ruleset.xml and then remove @SuppressWarnings since is not relevant anymore. We decided to get rid of this pmd rule because it doesn't seem to help the code style but just making everything harder.", "author": "tcibinan", "createdAt": "2020-10-23T08:28:06Z", "path": "api/src/test/java/com/epam/pipeline/acl/configuration/ServerlessConfigurationApiServiceTest.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.configuration;\n+\n+import com.epam.pipeline.controller.vo.configuration.RunConfigurationVO;\n+import com.epam.pipeline.entity.configuration.RunConfiguration;\n+import com.epam.pipeline.manager.configuration.RunConfigurationManager;\n+import com.epam.pipeline.manager.configuration.ServerlessConfigurationManager;\n+import com.epam.pipeline.manager.pipeline.runner.ConfigurationProviderManager;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.configuration.ConfigurationCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.mock.web.MockHttpServletRequest;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import javax.servlet.http.HttpServletRequest;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.anyLong;\n+import static org.mockito.Mockito.doReturn;\n+\n+@SuppressWarnings(\"PMD.TooManyStaticImports\")", "originalCommit": "c53ea47ef7d76f9f347e860e7dc14b979b0a5062", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c511a5ec0ed4881af5f3ad8161bc8914cf248ab7", "url": "https://github.com/epam/cloud-pipeline/commit/c511a5ec0ed4881af5f3ad8161bc8914cf248ab7", "message": "Issue #1404: Merge conflicts resolved\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-10-26T09:44:45Z", "type": "forcePushed"}, {"oid": "0a70791f4f8fd2f6cbef4627e13bfc4c77429c53", "url": "https://github.com/epam/cloud-pipeline/commit/0a70791f4f8fd2f6cbef4627e13bfc4c77429c53", "message": "Issue #1404: Unfinished tests for ConfigurationApiServices\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-10-27T14:54:14Z", "type": "commit"}, {"oid": "a73ac450ba211da9337de78be7a75b549980cb61", "url": "https://github.com/epam/cloud-pipeline/commit/a73ac450ba211da9337de78be7a75b549980cb61", "message": "Issue #1404: Incomplete tests (not done for one method) for ConfigurationApiServices\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-10-27T14:54:22Z", "type": "commit"}, {"oid": "4d1fa075892843422db2a569cb0baa957196c035", "url": "https://github.com/epam/cloud-pipeline/commit/4d1fa075892843422db2a569cb0baa957196c035", "message": "Issue #1404: Implemented tests for Configuration Api Services\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-10-27T14:54:58Z", "type": "commit"}, {"oid": "3dac0af668c91d7f578d4a6a5a0dc13711719df2", "url": "https://github.com/epam/cloud-pipeline/commit/3dac0af668c91d7f578d4a6a5a0dc13711719df2", "message": "Issue #1404: Improvement tests for Configuration Api Services\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-10-27T14:55:36Z", "type": "commit"}, {"oid": "b81d963168f614dd29c84b1bcfe4e0bc95a375a5", "url": "https://github.com/epam/cloud-pipeline/commit/b81d963168f614dd29c84b1bcfe4e0bc95a375a5", "message": "Issue #1404: Added overload getters to ConfigurationCreatorUtils\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-10-27T14:55:36Z", "type": "commit"}, {"oid": "bdaf92cb7956df27517fe24d1c60d5b33d4f326f", "url": "https://github.com/epam/cloud-pipeline/commit/bdaf92cb7956df27517fe24d1c60d5b33d4f326f", "message": "Issue #1404: Refactoring initAclEntity method\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-10-27T14:56:14Z", "type": "commit"}, {"oid": "663b6c2bf347e30b453f2d64e739bb31d49adeba", "url": "https://github.com/epam/cloud-pipeline/commit/663b6c2bf347e30b453f2d64e739bb31d49adeba", "message": "Issue #1404: Added valid masks check and fixes @WithMockUser arguments\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-10-27T14:56:14Z", "type": "commit"}, {"oid": "10604a54d74727f88397d7d3702cb72106e60ad5", "url": "https://github.com/epam/cloud-pipeline/commit/10604a54d74727f88397d7d3702cb72106e60ad5", "message": "Issue #1404: Refactoring and fixes in accordance with comments\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-10-27T14:56:32Z", "type": "commit"}, {"oid": "0dbca0c0a50d59c4195ce5017c258e9aec8c518d", "url": "https://github.com/epam/cloud-pipeline/commit/0dbca0c0a50d59c4195ce5017c258e9aec8c518d", "message": "Issue #1404: Improvements in the tests, changes in the PMD rules\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-10-27T14:57:14Z", "type": "commit"}, {"oid": "bd855245c482408a735dafe9c3df9f719b6e5b37", "url": "https://github.com/epam/cloud-pipeline/commit/bd855245c482408a735dafe9c3df9f719b6e5b37", "message": "Issue #1404: Fix PMD config\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-10-27T14:57:14Z", "type": "commit"}, {"oid": "df6b911b920bcf86b1194acca20da5113707fb1f", "url": "https://github.com/epam/cloud-pipeline/commit/df6b911b920bcf86b1194acca20da5113707fb1f", "message": "Issue #1404: Merge conflicts resolved\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-10-27T14:57:15Z", "type": "commit"}, {"oid": "8581a67f10d2b1581d86973f8d2c83708a78804e", "url": "https://github.com/epam/cloud-pipeline/commit/8581a67f10d2b1581d86973f8d2c83708a78804e", "message": "Issue #1404: Style (valid indentations) fixes\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-10-27T14:57:15Z", "type": "commit"}, {"oid": "fe45833153293c278103b74fcc81868d34adac16", "url": "https://github.com/epam/cloud-pipeline/commit/fe45833153293c278103b74fcc81868d34adac16", "message": "Issue #1404: Merge conflicts resolved\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-10-27T15:18:13Z", "type": "commit"}, {"oid": "fe45833153293c278103b74fcc81868d34adac16", "url": "https://github.com/epam/cloud-pipeline/commit/fe45833153293c278103b74fcc81868d34adac16", "message": "Issue #1404: Merge conflicts resolved\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-10-27T15:18:13Z", "type": "forcePushed"}]}