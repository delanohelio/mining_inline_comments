{"pr_number": 979, "pr_title": "pipe storage du implementation", "pr_createdAt": "2020-02-21T13:14:16Z", "pr_url": "https://github.com/epam/cloud-pipeline/pull/979", "timeline": [{"oid": "8dbb66abb5efccf4bf50799eb7ea426e2b8e3ae6", "url": "https://github.com/epam/cloud-pipeline/commit/8dbb66abb5efccf4bf50799eb7ea426e2b8e3ae6", "message": "Issue #548: Implement storage usage statistics retrieval via pipe - S3 support", "committedDate": "2020-02-18T15:51:06Z", "type": "commit"}, {"oid": "d30908252d1569f4c9ffd09c3dd4a6a7445e7ca7", "url": "https://github.com/epam/cloud-pipeline/commit/d30908252d1569f4c9ffd09c3dd4a6a7445e7ca7", "message": "issue #548: Implement storage usage statistics retrieval via pipe - API method for search storage usage statistics", "committedDate": "2020-02-20T13:10:23Z", "type": "commit"}, {"oid": "f1107f39bb2d84b9ab2d41f913d70cef181f071c", "url": "https://github.com/epam/cloud-pipeline/commit/f1107f39bb2d84b9ab2d41f913d70cef181f071c", "message": "issue #548: Implement storage usage statistics retrieval via pipe - fix for field that should be indexed", "committedDate": "2020-02-20T13:47:08Z", "type": "commit"}, {"oid": "886b6b0d987d7beced339b570cf4fe5cfeb00665", "url": "https://github.com/epam/cloud-pipeline/commit/886b6b0d987d7beced339b570cf4fe5cfeb00665", "message": "Issue #548: Implement storage usage statistics retrieval via pipe - NFS support for CLI", "committedDate": "2020-02-21T11:01:46Z", "type": "commit"}, {"oid": "6f4bb95352d322cbc968f30efc04f2a4ff8f1d02", "url": "https://github.com/epam/cloud-pipeline/commit/6f4bb95352d322cbc968f30efc04f2a4ff8f1d02", "message": "issue #548: Implement storage usage statistics retrieval via pipe - fix for data storage loading", "committedDate": "2020-02-21T11:21:40Z", "type": "commit"}, {"oid": "b4d4b74cbca4e2ad4b98d40a64018cd7b7450b53", "url": "https://github.com/epam/cloud-pipeline/commit/b4d4b74cbca4e2ad4b98d40a64018cd7b7450b53", "message": "Issue #548: Implement storage usage statistics retrieval via pipe - use method GET datastorage/path/usage for all buckets usage listing", "committedDate": "2020-02-21T12:38:46Z", "type": "commit"}, {"oid": "99d719a65c497f8de661053df2a37eec3f2b522e", "url": "https://github.com/epam/cloud-pipeline/commit/99d719a65c497f8de661053df2a37eec3f2b522e", "message": "Issue #548: Implement storage usage statistics retrieval via pipe - temporary wrap for load usage api method", "committedDate": "2020-02-21T13:11:24Z", "type": "commit"}, {"oid": "9c9506c6903503a7196870df8ad6830da33f26fa", "url": "https://github.com/epam/cloud-pipeline/commit/9c9506c6903503a7196870df8ad6830da33f26fa", "message": "issue #548: Implement storage usage statistics retrieval via pipe - cleanup", "committedDate": "2020-02-21T13:13:40Z", "type": "commit"}, {"oid": "6b15a7ce76b3da63face98bbbf1bfc9c94c8b702", "url": "https://github.com/epam/cloud-pipeline/commit/6b15a7ce76b3da63face98bbbf1bfc9c94c8b702", "message": "Issue #548: Implement storage usage statistics retrieval via pipe - cleanup", "committedDate": "2020-02-21T14:08:28Z", "type": "commit"}, {"oid": "06d73dd5e357f9bcd124b4ef1a5448cf24100ec9", "url": "https://github.com/epam/cloud-pipeline/commit/06d73dd5e357f9bcd124b4ef1a5448cf24100ec9", "message": "Issue #548: Implement storage usage statistics retrieval via pipe - throw unsupported exceptions for azure and gs providers for now", "committedDate": "2020-02-21T14:26:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjYwMDU1Mg==", "url": "https://github.com/epam/cloud-pipeline/pull/979#discussion_r382600552", "bodyText": "It seems that method name is misleading", "author": "mzueva", "createdAt": "2020-02-21T14:10:46Z", "path": "pipe-cli/pipe.py", "diffHunk": "@@ -901,6 +902,16 @@ def storage_copy_item(source, destination, recursive, force, exclude, include, q\n                              exclude, include, quiet, tags, file_list, symlinks, skip_existing=skip_existing)\n \n \n+@storage.command('du')\n+@click.argument('path', required=False)\n+@click.option('-f', '--format', help='Format for size [G/M/K]',\n+              type=click.Choice(DuFormatType.possible_types()), required=False, default='M')\n+@click.option('-d', '--depth', help='Depth level', type=int, required=False)\n+@Config.validate_access_token(quiet_flag_property_name='quiet')\n+def storage_copy_item(path, format, depth):", "originalCommit": "9c9506c6903503a7196870df8ad6830da33f26fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjYwNDc1Nw==", "url": "https://github.com/epam/cloud-pipeline/pull/979#discussion_r382604757", "bodyText": "Could we extract this logic into a separate method to make it more readable?", "author": "mzueva", "createdAt": "2020-02-21T14:18:59Z", "path": "pipe-cli/src/utilities/storage/s3.py", "diffHunk": "@@ -411,6 +414,83 @@ def list_items(self, relative_path=None, recursive=False, page_size=StorageOpera\n         else:\n             return self.list_objects(client, prefix, operation_parameters, recursive)\n \n+    def get_summary_with_depth(self, max_depth, relative_path=None):\n+        bucket_name = self.bucket.bucket.path\n+        delimiter = S3BucketOperations.S3_PATH_SEPARATOR\n+        client = self.session.client('s3', config=S3BucketOperations.get_proxy_config())\n+        operation_parameters = {\n+            'Bucket': bucket_name\n+        }\n+        prefix = S3BucketOperations.get_prefix(delimiter, relative_path)\n+        if relative_path:\n+            operation_parameters['Prefix'] = prefix\n+            max_depth += len(prefix.split(delimiter))\n+\n+        paginator = client.get_paginator('list_objects_v2')\n+        page_iterator = paginator.paginate(**operation_parameters)\n+        result = Tree()\n+        relative_path_len = 0\n+        range_start = 1\n+        if relative_path:\n+            root_path = delimiter.join([bucket_name, relative_path])\n+            root = result.create_node(root_path, root_path, data=StorageItem())\n+            relative_path_len = len(relative_path.split(delimiter))\n+            range_start = relative_path_len + 1\n+        else:\n+            root = result.create_node(bucket_name, bucket_name, data=StorageItem())\n+\n+        for page in page_iterator:\n+            if 'Contents' in page:\n+                for file in page['Contents']:\n+                    name = self.get_file_name(file, prefix, True)\n+                    size = file['Size']\n+\n+                    tokens = name.split(delimiter)\n+                    root.data.add_item(size)\n+\n+                    if len(tokens) - relative_path_len > 1:\n+                        if relative_path:", "originalCommit": "9c9506c6903503a7196870df8ad6830da33f26fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjYwNTUzNw==", "url": "https://github.com/epam/cloud-pipeline/pull/979#discussion_r382605537", "bodyText": "missing final", "author": "mzueva", "createdAt": "2020-02-21T14:20:36Z", "path": "api/src/main/java/com/epam/pipeline/manager/security/GrantPermissionManager.java", "diffHunk": "@@ -412,6 +412,15 @@ public boolean storagePermission(Long storageId, String permissionName) {\n         }\n     }\n \n+    public boolean storagePermissionByName(final String identifier, final String permissionName) {\n+        AbstractSecuredEntity storage = entityManager.loadByNameOrId(AclClass.DATA_STORAGE, identifier);", "originalCommit": "9c9506c6903503a7196870df8ad6830da33f26fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDcxODQ3Mg==", "url": "https://github.com/epam/cloud-pipeline/pull/979#discussion_r384718472", "bodyText": "still missing final", "author": "mzueva", "createdAt": "2020-02-26T19:37:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjYwNTUzNw=="}], "type": "inlineReview"}, {"oid": "b3c4898bbc01425cf975d6db5dbd06a4c416ffbc", "url": "https://github.com/epam/cloud-pipeline/commit/b3c4898bbc01425cf975d6db5dbd06a4c416ffbc", "message": "Issue #548: Implement storage usage statistics retrieval via pipe - Azure support for CLI", "committedDate": "2020-02-25T11:26:43Z", "type": "commit"}, {"oid": "28666c6a30fdd539bcc61b36f3dccbdab04eedda", "url": "https://github.com/epam/cloud-pipeline/commit/28666c6a30fdd539bcc61b36f3dccbdab04eedda", "message": "Issue #548: Implement storage usage statistics retrieval via pipe - GCP support", "committedDate": "2020-02-26T13:22:00Z", "type": "commit"}, {"oid": "bd16ce22979001170d44eea9cae6021775990f59", "url": "https://github.com/epam/cloud-pipeline/commit/bd16ce22979001170d44eea9cae6021775990f59", "message": "issue #548: Implement storage usage statistics retrieval via pipe - cleanup", "committedDate": "2020-02-26T14:24:28Z", "type": "commit"}, {"oid": "21925474401e6381d15fb592c93fce2cc1a5c319", "url": "https://github.com/epam/cloud-pipeline/commit/21925474401e6381d15fb592c93fce2cc1a5c319", "message": "Issue #548: Implement storage usage statistics retrieval via pipe - split input storage path into storage name and relative path", "committedDate": "2020-02-27T09:55:15Z", "type": "commit"}, {"oid": "abe5d5f489da59b01f524f80e9a4512b60832687", "url": "https://github.com/epam/cloud-pipeline/commit/abe5d5f489da59b01f524f80e9a4512b60832687", "message": "Issue #548: Implement storage usage statistics retrieval via pipe - cleanup", "committedDate": "2020-02-27T10:39:42Z", "type": "commit"}, {"oid": "6eb2c187958fc6089b4a7c99799a2ef4fb27a8c4", "url": "https://github.com/epam/cloud-pipeline/commit/6eb2c187958fc6089b4a7c99799a2ef4fb27a8c4", "message": "Issue #548: Implement storage usage statistics retrieval via pipe - fix for relative path", "committedDate": "2020-02-27T10:47:15Z", "type": "commit"}]}