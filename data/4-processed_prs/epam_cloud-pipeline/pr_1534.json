{"pr_number": 1534, "pr_title": "Implement passwordless ssh support in pipe tunnel", "pr_createdAt": "2020-11-02T09:13:15Z", "pr_url": "https://github.com/epam/cloud-pipeline/pull/1534", "timeline": [{"oid": "7d94123f468bcaec0c03553cf0218b1c7872029c", "url": "https://github.com/epam/cloud-pipeline/commit/7d94123f468bcaec0c03553cf0218b1c7872029c", "message": "Add proper error handling and allow changing default timeout", "committedDate": "2020-11-05T12:33:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE3MzAzOA==", "url": "https://github.com/epam/cloud-pipeline/pull/1534#discussion_r525173038", "bodyText": "If the goal is to print stack trace we can use something like traceback.print_exc() in except section", "author": "mzueva", "createdAt": "2020-11-17T13:56:34Z", "path": "pipe-cli/pipe.py", "diffHunk": "@@ -1226,42 +1227,82 @@ def ssh(ctx, run_id, retries):\n @click.argument('run-id', required=True, type=int)\n @click.option('-lp', '--local-port', required=True, type=int, help='Local port to establish connection from')\n @click.option('-rp', '--remote-port', required=True, type=int, help='Remote port to establish connection to')\n+@click.option('-ct', '--connection-timeout', required=False, type=float, default=0,\n+              help='Socket connection timeout in seconds')\n+@click.option('-s', '--ssh', required=False, is_flag=True, default=False,\n+              help='Configures passwordless ssh to specified run instance. '\n+                   'Supported on Linux only.')\n+@click.option('-sp', '--ssh-path', required=False, type=str,\n+              help='Path to .ssh directory for passwordless ssh configuration')\n+@click.option('-sh', '--ssh-host', required=False, type=str,\n+              help='Host name for passwordless ssh configuration')\n+@click.option('-sk', '--ssh-keep', required=False, is_flag=True, default=False,\n+              help='Keeps passwordless ssh configuration after tunnel stopping')\n @click.option('-l', '--log-file', required=False, help='Logs file for tunnel in background mode')\n @click.option('-v', '--log-level', required=False, help='Logs level for tunnel: '\n                                                         'CRITICAL, ERROR, WARNING, INFO or DEBUG')\n-@click.option('-t', '--timeout', required=False, type=int, default=1000,\n+@click.option('-t', '--timeout', required=False, type=int, default=5 * 1000,\n               help='Time period in ms for background tunnel process health check')\n @click.option('-f', '--foreground', required=False, is_flag=True, default=False,\n               help='Establishes tunnel in foreground mode')\n @click.option('-u', '--user', required=False, callback=set_user_token, expose_value=False, help=USER_OPTION_DESCRIPTION)\n+@click.option('-r', '--retries', required=False, type=int, default=10, help=RETRIES_OPTION_DESCRIPTION)\n+@click.option('--trace', required=False, is_flag=True, default=False, help=TRACE_OPTION_DESCRIPTION)\n @Config.validate_access_token\n-def tunnel(run_id, local_port, remote_port, log_file, log_level, timeout, foreground):\n+def tunnel(run_id, local_port, remote_port, connection_timeout,\n+           ssh, ssh_path, ssh_host, ssh_keep, log_file, log_level,\n+           timeout, foreground, retries, trace):\n     \"\"\"\n     Establishes tunnel connection to specified run instance port and serves it as a local port.\n \n     It allows to transfer any tcp traffic from local machine to run instance and works both on Linux and Windows.\n \n-    For example it can be used to allow ssh connections to run instance.\n+    Additionally it enables passwordless ssh connections if the corresponding option is specified.\n+    Once specified ssh is configured both locally and remotely to support passwordless connections.\n+    Passwordless ssh configuration is supported only for openssh client on Linux.\n+\n+    Examples:\n+\n+    I. Example of simple tcp port tunnel connection establishing.\n+\n+    Establish tunnel connection from run (12345) instance port (4567) to the same local port.\n+\n+        pipe tunnel -lp 4567 -rp 4567 12345\n+\n+    II. Example of ssh port tunnel connection establishing with enabled passwordless ssh configuration.\n \n-    \\b\n     First of all establish tunnel connection from run (12345) instance ssh port (22) to some local port (4567).\n-        pipe tunnel -lp 4567 -rp 22 12345\n \n-    \\b\n-    Then connect to run instance using regular ssh client on the configured local port (4567).\n-        ssh -p 4567 root@localhost\n+        pipe tunnel -lp 4567 -rp 22 --ssh 12345\n+\n+    Then connect to run instance using regular ssh client.\n+\n+        ssh root@pipeline-12345\n+\n+    Or transfer some files to and from run instance using regular scp client.\n+\n+        scp file.txt root@pipeline-12345:/common/workdir/file.txt\n+\n+    Advanced tunnel configuration environment variables:\n \n     \\b\n-    Additionally the following environment variables can be used to specify the exact tunnel properties.\n-        CP_CLI_TUNNEL_PROXY_HOST\n-        CP_CLI_TUNNEL_PROXY_PORT\n-        CP_CLI_TUNNEL_TARGET_HOST\n+        CP_CLI_TUNNEL_PROXY_HOST - tunnel proxy host\n+        CP_CLI_TUNNEL_PROXY_PORT - tunnel proxy port\n+        CP_CLI_TUNNEL_TARGET_HOST - tunnel target host\n+        CP_CLI_TUNNEL_SERVER_ADDRESS - tunnel server address\n     \"\"\"\n-    try:\n-        create_tunnel(run_id, local_port, remote_port, log_file, log_level, timeout, foreground)\n-    except Exception as runtime_error:\n-        click.echo('Error: {}'.format(str(runtime_error)), err=True)\n-        sys.exit(1)\n+    if trace:", "originalCommit": "fbdb1d1041737a560b9c0b3fc15a69af15e83d5c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b025e3481a47f7a529ef031b9eba000e5fabaf33", "url": "https://github.com/epam/cloud-pipeline/commit/b025e3481a47f7a529ef031b9eba000e5fabaf33", "message": "Add support for automatically configured passwordless ssh", "committedDate": "2020-11-17T14:55:49Z", "type": "commit"}, {"oid": "520b40d7bcbc176d08ac8187c5e98205bfce75f5", "url": "https://github.com/epam/cloud-pipeline/commit/520b40d7bcbc176d08ac8187c5e98205bfce75f5", "message": "Add retries to pipe tunnel command with passwordless ssh", "committedDate": "2020-11-17T14:55:49Z", "type": "commit"}, {"oid": "7d777aeb3f300b7357f5e4abaaa1857f7886b47c", "url": "https://github.com/epam/cloud-pipeline/commit/7d777aeb3f300b7357f5e4abaaa1857f7886b47c", "message": "Add support for passwordless ssh both to root and run owner", "committedDate": "2020-11-17T14:55:50Z", "type": "commit"}, {"oid": "98d3045215b63e35927161772aec39fdcebe7b93", "url": "https://github.com/epam/cloud-pipeline/commit/98d3045215b63e35927161772aec39fdcebe7b93", "message": "Add missing semicolon", "committedDate": "2020-11-17T14:55:50Z", "type": "commit"}, {"oid": "c34ae7c1cd572c017ef9cb04d4a13c1fa5ba066c", "url": "https://github.com/epam/cloud-pipeline/commit/c34ae7c1cd572c017ef9cb04d4a13c1fa5ba066c", "message": "Improve pipe tunnel docs and rearrange methods", "committedDate": "2020-11-17T14:55:51Z", "type": "commit"}, {"oid": "2140155a1542e798d5cf01369fd1ec99d69668b1", "url": "https://github.com/epam/cloud-pipeline/commit/2140155a1542e798d5cf01369fd1ec99d69668b1", "message": "Add more examples to pipe tunnel docs", "committedDate": "2020-11-17T14:55:51Z", "type": "commit"}, {"oid": "252b33b4a125cb954465a93dd88ac8d79b976e64", "url": "https://github.com/epam/cloud-pipeline/commit/252b33b4a125cb954465a93dd88ac8d79b976e64", "message": "Create pseudo terminal for background tunnel", "committedDate": "2020-11-17T14:55:52Z", "type": "commit"}, {"oid": "7c5ad880969f53ea51967b62e11628fc3d19f4da", "url": "https://github.com/epam/cloud-pipeline/commit/7c5ad880969f53ea51967b62e11628fc3d19f4da", "message": "Add support for WSL in pipe tunnel passwordless ssh", "committedDate": "2020-11-17T14:55:52Z", "type": "commit"}, {"oid": "8e3869c0e745cf3044a4ca9be1d59d9def79f1f4", "url": "https://github.com/epam/cloud-pipeline/commit/8e3869c0e745cf3044a4ca9be1d59d9def79f1f4", "message": "Add proper error handling and allow changing default timeout", "committedDate": "2020-11-17T14:55:52Z", "type": "commit"}, {"oid": "cd127b8b03055b2f76ece9503c6b88142c1ee44b", "url": "https://github.com/epam/cloud-pipeline/commit/cd127b8b03055b2f76ece9503c6b88142c1ee44b", "message": "Handle missing ssh config file case", "committedDate": "2020-11-17T14:55:53Z", "type": "commit"}, {"oid": "cd44db61ff24cdc90938fc730704b594ac341ff7", "url": "https://github.com/epam/cloud-pipeline/commit/cd44db61ff24cdc90938fc730704b594ac341ff7", "message": "Add proper permissions for creating ssh config files", "committedDate": "2020-11-17T14:55:53Z", "type": "commit"}, {"oid": "30fe50e2a208c965fd58d1ea3cbe3ead549226a0", "url": "https://github.com/epam/cloud-pipeline/commit/30fe50e2a208c965fd58d1ea3cbe3ead549226a0", "message": "Use ssh default root user in case of missing preference", "committedDate": "2020-11-17T14:55:54Z", "type": "commit"}, {"oid": "8044cfa3e70033988496190b55b225c6498cab26", "url": "https://github.com/epam/cloud-pipeline/commit/8044cfa3e70033988496190b55b225c6498cab26", "message": "Add support for passwordless ssh host name overriding", "committedDate": "2020-11-17T14:55:54Z", "type": "commit"}, {"oid": "f7387ef2c6e3dd4ca4dab0c31e46bfae46d4eb11", "url": "https://github.com/epam/cloud-pipeline/commit/f7387ef2c6e3dd4ca4dab0c31e46bfae46d4eb11", "message": "Create ssh directory if it doesn't exist and clean up known hosts", "committedDate": "2020-11-17T14:55:55Z", "type": "commit"}, {"oid": "16b173677d32feec802a37070c02756613f8e2e9", "url": "https://github.com/epam/cloud-pipeline/commit/16b173677d32feec802a37070c02756613f8e2e9", "message": "Increase tunnel default timeouts", "committedDate": "2020-11-17T14:55:55Z", "type": "commit"}, {"oid": "701cbf22adc3454f0f8911fd913c686ff06929d3", "url": "https://github.com/epam/cloud-pipeline/commit/701cbf22adc3454f0f8911fd913c686ff06929d3", "message": "Improve stability and logging of passwordless ssh configuration", "committedDate": "2020-11-17T14:55:55Z", "type": "commit"}, {"oid": "738f0fc2aca3fc86f31f01611381a303ecd981b8", "url": "https://github.com/epam/cloud-pipeline/commit/738f0fc2aca3fc86f31f01611381a303ecd981b8", "message": "Use traceback module to print stacktraces", "committedDate": "2020-11-17T14:55:56Z", "type": "commit"}, {"oid": "738f0fc2aca3fc86f31f01611381a303ecd981b8", "url": "https://github.com/epam/cloud-pipeline/commit/738f0fc2aca3fc86f31f01611381a303ecd981b8", "message": "Use traceback module to print stacktraces", "committedDate": "2020-11-17T14:55:56Z", "type": "forcePushed"}]}