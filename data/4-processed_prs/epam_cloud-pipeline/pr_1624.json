{"pr_number": 1624, "pr_title": "Issue 1615 Route53 integration to be able to create custom dns records for the tools", "pr_createdAt": "2020-12-02T10:45:37Z", "pr_url": "https://github.com/epam/cloud-pipeline/pull/1624", "timeline": [{"oid": "3648e6e743151cc5199dfb7ebd98973e2259ec95", "url": "https://github.com/epam/cloud-pipeline/commit/3648e6e743151cc5199dfb7ebd98973e2259ec95", "message": "issue #1615 WIP implement possibility to create custom dns records if specified (aws only)", "committedDate": "2020-12-03T08:48:33Z", "type": "commit"}, {"oid": "f0d141a49773ee95a8b2715ecb7526b7b0ac9d33", "url": "https://github.com/epam/cloud-pipeline/commit/f0d141a49773ee95a8b2715ecb7526b7b0ac9d33", "message": "issue #1615 fail run if custom DNS record couldn't be created", "committedDate": "2020-12-03T08:48:33Z", "type": "commit"}, {"oid": "9c3e5e025c83bc11784e43a87c9082047e723441", "url": "https://github.com/epam/cloud-pipeline/commit/9c3e5e025c83bc11784e43a87c9082047e723441", "message": "issue #1615 do not fail if DNS record already exist when api trying to create it", "committedDate": "2020-12-03T08:48:33Z", "type": "commit"}, {"oid": "f46649cea028c2ae50938c7692b609024769d61c", "url": "https://github.com/epam/cloud-pipeline/commit/f46649cea028c2ae50938c7692b609024769d61c", "message": "issue #1615 refactor", "committedDate": "2020-12-03T08:48:34Z", "type": "commit"}, {"oid": "0510ac5cef2b7e13f19c5164d760dab331004a55", "url": "https://github.com/epam/cloud-pipeline/commit/0510ac5cef2b7e13f19c5164d760dab331004a55", "message": "issue #1615 move removing of DNS records to api server code", "committedDate": "2020-12-03T08:48:34Z", "type": "commit"}, {"oid": "a74d4f8e5e5fc88f6ffc48b3dba86d5541efda12", "url": "https://github.com/epam/cloud-pipeline/commit/a74d4f8e5e5fc88f6ffc48b3dba86d5541efda12", "message": "issue #1615 small fixes", "committedDate": "2020-12-03T08:48:34Z", "type": "commit"}, {"oid": "24e76195180b1e0ab775b3ed82b8bef68140efa8", "url": "https://github.com/epam/cloud-pipeline/commit/24e76195180b1e0ab775b3ed82b8bef68140efa8", "message": "issue #1615 change customDNS flag location", "committedDate": "2020-12-03T08:48:35Z", "type": "commit"}, {"oid": "a9658a811ac8ce41ac5f2a094ec98108ac782d75", "url": "https://github.com/epam/cloud-pipeline/commit/a9658a811ac8ce41ac5f2a094ec98108ac782d75", "message": "issue #1615 refactor", "committedDate": "2020-12-03T11:00:21Z", "type": "forcePushed"}, {"oid": "0c7595d54aeb5ea3d128db5d60ca5ace260bdd44", "url": "https://github.com/epam/cloud-pipeline/commit/0c7595d54aeb5ea3d128db5d60ca5ace260bdd44", "message": "issue #1615 refactor", "committedDate": "2020-12-03T11:02:52Z", "type": "commit"}, {"oid": "0c7595d54aeb5ea3d128db5d60ca5ace260bdd44", "url": "https://github.com/epam/cloud-pipeline/commit/0c7595d54aeb5ea3d128db5d60ca5ace260bdd44", "message": "issue #1615 refactor", "committedDate": "2020-12-03T11:02:52Z", "type": "forcePushed"}, {"oid": "435f9959dce4776b0379e59451cef842bf1bb81c", "url": "https://github.com/epam/cloud-pipeline/commit/435f9959dce4776b0379e59451cef842bf1bb81c", "message": "Tool settings: 'Use sub-domain' property", "committedDate": "2020-12-03T13:57:52Z", "type": "commit"}, {"oid": "27fc6341bf88fcedbfed609d228a544ac04ed9e4", "url": "https://github.com/epam/cloud-pipeline/commit/27fc6341bf88fcedbfed609d228a544ac04ed9e4", "message": "issue #1615 fixes", "committedDate": "2020-12-04T16:57:58Z", "type": "commit"}, {"oid": "27fc6341bf88fcedbfed609d228a544ac04ed9e4", "url": "https://github.com/epam/cloud-pipeline/commit/27fc6341bf88fcedbfed609d228a544ac04ed9e4", "message": "issue #1615 fixes", "committedDate": "2020-12-04T16:57:58Z", "type": "forcePushed"}, {"oid": "06622f2a75c59a881dec09e1209eeb41d47a9c3d", "url": "https://github.com/epam/cloud-pipeline/commit/06622f2a75c59a881dec09e1209eeb41d47a9c3d", "message": "issue #1615 fixe to create inc file instead of loc file for all locations with custom dns", "committedDate": "2020-12-06T16:54:25Z", "type": "commit"}, {"oid": "abe8d3e6b3c31523c251d5eacfa7b7b43d2bea0e", "url": "https://github.com/epam/cloud-pipeline/commit/abe8d3e6b3c31523c251d5eacfa7b7b43d2bea0e", "message": "issue #1615 fix to correctly fail run if creation of dns record is impossible", "committedDate": "2020-12-07T09:37:18Z", "type": "commit"}, {"oid": "38281883b85092024e5f25d4272855f9bb1dcc7e", "url": "https://github.com/epam/cloud-pipeline/commit/38281883b85092024e5f25d4272855f9bb1dcc7e", "message": "issue #1615 do not wait when trying to delete DNS record", "committedDate": "2020-12-07T12:17:36Z", "type": "commit"}, {"oid": "391f0ea482b8fe2d669efcf5a71f9239bfedecb5", "url": "https://github.com/epam/cloud-pipeline/commit/391f0ea482b8fe2d669efcf5a71f9239bfedecb5", "message": "issue #1615 create locations for custom dns asynchronously", "committedDate": "2020-12-08T08:33:59Z", "type": "commit"}, {"oid": "45122747b4ea27ce806f5e00e6c33db321363db6", "url": "https://github.com/epam/cloud-pipeline/commit/45122747b4ea27ce806f5e00e6c33db321363db6", "message": "issue #1615 do not sort locations before process", "committedDate": "2020-12-08T08:54:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQxODQ4Nw==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r538418487", "bodyText": "I think that edge service is running under admin account, so we can add @PreAuthorize(ADMIN_ONLY) here", "author": "mzueva", "createdAt": "2020-12-08T14:14:34Z", "path": "api/src/main/java/com/epam/pipeline/acl/cluster/ClusterApiService.java", "diffHunk": "@@ -112,4 +113,11 @@ public AllowedInstanceAndPriceTypes getAllowedInstanceAndPriceTypes(final Long t\n     public List<NodeDisk> loadNodeDisks(final String name) {\n         return nodeDiskManager.loadByNodeId(name);\n     }\n+\n+\n+    public InstanceDNSRecord changeInstanceDNSRecord(final Long regionId, final InstanceDNSRecord dnsRecord,", "originalCommit": "45122747b4ea27ce806f5e00e6c33db321363db6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQyMDA2Mg==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r538420062", "bodyText": "missing final", "author": "mzueva", "createdAt": "2020-12-08T14:16:09Z", "path": "api/src/main/java/com/epam/pipeline/controller/cluster/ClusterController.java", "diffHunk": "@@ -236,4 +238,17 @@ public void downloadNodeUsageStatisticsReport(\n     public Result<List<NodeDisk>> loadNodeDisks(@PathVariable(value = NAME) final String name) {\n         return Result.success(clusterApiService.loadNodeDisks(name));\n     }\n+\n+    @PostMapping(\"/cluster/dnsrecord\")\n+    @ResponseBody\n+    @ApiOperation(\n+            value = \"Creates or deletes dns record.\",\n+            notes = \"Creates or deletes dns record.\",\n+            produces = MediaType.APPLICATION_JSON_VALUE)\n+    @ApiResponses(value = {@ApiResponse(code = HTTP_STATUS_OK, message = API_STATUS_DESCRIPTION)})\n+    public Result<InstanceDNSRecord> dnsRecordChangeRequest(@RequestParam(required = false) final Long regionId,\n+                                                            @RequestParam(defaultValue = \"false\") final boolean delete,\n+                                                            @RequestBody InstanceDNSRecord dnsRecord) {", "originalCommit": "45122747b4ea27ce806f5e00e6c33db321363db6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQyMTQ4Ng==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r538421486", "bodyText": "missing final", "author": "mzueva", "createdAt": "2020-12-08T14:17:21Z", "path": "api/src/main/java/com/epam/pipeline/manager/cloud/CloudFacadeImpl.java", "diffHunk": "@@ -259,6 +260,23 @@ public CloudInstanceState getInstanceState(final Long runId) {\n         return getInstanceService(region).getInstanceState(region, String.valueOf(runId));\n     }\n \n+    @Override\n+    public InstanceDNSRecord changeInstanceDNSRecord(Long regionId, final InstanceDNSRecord dnsRecord, final boolean delete) {", "originalCommit": "45122747b4ea27ce806f5e00e6c33db321363db6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQyMjQ4OQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r538422489", "bodyText": "redundant empty line", "author": "mzueva", "createdAt": "2020-12-08T14:18:13Z", "path": "api/src/main/java/com/epam/pipeline/manager/cloud/CloudFacadeImpl.java", "diffHunk": "@@ -259,6 +260,23 @@ public CloudInstanceState getInstanceState(final Long runId) {\n         return getInstanceService(region).getInstanceState(region, String.valueOf(runId));\n     }\n \n+    @Override\n+    public InstanceDNSRecord changeInstanceDNSRecord(Long regionId, final InstanceDNSRecord dnsRecord, final boolean delete) {\n+", "originalCommit": "45122747b4ea27ce806f5e00e6c33db321363db6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQyMzE2OA==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r538423168", "bodyText": "We can use noneMatch here", "author": "mzueva", "createdAt": "2020-12-08T14:18:52Z", "path": "api/src/main/java/com/epam/pipeline/manager/cloud/CloudFacadeImpl.java", "diffHunk": "@@ -259,6 +260,23 @@ public CloudInstanceState getInstanceState(final Long runId) {\n         return getInstanceService(region).getInstanceState(region, String.valueOf(runId));\n     }\n \n+    @Override\n+    public InstanceDNSRecord changeInstanceDNSRecord(Long regionId, final InstanceDNSRecord dnsRecord, final boolean delete) {\n+\n+        if (delete && regionId == null) {\n+            List<PipelineRun> runs = pipelineRunManager.loadAllRunsByServiceURL(dnsRecord.getDnsRecord());\n+            if (!runs.stream().allMatch(pipelineRun -> pipelineRun.getEndDate() != null)) {", "originalCommit": "45122747b4ea27ce806f5e00e6c33db321363db6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQyNDM0Nw==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r538424347", "bodyText": "I would also add or !pipelineRun.getStatus().isFinal()", "author": "mzueva", "createdAt": "2020-12-08T14:19:55Z", "path": "api/src/main/java/com/epam/pipeline/manager/cloud/CloudFacadeImpl.java", "diffHunk": "@@ -259,6 +260,23 @@ public CloudInstanceState getInstanceState(final Long runId) {\n         return getInstanceService(region).getInstanceState(region, String.valueOf(runId));\n     }\n \n+    @Override\n+    public InstanceDNSRecord changeInstanceDNSRecord(Long regionId, final InstanceDNSRecord dnsRecord, final boolean delete) {\n+\n+        if (delete && regionId == null) {\n+            List<PipelineRun> runs = pipelineRunManager.loadAllRunsByServiceURL(dnsRecord.getDnsRecord());\n+            if (!runs.stream().allMatch(pipelineRun -> pipelineRun.getEndDate() != null)) {", "originalCommit": "45122747b4ea27ce806f5e00e6c33db321363db6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQyNjI0MA==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r538426240", "bodyText": "Please, do not mutate input arguments, introduce a new variable instead. You can extract logic to determine actual region id to a separate method.", "author": "mzueva", "createdAt": "2020-12-08T14:21:38Z", "path": "api/src/main/java/com/epam/pipeline/manager/cloud/CloudFacadeImpl.java", "diffHunk": "@@ -259,6 +260,23 @@ public CloudInstanceState getInstanceState(final Long runId) {\n         return getInstanceService(region).getInstanceState(region, String.valueOf(runId));\n     }\n \n+    @Override\n+    public InstanceDNSRecord changeInstanceDNSRecord(Long regionId, final InstanceDNSRecord dnsRecord, final boolean delete) {\n+\n+        if (delete && regionId == null) {\n+            List<PipelineRun> runs = pipelineRunManager.loadAllRunsByServiceURL(dnsRecord.getDnsRecord());\n+            if (!runs.stream().allMatch(pipelineRun -> pipelineRun.getEndDate() != null)) {\n+                log.warn(\"Won't try to delete dns record: \" + dnsRecord.getDnsRecord() + \" because it is still used a least in one active run.\");\n+                return null;\n+            } else {\n+                regionId = runs.stream().findFirst().map(pipelineRun -> pipelineRun.getInstance().getCloudRegionId()).orElse(null);", "originalCommit": "45122747b4ea27ce806f5e00e6c33db321363db6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQyOTc5Mg==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r538429792", "bodyText": "What is the goal of using one method for getOrCreate and delete operations? If there is no some issues with this, I'd prefer to split these methods on all layers.", "author": "mzueva", "createdAt": "2020-12-08T14:25:11Z", "path": "api/src/main/java/com/epam/pipeline/controller/cluster/ClusterController.java", "diffHunk": "@@ -236,4 +238,17 @@ public void downloadNodeUsageStatisticsReport(\n     public Result<List<NodeDisk>> loadNodeDisks(@PathVariable(value = NAME) final String name) {\n         return Result.success(clusterApiService.loadNodeDisks(name));\n     }\n+\n+    @PostMapping(\"/cluster/dnsrecord\")", "originalCommit": "45122747b4ea27ce806f5e00e6c33db321363db6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQzMDgzOA==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r538430838", "bodyText": "We can make Route53Helper a bean to skip constructor call at every method call", "author": "mzueva", "createdAt": "2020-12-08T14:26:19Z", "path": "api/src/main/java/com/epam/pipeline/manager/cloud/aws/AWSInstanceService.java", "diffHunk": "@@ -271,6 +274,25 @@ public CloudInstanceState getInstanceState(final AwsRegion region, final String\n         return null;\n     }\n \n+    @Override\n+    public InstanceDNSRecord changeInstanceDNSRecord(final InstanceDNSRecord dnsRecord, final boolean delete) {\n+        if (dnsRecord.getDnsRecord().contains(preferenceManager.getPreference(SystemPreferences.INSTANCE_DNS_HOSTED_ZONE_BASE))) {\n+            if (delete) {\n+                return new Route53Helper()", "originalCommit": "45122747b4ea27ce806f5e00e6c33db321363db6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQzMTg4MA==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r538431880", "bodyText": "Missing final or you can simply return client without local variable assignment", "author": "mzueva", "createdAt": "2020-12-08T14:27:24Z", "path": "api/src/main/java/com/epam/pipeline/manager/cloud/aws/Route53Helper.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\n+ * Copyright 2017-2019 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.manager.cloud.aws;\n+\n+import com.amazonaws.services.route53.AmazonRoute53;\n+import com.amazonaws.services.route53.AmazonRoute53AsyncClientBuilder;\n+import com.amazonaws.services.route53.model.Change;\n+import com.amazonaws.services.route53.model.ChangeAction;\n+import com.amazonaws.services.route53.model.ChangeBatch;\n+import com.amazonaws.services.route53.model.ChangeResourceRecordSetsRequest;\n+import com.amazonaws.services.route53.model.ChangeResourceRecordSetsResult;\n+import com.amazonaws.services.route53.model.ChangeStatus;\n+import com.amazonaws.services.route53.model.GetChangeRequest;\n+import com.amazonaws.services.route53.model.GetChangeResult;\n+import com.amazonaws.services.route53.model.InvalidChangeBatchException;\n+import com.amazonaws.services.route53.model.ListResourceRecordSetsRequest;\n+import com.amazonaws.services.route53.model.RRType;\n+import com.amazonaws.services.route53.model.ResourceRecord;\n+import com.amazonaws.services.route53.model.ResourceRecordSet;\n+import com.amazonaws.services.route53.waiters.AmazonRoute53Waiters;\n+import com.amazonaws.waiters.FixedDelayStrategy;\n+import com.amazonaws.waiters.MaxAttemptsRetryStrategy;\n+import com.amazonaws.waiters.PollingStrategy;\n+import com.amazonaws.waiters.WaiterParameters;\n+import com.epam.pipeline.entity.cloud.InstanceDNSRecord;\n+import lombok.RequiredArgsConstructor;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+@RequiredArgsConstructor\n+public class Route53Helper {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(Route53Helper.class);\n+    private static final long TTL_TIME = 60L;\n+    private static final int MAX_ATTEMPTS = 100;\n+    private static final int DELAY_IN_SECONDS = 1;\n+\n+    public AmazonRoute53 getRoute53Client() {\n+        AmazonRoute53AsyncClientBuilder builder = AmazonRoute53AsyncClientBuilder.standard();", "originalCommit": "45122747b4ea27ce806f5e00e6c33db321363db6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQzMjk3OA==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r538432978", "bodyText": "Let's call method getOrCreate to make it more clear", "author": "mzueva", "createdAt": "2020-12-08T14:28:32Z", "path": "api/src/main/java/com/epam/pipeline/manager/cloud/aws/Route53Helper.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\n+ * Copyright 2017-2019 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.manager.cloud.aws;\n+\n+import com.amazonaws.services.route53.AmazonRoute53;\n+import com.amazonaws.services.route53.AmazonRoute53AsyncClientBuilder;\n+import com.amazonaws.services.route53.model.Change;\n+import com.amazonaws.services.route53.model.ChangeAction;\n+import com.amazonaws.services.route53.model.ChangeBatch;\n+import com.amazonaws.services.route53.model.ChangeResourceRecordSetsRequest;\n+import com.amazonaws.services.route53.model.ChangeResourceRecordSetsResult;\n+import com.amazonaws.services.route53.model.ChangeStatus;\n+import com.amazonaws.services.route53.model.GetChangeRequest;\n+import com.amazonaws.services.route53.model.GetChangeResult;\n+import com.amazonaws.services.route53.model.InvalidChangeBatchException;\n+import com.amazonaws.services.route53.model.ListResourceRecordSetsRequest;\n+import com.amazonaws.services.route53.model.RRType;\n+import com.amazonaws.services.route53.model.ResourceRecord;\n+import com.amazonaws.services.route53.model.ResourceRecordSet;\n+import com.amazonaws.services.route53.waiters.AmazonRoute53Waiters;\n+import com.amazonaws.waiters.FixedDelayStrategy;\n+import com.amazonaws.waiters.MaxAttemptsRetryStrategy;\n+import com.amazonaws.waiters.PollingStrategy;\n+import com.amazonaws.waiters.WaiterParameters;\n+import com.epam.pipeline.entity.cloud.InstanceDNSRecord;\n+import lombok.RequiredArgsConstructor;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+@RequiredArgsConstructor\n+public class Route53Helper {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(Route53Helper.class);\n+    private static final long TTL_TIME = 60L;\n+    private static final int MAX_ATTEMPTS = 100;\n+    private static final int DELAY_IN_SECONDS = 1;\n+\n+    public AmazonRoute53 getRoute53Client() {\n+        AmazonRoute53AsyncClientBuilder builder = AmazonRoute53AsyncClientBuilder.standard();\n+        return builder.build();\n+    }\n+\n+    public InstanceDNSRecord createDNSRecord(final String hostedZoneId, final InstanceDNSRecord dnsRecord) {", "originalCommit": "45122747b4ea27ce806f5e00e6c33db321363db6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQzMzY2MA==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r538433660", "bodyText": "Missing final", "author": "mzueva", "createdAt": "2020-12-08T14:29:15Z", "path": "api/src/main/java/com/epam/pipeline/manager/cloud/aws/Route53Helper.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\n+ * Copyright 2017-2019 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.manager.cloud.aws;\n+\n+import com.amazonaws.services.route53.AmazonRoute53;\n+import com.amazonaws.services.route53.AmazonRoute53AsyncClientBuilder;\n+import com.amazonaws.services.route53.model.Change;\n+import com.amazonaws.services.route53.model.ChangeAction;\n+import com.amazonaws.services.route53.model.ChangeBatch;\n+import com.amazonaws.services.route53.model.ChangeResourceRecordSetsRequest;\n+import com.amazonaws.services.route53.model.ChangeResourceRecordSetsResult;\n+import com.amazonaws.services.route53.model.ChangeStatus;\n+import com.amazonaws.services.route53.model.GetChangeRequest;\n+import com.amazonaws.services.route53.model.GetChangeResult;\n+import com.amazonaws.services.route53.model.InvalidChangeBatchException;\n+import com.amazonaws.services.route53.model.ListResourceRecordSetsRequest;\n+import com.amazonaws.services.route53.model.RRType;\n+import com.amazonaws.services.route53.model.ResourceRecord;\n+import com.amazonaws.services.route53.model.ResourceRecordSet;\n+import com.amazonaws.services.route53.waiters.AmazonRoute53Waiters;\n+import com.amazonaws.waiters.FixedDelayStrategy;\n+import com.amazonaws.waiters.MaxAttemptsRetryStrategy;\n+import com.amazonaws.waiters.PollingStrategy;\n+import com.amazonaws.waiters.WaiterParameters;\n+import com.epam.pipeline.entity.cloud.InstanceDNSRecord;\n+import lombok.RequiredArgsConstructor;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+@RequiredArgsConstructor\n+public class Route53Helper {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(Route53Helper.class);\n+    private static final long TTL_TIME = 60L;\n+    private static final int MAX_ATTEMPTS = 100;\n+    private static final int DELAY_IN_SECONDS = 1;\n+\n+    public AmazonRoute53 getRoute53Client() {\n+        AmazonRoute53AsyncClientBuilder builder = AmazonRoute53AsyncClientBuilder.standard();\n+        return builder.build();\n+    }\n+\n+    public InstanceDNSRecord createDNSRecord(final String hostedZoneId, final InstanceDNSRecord dnsRecord) {\n+        LOGGER.info(\"Creating DNS record for hostedZoneId: \" + hostedZoneId + \" record: \" + dnsRecord.getDnsRecord() + \" and target: \" + dnsRecord.getTarget());\n+        final AmazonRoute53 client = getRoute53Client();\n+        if (!isDnsRecordExists(hostedZoneId, dnsRecord, client)) {\n+            try {\n+                final ChangeResourceRecordSetsResult result = performChangeRequest(hostedZoneId,\n+                        dnsRecord.getDnsRecord(), dnsRecord.getTarget(), client, ChangeAction.CREATE, true);\n+                return buildInstanceDNSRecord(dnsRecord.getDnsRecord(), dnsRecord.getTarget(), result.getChangeInfo().getStatus());\n+            } catch (InvalidChangeBatchException e) {\n+                LOGGER.error(\"AWS 53 Route service responded with: \" + e.getLocalizedMessage());\n+                if (e.getLocalizedMessage().matches(\".*Tried to create resource record set.*but it already exists.*\")) {\n+                    LOGGER.info(\"DNS Record already exists, API will proceed with this record.\");\n+                } else {\n+                    throw e;\n+                }\n+            }\n+        }\n+        return buildInstanceDNSRecord(dnsRecord.getDnsRecord(), dnsRecord.getTarget(), InstanceDNSRecord.DNSRecordStatus.INSYNC.name());\n+    }\n+\n+    public InstanceDNSRecord removeDNSRecord(final String hostedZoneId, final InstanceDNSRecord dnsRecord) {\n+        LOGGER.info(\"Removing DNS record: \" + dnsRecord.getDnsRecord() + \" for target: \" + dnsRecord.getTarget() + \" in hostedZoneId: \" + hostedZoneId);\n+        final AmazonRoute53 client = getRoute53Client();\n+        if (!isDnsRecordExists(hostedZoneId, dnsRecord, client)) {\n+            LOGGER.info(\"DNS record: \" + dnsRecord.getDnsRecord() + \" type: \" + getRRType(dnsRecord.getTarget()) + \" for target: \" + dnsRecord.getTarget()\n+                    + \" in hostedZoneId: \" + hostedZoneId + \" doesn't exists\");\n+            return buildInstanceDNSRecord(dnsRecord.getDnsRecord(), dnsRecord.getTarget(), InstanceDNSRecord.DNSRecordStatus.INSYNC.name());\n+        } else {\n+            final ChangeResourceRecordSetsResult result = performChangeRequest(hostedZoneId,\n+                    dnsRecord.getDnsRecord(), dnsRecord.getTarget(), client, ChangeAction.DELETE, false);\n+            return buildInstanceDNSRecord(dnsRecord.getDnsRecord(), dnsRecord.getTarget(), result.getChangeInfo().getStatus());\n+        }\n+\n+    }\n+\n+    private boolean isDnsRecordExists(final String hostedZoneId, final InstanceDNSRecord dnsRecord, final AmazonRoute53 client) {\n+        return client.listResourceRecordSets(new ListResourceRecordSetsRequest()\n+                .withHostedZoneId(hostedZoneId)\n+                .withStartRecordName(dnsRecord.getDnsRecord())\n+                .withStartRecordType(getRRType(dnsRecord.getTarget()))).getResourceRecordSets().stream()\n+                .map(ResourceRecordSet::getName)\n+                .anyMatch(resourceRecord -> resourceRecord.equalsIgnoreCase(dnsRecord.getDnsRecord())\n+                        || resourceRecord.equalsIgnoreCase(dnsRecord.getDnsRecord() + \".\"));\n+    }\n+\n+    private InstanceDNSRecord buildInstanceDNSRecord(final String dnsRecord,\n+                                                     final String target, final String status) {\n+        return new InstanceDNSRecord(dnsRecord, target, getStatus(status));\n+    }\n+\n+    private InstanceDNSRecord.DNSRecordStatus getStatus(final String status) {\n+        switch (status) {\n+            case \"PENDING\":\n+                return InstanceDNSRecord.DNSRecordStatus.PENDING;\n+            case \"INSYNC\":\n+                return InstanceDNSRecord.DNSRecordStatus.INSYNC;\n+            default:\n+                return InstanceDNSRecord.DNSRecordStatus.NO_OP;\n+        }\n+    }\n+\n+    private ChangeResourceRecordSetsResult performChangeRequest(final String hostedZoneId, final String dnsRecord,\n+                                                                final String target, final AmazonRoute53 client,\n+                                                                final ChangeAction action, final boolean await) {\n+        ChangeResourceRecordSetsResult result = client.changeResourceRecordSets(new ChangeResourceRecordSetsRequest()", "originalCommit": "45122747b4ea27ce806f5e00e6c33db321363db6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQzOTUxNA==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r538439514", "bodyText": "I'd suggest to move dns method/methods to a new apiService and manager classes, as ClusterApiService mostly works with kubernetes cluster, except for instance offers (but is another topic to discuss).", "author": "mzueva", "createdAt": "2020-12-08T14:34:52Z", "path": "api/src/main/java/com/epam/pipeline/acl/cluster/ClusterApiService.java", "diffHunk": "@@ -112,4 +113,11 @@ public AllowedInstanceAndPriceTypes getAllowedInstanceAndPriceTypes(final Long t\n     public List<NodeDisk> loadNodeDisks(final String name) {\n         return nodeDiskManager.loadByNodeId(name);\n     }\n+\n+\n+    public InstanceDNSRecord changeInstanceDNSRecord(final Long regionId, final InstanceDNSRecord dnsRecord,", "originalCommit": "45122747b4ea27ce806f5e00e6c33db321363db6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQ0MTc4Mg==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r538441782", "bodyText": "Can't we use JsonMapper.parseData instead of creating a new mapper?", "author": "mzueva", "createdAt": "2020-12-08T14:36:58Z", "path": "api/src/main/java/com/epam/pipeline/manager/cluster/cleaner/DNSRecordRunCleaner.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.manager.cluster.cleaner;\n+\n+import com.epam.pipeline.entity.cloud.InstanceDNSRecord;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cloud.aws.Route53Helper;\n+import com.epam.pipeline.manager.preference.PreferenceManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.utils.UtilsManager;\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Service;\n+import org.springframework.util.Assert;\n+import org.springframework.util.StringUtils;\n+\n+import java.io.IOException;\n+import java.util.Map;\n+\n+@Service\n+@Slf4j\n+public class DNSRecordRunCleaner implements RunCleaner {\n+\n+    private static final String HTTP = \"http://\";\n+    private static final String HTTPS = \"https://\";\n+    private static final String DELIMITER = \"/\";\n+    private static final String PORT_DELIMITER = \":\";\n+\n+    private final PreferenceManager preferenceManager;\n+    private final UtilsManager utilsManager;\n+    private final Route53Helper route53Helper = new Route53Helper();\n+    private final ObjectMapper mapper = new ObjectMapper();", "originalCommit": "45122747b4ea27ce806f5e00e6c33db321363db6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQ0MjI3MQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r538442271", "bodyText": "missing final", "author": "mzueva", "createdAt": "2020-12-08T14:37:21Z", "path": "api/src/main/java/com/epam/pipeline/manager/cluster/cleaner/DNSRecordRunCleaner.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.manager.cluster.cleaner;\n+\n+import com.epam.pipeline.entity.cloud.InstanceDNSRecord;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cloud.aws.Route53Helper;\n+import com.epam.pipeline.manager.preference.PreferenceManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.utils.UtilsManager;\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Service;\n+import org.springframework.util.Assert;\n+import org.springframework.util.StringUtils;\n+\n+import java.io.IOException;\n+import java.util.Map;\n+\n+@Service\n+@Slf4j\n+public class DNSRecordRunCleaner implements RunCleaner {\n+\n+    private static final String HTTP = \"http://\";\n+    private static final String HTTPS = \"https://\";\n+    private static final String DELIMITER = \"/\";\n+    private static final String PORT_DELIMITER = \":\";\n+\n+    private final PreferenceManager preferenceManager;\n+    private final UtilsManager utilsManager;\n+    private final Route53Helper route53Helper = new Route53Helper();\n+    private final ObjectMapper mapper = new ObjectMapper();\n+\n+    public DNSRecordRunCleaner(final PreferenceManager preferenceManager,\n+                               UtilsManager utilsManager) {", "originalCommit": "45122747b4ea27ce806f5e00e6c33db321363db6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQ0NDM1NA==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r538444354", "bodyText": "Let's invert if to improve readability.\nif (StringUtils.isEmpty(serviceUrls)) {\n    return;\n}\nfinal String hostZoneId = ...\n...", "author": "mzueva", "createdAt": "2020-12-08T14:39:10Z", "path": "api/src/main/java/com/epam/pipeline/manager/cluster/cleaner/DNSRecordRunCleaner.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.manager.cluster.cleaner;\n+\n+import com.epam.pipeline.entity.cloud.InstanceDNSRecord;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cloud.aws.Route53Helper;\n+import com.epam.pipeline.manager.preference.PreferenceManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.utils.UtilsManager;\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.stereotype.Service;\n+import org.springframework.util.Assert;\n+import org.springframework.util.StringUtils;\n+\n+import java.io.IOException;\n+import java.util.Map;\n+\n+@Service\n+@Slf4j\n+public class DNSRecordRunCleaner implements RunCleaner {\n+\n+    private static final String HTTP = \"http://\";\n+    private static final String HTTPS = \"https://\";\n+    private static final String DELIMITER = \"/\";\n+    private static final String PORT_DELIMITER = \":\";\n+\n+    private final PreferenceManager preferenceManager;\n+    private final UtilsManager utilsManager;\n+    private final Route53Helper route53Helper = new Route53Helper();\n+    private final ObjectMapper mapper = new ObjectMapper();\n+\n+    public DNSRecordRunCleaner(final PreferenceManager preferenceManager,\n+                               UtilsManager utilsManager) {\n+        this.preferenceManager = preferenceManager;\n+        this.utilsManager = utilsManager;\n+    }\n+\n+    @Override\n+    public void cleanResources(final PipelineRun run) {\n+        final String serviceUrls = run.getServiceUrl();\n+        if (!StringUtils.isEmpty(serviceUrls)) {", "originalCommit": "45122747b4ea27ce806f5e00e6c33db321363db6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQ0NTU2Nw==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r538445567", "bodyText": "missing final", "author": "mzueva", "createdAt": "2020-12-08T14:40:18Z", "path": "api/src/main/java/com/epam/pipeline/manager/utils/UtilsManager.java", "diffHunk": "@@ -53,6 +53,14 @@ public String buildSshUrl(Long runId) {\n         return buildUrl(SSH_URL_TEMPLATE, runId);\n     }\n \n+    public String getEdgeUrl() {\n+        ServiceDescription service = kubeManager.getServiceByLabel(edgeLabel);", "originalCommit": "45122747b4ea27ce806f5e00e6c33db321363db6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQ0NzQ4Nw==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r538447487", "bodyText": "It seems that some code is duplicated with buildUrl method", "author": "mzueva", "createdAt": "2020-12-08T14:42:00Z", "path": "api/src/main/java/com/epam/pipeline/manager/utils/UtilsManager.java", "diffHunk": "@@ -53,6 +53,14 @@ public String buildSshUrl(Long runId) {\n         return buildUrl(SSH_URL_TEMPLATE, runId);\n     }\n \n+    public String getEdgeUrl() {", "originalCommit": "45122747b4ea27ce806f5e00e6c33db321363db6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQ0ODc0Ng==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r538448746", "bodyText": "Is ip enough here? If it is so, let's rename method to getEdgeIP", "author": "mzueva", "createdAt": "2020-12-08T14:43:08Z", "path": "api/src/main/java/com/epam/pipeline/manager/utils/UtilsManager.java", "diffHunk": "@@ -53,6 +53,14 @@ public String buildSshUrl(Long runId) {\n         return buildUrl(SSH_URL_TEMPLATE, runId);\n     }\n \n+    public String getEdgeUrl() {\n+        ServiceDescription service = kubeManager.getServiceByLabel(edgeLabel);\n+        if (service == null) {\n+            throw new IllegalArgumentException(\"Edge server is not registered in the cluster.\");\n+        }\n+        return service.getIp();", "originalCommit": "45122747b4ea27ce806f5e00e6c33db321363db6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "42f79f2c04ca163f598c7c321f20a97e3ab19b6e", "url": "https://github.com/epam/cloud-pipeline/commit/42f79f2c04ca163f598c7c321f20a97e3ab19b6e", "message": "issue #1615 correction on review", "committedDate": "2020-12-08T16:15:19Z", "type": "commit"}, {"oid": "db6ca713431f437ef37455ba04edf049c14e247f", "url": "https://github.com/epam/cloud-pipeline/commit/db6ca713431f437ef37455ba04edf049c14e247f", "message": "issue #1615 move methods to new manager and service classes", "committedDate": "2020-12-08T16:30:47Z", "type": "commit"}, {"oid": "70f2fbcad92a3cd3157ac1aa6e2536524143360d", "url": "https://github.com/epam/cloud-pipeline/commit/70f2fbcad92a3cd3157ac1aa6e2536524143360d", "message": "issue #1615 corrections on review", "committedDate": "2020-12-09T10:34:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDA5NjkxMg==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r540096912", "bodyText": "Please, do not use star imports in the source code", "author": "mzueva", "createdAt": "2020-12-10T11:35:21Z", "path": "api/src/main/java/com/epam/pipeline/acl/cluster/ClusterApiService.java", "diffHunk": "@@ -39,9 +40,7 @@\n import org.springframework.security.access.prepost.PreAuthorize;\n import org.springframework.stereotype.Service;\n \n-import static com.epam.pipeline.security.acl.AclExpressions.NODE_READ;\n-import static com.epam.pipeline.security.acl.AclExpressions.NODE_READ_FILTER;\n-import static com.epam.pipeline.security.acl.AclExpressions.NODE_STOP;\n+import static com.epam.pipeline.security.acl.AclExpressions.*;", "originalCommit": "70f2fbcad92a3cd3157ac1aa6e2536524143360d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDA5OTU0MA==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r540099540", "bodyText": "It is better to use CloudFacade here rather than directly call AWS implementation as run may be assigned to any of cloud regions.", "author": "mzueva", "createdAt": "2020-12-10T11:39:48Z", "path": "api/src/main/java/com/epam/pipeline/manager/cluster/cleaner/DNSRecordRunCleaner.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.manager.cluster.cleaner;\n+\n+import com.epam.pipeline.config.JsonMapper;\n+import com.epam.pipeline.entity.cloud.InstanceDNSRecord;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cloud.aws.Route53Helper;\n+import com.epam.pipeline.manager.preference.PreferenceManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.utils.UtilsManager;\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.stereotype.Service;\n+import org.springframework.util.Assert;\n+import org.springframework.util.StringUtils;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+@Service\n+@Slf4j\n+public class DNSRecordRunCleaner implements RunCleaner {\n+\n+    private static final String HTTP = \"http://\";\n+    private static final String HTTPS = \"https://\";\n+    private static final String DELIMITER = \"/\";\n+    private static final String PORT_DELIMITER = \":\";\n+\n+    private final PreferenceManager preferenceManager;\n+    private final UtilsManager utilsManager;\n+    private final Route53Helper route53Helper;\n+\n+    public DNSRecordRunCleaner(final PreferenceManager preferenceManager,\n+                               final UtilsManager utilsManager,\n+                               final Route53Helper route53Helper) {\n+        this.preferenceManager = preferenceManager;\n+        this.utilsManager = utilsManager;\n+        this.route53Helper = route53Helper;", "originalCommit": "70f2fbcad92a3cd3157ac1aa6e2536524143360d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDEwMTU1Mg==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r540101552", "bodyText": "Unused import", "author": "mzueva", "createdAt": "2020-12-10T11:43:13Z", "path": "api/src/main/java/com/epam/pipeline/acl/cluster/ClusterApiService.java", "diffHunk": "@@ -22,6 +22,7 @@\n import java.util.List;\n \n import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cloud.InstanceDNSRecord;", "originalCommit": "70f2fbcad92a3cd3157ac1aa6e2536524143360d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9b2d7ab8169fe76fc2a606fde7055af897268eb3", "url": "https://github.com/epam/cloud-pipeline/commit/9b2d7ab8169fe76fc2a606fde7055af897268eb3", "message": "issue #1615 fix tests", "committedDate": "2020-12-11T11:18:53Z", "type": "commit"}, {"oid": "9b2d7ab8169fe76fc2a606fde7055af897268eb3", "url": "https://github.com/epam/cloud-pipeline/commit/9b2d7ab8169fe76fc2a606fde7055af897268eb3", "message": "issue #1615 fix tests", "committedDate": "2020-12-11T11:18:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg5MTQxNw==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r540891417", "bodyText": "Do not use star imports", "author": "mzueva", "createdAt": "2020-12-11T11:47:48Z", "path": "api/src/main/java/com/epam/pipeline/acl/cluster/InfrastructureApiService.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.entity.cloud.InstanceDNSRecord;\n+import com.epam.pipeline.manager.cluster.InfrastructureManager;\n+import lombok.RequiredArgsConstructor;\n+import org.springframework.security.access.prepost.PreAuthorize;\n+import org.springframework.stereotype.Service;\n+\n+import static com.epam.pipeline.security.acl.AclExpressions.*;", "originalCommit": "9b2d7ab8169fe76fc2a606fde7055af897268eb3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg5MTg3MA==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r540891870", "bodyText": "missing final", "author": "mzueva", "createdAt": "2020-12-11T11:48:38Z", "path": "api/src/main/java/com/epam/pipeline/manager/cloud/CloudFacadeImpl.java", "diffHunk": "@@ -259,6 +260,17 @@ public CloudInstanceState getInstanceState(final Long runId) {\n         return getInstanceService(region).getInstanceState(region, String.valueOf(runId));\n     }\n \n+    public InstanceDNSRecord createDNSRecord(final Long regionId, final InstanceDNSRecord dnsRecord) {\n+        AbstractCloudRegion cloudRegion = regionManager.loadOrDefault(regionId);", "originalCommit": "9b2d7ab8169fe76fc2a606fde7055af897268eb3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg5MTkwMA==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r540891900", "bodyText": "missing final", "author": "mzueva", "createdAt": "2020-12-11T11:48:42Z", "path": "api/src/main/java/com/epam/pipeline/manager/cloud/CloudFacadeImpl.java", "diffHunk": "@@ -259,6 +260,17 @@ public CloudInstanceState getInstanceState(final Long runId) {\n         return getInstanceService(region).getInstanceState(region, String.valueOf(runId));\n     }\n \n+    public InstanceDNSRecord createDNSRecord(final Long regionId, final InstanceDNSRecord dnsRecord) {\n+        AbstractCloudRegion cloudRegion = regionManager.loadOrDefault(regionId);\n+        return getInstanceService(cloudRegion).getOrCreateInstanceDNSRecord(dnsRecord);\n+    }\n+\n+    @Override\n+    public InstanceDNSRecord removeDNSRecord(final Long regionId, final InstanceDNSRecord dnsRecord) {\n+        AbstractCloudRegion cloudRegion = regionManager.loadOrDefault(regionId);", "originalCommit": "9b2d7ab8169fe76fc2a606fde7055af897268eb3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg5MjU3MQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r540892571", "bodyText": "license year -> 2017-2020", "author": "mzueva", "createdAt": "2020-12-11T11:49:58Z", "path": "api/src/main/java/com/epam/pipeline/manager/cloud/aws/Route53Helper.java", "diffHunk": "@@ -0,0 +1,183 @@\n+/*\n+ * Copyright 2017-2019 EPAM Systems, Inc. (https://www.epam.com/)", "originalCommit": "9b2d7ab8169fe76fc2a606fde7055af897268eb3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg5MzIzMg==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r540893232", "bodyText": "Let's use @Sl4j annotation instead of declaring a logger manually", "author": "mzueva", "createdAt": "2020-12-11T11:51:22Z", "path": "api/src/main/java/com/epam/pipeline/manager/cloud/aws/Route53Helper.java", "diffHunk": "@@ -0,0 +1,183 @@\n+/*\n+ * Copyright 2017-2019 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.manager.cloud.aws;\n+\n+import com.amazonaws.services.route53.AmazonRoute53;\n+import com.amazonaws.services.route53.AmazonRoute53AsyncClientBuilder;\n+import com.amazonaws.services.route53.model.Change;\n+import com.amazonaws.services.route53.model.ChangeAction;\n+import com.amazonaws.services.route53.model.ChangeBatch;\n+import com.amazonaws.services.route53.model.ChangeResourceRecordSetsRequest;\n+import com.amazonaws.services.route53.model.ChangeResourceRecordSetsResult;\n+import com.amazonaws.services.route53.model.ChangeStatus;\n+import com.amazonaws.services.route53.model.GetChangeRequest;\n+import com.amazonaws.services.route53.model.GetChangeResult;\n+import com.amazonaws.services.route53.model.InvalidChangeBatchException;\n+import com.amazonaws.services.route53.model.ListResourceRecordSetsRequest;\n+import com.amazonaws.services.route53.model.RRType;\n+import com.amazonaws.services.route53.model.ResourceRecord;\n+import com.amazonaws.services.route53.model.ResourceRecordSet;\n+import com.amazonaws.services.route53.waiters.AmazonRoute53Waiters;\n+import com.amazonaws.waiters.FixedDelayStrategy;\n+import com.amazonaws.waiters.MaxAttemptsRetryStrategy;\n+import com.amazonaws.waiters.PollingStrategy;\n+import com.amazonaws.waiters.WaiterParameters;\n+import com.epam.pipeline.entity.cloud.InstanceDNSRecord;\n+import lombok.RequiredArgsConstructor;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Service;\n+\n+@Service\n+@RequiredArgsConstructor\n+public class Route53Helper {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(Route53Helper.class);", "originalCommit": "9b2d7ab8169fe76fc2a606fde7055af897268eb3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg5Mzc1MQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r540893751", "bodyText": "To make logging more readable we can use log.info(\"Creating DNS record for hostedZoneid : {} record {}\",  hostedZoneId, dnsRecord.getDnsRecord())", "author": "mzueva", "createdAt": "2020-12-11T11:52:16Z", "path": "api/src/main/java/com/epam/pipeline/manager/cloud/aws/Route53Helper.java", "diffHunk": "@@ -0,0 +1,183 @@\n+/*\n+ * Copyright 2017-2019 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.manager.cloud.aws;\n+\n+import com.amazonaws.services.route53.AmazonRoute53;\n+import com.amazonaws.services.route53.AmazonRoute53AsyncClientBuilder;\n+import com.amazonaws.services.route53.model.Change;\n+import com.amazonaws.services.route53.model.ChangeAction;\n+import com.amazonaws.services.route53.model.ChangeBatch;\n+import com.amazonaws.services.route53.model.ChangeResourceRecordSetsRequest;\n+import com.amazonaws.services.route53.model.ChangeResourceRecordSetsResult;\n+import com.amazonaws.services.route53.model.ChangeStatus;\n+import com.amazonaws.services.route53.model.GetChangeRequest;\n+import com.amazonaws.services.route53.model.GetChangeResult;\n+import com.amazonaws.services.route53.model.InvalidChangeBatchException;\n+import com.amazonaws.services.route53.model.ListResourceRecordSetsRequest;\n+import com.amazonaws.services.route53.model.RRType;\n+import com.amazonaws.services.route53.model.ResourceRecord;\n+import com.amazonaws.services.route53.model.ResourceRecordSet;\n+import com.amazonaws.services.route53.waiters.AmazonRoute53Waiters;\n+import com.amazonaws.waiters.FixedDelayStrategy;\n+import com.amazonaws.waiters.MaxAttemptsRetryStrategy;\n+import com.amazonaws.waiters.PollingStrategy;\n+import com.amazonaws.waiters.WaiterParameters;\n+import com.epam.pipeline.entity.cloud.InstanceDNSRecord;\n+import lombok.RequiredArgsConstructor;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Service;\n+\n+@Service\n+@RequiredArgsConstructor\n+public class Route53Helper {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(Route53Helper.class);\n+    private static final long TTL_TIME = 60L;\n+    private static final int MAX_ATTEMPTS = 100;\n+    private static final int DELAY_IN_SECONDS = 1;\n+\n+    public InstanceDNSRecord createDNSRecord(final String hostedZoneId, final InstanceDNSRecord dnsRecord) {\n+        LOGGER.info(\"Creating DNS record for hostedZoneId: \" + hostedZoneId + \" record: \"", "originalCommit": "9b2d7ab8169fe76fc2a606fde7055af897268eb3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg5NDczOA==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r540894738", "bodyText": "License year 2017-2020", "author": "mzueva", "createdAt": "2020-12-11T11:54:07Z", "path": "api/src/main/java/com/epam/pipeline/manager/cluster/InfrastructureManager.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * Copyright 2017-2019 EPAM Systems, Inc. (https://www.epam.com/)", "originalCommit": "9b2d7ab8169fe76fc2a606fde7055af897268eb3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg5NTAxNA==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r540895014", "bodyText": "Missing final", "author": "mzueva", "createdAt": "2020-12-11T11:54:33Z", "path": "api/src/main/java/com/epam/pipeline/manager/cluster/cleaner/DNSRecordRunCleaner.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.manager.cluster.cleaner;\n+\n+import com.epam.pipeline.config.JsonMapper;\n+import com.epam.pipeline.entity.cloud.InstanceDNSRecord;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cloud.CloudFacade;\n+import com.epam.pipeline.manager.preference.PreferenceManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.utils.UtilsManager;\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.stereotype.Service;\n+import org.springframework.util.Assert;\n+import org.springframework.util.StringUtils;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+@Service\n+@Slf4j\n+public class DNSRecordRunCleaner implements RunCleaner {\n+\n+    private static final String HTTP = \"http://\";\n+    private static final String HTTPS = \"https://\";\n+    private static final String DELIMITER = \"/\";\n+    private static final String PORT_DELIMITER = \":\";\n+\n+    private final PreferenceManager preferenceManager;\n+    private final UtilsManager utilsManager;\n+    private final CloudFacade cloudFacade;\n+\n+    public DNSRecordRunCleaner(final PreferenceManager preferenceManager,\n+                               final UtilsManager utilsManager,\n+                               final CloudFacade cloudFacade) {\n+        this.preferenceManager = preferenceManager;\n+        this.utilsManager = utilsManager;\n+        this.cloudFacade = cloudFacade;\n+    }\n+\n+    @Override\n+    public void cleanResources(final PipelineRun run) {\n+        final String serviceUrls = run.getServiceUrl();\n+        if (StringUtils.isEmpty(serviceUrls)) {\n+            return;\n+        }\n+\n+        final String hostZoneId = preferenceManager.getPreference(SystemPreferences.INSTANCE_DNS_HOSTED_ZONE_ID);\n+        final String hostZoneUrlBase = preferenceManager.getPreference(SystemPreferences.INSTANCE_DNS_HOSTED_ZONE_BASE);\n+        Assert.isTrue(\n+                !StringUtils.isEmpty(hostZoneId) && !StringUtils.isEmpty(hostZoneUrlBase),\n+                \"instance.dns.hosted.zone.id or instance.dns.hosted.zone.base is empty can't remove DNS record.\"\n+        );\n+\n+        List<Map<String, String>> serviceUrlsList = JsonMapper.parseData(", "originalCommit": "9b2d7ab8169fe76fc2a606fde7055af897268eb3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg5NzA1OA==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r540897058", "bodyText": "At the moment this method will throw an error for all runs with service URLs if DNS settings are not configured. Can we at first check whether run uses custom DNS approach at first and only then check the settings?", "author": "mzueva", "createdAt": "2020-12-11T11:58:20Z", "path": "api/src/main/java/com/epam/pipeline/manager/cluster/cleaner/DNSRecordRunCleaner.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.manager.cluster.cleaner;\n+\n+import com.epam.pipeline.config.JsonMapper;\n+import com.epam.pipeline.entity.cloud.InstanceDNSRecord;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cloud.CloudFacade;\n+import com.epam.pipeline.manager.preference.PreferenceManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.utils.UtilsManager;\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import lombok.extern.slf4j.Slf4j;\n+import org.springframework.stereotype.Service;\n+import org.springframework.util.Assert;\n+import org.springframework.util.StringUtils;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+@Service\n+@Slf4j\n+public class DNSRecordRunCleaner implements RunCleaner {\n+\n+    private static final String HTTP = \"http://\";\n+    private static final String HTTPS = \"https://\";\n+    private static final String DELIMITER = \"/\";\n+    private static final String PORT_DELIMITER = \":\";\n+\n+    private final PreferenceManager preferenceManager;\n+    private final UtilsManager utilsManager;\n+    private final CloudFacade cloudFacade;\n+\n+    public DNSRecordRunCleaner(final PreferenceManager preferenceManager,\n+                               final UtilsManager utilsManager,\n+                               final CloudFacade cloudFacade) {\n+        this.preferenceManager = preferenceManager;\n+        this.utilsManager = utilsManager;\n+        this.cloudFacade = cloudFacade;\n+    }\n+\n+    @Override\n+    public void cleanResources(final PipelineRun run) {\n+        final String serviceUrls = run.getServiceUrl();\n+        if (StringUtils.isEmpty(serviceUrls)) {\n+            return;\n+        }\n+\n+        final String hostZoneId = preferenceManager.getPreference(SystemPreferences.INSTANCE_DNS_HOSTED_ZONE_ID);\n+        final String hostZoneUrlBase = preferenceManager.getPreference(SystemPreferences.INSTANCE_DNS_HOSTED_ZONE_BASE);\n+        Assert.isTrue(", "originalCommit": "9b2d7ab8169fe76fc2a606fde7055af897268eb3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg5ODAxMg==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r540898012", "bodyText": "Controller should use InfrastructureApiService not InfrastructureManager", "author": "mzueva", "createdAt": "2020-12-11T12:00:11Z", "path": "api/src/main/java/com/epam/pipeline/controller/cluster/ClusterController.java", "diffHunk": "@@ -236,4 +240,16 @@ public void downloadNodeUsageStatisticsReport(\n     public Result<List<NodeDisk>> loadNodeDisks(@PathVariable(value = NAME) final String name) {\n         return Result.success(clusterApiService.loadNodeDisks(name));\n     }\n+\n+    @PostMapping(\"/cluster/dnsrecord\")\n+    @ResponseBody\n+    @ApiOperation(\n+            value = \"Creates dns record.\",\n+            notes = \"Creates dns record.\",\n+            produces = MediaType.APPLICATION_JSON_VALUE)\n+    @ApiResponses(value = {@ApiResponse(code = HTTP_STATUS_OK, message = API_STATUS_DESCRIPTION)})\n+    public Result<InstanceDNSRecord> requestDnsRecord(@RequestParam final Long regionId,\n+                                                      @RequestBody final InstanceDNSRecord dnsRecord) {\n+        return Result.success(infrastructureManager.createInstanceDNSRecord(regionId, dnsRecord));", "originalCommit": "9b2d7ab8169fe76fc2a606fde7055af897268eb3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg5ODUwMA==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r540898500", "bodyText": "Wrong message Deletion -> Creation", "author": "mzueva", "createdAt": "2020-12-11T12:01:07Z", "path": "api/src/main/java/com/epam/pipeline/manager/cloud/azure/AzureInstanceService.java", "diffHunk": "@@ -257,6 +258,15 @@ public CloudInstanceState getInstanceState(final AzureRegion region, final Strin\n         }\n     }\n \n+    public InstanceDNSRecord getOrCreateInstanceDNSRecord(final InstanceDNSRecord dnsRecord) {\n+        throw new UnsupportedOperationException(\"Deletion of DNS record doesn't work with Azure provider yet.\");", "originalCommit": "9b2d7ab8169fe76fc2a606fde7055af897268eb3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg5ODU1OA==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r540898558", "bodyText": "Wrong message Deletion -> Creation", "author": "mzueva", "createdAt": "2020-12-11T12:01:14Z", "path": "api/src/main/java/com/epam/pipeline/manager/cloud/gcp/GCPInstanceService.java", "diffHunk": "@@ -214,6 +215,16 @@ public void attachDisk(final GCPRegion region, final Long runId, final DiskAttac\n         throw new UnsupportedOperationException(\"Disk attaching doesn't work with GCP provider yet.\");\n     }\n \n+    @Override\n+    public InstanceDNSRecord getOrCreateInstanceDNSRecord(final InstanceDNSRecord dnsRecord) {\n+        throw new UnsupportedOperationException(\"Deletion of DNS record doesn't work with GCP provider yet.\");", "originalCommit": "9b2d7ab8169fe76fc2a606fde7055af897268eb3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDkwNTAwOQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r540905009", "bodyText": "With this approach plain endpoints are initialised only when all dns records will be created, so users will have to wait. Can we improve this?", "author": "mzueva", "createdAt": "2020-12-11T12:13:56Z", "path": "deploy/docker/cp-edge/sync-routes.py", "diffHunk": "@@ -680,3 +780,5 @@ def load_pods_for_runs_with_endpoints():\n                 print('Service url ({}) assigned to RunID: {}'.format(service_urls_json, run_id))\n         else:\n                 print('Service url was not assigned due to API errors')\n+", "originalCommit": "9b2d7ab8169fe76fc2a606fde7055af897268eb3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5462cd39a7d2e56ab3fc0550cfd3f7bdfe3401d3", "url": "https://github.com/epam/cloud-pipeline/commit/5462cd39a7d2e56ab3fc0550cfd3f7bdfe3401d3", "message": "issue #1615 corrections on review", "committedDate": "2020-12-11T12:42:33Z", "type": "commit"}, {"oid": "57a1880572d32dba1bbdbbf80dfe6af9163bbf47", "url": "https://github.com/epam/cloud-pipeline/commit/57a1880572d32dba1bbdbbf80dfe6af9163bbf47", "message": "issue #1615 reload nginx two times", "committedDate": "2020-12-11T13:59:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDk1MTg2MQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r540951861", "bodyText": "Looks like this can be simplified to just\nif service_spec[\"create_dns_record\"] and not service_spec[\"custom_domain\"]:\n        dns_services_pool.apply_async(create_dns_service_location, (service_spec, added_route))", "author": "tcibinan", "createdAt": "2020-12-11T13:37:29Z", "path": "deploy/docker/cp-edge/sync-routes.py", "diffHunk": "@@ -596,66 +738,24 @@ def load_pods_for_runs_with_endpoints():\n     sensitive_routes = json.load(sensitive_routes_file)\n \n service_url_dict = {}\n+\n+# loop through all routes that we need to create, if this route doesn't have option to create custom DNS record\n+# we handle it it the main thread, if custom DNS record should be created, since it consume some time ~ 20 sec,\n+# we put it to the async pool and store result future.\n for added_route in routes_to_add:\n         service_spec = services_list[added_route]\n \n-        has_custom_domain = service_spec[\"custom_domain\"] is not None\n-        service_hostname = service_spec[\"custom_domain\"] if has_custom_domain else edge_service_external_ip\n-        service_location = '/{}/'.format(service_spec[\"edge_location\"]) if service_spec[\"edge_location\"] else \"/\"\n-\n-        nginx_route_definition = nginx_loc_module_template_contents\\\n-                .replace('{edge_route_location}', service_location)\\\n-                .replace('{edge_route_target}', service_spec[\"edge_target\"])\\\n-                .replace('{edge_route_owner}', service_spec[\"pod_owner\"]) \\\n-                .replace('{run_id}', service_spec[\"run_id\"]) \\\n-                .replace('{edge_route_shared_users}', service_spec[\"shared_users_sids\"]) \\\n-                .replace('{edge_route_shared_groups}', service_spec[\"shared_groups_sids\"]) \\\n-                .replace('{edge_route_schema}', 'https' if service_spec[\"is_ssl_backend\"] else 'http') \\\n-                .replace('{additional}', service_spec[\"additional\"])\n-\n-        nginx_sensitive_route_definitions = []\n-        if service_spec[\"sensitive\"]:\n-                for sensitive_route in sensitive_routes:\n-                        # proxy_pass cannot have trailing slash for regexp locations\n-                        edge_target = service_spec[\"edge_target\"]\n-                        if edge_target.endswith(\"/\"):\n-                                edge_target = edge_target[:-1]\n-                        nginx_sensitive_route_definition = nginx_sensitive_loc_module_template_contents \\\n-                                .replace('{edge_route_location}', service_location + sensitive_route['route']) \\\n-                                .replace('{edge_route_sensitive_methods}', '|'.join(sensitive_route['methods'])) \\\n-                                .replace('{edge_route_target}', edge_target) \\\n-                                .replace('{edge_route_owner}', service_spec[\"pod_owner\"]) \\\n-                                .replace('{run_id}', service_spec[\"run_id\"]) \\\n-                                .replace('{edge_route_shared_users}', service_spec[\"shared_users_sids\"]) \\\n-                                .replace('{edge_route_shared_groups}', service_spec[\"shared_groups_sids\"]) \\\n-                                .replace('{additional}', service_spec[\"additional\"])\n-                        nginx_sensitive_route_definitions.append(nginx_sensitive_route_definition)\n-\n-        path_to_route = os.path.join(nginx_sites_path, added_route + '.conf')\n-        if service_spec[\"sensitive\"]:\n-                print('Adding new sensitive route: ' + path_to_route)\n+        need_to_create_dns_record = service_spec[\"create_dns_record\"] if service_spec[\"create_dns_record\"] and not service_spec[\"custom_domain\"] else False\n+        if need_to_create_dns_record:\n+                dns_services_pool.apply_async(create_dns_service_location, (service_spec, added_route))", "originalCommit": "5462cd39a7d2e56ab3fc0550cfd3f7bdfe3401d3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDk1NjA1Ng==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r540956056", "bodyText": "Typo in current.", "author": "tcibinan", "createdAt": "2020-12-11T13:44:12Z", "path": "deploy/docker/cp-edge/sync-routes.py", "diffHunk": "@@ -500,6 +515,133 @@ def load_pods_for_runs_with_endpoints():\n                                 pods_with_endpoints.append(pod)\n         return pods_with_endpoints\n \n+\n+def create_dns_record(service_spec):\n+        if hosted_zone_base_value is not None:\n+                dns_custom_domain = service_spec[\"edge_location\"] + \".\" + hosted_zone_base_value\n+                dns_record_create = os.path.join(api_url, API_POST_DNS_RECORD\n+                                                 + \"?regionId={regionId}\"\n+                                                 .format(regionId=service_spec[\"cloudRegionId\"]))\n+                data = json.dumps({\n+                        'dnsRecord': dns_custom_domain,\n+                        'target': \"{external_ip}\".format(external_ip=edge_service_external_ip)\n+                })\n+                dns_record_create_response = call_api(dns_record_create, data)\n+                if dns_record_create_response and \"payload\" in dns_record_create_response and \"status\" in \\\n+                        dns_record_create_response[\"payload\"] \\\n+                        and dns_record_create_response[\"payload\"][\"status\"] == \"INSYNC\":\n+                        service_spec[\"custom_domain\"] = dns_custom_domain\n+                        service_spec[\"edge_location\"] = None\n+                else:\n+                        log_task_event(\"CreateDNSRecord\",\n+                                       \"Fail to create DNS record for the run\",\n+                                       service_spec[\"run_id\"],\n+                                       service_spec[\"pod_id\"],\n+                                       \"FAILURE\")\n+                        update_run_status(service_spec[\"run_id\"], \"FAILURE\")\n+                        raise ValueError(\"Couldn't create DNS record\")\n+        else:\n+                log_task_event(\"CreateDNSRecord\",\n+                               \"No hosted zone is configured for currect environment, will not create any DNS records\",", "originalCommit": "5462cd39a7d2e56ab3fc0550cfd3f7bdfe3401d3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDk2NzM4MQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r540967381", "bodyText": "I would propose not to throw any exceptions without handling them explicitly. I'm not sure enough how unhanded exceptions will affect threads in the pool. In order to avoid the worst scenario when a single failing endpoint prevents other endpoints from being processed I suggest to handle errors explicitly.\nOf course If you've tested it and you are pretty confident that it is safe then I'm good too.", "author": "tcibinan", "createdAt": "2020-12-11T14:01:35Z", "path": "deploy/docker/cp-edge/sync-routes.py", "diffHunk": "@@ -500,6 +515,133 @@ def load_pods_for_runs_with_endpoints():\n                                 pods_with_endpoints.append(pod)\n         return pods_with_endpoints\n \n+\n+def create_dns_record(service_spec):\n+        if hosted_zone_base_value is not None:\n+                dns_custom_domain = service_spec[\"edge_location\"] + \".\" + hosted_zone_base_value\n+                dns_record_create = os.path.join(api_url, API_POST_DNS_RECORD\n+                                                 + \"?regionId={regionId}\"\n+                                                 .format(regionId=service_spec[\"cloudRegionId\"]))\n+                data = json.dumps({\n+                        'dnsRecord': dns_custom_domain,\n+                        'target': \"{external_ip}\".format(external_ip=edge_service_external_ip)\n+                })\n+                dns_record_create_response = call_api(dns_record_create, data)\n+                if dns_record_create_response and \"payload\" in dns_record_create_response and \"status\" in \\\n+                        dns_record_create_response[\"payload\"] \\\n+                        and dns_record_create_response[\"payload\"][\"status\"] == \"INSYNC\":\n+                        service_spec[\"custom_domain\"] = dns_custom_domain\n+                        service_spec[\"edge_location\"] = None\n+                else:\n+                        log_task_event(\"CreateDNSRecord\",\n+                                       \"Fail to create DNS record for the run\",\n+                                       service_spec[\"run_id\"],\n+                                       service_spec[\"pod_id\"],\n+                                       \"FAILURE\")\n+                        update_run_status(service_spec[\"run_id\"], \"FAILURE\")\n+                        raise ValueError(\"Couldn't create DNS record\")", "originalCommit": "5462cd39a7d2e56ab3fc0550cfd3f7bdfe3401d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDk4NTIyNg==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r540985226", "bodyText": "Good point.\nIt should work fine, exception will be raised in the thread and shouldn't affect other threads, but I think it is better to explicitly catch it and just message log about it and quit from thread", "author": "SilinPavel", "createdAt": "2020-12-11T14:27:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDk2NzM4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDk3MTM2MQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r540971361", "bodyText": "There is a simple notation for such calls:\ncloud_region_id = run_info.get(\"instance\", {}).get(\"cloudRegionId\") or None", "author": "tcibinan", "createdAt": "2020-12-11T14:07:36Z", "path": "deploy/docker/cp-edge/sync-routes.py", "diffHunk": "@@ -353,6 +382,10 @@ def get_service_list(pod_id, pod_run_id, pod_ip):\n                         pretty_url = parse_pretty_url(run_info[\"prettyUrl\"])\n                 sensitive = run_info.get(\"sensitive\") or False\n \n+                cloud_region_id = None\n+                if \"instance\" in run_info:\n+                        cloud_region_id = run_info[\"instance\"].get(\"cloudRegionId\")", "originalCommit": "5462cd39a7d2e56ab3fc0550cfd3f7bdfe3401d3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c7c65db12259a0b8abfcb1461bcd8ca4bd05e2e2", "url": "https://github.com/epam/cloud-pipeline/commit/c7c65db12259a0b8abfcb1461bcd8ca4bd05e2e2", "message": "issue #1615 check exception in dns record creation thread", "committedDate": "2020-12-11T14:28:24Z", "type": "commit"}, {"oid": "c7c65db12259a0b8abfcb1461bcd8ca4bd05e2e2", "url": "https://github.com/epam/cloud-pipeline/commit/c7c65db12259a0b8abfcb1461bcd8ca4bd05e2e2", "message": "issue #1615 check exception in dns record creation thread", "committedDate": "2020-12-11T14:28:24Z", "type": "forcePushed"}, {"oid": "28ec04f6ad9dfac3e1ea7cae35e3f22f1cf86397", "url": "https://github.com/epam/cloud-pipeline/commit/28ec04f6ad9dfac3e1ea7cae35e3f22f1cf86397", "message": "Merge remote-tracking branch 'origin/develop' into issue_1615_route53_integration\n\n# Conflicts:\n#\tapi/src/test/java/com/epam/pipeline/app/AclTestConfiguration.java\n#\tapi/src/test/java/com/epam/pipeline/test/web/ControllerTestBeans.java", "committedDate": "2020-12-13T21:28:11Z", "type": "commit"}, {"oid": "26875cb1b1ec0a09305d5791aed47df4c380d991", "url": "https://github.com/epam/cloud-pipeline/commit/26875cb1b1ec0a09305d5791aed47df4c380d991", "message": "issue #1615 deal with routes without dns first", "committedDate": "2020-12-14T15:10:25Z", "type": "commit"}, {"oid": "26875cb1b1ec0a09305d5791aed47df4c380d991", "url": "https://github.com/epam/cloud-pipeline/commit/26875cb1b1ec0a09305d5791aed47df4c380d991", "message": "issue #1615 deal with routes without dns first", "committedDate": "2020-12-14T15:10:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTYyODMzNg==", "url": "https://github.com/epam/cloud-pipeline/pull/1624#discussion_r545628336", "bodyText": "I wonder if it is safe to modify the same service_url_dict dictionary in multiple threads including the main one. Correct me if I'm wrong but this apply_async call just copies the arguments and therefore the dictionary in multiple threads is just not the same one anymore.", "author": "tcibinan", "createdAt": "2020-12-18T07:51:46Z", "path": "deploy/docker/cp-edge/sync-routes.py", "diffHunk": "@@ -595,88 +759,56 @@ def load_pods_for_runs_with_endpoints():\n with open(nginx_sensitive_routes_config_path, 'r') as sensitive_routes_file:\n     sensitive_routes = json.load(sensitive_routes_file)\n \n+\n+# loop through all routes that we need to create, if this route doesn't have option to create custom DNS record\n+# we handle it in the main thread, if custom DNS record should be created, since it consume some time ~ 20 sec,\n+# we put it to the separate collection to handle it at the end.\n service_url_dict = {}\n+routes_with_custom_dns = set()\n+runs_with_custom_dns = set()\n for added_route in routes_to_add:\n         service_spec = services_list[added_route]\n \n-        has_custom_domain = service_spec[\"custom_domain\"] is not None\n-        service_hostname = service_spec[\"custom_domain\"] if has_custom_domain else edge_service_external_ip\n-        service_location = '/{}/'.format(service_spec[\"edge_location\"]) if service_spec[\"edge_location\"] else \"/\"\n-\n-        nginx_route_definition = nginx_loc_module_template_contents\\\n-                .replace('{edge_route_location}', service_location)\\\n-                .replace('{edge_route_target}', service_spec[\"edge_target\"])\\\n-                .replace('{edge_route_owner}', service_spec[\"pod_owner\"]) \\\n-                .replace('{run_id}', service_spec[\"run_id\"]) \\\n-                .replace('{edge_route_shared_users}', service_spec[\"shared_users_sids\"]) \\\n-                .replace('{edge_route_shared_groups}', service_spec[\"shared_groups_sids\"]) \\\n-                .replace('{edge_route_schema}', 'https' if service_spec[\"is_ssl_backend\"] else 'http') \\\n-                .replace('{additional}', service_spec[\"additional\"])\n-\n-        nginx_sensitive_route_definitions = []\n-        if service_spec[\"sensitive\"]:\n-                for sensitive_route in sensitive_routes:\n-                        # proxy_pass cannot have trailing slash for regexp locations\n-                        edge_target = service_spec[\"edge_target\"]\n-                        if edge_target.endswith(\"/\"):\n-                                edge_target = edge_target[:-1]\n-                        nginx_sensitive_route_definition = nginx_sensitive_loc_module_template_contents \\\n-                                .replace('{edge_route_location}', service_location + sensitive_route['route']) \\\n-                                .replace('{edge_route_sensitive_methods}', '|'.join(sensitive_route['methods'])) \\\n-                                .replace('{edge_route_target}', edge_target) \\\n-                                .replace('{edge_route_owner}', service_spec[\"pod_owner\"]) \\\n-                                .replace('{run_id}', service_spec[\"run_id\"]) \\\n-                                .replace('{edge_route_shared_users}', service_spec[\"shared_users_sids\"]) \\\n-                                .replace('{edge_route_shared_groups}', service_spec[\"shared_groups_sids\"]) \\\n-                                .replace('{additional}', service_spec[\"additional\"])\n-                        nginx_sensitive_route_definitions.append(nginx_sensitive_route_definition)\n-\n-        path_to_route = os.path.join(nginx_sites_path, added_route + '.conf')\n-        if service_spec[\"sensitive\"]:\n-                print('Adding new sensitive route: ' + path_to_route)\n+        if service_spec[\"create_dns_record\"] and not service_spec[\"custom_domain\"]:\n+                runs_with_custom_dns.add(service_spec[\"run_id\"])\n+                routes_with_custom_dns.add(added_route)\n         else:\n-                print('Adding new route: ' + path_to_route)\n-        with open(path_to_route, \"w\") as added_route_file:\n-                added_route_file.write(nginx_route_definition)\n-                if nginx_sensitive_route_definitions:\n-                        for nginx_sensitive_route_definition in nginx_sensitive_route_definitions:\n-                                added_route_file.write(nginx_sensitive_route_definition)\n-\n-        if has_custom_domain:\n-                print('Adding {} route to the server block {}'.format(path_to_route, service_hostname))\n-                add_custom_domain(service_hostname, path_to_route)\n-\n-        service_url = SVC_URL_TMPL.format(external_ip=service_hostname,\n-                                          edge_location=service_spec[\"edge_location\"] if service_spec[\"edge_location\"] else \"\",\n-                                          edge_port=str(edge_service_port),\n-                                          service_name=service_spec[\"service_name\"],\n-                                          is_default_endpoint=service_spec[\"is_default_endpoint\"],\n-                                          external_schema=edge_service_external_schema)\n-        run_id = service_spec[\"run_id\"]\n-        if run_id in service_url_dict:\n-                service_url = service_url_dict[run_id] + ',' + service_url\n-        service_url_dict[run_id] = service_url\n+                create_service_location(service_spec, added_route, service_url_dict)\n \n-# Once all entries are added to the template - run \"nginx -s reload\"\n+# reload nginx first time to enable all urls with out custom dns with \"nginx -s reload\"\n # TODO: Add error handling, if non-zero is returned - restore previous state\n if len(routes_to_add) > 0 or len(routes_to_delete) or routes_were_updated:\n-        print('Reloading nginx config')\n+        print('Reloading nginx config to enable non custom DNS runs')\n         check_output('nginx -s reload', shell=True)\n \n-\n # For all added entries - call API and set Service URL property for the run:\n # -- Get ServiceExternalIP from the EDGE-labeled service description\n # -- http://{ServiceExternalIP}/{PodID}-{svc-port-N}-{N}\n \n for run_id in service_url_dict:\n-        # make array of json objects\n-        service_urls_json = '[' + service_url_dict[run_id] + ']'\n-        update_svc_method = os.path.join(api_url, API_UPDATE_SVC.format(run_id=run_id))\n-        print('Assigning service url ({}) to RunID: {}'.format(service_urls_json, run_id))\n+        if run_id not in runs_with_custom_dns:\n+                update_svc_url_for_run(run_id)\n \n-        data = json.dumps({'serviceUrl': service_urls_json})\n-        response_data = call_api(update_svc_method, data=data)\n-        if response_data:\n-                print('Service url ({}) assigned to RunID: {}'.format(service_urls_json, run_id))\n-        else:\n-                print('Service url was not assigned due to API errors')\n+#Now handle all routes with custom DNS\n+for added_route in routes_with_custom_dns:\n+        service_spec = services_list[added_route]\n+        dns_services_pool.apply_async(create_dns_service_location, (service_spec, added_route, service_url_dict))", "originalCommit": "26875cb1b1ec0a09305d5791aed47df4c380d991", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bcfb7e4d77144d0df59362d2ed36055361b4f79a", "url": "https://github.com/epam/cloud-pipeline/commit/bcfb7e4d77144d0df59362d2ed36055361b4f79a", "message": "issue 1615 merge async results synchronously", "committedDate": "2020-12-18T10:21:27Z", "type": "commit"}, {"oid": "cf1181e42ede30c71ba06099a08b2df17bc4bac4", "url": "https://github.com/epam/cloud-pipeline/commit/cf1181e42ede30c71ba06099a08b2df17bc4bac4", "message": "Merge remote-tracking branch 'origin/develop' into issue_1615_route53_integration\n\n# Conflicts:\n#\tapi/src/test/java/com/epam/pipeline/app/AclTestConfiguration.java", "committedDate": "2020-12-22T15:23:46Z", "type": "commit"}, {"oid": "9380279a830d659fd67f375133aa24b26a90f7d1", "url": "https://github.com/epam/cloud-pipeline/commit/9380279a830d659fd67f375133aa24b26a90f7d1", "message": "issue 1615 fix tests", "committedDate": "2020-12-22T15:25:02Z", "type": "commit"}]}