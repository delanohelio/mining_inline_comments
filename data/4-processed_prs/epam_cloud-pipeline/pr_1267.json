{"pr_number": 1267, "pr_title": "Issue #1245 Change endpoints processing in cp-edge", "pr_createdAt": "2020-08-12T09:25:54Z", "pr_url": "https://github.com/epam/cloud-pipeline/pull/1267", "timeline": [{"oid": "32662a54101d0f07182c6f71ceb2e09b3ce66940", "url": "https://github.com/epam/cloud-pipeline/commit/32662a54101d0f07182c6f71ceb2e09b3ce66940", "message": "Issue #1245 Setup system endpoints via the configuration file", "committedDate": "2020-08-12T09:16:45Z", "type": "commit"}, {"oid": "7ae9294077bb55f7b54e2bc63a861828b49e4517", "url": "https://github.com/epam/cloud-pipeline/commit/7ae9294077bb55f7b54e2bc63a861828b49e4517", "message": "Issue #1245 Allow adding system endpoints to non-interactive runs.", "committedDate": "2020-08-12T09:18:28Z", "type": "commit"}, {"oid": "02f59c0342745ced734c89cbbabdb26b36afb96e", "url": "https://github.com/epam/cloud-pipeline/commit/02f59c0342745ced734c89cbbabdb26b36afb96e", "message": "Issue #1245 Do not apply system endpoint if the same one exists in the tool settings", "committedDate": "2020-08-12T09:20:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE5OTczMw==", "url": "https://github.com/epam/cloud-pipeline/pull/1267#discussion_r480199733", "bodyText": "The PipelineRunParameter object hasn't friendly_name field. So, this line may lead to KeyError.", "author": "ekazachkova", "createdAt": "2020-08-31T15:16:49Z", "path": "deploy/docker/cp-edge/sync-routes.py", "diffHunk": "@@ -245,24 +246,41 @@ def search_custom_domain_cert(domain):\n         if not cert_path or not key_path:\n                 cert_path = pki_default_cert\n                 key_path = pki_default_cert_key\n-        \n+\n         print('Certificate:Key for {} will be used: {}:{}'.format(domain, cert_path, key_path))\n         return (cert_path, key_path)\n \n-# FIXME: once we'll get more than one \"system endpoint\" - a list of such endpoints shall be moved to the configuration\n-SYSTEM_ENDPOINTS={ \"CP_CAP_SPARK\": { \n-                        \"value\": \"true\", \n-                        \"endpoint\": str(os.environ.get(\"CP_CAP_SPARK_UI_PROXY_PORT\", \"8088\")), \n-                        \"endpoint_num\":  str(os.environ.get(\"CP_CAP_SPARK_UI_PROXY_ENDPOINT_ID\", \"1000\")),\n-                        \"friendly_name\": \"SparkUI\" }}\n+def read_system_endpoints():\n+        system_endpoints = {}\n+        with open(nginx_system_endpoints_config_path, 'r') as system_endpoints_file:\n+                system_endpoints_list = json.load(system_endpoints_file)\n+                for endpoint in system_endpoints_list:\n+                        system_endpoints[endpoint['name']] = {\n+                                \"value\": \"true\",\n+                                \"endpoint\": str(os.environ.get(endpoint['endpoint_env'],\n+                                                               endpoint['endpoint_default'])),\n+                                \"endpoint_num\":  str(os.environ.get(endpoint['endpoint_num_env'],\n+                                                                    endpoint['endpoint_num_default'])),\n+                                \"friendly_name\": endpoint['friendly_name']\n+                        }\n+        return system_endpoints\n+\n+SYSTEM_ENDPOINTS = read_system_endpoints()\n+\n def append_system_endpoints(tool_endpoints, run_details):\n         if not tool_endpoints:\n                 tool_endpoints = []\n         system_endpoints_params = SYSTEM_ENDPOINTS.keys()\n+        tool_endpoints_dict = {}\n+        for endpoint in tool_endpoints:\n+                endpoint_obj = json.loads(endpoint)\n+                tool_endpoints_dict[endpoint_obj['name']] = endpoint_obj['nginx']['port']\n         if run_details and \"pipelineRunParameters\" in run_details:\n                 # Get a list of endpoints from SYSTEM_ENDPOINTS which match the run's parameters (param name and a value)\n-                system_endpoints_matched = [SYSTEM_ENDPOINTS[x[\"name\"]] for x in run_details[\"pipelineRunParameters\"] \n-                                                if x[\"name\"] in system_endpoints_params \n+                system_endpoints_matched = [SYSTEM_ENDPOINTS[x[\"name\"]] for x in run_details[\"pipelineRunParameters\"]\n+                                                if x[\"name\"] in system_endpoints_params\n+                                                   and (x[\"friendly_name\"] not in tool_endpoints_dict", "originalCommit": "02f59c0342745ced734c89cbbabdb26b36afb96e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI2NzUxMw==", "url": "https://github.com/epam/cloud-pipeline/pull/1267#discussion_r480267513", "bodyText": "Done, x in this and the following line is replaced with SYSTEM_ENDPOINTS[x[\"name\"]]", "author": "Wedds", "createdAt": "2020-08-31T17:08:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE5OTczMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDIxNzgyNQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1267#discussion_r480217825", "bodyText": "May the endpoint_obj['nginx'] returns None? ( check for that case )", "author": "ekazachkova", "createdAt": "2020-08-31T15:42:54Z", "path": "deploy/docker/cp-edge/sync-routes.py", "diffHunk": "@@ -245,24 +246,41 @@ def search_custom_domain_cert(domain):\n         if not cert_path or not key_path:\n                 cert_path = pki_default_cert\n                 key_path = pki_default_cert_key\n-        \n+\n         print('Certificate:Key for {} will be used: {}:{}'.format(domain, cert_path, key_path))\n         return (cert_path, key_path)\n \n-# FIXME: once we'll get more than one \"system endpoint\" - a list of such endpoints shall be moved to the configuration\n-SYSTEM_ENDPOINTS={ \"CP_CAP_SPARK\": { \n-                        \"value\": \"true\", \n-                        \"endpoint\": str(os.environ.get(\"CP_CAP_SPARK_UI_PROXY_PORT\", \"8088\")), \n-                        \"endpoint_num\":  str(os.environ.get(\"CP_CAP_SPARK_UI_PROXY_ENDPOINT_ID\", \"1000\")),\n-                        \"friendly_name\": \"SparkUI\" }}\n+def read_system_endpoints():\n+        system_endpoints = {}\n+        with open(nginx_system_endpoints_config_path, 'r') as system_endpoints_file:\n+                system_endpoints_list = json.load(system_endpoints_file)\n+                for endpoint in system_endpoints_list:\n+                        system_endpoints[endpoint['name']] = {\n+                                \"value\": \"true\",\n+                                \"endpoint\": str(os.environ.get(endpoint['endpoint_env'],\n+                                                               endpoint['endpoint_default'])),\n+                                \"endpoint_num\":  str(os.environ.get(endpoint['endpoint_num_env'],\n+                                                                    endpoint['endpoint_num_default'])),\n+                                \"friendly_name\": endpoint['friendly_name']\n+                        }\n+        return system_endpoints\n+\n+SYSTEM_ENDPOINTS = read_system_endpoints()\n+\n def append_system_endpoints(tool_endpoints, run_details):\n         if not tool_endpoints:\n                 tool_endpoints = []\n         system_endpoints_params = SYSTEM_ENDPOINTS.keys()\n+        tool_endpoints_dict = {}\n+        for endpoint in tool_endpoints:\n+                endpoint_obj = json.loads(endpoint)\n+                tool_endpoints_dict[endpoint_obj['name']] = endpoint_obj['nginx']['port']", "originalCommit": "02f59c0342745ced734c89cbbabdb26b36afb96e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI2Nzg3Ng==", "url": "https://github.com/epam/cloud-pipeline/pull/1267#discussion_r480267876", "bodyText": "Done, checking if both name and nginx are presented in the endpoint_obj after conversion from JSON", "author": "Wedds", "createdAt": "2020-08-31T17:08:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDIxNzgyNQ=="}], "type": "inlineReview"}, {"oid": "5a727643bb25e9f36e285a78adb381a2d5dcad1d", "url": "https://github.com/epam/cloud-pipeline/commit/5a727643bb25e9f36e285a78adb381a2d5dcad1d", "message": "Issue #1245 Check if conversion from tool's endpoint json is successful", "committedDate": "2020-08-31T17:00:51Z", "type": "commit"}, {"oid": "28902d9aa29ecaa986bc84fa99f1b737c12b99d9", "url": "https://github.com/epam/cloud-pipeline/commit/28902d9aa29ecaa986bc84fa99f1b737c12b99d9", "message": "Issue #1245 Fix procedure of checking if required system endpoint is presented in tool endpoints already", "committedDate": "2020-08-31T17:04:16Z", "type": "commit"}, {"oid": "09c80a58ab6359f34de2ecbef5c6a370a06f13c8", "url": "https://github.com/epam/cloud-pipeline/commit/09c80a58ab6359f34de2ecbef5c6a370a06f13c8", "message": "Issue #1245 Check existence of the name and port, before adding tool endpoint to a dict for resolving clashes with system endpoints", "committedDate": "2020-09-01T12:06:18Z", "type": "commit"}, {"oid": "161365f96adda3f37f39a38f745bc9e992646d54", "url": "https://github.com/epam/cloud-pipeline/commit/161365f96adda3f37f39a38f745bc9e992646d54", "message": "Issue #1245 Load non-interactive pipelines with system endpoints to proceed in routing", "committedDate": "2020-09-01T18:41:45Z", "type": "commit"}, {"oid": "644107be4154dec33719986a6560c950ee9c5cad", "url": "https://github.com/epam/cloud-pipeline/commit/644107be4154dec33719986a6560c950ee9c5cad", "message": "Issue #1245 Override tool endpoints with corresponding by name and endpoint num system ones", "committedDate": "2020-09-02T13:44:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg3MDI5MQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1267#discussion_r482870291", "bodyText": "Lets continue to use naming convention lower_case_with_underscores in this script", "author": "ekazachkova", "createdAt": "2020-09-03T10:19:10Z", "path": "deploy/docker/cp-edge/sync-routes.py", "diffHunk": "@@ -273,16 +286,48 @@ def append_system_endpoints(tool_endpoints, run_details):\n                         current_tool_endpoint = json.loads(tool_endpoints[0])\n                         current_tool_endpoint[\"isDefault\"] = \"true\"\n                         tool_endpoints[0] = json.dumps(current_tool_endpoint)\n-\n                 # Append system endpoints to the existing list\n                 for system_endpoint in system_endpoints_matched:\n-                        tool_endpoint = { \"nginx\": { \"port\": system_endpoint[\"endpoint\"] }, \"isDefault\": \"false\" }\n+                        tool_endpoint = { \"nginx\": { \"port\": system_endpoint[\"endpoint\"] }}\n+                        system_endpoint_port = system_endpoint[\"endpoint\"]\n+                        system_endpoint_name = None\n                         if \"friendly_name\" in system_endpoint:\n                                 tool_endpoint[\"name\"] = system_endpoint[\"friendly_name\"]\n+                                system_endpoint_name = system_endpoint[\"friendly_name\"]\n                         if \"endpoint_num\" in system_endpoint and system_endpoint[\"endpoint_num\"]:\n                                 tool_endpoint[\"endpoint_num\"] = system_endpoint[\"endpoint_num\"]\n+                        modified_tool_endpoints, modified_count, isDefaultEndpoint = \\", "originalCommit": "644107be4154dec33719986a6560c950ee9c5cad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjk0NjIxOA==", "url": "https://github.com/epam/cloud-pipeline/pull/1267#discussion_r482946218", "bodyText": "Done", "author": "Wedds", "createdAt": "2020-09-03T12:40:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg3MDI5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg3MDM5Nw==", "url": "https://github.com/epam/cloud-pipeline/pull/1267#discussion_r482870397", "bodyText": "Lets continue to use naming convention lower_case_with_underscores in this script", "author": "ekazachkova", "createdAt": "2020-09-03T10:19:20Z", "path": "deploy/docker/cp-edge/sync-routes.py", "diffHunk": "@@ -273,16 +286,48 @@ def append_system_endpoints(tool_endpoints, run_details):\n                         current_tool_endpoint = json.loads(tool_endpoints[0])\n                         current_tool_endpoint[\"isDefault\"] = \"true\"\n                         tool_endpoints[0] = json.dumps(current_tool_endpoint)\n-\n                 # Append system endpoints to the existing list\n                 for system_endpoint in system_endpoints_matched:\n-                        tool_endpoint = { \"nginx\": { \"port\": system_endpoint[\"endpoint\"] }, \"isDefault\": \"false\" }\n+                        tool_endpoint = { \"nginx\": { \"port\": system_endpoint[\"endpoint\"] }}\n+                        system_endpoint_port = system_endpoint[\"endpoint\"]\n+                        system_endpoint_name = None\n                         if \"friendly_name\" in system_endpoint:\n                                 tool_endpoint[\"name\"] = system_endpoint[\"friendly_name\"]\n+                                system_endpoint_name = system_endpoint[\"friendly_name\"]\n                         if \"endpoint_num\" in system_endpoint and system_endpoint[\"endpoint_num\"]:\n                                 tool_endpoint[\"endpoint_num\"] = system_endpoint[\"endpoint_num\"]\n+                        modified_tool_endpoints, modified_count, isDefaultEndpoint = \\\n+                                remove_from_tool_endpoints_if_fully_matches(system_endpoint_name,\n+                                                                            system_endpoint_port, tool_endpoints)\n+                        tool_endpoint[\"isDefault\"] = str(isDefaultEndpoint).lower()\n+                        if modified_count != 0:\n+                                tool_endpoints = modified_tool_endpoints\n+                                modified_endpoints_count += modified_count\n                         tool_endpoints.append(json.dumps(tool_endpoint))\n-        return tool_endpoints \n+        return tool_endpoints, modified_endpoints_count\n+\n+\n+def remove_from_tool_endpoints_if_fully_matches(endpoint_name, endpoint_port, tool_endpoints):\n+        tools_endpoints_wo_matches = []\n+        endpoints_modified = 0\n+        isModifiedDefault = False", "originalCommit": "644107be4154dec33719986a6560c950ee9c5cad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjk0NjI4Mg==", "url": "https://github.com/epam/cloud-pipeline/pull/1267#discussion_r482946282", "bodyText": "Done", "author": "Wedds", "createdAt": "2020-09-03T12:40:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg3MDM5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg3MDgxMA==", "url": "https://github.com/epam/cloud-pipeline/pull/1267#discussion_r482870810", "bodyText": "Is it correct field name?", "author": "ekazachkova", "createdAt": "2020-09-03T10:20:04Z", "path": "deploy/docker/cp-edge/sync-routes.py", "diffHunk": "@@ -273,16 +286,48 @@ def append_system_endpoints(tool_endpoints, run_details):\n                         current_tool_endpoint = json.loads(tool_endpoints[0])\n                         current_tool_endpoint[\"isDefault\"] = \"true\"\n                         tool_endpoints[0] = json.dumps(current_tool_endpoint)\n-\n                 # Append system endpoints to the existing list\n                 for system_endpoint in system_endpoints_matched:\n-                        tool_endpoint = { \"nginx\": { \"port\": system_endpoint[\"endpoint\"] }, \"isDefault\": \"false\" }\n+                        tool_endpoint = { \"nginx\": { \"port\": system_endpoint[\"endpoint\"] }}\n+                        system_endpoint_port = system_endpoint[\"endpoint\"]\n+                        system_endpoint_name = None\n                         if \"friendly_name\" in system_endpoint:\n                                 tool_endpoint[\"name\"] = system_endpoint[\"friendly_name\"]\n+                                system_endpoint_name = system_endpoint[\"friendly_name\"]\n                         if \"endpoint_num\" in system_endpoint and system_endpoint[\"endpoint_num\"]:\n                                 tool_endpoint[\"endpoint_num\"] = system_endpoint[\"endpoint_num\"]\n+                        modified_tool_endpoints, modified_count, isDefaultEndpoint = \\\n+                                remove_from_tool_endpoints_if_fully_matches(system_endpoint_name,\n+                                                                            system_endpoint_port, tool_endpoints)\n+                        tool_endpoint[\"isDefault\"] = str(isDefaultEndpoint).lower()\n+                        if modified_count != 0:\n+                                tool_endpoints = modified_tool_endpoints\n+                                modified_endpoints_count += modified_count\n                         tool_endpoints.append(json.dumps(tool_endpoint))\n-        return tool_endpoints \n+        return tool_endpoints, modified_endpoints_count\n+\n+\n+def remove_from_tool_endpoints_if_fully_matches(endpoint_name, endpoint_port, tool_endpoints):\n+        tools_endpoints_wo_matches = []", "originalCommit": "644107be4154dec33719986a6560c950ee9c5cad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjk0NjM3OQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1267#discussion_r482946379", "bodyText": "Renamed to more suitable non_matching_tool_endpoints", "author": "Wedds", "createdAt": "2020-09-03T12:40:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg3MDgxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg5NDE0OQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1267#discussion_r482894149", "bodyText": "Should we add check 'spec' and 'containers' for existence and pod['spec']['containers'][0] for not null?", "author": "ekazachkova", "createdAt": "2020-09-03T11:04:50Z", "path": "deploy/docker/cp-edge/sync-routes.py", "diffHunk": "@@ -412,17 +463,35 @@ def get_service_list(pod_id, pod_run_id, pod_ip):\n         print('EDGE service port: ' + str(edge_service_port))\n         print('EDGE service ip: ' + edge_service_external_ip)\n \n-# From each pod with \"job-type=Service\"  we shall take:\n+# From each pod with a container, which has endpoints (\"job-type=Service\" or container's environment\n+# has a parameter from SYSTEM_ENDPOINTS) we shall take:\n # -- PodIP\n # -- PodID\n # -- N entries by a template\n # --- svc-port-N\n # --- svc-path-N\n-pods = Pod.objects(kube_api).filter(selector={'job-type': 'Service'})\\\n-                            .filter(field_selector={\"status.phase\": \"Running\"})\n+\n+def load_pods_for_runs_with_endpoints():\n+        pods_with_endpoints = []\n+        all_pipeline_pods = Pod.objects(kube_api).filter(selector={'type': 'pipeline'})\\\n+                                                 .filter(field_selector={\"status.phase\": \"Running\"})\n+        for pod in all_pipeline_pods.response['items']:\n+                labels = pod['metadata']['labels']\n+                if 'job-type' in labels and labels['job-type'] == 'Service':\n+                        pods_with_endpoints.append(pod)\n+                        continue\n+                pipeline_env_parameters = pod['spec']['containers'][0]['env']", "originalCommit": "644107be4154dec33719986a6560c950ee9c5cad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjk0NzYxNw==", "url": "https://github.com/epam/cloud-pipeline/pull/1267#discussion_r482947617", "bodyText": "Done, perform additional checks, that response structure is as expected", "author": "Wedds", "createdAt": "2020-09-03T12:42:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg5NDE0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg5Nzg5OA==", "url": "https://github.com/epam/cloud-pipeline/pull/1267#discussion_r482897898", "bodyText": "According to this naming, it looks like modified_count = len(modified_tool_endpoints) but this is not true. Maybe we should make more understandable names?", "author": "ekazachkova", "createdAt": "2020-09-03T11:12:05Z", "path": "deploy/docker/cp-edge/sync-routes.py", "diffHunk": "@@ -273,16 +286,48 @@ def append_system_endpoints(tool_endpoints, run_details):\n                         current_tool_endpoint = json.loads(tool_endpoints[0])\n                         current_tool_endpoint[\"isDefault\"] = \"true\"\n                         tool_endpoints[0] = json.dumps(current_tool_endpoint)\n-\n                 # Append system endpoints to the existing list\n                 for system_endpoint in system_endpoints_matched:\n-                        tool_endpoint = { \"nginx\": { \"port\": system_endpoint[\"endpoint\"] }, \"isDefault\": \"false\" }\n+                        tool_endpoint = { \"nginx\": { \"port\": system_endpoint[\"endpoint\"] }}\n+                        system_endpoint_port = system_endpoint[\"endpoint\"]\n+                        system_endpoint_name = None\n                         if \"friendly_name\" in system_endpoint:\n                                 tool_endpoint[\"name\"] = system_endpoint[\"friendly_name\"]\n+                                system_endpoint_name = system_endpoint[\"friendly_name\"]\n                         if \"endpoint_num\" in system_endpoint and system_endpoint[\"endpoint_num\"]:\n                                 tool_endpoint[\"endpoint_num\"] = system_endpoint[\"endpoint_num\"]\n+                        modified_tool_endpoints, modified_count, isDefaultEndpoint = \\", "originalCommit": "644107be4154dec33719986a6560c950ee9c5cad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjk0ODQ3Nw==", "url": "https://github.com/epam/cloud-pipeline/pull/1267#discussion_r482948477", "bodyText": "More convenient prefixes are used for those values", "author": "Wedds", "createdAt": "2020-09-03T12:44:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg5Nzg5OA=="}], "type": "inlineReview"}, {"oid": "125ee2de74082405947a0f8e25317572ce6967ce", "url": "https://github.com/epam/cloud-pipeline/commit/125ee2de74082405947a0f8e25317572ce6967ce", "message": "Issue #1245 Fix naming up to conventions, expand response verification during the search of interactive runs", "committedDate": "2020-09-03T12:36:38Z", "type": "commit"}]}