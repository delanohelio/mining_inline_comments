{"pr_number": 973, "pr_title": "Add item renderer with model transformation mode, deprecate old one.", "pr_createdAt": "2020-07-30T19:07:52Z", "pr_url": "https://github.com/FabricMC/fabric/pull/973", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI2NzYzNg==", "url": "https://github.com/FabricMC/fabric/pull/973#discussion_r463267636", "bodyText": "I do not think this is a multiplier.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t * @param light           the color light multiplier at the rendering position\n          \n          \n            \n            \t * @param light           packed lightmap coordinates", "author": "shartte", "createdAt": "2020-07-30T20:58:56Z", "path": "fabric-rendering-v1/src/main/java/net/fabricmc/fabric/api/client/rendering/v1/BuiltinItemRendererWithMode.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/*\n+ * Copyright (c) 2016, 2017, 2018, 2019 FabricMC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package net.fabricmc.fabric.api.client.rendering.v1;\n+\n+import net.minecraft.client.render.VertexConsumerProvider;\n+import net.minecraft.client.render.model.json.ModelTransformation;\n+import net.minecraft.client.util.math.MatrixStack;\n+import net.minecraft.item.ItemStack;\n+\n+/**\n+ * Builtin item renderers render items with custom code.\n+ * They allow using non-model rendering, such as BERs, for items.\n+ *\n+ * <p>An item with a builtin renderer must have a model extending {@code minecraft:builtin/entity}.\n+ * The renderers are registered with {@link BuiltinItemRendererRegistry#register}.\n+ */\n+public interface BuiltinItemRendererWithMode {\n+\t/**\n+\t * Renders an item stack.\n+\t *\n+\t * @param stack           the rendered item stack\n+\t * @param mode            the model transformation mode\n+\t * @param matrices        the matrix stack\n+\t * @param vertexConsumers the vertex consumer provider\n+\t * @param light           the color light multiplier at the rendering position", "originalCommit": "783b5d72141a3b6305dff9df5daa4d2a2ba4a6b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc0NjEzMQ==", "url": "https://github.com/FabricMC/fabric/pull/973#discussion_r463746131", "bodyText": "can just convert this to a lambda imo since that is not performance-wise worse", "author": "liach", "createdAt": "2020-07-31T17:46:32Z", "path": "fabric-rendering-v1/src/main/java/net/fabricmc/fabric/impl/client/rendering/BuiltinItemRendererRegistryImpl.java", "diffHunk": "@@ -50,7 +59,23 @@ public void register(Item item, BuiltinItemRenderer renderer) {\n \t}\n \n \t/* @Nullable */\n-\tpublic static BuiltinItemRenderer getRenderer(Item item) {\n+\tpublic static DynamicItemRenderer getRenderer(Item item) {\n \t\treturn RENDERERS.get(item);\n \t}\n+\n+\t/**\n+\t * An implementation of the new renderer that forwards calls to an old renderer.\n+\t */\n+\tstatic class OldRendererImpl implements DynamicItemRenderer {\n+\t\tprivate final BuiltinItemRenderer renderer;\n+\n+\t\tprivate OldRendererImpl(BuiltinItemRenderer renderer) {\n+\t\t\tthis.renderer = renderer;", "originalCommit": "ea2bd7d3c6acee293d867f3ba3e323be99161f05", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk5MTE1Ng==", "url": "https://github.com/FabricMC/fabric/pull/973#discussion_r463991156", "bodyText": "Just messy as a Lambda imo. But I could", "author": "i509VCB", "createdAt": "2020-08-01T19:12:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc0NjEzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDExNjgyMg==", "url": "https://github.com/FabricMC/fabric/pull/973#discussion_r464116822", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tthis.register(item, new OldRendererImpl(Objects.requireNonNull(renderer, \"renderer is null\")));\n          \n          \n            \n            \t\tObjects.requireNonNull(renderer, \"renderer is null\")\n          \n          \n            \n            \t\tthis.register(item, (stack, mode, matrices, vertexConsumers, light, overlay) -> renderer.render(stack, matrices, vertexConsumers, light, overlay));\n          \n      \n    \n    \n  \n\nAnd remove that old renderer class", "author": "liach", "createdAt": "2020-08-02T19:52:08Z", "path": "fabric-rendering-v1/src/main/java/net/fabricmc/fabric/impl/client/rendering/BuiltinItemRendererRegistryImpl.java", "diffHunk": "@@ -32,13 +36,18 @@\n public final class BuiltinItemRendererRegistryImpl implements BuiltinItemRendererRegistry {\n \tpublic static final BuiltinItemRendererRegistryImpl INSTANCE = new BuiltinItemRendererRegistryImpl();\n \n-\tprivate static final Map<Item, BuiltinItemRenderer> RENDERERS = new HashMap<>();\n+\tprivate static final Map<Item, DynamicItemRenderer> RENDERERS = new HashMap<>();\n \n \tprivate BuiltinItemRendererRegistryImpl() {\n \t}\n \n \t@Override\n \tpublic void register(Item item, BuiltinItemRenderer renderer) {\n+\t\tthis.register(item, new OldRendererImpl(Objects.requireNonNull(renderer, \"renderer is null\")));", "originalCommit": "ea2bd7d3c6acee293d867f3ba3e323be99161f05", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMyNjI4MQ==", "url": "https://github.com/FabricMC/fabric/pull/973#discussion_r469326281", "bodyText": "I think this would be better as a top-level type like the old interface.", "author": "Juuxel", "createdAt": "2020-08-12T15:01:35Z", "path": "fabric-rendering-v1/src/main/java/net/fabricmc/fabric/api/client/rendering/v1/BuiltinItemRendererRegistry.java", "diffHunk": "@@ -42,6 +47,43 @@\n \t * @param renderer the renderer\n \t * @throws IllegalArgumentException if the item already has a registered renderer\n \t * @throws NullPointerException if either the item or the renderer is null\n+\t * @deprecated Please use {@link BuiltinItemRendererRegistry#register(Item, DynamicItemRenderer)} instead.\n \t */\n+\t@Deprecated\n \tvoid register(Item item, BuiltinItemRenderer renderer);\n+\n+\t/**\n+\t * Registers the renderer for the item.\n+\t *\n+\t * <p>Note that the item's JSON model must also extend {@code minecraft:builtin/entity}.\n+\t *\n+\t * @param item     the item\n+\t * @param renderer the renderer\n+\t * @throws IllegalArgumentException if the item already has a registered renderer\n+\t * @throws NullPointerException if either the item or the renderer is null\n+\t */\n+\tvoid register(ItemConvertible item, DynamicItemRenderer renderer);\n+\n+\t/**\n+\t * Dynamic item renderers render items with custom code.\n+\t * They allow using non-model rendering, such as BERs, for items.\n+\t *\n+\t * <p>An item with a dynamic renderer must have a model extending {@code minecraft:builtin/entity}.\n+\t * The renderers are registered with {@link BuiltinItemRendererRegistry#register(Item, DynamicItemRenderer)}.\n+\t */\n+\t@FunctionalInterface\n+\t@Environment(EnvType.CLIENT)\n+\tinterface DynamicItemRenderer {", "originalCommit": "d614115edb54f48020dbcfc2e979247ead3a1ebc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQxMzAxMg==", "url": "https://github.com/FabricMC/fabric/pull/973#discussion_r469413012", "bodyText": "Given this name, it's better left at top level indeed. \ud83d\udc4d", "author": "liach", "createdAt": "2020-08-12T17:11:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMyNjI4MQ=="}], "type": "inlineReview"}, {"oid": "aa4a6e0a2545ed6909cad5d9905fbd2f10228d5e", "url": "https://github.com/FabricMC/fabric/commit/aa4a6e0a2545ed6909cad5d9905fbd2f10228d5e", "message": "Add item renderer with model transformation mode, deprecate old one.\n\nThis PR simply adds a new interface which supplies the additional `Mode` parameter.\nAll old renderers are delegated to an implementation of the new renderer, thereby making this PR still backwards compatable with all existing renderers.\n\n(cherry picked from commit 7c9162e99f48c6e3989eec9a46afaa935d65ce30)", "committedDate": "2020-08-15T22:09:36Z", "type": "commit"}, {"oid": "277c5ba0934913601fbdd918f1aabf7da9301717", "url": "https://github.com/FabricMC/fabric/commit/277c5ba0934913601fbdd918f1aabf7da9301717", "message": "Update fabric-rendering-v1/src/main/java/net/fabricmc/fabric/api/client/rendering/v1/BuiltinItemRendererWithMode.java\n\nCo-authored-by: shartte <shartte@users.noreply.github.com>", "committedDate": "2020-08-15T22:09:43Z", "type": "commit"}, {"oid": "34d4723e54f63e1bf7d0095d0903f94142b43101", "url": "https://github.com/FabricMC/fabric/commit/34d4723e54f63e1bf7d0095d0903f94142b43101", "message": "Rename new interfact to `DynamicItemRenderer`, make it an inner class of the registry class.", "committedDate": "2020-08-15T22:11:58Z", "type": "commit"}, {"oid": "137e9f4d43f1d702bf28106c83b7aebac715bb94", "url": "https://github.com/FabricMC/fabric/commit/137e9f4d43f1d702bf28106c83b7aebac715bb94", "message": "Update fabric-rendering-v1/src/main/java/net/fabricmc/fabric/impl/client/rendering/BuiltinItemRendererRegistryImpl.java\n\nCo-authored-by: liach <7806504+liach@users.noreply.github.com>", "committedDate": "2020-08-15T22:12:05Z", "type": "commit"}, {"oid": "19d67c651061c60e703dc97dc8cbfc33a90a7a20", "url": "https://github.com/FabricMC/fabric/commit/19d67c651061c60e703dc97dc8cbfc33a90a7a20", "message": "Update BuiltinItemRendererRegistryImpl.java", "committedDate": "2020-08-15T22:12:05Z", "type": "commit"}, {"oid": "63babaf0d55e3764672ae22a8b97f4c20764ebf4", "url": "https://github.com/FabricMC/fabric/commit/63babaf0d55e3764672ae22a8b97f4c20764ebf4", "message": "Update BuiltinItemRendererRegistryImpl.java", "committedDate": "2020-08-15T22:12:05Z", "type": "commit"}, {"oid": "2068053fee9fefd41bf29478a2fe383256fc6369", "url": "https://github.com/FabricMC/fabric/commit/2068053fee9fefd41bf29478a2fe383256fc6369", "message": "Imports", "committedDate": "2020-08-15T22:13:14Z", "type": "commit"}, {"oid": "97ca40bb4ab28c85a30ef4bf893004825eefc45a", "url": "https://github.com/FabricMC/fabric/commit/97ca40bb4ab28c85a30ef4bf893004825eefc45a", "message": "Use ItemConvertible for new render method", "committedDate": "2020-08-15T22:13:17Z", "type": "commit"}, {"oid": "97ca40bb4ab28c85a30ef4bf893004825eefc45a", "url": "https://github.com/FabricMC/fabric/commit/97ca40bb4ab28c85a30ef4bf893004825eefc45a", "message": "Use ItemConvertible for new render method", "committedDate": "2020-08-15T22:13:17Z", "type": "forcePushed"}, {"oid": "05173ab70038fdce9194d88d535a431d61b6008e", "url": "https://github.com/FabricMC/fabric/commit/05173ab70038fdce9194d88d535a431d61b6008e", "message": "Rename new interfact to `DynamicItemRenderer`, make it an inner class of the registry class.\n\nfabric-rendering-v1/src/main/java/net/fabricmc/fabric/api/client/rendering/v1/BuiltinItemRendererRegistry.java", "committedDate": "2020-08-15T23:04:32Z", "type": "commit"}, {"oid": "96b20b860bb9643502a60b38108fb3c58efb7c0c", "url": "https://github.com/FabricMC/fabric/commit/96b20b860bb9643502a60b38108fb3c58efb7c0c", "message": "Move inner class out, fix formatting issue in loot-tables with linux oses", "committedDate": "2020-08-16T00:02:11Z", "type": "commit"}, {"oid": "bd722306337139bfa7470fbe262e550434f2b635", "url": "https://github.com/FabricMC/fabric/commit/bd722306337139bfa7470fbe262e550434f2b635", "message": "why was this multilined", "committedDate": "2020-08-16T04:11:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTA2MjgwMg==", "url": "https://github.com/FabricMC/fabric/pull/973#discussion_r471062802", "bodyText": "So a story on this one, apparently a symbol was there that prevents gradle from building on my arch setup, so the whitespace had to change", "author": "i509VCB", "createdAt": "2020-08-16T04:15:07Z", "path": "fabric-loot-tables-v1/src/main/java/net/fabricmc/fabric/api/loot/v1/FabricLootSupplierBuilder.java", "diffHunk": "@@ -81,7 +81,7 @@ public FabricLootSupplierBuilder copyFrom(LootTable supplier) {\n \t}\n \n \t/**\n-\t * Copies the pools and functions of the\u00a0{@code supplier} to this builder.\n+\t * Copies the pools and functions of the {@code supplier} to this builder.", "originalCommit": "bd722306337139bfa7470fbe262e550434f2b635", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTA4MTA3MQ==", "url": "https://github.com/FabricMC/fabric/pull/973#discussion_r471081071", "bodyText": "Ah, I've probably made an accidental NBSP there (iirc that's my code?)", "author": "Juuxel", "createdAt": "2020-08-16T08:02:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTA2MjgwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE4NTUxMw==", "url": "https://github.com/FabricMC/fabric/pull/973#discussion_r483185513", "bodyText": "Can checksyle fail on these? idk", "author": "modmuss50", "createdAt": "2020-09-03T18:47:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTA2MjgwMg=="}], "type": "inlineReview"}, {"oid": "5e02f8012415122e31213ac790a482002ce5f6e3", "url": "https://github.com/FabricMC/fabric/commit/5e02f8012415122e31213ac790a482002ce5f6e3", "message": "license header lol", "committedDate": "2020-08-19T19:38:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM3Nzc5NQ==", "url": "https://github.com/FabricMC/fabric/pull/973#discussion_r473377795", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tif (RENDERERS.containsKey(item.asItem())) {\n          \n          \n            \n            \t\tif (RENDERERS.put(item.asItem(), renderer) != null) {", "author": "liach", "createdAt": "2020-08-19T22:15:07Z", "path": "fabric-rendering-v1/src/main/java/net/fabricmc/fabric/impl/client/rendering/BuiltinItemRendererRegistryImpl.java", "diffHunk": "@@ -56,8 +51,21 @@ public void register(ItemConvertible item, BuiltinItemRenderer renderer) {\n \t\tregister(item.asItem(), renderer);\n \t}\n \n+\t@Override\n+\tpublic void register(ItemConvertible item, DynamicItemRenderer renderer) {\n+\t\tObjects.requireNonNull(item, \"item is null\");\n+\t\tObjects.requireNonNull(item.asItem(), \"item is null\");\n+\t\tObjects.requireNonNull(renderer, \"renderer is null\");\n+\n+\t\tif (RENDERERS.containsKey(item.asItem())) {", "originalCommit": "5e02f8012415122e31213ac790a482002ce5f6e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDA2MDg1Ng==", "url": "https://github.com/FabricMC/fabric/pull/973#discussion_r474060856", "bodyText": "This will still overwrite the existing entry if the modder decides to catch any exceptions produced by this method, which is incorrect behaviour IMO. If that exception is thrown, there should be no side effects to the registry itself.", "author": "Juuxel", "createdAt": "2020-08-20T15:14:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM3Nzc5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ5MTA1Mg==", "url": "https://github.com/FabricMC/fabric/pull/973#discussion_r474491052", "bodyText": "then putIfAbsent", "author": "liach", "createdAt": "2020-08-21T07:55:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM3Nzc5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgxMTg3Ng==", "url": "https://github.com/FabricMC/fabric/pull/973#discussion_r474811876", "bodyText": "Will do that in a bit", "author": "i509VCB", "createdAt": "2020-08-21T16:47:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM3Nzc5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM3ODAwOQ==", "url": "https://github.com/FabricMC/fabric/pull/973#discussion_r473378009", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \n          \n          \n            \n            \t\tRENDERERS.put(item.asItem(), renderer);", "author": "liach", "createdAt": "2020-08-19T22:15:25Z", "path": "fabric-rendering-v1/src/main/java/net/fabricmc/fabric/impl/client/rendering/BuiltinItemRendererRegistryImpl.java", "diffHunk": "@@ -56,8 +51,21 @@ public void register(ItemConvertible item, BuiltinItemRenderer renderer) {\n \t\tregister(item.asItem(), renderer);\n \t}\n \n+\t@Override\n+\tpublic void register(ItemConvertible item, DynamicItemRenderer renderer) {\n+\t\tObjects.requireNonNull(item, \"item is null\");\n+\t\tObjects.requireNonNull(item.asItem(), \"item is null\");\n+\t\tObjects.requireNonNull(renderer, \"renderer is null\");\n+\n+\t\tif (RENDERERS.containsKey(item.asItem())) {\n+\t\t\tthrow new IllegalArgumentException(\"Item \" + Registry.ITEM.getId(item.asItem()) + \" already has a builtin renderer!\");\n+\t\t}\n+\n+\t\tRENDERERS.put(item.asItem(), renderer);", "originalCommit": "5e02f8012415122e31213ac790a482002ce5f6e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5689d9617163f2f962654d952693e276e50733ed", "url": "https://github.com/FabricMC/fabric/commit/5689d9617163f2f962654d952693e276e50733ed", "message": "Apply suggestions from code review\n\nCo-authored-by: liach <7806504+liach@users.noreply.github.com>", "committedDate": "2020-08-19T22:32:41Z", "type": "commit"}, {"oid": "9525063773eb7ec113c02d069883e858d2de1591", "url": "https://github.com/FabricMC/fabric/commit/9525063773eb7ec113c02d069883e858d2de1591", "message": "Make renderer a nested class again", "committedDate": "2020-08-25T19:02:29Z", "type": "commit"}, {"oid": "9e424536b01a30ae77a5d7ffb22befbd629636a1", "url": "https://github.com/FabricMC/fabric/commit/9e424536b01a30ae77a5d7ffb22befbd629636a1", "message": "putIfAbsent", "committedDate": "2020-08-27T18:05:25Z", "type": "commit"}]}