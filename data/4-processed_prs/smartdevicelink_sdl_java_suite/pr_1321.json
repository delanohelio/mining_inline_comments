{"pr_number": 1321, "pr_title": "Align SystemCapabilityManager with iOS (part3)", "pr_createdAt": "2020-03-25T21:31:11Z", "pr_url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1321", "timeline": [{"oid": "ada4a6aab493b48a72ce17ad1ac0b91d232202d7", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/ada4a6aab493b48a72ce17ad1ac0b91d232202d7", "message": "Update comments in SCM", "committedDate": "2020-03-25T16:04:23Z", "type": "commit"}, {"oid": "a7e73066397e3abec6578be6bbe7c317577b08f2", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/a7e73066397e3abec6578be6bbe7c317577b08f2", "message": "Update SCM to avoid force updating if subscribed to capability", "committedDate": "2020-03-25T17:05:35Z", "type": "commit"}, {"oid": "ead0466e11c82a8894a6764c33ef3f6d64784093", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/ead0466e11c82a8894a6764c33ef3f6d64784093", "message": "Update SCM to not send GSCR in HMI NONE", "committedDate": "2020-03-25T18:49:20Z", "type": "commit"}, {"oid": "c77e4412e77b8825b9e940727af8d8f18c43ed94", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/c77e4412e77b8825b9e940727af8d8f18c43ed94", "message": "Fix broken SCM unit tests", "committedDate": "2020-03-25T21:28:16Z", "type": "commit"}, {"oid": "f6c872e283b0022f75336a4d8eb9cffb64c3d245", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/f6c872e283b0022f75336a4d8eb9cffb64c3d245", "message": "Add test to get capability on HMI NONE", "committedDate": "2020-03-25T21:43:21Z", "type": "commit"}, {"oid": "7dfa046a78250d7e9d0f45d2d3d42a69863e200c", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/7dfa046a78250d7e9d0f45d2d3d42a69863e200c", "message": "Add the new getCapability() method to Isdl", "committedDate": "2020-03-26T18:37:54Z", "type": "commit"}, {"oid": "bee9f979499f88a041590290b811896883f6bbe4", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/bee9f979499f88a041590290b811896883f6bbe4", "message": "Add the new getCapability() method to LifecycleManager", "committedDate": "2020-03-26T18:46:36Z", "type": "commit"}, {"oid": "32ba00131305e45ce094b970473fa474b4a12ddc", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/32ba00131305e45ce094b970473fa474b4a12ddc", "message": "Update VideoStreamManager to avoid querying for capabilities in HMI NONE", "committedDate": "2020-03-26T22:39:00Z", "type": "commit"}, {"oid": "a97d392533f167fb93ad0bffa363e60412c29bf7", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/a97d392533f167fb93ad0bffa363e60412c29bf7", "message": "Mark DISPLAYS as auto subscribed when the SCM is created", "committedDate": "2020-03-27T16:28:04Z", "type": "commit"}, {"oid": "205cb94cc7b80ab6adf9c8704ce3e468ea026a63", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/205cb94cc7b80ab6adf9c8704ce3e468ea026a63", "message": "Fix SCM unit tests", "committedDate": "2020-03-27T16:49:31Z", "type": "commit"}, {"oid": "d9340f4a3bd113c9f85b41c770d68b3a94d21d11", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/d9340f4a3bd113c9f85b41c770d68b3a94d21d11", "message": "Fix spacing issue in SCM", "committedDate": "2020-03-27T22:22:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzNzMwMQ==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1321#discussion_r402537301", "bodyText": "This indentation doesn't seem correct", "author": "joeljfischer", "createdAt": "2020-04-02T18:50:24Z", "path": "base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java", "diffHunk": "@@ -284,6 +289,13 @@ public void onReceived(RPCMessage message) {\n                         }\n                     } else if (RPCMessage.KEY_NOTIFICATION.equals(message.getMessageType())) {\n                         switch (message.getFunctionID()) {\n+\t\t\t\t\t\t\tcase ON_HMI_STATUS:\n+\t\t\t\t\t\t\t\tOnHMIStatus onHMIStatus = (OnHMIStatus) message;\n+\t\t\t\t\t\t\t\tif (onHMIStatus.getWindowID() != null && onHMIStatus.getWindowID() != PredefinedWindows.DEFAULT_WINDOW.getValue()) {\n+\t\t\t\t\t\t\t\t\treturn;\n+\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\tcurrentHMILevel = onHMIStatus.getHmiLevel();\n+\t\t\t\t\t\t\t\tbreak;", "originalCommit": "d9340f4a3bd113c9f85b41c770d68b3a94d21d11", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzODI4NQ==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1321#discussion_r402538285", "bodyText": "Indentation?", "author": "joeljfischer", "createdAt": "2020-04-02T18:51:59Z", "path": "base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java", "diffHunk": "@@ -325,11 +336,12 @@ public void onReceived(RPCMessage message) {\n             }\n         };\n \n-        if (callback != null) {\n-        \tcallback.addOnRPCListener(FunctionID.GET_SYSTEM_CAPABILITY, rpcListener);\n-            callback.addOnRPCListener(FunctionID.SET_DISPLAY_LAYOUT, rpcListener);\n-            callback.addOnRPCListener(FunctionID.ON_SYSTEM_CAPABILITY_UPDATED, rpcListener);\n-        }\n+\t\tif (callback != null) {\n+\t\t\tcallback.addOnRPCListener(FunctionID.GET_SYSTEM_CAPABILITY, rpcListener);\n+\t\t\tcallback.addOnRPCListener(FunctionID.SET_DISPLAY_LAYOUT, rpcListener);\n+\t\t\tcallback.addOnRPCListener(FunctionID.ON_SYSTEM_CAPABILITY_UPDATED, rpcListener);\n+\t\t\tcallback.addOnRPCListener(FunctionID.ON_HMI_STATUS, rpcListener);\n+\t\t}", "originalCommit": "d9340f4a3bd113c9f85b41c770d68b3a94d21d11", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "416188dc8a9afd69756d16705a44fe735b5bedbd", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/416188dc8a9afd69756d16705a44fe735b5bedbd", "message": "Fix Indentation issues in SCM", "committedDate": "2020-04-03T14:20:05Z", "type": "commit"}, {"oid": "4dd9dff6eb45603dc963076f3dc0a4069e48d67a", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/4dd9dff6eb45603dc963076f3dc0a4069e48d67a", "message": "Fix Indentation issues in SCM", "committedDate": "2020-04-03T14:22:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU5NTQwMQ==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1321#discussion_r405595401", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\tif (proxy.getSystemCapabilityManager() != null) {\n          \n          \n            \n            \t\t\tif (proxy != null && proxy.getSystemCapabilityManager() != null) {", "author": "joeygrover", "createdAt": "2020-04-08T15:05:20Z", "path": "android/sdl_android/src/main/java/com/smartdevicelink/managers/SdlManager.java", "diffHunk": "@@ -866,6 +866,14 @@ public void getCapability(SystemCapabilityType systemCapabilityType, OnSystemCap\n \t\t\tproxy.getCapability(systemCapabilityType, scListener);\n \t\t}\n \n+\t\t@Override\n+\t\tpublic Object getCapability(SystemCapabilityType systemCapabilityType, OnSystemCapabilityListener scListener, boolean forceUpdate) {\n+\t\t\tif (proxy.getSystemCapabilityManager() != null) {", "originalCommit": "4dd9dff6eb45603dc963076f3dc0a4069e48d67a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU5NjA0Ng==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1321#discussion_r405596046", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\tif (!hmiLevel.equals(HMILevel.HMI_NONE) && VideoStreamManager.this.parameters == null) {\n          \n          \n            \n            \t\t\t\tif (!HMILevel.HMI_NONE.equals(hmiLevel) && VideoStreamManager.this.parameters == null) {", "author": "joeygrover", "createdAt": "2020-04-08T15:06:15Z", "path": "android/sdl_android/src/main/java/com/smartdevicelink/managers/video/VideoStreamManager.java", "diffHunk": "@@ -151,6 +151,9 @@ public void onNotified(RPCNotification notification) {\n \t\t\t\t}\n \t\t\t\tHMILevel prevHMILevel = hmiLevel;\n \t\t\t\thmiLevel = onHMIStatus.getHmiLevel();\n+\t\t\t\tif (!hmiLevel.equals(HMILevel.HMI_NONE) && VideoStreamManager.this.parameters == null) {", "originalCommit": "4dd9dff6eb45603dc963076f3dc0a4069e48d67a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU5NjQyMg==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1321#discussion_r405596422", "bodyText": "Avoids an NPE if hmiLevel is null but doesn't need an NPE check explicitly.", "author": "joeygrover", "createdAt": "2020-04-08T15:06:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU5NjA0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU5ODMxMw==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1321#discussion_r405598313", "bodyText": "Is this what iOS does? IMO our currentHMILevel would be none until we are at least registered on the IVI and even then we are inferring that. However, I'm not sure if it makes much of a difference to simply put this as the initial state or not so if it is what iOS does then this comment can be resolved without action.", "author": "joeygrover", "createdAt": "2020-04-08T15:09:26Z", "path": "base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java", "diffHunk": "@@ -78,14 +80,17 @@\n \tprivate final ISdl callback;\n \tprivate OnRPCListener rpcListener;\n \tprivate boolean shouldConvertDeprecatedDisplayCapabilities;\n+\tprivate HMILevel currentHMILevel;\n \n \tpublic SystemCapabilityManager(ISdl callback) {\n \t\tthis.callback = callback;\n \t\tthis.LISTENER_LOCK = new Object();\n \t\tthis.onSystemCapabilityListeners = new HashMap<>();\n \t\tthis.cachedSystemCapabilities = new HashMap<>();\n \t\tthis.systemCapabilitiesSubscriptionStatus = new HashMap<>();\n+\t\tthis.systemCapabilitiesSubscriptionStatus.put(SystemCapabilityType.DISPLAYS, true);\n \t\tthis.shouldConvertDeprecatedDisplayCapabilities = true;\n+\t\tthis.currentHMILevel = HMILevel.HMI_NONE;", "originalCommit": "4dd9dff6eb45603dc963076f3dc0a4069e48d67a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcxMzU5MA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1321#discussion_r405713590", "bodyText": "Yes, iOS does a similar thing: https://github.com/smartdevicelink/sdl_ios/blob/4f650efc70d853d31b14ccc3e64210f192f3f9b7/SmartDeviceLink/SDLSystemCapabilityManager.m#L97", "author": "bilal-alsharifi", "createdAt": "2020-04-08T18:04:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTU5ODMxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTYwMjU0Mw==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1321#discussion_r405602543", "bodyText": "Do we need the message variable here, or couldn't this simply be inline with the DebugTool call?", "author": "joeygrover", "createdAt": "2020-04-08T15:15:07Z", "path": "base/src/main/java/com/smartdevicelink/proxy/SystemCapabilityManager.java", "diffHunk": "@@ -541,6 +555,15 @@ public boolean removeOnSystemCapabilityListener(final SystemCapabilityType syste\n \t * @param subscribe flag to subscribe to updates of the supplied capability type. True means subscribe; false means cancel subscription; null means don't change current subscription status.\n \t */\n \tprivate void retrieveCapability(final SystemCapabilityType systemCapabilityType, final OnSystemCapabilityListener scListener, final Boolean subscribe) {\n+\t\tif (currentHMILevel != null && currentHMILevel.equals(HMILevel.HMI_NONE)) {\n+\t\t\tString message = String.format(\"Attempted to update type: %s in HMI level NONE, which is not allowed. \" +\n+\t\t\t\t\t\"Please wait until you are in HMI BACKGROUND, LIMITED, or FULL before attempting to update any SystemCapabilityType\", systemCapabilityType);\n+\t\t\tDebugTool.logError(message);", "originalCommit": "4dd9dff6eb45603dc963076f3dc0a4069e48d67a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcxNDYxMA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1321#discussion_r405714610", "bodyText": "I stored the message in var so I can reuse it when I call scListener.onError(message)", "author": "bilal-alsharifi", "createdAt": "2020-04-08T18:05:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTYwMjU0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTYwMjkyOA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1321#discussion_r405602928", "bodyText": "Please add javadoc as to what method should be used instead of this one because of deprecation.", "author": "joeygrover", "createdAt": "2020-04-08T15:15:40Z", "path": "base/src/main/java/com/smartdevicelink/proxy/interfaces/ISdl.java", "diffHunk": "@@ -208,6 +208,7 @@\n      * @param systemCapabilityType a system capability type that should be retrieved\n      * @return the system capability provided if available, null if not\n      */\n+    @Deprecated", "originalCommit": "4dd9dff6eb45603dc963076f3dc0a4069e48d67a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcxOTE0MA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1321#discussion_r405719140", "bodyText": "I will add that to deprecated methods here and in SCM", "author": "bilal-alsharifi", "createdAt": "2020-04-08T18:13:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTYwMjkyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTYwMjk5MA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1321#discussion_r405602990", "bodyText": "Please add javadoc as to what method should be used instead of this one because of deprecation.", "author": "joeygrover", "createdAt": "2020-04-08T15:15:45Z", "path": "base/src/main/java/com/smartdevicelink/proxy/interfaces/ISdl.java", "diffHunk": "@@ -216,8 +217,18 @@\n      * @param scListener listener that will be called when the system capability is retrieved. If already cached, it\n      *                   will be called immediately\n      */\n+    @Deprecated", "originalCommit": "4dd9dff6eb45603dc963076f3dc0a4069e48d67a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTYwNDA2Mg==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1321#discussion_r405604062", "bodyText": "There should probably be some null checks here and in the isCapabilitySupported methods to make sure that LifecycleManager.this.systemCapabilityManager isn't null before simply accessing it.", "author": "joeygrover", "createdAt": "2020-04-08T15:17:15Z", "path": "javaSE/src/main/java/com/smartdevicelink/managers/lifecycle/LifecycleManager.java", "diffHunk": "@@ -1145,6 +1145,11 @@ public void getCapability(SystemCapabilityType systemCapabilityType, OnSystemCap\n \n         }\n \n+        @Override\n+        public Object getCapability(SystemCapabilityType systemCapabilityType, OnSystemCapabilityListener scListener, boolean forceUpdate) {\n+            return LifecycleManager.this.systemCapabilityManager.getCapability(systemCapabilityType, scListener, forceUpdate);", "originalCommit": "4dd9dff6eb45603dc963076f3dc0a4069e48d67a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0a7a25302033513ee7bfd86885f2725fb73698c6", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/0a7a25302033513ee7bfd86885f2725fb73698c6", "message": "Update android/sdl_android/src/main/java/com/smartdevicelink/managers/SdlManager.java\n\nCo-Authored-By: Joey Grover <joeygrover@gmail.com>", "committedDate": "2020-04-08T17:46:02Z", "type": "commit"}, {"oid": "ce273f914a1f1b30446bc1bbac8cee75ee8a05ad", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/ce273f914a1f1b30446bc1bbac8cee75ee8a05ad", "message": "Update android/sdl_android/src/main/java/com/smartdevicelink/managers/video/VideoStreamManager.java\n\nCo-Authored-By: Joey Grover <joeygrover@gmail.com>", "committedDate": "2020-04-08T17:46:41Z", "type": "commit"}, {"oid": "fb483682f1f36d49f68225069afbece15c5074fb", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/fb483682f1f36d49f68225069afbece15c5074fb", "message": "Add some null checks to LifecycleManager", "committedDate": "2020-04-08T17:58:15Z", "type": "commit"}, {"oid": "89f4f1de22f213c67a665451df551ece890693c9", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/89f4f1de22f213c67a665451df551ece890693c9", "message": "Add use @link Javadoc annotation to ISdl and SCM", "committedDate": "2020-04-08T18:13:08Z", "type": "commit"}, {"oid": "f119e40af55c2ce1e5014f6c1d647b2fce7f68ff", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/f119e40af55c2ce1e5014f6c1d647b2fce7f68ff", "message": "Merge branch 'develop' into feature/scm_align_part3\n\n# Conflicts:\n#\tandroid/sdl_android/src/androidTest/java/com/smartdevicelink/test/proxy/SystemCapabilityManagerTests.java\n#\tandroid/sdl_android/src/main/java/com/smartdevicelink/managers/SdlManager.java\n#\tandroid/sdl_android/src/main/java/com/smartdevicelink/managers/video/VideoStreamManager.java", "committedDate": "2020-04-08T18:42:00Z", "type": "commit"}]}