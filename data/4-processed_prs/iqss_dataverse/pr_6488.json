{"pr_number": 6488, "pr_title": "Iqss/6485 - Multiple File Stores", "pr_createdAt": "2020-01-07T19:05:30Z", "pr_url": "https://github.com/IQSS/dataverse/pull/6488", "timeline": [{"oid": "cc0833035208d6c03de18a00b936d5fd35dc8d8b", "url": "https://github.com/IQSS/dataverse/commit/cc0833035208d6c03de18a00b936d5fd35dc8d8b", "message": "multistore implementation (built on direct upload)\n\nConflicts:\n\tpom.xml\n\tsrc/main/java/edu/harvard/iq/dataverse/api/Datasets.java\n\tsrc/main/java/edu/harvard/iq/dataverse/ingest/IngestServiceBean.java", "committedDate": "2020-01-07T14:33:28Z", "type": "commit"}, {"oid": "cdbd6f2a0571146b156f34b1defd047a11fef59d", "url": "https://github.com/IQSS/dataverse/commit/cdbd6f2a0571146b156f34b1defd047a11fef59d", "message": "merge issue", "committedDate": "2020-01-07T14:53:16Z", "type": "commit"}, {"oid": "9cc034a351761d5994aee931ff102369ff439102", "url": "https://github.com/IQSS/dataverse/commit/9cc034a351761d5994aee931ff102369ff439102", "message": "dcm - use new option name - assume store with id 's3'\n\nNote: DCM doesn't use any of the other S3 options in creating the Amazon\n client, so it is somewhat hardcoded that was as well. A rewrite might\n identify a specific s3 store to use, build the amazon client from it's\nsettings and still use the general dcm-s3-bucket-name entry. If DCM\nshould be supported across multiple stores, a\ndataverse.files.<id>.dcm-s3-bucket-name option could be created so that\neverything is ties to a specific store.", "committedDate": "2020-01-07T15:28:27Z", "type": "commit"}, {"oid": "ae6ecfa0bfe254bc7e16cc84112d5d76a9073091", "url": "https://github.com/IQSS/dataverse/commit/ae6ecfa0bfe254bc7e16cc84112d5d76a9073091", "message": "control store via dataverse.storagedriver param\n\nmanageable by superuser only\n\nConflicts:\n\tsrc/main/java/edu/harvard/iq/dataverse/EditDatafilesPage.java\n\tsrc/main/java/edu/harvard/iq/dataverse/dataaccess/DataAccess.java\n\tsrc/main/java/edu/harvard/iq/dataverse/util/FileUtil.java", "committedDate": "2020-01-07T16:23:59Z", "type": "commit"}, {"oid": "79fbd8ce4781ae996c17f0b8e24e1d385bd6a37b", "url": "https://github.com/IQSS/dataverse/commit/79fbd8ce4781ae996c17f0b8e24e1d385bd6a37b", "message": "redirect and url lifetime store specific", "committedDate": "2020-01-07T16:25:05Z", "type": "commit"}, {"oid": "6c506ab5c9a602364563c6afaead1fc875c35135", "url": "https://github.com/IQSS/dataverse/commit/6c506ab5c9a602364563c6afaead1fc875c35135", "message": "limit rsync setup/panel to datasets using 's3' store", "committedDate": "2020-01-07T16:47:26Z", "type": "commit"}, {"oid": "171abe1d1a73abfd867ff5ff1b75bd64121f1b98", "url": "https://github.com/IQSS/dataverse/commit/171abe1d1a73abfd867ff5ff1b75bd64121f1b98", "message": "documentation", "committedDate": "2020-01-07T17:59:59Z", "type": "commit"}, {"oid": "be8a5c7717b39a4334970f9e0eb20bc73c6d48f1", "url": "https://github.com/IQSS/dataverse/commit/be8a5c7717b39a4334970f9e0eb20bc73c6d48f1", "message": "api and doc for it", "committedDate": "2020-01-07T18:29:42Z", "type": "commit"}, {"oid": "2220d87847d3ba6379d6e7f9b2dfb199aca6fe7f", "url": "https://github.com/IQSS/dataverse/commit/2220d87847d3ba6379d6e7f9b2dfb199aca6fe7f", "message": "merge issue", "committedDate": "2020-01-07T18:39:07Z", "type": "commit"}, {"oid": "27b5308acedbf3ea880fe4b2a8f0d95a5961391e", "url": "https://github.com/IQSS/dataverse/commit/27b5308acedbf3ea880fe4b2a8f0d95a5961391e", "message": "minimal file store config", "committedDate": "2020-01-07T18:46:31Z", "type": "commit"}, {"oid": "9e13e066124f50d6b8f1e1c11c752c18f33da661", "url": "https://github.com/IQSS/dataverse/commit/9e13e066124f50d6b8f1e1c11c752c18f33da661", "message": "fix tests", "committedDate": "2020-01-08T18:17:18Z", "type": "commit"}, {"oid": "a7507dcd51c32cb985bdb4e4fc51e5bc1215719e", "url": "https://github.com/IQSS/dataverse/commit/a7507dcd51c32cb985bdb4e4fc51e5bc1215719e", "message": "test fixes", "committedDate": "2020-01-08T18:17:25Z", "type": "commit"}, {"oid": "7073314a0d0ee4a5403b614514e00719d7cf9f8b", "url": "https://github.com/IQSS/dataverse/commit/7073314a0d0ee4a5403b614514e00719d7cf9f8b", "message": "define 'file' store type for default test", "committedDate": "2020-01-08T18:17:32Z", "type": "commit"}, {"oid": "6ec46ba1200e5bd28285dc14612498eb5f2d1861", "url": "https://github.com/IQSS/dataverse/commit/6ec46ba1200e5bd28285dc14612498eb5f2d1861", "message": "doc updates per review", "committedDate": "2020-01-15T17:49:26Z", "type": "commit"}, {"oid": "5edeb487007fbd19f21a73121afa4050a47697bf", "url": "https://github.com/IQSS/dataverse/commit/5edeb487007fbd19f21a73121afa4050a47697bf", "message": "Merge remote-tracking branch 'IQSS/develop' into IQSS/6485\n\nConflicts:\n\tsrc/main/java/edu/harvard/iq/dataverse/ingest/IngestServiceBean.java", "committedDate": "2020-01-15T17:59:56Z", "type": "commit"}, {"oid": "42bec6b761da439202f54dac8136183d683f6bed", "url": "https://github.com/IQSS/dataverse/commit/42bec6b761da439202f54dac8136183d683f6bed", "message": "inherit from parent in 'New Dataverse' form\n\nand show a 'Use Default' label when not set", "committedDate": "2020-01-15T21:02:04Z", "type": "commit"}, {"oid": "2b3bbd86b947b1345c67bca83284324d7af86de8", "url": "https://github.com/IQSS/dataverse/commit/2b3bbd86b947b1345c67bca83284324d7af86de8", "message": "allow storagedriver to be set when adding dataverse via api", "committedDate": "2020-01-15T21:11:49Z", "type": "commit"}, {"oid": "fb67d4e49bf77806aa2228e4681ae775e41a664d", "url": "https://github.com/IQSS/dataverse/commit/fb67d4e49bf77806aa2228e4681ae775e41a664d", "message": "return storage driver label if set", "committedDate": "2020-01-15T21:15:52Z", "type": "commit"}, {"oid": "feb4329cafdcde346da5c2a3efc3f0c747557d82", "url": "https://github.com/IQSS/dataverse/commit/feb4329cafdcde346da5c2a3efc3f0c747557d82", "message": "Removing storage driver setting\n\nThinking further, since setting the driver is superuser-only, it\nshouldn't be settable via the addDataverse API call (at least not\nwithout an additional security check, but even then, making the admin\nuser make a separate call to set the driver via the already defined\nadmin API call might be cleaner.", "committedDate": "2020-01-15T21:56:18Z", "type": "commit"}, {"oid": "b5c7fa13920f9eb06d2de710b4c4fe56b136f35a", "url": "https://github.com/IQSS/dataverse/commit/b5c7fa13920f9eb06d2de710b4c4fe56b136f35a", "message": "updating wording based on design feedback", "committedDate": "2020-01-16T16:41:57Z", "type": "commit"}, {"oid": "f3de92634578e2b57c40018faaa7c0378d7c193b", "url": "https://github.com/IQSS/dataverse/commit/f3de92634578e2b57c40018faaa7c0378d7c193b", "message": "change inheritance mechanism per review feedback\n\nConflicts:\n\tsrc/main/java/edu/harvard/iq/dataverse/dataaccess/DataAccess.java", "committedDate": "2020-01-31T20:26:40Z", "type": "commit"}, {"oid": "eac17c4d197a0e74c28527cf38fa8e455a1b14bf", "url": "https://github.com/IQSS/dataverse/commit/eac17c4d197a0e74c28527cf38fa8e455a1b14bf", "message": "Merge remote-tracking branch 'origin/IQSS/6485' into IQSS/6485", "committedDate": "2020-01-31T20:35:18Z", "type": "commit"}, {"oid": "ccb39e793d0a2d28784a2c292931784acf49abdb", "url": "https://github.com/IQSS/dataverse/commit/ccb39e793d0a2d28784a2c292931784acf49abdb", "message": "Merge remote-tracking branch 'IQSS/develop' into IQSS/6485", "committedDate": "2020-01-31T20:36:22Z", "type": "commit"}, {"oid": "08f059a6f294f571171c4a150cd1d0291c5926b0", "url": "https://github.com/IQSS/dataverse/commit/08f059a6f294f571171c4a150cd1d0291c5926b0", "message": "update new API calls to match", "committedDate": "2020-01-31T20:44:52Z", "type": "commit"}, {"oid": "e1a8a71096465876c9d6bf69ae70ebc964e97e43", "url": "https://github.com/IQSS/dataverse/commit/e1a8a71096465876c9d6bf69ae70ebc964e97e43", "message": "and fix default case for test", "committedDate": "2020-01-31T20:52:42Z", "type": "commit"}, {"oid": "310fb7352f0a095471e0a88851c7d7a77a200a85", "url": "https://github.com/IQSS/dataverse/commit/310fb7352f0a095471e0a88851c7d7a77a200a85", "message": "Merge remote-tracking branch 'IQSS/develop' into IQSS/6485\n\nConflicts:\n\tsrc/main/java/edu/harvard/iq/dataverse/ingest/IngestServiceBean.java", "committedDate": "2020-02-05T21:07:21Z", "type": "commit"}, {"oid": "6b660c5a67de9fa443805bcdb70373809ca82146", "url": "https://github.com/IQSS/dataverse/commit/6b660c5a67de9fa443805bcdb70373809ca82146", "message": "fix storagedriver assignment\n\nthe change to the inheritance model changed the meaning of\ngetStorageDriverId() which now returns what is locally set on a\ndataverse. getEffectiveStorageDriverId() properly recurses as needed to\nfind the effective one (and should never return null).", "committedDate": "2020-02-07T15:38:18Z", "type": "commit"}, {"oid": "669836348cf09789d406be1e0422b9e95ba60739", "url": "https://github.com/IQSS/dataverse/commit/669836348cf09789d406be1e0422b9e95ba60739", "message": "change defaults for storageidentifiers with no driver prepended", "committedDate": "2020-02-08T00:38:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzMyNzI4Ng==", "url": "https://github.com/IQSS/dataverse/pull/6488#discussion_r377327286", "bodyText": "@qqmyers After some testing and looking into this with @kcondon, we are wondering - since it is now possible to configure more than one stores of the type \"file\", it seems like we need to be able to also define different physical directories for these locations.\ni.e., instead of the fixed Ddataverse.files.directory=..., it should be\ndataverse.files.file.directory=..., dataverse.files.file1.directory=..., etc.\n(but maybe we should also leave the current dataverse.files.directory, for backward compatiblity, to be consulted if dataverse.files.file.directory is not defined - ?)\nwhat do you think?", "author": "landreev", "createdAt": "2020-02-10T21:29:56Z", "path": "scripts/installer/glassfish-setup.sh", "diffHunk": "@@ -73,6 +73,9 @@ function preliminary_setup()\n   # location of the datafiles directory: \n   # (defaults to dataverse/files in the users home directory)\n   ./asadmin $ASADMIN_OPTS create-jvm-options \"\\-Ddataverse.files.directory=${FILES_DIR}\"", "originalCommit": "669836348cf09789d406be1e0422b9e95ba60739", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzMzMjc5OA==", "url": "https://github.com/IQSS/dataverse/pull/6488#discussion_r377332798", "bodyText": "@qqmyers OK, please [half]scratch the above - I see what's going on... the code is already doing what I suggested above; it's the documentation and the migration instruction that need to be updated, to include the .directory JVM option. (otherwise the file storage is working, BUT the files end up stored in /tmp/files!)", "author": "landreev", "createdAt": "2020-02-10T21:40:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzMyNzI4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzMzNzA0MA==", "url": "https://github.com/IQSS/dataverse/pull/6488#discussion_r377337040", "bodyText": "Yep - was just writing that up since I knew I'd changed the code. I can update the docs to match.", "author": "qqmyers", "createdAt": "2020-02-10T21:49:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzMyNzI4Ng=="}], "type": "inlineReview"}, {"oid": "ceefc72f369fd86abb2f16ec5f0ea3cc022638c4", "url": "https://github.com/IQSS/dataverse/commit/ceefc72f369fd86abb2f16ec5f0ea3cc022638c4", "message": "Merge remote-tracking branch 'IQSS/develop' into IQSS/6485", "committedDate": "2020-02-11T14:25:11Z", "type": "commit"}, {"oid": "1b44d8a3e8d64071464b6ffefb3958936b5d7c22", "url": "https://github.com/IQSS/dataverse/commit/1b44d8a3e8d64071464b6ffefb3958936b5d7c22", "message": "finalize sql script name, update docs/default temp file store", "committedDate": "2020-02-11T14:54:24Z", "type": "commit"}, {"oid": "9415c63f6bde7b3e9ebb9db16384ffb6aed0084d", "url": "https://github.com/IQSS/dataverse/commit/9415c63f6bde7b3e9ebb9db16384ffb6aed0084d", "message": "Update 6485-multiple-stores.md\n\nFixed temp dir jvm option", "committedDate": "2020-02-11T16:32:25Z", "type": "commit"}, {"oid": "db4ac18a52e2c9e13de756ad4144b9481323d8a9", "url": "https://github.com/IQSS/dataverse/commit/db4ac18a52e2c9e13de756ad4144b9481323d8a9", "message": "Update config.rst\n\nClarified behavior of temp dir jvm option and made more consistent with release notes.", "committedDate": "2020-02-11T16:35:54Z", "type": "commit"}, {"oid": "14e26492096247e5a7d21b1a601ce1421fb9699a", "url": "https://github.com/IQSS/dataverse/commit/14e26492096247e5a7d21b1a601ce1421fb9699a", "message": "Assure file type storage always uses '<driverID>://' prefix\n\navoid a doi: in the dataset storageidentifier\nfix dataset and file storageidentifier assignment issues\nupdate db datafile entries to have file:// if they don't have a prefix\n\nConflicts:\n\tsrc/main/resources/db/migration/V4.19.0.1__tbd_multistore.sql", "committedDate": "2020-02-14T18:33:37Z", "type": "commit"}, {"oid": "734d5666dde8c0ca60e10c308446d064d685df16", "url": "https://github.com/IQSS/dataverse/commit/734d5666dde8c0ca60e10c308446d064d685df16", "message": "doc updates", "committedDate": "2020-02-14T18:49:48Z", "type": "commit"}, {"oid": "1efdf38e4df63118506cee352afa44c62a026621", "url": "https://github.com/IQSS/dataverse/commit/1efdf38e4df63118506cee352afa44c62a026621", "message": "replace default file driverId with real one", "committedDate": "2020-02-14T20:02:50Z", "type": "commit"}, {"oid": "d038a9dd420702fd2d47a7a1c8e1a642e1859bae", "url": "https://github.com/IQSS/dataverse/commit/d038a9dd420702fd2d47a7a1c8e1a642e1859bae", "message": "Merge branch 'IQSS/6485' of\nhttps://github.com/TexasDigitalLibrary/dataverse.git into IQSS/6485\n\nConflicts:\n\tdoc/release-notes/6485-multiple-stores.md", "committedDate": "2020-02-14T23:15:34Z", "type": "commit"}, {"oid": "034787bdb5be394deb246c136a8ddd8a56b1aa8d", "url": "https://github.com/IQSS/dataverse/commit/034787bdb5be394deb246c136a8ddd8a56b1aa8d", "message": "update test and comment", "committedDate": "2020-02-18T19:19:16Z", "type": "commit"}]}