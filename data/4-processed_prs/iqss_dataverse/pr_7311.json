{"pr_number": 7311, "pr_title": "6919 preview tools", "pr_createdAt": "2020-10-07T19:24:19Z", "pr_url": "https://github.com/IQSS/dataverse/pull/7311", "timeline": [{"oid": "bee8880182669c6a659bd72090f3bddc608ecb8a", "url": "https://github.com/IQSS/dataverse/commit/bee8880182669c6a659bd72090f3bddc608ecb8a", "message": "Added static preview icon btn to file table on dataset pg, reviewed references in guides to explore tools [ref #6919]", "committedDate": "2020-08-20T21:51:15Z", "type": "commit"}, {"oid": "9a6c0c90488915183f06f405c1edc84a210da8ec", "url": "https://github.com/IQSS/dataverse/commit/9a6c0c90488915183f06f405c1edc84a210da8ec", "message": "Added hasPreviewMode to example code in Admin Guide, added preview icon btn to Style Guide [ref #6919]", "committedDate": "2020-08-21T14:15:59Z", "type": "commit"}, {"oid": "78fb7df1e6c663d77d539ea91068abb36805df83", "url": "https://github.com/IQSS/dataverse/commit/78fb7df1e6c663d77d539ea91068abb36805df83", "message": "Fixed format and layout issues on Patterns pg in Style Guide [ref #6919]", "committedDate": "2020-08-24T16:19:39Z", "type": "commit"}, {"oid": "37afbce5a31f41010c4ecd878e716d3ef402ca0e", "url": "https://github.com/IQSS/dataverse/commit/37afbce5a31f41010c4ecd878e716d3ef402ca0e", "message": "Merge branch 'develop' into 6919-preview-tools", "committedDate": "2020-08-25T13:43:22Z", "type": "commit"}, {"oid": "b142cc5a93b49e6dc020afd575683dcbe06160cf", "url": "https://github.com/IQSS/dataverse/commit/b142cc5a93b49e6dc020afd575683dcbe06160cf", "message": "Merge branch 'develop' into 6919-preview-tools", "committedDate": "2020-08-27T13:45:45Z", "type": "commit"}, {"oid": "e2d0caf7aed1e40a0c68888781e65d0d5a9e9334", "url": "https://github.com/IQSS/dataverse/commit/e2d0caf7aed1e40a0c68888781e65d0d5a9e9334", "message": "#6919 add Preview Type to External Tools", "committedDate": "2020-08-28T13:22:44Z", "type": "commit"}, {"oid": "8b2dcfd9120b5fdc2f0ae2b33dc81f269f944eab", "url": "https://github.com/IQSS/dataverse/commit/8b2dcfd9120b5fdc2f0ae2b33dc81f269f944eab", "message": "#6919 preview mode logic", "committedDate": "2020-08-28T14:57:56Z", "type": "commit"}, {"oid": "54bd1e37c67737cb73d0b61d7cec77a17d56af5f", "url": "https://github.com/IQSS/dataverse/commit/54bd1e37c67737cb73d0b61d7cec77a17d56af5f", "message": "Merge branch 'develop' into 6919-preview-tools", "committedDate": "2020-09-02T13:33:42Z", "type": "commit"}, {"oid": "5f102bef25b00f572e9eb1e815f2664a9e388bc9", "url": "https://github.com/IQSS/dataverse/commit/5f102bef25b00f572e9eb1e815f2664a9e388bc9", "message": "fix formatting #6919", "committedDate": "2020-09-11T20:57:49Z", "type": "commit"}, {"oid": "80fe7643be2340cbb1e464b5e7befbf33a16aa4e", "url": "https://github.com/IQSS/dataverse/commit/80fe7643be2340cbb1e464b5e7befbf33a16aa4e", "message": "get test passing (preview added) #6919", "committedDate": "2020-09-11T20:59:12Z", "type": "commit"}, {"oid": "a2fb03cb37ba4ff70efd1a842d1b8e1f7555ebd8", "url": "https://github.com/IQSS/dataverse/commit/a2fb03cb37ba4ff70efd1a842d1b8e1f7555ebd8", "message": "add tools to test explore, preview, and both #6919", "committedDate": "2020-09-11T21:01:55Z", "type": "commit"}, {"oid": "2c941485c2a923193801f8397c683a0b85fc959c", "url": "https://github.com/IQSS/dataverse/commit/2c941485c2a923193801f8397c683a0b85fc959c", "message": "show preview tools on Preview tab #6919", "committedDate": "2020-09-14T15:49:46Z", "type": "commit"}, {"oid": "de01f3539e7333dc41d8691a5ce13fc122e41535", "url": "https://github.com/IQSS/dataverse/commit/de01f3539e7333dc41d8691a5ce13fc122e41535", "message": "selectively render preview/eyeball button #6919\n\nThe rule is \"The eyeball is present if the Preview tab is present.\"\n\nThere are edge cases to consider around guestbook, terms of use,\nrestricted data, etc.\n\nFor now we at least check if the appropriate tools are in place.", "committedDate": "2020-09-14T19:51:06Z", "type": "commit"}, {"oid": "50f90180b9ff05583eb414230c5e2eb8f37f57ea", "url": "https://github.com/IQSS/dataverse/commit/50f90180b9ff05583eb414230c5e2eb8f37f57ea", "message": "remove binding and process=@this #6919\n\nOur goal is to include file-download-popup-fragment.xhtml onto another\nlocation, the Preview tab on the file page, while still displaying\nit as a popup on that page.\n\nIn the Preview tab the input fields weren't showing up and we discovered\nthat commenting out \"binding\" made them appear. Commenting out \"binding\"\nresulted in validation not working. Additionally removing process=@this\nalong with much more refactoring, got validation working. Bean validation\nwas added as well.\n\nThe hope is that with this commit in place, we can switch back to trying\nto get the extra \"include\" (mentioned above) working.\n\nSome things to note about this commit:\n\n- Custom UIInput fields have been removed in favor of standard\nBean Validation.\n- The GuestbookResponse field was removed from FileDownloadHelper because\nit was confusing to sometimes set it and other times pass it in as argument\nto various methods. Now we always pass it in.\n- Various unused code was deleted.\n- process=@this wasn't removed from the \"package\" code and it's unknown\nif that code is working.\n\nConflicts:\nsrc/main/java/ValidationMessages.properties", "committedDate": "2020-09-25T20:12:53Z", "type": "commit"}, {"oid": "886cab83b01a29c22b3de7265d6767cd3f6c40d8", "url": "https://github.com/IQSS/dataverse/commit/886cab83b01a29c22b3de7265d6767cd3f6c40d8", "message": "show gb/terms on Preview tab, relax preview rules #6919\n\nThis commit does two things:\n\n- Include file-download-popup-fragment.xhtml (where guestbook and terms live) on the Preview tab.\n- Allow files to be previewed in more scenarios, such as when datasets have a guestbook or terms.\n\nThere are a couple TODO/FIXME items not addressed:\n\n- <p:focus context=\"downloadPopup\"/> was commented out.\n- @form is used in a place where it could be more precise.", "committedDate": "2020-09-30T20:12:00Z", "type": "commit"}, {"oid": "c509773bad1f9f346c4a53d461fba917cae1f412", "url": "https://github.com/IQSS/dataverse/commit/c509773bad1f9f346c4a53d461fba917cae1f412", "message": "Fixed guestbook form focus issue, added external tool type render logic to btn txt on file pg [ref #6919]", "committedDate": "2020-10-02T17:49:48Z", "type": "commit"}, {"oid": "2115b6d8f1debb804f03fe78f79b405439be6a61", "url": "https://github.com/IQSS/dataverse/commit/2115b6d8f1debb804f03fe78f79b405439be6a61", "message": "Added conditional btn text to file pg preview tab external tool btn [ref #6919]", "committedDate": "2020-10-05T19:16:02Z", "type": "commit"}, {"oid": "2b34ca9e3a084d8bad141a69226c31711c13cf73", "url": "https://github.com/IQSS/dataverse/commit/2b34ca9e3a084d8bad141a69226c31711c13cf73", "message": "adding \"process\" to target correct fields #6919", "committedDate": "2020-10-05T19:52:08Z", "type": "commit"}, {"oid": "9a2428310528768f7805f5bca040274bd66c86fd", "url": "https://github.com/IQSS/dataverse/commit/9a2428310528768f7805f5bca040274bd66c86fd", "message": "move validateThisContext up, remove extra p:fragment #6919", "committedDate": "2020-10-05T20:15:09Z", "type": "commit"}, {"oid": "f8213baad2d8d04ad03470d38b926d82c4930285", "url": "https://github.com/IQSS/dataverse/commit/f8213baad2d8d04ad03470d38b926d82c4930285", "message": "more precise update than \"form\" #6919", "committedDate": "2020-10-05T20:28:11Z", "type": "commit"}, {"oid": "55c6854bb6d0269e56ea25772f9d2dd0b24e93dc", "url": "https://github.com/IQSS/dataverse/commit/55c6854bb6d0269e56ea25772f9d2dd0b24e93dc", "message": "expand \"update\" for validation #6919\n\nWithout this update, the failure case was this:\n\n1. When there are required fields, click Accept without filling them in.\n2. Fill in all required fields and click Accept.\n3. The form remains and you cannot see the preview.", "committedDate": "2020-10-05T20:38:43Z", "type": "commit"}, {"oid": "a6d32fffc388ea70dbdd63d48bf58b45b307cecd", "url": "https://github.com/IQSS/dataverse/commit/a6d32fffc388ea70dbdd63d48bf58b45b307cecd", "message": "Merge branch 'develop' into 6919-preview-tools #6919\n\nConflicts:\nsrc/main/java/ValidationMessages.properties", "committedDate": "2020-10-05T20:51:09Z", "type": "commit"}, {"oid": "bff99b3f73099395e0abfd3623342c700fece6ad", "url": "https://github.com/IQSS/dataverse/commit/bff99b3f73099395e0abfd3623342c700fece6ad", "message": "cleanup (no-op), formatting, etc.  #6919", "committedDate": "2020-10-06T20:09:03Z", "type": "commit"}, {"oid": "90f1673c04a09d00eab720bfd1a46b1e51508986", "url": "https://github.com/IQSS/dataverse/commit/90f1673c04a09d00eab720bfd1a46b1e51508986", "message": "update docs for preview tools branch #6919\n\nLots of edits were made previously in this branch.", "committedDate": "2020-10-07T18:41:35Z", "type": "commit"}, {"oid": "a42fa4ddbcd3074c90d60e3f1bb5935b5b17e6f1", "url": "https://github.com/IQSS/dataverse/commit/a42fa4ddbcd3074c90d60e3f1bb5935b5b17e6f1", "message": "add release note for preview tools #6919", "committedDate": "2020-10-07T19:14:27Z", "type": "commit"}, {"oid": "e469cc46e06d4f23cf36d4ac2ddb33e2f8f3deab", "url": "https://github.com/IQSS/dataverse/commit/e469cc46e06d4f23cf36d4ac2ddb33e2f8f3deab", "message": "Merge branch 'develop' into 6919-preview-tools #6919", "committedDate": "2020-10-07T19:16:48Z", "type": "commit"}, {"oid": "5696f5fe24e8870118912755145cfece14cd6af2", "url": "https://github.com/IQSS/dataverse/commit/5696f5fe24e8870118912755145cfece14cd6af2", "message": "Merge branch 'develop' into 6919-preview-tools #6919", "committedDate": "2020-10-08T18:26:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQyOTA1OA==", "url": "https://github.com/IQSS/dataverse/pull/7311#discussion_r502429058", "bodyText": "Do we want/need to say that hasPreviewMode only pertains to explore tools?", "author": "sekmiller", "createdAt": "2020-10-09T13:31:45Z", "path": "doc/sphinx-guides/source/api/external-tools.rst", "diffHunk": "@@ -70,19 +78,19 @@ Terminology\n     ===========================  ==========\n     Term                         Definition\n     ===========================  ==========\n-    external tool manifest       A **JSON file** the defines the URL constructed by Dataverse when users click \"Explore\" or \"Configure\" buttons. External tool makers are asked to host this JSON file on a website (no app store yet, sorry) and explain how to use install and use the tool. Examples include :download:`fabulousFileTool.json <../_static/installation/files/root/external-tools/fabulousFileTool.json>` and :download:`dynamicDatasetTool.json <../_static/installation/files/root/external-tools/dynamicDatasetTool.json>` as well as the real world examples above such as Data Explorer.\n+    external tool manifest       A **JSON file** the defines the URL constructed by Dataverse when users click explore or configure tool options. External tool makers are asked to host this JSON file on a website (no app store yet, sorry) and explain how to use install and use the tool. Examples include :download:`fabulousFileTool.json <../_static/installation/files/root/external-tools/fabulousFileTool.json>` and :download:`dynamicDatasetTool.json <../_static/installation/files/root/external-tools/dynamicDatasetTool.json>` as well as the real world examples above such as Data Explorer.\n \n     displayName                  The **name** of the tool in the Dataverse web interface. For example, \"Data Explorer\".\n \n     description                  The **description** of the tool, which appears in a popup (for configure tools only) so the user who clicked the tool can learn about the tool before being redirected the tool in a new tab in their browser. HTML is supported.\n \n     scope                        Whether the external tool appears and operates at the **file** level or the **dataset** level. Note that a file level tool much also specify the type of file it operates on (see \"contentType\" below).\n \n-    type                         Whether the external tool is an **explore** tool or a **configure** tool. Configure tools require an API token because they make changes to data files (files within datasets). Configure tools are currently not supported at the dataset level (no \"Configure\" button appears in the GUI for datasets).\n+    type                         Whether the external tool is an **explore** tool, a **preview** tool or a **configure** tool. Configure tools require an API token because they make changes to data files (files within datasets). Configure tools are currently not supported at the dataset level.\n \n     toolUrl                      The **base URL** of the tool before query parameters are added.\n     \n-    hasPreviewMode               A boolean that indicates whether tool has a preview mode which can be embedded in the File Page. Since this view is designed for embedding within Dataverse, the preview mode for a tool will typically be a view without headers or other options that may be included with a tool that is designed to be launched in a new window. Sometimes, a tool will exist solely to preview files in Dataverse and the preview mode will be the same as the regular view. \n+    hasPreviewMode               A boolean that indicates whether tool has a preview mode which can be embedded in the File Page. Since this view is designed for embedding within Dataverse, the preview mode for a tool will typically be a view without headers or other options that may be included with a tool that is designed to be launched in a new window. \n ", "originalCommit": "5696f5fe24e8870118912755145cfece14cd6af2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU1OTYyMA==", "url": "https://github.com/IQSS/dataverse/pull/7311#discussion_r502559620", "bodyText": "As we discussed with @scolapasta we might do away with hasPreviewMode entirely and factor out \"type\" to its own table. The idea would be the perhaps tools could have multiple types, so an explore tool would also be a preview tool if it supports preview. We plan to discuss more next week.", "author": "pdurbin", "createdAt": "2020-10-09T16:58:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQyOTA1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU5MzA0Nw==", "url": "https://github.com/IQSS/dataverse/pull/7311#discussion_r502593047", "bodyText": "FWIW: Looking at 5.x with QDR, some of the previewers like audio are small (regardless of file size) and it really makes no sense to have a separate explore button on the file page, so being able to mark such a previewer as preview only would help there, and would make it easy for admins to decide whether other previewers are worth popping out as explore tools or not. So - support for allowing tools to register with one or more types.", "author": "qqmyers", "createdAt": "2020-10-09T18:05:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQyOTA1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU5ODU0Ng==", "url": "https://github.com/IQSS/dataverse/pull/7311#discussion_r502598546", "bodyText": "@qqmyers thanks. To be clear, even with the code as-is in this pull request, it's possible for admins to decide if a tool that offers preview appears under \"explore\" or not. To convert the audio tool to \"preview only\" (again, given the code so far), you'd change it from an \"explore\" tool to a \"preview\" tool. To switch it back, you'd change it from \"preview\" to \"explore\" and make sure hasPreviewMode is true.\nAlso, please note that from the Preview tab, there's always a button to open the tool in a new window. For preview tools the button is labeled \"Open in a New Window\" and for explore tools it's labeled as it was before, \"Explore on [TOOL NAME]\". So popping out happens for both.", "author": "pdurbin", "createdAt": "2020-10-09T18:16:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQyOTA1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY2OTE1Mg==", "url": "https://github.com/IQSS/dataverse/pull/7311#discussion_r509669152", "bodyText": "hasPreviewMode has been removed in 767882b", "author": "pdurbin", "createdAt": "2020-10-21T20:29:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQyOTA1OA=="}], "type": "inlineReview"}, {"oid": "e5eacaea06a3d32e9077bfcd31e26f001672628a", "url": "https://github.com/IQSS/dataverse/commit/e5eacaea06a3d32e9077bfcd31e26f001672628a", "message": "remove \"Tools\" from preview tool switcher #6919", "committedDate": "2020-10-15T18:02:03Z", "type": "commit"}, {"oid": "767882b1e95120113290ed3cded3c3dff5285f3b", "url": "https://github.com/IQSS/dataverse/commit/767882b1e95120113290ed3cded3c3dff5285f3b", "message": "support multiple types, remove hasPreviewMode #6919", "committedDate": "2020-10-21T20:24:42Z", "type": "commit"}, {"oid": "6b62d0d7eb00a8f957af64686db8bf1799f4de76", "url": "https://github.com/IQSS/dataverse/commit/6b62d0d7eb00a8f957af64686db8bf1799f4de76", "message": "Merge branch 'develop' into 6919-preview-tools #6919", "committedDate": "2020-10-21T20:25:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAzMTMzMA==", "url": "https://github.com/IQSS/dataverse/pull/7311#discussion_r511031330", "bodyText": "Because the validation isn't run - any missing required are caught in the UI - we can get rid of this", "author": "sekmiller", "createdAt": "2020-10-23T17:25:27Z", "path": "src/main/java/edu/harvard/iq/dataverse/FileDownloadHelper.java", "diffHunk": "@@ -230,6 +133,7 @@ public void writeGuestbookAndStartDownload(GuestbookResponse guestbookResponse)\n          boolean valid = validateGuestbookResponse(guestbookResponse);\n \n          if (!valid) {\n+             // FIXME: This never validation error shows in the UI (even if you add a bundle entry).", "originalCommit": "6b62d0d7eb00a8f957af64686db8bf1799f4de76", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE3NDg1Mg==", "url": "https://github.com/IQSS/dataverse/pull/7311#discussion_r512174852", "bodyText": "Done in e73d2f4.", "author": "pdurbin", "createdAt": "2020-10-26T18:20:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAzMTMzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAzMjI5OQ==", "url": "https://github.com/IQSS/dataverse/pull/7311#discussion_r511032299", "bodyText": "I don't think this method is needed anymore.", "author": "sekmiller", "createdAt": "2020-10-23T17:27:24Z", "path": "src/main/java/edu/harvard/iq/dataverse/FileDownloadHelper.java", "diffHunk": "@@ -230,6 +133,7 @@ public void writeGuestbookAndStartDownload(GuestbookResponse guestbookResponse)\n          boolean valid = validateGuestbookResponse(guestbookResponse);", "originalCommit": "6b62d0d7eb00a8f957af64686db8bf1799f4de76", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE3NTE2NQ==", "url": "https://github.com/IQSS/dataverse/pull/7311#discussion_r512175165", "bodyText": "Done in e73d2f4.", "author": "pdurbin", "createdAt": "2020-10-26T18:21:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAzMjI5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAzMzEyNA==", "url": "https://github.com/IQSS/dataverse/pull/7311#discussion_r511033124", "bodyText": "Again since the validation is done in the UI, I think you can go directly to writing the GB response", "author": "sekmiller", "createdAt": "2020-10-23T17:29:04Z", "path": "src/main/java/edu/harvard/iq/dataverse/FileDownloadHelper.java", "diffHunk": "@@ -347,7 +251,22 @@ public String startWorldMapDownloadLink(GuestbookResponse guestbookResponse, Fil\n         return retVal;\n     }\n \n-        \n+     /**\n+      * Writes a guestbook entry for either popup scenario: guestbook or terms.\n+      */\n+     public boolean writeGuestbookAndShowPreview(GuestbookResponse guestbookResponse) {\n+         // We've already validated guestbooks on the front end but we validate again\n+         // on the backend (that's what older methods do).\n+         boolean valid = validateGuestbookResponse(guestbookResponse);", "originalCommit": "6b62d0d7eb00a8f957af64686db8bf1799f4de76", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE3NTAwOQ==", "url": "https://github.com/IQSS/dataverse/pull/7311#discussion_r512175009", "bodyText": "Done in e73d2f4.", "author": "pdurbin", "createdAt": "2020-10-26T18:20:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTAzMzEyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA1ODkwMQ==", "url": "https://github.com/IQSS/dataverse/pull/7311#discussion_r511058901", "bodyText": "If we are rendering the buttons based on the gbResponse file formats, can we just have one method for Launching the explore tool, world map and package popup that decides what to do based on the file format. That could reduce three buttons to one.", "author": "sekmiller", "createdAt": "2020-10-23T18:17:01Z", "path": "src/main/webapp/file-download-popup-fragment.xhtml", "diffHunk": "@@ -121,56 +123,83 @@\n                                 </label>\n                                 <p:inputText id=\"customQuestionResponse\"\n                                              styleClass=\"form-control\" value=\"#{customQuestionResponse.response}\"\n-                                             required=\"#{param['DO_GB_VALIDATION'] and customQuestionResponse.customQuestion.required}\"\n+                                             required=\"#{param[validateThisContext] and customQuestionResponse.customQuestion.required}\"\n                                              rendered=\"#{customQuestionResponse.customQuestion.questionType=='text'}\"\n                                              requiredMessage=\"#{bundle['requiredField']}\">\n-                                    <p:ajax listener=\"#{fileDownloadHelper.customQuestionValueChangeListener}\"/>\n                                 </p:inputText>\n                                 <p:message id=\"cqMessages\" for=\"customQuestionResponse\" display=\"text\"/>\n                                 <p:selectOneMenu id=\"customQuestionResponseSelect\"\n                                                  styleClass=\"form-control\" value=\"#{customQuestionResponse.response}\"\n-                                                 required=\"#{param['DO_GB_VALIDATION'] and customQuestionResponse.customQuestion.required}\"\n+                                                 required=\"#{param[validateThisContext] and customQuestionResponse.customQuestion.required}\"\n                                                  rendered=\"#{customQuestionResponse.customQuestion.questionType=='options'}\"\n                                                  requiredMessage=\"#{bundle['requiredField']}\">\n                                     <f:selectItem itemLabel=\"#{bundle.select}\" itemValue=\"\" noSelectionOption=\"true\" />\n                                     <f:selectItems value=\"#{customQuestionResponse.responseSelectItems}\" />\n-                                    <p:ajax listener=\"#{fileDownloadHelper.customQuestionValueChangeListener}\"/>\n                                 </p:selectOneMenu>\n+                                <p:message id=\"cqrsMessages\" for=\"customQuestionResponseSelect\" display=\"text\"/>\n                             </div>\n-                                <div class=\"ui-message ui-message-error ui-widget ui-corner-all\" aria-live=\"polite\" jsf:rendered=\"#{!empty customQuestionResponse.validationMessage}\">\n-                                    <span class=\"ui-message-error-detail\">#{customQuestionResponse.validationMessage}</span>\n-                                </div>\n                         </ui:repeat>\n                     </div>\n                 </div>\n             </p:fragment>\n         </div>\n         <div class=\"button-block\">\n+            <!--\n+            The \"process\" directive below is very important. Without it, the\n+            setters on the GuestbookResponse object can be called twice leading\n+            to form values (name, email, etc) to be overwritten by the object in\n+            the other context. For example, \"name\" in the Preview tab could get\n+            overwritten by \"name\" in the download popup with either a blank\n+            value or a prefilled value, leading to a botched guestbook entry.\n+            \n+            Experimentation was done with adding process=\"downloadPopup\" to the\n+            non-Preview tab buttons but this caused a ComponentNotFoundException\n+            and didn't solve any problems. If you add logging to print out\n+            setName from Guestbook response, you can see that the setters are\n+            called on the GuestbookResponse object from the Preview tab but they\n+            are later overwritten by the setters on the GuestbookResponse object\n+            from the Download popup.\n+            -->\n+            <!--REGULAR DOWNLOAD BUTTON, NO EXTERNAL TOOL, NOT THE PREVIEW TAB-->\n             <!--Note: the guestbookResponse.fileFormat is being set in xhtml via the initial download buttons in file-download-button-fragment.xhtml -->\n-            <p:commandButton styleClass=\"btn btn-default\" process=\"@this\" value=\"#{bundle.acceptTerms}\" rendered=\"#{guestbookResponse.fileFormat != 'externalTool'\n-                                                                                                                            and guestbookResponse.fileFormat != 'worldMap'\n-                                                                                                                            and guestbookResponse.fileFormat != 'package'}\"\n-                           actionListener=\"#{fileDownloadHelper.writeGuestbookAndStartDownload(guestbookResponse)}\"\n-                           update=\"guestbookUIFragment\">\n-                <f:param name=\"DO_GB_VALIDATION\" value=\"true\"/>\n+            <p:commandButton styleClass=\"btn btn-default\" value=\"#{bundle.acceptTerms}\"\n+                             rendered=\"#{guestbookResponse.fileFormat != 'externalTool' and\n+                                         guestbookResponse.fileFormat != 'worldMap' and\n+                                         guestbookResponse.fileFormat != 'package' and\n+                                         popupContext != 'previewTab'}\"\n+                             actionListener=\"#{fileDownloadHelper.writeGuestbookAndStartDownload(guestbookResponse)}\"\n+                             update=\"guestbookUIFragment\">\n+                <f:param name=\"DO_GB_VALIDATION_#{popupContext}\" value=\"true\"/>\n+            </p:commandButton>\n+            <!--PREVIEW TAB BUTTON-->\n+            <p:commandButton styleClass=\"btn btn-default\" value=\"#{bundle.acceptTerms}\"\n+                             rendered=\"#{popupContext == 'previewTab'}\"\n+                             actionListener=\"#{FilePage.showPreview(guestbookResponse)}\"\n+                             process=\"previewTab\"\n+                             update=\"fileForm:tabView\">\n+                <f:param name=\"DO_GB_VALIDATION_#{popupContext}\" value=\"true\"/>\n             </p:commandButton>\n+            <!--WORLDMAP BUTTON-->\n             <p:commandButton styleClass=\"btn btn-default\" value=\"#{bundle.acceptTerms}\" rendered=\"#{guestbookResponse.fileFormat == 'worldMap'}\"\n-                            actionListener=\"#{fileDownloadHelper.startWorldMapDownloadLink(guestbookResponse, null)}\" \n-                            update=\"guestbookUIFragment\">\n-                <f:param name=\"DO_GB_VALIDATION\" value=\"true\"/> \n+                             actionListener=\"#{fileDownloadHelper.startWorldMapDownloadLink(guestbookResponse, null)}\"\n+                             update=\"guestbookUIFragment\">\n+                <f:param name=\"DO_GB_VALIDATION_#{popupContext}\" value=\"true\"/>\n             </p:commandButton>\n+            <!--EXTERNAL TOOL BUTTON-->\n             <!--On the dataset page (but not the file page), \"tool\" is null so we get the tool from the guestbookResponse.-->\n-            <p:commandButton styleClass=\"btn btn-default\" process=\"@this\" value=\"#{bundle.acceptTerms}\" rendered=\"#{guestbookResponse.fileFormat == 'externalTool'}\"\n-                           action=\"#{fileDownloadHelper.writeGuestbookAndLaunchExploreTool(guestbookResponse, fileMetadata, tool)}\"\n-                           update=\"guestbookUIFragment\">\n-                <f:param name=\"DO_GB_VALIDATION\" value=\"true\"/>\n+            <p:commandButton styleClass=\"btn btn-default\" value=\"#{bundle.acceptTerms}\" rendered=\"#{guestbookResponse.fileFormat == 'externalTool'}\"\n+                             action=\"#{fileDownloadHelper.writeGuestbookAndLaunchExploreTool(guestbookResponse, fileMetadata, tool)}\"", "originalCommit": "6b62d0d7eb00a8f957af64686db8bf1799f4de76", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA2MjQxNQ==", "url": "https://github.com/IQSS/dataverse/pull/7311#discussion_r511062415", "bodyText": "A related thought: @djbrooke  has given the ok to start removing world map related buttons and such, so if that helps simplify the code... (I've started to do that in the kebab issue / edit buttons)", "author": "scolapasta", "createdAt": "2020-10-23T18:23:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA1ODkwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA2NDM1NA==", "url": "https://github.com/IQSS/dataverse/pull/7311#discussion_r511064354", "bodyText": "Yes - I have on my list to start clearing out Worldmap issues from Github and to create an issue to pull out any Worldmap/Geoconnect code specific in Dataverse, so it's good to get a headstart.", "author": "djbrooke", "createdAt": "2020-10-23T18:27:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA1ODkwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE4Mjc2OA==", "url": "https://github.com/IQSS/dataverse/pull/7311#discussion_r512182768", "bodyText": "I just looked at this and I don't see a lot of value in refactoring. The complexity has to live somewhere and right now a decision is made on the front end. I think it's fine as it is.", "author": "pdurbin", "createdAt": "2020-10-26T18:33:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA1ODkwMQ=="}], "type": "inlineReview"}, {"oid": "e73d2f4f95819fb746736bafafef21e5f29c5943", "url": "https://github.com/IQSS/dataverse/commit/e73d2f4f95819fb746736bafafef21e5f29c5943", "message": "remove validation checks we don't need #6919\n\nWe've switched to Bean Validation, which is done centrally instead of\nbeing only in the UI.", "committedDate": "2020-10-26T18:18:51Z", "type": "commit"}, {"oid": "132e1ee038291a38dc6549a046fbef116d1a621b", "url": "https://github.com/IQSS/dataverse/commit/132e1ee038291a38dc6549a046fbef116d1a621b", "message": "Merge branch 'develop' into 6919-preview-tools #6919", "committedDate": "2020-10-26T18:31:11Z", "type": "commit"}, {"oid": "a82d8398292293fd945f84d8cfd9ca88f2da214e", "url": "https://github.com/IQSS/dataverse/commit/a82d8398292293fd945f84d8cfd9ca88f2da214e", "message": "#6919 remove unused code", "committedDate": "2020-10-27T14:42:57Z", "type": "commit"}, {"oid": "b6c0778d63c6834fa82a07ce0a704ecdd0ca1cd3", "url": "https://github.com/IQSS/dataverse/commit/b6c0778d63c6834fa82a07ce0a704ecdd0ca1cd3", "message": "Merge branch 'develop' into 6919-preview-tools", "committedDate": "2020-10-27T14:43:20Z", "type": "commit"}]}