{"pr_number": 7164, "pr_title": "7046 dataverse 5 release notes", "pr_createdAt": "2020-08-06T00:35:06Z", "pr_url": "https://github.com/IQSS/dataverse/pull/7164", "timeline": [{"oid": "482f9191becc727d712bee0d3d41ad7f9bfbac85", "url": "https://github.com/IQSS/dataverse/commit/482f9191becc727d712bee0d3d41ad7f9bfbac85", "message": "initial commit for release notes", "committedDate": "2020-07-08T15:37:43Z", "type": "commit"}, {"oid": "1a43e89ecb10588d218f65d2c4c99a7c0ac2cc98", "url": "https://github.com/IQSS/dataverse/commit/1a43e89ecb10588d218f65d2c4c99a7c0ac2cc98", "message": "pre-lunch commit, consolidating content into 5.0 file", "committedDate": "2020-07-08T16:04:20Z", "type": "commit"}, {"oid": "60f8607b543674dd9f7e52dd767e088ea345b469", "url": "https://github.com/IQSS/dataverse/commit/60f8607b543674dd9f7e52dd767e088ea345b469", "message": "consolidating all outstanding release notes files into the main doc", "committedDate": "2020-07-08T18:02:14Z", "type": "commit"}, {"oid": "76181fb1d991e7aa6b0e0f7470c0947e26a8c8bd", "url": "https://github.com/IQSS/dataverse/commit/76181fb1d991e7aa6b0e0f7470c0947e26a8c8bd", "message": "adding additional content, adding stubs for release notes for work still to be merged", "committedDate": "2020-07-08T19:09:04Z", "type": "commit"}, {"oid": "469244d2dac57fb4e4fa873f40dfc080185e1d4c", "url": "https://github.com/IQSS/dataverse/commit/469244d2dac57fb4e4fa873f40dfc080185e1d4c", "message": "cleaning up all the lint warnings", "committedDate": "2020-07-08T19:48:10Z", "type": "commit"}, {"oid": "dff3b34d5b6aaa2a22464c4cd1995349bb5d60b7", "url": "https://github.com/IQSS/dataverse/commit/dff3b34d5b6aaa2a22464c4cd1995349bb5d60b7", "message": "responding to lint warning aobut headers", "committedDate": "2020-07-08T19:51:23Z", "type": "commit"}, {"oid": "176579d1651a637f23ab2bc3e38862fbb519c557", "url": "https://github.com/IQSS/dataverse/commit/176579d1651a637f23ab2bc3e38862fbb519c557", "message": "last update before putting this down and waiting for more notes to come in", "committedDate": "2020-07-08T21:14:50Z", "type": "commit"}, {"oid": "98d280069b2b24fa5d5dff3b13b845df6c5f2634", "url": "https://github.com/IQSS/dataverse/commit/98d280069b2b24fa5d5dff3b13b845df6c5f2634", "message": "update url", "committedDate": "2020-07-09T01:47:05Z", "type": "commit"}, {"oid": "fa2062a10d93d3d26abbb153ecaaac14ad702352", "url": "https://github.com/IQSS/dataverse/commit/fa2062a10d93d3d26abbb153ecaaac14ad702352", "message": "Merge branch 'develop' into 7046-dataverse-5-release-notes", "committedDate": "2020-08-04T19:28:31Z", "type": "commit"}, {"oid": "45e51d17f996e03909014c5fe135d1f5f02841c8", "url": "https://github.com/IQSS/dataverse/commit/45e51d17f996e03909014c5fe135d1f5f02841c8", "message": "update from dev, consolidation", "committedDate": "2020-08-04T19:35:31Z", "type": "commit"}, {"oid": "bd5fe665d79e1a287635dd96029ba186f803b4f6", "url": "https://github.com/IQSS/dataverse/commit/bd5fe665d79e1a287635dd96029ba186f803b4f6", "message": "updates, saving to branch", "committedDate": "2020-08-05T00:59:52Z", "type": "commit"}, {"oid": "42aaedd74bf400664685ca450b0392dc24de7ed2", "url": "https://github.com/IQSS/dataverse/commit/42aaedd74bf400664685ca450b0392dc24de7ed2", "message": "more updates", "committedDate": "2020-08-05T02:03:13Z", "type": "commit"}, {"oid": "7cd3b68f6f55888f3dac44d0dd28aceb00e92869", "url": "https://github.com/IQSS/dataverse/commit/7cd3b68f6f55888f3dac44d0dd28aceb00e92869", "message": "more updates", "committedDate": "2020-08-05T21:44:20Z", "type": "commit"}, {"oid": "96e67b2ce026e7589e882cf820c86ec848b1d023", "url": "https://github.com/IQSS/dataverse/commit/96e67b2ce026e7589e882cf820c86ec848b1d023", "message": "updates before making draft PR", "committedDate": "2020-08-06T00:30:41Z", "type": "commit"}, {"oid": "b8085fd997fc7e1e25480b46709c7c1337108b11", "url": "https://github.com/IQSS/dataverse/commit/b8085fd997fc7e1e25480b46709c7c1337108b11", "message": "Merge branch 'develop' into 7046-dataverse-5-release-notes", "committedDate": "2020-08-06T00:32:28Z", "type": "commit"}, {"oid": "316bdb75655ab2460fd6f744d4f2ed64864e37fd", "url": "https://github.com/IQSS/dataverse/commit/316bdb75655ab2460fd6f744d4f2ed64864e37fd", "message": "need to integrate one more set of notes...", "committedDate": "2020-08-06T00:36:38Z", "type": "commit"}, {"oid": "10b237641a2b0900909351deac3e1517496e9627", "url": "https://github.com/IQSS/dataverse/commit/10b237641a2b0900909351deac3e1517496e9627", "message": "last update before draft PR review", "committedDate": "2020-08-06T00:47:58Z", "type": "commit"}, {"oid": "b7c947a6381a1bef87cead90f7a169798aeb2de6", "url": "https://github.com/IQSS/dataverse/commit/b7c947a6381a1bef87cead90f7a169798aeb2de6", "message": "delete file that has been integrated into the main file", "committedDate": "2020-08-06T16:21:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4Nzg0OQ==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r466687849", "bodyText": "@djbrooke - FWIW:  #7116 changes this but I see it didn't get tagged as 5.0 - as is there are two options that both point to the same URL:  doi.mdcbaseurlstring and :doi.baseurlstringnext.", "author": "qqmyers", "createdAt": "2020-08-06T21:09:36Z", "path": "doc/release-notes/5.0-release-notes.md", "diffHunk": "@@ -0,0 +1,313 @@\n+# Dataverse 5.0\n+\n+This release brings new features, enhancements, and bug fixes to Dataverse. Thank you to all of the community members who contributed code, suggestions, bug reports, and other assistance across the project.\n+\n+Please note that this is a major release and these are long release notes. We offer no apologies. :)\n+\n+## Release Highlights\n+\n+### Continued Dataset and File Redesign: Dataset and File Button Redesign, Responsive Layout\n+\n+The buttons available on the Dataset and File pages have been redesigned. This change is to provide more scalability for future expanded options for data access and exploration, and to provide a consistent experience between the two pages. The dataset and file pages have also be redesigned to be more responsive and function better across multiple devices.\n+\n+This is an important step in the incremental process of the Dataset and File Redesign, following the release of on-page previews, filtering and sorting options, tree view, and other enhancements. Additional features in support of these redesign efforts will follow in later 5.x releases.\n+\n+### Payara 5\n+\n+A major upgrade of the application server provides security updates, access to new features like MicroProfile Config API, and will enable eagerly anticipated upgrades to other core technologies.\n+\n+Note that moving from Glassfish to Payara will be required as part of the move to Dataverse 5. If your installation upgrades to Dataverse 5 without upgrading to Payara, the first step of any troubleshooting will be to suggest an upgrade to Payara.\n+\n+### Primefaces 8\n+\n+Primefaces, the open source UI framework upon which the Dataverse front end is built, has been updated to the most recent version. This provides security updates and bug fixes and will also allow Dataverse developers to take advantage of new features and enhancements.\n+\n+### Download Dataset\n+\n+Users can now more easily Download all files in Dataset. If this causes server instability, it's suggested that Dataverse Installation Administrators take advantage of the new Standalone Zipper Service described below.\n+\n+#### Download All Option on the Dataset Page\n+\n+In previous versions of Dataverse, downloading all files from a dataset meant several clicks to select files and initiate the download. The Dataset Page now includes a Download All option for both the original and archival formats of the files in a dataset under the \"Access Dataset\" button.\n+\n+#### Download All API\n+\n+In previous versions of Dataverse, downloading all files from a dataset via API was a two step process:\n+\n+- Find all the database id of the files.\n+- Download all the files, using those ids (comma-separated).\n+\n+Now you can download all files from a dataset (assuming you have access to them) via API by passing the dataset persistent ID (PID such as DOI or Handle) or the dataset's database id. Versions are also supported like with the \"download metadata\" API you can pass :draft, :latest, :latest-published, or numbers (1.1, 2.0).\n+\n+### A Multi-File, Zipped Download Optimization\n+\n+In this release we are offering an experimental optimization for the multi-file, download-as-zip functionality. If this option is enabled, instead of enforcing size limits, we attempt to serve all the files that the user requested (that they are authorized to download), but the request is redirected to a standalone zipper service running as a cgi executable. Thus moving these potentially long-running jobs completely outside the Application Server (Payara); and preventing service threads from becoming locked serving them. Since zipping is also a CPU-intensive task, it is possible to have this service running on a different host system, thus freeing the cycles on the main Application Server. The system running the service needs to have access to the database as well as to the storage filesystem, and/or S3 bucket.\n+\n+Please consult the scripts/zipdownload/README.md in the Dataverse 5 source tree.\n+\n+The components of the standalone \"zipper tool\" can also be downloaded\n+here:\n+\n+XXXXX\n+\n+(my plan is to build the executable and to add it to the v5\n+release files on github: - L.A.)\n+<https://github.com/IQSS/dataverse/releases/download/v5.0/zipper.zip>.\n+\n+### Updated File Handling\n+\n+Files without extensions can now be uploaded through the UI. This release also changes the way Dataverse handles duplicate (filename or checksum) files in a dataset. Specifically:\n+\n+- Files with the same checksum can be included in a dataset, even if the files are in the same directory.\n+- Files with the same filename can be included in a dataset as long as the files are in different directories.\n+- If a user uploads a file to a directory where a file already exists with that directory/filename combination, Dataverse will adjust the file path and names by adding \"-1\" or \"-2\" as applicable. This change will be visible in the list of files being uploaded.\n+- If the directory or name of an existing or newly uploaded file is edited in such a way that would create a directory/filename combination that already exists, Dataverse will display an error.\n+- If a user attempts to replace a file with another file that has the same checksum, an error message will be displayed and the file will not be able to be replaced.\n+- If a user attempts to replace a file with a file that has the same checksum as a different file in the dataset, a warning will be displayed.\n+- Files without extensions can now be uploaded through the UI.\n+\n+### Pre-Publish DOI Reservation with DataCite\n+\n+Dataverse Installations using DataCite will have DOIs reserved as \"Draft\" with DataCite when the Dataset is created, instead of the reservation taking place locally at create time and the reservation taking place with DataCite at publish time. This allows the DOI to reserved earlier in the publication process.\n+\n+## Major Use Cases\n+\n+Newly-supported use cases in this release include:\n+\n+- Users will be presented with a new workflow around dataset and file access and exploration. (Issue #6684, PR #6909)\n+- Users will experience a UI appropriate across a variety of device sizes. (Issue #6684, PR #6909)\n+- Users will be able to download an entire dataset without needing to select all the files in that dataset. (Issue #6564, PR #6262)\n+- Users will be able to download a dataset with a single API call. (Issue #4529, PR #7086)\n+- Users will have DOIs reserved for their datasets upon dataset create instead of at publish time. (Issue #5093, PR #6901)\n+- Users will be able to upload files without extensions. (Issue #6634, PR #6804)\n+- Users will be able to upload files with the same name in a dataset, as long as a those files are in different file paths. (Issue #4813, PR #6924)\n+- Users will be able to upload files with the same checksum in a dataset. (Issue #4813, PR #6924)\n+- Users will be less likely to encounter locks during the publishing process due to PID providers being unavailable. (Issue #6918, PR #7118)\n+- Users will now have their files validated during publish, and in the unlikely event that anything has happened to the files between deposit and publish, they will be able to take corrective action. (Issue #6558, PR #6790)\n+- Administrators will likely see more success with Harvesting, as many minor harvesting issues have been resolved. (Issues #7127, #7128, #4597, #7056, #7052, #7023, #7009, and #7003)\n+- Administrators can now enable an external zip service that frees up application server resources and allows the zip download limit to be increased. (Issue #6505, PR #6986)\n+- Administrators can now create groups based on users' email domains. (Issue #6936, PR #6974)\n+- Administrators can now set date facets to be organized chronologically. (Issue #4977, PR #6958)\n+- Administrators can now link harvested datasets using an API. (Issue #5886, PR #6935)\n+- Administrators can now destroy datasets with mapped shapefiles. (Issue #4093, PR #6860)\n+\n+## Notes for Dataverse Installation Administrators\n+\n+### Glassfish to Payara\n+\n+This upgrade requires a few extra steps. See the detailed upgrade instructions below.\n+\n+### Dataverse Installations Using DataCite: Upgrade Action Recommended\n+\n+For installations that are using DataCite, Dataverse v5.0 introduces a change in the process of registering the Persistent Identifier (DOI) for a dataset. Instead of registering it when the dataset is published for the first time, Dataverse will try to \"reserve\" the DOI when it's created (by registering it as a \"draft\", using DataCite terminology). When the user publishes the dataset, the DOI will be publicized as well (by switching the registration status to \"findable\"). This approach makes the process of publishing datasets simpler and less error-prone.\n+\n+New APIs have been provided for finding any unreserved DataCite-issued DOIs in your Dataverse, and for reserving them (see below). While not required - the user can still attempt to publish a dataset with an unreserved DOI - having all the identifiers reserved ahead of time is recommended. If you are upgrading an installation that uses DataCite, we specifically recommend that you reserve the DOIs for all your pre-existing unpublished drafts as soon as Dataverse v5.0 is deployed, since none of them were registered at create time. This can be done using the following API calls:  \n+\n+- `/api/pids/unreserved`  will report the ids of the datasets\n+- `/api/pids/:persistentId/reserve` reserves the assigned DOI with DataCite (will need to be run on every id reported by the the first API).\n+\n+See the [Native API Guide](http://guides.dataverse.org/en/5.0/api/native-api.html) for more information.\n+\n+Scripted, the whole process would look as follows (adjust as needed):\n+\n+```\n+   API_TOKEN='xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'\n+\n+   curl -s -H \"X-Dataverse-key:$API_TOKEN\" http://localhost:8080/api/pids/unreserved |\n+   # the API outputs JSON; note the use of jq to parse it:\n+   jq '.data.count[].pid' | tr -d '\"' | \n+   while read doi\n+   do\n+      curl -s -H \"X-Dataverse-key:$API_TOKEN\" -X POST http://localhost:8080/api/pids/:persistentId/reserve?persistentId=$doi\n+   done\n+```\n+\n+Going forward, once all the DOIs have been reserved for the legacy drafts, you may still get an occasional dataset with an unreserved identifier. DataCite service instability would be a potential cause. There is no reason to expect that to happen often, but it is not impossible. You may consider running the script above (perhaps with some extra diagnostics added) regularly, from a cron job or otherwise, to address this preemptively.\n+\n+### Datafiles Validation when Publishing Datasets\n+\n+When a user requests to publish a dataset, Dataverse will now attempt to validate the physical files in the dataset, by recalculating the checksums and verifying them against the values in the database. The goal is to prevent any corrupted files in published datasets. Most of all the instances of actual damage to physical files that we've seen in the past happened while the datafiles were still in the Draft state. (Physical files become essentially read-only once published). So this is the logical place to catch any such issues.\n+\n+If any files in the dataset fail the validation, the dataset does not get published, and the user is notified that they need to contact their Dataverse support in order to address the issue before another attempt to publish can be made. See the \"Troubleshooting\" section of the Guide on how to fix such problems.\n+\n+For datasets with large numbers of files, this validation will be performed asynchronously, using the same mechanism as for the registration of the file-level global ids. The cutoff number of files is configured by the same database setting. Similarly to the file PID registration, this validation process can be disabled on your system, with the setting `:FileValidationOnPublishEnabled`. (A Dataverse admin may choose to disable it if, for example, they are already running an external auditing system to monitor the integrity of the files in their Dataverse, and would prefer the publishing process to take less time). See the Config section of the Installation guide for more info.\n+\n+Please note that we are not aware of any bugs in the current versions of Dataverse that would result in damage to users' files. But you may have some legacy files in your archive that were affected by some issue in the past, or perhaps affected by something outside Dataverse, so we are adding this feature out of abundance of caution. An example of a problem we've experienced in the early versions of Dataverse was a possible scenario where a user actually attempted to delete a Draft file from an unpublished version, where the database transaction would fail for whatever reason, but only after the physical file had already been deleted from the filesystem. Thus resulting in a datafile entry remaining in the dataset, but with the corresponding physical file missing. (the fix for this case, since the user wanted to delete the file in the first place, is simply to confirm it and purge the datafile entity from the database).\n+\n+### The setting :PIDAsynchRegFileCount is deprecated as of v5.0\n+\n+It used to specify the number of datafiles in the dataset to warrant adding a lock during publishing. As of v5.0 all datasets get locked for the duration of the publishing process. The setting will be ignored if present.\n+\n+### Location Changes for Related Projects\n+\n+The dataverse-ansible and dataverse-previewers repositories have been moved to the GDCC Organization on GitHub. If you have been referencing the dataverse-ansible repository from IQSS and the dataverse-previewers from QDR, please instead use them from their new locations:\n+\n+<https://github.com/GlobalDataverseCommunityConsortium/dataverse-ansible>\n+<https://github.com/GlobalDataverseCommunityConsortium/dataverse-previewers>\n+\n+### Harvesting Improvements\n+\n+Many updates have been made to address common Harvesting failures. You may see Harvests complete more often and have a higher success rate on a dataset-by-dataset basis.\n+\n+### New JVM Options and Database Settings\n+\n+Several new JVM options and DB Settings have been added in this release. More documentation about each of these settings can be found in the Configuration section of the [Installation Guide](http://guides.dataverse.org/en/5.0/installation/config.rst).\n+\n+#### New JVM Options\n+\n+- :doi.baseurlstringnext: Set with a value of \"https://api.datacite.org\" for production environments and \"https://api.test.datacite.org\" for test environments. Must be set if you are using DataCite as your DOI provider.", "originalCommit": "b7c947a6381a1bef87cead90f7a169798aeb2de6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA2MTU0NQ==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r467061545", "bodyText": "@qqmyers @scolapasta what is the preferred resolution here? Should #7116 be tagged as 5.0 or no?", "author": "djbrooke", "createdAt": "2020-08-07T14:04:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4Nzg0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA2NTQ4NQ==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r467065485", "bodyText": "I would recommend that - to avoid having duplicate jvm options in 5.0 that would then disappear.\nIf #7116 is a concern because it changes build scripts, a more minimalist approach would just be to replace uses of the newly created doi.baseurlstringnext with doi:mdcbasurlstring (and maybe note that mdcbaseurlstring must be set/is no longer optional/just for mdc) and then use an update to #7116 to give that jvm option a more neutral/correct name.", "author": "qqmyers", "createdAt": "2020-08-07T14:11:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4Nzg0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA4MTY2MQ==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r467081661", "bodyText": "Thanks @qqmyers I'll tag it as 5.0 and we can accept any feedback in that PR. I see there's a release note file as part of the changes in the PR, so it'll force us to revisit the correct phrasing here. :)\ncc: @pdurbin as I saw you brought this up on a Slack thread as well.", "author": "djbrooke", "createdAt": "2020-08-07T14:37:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4Nzg0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4ODUzNg==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r466688536", "bodyText": "This is a setting not a jvm option", "author": "qqmyers", "createdAt": "2020-08-06T21:11:05Z", "path": "doc/release-notes/5.0-release-notes.md", "diffHunk": "@@ -0,0 +1,313 @@\n+# Dataverse 5.0\n+\n+This release brings new features, enhancements, and bug fixes to Dataverse. Thank you to all of the community members who contributed code, suggestions, bug reports, and other assistance across the project.\n+\n+Please note that this is a major release and these are long release notes. We offer no apologies. :)\n+\n+## Release Highlights\n+\n+### Continued Dataset and File Redesign: Dataset and File Button Redesign, Responsive Layout\n+\n+The buttons available on the Dataset and File pages have been redesigned. This change is to provide more scalability for future expanded options for data access and exploration, and to provide a consistent experience between the two pages. The dataset and file pages have also be redesigned to be more responsive and function better across multiple devices.\n+\n+This is an important step in the incremental process of the Dataset and File Redesign, following the release of on-page previews, filtering and sorting options, tree view, and other enhancements. Additional features in support of these redesign efforts will follow in later 5.x releases.\n+\n+### Payara 5\n+\n+A major upgrade of the application server provides security updates, access to new features like MicroProfile Config API, and will enable eagerly anticipated upgrades to other core technologies.\n+\n+Note that moving from Glassfish to Payara will be required as part of the move to Dataverse 5. If your installation upgrades to Dataverse 5 without upgrading to Payara, the first step of any troubleshooting will be to suggest an upgrade to Payara.\n+\n+### Primefaces 8\n+\n+Primefaces, the open source UI framework upon which the Dataverse front end is built, has been updated to the most recent version. This provides security updates and bug fixes and will also allow Dataverse developers to take advantage of new features and enhancements.\n+\n+### Download Dataset\n+\n+Users can now more easily Download all files in Dataset. If this causes server instability, it's suggested that Dataverse Installation Administrators take advantage of the new Standalone Zipper Service described below.\n+\n+#### Download All Option on the Dataset Page\n+\n+In previous versions of Dataverse, downloading all files from a dataset meant several clicks to select files and initiate the download. The Dataset Page now includes a Download All option for both the original and archival formats of the files in a dataset under the \"Access Dataset\" button.\n+\n+#### Download All API\n+\n+In previous versions of Dataverse, downloading all files from a dataset via API was a two step process:\n+\n+- Find all the database id of the files.\n+- Download all the files, using those ids (comma-separated).\n+\n+Now you can download all files from a dataset (assuming you have access to them) via API by passing the dataset persistent ID (PID such as DOI or Handle) or the dataset's database id. Versions are also supported like with the \"download metadata\" API you can pass :draft, :latest, :latest-published, or numbers (1.1, 2.0).\n+\n+### A Multi-File, Zipped Download Optimization\n+\n+In this release we are offering an experimental optimization for the multi-file, download-as-zip functionality. If this option is enabled, instead of enforcing size limits, we attempt to serve all the files that the user requested (that they are authorized to download), but the request is redirected to a standalone zipper service running as a cgi executable. Thus moving these potentially long-running jobs completely outside the Application Server (Payara); and preventing service threads from becoming locked serving them. Since zipping is also a CPU-intensive task, it is possible to have this service running on a different host system, thus freeing the cycles on the main Application Server. The system running the service needs to have access to the database as well as to the storage filesystem, and/or S3 bucket.\n+\n+Please consult the scripts/zipdownload/README.md in the Dataverse 5 source tree.\n+\n+The components of the standalone \"zipper tool\" can also be downloaded\n+here:\n+\n+XXXXX\n+\n+(my plan is to build the executable and to add it to the v5\n+release files on github: - L.A.)\n+<https://github.com/IQSS/dataverse/releases/download/v5.0/zipper.zip>.\n+\n+### Updated File Handling\n+\n+Files without extensions can now be uploaded through the UI. This release also changes the way Dataverse handles duplicate (filename or checksum) files in a dataset. Specifically:\n+\n+- Files with the same checksum can be included in a dataset, even if the files are in the same directory.\n+- Files with the same filename can be included in a dataset as long as the files are in different directories.\n+- If a user uploads a file to a directory where a file already exists with that directory/filename combination, Dataverse will adjust the file path and names by adding \"-1\" or \"-2\" as applicable. This change will be visible in the list of files being uploaded.\n+- If the directory or name of an existing or newly uploaded file is edited in such a way that would create a directory/filename combination that already exists, Dataverse will display an error.\n+- If a user attempts to replace a file with another file that has the same checksum, an error message will be displayed and the file will not be able to be replaced.\n+- If a user attempts to replace a file with a file that has the same checksum as a different file in the dataset, a warning will be displayed.\n+- Files without extensions can now be uploaded through the UI.\n+\n+### Pre-Publish DOI Reservation with DataCite\n+\n+Dataverse Installations using DataCite will have DOIs reserved as \"Draft\" with DataCite when the Dataset is created, instead of the reservation taking place locally at create time and the reservation taking place with DataCite at publish time. This allows the DOI to reserved earlier in the publication process.\n+\n+## Major Use Cases\n+\n+Newly-supported use cases in this release include:\n+\n+- Users will be presented with a new workflow around dataset and file access and exploration. (Issue #6684, PR #6909)\n+- Users will experience a UI appropriate across a variety of device sizes. (Issue #6684, PR #6909)\n+- Users will be able to download an entire dataset without needing to select all the files in that dataset. (Issue #6564, PR #6262)\n+- Users will be able to download a dataset with a single API call. (Issue #4529, PR #7086)\n+- Users will have DOIs reserved for their datasets upon dataset create instead of at publish time. (Issue #5093, PR #6901)\n+- Users will be able to upload files without extensions. (Issue #6634, PR #6804)\n+- Users will be able to upload files with the same name in a dataset, as long as a those files are in different file paths. (Issue #4813, PR #6924)\n+- Users will be able to upload files with the same checksum in a dataset. (Issue #4813, PR #6924)\n+- Users will be less likely to encounter locks during the publishing process due to PID providers being unavailable. (Issue #6918, PR #7118)\n+- Users will now have their files validated during publish, and in the unlikely event that anything has happened to the files between deposit and publish, they will be able to take corrective action. (Issue #6558, PR #6790)\n+- Administrators will likely see more success with Harvesting, as many minor harvesting issues have been resolved. (Issues #7127, #7128, #4597, #7056, #7052, #7023, #7009, and #7003)\n+- Administrators can now enable an external zip service that frees up application server resources and allows the zip download limit to be increased. (Issue #6505, PR #6986)\n+- Administrators can now create groups based on users' email domains. (Issue #6936, PR #6974)\n+- Administrators can now set date facets to be organized chronologically. (Issue #4977, PR #6958)\n+- Administrators can now link harvested datasets using an API. (Issue #5886, PR #6935)\n+- Administrators can now destroy datasets with mapped shapefiles. (Issue #4093, PR #6860)\n+\n+## Notes for Dataverse Installation Administrators\n+\n+### Glassfish to Payara\n+\n+This upgrade requires a few extra steps. See the detailed upgrade instructions below.\n+\n+### Dataverse Installations Using DataCite: Upgrade Action Recommended\n+\n+For installations that are using DataCite, Dataverse v5.0 introduces a change in the process of registering the Persistent Identifier (DOI) for a dataset. Instead of registering it when the dataset is published for the first time, Dataverse will try to \"reserve\" the DOI when it's created (by registering it as a \"draft\", using DataCite terminology). When the user publishes the dataset, the DOI will be publicized as well (by switching the registration status to \"findable\"). This approach makes the process of publishing datasets simpler and less error-prone.\n+\n+New APIs have been provided for finding any unreserved DataCite-issued DOIs in your Dataverse, and for reserving them (see below). While not required - the user can still attempt to publish a dataset with an unreserved DOI - having all the identifiers reserved ahead of time is recommended. If you are upgrading an installation that uses DataCite, we specifically recommend that you reserve the DOIs for all your pre-existing unpublished drafts as soon as Dataverse v5.0 is deployed, since none of them were registered at create time. This can be done using the following API calls:  \n+\n+- `/api/pids/unreserved`  will report the ids of the datasets\n+- `/api/pids/:persistentId/reserve` reserves the assigned DOI with DataCite (will need to be run on every id reported by the the first API).\n+\n+See the [Native API Guide](http://guides.dataverse.org/en/5.0/api/native-api.html) for more information.\n+\n+Scripted, the whole process would look as follows (adjust as needed):\n+\n+```\n+   API_TOKEN='xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'\n+\n+   curl -s -H \"X-Dataverse-key:$API_TOKEN\" http://localhost:8080/api/pids/unreserved |\n+   # the API outputs JSON; note the use of jq to parse it:\n+   jq '.data.count[].pid' | tr -d '\"' | \n+   while read doi\n+   do\n+      curl -s -H \"X-Dataverse-key:$API_TOKEN\" -X POST http://localhost:8080/api/pids/:persistentId/reserve?persistentId=$doi\n+   done\n+```\n+\n+Going forward, once all the DOIs have been reserved for the legacy drafts, you may still get an occasional dataset with an unreserved identifier. DataCite service instability would be a potential cause. There is no reason to expect that to happen often, but it is not impossible. You may consider running the script above (perhaps with some extra diagnostics added) regularly, from a cron job or otherwise, to address this preemptively.\n+\n+### Datafiles Validation when Publishing Datasets\n+\n+When a user requests to publish a dataset, Dataverse will now attempt to validate the physical files in the dataset, by recalculating the checksums and verifying them against the values in the database. The goal is to prevent any corrupted files in published datasets. Most of all the instances of actual damage to physical files that we've seen in the past happened while the datafiles were still in the Draft state. (Physical files become essentially read-only once published). So this is the logical place to catch any such issues.\n+\n+If any files in the dataset fail the validation, the dataset does not get published, and the user is notified that they need to contact their Dataverse support in order to address the issue before another attempt to publish can be made. See the \"Troubleshooting\" section of the Guide on how to fix such problems.\n+\n+For datasets with large numbers of files, this validation will be performed asynchronously, using the same mechanism as for the registration of the file-level global ids. The cutoff number of files is configured by the same database setting. Similarly to the file PID registration, this validation process can be disabled on your system, with the setting `:FileValidationOnPublishEnabled`. (A Dataverse admin may choose to disable it if, for example, they are already running an external auditing system to monitor the integrity of the files in their Dataverse, and would prefer the publishing process to take less time). See the Config section of the Installation guide for more info.\n+\n+Please note that we are not aware of any bugs in the current versions of Dataverse that would result in damage to users' files. But you may have some legacy files in your archive that were affected by some issue in the past, or perhaps affected by something outside Dataverse, so we are adding this feature out of abundance of caution. An example of a problem we've experienced in the early versions of Dataverse was a possible scenario where a user actually attempted to delete a Draft file from an unpublished version, where the database transaction would fail for whatever reason, but only after the physical file had already been deleted from the filesystem. Thus resulting in a datafile entry remaining in the dataset, but with the corresponding physical file missing. (the fix for this case, since the user wanted to delete the file in the first place, is simply to confirm it and purge the datafile entity from the database).\n+\n+### The setting :PIDAsynchRegFileCount is deprecated as of v5.0\n+\n+It used to specify the number of datafiles in the dataset to warrant adding a lock during publishing. As of v5.0 all datasets get locked for the duration of the publishing process. The setting will be ignored if present.\n+\n+### Location Changes for Related Projects\n+\n+The dataverse-ansible and dataverse-previewers repositories have been moved to the GDCC Organization on GitHub. If you have been referencing the dataverse-ansible repository from IQSS and the dataverse-previewers from QDR, please instead use them from their new locations:\n+\n+<https://github.com/GlobalDataverseCommunityConsortium/dataverse-ansible>\n+<https://github.com/GlobalDataverseCommunityConsortium/dataverse-previewers>\n+\n+### Harvesting Improvements\n+\n+Many updates have been made to address common Harvesting failures. You may see Harvests complete more often and have a higher success rate on a dataset-by-dataset basis.\n+\n+### New JVM Options and Database Settings\n+\n+Several new JVM options and DB Settings have been added in this release. More documentation about each of these settings can be found in the Configuration section of the [Installation Guide](http://guides.dataverse.org/en/5.0/installation/config.rst).\n+\n+#### New JVM Options\n+\n+- :doi.baseurlstringnext: Set with a value of \"https://api.datacite.org\" for production environments and \"https://api.test.datacite.org\" for test environments. Must be set if you are using DataCite as your DOI provider.\n+- :dataverse.useripaddresssourceheader: If set, specifies an HTTP Header such as X-Forwarded-For to use to retrieve the user's IP address. This setting is useful in cases such as running Dataverse behind load balancers where the default option of getting the Remote Address from the servlet isn't correct (e.g. it would be the load balancer IP address). Note that unless your installation always sets the header you configure here, this could be used as a way to spoof the user's address.\n+- :FileValidationOnPublishEnabled: Toggles validation of the physical files in the dataset when it's published, by recalculating the checksums and comparing against the values stored in the DataFile table. By default this setting is absent and Dataverse assumes it to be true. If enabled, the validation will be performed asynchronously, similarly to how we handle assigning persistent identifiers to datafiles, with the dataset locked for the duration of the publishing process.", "originalCommit": "b7c947a6381a1bef87cead90f7a169798aeb2de6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY0MjM5NQ==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r466642395", "bodyText": "I would consider moving Primefaces down in the list, even to the bottom. End users don't care, neither do sysadmins (who will need to care about Payara).", "author": "pdurbin", "createdAt": "2020-08-06T19:37:44Z", "path": "doc/release-notes/5.0-release-notes.md", "diffHunk": "@@ -0,0 +1,313 @@\n+# Dataverse 5.0\n+\n+This release brings new features, enhancements, and bug fixes to Dataverse. Thank you to all of the community members who contributed code, suggestions, bug reports, and other assistance across the project.\n+\n+Please note that this is a major release and these are long release notes. We offer no apologies. :)\n+\n+## Release Highlights\n+\n+### Continued Dataset and File Redesign: Dataset and File Button Redesign, Responsive Layout\n+\n+The buttons available on the Dataset and File pages have been redesigned. This change is to provide more scalability for future expanded options for data access and exploration, and to provide a consistent experience between the two pages. The dataset and file pages have also be redesigned to be more responsive and function better across multiple devices.\n+\n+This is an important step in the incremental process of the Dataset and File Redesign, following the release of on-page previews, filtering and sorting options, tree view, and other enhancements. Additional features in support of these redesign efforts will follow in later 5.x releases.\n+\n+### Payara 5\n+\n+A major upgrade of the application server provides security updates, access to new features like MicroProfile Config API, and will enable eagerly anticipated upgrades to other core technologies.\n+\n+Note that moving from Glassfish to Payara will be required as part of the move to Dataverse 5. If your installation upgrades to Dataverse 5 without upgrading to Payara, the first step of any troubleshooting will be to suggest an upgrade to Payara.\n+\n+### Primefaces 8", "originalCommit": "b7c947a6381a1bef87cead90f7a169798aeb2de6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY0NTQ1MQ==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r466645451", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Note that moving from Glassfish to Payara will be required as part of the move to Dataverse 5. If your installation upgrades to Dataverse 5 without upgrading to Payara, the first step of any troubleshooting will be to suggest an upgrade to Payara.\n          \n          \n            \n            Note that moving from Glassfish to Payara will be required as part of the move to Dataverse 5.\n          \n      \n    \n    \n  \n\nNow that pull request #7064 has been merged, it's not possible to run Dataverse 5 on Glassfish 4 without hacking on your pom.xml file (@mheppler may be able to verify this).\nSo, I would simply remove the line that suggests that it's possible to stay on Glassfish.", "author": "pdurbin", "createdAt": "2020-08-06T19:43:47Z", "path": "doc/release-notes/5.0-release-notes.md", "diffHunk": "@@ -0,0 +1,313 @@\n+# Dataverse 5.0\n+\n+This release brings new features, enhancements, and bug fixes to Dataverse. Thank you to all of the community members who contributed code, suggestions, bug reports, and other assistance across the project.\n+\n+Please note that this is a major release and these are long release notes. We offer no apologies. :)\n+\n+## Release Highlights\n+\n+### Continued Dataset and File Redesign: Dataset and File Button Redesign, Responsive Layout\n+\n+The buttons available on the Dataset and File pages have been redesigned. This change is to provide more scalability for future expanded options for data access and exploration, and to provide a consistent experience between the two pages. The dataset and file pages have also be redesigned to be more responsive and function better across multiple devices.\n+\n+This is an important step in the incremental process of the Dataset and File Redesign, following the release of on-page previews, filtering and sorting options, tree view, and other enhancements. Additional features in support of these redesign efforts will follow in later 5.x releases.\n+\n+### Payara 5\n+\n+A major upgrade of the application server provides security updates, access to new features like MicroProfile Config API, and will enable eagerly anticipated upgrades to other core technologies.\n+\n+Note that moving from Glassfish to Payara will be required as part of the move to Dataverse 5. If your installation upgrades to Dataverse 5 without upgrading to Payara, the first step of any troubleshooting will be to suggest an upgrade to Payara.", "originalCommit": "b7c947a6381a1bef87cead90f7a169798aeb2de6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzAzNzQyMg==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r467037422", "bodyText": "Will remove", "author": "djbrooke", "createdAt": "2020-08-07T13:24:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY0NTQ1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY0NzI5NQ==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r466647295", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The buttons available on the Dataset and File pages have been redesigned. This change is to provide more scalability for future expanded options for data access and exploration, and to provide a consistent experience between the two pages. The dataset and file pages have also be redesigned to be more responsive and function better across multiple devices.\n          \n          \n            \n            The buttons available on the Dataset and File pages have been redesigned. This change is to provide more scalability for future expanded options for data access and exploration, and to provide a consistent experience between the two pages. The dataset and file pages have also been redesigned to be more responsive and function better across multiple devices.", "author": "pdurbin", "createdAt": "2020-08-06T19:47:06Z", "path": "doc/release-notes/5.0-release-notes.md", "diffHunk": "@@ -0,0 +1,313 @@\n+# Dataverse 5.0\n+\n+This release brings new features, enhancements, and bug fixes to Dataverse. Thank you to all of the community members who contributed code, suggestions, bug reports, and other assistance across the project.\n+\n+Please note that this is a major release and these are long release notes. We offer no apologies. :)\n+\n+## Release Highlights\n+\n+### Continued Dataset and File Redesign: Dataset and File Button Redesign, Responsive Layout\n+\n+The buttons available on the Dataset and File pages have been redesigned. This change is to provide more scalability for future expanded options for data access and exploration, and to provide a consistent experience between the two pages. The dataset and file pages have also be redesigned to be more responsive and function better across multiple devices.", "originalCommit": "b7c947a6381a1bef87cead90f7a169798aeb2de6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY0ODU1Mg==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r466648552", "bodyText": "\"Dataset and File Redesign\" as a proper name seems odd to me. Maybe \"the Dataset and File Redesign project\"?", "author": "pdurbin", "createdAt": "2020-08-06T19:49:34Z", "path": "doc/release-notes/5.0-release-notes.md", "diffHunk": "@@ -0,0 +1,313 @@\n+# Dataverse 5.0\n+\n+This release brings new features, enhancements, and bug fixes to Dataverse. Thank you to all of the community members who contributed code, suggestions, bug reports, and other assistance across the project.\n+\n+Please note that this is a major release and these are long release notes. We offer no apologies. :)\n+\n+## Release Highlights\n+\n+### Continued Dataset and File Redesign: Dataset and File Button Redesign, Responsive Layout\n+\n+The buttons available on the Dataset and File pages have been redesigned. This change is to provide more scalability for future expanded options for data access and exploration, and to provide a consistent experience between the two pages. The dataset and file pages have also be redesigned to be more responsive and function better across multiple devices.\n+\n+This is an important step in the incremental process of the Dataset and File Redesign, following the release of on-page previews, filtering and sorting options, tree view, and other enhancements. Additional features in support of these redesign efforts will follow in later 5.x releases.", "originalCommit": "b7c947a6381a1bef87cead90f7a169798aeb2de6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzAzODE4MA==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r467038180", "bodyText": "Yes", "author": "djbrooke", "createdAt": "2020-08-07T13:25:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY0ODU1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY0OTU3OQ==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r466649579", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            A major upgrade of the application server provides security updates, access to new features like MicroProfile Config API, and will enable eagerly anticipated upgrades to other core technologies.\n          \n          \n            \n            A major upgrade of the application server provides security updates, access to new features like MicroProfile Config API, and will enable upgrades to other core technologies.\n          \n      \n    \n    \n  \n\nCurb your enthusiasm. \ud83d\ude04", "author": "pdurbin", "createdAt": "2020-08-06T19:51:22Z", "path": "doc/release-notes/5.0-release-notes.md", "diffHunk": "@@ -0,0 +1,313 @@\n+# Dataverse 5.0\n+\n+This release brings new features, enhancements, and bug fixes to Dataverse. Thank you to all of the community members who contributed code, suggestions, bug reports, and other assistance across the project.\n+\n+Please note that this is a major release and these are long release notes. We offer no apologies. :)\n+\n+## Release Highlights\n+\n+### Continued Dataset and File Redesign: Dataset and File Button Redesign, Responsive Layout\n+\n+The buttons available on the Dataset and File pages have been redesigned. This change is to provide more scalability for future expanded options for data access and exploration, and to provide a consistent experience between the two pages. The dataset and file pages have also be redesigned to be more responsive and function better across multiple devices.\n+\n+This is an important step in the incremental process of the Dataset and File Redesign, following the release of on-page previews, filtering and sorting options, tree view, and other enhancements. Additional features in support of these redesign efforts will follow in later 5.x releases.\n+\n+### Payara 5\n+\n+A major upgrade of the application server provides security updates, access to new features like MicroProfile Config API, and will enable eagerly anticipated upgrades to other core technologies.", "originalCommit": "b7c947a6381a1bef87cead90f7a169798aeb2de6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzAzODUwMg==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r467038502", "bodyText": "I was trying to channel @poikilotherm here!", "author": "djbrooke", "createdAt": "2020-08-07T13:25:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY0OTU3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY1NjA0MQ==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r466656041", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Users can now more easily Download all files in Dataset. If this causes server instability, it's suggested that Dataverse Installation Administrators take advantage of the new Standalone Zipper Service described below.\n          \n          \n            \n            Users can now more easily download all files in Dataset. If this causes server instability, it's suggested that Dataverse Installation Administrators take advantage of the new Standalone Zipper Service described below.\n          \n      \n    \n    \n  \n\nAlso, I wonder if \"Dataverse Installation Administrators\" will grow on me. I guess it's fine. You could probably also say \"you\". Above we say \"your installation\".", "author": "pdurbin", "createdAt": "2020-08-06T20:04:44Z", "path": "doc/release-notes/5.0-release-notes.md", "diffHunk": "@@ -0,0 +1,313 @@\n+# Dataverse 5.0\n+\n+This release brings new features, enhancements, and bug fixes to Dataverse. Thank you to all of the community members who contributed code, suggestions, bug reports, and other assistance across the project.\n+\n+Please note that this is a major release and these are long release notes. We offer no apologies. :)\n+\n+## Release Highlights\n+\n+### Continued Dataset and File Redesign: Dataset and File Button Redesign, Responsive Layout\n+\n+The buttons available on the Dataset and File pages have been redesigned. This change is to provide more scalability for future expanded options for data access and exploration, and to provide a consistent experience between the two pages. The dataset and file pages have also be redesigned to be more responsive and function better across multiple devices.\n+\n+This is an important step in the incremental process of the Dataset and File Redesign, following the release of on-page previews, filtering and sorting options, tree view, and other enhancements. Additional features in support of these redesign efforts will follow in later 5.x releases.\n+\n+### Payara 5\n+\n+A major upgrade of the application server provides security updates, access to new features like MicroProfile Config API, and will enable eagerly anticipated upgrades to other core technologies.\n+\n+Note that moving from Glassfish to Payara will be required as part of the move to Dataverse 5. If your installation upgrades to Dataverse 5 without upgrading to Payara, the first step of any troubleshooting will be to suggest an upgrade to Payara.\n+\n+### Primefaces 8\n+\n+Primefaces, the open source UI framework upon which the Dataverse front end is built, has been updated to the most recent version. This provides security updates and bug fixes and will also allow Dataverse developers to take advantage of new features and enhancements.\n+\n+### Download Dataset\n+\n+Users can now more easily Download all files in Dataset. If this causes server instability, it's suggested that Dataverse Installation Administrators take advantage of the new Standalone Zipper Service described below.", "originalCommit": "b7c947a6381a1bef87cead90f7a169798aeb2de6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY1OTU1Mw==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r466659553", "bodyText": "Wait, how is this \"Download All Option on the Dataset Page\" item different from the \"Download Dataset\" item, just above it? Should they be merged into one? If not, what issue numbers are we talking about?", "author": "pdurbin", "createdAt": "2020-08-06T20:12:10Z", "path": "doc/release-notes/5.0-release-notes.md", "diffHunk": "@@ -0,0 +1,313 @@\n+# Dataverse 5.0\n+\n+This release brings new features, enhancements, and bug fixes to Dataverse. Thank you to all of the community members who contributed code, suggestions, bug reports, and other assistance across the project.\n+\n+Please note that this is a major release and these are long release notes. We offer no apologies. :)\n+\n+## Release Highlights\n+\n+### Continued Dataset and File Redesign: Dataset and File Button Redesign, Responsive Layout\n+\n+The buttons available on the Dataset and File pages have been redesigned. This change is to provide more scalability for future expanded options for data access and exploration, and to provide a consistent experience between the two pages. The dataset and file pages have also be redesigned to be more responsive and function better across multiple devices.\n+\n+This is an important step in the incremental process of the Dataset and File Redesign, following the release of on-page previews, filtering and sorting options, tree view, and other enhancements. Additional features in support of these redesign efforts will follow in later 5.x releases.\n+\n+### Payara 5\n+\n+A major upgrade of the application server provides security updates, access to new features like MicroProfile Config API, and will enable eagerly anticipated upgrades to other core technologies.\n+\n+Note that moving from Glassfish to Payara will be required as part of the move to Dataverse 5. If your installation upgrades to Dataverse 5 without upgrading to Payara, the first step of any troubleshooting will be to suggest an upgrade to Payara.\n+\n+### Primefaces 8\n+\n+Primefaces, the open source UI framework upon which the Dataverse front end is built, has been updated to the most recent version. This provides security updates and bug fixes and will also allow Dataverse developers to take advantage of new features and enhancements.\n+\n+### Download Dataset\n+\n+Users can now more easily Download all files in Dataset. If this causes server instability, it's suggested that Dataverse Installation Administrators take advantage of the new Standalone Zipper Service described below.\n+\n+#### Download All Option on the Dataset Page\n+\n+In previous versions of Dataverse, downloading all files from a dataset meant several clicks to select files and initiate the download. The Dataset Page now includes a Download All option for both the original and archival formats of the files in a dataset under the \"Access Dataset\" button.", "originalCommit": "b7c947a6381a1bef87cead90f7a169798aeb2de6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA0OTUwMg==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r467049502", "bodyText": "\"Download Dataset\" is a higher level heading and is an umbrella for both the Download All through the UI and the Download all through the API. I wanted to get in a plug for the zipper service here as well", "author": "djbrooke", "createdAt": "2020-08-07T13:44:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY1OTU1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA5MjM0Mg==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r467092342", "bodyText": "Ah, umbrella term and a higher level heading. Got it.", "author": "pdurbin", "createdAt": "2020-08-07T14:54:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY1OTU1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY2MTcwMQ==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r466661701", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            - Find all the database id of the files.\n          \n          \n            \n            - Find all the database ids of the files.", "author": "pdurbin", "createdAt": "2020-08-06T20:16:31Z", "path": "doc/release-notes/5.0-release-notes.md", "diffHunk": "@@ -0,0 +1,313 @@\n+# Dataverse 5.0\n+\n+This release brings new features, enhancements, and bug fixes to Dataverse. Thank you to all of the community members who contributed code, suggestions, bug reports, and other assistance across the project.\n+\n+Please note that this is a major release and these are long release notes. We offer no apologies. :)\n+\n+## Release Highlights\n+\n+### Continued Dataset and File Redesign: Dataset and File Button Redesign, Responsive Layout\n+\n+The buttons available on the Dataset and File pages have been redesigned. This change is to provide more scalability for future expanded options for data access and exploration, and to provide a consistent experience between the two pages. The dataset and file pages have also be redesigned to be more responsive and function better across multiple devices.\n+\n+This is an important step in the incremental process of the Dataset and File Redesign, following the release of on-page previews, filtering and sorting options, tree view, and other enhancements. Additional features in support of these redesign efforts will follow in later 5.x releases.\n+\n+### Payara 5\n+\n+A major upgrade of the application server provides security updates, access to new features like MicroProfile Config API, and will enable eagerly anticipated upgrades to other core technologies.\n+\n+Note that moving from Glassfish to Payara will be required as part of the move to Dataverse 5. If your installation upgrades to Dataverse 5 without upgrading to Payara, the first step of any troubleshooting will be to suggest an upgrade to Payara.\n+\n+### Primefaces 8\n+\n+Primefaces, the open source UI framework upon which the Dataverse front end is built, has been updated to the most recent version. This provides security updates and bug fixes and will also allow Dataverse developers to take advantage of new features and enhancements.\n+\n+### Download Dataset\n+\n+Users can now more easily Download all files in Dataset. If this causes server instability, it's suggested that Dataverse Installation Administrators take advantage of the new Standalone Zipper Service described below.\n+\n+#### Download All Option on the Dataset Page\n+\n+In previous versions of Dataverse, downloading all files from a dataset meant several clicks to select files and initiate the download. The Dataset Page now includes a Download All option for both the original and archival formats of the files in a dataset under the \"Access Dataset\" button.\n+\n+#### Download All API\n+\n+In previous versions of Dataverse, downloading all files from a dataset via API was a two step process:\n+\n+- Find all the database id of the files.", "originalCommit": "b7c947a6381a1bef87cead90f7a169798aeb2de6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY2MjE5MA==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r466662190", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Now you can download all files from a dataset (assuming you have access to them) via API by passing the dataset persistent ID (PID such as DOI or Handle) or the dataset's database id. Versions are also supported like with the \"download metadata\" API you can pass :draft, :latest, :latest-published, or numbers (1.1, 2.0).\n          \n          \n            \n            Now you can download all files from a dataset (assuming you have access to them) via API by passing the dataset persistent ID (PID such as DOI or Handle) or the dataset's database id. Versions are also supported and like with the \"download metadata\" API you can pass :draft, :latest, :latest-published, or numbers (1.1, 2.0).", "author": "pdurbin", "createdAt": "2020-08-06T20:17:29Z", "path": "doc/release-notes/5.0-release-notes.md", "diffHunk": "@@ -0,0 +1,313 @@\n+# Dataverse 5.0\n+\n+This release brings new features, enhancements, and bug fixes to Dataverse. Thank you to all of the community members who contributed code, suggestions, bug reports, and other assistance across the project.\n+\n+Please note that this is a major release and these are long release notes. We offer no apologies. :)\n+\n+## Release Highlights\n+\n+### Continued Dataset and File Redesign: Dataset and File Button Redesign, Responsive Layout\n+\n+The buttons available on the Dataset and File pages have been redesigned. This change is to provide more scalability for future expanded options for data access and exploration, and to provide a consistent experience between the two pages. The dataset and file pages have also be redesigned to be more responsive and function better across multiple devices.\n+\n+This is an important step in the incremental process of the Dataset and File Redesign, following the release of on-page previews, filtering and sorting options, tree view, and other enhancements. Additional features in support of these redesign efforts will follow in later 5.x releases.\n+\n+### Payara 5\n+\n+A major upgrade of the application server provides security updates, access to new features like MicroProfile Config API, and will enable eagerly anticipated upgrades to other core technologies.\n+\n+Note that moving from Glassfish to Payara will be required as part of the move to Dataverse 5. If your installation upgrades to Dataverse 5 without upgrading to Payara, the first step of any troubleshooting will be to suggest an upgrade to Payara.\n+\n+### Primefaces 8\n+\n+Primefaces, the open source UI framework upon which the Dataverse front end is built, has been updated to the most recent version. This provides security updates and bug fixes and will also allow Dataverse developers to take advantage of new features and enhancements.\n+\n+### Download Dataset\n+\n+Users can now more easily Download all files in Dataset. If this causes server instability, it's suggested that Dataverse Installation Administrators take advantage of the new Standalone Zipper Service described below.\n+\n+#### Download All Option on the Dataset Page\n+\n+In previous versions of Dataverse, downloading all files from a dataset meant several clicks to select files and initiate the download. The Dataset Page now includes a Download All option for both the original and archival formats of the files in a dataset under the \"Access Dataset\" button.\n+\n+#### Download All API\n+\n+In previous versions of Dataverse, downloading all files from a dataset via API was a two step process:\n+\n+- Find all the database id of the files.\n+- Download all the files, using those ids (comma-separated).\n+\n+Now you can download all files from a dataset (assuming you have access to them) via API by passing the dataset persistent ID (PID such as DOI or Handle) or the dataset's database id. Versions are also supported like with the \"download metadata\" API you can pass :draft, :latest, :latest-published, or numbers (1.1, 2.0).", "originalCommit": "b7c947a6381a1bef87cead90f7a169798aeb2de6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY2NDU3NA==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r466664574", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            #### Download All API\n          \n          \n            \n            #### Download All By Dataset API\n          \n      \n    \n    \n  \n\nI'm not sure what to call it but here's how we document it:", "author": "pdurbin", "createdAt": "2020-08-06T20:22:08Z", "path": "doc/release-notes/5.0-release-notes.md", "diffHunk": "@@ -0,0 +1,313 @@\n+# Dataverse 5.0\n+\n+This release brings new features, enhancements, and bug fixes to Dataverse. Thank you to all of the community members who contributed code, suggestions, bug reports, and other assistance across the project.\n+\n+Please note that this is a major release and these are long release notes. We offer no apologies. :)\n+\n+## Release Highlights\n+\n+### Continued Dataset and File Redesign: Dataset and File Button Redesign, Responsive Layout\n+\n+The buttons available on the Dataset and File pages have been redesigned. This change is to provide more scalability for future expanded options for data access and exploration, and to provide a consistent experience between the two pages. The dataset and file pages have also be redesigned to be more responsive and function better across multiple devices.\n+\n+This is an important step in the incremental process of the Dataset and File Redesign, following the release of on-page previews, filtering and sorting options, tree view, and other enhancements. Additional features in support of these redesign efforts will follow in later 5.x releases.\n+\n+### Payara 5\n+\n+A major upgrade of the application server provides security updates, access to new features like MicroProfile Config API, and will enable eagerly anticipated upgrades to other core technologies.\n+\n+Note that moving from Glassfish to Payara will be required as part of the move to Dataverse 5. If your installation upgrades to Dataverse 5 without upgrading to Payara, the first step of any troubleshooting will be to suggest an upgrade to Payara.\n+\n+### Primefaces 8\n+\n+Primefaces, the open source UI framework upon which the Dataverse front end is built, has been updated to the most recent version. This provides security updates and bug fixes and will also allow Dataverse developers to take advantage of new features and enhancements.\n+\n+### Download Dataset\n+\n+Users can now more easily Download all files in Dataset. If this causes server instability, it's suggested that Dataverse Installation Administrators take advantage of the new Standalone Zipper Service described below.\n+\n+#### Download All Option on the Dataset Page\n+\n+In previous versions of Dataverse, downloading all files from a dataset meant several clicks to select files and initiate the download. The Dataset Page now includes a Download All option for both the original and archival formats of the files in a dataset under the \"Access Dataset\" button.\n+\n+#### Download All API", "originalCommit": "b7c947a6381a1bef87cead90f7a169798aeb2de6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY2NzI5MA==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r466667290", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            XXXXX\n          \n          \n            \n            \n          \n          \n            \n            (my plan is to build the executable and to add it to the v5\n          \n          \n            \n            release files on github: - L.A.)\n          \n          \n            \n            <https://github.com/IQSS/dataverse/releases/download/v5.0/zipper.zip>.\n          \n          \n            \n            <https://github.com/IQSS/dataverse/releases/download/v5.0/zipper.zip>\n          \n      \n    \n    \n  \n\nLet's not forget to actually do this. \ud83d\ude04", "author": "pdurbin", "createdAt": "2020-08-06T20:27:39Z", "path": "doc/release-notes/5.0-release-notes.md", "diffHunk": "@@ -0,0 +1,313 @@\n+# Dataverse 5.0\n+\n+This release brings new features, enhancements, and bug fixes to Dataverse. Thank you to all of the community members who contributed code, suggestions, bug reports, and other assistance across the project.\n+\n+Please note that this is a major release and these are long release notes. We offer no apologies. :)\n+\n+## Release Highlights\n+\n+### Continued Dataset and File Redesign: Dataset and File Button Redesign, Responsive Layout\n+\n+The buttons available on the Dataset and File pages have been redesigned. This change is to provide more scalability for future expanded options for data access and exploration, and to provide a consistent experience between the two pages. The dataset and file pages have also be redesigned to be more responsive and function better across multiple devices.\n+\n+This is an important step in the incremental process of the Dataset and File Redesign, following the release of on-page previews, filtering and sorting options, tree view, and other enhancements. Additional features in support of these redesign efforts will follow in later 5.x releases.\n+\n+### Payara 5\n+\n+A major upgrade of the application server provides security updates, access to new features like MicroProfile Config API, and will enable eagerly anticipated upgrades to other core technologies.\n+\n+Note that moving from Glassfish to Payara will be required as part of the move to Dataverse 5. If your installation upgrades to Dataverse 5 without upgrading to Payara, the first step of any troubleshooting will be to suggest an upgrade to Payara.\n+\n+### Primefaces 8\n+\n+Primefaces, the open source UI framework upon which the Dataverse front end is built, has been updated to the most recent version. This provides security updates and bug fixes and will also allow Dataverse developers to take advantage of new features and enhancements.\n+\n+### Download Dataset\n+\n+Users can now more easily Download all files in Dataset. If this causes server instability, it's suggested that Dataverse Installation Administrators take advantage of the new Standalone Zipper Service described below.\n+\n+#### Download All Option on the Dataset Page\n+\n+In previous versions of Dataverse, downloading all files from a dataset meant several clicks to select files and initiate the download. The Dataset Page now includes a Download All option for both the original and archival formats of the files in a dataset under the \"Access Dataset\" button.\n+\n+#### Download All API\n+\n+In previous versions of Dataverse, downloading all files from a dataset via API was a two step process:\n+\n+- Find all the database id of the files.\n+- Download all the files, using those ids (comma-separated).\n+\n+Now you can download all files from a dataset (assuming you have access to them) via API by passing the dataset persistent ID (PID such as DOI or Handle) or the dataset's database id. Versions are also supported like with the \"download metadata\" API you can pass :draft, :latest, :latest-published, or numbers (1.1, 2.0).\n+\n+### A Multi-File, Zipped Download Optimization\n+\n+In this release we are offering an experimental optimization for the multi-file, download-as-zip functionality. If this option is enabled, instead of enforcing size limits, we attempt to serve all the files that the user requested (that they are authorized to download), but the request is redirected to a standalone zipper service running as a cgi executable. Thus moving these potentially long-running jobs completely outside the Application Server (Payara); and preventing service threads from becoming locked serving them. Since zipping is also a CPU-intensive task, it is possible to have this service running on a different host system, thus freeing the cycles on the main Application Server. The system running the service needs to have access to the database as well as to the storage filesystem, and/or S3 bucket.\n+\n+Please consult the scripts/zipdownload/README.md in the Dataverse 5 source tree.\n+\n+The components of the standalone \"zipper tool\" can also be downloaded\n+here:\n+\n+XXXXX\n+\n+(my plan is to build the executable and to add it to the v5\n+release files on github: - L.A.)\n+<https://github.com/IQSS/dataverse/releases/download/v5.0/zipper.zip>.", "originalCommit": "b7c947a6381a1bef87cead90f7a169798aeb2de6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY3NTk4MQ==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r466675981", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Dataverse Installations using DataCite will have DOIs reserved as \"Draft\" with DataCite when the Dataset is created, instead of the reservation taking place locally at create time and the reservation taking place with DataCite at publish time. This allows the DOI to reserved earlier in the publication process.\n          \n          \n            \n            Dataverse installations using DataCite will have DOIs reserved as \"draft\" with DataCite when the Dataset is created, instead of the reservation (and publication, the switch to \"findable\") taking place with DataCite at publish time. This allows the DOI to be reserved earlier in the publication process.", "author": "pdurbin", "createdAt": "2020-08-06T20:45:08Z", "path": "doc/release-notes/5.0-release-notes.md", "diffHunk": "@@ -0,0 +1,313 @@\n+# Dataverse 5.0\n+\n+This release brings new features, enhancements, and bug fixes to Dataverse. Thank you to all of the community members who contributed code, suggestions, bug reports, and other assistance across the project.\n+\n+Please note that this is a major release and these are long release notes. We offer no apologies. :)\n+\n+## Release Highlights\n+\n+### Continued Dataset and File Redesign: Dataset and File Button Redesign, Responsive Layout\n+\n+The buttons available on the Dataset and File pages have been redesigned. This change is to provide more scalability for future expanded options for data access and exploration, and to provide a consistent experience between the two pages. The dataset and file pages have also be redesigned to be more responsive and function better across multiple devices.\n+\n+This is an important step in the incremental process of the Dataset and File Redesign, following the release of on-page previews, filtering and sorting options, tree view, and other enhancements. Additional features in support of these redesign efforts will follow in later 5.x releases.\n+\n+### Payara 5\n+\n+A major upgrade of the application server provides security updates, access to new features like MicroProfile Config API, and will enable eagerly anticipated upgrades to other core technologies.\n+\n+Note that moving from Glassfish to Payara will be required as part of the move to Dataverse 5. If your installation upgrades to Dataverse 5 without upgrading to Payara, the first step of any troubleshooting will be to suggest an upgrade to Payara.\n+\n+### Primefaces 8\n+\n+Primefaces, the open source UI framework upon which the Dataverse front end is built, has been updated to the most recent version. This provides security updates and bug fixes and will also allow Dataverse developers to take advantage of new features and enhancements.\n+\n+### Download Dataset\n+\n+Users can now more easily Download all files in Dataset. If this causes server instability, it's suggested that Dataverse Installation Administrators take advantage of the new Standalone Zipper Service described below.\n+\n+#### Download All Option on the Dataset Page\n+\n+In previous versions of Dataverse, downloading all files from a dataset meant several clicks to select files and initiate the download. The Dataset Page now includes a Download All option for both the original and archival formats of the files in a dataset under the \"Access Dataset\" button.\n+\n+#### Download All API\n+\n+In previous versions of Dataverse, downloading all files from a dataset via API was a two step process:\n+\n+- Find all the database id of the files.\n+- Download all the files, using those ids (comma-separated).\n+\n+Now you can download all files from a dataset (assuming you have access to them) via API by passing the dataset persistent ID (PID such as DOI or Handle) or the dataset's database id. Versions are also supported like with the \"download metadata\" API you can pass :draft, :latest, :latest-published, or numbers (1.1, 2.0).\n+\n+### A Multi-File, Zipped Download Optimization\n+\n+In this release we are offering an experimental optimization for the multi-file, download-as-zip functionality. If this option is enabled, instead of enforcing size limits, we attempt to serve all the files that the user requested (that they are authorized to download), but the request is redirected to a standalone zipper service running as a cgi executable. Thus moving these potentially long-running jobs completely outside the Application Server (Payara); and preventing service threads from becoming locked serving them. Since zipping is also a CPU-intensive task, it is possible to have this service running on a different host system, thus freeing the cycles on the main Application Server. The system running the service needs to have access to the database as well as to the storage filesystem, and/or S3 bucket.\n+\n+Please consult the scripts/zipdownload/README.md in the Dataverse 5 source tree.\n+\n+The components of the standalone \"zipper tool\" can also be downloaded\n+here:\n+\n+XXXXX\n+\n+(my plan is to build the executable and to add it to the v5\n+release files on github: - L.A.)\n+<https://github.com/IQSS/dataverse/releases/download/v5.0/zipper.zip>.\n+\n+### Updated File Handling\n+\n+Files without extensions can now be uploaded through the UI. This release also changes the way Dataverse handles duplicate (filename or checksum) files in a dataset. Specifically:\n+\n+- Files with the same checksum can be included in a dataset, even if the files are in the same directory.\n+- Files with the same filename can be included in a dataset as long as the files are in different directories.\n+- If a user uploads a file to a directory where a file already exists with that directory/filename combination, Dataverse will adjust the file path and names by adding \"-1\" or \"-2\" as applicable. This change will be visible in the list of files being uploaded.\n+- If the directory or name of an existing or newly uploaded file is edited in such a way that would create a directory/filename combination that already exists, Dataverse will display an error.\n+- If a user attempts to replace a file with another file that has the same checksum, an error message will be displayed and the file will not be able to be replaced.\n+- If a user attempts to replace a file with a file that has the same checksum as a different file in the dataset, a warning will be displayed.\n+- Files without extensions can now be uploaded through the UI.\n+\n+### Pre-Publish DOI Reservation with DataCite\n+\n+Dataverse Installations using DataCite will have DOIs reserved as \"Draft\" with DataCite when the Dataset is created, instead of the reservation taking place locally at create time and the reservation taking place with DataCite at publish time. This allows the DOI to reserved earlier in the publication process.", "originalCommit": "b7c947a6381a1bef87cead90f7a169798aeb2de6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY3NzI4OA==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r466677288", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            - Users will be able to download a dataset with a single API call. (Issue #4529, PR #7086)\n          \n          \n            \n            - Users will be able to download all files in a dataset with a single API call. (Issue #4529, PR #7086)", "author": "pdurbin", "createdAt": "2020-08-06T20:47:48Z", "path": "doc/release-notes/5.0-release-notes.md", "diffHunk": "@@ -0,0 +1,313 @@\n+# Dataverse 5.0\n+\n+This release brings new features, enhancements, and bug fixes to Dataverse. Thank you to all of the community members who contributed code, suggestions, bug reports, and other assistance across the project.\n+\n+Please note that this is a major release and these are long release notes. We offer no apologies. :)\n+\n+## Release Highlights\n+\n+### Continued Dataset and File Redesign: Dataset and File Button Redesign, Responsive Layout\n+\n+The buttons available on the Dataset and File pages have been redesigned. This change is to provide more scalability for future expanded options for data access and exploration, and to provide a consistent experience between the two pages. The dataset and file pages have also be redesigned to be more responsive and function better across multiple devices.\n+\n+This is an important step in the incremental process of the Dataset and File Redesign, following the release of on-page previews, filtering and sorting options, tree view, and other enhancements. Additional features in support of these redesign efforts will follow in later 5.x releases.\n+\n+### Payara 5\n+\n+A major upgrade of the application server provides security updates, access to new features like MicroProfile Config API, and will enable eagerly anticipated upgrades to other core technologies.\n+\n+Note that moving from Glassfish to Payara will be required as part of the move to Dataverse 5. If your installation upgrades to Dataverse 5 without upgrading to Payara, the first step of any troubleshooting will be to suggest an upgrade to Payara.\n+\n+### Primefaces 8\n+\n+Primefaces, the open source UI framework upon which the Dataverse front end is built, has been updated to the most recent version. This provides security updates and bug fixes and will also allow Dataverse developers to take advantage of new features and enhancements.\n+\n+### Download Dataset\n+\n+Users can now more easily Download all files in Dataset. If this causes server instability, it's suggested that Dataverse Installation Administrators take advantage of the new Standalone Zipper Service described below.\n+\n+#### Download All Option on the Dataset Page\n+\n+In previous versions of Dataverse, downloading all files from a dataset meant several clicks to select files and initiate the download. The Dataset Page now includes a Download All option for both the original and archival formats of the files in a dataset under the \"Access Dataset\" button.\n+\n+#### Download All API\n+\n+In previous versions of Dataverse, downloading all files from a dataset via API was a two step process:\n+\n+- Find all the database id of the files.\n+- Download all the files, using those ids (comma-separated).\n+\n+Now you can download all files from a dataset (assuming you have access to them) via API by passing the dataset persistent ID (PID such as DOI or Handle) or the dataset's database id. Versions are also supported like with the \"download metadata\" API you can pass :draft, :latest, :latest-published, or numbers (1.1, 2.0).\n+\n+### A Multi-File, Zipped Download Optimization\n+\n+In this release we are offering an experimental optimization for the multi-file, download-as-zip functionality. If this option is enabled, instead of enforcing size limits, we attempt to serve all the files that the user requested (that they are authorized to download), but the request is redirected to a standalone zipper service running as a cgi executable. Thus moving these potentially long-running jobs completely outside the Application Server (Payara); and preventing service threads from becoming locked serving them. Since zipping is also a CPU-intensive task, it is possible to have this service running on a different host system, thus freeing the cycles on the main Application Server. The system running the service needs to have access to the database as well as to the storage filesystem, and/or S3 bucket.\n+\n+Please consult the scripts/zipdownload/README.md in the Dataverse 5 source tree.\n+\n+The components of the standalone \"zipper tool\" can also be downloaded\n+here:\n+\n+XXXXX\n+\n+(my plan is to build the executable and to add it to the v5\n+release files on github: - L.A.)\n+<https://github.com/IQSS/dataverse/releases/download/v5.0/zipper.zip>.\n+\n+### Updated File Handling\n+\n+Files without extensions can now be uploaded through the UI. This release also changes the way Dataverse handles duplicate (filename or checksum) files in a dataset. Specifically:\n+\n+- Files with the same checksum can be included in a dataset, even if the files are in the same directory.\n+- Files with the same filename can be included in a dataset as long as the files are in different directories.\n+- If a user uploads a file to a directory where a file already exists with that directory/filename combination, Dataverse will adjust the file path and names by adding \"-1\" or \"-2\" as applicable. This change will be visible in the list of files being uploaded.\n+- If the directory or name of an existing or newly uploaded file is edited in such a way that would create a directory/filename combination that already exists, Dataverse will display an error.\n+- If a user attempts to replace a file with another file that has the same checksum, an error message will be displayed and the file will not be able to be replaced.\n+- If a user attempts to replace a file with a file that has the same checksum as a different file in the dataset, a warning will be displayed.\n+- Files without extensions can now be uploaded through the UI.\n+\n+### Pre-Publish DOI Reservation with DataCite\n+\n+Dataverse Installations using DataCite will have DOIs reserved as \"Draft\" with DataCite when the Dataset is created, instead of the reservation taking place locally at create time and the reservation taking place with DataCite at publish time. This allows the DOI to reserved earlier in the publication process.\n+\n+## Major Use Cases\n+\n+Newly-supported use cases in this release include:\n+\n+- Users will be presented with a new workflow around dataset and file access and exploration. (Issue #6684, PR #6909)\n+- Users will experience a UI appropriate across a variety of device sizes. (Issue #6684, PR #6909)\n+- Users will be able to download an entire dataset without needing to select all the files in that dataset. (Issue #6564, PR #6262)\n+- Users will be able to download a dataset with a single API call. (Issue #4529, PR #7086)", "originalCommit": "b7c947a6381a1bef87cead90f7a169798aeb2de6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4MTM3Mg==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r466681372", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            For datasets with large numbers of files, this validation will be performed asynchronously, using the same mechanism as for the registration of the file-level global ids. The cutoff number of files is configured by the same database setting. Similarly to the file PID registration, this validation process can be disabled on your system, with the setting `:FileValidationOnPublishEnabled`. (A Dataverse admin may choose to disable it if, for example, they are already running an external auditing system to monitor the integrity of the files in their Dataverse, and would prefer the publishing process to take less time). See the Config section of the Installation guide for more info.\n          \n          \n            \n            For datasets with large numbers of files, this validation will be performed asynchronously, using the same mechanism as for the registration of the file-level persistent ids. The cutoff number of files is configured by the same database setting. Similarly to the file PID registration, this validation process can be disabled on your system, with the setting `:FileValidationOnPublishEnabled`. (A Dataverse admin may choose to disable it if, for example, they are already running an external auditing system to monitor the integrity of the files in their Dataverse, and would prefer the publishing process to take less time). See the Config section of the Installation guide for more info.", "author": "pdurbin", "createdAt": "2020-08-06T20:55:56Z", "path": "doc/release-notes/5.0-release-notes.md", "diffHunk": "@@ -0,0 +1,313 @@\n+# Dataverse 5.0\n+\n+This release brings new features, enhancements, and bug fixes to Dataverse. Thank you to all of the community members who contributed code, suggestions, bug reports, and other assistance across the project.\n+\n+Please note that this is a major release and these are long release notes. We offer no apologies. :)\n+\n+## Release Highlights\n+\n+### Continued Dataset and File Redesign: Dataset and File Button Redesign, Responsive Layout\n+\n+The buttons available on the Dataset and File pages have been redesigned. This change is to provide more scalability for future expanded options for data access and exploration, and to provide a consistent experience between the two pages. The dataset and file pages have also be redesigned to be more responsive and function better across multiple devices.\n+\n+This is an important step in the incremental process of the Dataset and File Redesign, following the release of on-page previews, filtering and sorting options, tree view, and other enhancements. Additional features in support of these redesign efforts will follow in later 5.x releases.\n+\n+### Payara 5\n+\n+A major upgrade of the application server provides security updates, access to new features like MicroProfile Config API, and will enable eagerly anticipated upgrades to other core technologies.\n+\n+Note that moving from Glassfish to Payara will be required as part of the move to Dataverse 5. If your installation upgrades to Dataverse 5 without upgrading to Payara, the first step of any troubleshooting will be to suggest an upgrade to Payara.\n+\n+### Primefaces 8\n+\n+Primefaces, the open source UI framework upon which the Dataverse front end is built, has been updated to the most recent version. This provides security updates and bug fixes and will also allow Dataverse developers to take advantage of new features and enhancements.\n+\n+### Download Dataset\n+\n+Users can now more easily Download all files in Dataset. If this causes server instability, it's suggested that Dataverse Installation Administrators take advantage of the new Standalone Zipper Service described below.\n+\n+#### Download All Option on the Dataset Page\n+\n+In previous versions of Dataverse, downloading all files from a dataset meant several clicks to select files and initiate the download. The Dataset Page now includes a Download All option for both the original and archival formats of the files in a dataset under the \"Access Dataset\" button.\n+\n+#### Download All API\n+\n+In previous versions of Dataverse, downloading all files from a dataset via API was a two step process:\n+\n+- Find all the database id of the files.\n+- Download all the files, using those ids (comma-separated).\n+\n+Now you can download all files from a dataset (assuming you have access to them) via API by passing the dataset persistent ID (PID such as DOI or Handle) or the dataset's database id. Versions are also supported like with the \"download metadata\" API you can pass :draft, :latest, :latest-published, or numbers (1.1, 2.0).\n+\n+### A Multi-File, Zipped Download Optimization\n+\n+In this release we are offering an experimental optimization for the multi-file, download-as-zip functionality. If this option is enabled, instead of enforcing size limits, we attempt to serve all the files that the user requested (that they are authorized to download), but the request is redirected to a standalone zipper service running as a cgi executable. Thus moving these potentially long-running jobs completely outside the Application Server (Payara); and preventing service threads from becoming locked serving them. Since zipping is also a CPU-intensive task, it is possible to have this service running on a different host system, thus freeing the cycles on the main Application Server. The system running the service needs to have access to the database as well as to the storage filesystem, and/or S3 bucket.\n+\n+Please consult the scripts/zipdownload/README.md in the Dataverse 5 source tree.\n+\n+The components of the standalone \"zipper tool\" can also be downloaded\n+here:\n+\n+XXXXX\n+\n+(my plan is to build the executable and to add it to the v5\n+release files on github: - L.A.)\n+<https://github.com/IQSS/dataverse/releases/download/v5.0/zipper.zip>.\n+\n+### Updated File Handling\n+\n+Files without extensions can now be uploaded through the UI. This release also changes the way Dataverse handles duplicate (filename or checksum) files in a dataset. Specifically:\n+\n+- Files with the same checksum can be included in a dataset, even if the files are in the same directory.\n+- Files with the same filename can be included in a dataset as long as the files are in different directories.\n+- If a user uploads a file to a directory where a file already exists with that directory/filename combination, Dataverse will adjust the file path and names by adding \"-1\" or \"-2\" as applicable. This change will be visible in the list of files being uploaded.\n+- If the directory or name of an existing or newly uploaded file is edited in such a way that would create a directory/filename combination that already exists, Dataverse will display an error.\n+- If a user attempts to replace a file with another file that has the same checksum, an error message will be displayed and the file will not be able to be replaced.\n+- If a user attempts to replace a file with a file that has the same checksum as a different file in the dataset, a warning will be displayed.\n+- Files without extensions can now be uploaded through the UI.\n+\n+### Pre-Publish DOI Reservation with DataCite\n+\n+Dataverse Installations using DataCite will have DOIs reserved as \"Draft\" with DataCite when the Dataset is created, instead of the reservation taking place locally at create time and the reservation taking place with DataCite at publish time. This allows the DOI to reserved earlier in the publication process.\n+\n+## Major Use Cases\n+\n+Newly-supported use cases in this release include:\n+\n+- Users will be presented with a new workflow around dataset and file access and exploration. (Issue #6684, PR #6909)\n+- Users will experience a UI appropriate across a variety of device sizes. (Issue #6684, PR #6909)\n+- Users will be able to download an entire dataset without needing to select all the files in that dataset. (Issue #6564, PR #6262)\n+- Users will be able to download a dataset with a single API call. (Issue #4529, PR #7086)\n+- Users will have DOIs reserved for their datasets upon dataset create instead of at publish time. (Issue #5093, PR #6901)\n+- Users will be able to upload files without extensions. (Issue #6634, PR #6804)\n+- Users will be able to upload files with the same name in a dataset, as long as a those files are in different file paths. (Issue #4813, PR #6924)\n+- Users will be able to upload files with the same checksum in a dataset. (Issue #4813, PR #6924)\n+- Users will be less likely to encounter locks during the publishing process due to PID providers being unavailable. (Issue #6918, PR #7118)\n+- Users will now have their files validated during publish, and in the unlikely event that anything has happened to the files between deposit and publish, they will be able to take corrective action. (Issue #6558, PR #6790)\n+- Administrators will likely see more success with Harvesting, as many minor harvesting issues have been resolved. (Issues #7127, #7128, #4597, #7056, #7052, #7023, #7009, and #7003)\n+- Administrators can now enable an external zip service that frees up application server resources and allows the zip download limit to be increased. (Issue #6505, PR #6986)\n+- Administrators can now create groups based on users' email domains. (Issue #6936, PR #6974)\n+- Administrators can now set date facets to be organized chronologically. (Issue #4977, PR #6958)\n+- Administrators can now link harvested datasets using an API. (Issue #5886, PR #6935)\n+- Administrators can now destroy datasets with mapped shapefiles. (Issue #4093, PR #6860)\n+\n+## Notes for Dataverse Installation Administrators\n+\n+### Glassfish to Payara\n+\n+This upgrade requires a few extra steps. See the detailed upgrade instructions below.\n+\n+### Dataverse Installations Using DataCite: Upgrade Action Recommended\n+\n+For installations that are using DataCite, Dataverse v5.0 introduces a change in the process of registering the Persistent Identifier (DOI) for a dataset. Instead of registering it when the dataset is published for the first time, Dataverse will try to \"reserve\" the DOI when it's created (by registering it as a \"draft\", using DataCite terminology). When the user publishes the dataset, the DOI will be publicized as well (by switching the registration status to \"findable\"). This approach makes the process of publishing datasets simpler and less error-prone.\n+\n+New APIs have been provided for finding any unreserved DataCite-issued DOIs in your Dataverse, and for reserving them (see below). While not required - the user can still attempt to publish a dataset with an unreserved DOI - having all the identifiers reserved ahead of time is recommended. If you are upgrading an installation that uses DataCite, we specifically recommend that you reserve the DOIs for all your pre-existing unpublished drafts as soon as Dataverse v5.0 is deployed, since none of them were registered at create time. This can be done using the following API calls:  \n+\n+- `/api/pids/unreserved`  will report the ids of the datasets\n+- `/api/pids/:persistentId/reserve` reserves the assigned DOI with DataCite (will need to be run on every id reported by the the first API).\n+\n+See the [Native API Guide](http://guides.dataverse.org/en/5.0/api/native-api.html) for more information.\n+\n+Scripted, the whole process would look as follows (adjust as needed):\n+\n+```\n+   API_TOKEN='xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'\n+\n+   curl -s -H \"X-Dataverse-key:$API_TOKEN\" http://localhost:8080/api/pids/unreserved |\n+   # the API outputs JSON; note the use of jq to parse it:\n+   jq '.data.count[].pid' | tr -d '\"' | \n+   while read doi\n+   do\n+      curl -s -H \"X-Dataverse-key:$API_TOKEN\" -X POST http://localhost:8080/api/pids/:persistentId/reserve?persistentId=$doi\n+   done\n+```\n+\n+Going forward, once all the DOIs have been reserved for the legacy drafts, you may still get an occasional dataset with an unreserved identifier. DataCite service instability would be a potential cause. There is no reason to expect that to happen often, but it is not impossible. You may consider running the script above (perhaps with some extra diagnostics added) regularly, from a cron job or otherwise, to address this preemptively.\n+\n+### Datafiles Validation when Publishing Datasets\n+\n+When a user requests to publish a dataset, Dataverse will now attempt to validate the physical files in the dataset, by recalculating the checksums and verifying them against the values in the database. The goal is to prevent any corrupted files in published datasets. Most of all the instances of actual damage to physical files that we've seen in the past happened while the datafiles were still in the Draft state. (Physical files become essentially read-only once published). So this is the logical place to catch any such issues.\n+\n+If any files in the dataset fail the validation, the dataset does not get published, and the user is notified that they need to contact their Dataverse support in order to address the issue before another attempt to publish can be made. See the \"Troubleshooting\" section of the Guide on how to fix such problems.\n+\n+For datasets with large numbers of files, this validation will be performed asynchronously, using the same mechanism as for the registration of the file-level global ids. The cutoff number of files is configured by the same database setting. Similarly to the file PID registration, this validation process can be disabled on your system, with the setting `:FileValidationOnPublishEnabled`. (A Dataverse admin may choose to disable it if, for example, they are already running an external auditing system to monitor the integrity of the files in their Dataverse, and would prefer the publishing process to take less time). See the Config section of the Installation guide for more info.", "originalCommit": "b7c947a6381a1bef87cead90f7a169798aeb2de6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4MjI3NQ==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r466682275", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Please note that we are not aware of any bugs in the current versions of Dataverse that would result in damage to users' files. But you may have some legacy files in your archive that were affected by some issue in the past, or perhaps affected by something outside Dataverse, so we are adding this feature out of abundance of caution. An example of a problem we've experienced in the early versions of Dataverse was a possible scenario where a user actually attempted to delete a Draft file from an unpublished version, where the database transaction would fail for whatever reason, but only after the physical file had already been deleted from the filesystem. Thus resulting in a datafile entry remaining in the dataset, but with the corresponding physical file missing. (the fix for this case, since the user wanted to delete the file in the first place, is simply to confirm it and purge the datafile entity from the database).\n          \n          \n            \n            Please note that we are not aware of any bugs in the current versions of Dataverse that would result in damage to users' files. But you may have some legacy files in your archive that were affected by some issue in the past, or perhaps affected by something outside Dataverse, so we are adding this feature out of abundance of caution. An example of a problem we've experienced in the early versions of Dataverse was a possible scenario where a user actually attempted to delete a Draft file from an unpublished version, where the database transaction would fail for whatever reason, but only after the physical file had already been deleted from the filesystem. Thus resulting in a datafile entry remaining in the dataset, but with the corresponding physical file missing. (The fix for this case, since the user wanted to delete the file in the first place, is simply to confirm it and purge the datafile entity from the database).", "author": "pdurbin", "createdAt": "2020-08-06T20:57:50Z", "path": "doc/release-notes/5.0-release-notes.md", "diffHunk": "@@ -0,0 +1,313 @@\n+# Dataverse 5.0\n+\n+This release brings new features, enhancements, and bug fixes to Dataverse. Thank you to all of the community members who contributed code, suggestions, bug reports, and other assistance across the project.\n+\n+Please note that this is a major release and these are long release notes. We offer no apologies. :)\n+\n+## Release Highlights\n+\n+### Continued Dataset and File Redesign: Dataset and File Button Redesign, Responsive Layout\n+\n+The buttons available on the Dataset and File pages have been redesigned. This change is to provide more scalability for future expanded options for data access and exploration, and to provide a consistent experience between the two pages. The dataset and file pages have also be redesigned to be more responsive and function better across multiple devices.\n+\n+This is an important step in the incremental process of the Dataset and File Redesign, following the release of on-page previews, filtering and sorting options, tree view, and other enhancements. Additional features in support of these redesign efforts will follow in later 5.x releases.\n+\n+### Payara 5\n+\n+A major upgrade of the application server provides security updates, access to new features like MicroProfile Config API, and will enable eagerly anticipated upgrades to other core technologies.\n+\n+Note that moving from Glassfish to Payara will be required as part of the move to Dataverse 5. If your installation upgrades to Dataverse 5 without upgrading to Payara, the first step of any troubleshooting will be to suggest an upgrade to Payara.\n+\n+### Primefaces 8\n+\n+Primefaces, the open source UI framework upon which the Dataverse front end is built, has been updated to the most recent version. This provides security updates and bug fixes and will also allow Dataverse developers to take advantage of new features and enhancements.\n+\n+### Download Dataset\n+\n+Users can now more easily Download all files in Dataset. If this causes server instability, it's suggested that Dataverse Installation Administrators take advantage of the new Standalone Zipper Service described below.\n+\n+#### Download All Option on the Dataset Page\n+\n+In previous versions of Dataverse, downloading all files from a dataset meant several clicks to select files and initiate the download. The Dataset Page now includes a Download All option for both the original and archival formats of the files in a dataset under the \"Access Dataset\" button.\n+\n+#### Download All API\n+\n+In previous versions of Dataverse, downloading all files from a dataset via API was a two step process:\n+\n+- Find all the database id of the files.\n+- Download all the files, using those ids (comma-separated).\n+\n+Now you can download all files from a dataset (assuming you have access to them) via API by passing the dataset persistent ID (PID such as DOI or Handle) or the dataset's database id. Versions are also supported like with the \"download metadata\" API you can pass :draft, :latest, :latest-published, or numbers (1.1, 2.0).\n+\n+### A Multi-File, Zipped Download Optimization\n+\n+In this release we are offering an experimental optimization for the multi-file, download-as-zip functionality. If this option is enabled, instead of enforcing size limits, we attempt to serve all the files that the user requested (that they are authorized to download), but the request is redirected to a standalone zipper service running as a cgi executable. Thus moving these potentially long-running jobs completely outside the Application Server (Payara); and preventing service threads from becoming locked serving them. Since zipping is also a CPU-intensive task, it is possible to have this service running on a different host system, thus freeing the cycles on the main Application Server. The system running the service needs to have access to the database as well as to the storage filesystem, and/or S3 bucket.\n+\n+Please consult the scripts/zipdownload/README.md in the Dataverse 5 source tree.\n+\n+The components of the standalone \"zipper tool\" can also be downloaded\n+here:\n+\n+XXXXX\n+\n+(my plan is to build the executable and to add it to the v5\n+release files on github: - L.A.)\n+<https://github.com/IQSS/dataverse/releases/download/v5.0/zipper.zip>.\n+\n+### Updated File Handling\n+\n+Files without extensions can now be uploaded through the UI. This release also changes the way Dataverse handles duplicate (filename or checksum) files in a dataset. Specifically:\n+\n+- Files with the same checksum can be included in a dataset, even if the files are in the same directory.\n+- Files with the same filename can be included in a dataset as long as the files are in different directories.\n+- If a user uploads a file to a directory where a file already exists with that directory/filename combination, Dataverse will adjust the file path and names by adding \"-1\" or \"-2\" as applicable. This change will be visible in the list of files being uploaded.\n+- If the directory or name of an existing or newly uploaded file is edited in such a way that would create a directory/filename combination that already exists, Dataverse will display an error.\n+- If a user attempts to replace a file with another file that has the same checksum, an error message will be displayed and the file will not be able to be replaced.\n+- If a user attempts to replace a file with a file that has the same checksum as a different file in the dataset, a warning will be displayed.\n+- Files without extensions can now be uploaded through the UI.\n+\n+### Pre-Publish DOI Reservation with DataCite\n+\n+Dataverse Installations using DataCite will have DOIs reserved as \"Draft\" with DataCite when the Dataset is created, instead of the reservation taking place locally at create time and the reservation taking place with DataCite at publish time. This allows the DOI to reserved earlier in the publication process.\n+\n+## Major Use Cases\n+\n+Newly-supported use cases in this release include:\n+\n+- Users will be presented with a new workflow around dataset and file access and exploration. (Issue #6684, PR #6909)\n+- Users will experience a UI appropriate across a variety of device sizes. (Issue #6684, PR #6909)\n+- Users will be able to download an entire dataset without needing to select all the files in that dataset. (Issue #6564, PR #6262)\n+- Users will be able to download a dataset with a single API call. (Issue #4529, PR #7086)\n+- Users will have DOIs reserved for their datasets upon dataset create instead of at publish time. (Issue #5093, PR #6901)\n+- Users will be able to upload files without extensions. (Issue #6634, PR #6804)\n+- Users will be able to upload files with the same name in a dataset, as long as a those files are in different file paths. (Issue #4813, PR #6924)\n+- Users will be able to upload files with the same checksum in a dataset. (Issue #4813, PR #6924)\n+- Users will be less likely to encounter locks during the publishing process due to PID providers being unavailable. (Issue #6918, PR #7118)\n+- Users will now have their files validated during publish, and in the unlikely event that anything has happened to the files between deposit and publish, they will be able to take corrective action. (Issue #6558, PR #6790)\n+- Administrators will likely see more success with Harvesting, as many minor harvesting issues have been resolved. (Issues #7127, #7128, #4597, #7056, #7052, #7023, #7009, and #7003)\n+- Administrators can now enable an external zip service that frees up application server resources and allows the zip download limit to be increased. (Issue #6505, PR #6986)\n+- Administrators can now create groups based on users' email domains. (Issue #6936, PR #6974)\n+- Administrators can now set date facets to be organized chronologically. (Issue #4977, PR #6958)\n+- Administrators can now link harvested datasets using an API. (Issue #5886, PR #6935)\n+- Administrators can now destroy datasets with mapped shapefiles. (Issue #4093, PR #6860)\n+\n+## Notes for Dataverse Installation Administrators\n+\n+### Glassfish to Payara\n+\n+This upgrade requires a few extra steps. See the detailed upgrade instructions below.\n+\n+### Dataverse Installations Using DataCite: Upgrade Action Recommended\n+\n+For installations that are using DataCite, Dataverse v5.0 introduces a change in the process of registering the Persistent Identifier (DOI) for a dataset. Instead of registering it when the dataset is published for the first time, Dataverse will try to \"reserve\" the DOI when it's created (by registering it as a \"draft\", using DataCite terminology). When the user publishes the dataset, the DOI will be publicized as well (by switching the registration status to \"findable\"). This approach makes the process of publishing datasets simpler and less error-prone.\n+\n+New APIs have been provided for finding any unreserved DataCite-issued DOIs in your Dataverse, and for reserving them (see below). While not required - the user can still attempt to publish a dataset with an unreserved DOI - having all the identifiers reserved ahead of time is recommended. If you are upgrading an installation that uses DataCite, we specifically recommend that you reserve the DOIs for all your pre-existing unpublished drafts as soon as Dataverse v5.0 is deployed, since none of them were registered at create time. This can be done using the following API calls:  \n+\n+- `/api/pids/unreserved`  will report the ids of the datasets\n+- `/api/pids/:persistentId/reserve` reserves the assigned DOI with DataCite (will need to be run on every id reported by the the first API).\n+\n+See the [Native API Guide](http://guides.dataverse.org/en/5.0/api/native-api.html) for more information.\n+\n+Scripted, the whole process would look as follows (adjust as needed):\n+\n+```\n+   API_TOKEN='xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'\n+\n+   curl -s -H \"X-Dataverse-key:$API_TOKEN\" http://localhost:8080/api/pids/unreserved |\n+   # the API outputs JSON; note the use of jq to parse it:\n+   jq '.data.count[].pid' | tr -d '\"' | \n+   while read doi\n+   do\n+      curl -s -H \"X-Dataverse-key:$API_TOKEN\" -X POST http://localhost:8080/api/pids/:persistentId/reserve?persistentId=$doi\n+   done\n+```\n+\n+Going forward, once all the DOIs have been reserved for the legacy drafts, you may still get an occasional dataset with an unreserved identifier. DataCite service instability would be a potential cause. There is no reason to expect that to happen often, but it is not impossible. You may consider running the script above (perhaps with some extra diagnostics added) regularly, from a cron job or otherwise, to address this preemptively.\n+\n+### Datafiles Validation when Publishing Datasets\n+\n+When a user requests to publish a dataset, Dataverse will now attempt to validate the physical files in the dataset, by recalculating the checksums and verifying them against the values in the database. The goal is to prevent any corrupted files in published datasets. Most of all the instances of actual damage to physical files that we've seen in the past happened while the datafiles were still in the Draft state. (Physical files become essentially read-only once published). So this is the logical place to catch any such issues.\n+\n+If any files in the dataset fail the validation, the dataset does not get published, and the user is notified that they need to contact their Dataverse support in order to address the issue before another attempt to publish can be made. See the \"Troubleshooting\" section of the Guide on how to fix such problems.\n+\n+For datasets with large numbers of files, this validation will be performed asynchronously, using the same mechanism as for the registration of the file-level global ids. The cutoff number of files is configured by the same database setting. Similarly to the file PID registration, this validation process can be disabled on your system, with the setting `:FileValidationOnPublishEnabled`. (A Dataverse admin may choose to disable it if, for example, they are already running an external auditing system to monitor the integrity of the files in their Dataverse, and would prefer the publishing process to take less time). See the Config section of the Installation guide for more info.\n+\n+Please note that we are not aware of any bugs in the current versions of Dataverse that would result in damage to users' files. But you may have some legacy files in your archive that were affected by some issue in the past, or perhaps affected by something outside Dataverse, so we are adding this feature out of abundance of caution. An example of a problem we've experienced in the early versions of Dataverse was a possible scenario where a user actually attempted to delete a Draft file from an unpublished version, where the database transaction would fail for whatever reason, but only after the physical file had already been deleted from the filesystem. Thus resulting in a datafile entry remaining in the dataset, but with the corresponding physical file missing. (the fix for this case, since the user wanted to delete the file in the first place, is simply to confirm it and purge the datafile entity from the database).", "originalCommit": "b7c947a6381a1bef87cead90f7a169798aeb2de6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4Mjk4NQ==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r466682985", "bodyText": "Just noting that Title Case isn't used here. I see another instance of this below. Not sure how much we care.", "author": "pdurbin", "createdAt": "2020-08-06T20:59:18Z", "path": "doc/release-notes/5.0-release-notes.md", "diffHunk": "@@ -0,0 +1,313 @@\n+# Dataverse 5.0\n+\n+This release brings new features, enhancements, and bug fixes to Dataverse. Thank you to all of the community members who contributed code, suggestions, bug reports, and other assistance across the project.\n+\n+Please note that this is a major release and these are long release notes. We offer no apologies. :)\n+\n+## Release Highlights\n+\n+### Continued Dataset and File Redesign: Dataset and File Button Redesign, Responsive Layout\n+\n+The buttons available on the Dataset and File pages have been redesigned. This change is to provide more scalability for future expanded options for data access and exploration, and to provide a consistent experience between the two pages. The dataset and file pages have also be redesigned to be more responsive and function better across multiple devices.\n+\n+This is an important step in the incremental process of the Dataset and File Redesign, following the release of on-page previews, filtering and sorting options, tree view, and other enhancements. Additional features in support of these redesign efforts will follow in later 5.x releases.\n+\n+### Payara 5\n+\n+A major upgrade of the application server provides security updates, access to new features like MicroProfile Config API, and will enable eagerly anticipated upgrades to other core technologies.\n+\n+Note that moving from Glassfish to Payara will be required as part of the move to Dataverse 5. If your installation upgrades to Dataverse 5 without upgrading to Payara, the first step of any troubleshooting will be to suggest an upgrade to Payara.\n+\n+### Primefaces 8\n+\n+Primefaces, the open source UI framework upon which the Dataverse front end is built, has been updated to the most recent version. This provides security updates and bug fixes and will also allow Dataverse developers to take advantage of new features and enhancements.\n+\n+### Download Dataset\n+\n+Users can now more easily Download all files in Dataset. If this causes server instability, it's suggested that Dataverse Installation Administrators take advantage of the new Standalone Zipper Service described below.\n+\n+#### Download All Option on the Dataset Page\n+\n+In previous versions of Dataverse, downloading all files from a dataset meant several clicks to select files and initiate the download. The Dataset Page now includes a Download All option for both the original and archival formats of the files in a dataset under the \"Access Dataset\" button.\n+\n+#### Download All API\n+\n+In previous versions of Dataverse, downloading all files from a dataset via API was a two step process:\n+\n+- Find all the database id of the files.\n+- Download all the files, using those ids (comma-separated).\n+\n+Now you can download all files from a dataset (assuming you have access to them) via API by passing the dataset persistent ID (PID such as DOI or Handle) or the dataset's database id. Versions are also supported like with the \"download metadata\" API you can pass :draft, :latest, :latest-published, or numbers (1.1, 2.0).\n+\n+### A Multi-File, Zipped Download Optimization\n+\n+In this release we are offering an experimental optimization for the multi-file, download-as-zip functionality. If this option is enabled, instead of enforcing size limits, we attempt to serve all the files that the user requested (that they are authorized to download), but the request is redirected to a standalone zipper service running as a cgi executable. Thus moving these potentially long-running jobs completely outside the Application Server (Payara); and preventing service threads from becoming locked serving them. Since zipping is also a CPU-intensive task, it is possible to have this service running on a different host system, thus freeing the cycles on the main Application Server. The system running the service needs to have access to the database as well as to the storage filesystem, and/or S3 bucket.\n+\n+Please consult the scripts/zipdownload/README.md in the Dataverse 5 source tree.\n+\n+The components of the standalone \"zipper tool\" can also be downloaded\n+here:\n+\n+XXXXX\n+\n+(my plan is to build the executable and to add it to the v5\n+release files on github: - L.A.)\n+<https://github.com/IQSS/dataverse/releases/download/v5.0/zipper.zip>.\n+\n+### Updated File Handling\n+\n+Files without extensions can now be uploaded through the UI. This release also changes the way Dataverse handles duplicate (filename or checksum) files in a dataset. Specifically:\n+\n+- Files with the same checksum can be included in a dataset, even if the files are in the same directory.\n+- Files with the same filename can be included in a dataset as long as the files are in different directories.\n+- If a user uploads a file to a directory where a file already exists with that directory/filename combination, Dataverse will adjust the file path and names by adding \"-1\" or \"-2\" as applicable. This change will be visible in the list of files being uploaded.\n+- If the directory or name of an existing or newly uploaded file is edited in such a way that would create a directory/filename combination that already exists, Dataverse will display an error.\n+- If a user attempts to replace a file with another file that has the same checksum, an error message will be displayed and the file will not be able to be replaced.\n+- If a user attempts to replace a file with a file that has the same checksum as a different file in the dataset, a warning will be displayed.\n+- Files without extensions can now be uploaded through the UI.\n+\n+### Pre-Publish DOI Reservation with DataCite\n+\n+Dataverse Installations using DataCite will have DOIs reserved as \"Draft\" with DataCite when the Dataset is created, instead of the reservation taking place locally at create time and the reservation taking place with DataCite at publish time. This allows the DOI to reserved earlier in the publication process.\n+\n+## Major Use Cases\n+\n+Newly-supported use cases in this release include:\n+\n+- Users will be presented with a new workflow around dataset and file access and exploration. (Issue #6684, PR #6909)\n+- Users will experience a UI appropriate across a variety of device sizes. (Issue #6684, PR #6909)\n+- Users will be able to download an entire dataset without needing to select all the files in that dataset. (Issue #6564, PR #6262)\n+- Users will be able to download a dataset with a single API call. (Issue #4529, PR #7086)\n+- Users will have DOIs reserved for their datasets upon dataset create instead of at publish time. (Issue #5093, PR #6901)\n+- Users will be able to upload files without extensions. (Issue #6634, PR #6804)\n+- Users will be able to upload files with the same name in a dataset, as long as a those files are in different file paths. (Issue #4813, PR #6924)\n+- Users will be able to upload files with the same checksum in a dataset. (Issue #4813, PR #6924)\n+- Users will be less likely to encounter locks during the publishing process due to PID providers being unavailable. (Issue #6918, PR #7118)\n+- Users will now have their files validated during publish, and in the unlikely event that anything has happened to the files between deposit and publish, they will be able to take corrective action. (Issue #6558, PR #6790)\n+- Administrators will likely see more success with Harvesting, as many minor harvesting issues have been resolved. (Issues #7127, #7128, #4597, #7056, #7052, #7023, #7009, and #7003)\n+- Administrators can now enable an external zip service that frees up application server resources and allows the zip download limit to be increased. (Issue #6505, PR #6986)\n+- Administrators can now create groups based on users' email domains. (Issue #6936, PR #6974)\n+- Administrators can now set date facets to be organized chronologically. (Issue #4977, PR #6958)\n+- Administrators can now link harvested datasets using an API. (Issue #5886, PR #6935)\n+- Administrators can now destroy datasets with mapped shapefiles. (Issue #4093, PR #6860)\n+\n+## Notes for Dataverse Installation Administrators\n+\n+### Glassfish to Payara\n+\n+This upgrade requires a few extra steps. See the detailed upgrade instructions below.\n+\n+### Dataverse Installations Using DataCite: Upgrade Action Recommended\n+\n+For installations that are using DataCite, Dataverse v5.0 introduces a change in the process of registering the Persistent Identifier (DOI) for a dataset. Instead of registering it when the dataset is published for the first time, Dataverse will try to \"reserve\" the DOI when it's created (by registering it as a \"draft\", using DataCite terminology). When the user publishes the dataset, the DOI will be publicized as well (by switching the registration status to \"findable\"). This approach makes the process of publishing datasets simpler and less error-prone.\n+\n+New APIs have been provided for finding any unreserved DataCite-issued DOIs in your Dataverse, and for reserving them (see below). While not required - the user can still attempt to publish a dataset with an unreserved DOI - having all the identifiers reserved ahead of time is recommended. If you are upgrading an installation that uses DataCite, we specifically recommend that you reserve the DOIs for all your pre-existing unpublished drafts as soon as Dataverse v5.0 is deployed, since none of them were registered at create time. This can be done using the following API calls:  \n+\n+- `/api/pids/unreserved`  will report the ids of the datasets\n+- `/api/pids/:persistentId/reserve` reserves the assigned DOI with DataCite (will need to be run on every id reported by the the first API).\n+\n+See the [Native API Guide](http://guides.dataverse.org/en/5.0/api/native-api.html) for more information.\n+\n+Scripted, the whole process would look as follows (adjust as needed):\n+\n+```\n+   API_TOKEN='xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'\n+\n+   curl -s -H \"X-Dataverse-key:$API_TOKEN\" http://localhost:8080/api/pids/unreserved |\n+   # the API outputs JSON; note the use of jq to parse it:\n+   jq '.data.count[].pid' | tr -d '\"' | \n+   while read doi\n+   do\n+      curl -s -H \"X-Dataverse-key:$API_TOKEN\" -X POST http://localhost:8080/api/pids/:persistentId/reserve?persistentId=$doi\n+   done\n+```\n+\n+Going forward, once all the DOIs have been reserved for the legacy drafts, you may still get an occasional dataset with an unreserved identifier. DataCite service instability would be a potential cause. There is no reason to expect that to happen often, but it is not impossible. You may consider running the script above (perhaps with some extra diagnostics added) regularly, from a cron job or otherwise, to address this preemptively.\n+\n+### Datafiles Validation when Publishing Datasets\n+\n+When a user requests to publish a dataset, Dataverse will now attempt to validate the physical files in the dataset, by recalculating the checksums and verifying them against the values in the database. The goal is to prevent any corrupted files in published datasets. Most of all the instances of actual damage to physical files that we've seen in the past happened while the datafiles were still in the Draft state. (Physical files become essentially read-only once published). So this is the logical place to catch any such issues.\n+\n+If any files in the dataset fail the validation, the dataset does not get published, and the user is notified that they need to contact their Dataverse support in order to address the issue before another attempt to publish can be made. See the \"Troubleshooting\" section of the Guide on how to fix such problems.\n+\n+For datasets with large numbers of files, this validation will be performed asynchronously, using the same mechanism as for the registration of the file-level global ids. The cutoff number of files is configured by the same database setting. Similarly to the file PID registration, this validation process can be disabled on your system, with the setting `:FileValidationOnPublishEnabled`. (A Dataverse admin may choose to disable it if, for example, they are already running an external auditing system to monitor the integrity of the files in their Dataverse, and would prefer the publishing process to take less time). See the Config section of the Installation guide for more info.\n+\n+Please note that we are not aware of any bugs in the current versions of Dataverse that would result in damage to users' files. But you may have some legacy files in your archive that were affected by some issue in the past, or perhaps affected by something outside Dataverse, so we are adding this feature out of abundance of caution. An example of a problem we've experienced in the early versions of Dataverse was a possible scenario where a user actually attempted to delete a Draft file from an unpublished version, where the database transaction would fail for whatever reason, but only after the physical file had already been deleted from the filesystem. Thus resulting in a datafile entry remaining in the dataset, but with the corresponding physical file missing. (the fix for this case, since the user wanted to delete the file in the first place, is simply to confirm it and purge the datafile entity from the database).\n+\n+### The setting :PIDAsynchRegFileCount is deprecated as of v5.0", "originalCommit": "b7c947a6381a1bef87cead90f7a169798aeb2de6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4NDYxOQ==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r466684619", "bodyText": "Just noting that this sounds a little scary:\n\"Note that unless your installation always sets the header you configure here, this could be used as a way to spoof the user's address.\"\nMaybe we could end with \"If you don't need this setting, don't set it.\"", "author": "pdurbin", "createdAt": "2020-08-06T21:02:35Z", "path": "doc/release-notes/5.0-release-notes.md", "diffHunk": "@@ -0,0 +1,313 @@\n+# Dataverse 5.0\n+\n+This release brings new features, enhancements, and bug fixes to Dataverse. Thank you to all of the community members who contributed code, suggestions, bug reports, and other assistance across the project.\n+\n+Please note that this is a major release and these are long release notes. We offer no apologies. :)\n+\n+## Release Highlights\n+\n+### Continued Dataset and File Redesign: Dataset and File Button Redesign, Responsive Layout\n+\n+The buttons available on the Dataset and File pages have been redesigned. This change is to provide more scalability for future expanded options for data access and exploration, and to provide a consistent experience between the two pages. The dataset and file pages have also be redesigned to be more responsive and function better across multiple devices.\n+\n+This is an important step in the incremental process of the Dataset and File Redesign, following the release of on-page previews, filtering and sorting options, tree view, and other enhancements. Additional features in support of these redesign efforts will follow in later 5.x releases.\n+\n+### Payara 5\n+\n+A major upgrade of the application server provides security updates, access to new features like MicroProfile Config API, and will enable eagerly anticipated upgrades to other core technologies.\n+\n+Note that moving from Glassfish to Payara will be required as part of the move to Dataverse 5. If your installation upgrades to Dataverse 5 without upgrading to Payara, the first step of any troubleshooting will be to suggest an upgrade to Payara.\n+\n+### Primefaces 8\n+\n+Primefaces, the open source UI framework upon which the Dataverse front end is built, has been updated to the most recent version. This provides security updates and bug fixes and will also allow Dataverse developers to take advantage of new features and enhancements.\n+\n+### Download Dataset\n+\n+Users can now more easily Download all files in Dataset. If this causes server instability, it's suggested that Dataverse Installation Administrators take advantage of the new Standalone Zipper Service described below.\n+\n+#### Download All Option on the Dataset Page\n+\n+In previous versions of Dataverse, downloading all files from a dataset meant several clicks to select files and initiate the download. The Dataset Page now includes a Download All option for both the original and archival formats of the files in a dataset under the \"Access Dataset\" button.\n+\n+#### Download All API\n+\n+In previous versions of Dataverse, downloading all files from a dataset via API was a two step process:\n+\n+- Find all the database id of the files.\n+- Download all the files, using those ids (comma-separated).\n+\n+Now you can download all files from a dataset (assuming you have access to them) via API by passing the dataset persistent ID (PID such as DOI or Handle) or the dataset's database id. Versions are also supported like with the \"download metadata\" API you can pass :draft, :latest, :latest-published, or numbers (1.1, 2.0).\n+\n+### A Multi-File, Zipped Download Optimization\n+\n+In this release we are offering an experimental optimization for the multi-file, download-as-zip functionality. If this option is enabled, instead of enforcing size limits, we attempt to serve all the files that the user requested (that they are authorized to download), but the request is redirected to a standalone zipper service running as a cgi executable. Thus moving these potentially long-running jobs completely outside the Application Server (Payara); and preventing service threads from becoming locked serving them. Since zipping is also a CPU-intensive task, it is possible to have this service running on a different host system, thus freeing the cycles on the main Application Server. The system running the service needs to have access to the database as well as to the storage filesystem, and/or S3 bucket.\n+\n+Please consult the scripts/zipdownload/README.md in the Dataverse 5 source tree.\n+\n+The components of the standalone \"zipper tool\" can also be downloaded\n+here:\n+\n+XXXXX\n+\n+(my plan is to build the executable and to add it to the v5\n+release files on github: - L.A.)\n+<https://github.com/IQSS/dataverse/releases/download/v5.0/zipper.zip>.\n+\n+### Updated File Handling\n+\n+Files without extensions can now be uploaded through the UI. This release also changes the way Dataverse handles duplicate (filename or checksum) files in a dataset. Specifically:\n+\n+- Files with the same checksum can be included in a dataset, even if the files are in the same directory.\n+- Files with the same filename can be included in a dataset as long as the files are in different directories.\n+- If a user uploads a file to a directory where a file already exists with that directory/filename combination, Dataverse will adjust the file path and names by adding \"-1\" or \"-2\" as applicable. This change will be visible in the list of files being uploaded.\n+- If the directory or name of an existing or newly uploaded file is edited in such a way that would create a directory/filename combination that already exists, Dataverse will display an error.\n+- If a user attempts to replace a file with another file that has the same checksum, an error message will be displayed and the file will not be able to be replaced.\n+- If a user attempts to replace a file with a file that has the same checksum as a different file in the dataset, a warning will be displayed.\n+- Files without extensions can now be uploaded through the UI.\n+\n+### Pre-Publish DOI Reservation with DataCite\n+\n+Dataverse Installations using DataCite will have DOIs reserved as \"Draft\" with DataCite when the Dataset is created, instead of the reservation taking place locally at create time and the reservation taking place with DataCite at publish time. This allows the DOI to reserved earlier in the publication process.\n+\n+## Major Use Cases\n+\n+Newly-supported use cases in this release include:\n+\n+- Users will be presented with a new workflow around dataset and file access and exploration. (Issue #6684, PR #6909)\n+- Users will experience a UI appropriate across a variety of device sizes. (Issue #6684, PR #6909)\n+- Users will be able to download an entire dataset without needing to select all the files in that dataset. (Issue #6564, PR #6262)\n+- Users will be able to download a dataset with a single API call. (Issue #4529, PR #7086)\n+- Users will have DOIs reserved for their datasets upon dataset create instead of at publish time. (Issue #5093, PR #6901)\n+- Users will be able to upload files without extensions. (Issue #6634, PR #6804)\n+- Users will be able to upload files with the same name in a dataset, as long as a those files are in different file paths. (Issue #4813, PR #6924)\n+- Users will be able to upload files with the same checksum in a dataset. (Issue #4813, PR #6924)\n+- Users will be less likely to encounter locks during the publishing process due to PID providers being unavailable. (Issue #6918, PR #7118)\n+- Users will now have their files validated during publish, and in the unlikely event that anything has happened to the files between deposit and publish, they will be able to take corrective action. (Issue #6558, PR #6790)\n+- Administrators will likely see more success with Harvesting, as many minor harvesting issues have been resolved. (Issues #7127, #7128, #4597, #7056, #7052, #7023, #7009, and #7003)\n+- Administrators can now enable an external zip service that frees up application server resources and allows the zip download limit to be increased. (Issue #6505, PR #6986)\n+- Administrators can now create groups based on users' email domains. (Issue #6936, PR #6974)\n+- Administrators can now set date facets to be organized chronologically. (Issue #4977, PR #6958)\n+- Administrators can now link harvested datasets using an API. (Issue #5886, PR #6935)\n+- Administrators can now destroy datasets with mapped shapefiles. (Issue #4093, PR #6860)\n+\n+## Notes for Dataverse Installation Administrators\n+\n+### Glassfish to Payara\n+\n+This upgrade requires a few extra steps. See the detailed upgrade instructions below.\n+\n+### Dataverse Installations Using DataCite: Upgrade Action Recommended\n+\n+For installations that are using DataCite, Dataverse v5.0 introduces a change in the process of registering the Persistent Identifier (DOI) for a dataset. Instead of registering it when the dataset is published for the first time, Dataverse will try to \"reserve\" the DOI when it's created (by registering it as a \"draft\", using DataCite terminology). When the user publishes the dataset, the DOI will be publicized as well (by switching the registration status to \"findable\"). This approach makes the process of publishing datasets simpler and less error-prone.\n+\n+New APIs have been provided for finding any unreserved DataCite-issued DOIs in your Dataverse, and for reserving them (see below). While not required - the user can still attempt to publish a dataset with an unreserved DOI - having all the identifiers reserved ahead of time is recommended. If you are upgrading an installation that uses DataCite, we specifically recommend that you reserve the DOIs for all your pre-existing unpublished drafts as soon as Dataverse v5.0 is deployed, since none of them were registered at create time. This can be done using the following API calls:  \n+\n+- `/api/pids/unreserved`  will report the ids of the datasets\n+- `/api/pids/:persistentId/reserve` reserves the assigned DOI with DataCite (will need to be run on every id reported by the the first API).\n+\n+See the [Native API Guide](http://guides.dataverse.org/en/5.0/api/native-api.html) for more information.\n+\n+Scripted, the whole process would look as follows (adjust as needed):\n+\n+```\n+   API_TOKEN='xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'\n+\n+   curl -s -H \"X-Dataverse-key:$API_TOKEN\" http://localhost:8080/api/pids/unreserved |\n+   # the API outputs JSON; note the use of jq to parse it:\n+   jq '.data.count[].pid' | tr -d '\"' | \n+   while read doi\n+   do\n+      curl -s -H \"X-Dataverse-key:$API_TOKEN\" -X POST http://localhost:8080/api/pids/:persistentId/reserve?persistentId=$doi\n+   done\n+```\n+\n+Going forward, once all the DOIs have been reserved for the legacy drafts, you may still get an occasional dataset with an unreserved identifier. DataCite service instability would be a potential cause. There is no reason to expect that to happen often, but it is not impossible. You may consider running the script above (perhaps with some extra diagnostics added) regularly, from a cron job or otherwise, to address this preemptively.\n+\n+### Datafiles Validation when Publishing Datasets\n+\n+When a user requests to publish a dataset, Dataverse will now attempt to validate the physical files in the dataset, by recalculating the checksums and verifying them against the values in the database. The goal is to prevent any corrupted files in published datasets. Most of all the instances of actual damage to physical files that we've seen in the past happened while the datafiles were still in the Draft state. (Physical files become essentially read-only once published). So this is the logical place to catch any such issues.\n+\n+If any files in the dataset fail the validation, the dataset does not get published, and the user is notified that they need to contact their Dataverse support in order to address the issue before another attempt to publish can be made. See the \"Troubleshooting\" section of the Guide on how to fix such problems.\n+\n+For datasets with large numbers of files, this validation will be performed asynchronously, using the same mechanism as for the registration of the file-level global ids. The cutoff number of files is configured by the same database setting. Similarly to the file PID registration, this validation process can be disabled on your system, with the setting `:FileValidationOnPublishEnabled`. (A Dataverse admin may choose to disable it if, for example, they are already running an external auditing system to monitor the integrity of the files in their Dataverse, and would prefer the publishing process to take less time). See the Config section of the Installation guide for more info.\n+\n+Please note that we are not aware of any bugs in the current versions of Dataverse that would result in damage to users' files. But you may have some legacy files in your archive that were affected by some issue in the past, or perhaps affected by something outside Dataverse, so we are adding this feature out of abundance of caution. An example of a problem we've experienced in the early versions of Dataverse was a possible scenario where a user actually attempted to delete a Draft file from an unpublished version, where the database transaction would fail for whatever reason, but only after the physical file had already been deleted from the filesystem. Thus resulting in a datafile entry remaining in the dataset, but with the corresponding physical file missing. (the fix for this case, since the user wanted to delete the file in the first place, is simply to confirm it and purge the datafile entity from the database).\n+\n+### The setting :PIDAsynchRegFileCount is deprecated as of v5.0\n+\n+It used to specify the number of datafiles in the dataset to warrant adding a lock during publishing. As of v5.0 all datasets get locked for the duration of the publishing process. The setting will be ignored if present.\n+\n+### Location Changes for Related Projects\n+\n+The dataverse-ansible and dataverse-previewers repositories have been moved to the GDCC Organization on GitHub. If you have been referencing the dataverse-ansible repository from IQSS and the dataverse-previewers from QDR, please instead use them from their new locations:\n+\n+<https://github.com/GlobalDataverseCommunityConsortium/dataverse-ansible>\n+<https://github.com/GlobalDataverseCommunityConsortium/dataverse-previewers>\n+\n+### Harvesting Improvements\n+\n+Many updates have been made to address common Harvesting failures. You may see Harvests complete more often and have a higher success rate on a dataset-by-dataset basis.\n+\n+### New JVM Options and Database Settings\n+\n+Several new JVM options and DB Settings have been added in this release. More documentation about each of these settings can be found in the Configuration section of the [Installation Guide](http://guides.dataverse.org/en/5.0/installation/config.rst).\n+\n+#### New JVM Options\n+\n+- :doi.baseurlstringnext: Set with a value of \"https://api.datacite.org\" for production environments and \"https://api.test.datacite.org\" for test environments. Must be set if you are using DataCite as your DOI provider.\n+- :dataverse.useripaddresssourceheader: If set, specifies an HTTP Header such as X-Forwarded-For to use to retrieve the user's IP address. This setting is useful in cases such as running Dataverse behind load balancers where the default option of getting the Remote Address from the servlet isn't correct (e.g. it would be the load balancer IP address). Note that unless your installation always sets the header you configure here, this could be used as a way to spoof the user's address.", "originalCommit": "b7c947a6381a1bef87cead90f7a169798aeb2de6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY5MTQ0MA==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r466691440", "bodyText": "Or 'see guide for proper use and details about the security concern.'", "author": "qqmyers", "createdAt": "2020-08-06T21:17:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4NDYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA5NDExMw==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r467094113", "bodyText": "Ah, I didn't realize there's more detail in the guides about the security concern. Sure, mentioning this would be good. Or we could remove the scary line and let people discover it in the guides. Less is more.", "author": "pdurbin", "createdAt": "2020-08-07T14:57:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4NDYxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4NzEyMg==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r466687122", "bodyText": ":FileValidationOnPublishEnabled is a database setting, not a JVM option, so it should be moved down there.", "author": "pdurbin", "createdAt": "2020-08-06T21:07:57Z", "path": "doc/release-notes/5.0-release-notes.md", "diffHunk": "@@ -0,0 +1,313 @@\n+# Dataverse 5.0\n+\n+This release brings new features, enhancements, and bug fixes to Dataverse. Thank you to all of the community members who contributed code, suggestions, bug reports, and other assistance across the project.\n+\n+Please note that this is a major release and these are long release notes. We offer no apologies. :)\n+\n+## Release Highlights\n+\n+### Continued Dataset and File Redesign: Dataset and File Button Redesign, Responsive Layout\n+\n+The buttons available on the Dataset and File pages have been redesigned. This change is to provide more scalability for future expanded options for data access and exploration, and to provide a consistent experience between the two pages. The dataset and file pages have also be redesigned to be more responsive and function better across multiple devices.\n+\n+This is an important step in the incremental process of the Dataset and File Redesign, following the release of on-page previews, filtering and sorting options, tree view, and other enhancements. Additional features in support of these redesign efforts will follow in later 5.x releases.\n+\n+### Payara 5\n+\n+A major upgrade of the application server provides security updates, access to new features like MicroProfile Config API, and will enable eagerly anticipated upgrades to other core technologies.\n+\n+Note that moving from Glassfish to Payara will be required as part of the move to Dataverse 5. If your installation upgrades to Dataverse 5 without upgrading to Payara, the first step of any troubleshooting will be to suggest an upgrade to Payara.\n+\n+### Primefaces 8\n+\n+Primefaces, the open source UI framework upon which the Dataverse front end is built, has been updated to the most recent version. This provides security updates and bug fixes and will also allow Dataverse developers to take advantage of new features and enhancements.\n+\n+### Download Dataset\n+\n+Users can now more easily Download all files in Dataset. If this causes server instability, it's suggested that Dataverse Installation Administrators take advantage of the new Standalone Zipper Service described below.\n+\n+#### Download All Option on the Dataset Page\n+\n+In previous versions of Dataverse, downloading all files from a dataset meant several clicks to select files and initiate the download. The Dataset Page now includes a Download All option for both the original and archival formats of the files in a dataset under the \"Access Dataset\" button.\n+\n+#### Download All API\n+\n+In previous versions of Dataverse, downloading all files from a dataset via API was a two step process:\n+\n+- Find all the database id of the files.\n+- Download all the files, using those ids (comma-separated).\n+\n+Now you can download all files from a dataset (assuming you have access to them) via API by passing the dataset persistent ID (PID such as DOI or Handle) or the dataset's database id. Versions are also supported like with the \"download metadata\" API you can pass :draft, :latest, :latest-published, or numbers (1.1, 2.0).\n+\n+### A Multi-File, Zipped Download Optimization\n+\n+In this release we are offering an experimental optimization for the multi-file, download-as-zip functionality. If this option is enabled, instead of enforcing size limits, we attempt to serve all the files that the user requested (that they are authorized to download), but the request is redirected to a standalone zipper service running as a cgi executable. Thus moving these potentially long-running jobs completely outside the Application Server (Payara); and preventing service threads from becoming locked serving them. Since zipping is also a CPU-intensive task, it is possible to have this service running on a different host system, thus freeing the cycles on the main Application Server. The system running the service needs to have access to the database as well as to the storage filesystem, and/or S3 bucket.\n+\n+Please consult the scripts/zipdownload/README.md in the Dataverse 5 source tree.\n+\n+The components of the standalone \"zipper tool\" can also be downloaded\n+here:\n+\n+XXXXX\n+\n+(my plan is to build the executable and to add it to the v5\n+release files on github: - L.A.)\n+<https://github.com/IQSS/dataverse/releases/download/v5.0/zipper.zip>.\n+\n+### Updated File Handling\n+\n+Files without extensions can now be uploaded through the UI. This release also changes the way Dataverse handles duplicate (filename or checksum) files in a dataset. Specifically:\n+\n+- Files with the same checksum can be included in a dataset, even if the files are in the same directory.\n+- Files with the same filename can be included in a dataset as long as the files are in different directories.\n+- If a user uploads a file to a directory where a file already exists with that directory/filename combination, Dataverse will adjust the file path and names by adding \"-1\" or \"-2\" as applicable. This change will be visible in the list of files being uploaded.\n+- If the directory or name of an existing or newly uploaded file is edited in such a way that would create a directory/filename combination that already exists, Dataverse will display an error.\n+- If a user attempts to replace a file with another file that has the same checksum, an error message will be displayed and the file will not be able to be replaced.\n+- If a user attempts to replace a file with a file that has the same checksum as a different file in the dataset, a warning will be displayed.\n+- Files without extensions can now be uploaded through the UI.\n+\n+### Pre-Publish DOI Reservation with DataCite\n+\n+Dataverse Installations using DataCite will have DOIs reserved as \"Draft\" with DataCite when the Dataset is created, instead of the reservation taking place locally at create time and the reservation taking place with DataCite at publish time. This allows the DOI to reserved earlier in the publication process.\n+\n+## Major Use Cases\n+\n+Newly-supported use cases in this release include:\n+\n+- Users will be presented with a new workflow around dataset and file access and exploration. (Issue #6684, PR #6909)\n+- Users will experience a UI appropriate across a variety of device sizes. (Issue #6684, PR #6909)\n+- Users will be able to download an entire dataset without needing to select all the files in that dataset. (Issue #6564, PR #6262)\n+- Users will be able to download a dataset with a single API call. (Issue #4529, PR #7086)\n+- Users will have DOIs reserved for their datasets upon dataset create instead of at publish time. (Issue #5093, PR #6901)\n+- Users will be able to upload files without extensions. (Issue #6634, PR #6804)\n+- Users will be able to upload files with the same name in a dataset, as long as a those files are in different file paths. (Issue #4813, PR #6924)\n+- Users will be able to upload files with the same checksum in a dataset. (Issue #4813, PR #6924)\n+- Users will be less likely to encounter locks during the publishing process due to PID providers being unavailable. (Issue #6918, PR #7118)\n+- Users will now have their files validated during publish, and in the unlikely event that anything has happened to the files between deposit and publish, they will be able to take corrective action. (Issue #6558, PR #6790)\n+- Administrators will likely see more success with Harvesting, as many minor harvesting issues have been resolved. (Issues #7127, #7128, #4597, #7056, #7052, #7023, #7009, and #7003)\n+- Administrators can now enable an external zip service that frees up application server resources and allows the zip download limit to be increased. (Issue #6505, PR #6986)\n+- Administrators can now create groups based on users' email domains. (Issue #6936, PR #6974)\n+- Administrators can now set date facets to be organized chronologically. (Issue #4977, PR #6958)\n+- Administrators can now link harvested datasets using an API. (Issue #5886, PR #6935)\n+- Administrators can now destroy datasets with mapped shapefiles. (Issue #4093, PR #6860)\n+\n+## Notes for Dataverse Installation Administrators\n+\n+### Glassfish to Payara\n+\n+This upgrade requires a few extra steps. See the detailed upgrade instructions below.\n+\n+### Dataverse Installations Using DataCite: Upgrade Action Recommended\n+\n+For installations that are using DataCite, Dataverse v5.0 introduces a change in the process of registering the Persistent Identifier (DOI) for a dataset. Instead of registering it when the dataset is published for the first time, Dataverse will try to \"reserve\" the DOI when it's created (by registering it as a \"draft\", using DataCite terminology). When the user publishes the dataset, the DOI will be publicized as well (by switching the registration status to \"findable\"). This approach makes the process of publishing datasets simpler and less error-prone.\n+\n+New APIs have been provided for finding any unreserved DataCite-issued DOIs in your Dataverse, and for reserving them (see below). While not required - the user can still attempt to publish a dataset with an unreserved DOI - having all the identifiers reserved ahead of time is recommended. If you are upgrading an installation that uses DataCite, we specifically recommend that you reserve the DOIs for all your pre-existing unpublished drafts as soon as Dataverse v5.0 is deployed, since none of them were registered at create time. This can be done using the following API calls:  \n+\n+- `/api/pids/unreserved`  will report the ids of the datasets\n+- `/api/pids/:persistentId/reserve` reserves the assigned DOI with DataCite (will need to be run on every id reported by the the first API).\n+\n+See the [Native API Guide](http://guides.dataverse.org/en/5.0/api/native-api.html) for more information.\n+\n+Scripted, the whole process would look as follows (adjust as needed):\n+\n+```\n+   API_TOKEN='xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'\n+\n+   curl -s -H \"X-Dataverse-key:$API_TOKEN\" http://localhost:8080/api/pids/unreserved |\n+   # the API outputs JSON; note the use of jq to parse it:\n+   jq '.data.count[].pid' | tr -d '\"' | \n+   while read doi\n+   do\n+      curl -s -H \"X-Dataverse-key:$API_TOKEN\" -X POST http://localhost:8080/api/pids/:persistentId/reserve?persistentId=$doi\n+   done\n+```\n+\n+Going forward, once all the DOIs have been reserved for the legacy drafts, you may still get an occasional dataset with an unreserved identifier. DataCite service instability would be a potential cause. There is no reason to expect that to happen often, but it is not impossible. You may consider running the script above (perhaps with some extra diagnostics added) regularly, from a cron job or otherwise, to address this preemptively.\n+\n+### Datafiles Validation when Publishing Datasets\n+\n+When a user requests to publish a dataset, Dataverse will now attempt to validate the physical files in the dataset, by recalculating the checksums and verifying them against the values in the database. The goal is to prevent any corrupted files in published datasets. Most of all the instances of actual damage to physical files that we've seen in the past happened while the datafiles were still in the Draft state. (Physical files become essentially read-only once published). So this is the logical place to catch any such issues.\n+\n+If any files in the dataset fail the validation, the dataset does not get published, and the user is notified that they need to contact their Dataverse support in order to address the issue before another attempt to publish can be made. See the \"Troubleshooting\" section of the Guide on how to fix such problems.\n+\n+For datasets with large numbers of files, this validation will be performed asynchronously, using the same mechanism as for the registration of the file-level global ids. The cutoff number of files is configured by the same database setting. Similarly to the file PID registration, this validation process can be disabled on your system, with the setting `:FileValidationOnPublishEnabled`. (A Dataverse admin may choose to disable it if, for example, they are already running an external auditing system to monitor the integrity of the files in their Dataverse, and would prefer the publishing process to take less time). See the Config section of the Installation guide for more info.\n+\n+Please note that we are not aware of any bugs in the current versions of Dataverse that would result in damage to users' files. But you may have some legacy files in your archive that were affected by some issue in the past, or perhaps affected by something outside Dataverse, so we are adding this feature out of abundance of caution. An example of a problem we've experienced in the early versions of Dataverse was a possible scenario where a user actually attempted to delete a Draft file from an unpublished version, where the database transaction would fail for whatever reason, but only after the physical file had already been deleted from the filesystem. Thus resulting in a datafile entry remaining in the dataset, but with the corresponding physical file missing. (the fix for this case, since the user wanted to delete the file in the first place, is simply to confirm it and purge the datafile entity from the database).\n+\n+### The setting :PIDAsynchRegFileCount is deprecated as of v5.0\n+\n+It used to specify the number of datafiles in the dataset to warrant adding a lock during publishing. As of v5.0 all datasets get locked for the duration of the publishing process. The setting will be ignored if present.\n+\n+### Location Changes for Related Projects\n+\n+The dataverse-ansible and dataverse-previewers repositories have been moved to the GDCC Organization on GitHub. If you have been referencing the dataverse-ansible repository from IQSS and the dataverse-previewers from QDR, please instead use them from their new locations:\n+\n+<https://github.com/GlobalDataverseCommunityConsortium/dataverse-ansible>\n+<https://github.com/GlobalDataverseCommunityConsortium/dataverse-previewers>\n+\n+### Harvesting Improvements\n+\n+Many updates have been made to address common Harvesting failures. You may see Harvests complete more often and have a higher success rate on a dataset-by-dataset basis.\n+\n+### New JVM Options and Database Settings\n+\n+Several new JVM options and DB Settings have been added in this release. More documentation about each of these settings can be found in the Configuration section of the [Installation Guide](http://guides.dataverse.org/en/5.0/installation/config.rst).\n+\n+#### New JVM Options\n+\n+- :doi.baseurlstringnext: Set with a value of \"https://api.datacite.org\" for production environments and \"https://api.test.datacite.org\" for test environments. Must be set if you are using DataCite as your DOI provider.\n+- :dataverse.useripaddresssourceheader: If set, specifies an HTTP Header such as X-Forwarded-For to use to retrieve the user's IP address. This setting is useful in cases such as running Dataverse behind load balancers where the default option of getting the Remote Address from the servlet isn't correct (e.g. it would be the load balancer IP address). Note that unless your installation always sets the header you configure here, this could be used as a way to spoof the user's address.\n+- :FileValidationOnPublishEnabled: Toggles validation of the physical files in the dataset when it's published, by recalculating the checksums and comparing against the values stored in the DataFile table. By default this setting is absent and Dataverse assumes it to be true. If enabled, the validation will be performed asynchronously, similarly to how we handle assigning persistent identifiers to datafiles, with the dataset locked for the duration of the publishing process.", "originalCommit": "b7c947a6381a1bef87cead90f7a169798aeb2de6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4Nzg3MQ==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r466687871", "bodyText": "\"Application Service\" sounds weird to me. Maybe \"application server\"? Perhaps the idea is that there can be multiple application servers forming a service and the zipper can live outside all of that. Maybe just say \"the main application\"? I don't know.", "author": "pdurbin", "createdAt": "2020-08-06T21:09:39Z", "path": "doc/release-notes/5.0-release-notes.md", "diffHunk": "@@ -0,0 +1,313 @@\n+# Dataverse 5.0\n+\n+This release brings new features, enhancements, and bug fixes to Dataverse. Thank you to all of the community members who contributed code, suggestions, bug reports, and other assistance across the project.\n+\n+Please note that this is a major release and these are long release notes. We offer no apologies. :)\n+\n+## Release Highlights\n+\n+### Continued Dataset and File Redesign: Dataset and File Button Redesign, Responsive Layout\n+\n+The buttons available on the Dataset and File pages have been redesigned. This change is to provide more scalability for future expanded options for data access and exploration, and to provide a consistent experience between the two pages. The dataset and file pages have also be redesigned to be more responsive and function better across multiple devices.\n+\n+This is an important step in the incremental process of the Dataset and File Redesign, following the release of on-page previews, filtering and sorting options, tree view, and other enhancements. Additional features in support of these redesign efforts will follow in later 5.x releases.\n+\n+### Payara 5\n+\n+A major upgrade of the application server provides security updates, access to new features like MicroProfile Config API, and will enable eagerly anticipated upgrades to other core technologies.\n+\n+Note that moving from Glassfish to Payara will be required as part of the move to Dataverse 5. If your installation upgrades to Dataverse 5 without upgrading to Payara, the first step of any troubleshooting will be to suggest an upgrade to Payara.\n+\n+### Primefaces 8\n+\n+Primefaces, the open source UI framework upon which the Dataverse front end is built, has been updated to the most recent version. This provides security updates and bug fixes and will also allow Dataverse developers to take advantage of new features and enhancements.\n+\n+### Download Dataset\n+\n+Users can now more easily Download all files in Dataset. If this causes server instability, it's suggested that Dataverse Installation Administrators take advantage of the new Standalone Zipper Service described below.\n+\n+#### Download All Option on the Dataset Page\n+\n+In previous versions of Dataverse, downloading all files from a dataset meant several clicks to select files and initiate the download. The Dataset Page now includes a Download All option for both the original and archival formats of the files in a dataset under the \"Access Dataset\" button.\n+\n+#### Download All API\n+\n+In previous versions of Dataverse, downloading all files from a dataset via API was a two step process:\n+\n+- Find all the database id of the files.\n+- Download all the files, using those ids (comma-separated).\n+\n+Now you can download all files from a dataset (assuming you have access to them) via API by passing the dataset persistent ID (PID such as DOI or Handle) or the dataset's database id. Versions are also supported like with the \"download metadata\" API you can pass :draft, :latest, :latest-published, or numbers (1.1, 2.0).\n+\n+### A Multi-File, Zipped Download Optimization\n+\n+In this release we are offering an experimental optimization for the multi-file, download-as-zip functionality. If this option is enabled, instead of enforcing size limits, we attempt to serve all the files that the user requested (that they are authorized to download), but the request is redirected to a standalone zipper service running as a cgi executable. Thus moving these potentially long-running jobs completely outside the Application Server (Payara); and preventing service threads from becoming locked serving them. Since zipping is also a CPU-intensive task, it is possible to have this service running on a different host system, thus freeing the cycles on the main Application Server. The system running the service needs to have access to the database as well as to the storage filesystem, and/or S3 bucket.\n+\n+Please consult the scripts/zipdownload/README.md in the Dataverse 5 source tree.\n+\n+The components of the standalone \"zipper tool\" can also be downloaded\n+here:\n+\n+XXXXX\n+\n+(my plan is to build the executable and to add it to the v5\n+release files on github: - L.A.)\n+<https://github.com/IQSS/dataverse/releases/download/v5.0/zipper.zip>.\n+\n+### Updated File Handling\n+\n+Files without extensions can now be uploaded through the UI. This release also changes the way Dataverse handles duplicate (filename or checksum) files in a dataset. Specifically:\n+\n+- Files with the same checksum can be included in a dataset, even if the files are in the same directory.\n+- Files with the same filename can be included in a dataset as long as the files are in different directories.\n+- If a user uploads a file to a directory where a file already exists with that directory/filename combination, Dataverse will adjust the file path and names by adding \"-1\" or \"-2\" as applicable. This change will be visible in the list of files being uploaded.\n+- If the directory or name of an existing or newly uploaded file is edited in such a way that would create a directory/filename combination that already exists, Dataverse will display an error.\n+- If a user attempts to replace a file with another file that has the same checksum, an error message will be displayed and the file will not be able to be replaced.\n+- If a user attempts to replace a file with a file that has the same checksum as a different file in the dataset, a warning will be displayed.\n+- Files without extensions can now be uploaded through the UI.\n+\n+### Pre-Publish DOI Reservation with DataCite\n+\n+Dataverse Installations using DataCite will have DOIs reserved as \"Draft\" with DataCite when the Dataset is created, instead of the reservation taking place locally at create time and the reservation taking place with DataCite at publish time. This allows the DOI to reserved earlier in the publication process.\n+\n+## Major Use Cases\n+\n+Newly-supported use cases in this release include:\n+\n+- Users will be presented with a new workflow around dataset and file access and exploration. (Issue #6684, PR #6909)\n+- Users will experience a UI appropriate across a variety of device sizes. (Issue #6684, PR #6909)\n+- Users will be able to download an entire dataset without needing to select all the files in that dataset. (Issue #6564, PR #6262)\n+- Users will be able to download a dataset with a single API call. (Issue #4529, PR #7086)\n+- Users will have DOIs reserved for their datasets upon dataset create instead of at publish time. (Issue #5093, PR #6901)\n+- Users will be able to upload files without extensions. (Issue #6634, PR #6804)\n+- Users will be able to upload files with the same name in a dataset, as long as a those files are in different file paths. (Issue #4813, PR #6924)\n+- Users will be able to upload files with the same checksum in a dataset. (Issue #4813, PR #6924)\n+- Users will be less likely to encounter locks during the publishing process due to PID providers being unavailable. (Issue #6918, PR #7118)\n+- Users will now have their files validated during publish, and in the unlikely event that anything has happened to the files between deposit and publish, they will be able to take corrective action. (Issue #6558, PR #6790)\n+- Administrators will likely see more success with Harvesting, as many minor harvesting issues have been resolved. (Issues #7127, #7128, #4597, #7056, #7052, #7023, #7009, and #7003)\n+- Administrators can now enable an external zip service that frees up application server resources and allows the zip download limit to be increased. (Issue #6505, PR #6986)\n+- Administrators can now create groups based on users' email domains. (Issue #6936, PR #6974)\n+- Administrators can now set date facets to be organized chronologically. (Issue #4977, PR #6958)\n+- Administrators can now link harvested datasets using an API. (Issue #5886, PR #6935)\n+- Administrators can now destroy datasets with mapped shapefiles. (Issue #4093, PR #6860)\n+\n+## Notes for Dataverse Installation Administrators\n+\n+### Glassfish to Payara\n+\n+This upgrade requires a few extra steps. See the detailed upgrade instructions below.\n+\n+### Dataverse Installations Using DataCite: Upgrade Action Recommended\n+\n+For installations that are using DataCite, Dataverse v5.0 introduces a change in the process of registering the Persistent Identifier (DOI) for a dataset. Instead of registering it when the dataset is published for the first time, Dataverse will try to \"reserve\" the DOI when it's created (by registering it as a \"draft\", using DataCite terminology). When the user publishes the dataset, the DOI will be publicized as well (by switching the registration status to \"findable\"). This approach makes the process of publishing datasets simpler and less error-prone.\n+\n+New APIs have been provided for finding any unreserved DataCite-issued DOIs in your Dataverse, and for reserving them (see below). While not required - the user can still attempt to publish a dataset with an unreserved DOI - having all the identifiers reserved ahead of time is recommended. If you are upgrading an installation that uses DataCite, we specifically recommend that you reserve the DOIs for all your pre-existing unpublished drafts as soon as Dataverse v5.0 is deployed, since none of them were registered at create time. This can be done using the following API calls:  \n+\n+- `/api/pids/unreserved`  will report the ids of the datasets\n+- `/api/pids/:persistentId/reserve` reserves the assigned DOI with DataCite (will need to be run on every id reported by the the first API).\n+\n+See the [Native API Guide](http://guides.dataverse.org/en/5.0/api/native-api.html) for more information.\n+\n+Scripted, the whole process would look as follows (adjust as needed):\n+\n+```\n+   API_TOKEN='xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'\n+\n+   curl -s -H \"X-Dataverse-key:$API_TOKEN\" http://localhost:8080/api/pids/unreserved |\n+   # the API outputs JSON; note the use of jq to parse it:\n+   jq '.data.count[].pid' | tr -d '\"' | \n+   while read doi\n+   do\n+      curl -s -H \"X-Dataverse-key:$API_TOKEN\" -X POST http://localhost:8080/api/pids/:persistentId/reserve?persistentId=$doi\n+   done\n+```\n+\n+Going forward, once all the DOIs have been reserved for the legacy drafts, you may still get an occasional dataset with an unreserved identifier. DataCite service instability would be a potential cause. There is no reason to expect that to happen often, but it is not impossible. You may consider running the script above (perhaps with some extra diagnostics added) regularly, from a cron job or otherwise, to address this preemptively.\n+\n+### Datafiles Validation when Publishing Datasets\n+\n+When a user requests to publish a dataset, Dataverse will now attempt to validate the physical files in the dataset, by recalculating the checksums and verifying them against the values in the database. The goal is to prevent any corrupted files in published datasets. Most of all the instances of actual damage to physical files that we've seen in the past happened while the datafiles were still in the Draft state. (Physical files become essentially read-only once published). So this is the logical place to catch any such issues.\n+\n+If any files in the dataset fail the validation, the dataset does not get published, and the user is notified that they need to contact their Dataverse support in order to address the issue before another attempt to publish can be made. See the \"Troubleshooting\" section of the Guide on how to fix such problems.\n+\n+For datasets with large numbers of files, this validation will be performed asynchronously, using the same mechanism as for the registration of the file-level global ids. The cutoff number of files is configured by the same database setting. Similarly to the file PID registration, this validation process can be disabled on your system, with the setting `:FileValidationOnPublishEnabled`. (A Dataverse admin may choose to disable it if, for example, they are already running an external auditing system to monitor the integrity of the files in their Dataverse, and would prefer the publishing process to take less time). See the Config section of the Installation guide for more info.\n+\n+Please note that we are not aware of any bugs in the current versions of Dataverse that would result in damage to users' files. But you may have some legacy files in your archive that were affected by some issue in the past, or perhaps affected by something outside Dataverse, so we are adding this feature out of abundance of caution. An example of a problem we've experienced in the early versions of Dataverse was a possible scenario where a user actually attempted to delete a Draft file from an unpublished version, where the database transaction would fail for whatever reason, but only after the physical file had already been deleted from the filesystem. Thus resulting in a datafile entry remaining in the dataset, but with the corresponding physical file missing. (the fix for this case, since the user wanted to delete the file in the first place, is simply to confirm it and purge the datafile entity from the database).\n+\n+### The setting :PIDAsynchRegFileCount is deprecated as of v5.0\n+\n+It used to specify the number of datafiles in the dataset to warrant adding a lock during publishing. As of v5.0 all datasets get locked for the duration of the publishing process. The setting will be ignored if present.\n+\n+### Location Changes for Related Projects\n+\n+The dataverse-ansible and dataverse-previewers repositories have been moved to the GDCC Organization on GitHub. If you have been referencing the dataverse-ansible repository from IQSS and the dataverse-previewers from QDR, please instead use them from their new locations:\n+\n+<https://github.com/GlobalDataverseCommunityConsortium/dataverse-ansible>\n+<https://github.com/GlobalDataverseCommunityConsortium/dataverse-previewers>\n+\n+### Harvesting Improvements\n+\n+Many updates have been made to address common Harvesting failures. You may see Harvests complete more often and have a higher success rate on a dataset-by-dataset basis.\n+\n+### New JVM Options and Database Settings\n+\n+Several new JVM options and DB Settings have been added in this release. More documentation about each of these settings can be found in the Configuration section of the [Installation Guide](http://guides.dataverse.org/en/5.0/installation/config.rst).\n+\n+#### New JVM Options\n+\n+- :doi.baseurlstringnext: Set with a value of \"https://api.datacite.org\" for production environments and \"https://api.test.datacite.org\" for test environments. Must be set if you are using DataCite as your DOI provider.\n+- :dataverse.useripaddresssourceheader: If set, specifies an HTTP Header such as X-Forwarded-For to use to retrieve the user's IP address. This setting is useful in cases such as running Dataverse behind load balancers where the default option of getting the Remote Address from the servlet isn't correct (e.g. it would be the load balancer IP address). Note that unless your installation always sets the header you configure here, this could be used as a way to spoof the user's address.\n+- :FileValidationOnPublishEnabled: Toggles validation of the physical files in the dataset when it's published, by recalculating the checksums and comparing against the values stored in the DataFile table. By default this setting is absent and Dataverse assumes it to be true. If enabled, the validation will be performed asynchronously, similarly to how we handle assigning persistent identifiers to datafiles, with the dataset locked for the duration of the publishing process.\n+- :http.request-timeout-seconds: To facilitate large file upload and download, the Dataverse installer bumps the Payara **server-config.network-config.protocols.protocol.http-listener-1.http.request-timeout-seconds** setting from its default 900 seconds (15 minutes) to 1800 (30 minutes).\n+\n+#### New Database Settings\n+\n+- :CustomZipDownloadServiceUrl: If defined, this is the URL of the zipping service outside the main Application Service where zip downloads should be directed (instead of /api/access/datafiles/).", "originalCommit": "b7c947a6381a1bef87cead90f7a169798aeb2de6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4ODkzNw==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r466688937", "bodyText": "After reading the first line I'm wondering how to update my custom analytics code.\nThe second line gives the link but perhaps these could be woven together a bit more smoothly.", "author": "pdurbin", "createdAt": "2020-08-06T21:11:57Z", "path": "doc/release-notes/5.0-release-notes.md", "diffHunk": "@@ -0,0 +1,313 @@\n+# Dataverse 5.0\n+\n+This release brings new features, enhancements, and bug fixes to Dataverse. Thank you to all of the community members who contributed code, suggestions, bug reports, and other assistance across the project.\n+\n+Please note that this is a major release and these are long release notes. We offer no apologies. :)\n+\n+## Release Highlights\n+\n+### Continued Dataset and File Redesign: Dataset and File Button Redesign, Responsive Layout\n+\n+The buttons available on the Dataset and File pages have been redesigned. This change is to provide more scalability for future expanded options for data access and exploration, and to provide a consistent experience between the two pages. The dataset and file pages have also be redesigned to be more responsive and function better across multiple devices.\n+\n+This is an important step in the incremental process of the Dataset and File Redesign, following the release of on-page previews, filtering and sorting options, tree view, and other enhancements. Additional features in support of these redesign efforts will follow in later 5.x releases.\n+\n+### Payara 5\n+\n+A major upgrade of the application server provides security updates, access to new features like MicroProfile Config API, and will enable eagerly anticipated upgrades to other core technologies.\n+\n+Note that moving from Glassfish to Payara will be required as part of the move to Dataverse 5. If your installation upgrades to Dataverse 5 without upgrading to Payara, the first step of any troubleshooting will be to suggest an upgrade to Payara.\n+\n+### Primefaces 8\n+\n+Primefaces, the open source UI framework upon which the Dataverse front end is built, has been updated to the most recent version. This provides security updates and bug fixes and will also allow Dataverse developers to take advantage of new features and enhancements.\n+\n+### Download Dataset\n+\n+Users can now more easily Download all files in Dataset. If this causes server instability, it's suggested that Dataverse Installation Administrators take advantage of the new Standalone Zipper Service described below.\n+\n+#### Download All Option on the Dataset Page\n+\n+In previous versions of Dataverse, downloading all files from a dataset meant several clicks to select files and initiate the download. The Dataset Page now includes a Download All option for both the original and archival formats of the files in a dataset under the \"Access Dataset\" button.\n+\n+#### Download All API\n+\n+In previous versions of Dataverse, downloading all files from a dataset via API was a two step process:\n+\n+- Find all the database id of the files.\n+- Download all the files, using those ids (comma-separated).\n+\n+Now you can download all files from a dataset (assuming you have access to them) via API by passing the dataset persistent ID (PID such as DOI or Handle) or the dataset's database id. Versions are also supported like with the \"download metadata\" API you can pass :draft, :latest, :latest-published, or numbers (1.1, 2.0).\n+\n+### A Multi-File, Zipped Download Optimization\n+\n+In this release we are offering an experimental optimization for the multi-file, download-as-zip functionality. If this option is enabled, instead of enforcing size limits, we attempt to serve all the files that the user requested (that they are authorized to download), but the request is redirected to a standalone zipper service running as a cgi executable. Thus moving these potentially long-running jobs completely outside the Application Server (Payara); and preventing service threads from becoming locked serving them. Since zipping is also a CPU-intensive task, it is possible to have this service running on a different host system, thus freeing the cycles on the main Application Server. The system running the service needs to have access to the database as well as to the storage filesystem, and/or S3 bucket.\n+\n+Please consult the scripts/zipdownload/README.md in the Dataverse 5 source tree.\n+\n+The components of the standalone \"zipper tool\" can also be downloaded\n+here:\n+\n+XXXXX\n+\n+(my plan is to build the executable and to add it to the v5\n+release files on github: - L.A.)\n+<https://github.com/IQSS/dataverse/releases/download/v5.0/zipper.zip>.\n+\n+### Updated File Handling\n+\n+Files without extensions can now be uploaded through the UI. This release also changes the way Dataverse handles duplicate (filename or checksum) files in a dataset. Specifically:\n+\n+- Files with the same checksum can be included in a dataset, even if the files are in the same directory.\n+- Files with the same filename can be included in a dataset as long as the files are in different directories.\n+- If a user uploads a file to a directory where a file already exists with that directory/filename combination, Dataverse will adjust the file path and names by adding \"-1\" or \"-2\" as applicable. This change will be visible in the list of files being uploaded.\n+- If the directory or name of an existing or newly uploaded file is edited in such a way that would create a directory/filename combination that already exists, Dataverse will display an error.\n+- If a user attempts to replace a file with another file that has the same checksum, an error message will be displayed and the file will not be able to be replaced.\n+- If a user attempts to replace a file with a file that has the same checksum as a different file in the dataset, a warning will be displayed.\n+- Files without extensions can now be uploaded through the UI.\n+\n+### Pre-Publish DOI Reservation with DataCite\n+\n+Dataverse Installations using DataCite will have DOIs reserved as \"Draft\" with DataCite when the Dataset is created, instead of the reservation taking place locally at create time and the reservation taking place with DataCite at publish time. This allows the DOI to reserved earlier in the publication process.\n+\n+## Major Use Cases\n+\n+Newly-supported use cases in this release include:\n+\n+- Users will be presented with a new workflow around dataset and file access and exploration. (Issue #6684, PR #6909)\n+- Users will experience a UI appropriate across a variety of device sizes. (Issue #6684, PR #6909)\n+- Users will be able to download an entire dataset without needing to select all the files in that dataset. (Issue #6564, PR #6262)\n+- Users will be able to download a dataset with a single API call. (Issue #4529, PR #7086)\n+- Users will have DOIs reserved for their datasets upon dataset create instead of at publish time. (Issue #5093, PR #6901)\n+- Users will be able to upload files without extensions. (Issue #6634, PR #6804)\n+- Users will be able to upload files with the same name in a dataset, as long as a those files are in different file paths. (Issue #4813, PR #6924)\n+- Users will be able to upload files with the same checksum in a dataset. (Issue #4813, PR #6924)\n+- Users will be less likely to encounter locks during the publishing process due to PID providers being unavailable. (Issue #6918, PR #7118)\n+- Users will now have their files validated during publish, and in the unlikely event that anything has happened to the files between deposit and publish, they will be able to take corrective action. (Issue #6558, PR #6790)\n+- Administrators will likely see more success with Harvesting, as many minor harvesting issues have been resolved. (Issues #7127, #7128, #4597, #7056, #7052, #7023, #7009, and #7003)\n+- Administrators can now enable an external zip service that frees up application server resources and allows the zip download limit to be increased. (Issue #6505, PR #6986)\n+- Administrators can now create groups based on users' email domains. (Issue #6936, PR #6974)\n+- Administrators can now set date facets to be organized chronologically. (Issue #4977, PR #6958)\n+- Administrators can now link harvested datasets using an API. (Issue #5886, PR #6935)\n+- Administrators can now destroy datasets with mapped shapefiles. (Issue #4093, PR #6860)\n+\n+## Notes for Dataverse Installation Administrators\n+\n+### Glassfish to Payara\n+\n+This upgrade requires a few extra steps. See the detailed upgrade instructions below.\n+\n+### Dataverse Installations Using DataCite: Upgrade Action Recommended\n+\n+For installations that are using DataCite, Dataverse v5.0 introduces a change in the process of registering the Persistent Identifier (DOI) for a dataset. Instead of registering it when the dataset is published for the first time, Dataverse will try to \"reserve\" the DOI when it's created (by registering it as a \"draft\", using DataCite terminology). When the user publishes the dataset, the DOI will be publicized as well (by switching the registration status to \"findable\"). This approach makes the process of publishing datasets simpler and less error-prone.\n+\n+New APIs have been provided for finding any unreserved DataCite-issued DOIs in your Dataverse, and for reserving them (see below). While not required - the user can still attempt to publish a dataset with an unreserved DOI - having all the identifiers reserved ahead of time is recommended. If you are upgrading an installation that uses DataCite, we specifically recommend that you reserve the DOIs for all your pre-existing unpublished drafts as soon as Dataverse v5.0 is deployed, since none of them were registered at create time. This can be done using the following API calls:  \n+\n+- `/api/pids/unreserved`  will report the ids of the datasets\n+- `/api/pids/:persistentId/reserve` reserves the assigned DOI with DataCite (will need to be run on every id reported by the the first API).\n+\n+See the [Native API Guide](http://guides.dataverse.org/en/5.0/api/native-api.html) for more information.\n+\n+Scripted, the whole process would look as follows (adjust as needed):\n+\n+```\n+   API_TOKEN='xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'\n+\n+   curl -s -H \"X-Dataverse-key:$API_TOKEN\" http://localhost:8080/api/pids/unreserved |\n+   # the API outputs JSON; note the use of jq to parse it:\n+   jq '.data.count[].pid' | tr -d '\"' | \n+   while read doi\n+   do\n+      curl -s -H \"X-Dataverse-key:$API_TOKEN\" -X POST http://localhost:8080/api/pids/:persistentId/reserve?persistentId=$doi\n+   done\n+```\n+\n+Going forward, once all the DOIs have been reserved for the legacy drafts, you may still get an occasional dataset with an unreserved identifier. DataCite service instability would be a potential cause. There is no reason to expect that to happen often, but it is not impossible. You may consider running the script above (perhaps with some extra diagnostics added) regularly, from a cron job or otherwise, to address this preemptively.\n+\n+### Datafiles Validation when Publishing Datasets\n+\n+When a user requests to publish a dataset, Dataverse will now attempt to validate the physical files in the dataset, by recalculating the checksums and verifying them against the values in the database. The goal is to prevent any corrupted files in published datasets. Most of all the instances of actual damage to physical files that we've seen in the past happened while the datafiles were still in the Draft state. (Physical files become essentially read-only once published). So this is the logical place to catch any such issues.\n+\n+If any files in the dataset fail the validation, the dataset does not get published, and the user is notified that they need to contact their Dataverse support in order to address the issue before another attempt to publish can be made. See the \"Troubleshooting\" section of the Guide on how to fix such problems.\n+\n+For datasets with large numbers of files, this validation will be performed asynchronously, using the same mechanism as for the registration of the file-level global ids. The cutoff number of files is configured by the same database setting. Similarly to the file PID registration, this validation process can be disabled on your system, with the setting `:FileValidationOnPublishEnabled`. (A Dataverse admin may choose to disable it if, for example, they are already running an external auditing system to monitor the integrity of the files in their Dataverse, and would prefer the publishing process to take less time). See the Config section of the Installation guide for more info.\n+\n+Please note that we are not aware of any bugs in the current versions of Dataverse that would result in damage to users' files. But you may have some legacy files in your archive that were affected by some issue in the past, or perhaps affected by something outside Dataverse, so we are adding this feature out of abundance of caution. An example of a problem we've experienced in the early versions of Dataverse was a possible scenario where a user actually attempted to delete a Draft file from an unpublished version, where the database transaction would fail for whatever reason, but only after the physical file had already been deleted from the filesystem. Thus resulting in a datafile entry remaining in the dataset, but with the corresponding physical file missing. (the fix for this case, since the user wanted to delete the file in the first place, is simply to confirm it and purge the datafile entity from the database).\n+\n+### The setting :PIDAsynchRegFileCount is deprecated as of v5.0\n+\n+It used to specify the number of datafiles in the dataset to warrant adding a lock during publishing. As of v5.0 all datasets get locked for the duration of the publishing process. The setting will be ignored if present.\n+\n+### Location Changes for Related Projects\n+\n+The dataverse-ansible and dataverse-previewers repositories have been moved to the GDCC Organization on GitHub. If you have been referencing the dataverse-ansible repository from IQSS and the dataverse-previewers from QDR, please instead use them from their new locations:\n+\n+<https://github.com/GlobalDataverseCommunityConsortium/dataverse-ansible>\n+<https://github.com/GlobalDataverseCommunityConsortium/dataverse-previewers>\n+\n+### Harvesting Improvements\n+\n+Many updates have been made to address common Harvesting failures. You may see Harvests complete more often and have a higher success rate on a dataset-by-dataset basis.\n+\n+### New JVM Options and Database Settings\n+\n+Several new JVM options and DB Settings have been added in this release. More documentation about each of these settings can be found in the Configuration section of the [Installation Guide](http://guides.dataverse.org/en/5.0/installation/config.rst).\n+\n+#### New JVM Options\n+\n+- :doi.baseurlstringnext: Set with a value of \"https://api.datacite.org\" for production environments and \"https://api.test.datacite.org\" for test environments. Must be set if you are using DataCite as your DOI provider.\n+- :dataverse.useripaddresssourceheader: If set, specifies an HTTP Header such as X-Forwarded-For to use to retrieve the user's IP address. This setting is useful in cases such as running Dataverse behind load balancers where the default option of getting the Remote Address from the servlet isn't correct (e.g. it would be the load balancer IP address). Note that unless your installation always sets the header you configure here, this could be used as a way to spoof the user's address.\n+- :FileValidationOnPublishEnabled: Toggles validation of the physical files in the dataset when it's published, by recalculating the checksums and comparing against the values stored in the DataFile table. By default this setting is absent and Dataverse assumes it to be true. If enabled, the validation will be performed asynchronously, similarly to how we handle assigning persistent identifiers to datafiles, with the dataset locked for the duration of the publishing process.\n+- :http.request-timeout-seconds: To facilitate large file upload and download, the Dataverse installer bumps the Payara **server-config.network-config.protocols.protocol.http-listener-1.http.request-timeout-seconds** setting from its default 900 seconds (15 minutes) to 1800 (30 minutes).\n+\n+#### New Database Settings\n+\n+- :CustomZipDownloadServiceUrl: If defined, this is the URL of the zipping service outside the main Application Service where zip downloads should be directed (instead of /api/access/datafiles/).\n+- :ShibAttributeCharacterSetConversionEnabled: By default, all attributes received from Shibboleth are converted from ISO-8859-1 to UTF-8. You can disable this behavior by setting to false.\n+- :ChronologicalDateFacets: Facets with Date/Year are sorted chronologically by default, with the most recent value first. To have them sorted by number of hits, e.g. with the year with the most results first, set this to false.\n+- :NavbarGuidesUrl: Set to a fully-qualified URL which will be used for the \"User Guide\" link in the navbar.\n+\n+### Custom Analytics Code Changes\n+\n+You should update your custom analytics code to implement necessary changes for tracking updated dataset and file buttons. There was also a fix to the analytics code that will now properly track downloads for tabular files.\n+\n+We have updated the documentation and sample analytics code snippet provided in [Installation Guide > Configuration > Web Analytics Code](http://guides.dataverse.org/en/5.0/installation/config.html#web-analytics-code) to reflect the changes implemented in this version (#6938/#6684).", "originalCommit": "b7c947a6381a1bef87cead90f7a169798aeb2de6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4OTEyNA==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r466689124", "bodyText": "This is the other non Title Case I mentioned above.", "author": "pdurbin", "createdAt": "2020-08-06T21:12:18Z", "path": "doc/release-notes/5.0-release-notes.md", "diffHunk": "@@ -0,0 +1,313 @@\n+# Dataverse 5.0\n+\n+This release brings new features, enhancements, and bug fixes to Dataverse. Thank you to all of the community members who contributed code, suggestions, bug reports, and other assistance across the project.\n+\n+Please note that this is a major release and these are long release notes. We offer no apologies. :)\n+\n+## Release Highlights\n+\n+### Continued Dataset and File Redesign: Dataset and File Button Redesign, Responsive Layout\n+\n+The buttons available on the Dataset and File pages have been redesigned. This change is to provide more scalability for future expanded options for data access and exploration, and to provide a consistent experience between the two pages. The dataset and file pages have also be redesigned to be more responsive and function better across multiple devices.\n+\n+This is an important step in the incremental process of the Dataset and File Redesign, following the release of on-page previews, filtering and sorting options, tree view, and other enhancements. Additional features in support of these redesign efforts will follow in later 5.x releases.\n+\n+### Payara 5\n+\n+A major upgrade of the application server provides security updates, access to new features like MicroProfile Config API, and will enable eagerly anticipated upgrades to other core technologies.\n+\n+Note that moving from Glassfish to Payara will be required as part of the move to Dataverse 5. If your installation upgrades to Dataverse 5 without upgrading to Payara, the first step of any troubleshooting will be to suggest an upgrade to Payara.\n+\n+### Primefaces 8\n+\n+Primefaces, the open source UI framework upon which the Dataverse front end is built, has been updated to the most recent version. This provides security updates and bug fixes and will also allow Dataverse developers to take advantage of new features and enhancements.\n+\n+### Download Dataset\n+\n+Users can now more easily Download all files in Dataset. If this causes server instability, it's suggested that Dataverse Installation Administrators take advantage of the new Standalone Zipper Service described below.\n+\n+#### Download All Option on the Dataset Page\n+\n+In previous versions of Dataverse, downloading all files from a dataset meant several clicks to select files and initiate the download. The Dataset Page now includes a Download All option for both the original and archival formats of the files in a dataset under the \"Access Dataset\" button.\n+\n+#### Download All API\n+\n+In previous versions of Dataverse, downloading all files from a dataset via API was a two step process:\n+\n+- Find all the database id of the files.\n+- Download all the files, using those ids (comma-separated).\n+\n+Now you can download all files from a dataset (assuming you have access to them) via API by passing the dataset persistent ID (PID such as DOI or Handle) or the dataset's database id. Versions are also supported like with the \"download metadata\" API you can pass :draft, :latest, :latest-published, or numbers (1.1, 2.0).\n+\n+### A Multi-File, Zipped Download Optimization\n+\n+In this release we are offering an experimental optimization for the multi-file, download-as-zip functionality. If this option is enabled, instead of enforcing size limits, we attempt to serve all the files that the user requested (that they are authorized to download), but the request is redirected to a standalone zipper service running as a cgi executable. Thus moving these potentially long-running jobs completely outside the Application Server (Payara); and preventing service threads from becoming locked serving them. Since zipping is also a CPU-intensive task, it is possible to have this service running on a different host system, thus freeing the cycles on the main Application Server. The system running the service needs to have access to the database as well as to the storage filesystem, and/or S3 bucket.\n+\n+Please consult the scripts/zipdownload/README.md in the Dataverse 5 source tree.\n+\n+The components of the standalone \"zipper tool\" can also be downloaded\n+here:\n+\n+XXXXX\n+\n+(my plan is to build the executable and to add it to the v5\n+release files on github: - L.A.)\n+<https://github.com/IQSS/dataverse/releases/download/v5.0/zipper.zip>.\n+\n+### Updated File Handling\n+\n+Files without extensions can now be uploaded through the UI. This release also changes the way Dataverse handles duplicate (filename or checksum) files in a dataset. Specifically:\n+\n+- Files with the same checksum can be included in a dataset, even if the files are in the same directory.\n+- Files with the same filename can be included in a dataset as long as the files are in different directories.\n+- If a user uploads a file to a directory where a file already exists with that directory/filename combination, Dataverse will adjust the file path and names by adding \"-1\" or \"-2\" as applicable. This change will be visible in the list of files being uploaded.\n+- If the directory or name of an existing or newly uploaded file is edited in such a way that would create a directory/filename combination that already exists, Dataverse will display an error.\n+- If a user attempts to replace a file with another file that has the same checksum, an error message will be displayed and the file will not be able to be replaced.\n+- If a user attempts to replace a file with a file that has the same checksum as a different file in the dataset, a warning will be displayed.\n+- Files without extensions can now be uploaded through the UI.\n+\n+### Pre-Publish DOI Reservation with DataCite\n+\n+Dataverse Installations using DataCite will have DOIs reserved as \"Draft\" with DataCite when the Dataset is created, instead of the reservation taking place locally at create time and the reservation taking place with DataCite at publish time. This allows the DOI to reserved earlier in the publication process.\n+\n+## Major Use Cases\n+\n+Newly-supported use cases in this release include:\n+\n+- Users will be presented with a new workflow around dataset and file access and exploration. (Issue #6684, PR #6909)\n+- Users will experience a UI appropriate across a variety of device sizes. (Issue #6684, PR #6909)\n+- Users will be able to download an entire dataset without needing to select all the files in that dataset. (Issue #6564, PR #6262)\n+- Users will be able to download a dataset with a single API call. (Issue #4529, PR #7086)\n+- Users will have DOIs reserved for their datasets upon dataset create instead of at publish time. (Issue #5093, PR #6901)\n+- Users will be able to upload files without extensions. (Issue #6634, PR #6804)\n+- Users will be able to upload files with the same name in a dataset, as long as a those files are in different file paths. (Issue #4813, PR #6924)\n+- Users will be able to upload files with the same checksum in a dataset. (Issue #4813, PR #6924)\n+- Users will be less likely to encounter locks during the publishing process due to PID providers being unavailable. (Issue #6918, PR #7118)\n+- Users will now have their files validated during publish, and in the unlikely event that anything has happened to the files between deposit and publish, they will be able to take corrective action. (Issue #6558, PR #6790)\n+- Administrators will likely see more success with Harvesting, as many minor harvesting issues have been resolved. (Issues #7127, #7128, #4597, #7056, #7052, #7023, #7009, and #7003)\n+- Administrators can now enable an external zip service that frees up application server resources and allows the zip download limit to be increased. (Issue #6505, PR #6986)\n+- Administrators can now create groups based on users' email domains. (Issue #6936, PR #6974)\n+- Administrators can now set date facets to be organized chronologically. (Issue #4977, PR #6958)\n+- Administrators can now link harvested datasets using an API. (Issue #5886, PR #6935)\n+- Administrators can now destroy datasets with mapped shapefiles. (Issue #4093, PR #6860)\n+\n+## Notes for Dataverse Installation Administrators\n+\n+### Glassfish to Payara\n+\n+This upgrade requires a few extra steps. See the detailed upgrade instructions below.\n+\n+### Dataverse Installations Using DataCite: Upgrade Action Recommended\n+\n+For installations that are using DataCite, Dataverse v5.0 introduces a change in the process of registering the Persistent Identifier (DOI) for a dataset. Instead of registering it when the dataset is published for the first time, Dataverse will try to \"reserve\" the DOI when it's created (by registering it as a \"draft\", using DataCite terminology). When the user publishes the dataset, the DOI will be publicized as well (by switching the registration status to \"findable\"). This approach makes the process of publishing datasets simpler and less error-prone.\n+\n+New APIs have been provided for finding any unreserved DataCite-issued DOIs in your Dataverse, and for reserving them (see below). While not required - the user can still attempt to publish a dataset with an unreserved DOI - having all the identifiers reserved ahead of time is recommended. If you are upgrading an installation that uses DataCite, we specifically recommend that you reserve the DOIs for all your pre-existing unpublished drafts as soon as Dataverse v5.0 is deployed, since none of them were registered at create time. This can be done using the following API calls:  \n+\n+- `/api/pids/unreserved`  will report the ids of the datasets\n+- `/api/pids/:persistentId/reserve` reserves the assigned DOI with DataCite (will need to be run on every id reported by the the first API).\n+\n+See the [Native API Guide](http://guides.dataverse.org/en/5.0/api/native-api.html) for more information.\n+\n+Scripted, the whole process would look as follows (adjust as needed):\n+\n+```\n+   API_TOKEN='xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'\n+\n+   curl -s -H \"X-Dataverse-key:$API_TOKEN\" http://localhost:8080/api/pids/unreserved |\n+   # the API outputs JSON; note the use of jq to parse it:\n+   jq '.data.count[].pid' | tr -d '\"' | \n+   while read doi\n+   do\n+      curl -s -H \"X-Dataverse-key:$API_TOKEN\" -X POST http://localhost:8080/api/pids/:persistentId/reserve?persistentId=$doi\n+   done\n+```\n+\n+Going forward, once all the DOIs have been reserved for the legacy drafts, you may still get an occasional dataset with an unreserved identifier. DataCite service instability would be a potential cause. There is no reason to expect that to happen often, but it is not impossible. You may consider running the script above (perhaps with some extra diagnostics added) regularly, from a cron job or otherwise, to address this preemptively.\n+\n+### Datafiles Validation when Publishing Datasets\n+\n+When a user requests to publish a dataset, Dataverse will now attempt to validate the physical files in the dataset, by recalculating the checksums and verifying them against the values in the database. The goal is to prevent any corrupted files in published datasets. Most of all the instances of actual damage to physical files that we've seen in the past happened while the datafiles were still in the Draft state. (Physical files become essentially read-only once published). So this is the logical place to catch any such issues.\n+\n+If any files in the dataset fail the validation, the dataset does not get published, and the user is notified that they need to contact their Dataverse support in order to address the issue before another attempt to publish can be made. See the \"Troubleshooting\" section of the Guide on how to fix such problems.\n+\n+For datasets with large numbers of files, this validation will be performed asynchronously, using the same mechanism as for the registration of the file-level global ids. The cutoff number of files is configured by the same database setting. Similarly to the file PID registration, this validation process can be disabled on your system, with the setting `:FileValidationOnPublishEnabled`. (A Dataverse admin may choose to disable it if, for example, they are already running an external auditing system to monitor the integrity of the files in their Dataverse, and would prefer the publishing process to take less time). See the Config section of the Installation guide for more info.\n+\n+Please note that we are not aware of any bugs in the current versions of Dataverse that would result in damage to users' files. But you may have some legacy files in your archive that were affected by some issue in the past, or perhaps affected by something outside Dataverse, so we are adding this feature out of abundance of caution. An example of a problem we've experienced in the early versions of Dataverse was a possible scenario where a user actually attempted to delete a Draft file from an unpublished version, where the database transaction would fail for whatever reason, but only after the physical file had already been deleted from the filesystem. Thus resulting in a datafile entry remaining in the dataset, but with the corresponding physical file missing. (the fix for this case, since the user wanted to delete the file in the first place, is simply to confirm it and purge the datafile entity from the database).\n+\n+### The setting :PIDAsynchRegFileCount is deprecated as of v5.0\n+\n+It used to specify the number of datafiles in the dataset to warrant adding a lock during publishing. As of v5.0 all datasets get locked for the duration of the publishing process. The setting will be ignored if present.\n+\n+### Location Changes for Related Projects\n+\n+The dataverse-ansible and dataverse-previewers repositories have been moved to the GDCC Organization on GitHub. If you have been referencing the dataverse-ansible repository from IQSS and the dataverse-previewers from QDR, please instead use them from their new locations:\n+\n+<https://github.com/GlobalDataverseCommunityConsortium/dataverse-ansible>\n+<https://github.com/GlobalDataverseCommunityConsortium/dataverse-previewers>\n+\n+### Harvesting Improvements\n+\n+Many updates have been made to address common Harvesting failures. You may see Harvests complete more often and have a higher success rate on a dataset-by-dataset basis.\n+\n+### New JVM Options and Database Settings\n+\n+Several new JVM options and DB Settings have been added in this release. More documentation about each of these settings can be found in the Configuration section of the [Installation Guide](http://guides.dataverse.org/en/5.0/installation/config.rst).\n+\n+#### New JVM Options\n+\n+- :doi.baseurlstringnext: Set with a value of \"https://api.datacite.org\" for production environments and \"https://api.test.datacite.org\" for test environments. Must be set if you are using DataCite as your DOI provider.\n+- :dataverse.useripaddresssourceheader: If set, specifies an HTTP Header such as X-Forwarded-For to use to retrieve the user's IP address. This setting is useful in cases such as running Dataverse behind load balancers where the default option of getting the Remote Address from the servlet isn't correct (e.g. it would be the load balancer IP address). Note that unless your installation always sets the header you configure here, this could be used as a way to spoof the user's address.\n+- :FileValidationOnPublishEnabled: Toggles validation of the physical files in the dataset when it's published, by recalculating the checksums and comparing against the values stored in the DataFile table. By default this setting is absent and Dataverse assumes it to be true. If enabled, the validation will be performed asynchronously, similarly to how we handle assigning persistent identifiers to datafiles, with the dataset locked for the duration of the publishing process.\n+- :http.request-timeout-seconds: To facilitate large file upload and download, the Dataverse installer bumps the Payara **server-config.network-config.protocols.protocol.http-listener-1.http.request-timeout-seconds** setting from its default 900 seconds (15 minutes) to 1800 (30 minutes).\n+\n+#### New Database Settings\n+\n+- :CustomZipDownloadServiceUrl: If defined, this is the URL of the zipping service outside the main Application Service where zip downloads should be directed (instead of /api/access/datafiles/).\n+- :ShibAttributeCharacterSetConversionEnabled: By default, all attributes received from Shibboleth are converted from ISO-8859-1 to UTF-8. You can disable this behavior by setting to false.\n+- :ChronologicalDateFacets: Facets with Date/Year are sorted chronologically by default, with the most recent value first. To have them sorted by number of hits, e.g. with the year with the most results first, set this to false.\n+- :NavbarGuidesUrl: Set to a fully-qualified URL which will be used for the \"User Guide\" link in the navbar.\n+\n+### Custom Analytics Code Changes\n+\n+You should update your custom analytics code to implement necessary changes for tracking updated dataset and file buttons. There was also a fix to the analytics code that will now properly track downloads for tabular files.\n+\n+We have updated the documentation and sample analytics code snippet provided in [Installation Guide > Configuration > Web Analytics Code](http://guides.dataverse.org/en/5.0/installation/config.html#web-analytics-code) to reflect the changes implemented in this version (#6938/#6684).\n+\n+### Tracking users' IP addresses behind an address-masking proxy", "originalCommit": "b7c947a6381a1bef87cead90f7a169798aeb2de6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY5MTY0Ng==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r466691646", "bodyText": "THese jvm options also don't get a leading ':' like settings do they?", "author": "qqmyers", "createdAt": "2020-08-06T21:18:16Z", "path": "doc/release-notes/5.0-release-notes.md", "diffHunk": "@@ -0,0 +1,313 @@\n+# Dataverse 5.0\n+\n+This release brings new features, enhancements, and bug fixes to Dataverse. Thank you to all of the community members who contributed code, suggestions, bug reports, and other assistance across the project.\n+\n+Please note that this is a major release and these are long release notes. We offer no apologies. :)\n+\n+## Release Highlights\n+\n+### Continued Dataset and File Redesign: Dataset and File Button Redesign, Responsive Layout\n+\n+The buttons available on the Dataset and File pages have been redesigned. This change is to provide more scalability for future expanded options for data access and exploration, and to provide a consistent experience between the two pages. The dataset and file pages have also be redesigned to be more responsive and function better across multiple devices.\n+\n+This is an important step in the incremental process of the Dataset and File Redesign, following the release of on-page previews, filtering and sorting options, tree view, and other enhancements. Additional features in support of these redesign efforts will follow in later 5.x releases.\n+\n+### Payara 5\n+\n+A major upgrade of the application server provides security updates, access to new features like MicroProfile Config API, and will enable eagerly anticipated upgrades to other core technologies.\n+\n+Note that moving from Glassfish to Payara will be required as part of the move to Dataverse 5. If your installation upgrades to Dataverse 5 without upgrading to Payara, the first step of any troubleshooting will be to suggest an upgrade to Payara.\n+\n+### Primefaces 8\n+\n+Primefaces, the open source UI framework upon which the Dataverse front end is built, has been updated to the most recent version. This provides security updates and bug fixes and will also allow Dataverse developers to take advantage of new features and enhancements.\n+\n+### Download Dataset\n+\n+Users can now more easily Download all files in Dataset. If this causes server instability, it's suggested that Dataverse Installation Administrators take advantage of the new Standalone Zipper Service described below.\n+\n+#### Download All Option on the Dataset Page\n+\n+In previous versions of Dataverse, downloading all files from a dataset meant several clicks to select files and initiate the download. The Dataset Page now includes a Download All option for both the original and archival formats of the files in a dataset under the \"Access Dataset\" button.\n+\n+#### Download All API\n+\n+In previous versions of Dataverse, downloading all files from a dataset via API was a two step process:\n+\n+- Find all the database id of the files.\n+- Download all the files, using those ids (comma-separated).\n+\n+Now you can download all files from a dataset (assuming you have access to them) via API by passing the dataset persistent ID (PID such as DOI or Handle) or the dataset's database id. Versions are also supported like with the \"download metadata\" API you can pass :draft, :latest, :latest-published, or numbers (1.1, 2.0).\n+\n+### A Multi-File, Zipped Download Optimization\n+\n+In this release we are offering an experimental optimization for the multi-file, download-as-zip functionality. If this option is enabled, instead of enforcing size limits, we attempt to serve all the files that the user requested (that they are authorized to download), but the request is redirected to a standalone zipper service running as a cgi executable. Thus moving these potentially long-running jobs completely outside the Application Server (Payara); and preventing service threads from becoming locked serving them. Since zipping is also a CPU-intensive task, it is possible to have this service running on a different host system, thus freeing the cycles on the main Application Server. The system running the service needs to have access to the database as well as to the storage filesystem, and/or S3 bucket.\n+\n+Please consult the scripts/zipdownload/README.md in the Dataverse 5 source tree.\n+\n+The components of the standalone \"zipper tool\" can also be downloaded\n+here:\n+\n+XXXXX\n+\n+(my plan is to build the executable and to add it to the v5\n+release files on github: - L.A.)\n+<https://github.com/IQSS/dataverse/releases/download/v5.0/zipper.zip>.\n+\n+### Updated File Handling\n+\n+Files without extensions can now be uploaded through the UI. This release also changes the way Dataverse handles duplicate (filename or checksum) files in a dataset. Specifically:\n+\n+- Files with the same checksum can be included in a dataset, even if the files are in the same directory.\n+- Files with the same filename can be included in a dataset as long as the files are in different directories.\n+- If a user uploads a file to a directory where a file already exists with that directory/filename combination, Dataverse will adjust the file path and names by adding \"-1\" or \"-2\" as applicable. This change will be visible in the list of files being uploaded.\n+- If the directory or name of an existing or newly uploaded file is edited in such a way that would create a directory/filename combination that already exists, Dataverse will display an error.\n+- If a user attempts to replace a file with another file that has the same checksum, an error message will be displayed and the file will not be able to be replaced.\n+- If a user attempts to replace a file with a file that has the same checksum as a different file in the dataset, a warning will be displayed.\n+- Files without extensions can now be uploaded through the UI.\n+\n+### Pre-Publish DOI Reservation with DataCite\n+\n+Dataverse Installations using DataCite will have DOIs reserved as \"Draft\" with DataCite when the Dataset is created, instead of the reservation taking place locally at create time and the reservation taking place with DataCite at publish time. This allows the DOI to reserved earlier in the publication process.\n+\n+## Major Use Cases\n+\n+Newly-supported use cases in this release include:\n+\n+- Users will be presented with a new workflow around dataset and file access and exploration. (Issue #6684, PR #6909)\n+- Users will experience a UI appropriate across a variety of device sizes. (Issue #6684, PR #6909)\n+- Users will be able to download an entire dataset without needing to select all the files in that dataset. (Issue #6564, PR #6262)\n+- Users will be able to download a dataset with a single API call. (Issue #4529, PR #7086)\n+- Users will have DOIs reserved for their datasets upon dataset create instead of at publish time. (Issue #5093, PR #6901)\n+- Users will be able to upload files without extensions. (Issue #6634, PR #6804)\n+- Users will be able to upload files with the same name in a dataset, as long as a those files are in different file paths. (Issue #4813, PR #6924)\n+- Users will be able to upload files with the same checksum in a dataset. (Issue #4813, PR #6924)\n+- Users will be less likely to encounter locks during the publishing process due to PID providers being unavailable. (Issue #6918, PR #7118)\n+- Users will now have their files validated during publish, and in the unlikely event that anything has happened to the files between deposit and publish, they will be able to take corrective action. (Issue #6558, PR #6790)\n+- Administrators will likely see more success with Harvesting, as many minor harvesting issues have been resolved. (Issues #7127, #7128, #4597, #7056, #7052, #7023, #7009, and #7003)\n+- Administrators can now enable an external zip service that frees up application server resources and allows the zip download limit to be increased. (Issue #6505, PR #6986)\n+- Administrators can now create groups based on users' email domains. (Issue #6936, PR #6974)\n+- Administrators can now set date facets to be organized chronologically. (Issue #4977, PR #6958)\n+- Administrators can now link harvested datasets using an API. (Issue #5886, PR #6935)\n+- Administrators can now destroy datasets with mapped shapefiles. (Issue #4093, PR #6860)\n+\n+## Notes for Dataverse Installation Administrators\n+\n+### Glassfish to Payara\n+\n+This upgrade requires a few extra steps. See the detailed upgrade instructions below.\n+\n+### Dataverse Installations Using DataCite: Upgrade Action Recommended\n+\n+For installations that are using DataCite, Dataverse v5.0 introduces a change in the process of registering the Persistent Identifier (DOI) for a dataset. Instead of registering it when the dataset is published for the first time, Dataverse will try to \"reserve\" the DOI when it's created (by registering it as a \"draft\", using DataCite terminology). When the user publishes the dataset, the DOI will be publicized as well (by switching the registration status to \"findable\"). This approach makes the process of publishing datasets simpler and less error-prone.\n+\n+New APIs have been provided for finding any unreserved DataCite-issued DOIs in your Dataverse, and for reserving them (see below). While not required - the user can still attempt to publish a dataset with an unreserved DOI - having all the identifiers reserved ahead of time is recommended. If you are upgrading an installation that uses DataCite, we specifically recommend that you reserve the DOIs for all your pre-existing unpublished drafts as soon as Dataverse v5.0 is deployed, since none of them were registered at create time. This can be done using the following API calls:  \n+\n+- `/api/pids/unreserved`  will report the ids of the datasets\n+- `/api/pids/:persistentId/reserve` reserves the assigned DOI with DataCite (will need to be run on every id reported by the the first API).\n+\n+See the [Native API Guide](http://guides.dataverse.org/en/5.0/api/native-api.html) for more information.\n+\n+Scripted, the whole process would look as follows (adjust as needed):\n+\n+```\n+   API_TOKEN='xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'\n+\n+   curl -s -H \"X-Dataverse-key:$API_TOKEN\" http://localhost:8080/api/pids/unreserved |\n+   # the API outputs JSON; note the use of jq to parse it:\n+   jq '.data.count[].pid' | tr -d '\"' | \n+   while read doi\n+   do\n+      curl -s -H \"X-Dataverse-key:$API_TOKEN\" -X POST http://localhost:8080/api/pids/:persistentId/reserve?persistentId=$doi\n+   done\n+```\n+\n+Going forward, once all the DOIs have been reserved for the legacy drafts, you may still get an occasional dataset with an unreserved identifier. DataCite service instability would be a potential cause. There is no reason to expect that to happen often, but it is not impossible. You may consider running the script above (perhaps with some extra diagnostics added) regularly, from a cron job or otherwise, to address this preemptively.\n+\n+### Datafiles Validation when Publishing Datasets\n+\n+When a user requests to publish a dataset, Dataverse will now attempt to validate the physical files in the dataset, by recalculating the checksums and verifying them against the values in the database. The goal is to prevent any corrupted files in published datasets. Most of all the instances of actual damage to physical files that we've seen in the past happened while the datafiles were still in the Draft state. (Physical files become essentially read-only once published). So this is the logical place to catch any such issues.\n+\n+If any files in the dataset fail the validation, the dataset does not get published, and the user is notified that they need to contact their Dataverse support in order to address the issue before another attempt to publish can be made. See the \"Troubleshooting\" section of the Guide on how to fix such problems.\n+\n+For datasets with large numbers of files, this validation will be performed asynchronously, using the same mechanism as for the registration of the file-level global ids. The cutoff number of files is configured by the same database setting. Similarly to the file PID registration, this validation process can be disabled on your system, with the setting `:FileValidationOnPublishEnabled`. (A Dataverse admin may choose to disable it if, for example, they are already running an external auditing system to monitor the integrity of the files in their Dataverse, and would prefer the publishing process to take less time). See the Config section of the Installation guide for more info.\n+\n+Please note that we are not aware of any bugs in the current versions of Dataverse that would result in damage to users' files. But you may have some legacy files in your archive that were affected by some issue in the past, or perhaps affected by something outside Dataverse, so we are adding this feature out of abundance of caution. An example of a problem we've experienced in the early versions of Dataverse was a possible scenario where a user actually attempted to delete a Draft file from an unpublished version, where the database transaction would fail for whatever reason, but only after the physical file had already been deleted from the filesystem. Thus resulting in a datafile entry remaining in the dataset, but with the corresponding physical file missing. (the fix for this case, since the user wanted to delete the file in the first place, is simply to confirm it and purge the datafile entity from the database).\n+\n+### The setting :PIDAsynchRegFileCount is deprecated as of v5.0\n+\n+It used to specify the number of datafiles in the dataset to warrant adding a lock during publishing. As of v5.0 all datasets get locked for the duration of the publishing process. The setting will be ignored if present.\n+\n+### Location Changes for Related Projects\n+\n+The dataverse-ansible and dataverse-previewers repositories have been moved to the GDCC Organization on GitHub. If you have been referencing the dataverse-ansible repository from IQSS and the dataverse-previewers from QDR, please instead use them from their new locations:\n+\n+<https://github.com/GlobalDataverseCommunityConsortium/dataverse-ansible>\n+<https://github.com/GlobalDataverseCommunityConsortium/dataverse-previewers>\n+\n+### Harvesting Improvements\n+\n+Many updates have been made to address common Harvesting failures. You may see Harvests complete more often and have a higher success rate on a dataset-by-dataset basis.\n+\n+### New JVM Options and Database Settings\n+\n+Several new JVM options and DB Settings have been added in this release. More documentation about each of these settings can be found in the Configuration section of the [Installation Guide](http://guides.dataverse.org/en/5.0/installation/config.rst).\n+\n+#### New JVM Options\n+\n+- :doi.baseurlstringnext: Set with a value of \"https://api.datacite.org\" for production environments and \"https://api.test.datacite.org\" for test environments. Must be set if you are using DataCite as your DOI provider.\n+- :dataverse.useripaddresssourceheader: If set, specifies an HTTP Header such as X-Forwarded-For to use to retrieve the user's IP address. This setting is useful in cases such as running Dataverse behind load balancers where the default option of getting the Remote Address from the servlet isn't correct (e.g. it would be the load balancer IP address). Note that unless your installation always sets the header you configure here, this could be used as a way to spoof the user's address.", "originalCommit": "b7c947a6381a1bef87cead90f7a169798aeb2de6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA1NzQ2OA==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r467057468", "bodyText": "Only in @djbrooke's release note world. I'll update.", "author": "djbrooke", "createdAt": "2020-08-07T13:57:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY5MTY0Ng=="}], "type": "inlineReview"}, {"oid": "d224ce718171aefd34825d57ed72054bdb2ecb01", "url": "https://github.com/IQSS/dataverse/commit/d224ce718171aefd34825d57ed72054bdb2ecb01", "message": "moving primefaces down", "committedDate": "2020-08-07T13:23:16Z", "type": "commit"}, {"oid": "f65d2fb5349b16482df5d207acf289e236b743b2", "url": "https://github.com/IQSS/dataverse/commit/f65d2fb5349b16482df5d207acf289e236b743b2", "message": "CR feedback updates", "committedDate": "2020-08-07T13:34:45Z", "type": "commit"}, {"oid": "20ed3d674ed2b19b5e781cb652c60f268176af28", "url": "https://github.com/IQSS/dataverse/commit/20ed3d674ed2b19b5e781cb652c60f268176af28", "message": "code review feedback updates", "committedDate": "2020-08-07T13:50:02Z", "type": "commit"}, {"oid": "979ca401bb52a7e7bcf7adfc45e151cf548e3990", "url": "https://github.com/IQSS/dataverse/commit/979ca401bb52a7e7bcf7adfc45e151cf548e3990", "message": "last code review updates (for now)", "committedDate": "2020-08-07T13:58:31Z", "type": "commit"}, {"oid": "3f9cb083a7499594b02c3f429986bf7a2d7feee1", "url": "https://github.com/IQSS/dataverse/commit/3f9cb083a7499594b02c3f429986bf7a2d7feee1", "message": "Update 5.0-release-notes.md", "committedDate": "2020-08-07T15:15:28Z", "type": "commit"}, {"oid": "8db25a3f6be56d4b88a7c5480bb2dac973b0c720", "url": "https://github.com/IQSS/dataverse/commit/8db25a3f6be56d4b88a7c5480bb2dac973b0c720", "message": "Update 5.0-release-notes.md", "committedDate": "2020-08-07T15:15:38Z", "type": "commit"}, {"oid": "5401444f37c7bb4b7d12b0824e2d06e5612ae17a", "url": "https://github.com/IQSS/dataverse/commit/5401444f37c7bb4b7d12b0824e2d06e5612ae17a", "message": "Merge branch 'develop' into 7046-dataverse-5-release-notes", "committedDate": "2020-08-10T19:35:51Z", "type": "commit"}, {"oid": "5c6c78341043e84ff22736de18b36e0af1d82790", "url": "https://github.com/IQSS/dataverse/commit/5c6c78341043e84ff22736de18b36e0af1d82790", "message": "Merge branch 'develop' into 7046-dataverse-5-release-notes", "committedDate": "2020-08-12T14:26:12Z", "type": "commit"}, {"oid": "321df8849cd5e5a89dd0a5a04f934f2e6c99f7d6", "url": "https://github.com/IQSS/dataverse/commit/321df8849cd5e5a89dd0a5a04f934f2e6c99f7d6", "message": "adding notes about doi.dataciterestapiurlstring", "committedDate": "2020-08-12T14:32:36Z", "type": "commit"}, {"oid": "8554fbc29deb2606f3377860937ac5be923f2ed1", "url": "https://github.com/IQSS/dataverse/commit/8554fbc29deb2606f3377860937ac5be923f2ed1", "message": "Merge branch 'develop' into 7046-dataverse-5-release-notes", "committedDate": "2020-08-13T19:00:28Z", "type": "commit"}, {"oid": "5aa2c6a87b0bed28ff453b36fe6e7f678d460fa7", "url": "https://github.com/IQSS/dataverse/commit/5aa2c6a87b0bed28ff453b36fe6e7f678d460fa7", "message": "integrating notes from I18N ToU PR", "committedDate": "2020-08-13T19:02:09Z", "type": "commit"}, {"oid": "c0d1572deb7e8d2b20315436f011434a5deda443", "url": "https://github.com/IQSS/dataverse/commit/c0d1572deb7e8d2b20315436f011434a5deda443", "message": "download link for the zipper tool", "committedDate": "2020-08-13T20:49:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI1MDc2Mg==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r470250762", "bodyText": "crap, I've typed, and lost a comment here twice in a row... there may be something wrong with this paragraph: it appears to be saying \"dataverse will be reserving the DOI at create time, instead of reserving it at create time\"? - maybe not (it says \"locally\" in the second part?) - but there may be simply TMI in it. I would leave the technical details (about \"findable\" and \"draft\" etc.) in the upgrade instruction further down; but only say\n\"Dataverse installations using DataCite will be able to reserve the persistent identifiers for datasets ahead of publishing time.\" - or something along these lines - in this part of the release note?", "author": "landreev", "createdAt": "2020-08-13T21:11:19Z", "path": "doc/release-notes/5.0-release-notes.md", "diffHunk": "@@ -0,0 +1,321 @@\n+# Dataverse 5.0\n+\n+This release brings new features, enhancements, and bug fixes to Dataverse. Thank you to all of the community members who contributed code, suggestions, bug reports, and other assistance across the project.\n+\n+Please note that this is a major release and these are long release notes. We offer no apologies. :)\n+\n+## Release Highlights\n+\n+### Continued Dataset and File Redesign: Dataset and File Button Redesign, Responsive Layout\n+\n+The buttons available on the Dataset and File pages have been redesigned. This change is to provide more scalability for future expanded options for data access and exploration, and to provide a consistent experience between the two pages. The dataset and file pages have also been redesigned to be more responsive and function better across multiple devices.\n+\n+This is an important step in the incremental process of the Dataset and File Redesign project, following the release of on-page previews, filtering and sorting options, tree view, and other enhancements. Additional features in support of these redesign efforts will follow in later 5.x releases.\n+\n+### Payara 5\n+\n+A major upgrade of the application server provides security updates, access to new features like MicroProfile Config API, and will enable upgrades to other core technologies.\n+\n+Note that moving from Glassfish to Payara will be required as part of the move to Dataverse 5.\n+\n+### Download Dataset\n+\n+Users can now more easily download all files in Dataset through both the UI and API. If this causes server instability, it's suggested that Dataverse Installation Administrators take advantage of the new Standalone Zipper Service described below.\n+\n+#### Download All Option on the Dataset Page\n+\n+In previous versions of Dataverse, downloading all files from a dataset meant several clicks to select files and initiate the download. The Dataset Page now includes a Download All option for both the original and archival formats of the files in a dataset under the \"Access Dataset\" button.\n+\n+#### Download All Files in a Dataset by API\n+\n+In previous versions of Dataverse, downloading all files from a dataset via API was a two step process:\n+\n+- Find all the database ids of the files.\n+- Download all the files, using those ids (comma-separated).\n+\n+Now you can download all files from a dataset (assuming you have access to them) via API by passing the dataset persistent ID (PID such as DOI or Handle) or the dataset's database id. Versions are also supported, and you can pass :draft, :latest, :latest-published, or numbers (1.1, 2.0) similar to the \"download metadata\" API.\n+\n+### A Multi-File, Zipped Download Optimization\n+\n+In this release we are offering an experimental optimization for the multi-file, download-as-zip functionality. If this option is enabled, instead of enforcing size limits, we attempt to serve all the files that the user requested (that they are authorized to download), but the request is redirected to a standalone zipper service running as a cgi executable. Thus moving these potentially long-running jobs completely outside the Application Server (Payara); and preventing service threads from becoming locked serving them. Since zipping is also a CPU-intensive task, it is possible to have this service running on a different host system, thus freeing the cycles on the main Application Server. The system running the service needs to have access to the database as well as to the storage filesystem, and/or S3 bucket.\n+\n+Please consult the scripts/zipdownload/README.md in the Dataverse 5 source tree.\n+\n+The components of the standalone \"zipper tool\" can also be downloaded\n+here:\n+\n+https://github.com/IQSS/dataverse/releases/download/v5.0/zipper.zip\n+\n+### Updated File Handling\n+\n+Files without extensions can now be uploaded through the UI. This release also changes the way Dataverse handles duplicate (filename or checksum) files in a dataset. Specifically:\n+\n+- Files with the same checksum can be included in a dataset, even if the files are in the same directory.\n+- Files with the same filename can be included in a dataset as long as the files are in different directories.\n+- If a user uploads a file to a directory where a file already exists with that directory/filename combination, Dataverse will adjust the file path and names by adding \"-1\" or \"-2\" as applicable. This change will be visible in the list of files being uploaded.\n+- If the directory or name of an existing or newly uploaded file is edited in such a way that would create a directory/filename combination that already exists, Dataverse will display an error.\n+- If a user attempts to replace a file with another file that has the same checksum, an error message will be displayed and the file will not be able to be replaced.\n+- If a user attempts to replace a file with a file that has the same checksum as a different file in the dataset, a warning will be displayed.\n+- Files without extensions can now be uploaded through the UI.\n+\n+### Pre-Publish DOI Reservation with DataCite\n+\n+Dataverse installations using DataCite will have DOIs reserved as \"draft\" with DataCite when the Dataset is created, instead of the DOI reservation taking place locally at create time and the reservation and switch to \"findable\" taking place with DataCite at publish time. This allows the DOI to reserved earlier in the publication process.", "originalCommit": "c0d1572deb7e8d2b20315436f011434a5deda443", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU5MjcyMQ==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r470592721", "bodyText": "Updated text in 2ec68b3\nI agree that at this point in the doc (release highlights) we can be less technical.", "author": "djbrooke", "createdAt": "2020-08-14T12:26:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI1MDc2Mg=="}], "type": "inlineReview"}, {"oid": "9e96567fedf52577532676e0f3d6597354725f65", "url": "https://github.com/IQSS/dataverse/commit/9e96567fedf52577532676e0f3d6597354725f65", "message": "file validation paragraph", "committedDate": "2020-08-13T21:14:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI1NTU5OQ==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r470255599", "bodyText": "Not sure why it was needed, mentioning the Xmx and Xms lines in this upgrade instruction. I mean, it's an existing installation - they must have these settings in their config already. I can see how this can confuse somebody.\nI would simply remove this paragraph and the last two jvm-options lines.", "author": "landreev", "createdAt": "2020-08-13T21:20:47Z", "path": "doc/release-notes/5.0-release-notes.md", "diffHunk": "@@ -0,0 +1,321 @@\n+# Dataverse 5.0\n+\n+This release brings new features, enhancements, and bug fixes to Dataverse. Thank you to all of the community members who contributed code, suggestions, bug reports, and other assistance across the project.\n+\n+Please note that this is a major release and these are long release notes. We offer no apologies. :)\n+\n+## Release Highlights\n+\n+### Continued Dataset and File Redesign: Dataset and File Button Redesign, Responsive Layout\n+\n+The buttons available on the Dataset and File pages have been redesigned. This change is to provide more scalability for future expanded options for data access and exploration, and to provide a consistent experience between the two pages. The dataset and file pages have also been redesigned to be more responsive and function better across multiple devices.\n+\n+This is an important step in the incremental process of the Dataset and File Redesign project, following the release of on-page previews, filtering and sorting options, tree view, and other enhancements. Additional features in support of these redesign efforts will follow in later 5.x releases.\n+\n+### Payara 5\n+\n+A major upgrade of the application server provides security updates, access to new features like MicroProfile Config API, and will enable upgrades to other core technologies.\n+\n+Note that moving from Glassfish to Payara will be required as part of the move to Dataverse 5.\n+\n+### Download Dataset\n+\n+Users can now more easily download all files in Dataset through both the UI and API. If this causes server instability, it's suggested that Dataverse Installation Administrators take advantage of the new Standalone Zipper Service described below.\n+\n+#### Download All Option on the Dataset Page\n+\n+In previous versions of Dataverse, downloading all files from a dataset meant several clicks to select files and initiate the download. The Dataset Page now includes a Download All option for both the original and archival formats of the files in a dataset under the \"Access Dataset\" button.\n+\n+#### Download All Files in a Dataset by API\n+\n+In previous versions of Dataverse, downloading all files from a dataset via API was a two step process:\n+\n+- Find all the database ids of the files.\n+- Download all the files, using those ids (comma-separated).\n+\n+Now you can download all files from a dataset (assuming you have access to them) via API by passing the dataset persistent ID (PID such as DOI or Handle) or the dataset's database id. Versions are also supported, and you can pass :draft, :latest, :latest-published, or numbers (1.1, 2.0) similar to the \"download metadata\" API.\n+\n+### A Multi-File, Zipped Download Optimization\n+\n+In this release we are offering an experimental optimization for the multi-file, download-as-zip functionality. If this option is enabled, instead of enforcing size limits, we attempt to serve all the files that the user requested (that they are authorized to download), but the request is redirected to a standalone zipper service running as a cgi executable. Thus moving these potentially long-running jobs completely outside the Application Server (Payara); and preventing service threads from becoming locked serving them. Since zipping is also a CPU-intensive task, it is possible to have this service running on a different host system, thus freeing the cycles on the main Application Server. The system running the service needs to have access to the database as well as to the storage filesystem, and/or S3 bucket.\n+\n+Please consult the scripts/zipdownload/README.md in the Dataverse 5 source tree.\n+\n+The components of the standalone \"zipper tool\" can also be downloaded\n+here:\n+\n+https://github.com/IQSS/dataverse/releases/download/v5.0/zipper.zip\n+\n+### Updated File Handling\n+\n+Files without extensions can now be uploaded through the UI. This release also changes the way Dataverse handles duplicate (filename or checksum) files in a dataset. Specifically:\n+\n+- Files with the same checksum can be included in a dataset, even if the files are in the same directory.\n+- Files with the same filename can be included in a dataset as long as the files are in different directories.\n+- If a user uploads a file to a directory where a file already exists with that directory/filename combination, Dataverse will adjust the file path and names by adding \"-1\" or \"-2\" as applicable. This change will be visible in the list of files being uploaded.\n+- If the directory or name of an existing or newly uploaded file is edited in such a way that would create a directory/filename combination that already exists, Dataverse will display an error.\n+- If a user attempts to replace a file with another file that has the same checksum, an error message will be displayed and the file will not be able to be replaced.\n+- If a user attempts to replace a file with a file that has the same checksum as a different file in the dataset, a warning will be displayed.\n+- Files without extensions can now be uploaded through the UI.\n+\n+### Pre-Publish DOI Reservation with DataCite\n+\n+Dataverse installations using DataCite will have DOIs reserved as \"draft\" with DataCite when the Dataset is created, instead of the DOI reservation taking place locally at create time and the reservation and switch to \"findable\" taking place with DataCite at publish time. This allows the DOI to reserved earlier in the publication process.\n+\n+### Primefaces 8\n+\n+Primefaces, the open source UI framework upon which the Dataverse front end is built, has been updated to the most recent version. This provides security updates and bug fixes and will also allow Dataverse developers to take advantage of new features and enhancements.\n+\n+## Major Use Cases\n+\n+Newly-supported use cases in this release include:\n+\n+- Users will be presented with a new workflow around dataset and file access and exploration. (Issue #6684, PR #6909)\n+- Users will experience a UI appropriate across a variety of device sizes. (Issue #6684, PR #6909)\n+- Users will be able to download an entire dataset without needing to select all the files in that dataset. (Issue #6564, PR #6262)\n+- Users will be able to download all files in a dataset with a single API call. (Issue #4529, PR #7086)\n+- Users will have DOIs reserved for their datasets upon dataset create instead of at publish time. (Issue #5093, PR #6901)\n+- Users will be able to upload files without extensions. (Issue #6634, PR #6804)\n+- Users will be able to upload files with the same name in a dataset, as long as a those files are in different file paths. (Issue #4813, PR #6924)\n+- Users will be able to upload files with the same checksum in a dataset. (Issue #4813, PR #6924)\n+- Users will be less likely to encounter locks during the publishing process due to PID providers being unavailable. (Issue #6918, PR #7118)\n+- Users will now have their files validated during publish, and in the unlikely event that anything has happened to the files between deposit and publish, they will be able to take corrective action. (Issue #6558, PR #6790)\n+- Administrators will likely see more success with Harvesting, as many minor harvesting issues have been resolved. (Issues #7127, #7128, #4597, #7056, #7052, #7023, #7009, and #7003)\n+- Administrators can now enable an external zip service that frees up application server resources and allows the zip download limit to be increased. (Issue #6505, PR #6986)\n+- Administrators can now create groups based on users' email domains. (Issue #6936, PR #6974)\n+- Administrators can now set date facets to be organized chronologically. (Issue #4977, PR #6958)\n+- Administrators can now link harvested datasets using an API. (Issue #5886, PR #6935)\n+- Administrators can now destroy datasets with mapped shapefiles. (Issue #4093, PR #6860)\n+\n+## Notes for Dataverse Installation Administrators\n+\n+### Glassfish to Payara\n+\n+This upgrade requires a few extra steps. See the detailed upgrade instructions below.\n+\n+### Dataverse Installations Using DataCite: Upgrade Action Required\n+\n+If you are using DataCite as your DOI provider you must add a new JVM option called \"doi.dataciterestapiurlstring\" with a value of \"https://api.datacite.org\" for production environments and \"https://api.test.datacite.org\" for test environments. More information about this JVM option can be found in the [Installation Guide](http://guides.dataverse.org/en/5.0/installation/).\n+\n+\"doi.mdcbaseurlstring\" should be deleted if it was previously set.\n+\n+### Dataverse Installations Using DataCite: Upgrade Action Recommended\n+\n+For installations that are using DataCite, Dataverse v5.0 introduces a change in the process of registering the Persistent Identifier (DOI) for a dataset. Instead of registering it when the dataset is published for the first time, Dataverse will try to \"reserve\" the DOI when it's created (by registering it as a \"draft\", using DataCite terminology). When the user publishes the dataset, the DOI will be publicized as well (by switching the registration status to \"findable\"). This approach makes the process of publishing datasets simpler and less error-prone.\n+\n+New APIs have been provided for finding any unreserved DataCite-issued DOIs in your Dataverse, and for reserving them (see below). While not required - the user can still attempt to publish a dataset with an unreserved DOI - having all the identifiers reserved ahead of time is recommended. If you are upgrading an installation that uses DataCite, we specifically recommend that you reserve the DOIs for all your pre-existing unpublished drafts as soon as Dataverse v5.0 is deployed, since none of them were registered at create time. This can be done using the following API calls:  \n+\n+- `/api/pids/unreserved`  will report the ids of the datasets\n+- `/api/pids/:persistentId/reserve` reserves the assigned DOI with DataCite (will need to be run on every id reported by the the first API).\n+\n+See the [Native API Guide](http://guides.dataverse.org/en/5.0/api/native-api.html) for more information.\n+\n+Scripted, the whole process would look as follows (adjust as needed):\n+\n+```\n+   API_TOKEN='xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'\n+\n+   curl -s -H \"X-Dataverse-key:$API_TOKEN\" http://localhost:8080/api/pids/unreserved |\n+   # the API outputs JSON; note the use of jq to parse it:\n+   jq '.data.count[].pid' | tr -d '\"' | \n+   while read doi\n+   do\n+      curl -s -H \"X-Dataverse-key:$API_TOKEN\" -X POST http://localhost:8080/api/pids/:persistentId/reserve?persistentId=$doi\n+   done\n+```\n+\n+Going forward, once all the DOIs have been reserved for the legacy drafts, you may still get an occasional dataset with an unreserved identifier. DataCite service instability would be a potential cause. There is no reason to expect that to happen often, but it is not impossible. You may consider running the script above (perhaps with some extra diagnostics added) regularly, from a cron job or otherwise, to address this preemptively.\n+\n+### Terms of Use Display Updates\n+\n+In this release we\u2019ve fixed an issue that would cause the Application Terms of Use to not display when the user's language is set to a language that does not match one of the languages for which terms were created and registered for that Dataverse installation. Instead of the expected Terms of Use, users signing up could receive the \u201cThere are no Terms of Use for this Dataverse installation\u201d message. This could potentially result in some users signing up for an account without having the proper Terms of Use displayed. This will only affect installations that use the :ApplicationTermsOfUse setting.\n+\n+Please note that there is not currently a native workflow in Dataverse to display updated Terms of Use to a user or to force re-agreement. This would only potentially affect users that have signed up since the upgrade to 4.17 (or a following release if 4.17 was skipped).\n+\n+### Datafiles Validation when Publishing Datasets\n+\n+When a user requests to publish a dataset, Dataverse will now attempt to validate the physical files in the dataset, by recalculating the checksums and verifying them against the values in the database. The goal is to prevent any corrupted files in published datasets. Most of all the instances of actual damage to physical files that we've seen in the past happened while the datafiles were still in the Draft state. (Physical files become essentially read-only once published). So this is the logical place to catch any such issues.\n+\n+If any files in the dataset fail the validation, the dataset does not get published, and the user is notified that they need to contact their Dataverse support in order to address the issue before another attempt to publish can be made. See the \"Troubleshooting\" section of the Guide on how to fix such problems.\n+\n+This validation will be performed asynchronously, the same way as the registration of the file-level persistent ids. Similarly to the file PID registration, this validation process can be disabled on your system, with the setting `:FileValidationOnPublishEnabled`. (A Dataverse admin may choose to disable it if, for example, they are already running an external auditing system to monitor the integrity of the files in their Dataverse, and would prefer the publishing process to take less time). See the Configuration section of the [Installation Guide](http://guides.dataverse.org/en/5.0/installation/config.rst).\n+\n+Please note that we are not aware of any bugs in the current versions of Dataverse that would result in damage to users' files. But you may have some legacy files in your archive that were affected by some issue in the past, or perhaps affected by something outside Dataverse, so we are adding this feature out of abundance of caution. An example of a problem we've experienced in the early versions of Dataverse was a possible scenario where a user actually attempted to delete a Draft file from an unpublished version, where the database transaction would fail for whatever reason, but only after the physical file had already been deleted from the filesystem. Thus resulting in a datafile entry remaining in the dataset, but with the corresponding physical file missing. The fix for this case, since the user wanted to delete the file in the first place, is simply to confirm it and purge the datafile entity from the database.\n+\n+### The Setting :PIDAsynchRegFileCount is Deprecated as of 5.0\n+\n+It used to specify the number of datafiles in the dataset to warrant adding a lock during publishing. As of v5.0 all datasets get locked for the duration of the publishing process. The setting will be ignored if present.\n+\n+### Location Changes for Related Projects\n+\n+The dataverse-ansible and dataverse-previewers repositories have been moved to the GDCC Organization on GitHub. If you have been referencing the dataverse-ansible repository from IQSS and the dataverse-previewers from QDR, please instead use them from their new locations:\n+\n+<https://github.com/GlobalDataverseCommunityConsortium/dataverse-ansible>\n+<https://github.com/GlobalDataverseCommunityConsortium/dataverse-previewers>\n+\n+### Harvesting Improvements\n+\n+Many updates have been made to address common Harvesting failures. You may see Harvests complete more often and have a higher success rate on a dataset-by-dataset basis.\n+\n+### New JVM Options and Database Settings\n+\n+Several new JVM options and DB Settings have been added in this release. More documentation about each of these settings can be found in the Configuration section of the [Installation Guide](http://guides.dataverse.org/en/5.0/installation/config.rst).\n+\n+#### New JVM Options\n+\n+- doi.dataciterestapiurlstring: Set with a value of \"https://api.datacite.org\" for production environments and \"https://api.test.datacite.org\" for test environments. Must be set if you are using DataCite as your DOI provider.\n+- dataverse.useripaddresssourceheader: If set, specifies an HTTP Header such as X-Forwarded-For to use to retrieve the user's IP address. This setting is useful in cases such as running Dataverse behind load balancers where the default option of getting the Remote Address from the servlet isn't correct (e.g. it would be the load balancer IP address). Note that unless your installation always sets the header you configure here, this could be used as a way to spoof the user's address. See the Configuration section of the [Installation Guide](http://guides.dataverse.org/en/5.0/installation/config.rst) for more information about proper use and security concerns.\n+- http.request-timeout-seconds: To facilitate large file upload and download, the Dataverse installer bumps the Payara **server-config.network-config.protocols.protocol.http-listener-1.http.request-timeout-seconds** setting from its default 900 seconds (15 minutes) to 1800 (30 minutes).\n+\n+#### New Database Settings\n+\n+- :CustomZipDownloadServiceUrl: If defined, this is the URL of the zipping service outside the main application server where zip downloads should be directed (instead of /api/access/datafiles/).\n+- :ShibAttributeCharacterSetConversionEnabled: By default, all attributes received from Shibboleth are converted from ISO-8859-1 to UTF-8. You can disable this behavior by setting to false.\n+- :ChronologicalDateFacets: Facets with Date/Year are sorted chronologically by default, with the most recent value first. To have them sorted by number of hits, e.g. with the year with the most results first, set this to false.\n+- :NavbarGuidesUrl: Set to a fully-qualified URL which will be used for the \"User Guide\" link in the navbar.\n+- :FileValidationOnPublishEnabled: Toggles validation of the physical files in the dataset when it's published, by recalculating the checksums and comparing against the values stored in the DataFile table. By default this setting is absent and Dataverse assumes it to be true. If enabled, the validation will be performed asynchronously, similarly to how we handle assigning persistent identifiers to datafiles, with the dataset locked for the duration of the publishing process.\n+\n+### Custom Analytics Code Changes\n+\n+You should update your custom analytics code to implement necessary changes for tracking updated dataset and file buttons. There was also a fix to the analytics code that will now properly track downloads for tabular files.\n+\n+For more information, see the documentation and sample analytics code snippet provided in [Installation Guide > Configuration > Web Analytics Code](http://guides.dataverse.org/en/5.0/installation/config.html#web-analytics-code) to reflect the changes implemented in this version (#6938/#6684).\n+\n+### Tracking Users' IP Addresses Behind an Address-Masking Proxy\n+\n+It is now possible to collect real user IP addresses in MDC logs and/or set up an IP group on a system running behind a proxy/load balancer that hides the addresses of incoming requests. See \"Recording User IP Addresses\" in the Configuration section of the [Installation Guide](http://guides.dataverse.org/en/5.0/installation/config.rst).\n+\n+### Reload Astrophysics Metadata Block (if used)\n+\n+Tooltips have been updated for the Astrophysics Metadata Block. If you'd like these updated Tooltips to be displayed to users of your installation, you should update the Astrophysics Metadata Block:\n+\n+`curl http://localhost:8080/api/admin/datasetfield/load -X POST --data-binary @astrophysics.tsv -H \"Content-type: text/tab-separated-values\"`\n+\n+We've included this in the step-by-step instructions below.\n+\n+### Run ReExportall\n+\n+We made changes to the JSON Export in this release. If you'd like these changes to reflected in your JSON exports, you should run ReExportall as part of the upgrade process following the steps in [Admin Guide](http://guides.dataverse.org/en/5.0/admin/metadataexport.html?highlight=export#batch-exports-through-the-api)\n+\n+We've included this in the step-by-step instructions below.\n+\n+## Notes for Tool Developers and Integrators\n+\n+## Complete List of Changes\n+\n+For the complete list of code changes in this release, see the [5.0 Milestone](https://github.com/IQSS/dataverse/milestone/89?closed=1) in Github.\n+\n+For help with upgrading, installing, or general questions please post to the [Dataverse Google Group](https://groups.google.com/forum/#!forum/dataverse-community) or email support@dataverse.org.\n+\n+## Installation\n+\n+If this is a new installation, please see our [Installation Guide](http://guides.dataverse.org/en/5.0/installation/)\n+\n+## Upgrade Dataverse from Glassfish 4.1 to Payara 5\n+\n+The instructions below describe the upgrade procedure based on moving an existing glassfish4 domain directory under Payara. We recommend this method instead of setting up a brand-new Payara domain using the installer because it appears to be the easiest way to recreate your current configuration and preserve all your data.\n+\n+1. Download Payara, v5.2020.2 as of this writing:\n+\n+   `curl -L -O https://github.com/payara/Payara/releases/download/payara-server-5.2020.2/payara-5.2020.2.zip`\n+   `sha256sum payara-5.2020.2.zip`\n+      1f5f7ea30901b1b4c7bcdfa5591881a700c9b7e2022ae3894192ba97eb83cc3e\n+\n+2. Unzip it somewhere (/usr/local is a safe bet)\n+\n+   `sudo unzip payara-5.2020.2.zip -d /usr/local/`\n+\n+3. Copy the Postgres driver to /usr/local/payara5/glassfish/lib\n+\n+   `sudo cp /usr/local/glassfish4/glassfish/lib/postgresql-42.2.9.jar /usr/local/payara5/glassfish/lib/`\n+\n+4. Move payara5/glassfish/domains/domain1 out of the way\n+\n+   `sudo mv /usr/local/payara5/glassfish/domains/domain1 /usr/local/payara5/glassfish/domains/domain1.orig`\n+\n+5. Undeploy the Dataverse web application (if deployed; version 4.20 is assumed in the example below)\n+\n+   `sudo /usr/local/glassfish4/bin/asadmin list-applications`\n+   `sudo /usr/local/glassfish4/bin/asadmin undeploy dataverse-4.20`\n+\n+6. Stop Glassfish; copy domain1 to Payara\n+\n+   `sudo /usr/local/glassfish4/bin/asadmin stop-domain`\n+   `sudo cp -ar /usr/local/glassfish4/glassfish/domains/domain1 /usr/local/payara5/glassfish/domains/`\n+\n+7. Remove the Glassfish cache directories\n+\n+   `sudo rm -rf /usr/local/payara5/glassfish/domains/domain1/generated/`  `sudo rm -rf /usr/local/payara5/glassfish/domains/domain1/osgi-cache/`\n+\n+8. In domain.xml:\n+\n+ Replace the -XX:PermSize and -XX:MaxPermSize JVM options with -XX:MetaspaceSize and -XX:MaxMetaspaceSize.\n+\n+   <jvm-options>-XX:MetaspaceSize=256m</jvm-options>\n+   <jvm-options>-XX:MaxMetaspaceSize=512m</jvm-options>\n+\n+Set both Xmx and Xms at startup to avoid runtime re-allocation. Your Xmx value should likely be higher:\n+\n+   <jvm-options>-Xmx2048m</jvm-options>\n+   <jvm-options>-Xms2048m</jvm-options>", "originalCommit": "9e96567fedf52577532676e0f3d6597354725f65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU5NDYwMQ==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r470594601", "bodyText": "@landreev I removed this in c593f89\nheads up to @donsizemore in case this was included for some other reason we're not seeing", "author": "djbrooke", "createdAt": "2020-08-14T12:30:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI1NTU5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI1NzEyNg==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r470257126", "bodyText": "Since there is already a detailed section for this step, above - does it need to be here, in the upgrade-to-payara instruction - probably not?", "author": "landreev", "createdAt": "2020-08-13T21:24:06Z", "path": "doc/release-notes/5.0-release-notes.md", "diffHunk": "@@ -0,0 +1,321 @@\n+# Dataverse 5.0\n+\n+This release brings new features, enhancements, and bug fixes to Dataverse. Thank you to all of the community members who contributed code, suggestions, bug reports, and other assistance across the project.\n+\n+Please note that this is a major release and these are long release notes. We offer no apologies. :)\n+\n+## Release Highlights\n+\n+### Continued Dataset and File Redesign: Dataset and File Button Redesign, Responsive Layout\n+\n+The buttons available on the Dataset and File pages have been redesigned. This change is to provide more scalability for future expanded options for data access and exploration, and to provide a consistent experience between the two pages. The dataset and file pages have also been redesigned to be more responsive and function better across multiple devices.\n+\n+This is an important step in the incremental process of the Dataset and File Redesign project, following the release of on-page previews, filtering and sorting options, tree view, and other enhancements. Additional features in support of these redesign efforts will follow in later 5.x releases.\n+\n+### Payara 5\n+\n+A major upgrade of the application server provides security updates, access to new features like MicroProfile Config API, and will enable upgrades to other core technologies.\n+\n+Note that moving from Glassfish to Payara will be required as part of the move to Dataverse 5.\n+\n+### Download Dataset\n+\n+Users can now more easily download all files in Dataset through both the UI and API. If this causes server instability, it's suggested that Dataverse Installation Administrators take advantage of the new Standalone Zipper Service described below.\n+\n+#### Download All Option on the Dataset Page\n+\n+In previous versions of Dataverse, downloading all files from a dataset meant several clicks to select files and initiate the download. The Dataset Page now includes a Download All option for both the original and archival formats of the files in a dataset under the \"Access Dataset\" button.\n+\n+#### Download All Files in a Dataset by API\n+\n+In previous versions of Dataverse, downloading all files from a dataset via API was a two step process:\n+\n+- Find all the database ids of the files.\n+- Download all the files, using those ids (comma-separated).\n+\n+Now you can download all files from a dataset (assuming you have access to them) via API by passing the dataset persistent ID (PID such as DOI or Handle) or the dataset's database id. Versions are also supported, and you can pass :draft, :latest, :latest-published, or numbers (1.1, 2.0) similar to the \"download metadata\" API.\n+\n+### A Multi-File, Zipped Download Optimization\n+\n+In this release we are offering an experimental optimization for the multi-file, download-as-zip functionality. If this option is enabled, instead of enforcing size limits, we attempt to serve all the files that the user requested (that they are authorized to download), but the request is redirected to a standalone zipper service running as a cgi executable. Thus moving these potentially long-running jobs completely outside the Application Server (Payara); and preventing service threads from becoming locked serving them. Since zipping is also a CPU-intensive task, it is possible to have this service running on a different host system, thus freeing the cycles on the main Application Server. The system running the service needs to have access to the database as well as to the storage filesystem, and/or S3 bucket.\n+\n+Please consult the scripts/zipdownload/README.md in the Dataverse 5 source tree.\n+\n+The components of the standalone \"zipper tool\" can also be downloaded\n+here:\n+\n+https://github.com/IQSS/dataverse/releases/download/v5.0/zipper.zip\n+\n+### Updated File Handling\n+\n+Files without extensions can now be uploaded through the UI. This release also changes the way Dataverse handles duplicate (filename or checksum) files in a dataset. Specifically:\n+\n+- Files with the same checksum can be included in a dataset, even if the files are in the same directory.\n+- Files with the same filename can be included in a dataset as long as the files are in different directories.\n+- If a user uploads a file to a directory where a file already exists with that directory/filename combination, Dataverse will adjust the file path and names by adding \"-1\" or \"-2\" as applicable. This change will be visible in the list of files being uploaded.\n+- If the directory or name of an existing or newly uploaded file is edited in such a way that would create a directory/filename combination that already exists, Dataverse will display an error.\n+- If a user attempts to replace a file with another file that has the same checksum, an error message will be displayed and the file will not be able to be replaced.\n+- If a user attempts to replace a file with a file that has the same checksum as a different file in the dataset, a warning will be displayed.\n+- Files without extensions can now be uploaded through the UI.\n+\n+### Pre-Publish DOI Reservation with DataCite\n+\n+Dataverse installations using DataCite will have DOIs reserved as \"draft\" with DataCite when the Dataset is created, instead of the DOI reservation taking place locally at create time and the reservation and switch to \"findable\" taking place with DataCite at publish time. This allows the DOI to reserved earlier in the publication process.\n+\n+### Primefaces 8\n+\n+Primefaces, the open source UI framework upon which the Dataverse front end is built, has been updated to the most recent version. This provides security updates and bug fixes and will also allow Dataverse developers to take advantage of new features and enhancements.\n+\n+## Major Use Cases\n+\n+Newly-supported use cases in this release include:\n+\n+- Users will be presented with a new workflow around dataset and file access and exploration. (Issue #6684, PR #6909)\n+- Users will experience a UI appropriate across a variety of device sizes. (Issue #6684, PR #6909)\n+- Users will be able to download an entire dataset without needing to select all the files in that dataset. (Issue #6564, PR #6262)\n+- Users will be able to download all files in a dataset with a single API call. (Issue #4529, PR #7086)\n+- Users will have DOIs reserved for their datasets upon dataset create instead of at publish time. (Issue #5093, PR #6901)\n+- Users will be able to upload files without extensions. (Issue #6634, PR #6804)\n+- Users will be able to upload files with the same name in a dataset, as long as a those files are in different file paths. (Issue #4813, PR #6924)\n+- Users will be able to upload files with the same checksum in a dataset. (Issue #4813, PR #6924)\n+- Users will be less likely to encounter locks during the publishing process due to PID providers being unavailable. (Issue #6918, PR #7118)\n+- Users will now have their files validated during publish, and in the unlikely event that anything has happened to the files between deposit and publish, they will be able to take corrective action. (Issue #6558, PR #6790)\n+- Administrators will likely see more success with Harvesting, as many minor harvesting issues have been resolved. (Issues #7127, #7128, #4597, #7056, #7052, #7023, #7009, and #7003)\n+- Administrators can now enable an external zip service that frees up application server resources and allows the zip download limit to be increased. (Issue #6505, PR #6986)\n+- Administrators can now create groups based on users' email domains. (Issue #6936, PR #6974)\n+- Administrators can now set date facets to be organized chronologically. (Issue #4977, PR #6958)\n+- Administrators can now link harvested datasets using an API. (Issue #5886, PR #6935)\n+- Administrators can now destroy datasets with mapped shapefiles. (Issue #4093, PR #6860)\n+\n+## Notes for Dataverse Installation Administrators\n+\n+### Glassfish to Payara\n+\n+This upgrade requires a few extra steps. See the detailed upgrade instructions below.\n+\n+### Dataverse Installations Using DataCite: Upgrade Action Required\n+\n+If you are using DataCite as your DOI provider you must add a new JVM option called \"doi.dataciterestapiurlstring\" with a value of \"https://api.datacite.org\" for production environments and \"https://api.test.datacite.org\" for test environments. More information about this JVM option can be found in the [Installation Guide](http://guides.dataverse.org/en/5.0/installation/).\n+\n+\"doi.mdcbaseurlstring\" should be deleted if it was previously set.\n+\n+### Dataverse Installations Using DataCite: Upgrade Action Recommended\n+\n+For installations that are using DataCite, Dataverse v5.0 introduces a change in the process of registering the Persistent Identifier (DOI) for a dataset. Instead of registering it when the dataset is published for the first time, Dataverse will try to \"reserve\" the DOI when it's created (by registering it as a \"draft\", using DataCite terminology). When the user publishes the dataset, the DOI will be publicized as well (by switching the registration status to \"findable\"). This approach makes the process of publishing datasets simpler and less error-prone.\n+\n+New APIs have been provided for finding any unreserved DataCite-issued DOIs in your Dataverse, and for reserving them (see below). While not required - the user can still attempt to publish a dataset with an unreserved DOI - having all the identifiers reserved ahead of time is recommended. If you are upgrading an installation that uses DataCite, we specifically recommend that you reserve the DOIs for all your pre-existing unpublished drafts as soon as Dataverse v5.0 is deployed, since none of them were registered at create time. This can be done using the following API calls:  \n+\n+- `/api/pids/unreserved`  will report the ids of the datasets\n+- `/api/pids/:persistentId/reserve` reserves the assigned DOI with DataCite (will need to be run on every id reported by the the first API).\n+\n+See the [Native API Guide](http://guides.dataverse.org/en/5.0/api/native-api.html) for more information.\n+\n+Scripted, the whole process would look as follows (adjust as needed):\n+\n+```\n+   API_TOKEN='xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'\n+\n+   curl -s -H \"X-Dataverse-key:$API_TOKEN\" http://localhost:8080/api/pids/unreserved |\n+   # the API outputs JSON; note the use of jq to parse it:\n+   jq '.data.count[].pid' | tr -d '\"' | \n+   while read doi\n+   do\n+      curl -s -H \"X-Dataverse-key:$API_TOKEN\" -X POST http://localhost:8080/api/pids/:persistentId/reserve?persistentId=$doi\n+   done\n+```\n+\n+Going forward, once all the DOIs have been reserved for the legacy drafts, you may still get an occasional dataset with an unreserved identifier. DataCite service instability would be a potential cause. There is no reason to expect that to happen often, but it is not impossible. You may consider running the script above (perhaps with some extra diagnostics added) regularly, from a cron job or otherwise, to address this preemptively.\n+\n+### Terms of Use Display Updates\n+\n+In this release we\u2019ve fixed an issue that would cause the Application Terms of Use to not display when the user's language is set to a language that does not match one of the languages for which terms were created and registered for that Dataverse installation. Instead of the expected Terms of Use, users signing up could receive the \u201cThere are no Terms of Use for this Dataverse installation\u201d message. This could potentially result in some users signing up for an account without having the proper Terms of Use displayed. This will only affect installations that use the :ApplicationTermsOfUse setting.\n+\n+Please note that there is not currently a native workflow in Dataverse to display updated Terms of Use to a user or to force re-agreement. This would only potentially affect users that have signed up since the upgrade to 4.17 (or a following release if 4.17 was skipped).\n+\n+### Datafiles Validation when Publishing Datasets\n+\n+When a user requests to publish a dataset, Dataverse will now attempt to validate the physical files in the dataset, by recalculating the checksums and verifying them against the values in the database. The goal is to prevent any corrupted files in published datasets. Most of all the instances of actual damage to physical files that we've seen in the past happened while the datafiles were still in the Draft state. (Physical files become essentially read-only once published). So this is the logical place to catch any such issues.\n+\n+If any files in the dataset fail the validation, the dataset does not get published, and the user is notified that they need to contact their Dataverse support in order to address the issue before another attempt to publish can be made. See the \"Troubleshooting\" section of the Guide on how to fix such problems.\n+\n+This validation will be performed asynchronously, the same way as the registration of the file-level persistent ids. Similarly to the file PID registration, this validation process can be disabled on your system, with the setting `:FileValidationOnPublishEnabled`. (A Dataverse admin may choose to disable it if, for example, they are already running an external auditing system to monitor the integrity of the files in their Dataverse, and would prefer the publishing process to take less time). See the Configuration section of the [Installation Guide](http://guides.dataverse.org/en/5.0/installation/config.rst).\n+\n+Please note that we are not aware of any bugs in the current versions of Dataverse that would result in damage to users' files. But you may have some legacy files in your archive that were affected by some issue in the past, or perhaps affected by something outside Dataverse, so we are adding this feature out of abundance of caution. An example of a problem we've experienced in the early versions of Dataverse was a possible scenario where a user actually attempted to delete a Draft file from an unpublished version, where the database transaction would fail for whatever reason, but only after the physical file had already been deleted from the filesystem. Thus resulting in a datafile entry remaining in the dataset, but with the corresponding physical file missing. The fix for this case, since the user wanted to delete the file in the first place, is simply to confirm it and purge the datafile entity from the database.\n+\n+### The Setting :PIDAsynchRegFileCount is Deprecated as of 5.0\n+\n+It used to specify the number of datafiles in the dataset to warrant adding a lock during publishing. As of v5.0 all datasets get locked for the duration of the publishing process. The setting will be ignored if present.\n+\n+### Location Changes for Related Projects\n+\n+The dataverse-ansible and dataverse-previewers repositories have been moved to the GDCC Organization on GitHub. If you have been referencing the dataverse-ansible repository from IQSS and the dataverse-previewers from QDR, please instead use them from their new locations:\n+\n+<https://github.com/GlobalDataverseCommunityConsortium/dataverse-ansible>\n+<https://github.com/GlobalDataverseCommunityConsortium/dataverse-previewers>\n+\n+### Harvesting Improvements\n+\n+Many updates have been made to address common Harvesting failures. You may see Harvests complete more often and have a higher success rate on a dataset-by-dataset basis.\n+\n+### New JVM Options and Database Settings\n+\n+Several new JVM options and DB Settings have been added in this release. More documentation about each of these settings can be found in the Configuration section of the [Installation Guide](http://guides.dataverse.org/en/5.0/installation/config.rst).\n+\n+#### New JVM Options\n+\n+- doi.dataciterestapiurlstring: Set with a value of \"https://api.datacite.org\" for production environments and \"https://api.test.datacite.org\" for test environments. Must be set if you are using DataCite as your DOI provider.\n+- dataverse.useripaddresssourceheader: If set, specifies an HTTP Header such as X-Forwarded-For to use to retrieve the user's IP address. This setting is useful in cases such as running Dataverse behind load balancers where the default option of getting the Remote Address from the servlet isn't correct (e.g. it would be the load balancer IP address). Note that unless your installation always sets the header you configure here, this could be used as a way to spoof the user's address. See the Configuration section of the [Installation Guide](http://guides.dataverse.org/en/5.0/installation/config.rst) for more information about proper use and security concerns.\n+- http.request-timeout-seconds: To facilitate large file upload and download, the Dataverse installer bumps the Payara **server-config.network-config.protocols.protocol.http-listener-1.http.request-timeout-seconds** setting from its default 900 seconds (15 minutes) to 1800 (30 minutes).\n+\n+#### New Database Settings\n+\n+- :CustomZipDownloadServiceUrl: If defined, this is the URL of the zipping service outside the main application server where zip downloads should be directed (instead of /api/access/datafiles/).\n+- :ShibAttributeCharacterSetConversionEnabled: By default, all attributes received from Shibboleth are converted from ISO-8859-1 to UTF-8. You can disable this behavior by setting to false.\n+- :ChronologicalDateFacets: Facets with Date/Year are sorted chronologically by default, with the most recent value first. To have them sorted by number of hits, e.g. with the year with the most results first, set this to false.\n+- :NavbarGuidesUrl: Set to a fully-qualified URL which will be used for the \"User Guide\" link in the navbar.\n+- :FileValidationOnPublishEnabled: Toggles validation of the physical files in the dataset when it's published, by recalculating the checksums and comparing against the values stored in the DataFile table. By default this setting is absent and Dataverse assumes it to be true. If enabled, the validation will be performed asynchronously, similarly to how we handle assigning persistent identifiers to datafiles, with the dataset locked for the duration of the publishing process.\n+\n+### Custom Analytics Code Changes\n+\n+You should update your custom analytics code to implement necessary changes for tracking updated dataset and file buttons. There was also a fix to the analytics code that will now properly track downloads for tabular files.\n+\n+For more information, see the documentation and sample analytics code snippet provided in [Installation Guide > Configuration > Web Analytics Code](http://guides.dataverse.org/en/5.0/installation/config.html#web-analytics-code) to reflect the changes implemented in this version (#6938/#6684).\n+\n+### Tracking Users' IP Addresses Behind an Address-Masking Proxy\n+\n+It is now possible to collect real user IP addresses in MDC logs and/or set up an IP group on a system running behind a proxy/load balancer that hides the addresses of incoming requests. See \"Recording User IP Addresses\" in the Configuration section of the [Installation Guide](http://guides.dataverse.org/en/5.0/installation/config.rst).\n+\n+### Reload Astrophysics Metadata Block (if used)\n+\n+Tooltips have been updated for the Astrophysics Metadata Block. If you'd like these updated Tooltips to be displayed to users of your installation, you should update the Astrophysics Metadata Block:\n+\n+`curl http://localhost:8080/api/admin/datasetfield/load -X POST --data-binary @astrophysics.tsv -H \"Content-type: text/tab-separated-values\"`\n+\n+We've included this in the step-by-step instructions below.\n+\n+### Run ReExportall\n+\n+We made changes to the JSON Export in this release. If you'd like these changes to reflected in your JSON exports, you should run ReExportall as part of the upgrade process following the steps in [Admin Guide](http://guides.dataverse.org/en/5.0/admin/metadataexport.html?highlight=export#batch-exports-through-the-api)\n+\n+We've included this in the step-by-step instructions below.\n+\n+## Notes for Tool Developers and Integrators\n+\n+## Complete List of Changes\n+\n+For the complete list of code changes in this release, see the [5.0 Milestone](https://github.com/IQSS/dataverse/milestone/89?closed=1) in Github.\n+\n+For help with upgrading, installing, or general questions please post to the [Dataverse Google Group](https://groups.google.com/forum/#!forum/dataverse-community) or email support@dataverse.org.\n+\n+## Installation\n+\n+If this is a new installation, please see our [Installation Guide](http://guides.dataverse.org/en/5.0/installation/)\n+\n+## Upgrade Dataverse from Glassfish 4.1 to Payara 5\n+\n+The instructions below describe the upgrade procedure based on moving an existing glassfish4 domain directory under Payara. We recommend this method instead of setting up a brand-new Payara domain using the installer because it appears to be the easiest way to recreate your current configuration and preserve all your data.\n+\n+1. Download Payara, v5.2020.2 as of this writing:\n+\n+   `curl -L -O https://github.com/payara/Payara/releases/download/payara-server-5.2020.2/payara-5.2020.2.zip`\n+   `sha256sum payara-5.2020.2.zip`\n+      1f5f7ea30901b1b4c7bcdfa5591881a700c9b7e2022ae3894192ba97eb83cc3e\n+\n+2. Unzip it somewhere (/usr/local is a safe bet)\n+\n+   `sudo unzip payara-5.2020.2.zip -d /usr/local/`\n+\n+3. Copy the Postgres driver to /usr/local/payara5/glassfish/lib\n+\n+   `sudo cp /usr/local/glassfish4/glassfish/lib/postgresql-42.2.9.jar /usr/local/payara5/glassfish/lib/`\n+\n+4. Move payara5/glassfish/domains/domain1 out of the way\n+\n+   `sudo mv /usr/local/payara5/glassfish/domains/domain1 /usr/local/payara5/glassfish/domains/domain1.orig`\n+\n+5. Undeploy the Dataverse web application (if deployed; version 4.20 is assumed in the example below)\n+\n+   `sudo /usr/local/glassfish4/bin/asadmin list-applications`\n+   `sudo /usr/local/glassfish4/bin/asadmin undeploy dataverse-4.20`\n+\n+6. Stop Glassfish; copy domain1 to Payara\n+\n+   `sudo /usr/local/glassfish4/bin/asadmin stop-domain`\n+   `sudo cp -ar /usr/local/glassfish4/glassfish/domains/domain1 /usr/local/payara5/glassfish/domains/`\n+\n+7. Remove the Glassfish cache directories\n+\n+   `sudo rm -rf /usr/local/payara5/glassfish/domains/domain1/generated/`  `sudo rm -rf /usr/local/payara5/glassfish/domains/domain1/osgi-cache/`\n+\n+8. In domain.xml:\n+\n+ Replace the -XX:PermSize and -XX:MaxPermSize JVM options with -XX:MetaspaceSize and -XX:MaxMetaspaceSize.\n+\n+   <jvm-options>-XX:MetaspaceSize=256m</jvm-options>\n+   <jvm-options>-XX:MaxMetaspaceSize=512m</jvm-options>\n+\n+Set both Xmx and Xms at startup to avoid runtime re-allocation. Your Xmx value should likely be higher:\n+\n+   <jvm-options>-Xmx2048m</jvm-options>\n+   <jvm-options>-Xms2048m</jvm-options>\n+\n+Add the below JVM options beneath the -Ddataverse settings:  \n+\n+   <jvm-options>-Dfish.payara.classloading.delegate=false</jvm-options>\n+   <jvm-options>-XX:+UseG1GC</jvm-options>\n+   <jvm-options>-XX:+UseStringDeduplication</jvm-options>\n+   <jvm-options>-XX:+DisableExplicitGC</jvm-options>\n+\n+9. Change any full pathnames /usr/local/glassfish4/... to /usr/local/payara5/... or whatever it is in your case. (Specifically check the -Ddataverse.files.directory and -Ddataverse.files.file.directory JVM options)\n+\n+10. In domain1/config/jhove.conf, change the hard-coded /usr/local/glassfish4 path, as above.\n+\n+(Optional): If you renamed your service account from glassfish to payara or appserver, update the ownership permissions. The Installation Guide recommends a service account of `dataverse`:\n+\n+   `sudo chown -R dataverse /usr/local/payara5/glassfish/domains/domain1`\n+   `sudo chown -R dataverse /usr/local/payara5/glassfish/lib`\n+\n+11. You will also need to check that the service account has write permission on the files directory, if they are located outside the old Glassfish domain. And/or make sure the service account has the correct AWS credentials, if you are using S3 for storage.\n+\n+12. Finally, start Payara:\n+\n+   `sudo -u dataverse /usr/local/payara5/bin/asadmin start-domain`\n+\n+13. Deploy the Dataverse 5 warfile:\n+\n+   `sudo -u dataverse /usr/local/payara5/bin/asadmin deploy /path/to/dataverse-5.0.war`\n+\n+14. Then restart Payara:\n+\n+   `sudo -u dataverse /usr/local/payara5/bin/asadmin stop-domain`\n+   `sudo -u dataverse /usr/local/payara5/bin/asadmin start-domain`\n+\n+15. Update Astrophysics Metadata Block (if used)\n+\n+   `wget https://github.com/IQSS/dataverse/releases/download/5.0/astrophysics.tsv`\n+   `curl http://localhost:8080/api/admin/datasetfield/load -X POST --data-binary @astrophysics.tsv -H \"Content-type: text/tab-separated-values\"`\n+\n+16. (Recommended) Run ReExportall to update JSON Exports  \n+\n+   <http://guides.dataverse.org/en/5.0/admin/metadataexport.html?highlight=export#batch-exports-through-the-api>\n+\n+17. For installations using DataCite, pre-register DOIs:", "originalCommit": "9e96567fedf52577532676e0f3d6597354725f65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU5ODU5MA==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r470598590", "bodyText": "We've done this previously, that is, added it in the notes above and called out and individual step.\nI added a (Recommended for installations using DataCite) at the start of the instruction. I also added a note for Add doi.dataciterestapiurlstring\nLet me know what you think following the updates in abc4d9b", "author": "djbrooke", "createdAt": "2020-08-14T12:39:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI1NzEyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI1NzYxNA==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r470257614", "bodyText": "similarly, this is already explained in its own section above - not sure it needs to be repeated in the upgrade-to-payara instruction - ?", "author": "landreev", "createdAt": "2020-08-13T21:25:01Z", "path": "doc/release-notes/5.0-release-notes.md", "diffHunk": "@@ -0,0 +1,321 @@\n+# Dataverse 5.0\n+\n+This release brings new features, enhancements, and bug fixes to Dataverse. Thank you to all of the community members who contributed code, suggestions, bug reports, and other assistance across the project.\n+\n+Please note that this is a major release and these are long release notes. We offer no apologies. :)\n+\n+## Release Highlights\n+\n+### Continued Dataset and File Redesign: Dataset and File Button Redesign, Responsive Layout\n+\n+The buttons available on the Dataset and File pages have been redesigned. This change is to provide more scalability for future expanded options for data access and exploration, and to provide a consistent experience between the two pages. The dataset and file pages have also been redesigned to be more responsive and function better across multiple devices.\n+\n+This is an important step in the incremental process of the Dataset and File Redesign project, following the release of on-page previews, filtering and sorting options, tree view, and other enhancements. Additional features in support of these redesign efforts will follow in later 5.x releases.\n+\n+### Payara 5\n+\n+A major upgrade of the application server provides security updates, access to new features like MicroProfile Config API, and will enable upgrades to other core technologies.\n+\n+Note that moving from Glassfish to Payara will be required as part of the move to Dataverse 5.\n+\n+### Download Dataset\n+\n+Users can now more easily download all files in Dataset through both the UI and API. If this causes server instability, it's suggested that Dataverse Installation Administrators take advantage of the new Standalone Zipper Service described below.\n+\n+#### Download All Option on the Dataset Page\n+\n+In previous versions of Dataverse, downloading all files from a dataset meant several clicks to select files and initiate the download. The Dataset Page now includes a Download All option for both the original and archival formats of the files in a dataset under the \"Access Dataset\" button.\n+\n+#### Download All Files in a Dataset by API\n+\n+In previous versions of Dataverse, downloading all files from a dataset via API was a two step process:\n+\n+- Find all the database ids of the files.\n+- Download all the files, using those ids (comma-separated).\n+\n+Now you can download all files from a dataset (assuming you have access to them) via API by passing the dataset persistent ID (PID such as DOI or Handle) or the dataset's database id. Versions are also supported, and you can pass :draft, :latest, :latest-published, or numbers (1.1, 2.0) similar to the \"download metadata\" API.\n+\n+### A Multi-File, Zipped Download Optimization\n+\n+In this release we are offering an experimental optimization for the multi-file, download-as-zip functionality. If this option is enabled, instead of enforcing size limits, we attempt to serve all the files that the user requested (that they are authorized to download), but the request is redirected to a standalone zipper service running as a cgi executable. Thus moving these potentially long-running jobs completely outside the Application Server (Payara); and preventing service threads from becoming locked serving them. Since zipping is also a CPU-intensive task, it is possible to have this service running on a different host system, thus freeing the cycles on the main Application Server. The system running the service needs to have access to the database as well as to the storage filesystem, and/or S3 bucket.\n+\n+Please consult the scripts/zipdownload/README.md in the Dataverse 5 source tree.\n+\n+The components of the standalone \"zipper tool\" can also be downloaded\n+here:\n+\n+https://github.com/IQSS/dataverse/releases/download/v5.0/zipper.zip\n+\n+### Updated File Handling\n+\n+Files without extensions can now be uploaded through the UI. This release also changes the way Dataverse handles duplicate (filename or checksum) files in a dataset. Specifically:\n+\n+- Files with the same checksum can be included in a dataset, even if the files are in the same directory.\n+- Files with the same filename can be included in a dataset as long as the files are in different directories.\n+- If a user uploads a file to a directory where a file already exists with that directory/filename combination, Dataverse will adjust the file path and names by adding \"-1\" or \"-2\" as applicable. This change will be visible in the list of files being uploaded.\n+- If the directory or name of an existing or newly uploaded file is edited in such a way that would create a directory/filename combination that already exists, Dataverse will display an error.\n+- If a user attempts to replace a file with another file that has the same checksum, an error message will be displayed and the file will not be able to be replaced.\n+- If a user attempts to replace a file with a file that has the same checksum as a different file in the dataset, a warning will be displayed.\n+- Files without extensions can now be uploaded through the UI.\n+\n+### Pre-Publish DOI Reservation with DataCite\n+\n+Dataverse installations using DataCite will have DOIs reserved as \"draft\" with DataCite when the Dataset is created, instead of the DOI reservation taking place locally at create time and the reservation and switch to \"findable\" taking place with DataCite at publish time. This allows the DOI to reserved earlier in the publication process.\n+\n+### Primefaces 8\n+\n+Primefaces, the open source UI framework upon which the Dataverse front end is built, has been updated to the most recent version. This provides security updates and bug fixes and will also allow Dataverse developers to take advantage of new features and enhancements.\n+\n+## Major Use Cases\n+\n+Newly-supported use cases in this release include:\n+\n+- Users will be presented with a new workflow around dataset and file access and exploration. (Issue #6684, PR #6909)\n+- Users will experience a UI appropriate across a variety of device sizes. (Issue #6684, PR #6909)\n+- Users will be able to download an entire dataset without needing to select all the files in that dataset. (Issue #6564, PR #6262)\n+- Users will be able to download all files in a dataset with a single API call. (Issue #4529, PR #7086)\n+- Users will have DOIs reserved for their datasets upon dataset create instead of at publish time. (Issue #5093, PR #6901)\n+- Users will be able to upload files without extensions. (Issue #6634, PR #6804)\n+- Users will be able to upload files with the same name in a dataset, as long as a those files are in different file paths. (Issue #4813, PR #6924)\n+- Users will be able to upload files with the same checksum in a dataset. (Issue #4813, PR #6924)\n+- Users will be less likely to encounter locks during the publishing process due to PID providers being unavailable. (Issue #6918, PR #7118)\n+- Users will now have their files validated during publish, and in the unlikely event that anything has happened to the files between deposit and publish, they will be able to take corrective action. (Issue #6558, PR #6790)\n+- Administrators will likely see more success with Harvesting, as many minor harvesting issues have been resolved. (Issues #7127, #7128, #4597, #7056, #7052, #7023, #7009, and #7003)\n+- Administrators can now enable an external zip service that frees up application server resources and allows the zip download limit to be increased. (Issue #6505, PR #6986)\n+- Administrators can now create groups based on users' email domains. (Issue #6936, PR #6974)\n+- Administrators can now set date facets to be organized chronologically. (Issue #4977, PR #6958)\n+- Administrators can now link harvested datasets using an API. (Issue #5886, PR #6935)\n+- Administrators can now destroy datasets with mapped shapefiles. (Issue #4093, PR #6860)\n+\n+## Notes for Dataverse Installation Administrators\n+\n+### Glassfish to Payara\n+\n+This upgrade requires a few extra steps. See the detailed upgrade instructions below.\n+\n+### Dataverse Installations Using DataCite: Upgrade Action Required\n+\n+If you are using DataCite as your DOI provider you must add a new JVM option called \"doi.dataciterestapiurlstring\" with a value of \"https://api.datacite.org\" for production environments and \"https://api.test.datacite.org\" for test environments. More information about this JVM option can be found in the [Installation Guide](http://guides.dataverse.org/en/5.0/installation/).\n+\n+\"doi.mdcbaseurlstring\" should be deleted if it was previously set.\n+\n+### Dataverse Installations Using DataCite: Upgrade Action Recommended\n+\n+For installations that are using DataCite, Dataverse v5.0 introduces a change in the process of registering the Persistent Identifier (DOI) for a dataset. Instead of registering it when the dataset is published for the first time, Dataverse will try to \"reserve\" the DOI when it's created (by registering it as a \"draft\", using DataCite terminology). When the user publishes the dataset, the DOI will be publicized as well (by switching the registration status to \"findable\"). This approach makes the process of publishing datasets simpler and less error-prone.\n+\n+New APIs have been provided for finding any unreserved DataCite-issued DOIs in your Dataverse, and for reserving them (see below). While not required - the user can still attempt to publish a dataset with an unreserved DOI - having all the identifiers reserved ahead of time is recommended. If you are upgrading an installation that uses DataCite, we specifically recommend that you reserve the DOIs for all your pre-existing unpublished drafts as soon as Dataverse v5.0 is deployed, since none of them were registered at create time. This can be done using the following API calls:  \n+\n+- `/api/pids/unreserved`  will report the ids of the datasets\n+- `/api/pids/:persistentId/reserve` reserves the assigned DOI with DataCite (will need to be run on every id reported by the the first API).\n+\n+See the [Native API Guide](http://guides.dataverse.org/en/5.0/api/native-api.html) for more information.\n+\n+Scripted, the whole process would look as follows (adjust as needed):\n+\n+```\n+   API_TOKEN='xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'\n+\n+   curl -s -H \"X-Dataverse-key:$API_TOKEN\" http://localhost:8080/api/pids/unreserved |\n+   # the API outputs JSON; note the use of jq to parse it:\n+   jq '.data.count[].pid' | tr -d '\"' | \n+   while read doi\n+   do\n+      curl -s -H \"X-Dataverse-key:$API_TOKEN\" -X POST http://localhost:8080/api/pids/:persistentId/reserve?persistentId=$doi\n+   done\n+```\n+\n+Going forward, once all the DOIs have been reserved for the legacy drafts, you may still get an occasional dataset with an unreserved identifier. DataCite service instability would be a potential cause. There is no reason to expect that to happen often, but it is not impossible. You may consider running the script above (perhaps with some extra diagnostics added) regularly, from a cron job or otherwise, to address this preemptively.\n+\n+### Terms of Use Display Updates\n+\n+In this release we\u2019ve fixed an issue that would cause the Application Terms of Use to not display when the user's language is set to a language that does not match one of the languages for which terms were created and registered for that Dataverse installation. Instead of the expected Terms of Use, users signing up could receive the \u201cThere are no Terms of Use for this Dataverse installation\u201d message. This could potentially result in some users signing up for an account without having the proper Terms of Use displayed. This will only affect installations that use the :ApplicationTermsOfUse setting.\n+\n+Please note that there is not currently a native workflow in Dataverse to display updated Terms of Use to a user or to force re-agreement. This would only potentially affect users that have signed up since the upgrade to 4.17 (or a following release if 4.17 was skipped).\n+\n+### Datafiles Validation when Publishing Datasets\n+\n+When a user requests to publish a dataset, Dataverse will now attempt to validate the physical files in the dataset, by recalculating the checksums and verifying them against the values in the database. The goal is to prevent any corrupted files in published datasets. Most of all the instances of actual damage to physical files that we've seen in the past happened while the datafiles were still in the Draft state. (Physical files become essentially read-only once published). So this is the logical place to catch any such issues.\n+\n+If any files in the dataset fail the validation, the dataset does not get published, and the user is notified that they need to contact their Dataverse support in order to address the issue before another attempt to publish can be made. See the \"Troubleshooting\" section of the Guide on how to fix such problems.\n+\n+This validation will be performed asynchronously, the same way as the registration of the file-level persistent ids. Similarly to the file PID registration, this validation process can be disabled on your system, with the setting `:FileValidationOnPublishEnabled`. (A Dataverse admin may choose to disable it if, for example, they are already running an external auditing system to monitor the integrity of the files in their Dataverse, and would prefer the publishing process to take less time). See the Configuration section of the [Installation Guide](http://guides.dataverse.org/en/5.0/installation/config.rst).\n+\n+Please note that we are not aware of any bugs in the current versions of Dataverse that would result in damage to users' files. But you may have some legacy files in your archive that were affected by some issue in the past, or perhaps affected by something outside Dataverse, so we are adding this feature out of abundance of caution. An example of a problem we've experienced in the early versions of Dataverse was a possible scenario where a user actually attempted to delete a Draft file from an unpublished version, where the database transaction would fail for whatever reason, but only after the physical file had already been deleted from the filesystem. Thus resulting in a datafile entry remaining in the dataset, but with the corresponding physical file missing. The fix for this case, since the user wanted to delete the file in the first place, is simply to confirm it and purge the datafile entity from the database.\n+\n+### The Setting :PIDAsynchRegFileCount is Deprecated as of 5.0\n+\n+It used to specify the number of datafiles in the dataset to warrant adding a lock during publishing. As of v5.0 all datasets get locked for the duration of the publishing process. The setting will be ignored if present.\n+\n+### Location Changes for Related Projects\n+\n+The dataverse-ansible and dataverse-previewers repositories have been moved to the GDCC Organization on GitHub. If you have been referencing the dataverse-ansible repository from IQSS and the dataverse-previewers from QDR, please instead use them from their new locations:\n+\n+<https://github.com/GlobalDataverseCommunityConsortium/dataverse-ansible>\n+<https://github.com/GlobalDataverseCommunityConsortium/dataverse-previewers>\n+\n+### Harvesting Improvements\n+\n+Many updates have been made to address common Harvesting failures. You may see Harvests complete more often and have a higher success rate on a dataset-by-dataset basis.\n+\n+### New JVM Options and Database Settings\n+\n+Several new JVM options and DB Settings have been added in this release. More documentation about each of these settings can be found in the Configuration section of the [Installation Guide](http://guides.dataverse.org/en/5.0/installation/config.rst).\n+\n+#### New JVM Options\n+\n+- doi.dataciterestapiurlstring: Set with a value of \"https://api.datacite.org\" for production environments and \"https://api.test.datacite.org\" for test environments. Must be set if you are using DataCite as your DOI provider.\n+- dataverse.useripaddresssourceheader: If set, specifies an HTTP Header such as X-Forwarded-For to use to retrieve the user's IP address. This setting is useful in cases such as running Dataverse behind load balancers where the default option of getting the Remote Address from the servlet isn't correct (e.g. it would be the load balancer IP address). Note that unless your installation always sets the header you configure here, this could be used as a way to spoof the user's address. See the Configuration section of the [Installation Guide](http://guides.dataverse.org/en/5.0/installation/config.rst) for more information about proper use and security concerns.\n+- http.request-timeout-seconds: To facilitate large file upload and download, the Dataverse installer bumps the Payara **server-config.network-config.protocols.protocol.http-listener-1.http.request-timeout-seconds** setting from its default 900 seconds (15 minutes) to 1800 (30 minutes).\n+\n+#### New Database Settings\n+\n+- :CustomZipDownloadServiceUrl: If defined, this is the URL of the zipping service outside the main application server where zip downloads should be directed (instead of /api/access/datafiles/).\n+- :ShibAttributeCharacterSetConversionEnabled: By default, all attributes received from Shibboleth are converted from ISO-8859-1 to UTF-8. You can disable this behavior by setting to false.\n+- :ChronologicalDateFacets: Facets with Date/Year are sorted chronologically by default, with the most recent value first. To have them sorted by number of hits, e.g. with the year with the most results first, set this to false.\n+- :NavbarGuidesUrl: Set to a fully-qualified URL which will be used for the \"User Guide\" link in the navbar.\n+- :FileValidationOnPublishEnabled: Toggles validation of the physical files in the dataset when it's published, by recalculating the checksums and comparing against the values stored in the DataFile table. By default this setting is absent and Dataverse assumes it to be true. If enabled, the validation will be performed asynchronously, similarly to how we handle assigning persistent identifiers to datafiles, with the dataset locked for the duration of the publishing process.\n+\n+### Custom Analytics Code Changes\n+\n+You should update your custom analytics code to implement necessary changes for tracking updated dataset and file buttons. There was also a fix to the analytics code that will now properly track downloads for tabular files.\n+\n+For more information, see the documentation and sample analytics code snippet provided in [Installation Guide > Configuration > Web Analytics Code](http://guides.dataverse.org/en/5.0/installation/config.html#web-analytics-code) to reflect the changes implemented in this version (#6938/#6684).\n+\n+### Tracking Users' IP Addresses Behind an Address-Masking Proxy\n+\n+It is now possible to collect real user IP addresses in MDC logs and/or set up an IP group on a system running behind a proxy/load balancer that hides the addresses of incoming requests. See \"Recording User IP Addresses\" in the Configuration section of the [Installation Guide](http://guides.dataverse.org/en/5.0/installation/config.rst).\n+\n+### Reload Astrophysics Metadata Block (if used)\n+\n+Tooltips have been updated for the Astrophysics Metadata Block. If you'd like these updated Tooltips to be displayed to users of your installation, you should update the Astrophysics Metadata Block:\n+\n+`curl http://localhost:8080/api/admin/datasetfield/load -X POST --data-binary @astrophysics.tsv -H \"Content-type: text/tab-separated-values\"`\n+\n+We've included this in the step-by-step instructions below.\n+\n+### Run ReExportall\n+\n+We made changes to the JSON Export in this release. If you'd like these changes to reflected in your JSON exports, you should run ReExportall as part of the upgrade process following the steps in [Admin Guide](http://guides.dataverse.org/en/5.0/admin/metadataexport.html?highlight=export#batch-exports-through-the-api)\n+\n+We've included this in the step-by-step instructions below.\n+\n+## Notes for Tool Developers and Integrators\n+\n+## Complete List of Changes\n+\n+For the complete list of code changes in this release, see the [5.0 Milestone](https://github.com/IQSS/dataverse/milestone/89?closed=1) in Github.\n+\n+For help with upgrading, installing, or general questions please post to the [Dataverse Google Group](https://groups.google.com/forum/#!forum/dataverse-community) or email support@dataverse.org.\n+\n+## Installation\n+\n+If this is a new installation, please see our [Installation Guide](http://guides.dataverse.org/en/5.0/installation/)\n+\n+## Upgrade Dataverse from Glassfish 4.1 to Payara 5\n+\n+The instructions below describe the upgrade procedure based on moving an existing glassfish4 domain directory under Payara. We recommend this method instead of setting up a brand-new Payara domain using the installer because it appears to be the easiest way to recreate your current configuration and preserve all your data.\n+\n+1. Download Payara, v5.2020.2 as of this writing:\n+\n+   `curl -L -O https://github.com/payara/Payara/releases/download/payara-server-5.2020.2/payara-5.2020.2.zip`\n+   `sha256sum payara-5.2020.2.zip`\n+      1f5f7ea30901b1b4c7bcdfa5591881a700c9b7e2022ae3894192ba97eb83cc3e\n+\n+2. Unzip it somewhere (/usr/local is a safe bet)\n+\n+   `sudo unzip payara-5.2020.2.zip -d /usr/local/`\n+\n+3. Copy the Postgres driver to /usr/local/payara5/glassfish/lib\n+\n+   `sudo cp /usr/local/glassfish4/glassfish/lib/postgresql-42.2.9.jar /usr/local/payara5/glassfish/lib/`\n+\n+4. Move payara5/glassfish/domains/domain1 out of the way\n+\n+   `sudo mv /usr/local/payara5/glassfish/domains/domain1 /usr/local/payara5/glassfish/domains/domain1.orig`\n+\n+5. Undeploy the Dataverse web application (if deployed; version 4.20 is assumed in the example below)\n+\n+   `sudo /usr/local/glassfish4/bin/asadmin list-applications`\n+   `sudo /usr/local/glassfish4/bin/asadmin undeploy dataverse-4.20`\n+\n+6. Stop Glassfish; copy domain1 to Payara\n+\n+   `sudo /usr/local/glassfish4/bin/asadmin stop-domain`\n+   `sudo cp -ar /usr/local/glassfish4/glassfish/domains/domain1 /usr/local/payara5/glassfish/domains/`\n+\n+7. Remove the Glassfish cache directories\n+\n+   `sudo rm -rf /usr/local/payara5/glassfish/domains/domain1/generated/`  `sudo rm -rf /usr/local/payara5/glassfish/domains/domain1/osgi-cache/`\n+\n+8. In domain.xml:\n+\n+ Replace the -XX:PermSize and -XX:MaxPermSize JVM options with -XX:MetaspaceSize and -XX:MaxMetaspaceSize.\n+\n+   <jvm-options>-XX:MetaspaceSize=256m</jvm-options>\n+   <jvm-options>-XX:MaxMetaspaceSize=512m</jvm-options>\n+\n+Set both Xmx and Xms at startup to avoid runtime re-allocation. Your Xmx value should likely be higher:\n+\n+   <jvm-options>-Xmx2048m</jvm-options>\n+   <jvm-options>-Xms2048m</jvm-options>\n+\n+Add the below JVM options beneath the -Ddataverse settings:  \n+\n+   <jvm-options>-Dfish.payara.classloading.delegate=false</jvm-options>\n+   <jvm-options>-XX:+UseG1GC</jvm-options>\n+   <jvm-options>-XX:+UseStringDeduplication</jvm-options>\n+   <jvm-options>-XX:+DisableExplicitGC</jvm-options>\n+\n+9. Change any full pathnames /usr/local/glassfish4/... to /usr/local/payara5/... or whatever it is in your case. (Specifically check the -Ddataverse.files.directory and -Ddataverse.files.file.directory JVM options)\n+\n+10. In domain1/config/jhove.conf, change the hard-coded /usr/local/glassfish4 path, as above.\n+\n+(Optional): If you renamed your service account from glassfish to payara or appserver, update the ownership permissions. The Installation Guide recommends a service account of `dataverse`:\n+\n+   `sudo chown -R dataverse /usr/local/payara5/glassfish/domains/domain1`\n+   `sudo chown -R dataverse /usr/local/payara5/glassfish/lib`\n+\n+11. You will also need to check that the service account has write permission on the files directory, if they are located outside the old Glassfish domain. And/or make sure the service account has the correct AWS credentials, if you are using S3 for storage.\n+\n+12. Finally, start Payara:\n+\n+   `sudo -u dataverse /usr/local/payara5/bin/asadmin start-domain`\n+\n+13. Deploy the Dataverse 5 warfile:\n+\n+   `sudo -u dataverse /usr/local/payara5/bin/asadmin deploy /path/to/dataverse-5.0.war`\n+\n+14. Then restart Payara:\n+\n+   `sudo -u dataverse /usr/local/payara5/bin/asadmin stop-domain`\n+   `sudo -u dataverse /usr/local/payara5/bin/asadmin start-domain`\n+\n+15. Update Astrophysics Metadata Block (if used)\n+\n+   `wget https://github.com/IQSS/dataverse/releases/download/5.0/astrophysics.tsv`\n+   `curl http://localhost:8080/api/admin/datasetfield/load -X POST --data-binary @astrophysics.tsv -H \"Content-type: text/tab-separated-values\"`\n+\n+16. (Recommended) Run ReExportall to update JSON Exports  \n+\n+   <http://guides.dataverse.org/en/5.0/admin/metadataexport.html?highlight=export#batch-exports-through-the-api>\n+\n+17. For installations using DataCite, pre-register DOIs:\n+\n+   `/api/pids/unreserved`  will report the ids of the datasets\n+   `/api/pids/:persistentId/reserve` reserves the assigned DOI with DataCite (will need to be run on every id reported by the the first API).\n+\n+   Scripted, the whole process would look as follows (adjust as needed):\n+\n+```\n+   API_TOKEN='xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'\n+\n+   curl -s -H \"X-Dataverse-key:$API_TOKEN\" http://localhost:8080/api/pids/unreserved |\n+   # the API outputs JSON; note the use of jq to parse it:\n+   jq '.data.count[].pid' | tr -d '\"' | \n+   while read doi\n+   do\n+      curl -s -H \"X-Dataverse-key:$API_TOKEN\" -X POST http://localhost:8080/api/pids/:persistentId/reserve?persistentId=$doi\n+   done\n+```\n+\n+18. Set up Standalone Zipper Service if desired. Please consult the scripts/zipdownload/README.md in the Dataverse 5 source tree for more information. ", "originalCommit": "9e96567fedf52577532676e0f3d6597354725f65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU5OTcyNw==", "url": "https://github.com/IQSS/dataverse/pull/7164#discussion_r470599727", "bodyText": "I added the experimental note in abc4d9b. I think it's fine to add this in two different instruction formats and it matches what we've done in previous notes but if you feel strongly I can revisit. I don't do the upgrades myself so if this sort of thing is not helpful to mention multiple times I'm fine to adjust it.", "author": "djbrooke", "createdAt": "2020-08-14T12:41:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI1NzYxNA=="}], "type": "inlineReview"}, {"oid": "2ec68b34c4671203fc1360ff88d0de95989d61d6", "url": "https://github.com/IQSS/dataverse/commit/2ec68b34c4671203fc1360ff88d0de95989d61d6", "message": "rewriting based on CR Feedback", "committedDate": "2020-08-14T12:25:47Z", "type": "commit"}, {"oid": "c593f89bff1e4ba3e5988bc9dd81708ff739f0a1", "url": "https://github.com/IQSS/dataverse/commit/c593f89bff1e4ba3e5988bc9dd81708ff739f0a1", "message": "removing existing settings", "committedDate": "2020-08-14T12:29:35Z", "type": "commit"}, {"oid": "abc4d9bc136d027862dab7b8b72381b89e340d9a", "url": "https://github.com/IQSS/dataverse/commit/abc4d9bc136d027862dab7b8b72381b89e340d9a", "message": "add \"recommended\" and added an instruction for updating the doi.dataciterestapiurlstring setting", "committedDate": "2020-08-14T12:38:54Z", "type": "commit"}, {"oid": "f8a221e58cadf8d673a46d8db898c6428c91710b", "url": "https://github.com/IQSS/dataverse/commit/f8a221e58cadf8d673a46d8db898c6428c91710b", "message": "reorganized the upgrade instruction", "committedDate": "2020-08-14T14:30:13Z", "type": "commit"}, {"oid": "12bb8fcbc2697cc4e2cc3df4eac45c5e70f01651", "url": "https://github.com/IQSS/dataverse/commit/12bb8fcbc2697cc4e2cc3df4eac45c5e70f01651", "message": "making the linter happy", "committedDate": "2020-08-14T14:40:21Z", "type": "commit"}]}