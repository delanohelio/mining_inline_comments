{"pr_number": 7222, "pr_title": "Security18 hibernate validator vulnerability", "pr_createdAt": "2020-08-24T21:11:43Z", "pr_url": "https://github.com/IQSS/dataverse/pull/7222", "timeline": [{"oid": "76c0b3c00e211e83f7c0e2d035fc1eb52066c4c3", "url": "https://github.com/IQSS/dataverse/commit/76c0b3c00e211e83f7c0e2d035fc1eb52066c4c3", "message": "The version pf hibernate-validator that we were using, 5.0.3.Final was reported to allow an attacker to escalate permissions and access private values and create invalid instances - see CVE-2017-7536. It is reported to be fixed in versions 5.2.5.Final and greater.\n\nThe upgraded library had changes to the api for constructing ConstaintValidatorContextImpl, used in URLValidatorTest.java. In investigating the changes, it was found that there were further changes to the api in recent versions and it was decided to adapt the code to the latest changes and use the latest available stable hibernate-validator library - 6.1.5.Final.\n\nIt was also necessary to add a dependency to javax.el due to changes in the library starting with version 5.3.1.Final and later.", "committedDate": "2020-08-20T16:48:16Z", "type": "commit"}, {"oid": "438a7d0b4a317abae32d0116beed5d377c8b1b6d", "url": "https://github.com/IQSS/dataverse/commit/438a7d0b4a317abae32d0116beed5d377c8b1b6d", "message": "code cleanup", "committedDate": "2020-08-20T17:49:41Z", "type": "commit"}, {"oid": "ab33496e6bc3b62c0de83e94a011dbd6a48142c1", "url": "https://github.com/IQSS/dataverse/commit/ab33496e6bc3b62c0de83e94a011dbd6a48142c1", "message": "sorry, one more line of commented code removed", "committedDate": "2020-08-20T17:53:40Z", "type": "commit"}, {"oid": "df442c5c4ccd84a02169adda11f0ebda52833833", "url": "https://github.com/IQSS/dataverse/commit/df442c5c4ccd84a02169adda11f0ebda52833833", "message": "Change ek dependency to jakarta.el provided by Payara", "committedDate": "2020-08-20T20:31:45Z", "type": "commit"}, {"oid": "a7fcdfa9a1891fb73c58467c5aaa6d09a369dd24", "url": "https://github.com/IQSS/dataverse/commit/a7fcdfa9a1891fb73c58467c5aaa6d09a369dd24", "message": "Use hibernate-validator provided with Payara (still a 6.1.x -6.1.2 specifically at this point)", "committedDate": "2020-08-20T21:50:13Z", "type": "commit"}, {"oid": "1dd243115af5e04eba4d3a4751fa42d20bcc7064", "url": "https://github.com/IQSS/dataverse/commit/1dd243115af5e04eba4d3a4751fa42d20bcc7064", "message": "changed hibernat-validator scope from provided to compile, because we were getting NoClassDefFoundError: org/hibernate/validator/internal/util/CollectionHelper at runtime while creating an account", "committedDate": "2020-08-25T21:52:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzA5ODQzNg==", "url": "https://github.com/IQSS/dataverse/pull/7222#discussion_r477098436", "bodyText": "I doubt this is necessary. There isn't a single use of this package as far as I know from the codebase. Using EL in JSF usually doesn't imply adding it to the direct dependencies. Your commit message states it had been added because of the validator dependency, but the Payara BOM already should take care of that. Please try to remove and test.", "author": "poikilotherm", "createdAt": "2020-08-26T07:42:16Z", "path": "pom.xml", "diffHunk": "@@ -294,9 +294,14 @@\n             <version>1.7</version> <!-- Or 1.8-SNAPSHOT -->\n         </dependency>\n         <dependency>\n-            <groupId>org.hibernate</groupId>\n+            <groupId>org.hibernate.validator</groupId>\n             <artifactId>hibernate-validator</artifactId>\n-            <version>5.0.3.Final</version>\n+            <scope>compile</scope>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.glassfish</groupId>\n+            <artifactId>jakarta.el</artifactId>\n+            <scope>provided</scope>", "originalCommit": "1dd243115af5e04eba4d3a4751fa42d20bcc7064", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzMwNjMwMg==", "url": "https://github.com/IQSS/dataverse/pull/7222#discussion_r477306302", "bodyText": "Tested this again without jakarta.el - brings back the problem it was addressing\nTest set: edu.harvard.iq.dataverse.ingest.IngestUtilTest\nTests run: 12, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 0.121 s <<< FAILURE! - in edu.harvard.iq.dataverse.ingest.IngestUtilTest\ntestDirectoryLabels  Time elapsed: 0.103 s  <<< ERROR!\njavax.validation.ValidationException: HV000183: Unable to initialize 'javax.el.ExpressionFactory'. Check that you have the EL dependencies on the classpath, or use ParameterMessageInterpolator instead\nat edu.harvard.iq.dataverse.ingest.IngestUtilTest.testDirectoryLabels(IngestUtilTest.java:473)", "author": "rtreacy", "createdAt": "2020-08-26T13:37:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzA5ODQzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzA5ODY4Mw==", "url": "https://github.com/IQSS/dataverse/pull/7222#discussion_r477098683", "bodyText": "This should remain provided or be deleted, as compile is the default.", "author": "poikilotherm", "createdAt": "2020-08-26T07:42:43Z", "path": "pom.xml", "diffHunk": "@@ -294,9 +294,14 @@\n             <version>1.7</version> <!-- Or 1.8-SNAPSHOT -->\n         </dependency>\n         <dependency>\n-            <groupId>org.hibernate</groupId>\n+            <groupId>org.hibernate.validator</groupId>\n             <artifactId>hibernate-validator</artifactId>\n-            <version>5.0.3.Final</version>\n+            <scope>compile</scope>", "originalCommit": "1dd243115af5e04eba4d3a4751fa42d20bcc7064", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzEwMjE3MQ==", "url": "https://github.com/IQSS/dataverse/pull/7222#discussion_r477102171", "bodyText": "IMHO you should take a look at this:\n\nWe're using an internal validator class in our code and I'm not sure if this is a supported use case. This should be refactored and use Java 8 Collections API.", "author": "poikilotherm", "createdAt": "2020-08-26T07:48:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzA5ODY4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzEwNjIxNg==", "url": "https://github.com/IQSS/dataverse/pull/7222#discussion_r477106216", "bodyText": "BTW @kcondon I noticed you're testing on Payara 5.201. It's not important for this issue (both 5.201 up to 5.2020.4 use Hibernate Validator 6.1.2 Final), but we should make sure that testers, QA etc all use the same version referenced in pom.xml.", "author": "poikilotherm", "createdAt": "2020-08-26T07:55:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzA5ODY4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzMwODgzMA==", "url": "https://github.com/IQSS/dataverse/pull/7222#discussion_r477308830", "bodyText": "@poikilotherm - I suspected that this was the reason I couldn't use provided, but refactoring the BuiltInGroupsProvider code is a separate issue IMHO", "author": "rtreacy", "createdAt": "2020-08-26T13:40:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzA5ODY4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzEwMDU5Nw==", "url": "https://github.com/IQSS/dataverse/pull/7222#discussion_r477100597", "bodyText": "The complete test class should be refactored to use a JUnit5 @ParameterizedTest, usable for both unit tests.\nThe context object should be mocked. Creating a real object is of no use here and at least on my machine creates errors. Happy to create a PR against this PR.", "author": "poikilotherm", "createdAt": "2020-08-26T07:46:01Z", "path": "src/test/java/edu/harvard/iq/dataverse/URLValidatorTest.java", "diffHunk": "@@ -35,15 +39,15 @@ public void testIsValidWithUnspecifiedContext() {\n     @Test\n     public void testIsValidWithContextAndValidURL() {\n         String value = \"https://twitter.com/\";\n-        ConstraintValidatorContext context = new ConstraintValidatorContextImpl(null, PathImpl.createPathFromString(\"\"), null);\n+        ConstraintValidatorContext context = new ConstraintValidatorContextImpl(validatorFactory.getClockProvider(), PathImpl.createPathFromString(\"\"),null, null);\n \n         assertEquals(true, new URLValidator().isValid(value, context));\n     }\n \n     @Test\n     public void testIsValidWithContextButInvalidURL() {\n         String value = \"cnn.com\";\n-        ConstraintValidatorContext context = new ConstraintValidatorContextImpl(null, PathImpl.createPathFromString(\"\"), null);\n+        ConstraintValidatorContext context = new ConstraintValidatorContextImpl(validatorFactory.getClockProvider(), PathImpl.createPathFromString(\"\"),null, null);", "originalCommit": "1dd243115af5e04eba4d3a4751fa42d20bcc7064", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7f3051a93715a1780ea9c7a2e0a6ffcf3381ae6b", "url": "https://github.com/IQSS/dataverse/commit/7f3051a93715a1780ea9c7a2e0a6ffcf3381ae6b", "message": "Remove compile scope as unneccessary because it is the default scope", "committedDate": "2020-08-26T13:44:35Z", "type": "commit"}, {"oid": "5e3b6acb5b13ce7a11d863125eb6228f0f2c99e6", "url": "https://github.com/IQSS/dataverse/commit/5e3b6acb5b13ce7a11d863125eb6228f0f2c99e6", "message": "Last commit included experimental removal of jakarta.el, which does not work", "committedDate": "2020-08-26T14:01:04Z", "type": "commit"}]}