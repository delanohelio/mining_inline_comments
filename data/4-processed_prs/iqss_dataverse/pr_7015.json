{"pr_number": 7015, "pr_title": "only iterate over current files in latest published version", "pr_createdAt": "2020-06-24T18:59:18Z", "pr_url": "https://github.com/IQSS/dataverse/pull/7015", "timeline": [{"oid": "048bb5d191c7e55aac14720cfd453e98fde4b226", "url": "https://github.com/IQSS/dataverse/commit/048bb5d191c7e55aac14720cfd453e98fde4b226", "message": "only iterate over current files in latest published version", "committedDate": "2020-06-24T18:50:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI3NzYwOA==", "url": "https://github.com/IQSS/dataverse/pull/7015#discussion_r446277608", "bodyText": "English that users can see in the UI (including errors) should be moved to a bundle.", "author": "pdurbin", "createdAt": "2020-06-26T16:11:19Z", "path": "src/main/java/edu/harvard/iq/dataverse/engine/command/impl/CuratePublishedDatasetVersionCommand.java", "diffHunk": "@@ -85,18 +85,26 @@ public Dataset execute(CommandContext ctxt) throws CommandException {\n         Dataset tempDataset = ctxt.em().merge(getDataset());\n \n         // Look for file metadata changes and update published metadata if needed\n-        for (DataFile dataFile : tempDataset.getFiles()) {\n-            List<FileMetadata> fmdList = dataFile.getFileMetadatas();\n+        List<FileMetadata> pubFmds = updateVersion.getFileMetadatas();\n+        int pubFileCount = pubFmds.size();\n+        int newFileCount = tempDataset.getEditVersion().getFileMetadatas().size();\n+        if (pubFileCount != newFileCount) {\n+            logger.severe(\"Draft version of dataset: \" + tempDataset.getId() + \" has: \" + newFileCount + \" while last published version has \" + pubFileCount);\n+            throw new IllegalCommandException(\"Different number of files in draft version\", this);", "originalCommit": "048bb5d191c7e55aac14720cfd453e98fde4b226", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI4MDU1NA==", "url": "https://github.com/IQSS/dataverse/pull/7015#discussion_r446280554", "bodyText": "English should go in the bundle. In addition, since we have the file id, maybe it would be worth exposing it to the user in the error message, if it will help them troubleshoot the problem.", "author": "pdurbin", "createdAt": "2020-06-26T16:17:05Z", "path": "src/main/java/edu/harvard/iq/dataverse/engine/command/impl/CuratePublishedDatasetVersionCommand.java", "diffHunk": "@@ -85,18 +85,26 @@ public Dataset execute(CommandContext ctxt) throws CommandException {\n         Dataset tempDataset = ctxt.em().merge(getDataset());\n \n         // Look for file metadata changes and update published metadata if needed\n-        for (DataFile dataFile : tempDataset.getFiles()) {\n-            List<FileMetadata> fmdList = dataFile.getFileMetadatas();\n+        List<FileMetadata> pubFmds = updateVersion.getFileMetadatas();\n+        int pubFileCount = pubFmds.size();\n+        int newFileCount = tempDataset.getEditVersion().getFileMetadatas().size();\n+        if (pubFileCount != newFileCount) {\n+            logger.severe(\"Draft version of dataset: \" + tempDataset.getId() + \" has: \" + newFileCount + \" while last published version has \" + pubFileCount);\n+            throw new IllegalCommandException(\"Different number of files in draft version\", this);\n+        }\n+        for (FileMetadata publishedFmd : pubFmds) {\n+            DataFile dataFile = publishedFmd.getDataFile();\n             FileMetadata draftFmd = dataFile.getLatestFileMetadata();\n-            FileMetadata publishedFmd = null;\n-            for (FileMetadata fmd : fmdList) {\n-                if (fmd.getDatasetVersion().equals(updateVersion)) {\n-                    publishedFmd = fmd;\n-                    break;\n-                }\n-            }\n             boolean metadataUpdated = false;\n-            if (draftFmd != null && publishedFmd != null) {\n+            if (draftFmd == null || draftFmd.getDatasetVersion().equals(updateVersion)) {\n+                if (draftFmd == null) {\n+                    logger.severe(\"Unable to find latest FMD for file id: \" + dataFile.getId());\n+                } else {\n+                    logger.severe(\"No filemetadata for file id: \" + dataFile.getId() + \" in draft version\");\n+                }\n+                throw new IllegalCommandException(\"Cannot change files in the dataset\", this);", "originalCommit": "048bb5d191c7e55aac14720cfd453e98fde4b226", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a4a3911255e0a5c8084adac014af16546baffd06", "url": "https://github.com/IQSS/dataverse/commit/a4a3911255e0a5c8084adac014af16546baffd06", "message": "updates per review", "committedDate": "2020-06-26T16:49:05Z", "type": "commit"}]}