{"pr_number": 7351, "pr_title": "7344 mailgroup regex", "pr_createdAt": "2020-10-23T10:31:33Z", "pr_url": "https://github.com/IQSS/dataverse/pull/7351", "timeline": [{"oid": "35612421b060d6b8cdbf16adf2d005770e583ac7", "url": "https://github.com/IQSS/dataverse/commit/35612421b060d6b8cdbf16adf2d005770e583ac7", "message": "Replace deprecated @NotEmpty annotation in MailDomainGroup. #7344", "committedDate": "2020-10-22T13:02:33Z", "type": "commit"}, {"oid": "e6e0af450d5923b25d20d341cf8fa558a1504e7a", "url": "https://github.com/IQSS/dataverse/commit/e6e0af450d5923b25d20d341cf8fa558a1504e7a", "message": "Initial support for regexes in mail domain groups. Not tested yet, but caching in a singleton. No API yet. #7344", "committedDate": "2020-10-22T14:08:01Z", "type": "commit"}, {"oid": "8af96c83b5c75dac00dcba45083c9c44e1593d33", "url": "https://github.com/IQSS/dataverse/commit/8af96c83b5c75dac00dcba45083c9c44e1593d33", "message": "Add JSON parser & printer support for the new regex support, enabling API usage. #7344", "committedDate": "2020-10-23T09:38:25Z", "type": "commit"}, {"oid": "7f0a00b2d65ccee990c859d4eb5d0066164e44d8", "url": "https://github.com/IQSS/dataverse/commit/7f0a00b2d65ccee990c859d4eb5d0066164e44d8", "message": "Split simple mail domain groups and regex based to avoid double-processing and make code more readable. #7344", "committedDate": "2020-10-23T09:39:35Z", "type": "commit"}, {"oid": "d39dd14450a4b07412f795aff7abc401c00ed074", "url": "https://github.com/IQSS/dataverse/commit/d39dd14450a4b07412f795aff7abc401c00ed074", "message": "Add unit testing for mail domain group changes. #7344", "committedDate": "2020-10-23T09:39:56Z", "type": "commit"}, {"oid": "59c33ffaf6855d3b38d1b71a0754c6876dd57699", "url": "https://github.com/IQSS/dataverse/commit/59c33ffaf6855d3b38d1b71a0754c6876dd57699", "message": "Add DB migration for maildomaingroups regex flag support. #7344", "committedDate": "2020-10-23T09:40:31Z", "type": "commit"}, {"oid": "f6168967c16a3787eef65f82a4d4e232007f1076", "url": "https://github.com/IQSS/dataverse/commit/f6168967c16a3787eef65f82a4d4e232007f1076", "message": "Remove timer, instead trigger updates of mail domain groups cache from API calls, avoiding unnecessary CPU cycles. #7344", "committedDate": "2020-10-23T09:57:43Z", "type": "commit"}, {"oid": "5b009d6ec8a6e04ff98cad97b163719c14095b43", "url": "https://github.com/IQSS/dataverse/commit/5b009d6ec8a6e04ff98cad97b163719c14095b43", "message": "Make mail domain group service singleton scale by assigning proper lock types. #7344", "committedDate": "2020-10-23T10:00:59Z", "type": "commit"}, {"oid": "7aa42d24bf81999bf6ed89e5b9d8162ca86f2c4e", "url": "https://github.com/IQSS/dataverse/commit/7aa42d24bf81999bf6ed89e5b9d8162ca86f2c4e", "message": "Add docs about regex support for mail domain groups. #7344", "committedDate": "2020-10-23T10:18:02Z", "type": "commit"}, {"oid": "4fa63338640bef2a195d74f5c036aee461c070c4", "url": "https://github.com/IQSS/dataverse/commit/4fa63338640bef2a195d74f5c036aee461c070c4", "message": "Fix migration SQL script to use the parent entity table name. #7344", "committedDate": "2020-10-23T14:16:17Z", "type": "commit"}, {"oid": "8b523ffa2a6e085e811cd62e06dd47fabcc02d22", "url": "https://github.com/IQSS/dataverse/commit/8b523ffa2a6e085e811cd62e06dd47fabcc02d22", "message": "Cleanup maildomain group service and make it an EJB Singleton instead of CDI. Otherwise it does not start and cannot be used as a facade. #7344", "committedDate": "2020-10-23T14:16:56Z", "type": "commit"}, {"oid": "c10e11b3db51e9f712828c49834ad55fbea63e62", "url": "https://github.com/IQSS/dataverse/commit/c10e11b3db51e9f712828c49834ad55fbea63e62", "message": "Make MailDomainGroupServiceBean startup _after_ the Flyway migrations happened, as we rely on the database... #7344", "committedDate": "2020-10-23T18:20:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA4NTA0OA==", "url": "https://github.com/IQSS/dataverse/pull/7351#discussion_r511085048", "bodyText": "Can you explain a little more what you mean by this? what is cached and when?", "author": "scolapasta", "createdAt": "2020-10-23T18:57:43Z", "path": "doc/sphinx-guides/source/admin/mail-groups.rst", "diffHunk": "@@ -55,6 +55,36 @@ To load it into your Dataverse installation, either use a ``POST`` or ``PUT`` re\n \n ``curl -X POST -H 'Content-type: application/json' http://localhost:8080/api/admin/groups/domain --upload-file domainGroup1.json``\n \n+Matching with domains or regular expressions\n+^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+Adding simple domain names requires exact matches of user email domains and the configured domains of a group.\n+Although you could add multiple domains to a group, those still require exact matches.\n+\n+In addition, you can use one or multiple regular expressions instead of simple domains for a group. Those\n+should not be mixed, although it would work. Regular expressions still require exact matches, but are way more flexible.\n+\n+Some hints:\n+\n+- Due to their excessive CPU usage, regular expressions should be used rarely.\n+- Also due to their CPU usage, all domain groups are cached. Cache updates when groups change via API.", "originalCommit": "c10e11b3db51e9f712828c49834ad55fbea63e62", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEyNzU2Nw==", "url": "https://github.com/IQSS/dataverse/pull/7351#discussion_r511127567", "bodyText": "The singleton has a copy of the groups in memory (instance variables).\nEverytime authorization happens, the regular expressions aren't recompiled, which would be a huge waste of CPU resources. In other words: the singleton is a facade for the rarely changing group data.\nThis \"cache\" is updated (compiling the regex) on startup and when domain groups are changed via CRUD API actions (not during read, obviously).\nThis might not be necessary to mention in the guides, as an admin should never notice anything of it. I left it there for FWIW.", "author": "poikilotherm", "createdAt": "2020-10-23T19:57:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA4NTA0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE2MjQyMg==", "url": "https://github.com/IQSS/dataverse/pull/7351#discussion_r511162422", "bodyText": "Ah, yeah, I think Admins won't care about that detail - I think it's safe to remove.", "author": "scolapasta", "createdAt": "2020-10-23T21:26:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA4NTA0OA=="}], "type": "inlineReview"}, {"oid": "18ce38ca56a793be726b43b6603264ba9543b9e6", "url": "https://github.com/IQSS/dataverse/commit/18ce38ca56a793be726b43b6603264ba9543b9e6", "message": "doc updates", "committedDate": "2020-10-23T20:58:07Z", "type": "commit"}, {"oid": "be25dd6a0004178c6c4fa40d1a0c3f6fe1eea4bd", "url": "https://github.com/IQSS/dataverse/commit/be25dd6a0004178c6c4fa40d1a0c3f6fe1eea4bd", "message": "removing bullet based on code review", "committedDate": "2020-10-26T23:37:53Z", "type": "commit"}, {"oid": "52f140c1ed8a49a71769f8b106e995b5f2a175fb", "url": "https://github.com/IQSS/dataverse/commit/52f140c1ed8a49a71769f8b106e995b5f2a175fb", "message": "Merge pull request #340 from IQSS/pr/7351\n\nDocumentation Updates", "committedDate": "2020-10-27T00:55:23Z", "type": "commit"}]}