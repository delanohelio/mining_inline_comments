{"pr_number": 6785, "pr_title": "MDC scripts", "pr_createdAt": "2020-04-01T15:18:41Z", "pr_url": "https://github.com/IQSS/dataverse/pull/6785", "timeline": [{"oid": "bbb2722d799e8a4386695f366d737064e8c3c0bc", "url": "https://github.com/IQSS/dataverse/commit/bbb2722d799e8a4386695f366d737064e8c3c0bc", "message": "MDC scripts", "committedDate": "2020-04-01T15:13:05Z", "type": "commit"}, {"oid": "e582e45b1ec280110b33859e62779bfbdc27bee0", "url": "https://github.com/IQSS/dataverse/commit/e582e45b1ec280110b33859e62779bfbdc27bee0", "message": "Merge remote-tracking branch 'IQSS/develop' into IQSS/6784", "committedDate": "2020-04-01T21:53:42Z", "type": "commit"}, {"oid": "3c78a0e3dc8d5caeb2f8c2d246d1f31bb975a769", "url": "https://github.com/IQSS/dataverse/commit/3c78a0e3dc8d5caeb2f8c2d246d1f31bb975a769", "message": "Merge remote-tracking branch 'IQSS/develop' into IQSS/6784", "committedDate": "2020-05-08T20:00:41Z", "type": "commit"}, {"oid": "c1d37b3e334e59644c7c35ddceff84c48fd5d69d", "url": "https://github.com/IQSS/dataverse/commit/c1d37b3e334e59644c7c35ddceff84c48fd5d69d", "message": "script updates", "committedDate": "2020-05-08T20:13:26Z", "type": "commit"}, {"oid": "197095364e54ca8f9adc88818fb95a993e1c7816", "url": "https://github.com/IQSS/dataverse/commit/197095364e54ca8f9adc88818fb95a993e1c7816", "message": "also report # of citation counts found", "committedDate": "2020-05-08T21:51:36Z", "type": "commit"}, {"oid": "f0772e2967aa4a2ab34a5833eb2b4fe1bbea9777", "url": "https://github.com/IQSS/dataverse/commit/f0772e2967aa4a2ab34a5833eb2b4fe1bbea9777", "message": "fix cut/pasted names", "committedDate": "2020-05-08T22:10:44Z", "type": "commit"}, {"oid": "f35f8d7a4659ea8753bc8ec47159a990fdb05a1c", "url": "https://github.com/IQSS/dataverse/commit/f35f8d7a4659ea8753bc8ec47159a990fdb05a1c", "message": "add todo note", "committedDate": "2020-05-08T22:10:52Z", "type": "commit"}, {"oid": "2f0fbd9560b77176423f8ec43c6c58f20a554647", "url": "https://github.com/IQSS/dataverse/commit/2f0fbd9560b77176423f8ec43c6c58f20a554647", "message": "Updates to script location, made paths configurable, added documentation", "committedDate": "2020-06-04T21:52:46Z", "type": "commit"}, {"oid": "dbdb3329ebc4be912502041d02ae6e192570a4b0", "url": "https://github.com/IQSS/dataverse/commit/dbdb3329ebc4be912502041d02ae6e192570a4b0", "message": "adding release note", "committedDate": "2020-06-05T01:11:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjAyOTg5OQ==", "url": "https://github.com/IQSS/dataverse/pull/6785#discussion_r436029899", "bodyText": "Are we standardizing on having \"mdc\" in the path? If so, should we change the example for :MDCLogPath in the docs? This: http://guides.dataverse.org/en/4.20/installation/config.html#mdclogpath . And explain in the docs that this \"mdc\" directory should be created?", "author": "pdurbin", "createdAt": "2020-06-05T16:25:22Z", "path": "doc/sphinx-guides/source/_static/admin/counter-processor-config.yaml", "diffHunk": "@@ -2,7 +2,7 @@\n # 4-digit year and 2-digit month and day\n # /usr/local/payara5/glassfish/domains/domain1/logs/counter_2019-01-11.log\n #log_name_pattern: sample_logs/counter_(yyyy-mm-dd).log\n-log_name_pattern: /usr/local/payara5/glassfish/domains/domain1/logs/counter_(yyyy-mm-dd).log\n+log_name_pattern: /usr/local/payara5/glassfish/domains/domain1/logs/mdc/counter_(yyyy-mm-dd).log", "originalCommit": "dbdb3329ebc4be912502041d02ae6e192570a4b0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA5Mjc3Mg==", "url": "https://github.com/IQSS/dataverse/pull/6785#discussion_r436092772", "bodyText": "Given the number of logs, I think its a good idea, but I'm happy to go either direction. Once there's a decision, I can look at updating the other references.", "author": "qqmyers", "createdAt": "2020-06-05T18:25:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjAyOTg5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjAzMjEwNg==", "url": "https://github.com/IQSS/dataverse/pull/6785#discussion_r436032106", "bodyText": "dataverse-ansible installs Counter Processor in /usr/local: https://github.com/IQSS/dataverse-ansible/blob/61381428ef0c30d321c8dd7ca4d9f21b9f46e733/tasks/dataverse-counter.yml#L40\nShould we consider using the same path. Pinging @donsizemore", "author": "pdurbin", "createdAt": "2020-06-05T16:29:45Z", "path": "doc/sphinx-guides/source/_static/util/counter_daily.sh", "diffHunk": "@@ -0,0 +1,36 @@\n+#! /bin/bash\n+\n+COUNTER_PROCESSOR_DIRECTORY=\"/opt/counter-processor-0.0.1\"", "originalCommit": "dbdb3329ebc4be912502041d02ae6e192570a4b0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA5NTI1NQ==", "url": "https://github.com/IQSS/dataverse/pull/6785#discussion_r436095255", "bodyText": "Looks like everything else uses /usr/local so I'll update.", "author": "qqmyers", "createdAt": "2020-06-05T18:30:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjAzMjEwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjAzMzQ2MA==", "url": "https://github.com/IQSS/dataverse/pull/6785#discussion_r436033460", "bodyText": "It feels a little insecure to me to put this data in /tmp.", "author": "pdurbin", "createdAt": "2020-06-05T16:32:19Z", "path": "doc/sphinx-guides/source/_static/util/counter_daily.sh", "diffHunk": "@@ -0,0 +1,36 @@\n+#! /bin/bash\n+\n+COUNTER_PROCESSOR_DIRECTORY=\"/opt/counter-processor-0.0.1\"\n+MDC_LOG_DIRECTORY=\"/usr/local/payara5/glassfish/domains/domain1/logs/mdc\"\n+\n+# counter_daily.sh\n+\n+cd $COUNTER_PROCESSOR_DIRECTORY\n+\n+echo >>/tmp/counter_daily.log\n+date >>/tmp/counter_daily.log\n+echo >>/tmp/counter_daily.log\n+\n+# \"You should run Counter Processor once a day to create reports in SUSHI (JSON) format that are saved to disk for Dataverse to process and that are sent to the DataCite hub.\"\n+\n+LAST=$(date -d \"yesterday 13:00\" '+%Y-%m-%d')\n+# echo $LAST\n+YEAR_MONTH=$(date -d \"yesterday 13:00\" '+%Y-%m')\n+# echo $YEAR_MONTH\n+d=$(date -I -d \"$YEAR_MONTH-01\")\n+#echo $d\n+while [ \"$(date -d \"$d\" +%Y%m%d)\" -le \"$(date -d \"$LAST\" +%Y%m%d)\" ];\n+do\n+  if [ -f \"$MDC_LOG_DIRECTORY/counter_$d.log\" ]; then\n+#       echo \"Found counter_$d.log\"\n+  else\n+        touch \"$MDC_LOG_DIRECTORY/counter_$d.log\"\n+  fi\n+  d=$(date -I -d \"$d + 1 day\")\n+done\n+\n+#run counter-processor as counter user\n+\n+sudo -u counter YEAR_MONTH=$YEAR_MONTH python3 main.py >>/tmp/counter_daily.log\n+\n+curl -X POST \"http://localhost:8080/api/admin/makeDataCount/addUsageMetricsFromSushiReport?reportOnDisk=/tmp/make-data-count-report.json\"", "originalCommit": "dbdb3329ebc4be912502041d02ae6e192570a4b0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA5NjIzNQ==", "url": "https://github.com/IQSS/dataverse/pull/6785#discussion_r436096235", "bodyText": "I agree. QDR uses a tmp subdir within the counter-processor dir, analogous to how CP has it's state in a state subdir. I picked /tmp here based on current admin docs.", "author": "qqmyers", "createdAt": "2020-06-05T18:32:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjAzMzQ2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjEwMTEwNA==", "url": "https://github.com/IQSS/dataverse/pull/6785#discussion_r436101104", "bodyText": "and the example config.yml doc included in the guides - that would need to be updated if we change.", "author": "qqmyers", "createdAt": "2020-06-05T18:42:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjAzMzQ2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA4NzM5OQ==", "url": "https://github.com/IQSS/dataverse/pull/6785#discussion_r436087399", "bodyText": "I'm confused by this comment. When I look into at datasetExternalCitationsService.save(dm) I see logic in there about repopulating and a comment that says \"Replace existing if necessary\". Some variables in that method were renamed in this pull request so it seems to have been examined.\nThat said there's more below (hasPart, etc.) that I'm not entirely following. And this is just a comment, not a code change. \ud83d\ude04\nIf there's a bug, it might be better to not add this comment and simply create an issue to handle it separately.", "author": "pdurbin", "createdAt": "2020-06-05T18:14:58Z", "path": "src/main/java/edu/harvard/iq/dataverse/api/MakeDataCountApi.java", "diffHunk": "@@ -170,7 +170,13 @@ public Response updateCitationsForDataset(@PathParam(\"id\") String id) throws Mal\n             } while (nextPage == true);\n             JsonArray allData = dataBuilder.build();\n             List<DatasetExternalCitations> datasetExternalCitations = datasetExternalCitationsService.parseCitations(allData);\n-\n+            /*\n+             * ToDo: If this is the only source of citations, we should remove all the existing ones for the dataset and repopuate them.", "originalCommit": "dbdb3329ebc4be912502041d02ae6e192570a4b0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA5OTYzMw==", "url": "https://github.com/IQSS/dataverse/pull/6785#discussion_r436099633", "bodyText": "The save method only replaces an existing entry if a new one that matches is found. If a citation ever goes away, it will never get deleted. While one could argue that citations won't go away, the practical example from QDR is that from ~ v.4.17 we sent hasPart info to DataCite and that was originally pulled back as a citation. PRs now in v4.20 now filter what comes back from DataCite to remove these and other 'non-citation' relationships, but if the upload citations method was run and db entries created, they won't get deleted, and future changes to the list of relationships to consider also won't clear old db entries.", "author": "qqmyers", "createdAt": "2020-06-05T18:39:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA4NzM5OQ=="}], "type": "inlineReview"}, {"oid": "81457d555dd75deb698b723e8ccb5b1a931c23a5", "url": "https://github.com/IQSS/dataverse/commit/81457d555dd75deb698b723e8ccb5b1a931c23a5", "message": "Change default CP dir per comment", "committedDate": "2020-06-05T18:40:46Z", "type": "commit"}, {"oid": "1d459aab17462224e453cc543b3dea244a69deb7", "url": "https://github.com/IQSS/dataverse/commit/1d459aab17462224e453cc543b3dea244a69deb7", "message": "Merge remote-tracking branch 'IQSS/develop' into IQSS/6784", "committedDate": "2020-08-10T18:42:06Z", "type": "commit"}, {"oid": "bcfb64234c257e6fd07f144d676163f8c90161e7", "url": "https://github.com/IQSS/dataverse/commit/bcfb64234c257e6fd07f144d676163f8c90161e7", "message": "Merge remote-tracking branch 'IQSS/develop' into IQSS/6784", "committedDate": "2020-09-15T16:10:45Z", "type": "commit"}, {"oid": "90002279c039ab8aa4cae967b4550ded459e4341", "url": "https://github.com/IQSS/dataverse/commit/90002279c039ab8aa4cae967b4550ded459e4341", "message": "Merge remote-tracking branch 'IQSS/develop' into IQSS/6784", "committedDate": "2020-10-06T15:26:30Z", "type": "commit"}, {"oid": "7b12c8317e2ad5825a854a29f37690f8615deb22", "url": "https://github.com/IQSS/dataverse/commit/7b12c8317e2ad5825a854a29f37690f8615deb22", "message": "Merge remote-tracking branch 'IQSS/develop' into IQSS/6784", "committedDate": "2020-10-08T18:39:33Z", "type": "commit"}]}