{"pr_number": 492, "pr_title": "#444 - permissions API skeleton", "pr_createdAt": "2020-08-24T17:46:09Z", "pr_url": "https://github.com/artipie/artipie/pull/492", "timeline": [{"oid": "34b09b347778054e6de160442925effcb9e069ef", "url": "https://github.com/artipie/artipie/commit/34b09b347778054e6de160442925effcb9e069ef", "message": "#444 - permissions API skeleton", "committedDate": "2020-08-24T17:44:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjIwNDU5Mg==", "url": "https://github.com/artipie/artipie/pull/492#discussion_r476204592", "bodyText": "@olenagerasimova I'd suggest to extract individual repository permissions class from this one, so we can avoid complex methods like addUpdate(String, String, String) and return type like CompletionStage<Map<String, List<String>>>. What I suggest is something like this:\ninterfaces RepoPermissionsRegistry {\n  List<RepoPermissions> list();\n  RepoPermissions get(String name);\n  ...\n}\ninterfaces RepoPermissions {\n  void add(String username, String permission);\n  ...\n}\nWhat do you think?", "author": "olegmoz", "createdAt": "2020-08-25T06:24:10Z", "path": "src/main/java/com/artipie/RepoPermissions.java", "diffHunk": "@@ -0,0 +1,130 @@\n+/*\n+ * The MIT License (MIT)\n+ *\n+ * Copyright (c) 2020 artipie.com\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included\n+ * in all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ */\n+package com.artipie;\n+\n+import com.artipie.asto.Key;\n+import com.artipie.asto.Storage;\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletionStage;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Repository permissions settings.\n+ * @since 0.10\n+ */\n+public interface RepoPermissions {", "originalCommit": "34b09b347778054e6de160442925effcb9e069ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjIxNzk2OA==", "url": "https://github.com/artipie/artipie/pull/492#discussion_r476217968", "bodyText": "@olegmoz hm, I do not see how one more interface will allow us to avoid returning Map<String, List<String>> for repo permissions, as we still need map user -> permissions list... The only thing we will avoid here - passings parameter repo", "author": "olenagerasimova", "createdAt": "2020-08-25T06:55:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjIwNDU5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjIyOTg2OQ==", "url": "https://github.com/artipie/artipie/pull/492#discussion_r476229869", "bodyText": "@olenagerasimova basically we replace Map<String, List<String>> with RepoPermissions. RepoPermissions may implement Map<...> or have similar methods like Set<String> users() instead of Set<String> keySet() and Set<String> permissions(String user) instead of List<String> get(String value).\nIt is all about making code more understandable. It's hard to understand what is what in type like Map<String, List<String>>.", "author": "olegmoz", "createdAt": "2020-08-25T07:19:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjIwNDU5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI0ODQxMg==", "url": "https://github.com/artipie/artipie/pull/492#discussion_r476248412", "bodyText": "@olegmoz RepoPermissions still will have to return users and permissions for repository (map username -> permissions list) as GetPermissionSlice have to return following json format\n\"users\" : {\n      \"bob\": [\"r\",\"w\",\"m\"],\n      \"alice\" : [\"d\",\"w\",\"n\", \"r\"]\n}\nMap<String, List<String>> seems to be very convenient structure to build this json. Basically, I do not mind creating the interface you are suggesting, I just do not think it's necessary in this case, we can simply rename\nCompletionStage<Map<String, List<String>>> get(String repo) to CompletionStage<Map<String, List<String>>> permissions(String repo) and extend javadoc.\nFurthermore, having separate methods to obtain users and permissions from settings can lead to inconsistency as they can be changed while we are building json response in GetPermissionSlice.", "author": "olenagerasimova", "createdAt": "2020-08-25T07:52:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjIwNDU5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI3OTE5MA==", "url": "https://github.com/artipie/artipie/pull/492#discussion_r476279190", "bodyText": "@olenagerasimova that makes sense, thanks", "author": "olegmoz", "createdAt": "2020-08-25T08:40:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjIwNDU5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjIwNjE2MQ==", "url": "https://github.com/artipie/artipie/pull/492#discussion_r476206161", "bodyText": "@olenagerasimova if I understand correctly, these methods need to be implemented. Am I right? It would be way more obvious to throw UnsupporetedOperationException, as it is common contract for not yet implemented methods. null value may look like a normal result and be propagated too far breaking the fail-fast principle.\nSame goes for not implemented slices.", "author": "olegmoz", "createdAt": "2020-08-25T06:28:06Z", "path": "src/main/java/com/artipie/RepoPermissions.java", "diffHunk": "@@ -0,0 +1,130 @@\n+/*\n+ * The MIT License (MIT)\n+ *\n+ * Copyright (c) 2020 artipie.com\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included\n+ * in all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ */\n+package com.artipie;\n+\n+import com.artipie.asto.Key;\n+import com.artipie.asto.Storage;\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletionStage;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Repository permissions settings.\n+ * @since 0.10\n+ */\n+public interface RepoPermissions {\n+\n+    /**\n+     * Artipie repositories list.\n+     * @return Repository names list\n+     */\n+    CompletionStage<List<String>> repositories();\n+\n+    /**\n+     * Deletes all permissions for repository.\n+     * @param repo Repository name\n+     * @return Completion remove action\n+     */\n+    CompletionStage<Void> remove(String repo);\n+\n+    /**\n+     * Adds or updates repository permission.\n+     * @param repo Repository name\n+     * @param username Username\n+     * @param permission Permission name\n+     * @return Completion action\n+     */\n+    CompletionStage<Void> addUpdate(String repo, String username, String permission);\n+\n+    /**\n+     * Get repository permissions settings.\n+     * @param repo Repository name\n+     * @return Completion action with map with users and permissions\n+     */\n+    CompletionStage<Map<String, List<String>>> get(String repo);\n+\n+    /**\n+     * {@link RepoPermissions} from Artipie settings.\n+     * @since 0.10\n+     */\n+    final class FromSettings implements RepoPermissions {\n+\n+        /**\n+         * Artipie settings.\n+         */\n+        private final Settings settings;\n+\n+        /**\n+         * Ctor.\n+         * @param settings Artipie settings\n+         */\n+        public FromSettings(final Settings settings) {\n+            this.settings = settings;\n+        }\n+\n+        @Override\n+        public CompletionStage<List<String>> repositories() {\n+            return this.storage().list(Key.ROOT)\n+                .thenApply(\n+                    list -> list.stream()\n+                        .map(Key::string)\n+                        .filter(key -> key.contains(\"yaml\"))\n+                        .map(key -> key.replace(\".yaml\", \"\"))\n+                        .collect(Collectors.toList())\n+            );\n+        }\n+\n+        @Override\n+        public CompletionStage<Void> remove(final String repo) {\n+            return null;\n+        }\n+\n+        @Override\n+        public CompletionStage<Void> addUpdate(final String repo, final String username,\n+            final String permission) {\n+            return null;\n+        }\n+\n+        @Override\n+        public CompletionStage<Map<String, List<String>>> get(final String repo) {\n+            return null;\n+        }", "originalCommit": "34b09b347778054e6de160442925effcb9e069ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjIwNjk0Ng==", "url": "https://github.com/artipie/artipie/pull/492#discussion_r476206946", "bodyText": "@olenagerasimova the comment looks wrong, please update", "author": "olegmoz", "createdAt": "2020-08-25T06:30:00Z", "path": "src/main/java/com/artipie/api/artifactory/AddUpdatePermissionSlice.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * The MIT License (MIT)\n+ *\n+ * Copyright (c) 2020 artipie.com\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included\n+ * in all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ */\n+package com.artipie.api.artifactory;\n+\n+import com.artipie.http.Response;\n+import com.artipie.http.Slice;\n+import java.nio.ByteBuffer;\n+import java.util.Map;\n+import org.reactivestreams.Publisher;\n+\n+/**\n+ * Artifactory `GET /api/security/permissions/{target}` endpoint, returns json with\n+ * permissions (= repository) information.\n+ * @since 0.10\n+ * @todo #444:30min Implement GetPermissionSlice return repository permissions.\n+ *  First, implement and test RepoPermissions.FromSettings#addUpdate(java.lang.String), then use\n+ *  this method in this slice. Request json format can be found\n+ *  https://www.jfrog.com/confluence/display/rtf/artifactory+rest+api, we should obtain information\n+ *  from `repo.actions.users` fields.", "originalCommit": "34b09b347778054e6de160442925effcb9e069ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjIwNzU1OA==", "url": "https://github.com/artipie/artipie/pull/492#discussion_r476207558", "bodyText": "@olenagerasimova Content.EMPTY was added in ASTO recently, it would make code less verbose if used here", "author": "olegmoz", "createdAt": "2020-08-25T06:31:18Z", "path": "src/test/java/com/artipie/RepoPermissionsFromSettingsTest.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * The MIT License (MIT)\n+ *\n+ * Copyright (c) 2020 artipie.com\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included\n+ * in all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ */\n+package com.artipie;\n+\n+import com.artipie.asto.Content;\n+import com.artipie.asto.Key;\n+import com.artipie.asto.Storage;\n+import com.artipie.asto.memory.InMemoryStorage;\n+import org.hamcrest.MatcherAssert;\n+import org.hamcrest.Matchers;\n+import org.junit.jupiter.api.Test;\n+\n+/**\n+ * Test for {@link RepoPermissions.FromSettings}.\n+ * @since 0.10\n+ */\n+class RepoPermissionsFromSettingsTest {\n+\n+    @Test\n+    void returnsRepoList() {\n+        final Storage storage = new InMemoryStorage();\n+        storage.save(new Key.From(\"one.yaml\"), new Content.From(new byte[]{})).join();\n+        storage.save(new Key.From(\"two.yaml\"), new Content.From(new byte[]{})).join();\n+        storage.save(new Key.From(\"abc\"), new Content.From(new byte[]{})).join();\n+        storage.save(new Key.From(\"three.yaml\"), new Content.From(new byte[]{})).join();", "originalCommit": "34b09b347778054e6de160442925effcb9e069ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "88ee370fc3c8df6d8f0d9efd624ec15581dba89b", "url": "https://github.com/artipie/artipie/commit/88ee370fc3c8df6d8f0d9efd624ec15581dba89b", "message": "#444 - CR", "committedDate": "2020-08-25T07:03:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjIzMDU4OQ==", "url": "https://github.com/artipie/artipie/pull/492#discussion_r476230589", "bodyText": "@olenagerasimova GET method here looks wrong", "author": "olegmoz", "createdAt": "2020-08-25T07:20:46Z", "path": "src/main/java/com/artipie/api/artifactory/AddUpdatePermissionSlice.java", "diffHunk": "@@ -33,8 +33,8 @@\n  * Artifactory `GET /api/security/permissions/{target}` endpoint, returns json with", "originalCommit": "88ee370fc3c8df6d8f0d9efd624ec15581dba89b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5758aca1ccc9f164aaa2c7e44647f7d3ac9383f9", "url": "https://github.com/artipie/artipie/commit/5758aca1ccc9f164aaa2c7e44647f7d3ac9383f9", "message": "#444 - javadoc corrected", "committedDate": "2020-08-25T08:12:20Z", "type": "commit"}, {"oid": "3ea268038f050ef4db79840a0bd1b591c2e8aee7", "url": "https://github.com/artipie/artipie/commit/3ea268038f050ef4db79840a0bd1b591c2e8aee7", "message": "Merge branch 'master' into 444-perms-skeleton", "committedDate": "2020-08-25T08:21:57Z", "type": "commit"}]}