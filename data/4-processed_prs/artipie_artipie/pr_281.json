{"pr_number": 281, "pr_title": "#250 - Support for caching Docker proxy", "pr_createdAt": "2020-07-08T07:37:23Z", "pr_url": "https://github.com/artipie/artipie/pull/281", "timeline": [{"oid": "16a7519addea5275728ff1a2356c997c510b937f", "url": "https://github.com/artipie/artipie/commit/16a7519addea5275728ff1a2356c997c510b937f", "message": "#250 - Support for caching Docker proxy", "committedDate": "2020-07-08T07:43:43Z", "type": "forcePushed"}, {"oid": "686a97a7741920bdf392830642ffb9a016d1fa2d", "url": "https://github.com/artipie/artipie/commit/686a97a7741920bdf392830642ffb9a016d1fa2d", "message": "#250 - Support for caching Docker proxy", "committedDate": "2020-07-08T07:56:13Z", "type": "forcePushed"}, {"oid": "686a97a7741920bdf392830642ffb9a016d1fa2d", "url": "https://github.com/artipie/artipie/commit/686a97a7741920bdf392830642ffb9a016d1fa2d", "message": "#250 - Support for caching Docker proxy", "committedDate": "2020-07-08T07:56:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM5NDMwNg==", "url": "https://github.com/artipie/artipie/pull/281#discussion_r451394306", "bodyText": "@olegmoz can we add a test for this?", "author": "Vatavuk", "createdAt": "2020-07-08T09:03:53Z", "path": "src/main/java/com/artipie/SliceFromConfig.java", "diffHunk": "@@ -243,10 +245,11 @@ static Slice build(final Settings settings, final Authentication auth,\n                 final String host = cfg.settings()\n                     .orElseThrow(() -> new IllegalStateException(\"Repo settings not found\"))\n                     .string(\"host\");\n-                slice = new DockerSlice(\n-                    cfg.path(),\n-                    new ProxyDocker(new ClientSlice(SliceFromConfig.HTTP, host))\n-                );\n+                final Docker proxy = new ProxyDocker(new ClientSlice(SliceFromConfig.HTTP, host));\n+                final Docker docker = cfg.storageOpt()", "originalCommit": "686a97a7741920bdf392830642ffb9a016d1fa2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM5Nzg1OQ==", "url": "https://github.com/artipie/artipie/pull/281#discussion_r451397859", "bodyText": "@Vatavuk I doubt that we can test this class in any meaningful way without significant refactoring. We may check that it returns DockerSlice, but cannot check what's inside in unit test", "author": "olegmoz", "createdAt": "2020-07-08T09:10:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM5NDMwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQwOTIxMA==", "url": "https://github.com/artipie/artipie/pull/281#discussion_r451409210", "bodyText": "@olegmoz what about an IT test?", "author": "Vatavuk", "createdAt": "2020-07-08T09:29:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM5NDMwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQzMjAxNQ==", "url": "https://github.com/artipie/artipie/pull/281#discussion_r451432015", "bodyText": "@Vatavuk that would be possible, but there no any IT tests in the project yet", "author": "olegmoz", "createdAt": "2020-07-08T10:09:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM5NDMwNg=="}], "type": "inlineReview"}, {"oid": "79c4f9f60269f5fdd5372be7276ff0c9a3c5b82b", "url": "https://github.com/artipie/artipie/commit/79c4f9f60269f5fdd5372be7276ff0c9a3c5b82b", "message": "Merge branch 'master' into 250-docker-proxy-cache", "committedDate": "2020-07-08T12:11:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTU3MjIzNQ==", "url": "https://github.com/artipie/artipie/pull/281#discussion_r451572235", "bodyText": "@olegmoz I think we can replace storage() with this implementation and just call storage().orElseThrow() to get storage where it's required", "author": "g4s8", "createdAt": "2020-07-08T14:06:33Z", "path": "src/main/java/com/artipie/RepoConfig.java", "diffHunk": "@@ -128,17 +128,32 @@ public URL url() {\n      * @return Async storage for repo\n      */\n     public Storage storage() {\n-        final YamlMapping repo = this.repoConfig();\n-        final Storage storage;\n-        final YamlNode node = repo.value(\"storage\");\n-        if (node instanceof Scalar) {\n-            storage = this.storages.storage(((Scalar) node).value());\n-        } else if (node instanceof YamlMapping) {\n-            storage = new YamlStorage((YamlMapping) node).storage();\n-        } else {\n-            throw new IllegalStateException(String.format(\"Invalid storage config: %s\", node));\n-        }\n-        return new SubStorage(this.prefix, new LoggingStorage(Level.INFO, storage));\n+        return this.storageOpt().orElseThrow(\n+            () -> new IllegalStateException(\"Storage is not configured\")\n+        );\n+    }\n+\n+    /**\n+     * Create storage if configured.\n+     *\n+     * @return Async storage for repo\n+     */\n+    public Optional<Storage> storageOpt() {", "originalCommit": "79c4f9f60269f5fdd5372be7276ff0c9a3c5b82b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTYwMjMyMA==", "url": "https://github.com/artipie/artipie/pull/281#discussion_r451602320", "bodyText": "@g4s8 I think I did just that, RepoConfig.storage() method looks like that now:\npublic Storage storage() {\n        return this.storageOpt().orElseThrow(\n            () -> new IllegalStateException(\"Storage is not configured\")\n        );\n    }", "author": "olegmoz", "createdAt": "2020-07-08T14:46:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTU3MjIzNQ=="}], "type": "inlineReview"}, {"oid": "8a4c370926ab17c1ac3ab5c809c0c30aa09f458b", "url": "https://github.com/artipie/artipie/commit/8a4c370926ab17c1ac3ab5c809c0c30aa09f458b", "message": "Merge branch 'master' into 250-docker-proxy-cache", "committedDate": "2020-07-08T14:52:03Z", "type": "commit"}, {"oid": "8c1b1aa639a88f3acf85a192743f80393af3c032", "url": "https://github.com/artipie/artipie/commit/8c1b1aa639a88f3acf85a192743f80393af3c032", "message": "Merge branch 'master' into 250-docker-proxy-cache", "committedDate": "2020-07-08T14:52:47Z", "type": "commit"}, {"oid": "a9062e5e4d6609fdd4aac77439f7798b77ec06b5", "url": "https://github.com/artipie/artipie/commit/a9062e5e4d6609fdd4aac77439f7798b77ec06b5", "message": "Merge branch 'master' into 250-docker-proxy-cache", "committedDate": "2020-07-08T14:58:46Z", "type": "commit"}]}