{"pr_number": 506, "pr_title": "#494 - RepoPermissions.FromSettings fully implemented", "pr_createdAt": "2020-08-26T06:22:44Z", "pr_url": "https://github.com/artipie/artipie/pull/506", "timeline": [{"oid": "0e25c4a01bdf2d8eda7e2c07f62d3d682ad79849", "url": "https://github.com/artipie/artipie/commit/0e25c4a01bdf2d8eda7e2c07f62d3d682ad79849", "message": "#494 - RepoPermissions.FromSettings fully implemented", "committedDate": "2020-08-26T06:15:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzEyNTcyMg==", "url": "https://github.com/artipie/artipie/pull/506#discussion_r477125722", "bodyText": "@olenagerasimova I am concerned about List<UserPermission>. It makes one think that users are ordered and order does matter. I do not think that this is the case and would suggest to change it to Collection. Same goes for permissions method return value", "author": "olegmoz", "createdAt": "2020-08-26T08:27:07Z", "path": "src/main/java/com/artipie/RepoPermissions.java", "diffHunk": "@@ -61,25 +67,34 @@\n     /**\n      * Adds or updates repository permission.\n      * @param repo Repository name\n-     * @param username Username\n-     * @param permission Permission name\n+     * @param permissions Permissions list\n      * @return Completion action\n      */\n-    CompletionStage<Void> addUpdate(String repo, String username, String permission);\n+    CompletionStage<Void> addUpdate(String repo, List<UserPermission> permissions);", "originalCommit": "0e25c4a01bdf2d8eda7e2c07f62d3d682ad79849", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzEzMjA0NQ==", "url": "https://github.com/artipie/artipie/pull/506#discussion_r477132045", "bodyText": "@olenagerasimova I think we miss the case when user has some permissions and we update the user by adding more permissions or removing some permissions", "author": "olegmoz", "createdAt": "2020-08-26T08:37:04Z", "path": "src/test/java/com/artipie/RepoPermissionsFromSettingsTest.java", "diffHunk": "@@ -103,6 +110,88 @@ void returnsEmptyMapWhenPermissionsAreNotSet() {\n         );\n     }\n \n+    @Test\n+    void updatesUserPermissions() throws IOException {", "originalCommit": "0e25c4a01bdf2d8eda7e2c07f62d3d682ad79849", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzEzMzExMg==", "url": "https://github.com/artipie/artipie/pull/506#discussion_r477133112", "bodyText": "@olenagerasimova this test will pass if remove method just clears all repositories. May we check that other repos stay intact after removing a repo?", "author": "olegmoz", "createdAt": "2020-08-26T08:38:50Z", "path": "src/test/java/com/artipie/RepoPermissionsFromSettingsTest.java", "diffHunk": "@@ -103,6 +110,88 @@ void returnsEmptyMapWhenPermissionsAreNotSet() {\n         );\n     }\n \n+    @Test\n+    void updatesUserPermissions() throws IOException {\n+        final String repo = \"rpm\";\n+        this.addSettings(\n+            repo,\n+            new MapOf<String, List<String>>(\n+                new MapEntry<>(\"david\", new ListOf<String>(\"add\", \"update\"))\n+            )\n+        );\n+        final String olga = \"olga\";\n+        final String victor = \"victor\";\n+        final String download = \"download\";\n+        final String deploy = \"deploy\";\n+        new RepoPermissions.FromSettings(new Settings.Fake(this.storage))\n+            .addUpdate(\n+                repo,\n+                new ListOf<>(\n+                    new RepoPermissions.UserPermission(olga, new ListOf<>(download, deploy)),\n+                    new RepoPermissions.UserPermission(victor, new ListOf<>(deploy))\n+                )\n+            ).toCompletableFuture().join();\n+        MatcherAssert.assertThat(\n+            \"Added permissions for olga\",\n+            this.permissionsForUser(repo, olga),\n+            Matchers.contains(download, deploy)\n+        );\n+        MatcherAssert.assertThat(\n+            \"Added permissions for victor\",\n+            this.permissionsForUser(repo, victor),\n+            Matchers.contains(deploy)\n+        );\n+    }\n+\n+    @Test\n+    void addsUserPermissionWhenOriginalPermissionsAreNotSet() throws IOException {\n+        final String repo = \"go\";\n+        this.addEmpty(repo);\n+        final String ann = \"ann\";\n+        final String download = \"download\";\n+        new RepoPermissions.FromSettings(new Settings.Fake(this.storage))\n+            .addUpdate(\n+                repo,\n+                new ListOf<>(new RepoPermissions.UserPermission(ann, new ListOf<>(download)))\n+            )\n+            .toCompletableFuture().join();\n+        MatcherAssert.assertThat(\n+            this.permissionsForUser(repo, ann),\n+            Matchers.contains(download)\n+        );\n+    }\n+\n+    @Test\n+    void deletesPermissionSection() throws IOException {", "originalCommit": "0e25c4a01bdf2d8eda7e2c07f62d3d682ad79849", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6942b6a5b040eeb1f319bbc6d0110ddc8cb32518", "url": "https://github.com/artipie/artipie/commit/6942b6a5b040eeb1f319bbc6d0110ddc8cb32518", "message": "#494 - CR", "committedDate": "2020-08-26T09:13:52Z", "type": "commit"}, {"oid": "e23f129e15651ba00bc62bc0783464e7105b2d7c", "url": "https://github.com/artipie/artipie/commit/e23f129e15651ba00bc62bc0783464e7105b2d7c", "message": "Merge branch 'master' of https://github.com/artipie/artipie into 494-repo-permissions-impl", "committedDate": "2020-08-26T09:17:41Z", "type": "commit"}]}