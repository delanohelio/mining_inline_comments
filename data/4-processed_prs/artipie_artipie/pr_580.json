{"pr_number": 580, "pr_title": "#535 - Add mavenProxyIT", "pr_createdAt": "2020-09-11T14:04:38Z", "pr_url": "https://github.com/artipie/artipie/pull/580", "timeline": [{"oid": "12683a7262ba772b2e10d6e0449751324331d02f", "url": "https://github.com/artipie/artipie/commit/12683a7262ba772b2e10d6e0449751324331d02f", "message": "#535 - Add mavenProxyIT", "committedDate": "2020-09-11T14:02:44Z", "type": "commit"}, {"oid": "b407d3feb4975c13e0718f005ad16d3e65197132", "url": "https://github.com/artipie/artipie/commit/b407d3feb4975c13e0718f005ad16d3e65197132", "message": "Merge remote-tracking branch 'upstream/master' into 535-mavenProxyIT", "committedDate": "2020-09-13T22:50:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzgzNTUxOA==", "url": "https://github.com/artipie/artipie/pull/580#discussion_r487835518", "bodyText": "@genryxy I see that this command is executed twice, is it really necessary?", "author": "olenagerasimova", "createdAt": "2020-09-14T11:17:58Z", "path": "src/test/java/com/artipie/maven/MavenProxyIT.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\n+ * The MIT License (MIT)\n+ *\n+ * Copyright (c) 2020 artipie.com\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included\n+ * in all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ */\n+package com.artipie.maven;\n+\n+import com.amihaiemil.eoyaml.Yaml;\n+import com.artipie.ArtipieServer;\n+import com.artipie.docker.junit.DockerClientSupport;\n+import com.jcabi.log.Logger;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Arrays;\n+import java.util.List;\n+import org.cactoos.list.ListOf;\n+import org.hamcrest.MatcherAssert;\n+import org.hamcrest.core.AllOf;\n+import org.hamcrest.core.IsNot;\n+import org.hamcrest.core.StringContains;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.condition.EnabledOnOs;\n+import org.junit.jupiter.api.condition.OS;\n+import org.junit.jupiter.api.io.TempDir;\n+import org.testcontainers.Testcontainers;\n+import org.testcontainers.containers.GenericContainer;\n+\n+/**\n+ * Integration test for {@link com.artipie.maven.http.MavenProxySlice}.\n+ *\n+ * @checkstyle ClassDataAbstractionCouplingCheck (500 lines)\n+ * @since 0.11\n+ */\n+@SuppressWarnings(\"PMD.AvoidDuplicateLiterals\")\n+@EnabledOnOs(OS.LINUX)\n+@DockerClientSupport\n+final class MavenProxyIT {\n+\n+    /**\n+     * Temporary directory for all tests.\n+     * @checkstyle VisibilityModifierCheck (3 lines)\n+     */\n+    @TempDir\n+    Path tmp;\n+\n+    /**\n+     * Subdirectory in temporary directory.\n+     */\n+    private Path subdir;\n+\n+    /**\n+     * Local Artipie server that stores artifacts.\n+     */\n+    private ArtipieServer server;\n+\n+    /**\n+     * Container for local server.\n+     */\n+    private GenericContainer<?> cntn;\n+\n+    /**\n+     * Proxy Artipie server port.\n+     */\n+    private int port;\n+\n+    @BeforeEach\n+    void setUp() throws Exception {\n+        this.subdir = Files.createDirectory(Path.of(this.tmp.toString(), \"subdir\"));\n+        this.server = new ArtipieServer(this.subdir, \"my-maven\", this.configsProxy());\n+        this.port = this.server.start();\n+        final Path setting = this.subdir.resolve(\"settings.xml\");\n+        setting.toFile().createNewFile();\n+        Files.write(setting, this.settings());\n+        this.cntn = new GenericContainer<>(\"centos:centos8\")\n+            .withCommand(\"tail\", \"-f\", \"/dev/null\")\n+            .withWorkingDirectory(\"/home/\")\n+            .withFileSystemBind(this.subdir.toString(), \"/home\");\n+        Testcontainers.exposeHostPorts(this.port);\n+        this.cntn.start();\n+        this.cntn.execInContainer(\"yum\", \"-y\", \"install\", \"maven\");\n+    }\n+\n+    @AfterEach\n+    void tearDown() {\n+        this.server.stop();\n+        this.cntn.close();\n+    }\n+\n+    @Test\n+    void shouldGetArtifactFromLocalAndSaveInCache() throws Exception {\n+        final String artifact = \"-Dartifact=aspectj:aspectj-ant:1.0.6:jar\";\n+        this.exec(\"mvn\", \"-s\", \"/home/settings.xml\", \"dependency:get\", artifact);\n+        MatcherAssert.assertThat(\n+            this.exec(\n+                \"mvn\", \"-s\", \"/home/settings.xml\", \"dependency:get\", artifact", "originalCommit": "12683a7262ba772b2e10d6e0449751324331d02f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg0MjE0NQ==", "url": "https://github.com/artipie/artipie/pull/580#discussion_r487842145", "bodyText": "@olenagerasimova thanks. I try to verify that artifacts are cached. Maybe, it would be nice just to check that storage contains the key, but I have some troubles with it therefore implemented so. I'll try to check through storage and execute this command only once.", "author": "genryxy", "createdAt": "2020-09-14T11:31:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzgzNTUxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzk0MTEzNA==", "url": "https://github.com/artipie/artipie/pull/580#discussion_r487941134", "bodyText": "@genryxy have you tried simply check temp directory structure? You can add brake point, copy path and use ls -la. As far as see files should be ./subdir/repos/. When you understand where files are, you can create FileStorage instance over subdir and check that files are loaded by corresponding keys", "author": "olenagerasimova", "createdAt": "2020-09-14T13:56:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzgzNTUxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzk0NzQxOQ==", "url": "https://github.com/artipie/artipie/pull/580#discussion_r487947419", "bodyText": "@olenagerasimova yes, I tried to check temp directory. It has artipie.yaml, settings, repos/my-maven.yaml, repos/_credentials.yml", "author": "genryxy", "createdAt": "2020-09-14T14:02:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzgzNTUxOA=="}], "type": "inlineReview"}, {"oid": "cade41bf2882908d4dea93dd0408b68ce912271c", "url": "https://github.com/artipie/artipie/commit/cade41bf2882908d4dea93dd0408b68ce912271c", "message": "Merge remote-tracking branch 'upstream/master' into 535-mavenProxyIT", "committedDate": "2020-09-17T06:11:22Z", "type": "commit"}, {"oid": "370251f567e8192915b94458f92df11df8d99d4a", "url": "https://github.com/artipie/artipie/commit/370251f567e8192915b94458f92df11df8d99d4a", "message": "Merge remote-tracking branch 'upstream/master' into 535-mavenProxyIT", "committedDate": "2020-09-22T09:46:53Z", "type": "commit"}, {"oid": "7297b7a551f4105c24f3220bba78dca076348f9d", "url": "https://github.com/artipie/artipie/commit/7297b7a551f4105c24f3220bba78dca076348f9d", "message": "#535 - Add storage checking, disable test", "committedDate": "2020-09-22T10:33:11Z", "type": "commit"}, {"oid": "e59cdde76f27c8da3f4fc1ef4add0b8512ed1383", "url": "https://github.com/artipie/artipie/commit/e59cdde76f27c8da3f4fc1ef4add0b8512ed1383", "message": "#535 - Change artifact name", "committedDate": "2020-09-24T08:22:56Z", "type": "commit"}, {"oid": "da0eed32342a7d6a5673aa285f7955a545ce25a9", "url": "https://github.com/artipie/artipie/commit/da0eed32342a7d6a5673aa285f7955a545ce25a9", "message": "Merge remote-tracking branch 'upstream/master' into 535-mavenProxyIT", "committedDate": "2020-09-24T08:24:55Z", "type": "commit"}, {"oid": "c8ae78dc1beff51531d2f406c0f6412450d70849", "url": "https://github.com/artipie/artipie/commit/c8ae78dc1beff51531d2f406c0f6412450d70849", "message": "Merge branch 'master' into 535-mavenProxyIT", "committedDate": "2020-09-24T16:54:15Z", "type": "commit"}]}