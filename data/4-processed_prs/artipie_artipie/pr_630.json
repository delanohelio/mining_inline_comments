{"pr_number": 630, "pr_title": "#603 - Check PUT and GET with auth disabled", "pr_createdAt": "2020-09-25T07:40:14Z", "pr_url": "https://github.com/artipie/artipie/pull/630", "timeline": [{"oid": "4fa8b1c16e3391a4e45bb625366928436eb7d089", "url": "https://github.com/artipie/artipie/commit/4fa8b1c16e3391a4e45bb625366928436eb7d089", "message": "#603 - Check PUT and GET with auth disabled", "committedDate": "2020-09-25T07:36:26Z", "type": "commit"}, {"oid": "d66ccb8404551438f1379f62c3e5abe95b74ea97", "url": "https://github.com/artipie/artipie/commit/d66ccb8404551438f1379f62c3e5abe95b74ea97", "message": "#603 - Enable test on Linux and Mac", "committedDate": "2020-09-25T07:54:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDgzNDk2Nw==", "url": "https://github.com/artipie/artipie/pull/630#discussion_r494834967", "bodyText": "@genryxy it is not needed to install maven for these tests, we only need curl", "author": "olegmoz", "createdAt": "2020-09-25T08:35:45Z", "path": "src/test/java/com/artipie/FilesRepoITCase.java", "diffHunk": "@@ -0,0 +1,163 @@\n+/*\n+ * The MIT License (MIT)\n+ *\n+ * Copyright (c) 2020 artipie.com\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included\n+ * in all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ */\n+package com.artipie;\n+\n+import com.amihaiemil.eoyaml.Yaml;\n+import com.artipie.asto.Key;\n+import com.artipie.asto.Storage;\n+import com.artipie.asto.blocking.BlockingStorage;\n+import com.artipie.asto.fs.FileStorage;\n+import com.artipie.asto.test.TestResource;\n+import com.jcabi.log.Logger;\n+import java.nio.file.Path;\n+import java.util.regex.Pattern;\n+import org.hamcrest.MatcherAssert;\n+import org.hamcrest.core.StringContains;\n+import org.hamcrest.text.MatchesPattern;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.condition.EnabledOnOs;\n+import org.junit.jupiter.api.condition.OS;\n+import org.junit.jupiter.api.io.TempDir;\n+import org.testcontainers.Testcontainers;\n+import org.testcontainers.containers.GenericContainer;\n+\n+/**\n+ * Integration tests for Files repository.\n+ * @since 0.11\n+ * @checkstyle ClassDataAbstractionCouplingCheck (500 lines)\n+ */\n+@SuppressWarnings(\"PMD.AvoidDuplicateLiterals\")\n+@EnabledOnOs({OS.LINUX, OS.MAC})\n+final class FilesRepoITCase {\n+\n+    /**\n+     * Temporary directory for all tests.\n+     * @checkstyle VisibilityModifierCheck (3 lines)\n+     */\n+    @TempDir\n+    Path tmp;\n+\n+    /**\n+     * Tested Artipie server.\n+     */\n+    private ArtipieServer server;\n+\n+    /**\n+     * Container.\n+     */\n+    private GenericContainer<?> cntn;\n+\n+    /**\n+     * Storage.\n+     */\n+    private Storage storage;\n+\n+    /**\n+     * Artipie server port.\n+     */\n+    private int port;\n+\n+    @BeforeEach\n+    void init() throws Exception {\n+        this.storage = new FileStorage(this.tmp);\n+        this.server = new ArtipieServer(this.tmp, \"my-file\", this.configs());\n+        this.port = this.server.start();\n+        this.server.start();\n+        Testcontainers.exposeHostPorts(this.port);\n+        this.cntn = new GenericContainer<>(\"centos:centos8\")\n+            .withCommand(\"tail\", \"-f\", \"/dev/null\")\n+            .withWorkingDirectory(\"/home/\")\n+            .withFileSystemBind(this.tmp.toString(), \"/home\");\n+        this.cntn.start();\n+        this.exec(\"yum\", \"-y\", \"install\", \"curl\");\n+        this.exec(\"yum\", \"-y\", \"install\", \"maven\");", "originalCommit": "d66ccb8404551438f1379f62c3e5abe95b74ea97", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDgzNjg0Mw==", "url": "https://github.com/artipie/artipie/pull/630#discussion_r494836843", "bodyText": "@genryxy here we add the same file to storage twice: first with addFilesToStorage and then using curl. I'd say in test checking download we should add file to storage  using addFilesToStorage method and create another test that runs curl PUT and checks that file is present in Storage after that.\nYou may just remove call of curl PUT for now and add another test later that checks curl PUT runs normally and adds file to Storage at expected path", "author": "olegmoz", "createdAt": "2020-09-25T08:39:07Z", "path": "src/test/java/com/artipie/FilesRepoITCase.java", "diffHunk": "@@ -0,0 +1,163 @@\n+/*\n+ * The MIT License (MIT)\n+ *\n+ * Copyright (c) 2020 artipie.com\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included\n+ * in all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ */\n+package com.artipie;\n+\n+import com.amihaiemil.eoyaml.Yaml;\n+import com.artipie.asto.Key;\n+import com.artipie.asto.Storage;\n+import com.artipie.asto.blocking.BlockingStorage;\n+import com.artipie.asto.fs.FileStorage;\n+import com.artipie.asto.test.TestResource;\n+import com.jcabi.log.Logger;\n+import java.nio.file.Path;\n+import java.util.regex.Pattern;\n+import org.hamcrest.MatcherAssert;\n+import org.hamcrest.core.StringContains;\n+import org.hamcrest.text.MatchesPattern;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.condition.EnabledOnOs;\n+import org.junit.jupiter.api.condition.OS;\n+import org.junit.jupiter.api.io.TempDir;\n+import org.testcontainers.Testcontainers;\n+import org.testcontainers.containers.GenericContainer;\n+\n+/**\n+ * Integration tests for Files repository.\n+ * @since 0.11\n+ * @checkstyle ClassDataAbstractionCouplingCheck (500 lines)\n+ */\n+@SuppressWarnings(\"PMD.AvoidDuplicateLiterals\")\n+@EnabledOnOs({OS.LINUX, OS.MAC})\n+final class FilesRepoITCase {\n+\n+    /**\n+     * Temporary directory for all tests.\n+     * @checkstyle VisibilityModifierCheck (3 lines)\n+     */\n+    @TempDir\n+    Path tmp;\n+\n+    /**\n+     * Tested Artipie server.\n+     */\n+    private ArtipieServer server;\n+\n+    /**\n+     * Container.\n+     */\n+    private GenericContainer<?> cntn;\n+\n+    /**\n+     * Storage.\n+     */\n+    private Storage storage;\n+\n+    /**\n+     * Artipie server port.\n+     */\n+    private int port;\n+\n+    @BeforeEach\n+    void init() throws Exception {\n+        this.storage = new FileStorage(this.tmp);\n+        this.server = new ArtipieServer(this.tmp, \"my-file\", this.configs());\n+        this.port = this.server.start();\n+        this.server.start();\n+        Testcontainers.exposeHostPorts(this.port);\n+        this.cntn = new GenericContainer<>(\"centos:centos8\")\n+            .withCommand(\"tail\", \"-f\", \"/dev/null\")\n+            .withWorkingDirectory(\"/home/\")\n+            .withFileSystemBind(this.tmp.toString(), \"/home\");\n+        this.cntn.start();\n+        this.exec(\"yum\", \"-y\", \"install\", \"curl\");\n+        this.exec(\"yum\", \"-y\", \"install\", \"maven\");\n+    }\n+\n+    @Test\n+    void downloadsArtifact() throws Exception {\n+        final String url = \"http://host.testcontainers.internal:%d/my-file/helloworld-src/pom.xml\";\n+        this.addFilesToStorage(\n+            \"helloworld-src\", new Key.From(\"my-file\", \"helloworld-src\")\n+        );\n+        MatcherAssert.assertThat(\n+            \"curl PUT doesn't work properly\",\n+            this.exec(\"curl\", \"-i\", \"-X\", \"PUT\", String.format(url, this.port)),\n+            new StringContains(\"HTTP/1.1 201 Created\")\n+        );", "originalCommit": "d66ccb8404551438f1379f62c3e5abe95b74ea97", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDgzODI2MQ==", "url": "https://github.com/artipie/artipie/pull/630#discussion_r494838261", "bodyText": "@genryxy please do not use a pom.xml file for this test, it is misguiding. When one sees pom.xml it means we are talking about Maven. And Maven has nothing to do with it. Please just create a file with some text at some path, so it will not give wrong idea to reader.", "author": "olegmoz", "createdAt": "2020-09-25T08:41:37Z", "path": "src/test/java/com/artipie/FilesRepoITCase.java", "diffHunk": "@@ -0,0 +1,163 @@\n+/*\n+ * The MIT License (MIT)\n+ *\n+ * Copyright (c) 2020 artipie.com\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included\n+ * in all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ */\n+package com.artipie;\n+\n+import com.amihaiemil.eoyaml.Yaml;\n+import com.artipie.asto.Key;\n+import com.artipie.asto.Storage;\n+import com.artipie.asto.blocking.BlockingStorage;\n+import com.artipie.asto.fs.FileStorage;\n+import com.artipie.asto.test.TestResource;\n+import com.jcabi.log.Logger;\n+import java.nio.file.Path;\n+import java.util.regex.Pattern;\n+import org.hamcrest.MatcherAssert;\n+import org.hamcrest.core.StringContains;\n+import org.hamcrest.text.MatchesPattern;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.condition.EnabledOnOs;\n+import org.junit.jupiter.api.condition.OS;\n+import org.junit.jupiter.api.io.TempDir;\n+import org.testcontainers.Testcontainers;\n+import org.testcontainers.containers.GenericContainer;\n+\n+/**\n+ * Integration tests for Files repository.\n+ * @since 0.11\n+ * @checkstyle ClassDataAbstractionCouplingCheck (500 lines)\n+ */\n+@SuppressWarnings(\"PMD.AvoidDuplicateLiterals\")\n+@EnabledOnOs({OS.LINUX, OS.MAC})\n+final class FilesRepoITCase {\n+\n+    /**\n+     * Temporary directory for all tests.\n+     * @checkstyle VisibilityModifierCheck (3 lines)\n+     */\n+    @TempDir\n+    Path tmp;\n+\n+    /**\n+     * Tested Artipie server.\n+     */\n+    private ArtipieServer server;\n+\n+    /**\n+     * Container.\n+     */\n+    private GenericContainer<?> cntn;\n+\n+    /**\n+     * Storage.\n+     */\n+    private Storage storage;\n+\n+    /**\n+     * Artipie server port.\n+     */\n+    private int port;\n+\n+    @BeforeEach\n+    void init() throws Exception {\n+        this.storage = new FileStorage(this.tmp);\n+        this.server = new ArtipieServer(this.tmp, \"my-file\", this.configs());\n+        this.port = this.server.start();\n+        this.server.start();\n+        Testcontainers.exposeHostPorts(this.port);\n+        this.cntn = new GenericContainer<>(\"centos:centos8\")\n+            .withCommand(\"tail\", \"-f\", \"/dev/null\")\n+            .withWorkingDirectory(\"/home/\")\n+            .withFileSystemBind(this.tmp.toString(), \"/home\");\n+        this.cntn.start();\n+        this.exec(\"yum\", \"-y\", \"install\", \"curl\");\n+        this.exec(\"yum\", \"-y\", \"install\", \"maven\");\n+    }\n+\n+    @Test\n+    void downloadsArtifact() throws Exception {\n+        final String url = \"http://host.testcontainers.internal:%d/my-file/helloworld-src/pom.xml\";\n+        this.addFilesToStorage(\n+            \"helloworld-src\", new Key.From(\"my-file\", \"helloworld-src\")\n+        );", "originalCommit": "d66ccb8404551438f1379f62c3e5abe95b74ea97", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDgzODY2MA==", "url": "https://github.com/artipie/artipie/pull/630#discussion_r494838660", "bodyText": "@genryxy running mvn clean command here is not needed, please remove it", "author": "olegmoz", "createdAt": "2020-09-25T08:42:18Z", "path": "src/test/java/com/artipie/FilesRepoITCase.java", "diffHunk": "@@ -0,0 +1,163 @@\n+/*\n+ * The MIT License (MIT)\n+ *\n+ * Copyright (c) 2020 artipie.com\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included\n+ * in all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ */\n+package com.artipie;\n+\n+import com.amihaiemil.eoyaml.Yaml;\n+import com.artipie.asto.Key;\n+import com.artipie.asto.Storage;\n+import com.artipie.asto.blocking.BlockingStorage;\n+import com.artipie.asto.fs.FileStorage;\n+import com.artipie.asto.test.TestResource;\n+import com.jcabi.log.Logger;\n+import java.nio.file.Path;\n+import java.util.regex.Pattern;\n+import org.hamcrest.MatcherAssert;\n+import org.hamcrest.core.StringContains;\n+import org.hamcrest.text.MatchesPattern;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.condition.EnabledOnOs;\n+import org.junit.jupiter.api.condition.OS;\n+import org.junit.jupiter.api.io.TempDir;\n+import org.testcontainers.Testcontainers;\n+import org.testcontainers.containers.GenericContainer;\n+\n+/**\n+ * Integration tests for Files repository.\n+ * @since 0.11\n+ * @checkstyle ClassDataAbstractionCouplingCheck (500 lines)\n+ */\n+@SuppressWarnings(\"PMD.AvoidDuplicateLiterals\")\n+@EnabledOnOs({OS.LINUX, OS.MAC})\n+final class FilesRepoITCase {\n+\n+    /**\n+     * Temporary directory for all tests.\n+     * @checkstyle VisibilityModifierCheck (3 lines)\n+     */\n+    @TempDir\n+    Path tmp;\n+\n+    /**\n+     * Tested Artipie server.\n+     */\n+    private ArtipieServer server;\n+\n+    /**\n+     * Container.\n+     */\n+    private GenericContainer<?> cntn;\n+\n+    /**\n+     * Storage.\n+     */\n+    private Storage storage;\n+\n+    /**\n+     * Artipie server port.\n+     */\n+    private int port;\n+\n+    @BeforeEach\n+    void init() throws Exception {\n+        this.storage = new FileStorage(this.tmp);\n+        this.server = new ArtipieServer(this.tmp, \"my-file\", this.configs());\n+        this.port = this.server.start();\n+        this.server.start();\n+        Testcontainers.exposeHostPorts(this.port);\n+        this.cntn = new GenericContainer<>(\"centos:centos8\")\n+            .withCommand(\"tail\", \"-f\", \"/dev/null\")\n+            .withWorkingDirectory(\"/home/\")\n+            .withFileSystemBind(this.tmp.toString(), \"/home\");\n+        this.cntn.start();\n+        this.exec(\"yum\", \"-y\", \"install\", \"curl\");\n+        this.exec(\"yum\", \"-y\", \"install\", \"maven\");\n+    }\n+\n+    @Test\n+    void downloadsArtifact() throws Exception {\n+        final String url = \"http://host.testcontainers.internal:%d/my-file/helloworld-src/pom.xml\";\n+        this.addFilesToStorage(\n+            \"helloworld-src\", new Key.From(\"my-file\", \"helloworld-src\")\n+        );\n+        MatcherAssert.assertThat(\n+            \"curl PUT doesn't work properly\",\n+            this.exec(\"curl\", \"-i\", \"-X\", \"PUT\", String.format(url, this.port)),\n+            new StringContains(\"HTTP/1.1 201 Created\")\n+        );\n+        MatcherAssert.assertThat(\n+            \"curl GET doesn't work properly\",\n+            this.exec(\"curl\", \"-i\", \"-X\", \"GET\", String.format(url, this.port)),\n+            new MatchesPattern(\n+                Pattern.compile(\n+                    // @checkstyle LineLengthCheck (1 line)\n+                    \"HTTP\\\\/1.1 200 OK[\\\\r\\\\n]{0,2}Content-Type: application\\\\/octet-stream[\\\\r\\\\n \\\\S]*\"\n+                )\n+            )\n+        );\n+        this.exec(\"mvn\", \"clean\");", "originalCommit": "d66ccb8404551438f1379f62c3e5abe95b74ea97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDg1MzUxNw==", "url": "https://github.com/artipie/artipie/pull/630#discussion_r494853517", "bodyText": "@olegmoz in some case I get the error as https://github.com/artipie/artipie/pull/537/checks?check_run_id=1081335703#step:5:1028 In the previous case running mvn clean command helped to fix. I can try to push without maven", "author": "genryxy", "createdAt": "2020-09-25T09:08:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDgzODY2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDg3NDU4MQ==", "url": "https://github.com/artipie/artipie/pull/630#discussion_r494874581", "bodyText": "@genryxy that was in Maven test, this test is absolutely unrelated. So I am pretty sure that everything will work fine if you remove mvn clean", "author": "olegmoz", "createdAt": "2020-09-25T09:45:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDgzODY2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDg3Njk3OQ==", "url": "https://github.com/artipie/artipie/pull/630#discussion_r494876979", "bodyText": "@olegmoz understood, thanks", "author": "genryxy", "createdAt": "2020-09-25T09:49:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDgzODY2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDgzOTAyOA==", "url": "https://github.com/artipie/artipie/pull/630#discussion_r494839028", "bodyText": "@genryxy do not see the reason why name is plural, e.g. configS, why not just config?", "author": "olegmoz", "createdAt": "2020-09-25T08:43:00Z", "path": "src/test/java/com/artipie/FilesRepoITCase.java", "diffHunk": "@@ -0,0 +1,163 @@\n+/*\n+ * The MIT License (MIT)\n+ *\n+ * Copyright (c) 2020 artipie.com\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included\n+ * in all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ */\n+package com.artipie;\n+\n+import com.amihaiemil.eoyaml.Yaml;\n+import com.artipie.asto.Key;\n+import com.artipie.asto.Storage;\n+import com.artipie.asto.blocking.BlockingStorage;\n+import com.artipie.asto.fs.FileStorage;\n+import com.artipie.asto.test.TestResource;\n+import com.jcabi.log.Logger;\n+import java.nio.file.Path;\n+import java.util.regex.Pattern;\n+import org.hamcrest.MatcherAssert;\n+import org.hamcrest.core.StringContains;\n+import org.hamcrest.text.MatchesPattern;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.condition.EnabledOnOs;\n+import org.junit.jupiter.api.condition.OS;\n+import org.junit.jupiter.api.io.TempDir;\n+import org.testcontainers.Testcontainers;\n+import org.testcontainers.containers.GenericContainer;\n+\n+/**\n+ * Integration tests for Files repository.\n+ * @since 0.11\n+ * @checkstyle ClassDataAbstractionCouplingCheck (500 lines)\n+ */\n+@SuppressWarnings(\"PMD.AvoidDuplicateLiterals\")\n+@EnabledOnOs({OS.LINUX, OS.MAC})\n+final class FilesRepoITCase {\n+\n+    /**\n+     * Temporary directory for all tests.\n+     * @checkstyle VisibilityModifierCheck (3 lines)\n+     */\n+    @TempDir\n+    Path tmp;\n+\n+    /**\n+     * Tested Artipie server.\n+     */\n+    private ArtipieServer server;\n+\n+    /**\n+     * Container.\n+     */\n+    private GenericContainer<?> cntn;\n+\n+    /**\n+     * Storage.\n+     */\n+    private Storage storage;\n+\n+    /**\n+     * Artipie server port.\n+     */\n+    private int port;\n+\n+    @BeforeEach\n+    void init() throws Exception {\n+        this.storage = new FileStorage(this.tmp);\n+        this.server = new ArtipieServer(this.tmp, \"my-file\", this.configs());\n+        this.port = this.server.start();\n+        this.server.start();\n+        Testcontainers.exposeHostPorts(this.port);\n+        this.cntn = new GenericContainer<>(\"centos:centos8\")\n+            .withCommand(\"tail\", \"-f\", \"/dev/null\")\n+            .withWorkingDirectory(\"/home/\")\n+            .withFileSystemBind(this.tmp.toString(), \"/home\");\n+        this.cntn.start();\n+        this.exec(\"yum\", \"-y\", \"install\", \"curl\");\n+        this.exec(\"yum\", \"-y\", \"install\", \"maven\");\n+    }\n+\n+    @Test\n+    void downloadsArtifact() throws Exception {\n+        final String url = \"http://host.testcontainers.internal:%d/my-file/helloworld-src/pom.xml\";\n+        this.addFilesToStorage(\n+            \"helloworld-src\", new Key.From(\"my-file\", \"helloworld-src\")\n+        );\n+        MatcherAssert.assertThat(\n+            \"curl PUT doesn't work properly\",\n+            this.exec(\"curl\", \"-i\", \"-X\", \"PUT\", String.format(url, this.port)),\n+            new StringContains(\"HTTP/1.1 201 Created\")\n+        );\n+        MatcherAssert.assertThat(\n+            \"curl GET doesn't work properly\",\n+            this.exec(\"curl\", \"-i\", \"-X\", \"GET\", String.format(url, this.port)),\n+            new MatchesPattern(\n+                Pattern.compile(\n+                    // @checkstyle LineLengthCheck (1 line)\n+                    \"HTTP\\\\/1.1 200 OK[\\\\r\\\\n]{0,2}Content-Type: application\\\\/octet-stream[\\\\r\\\\n \\\\S]*\"\n+                )\n+            )\n+        );\n+        this.exec(\"mvn\", \"clean\");\n+    }\n+\n+    @AfterEach\n+    void release() throws Exception {\n+        this.server.stop();\n+        this.cntn.stop();\n+    }\n+\n+    private String exec(final String... command) throws Exception {\n+        Logger.debug(this, \"Command:\\n%s\", String.join(\" \", command));\n+        return this.cntn.execInContainer(command).getStdout();\n+    }\n+\n+    private String configs() {", "originalCommit": "d66ccb8404551438f1379f62c3e5abe95b74ea97", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDgzOTgwNA==", "url": "https://github.com/artipie/artipie/pull/630#discussion_r494839804", "bodyText": "@genryxy it's common to write what we expect, not what what happend on a failure. Meaning this would be better change to curl PUT does work properly. Same goes for other assert comment about curl GET", "author": "olegmoz", "createdAt": "2020-09-25T08:44:29Z", "path": "src/test/java/com/artipie/FilesRepoITCase.java", "diffHunk": "@@ -0,0 +1,163 @@\n+/*\n+ * The MIT License (MIT)\n+ *\n+ * Copyright (c) 2020 artipie.com\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included\n+ * in all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ */\n+package com.artipie;\n+\n+import com.amihaiemil.eoyaml.Yaml;\n+import com.artipie.asto.Key;\n+import com.artipie.asto.Storage;\n+import com.artipie.asto.blocking.BlockingStorage;\n+import com.artipie.asto.fs.FileStorage;\n+import com.artipie.asto.test.TestResource;\n+import com.jcabi.log.Logger;\n+import java.nio.file.Path;\n+import java.util.regex.Pattern;\n+import org.hamcrest.MatcherAssert;\n+import org.hamcrest.core.StringContains;\n+import org.hamcrest.text.MatchesPattern;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.condition.EnabledOnOs;\n+import org.junit.jupiter.api.condition.OS;\n+import org.junit.jupiter.api.io.TempDir;\n+import org.testcontainers.Testcontainers;\n+import org.testcontainers.containers.GenericContainer;\n+\n+/**\n+ * Integration tests for Files repository.\n+ * @since 0.11\n+ * @checkstyle ClassDataAbstractionCouplingCheck (500 lines)\n+ */\n+@SuppressWarnings(\"PMD.AvoidDuplicateLiterals\")\n+@EnabledOnOs({OS.LINUX, OS.MAC})\n+final class FilesRepoITCase {\n+\n+    /**\n+     * Temporary directory for all tests.\n+     * @checkstyle VisibilityModifierCheck (3 lines)\n+     */\n+    @TempDir\n+    Path tmp;\n+\n+    /**\n+     * Tested Artipie server.\n+     */\n+    private ArtipieServer server;\n+\n+    /**\n+     * Container.\n+     */\n+    private GenericContainer<?> cntn;\n+\n+    /**\n+     * Storage.\n+     */\n+    private Storage storage;\n+\n+    /**\n+     * Artipie server port.\n+     */\n+    private int port;\n+\n+    @BeforeEach\n+    void init() throws Exception {\n+        this.storage = new FileStorage(this.tmp);\n+        this.server = new ArtipieServer(this.tmp, \"my-file\", this.configs());\n+        this.port = this.server.start();\n+        this.server.start();\n+        Testcontainers.exposeHostPorts(this.port);\n+        this.cntn = new GenericContainer<>(\"centos:centos8\")\n+            .withCommand(\"tail\", \"-f\", \"/dev/null\")\n+            .withWorkingDirectory(\"/home/\")\n+            .withFileSystemBind(this.tmp.toString(), \"/home\");\n+        this.cntn.start();\n+        this.exec(\"yum\", \"-y\", \"install\", \"curl\");\n+        this.exec(\"yum\", \"-y\", \"install\", \"maven\");\n+    }\n+\n+    @Test\n+    void downloadsArtifact() throws Exception {\n+        final String url = \"http://host.testcontainers.internal:%d/my-file/helloworld-src/pom.xml\";\n+        this.addFilesToStorage(\n+            \"helloworld-src\", new Key.From(\"my-file\", \"helloworld-src\")\n+        );\n+        MatcherAssert.assertThat(\n+            \"curl PUT doesn't work properly\",", "originalCommit": "d66ccb8404551438f1379f62c3e5abe95b74ea97", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "166e7cc2a22bec9c5a8db71d0db4a1c2ea9d76a7", "url": "https://github.com/artipie/artipie/commit/166e7cc2a22bec9c5a8db71d0db4a1c2ea9d76a7", "message": "#603 - Review fixes", "committedDate": "2020-09-25T09:50:50Z", "type": "commit"}, {"oid": "09cd652b3c90b2c870f7f84741d9ba8f66dfe008", "url": "https://github.com/artipie/artipie/commit/09cd652b3c90b2c870f7f84741d9ba8f66dfe008", "message": "Merge branch 'master' into 603-filesRepoIT", "committedDate": "2020-09-25T09:54:16Z", "type": "commit"}, {"oid": "e8b09d3b227cbfcd23e9950ebd42de678a5a94c5", "url": "https://github.com/artipie/artipie/commit/e8b09d3b227cbfcd23e9950ebd42de678a5a94c5", "message": "Merge branch 'master' into 603-filesRepoIT", "committedDate": "2020-09-25T11:29:12Z", "type": "commit"}]}