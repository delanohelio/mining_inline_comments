{"pr_number": 363, "pr_title": "#333 - Multi remote docker proxy support", "pr_createdAt": "2020-07-20T10:11:22Z", "pr_url": "https://github.com/artipie/artipie/pull/363", "timeline": [{"oid": "4c8c65af847a3e88d2f559772645fa712917021f", "url": "https://github.com/artipie/artipie/commit/4c8c65af847a3e88d2f559772645fa712917021f", "message": "#333 - Multi remote docker proxy support", "committedDate": "2020-07-20T10:27:27Z", "type": "forcePushed"}, {"oid": "4c8c65af847a3e88d2f559772645fa712917021f", "url": "https://github.com/artipie/artipie/commit/4c8c65af847a3e88d2f559772645fa712917021f", "message": "#333 - Multi remote docker proxy support", "committedDate": "2020-07-20T10:27:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM2MjkyNg==", "url": "https://github.com/artipie/artipie/pull/363#discussion_r457362926", "bodyText": "@olegmoz How about using Optional here?", "author": "paulodamaso", "createdAt": "2020-07-20T13:03:49Z", "path": "src/main/java/com/artipie/docker/DockerProxy.java", "diffHunk": "@@ -88,15 +93,51 @@ public Response response(\n      * @return Docker proxy slice.\n      */\n     private Slice delegate() {\n-        final YamlMapping settings = this.cfg.settings()\n-            .orElseThrow(() -> new IllegalStateException(\"Settings not found for Docker proxy\"));\n-        final String host = settings.string(\"host\");\n-        if (host == null) {\n-            throw new IllegalStateException(\"`host` is not specified in settings for Docker proxy\");\n+        final YamlSequence remotes = Optional.ofNullable(\n+            this.cfg.repoConfig().yamlSequence(\"remotes\")\n+        ).orElseThrow(() -> new IllegalStateException(\"`remotes` not found for Docker proxy\"));\n+        final ClientSlices slices = new ClientSlices(this.client);\n+        final Docker proxies = new MultiReadDocker(\n+            StreamSupport.stream(remotes.spliterator(), false).map(\n+                remote -> {\n+                    if (!(remote instanceof YamlMapping)) {\n+                        throw new IllegalStateException(\n+                            \"`remotes` element is not mapping in Docker proxy\"\n+                        );\n+                    }\n+                    final YamlMapping mapping = (YamlMapping) remote;\n+                    return this.proxy(slices, mapping);\n+                }\n+            ).collect(Collectors.toList())\n+        );\n+        final Docker docker = this.cfg.storageOpt()\n+            .<Docker>map(\n+                storage -> {\n+                    final AstoDocker local = new AstoDocker(storage);\n+                    return new ReadWriteDocker(new MultiReadDocker(local, proxies), local);\n+                }\n+            )\n+            .orElse(proxies);\n+        return new DockerSlice(docker);\n+    }\n+\n+    /**\n+     * Create proxy from YAML config.\n+     *\n+     * @param slices HTTP client slices.\n+     * @param mapping YAML config.\n+     * @return Docker proxy.\n+     */\n+    private Docker proxy(final ClientSlices slices, final YamlMapping mapping) {\n+        final String url = mapping.string(\"url\");\n+        if (url == null) {", "originalCommit": "4c8c65af847a3e88d2f559772645fa712917021f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM2NTcxNw==", "url": "https://github.com/artipie/artipie/pull/363#discussion_r457365717", "bodyText": "@olegmoz I see that this method was just made public, but I think that it would be a good idea to change its message to something like yaml repo config is null or absent; I think that it represents better the error, and it is important now that we have this method public which can be called by anyone since it is public. WDYT?", "author": "paulodamaso", "createdAt": "2020-07-20T13:07:37Z", "path": "src/main/java/com/artipie/RepoConfig.java", "diffHunk": "@@ -191,6 +211,15 @@ public Permissions permissions() {\n             .thenApply(yaml -> new RepoConfig(storages, prefix, yaml));\n     }\n \n+    /**\n+     * Repo part of YAML.\n+     *\n+     * @return Async YAML mapping\n+     */\n+    public YamlMapping repoConfig() {\n+        return Objects.requireNonNull(this.yaml.yamlMapping(\"repo\"), \"yaml repo is null\");", "originalCommit": "4c8c65af847a3e88d2f559772645fa712917021f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b293074b4baf1bce55aad2a03a9eaa0bfb63f9a5", "url": "https://github.com/artipie/artipie/commit/b293074b4baf1bce55aad2a03a9eaa0bfb63f9a5", "message": "#333 - Changes by review", "committedDate": "2020-07-20T16:44:14Z", "type": "forcePushed"}, {"oid": "b293074b4baf1bce55aad2a03a9eaa0bfb63f9a5", "url": "https://github.com/artipie/artipie/commit/b293074b4baf1bce55aad2a03a9eaa0bfb63f9a5", "message": "#333 - Changes by review", "committedDate": "2020-07-20T16:44:14Z", "type": "commit"}, {"oid": "5e8e6226d7aba6bbaae0af08a9cdd72629d8d82e", "url": "https://github.com/artipie/artipie/commit/5e8e6226d7aba6bbaae0af08a9cdd72629d8d82e", "message": "Merge branch 'master' into 333-multi-remote-docker", "committedDate": "2020-07-21T07:58:18Z", "type": "commit"}, {"oid": "e574f98871937d126d6cf48f929e8d2c901467eb", "url": "https://github.com/artipie/artipie/commit/e574f98871937d126d6cf48f929e8d2c901467eb", "message": "Merge branch 'master' into 333-multi-remote-docker", "committedDate": "2020-07-21T15:58:25Z", "type": "commit"}]}