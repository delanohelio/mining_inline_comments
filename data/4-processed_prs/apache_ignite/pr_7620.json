{"pr_number": 7620, "pr_title": "IGNITE-12828 Fixes NPE during CQ registration with failed deployment.", "pr_createdAt": "2020-04-03T10:32:48Z", "pr_url": "https://github.com/apache/ignite/pull/7620", "timeline": [{"oid": "38d9ff7c2b98e7723b962fa1e5036d311bb9dc2b", "url": "https://github.com/apache/ignite/commit/38d9ff7c2b98e7723b962fa1e5036d311bb9dc2b", "message": "IGNITE-12828 Fixes NPE during CQ registration with failed deployment.", "committedDate": "2020-04-03T11:34:59Z", "type": "commit"}, {"oid": "38d9ff7c2b98e7723b962fa1e5036d311bb9dc2b", "url": "https://github.com/apache/ignite/commit/38d9ff7c2b98e7723b962fa1e5036d311bb9dc2b", "message": "IGNITE-12828 Fixes NPE during CQ registration with failed deployment.", "committedDate": "2020-04-03T11:34:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzIxMDcwOA==", "url": "https://github.com/apache/ignite/pull/7620#discussion_r403210708", "bodyText": "Is err == null not enough?", "author": "NSAmelchev", "createdAt": "2020-04-03T18:12:22Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/continuous/GridContinuousProcessor.java", "diffHunk": "@@ -1472,14 +1472,16 @@ private void processStartRequest(ClusterNode node, StartRoutineDiscoveryMessage\n         }\n \n         // Load partition counters.\n-        if (hnd.isQuery()) {\n+        if (err == null && hnd.isQuery()) {\n             GridCacheProcessor proc = ctx.cache();\n \n             if (proc != null) {\n                 GridCacheAdapter cache = ctx.cache().internalCache(hnd.cacheName());\n \n-                if (cache != null && !cache.isLocal() && cache.context().userCache())\n-                    req.addUpdateCounters(ctx.localNodeId(), hnd.updateCounters());\n+                Map<Integer, T2<Long, Long>> cntrs = hnd.updateCounters();\n+\n+                if (cache != null && cntrs != null && !cache.isLocal() && cache.context().userCache())", "originalCommit": "38d9ff7c2b98e7723b962fa1e5036d311bb9dc2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzIxMjg5OQ==", "url": "https://github.com/apache/ignite/pull/7620#discussion_r403212899", "bodyText": "typo: behavior", "author": "NSAmelchev", "createdAt": "2020-04-03T18:14:46Z", "path": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/query/continuous/ContinuousQueryFilterDeploymentFailedTest.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache.query.continuous;\n+\n+import javax.cache.CacheException;\n+import javax.cache.configuration.Factory;\n+import javax.cache.event.CacheEntryEventFilter;\n+import org.apache.ignite.cache.query.ContinuousQuery;\n+import org.apache.ignite.cluster.ClusterState;\n+import org.apache.ignite.configuration.CacheConfiguration;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.internal.TestRecordingCommunicationSpi;\n+import org.apache.ignite.internal.managers.deployment.GridDeploymentRequest;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+import org.junit.Test;\n+\n+import static org.apache.ignite.internal.TestRecordingCommunicationSpi.spi;\n+import static org.apache.ignite.internal.processors.continuous.GridContinuousProcessor.CQ_SYS_VIEW;\n+import static org.apache.ignite.testframework.GridTestUtils.assertThrowsAnyCause;\n+\n+/**\n+ * Tests the behaviour of continuous query registration in case the remote node failed to obtain the filter deployment.\n+ */\n+public class ContinuousQueryFilterDeploymentFailedTest extends GridCommonAbstractTest {\n+    /** The name of the CQ filter factory class. Its obtaining on a non-local node requires P2P class loading. */\n+    private static final String EXT_FILTER_CLS = \"org.apache.ignite.tests.p2p.CacheDeploymentEntryEventFilterFactory\";\n+\n+    /** {@inheritDoc} */\n+    @Override protected IgniteConfiguration getConfiguration(String igniteInstanceName) throws Exception {\n+        IgniteConfiguration cfg = super.getConfiguration(igniteInstanceName);\n+\n+        cfg.setCommunicationSpi(new TestRecordingCommunicationSpi());\n+        cfg.setPeerClassLoadingEnabled(true);\n+        cfg.setNetworkTimeout(1000);\n+\n+        return cfg;\n+    }\n+\n+    /**\n+     * Tests continuous query behaviour in case of filter deployment obtaining failure.", "originalCommit": "38d9ff7c2b98e7723b962fa1e5036d311bb9dc2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzIxMzMxNA==", "url": "https://github.com/apache/ignite/pull/7620#discussion_r403213314", "bodyText": "Missed @throws", "author": "NSAmelchev", "createdAt": "2020-04-03T18:15:14Z", "path": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/query/continuous/ContinuousQueryFilterDeploymentFailedTest.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache.query.continuous;\n+\n+import javax.cache.CacheException;\n+import javax.cache.configuration.Factory;\n+import javax.cache.event.CacheEntryEventFilter;\n+import org.apache.ignite.cache.query.ContinuousQuery;\n+import org.apache.ignite.cluster.ClusterState;\n+import org.apache.ignite.configuration.CacheConfiguration;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.internal.TestRecordingCommunicationSpi;\n+import org.apache.ignite.internal.managers.deployment.GridDeploymentRequest;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+import org.junit.Test;\n+\n+import static org.apache.ignite.internal.TestRecordingCommunicationSpi.spi;\n+import static org.apache.ignite.internal.processors.continuous.GridContinuousProcessor.CQ_SYS_VIEW;\n+import static org.apache.ignite.testframework.GridTestUtils.assertThrowsAnyCause;\n+\n+/**\n+ * Tests the behaviour of continuous query registration in case the remote node failed to obtain the filter deployment.\n+ */\n+public class ContinuousQueryFilterDeploymentFailedTest extends GridCommonAbstractTest {\n+    /** The name of the CQ filter factory class. Its obtaining on a non-local node requires P2P class loading. */\n+    private static final String EXT_FILTER_CLS = \"org.apache.ignite.tests.p2p.CacheDeploymentEntryEventFilterFactory\";\n+\n+    /** {@inheritDoc} */\n+    @Override protected IgniteConfiguration getConfiguration(String igniteInstanceName) throws Exception {\n+        IgniteConfiguration cfg = super.getConfiguration(igniteInstanceName);\n+\n+        cfg.setCommunicationSpi(new TestRecordingCommunicationSpi());\n+        cfg.setPeerClassLoadingEnabled(true);\n+        cfg.setNetworkTimeout(1000);\n+\n+        return cfg;\n+    }\n+\n+    /**\n+     * Tests continuous query behaviour in case of filter deployment obtaining failure.\n+     */", "originalCommit": "38d9ff7c2b98e7723b962fa1e5036d311bb9dc2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzIxOTk4Mg==", "url": "https://github.com/apache/ignite/pull/7620#discussion_r403219982", "bodyText": "? extends  is unnecessary", "author": "NSAmelchev", "createdAt": "2020-04-03T18:23:11Z", "path": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/query/continuous/ContinuousQueryFilterDeploymentFailedTest.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache.query.continuous;\n+\n+import javax.cache.CacheException;\n+import javax.cache.configuration.Factory;\n+import javax.cache.event.CacheEntryEventFilter;\n+import org.apache.ignite.cache.query.ContinuousQuery;\n+import org.apache.ignite.cluster.ClusterState;\n+import org.apache.ignite.configuration.CacheConfiguration;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.internal.TestRecordingCommunicationSpi;\n+import org.apache.ignite.internal.managers.deployment.GridDeploymentRequest;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+import org.junit.Test;\n+\n+import static org.apache.ignite.internal.TestRecordingCommunicationSpi.spi;\n+import static org.apache.ignite.internal.processors.continuous.GridContinuousProcessor.CQ_SYS_VIEW;\n+import static org.apache.ignite.testframework.GridTestUtils.assertThrowsAnyCause;\n+\n+/**\n+ * Tests the behaviour of continuous query registration in case the remote node failed to obtain the filter deployment.\n+ */\n+public class ContinuousQueryFilterDeploymentFailedTest extends GridCommonAbstractTest {\n+    /** The name of the CQ filter factory class. Its obtaining on a non-local node requires P2P class loading. */\n+    private static final String EXT_FILTER_CLS = \"org.apache.ignite.tests.p2p.CacheDeploymentEntryEventFilterFactory\";\n+\n+    /** {@inheritDoc} */\n+    @Override protected IgniteConfiguration getConfiguration(String igniteInstanceName) throws Exception {\n+        IgniteConfiguration cfg = super.getConfiguration(igniteInstanceName);\n+\n+        cfg.setCommunicationSpi(new TestRecordingCommunicationSpi());\n+        cfg.setPeerClassLoadingEnabled(true);\n+        cfg.setNetworkTimeout(1000);\n+\n+        return cfg;\n+    }\n+\n+    /**\n+     * Tests continuous query behaviour in case of filter deployment obtaining failure.\n+     */\n+    @Test\n+    @SuppressWarnings({\"ThrowableNotThrown\"})\n+    public void testContinuousQueryFilterDeploymentFailed() throws Exception {\n+        startGrids(2).cluster().state(ClusterState.ACTIVE);\n+\n+        grid(0).createCache(new CacheConfiguration<>(DEFAULT_CACHE_NAME));\n+\n+        ContinuousQuery<Integer, Integer> qry = new ContinuousQuery<>();\n+\n+        Class<Factory<? extends CacheEntryEventFilter<Integer, Integer>>> filterFactoryCls =", "originalCommit": "38d9ff7c2b98e7723b962fa1e5036d311bb9dc2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzIyMDg3Nw==", "url": "https://github.com/apache/ignite/pull/7620#discussion_r403220877", "bodyText": "Whitespace after the cast is unnecessary.", "author": "NSAmelchev", "createdAt": "2020-04-03T18:24:16Z", "path": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/query/continuous/ContinuousQueryFilterDeploymentFailedTest.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache.query.continuous;\n+\n+import javax.cache.CacheException;\n+import javax.cache.configuration.Factory;\n+import javax.cache.event.CacheEntryEventFilter;\n+import org.apache.ignite.cache.query.ContinuousQuery;\n+import org.apache.ignite.cluster.ClusterState;\n+import org.apache.ignite.configuration.CacheConfiguration;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.internal.TestRecordingCommunicationSpi;\n+import org.apache.ignite.internal.managers.deployment.GridDeploymentRequest;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+import org.junit.Test;\n+\n+import static org.apache.ignite.internal.TestRecordingCommunicationSpi.spi;\n+import static org.apache.ignite.internal.processors.continuous.GridContinuousProcessor.CQ_SYS_VIEW;\n+import static org.apache.ignite.testframework.GridTestUtils.assertThrowsAnyCause;\n+\n+/**\n+ * Tests the behaviour of continuous query registration in case the remote node failed to obtain the filter deployment.\n+ */\n+public class ContinuousQueryFilterDeploymentFailedTest extends GridCommonAbstractTest {\n+    /** The name of the CQ filter factory class. Its obtaining on a non-local node requires P2P class loading. */\n+    private static final String EXT_FILTER_CLS = \"org.apache.ignite.tests.p2p.CacheDeploymentEntryEventFilterFactory\";\n+\n+    /** {@inheritDoc} */\n+    @Override protected IgniteConfiguration getConfiguration(String igniteInstanceName) throws Exception {\n+        IgniteConfiguration cfg = super.getConfiguration(igniteInstanceName);\n+\n+        cfg.setCommunicationSpi(new TestRecordingCommunicationSpi());\n+        cfg.setPeerClassLoadingEnabled(true);\n+        cfg.setNetworkTimeout(1000);\n+\n+        return cfg;\n+    }\n+\n+    /**\n+     * Tests continuous query behaviour in case of filter deployment obtaining failure.\n+     */\n+    @Test\n+    @SuppressWarnings({\"ThrowableNotThrown\"})\n+    public void testContinuousQueryFilterDeploymentFailed() throws Exception {\n+        startGrids(2).cluster().state(ClusterState.ACTIVE);\n+\n+        grid(0).createCache(new CacheConfiguration<>(DEFAULT_CACHE_NAME));\n+\n+        ContinuousQuery<Integer, Integer> qry = new ContinuousQuery<>();\n+\n+        Class<Factory<? extends CacheEntryEventFilter<Integer, Integer>>> filterFactoryCls =\n+            (Class<Factory<? extends CacheEntryEventFilter<Integer, Integer>>>) getExternalClassLoader()", "originalCommit": "38d9ff7c2b98e7723b962fa1e5036d311bb9dc2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4da37044b9888fdfd279bc8732826bbebbe0e901", "url": "https://github.com/apache/ignite/commit/4da37044b9888fdfd279bc8732826bbebbe0e901", "message": "IGNITE-12828 Removes CQ handler cache update counters null check.", "committedDate": "2020-04-05T13:45:16Z", "type": "forcePushed"}, {"oid": "53e7822176fe45de6045fee18f48c85435747b42", "url": "https://github.com/apache/ignite/commit/53e7822176fe45de6045fee18f48c85435747b42", "message": "IGNITE-12828 Removes CQ handler cache update counters null check.", "committedDate": "2020-04-05T14:07:36Z", "type": "commit"}, {"oid": "53e7822176fe45de6045fee18f48c85435747b42", "url": "https://github.com/apache/ignite/commit/53e7822176fe45de6045fee18f48c85435747b42", "message": "IGNITE-12828 Removes CQ handler cache update counters null check.", "committedDate": "2020-04-05T14:07:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc0MzMyOQ==", "url": "https://github.com/apache/ignite/pull/7620#discussion_r403743329", "bodyText": "Let's use a shortened form rmt", "author": "NSAmelchev", "createdAt": "2020-04-05T19:02:34Z", "path": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/query/continuous/CacheContinuousQueryFilterDeploymentFailedTest.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache.query.continuous;\n+\n+import javax.cache.CacheException;\n+import javax.cache.configuration.Factory;\n+import javax.cache.event.CacheEntryEventFilter;\n+import org.apache.ignite.cache.query.ContinuousQuery;\n+import org.apache.ignite.cluster.ClusterState;\n+import org.apache.ignite.configuration.CacheConfiguration;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.internal.TestRecordingCommunicationSpi;\n+import org.apache.ignite.internal.managers.deployment.GridDeploymentRequest;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+import org.junit.Test;\n+\n+import static org.apache.ignite.internal.TestRecordingCommunicationSpi.spi;\n+import static org.apache.ignite.internal.processors.continuous.GridContinuousProcessor.CQ_SYS_VIEW;\n+import static org.apache.ignite.testframework.GridTestUtils.assertThrowsAnyCause;\n+\n+/**\n+ * Tests the behavior of continuous query registration in case the remote node failed to obtain the filter deployment.\n+ */\n+public class CacheContinuousQueryFilterDeploymentFailedTest extends GridCommonAbstractTest {\n+    /** The name of the CQ filter factory class. Its obtaining on a non-local node requires P2P class loading. */\n+    private static final String EXT_FILTER_FACTORY_CLS =\n+        \"org.apache.ignite.tests.p2p.CacheDeploymentEntryEventFilterFactory\";\n+\n+    /** {@inheritDoc} */\n+    @Override protected IgniteConfiguration getConfiguration(String igniteInstanceName) throws Exception {\n+        IgniteConfiguration cfg = super.getConfiguration(igniteInstanceName);\n+\n+        cfg.setCommunicationSpi(new TestRecordingCommunicationSpi());\n+        cfg.setNetworkTimeout(1000);\n+\n+        return cfg;\n+    }\n+\n+    /**\n+     * Tests continuous query behavior in case of filter deployment obtaining failure.\n+     *\n+     * @throws Exception If failed.\n+     */\n+    @Test\n+    @SuppressWarnings({\"ThrowableNotThrown\"})\n+    public void testContinuousQueryFilterDeploymentFailed() throws Exception {\n+        startGrids(2).cluster().state(ClusterState.ACTIVE);\n+\n+        grid(0).createCache(new CacheConfiguration<>(DEFAULT_CACHE_NAME));\n+\n+        ContinuousQuery<Integer, Integer> qry = new ContinuousQuery<>();\n+\n+        Class<Factory<CacheEntryEventFilter<Integer, Integer>>> remoteFilterFactoryCls =\n+            (Class<Factory<CacheEntryEventFilter<Integer, Integer>>>)getExternalClassLoader()\n+                .loadClass(EXT_FILTER_FACTORY_CLS);\n+\n+        Factory<CacheEntryEventFilter<Integer, Integer>> remoteFilterFactory = remoteFilterFactoryCls.newInstance();", "originalCommit": "53e7822176fe45de6045fee18f48c85435747b42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzg5ODM3Mg==", "url": "https://github.com/apache/ignite/pull/7620#discussion_r403898372", "bodyText": "Thanks. Done.", "author": "ololo3000", "createdAt": "2020-04-06T08:00:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc0MzMyOQ=="}], "type": "inlineReview"}, {"oid": "a1adb0ea7704c5a7c11e4d83ce62ad0041fa8e04", "url": "https://github.com/apache/ignite/commit/a1adb0ea7704c5a7c11e4d83ce62ad0041fa8e04", "message": "IGNITE-12828 Fixes minor issues.", "committedDate": "2020-04-05T20:04:43Z", "type": "commit"}, {"oid": "1ea4902e764f0623aff5e5c697791cc021ffba43", "url": "https://github.com/apache/ignite/commit/1ea4902e764f0623aff5e5c697791cc021ffba43", "message": "IGNITE-12828 Adds client node to test case.", "committedDate": "2020-04-07T16:03:12Z", "type": "commit"}, {"oid": "e6861d6fd81da408083fbfc3f527f180dd37fed7", "url": "https://github.com/apache/ignite/commit/e6861d6fd81da408083fbfc3f527f180dd37fed7", "message": "IGNITE-12828 Fixes minor issues.", "committedDate": "2020-04-08T08:45:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQwMTY5OQ==", "url": "https://github.com/apache/ignite/pull/7620#discussion_r405401699", "bodyText": "Unnecessary line break", "author": "NSAmelchev", "createdAt": "2020-04-08T09:52:47Z", "path": "modules/core/src/test/java/org/apache/ignite/internal/processors/cache/query/continuous/CacheContinuousQueryFilterDeploymentFailedTest.java", "diffHunk": "@@ -0,0 +1,180 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache.query.continuous;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import javax.cache.CacheException;\n+import javax.cache.configuration.Factory;\n+import javax.cache.event.CacheEntryEventFilter;\n+import org.apache.ignite.Ignite;\n+import org.apache.ignite.cache.query.ContinuousQuery;\n+import org.apache.ignite.cluster.ClusterNode;\n+import org.apache.ignite.configuration.CacheConfiguration;\n+import org.apache.ignite.configuration.IgniteConfiguration;\n+import org.apache.ignite.internal.IgniteEx;\n+import org.apache.ignite.internal.TestRecordingCommunicationSpi;\n+import org.apache.ignite.internal.managers.deployment.GridDeploymentRequest;\n+import org.apache.ignite.internal.managers.discovery.DiscoveryCustomMessage;\n+import org.apache.ignite.internal.processors.continuous.StopRoutineDiscoveryMessage;\n+import org.apache.ignite.internal.util.typedef.G;\n+import org.apache.ignite.internal.util.typedef.internal.U;\n+import org.apache.ignite.lang.IgniteFuture;\n+import org.apache.ignite.spi.discovery.DiscoverySpi;\n+import org.apache.ignite.spi.discovery.DiscoverySpiCustomMessage;\n+import org.apache.ignite.spi.discovery.DiscoverySpiListener;\n+import org.apache.ignite.spi.discovery.tcp.TcpDiscoverySpi;\n+import org.apache.ignite.spi.systemview.view.ContinuousQueryView;\n+import org.apache.ignite.spi.systemview.view.SystemView;\n+import org.apache.ignite.testframework.GridTestUtils;\n+import org.apache.ignite.testframework.junits.common.GridCommonAbstractTest;\n+import org.jetbrains.annotations.Nullable;\n+import org.junit.Test;\n+\n+import static org.apache.ignite.cluster.ClusterState.ACTIVE;\n+import static org.apache.ignite.internal.TestRecordingCommunicationSpi.spi;\n+import static org.apache.ignite.internal.processors.continuous.GridContinuousProcessor.CQ_SYS_VIEW;\n+import static org.apache.ignite.testframework.GridTestUtils.assertThrowsAnyCause;\n+\n+/**\n+ * Tests the behavior of continuous query registration in case the remote node failed to obtain the filter deployment.\n+ */\n+public class CacheContinuousQueryFilterDeploymentFailedTest extends GridCommonAbstractTest {\n+    /** The name of the CQ filter factory class. Its obtaining on a non-local node requires P2P class loading. */\n+    private static final String EXT_FILTER_FACTORY_CLS =\n+        \"org.apache.ignite.tests.p2p.CacheDeploymentEntryEventFilterFactory\";\n+\n+    /** Counter of nodes that finished processing of {@link StopRoutineDiscoveryMessage}. */\n+    private final AtomicInteger stopRoutineMsgCntr = new AtomicInteger();\n+\n+    /** {@inheritDoc} */\n+    @Override protected IgniteConfiguration getConfiguration(String igniteInstanceName) throws Exception {\n+        IgniteConfiguration cfg = super.getConfiguration(igniteInstanceName);\n+\n+        DiscoverySpi spi = new TcpDiscoverySpi() {\n+            @Override public void setListener(@Nullable DiscoverySpiListener lsnr) {\n+                super.setListener(lsnr == null ? null : new TestDiscoverySpiListener(lsnr, stopRoutineMsgCntr));\n+            }\n+        };\n+\n+        cfg.setCommunicationSpi(new TestRecordingCommunicationSpi());\n+        cfg.setNetworkTimeout(1000);\n+        cfg.setDiscoverySpi(spi);\n+\n+        return cfg;\n+    }\n+\n+    /**\n+     * Tests continuous query behavior in case of filter deployment obtaining failure.\n+     *\n+     * @throws Exception If failed.\n+     */\n+    @Test\n+    @SuppressWarnings({\"ThrowableNotThrown\"})\n+    public void testContinuousQueryFilterDeploymentFailed() throws Exception {\n+        IgniteEx ignite = startGrids(2);\n+\n+        IgniteEx client = startClientGrid(2);\n+\n+        ignite.cluster().state(ACTIVE);\n+\n+        ignite.createCache(new CacheConfiguration<>(DEFAULT_CACHE_NAME));\n+\n+        ContinuousQuery<Integer, Integer> qry = new ContinuousQuery<>();\n+\n+        Class<Factory<CacheEntryEventFilter<Integer, Integer>>> rmtFilterFactoryCls =\n+            (Class<Factory<CacheEntryEventFilter<Integer, Integer>>>)getExternalClassLoader()\n+                .loadClass(EXT_FILTER_FACTORY_CLS);\n+\n+        Factory<CacheEntryEventFilter<Integer, Integer>> rmtFilterFactory = rmtFilterFactoryCls.newInstance();\n+\n+        qry.setRemoteFilterFactory(rmtFilterFactory);\n+\n+        spi(grid(1)).blockMessages((node, msg) -> msg instanceof GridDeploymentRequest);\n+\n+        assertThrowsAnyCause(\n+            log,\n+            () -> client.cache(DEFAULT_CACHE_NAME).query(qry),\n+            CacheException.class,\n+            \"Failed to start continuous query.\"\n+        );\n+\n+        checkContinuousQueryAborted();\n+    }\n+\n+    /**\n+     * Awaits handling of stop routine message on all cluster nodes and checks that CQ registraition was fully aborted.\n+     */\n+    private void checkContinuousQueryAborted() throws Exception {\n+        List<Ignite> grids = G.allGrids();\n+\n+        GridTestUtils.waitForCondition(() -> stopRoutineMsgCntr.get() == grids.size(), getTestTimeout());\n+\n+        assertTrue(grids.stream().allMatch(ignite -> {\n+            SystemView<ContinuousQueryView> locQrys = ((IgniteEx)ignite).context().systemView().view(CQ_SYS_VIEW);\n+\n+            return locQrys.size() == 0;\n+        }));\n+", "originalCommit": "e6861d6fd81da408083fbfc3f527f180dd37fed7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQxNjI1NQ==", "url": "https://github.com/apache/ignite/pull/7620#discussion_r405416255", "bodyText": "Thanks. Done.", "author": "ololo3000", "createdAt": "2020-04-08T10:17:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQwMTY5OQ=="}], "type": "inlineReview"}, {"oid": "425d90094206932d8ed2055ea39446c671ca9e07", "url": "https://github.com/apache/ignite/commit/425d90094206932d8ed2055ea39446c671ca9e07", "message": "IGNITE-12828 Fixes minor issues.", "committedDate": "2020-04-08T10:16:31Z", "type": "commit"}, {"oid": "3775e63a5d1b77026d35f0230575f4670e4c93c9", "url": "https://github.com/apache/ignite/commit/3775e63a5d1b77026d35f0230575f4670e4c93c9", "message": "IGNITE-12828 Refactors test configuration.", "committedDate": "2020-04-08T11:47:14Z", "type": "commit"}, {"oid": "3775e63a5d1b77026d35f0230575f4670e4c93c9", "url": "https://github.com/apache/ignite/commit/3775e63a5d1b77026d35f0230575f4670e4c93c9", "message": "IGNITE-12828 Refactors test configuration.", "committedDate": "2020-04-08T11:47:14Z", "type": "forcePushed"}, {"oid": "4b8a260d33e7125ec2156c103c50035273152057", "url": "https://github.com/apache/ignite/commit/4b8a260d33e7125ec2156c103c50035273152057", "message": "IGNITE-12828 Fixes minor issues.", "committedDate": "2020-04-08T12:07:47Z", "type": "commit"}, {"oid": "4b8a260d33e7125ec2156c103c50035273152057", "url": "https://github.com/apache/ignite/commit/4b8a260d33e7125ec2156c103c50035273152057", "message": "IGNITE-12828 Fixes minor issues.", "committedDate": "2020-04-08T12:07:47Z", "type": "forcePushed"}, {"oid": "46f37544fd34abb4585ad924b1d7dde9b20b5cad", "url": "https://github.com/apache/ignite/commit/46f37544fd34abb4585ad924b1d7dde9b20b5cad", "message": "IGNITE-12828 Fixes minor issues.", "committedDate": "2020-04-08T12:18:15Z", "type": "commit"}, {"oid": "fdc7f66c9ab351a73ad8ac91461bcb479a905ff3", "url": "https://github.com/apache/ignite/commit/fdc7f66c9ab351a73ad8ac91461bcb479a905ff3", "message": "IGNITE-12828 Changes DiscoveryHook method naming.", "committedDate": "2020-04-08T13:15:16Z", "type": "commit"}, {"oid": "fdc7f66c9ab351a73ad8ac91461bcb479a905ff3", "url": "https://github.com/apache/ignite/commit/fdc7f66c9ab351a73ad8ac91461bcb479a905ff3", "message": "IGNITE-12828 Changes DiscoveryHook method naming.", "committedDate": "2020-04-08T13:15:16Z", "type": "forcePushed"}, {"oid": "6199bc1a086f905628bfcf07cba9d98ed835943b", "url": "https://github.com/apache/ignite/commit/6199bc1a086f905628bfcf07cba9d98ed835943b", "message": "IGNITE-12828 Fixes minor issues.", "committedDate": "2020-04-08T13:21:39Z", "type": "commit"}, {"oid": "52d722829e4d0cbfb6f1ac3f5de952afe5e4660d", "url": "https://github.com/apache/ignite/commit/52d722829e4d0cbfb6f1ac3f5de952afe5e4660d", "message": "IGNITE-12828 Fixes minor issues.", "committedDate": "2020-04-08T13:38:36Z", "type": "commit"}, {"oid": "f4dfaf78720783a347c68e2db08f468c005c6d88", "url": "https://github.com/apache/ignite/commit/f4dfaf78720783a347c68e2db08f468c005c6d88", "message": "IGNITE-12828 Fixes minor issues.", "committedDate": "2020-04-08T14:31:41Z", "type": "commit"}, {"oid": "c7e018be0d6d716dda4607c7e91c234ed1b5288c", "url": "https://github.com/apache/ignite/commit/c7e018be0d6d716dda4607c7e91c234ed1b5288c", "message": "IGNITE-12828 Fixes minor issues.", "committedDate": "2020-04-08T14:39:32Z", "type": "commit"}, {"oid": "2072c28b8eb6b4bab6ee558b5599f0b695678380", "url": "https://github.com/apache/ignite/commit/2072c28b8eb6b4bab6ee558b5599f0b695678380", "message": "IGNITE-12828 Fixes minor issues.", "committedDate": "2020-04-08T14:42:02Z", "type": "commit"}, {"oid": "bccff946cac7eb4a8e63ea2931367e31166ab50a", "url": "https://github.com/apache/ignite/commit/bccff946cac7eb4a8e63ea2931367e31166ab50a", "message": "IGNITE-12828 Fixes minor issues.", "committedDate": "2020-04-08T14:52:59Z", "type": "commit"}, {"oid": "bccff946cac7eb4a8e63ea2931367e31166ab50a", "url": "https://github.com/apache/ignite/commit/bccff946cac7eb4a8e63ea2931367e31166ab50a", "message": "IGNITE-12828 Fixes minor issues.", "committedDate": "2020-04-08T14:52:59Z", "type": "forcePushed"}, {"oid": "3893c3329424df59f61b66f2d3990125aeeb9ac6", "url": "https://github.com/apache/ignite/commit/3893c3329424df59f61b66f2d3990125aeeb9ac6", "message": "IGNITE-12828 Fixes minor issues.", "committedDate": "2020-04-08T15:07:08Z", "type": "commit"}, {"oid": "ff646a98a1efeaaa213fe96de9352ca14f0beb3c", "url": "https://github.com/apache/ignite/commit/ff646a98a1efeaaa213fe96de9352ca14f0beb3c", "message": "IGNITE-12828 Fixes minor issues.", "committedDate": "2020-04-08T15:13:06Z", "type": "commit"}]}