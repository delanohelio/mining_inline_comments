{"pr_number": 7332, "pr_title": "IGNITE-12598: Cache metrics configuration should be removed only on cache destroy", "pr_createdAt": "2020-01-29T14:48:22Z", "pr_url": "https://github.com/apache/ignite/pull/7332", "timeline": [{"oid": "8fe1235d01e0b5a8df629aa7bc03afaebaa43e51", "url": "https://github.com/apache/ignite/commit/8fe1235d01e0b5a8df629aa7bc03afaebaa43e51", "message": "IGNITE-12598: Cache metrics configuration should be removed only on cache destroy.", "committedDate": "2020-01-29T14:47:23Z", "type": "commit"}, {"oid": "a4d6007818dde7f0341d81ca01bfade2025965b3", "url": "https://github.com/apache/ignite/commit/a4d6007818dde7f0341d81ca01bfade2025965b3", "message": "IGNITE-12598: Cache metrics configuration should be removed only on cache destroy.", "committedDate": "2020-01-29T15:07:22Z", "type": "commit"}, {"oid": "81482a3d2c19842469ca72f67871522ee2c48063", "url": "https://github.com/apache/ignite/commit/81482a3d2c19842469ca72f67871522ee2c48063", "message": "IGNITE-12598: Cache metrics configuration should be removed only on cache destroy.", "committedDate": "2020-01-29T18:10:38Z", "type": "commit"}, {"oid": "c4fe93f66da283e8c8ae2d1925af3f13aa7d92fa", "url": "https://github.com/apache/ignite/commit/c4fe93f66da283e8c8ae2d1925af3f13aa7d92fa", "message": "Merge branch 'master' into IGNITE-12598", "committedDate": "2020-02-03T17:00:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgxOTg3MQ==", "url": "https://github.com/apache/ignite/pull/7332#discussion_r374819871", "bodyText": "Here clearDbObjects is incorrect because destroy == false. IMHO valid value for flag is false.", "author": "agura", "createdAt": "2020-02-04T17:38:34Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheProcessor.java", "diffHunk": "@@ -2060,7 +2063,7 @@ private void stopCacheSafely(GridCacheContext<?, ?> cctx, boolean clearDbObjects\n             prepareCacheStop(cctx.name(), false, clearDbObjects);\n \n             if (!cctx.group().hasCaches())\n-                stopCacheGroup(cctx.group().groupId());\n+                stopCacheGroup(cctx.group().groupId(), clearDbObjects);", "originalCommit": "c4fe93f66da283e8c8ae2d1925af3f13aa7d92fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI1NTQ3OA==", "url": "https://github.com/apache/ignite/pull/7332#discussion_r375255478", "bodyText": "Fixed.", "author": "nizhikov", "createdAt": "2020-02-05T13:32:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgxOTg3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgyMTE5NA==", "url": "https://github.com/apache/ignite/pull/7332#discussion_r374821194", "bodyText": "It seems this place (and below at line 1041) are only places where we should remove metric configuration. IF this code will be invoked from this place then we don't need any additional flags for GridCacheAdapter.stop() method.", "author": "agura", "createdAt": "2020-02-04T17:41:19Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheProcessor.java", "diffHunk": "@@ -1021,7 +1024,7 @@ private void stopCache(GridCacheAdapter<?, ?> cache, boolean cancel, boolean des\n \n             sharedCtx.removeCacheContext(ctx);\n \n-            cache.stop();\n+            cache.stop(destroy);", "originalCommit": "c4fe93f66da283e8c8ae2d1925af3f13aa7d92fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI1MzQyOQ==", "url": "https://github.com/apache/ignite/pull/7332#discussion_r375253429", "bodyText": "Fixed.", "author": "nizhikov", "createdAt": "2020-02-05T13:28:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgyMTE5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgyMjQyNA==", "url": "https://github.com/apache/ignite/pull/7332#discussion_r374822424", "bodyText": "We can avoid this change. See my comment to GridCacheProcessor.stopCache() method.", "author": "agura", "createdAt": "2020-02-04T17:43:49Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheAdapter.java", "diffHunk": "@@ -659,13 +659,15 @@ protected final String startInfo() {\n     /**\n      * Stops this cache. Child classes should override this method\n      * to provide custom stop behavior.\n+     *\n+     * @param destroy Destroy data flag. Setting to <code>true</code> will remove all cache data.\n      */\n-    public void stop() {\n+    public void stop(boolean destroy) {", "originalCommit": "c4fe93f66da283e8c8ae2d1925af3f13aa7d92fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgyMjgxMw==", "url": "https://github.com/apache/ignite/pull/7332#discussion_r374822813", "bodyText": "Could be just removed (condition and statement under it). See my comment to GridCacheProcessor.stopCache() method.", "author": "agura", "createdAt": "2020-02-04T17:44:41Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheAdapter.java", "diffHunk": "@@ -659,13 +659,15 @@ protected final String startInfo() {\n     /**\n      * Stops this cache. Child classes should override this method\n      * to provide custom stop behavior.\n+     *\n+     * @param destroy Destroy data flag. Setting to <code>true</code> will remove all cache data.\n      */\n-    public void stop() {\n+    public void stop(boolean destroy) {\n         // Nulling thread local reference to ensure values will be eventually GCed\n         // no matter what references these futures are holding.\n         lastFut = null;\n \n-        if (!ctx.kernalContext().isStopping())\n+        if (!ctx.kernalContext().isStopping() && destroy)", "originalCommit": "c4fe93f66da283e8c8ae2d1925af3f13aa7d92fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgyMzE4Mg==", "url": "https://github.com/apache/ignite/pull/7332#discussion_r374823182", "bodyText": "See comment above (line 1027).", "author": "agura", "createdAt": "2020-02-04T17:45:28Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/GridCacheProcessor.java", "diffHunk": "@@ -1035,7 +1038,7 @@ private void stopCache(GridCacheAdapter<?, ?> cache, boolean cancel, boolean des\n \n                 // Check whether dht cache has been started.\n                 if (dht != null) {\n-                    dht.stop();\n+                    dht.stop(destroy);", "originalCommit": "c4fe93f66da283e8c8ae2d1925af3f13aa7d92fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI1MzUxOQ==", "url": "https://github.com/apache/ignite/pull/7332#discussion_r375253519", "bodyText": "Fixed.", "author": "nizhikov", "createdAt": "2020-02-05T13:28:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgyMzE4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgyMzk3Ng==", "url": "https://github.com/apache/ignite/pull/7332#discussion_r374823976", "bodyText": "After cache destroying should be asserted that metric configuration is removed.", "author": "agura", "createdAt": "2020-02-04T17:47:04Z", "path": "modules/core/src/test/java/org/apache/ignite/internal/metric/CacheMetricsAddRemoveTest.java", "diffHunk": "@@ -82,17 +98,58 @@ public void testCacheMetricsAddRemove() throws Exception {\n         checkMetricsEmpty(cachePrefix);\n     }\n \n+    /** */\n+    @Test\n+    public void testCacheMetricsNotRemovedOnStop() throws Exception {\n+        String cachePrefix = cacheMetricsRegistryName(\"other-cache\", false);\n+\n+        checkMetricsEmpty(cachePrefix);\n+\n+        createCache(\"persisted\", \"other-cache\");\n+\n+        grid(\"client\").cache(\"other-cache\").put(1L, 1L);\n+\n+        checkMetricsNotEmpty(cachePrefix);\n+\n+        //Cache will be stopped during deactivation.\n+        grid(\"client\").cluster().state(ClusterState.INACTIVE);\n+\n+        checkMetricsNotEmpty(cachePrefix);\n+\n+        grid(\"client\").cluster().state(ClusterState.ACTIVE);\n+\n+        assertEquals(1L, grid(\"client\").cache(\"other-cache\").get(1L));\n+\n+        checkMetricsNotEmpty(cachePrefix);\n+\n+        destroyCache();", "originalCommit": "c4fe93f66da283e8c8ae2d1925af3f13aa7d92fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI1NTkzOQ==", "url": "https://github.com/apache/ignite/pull/7332#discussion_r375255939", "bodyText": "Fixed.", "author": "nizhikov", "createdAt": "2020-02-05T13:33:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgyMzk3Ng=="}], "type": "inlineReview"}, {"oid": "e7a11be341207c69ed7f5b88a4f465b3e6dd3501", "url": "https://github.com/apache/ignite/commit/e7a11be341207c69ed7f5b88a4f465b3e6dd3501", "message": "Merge branch 'master' into IGNITE-12598", "committedDate": "2020-02-05T12:55:56Z", "type": "commit"}, {"oid": "39942715ee5be724590a7396ed39d7fbfa9cb16b", "url": "https://github.com/apache/ignite/commit/39942715ee5be724590a7396ed39d7fbfa9cb16b", "message": "IGNITE-12598: Code review fixes.", "committedDate": "2020-02-05T13:34:35Z", "type": "commit"}]}