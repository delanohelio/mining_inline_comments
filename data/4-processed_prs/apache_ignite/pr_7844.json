{"pr_number": 7844, "pr_title": "IGNITE-12823 .NET: Fix service method calls with typed array args", "pr_createdAt": "2020-05-25T15:03:25Z", "pr_url": "https://github.com/apache/ignite/pull/7844", "timeline": [{"oid": "9065533e27b9f9744fad88ca9124f75616eda9fa", "url": "https://github.com/apache/ignite/commit/9065533e27b9f9744fad88ca9124f75616eda9fa", "message": "Add tests and PoC", "committedDate": "2020-05-25T14:46:42Z", "type": "commit"}, {"oid": "adb70d51a822b92fd7dac999f592d927813830d3", "url": "https://github.com/apache/ignite/commit/adb70d51a822b92fd7dac999f592d927813830d3", "message": "Both tests work", "committedDate": "2020-05-25T14:56:16Z", "type": "commit"}, {"oid": "bc8f02d55639a2177501f9b7340e2124052f09ec", "url": "https://github.com/apache/ignite/commit/bc8f02d55639a2177501f9b7340e2124052f09ec", "message": "Cleanup", "committedDate": "2020-05-25T15:02:19Z", "type": "commit"}, {"oid": "76a70e50656f878c30fb2a5e520d46d44d7fb1fa", "url": "https://github.com/apache/ignite/commit/76a70e50656f878c30fb2a5e520d46d44d7fb1fa", "message": "cleanup", "committedDate": "2020-05-25T20:42:14Z", "type": "commit"}, {"oid": "bafd58591d9492f10e0dfff547f499df12cbcab0", "url": "https://github.com/apache/ignite/commit/bafd58591d9492f10e0dfff547f499df12cbcab0", "message": "cleanup", "committedDate": "2020-05-25T20:46:39Z", "type": "commit"}, {"oid": "334e66ba7ab7789831cd897a96ac5daa58337b62", "url": "https://github.com/apache/ignite/commit/334e66ba7ab7789831cd897a96ac5daa58337b62", "message": "cleanup", "committedDate": "2020-05-25T20:49:41Z", "type": "commit"}, {"oid": "94de5cab36c21d5e37dfc4348f1782b39d8d6034", "url": "https://github.com/apache/ignite/commit/94de5cab36c21d5e37dfc4348f1782b39d8d6034", "message": "cleanup", "committedDate": "2020-05-25T20:57:39Z", "type": "commit"}, {"oid": "549b25f00b8a9dde834886cfc157e713dc3c4e80", "url": "https://github.com/apache/ignite/commit/549b25f00b8a9dde834886cfc157e713dc3c4e80", "message": "cleanup", "committedDate": "2020-05-25T20:59:50Z", "type": "commit"}, {"oid": "dba267a2c605acb7db20f718b57a9f2f1961c9e6", "url": "https://github.com/apache/ignite/commit/dba267a2c605acb7db20f718b57a9f2f1961c9e6", "message": "Merge remote-tracking branch 'origin/master' into ignite-12823", "committedDate": "2020-05-26T18:19:18Z", "type": "commit"}, {"oid": "01e97fc7183b591e8d926872728554349d3f2508", "url": "https://github.com/apache/ignite/commit/01e97fc7183b591e8d926872728554349d3f2508", "message": "Adding tests", "committedDate": "2020-05-26T18:34:58Z", "type": "commit"}, {"oid": "38f79f3efc8de1de6aa19cb1ef38c01c34d9923f", "url": "https://github.com/apache/ignite/commit/38f79f3efc8de1de6aa19cb1ef38c01c34d9923f", "message": "Fix NullRef", "committedDate": "2020-05-26T18:37:09Z", "type": "commit"}, {"oid": "81b729d29060c7476ae8d354f61b2b26027cb6cf", "url": "https://github.com/apache/ignite/commit/81b729d29060c7476ae8d354f61b2b26027cb6cf", "message": "Add tests", "committedDate": "2020-05-26T18:38:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA2NDMxNQ==", "url": "https://github.com/apache/ignite/pull/7844#discussion_r431064315", "bodyText": "IgniteServices has a \"keep binary\" flag that makes the server side NOT to deserialize parameters, thus, allowing NOT having Java classes on the server. You need to do this block only if the \"keep binary\" flag is not set. Otherwise it will do that Array.newInstance thing even when \"keep binary = true\".", "author": "kukushal", "createdAt": "2020-05-27T12:03:23Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/platform/services/PlatformServices.java", "diffHunk": "@@ -581,6 +582,26 @@ public Object invoke(String mthdName, boolean srvKeepBinary, Object[] args)\n \n                 Method mtd = getMethod(serviceClass, mthdName, args);\n \n+                // Convert Object[] to T[] when required:\n+                // Ignite loses array item types when passing arguments through GridServiceProxy.\n+                for (int i = 0; i < args.length; i++) {", "originalCommit": "81b729d29060c7476ae8d354f61b2b26027cb6cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjExNTQyOQ==", "url": "https://github.com/apache/ignite/pull/7844#discussion_r432115429", "bodyText": "Array.newInstance is called only when array type does not match. keepBinary mode requires the same treatment as normal mode - service may take BinaryObject[], so array conversion is necessary. I've added tests for both .NET->.NET and .NET->Java calls to demonstrate this.", "author": "ptupitsyn", "createdAt": "2020-05-28T20:50:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA2NDMxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA2NDg2Nw==", "url": "https://github.com/apache/ignite/pull/7844#discussion_r431064867", "bodyText": "Please do the same in \"keep binary\" mode.", "author": "kukushal", "createdAt": "2020-05-27T12:04:28Z", "path": "modules/platforms/dotnet/Apache.Ignite.Core.Tests/Services/ServicesTest.cs", "diffHunk": "@@ -859,18 +903,28 @@ public void TestCallJavaService()\n             Assert.AreEqual(7, svc.testBinarizable(new PlatformComputeBinarizable {Field = 6}).Field);\n \n             // Binary collections\n-            var arr = new [] {10, 11, 12}.Select(x => new PlatformComputeBinarizable {Field = x}).ToArray<object>();\n+            var arr  = new[] {10, 11, 12}.Select(x => new PlatformComputeBinarizable {Field = x}).ToArray();\n+            var arrOfObj = arr.ToArray<object>();\n+\n             Assert.AreEqual(new[] {11, 12, 13}, svc.testBinarizableCollection(arr)\n                 .OfType<PlatformComputeBinarizable>().Select(x => x.Field).ToArray());\n-            Assert.AreEqual(new[] {11, 12, 13},\n-                svc.testBinarizableArray(arr).OfType<PlatformComputeBinarizable>().Select(x => x.Field).ToArray());\n+\n+            Assert.AreEqual(new[] {11, 12, 13}, svc.testBinarizableArrayOfObjects(arrOfObj)\n+                .OfType<PlatformComputeBinarizable>().Select(x => x.Field).ToArray());\n+\n+            Assert.IsNull(svc.testBinarizableArrayOfObjects(null));\n+\n+            Assert.AreEqual(new[] {11, 12, 13}, svc.testBinarizableArray(arr)", "originalCommit": "81b729d29060c7476ae8d354f61b2b26027cb6cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjExNDczNg==", "url": "https://github.com/apache/ignite/pull/7844#discussion_r432114736", "bodyText": "Good point, done", "author": "ptupitsyn", "createdAt": "2020-05-28T20:49:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA2NDg2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA2ODMxOA==", "url": "https://github.com/apache/ignite/pull/7844#discussion_r431068318", "bodyText": "Can we repeat these checks in \"keep binary\" mode as well? (with\nvar binPrx = Services.WithKeepBinary().GetServiceProxy(SvcName);", "author": "kukushal", "createdAt": "2020-05-27T12:11:04Z", "path": "modules/platforms/dotnet/Apache.Ignite.Core.Tests/Services/ServicesTest.cs", "diffHunk": "@@ -413,6 +413,50 @@ public void TestDuckTyping([Values(true, false)] bool local)\n             Assert.IsInstanceOf<InvalidCastException>(ex.InnerException);\n         }\n \n+        /// <summary>\n+        /// Test call service proxy from remote node with a methods having an array of user types and objects.\n+        /// </summary>\n+        [Test]\n+        public void TestCallServiceProxyWithMethodsHavingArrays()\n+        {\n+            // Deploy to the remote node.\n+            var nodeId = Grid2.GetCluster().GetLocalNode().Id;\n+\n+            var cluster = Grid1.GetCluster().ForNodeIds(nodeId);\n+\n+            cluster.GetServices().DeployNodeSingleton(SvcName, new TestIgniteServiceArraySerializable());\n+\n+            var typedArray = new[] {10, 11, 12}\n+                .Select(x => new PlatformComputeBinarizable {Field = x}).ToArray();\n+\n+            var objArray = typedArray.ToArray<object>();\n+\n+            var prx = Services.GetServiceProxy<ITestIgniteServiceArray>(SvcName);", "originalCommit": "81b729d29060c7476ae8d354f61b2b26027cb6cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjExNDgwNA==", "url": "https://github.com/apache/ignite/pull/7844#discussion_r432114804", "bodyText": "Done", "author": "ptupitsyn", "createdAt": "2020-05-28T20:49:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA2ODMxOA=="}], "type": "inlineReview"}, {"oid": "e27dd25bc8553a24fe6381ca9cf7c5038cb14fc6", "url": "https://github.com/apache/ignite/commit/e27dd25bc8553a24fe6381ca9cf7c5038cb14fc6", "message": "Adding tests with binary objects", "committedDate": "2020-05-28T20:10:31Z", "type": "commit"}, {"oid": "07868674eca40431ebebf3a13885cac74a4193c2", "url": "https://github.com/apache/ignite/commit/07868674eca40431ebebf3a13885cac74a4193c2", "message": "Adding tests with binary objects", "committedDate": "2020-05-28T20:22:43Z", "type": "commit"}, {"oid": "da7cd9efdfb25aa09efe0d41aa6b09fc22f762ed", "url": "https://github.com/apache/ignite/commit/da7cd9efdfb25aa09efe0d41aa6b09fc22f762ed", "message": "Adding tests", "committedDate": "2020-05-28T20:26:12Z", "type": "commit"}, {"oid": "06a59a85c0619be6104e93188e77b8b7c6fdb498", "url": "https://github.com/apache/ignite/commit/06a59a85c0619be6104e93188e77b8b7c6fdb498", "message": "Merge remote-tracking branch 'origin/master' into ignite-12823", "committedDate": "2020-05-28T20:27:20Z", "type": "commit"}, {"oid": "30bfd2d54906819dd6ff996d263f5aa78ef5e0ab", "url": "https://github.com/apache/ignite/commit/30bfd2d54906819dd6ff996d263f5aa78ef5e0ab", "message": "Adding tests with binary objects", "committedDate": "2020-05-28T20:42:17Z", "type": "commit"}, {"oid": "39a1070e33ec40fedfb584b55fe267938ace9634", "url": "https://github.com/apache/ignite/commit/39a1070e33ec40fedfb584b55fe267938ace9634", "message": "fix style", "committedDate": "2020-05-28T20:48:37Z", "type": "commit"}]}