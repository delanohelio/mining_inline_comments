{"pr_number": 7310, "pr_title": "IGNITE-12576 nodeId replaced with consistentId in TcpCommunicationSpi for usability purposes.", "pr_createdAt": "2020-01-24T15:00:16Z", "pr_url": "https://github.com/apache/ignite/pull/7310", "timeline": [{"oid": "6e24abae47b943e1bd2f8e276e9683f1df7b0ac2", "url": "https://github.com/apache/ignite/commit/6e24abae47b943e1bd2f8e276e9683f1df7b0ac2", "message": "IGNITE-12576 nodeId replaced with consistentId in TcpCommunicationSpi for usability purposes.", "committedDate": "2020-01-24T14:58:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTMyMDM0Nw==", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371320347", "bodyText": "Metric named ConsistentIdMetric but the constant for looking up named as by nodeId SENT_MESSAGES_BY_NODE_ID_METRIC_NAME why?", "author": "Mmuzaf", "createdAt": "2020-01-27T15:49:57Z", "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "diffHunk": "@@ -121,11 +134,17 @@ public TcpCommunicationMetricsListener(GridMetricManager mmgr) {\n         );\n \n         sentMsgsCntByNodeIdMetricFactory = nodeId ->\n-            mmgr.registry(metricName(COMMUNICATION_METRICS_GROUP_NAME, nodeId.toString()))\n-                .findMetric(SENT_MESSAGES_BY_NODE_ID_METRIC_NAME);\n+            allSentMsgsMetricsByNodeId.computeIfAbsent(nodeId, k -> new AtomicLong());\n \n         rcvdMsgsCntByNodeIdMetricFactory = nodeId ->\n-            mmgr.registry(metricName(COMMUNICATION_METRICS_GROUP_NAME, nodeId.toString()))\n+            allRcvdMsgsMetricsByNodeId.computeIfAbsent(nodeId, k -> new AtomicLong());\n+\n+        sentMsgsCntByConsistentIdMetricFactory = consistentId ->", "originalCommit": "6e24abae47b943e1bd2f8e276e9683f1df7b0ac2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0ODE4OA==", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371648188", "bodyText": "I'll rename it.", "author": "ibessonov", "createdAt": "2020-01-28T07:49:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTMyMDM0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTMzOTk5Mw==", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371339993", "bodyText": "Why we should keep this metric if it totally replaced with the new one?", "author": "Mmuzaf", "createdAt": "2020-01-27T16:21:34Z", "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "diffHunk": "@@ -121,11 +134,17 @@ public TcpCommunicationMetricsListener(GridMetricManager mmgr) {\n         );\n \n         sentMsgsCntByNodeIdMetricFactory = nodeId ->", "originalCommit": "6e24abae47b943e1bd2f8e276e9683f1df7b0ac2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0Nzg1Mw==", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371647853", "bodyText": "old JMX API", "author": "ibessonov", "createdAt": "2020-01-28T07:48:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTMzOTk5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk3OTcwNA==", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371979704", "bodyText": "@ibessonov It seems there are no release with metrics by node. Old metric shows total sent/received message count.", "author": "agura", "createdAt": "2020-01-28T18:29:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTMzOTk5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NDc1NA==", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371644754", "bodyText": "Why this change?", "author": "nizhikov", "createdAt": "2020-01-28T07:38:35Z", "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "diffHunk": "@@ -82,10 +83,22 @@\n     private final Function<Short, LongAdderMetric> rcvdMsgsCntByTypeMetricFactory;\n \n     /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code sentMsgsMetricsByNodeId}. */\n-    private final Function<UUID, LongAdderMetric> sentMsgsCntByNodeIdMetricFactory;\n+    private final Function<UUID, AtomicLong> sentMsgsCntByNodeIdMetricFactory;", "originalCommit": "6e24abae47b943e1bd2f8e276e9683f1df7b0ac2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NTcyMQ==", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371645721", "bodyText": "Are we still need this factory?", "author": "nizhikov", "createdAt": "2020-01-28T07:42:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NDc1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NjkyMw==", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371646923", "bodyText": "These things won't be exported as metrics. We have them for JMX support only.", "author": "ibessonov", "createdAt": "2020-01-28T07:45:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NDc1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NzE3OA==", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371647178", "bodyText": "And yes, factory saves us from extra allocations, we discussed this privately.", "author": "ibessonov", "createdAt": "2020-01-28T07:46:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NDc1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0ODU1MQ==", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371648551", "bodyText": "Can we map consistentId -> nodeId when the user requests data to reduce the amount of metrics we store internally?", "author": "nizhikov", "createdAt": "2020-01-28T07:50:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NDc1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NTM3Mw==", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371645373", "bodyText": "nodeId should be removed as it not used.", "author": "nizhikov", "createdAt": "2020-01-28T07:40:48Z", "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "diffHunk": "@@ -404,36 +423,50 @@ public static String receivedMessagesByTypeMetricName(Short directType) {\n         /**\n          * Sent messages count metrics grouped by message node id.\n          */\n-        public volatile Map<UUID, LongAdderMetric> sentMsgsMetricsByNodeId = new HashMap<>();\n+        public volatile Map<UUID, AtomicLong> sentMsgsMetricsByNodeId = new HashMap<>();\n \n         /**\n          * Received messages metrics count grouped by message node id.\n          */\n-        public volatile Map<UUID, LongAdderMetric> rcvdMsgsMetricsByNodeId = new HashMap<>();\n+        public volatile Map<UUID, AtomicLong> rcvdMsgsMetricsByNodeId = new HashMap<>();\n+\n+        /**\n+         * Sent messages count metrics grouped by message node consistent id.\n+         */\n+        public volatile Map<Object, LongAdderMetric> sentMsgsMetricsByConsistentId = new HashMap<>();\n+\n+        /**\n+         * Received messages metrics count grouped by message node consistent id.\n+         */\n+        public volatile Map<Object, LongAdderMetric> rcvdMsgsMetricsByConsistentId = new HashMap<>();\n \n \n         /**\n          * Collects statistics for message sent by SPI.\n-         *\n-         * @param msg Sent message.\n+         *  @param msg Sent message.\n+         * @param consistentId Receiver node consistent id.\n          * @param nodeId Receiver node id.\n          */\n-        private void onMessageSent(Message msg, UUID nodeId) {\n+        private void onMessageSent(Message msg, Object consistentId, UUID nodeId) {", "originalCommit": "6e24abae47b943e1bd2f8e276e9683f1df7b0ac2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0ODM0MA==", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371648340", "bodyText": "It is used in last line of the method.", "author": "ibessonov", "createdAt": "2020-01-28T07:49:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NTM3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NTQzNQ==", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371645435", "bodyText": "nodeId should be removed as it not used.", "author": "nizhikov", "createdAt": "2020-01-28T07:41:02Z", "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "diffHunk": "@@ -404,36 +423,50 @@ public static String receivedMessagesByTypeMetricName(Short directType) {\n         /**\n          * Sent messages count metrics grouped by message node id.\n          */\n-        public volatile Map<UUID, LongAdderMetric> sentMsgsMetricsByNodeId = new HashMap<>();\n+        public volatile Map<UUID, AtomicLong> sentMsgsMetricsByNodeId = new HashMap<>();\n \n         /**\n          * Received messages metrics count grouped by message node id.\n          */\n-        public volatile Map<UUID, LongAdderMetric> rcvdMsgsMetricsByNodeId = new HashMap<>();\n+        public volatile Map<UUID, AtomicLong> rcvdMsgsMetricsByNodeId = new HashMap<>();\n+\n+        /**\n+         * Sent messages count metrics grouped by message node consistent id.\n+         */\n+        public volatile Map<Object, LongAdderMetric> sentMsgsMetricsByConsistentId = new HashMap<>();\n+\n+        /**\n+         * Received messages metrics count grouped by message node consistent id.\n+         */\n+        public volatile Map<Object, LongAdderMetric> rcvdMsgsMetricsByConsistentId = new HashMap<>();\n \n \n         /**\n          * Collects statistics for message sent by SPI.\n-         *\n-         * @param msg Sent message.\n+         *  @param msg Sent message.\n+         * @param consistentId Receiver node consistent id.\n          * @param nodeId Receiver node id.\n          */\n-        private void onMessageSent(Message msg, UUID nodeId) {\n+        private void onMessageSent(Message msg, Object consistentId, UUID nodeId) {\n             sentMsgsMetricsByType.computeIfAbsent(msg.directType(), sentMsgsCntByTypeMetricFactory).increment();\n \n-            sentMsgsMetricsByNodeId.computeIfAbsent(nodeId, sentMsgsCntByNodeIdMetricFactory).increment();\n+            sentMsgsMetricsByConsistentId.computeIfAbsent(consistentId, sentMsgsCntByConsistentIdMetricFactory).increment();\n+\n+            sentMsgsMetricsByNodeId.computeIfAbsent(nodeId, sentMsgsCntByNodeIdMetricFactory).incrementAndGet();\n         }\n \n         /**\n          * Collects statistics for message received by SPI.\n-         *\n-         * @param msg Received message.\n+         *  @param msg Received message.\n+         * @param consistentId Sender node consistent id.\n          * @param nodeId Sender node id.\n          */\n-        private void onMessageReceived(Message msg, UUID nodeId) {\n+        private void onMessageReceived(Message msg, Object consistentId, UUID nodeId) {", "originalCommit": "6e24abae47b943e1bd2f8e276e9683f1df7b0ac2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0ODM5NQ==", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371648395", "bodyText": "Same as above.", "author": "ibessonov", "createdAt": "2020-01-28T07:49:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NTQzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NTc4MQ==", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371645781", "bodyText": "Are we still need this factory?", "author": "nizhikov", "createdAt": "2020-01-28T07:42:14Z", "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "diffHunk": "@@ -82,10 +83,22 @@\n     private final Function<Short, LongAdderMetric> rcvdMsgsCntByTypeMetricFactory;\n \n     /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code sentMsgsMetricsByNodeId}. */\n-    private final Function<UUID, LongAdderMetric> sentMsgsCntByNodeIdMetricFactory;\n+    private final Function<UUID, AtomicLong> sentMsgsCntByNodeIdMetricFactory;\n \n     /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code rcvdMsgsMetricsByNodeId}. */\n-    private final Function<UUID, LongAdderMetric> rcvdMsgsCntByNodeIdMetricFactory;\n+    private final Function<UUID, AtomicLong> rcvdMsgsCntByNodeIdMetricFactory;", "originalCommit": "6e24abae47b943e1bd2f8e276e9683f1df7b0ac2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NzI1MA==", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371647250", "bodyText": "Yes", "author": "ibessonov", "createdAt": "2020-01-28T07:46:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NTc4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1MDk5NA==", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371650994", "bodyText": "As I see in ticket descriptions we replacing nodeId with the consistentId, but the changes just add another copy of the same numbers, not replacing.", "author": "nizhikov", "createdAt": "2020-01-28T07:57:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NTc4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NTgzOQ==", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371645839", "bodyText": "Are we still need this factory?", "author": "nizhikov", "createdAt": "2020-01-28T07:42:27Z", "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "diffHunk": "@@ -82,10 +83,22 @@\n     private final Function<Short, LongAdderMetric> rcvdMsgsCntByTypeMetricFactory;\n \n     /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code sentMsgsMetricsByNodeId}. */\n-    private final Function<UUID, LongAdderMetric> sentMsgsCntByNodeIdMetricFactory;\n+    private final Function<UUID, AtomicLong> sentMsgsCntByNodeIdMetricFactory;\n \n     /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code rcvdMsgsMetricsByNodeId}. */\n-    private final Function<UUID, LongAdderMetric> rcvdMsgsCntByNodeIdMetricFactory;\n+    private final Function<UUID, AtomicLong> rcvdMsgsCntByNodeIdMetricFactory;\n+\n+    /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code #sentMsgsMetricsByConsistentId}. */\n+    private final Function<Object, LongAdderMetric> sentMsgsCntByConsistentIdMetricFactory;\n+\n+    /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code #rcvdMsgsMetricsByConsistentId}. */\n+    private final Function<Object, LongAdderMetric> rcvdMsgsCntByConsistentIdMetricFactory;\n+\n+    /** All sent messages count metrics grouped by message node id. */\n+    public volatile Map<UUID, AtomicLong> allSentMsgsMetricsByNodeId = new ConcurrentHashMap<>();", "originalCommit": "6e24abae47b943e1bd2f8e276e9683f1df7b0ac2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NzcxMQ==", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371647711", "bodyText": "Yes, this collection allows us to use HashMap in ThreadLocal entities without worrying about concurrent access - that was the main optimization point.\nBasically I emulate MetricRegistry with this collection.", "author": "ibessonov", "createdAt": "2020-01-28T07:48:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NTgzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NTg3Nw==", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371645877", "bodyText": "Are we still need this factory?", "author": "nizhikov", "createdAt": "2020-01-28T07:42:37Z", "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationMetricsListener.java", "diffHunk": "@@ -82,10 +83,22 @@\n     private final Function<Short, LongAdderMetric> rcvdMsgsCntByTypeMetricFactory;\n \n     /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code sentMsgsMetricsByNodeId}. */\n-    private final Function<UUID, LongAdderMetric> sentMsgsCntByNodeIdMetricFactory;\n+    private final Function<UUID, AtomicLong> sentMsgsCntByNodeIdMetricFactory;\n \n     /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code rcvdMsgsMetricsByNodeId}. */\n-    private final Function<UUID, LongAdderMetric> rcvdMsgsCntByNodeIdMetricFactory;\n+    private final Function<UUID, AtomicLong> rcvdMsgsCntByNodeIdMetricFactory;\n+\n+    /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code #sentMsgsMetricsByConsistentId}. */\n+    private final Function<Object, LongAdderMetric> sentMsgsCntByConsistentIdMetricFactory;\n+\n+    /** Function to be used in {@link Map#computeIfAbsent(Object, Function)} of {@code #rcvdMsgsMetricsByConsistentId}. */\n+    private final Function<Object, LongAdderMetric> rcvdMsgsCntByConsistentIdMetricFactory;\n+\n+    /** All sent messages count metrics grouped by message node id. */\n+    public volatile Map<UUID, AtomicLong> allSentMsgsMetricsByNodeId = new ConcurrentHashMap<>();\n+\n+    /** Received messages metrics count grouped by message node id. */\n+    public volatile Map<UUID, AtomicLong> allRcvdMsgsMetricsByNodeId = new HashMap<>();", "originalCommit": "6e24abae47b943e1bd2f8e276e9683f1df7b0ac2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0Nzc4NA==", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371647784", "bodyText": "Yes, replied above.", "author": "ibessonov", "createdAt": "2020-01-28T07:48:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0NTg3Nw=="}], "type": "inlineReview"}, {"oid": "42bf05e56122fbe5c9a9868c20dcef228bd0a278", "url": "https://github.com/apache/ignite/commit/42bf05e56122fbe5c9a9868c20dcef228bd0a278", "message": "IGNITE-12576 Constants renamed.", "committedDate": "2020-01-28T07:54:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1MTQ5Ng==", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371651496", "bodyText": "consistentId should be a part of session meta (ses.meta(CONSISTENT_ID_META). It has no meaning for the connectionKey class. An thus it will require much less changes in this PR.", "author": "Mmuzaf", "createdAt": "2020-01-28T07:59:37Z", "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/internal/ConnectionKey.java", "diffHunk": "@@ -25,6 +25,9 @@\n  * Connection Key.\n  */\n public class ConnectionKey {\n+    /** */\n+    private final Object consistentId;", "originalCommit": "42bf05e56122fbe5c9a9868c20dcef228bd0a278", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY2MzA1Mg==", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371663052", "bodyText": "I don't think that this would require less changes, pretty much the same amount.\nI don't see any issues in storing consistentId near to nodeId, looks logical to me. Why do you think that it has no meaning?", "author": "ibessonov", "createdAt": "2020-01-28T08:32:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1MTQ5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY5MjUyMA==", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371692520", "bodyText": "I see the following major reasons:\n\nConnectionKey is a public class from public API. Do you think changing public API is a good idea for a minor bug?\nconsistentId doesn't participate in equals and hashCode methods. For the person, who will take a look at ConnectionKey class the first time this would look weird because consistentId is not the same as nodeId.\nThis field is used only for metrics and does not have any meaning for a session connection key itself.\nYou are passing consistentId key for each constructor rather obtaining it from session attributes directly, so you should change each constructor and this will lead to unnecessary changes.", "author": "Mmuzaf", "createdAt": "2020-01-28T09:35:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1MTQ5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTcwMDE5MA==", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371700190", "bodyText": "No, it's not: org.apache.ignite.spi.communication.tcp.internal.ConnectionKey\nIt's absolutely fine, other fields don't participate in equals and hashCode either.\n\nFine, I'll do it and we'll see if it got simpler. Maybe it is, I don't know for sure.", "author": "ibessonov", "createdAt": "2020-01-28T09:50:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1MTQ5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTcwMTQxMA==", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371701410", "bodyText": "just for the protocol - I disagree with this change)", "author": "ibessonov", "createdAt": "2020-01-28T09:52:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1MTQ5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTc1MjgzNg==", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371752836", "bodyText": "@ibessonov thank you, please, let me know when you'll be done with changes. I'll take a final look.", "author": "Mmuzaf", "createdAt": "2020-01-28T11:41:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1MTQ5Ng=="}], "type": "inlineReview"}, {"oid": "cb90b96202a8b0ea252ecea4962f5946591f9fe0", "url": "https://github.com/apache/ignite/commit/cb90b96202a8b0ea252ecea4962f5946591f9fe0", "message": "IGNITE-12576 nodeId JMX values calculation reworked.", "committedDate": "2020-01-28T08:35:03Z", "type": "commit"}, {"oid": "0fe8004112b943a88a14d79dc2c4e79442f5ee82", "url": "https://github.com/apache/ignite/commit/0fe8004112b943a88a14d79dc2c4e79442f5ee82", "message": "IGNITE-12576 cleanup", "committedDate": "2020-01-28T08:38:23Z", "type": "commit"}, {"oid": "76cbccfe4c1cddbb7a1efe01c029ada2f2c2ae40", "url": "https://github.com/apache/ignite/commit/76cbccfe4c1cddbb7a1efe01c029ada2f2c2ae40", "message": "IGNITE-12576 cleanup", "committedDate": "2020-01-28T08:44:35Z", "type": "commit"}, {"oid": "808f8be196f47f9701e2ea7c11d09f33fe04d57e", "url": "https://github.com/apache/ignite/commit/808f8be196f47f9701e2ea7c11d09f33fe04d57e", "message": "IGNITE-12576 latest review remarks.", "committedDate": "2020-01-28T09:29:04Z", "type": "commit"}, {"oid": "81041a60ec2cd9c020c1c94339b5f0c1c4974e81", "url": "https://github.com/apache/ignite/commit/81041a60ec2cd9c020c1c94339b5f0c1c4974e81", "message": "IGNITE-12576 cleanup", "committedDate": "2020-01-28T09:36:57Z", "type": "commit"}, {"oid": "90646d45b5be65f1ea1c30b535a2c58d8842be71", "url": "https://github.com/apache/ignite/commit/90646d45b5be65f1ea1c30b535a2c58d8842be71", "message": "IGNITE-12576 CONSISTENT_ID_META", "committedDate": "2020-01-28T10:01:40Z", "type": "commit"}, {"oid": "af3d3f1d4962f3e53500174d63258c336c516267", "url": "https://github.com/apache/ignite/commit/af3d3f1d4962f3e53500174d63258c336c516267", "message": "IGNITE-12576 comment added", "committedDate": "2020-01-28T10:04:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTcxMDIyNg==", "url": "https://github.com/apache/ignite/pull/7310#discussion_r371710226", "bodyText": "It seems these changes are not required.", "author": "nizhikov", "createdAt": "2020-01-28T10:09:13Z", "path": "modules/core/src/main/java/org/apache/ignite/spi/communication/tcp/TcpCommunicationSpi.java", "diffHunk": "@@ -562,20 +569,22 @@\n              */\n             private void onFirstMessage(final GridNioSession ses, Message msg) {\n                 UUID sndId;\n-\n-                ConnectionKey connKey;\n+                int connIdx;\n+                long connCnt;\n \n                 if (msg instanceof NodeIdMessage) {\n                     sndId = U.bytesToUuid(((NodeIdMessage)msg).nodeIdBytes(), 0);\n-                    connKey = new ConnectionKey(sndId, 0, -1);\n+                    connIdx = 0;", "originalCommit": "af3d3f1d4962f3e53500174d63258c336c516267", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3d608e5ae2c6853e41ef90e86832c2a1650697a4", "url": "https://github.com/apache/ignite/commit/3d608e5ae2c6853e41ef90e86832c2a1650697a4", "message": "IGNITE-12576 cleanup.", "committedDate": "2020-01-28T11:00:31Z", "type": "commit"}, {"oid": "7f6a35f1fe280cceee89f25cd8b01508fc7a30e1", "url": "https://github.com/apache/ignite/commit/7f6a35f1fe280cceee89f25cd8b01508fc7a30e1", "message": "IGNITE-12576 meta", "committedDate": "2020-01-29T15:49:35Z", "type": "commit"}]}