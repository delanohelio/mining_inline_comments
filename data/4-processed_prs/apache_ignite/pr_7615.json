{"pr_number": 7615, "pr_title": "IGNITE-12764 Regression: Thin JDBC streaming fails/BatchUpdateException if function is used", "pr_createdAt": "2020-04-02T17:49:46Z", "pr_url": "https://github.com/apache/ignite/pull/7615", "timeline": [{"oid": "59b00a4de6599ef1bc2fcdfbb2dadb4ee7053cea", "url": "https://github.com/apache/ignite/commit/59b00a4de6599ef1bc2fcdfbb2dadb4ee7053cea", "message": "IGNITE-12764 Regression: Thin JDBC streaming fails/BatchUpdateException if function is used", "committedDate": "2020-04-02T17:47:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkzMzA0NQ==", "url": "https://github.com/apache/ignite/pull/7615#discussion_r403933045", "bodyText": "Can you, please, rewrite this test using Ignite code style?\nhttps://cwiki.apache.org/confluence/display/IGNITE/Coding+Guidelines", "author": "nizhikov", "createdAt": "2020-04-06T08:59:09Z", "path": "modules/indexing/src/test/java/org/apache/ignite/internal/processors/query/JdbcSqlStreamingTest.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.query;\n+\n+import java.sql.Connection;\n+import java.sql.Driver;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.util.Properties;\n+import java.util.UUID;\n+import org.apache.ignite.IgniteJdbcThinDriver;\n+import org.apache.ignite.internal.IgniteEx;\n+import org.apache.ignite.internal.processors.cache.index.AbstractIndexingCommonTest;\n+import org.junit.Test;\n+\n+/**\n+ *\n+ */\n+public class JdbcSqlStreamingTest extends AbstractIndexingCommonTest {\n+    /** */\n+    private static final int ROW_NUM = 1600;\n+\n+    /**\n+     * @throws Exception If failed.\n+     */\n+    @Test\n+    public void testStreamingWithFunctionValues() throws Exception {", "originalCommit": "59b00a4de6599ef1bc2fcdfbb2dadb4ee7053cea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM1NjA0MA==", "url": "https://github.com/apache/ignite/pull/7615#discussion_r405356040", "bodyText": "Done.", "author": "x-kreator", "createdAt": "2020-04-08T08:41:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkzMzA0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzk1MjQ5Nw==", "url": "https://github.com/apache/ignite/pull/7615#discussion_r403952497", "bodyText": "Why this query is always local?", "author": "nizhikov", "createdAt": "2020-04-06T09:30:27Z", "path": "modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/IgniteH2Indexing.java", "diffHunk": "@@ -691,36 +691,58 @@ private long streamQuery0(String qry, String schemaName, IgniteDataStreamer stre\n         try {\n             UpdatePlan plan = dml.plan();\n \n-            List<List<?>> planRows = plan.createRows(args != null ? args : X.EMPTY_OBJECT_ARRAY);\n+            Object[] params = args != null ? args : X.EMPTY_OBJECT_ARRAY;\n+\n+            Iterator<List<?>> iter0;\n+\n+            if (!F.isEmpty(plan.selectQuery())) {\n+                SqlFieldsQuery selectQry = new SqlFieldsQuery(plan.selectQuery())\n+                    .setArgs(params)\n+                    .setLocal(true);", "originalCommit": "59b00a4de6599ef1bc2fcdfbb2dadb4ee7053cea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM3OTAzMw==", "url": "https://github.com/apache/ignite/pull/7615#discussion_r405379033", "bodyText": "That behavior was implemented before was dropped at commit 6c9a17b (pr #6096 by vozerov), so I decided to return it with minimal differences.", "author": "x-kreator", "createdAt": "2020-04-08T09:16:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzk1MjQ5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTUwMzQ4Nw==", "url": "https://github.com/apache/ignite/pull/7615#discussion_r405503487", "bodyText": "Why do you think that changes in 6c9a17b is wrong?", "author": "nizhikov", "createdAt": "2020-04-08T12:57:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzk1MjQ5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTUyMTI0MA==", "url": "https://github.com/apache/ignite/pull/7615#discussion_r405521240", "bodyText": "Not all but condition removed from line 816 and assertion added to line 814.\nThat assertion was also removed at 1619dd5 (pr #6112).\nAssume that adding of assertion is right, then it's logical to expect that we should meet the changes which fix that assertion failures happening when we use expressions at streaming inserts. But all further changes keep the bug described above till 1619dd5. After 1619dd5 we became to meet the bug described in our issue instead of assertion error.", "author": "x-kreator", "createdAt": "2020-04-08T13:23:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzk1MjQ5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDAwMzkzOA==", "url": "https://github.com/apache/ignite/pull/7615#discussion_r404003938", "bodyText": "It seems this piece of code should be rewritten as follows to minimize changes in the code and improve readability:\n    private long streamQuery0(String qry, String schemaName, IgniteDataStreamer streamer, QueryParserResultDml dml,\n        final Object[] args) throws IgniteCheckedException {\n        Long qryId = runningQryMgr.register(qry, GridCacheQueryType.SQL_FIELDS, schemaName, true, null);\n\n        Exception failReason = null;\n\n        try {\n            UpdatePlan plan = dml.plan();\n\n            Iterator<List<?>> iter = updateQueryRows(schemaName, plan, args);\n\n            if (!iter.hasNext())\n                return 0;\n\n            IgniteBiTuple t = plan.processRow(iter.next());\n\n            if (!iter.hasNext()) {\n                streamer.addData(t.getKey(), t.getValue());\n\n                return 1;\n            }\n            else {\n                Map<Object, Object> rows = new LinkedHashMap<>(plan.rowCount());\n\n                rows.put(t.getKey(), t.getValue());\n\n                while (iter.hasNext()) {\n                    List<?> row = iter.next();\n\n                    t = plan.processRow(row);\n\n                    rows.put(t.getKey(), t.getValue());\n                }\n\n                streamer.addData(rows);\n\n                return rows.size();\n            }\n        }\n        catch (IgniteException | IgniteCheckedException e) {\n            failReason = e;\n\n            throw e;\n        }\n        finally {\n            runningQryMgr.unregister(qryId, failReason);\n        }\n    }\n\n    /**\n     * Calculates rows for update query.\n     *\n     * @param schemaName Schema name.\n     * @param plan Update plan.\n     * @param args Statement arguments.\n     * @return Rows for update.\n     * @throws IgniteCheckedException If failed.\n     */\n    Iterator<List<?>> updateQueryRows(String schemaName, UpdatePlan plan, Object[] args) throws IgniteCheckedException {\n        Object[] params = args != null ? args : X.EMPTY_OBJECT_ARRAY;\n\n        if (!F.isEmpty(plan.selectQuery())) {\n            SqlFieldsQuery selectQry = new SqlFieldsQuery(plan.selectQuery())\n                .setArgs(params)\n                .setLocal(true);\n\n            QueryParserResult selectParseRes = parser.parse(schemaName, selectQry, false);\n\n            GridQueryFieldsResult res = executeSelectLocal(\n                selectParseRes.queryDescriptor(),\n                selectParseRes.queryParameters(),\n                selectParseRes.select(),\n                null,\n                null,\n                null,\n                false,\n                0\n            );\n\n            return res.iterator();\n        } else\n            return plan.createRows(params).iterator();\n    }", "author": "nizhikov", "createdAt": "2020-04-06T10:59:15Z", "path": "modules/indexing/src/main/java/org/apache/ignite/internal/processors/query/h2/IgniteH2Indexing.java", "diffHunk": "@@ -691,36 +691,58 @@ private long streamQuery0(String qry, String schemaName, IgniteDataStreamer stre\n         try {\n             UpdatePlan plan = dml.plan();\n \n-            List<List<?>> planRows = plan.createRows(args != null ? args : X.EMPTY_OBJECT_ARRAY);\n+            Object[] params = args != null ? args : X.EMPTY_OBJECT_ARRAY;", "originalCommit": "59b00a4de6599ef1bc2fcdfbb2dadb4ee7053cea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM3MTMwMg==", "url": "https://github.com/apache/ignite/pull/7615#discussion_r405371302", "bodyText": "Done. I had same idea about updateQueryRows method, but I refrained from implementing it earlier due to the fact that some reviewers don't like methods used only once.", "author": "x-kreator", "createdAt": "2020-04-08T09:05:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDAwMzkzOA=="}], "type": "inlineReview"}, {"oid": "faa4bfcbff1f27f9e13873ddd154a276ce9fe15e", "url": "https://github.com/apache/ignite/commit/faa4bfcbff1f27f9e13873ddd154a276ce9fe15e", "message": "IGNITE-12764 Regression: Thin JDBC streaming fails/BatchUpdateException if function is used", "committedDate": "2020-04-08T08:37:39Z", "type": "commit"}, {"oid": "48d70f823d079715061766415a1db62931875097", "url": "https://github.com/apache/ignite/commit/48d70f823d079715061766415a1db62931875097", "message": "IGNITE-12764 Regression: Thin JDBC streaming fails/BatchUpdateException if function is used", "committedDate": "2020-04-08T08:59:00Z", "type": "commit"}, {"oid": "5c9db786a46e783f22eefc4b93952de5dfcdf725", "url": "https://github.com/apache/ignite/commit/5c9db786a46e783f22eefc4b93952de5dfcdf725", "message": "IGNITE-12764 Regression: Thin JDBC streaming fails/BatchUpdateException if function is used", "committedDate": "2020-04-08T12:54:21Z", "type": "commit"}, {"oid": "daab8a31811b6e15b5f3cf58da9d56c5c6f3b6ec", "url": "https://github.com/apache/ignite/commit/daab8a31811b6e15b5f3cf58da9d56c5c6f3b6ec", "message": "IGNITE-12764 Regression: Thin JDBC streaming fails/BatchUpdateException if function is used", "committedDate": "2020-04-10T07:55:23Z", "type": "commit"}, {"oid": "136ac36e54b195887c80d6f0f6360cbe2e5ad9ad", "url": "https://github.com/apache/ignite/commit/136ac36e54b195887c80d6f0f6360cbe2e5ad9ad", "message": "IGNITE-12764 Regression: Thin JDBC streaming fails/BatchUpdateException if function is used", "committedDate": "2020-04-10T08:48:12Z", "type": "commit"}, {"oid": "b962728906a6891fe7a7beb1b87ee79a2d212aca", "url": "https://github.com/apache/ignite/commit/b962728906a6891fe7a7beb1b87ee79a2d212aca", "message": "IGNITE-12764 Regression: Thin JDBC streaming fails/BatchUpdateException if function is used", "committedDate": "2020-04-10T12:36:37Z", "type": "commit"}, {"oid": "88473b0a3000750aa64dd6370d4a58c2d442dfcc", "url": "https://github.com/apache/ignite/commit/88473b0a3000750aa64dd6370d4a58c2d442dfcc", "message": "IGNITE-12764 Regression: Thin JDBC streaming fails/BatchUpdateException if function is used", "committedDate": "2020-04-10T14:49:14Z", "type": "commit"}]}