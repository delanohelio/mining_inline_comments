{"pr_number": 7967, "pr_title": "Duck is a duck ", "pr_createdAt": "2020-06-26T15:05:48Z", "pr_url": "https://github.com/apache/ignite/pull/7967", "timeline": [{"oid": "3c39983005bd9eaf8cb458950d942fb592fff85c", "url": "https://github.com/apache/ignite/commit/3c39983005bd9eaf8cb458950d942fb592fff85c", "message": "duck is a duck", "committedDate": "2020-06-26T15:04:43Z", "type": "commit"}, {"oid": "9ebffa7201275fc05c3928d8827880b66849d291", "url": "https://github.com/apache/ignite/commit/9ebffa7201275fc05c3928d8827880b66849d291", "message": "checkstyle + package refactoring", "committedDate": "2020-06-29T08:06:41Z", "type": "commit"}, {"oid": "22392a11a4318f3ca03bad18710ae3a3ab605a52", "url": "https://github.com/apache/ignite/commit/22392a11a4318f3ca03bad18710ae3a3ab605a52", "message": "WIP", "committedDate": "2020-06-29T08:09:06Z", "type": "commit"}, {"oid": "b01929ddfe7696027562f7ccdf1fe196f00edc5d", "url": "https://github.com/apache/ignite/commit/b01929ddfe7696027562f7ccdf1fe196f00edc5d", "message": "WIP", "committedDate": "2020-06-29T09:38:42Z", "type": "commit"}, {"oid": "e3ea44b397db5a621104b864ab84c931ca8ada55", "url": "https://github.com/apache/ignite/commit/e3ea44b397db5a621104b864ab84c931ca8ada55", "message": "WIP", "committedDate": "2020-06-30T07:34:07Z", "type": "commit"}, {"oid": "32109c09bd024f45b6be930da55d563b2d70559e", "url": "https://github.com/apache/ignite/commit/32109c09bd024f45b6be930da55d563b2d70559e", "message": "WIP", "committedDate": "2020-06-30T10:34:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk4NTQ1OQ==", "url": "https://github.com/apache/ignite/pull/7967#discussion_r448985459", "bodyText": "Use \"RUN curl -O\" or \"RUN wget\" instead of ADD to enable caching. Check this issue", "author": "timoninmaxim", "createdAt": "2020-07-02T13:03:38Z", "path": "modules/ducktests/tests/docker/Dockerfile", "diffHunk": "@@ -48,14 +48,13 @@ ARG APACHE_MIRROR=\"https://apache-mirror.rbc.ru/pub/apache/\"\n ARG APACHE_ARCHIVE=\"https://archive.apache.org/dist/\"\n \n # Install binary test dependencies.\n-ARG IGNITE_VERSION=\"2.8.0\"\n-ARG IGNITE_NAME=\"ignite-$IGNITE_VERSION\"\n-ARG IGNITE_RELEASE_NAME=\"apache-ignite-$IGNITE_VERSION-bin\"\n-\n-ADD $APACHE_ARCHIVE/ignite/$IGNITE_VERSION/$IGNITE_RELEASE_NAME.zip /opt/\n-RUN cd /opt && unzip $IGNITE_RELEASE_NAME.zip && rm $IGNITE_RELEASE_NAME.zip\n-RUN mv /opt/$IGNITE_RELEASE_NAME /opt/$IGNITE_NAME\n-RUN chmod a+wr /opt/$IGNITE_NAME -R\n+ADD $APACHE_ARCHIVE/ignite/2.7.6/apache-ignite-2.7.6-bin.zip /opt/", "originalCommit": "32109c09bd024f45b6be930da55d563b2d70559e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU0Mjg4Mw==", "url": "https://github.com/apache/ignite/pull/7967#discussion_r449542883", "bodyText": "Done", "author": "anton-vinogradov", "createdAt": "2020-07-03T11:50:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk4NTQ1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk4NjQ4Ng==", "url": "https://github.com/apache/ignite/pull/7967#discussion_r448986486", "bodyText": "IGNITE_NAME was removed, chmod invoked twice", "author": "timoninmaxim", "createdAt": "2020-07-02T13:05:14Z", "path": "modules/ducktests/tests/docker/Dockerfile", "diffHunk": "@@ -48,14 +48,13 @@ ARG APACHE_MIRROR=\"https://apache-mirror.rbc.ru/pub/apache/\"\n ARG APACHE_ARCHIVE=\"https://archive.apache.org/dist/\"\n \n # Install binary test dependencies.\n-ARG IGNITE_VERSION=\"2.8.0\"\n-ARG IGNITE_NAME=\"ignite-$IGNITE_VERSION\"\n-ARG IGNITE_RELEASE_NAME=\"apache-ignite-$IGNITE_VERSION-bin\"\n-\n-ADD $APACHE_ARCHIVE/ignite/$IGNITE_VERSION/$IGNITE_RELEASE_NAME.zip /opt/\n-RUN cd /opt && unzip $IGNITE_RELEASE_NAME.zip && rm $IGNITE_RELEASE_NAME.zip\n-RUN mv /opt/$IGNITE_RELEASE_NAME /opt/$IGNITE_NAME\n-RUN chmod a+wr /opt/$IGNITE_NAME -R\n+ADD $APACHE_ARCHIVE/ignite/2.7.6/apache-ignite-2.7.6-bin.zip /opt/\n+RUN cd /opt && unzip apache-ignite-2.7.6-bin.zip && mv /opt/apache-ignite-2.7.6-bin /opt/ignite-2.7.6 && chmod a+wr /opt/$IGNITE_NAME -R", "originalCommit": "32109c09bd024f45b6be930da55d563b2d70559e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU0MjkyNQ==", "url": "https://github.com/apache/ignite/pull/7967#discussion_r449542925", "bodyText": "Done", "author": "anton-vinogradov", "createdAt": "2020-07-03T11:51:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk4NjQ4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAwNjU5NQ==", "url": "https://github.com/apache/ignite/pull/7967#discussion_r449006595", "bodyText": "add XX:+UseCGroupMemoryLimitForHeap option for JVM to enable correct cgroups for Java application inside docker. Check this article", "author": "timoninmaxim", "createdAt": "2020-07-02T13:36:14Z", "path": "modules/ducktests/tests/ignitetest/services/ignite.py", "diffHunk": "@@ -20,79 +20,52 @@\n from ducktape.services.service import Service\n from ducktape.utils.util import wait_until\n \n-from ignitetest.services.utils.ignite_config import IgniteConfig\n-from ignitetest.services.utils.ignite_path import IgnitePath\n+from ignitetest.services.utils.ignite_aware import IgniteAwareService\n from ignitetest.version import DEV_BRANCH\n \n \n-class IgniteService(Service):\n-    PERSISTENT_ROOT = \"/mnt/ignite\"\n-    WORK_DIR = os.path.join(PERSISTENT_ROOT, \"work\")\n-    CONFIG_FILE = os.path.join(PERSISTENT_ROOT, \"ignite-config.xml\")\n-    LOG4J_CONFIG_FILE = os.path.join(PERSISTENT_ROOT, \"ignite-log4j.xml\")\n-    HEAP_DUMP_FILE = os.path.join(PERSISTENT_ROOT, \"ignite-heap.bin\")\n-    STDOUT_STDERR_CAPTURE = os.path.join(PERSISTENT_ROOT, \"console.log\")\n+class IgniteService(IgniteAwareService):\n+    APP_SERVICE_CLASS = \"org.apache.ignite.startup.cmdline.CommandLineStartup\"\n+    HEAP_DUMP_FILE = os.path.join(IgniteAwareService.PERSISTENT_ROOT, \"ignite-heap.bin\")\n \n     logs = {\n         \"console_log\": {\n-            \"path\": STDOUT_STDERR_CAPTURE,\n+            \"path\": IgniteAwareService.STDOUT_STDERR_CAPTURE,\n             \"collect_default\": True},\n \n         \"heap_dump\": {\n             \"path\": HEAP_DUMP_FILE,\n             \"collect_default\": False}\n     }\n \n-    def __init__(self, context, num_nodes=3, version=DEV_BRANCH):\n-        \"\"\"\n-        :param context: test context\n-        :param num_nodes: number of Ignite nodes.\n-        \"\"\"\n-        Service.__init__(self, context, num_nodes)\n+    def __init__(self, context, num_nodes, version=DEV_BRANCH, properties=\"\"):\n+        IgniteAwareService.__init__(self, context, num_nodes, version, properties)\n \n-        self.log_level = \"DEBUG\"\n-        self.config = IgniteConfig()\n-        self.path = IgnitePath()\n-\n-        for node in self.nodes:\n-            node.version = version\n-\n-    def start(self):\n+    def start(self, timeout_sec=180):\n         Service.start(self)\n \n-        self.logger.info(\"Waiting for Ignite to start...\")\n+        self.logger.info(\"Waiting for Ignite(s) to start...\")\n+\n+        for node in self.nodes:\n+            self.await_node_stated(node, timeout_sec)\n \n     def start_cmd(self, node):\n         jvm_opts = \"-J-DIGNITE_SUCCESS_FILE=\" + IgniteService.PERSISTENT_ROOT + \"/success_file \"\n         jvm_opts += \"-J-Dlog4j.configDebug=true\"", "originalCommit": "32109c09bd024f45b6be930da55d563b2d70559e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTYxOTczMA==", "url": "https://github.com/apache/ignite/pull/7967#discussion_r449619730", "bodyText": "Done", "author": "anton-vinogradov", "createdAt": "2020-07-03T14:50:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAwNjU5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE3MTI5OQ==", "url": "https://github.com/apache/ignite/pull/7967#discussion_r449171299", "bodyText": "Versions should be moved to config. Adding new versions (or ISP versions) will lead to change multiple files just to update version.", "author": "timoninmaxim", "createdAt": "2020-07-02T17:34:57Z", "path": "modules/ducktests/tests/ignitetest/tests/benchmarks/add_node_rebalance_test.py", "diffHunk": "@@ -0,0 +1,94 @@\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#    http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+import time\n+\n+from ducktape.mark import parametrize\n+from ducktape.mark.resource import cluster\n+\n+from ignitetest.services.ignite import IgniteService\n+from ignitetest.services.ignite_app import IgniteApplicationService\n+from ignitetest.tests.utils.ignite_test import IgniteTest\n+from ignitetest.version import DEV_BRANCH, IgniteVersion, V_2_8_0\n+\n+\n+class AddNodeRebalanceTest(IgniteTest):\n+    NUM_NODES = 4\n+    PRELOAD_TIMEOUT = 60\n+    DATA_AMOUNT = 1000000\n+    REBALANCE_TIMEOUT = 60\n+\n+    \"\"\"\n+    Test performs rebalance tests.\n+    \"\"\"\n+\n+    @staticmethod\n+    def properties(client_mode=\"false\"):\n+        return \"\"\"\n+            <property name=\"clientMode\" value=\"{client_mode}\"/>\n+        \"\"\".format(client_mode=client_mode)\n+\n+    def __init__(self, test_context):\n+        super(AddNodeRebalanceTest, self).__init__(test_context=test_context)\n+\n+    def setUp(self):\n+        pass\n+\n+    def teardown(self):\n+        pass\n+\n+    @cluster(num_nodes=NUM_NODES + 1)\n+    @parametrize(version=str(DEV_BRANCH))\n+    @parametrize(version=str(V_2_8_0))", "originalCommit": "32109c09bd024f45b6be930da55d563b2d70559e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE3OTY1OA==", "url": "https://github.com/apache/ignite/pull/7967#discussion_r449179658", "bodyText": "We want to build tests as stable as we can.\nSo the explicit version in test parameters is a thoughtful choice.\nKafka uses approach with the LATEST_2_8 or LATEST_2_9 to change all tests to the new minor versions.\nBut with every major version, one should update tests.", "author": "nizhikov", "createdAt": "2020-07-02T17:51:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE3MTI5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU1NzUxMQ==", "url": "https://github.com/apache/ignite/pull/7967#discussion_r449557511", "bodyText": "Agree with @nizhikov.\nFixed code to use Latest.", "author": "anton-vinogradov", "createdAt": "2020-07-03T12:27:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE3MTI5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE3NjEyMQ==", "url": "https://github.com/apache/ignite/pull/7967#discussion_r449176121", "bodyText": "Versions and distributive sources should be configured externally: easy add new versions, custom versions from custom sources, without changing dockerfile.\nPossible just try use different images for different versions (to save time on prepare tests to start)", "author": "timoninmaxim", "createdAt": "2020-07-02T17:44:28Z", "path": "modules/ducktests/tests/docker/Dockerfile", "diffHunk": "@@ -48,14 +48,13 @@ ARG APACHE_MIRROR=\"https://apache-mirror.rbc.ru/pub/apache/\"\n ARG APACHE_ARCHIVE=\"https://archive.apache.org/dist/\"\n \n # Install binary test dependencies.\n-ARG IGNITE_VERSION=\"2.8.0\"\n-ARG IGNITE_NAME=\"ignite-$IGNITE_VERSION\"\n-ARG IGNITE_RELEASE_NAME=\"apache-ignite-$IGNITE_VERSION-bin\"\n-\n-ADD $APACHE_ARCHIVE/ignite/$IGNITE_VERSION/$IGNITE_RELEASE_NAME.zip /opt/\n-RUN cd /opt && unzip $IGNITE_RELEASE_NAME.zip && rm $IGNITE_RELEASE_NAME.zip\n-RUN mv /opt/$IGNITE_RELEASE_NAME /opt/$IGNITE_NAME\n-RUN chmod a+wr /opt/$IGNITE_NAME -R\n+ADD $APACHE_ARCHIVE/ignite/2.7.6/apache-ignite-2.7.6-bin.zip /opt/\n+RUN cd /opt && unzip apache-ignite-2.7.6-bin.zip && mv /opt/apache-ignite-2.7.6-bin /opt/ignite-2.7.6 && chmod a+wr /opt/$IGNITE_NAME -R\n+\n+ADD $APACHE_ARCHIVE/ignite/2.8.0/apache-ignite-2.8.0-bin.zip /opt/", "originalCommit": "32109c09bd024f45b6be930da55d563b2d70559e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE3ODA3Mw==", "url": "https://github.com/apache/ignite/pull/7967#discussion_r449178073", "bodyText": "Versions and distributive sources should be configured externally\n\nPlease, clarify, what issues do you see with the approach when we have all the required versions in this Dockerfile?\nIf we have to use a different image with some custom Ignite assembly, we, probably, should have script parameters to specify other Dockerfile to build image from.", "author": "nizhikov", "createdAt": "2020-07-02T17:48:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE3NjEyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIzMjEzOQ==", "url": "https://github.com/apache/ignite/pull/7967#discussion_r449232139", "bodyText": "I see at least 3 issues there:\n\nSome versions could be incompatible with each other. For example, one version could work on java11 without issues, while others are not (there is also issue with our custom build that works only on patched java). Accidentally there could be dependencies on different system libs, envs, directories, etc.\n\nI think its a good practice do not mix different versions in the same env and prepare a separate image for every version.\n\n\nAlso there should be images like ignite-X.Y.Z-java8, ignite-X.Y.Z-java11, ignite-X.Y.Z-alpine, etc. I think we can reuse this common images in tests rather than creating uber image just for tests. Also it guarantees work of ignite public docker images.\n\n\nI'm trying to write some ISE specific tests with enabled custom plugins. Also I want to run existing tests (written for original Ignite) for the custom version directly from the ducktape directory. Also I want compare multiple versions (custom and original) with each other.\n\n\nI suppose that I can flexible configure my test just specify required versions rather than re-create new image for my every case.", "author": "timoninmaxim", "createdAt": "2020-07-02T19:44:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE3NjEyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIzNTc1OA==", "url": "https://github.com/apache/ignite/pull/7967#discussion_r449235758", "bodyText": "For example, one version could work on java11 without issues, while others are not\n\nThis knowledge should be put in the test itself. Kafka uses the same approach.\n\nAccidentally there could be dependencies on different system libs, envs, directories, etc.\n\nAll required dependencies exist in zip distribution.\nDirectories structure doesn't change frequently so we can put this knowledge into the service itself.\n\nI think its a good practice do not mix different versions\n\nWhat is wrong with the different versions?\nWe want to run the same tests on the different versions.\n\nAlso there should be images like ignite-X.Y.Z-java8, ignite-X.Y.Z-java11, ignite-X.Y.Z-alpine\n\n\nWe don't support alpine.\nYes, we can parametrize the creation of the image with the JDK version. Initial PR doesn't contain this parameter for the sake of simplicity.\n\n\nI'm trying to write some ISE specific tests with enabled custom plugins\nrather than re-create new image for my every case.\n\nYou should create different docker image to be able to use custom Ignite assembly.\nYou don't need several images, just one image that satisfies your requirements.", "author": "nizhikov", "createdAt": "2020-07-02T19:53:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE3NjEyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQyNjcyNw==", "url": "https://github.com/apache/ignite/pull/7967#discussion_r449426727", "bodyText": "All required dependencies exist in zip distribution.\n\nActually this is not true as at least Spark set up separately. And there could be issues with different versions of Ignite and Spark.\nWith storing dependencies in .zip you just reinvent containers without using any of their advantages. Now you need to support multiple applications in one container. But you can't start all of them in one container as you need to orchestrate apps by self: set LD_LIBRARY_PATH for different system libs, set JAVA_HOME for different jvms, use different networks, different mount directories, etc.\nIf you move JDK as param for container why do not do the same for Ignite version? It looks inconsistent now.\n\nKafka uses the same approach\n\nKafka may have a motivation for that. To do the same one need clearly understand reasons behind this approach. Could you please provide discussion or design doc that describes this solution.\n\nWe don't support alpine.\n\nIt's ok, it was just an example that there are should be different public official images that can be reused. I'm repeating there we could use public Ignite images to use them in tests instead of creating uber docker image just for tests.\n\nYou don't need several images, just one image that satisfies your requirements\n\nContainers are building blocks. A container provides a process and it is not a replacement of physical environment. There are additional limitations if try use containers as envs. For example in current dockerfile at least 2 problems that could lead to wasting time while try discover some troubles:\n\ndelegated volumes I've mentioned below (check this comment);\nUsing 'tail -f' as init process could lead to wasting Linux resources (Check this article).", "author": "timoninmaxim", "createdAt": "2020-07-03T07:39:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE3NjEyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ3NjUxNg==", "url": "https://github.com/apache/ignite/pull/7967#discussion_r449476516", "bodyText": "Actually this is not true as at least Spark set up separately. And there could be issues with different versions of Ignite and Spark.\n\nWe just should prepare all Spark or Ignite versions we want to tests.\nI can't see any issues with this.", "author": "nizhikov", "createdAt": "2020-07-03T09:18:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE3NjEyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ3NzAzOA==", "url": "https://github.com/apache/ignite/pull/7967#discussion_r449477038", "bodyText": "If you move JDK as param for container why do not do the same for Ignite version? It looks inconsistent now.\n\nBecause I think we don't want to increase the complexity of the final solution with dozens of different images.", "author": "nizhikov", "createdAt": "2020-07-03T09:19:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE3NjEyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ3Nzc2Ng==", "url": "https://github.com/apache/ignite/pull/7967#discussion_r449477766", "bodyText": "It's ok, it was just an example that there are should be different public official images that can be reused\n\nFor now, we don't have those images.\nMoreover, we want to use the same tests with the different deployment types - AWS, private cloud, etc.\nIf we go with the dozens of images we should provide a dozen scripts for each deployment type, also.", "author": "nizhikov", "createdAt": "2020-07-03T09:21:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE3NjEyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU4MzgzNA==", "url": "https://github.com/apache/ignite/pull/7967#discussion_r449583834", "bodyText": "Lets, restart this thread at separate PR if necessary?", "author": "anton-vinogradov", "createdAt": "2020-07-03T13:28:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE3NjEyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE4MjA4Ng==", "url": "https://github.com/apache/ignite/pull/7967#discussion_r449182086", "bodyText": "delegated could be misleading. Containers are reused for running tests with ./run_tests.sh script. But docker docs says:\n\nIf changes to the mount source directory are present on the host file system, those changes may be lost when the delegated mount synchronizes with the host source directory.\n\nIt could lead to situation when change of sources does not synchronized and does not affect tests.\nCheck this article", "author": "timoninmaxim", "createdAt": "2020-07-02T17:56:21Z", "path": "modules/ducktests/tests/docker/ducker-ignite", "diffHunk": "@@ -258,7 +258,7 @@ docker_run() {\n     must_do -v docker run --privileged \\\n         -d -t -h \"${node}\" --network ducknet \"${expose_ports}\" \\\n         --memory=${docker_run_memory_limit} --memory-swappiness=1 \\\n-        -v \"${ignite_dir}:/opt/ignite-dev\" --name \"${node}\" -- \"${image_name}\"\n+        -v \"${ignite_dir}:/opt/ignite-dev:delegated\" --name \"${node}\" -- \"${image_name}\"", "originalCommit": "32109c09bd024f45b6be930da55d563b2d70559e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE4OTg0NA==", "url": "https://github.com/apache/ignite/pull/7967#discussion_r449189844", "bodyText": "Possible solution is to force clean up all containers after tests have finished", "author": "timoninmaxim", "createdAt": "2020-07-02T18:11:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE4MjA4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU4NTM4Mw==", "url": "https://github.com/apache/ignite/pull/7967#discussion_r449585383", "bodyText": "Seems, we have to find a good fix here.\nLeft's restart this as a separate PR.", "author": "anton-vinogradov", "createdAt": "2020-07-03T13:31:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE4MjA4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxNTg0Mw==", "url": "https://github.com/apache/ignite/pull/7967#discussion_r449815843", "bodyText": "Is container mount slowdown (and related ':delegated' hack) a MacOs only issue? I suppose, Windows devs might face same problem? Coupled with most of SberGain devs use Windows, this is another reason why running persistence based benchmarks locally may produce totally different and misleading results compared to running same benchmarks on bare metal.", "author": "mshonichev", "createdAt": "2020-07-05T00:10:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE4MjA4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDA0OTk1OQ==", "url": "https://github.com/apache/ignite/pull/7967#discussion_r450049959", "bodyText": "Hi! delegated hack is used only for Ignite code. The same time work directory is located under /mnt/service directory that is not a volume. Also docker uses different filesystem for non-volumes (by default it is overlayfs) than bare metal. This FS allows native performance but in some circumstances performance can be different (check this note).\nSo one should not make assumptions about performance based on results in docker only. But this more about heavy benchmarks. Testing in docker helps to find programming issues that visibly slow down some operations.", "author": "timoninmaxim", "createdAt": "2020-07-06T08:02:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE4MjA4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDA1ODgyOA==", "url": "https://github.com/apache/ignite/pull/7967#discussion_r450058828", "bodyText": "Also, I've found that there is kibosh used in Dockerfile. I'm not confident how exactly it works, may be there are some penalties too (actually I don't know).", "author": "timoninmaxim", "createdAt": "2020-07-06T08:19:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE4MjA4Ng=="}], "type": "inlineReview"}, {"oid": "aae0cab81c48c1b871945cc96ec1b2966633177b", "url": "https://github.com/apache/ignite/commit/aae0cab81c48c1b871945cc96ec1b2966633177b", "message": "WIP", "committedDate": "2020-07-03T11:50:31Z", "type": "commit"}, {"oid": "5613c63ced32fe1c89204474936e6aeb1cf6b94c", "url": "https://github.com/apache/ignite/commit/5613c63ced32fe1c89204474936e6aeb1cf6b94c", "message": "WIP", "committedDate": "2020-07-03T12:27:23Z", "type": "commit"}, {"oid": "065be2e4cbe2d8675db84e8b4cee049ae4408262", "url": "https://github.com/apache/ignite/commit/065be2e4cbe2d8675db84e8b4cee049ae4408262", "message": "Merge remote-tracking branch 'remotes/origin/ignite-ducktape' into ignite-ducktape", "committedDate": "2020-07-03T12:46:47Z", "type": "commit"}, {"oid": "a42ff074ce241a22a544baa8a94722345e4397be", "url": "https://github.com/apache/ignite/commit/a42ff074ce241a22a544baa8a94722345e4397be", "message": "WIP", "committedDate": "2020-07-03T14:49:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUzMjU4NQ==", "url": "https://github.com/apache/ignite/pull/7967#discussion_r450532585", "bodyText": "That's just create two additional full-archive copy layers which increase image size [1] and may slow down file deletion operations due to layered nature of docker image [2].\n$ docker images\nREPOSITORY                TAG                 IMAGE ID            CREATED             SIZE\nducker-ignite-openjdk-8   latest              eb0bc05f45f0        10 minutes ago      4.31GB\n\nducker@ducker01:/$ sudo du -hs / 2>/dev/null\n3.6G\t/\n\n\nIf you absolutely need writable ignite dir, you could either glue RUN commands together, or you may set up a bunch of symlinks:\n/opt/apache-ignite-2.8.0/bin ... original archive\n/opt/ignite-2.8.0/ - real directory\n/opt/ignite-2.8.0/bin -> symlink to /opt/apache-ignite-2.8.0/bin\n...\n\n\n[1] - https://www.datawire.io/not-engineer-running-3-5gb-docker-images/\n[2] - https://docs.docker.com/storage/storagedriver/", "author": "mshonichev", "createdAt": "2020-07-06T23:36:26Z", "path": "modules/ducktests/tests/docker/Dockerfile", "diffHunk": "@@ -42,28 +42,23 @@ COPY ./ssh-config /root/.ssh/config\n RUN ssh-keygen -m PEM -q -t rsa -N '' -f /root/.ssh/id_rsa && cp -f /root/.ssh/id_rsa.pub /root/.ssh/authorized_keys\n RUN echo 'PermitUserEnvironment yes' >> /etc/ssh/sshd_config\n \n-RUN chmod a+wr /opt\n-\n ARG APACHE_MIRROR=\"https://apache-mirror.rbc.ru/pub/apache/\"\n ARG APACHE_ARCHIVE=\"https://archive.apache.org/dist/\"\n \n # Install binary test dependencies.\n-ARG IGNITE_VERSION=\"2.8.0\"\n-ARG IGNITE_NAME=\"ignite-$IGNITE_VERSION\"\n-ARG IGNITE_RELEASE_NAME=\"apache-ignite-$IGNITE_VERSION-bin\"\n+RUN cd /opt && curl -O $APACHE_ARCHIVE/ignite/2.7.6/apache-ignite-2.7.6-bin.zip && unzip apache-ignite-2.7.6-bin.zip && mv /opt/apache-ignite-2.7.6-bin /opt/ignite-2.7.6\n+RUN cd /opt && curl -O $APACHE_ARCHIVE/ignite/2.8.0/apache-ignite-2.8.0-bin.zip && unzip apache-ignite-2.8.0-bin.zip && mv /opt/apache-ignite-2.8.0-bin /opt/ignite-2.8.0\n+RUN cd /opt && curl -O $APACHE_ARCHIVE/ignite/2.8.1/apache-ignite-2.8.1-bin.zip && unzip apache-ignite-2.8.1-bin.zip && mv /opt/apache-ignite-2.8.1-bin /opt/ignite-2.8.1\n \n-ADD $APACHE_ARCHIVE/ignite/$IGNITE_VERSION/$IGNITE_RELEASE_NAME.zip /opt/\n-RUN cd /opt && unzip $IGNITE_RELEASE_NAME.zip && rm $IGNITE_RELEASE_NAME.zip\n-RUN mv /opt/$IGNITE_RELEASE_NAME /opt/$IGNITE_NAME\n-RUN chmod a+wr /opt/$IGNITE_NAME -R\n+RUN rm /opt/apache-ignite-*-bin.zip\n+RUN chmod a+wr /opt -R", "originalCommit": "a42ff074ce241a22a544baa8a94722345e4397be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTU2MDI1Mg==", "url": "https://github.com/apache/ignite/pull/7967#discussion_r451560252", "bodyText": "@mshonichev,\nAFAIU, the question about the necessity of \"RUN chmod a+wr /opt -R\".\nSeems, it can be safely removed since other folders used for write access.\nRemoved this.", "author": "anton-vinogradov", "createdAt": "2020-07-08T13:51:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUzMjU4NQ=="}], "type": "inlineReview"}, {"oid": "c283a5144f5f1f9830a2aa43dc97af5fd86602ac", "url": "https://github.com/apache/ignite/commit/c283a5144f5f1f9830a2aa43dc97af5fd86602ac", "message": "WIP", "committedDate": "2020-07-08T13:51:09Z", "type": "commit"}]}