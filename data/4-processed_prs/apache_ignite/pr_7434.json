{"pr_number": 7434, "pr_title": "IGNITE-7276 .NET: Enable/disable cache statistics in runtime", "pr_createdAt": "2020-02-15T20:25:43Z", "pr_url": "https://github.com/apache/ignite/pull/7434", "timeline": [{"oid": "f99fba6d7ba60c6298f3232926d3ade2c6856548", "url": "https://github.com/apache/ignite/commit/f99fba6d7ba60c6298f3232926d3ade2c6856548", "message": "IGNITE-7276 - ICache.EnableStatistics started", "committedDate": "2020-01-26T19:30:35Z", "type": "commit"}, {"oid": "9d822d53141319f111622fc990c761e6b7f11d88", "url": "https://github.com/apache/ignite/commit/9d822d53141319f111622fc990c761e6b7f11d88", "message": "Merge branch 'master' into IGNITE-7276-enable-cluster-stats\n\n# Conflicts:\n#\tmodules/platforms/dotnet/Apache.Ignite.Core/Impl/Cache/CacheOp.cs", "committedDate": "2020-02-06T22:23:54Z", "type": "commit"}, {"oid": "ba93a4f92e4f551b59aa44504023edb76abbff21", "url": "https://github.com/apache/ignite/commit/ba93a4f92e4f551b59aa44504023edb76abbff21", "message": "IGNITE-7276 - cache enable stats.", "committedDate": "2020-02-08T14:06:27Z", "type": "commit"}, {"oid": "08bee16128509fdb30cc4420e1c7890a689129d2", "url": "https://github.com/apache/ignite/commit/08bee16128509fdb30cc4420e1c7890a689129d2", "message": "IGNITE-7276 - cache enable stats.", "committedDate": "2020-02-15T20:06:43Z", "type": "commit"}, {"oid": "b7536bf2acd575cb55b679d70ef0848f93151746", "url": "https://github.com/apache/ignite/commit/b7536bf2acd575cb55b679d70ef0848f93151746", "message": "IGNITE-7276 - cache enable stats.", "committedDate": "2020-02-16T00:28:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDMyMDEyNA==", "url": "https://github.com/apache/ignite/pull/7434#discussion_r380320124", "bodyText": "val == FALSE ? false : true -> val == TRUE ?", "author": "ptupitsyn", "createdAt": "2020-02-17T18:20:49Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/platform/cache/PlatformCache.java", "diffHunk": "@@ -1174,6 +1177,11 @@ private void loadCache0(BinaryRawReaderEx reader, boolean loc) {\n             case OP_PRELOAD_PARTITION:\n                 cache.preloadPartition((int)val);\n \n+                return TRUE;\n+\n+            case OP_ENABLE_STATISTICS:\n+                cache.enableStatistics(val == FALSE ? false : true);", "originalCommit": "b7536bf2acd575cb55b679d70ef0848f93151746", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDMyMTM0NA==", "url": "https://github.com/apache/ignite/pull/7434#discussion_r380321344", "bodyText": "Please use public API when possible: platformCtx.kernalContext().grid().cluster().enableStatistics(cacheNames, enabled)\nThere is a difference in exception handling and GridKernalGateway.readLock call.", "author": "ptupitsyn", "createdAt": "2020-02-17T18:24:39Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/platform/cluster/PlatformClusterGroup.java", "diffHunk": "@@ -356,6 +359,22 @@ public PlatformClusterGroup(PlatformContext platformCtx, ClusterGroupEx prj) {\n                 return TRUE;\n             }\n \n+            case OP_ENABLE_STATISTICS: {\n+                boolean enabled = reader.readBoolean();\n+\n+                int cnt = reader.readInt();\n+\n+                Collection<String> cacheNames = new ArrayList<>(cnt);\n+\n+                for (int i = 0; i < cnt; i++) {\n+                    cacheNames.add(reader.readString());\n+                }\n+\n+                platformCtx.kernalContext().cache().enableStatistics(cacheNames, enabled);", "originalCommit": "b7536bf2acd575cb55b679d70ef0848f93151746", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDMyMTgxNQ==", "url": "https://github.com/apache/ignite/pull/7434#discussion_r380321815", "bodyText": "Redundant blank line", "author": "ptupitsyn", "createdAt": "2020-02-17T18:26:09Z", "path": "modules/platforms/dotnet/Apache.Ignite.Core.Tests/Cache/CacheMetricsTest.cs", "diffHunk": "@@ -99,6 +99,28 @@ public void TestGlobalMetrics()\n             Assert.AreEqual(1, remoteMetrics.CachePuts);\n         }\n \n+        /// <summary>\n+        /// Tests the cache metrics enable/disable \n+        /// </summary>\n+        [Test]\n+        public void TestCacheEnableStatistics()\n+        {\n+            TestEnableStatistics(\"cacheEnableStatistics\", (cache, b) => cache.EnableStatistics(b));\n+        }\n+", "originalCommit": "b7536bf2acd575cb55b679d70ef0848f93151746", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDMyMjI0MQ==", "url": "https://github.com/apache/ignite/pull/7434#discussion_r380322241", "bodyText": "enabled ? True : False", "author": "ptupitsyn", "createdAt": "2020-02-17T18:27:43Z", "path": "modules/platforms/dotnet/Apache.Ignite.Core/Impl/Cache/CacheImpl.cs", "diffHunk": "@@ -1173,6 +1173,12 @@ public ICacheMetrics GetLocalMetrics()\n             });\n         }\n \n+        /** <inheritDoc /> */\n+        public void EnableStatistics(bool enabled)\n+        {\n+            DoOutInOp((int) CacheOp.EnableStatistics, enabled ? 1 : 0);", "originalCommit": "b7536bf2acd575cb55b679d70ef0848f93151746", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDMyMjUxMQ==", "url": "https://github.com/apache/ignite/pull/7434#discussion_r380322511", "bodyText": "Please add /** <inheritdoc /> */", "author": "ptupitsyn", "createdAt": "2020-02-17T18:28:41Z", "path": "modules/platforms/dotnet/Apache.Ignite.Core/Impl/Ignite.cs", "diffHunk": "@@ -639,6 +639,11 @@ public IServices GetServices()\n             return _prj.ForServers().GetServices();\n         }\n \n+        public void EnableStatistics(IEnumerable<string> cacheNames, bool enabled)", "originalCommit": "b7536bf2acd575cb55b679d70ef0848f93151746", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDMyMzAwMQ==", "url": "https://github.com/apache/ignite/pull/7434#discussion_r380323001", "bodyText": "Please add the following tests additionally:\n\nPass empty cacheNames\nPass non-existent cache names", "author": "ptupitsyn", "createdAt": "2020-02-17T18:30:27Z", "path": "modules/platforms/dotnet/Apache.Ignite.Core.Tests/Cache/CacheMetricsTest.cs", "diffHunk": "@@ -99,6 +99,28 @@ public void TestGlobalMetrics()\n             Assert.AreEqual(1, remoteMetrics.CachePuts);\n         }\n \n+        /// <summary>\n+        /// Tests the cache metrics enable/disable \n+        /// </summary>\n+        [Test]\n+        public void TestCacheEnableStatistics()\n+        {\n+            TestEnableStatistics(\"cacheEnableStatistics\", (cache, b) => cache.EnableStatistics(b));\n+        }\n+\n+        \n+        /// <summary>\n+        /// Tests the cache metrics enable/disable \n+        /// </summary>\n+        [Test]\n+        public void TestClusterGroupEnableStatistics()\n+        {\n+            var cacheName = \"clusterEnableStatistics\";\n+            TestEnableStatistics(\n+                cacheName,\n+                (cache, b) => cache.Ignite.GetCluster().EnableStatistics(new[] {cacheName}, b));", "originalCommit": "b7536bf2acd575cb55b679d70ef0848f93151746", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "91931feb785e3deac64f282120c89d42e5cc92f0", "url": "https://github.com/apache/ignite/commit/91931feb785e3deac64f282120c89d42e5cc92f0", "message": "IGNITE-7276 - switch to public API", "committedDate": "2020-02-17T18:37:59Z", "type": "commit"}, {"oid": "ca457183c45a09d26030a165ea1ad30a7a220d46", "url": "https://github.com/apache/ignite/commit/ca457183c45a09d26030a165ea1ad30a7a220d46", "message": "IGNITE-7276 - clean up", "committedDate": "2020-02-17T18:46:32Z", "type": "commit"}, {"oid": "1d5bbf6f648b76e3f7b81e92f5edf8b05e3080cf", "url": "https://github.com/apache/ignite/commit/1d5bbf6f648b76e3f7b81e92f5edf8b05e3080cf", "message": "IGNITE-7276 - fixes after review.", "committedDate": "2020-02-17T19:11:42Z", "type": "commit"}, {"oid": "b9e40ea47966c6162cc351eda3058a20e851a197", "url": "https://github.com/apache/ignite/commit/b9e40ea47966c6162cc351eda3058a20e851a197", "message": "IGNITE-7276 - extra tests", "committedDate": "2020-02-19T07:18:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjkyMzYyNQ==", "url": "https://github.com/apache/ignite/pull/7434#discussion_r382923625", "bodyText": "Can you please extract the code below into two separate tests? Something like:\n\nTestClusterEnableStatisticsAllowsEmptyCacheNames\nTestClusterEnableStatisticsThrowsOnInvalidCacheName", "author": "ptupitsyn", "createdAt": "2020-02-22T16:16:43Z", "path": "modules/platforms/dotnet/Apache.Ignite.Core.Tests/Cache/CacheMetricsTest.cs", "diffHunk": "@@ -118,6 +120,16 @@ public void TestClusterGroupEnableStatistics()\n             TestEnableStatistics(\n                 cacheName,\n                 (cache, b) => cache.Ignite.GetCluster().EnableStatistics(new[] {cacheName}, b));\n+\n+            var ignite = Ignition.GetIgnite();", "originalCommit": "b9e40ea47966c6162cc351eda3058a20e851a197", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjkyMzY3MA==", "url": "https://github.com/apache/ignite/pull/7434#discussion_r382923670", "bodyText": "Let's add an assertion for the exception message. Does it make sense, is it clear enough for the user to fix the issue?", "author": "ptupitsyn", "createdAt": "2020-02-22T16:17:32Z", "path": "modules/platforms/dotnet/Apache.Ignite.Core.Tests/Cache/CacheMetricsTest.cs", "diffHunk": "@@ -118,6 +120,16 @@ public void TestClusterGroupEnableStatistics()\n             TestEnableStatistics(\n                 cacheName,\n                 (cache, b) => cache.Ignite.GetCluster().EnableStatistics(new[] {cacheName}, b));\n+\n+            var ignite = Ignition.GetIgnite();\n+            ignite.CreateCache<int, int>(new CacheConfiguration(\"clusterEnableStatsValidName\"));\n+            var cluster = ignite.GetCluster();\n+\n+            Assert.DoesNotThrow(() => cluster.EnableStatistics(Enumerable.Empty<string>(), true));\n+\n+            // Nonexistent cache name\n+            Assert.Throws<IgniteException>(", "originalCommit": "b9e40ea47966c6162cc351eda3058a20e851a197", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "953eca5a6f38eb43650e9d66f5c6185c76d5624c", "url": "https://github.com/apache/ignite/commit/953eca5a6f38eb43650e9d66f5c6185c76d5624c", "message": "IGNITE-7276 - refactor tests", "committedDate": "2020-02-22T20:30:57Z", "type": "commit"}]}