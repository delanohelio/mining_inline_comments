{"pr_number": 8004, "pr_title": "IGNITE-13214 .NET: Fix TransactionScope for read operations", "pr_createdAt": "2020-07-07T17:09:35Z", "pr_url": "https://github.com/apache/ignite/pull/8004", "timeline": [{"oid": "559768a09ac95047ff393eb276d034a526570d0d", "url": "https://github.com/apache/ignite/commit/559768a09ac95047ff393eb276d034a526570d0d", "message": "Add TestTransactionScopeWithSerializableIsolationLocksKeysOnRead", "committedDate": "2020-07-07T16:35:00Z", "type": "commit"}, {"oid": "4d2ccba883bb4edbe29ee1c7d9ee2645fad9dc2c", "url": "https://github.com/apache/ignite/commit/4d2ccba883bb4edbe29ee1c7d9ee2645fad9dc2c", "message": "Add TestTransactionScopeWithSerializableIsolationLocksKeysOnRead", "committedDate": "2020-07-07T16:39:31Z", "type": "commit"}, {"oid": "d191800c0940acbddb5f178a3c4e3d1f5cd0d7d6", "url": "https://github.com/apache/ignite/commit/d191800c0940acbddb5f178a3c4e3d1f5cd0d7d6", "message": "Get operation fixed", "committedDate": "2020-07-07T16:40:53Z", "type": "commit"}, {"oid": "47bec0dc753f1452842c62b770a4ab4b0596d209", "url": "https://github.com/apache/ignite/commit/47bec0dc753f1452842c62b770a4ab4b0596d209", "message": "Adding tests for all operations", "committedDate": "2020-07-07T16:55:06Z", "type": "commit"}, {"oid": "381febdefb8ae36e82010f9fce99d20b39c083f4", "url": "https://github.com/apache/ignite/commit/381febdefb8ae36e82010f9fce99d20b39c083f4", "message": "Adding tests for all operations", "committedDate": "2020-07-07T17:00:43Z", "type": "commit"}, {"oid": "299a0c3806786a683c8958d3f7173d1a06bb0121", "url": "https://github.com/apache/ignite/commit/299a0c3806786a683c8958d3f7173d1a06bb0121", "message": "Adding tests for all operations", "committedDate": "2020-07-07T17:02:32Z", "type": "commit"}, {"oid": "86936946ac1cfb872af69ac90ae059a6d01d39db", "url": "https://github.com/apache/ignite/commit/86936946ac1cfb872af69ac90ae059a6d01d39db", "message": "Fix done, tests done", "committedDate": "2020-07-07T17:07:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTEyNDA4OA==", "url": "https://github.com/apache/ignite/pull/8004#discussion_r451124088", "bodyText": "Can ContainsKey and ContainsKeys trigger transnational behavior?", "author": "gurustron", "createdAt": "2020-07-07T20:28:29Z", "path": "modules/platforms/dotnet/Apache.Ignite.Core.Tests/Cache/CacheAbstractTransactionalTest.cs", "diffHunk": "@@ -862,6 +862,50 @@ public void TestTransactionScopeAllOperations()\n             }\n         }\n \n+        /// <summary>\n+        /// Tests that read operations lock keys in Serializable mode.\n+        /// </summary>\n+        [Test]\n+        public void TestTransactionScopeWithSerializableIsolationLocksKeysOnRead()\n+        {\n+            Action<Func<ICache<int, int>, int, int>>\n+                test = TestTransactionScopeWithSerializableIsolationLocksKeysOnRead;\n+\n+            test((cache, key) => cache[key]);", "originalCommit": "86936946ac1cfb872af69ac90ae059a6d01d39db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ3NzEzNw==", "url": "https://github.com/apache/ignite/pull/8004#discussion_r451477137", "bodyText": "Double checked this - no, ContainsKey and ContainsKeys do not participate in transactions.", "author": "ptupitsyn", "createdAt": "2020-07-08T11:39:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTEyNDA4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTEyNzAzOQ==", "url": "https://github.com/apache/ignite/pull/8004#discussion_r451127039", "bodyText": "To be honest I prefer check the optimistic serializable transaction for throwing exception (as defined in documetation) on commit it seems to me to be more predictable and no need for magic numbers and waits.", "author": "gurustron", "createdAt": "2020-07-07T20:34:25Z", "path": "modules/platforms/dotnet/Apache.Ignite.Core.Tests/Cache/CacheAbstractTransactionalTest.cs", "diffHunk": "@@ -862,6 +862,50 @@ public void TestTransactionScopeAllOperations()\n             }\n         }\n \n+        /// <summary>\n+        /// Tests that read operations lock keys in Serializable mode.\n+        /// </summary>\n+        [Test]\n+        public void TestTransactionScopeWithSerializableIsolationLocksKeysOnRead()\n+        {\n+            Action<Func<ICache<int, int>, int, int>>\n+                test = TestTransactionScopeWithSerializableIsolationLocksKeysOnRead;\n+\n+            test((cache, key) => cache[key]);\n+            test((cache, key) => cache.Get(key));\n+            test((cache, key) => cache.GetAsync(key).Result);\n+            test((cache, key) => { int val; return cache.TryGet(key, out val) ? val : 0; });\n+            test((cache, key) => cache.TryGetAsync(key).Result.Value);\n+            test((cache, key) => cache.GetAll(new[] {key}).Single().Value);\n+            test((cache, key) => cache.GetAllAsync(new[] {key}).Result.Single().Value);\n+        }\n+\n+        /// <summary>\n+        /// Tests that read operations lock keys in Serializable mode.\n+        /// </summary>\n+        private void TestTransactionScopeWithSerializableIsolationLocksKeysOnRead(\n+            Func<ICache<int, int>, int, int> readOp)\n+        {\n+            var cache = Cache();\n+            cache.Put(1, 1);\n+\n+            var options = new TransactionOptions {IsolationLevel = IsolationLevel.Serializable};\n+\n+            using (var scope = new TransactionScope(TransactionScopeOption.Required, options))\n+            {\n+                Assert.AreEqual(1, readOp(cache, 1));\n+\n+                var taskFinished = Task.Factory.StartNew(() => cache.Put(1, 2)).Wait(TimeSpan.FromSeconds(1));\n+", "originalCommit": "86936946ac1cfb872af69ac90ae059a6d01d39db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM0MTU4Nw==", "url": "https://github.com/apache/ignite/pull/8004#discussion_r451341587", "bodyText": "Or just check that transaction is started.", "author": "gurustron", "createdAt": "2020-07-08T07:34:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTEyNzAzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ5NzcxOQ==", "url": "https://github.com/apache/ignite/pull/8004#discussion_r451497719", "bodyText": "Good point, I've added current Tx check, and replaced time-based wait with a wait handle.\nBut I'd like to keep the logic that checks whether keys are locked.\nOptimistic transactions are a different matter, we can have a separate test for them.", "author": "ptupitsyn", "createdAt": "2020-07-08T12:15:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTEyNzAzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTg0MTM4OQ==", "url": "https://github.com/apache/ignite/pull/8004#discussion_r451841389", "bodyText": "I've added more tests for Optimistic transactions, please have a look.", "author": "ptupitsyn", "createdAt": "2020-07-08T21:41:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTEyNzAzOQ=="}], "type": "inlineReview"}, {"oid": "986f81f486818bb891d00bed402f86c7bbc79394", "url": "https://github.com/apache/ignite/commit/986f81f486818bb891d00bed402f86c7bbc79394", "message": "Merge branch 'master' into ignite-13214", "committedDate": "2020-07-08T09:40:33Z", "type": "commit"}, {"oid": "da47075540bbb147848f4f020d7fbeb1faf7c2de", "url": "https://github.com/apache/ignite/commit/da47075540bbb147848f4f020d7fbeb1faf7c2de", "message": "Improve TestTransactionScopeWithSerializableIsolationLocksKeysOnRead according to review", "committedDate": "2020-07-08T12:15:54Z", "type": "commit"}, {"oid": "681279a043753374765af35fed42f672d0d9856c", "url": "https://github.com/apache/ignite/commit/681279a043753374765af35fed42f672d0d9856c", "message": "Add OptimisticTransactionTest (in progress)", "committedDate": "2020-07-08T12:26:06Z", "type": "commit"}, {"oid": "5c6cf83a51286fb0a73ddb6f37ab6ff75fa04173", "url": "https://github.com/apache/ignite/commit/5c6cf83a51286fb0a73ddb6f37ab6ff75fa04173", "message": "TestExplicitOptimisticTransactionThrowsExceptionOnConflict done", "committedDate": "2020-07-08T12:43:17Z", "type": "commit"}, {"oid": "de7e2df6c620330be980de28d7dc2f7dff16ebe1", "url": "https://github.com/apache/ignite/commit/de7e2df6c620330be980de28d7dc2f7dff16ebe1", "message": "Add TestAmbientOptimisticTransactionThrowsExceptionOnConflict", "committedDate": "2020-07-08T12:45:23Z", "type": "commit"}, {"oid": "984e6e385427ab2c59ab16461dea1b1192b4ad26", "url": "https://github.com/apache/ignite/commit/984e6e385427ab2c59ab16461dea1b1192b4ad26", "message": "Add .NET conversion for IgniteTxOptimisticCheckedException", "committedDate": "2020-07-08T12:55:29Z", "type": "commit"}, {"oid": "85259881ba837d31f84217af2c2098debb183ee7", "url": "https://github.com/apache/ignite/commit/85259881ba837d31f84217af2c2098debb183ee7", "message": "Fix TestAmbientOptimisticTransactionThrowsOptimisticExceptionOnConflict", "committedDate": "2020-07-08T13:07:02Z", "type": "commit"}, {"oid": "6996124c7b74f39a166cc7e24080e1186ddaa93d", "url": "https://github.com/apache/ignite/commit/6996124c7b74f39a166cc7e24080e1186ddaa93d", "message": "Update TestAmbientOptimisticTransactionThrowsOptimisticExceptionOnConflict to check for dispose transaction", "committedDate": "2020-07-08T13:10:33Z", "type": "commit"}, {"oid": "31d80d4f6b29a369660b38f80866c8bd7c031e93", "url": "https://github.com/apache/ignite/commit/31d80d4f6b29a369660b38f80866c8bd7c031e93", "message": "Fix cleanup of Ignite transaction on commit failure", "committedDate": "2020-07-08T21:35:39Z", "type": "commit"}, {"oid": "7ad335e4a1a9603a8aeb67e99753b2d910a5305d", "url": "https://github.com/apache/ignite/commit/7ad335e4a1a9603a8aeb67e99753b2d910a5305d", "message": "Fix cleanup of Ignite transaction on commit failure", "committedDate": "2020-07-08T21:36:20Z", "type": "commit"}, {"oid": "6ea28c05f6991a7908a298fd0ba0a2da511ef173", "url": "https://github.com/apache/ignite/commit/6ea28c05f6991a7908a298fd0ba0a2da511ef173", "message": "Merge branch 'master' into ignite-13214", "committedDate": "2020-07-09T09:11:25Z", "type": "commit"}, {"oid": "8408bc93a143efd43ead6b2cb8bda7f8e87537c6", "url": "https://github.com/apache/ignite/commit/8408bc93a143efd43ead6b2cb8bda7f8e87537c6", "message": "Merge branch 'master' into ignite-13214", "committedDate": "2020-07-09T09:54:08Z", "type": "commit"}, {"oid": "9775f08d5847ec436e54f5fb29d3b940b5c18f68", "url": "https://github.com/apache/ignite/commit/9775f08d5847ec436e54f5fb29d3b940b5c18f68", "message": "cleanup", "committedDate": "2020-07-09T10:15:34Z", "type": "commit"}, {"oid": "2ba39daecec9a6018878296cce081be11e78afc6", "url": "https://github.com/apache/ignite/commit/2ba39daecec9a6018878296cce081be11e78afc6", "message": "Move StartTxIfNeeded() calls before NearCache checks", "committedDate": "2020-07-09T10:37:47Z", "type": "commit"}, {"oid": "c725d9ad9f0388c9a986edfe4b78c3ea7a925635", "url": "https://github.com/apache/ignite/commit/c725d9ad9f0388c9a986edfe4b78c3ea7a925635", "message": "Remove current enlistment check from transaction manager", "committedDate": "2020-07-09T11:59:51Z", "type": "commit"}]}