{"pr_number": 8150, "pr_title": "IGNITE-13354 Add ClusterMetrics to the new framework", "pr_createdAt": "2020-08-13T15:16:08Z", "pr_url": "https://github.com/apache/ignite/pull/8150", "timeline": [{"oid": "3aa8b90f77fb388982c0413c68194dbffc856046", "url": "https://github.com/apache/ignite/commit/3aa8b90f77fb388982c0413c68194dbffc856046", "message": "Add new metrics. With jmx deprecation", "committedDate": "2020-08-13T14:02:12Z", "type": "commit"}, {"oid": "cb738a5e01d229de3e4ef451897d9540e1a717e1", "url": "https://github.com/apache/ignite/commit/cb738a5e01d229de3e4ef451897d9540e1a717e1", "message": "Fix deprecation. Add tests", "committedDate": "2020-08-13T15:12:44Z", "type": "commit"}, {"oid": "47e529415f3cb19aaed109219e8ed1b0a3c623f8", "url": "https://github.com/apache/ignite/commit/47e529415f3cb19aaed109219e8ed1b0a3c623f8", "message": "Fix node stopping/client disconnected cases", "committedDate": "2020-08-13T17:17:53Z", "type": "commit"}, {"oid": "ca44839c4c9df3787d6be8527626e09fe686b319", "url": "https://github.com/apache/ignite/commit/ca44839c4c9df3787d6be8527626e09fe686b319", "message": "Remove TotalNodes metric", "committedDate": "2020-08-14T10:41:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU4NTM0MA==", "url": "https://github.com/apache/ignite/pull/8150#discussion_r470585340", "bodyText": "Can we use this metric and all below inside ClusterMetricsMXBeanImpl to keep single method to calculate metric value.", "author": "nizhikov", "createdAt": "2020-08-14T12:09:43Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cluster/ClusterProcessor.java", "diffHunk": "@@ -607,6 +610,33 @@ private Boolean findLastFlag(Collection<Serializable> vals) {\n                 U.error(log, \"Failed to register MBean for cluster: \", e);\n             }\n         }\n+\n+        MetricRegistry reg = ctx.metric().registry(CLUSTER_METRICS);\n+\n+        reg.register(\"TopologyVersion\",", "originalCommit": "ca44839c4c9df3787d6be8527626e09fe686b319", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDYwNTQzNw==", "url": "https://github.com/apache/ignite/pull/8150#discussion_r470605437", "bodyText": "We can use this metrics for the ClusterMetricsMXBeanImpl implementation. But not for the ClusterLocalNodeMetricsMXBeanImpl.\nMoreover metrics registration should be placed between starting GridMetricManager and beans registration. For example, in the IgniteKernal#registerMetrics()", "author": "NSAmelchev", "createdAt": "2020-08-14T12:54:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU4NTM0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU4Njg1Ng==", "url": "https://github.com/apache/ignite/pull/8150#discussion_r470586856", "bodyText": "Let's use merg.<IntMetrics>findMetric(\"XXX\").value() to avoid type casting.", "author": "nizhikov", "createdAt": "2020-08-14T12:13:14Z", "path": "modules/core/src/test/java/org/apache/ignite/internal/ClusterBaselineNodesMetricsSelfTest.java", "diffHunk": "@@ -82,9 +92,13 @@ public void testBaselineNodes() throws Exception {\n         log.info(String.format(\">>> State #1: topology version = %d\", ignite0.cluster().topologyVersion()));\n \n         assertEquals(2, mxBeanCluster.getTotalServerNodes());\n+        assertEquals(2, ((IntMetric)mreg.findMetric(\"TotalServerNodes\")).value());", "originalCommit": "ca44839c4c9df3787d6be8527626e09fe686b319", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDYwNzg5NA==", "url": "https://github.com/apache/ignite/pull/8150#discussion_r470607894", "bodyText": "Fixed.", "author": "NSAmelchev", "createdAt": "2020-08-14T12:59:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU4Njg1Ng=="}], "type": "inlineReview"}, {"oid": "d79d2c73cd3a0409dc9130fe639ec36e596b05ba", "url": "https://github.com/apache/ignite/commit/d79d2c73cd3a0409dc9130fe639ec36e596b05ba", "message": "Avoid type casting", "committedDate": "2020-08-14T12:56:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDYxNTI2Nw==", "url": "https://github.com/apache/ignite/pull/8150#discussion_r470615267", "bodyText": "Let's return final modifier.", "author": "nizhikov", "createdAt": "2020-08-14T13:13:16Z", "path": "modules/core/src/test/java/org/apache/ignite/internal/ClusterNodeMetricsSelfTest.java", "diffHunk": "@@ -310,7 +314,7 @@ public void testIoMetrics() throws Exception {\n      */\n     @Test\n     public void testClusterNodeMetrics() throws Exception {\n-        final Ignite ignite0 = grid();\n+        IgniteEx ignite0 = grid();", "originalCommit": "d79d2c73cd3a0409dc9130fe639ec36e596b05ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDYyMDczNg==", "url": "https://github.com/apache/ignite/pull/8150#discussion_r470620736", "bodyText": "Reverted.", "author": "NSAmelchev", "createdAt": "2020-08-14T13:23:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDYxNTI2Nw=="}], "type": "inlineReview"}, {"oid": "8ce7d53fc78659517e4dd5e9b0326233d09bf956", "url": "https://github.com/apache/ignite/commit/8ce7d53fc78659517e4dd5e9b0326233d09bf956", "message": "Revert final var", "committedDate": "2020-08-14T13:22:55Z", "type": "commit"}, {"oid": "f5dea474d39b010cb824b70b2bdce05b7893ca34", "url": "https://github.com/apache/ignite/commit/f5dea474d39b010cb824b70b2bdce05b7893ca34", "message": "Reuse metrics", "committedDate": "2020-08-14T13:47:12Z", "type": "commit"}, {"oid": "3e9471b156e7b02a91f8d98e433d9c9789d1307a", "url": "https://github.com/apache/ignite/commit/3e9471b156e7b02a91f8d98e433d9c9789d1307a", "message": "Remove deprecated. Use separate method for metrics registration", "committedDate": "2020-08-14T14:26:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMxMTEwNQ==", "url": "https://github.com/apache/ignite/pull/8150#discussion_r471311105", "bodyText": "Let's remove this metric from new framework.\n\"CurrentTopologyVersion\" would be added by the #8145 in the \"io.discovery\" registry.", "author": "nizhikov", "createdAt": "2020-08-17T08:07:59Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/ClusterMetricsMXBeanImpl.java", "diffHunk": "@@ -47,13 +54,37 @@\n     /** Cluster metrics update mutex. */\n     private final Object clusterMetricsMux = new Object();\n \n+    /** Topology version metric. */\n+    private final LongMetric topVer;", "originalCommit": "3e9471b156e7b02a91f8d98e433d9c9789d1307a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM1NTU5NA==", "url": "https://github.com/apache/ignite/pull/8150#discussion_r471355594", "bodyText": "Done.", "author": "NSAmelchev", "createdAt": "2020-08-17T09:29:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMxMTEwNQ=="}], "type": "inlineReview"}, {"oid": "92828f0527cc159ca0d012eae53dddb7f6fb6637", "url": "https://github.com/apache/ignite/commit/92828f0527cc159ca0d012eae53dddb7f6fb6637", "message": "Revert TopologyVersion", "committedDate": "2020-08-17T09:27:40Z", "type": "commit"}, {"oid": "e4f68562b57ddebc512ad9e197d467700a0de1d7", "url": "https://github.com/apache/ignite/commit/e4f68562b57ddebc512ad9e197d467700a0de1d7", "message": "Move metrics registration", "committedDate": "2020-08-17T09:55:03Z", "type": "commit"}, {"oid": "41abe9acd173837ca98b1ac6ffd5c1b5f008bea7", "url": "https://github.com/apache/ignite/commit/41abe9acd173837ca98b1ac6ffd5c1b5f008bea7", "message": "Move metrics registration 2", "committedDate": "2020-08-17T12:21:21Z", "type": "commit"}]}