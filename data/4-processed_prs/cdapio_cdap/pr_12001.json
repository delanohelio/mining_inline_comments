{"pr_number": 12001, "pr_title": "(CDAP-16353) Make ProperitesResolver use PreferencesFetcher to get properties", "pr_createdAt": "2020-03-26T23:53:47Z", "pr_url": "https://github.com/cdapio/cdap/pull/12001", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3ODExMg==", "url": "https://github.com/cdapio/cdap/pull/12001#discussion_r398978112", "bodyText": "I think preview should use remote?", "author": "yaojiefeng", "createdAt": "2020-03-27T00:59:41Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/app/preview/DefaultPreviewRunnerModule.java", "diffHunk": "@@ -162,6 +164,8 @@ protected void configure() {\n     expose(OwnerAdmin.class);\n \n     bind(PreviewRequest.class).toInstance(previewRequest);\n+\n+    bind(PreferencesFetcher.class).to(LocalPreferencesFetcherInternal.class).in(Scopes.SINGLETON);", "originalCommit": "97651f545ba62f7f0b9a44ae65c820309871b43f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk5MjkwMw==", "url": "https://github.com/cdapio/cdap/pull/12001#discussion_r398992903", "bodyText": "That change comes in the next PR :), this PR ensure there is no behavior change.\nThe plan is\nif cloudsql => bind to local, so same as today\nif nosql => bind to remote", "author": "wyzhang", "createdAt": "2020-03-27T01:56:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3ODExMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3OTEzNA==", "url": "https://github.com/cdapio/cdap/pull/12001#discussion_r398979134", "bodyText": "Better not changing the behavior, these existence check is fairly common in our http handler. The pref store is only responsible for fetch/put data, it is handler's responsibility to validate the existence of entity. If an entity doesn't exist, it is no point to return the preferences since we delete the preferences whenever a program is deleted.", "author": "yaojiefeng", "createdAt": "2020-03-27T01:03:55Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/gateway/handlers/PreferencesHttpHandlerInternal.java", "diffHunk": "@@ -77,9 +72,7 @@ public void getNamespacePreferences(HttpRequest request, HttpResponder responder\n                                       @PathParam(\"namespace-id\") String namespace,\n                                       @QueryParam(\"resolved\") boolean resolved) throws Exception {\n     NamespaceId namespaceId = new NamespaceId(namespace);\n-    if (!namespaceQueryAdmin.exists(namespaceId)) {\n-      throw new NamespaceNotFoundException(namespaceId);\n-    }\n+    // No need to check if namespace exists. PreferencesService returns an empty PreferencesDetail when that happens.", "originalCommit": "97651f545ba62f7f0b9a44ae65c820309871b43f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk5NjAxOA==", "url": "https://github.com/cdapio/cdap/pull/12001#discussion_r398996018", "bodyText": "Context is:\nThis preferences http handler was recently introduced to support per-service local levelDB and it is currently not used anywhere. So changing the behavior will not cause any regression.\nAs for validating entity existence, in general I agree with failing if entity doesn't exist. But I think it might make sense for preferences for 2 reasons:\n\npreferences support \"resolve\", so if the app doesn't exist, caller might want get resolved properties from parents.\npreview deploys apps locally and fetch resolved preferences before run the preview. I think that fetch returns properties from parent as the app is not deployed to appfabric. To achieve the same effect, remote preferences fetch have to handle the entity non-existence case", "author": "wyzhang", "createdAt": "2020-03-27T02:09:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3OTEzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTY4NzExNQ==", "url": "https://github.com/cdapio/cdap/pull/12001#discussion_r399687115", "bodyText": "I agree that the remote and local implementations should have the same behavior. Failing on namespace not exists would actually be the backwards incompatible behavior in this case. Have we made sure the other internal endpoints would behave the same as their local counterparts?\nCan you add some javadocs for the method that explain the contract? Otherwise it is very easy to look at this class and think it should be checking for existence like all the other handlers.", "author": "albertshau", "createdAt": "2020-03-28T17:24:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3OTEzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTcwNjMyMQ==", "url": "https://github.com/cdapio/cdap/pull/12001#discussion_r399706321", "bodyText": "Done.\nAdded javadoc to call it out that request won't fail in the case of non-existing entity.\nLet me refactor the test for local and remote in the next PR to have a parameterized test to ensure local vs remote goes through exact same test cases to validate the same behavior (i.e. similar to what I did in #12007 for testing local vs remote ScheduleFetcher)", "author": "wyzhang", "createdAt": "2020-03-28T20:32:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3OTEzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTcwODg2OQ==", "url": "https://github.com/cdapio/cdap/pull/12001#discussion_r399708869", "bodyText": "@albertshau the problem is in local http handler we do check the existence of the entity, it is not in PreferencesService but in the actually handler. I don't think we should remove it here since it will cause confusion in the future in case there is some step involving getting preferences.\nPreview actually deploys app first and then call the run program method, I believe we get preferences when we actually run the program, at this step, all the entities should already be there. If the check of existence fails there, it means a bug in the app deploy or preview.", "author": "yaojiefeng", "createdAt": "2020-03-28T20:59:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3OTEzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTcxMDE5Nw==", "url": "https://github.com/cdapio/cdap/pull/12001#discussion_r399710197", "bodyText": "Ah, I see the changes in PropertiesResolver, seems like this is only used there? Then it is fine to remove the existence check to keep the functionality same. Please ignore my previous comment", "author": "yaojiefeng", "createdAt": "2020-03-28T21:13:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3OTEzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTcyMTc3NQ==", "url": "https://github.com/cdapio/cdap/pull/12001#discussion_r399721775", "bodyText": "Yes. PreferencesFetcher is used in propertiesResolver only at the moment. But metadata service will use it as well in the future (to switch from local store access to REST calls)\n@yaojiefeng \"in local http handler we do check the existence of the entity\", I think you are referring to public http handler for preference. Also note that public endpoints return property map while internal ones return PreferencesDetail.", "author": "wyzhang", "createdAt": "2020-03-28T23:25:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3OTEzNA=="}], "type": "inlineReview"}, {"oid": "b729b77281d712fc35a6955a3cf4091f22531221", "url": "https://github.com/cdapio/cdap/commit/b729b77281d712fc35a6955a3cf4091f22531221", "message": "(CDAP-16353) Make ProperitesResolver using PreferencesFetcher to get preference properites.\n\nMotivation:\nAt the moment, ProperitesResolver directly accesses local preferences store.\nChange that to use PreferencesFetcher allows us to fetch properties either from\nlocal storage or from a remote service via REST calls. This paves the path for\nsupport per service local level DB.\n\nAdditional changes:\n- Make PreferencesHttpHandler to return empty properties instead of fail if the\n  requested entity (e.g. program, or applciation) doesn't exist, for 2 reasons\n  1) consistent with the behavior of preferences store\n  2) user may request resolved properties for a program, which will include\n     properites from parents (e.g. application, namespace and instance). Even\n     through the program doesn't exist, it would be good to return resolved\n     properties from its parent and above.", "committedDate": "2020-03-28T20:34:57Z", "type": "commit"}, {"oid": "b729b77281d712fc35a6955a3cf4091f22531221", "url": "https://github.com/cdapio/cdap/commit/b729b77281d712fc35a6955a3cf4091f22531221", "message": "(CDAP-16353) Make ProperitesResolver using PreferencesFetcher to get preference properites.\n\nMotivation:\nAt the moment, ProperitesResolver directly accesses local preferences store.\nChange that to use PreferencesFetcher allows us to fetch properties either from\nlocal storage or from a remote service via REST calls. This paves the path for\nsupport per service local level DB.\n\nAdditional changes:\n- Make PreferencesHttpHandler to return empty properties instead of fail if the\n  requested entity (e.g. program, or applciation) doesn't exist, for 2 reasons\n  1) consistent with the behavior of preferences store\n  2) user may request resolved properties for a program, which will include\n     properites from parents (e.g. application, namespace and instance). Even\n     through the program doesn't exist, it would be good to return resolved\n     properties from its parent and above.", "committedDate": "2020-03-28T20:34:57Z", "type": "forcePushed"}]}