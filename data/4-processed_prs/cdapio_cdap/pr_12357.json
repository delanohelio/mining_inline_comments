{"pr_number": 12357, "pr_title": "[CDAP-16891] Upgrading pipeline drafts", "pr_createdAt": "2020-06-17T17:00:07Z", "pr_url": "https://github.com/cdapio/cdap/pull/12357", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc0MzY2Mg==", "url": "https://github.com/cdapio/cdap/pull/12357#discussion_r441743662", "bodyText": "nit: space after if. Aren't this being caught by linter? are you running gulp watch?", "author": "elfenheart", "createdAt": "2020-06-17T18:26:27Z", "path": "cdap-ui/app/hydrator/controllers/create/create-studio-ctrl.js", "diffHunk": "@@ -76,6 +76,9 @@ class HydratorPlusPlusStudioCtrl {\n       let config = {};\n       config.artifact = artifact;\n       HydratorPlusPlusConfigActions.initializeConfigStore(config);\n+      if(rConfig.upgrade){", "originalCommit": "34c09f1e06f6046813e22765ef650aa34337dcd8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgzOTM1Mw==", "url": "https://github.com/cdapio/cdap/pull/12357#discussion_r441839353", "bodyText": "I have gulp watch running, linter is not complaining about these", "author": "itsanudeep", "createdAt": "2020-06-17T21:16:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc0MzY2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc0MzkxNw==", "url": "https://github.com/cdapio/cdap/pull/12357#discussion_r441743917", "bodyText": "nit space after bracket", "author": "elfenheart", "createdAt": "2020-06-17T18:26:55Z", "path": "cdap-ui/app/hydrator/routes.js", "diffHunk": "@@ -106,9 +106,9 @@ angular.module(PKG.name + '.feature.hydrator')\n                 if (isVersionInRange) {\n                   $stateParams.data.artifact.version = rCDAPVersion;\n                 } else {\n-                  defer.resolve(false);\n+                  defer.resolve({ valid: false });\n                 }\n-                defer.resolve($stateParams.data);\n+                defer.resolve({config: $stateParams.data, valid: true});", "originalCommit": "34c09f1e06f6046813e22765ef650aa34337dcd8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc0NDA4OQ==", "url": "https://github.com/cdapio/cdap/pull/12357#discussion_r441744089", "bodyText": "space after ()", "author": "elfenheart", "createdAt": "2020-06-17T18:27:14Z", "path": "cdap-ui/app/hydrator/services/hydrator-upgrade-service.js", "diffHunk": "@@ -287,6 +287,9 @@ class HydratorUpgradeService {\n       resolve: {\n         rPipelineConfig: function () {\n           return jsonData;\n+        },\n+        rIsImport: function(){", "originalCommit": "34c09f1e06f6046813e22765ef650aa34337dcd8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc0NDI3NA==", "url": "https://github.com/cdapio/cdap/pull/12357#discussion_r441744274", "bodyText": "space after bracket", "author": "elfenheart", "createdAt": "2020-06-17T18:27:32Z", "path": "cdap-ui/app/hydrator/templates/create/pipeline-upgrade-modal.html", "diffHunk": "@@ -15,7 +15,8 @@\n -->\n \n <div class=\"modal-header\">\n-  <h3 class=\"modal-title pull-left\">Import Pipeline</h3>\n+  <h3 class=\"modal-title pull-left\" data-cy=\"upgrade-modal-header\">\n+    {{PipelineUpgradeController.isUpgrade ? \"Import Pipeline\" : \"Upgrade Pipeline\"}}</h3>", "originalCommit": "34c09f1e06f6046813e22765ef650aa34337dcd8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc0NDMyMw==", "url": "https://github.com/cdapio/cdap/pull/12357#discussion_r441744323", "bodyText": "space after bracket", "author": "elfenheart", "createdAt": "2020-06-17T18:27:37Z", "path": "cdap-ui/app/hydrator/templates/create/pipeline-upgrade-modal.html", "diffHunk": "@@ -35,9 +37,10 @@ <h3 class=\"text-xs-center\">\n <div\n   class=\"modal-body\"\n   ng-if=\"!PipelineUpgradeController.loading\"\n+  data-cy=\"upgrade-modal-body\"\n >\n   <h4 ng-if=\"PipelineUpgradeController.missingArtifactStages.length > 0 || PipelineUpgradeController.problematicStages.length > 0 || PipelineUpgradeController.problematicPostRunActions.length > 0 || PipelineUpgradeController.missingArtifactPostRunActions.length > 0\">\n-    Your pipeline cannot be imported because of the following issues:\n+    {{PipelineUpgradeController.isUpgrade ? \"Your pipeline cannot be imported because of the following issues:\" : \"Your pipeline has the following issues:\"}}", "originalCommit": "34c09f1e06f6046813e22765ef650aa34337dcd8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc0NDYwMA==", "url": "https://github.com/cdapio/cdap/pull/12357#discussion_r441744600", "bodyText": "space after bracket", "author": "elfenheart", "createdAt": "2020-06-17T18:28:04Z", "path": "cdap-ui/cypress/helpers.ts", "diffHunk": "@@ -117,4 +119,22 @@ function deployAndTestPipeline(filename, pipelineName, done) {\n     .then(() => done());\n }\n \n-export { loginIfRequired, getArtifactsPoll, deployAndTestPipeline, getSessionToken };\n+function dataCy(property) {\n+  return `[data-cy=\"${property}\"]`;\n+}\n+\n+function generateDraftFromPipeline(pipeline) {\n+  return cy.fixture(pipeline).then(pipeline1 => {\n+    const draftId = uuidV4();\n+    const pipelineName = `${pipeline1.name}-${Date.now()}`;\n+    pipeline1['__ui__'] = {draftId, lastSaved: '2019-06-10T16:57:34.559Z'};", "originalCommit": "34c09f1e06f6046813e22765ef650aa34337dcd8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc0NTA0MA==", "url": "https://github.com/cdapio/cdap/pull/12357#discussion_r441745040", "bodyText": "lastSaved Date.now()", "author": "elfenheart", "createdAt": "2020-06-17T18:28:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc0NDYwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc0NDY0Nw==", "url": "https://github.com/cdapio/cdap/pull/12357#discussion_r441744647", "bodyText": "remove", "author": "elfenheart", "createdAt": "2020-06-17T18:28:11Z", "path": "cdap-ui/cypress/helpers.ts", "diffHunk": "@@ -117,4 +119,22 @@ function deployAndTestPipeline(filename, pipelineName, done) {\n     .then(() => done());\n }\n \n-export { loginIfRequired, getArtifactsPoll, deployAndTestPipeline, getSessionToken };\n+function dataCy(property) {\n+  return `[data-cy=\"${property}\"]`;\n+}\n+\n+function generateDraftFromPipeline(pipeline) {\n+  return cy.fixture(pipeline).then(pipeline1 => {\n+    const draftId = uuidV4();\n+    const pipelineName = `${pipeline1.name}-${Date.now()}`;\n+    pipeline1['__ui__'] = {draftId, lastSaved: '2019-06-10T16:57:34.559Z'};\n+    pipeline1.name = pipelineName;\n+    const pipelineDraft = {\n+      'hydratorDrafts': {'default': {[draftId]: pipeline1}}\n+    };\n+    console.log(\"draftid\",pipeline1);", "originalCommit": "34c09f1e06f6046813e22765ef650aa34337dcd8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc0NDc2MA==", "url": "https://github.com/cdapio/cdap/pull/12357#discussion_r441744760", "bodyText": "unnecessary quotes", "author": "elfenheart", "createdAt": "2020-06-17T18:28:25Z", "path": "cdap-ui/cypress/helpers.ts", "diffHunk": "@@ -117,4 +119,22 @@ function deployAndTestPipeline(filename, pipelineName, done) {\n     .then(() => done());\n }\n \n-export { loginIfRequired, getArtifactsPoll, deployAndTestPipeline, getSessionToken };\n+function dataCy(property) {\n+  return `[data-cy=\"${property}\"]`;\n+}\n+\n+function generateDraftFromPipeline(pipeline) {\n+  return cy.fixture(pipeline).then(pipeline1 => {\n+    const draftId = uuidV4();\n+    const pipelineName = `${pipeline1.name}-${Date.now()}`;\n+    pipeline1['__ui__'] = {draftId, lastSaved: '2019-06-10T16:57:34.559Z'};\n+    pipeline1.name = pipelineName;\n+    const pipelineDraft = {\n+      'hydratorDrafts': {'default': {[draftId]: pipeline1}}", "originalCommit": "34c09f1e06f6046813e22765ef650aa34337dcd8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc0NTIyMA==", "url": "https://github.com/cdapio/cdap/pull/12357#discussion_r441745220", "bodyText": "make quotes consistent with single quotes", "author": "elfenheart", "createdAt": "2020-06-17T18:29:17Z", "path": "cdap-ui/cypress/integration/pipeline.upgrade.spec.ts", "diffHunk": "@@ -70,4 +72,25 @@ describe('Pipeline Upgrade should work fine', () => {\n       cy.contains('Hub');\n     });\n   });\n+\n+  it(\"should upgrade pipelines that are saved in drafts\", () => {\n+\n+    generateDraftFromPipeline('pipeline1.json').then(({ pipelineDraft, pipelineName }) => {\n+      cy.upload_draft_via_api(headers, pipelineDraft);\n+      cy.visit(\"/cdap/ns/default/pipelines/drafts\");", "originalCommit": "34c09f1e06f6046813e22765ef650aa34337dcd8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc0NTMyNA==", "url": "https://github.com/cdapio/cdap/pull/12357#discussion_r441745324", "bodyText": "space after brackets", "author": "elfenheart", "createdAt": "2020-06-17T18:29:27Z", "path": "cdap-ui/cypress/integration/pipeline.upgrade.spec.ts", "diffHunk": "@@ -15,6 +15,8 @@\n  */\n \n import * as Helpers from '../helpers';\n+import {dataCy, generateDraftFromPipeline} from '../helpers';", "originalCommit": "34c09f1e06f6046813e22765ef650aa34337dcd8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg0NTM5OA==", "url": "https://github.com/cdapio/cdap/pull/12357#discussion_r441845398", "bodyText": "not sure why my comment disappeared on this one..\nWhy is valid: false in here? what is considered valid? If you already have a flag for upgrade, can we just simply use that instead of adding another flag?", "author": "elfenheart", "createdAt": "2020-06-17T21:30:06Z", "path": "cdap-ui/app/hydrator/routes.js", "diffHunk": "@@ -125,52 +128,52 @@ angular.module(PKG.name + '.feature.hydrator')\n                       if (isVersionInRange) {\n                         draft.artifact.version = rCDAPVersion;\n                       } else {\n-                        defer.resolve(false);\n+                        defer.resolve({ valid: false, config: draft, upgrade: true });", "originalCommit": "06344c9f48992a42a59ab71f0af7990647d6db09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg3NDEzOQ==", "url": "https://github.com/cdapio/cdap/pull/12357#discussion_r441874139", "bodyText": "We used to resolve false to indicate that the configuration is invalid/when an error occurs. If we remove this field altogether, we would miss cases where it's not really a pipeline upgrade/import but an error like when parsing JSON.\nI can rename it as validConfig to make it more readable if you think that helps, please let me know.", "author": "itsanudeep", "createdAt": "2020-06-17T22:45:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg0NTM5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkwMzYwOA==", "url": "https://github.com/cdapio/cdap/pull/12357#discussion_r441903608", "bodyText": "why do we only want to delete this on import?", "author": "elfenheart", "createdAt": "2020-06-18T00:28:31Z", "path": "cdap-ui/app/hydrator/controllers/create/partials/pipelineupgrade-modal-ctrl.js", "diffHunk": "@@ -147,7 +148,7 @@ angular.module(PKG.name + '.feature.hydrator')\n       newConfig.config.stages = stages;\n       newConfig.config.postActions = postActions;\n \n-      if (newConfig.__ui__) {\n+      if (newConfig.__ui__ && this.isImport) {", "originalCommit": "06344c9f48992a42a59ab71f0af7990647d6db09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkwODEwMQ==", "url": "https://github.com/cdapio/cdap/pull/12357#discussion_r441908101", "bodyText": "We used to delete this every time we import and fix something. This was causing the draft that's already saved to change its id and causing it to save as a new draft. For upgrading a draft, we already have an id and do not need to delete the id. So, here we're excluding deletion of this property if it's an upgrade of a draft.", "author": "itsanudeep", "createdAt": "2020-06-18T00:46:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkwMzYwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkzMTQ4Ng==", "url": "https://github.com/cdapio/cdap/pull/12357#discussion_r441931486", "bodyText": "Changed the way we preserve the draftId - instead of not deleting __ui__ at all for upgrades, we now add any existing draftId back after we clear __ui__", "author": "itsanudeep", "createdAt": "2020-06-18T02:22:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkwMzYwOA=="}], "type": "inlineReview"}, {"oid": "0cbfbe39ccf52f22ad9c10cb2d29168ae4979921", "url": "https://github.com/cdapio/cdap/commit/0cbfbe39ccf52f22ad9c10cb2d29168ae4979921", "message": "rebasing and modal title change", "committedDate": "2020-06-18T00:35:28Z", "type": "forcePushed"}, {"oid": "098e40b3702bc2ee26c8145294c8eddbcf54a133", "url": "https://github.com/cdapio/cdap/commit/098e40b3702bc2ee26c8145294c8eddbcf54a133", "message": "upgrading drafts", "committedDate": "2020-06-18T04:36:58Z", "type": "commit"}, {"oid": "098e40b3702bc2ee26c8145294c8eddbcf54a133", "url": "https://github.com/cdapio/cdap/commit/098e40b3702bc2ee26c8145294c8eddbcf54a133", "message": "upgrading drafts", "committedDate": "2020-06-18T04:36:58Z", "type": "forcePushed"}]}