{"pr_number": 12465, "pr_title": "[CDAP-16682] System services delay notification", "pr_createdAt": "2020-07-16T15:53:52Z", "pr_url": "https://github.com/cdapio/cdap/pull/12465", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU5ODgyNg==", "url": "https://github.com/cdapio/cdap/pull/12465#discussion_r456598826", "bodyText": "nit: We don't need the ternary operator here (the equality should do the same thing).", "author": "yukiej", "createdAt": "2020-07-17T18:11:48Z", "path": "cdap-ui/app/cdap/components/Lab/index.tsx", "diffHunk": "@@ -58,34 +60,48 @@ const styles = (): StyleRules => {\n interface ILabProps extends WithStyles<typeof styles> {}\n interface IExperiment {\n   id: string;\n-  value: boolean;\n+  enabled: boolean;\n   screenshot: string | null;\n   name: string;\n   description: string;\n+  showValue?: boolean;\n+  valueLabel?: string;\n+  valueType?: string;\n }\n interface ILabState {\n   experiments: IExperiment[];\n }\n \n class Lab extends React.Component<ILabProps, ILabState> {\n-  public componentWillMount() {\n-    experimentsList.forEach((experiment) => {\n-      experiment.value = window.localStorage.getItem(experiment.id) === 'true' ? true : false;\n+  public componentDidMount() {\n+    experimentsList.forEach((experiment: IExperiment) => {\n+      // If experiment preference is present in storage, use it.\n+      // If not, use the default value and set it in storage and use it.\n+      const experimentStatusFromStorage = window.localStorage.getItem(experiment.id);\n+      if (experimentStatusFromStorage === null) {\n+        window.localStorage.setItem(experiment.id, experiment.enabled.toString());\n+      } else {\n+        experiment.enabled = experimentStatusFromStorage === 'true' ? true : false;", "originalCommit": "4990f00996d1bfb555638780de4323b9eeda98ca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYwMDAxMA==", "url": "https://github.com/cdapio/cdap/pull/12465#discussion_r456600010", "bodyText": "Why do we need to start the health check here as well as when the window is focused?", "author": "yukiej", "createdAt": "2020-07-17T18:14:22Z", "path": "cdap-ui/app/cdap/components/SystemServicesDelay/index.tsx", "diffHunk": "@@ -0,0 +1,187 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+import * as React from 'react';\n+import { connect, Provider } from 'react-redux';\n+import SystemDelayStore from 'services/SystemDelayStore';\n+import SystemDelayActions from 'services/SystemDelayStore/SystemDelayActions';\n+import Snackbar from '@material-ui/core/Snackbar';\n+import Button from '@material-ui/core/Button';\n+import ee from 'event-emitter';\n+import { WINDOW_ON_FOCUS, WINDOW_ON_BLUR } from 'services/WindowManager';\n+import { getExperimentValue, isExperimentEnabled } from 'services/helpers';\n+import DataSource from 'services/datasource';\n+import cloneDeep from 'lodash/cloneDeep';\n+import flatten from 'lodash/flatten';\n+\n+interface IBinding {\n+  resource: {\n+    id: string;\n+    requestTime: number;\n+  };\n+  type: string;\n+  checkAgainsLeft?: number;\n+}\n+\n+interface ISystemDelayProps {\n+  showDelay: boolean;\n+  activeDataSources: DataSource[];\n+}\n+\n+const EXPERIMENT_ID = 'system-delay-notification';\n+const HEALTH_CHECK_INTERVAL = 12000;\n+const DEFAULT_DELAY_TIME = 5000;\n+\n+class SystemServicesDelayView extends React.Component<ISystemDelayProps> {\n+  public state = { delayedBindings: [] };\n+  private healthCheckInterval: NodeJS.Timeout;\n+  private eventEmitter = ee(ee);\n+\n+  public componentDidMount() {\n+    if (isExperimentEnabled(EXPERIMENT_ID)) {\n+      this.checkForDelayedBindings();\n+    }\n+    this.startHealthCheck();", "originalCommit": "4990f00996d1bfb555638780de4323b9eeda98ca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc0MTE1MA==", "url": "https://github.com/cdapio/cdap/pull/12465#discussion_r457741150", "bodyText": "We stop this health check when user is not using the tab. We will resume the check when they're actively using again. Also, we would have to start health check on component mount to start the check right away instead of waiting for 12 seconds (default interval time).", "author": "itsanudeep", "createdAt": "2020-07-20T23:07:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYwMDAxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYwMTQ0MQ==", "url": "https://github.com/cdapio/cdap/pull/12465#discussion_r456601441", "bodyText": "It looks like delayedBindings should be an object? Relatedly (if that is a word), it might be helpful to define an interface for bindings.", "author": "yukiej", "createdAt": "2020-07-17T18:17:23Z", "path": "cdap-ui/app/cdap/components/SystemServicesDelay/index.tsx", "diffHunk": "@@ -0,0 +1,187 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+import * as React from 'react';\n+import { connect, Provider } from 'react-redux';\n+import SystemDelayStore from 'services/SystemDelayStore';\n+import SystemDelayActions from 'services/SystemDelayStore/SystemDelayActions';\n+import Snackbar from '@material-ui/core/Snackbar';\n+import Button from '@material-ui/core/Button';\n+import ee from 'event-emitter';\n+import { WINDOW_ON_FOCUS, WINDOW_ON_BLUR } from 'services/WindowManager';\n+import { getExperimentValue, isExperimentEnabled } from 'services/helpers';\n+import DataSource from 'services/datasource';\n+import cloneDeep from 'lodash/cloneDeep';\n+import flatten from 'lodash/flatten';\n+\n+interface IBinding {\n+  resource: {\n+    id: string;\n+    requestTime: number;\n+  };\n+  type: string;\n+  checkAgainsLeft?: number;\n+}\n+\n+interface ISystemDelayProps {\n+  showDelay: boolean;\n+  activeDataSources: DataSource[];\n+}\n+\n+const EXPERIMENT_ID = 'system-delay-notification';\n+const HEALTH_CHECK_INTERVAL = 12000;\n+const DEFAULT_DELAY_TIME = 5000;\n+\n+class SystemServicesDelayView extends React.Component<ISystemDelayProps> {\n+  public state = { delayedBindings: [] };", "originalCommit": "4990f00996d1bfb555638780de4323b9eeda98ca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc0MTIwOQ==", "url": "https://github.com/cdapio/cdap/pull/12465#discussion_r457741209", "bodyText": "fixed", "author": "itsanudeep", "createdAt": "2020-07-20T23:07:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYwMTQ0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYwNTk2NA==", "url": "https://github.com/cdapio/cdap/pull/12465#discussion_r456605964", "bodyText": "nit: don't need ternary operator here", "author": "yukiej", "createdAt": "2020-07-17T18:26:53Z", "path": "cdap-ui/app/cdap/services/helpers.js", "diffHunk": "@@ -490,6 +490,14 @@ function connectWithStore(store, WrappedComponent, ...args) {\n   };\n }\n \n+function getExperimentValue(experimentID) {\n+  return window.localStorage.getItem(`${experimentID}-value`);\n+}\n+\n+function isExperimentEnabled(experimentID) {\n+  return window.localStorage.getItem(`${experimentID}`) === 'true' ? true : false;", "originalCommit": "4990f00996d1bfb555638780de4323b9eeda98ca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzUzMzg1MQ==", "url": "https://github.com/cdapio/cdap/pull/12465#discussion_r457533851", "bodyText": "it's better to rename this to be something more explicit like experimentId. id is ambiguous with html id attribute", "author": "elfenheart", "createdAt": "2020-07-20T16:19:25Z", "path": "cdap-ui/app/cdap/components/AppHeader/AppDrawer/AppDrawer.tsx", "diffHunk": "@@ -140,7 +140,7 @@ class AppDrawer extends React.PureComponent<IAppDrawerProps> {\n             id=\"navbar-home\"\n             isActive={location.pathname === `/cdap/${nsurl}`}\n           />\n-          <ExperimentalFeature name={'data-ingestion'}>\n+          <ExperimentalFeature id=\"data-ingestion\">", "originalCommit": "4990f00996d1bfb555638780de4323b9eeda98ca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc0MTI4Mw==", "url": "https://github.com/cdapio/cdap/pull/12465#discussion_r457741283", "bodyText": "fixed, renamed it to experimentId", "author": "itsanudeep", "createdAt": "2020-07-20T23:07:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzUzMzg1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU0MDkzMw==", "url": "https://github.com/cdapio/cdap/pull/12465#discussion_r457540933", "bodyText": "why do you need to filter? It's getting flatten, so empty array will just get ignored, right?", "author": "elfenheart", "createdAt": "2020-07-20T16:30:34Z", "path": "cdap-ui/app/cdap/components/SystemServicesDelay/index.tsx", "diffHunk": "@@ -0,0 +1,187 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+import * as React from 'react';\n+import { connect, Provider } from 'react-redux';\n+import SystemDelayStore from 'services/SystemDelayStore';\n+import SystemDelayActions from 'services/SystemDelayStore/SystemDelayActions';\n+import Snackbar from '@material-ui/core/Snackbar';\n+import Button from '@material-ui/core/Button';\n+import ee from 'event-emitter';\n+import { WINDOW_ON_FOCUS, WINDOW_ON_BLUR } from 'services/WindowManager';\n+import { getExperimentValue, isExperimentEnabled } from 'services/helpers';\n+import DataSource from 'services/datasource';\n+import cloneDeep from 'lodash/cloneDeep';\n+import flatten from 'lodash/flatten';\n+\n+interface IBinding {\n+  resource: {\n+    id: string;\n+    requestTime: number;\n+  };\n+  type: string;\n+  checkAgainsLeft?: number;\n+}\n+\n+interface ISystemDelayProps {\n+  showDelay: boolean;\n+  activeDataSources: DataSource[];\n+}\n+\n+const EXPERIMENT_ID = 'system-delay-notification';\n+const HEALTH_CHECK_INTERVAL = 12000;\n+const DEFAULT_DELAY_TIME = 5000;\n+\n+class SystemServicesDelayView extends React.Component<ISystemDelayProps> {\n+  public state = { delayedBindings: [] };\n+  private healthCheckInterval: NodeJS.Timeout;\n+  private eventEmitter = ee(ee);\n+\n+  public componentDidMount() {\n+    if (isExperimentEnabled(EXPERIMENT_ID)) {\n+      this.checkForDelayedBindings();\n+    }\n+    this.startHealthCheck();\n+    this.eventEmitter.on(WINDOW_ON_FOCUS, () => {\n+      this.startHealthCheck();\n+    });\n+    this.eventEmitter.on(WINDOW_ON_BLUR, () => {\n+      this.stopHealthCheck();\n+    });\n+  }\n+\n+  private startHealthCheck = () => {\n+    if (isExperimentEnabled(EXPERIMENT_ID)) {\n+      this.healthCheckInterval = setInterval(this.checkForDelayedBindings, HEALTH_CHECK_INTERVAL);\n+    }\n+  };\n+\n+  private checkForDelayedBindings = () => {\n+    const delayedTimeFromExperiment = getExperimentValue(EXPERIMENT_ID);\n+    const SERVICES_DELAYED_TIME = delayedTimeFromExperiment\n+      ? parseInt(delayedTimeFromExperiment, 10) * 1000\n+      : DEFAULT_DELAY_TIME;\n+    const activeBindings = flatten(\n+      this.props.activeDataSources\n+        .map((dataSource: DataSource) => dataSource.getBindings())\n+        .filter((bindings) => bindings.length > 0)", "originalCommit": "4990f00996d1bfb555638780de4323b9eeda98ca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc0MTM1Mw==", "url": "https://github.com/cdapio/cdap/pull/12465#discussion_r457741353", "bodyText": "fixed", "author": "itsanudeep", "createdAt": "2020-07-20T23:07:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU0MDkzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU0MzgxNA==", "url": "https://github.com/cdapio/cdap/pull/12465#discussion_r457543814", "bodyText": "do you need to clone? All you need to store for the list of delayed bindings is the binding id and how many occurence, right?\nwe should avoid using cloneDeep as much as possible, especially for a recurring operations like this. It's inherently slow.", "author": "elfenheart", "createdAt": "2020-07-20T16:35:15Z", "path": "cdap-ui/app/cdap/components/SystemServicesDelay/index.tsx", "diffHunk": "@@ -0,0 +1,187 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+import * as React from 'react';\n+import { connect, Provider } from 'react-redux';\n+import SystemDelayStore from 'services/SystemDelayStore';\n+import SystemDelayActions from 'services/SystemDelayStore/SystemDelayActions';\n+import Snackbar from '@material-ui/core/Snackbar';\n+import Button from '@material-ui/core/Button';\n+import ee from 'event-emitter';\n+import { WINDOW_ON_FOCUS, WINDOW_ON_BLUR } from 'services/WindowManager';\n+import { getExperimentValue, isExperimentEnabled } from 'services/helpers';\n+import DataSource from 'services/datasource';\n+import cloneDeep from 'lodash/cloneDeep';\n+import flatten from 'lodash/flatten';\n+\n+interface IBinding {\n+  resource: {\n+    id: string;\n+    requestTime: number;\n+  };\n+  type: string;\n+  checkAgainsLeft?: number;\n+}\n+\n+interface ISystemDelayProps {\n+  showDelay: boolean;\n+  activeDataSources: DataSource[];\n+}\n+\n+const EXPERIMENT_ID = 'system-delay-notification';\n+const HEALTH_CHECK_INTERVAL = 12000;\n+const DEFAULT_DELAY_TIME = 5000;\n+\n+class SystemServicesDelayView extends React.Component<ISystemDelayProps> {\n+  public state = { delayedBindings: [] };\n+  private healthCheckInterval: NodeJS.Timeout;\n+  private eventEmitter = ee(ee);\n+\n+  public componentDidMount() {\n+    if (isExperimentEnabled(EXPERIMENT_ID)) {\n+      this.checkForDelayedBindings();\n+    }\n+    this.startHealthCheck();\n+    this.eventEmitter.on(WINDOW_ON_FOCUS, () => {\n+      this.startHealthCheck();\n+    });\n+    this.eventEmitter.on(WINDOW_ON_BLUR, () => {\n+      this.stopHealthCheck();\n+    });\n+  }\n+\n+  private startHealthCheck = () => {\n+    if (isExperimentEnabled(EXPERIMENT_ID)) {\n+      this.healthCheckInterval = setInterval(this.checkForDelayedBindings, HEALTH_CHECK_INTERVAL);\n+    }\n+  };\n+\n+  private checkForDelayedBindings = () => {\n+    const delayedTimeFromExperiment = getExperimentValue(EXPERIMENT_ID);\n+    const SERVICES_DELAYED_TIME = delayedTimeFromExperiment\n+      ? parseInt(delayedTimeFromExperiment, 10) * 1000\n+      : DEFAULT_DELAY_TIME;\n+    const activeBindings = flatten(\n+      this.props.activeDataSources\n+        .map((dataSource: DataSource) => dataSource.getBindings())\n+        .filter((bindings) => bindings.length > 0)\n+    );\n+    let newlyDelayedBindings = {};\n+    const delayedBindingsFromLastTime = cloneDeep(this.state.delayedBindings);", "originalCommit": "4990f00996d1bfb555638780de4323b9eeda98ca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc0MTY0NA==", "url": "https://github.com/cdapio/cdap/pull/12465#discussion_r457741644", "bodyText": "You're right, changed the approach to just store the id and re-checks left.", "author": "itsanudeep", "createdAt": "2020-07-20T23:08:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU0MzgxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU0NDI3OA==", "url": "https://github.com/cdapio/cdap/pull/12465#discussion_r457544278", "bodyText": "nit: space after comma", "author": "elfenheart", "createdAt": "2020-07-20T16:36:00Z", "path": "cdap-ui/app/cdap/services/datasource/index.js", "diffHunk": "@@ -35,17 +35,20 @@ import 'rxjs/add/operator/debounceTime';\n import WindowManager, { WINDOW_ON_BLUR, WINDOW_ON_FOCUS } from 'services/WindowManager';\n import { objectQuery } from 'services/helpers';\n import ifvisible from 'ifvisible.js';\n+import SystemDelayStore from 'services/SystemDelayStore';\n+import SystemDelayActions from 'services/SystemDelayStore/SystemDelayActions';\n+import cloneDeep from 'lodash/cloneDeep';\n \n const CDAP_API_VERSION = 'v3';\n // FIXME (CDAP-14836): Right now this is scattered across node and client. Need to consolidate this.\n const REQUEST_ORIGIN_ROUTER = 'ROUTER';\n \n export default class Datasource {\n-  constructor(genericResponseHandlers = [() => true]) {\n-    this.eventEmitter = ee(ee);\n+  constructor(genericResponseHandlers = [() => true],options) {", "originalCommit": "4990f00996d1bfb555638780de4323b9eeda98ca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU0NTkyMg==", "url": "https://github.com/cdapio/cdap/pull/12465#discussion_r457545922", "bodyText": "this should probably have a better function signature. Bindings is a map, but the return value here is an array.\nalso nit: space after ().", "author": "elfenheart", "createdAt": "2020-07-20T16:38:43Z", "path": "cdap-ui/app/cdap/services/datasource/index.js", "diffHunk": "@@ -115,9 +123,20 @@ export default class Datasource {\n     });\n     this.eventEmitter.on(WINDOW_ON_FOCUS, this.resumePoll.bind(this));\n     this.eventEmitter.on(WINDOW_ON_BLUR, this.pausePoll.bind(this));\n+    if (!this.excludeFromHealthCheck) {\n+      SystemDelayStore.dispatch({\n+        type: SystemDelayActions.registerDataSource,\n+        payload: this,\n+      });\n+    }\n+  }\n+\n+  getBindings(){", "originalCommit": "4990f00996d1bfb555638780de4323b9eeda98ca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc0MTcxOQ==", "url": "https://github.com/cdapio/cdap/pull/12465#discussion_r457741719", "bodyText": "renamed the function and fixed the spacing issue", "author": "itsanudeep", "createdAt": "2020-07-20T23:08:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU0NTkyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU0NjA5Mg==", "url": "https://github.com/cdapio/cdap/pull/12465#discussion_r457546092", "bodyText": "is cloneDeep required here? should avoid using cloneDeep", "author": "elfenheart", "createdAt": "2020-07-20T16:38:59Z", "path": "cdap-ui/app/cdap/services/datasource/index.js", "diffHunk": "@@ -115,9 +123,20 @@ export default class Datasource {\n     });\n     this.eventEmitter.on(WINDOW_ON_FOCUS, this.resumePoll.bind(this));\n     this.eventEmitter.on(WINDOW_ON_BLUR, this.pausePoll.bind(this));\n+    if (!this.excludeFromHealthCheck) {\n+      SystemDelayStore.dispatch({\n+        type: SystemDelayActions.registerDataSource,\n+        payload: this,\n+      });\n+    }\n+  }\n+\n+  getBindings(){\n+    return cloneDeep(Object.values(this.bindings));", "originalCommit": "4990f00996d1bfb555638780de4323b9eeda98ca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc0MTk3MA==", "url": "https://github.com/cdapio/cdap/pull/12465#discussion_r457741970", "bodyText": "Using this so we don't accidentally update anything in the original bindings as we only need a snapshot of bindings when the health check happens", "author": "itsanudeep", "createdAt": "2020-07-20T23:09:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU0NjA5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU0NzI5OQ==", "url": "https://github.com/cdapio/cdap/pull/12465#discussion_r457547299", "bodyText": "this seems a little weird. Why is the toggle for excluding from health check happening for a datasource instance? We want to be able to exclude a single API call from the healthCheck, so this toggle needs to come from individual bindings, not for the entire instance of datasource", "author": "elfenheart", "createdAt": "2020-07-20T16:40:56Z", "path": "cdap-ui/app/cdap/services/datasource/index.js", "diffHunk": "@@ -35,17 +35,20 @@ import 'rxjs/add/operator/debounceTime';\n import WindowManager, { WINDOW_ON_BLUR, WINDOW_ON_FOCUS } from 'services/WindowManager';\n import { objectQuery } from 'services/helpers';\n import ifvisible from 'ifvisible.js';\n+import SystemDelayStore from 'services/SystemDelayStore';\n+import SystemDelayActions from 'services/SystemDelayStore/SystemDelayActions';\n+import cloneDeep from 'lodash/cloneDeep';\n \n const CDAP_API_VERSION = 'v3';\n // FIXME (CDAP-14836): Right now this is scattered across node and client. Need to consolidate this.\n const REQUEST_ORIGIN_ROUTER = 'ROUTER';\n \n export default class Datasource {\n-  constructor(genericResponseHandlers = [() => true]) {\n-    this.eventEmitter = ee(ee);\n+  constructor(genericResponseHandlers = [() => true],options) {\n+  this.eventEmitter = ee(ee);\n     let socketData = Socket.getObservable();\n     this.bindings = {};\n-\n+    this.excludeFromHealthCheck = options ? !!options.excludeFromHealthCheck : false;", "originalCommit": "4990f00996d1bfb555638780de4323b9eeda98ca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc0MjExNg==", "url": "https://github.com/cdapio/cdap/pull/12465#discussion_r457742116", "bodyText": "fixed to specify this option at API endpoint level instead of at datasource level", "author": "itsanudeep", "createdAt": "2020-07-20T23:10:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU0NzI5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4MTczMQ==", "url": "https://github.com/cdapio/cdap/pull/12465#discussion_r458981731", "bodyText": "you can combine this with the forEach at line 85. You shouldn't need to create another map, you can simply check whether the binding is delayed there and set a boolean flag whether something is delayed or not.", "author": "elfenheart", "createdAt": "2020-07-22T18:01:29Z", "path": "cdap-ui/app/cdap/components/SystemServicesDelay/index.tsx", "diffHunk": "@@ -0,0 +1,173 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+import * as React from 'react';\n+import { connect, Provider } from 'react-redux';\n+import SystemDelayStore from 'services/SystemDelayStore';\n+import SystemDelayActions from 'services/SystemDelayStore/SystemDelayActions';\n+import Snackbar from '@material-ui/core/Snackbar';\n+import Button from '@material-ui/core/Button';\n+import ee from 'event-emitter';\n+import { WINDOW_ON_FOCUS, WINDOW_ON_BLUR } from 'services/WindowManager';\n+import { getExperimentValue, isExperimentEnabled } from 'services/helpers';\n+import DataSource from 'services/datasource';\n+import flatten from 'lodash/flatten';\n+\n+interface IBindingsMap {\n+  [key: string]: number;\n+}\n+\n+interface ISystemDelayProps {\n+  showDelay: boolean;\n+  activeDataSources: DataSource[];\n+}\n+\n+interface ISystemDelayState {\n+  cleanChecksNeeded: number;\n+}\n+\n+const EXPERIMENT_ID = 'system-delay-notification';\n+const HEALTH_CHECK_INTERVAL = 12000;\n+const DEFAULT_DELAY_TIME = 5000;\n+const CLEAN_CHECK_COUNT = 3;\n+\n+class SystemServicesDelayView extends React.Component<ISystemDelayProps> {\n+  public state: ISystemDelayState = {\n+    cleanChecksNeeded: 0,\n+  };\n+  private healthCheckInterval: NodeJS.Timeout;\n+  private eventEmitter = ee(ee);\n+\n+  public componentDidMount() {\n+    if (isExperimentEnabled(EXPERIMENT_ID)) {\n+      this.checkForDelayedBindings();\n+    }\n+    this.startHealthCheck();\n+    this.eventEmitter.on(WINDOW_ON_FOCUS, () => {\n+      this.startHealthCheck();\n+    });\n+    this.eventEmitter.on(WINDOW_ON_BLUR, () => {\n+      this.stopHealthCheck();\n+    });\n+  }\n+\n+  public componentWillUnmount() {\n+    this.stopHealthCheck();\n+  }\n+\n+  private startHealthCheck = () => {\n+    if (isExperimentEnabled(EXPERIMENT_ID)) {\n+      this.healthCheckInterval = setInterval(this.checkForDelayedBindings, HEALTH_CHECK_INTERVAL);\n+    }\n+  };\n+\n+  private checkForDelayedBindings = () => {\n+    const delayedTimeFromExperiment = getExperimentValue(EXPERIMENT_ID);\n+    const SERVICES_DELAYED_TIME = delayedTimeFromExperiment\n+      ? parseInt(delayedTimeFromExperiment, 10) * 1000\n+      : DEFAULT_DELAY_TIME;\n+    const bindingsMap = {};\n+    this.props.activeDataSources.forEach((dataSource: DataSource) => {\n+      const bindings = dataSource.getBindingsForHealthCheck();\n+      Object.keys(bindings).forEach((id) => {\n+        bindingsMap[id] = bindings[id];\n+      });\n+    });\n+    const currentTime = Date.now();\n+    const isBindingDelayed = (id: string, bindingsMap: IBindingsMap) => {\n+      const bindingStartTime = bindingsMap[id];\n+      return bindingStartTime && currentTime - bindingStartTime > SERVICES_DELAYED_TIME;\n+    };\n+    const hasDelayedBinding = Object.keys(bindingsMap).some((id: string) =>", "originalCommit": "59c088554b808d23dfa599ea5a8032b937d277e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU4MDIyMw==", "url": "https://github.com/cdapio/cdap/pull/12465#discussion_r459580223", "bodyText": "Fixed", "author": "itsanudeep", "createdAt": "2020-07-23T16:34:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4MTczMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4MjI0OQ==", "url": "https://github.com/cdapio/cdap/pull/12465#discussion_r458982249", "bodyText": "nit: indentation", "author": "elfenheart", "createdAt": "2020-07-22T18:02:24Z", "path": "cdap-ui/app/cdap/services/datasource/index.js", "diffHunk": "@@ -115,16 +122,34 @@ export default class Datasource {\n     });\n     this.eventEmitter.on(WINDOW_ON_FOCUS, this.resumePoll.bind(this));\n     this.eventEmitter.on(WINDOW_ON_BLUR, this.pausePoll.bind(this));\n+      SystemDelayStore.dispatch({\n+        type: SystemDelayActions.registerDataSource,\n+        payload: this,\n+      });\n+  }\n+\n+  getBindingsForHealthCheck() {\n+    const bindingsWithTime={};\n+     Object.values(this.bindings)", "originalCommit": "59c088554b808d23dfa599ea5a8032b937d277e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4MjI4Ng==", "url": "https://github.com/cdapio/cdap/pull/12465#discussion_r458982286", "bodyText": "nit: space", "author": "elfenheart", "createdAt": "2020-07-22T18:02:28Z", "path": "cdap-ui/app/cdap/services/datasource/index.js", "diffHunk": "@@ -115,16 +122,34 @@ export default class Datasource {\n     });\n     this.eventEmitter.on(WINDOW_ON_FOCUS, this.resumePoll.bind(this));\n     this.eventEmitter.on(WINDOW_ON_BLUR, this.pausePoll.bind(this));\n+      SystemDelayStore.dispatch({\n+        type: SystemDelayActions.registerDataSource,\n+        payload: this,\n+      });\n+  }\n+\n+  getBindingsForHealthCheck() {\n+    const bindingsWithTime={};", "originalCommit": "59c088554b808d23dfa599ea5a8032b937d277e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4Mjg5MQ==", "url": "https://github.com/cdapio/cdap/pull/12465#discussion_r458982891", "bodyText": "you can filter this as you are computing whether a binding is delayed or not, don't need to pre filter it", "author": "elfenheart", "createdAt": "2020-07-22T18:03:30Z", "path": "cdap-ui/app/cdap/services/datasource/index.js", "diffHunk": "@@ -115,16 +122,34 @@ export default class Datasource {\n     });\n     this.eventEmitter.on(WINDOW_ON_FOCUS, this.resumePoll.bind(this));\n     this.eventEmitter.on(WINDOW_ON_BLUR, this.pausePoll.bind(this));\n+      SystemDelayStore.dispatch({\n+        type: SystemDelayActions.registerDataSource,\n+        payload: this,\n+      });\n+  }\n+\n+  getBindingsForHealthCheck() {\n+    const bindingsWithTime={};\n+     Object.values(this.bindings)\n+        .filter(binding => !binding.excludeFromHealthCheck)", "originalCommit": "59c088554b808d23dfa599ea5a8032b937d277e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU4MDkyNQ==", "url": "https://github.com/cdapio/cdap/pull/12465#discussion_r459580925", "bodyText": "I was filtering it here to keep the response simple. I removed the extra filter and checking inside the forEach so we loop only once.", "author": "itsanudeep", "createdAt": "2020-07-23T16:35:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4Mjg5MQ=="}], "type": "inlineReview"}, {"oid": "a4707191370b2d3ea5a9bfc62faa25057883b906", "url": "https://github.com/cdapio/cdap/commit/a4707191370b2d3ea5a9bfc62faa25057883b906", "message": "system delay notification", "committedDate": "2020-07-30T00:07:59Z", "type": "forcePushed"}, {"oid": "aed08971e84183d380d02266ead43948480d5005", "url": "https://github.com/cdapio/cdap/commit/aed08971e84183d380d02266ead43948480d5005", "message": "system delay notification", "committedDate": "2020-07-30T00:24:30Z", "type": "commit"}, {"oid": "aed08971e84183d380d02266ead43948480d5005", "url": "https://github.com/cdapio/cdap/commit/aed08971e84183d380d02266ead43948480d5005", "message": "system delay notification", "committedDate": "2020-07-30T00:24:30Z", "type": "forcePushed"}]}