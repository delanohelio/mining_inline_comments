{"pr_number": 12342, "pr_title": "[CDAP-16975][CDAP-16976] Select latest version as default when choosing a plugin in UI + reset default plugins post upgrade", "pr_createdAt": "2020-06-16T07:37:25Z", "pr_url": "https://github.com/cdapio/cdap/pull/12342", "timeline": [{"oid": "ade72ce92c3a515f8122f2a3fa9e9d6c53e36802", "url": "https://github.com/cdapio/cdap/commit/ade72ce92c3a515f8122f2a3fa9e9d6c53e36802", "message": "[CDAP-16976] Reset the default plugin store post CDAP upgrade\n\nThis is to ensure we have the following behavior,\n\n1. Pre-upgrade - When the user chooses a plugin from side panel in studio we\nchoose the latest version and set that as default.\n\n2. Pre-upgrade - When the user consciously changes to a older version of the plugin we\ndefault to that specific version after that.\n\n3. Post-upgrade - Once the user upgrades the CDAP platform, we no longer want them to use\nthe default plugin version they were using in the previous version of CDAP. So we reset\nthe default plugins and start afresh\n\n4. Post-upgrade, Post-reset - After reset post upgrade we then follow the pre-upgrade behavior\nwhere from then on we choose the latest version of the plugin for the first time and default\nto that for subsequent usage.\n\nAs part of that we now store the current version of CDAP in the user store. Post upgrade\nthere will be a mis-match between the cdap version in the user store and the current cdap\nversion the user is running, indicating that there was an upgrade upon which we then reset.", "committedDate": "2020-06-16T07:42:29Z", "type": "forcePushed"}, {"oid": "b4836ba39f6eec853bc06e1bdbbbc0ded55358b0", "url": "https://github.com/cdapio/cdap/commit/b4836ba39f6eec853bc06e1bdbbbc0ded55358b0", "message": "Fixes jshint errors in gulp build", "committedDate": "2020-06-16T07:54:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAwNTU5Nw==", "url": "https://github.com/cdapio/cdap/pull/12342#discussion_r441005597", "bodyText": "I think all these promises need to be chained since they could overwrite each other?", "author": "elfenheart", "createdAt": "2020-06-16T17:01:29Z", "path": "cdap-ui/app/hydrator/controllers/create/leftpanel-ctrl.js", "diffHunk": "@@ -96,7 +96,15 @@ class HydratorPlusPlusLeftPanelCtrl {\n         type: this.LEFTPANELSTORE_ACTIONS.PLUGIN_DEFAULT_VERSION_CHECK_AND_UPDATE\n       });\n       const defaultVersionMap = this.leftpanelStore.getState().plugins.pluginToVersionMap;\n-      this.mySettings.set('plugin-default-version', defaultVersionMap);\n+      this.mySettings.get('CURRENT_CDAP_VERSION')\n+      .then((defaultCDAPVersion) => {\n+        if (this.rVersion.version !== defaultCDAPVersion) {\n+          this.mySettings.set('plugin-default-version', {});\n+          this.mySettings.set('CURRENT_CDAP_VERSION', this.rVersion.version);\n+          return;\n+        }\n+        this.mySettings.set('plugin-default-version', defaultVersionMap);", "originalCommit": "b4836ba39f6eec853bc06e1bdbbbc0ded55358b0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAwNzYxOQ==", "url": "https://github.com/cdapio/cdap/pull/12342#discussion_r441007619", "bodyText": "why do we need to do this twice in line 158 and 167?", "author": "elfenheart", "createdAt": "2020-06-16T17:05:04Z", "path": "cdap-ui/app/hydrator/services/hydrator-node-service.js", "diffHunk": "@@ -140,6 +140,37 @@ class HydratorPlusPlusNodeService {\n \n     return true;\n   }\n+\n+  getPluginToArtifactMap(plugins = []) {\n+    let typeMap = {};\n+    plugins.forEach( plugin => {\n+      typeMap[plugin.name] = typeMap[plugin.name] || [];\n+      typeMap[plugin.name].push(plugin);\n+    });\n+    return typeMap;\n+  }\n+\n+  getDefaultVersionForPlugin(plugin = {}, defaultVersionMap = {}) {\n+    if (!Object.keys(plugin).length) {\n+      return {};\n+    }\n+    if (Object.keys(defaultVersionMap).length) {\n+      const highestVersion = window.CaskCommon.VersionUtilities.findHighestVersion(plugin.allArtifacts.map((plugin) => plugin.artifact.version), true);\n+      return plugin.allArtifacts.find((plugin) => plugin.artifact.version === highestVersion);\n+    }\n+    let defaultVersionsList = Object.keys(defaultVersionMap);\n+    let key = `${plugin.name}-${plugin.type}-${plugin.artifact.name}`;\n+    let isDefaultVersionExists = defaultVersionsList.indexOf(key) !== -1;\n+\n+    let isArtifactExistsInBackend = (plugin.allArtifacts || []).filter(plug => angular.equals(plug.artifact, defaultVersionMap[key]));\n+    if (!isDefaultVersionExists || !isArtifactExistsInBackend.length) {\n+      const highestVersion = window.CaskCommon.VersionUtilities.findHighestVersion(plugin.allArtifacts.map((plugin) => plugin.artifact.version), true);", "originalCommit": "b4836ba39f6eec853bc06e1bdbbbc0ded55358b0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "10e8ef7a04f746e9a6416704644619699516eef9", "url": "https://github.com/cdapio/cdap/commit/10e8ef7a04f746e9a6416704644619699516eef9", "message": "[CDAP-16975] Default to latest version while adding plugin from left panel +  [CDAP-16976] Reset the default plugin store post CDAP upgrade\n\nThis is to ensure we have the following behavior,\n\n1. Pre-upgrade - When the user chooses a plugin from side panel in studio we\nchoose the latest version and set that as default.\n\n2. Pre-upgrade - When the user consciously changes to a older version of the plugin we\ndefault to that specific version after that.\n\n3. Post-upgrade - Once the user upgrades the CDAP platform, we no longer want them to use\nthe default plugin version they were using in the previous version of CDAP. So we reset\nthe default plugins and start afresh\n\n4. Post-upgrade, Post-reset - After reset post upgrade we then follow the pre-upgrade behavior\nwhere from then on we choose the latest version of the plugin for the first time and default\nto that for subsequent usage.\n\nAs part of that we now store the current version of CDAP in the user store. Post upgrade\nthere will be a mis-match between the cdap version in the user store and the current cdap\nversion the user is running, indicating that there was an upgrade upon which we then reset.", "committedDate": "2020-06-16T20:17:31Z", "type": "commit"}, {"oid": "10e8ef7a04f746e9a6416704644619699516eef9", "url": "https://github.com/cdapio/cdap/commit/10e8ef7a04f746e9a6416704644619699516eef9", "message": "[CDAP-16975] Default to latest version while adding plugin from left panel +  [CDAP-16976] Reset the default plugin store post CDAP upgrade\n\nThis is to ensure we have the following behavior,\n\n1. Pre-upgrade - When the user chooses a plugin from side panel in studio we\nchoose the latest version and set that as default.\n\n2. Pre-upgrade - When the user consciously changes to a older version of the plugin we\ndefault to that specific version after that.\n\n3. Post-upgrade - Once the user upgrades the CDAP platform, we no longer want them to use\nthe default plugin version they were using in the previous version of CDAP. So we reset\nthe default plugins and start afresh\n\n4. Post-upgrade, Post-reset - After reset post upgrade we then follow the pre-upgrade behavior\nwhere from then on we choose the latest version of the plugin for the first time and default\nto that for subsequent usage.\n\nAs part of that we now store the current version of CDAP in the user store. Post upgrade\nthere will be a mis-match between the cdap version in the user store and the current cdap\nversion the user is running, indicating that there was an upgrade upon which we then reset.", "committedDate": "2020-06-16T20:17:31Z", "type": "forcePushed"}]}