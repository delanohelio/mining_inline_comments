{"pr_number": 11995, "pr_title": "[CDAP-16458] Fixing integration tests", "pr_createdAt": "2020-03-24T16:00:20Z", "pr_url": "https://github.com/cdapio/cdap/pull/11995", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM1NDg0MQ==", "url": "https://github.com/cdapio/cdap/pull/11995#discussion_r397354841", "bodyText": "nit: indent this", "author": "elfenheart", "createdAt": "2020-03-24T17:59:16Z", "path": "cdap-ui/app/tracker/tracker.html", "diffHunk": "@@ -36,18 +36,18 @@\n   ng-keyup=\"onSearch($event)\">\n       <my-global-navbar ng-if=\"!$state.params.iframe\"></my-global-navbar>\n \n-    <main class=\"container\" id=\"app-container\" ng-class=\"{'iframe': $state.params.iframe}\">\n-      <div ng-if=\"!BodyCtrl.pageLevelError\" ui-view></div>\n-      <page404 ng-if=\"BodyCtrl.pageLevelError && BodyCtrl.pageLevelError.errorCode === 404\"\n-      message=\"BodyCtrl.pageLevelError.message\"></page404>\n-      <page500 ng-if=\"BodyCtrl.pageLevelError && BodyCtrl.pageLevelError.errorCode !== 404\"\n-      message=\"BodyCtrl.pageLevelError.message\"></page500>\n+    <main ng-if=\"!BodyCtrl.pageLevelError\" class=\"container\" id=\"app-container\" ng-class=\"{'iframe': $state.params.iframe}\">\n+      <div ui-view></div>\n     </main>\n \n   <div class=\"alerts\" id=\"alerts\"></div>\n   <div ng-if=\"!$state.params.iframe\">\n     <loading-icon></loading-icon>\n     <loading-indicator></loading-indicator>\n+    <page404 ng-if=\"BodyCtrl.pageLevelError && BodyCtrl.pageLevelError.errorCode === 404\"\n+    message=\"BodyCtrl.pageLevelError.message\"></page404>", "originalCommit": "4cc7251346ded169d5d041079642ca6a2f0be398", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM1NDk5OA==", "url": "https://github.com/cdapio/cdap/pull/11995#discussion_r397354998", "bodyText": "nit: indent here too", "author": "elfenheart", "createdAt": "2020-03-24T17:59:28Z", "path": "cdap-ui/app/tracker/tracker.html", "diffHunk": "@@ -36,18 +36,18 @@\n   ng-keyup=\"onSearch($event)\">\n       <my-global-navbar ng-if=\"!$state.params.iframe\"></my-global-navbar>\n \n-    <main class=\"container\" id=\"app-container\" ng-class=\"{'iframe': $state.params.iframe}\">\n-      <div ng-if=\"!BodyCtrl.pageLevelError\" ui-view></div>\n-      <page404 ng-if=\"BodyCtrl.pageLevelError && BodyCtrl.pageLevelError.errorCode === 404\"\n-      message=\"BodyCtrl.pageLevelError.message\"></page404>\n-      <page500 ng-if=\"BodyCtrl.pageLevelError && BodyCtrl.pageLevelError.errorCode !== 404\"\n-      message=\"BodyCtrl.pageLevelError.message\"></page500>\n+    <main ng-if=\"!BodyCtrl.pageLevelError\" class=\"container\" id=\"app-container\" ng-class=\"{'iframe': $state.params.iframe}\">\n+      <div ui-view></div>\n     </main>\n \n   <div class=\"alerts\" id=\"alerts\"></div>\n   <div ng-if=\"!$state.params.iframe\">\n     <loading-icon></loading-icon>\n     <loading-indicator></loading-indicator>\n+    <page404 ng-if=\"BodyCtrl.pageLevelError && BodyCtrl.pageLevelError.errorCode === 404\"\n+    message=\"BodyCtrl.pageLevelError.message\"></page404>\n+    <page500 ng-if=\"BodyCtrl.pageLevelError && BodyCtrl.pageLevelError.errorCode !== 404\"\n+    message=\"BodyCtrl.pageLevelError.message\"></page500>", "originalCommit": "4cc7251346ded169d5d041079642ca6a2f0be398", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4ced1172a5fa7f8d9930397b5b7b754563c9ba8a", "url": "https://github.com/cdapio/cdap/commit/4ced1172a5fa7f8d9930397b5b7b754563c9ba8a", "message": "saving runtime arguments is synchronus", "committedDate": "2020-03-24T22:34:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU1NjA4MA==", "url": "https://github.com/cdapio/cdap/pull/11995#discussion_r397556080", "bodyText": "Can we add more tests to add/edit/remove runtime arguments and reopening the modeless? We should try to imitate the test cases close to what the users might do.", "author": "ajainarayanan", "createdAt": "2020-03-25T01:18:53Z", "path": "cdap-ui/cypress/integration/pipeline.runtimeargs.spec.ts", "diffHunk": "@@ -410,4 +410,19 @@ describe('Deploying pipeline with saved runtime arguments', () => {\n     cy.get(dataCy('pipeline-run-btn')).click();\n     cy.get(dataCy('Succeeded'), { timeout: PIPELINE_RUN_TIMEOUT }).should('exist');\n   });\n+\n+  it('should have saved runtime arguments available',()=>{", "originalCommit": "4ced1172a5fa7f8d9930397b5b7b754563c9ba8a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI4Nzc1Nw==", "url": "https://github.com/cdapio/cdap/pull/11995#discussion_r398287757", "bodyText": "done.", "author": "itsanudeep", "createdAt": "2020-03-26T02:48:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU1NjA4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU1Njc2Mg==", "url": "https://github.com/cdapio/cdap/pull/11995#discussion_r397556762", "bodyText": "How does making this function async fix this issue? This is just a click handler right? As far as I debugged this issue, the store is incorrectly updated with old values when the user saves and closes the modeless.\nThis is a timing issue which I believe is happening every time we close the modeless where we update the preferences using a PUT call but before that we get the runtime arguments from the backend and update the store. So next time we show the modeless it is still the old value.\nI could have missed something but can you add comment as to why this needs to be async and how that fixes the issue?", "author": "ajainarayanan", "createdAt": "2020-03-25T01:21:34Z", "path": "cdap-ui/app/cdap/components/PipelineDetails/PipelineRuntimeArgsDropdownBtn/RuntimeArgsModeless/index.js", "diffHunk": "@@ -63,22 +63,26 @@ class RuntimeArgsModeless extends PureComponent {\n     });\n   };\n \n-  saveRuntimeArgs = () => {\n+  saveRuntimeArgs = async (e) => {", "originalCommit": "4ced1172a5fa7f8d9930397b5b7b754563c9ba8a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI4ODgzMQ==", "url": "https://github.com/cdapio/cdap/pull/11995#discussion_r398288831", "bodyText": "The timing issue was because updatePreferences was asynchronus. The modal was closed and  it was opened before the changes were saved in the backend. So, old arguments were available the next time tests were opening the modal. Making updatePreferences synchronous would make sure that the new arguments are propagated through the backend and available to the modeless when user opens it.", "author": "itsanudeep", "createdAt": "2020-03-26T02:53:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU1Njc2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc2MzU0MQ==", "url": "https://github.com/cdapio/cdap/pull/11995#discussion_r398763541", "bodyText": "this is not necessary. Why do you need to convert updatePreference into a promise? it is an observable", "author": "elfenheart", "createdAt": "2020-03-26T17:37:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU1Njc2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMwOTU4Mw==", "url": "https://github.com/cdapio/cdap/pull/11995#discussion_r400309583", "bodyText": "fixed.", "author": "itsanudeep", "createdAt": "2020-03-30T16:02:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU1Njc2Mg=="}], "type": "inlineReview"}, {"oid": "217aa8096427e660fad0bd59984c533ceb01ffe6", "url": "https://github.com/cdapio/cdap/commit/217aa8096427e660fad0bd59984c533ceb01ffe6", "message": "checking run btn is available before clicking", "committedDate": "2020-03-25T16:46:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc2MTc1OA==", "url": "https://github.com/cdapio/cdap/pull/11995#discussion_r398761758", "bodyText": "why is preventPropagation needed?", "author": "elfenheart", "createdAt": "2020-03-26T17:34:41Z", "path": "cdap-ui/app/cdap/components/PipelineDetails/PipelineRuntimeArgsDropdownBtn/RuntimeArgsModeless/index.js", "diffHunk": "@@ -63,22 +67,28 @@ class RuntimeArgsModeless extends PureComponent {\n     });\n   };\n \n-  saveRuntimeArgs = () => {\n+  saveRuntimeArgs = async (e) => {\n+    preventPropagation(e);", "originalCommit": "99b1afdc52e49cd463c0fb8f5de3c3197da4a831", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMwNDY1OA==", "url": "https://github.com/cdapio/cdap/pull/11995#discussion_r400304658", "bodyText": "Without this, the modeless closes right away when user clicks on one of the buttons. Now, we wait until updatePreferences is complete and close using onClose prop.", "author": "itsanudeep", "createdAt": "2020-03-30T15:55:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc2MTc1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc2NDcxNw==", "url": "https://github.com/cdapio/cdap/pull/11995#discussion_r398764717", "bodyText": "why does runtimeArgs have a key that is empty string? that seems like a bug", "author": "elfenheart", "createdAt": "2020-03-26T17:38:59Z", "path": "cdap-ui/app/cdap/components/PipelineDetails/RunLevelInfo/RunConfigs.js", "diffHunk": "@@ -84,8 +84,12 @@ export default class RunConfigs extends Component {\n \n     let runtimeArgs = objectQuery(this.props.currentRun, 'properties', 'runtimeArgs') || '';\n     try {\n-      runtimeArgs = JSON.parse(runtimeArgs);\n-      delete runtimeArgs[''];\n+      if (runtimeArgs === '') {\n+        runtimeArgs = {};\n+      } else {\n+        runtimeArgs = JSON.parse(runtimeArgs);\n+        delete runtimeArgs[''];", "originalCommit": "99b1afdc52e49cd463c0fb8f5de3c3197da4a831", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMwOTAzNQ==", "url": "https://github.com/cdapio/cdap/pull/11995#discussion_r400309035", "bodyText": "Not sure why, this has been there for over 2 years. @ajainarayanan has more context? The change I made here is just to suppress unnecessary ERROR: cannot parse runtime arguments log in console when we set runtimeArgs to be an empty string in line 85.", "author": "itsanudeep", "createdAt": "2020-03-30T16:01:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc2NDcxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU5NTcyNg==", "url": "https://github.com/cdapio/cdap/pull/11995#discussion_r400595726", "bodyText": "nit: typo alidating", "author": "elfenheart", "createdAt": "2020-03-31T01:50:13Z", "path": "cdap-ui/cypress/integration/pipeline.runtimeargs.spec.ts", "diffHunk": "@@ -364,50 +317,56 @@ describe('Deploying pipeline with saved runtime arguments', () => {\n \n   it('and running it should succeed.', () => {\n     cy.get('.arrow-btn-container').click();\n+    cy.get(dataCy(RUNTIME_ARGS_MODELESS_LOADING_SELECTOR)).should('not.exist');\n     cy.get(dataCy(RUNTIME_ARGS_DEPLOYED_SELECTOR)).should('exist');\n-    cy.get(\n-      `${dataCy(RUNTIME_ARGS_DEPLOYED_SELECTOR)} ${dataCy(0)} ${dataCy(\n-        RUNTIME_ARGS_KEY_SELECTOR\n-      )} input`\n-    ).should('be.disabled');\n-    cy.get(\n-      `${dataCy(RUNTIME_ARGS_DEPLOYED_SELECTOR)} ${dataCy(0)} ${dataCy(\n-        RUNTIME_ARGS_KEY_SELECTOR\n-      )} input`\n-    ).should('have.value', 'source_path');\n-    cy.get(\n-      `${dataCy(RUNTIME_ARGS_DEPLOYED_SELECTOR)} ${dataCy(0)} ${dataCy(\n-        RUNTIME_ARGS_VALUE_SELECTOR\n-      )} input`\n-    ).clear();\n-    cy.get(\n-      `${dataCy(RUNTIME_ARGS_DEPLOYED_SELECTOR)} ${dataCy(0)} ${dataCy(\n-        RUNTIME_ARGS_VALUE_SELECTOR\n-      )}`\n-    ).type(SOURCE_PATH_VAL);\n+    cy.assert_runtime_args_row(0, 'source_path', '', true);\n+    cy.assert_runtime_args_row(1, 'sink_path', '', true);\n+    cy.update_runtime_args_row(0, 'source_path', SOURCE_PATH_VAL, true);\n+    cy.update_runtime_args_row(1, 'sink_path', SINK_PATH_VAL, true);\n+    cy.get(dataCy('save-runtime-args-btn')).click();\n+    cy.get(dataCy('save-runtime-args-btn')).should('not.be.visible');\n+    cy.get(dataCy(\"pipeline-run-btn\")).should('be.visible');\n+    cy.get(dataCy('pipeline-run-btn')).click({ force: true });\n+    cy.get(dataCy('Succeeded'), { timeout: PIPELINE_RUN_TIMEOUT }).should('exist');\n+  });\n \n+  it('should have saved runtime arguments available and alidating other valid actions with runtime arguments', () => {", "originalCommit": "f452c98f9d8cbff1bb2a00a89851c444355e33ba", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3f1312a8bb332c659323624e8491f95cb639d47e", "url": "https://github.com/cdapio/cdap/commit/3f1312a8bb332c659323624e8491f95cb639d47e", "message": "Fixing UI E2E integeration tests", "committedDate": "2020-03-31T04:11:27Z", "type": "commit"}, {"oid": "3f1312a8bb332c659323624e8491f95cb639d47e", "url": "https://github.com/cdapio/cdap/commit/3f1312a8bb332c659323624e8491f95cb639d47e", "message": "Fixing UI E2E integeration tests", "committedDate": "2020-03-31T04:11:27Z", "type": "forcePushed"}]}