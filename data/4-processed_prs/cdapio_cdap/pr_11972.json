{"pr_number": 11972, "pr_title": "Completed \"Map to Target\" directive", "pr_createdAt": "2020-03-18T02:54:44Z", "pr_url": "https://github.com/cdapio/cdap/pull/11972", "timeline": [{"oid": "122b75ba7a4dfa8fb469f096e0fa966578e310fa", "url": "https://github.com/cdapio/cdap/commit/122b75ba7a4dfa8fb469f096e0fa966578e310fa", "message": "Implemented Map to Target directive.", "committedDate": "2020-03-12T09:06:46Z", "type": "commit"}, {"oid": "6897300d90457db8a90788d5acb1c9fa318111ff", "url": "https://github.com/cdapio/cdap/commit/6897300d90457db8a90788d5acb1c9fa318111ff", "message": "Fixed code review remarks.", "committedDate": "2020-03-17T15:30:04Z", "type": "commit"}, {"oid": "459a47da9e04fb03bc33f1aacce5c9174b0e02c3", "url": "https://github.com/cdapio/cdap/commit/459a47da9e04fb03bc33f1aacce5c9174b0e02c3", "message": "Fixed bug.", "committedDate": "2020-03-17T18:43:21Z", "type": "commit"}, {"oid": "09618c1c00720b89ca8d09c4dc4aff7c9b644557", "url": "https://github.com/cdapio/cdap/commit/09618c1c00720b89ca8d09c4dc4aff7c9b644557", "message": "Fixed bug: UncontrolledTooltip was not able to find target option item when user entered some filter and then cleared it.", "committedDate": "2020-03-18T02:50:06Z", "type": "commit"}, {"oid": "a641c404b8ab35c082a43eb1531aab95686c80af", "url": "https://github.com/cdapio/cdap/commit/a641c404b8ab35c082a43eb1531aab95686c80af", "message": "Refactored loading bar, details extracted to separate functions.", "committedDate": "2020-03-18T10:17:31Z", "type": "commit"}, {"oid": "96166421cefc88eae28408830cb7f45db850cbd2", "url": "https://github.com/cdapio/cdap/commit/96166421cefc88eae28408830cb7f45db850cbd2", "message": "Fixed bug: UncontrolledTooltip was not able to find target option item when user entered some filter and then cleared it.", "committedDate": "2020-03-18T11:16:29Z", "type": "commit"}, {"oid": "0e1943822df992b434cf9247afcc3647221f0a5a", "url": "https://github.com/cdapio/cdap/commit/0e1943822df992b434cf9247afcc3647221f0a5a", "message": "Fixed bug: Use UUID as DOM element ID to avoid special character used in CSS selectors. Minor UI improvements.", "committedDate": "2020-03-18T15:04:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ3NzI4Nw==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r394477287", "bodyText": "You can probably use id to override the rule. ie\nroot: {\n'& #map-to-target-second-level-popover': {\nwidth: '300px',\n}\n}", "author": "Biao", "createdAt": "2020-03-18T16:24:49Z", "path": "cdap-ui/app/cdap/components/DataPrep/Directives/MapToTarget/index.js", "diffHunk": "@@ -14,36 +14,365 @@\n  * the License.\n  */\n \n-import React, { Component } from 'react';\n+import React, { useEffect, useState } from 'react';\n import PropTypes from 'prop-types';\n import T from 'i18n-react';\n+import { makeStyles } from '@material-ui/core';\n+import Input from '@material-ui/core/Input';\n+import LinearProgress from '@material-ui/core/LinearProgress';\n+import List from '@material-ui/core/List';\n+import ListItem from '@material-ui/core/ListItem';\n+import ListItemText from '@material-ui/core/ListItemText';\n+import { UncontrolledTooltip } from 'reactstrap';\n import classnames from 'classnames';\n+import { preventPropagation, connectWithStore } from 'services/helpers';\n+import { setPopoverOffset } from 'components/DataPrep/helper';\n+import DataPrepStore from 'components/DataPrep/store';\n+import {\n+  execute,\n+  setError,\n+  loadTargetDataModelStates,\n+  saveTargetDataModelStates,\n+  setTargetDataModel,\n+  setTargetModel\n+} from 'components/DataPrep/store/DataPrepActionCreator';\n+\n+const useStyles = makeStyles(theme => ({\n+  secondLevelPopover: {\n+    width: '300px !important',", "originalCommit": "96166421cefc88eae28408830cb7f45db850cbd2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE5NDUwOA==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r395194508", "bodyText": "It does not work.", "author": "mukhlin", "createdAt": "2020-03-19T17:22:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ3NzI4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA2NTE0MA==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r402065140", "bodyText": "What is the reason this is changed to 300px? Can we be consistent with other second level popovers in dataprep?", "author": "ajainarayanan", "createdAt": "2020-04-02T05:48:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ3NzI4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI0NzA4Mg==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r405247082", "bodyText": "Some data model and model names are too long so they do not fit into the width of 200px that is default width for second level popover. Anyway, removed it.", "author": "mukhlin", "createdAt": "2020-04-08T04:10:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ3NzI4Nw=="}], "type": "inlineReview"}, {"oid": "f94e3d66f88d13389369a33c1323002d0d218047", "url": "https://github.com/cdapio/cdap/commit/f94e3d66f88d13389369a33c1323002d0d218047", "message": "Merge branch 'develop' of https://github.com/cdapio/cdap into feature/wrangler-data-model", "committedDate": "2020-03-26T04:59:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA2MDMwMg==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r402060302", "bodyText": "We have a component called <Heading type=\"h5\" />. Please use that.", "author": "ajainarayanan", "createdAt": "2020-04-02T05:31:14Z", "path": "cdap-ui/app/cdap/components/DataPrep/Directives/MapToTarget/index.js", "diffHunk": "@@ -14,36 +14,367 @@\n  * the License.\n  */\n \n-import React, { Component } from 'react';\n+import React, { useEffect, useState } from 'react';\n import PropTypes from 'prop-types';\n import T from 'i18n-react';\n+import { makeStyles } from '@material-ui/core';\n+import Input from '@material-ui/core/Input';\n+import LinearProgress from '@material-ui/core/LinearProgress';\n+import List from '@material-ui/core/List';\n+import ListItem from '@material-ui/core/ListItem';\n+import ListItemText from '@material-ui/core/ListItemText';\n+import { UncontrolledTooltip } from 'reactstrap';\n import classnames from 'classnames';\n+import { preventPropagation, connectWithStore } from 'services/helpers';\n+import { setPopoverOffset } from 'components/DataPrep/helper';\n+import DataPrepStore from 'components/DataPrep/store';\n+import {\n+  execute,\n+  setError,\n+  loadTargetDataModelStates,\n+  saveTargetDataModelStates,\n+  setTargetDataModel,\n+  setTargetModel\n+} from 'components/DataPrep/store/DataPrepActionCreator';\n+\n+const useStyles = makeStyles(theme => ({\n+  secondLevelPopover: {\n+    width: '300px !important',\n+  },\n+  selectedItem: {\n+    display: 'flex',\n+    flexDirection: 'row',\n+  },\n+  selectedItemLabel: {\n+    whiteSpace: 'nowrap',\n+    textOverflow: 'ellipsis',\n+    overflow: 'hidden',\n+    fontWeight: 'bold',\n+  },\n+  selectedItemName: {\n+    flex: 1,\n+    whiteSpace: 'nowrap',\n+    textOverflow: 'ellipsis',\n+    overflow: 'hidden',\n+  },\n+  unselectIcon: {\n+    cursor: 'pointer',\n+    padding: theme.spacing(0.75),\n+    margin: '0 !important',\n+    '&:hover': {\n+      fontWeight: 'bold',\n+    },\n+  },\n+  optionSearch: {\n+    width: '100%',\n+    marginBottom: theme.spacing(0.5),\n+  },\n+  targetOptionList: {\n+    overflowX: 'hidden',\n+    overflowY: 'auto',\n+    maxHeight: '400px',\n+  },\n+  targetOption: {\n+    whiteSpace: 'nowrap',\n+    textOverflow: 'ellipsis',\n+    overflow: 'hidden',\n+  },\n+  highlight: {\n+    color: theme.palette.primary.contrastText,\n+    backgroundColor: theme.palette.primary.dark,\n+  },\n+}));\n \n const PREFIX = 'features.DataPrep.Directives.MapToTarget';\n \n-export default class MapToTarget extends Component {\n-  static propTypes = {\n-    isOpen: PropTypes.bool,\n-    isDisabled: PropTypes.bool,\n-    column: PropTypes.string,\n-    onComplete: PropTypes.func,\n+const MapToTarget = (props) => {\n+  const classes = useStyles(undefined);\n+  const {\n+    isOpen,\n+    isDisabled,\n+    column,\n+    onComplete,\n+    close,\n+    dataModelList,\n+    targetDataModel,\n+    targetModel,\n+  } = props;\n+  const [loading, setLoading] = useState('');\n+  const [searchText, setSearchText] = useState('');\n+\n+  useEffect(() => {\n+    let pending = true;\n+    setLoading(`${PREFIX}.initializingText`);\n+    (async () => {\n+      try {\n+        await loadTargetDataModelStates();\n+      } catch (error) {\n+        setError(error);\n+      } finally {\n+        if (pending) {\n+          setLoading('');\n+        }\n+      }\n+    })();\n+    return () => {\n+      pending = false;\n+    }\n+  }, []);\n+\n+  useEffect(() => {\n+    if (isOpen && !isDisabled) {\n+      setPopoverOffset(document.getElementById('map-to-target-directive'));\n+    }\n+  });\n+\n+  const applySearch = (options) => {\n+    const searchTextUpper = searchText.trim().toUpperCase();\n+    if (searchTextUpper) {\n+      return options.filter((option) => option.name.toUpperCase().indexOf(searchTextUpper) >= 0);\n+    }\n+    return options;\n   };\n \n-  render() {\n+  const highlightText = (text) => {\n+    const searchTextUpper = searchText.trim().toUpperCase();\n+    if (!searchTextUpper) {\n+      return text;\n+    }\n+    const index = text.toUpperCase().indexOf(searchTextUpper);\n+    if (index < 0) {\n+      return text;\n+    }\n+    const leadingText = text.substring(0, index);\n+    const highlightedText = text.substring(index, index + searchTextUpper.length);\n+    const trailingText = text.substring(index + searchTextUpper.length);\n     return (\n-      <div\n-        id='map-to-target-directive'\n-        className={classnames('clearfix action-item', {\n-          active: this.props.isOpen && !this.props.isDisabled,\n-          disabled: this.props.isDisabled,\n-        })}\n-      >\n-        <span>{T.translate(`${PREFIX}.title`)}</span>\n-        <span className='float-right'>\n-          <span className='fa fa-caret-right' />\n-        </span>\n+      <span>\n+        {leadingText}\n+        <span className={classes.highlight}>{highlightedText}</span>\n+        {trailingText}\n+      </span>\n+    );\n+  };\n+\n+  const resetTargetOptionsScroll = () => {\n+    const element = document.querySelector('.' + classes.targetOptionList);\n+    if (element) {\n+      element.scrollTop = 0;\n+    }\n+  };\n+\n+  const selectTargetDataModel = async (dataModel) => {\n+    setLoading(`${PREFIX}.loadingText`);\n+    try {\n+      setTargetModel(null);\n+      await setTargetDataModel(dataModel);\n+      setSearchText('');\n+      resetTargetOptionsScroll();\n+    } catch (error) {\n+      setError(error, 'Could not set target data model');\n+    } finally {\n+      setLoading('');\n+    }\n+  };\n+\n+  const selectTargetModel = (model) => {\n+    setTargetModel(model);\n+    setSearchText('');\n+    resetTargetOptionsScroll();\n+  };\n+\n+  const applyDirective = async (field) => {\n+    setLoading(`${PREFIX}.executingDirectiveText`);\n+    try {\n+      await saveTargetDataModelStates();\n+\n+      const directive = 'data-model-map-column ' +\n+        `'${targetDataModel.url}' '${targetDataModel.id}' ${targetDataModel.revision} ` +\n+        `'${targetModel.id}' '${field.id}' :${column}`;\n+\n+      await execute([directive], false, true).toPromise();\n+\n+      close();\n+      onComplete();\n+    } catch (error) {\n+      setError(error, 'Error executing Map to Target directive');\n+    } finally {\n+      setLoading('');\n+    }\n+  };\n+\n+  const renderHeader = (selection) => {\n+    return (\n+      <div>\n+        {selection.length === 0 ? <h5>{T.translate(`${PREFIX}.dataModelPlaceholder`)}</h5> : null}", "originalCommit": "0e1943822df992b434cf9247afcc3647221f0a5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI0NzEzMA==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r405247130", "bodyText": "Done.", "author": "mukhlin", "createdAt": "2020-04-08T04:10:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA2MDMwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA2MDUyMQ==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r402060521", "bodyText": "There is a <If condition={}>...</If>component. Please use that for consistency.", "author": "ajainarayanan", "createdAt": "2020-04-02T05:32:06Z", "path": "cdap-ui/app/cdap/components/DataPrep/Directives/MapToTarget/index.js", "diffHunk": "@@ -14,36 +14,367 @@\n  * the License.\n  */\n \n-import React, { Component } from 'react';\n+import React, { useEffect, useState } from 'react';\n import PropTypes from 'prop-types';\n import T from 'i18n-react';\n+import { makeStyles } from '@material-ui/core';\n+import Input from '@material-ui/core/Input';\n+import LinearProgress from '@material-ui/core/LinearProgress';\n+import List from '@material-ui/core/List';\n+import ListItem from '@material-ui/core/ListItem';\n+import ListItemText from '@material-ui/core/ListItemText';\n+import { UncontrolledTooltip } from 'reactstrap';\n import classnames from 'classnames';\n+import { preventPropagation, connectWithStore } from 'services/helpers';\n+import { setPopoverOffset } from 'components/DataPrep/helper';\n+import DataPrepStore from 'components/DataPrep/store';\n+import {\n+  execute,\n+  setError,\n+  loadTargetDataModelStates,\n+  saveTargetDataModelStates,\n+  setTargetDataModel,\n+  setTargetModel\n+} from 'components/DataPrep/store/DataPrepActionCreator';\n+\n+const useStyles = makeStyles(theme => ({\n+  secondLevelPopover: {\n+    width: '300px !important',\n+  },\n+  selectedItem: {\n+    display: 'flex',\n+    flexDirection: 'row',\n+  },\n+  selectedItemLabel: {\n+    whiteSpace: 'nowrap',\n+    textOverflow: 'ellipsis',\n+    overflow: 'hidden',\n+    fontWeight: 'bold',\n+  },\n+  selectedItemName: {\n+    flex: 1,\n+    whiteSpace: 'nowrap',\n+    textOverflow: 'ellipsis',\n+    overflow: 'hidden',\n+  },\n+  unselectIcon: {\n+    cursor: 'pointer',\n+    padding: theme.spacing(0.75),\n+    margin: '0 !important',\n+    '&:hover': {\n+      fontWeight: 'bold',\n+    },\n+  },\n+  optionSearch: {\n+    width: '100%',\n+    marginBottom: theme.spacing(0.5),\n+  },\n+  targetOptionList: {\n+    overflowX: 'hidden',\n+    overflowY: 'auto',\n+    maxHeight: '400px',\n+  },\n+  targetOption: {\n+    whiteSpace: 'nowrap',\n+    textOverflow: 'ellipsis',\n+    overflow: 'hidden',\n+  },\n+  highlight: {\n+    color: theme.palette.primary.contrastText,\n+    backgroundColor: theme.palette.primary.dark,\n+  },\n+}));\n \n const PREFIX = 'features.DataPrep.Directives.MapToTarget';\n \n-export default class MapToTarget extends Component {\n-  static propTypes = {\n-    isOpen: PropTypes.bool,\n-    isDisabled: PropTypes.bool,\n-    column: PropTypes.string,\n-    onComplete: PropTypes.func,\n+const MapToTarget = (props) => {\n+  const classes = useStyles(undefined);\n+  const {\n+    isOpen,\n+    isDisabled,\n+    column,\n+    onComplete,\n+    close,\n+    dataModelList,\n+    targetDataModel,\n+    targetModel,\n+  } = props;\n+  const [loading, setLoading] = useState('');\n+  const [searchText, setSearchText] = useState('');\n+\n+  useEffect(() => {\n+    let pending = true;\n+    setLoading(`${PREFIX}.initializingText`);\n+    (async () => {\n+      try {\n+        await loadTargetDataModelStates();\n+      } catch (error) {\n+        setError(error);\n+      } finally {\n+        if (pending) {\n+          setLoading('');\n+        }\n+      }\n+    })();\n+    return () => {\n+      pending = false;\n+    }\n+  }, []);\n+\n+  useEffect(() => {\n+    if (isOpen && !isDisabled) {\n+      setPopoverOffset(document.getElementById('map-to-target-directive'));\n+    }\n+  });\n+\n+  const applySearch = (options) => {\n+    const searchTextUpper = searchText.trim().toUpperCase();\n+    if (searchTextUpper) {\n+      return options.filter((option) => option.name.toUpperCase().indexOf(searchTextUpper) >= 0);\n+    }\n+    return options;\n   };\n \n-  render() {\n+  const highlightText = (text) => {\n+    const searchTextUpper = searchText.trim().toUpperCase();\n+    if (!searchTextUpper) {\n+      return text;\n+    }\n+    const index = text.toUpperCase().indexOf(searchTextUpper);\n+    if (index < 0) {\n+      return text;\n+    }\n+    const leadingText = text.substring(0, index);\n+    const highlightedText = text.substring(index, index + searchTextUpper.length);\n+    const trailingText = text.substring(index + searchTextUpper.length);\n     return (\n-      <div\n-        id='map-to-target-directive'\n-        className={classnames('clearfix action-item', {\n-          active: this.props.isOpen && !this.props.isDisabled,\n-          disabled: this.props.isDisabled,\n-        })}\n-      >\n-        <span>{T.translate(`${PREFIX}.title`)}</span>\n-        <span className='float-right'>\n-          <span className='fa fa-caret-right' />\n-        </span>\n+      <span>\n+        {leadingText}\n+        <span className={classes.highlight}>{highlightedText}</span>\n+        {trailingText}\n+      </span>\n+    );\n+  };\n+\n+  const resetTargetOptionsScroll = () => {\n+    const element = document.querySelector('.' + classes.targetOptionList);\n+    if (element) {\n+      element.scrollTop = 0;\n+    }\n+  };\n+\n+  const selectTargetDataModel = async (dataModel) => {\n+    setLoading(`${PREFIX}.loadingText`);\n+    try {\n+      setTargetModel(null);\n+      await setTargetDataModel(dataModel);\n+      setSearchText('');\n+      resetTargetOptionsScroll();\n+    } catch (error) {\n+      setError(error, 'Could not set target data model');\n+    } finally {\n+      setLoading('');\n+    }\n+  };\n+\n+  const selectTargetModel = (model) => {\n+    setTargetModel(model);\n+    setSearchText('');\n+    resetTargetOptionsScroll();\n+  };\n+\n+  const applyDirective = async (field) => {\n+    setLoading(`${PREFIX}.executingDirectiveText`);\n+    try {\n+      await saveTargetDataModelStates();\n+\n+      const directive = 'data-model-map-column ' +\n+        `'${targetDataModel.url}' '${targetDataModel.id}' ${targetDataModel.revision} ` +\n+        `'${targetModel.id}' '${field.id}' :${column}`;\n+\n+      await execute([directive], false, true).toPromise();\n+\n+      close();\n+      onComplete();\n+    } catch (error) {\n+      setError(error, 'Error executing Map to Target directive');\n+    } finally {\n+      setLoading('');\n+    }\n+  };\n+\n+  const renderHeader = (selection) => {\n+    return (\n+      <div>\n+        {selection.length === 0 ? <h5>{T.translate(`${PREFIX}.dataModelPlaceholder`)}</h5> : null}\n+        {selection.map(item => (\n+          <div id={`map-to-target-selected-${item.key}`} key={item.key} className={classes.selectedItem}>\n+            <span className={classes.selectedItemLabel}>{item.label}:&nbsp;</span>\n+            <span className={classes.selectedItemName}>{item.name}</span>\n+            {!loading // Hide [X] when loading", "originalCommit": "0e1943822df992b434cf9247afcc3647221f0a5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI0NzE1OQ==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r405247159", "bodyText": "Done.", "author": "mukhlin", "createdAt": "2020-04-08T04:10:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA2MDUyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA2MTUxNA==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r402061514", "bodyText": "For consistency please use css-in-js styles alone. Mixing one with the other makes it hard for maintanence.", "author": "ajainarayanan", "createdAt": "2020-04-02T05:35:40Z", "path": "cdap-ui/app/cdap/components/DataPrep/Directives/MapToTarget/index.js", "diffHunk": "@@ -14,36 +14,367 @@\n  * the License.\n  */\n \n-import React, { Component } from 'react';\n+import React, { useEffect, useState } from 'react';\n import PropTypes from 'prop-types';\n import T from 'i18n-react';\n+import { makeStyles } from '@material-ui/core';\n+import Input from '@material-ui/core/Input';\n+import LinearProgress from '@material-ui/core/LinearProgress';\n+import List from '@material-ui/core/List';\n+import ListItem from '@material-ui/core/ListItem';\n+import ListItemText from '@material-ui/core/ListItemText';\n+import { UncontrolledTooltip } from 'reactstrap';\n import classnames from 'classnames';\n+import { preventPropagation, connectWithStore } from 'services/helpers';\n+import { setPopoverOffset } from 'components/DataPrep/helper';\n+import DataPrepStore from 'components/DataPrep/store';\n+import {\n+  execute,\n+  setError,\n+  loadTargetDataModelStates,\n+  saveTargetDataModelStates,\n+  setTargetDataModel,\n+  setTargetModel\n+} from 'components/DataPrep/store/DataPrepActionCreator';\n+\n+const useStyles = makeStyles(theme => ({\n+  secondLevelPopover: {\n+    width: '300px !important',\n+  },\n+  selectedItem: {\n+    display: 'flex',\n+    flexDirection: 'row',\n+  },\n+  selectedItemLabel: {\n+    whiteSpace: 'nowrap',\n+    textOverflow: 'ellipsis',\n+    overflow: 'hidden',\n+    fontWeight: 'bold',\n+  },\n+  selectedItemName: {\n+    flex: 1,\n+    whiteSpace: 'nowrap',\n+    textOverflow: 'ellipsis',\n+    overflow: 'hidden',\n+  },\n+  unselectIcon: {\n+    cursor: 'pointer',\n+    padding: theme.spacing(0.75),\n+    margin: '0 !important',\n+    '&:hover': {\n+      fontWeight: 'bold',\n+    },\n+  },\n+  optionSearch: {\n+    width: '100%',\n+    marginBottom: theme.spacing(0.5),\n+  },\n+  targetOptionList: {\n+    overflowX: 'hidden',\n+    overflowY: 'auto',\n+    maxHeight: '400px',\n+  },\n+  targetOption: {\n+    whiteSpace: 'nowrap',\n+    textOverflow: 'ellipsis',\n+    overflow: 'hidden',\n+  },\n+  highlight: {\n+    color: theme.palette.primary.contrastText,\n+    backgroundColor: theme.palette.primary.dark,\n+  },\n+}));\n \n const PREFIX = 'features.DataPrep.Directives.MapToTarget';\n \n-export default class MapToTarget extends Component {\n-  static propTypes = {\n-    isOpen: PropTypes.bool,\n-    isDisabled: PropTypes.bool,\n-    column: PropTypes.string,\n-    onComplete: PropTypes.func,\n+const MapToTarget = (props) => {\n+  const classes = useStyles(undefined);\n+  const {\n+    isOpen,\n+    isDisabled,\n+    column,\n+    onComplete,\n+    close,\n+    dataModelList,\n+    targetDataModel,\n+    targetModel,\n+  } = props;\n+  const [loading, setLoading] = useState('');\n+  const [searchText, setSearchText] = useState('');\n+\n+  useEffect(() => {\n+    let pending = true;\n+    setLoading(`${PREFIX}.initializingText`);\n+    (async () => {\n+      try {\n+        await loadTargetDataModelStates();\n+      } catch (error) {\n+        setError(error);\n+      } finally {\n+        if (pending) {\n+          setLoading('');\n+        }\n+      }\n+    })();\n+    return () => {\n+      pending = false;\n+    }\n+  }, []);\n+\n+  useEffect(() => {\n+    if (isOpen && !isDisabled) {\n+      setPopoverOffset(document.getElementById('map-to-target-directive'));\n+    }\n+  });\n+\n+  const applySearch = (options) => {\n+    const searchTextUpper = searchText.trim().toUpperCase();\n+    if (searchTextUpper) {\n+      return options.filter((option) => option.name.toUpperCase().indexOf(searchTextUpper) >= 0);\n+    }\n+    return options;\n   };\n \n-  render() {\n+  const highlightText = (text) => {\n+    const searchTextUpper = searchText.trim().toUpperCase();\n+    if (!searchTextUpper) {\n+      return text;\n+    }\n+    const index = text.toUpperCase().indexOf(searchTextUpper);\n+    if (index < 0) {\n+      return text;\n+    }\n+    const leadingText = text.substring(0, index);\n+    const highlightedText = text.substring(index, index + searchTextUpper.length);\n+    const trailingText = text.substring(index + searchTextUpper.length);\n     return (\n-      <div\n-        id='map-to-target-directive'\n-        className={classnames('clearfix action-item', {\n-          active: this.props.isOpen && !this.props.isDisabled,\n-          disabled: this.props.isDisabled,\n-        })}\n-      >\n-        <span>{T.translate(`${PREFIX}.title`)}</span>\n-        <span className='float-right'>\n-          <span className='fa fa-caret-right' />\n-        </span>\n+      <span>\n+        {leadingText}\n+        <span className={classes.highlight}>{highlightedText}</span>\n+        {trailingText}\n+      </span>\n+    );\n+  };\n+\n+  const resetTargetOptionsScroll = () => {\n+    const element = document.querySelector('.' + classes.targetOptionList);\n+    if (element) {\n+      element.scrollTop = 0;\n+    }\n+  };\n+\n+  const selectTargetDataModel = async (dataModel) => {\n+    setLoading(`${PREFIX}.loadingText`);\n+    try {\n+      setTargetModel(null);\n+      await setTargetDataModel(dataModel);\n+      setSearchText('');\n+      resetTargetOptionsScroll();\n+    } catch (error) {\n+      setError(error, 'Could not set target data model');\n+    } finally {\n+      setLoading('');\n+    }\n+  };\n+\n+  const selectTargetModel = (model) => {\n+    setTargetModel(model);\n+    setSearchText('');\n+    resetTargetOptionsScroll();\n+  };\n+\n+  const applyDirective = async (field) => {\n+    setLoading(`${PREFIX}.executingDirectiveText`);\n+    try {\n+      await saveTargetDataModelStates();\n+\n+      const directive = 'data-model-map-column ' +\n+        `'${targetDataModel.url}' '${targetDataModel.id}' ${targetDataModel.revision} ` +\n+        `'${targetModel.id}' '${field.id}' :${column}`;\n+\n+      await execute([directive], false, true).toPromise();\n+\n+      close();\n+      onComplete();\n+    } catch (error) {\n+      setError(error, 'Error executing Map to Target directive');\n+    } finally {\n+      setLoading('');\n+    }\n+  };\n+\n+  const renderHeader = (selection) => {\n+    return (\n+      <div>\n+        {selection.length === 0 ? <h5>{T.translate(`${PREFIX}.dataModelPlaceholder`)}</h5> : null}\n+        {selection.map(item => (\n+          <div id={`map-to-target-selected-${item.key}`} key={item.key} className={classes.selectedItem}>\n+            <span className={classes.selectedItemLabel}>{item.label}:&nbsp;</span>\n+            <span className={classes.selectedItemName}>{item.name}</span>\n+            {!loading // Hide [X] when loading\n+              ? <span className={classnames('fa fa-times', classes.unselectIcon)} onClick={item.unselectFn} />\n+              : null}\n+            <UncontrolledTooltip\n+              target={`map-to-target-selected-${item.key}`}\n+              placement='right-end'\n+              delay={{ show: 750, hide: 0 }}\n+            >\n+              {item.description || item.name}\n+            </UncontrolledTooltip>\n+          </div>\n+        ))}\n       </div>\n     );\n-  }\n+  };\n+\n+  const renderLoading = () => {\n+    if (!loading) {\n+      return <hr />;\n+    }\n+    return (\n+      <div>\n+        <LinearProgress />\n+        <div>{T.translate(loading)}</div>\n+      </div>\n+    );\n+  };\n+\n+  const renderFilter = (placeholder) => {\n+    if (loading || !targetDataModel) {\n+      return null;\n+    }\n+    return (\n+      <Input\n+        autoFocus={true}\n+        type='text'\n+        className={classes.optionSearch}\n+        value={searchText}\n+        placeholder={placeholder}\n+        onChange={(event) => setSearchText(event.target.value)}\n+      />\n+    );\n+  };\n+\n+  const renderOptions = (options, selectFn) => {\n+    if (loading) {\n+      return null;\n+    }\n+    return (\n+      <List dense={true} disablePadding={true} className={classes.targetOptionList} hidden={loading}>\n+        {options.map(option => (\n+          <ListItem\n+            button={true}\n+            key={option.id}\n+            id={`map-to-target-option-${option.uuid}`}\n+            onClick={() => selectFn(option)}\n+          >\n+            <ListItemText\n+              className={classes.targetOption}\n+              primary={highlightText(option.name)}\n+            />\n+            <UncontrolledTooltip\n+              target={`map-to-target-option-${option.uuid}`}\n+              modifiers={{\n+                preventOverflow: {\n+                  boundariesElement: 'window'\n+                }\n+              }}\n+              placement='right'\n+              delay={{ show: 500, hide: 0 }}\n+            >\n+              {option.description || option.name}\n+            </UncontrolledTooltip>\n+          </ListItem>\n+        ))}\n+      </List>\n+    );\n+  };\n+\n+  const renderDetail = () => {\n+    if (!isOpen || isDisabled) {\n+      return null;\n+    }\n+\n+    let options, selectFn;\n+    let filterPlaceholder;\n+    const selection = [];\n+\n+    if (targetDataModel) {\n+      selection.push(\n+        {\n+          key: 'datamodel',\n+          label: T.translate(`${PREFIX}.dataModelLabel`),\n+          unselectFn: () => (async() => await selectTargetDataModel(null))(),\n+          ...targetDataModel,\n+        }\n+      );\n+      if (targetModel) {\n+        selection.push(\n+          {\n+            key: 'model',\n+            label: T.translate(`${PREFIX}.modelLabel`),\n+            unselectFn: () => selectTargetModel(null),\n+            ...targetModel,\n+          }\n+        );\n+        filterPlaceholder = T.translate(`${PREFIX}.fieldFilterPlaceholder`);\n+        options = applySearch(targetModel.fields || []);\n+        selectFn = (field) => (async () => await applyDirective(field))();\n+      } else {\n+        filterPlaceholder = T.translate(`${PREFIX}.modelFilterPlaceholder`);\n+        options = applySearch(targetDataModel.models || []);\n+        selectFn = (model) => selectTargetModel(model);\n+      }\n+    } else {\n+      options = dataModelList || [];\n+      selectFn = (dataModel) => (async () => await selectTargetDataModel(dataModel))();\n+    }\n+\n+    return (\n+      <div className={classnames('second-level-popover', classes.secondLevelPopover)} onClick={preventPropagation}>\n+        {renderHeader(selection)}\n+        {renderLoading()}\n+        {renderFilter(filterPlaceholder)}\n+        {renderOptions(options, selectFn)}\n+      </div>\n+    );\n+  };\n+\n+  return (\n+    <div\n+      id='map-to-target-directive'\n+      className={classnames('map-to-target-directive clearfix action-item', {\n+        active: isOpen && !isDisabled,\n+        disabled: isDisabled,\n+      })}\n+    >\n+      <span>{T.translate(`${PREFIX}.title`)}</span>\n+      <span className='float-right'>", "originalCommit": "0e1943822df992b434cf9247afcc3647221f0a5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI0NzE4OQ==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r405247189", "bodyText": "Done.", "author": "mukhlin", "createdAt": "2020-04-08T04:10:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA2MTUxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA2MjAxMw==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r402062013", "bodyText": "This component can definitely be broken down into individual components. There are far too many render functions.", "author": "ajainarayanan", "createdAt": "2020-04-02T05:37:26Z", "path": "cdap-ui/app/cdap/components/DataPrep/Directives/MapToTarget/index.js", "diffHunk": "@@ -14,36 +14,367 @@\n  * the License.\n  */\n \n-import React, { Component } from 'react';\n+import React, { useEffect, useState } from 'react';\n import PropTypes from 'prop-types';\n import T from 'i18n-react';\n+import { makeStyles } from '@material-ui/core';\n+import Input from '@material-ui/core/Input';\n+import LinearProgress from '@material-ui/core/LinearProgress';\n+import List from '@material-ui/core/List';\n+import ListItem from '@material-ui/core/ListItem';\n+import ListItemText from '@material-ui/core/ListItemText';\n+import { UncontrolledTooltip } from 'reactstrap';\n import classnames from 'classnames';\n+import { preventPropagation, connectWithStore } from 'services/helpers';\n+import { setPopoverOffset } from 'components/DataPrep/helper';\n+import DataPrepStore from 'components/DataPrep/store';\n+import {\n+  execute,\n+  setError,\n+  loadTargetDataModelStates,\n+  saveTargetDataModelStates,\n+  setTargetDataModel,\n+  setTargetModel\n+} from 'components/DataPrep/store/DataPrepActionCreator';\n+\n+const useStyles = makeStyles(theme => ({\n+  secondLevelPopover: {\n+    width: '300px !important',\n+  },\n+  selectedItem: {\n+    display: 'flex',\n+    flexDirection: 'row',\n+  },\n+  selectedItemLabel: {\n+    whiteSpace: 'nowrap',\n+    textOverflow: 'ellipsis',\n+    overflow: 'hidden',\n+    fontWeight: 'bold',\n+  },\n+  selectedItemName: {\n+    flex: 1,\n+    whiteSpace: 'nowrap',\n+    textOverflow: 'ellipsis',\n+    overflow: 'hidden',\n+  },\n+  unselectIcon: {\n+    cursor: 'pointer',\n+    padding: theme.spacing(0.75),\n+    margin: '0 !important',\n+    '&:hover': {\n+      fontWeight: 'bold',\n+    },\n+  },\n+  optionSearch: {\n+    width: '100%',\n+    marginBottom: theme.spacing(0.5),\n+  },\n+  targetOptionList: {\n+    overflowX: 'hidden',\n+    overflowY: 'auto',\n+    maxHeight: '400px',\n+  },\n+  targetOption: {\n+    whiteSpace: 'nowrap',\n+    textOverflow: 'ellipsis',\n+    overflow: 'hidden',\n+  },\n+  highlight: {\n+    color: theme.palette.primary.contrastText,\n+    backgroundColor: theme.palette.primary.dark,\n+  },\n+}));\n \n const PREFIX = 'features.DataPrep.Directives.MapToTarget';\n \n-export default class MapToTarget extends Component {\n-  static propTypes = {\n-    isOpen: PropTypes.bool,\n-    isDisabled: PropTypes.bool,\n-    column: PropTypes.string,\n-    onComplete: PropTypes.func,\n+const MapToTarget = (props) => {", "originalCommit": "0e1943822df992b434cf9247afcc3647221f0a5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI0NzQyNg==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r405247426", "bodyText": "Broken into: MapToTarget, CurrentSelection, LoadingBar, OptionFilter, OptionList.", "author": "mukhlin", "createdAt": "2020-04-08T04:11:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA2MjAxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA2MjYwNA==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r402062604", "bodyText": "Please convert this file to ts and provide types for these inputs. We are moving towards typescript and it would help having types for maintainability.  If this requires changing dataprep store to typescript please do so and only add type annotations to the newly added properties.", "author": "ajainarayanan", "createdAt": "2020-04-02T05:39:19Z", "path": "cdap-ui/app/cdap/components/DataPrep/Directives/MapToTarget/index.js", "diffHunk": "@@ -14,36 +14,367 @@\n  * the License.\n  */\n \n-import React, { Component } from 'react';\n+import React, { useEffect, useState } from 'react';\n import PropTypes from 'prop-types';\n import T from 'i18n-react';\n+import { makeStyles } from '@material-ui/core';\n+import Input from '@material-ui/core/Input';\n+import LinearProgress from '@material-ui/core/LinearProgress';\n+import List from '@material-ui/core/List';\n+import ListItem from '@material-ui/core/ListItem';\n+import ListItemText from '@material-ui/core/ListItemText';\n+import { UncontrolledTooltip } from 'reactstrap';\n import classnames from 'classnames';\n+import { preventPropagation, connectWithStore } from 'services/helpers';\n+import { setPopoverOffset } from 'components/DataPrep/helper';\n+import DataPrepStore from 'components/DataPrep/store';\n+import {\n+  execute,\n+  setError,\n+  loadTargetDataModelStates,\n+  saveTargetDataModelStates,\n+  setTargetDataModel,\n+  setTargetModel\n+} from 'components/DataPrep/store/DataPrepActionCreator';\n+\n+const useStyles = makeStyles(theme => ({\n+  secondLevelPopover: {\n+    width: '300px !important',\n+  },\n+  selectedItem: {\n+    display: 'flex',\n+    flexDirection: 'row',\n+  },\n+  selectedItemLabel: {\n+    whiteSpace: 'nowrap',\n+    textOverflow: 'ellipsis',\n+    overflow: 'hidden',\n+    fontWeight: 'bold',\n+  },\n+  selectedItemName: {\n+    flex: 1,\n+    whiteSpace: 'nowrap',\n+    textOverflow: 'ellipsis',\n+    overflow: 'hidden',\n+  },\n+  unselectIcon: {\n+    cursor: 'pointer',\n+    padding: theme.spacing(0.75),\n+    margin: '0 !important',\n+    '&:hover': {\n+      fontWeight: 'bold',\n+    },\n+  },\n+  optionSearch: {\n+    width: '100%',\n+    marginBottom: theme.spacing(0.5),\n+  },\n+  targetOptionList: {\n+    overflowX: 'hidden',\n+    overflowY: 'auto',\n+    maxHeight: '400px',\n+  },\n+  targetOption: {\n+    whiteSpace: 'nowrap',\n+    textOverflow: 'ellipsis',\n+    overflow: 'hidden',\n+  },\n+  highlight: {\n+    color: theme.palette.primary.contrastText,\n+    backgroundColor: theme.palette.primary.dark,\n+  },\n+}));\n \n const PREFIX = 'features.DataPrep.Directives.MapToTarget';\n \n-export default class MapToTarget extends Component {\n-  static propTypes = {\n-    isOpen: PropTypes.bool,\n-    isDisabled: PropTypes.bool,\n-    column: PropTypes.string,\n-    onComplete: PropTypes.func,\n+const MapToTarget = (props) => {\n+  const classes = useStyles(undefined);\n+  const {", "originalCommit": "0e1943822df992b434cf9247afcc3647221f0a5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI0NzU4OA==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r405247588", "bodyText": "Done, dataprep store converted to TypeScript as well.", "author": "mukhlin", "createdAt": "2020-04-08T04:12:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA2MjYwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA2MzM2OQ==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r402063369", "bodyText": "Please extract this out as a separate if condition.\nconst renderHeader = (selection) => {\n  if (!selection.length) {\n    return <Heading type={HeadingTypes.H5}> ...</HeadingType>;\n  }\n  return (\n     ...\n  );\n}", "author": "ajainarayanan", "createdAt": "2020-04-02T05:42:11Z", "path": "cdap-ui/app/cdap/components/DataPrep/Directives/MapToTarget/index.js", "diffHunk": "@@ -14,36 +14,367 @@\n  * the License.\n  */\n \n-import React, { Component } from 'react';\n+import React, { useEffect, useState } from 'react';\n import PropTypes from 'prop-types';\n import T from 'i18n-react';\n+import { makeStyles } from '@material-ui/core';\n+import Input from '@material-ui/core/Input';\n+import LinearProgress from '@material-ui/core/LinearProgress';\n+import List from '@material-ui/core/List';\n+import ListItem from '@material-ui/core/ListItem';\n+import ListItemText from '@material-ui/core/ListItemText';\n+import { UncontrolledTooltip } from 'reactstrap';\n import classnames from 'classnames';\n+import { preventPropagation, connectWithStore } from 'services/helpers';\n+import { setPopoverOffset } from 'components/DataPrep/helper';\n+import DataPrepStore from 'components/DataPrep/store';\n+import {\n+  execute,\n+  setError,\n+  loadTargetDataModelStates,\n+  saveTargetDataModelStates,\n+  setTargetDataModel,\n+  setTargetModel\n+} from 'components/DataPrep/store/DataPrepActionCreator';\n+\n+const useStyles = makeStyles(theme => ({\n+  secondLevelPopover: {\n+    width: '300px !important',\n+  },\n+  selectedItem: {\n+    display: 'flex',\n+    flexDirection: 'row',\n+  },\n+  selectedItemLabel: {\n+    whiteSpace: 'nowrap',\n+    textOverflow: 'ellipsis',\n+    overflow: 'hidden',\n+    fontWeight: 'bold',\n+  },\n+  selectedItemName: {\n+    flex: 1,\n+    whiteSpace: 'nowrap',\n+    textOverflow: 'ellipsis',\n+    overflow: 'hidden',\n+  },\n+  unselectIcon: {\n+    cursor: 'pointer',\n+    padding: theme.spacing(0.75),\n+    margin: '0 !important',\n+    '&:hover': {\n+      fontWeight: 'bold',\n+    },\n+  },\n+  optionSearch: {\n+    width: '100%',\n+    marginBottom: theme.spacing(0.5),\n+  },\n+  targetOptionList: {\n+    overflowX: 'hidden',\n+    overflowY: 'auto',\n+    maxHeight: '400px',\n+  },\n+  targetOption: {\n+    whiteSpace: 'nowrap',\n+    textOverflow: 'ellipsis',\n+    overflow: 'hidden',\n+  },\n+  highlight: {\n+    color: theme.palette.primary.contrastText,\n+    backgroundColor: theme.palette.primary.dark,\n+  },\n+}));\n \n const PREFIX = 'features.DataPrep.Directives.MapToTarget';\n \n-export default class MapToTarget extends Component {\n-  static propTypes = {\n-    isOpen: PropTypes.bool,\n-    isDisabled: PropTypes.bool,\n-    column: PropTypes.string,\n-    onComplete: PropTypes.func,\n+const MapToTarget = (props) => {\n+  const classes = useStyles(undefined);\n+  const {\n+    isOpen,\n+    isDisabled,\n+    column,\n+    onComplete,\n+    close,\n+    dataModelList,\n+    targetDataModel,\n+    targetModel,\n+  } = props;\n+  const [loading, setLoading] = useState('');\n+  const [searchText, setSearchText] = useState('');\n+\n+  useEffect(() => {\n+    let pending = true;\n+    setLoading(`${PREFIX}.initializingText`);\n+    (async () => {\n+      try {\n+        await loadTargetDataModelStates();\n+      } catch (error) {\n+        setError(error);\n+      } finally {\n+        if (pending) {\n+          setLoading('');\n+        }\n+      }\n+    })();\n+    return () => {\n+      pending = false;\n+    }\n+  }, []);\n+\n+  useEffect(() => {\n+    if (isOpen && !isDisabled) {\n+      setPopoverOffset(document.getElementById('map-to-target-directive'));\n+    }\n+  });\n+\n+  const applySearch = (options) => {\n+    const searchTextUpper = searchText.trim().toUpperCase();\n+    if (searchTextUpper) {\n+      return options.filter((option) => option.name.toUpperCase().indexOf(searchTextUpper) >= 0);\n+    }\n+    return options;\n   };\n \n-  render() {\n+  const highlightText = (text) => {\n+    const searchTextUpper = searchText.trim().toUpperCase();\n+    if (!searchTextUpper) {\n+      return text;\n+    }\n+    const index = text.toUpperCase().indexOf(searchTextUpper);\n+    if (index < 0) {\n+      return text;\n+    }\n+    const leadingText = text.substring(0, index);\n+    const highlightedText = text.substring(index, index + searchTextUpper.length);\n+    const trailingText = text.substring(index + searchTextUpper.length);\n     return (\n-      <div\n-        id='map-to-target-directive'\n-        className={classnames('clearfix action-item', {\n-          active: this.props.isOpen && !this.props.isDisabled,\n-          disabled: this.props.isDisabled,\n-        })}\n-      >\n-        <span>{T.translate(`${PREFIX}.title`)}</span>\n-        <span className='float-right'>\n-          <span className='fa fa-caret-right' />\n-        </span>\n+      <span>\n+        {leadingText}\n+        <span className={classes.highlight}>{highlightedText}</span>\n+        {trailingText}\n+      </span>\n+    );\n+  };\n+\n+  const resetTargetOptionsScroll = () => {\n+    const element = document.querySelector('.' + classes.targetOptionList);\n+    if (element) {\n+      element.scrollTop = 0;\n+    }\n+  };\n+\n+  const selectTargetDataModel = async (dataModel) => {\n+    setLoading(`${PREFIX}.loadingText`);\n+    try {\n+      setTargetModel(null);\n+      await setTargetDataModel(dataModel);\n+      setSearchText('');\n+      resetTargetOptionsScroll();\n+    } catch (error) {\n+      setError(error, 'Could not set target data model');\n+    } finally {\n+      setLoading('');\n+    }\n+  };\n+\n+  const selectTargetModel = (model) => {\n+    setTargetModel(model);\n+    setSearchText('');\n+    resetTargetOptionsScroll();\n+  };\n+\n+  const applyDirective = async (field) => {\n+    setLoading(`${PREFIX}.executingDirectiveText`);\n+    try {\n+      await saveTargetDataModelStates();\n+\n+      const directive = 'data-model-map-column ' +\n+        `'${targetDataModel.url}' '${targetDataModel.id}' ${targetDataModel.revision} ` +\n+        `'${targetModel.id}' '${field.id}' :${column}`;\n+\n+      await execute([directive], false, true).toPromise();\n+\n+      close();\n+      onComplete();\n+    } catch (error) {\n+      setError(error, 'Error executing Map to Target directive');\n+    } finally {\n+      setLoading('');\n+    }\n+  };\n+\n+  const renderHeader = (selection) => {\n+    return (\n+      <div>\n+        {selection.length === 0 ? <h5>{T.translate(`${PREFIX}.dataModelPlaceholder`)}</h5> : null}", "originalCommit": "0e1943822df992b434cf9247afcc3647221f0a5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI0NzYyMg==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r405247622", "bodyText": "Done.", "author": "mukhlin", "createdAt": "2020-04-08T04:12:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA2MzM2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA2MzcwOQ==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r402063709", "bodyText": "Please use LoadingSVG component.", "author": "ajainarayanan", "createdAt": "2020-04-02T05:43:26Z", "path": "cdap-ui/app/cdap/components/DataPrep/Directives/MapToTarget/index.js", "diffHunk": "@@ -14,36 +14,367 @@\n  * the License.\n  */\n \n-import React, { Component } from 'react';\n+import React, { useEffect, useState } from 'react';\n import PropTypes from 'prop-types';\n import T from 'i18n-react';\n+import { makeStyles } from '@material-ui/core';\n+import Input from '@material-ui/core/Input';\n+import LinearProgress from '@material-ui/core/LinearProgress';\n+import List from '@material-ui/core/List';\n+import ListItem from '@material-ui/core/ListItem';\n+import ListItemText from '@material-ui/core/ListItemText';\n+import { UncontrolledTooltip } from 'reactstrap';\n import classnames from 'classnames';\n+import { preventPropagation, connectWithStore } from 'services/helpers';\n+import { setPopoverOffset } from 'components/DataPrep/helper';\n+import DataPrepStore from 'components/DataPrep/store';\n+import {\n+  execute,\n+  setError,\n+  loadTargetDataModelStates,\n+  saveTargetDataModelStates,\n+  setTargetDataModel,\n+  setTargetModel\n+} from 'components/DataPrep/store/DataPrepActionCreator';\n+\n+const useStyles = makeStyles(theme => ({\n+  secondLevelPopover: {\n+    width: '300px !important',\n+  },\n+  selectedItem: {\n+    display: 'flex',\n+    flexDirection: 'row',\n+  },\n+  selectedItemLabel: {\n+    whiteSpace: 'nowrap',\n+    textOverflow: 'ellipsis',\n+    overflow: 'hidden',\n+    fontWeight: 'bold',\n+  },\n+  selectedItemName: {\n+    flex: 1,\n+    whiteSpace: 'nowrap',\n+    textOverflow: 'ellipsis',\n+    overflow: 'hidden',\n+  },\n+  unselectIcon: {\n+    cursor: 'pointer',\n+    padding: theme.spacing(0.75),\n+    margin: '0 !important',\n+    '&:hover': {\n+      fontWeight: 'bold',\n+    },\n+  },\n+  optionSearch: {\n+    width: '100%',\n+    marginBottom: theme.spacing(0.5),\n+  },\n+  targetOptionList: {\n+    overflowX: 'hidden',\n+    overflowY: 'auto',\n+    maxHeight: '400px',\n+  },\n+  targetOption: {\n+    whiteSpace: 'nowrap',\n+    textOverflow: 'ellipsis',\n+    overflow: 'hidden',\n+  },\n+  highlight: {\n+    color: theme.palette.primary.contrastText,\n+    backgroundColor: theme.palette.primary.dark,\n+  },\n+}));\n \n const PREFIX = 'features.DataPrep.Directives.MapToTarget';\n \n-export default class MapToTarget extends Component {\n-  static propTypes = {\n-    isOpen: PropTypes.bool,\n-    isDisabled: PropTypes.bool,\n-    column: PropTypes.string,\n-    onComplete: PropTypes.func,\n+const MapToTarget = (props) => {\n+  const classes = useStyles(undefined);\n+  const {\n+    isOpen,\n+    isDisabled,\n+    column,\n+    onComplete,\n+    close,\n+    dataModelList,\n+    targetDataModel,\n+    targetModel,\n+  } = props;\n+  const [loading, setLoading] = useState('');\n+  const [searchText, setSearchText] = useState('');\n+\n+  useEffect(() => {\n+    let pending = true;\n+    setLoading(`${PREFIX}.initializingText`);\n+    (async () => {\n+      try {\n+        await loadTargetDataModelStates();\n+      } catch (error) {\n+        setError(error);\n+      } finally {\n+        if (pending) {\n+          setLoading('');\n+        }\n+      }\n+    })();\n+    return () => {\n+      pending = false;\n+    }\n+  }, []);\n+\n+  useEffect(() => {\n+    if (isOpen && !isDisabled) {\n+      setPopoverOffset(document.getElementById('map-to-target-directive'));\n+    }\n+  });\n+\n+  const applySearch = (options) => {\n+    const searchTextUpper = searchText.trim().toUpperCase();\n+    if (searchTextUpper) {\n+      return options.filter((option) => option.name.toUpperCase().indexOf(searchTextUpper) >= 0);\n+    }\n+    return options;\n   };\n \n-  render() {\n+  const highlightText = (text) => {\n+    const searchTextUpper = searchText.trim().toUpperCase();\n+    if (!searchTextUpper) {\n+      return text;\n+    }\n+    const index = text.toUpperCase().indexOf(searchTextUpper);\n+    if (index < 0) {\n+      return text;\n+    }\n+    const leadingText = text.substring(0, index);\n+    const highlightedText = text.substring(index, index + searchTextUpper.length);\n+    const trailingText = text.substring(index + searchTextUpper.length);\n     return (\n-      <div\n-        id='map-to-target-directive'\n-        className={classnames('clearfix action-item', {\n-          active: this.props.isOpen && !this.props.isDisabled,\n-          disabled: this.props.isDisabled,\n-        })}\n-      >\n-        <span>{T.translate(`${PREFIX}.title`)}</span>\n-        <span className='float-right'>\n-          <span className='fa fa-caret-right' />\n-        </span>\n+      <span>\n+        {leadingText}\n+        <span className={classes.highlight}>{highlightedText}</span>\n+        {trailingText}\n+      </span>\n+    );\n+  };\n+\n+  const resetTargetOptionsScroll = () => {\n+    const element = document.querySelector('.' + classes.targetOptionList);\n+    if (element) {\n+      element.scrollTop = 0;\n+    }\n+  };\n+\n+  const selectTargetDataModel = async (dataModel) => {\n+    setLoading(`${PREFIX}.loadingText`);\n+    try {\n+      setTargetModel(null);\n+      await setTargetDataModel(dataModel);\n+      setSearchText('');\n+      resetTargetOptionsScroll();\n+    } catch (error) {\n+      setError(error, 'Could not set target data model');\n+    } finally {\n+      setLoading('');\n+    }\n+  };\n+\n+  const selectTargetModel = (model) => {\n+    setTargetModel(model);\n+    setSearchText('');\n+    resetTargetOptionsScroll();\n+  };\n+\n+  const applyDirective = async (field) => {\n+    setLoading(`${PREFIX}.executingDirectiveText`);\n+    try {\n+      await saveTargetDataModelStates();\n+\n+      const directive = 'data-model-map-column ' +\n+        `'${targetDataModel.url}' '${targetDataModel.id}' ${targetDataModel.revision} ` +\n+        `'${targetModel.id}' '${field.id}' :${column}`;\n+\n+      await execute([directive], false, true).toPromise();\n+\n+      close();\n+      onComplete();\n+    } catch (error) {\n+      setError(error, 'Error executing Map to Target directive');\n+    } finally {\n+      setLoading('');\n+    }\n+  };\n+\n+  const renderHeader = (selection) => {\n+    return (\n+      <div>\n+        {selection.length === 0 ? <h5>{T.translate(`${PREFIX}.dataModelPlaceholder`)}</h5> : null}\n+        {selection.map(item => (\n+          <div id={`map-to-target-selected-${item.key}`} key={item.key} className={classes.selectedItem}>\n+            <span className={classes.selectedItemLabel}>{item.label}:&nbsp;</span>\n+            <span className={classes.selectedItemName}>{item.name}</span>\n+            {!loading // Hide [X] when loading\n+              ? <span className={classnames('fa fa-times', classes.unselectIcon)} onClick={item.unselectFn} />\n+              : null}\n+            <UncontrolledTooltip\n+              target={`map-to-target-selected-${item.key}`}\n+              placement='right-end'\n+              delay={{ show: 750, hide: 0 }}\n+            >\n+              {item.description || item.name}\n+            </UncontrolledTooltip>\n+          </div>\n+        ))}\n       </div>\n     );\n-  }\n+  };\n+\n+  const renderLoading = () => {\n+    if (!loading) {\n+      return <hr />;\n+    }\n+    return (\n+      <div>\n+        <LinearProgress />", "originalCommit": "0e1943822df992b434cf9247afcc3647221f0a5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI0NzY0Ng==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r405247646", "bodyText": "Done.", "author": "mukhlin", "createdAt": "2020-04-08T04:12:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA2MzcwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA2OTQyOQ==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r402069429", "bodyText": "Is it possible to add some comment on the logic of it? Seems very nested. A sample structure of the message.\nIs it possible to negate the conditions and return from the forEach? That would make it flatter.. ehh..\n data.fields.forEach((entry) => {\n  if (!Array.isArray(entry.type)) {\n    return;\n   }\n  const model = entry.type.find(..)\n  ...\n });\n\nSomething along that.", "author": "ajainarayanan", "createdAt": "2020-04-02T06:02:25Z", "path": "cdap-ui/app/cdap/components/DataPrep/store/DataPrepActionCreator.js", "diffHunk": "@@ -296,3 +298,216 @@ export function setVisualizationState(state) {\n     },\n   });\n }\n+\n+export function setError(error, prefix) {\n+  const status = error.statusCode;\n+  const detail = error.message || error.response.message || 'Unknown error';\n+  const message = `${prefix || 'Error'}: ${status ? `${status}: ${detail}` : detail}`;\n+  DataPrepStore.dispatch({\n+    type: DataPrepActions.setError,\n+    payload: {\n+      message,\n+    },\n+  });\n+}\n+\n+export async function loadTargetDataModelStates() {\n+  // These properties were populated by MyDataPrepApi.getWorkspace API\n+  const {\n+    dataModel,\n+    dataModelRevision,\n+    dataModelModel,\n+  } = DataPrepStore.getState().dataprep.properties;\n+\n+  let { dataModelList } = DataPrepStore.getState().dataprep;\n+  if (!Array.isArray(dataModelList)) {\n+    dataModelList = await fetchDataModelList(Theme.wranglerDataModelUrl);\n+  }\n+\n+  const rev = Number(dataModelRevision);\n+  const targetDataModel = dataModelList.find((dm) => dm.id === dataModel && dm.revision === rev);\n+  await setTargetDataModel(targetDataModel);\n+  if (targetDataModel) {\n+    await setTargetModel(targetDataModel.models.find((m) => m.id === dataModelModel));\n+  } else {\n+    await setTargetModel(null);\n+  }\n+}\n+\n+export async function saveTargetDataModelStates() {\n+  const params = {\n+    context: NamespaceStore.getState().selectedNamespace,\n+    workspaceId: DataPrepStore.getState().dataprep.workspaceId,\n+  };\n+\n+  const { targetDataModel, targetModel } = DataPrepStore.getState().dataprep;\n+  const newDataModelId = targetDataModel ? targetDataModel.id : null;\n+  const newDataModelRevision = targetDataModel ? targetDataModel.revision : null;\n+  const newModelId = targetModel ? targetModel.id : null;\n+\n+  // These properties were populated by MyDataPrepApi.getWorkspace API\n+  const {\n+    dataModel,\n+    dataModelRevision,\n+    dataModelModel,\n+  } = DataPrepStore.getState().dataprep.properties;\n+  const oldDataModelId = dataModel || null;\n+  const oldDataModelRevision = isFinite(dataModelRevision) ? Number(dataModelRevision) : null;\n+  const oldModelId = dataModelModel || null;\n+\n+  if (oldDataModelId !== newDataModelId || oldDataModelRevision !== newDataModelRevision) {\n+    if (oldDataModelId !== null) {\n+      await MyDataPrepApi.detachDataModel(params).toPromise();\n+    }\n+    if (newDataModelId !== null) {\n+      await MyDataPrepApi.attachDataModel(params, {\n+        id: newDataModelId,\n+        revision: newDataModelRevision,\n+      }).toPromise();\n+    }\n+  }\n+\n+  if (oldModelId !== newModelId) {\n+    if (oldModelId !== null) {\n+      await MyDataPrepApi.detachModel(\n+        Object.assign(\n+          {\n+            modelId: oldModelId,\n+          },\n+          params\n+        )\n+      ).toPromise();\n+    }\n+    if (newModelId !== null) {\n+      await MyDataPrepApi.attachModel(params, {\n+        id: newModelId,\n+      }).toPromise();\n+    }\n+  }\n+\n+  DataPrepStore.dispatch({\n+    type: DataPrepActions.setProperties,\n+    payload: {\n+      properties: {\n+        dataModel: newDataModelId,\n+        dataModelRevision: newDataModelRevision,\n+        dataModelModel: newModelId,\n+      },\n+    },\n+  });\n+}\n+\n+export async function fetchDataModelList(url) {\n+  const namespace = NamespaceStore.getState().selectedNamespace;\n+  const params = {\n+    context: namespace,\n+  };\n+\n+  await MyDataPrepApi.addDataModels(params, { url }).toPromise();\n+  const response = await MyDataPrepApi.getDataModels(params).toPromise();\n+  const dataModelList = response.values.map((dataModel) => ({\n+    uuid: uuidV4(),\n+    id: dataModel['namespacedId'].id,\n+    revision: dataModel.revision,\n+    name: dataModel.displayName,\n+    description: dataModel.description,\n+    url,\n+  }));\n+  dataModelList.sort((a, b) => a.name.localeCompare(b.name));\n+\n+  DataPrepStore.dispatch({\n+    type: DataPrepActions.setDataModelList,\n+    payload: {\n+      dataModelList,\n+    },\n+  });\n+\n+  return dataModelList;\n+}\n+\n+export async function fetchModelList(dataModel) {\n+  const params = {\n+    context: NamespaceStore.getState().selectedNamespace,\n+    dataModelId: dataModel.id,\n+    dataModelRevision: dataModel.revision,\n+  };\n+\n+  const response = await MyDataPrepApi.getDataModel(params).toPromise();\n+\n+  try {", "originalCommit": "0e1943822df992b434cf9247afcc3647221f0a5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI0Nzc4Mg==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r405247782", "bodyText": "Done.", "author": "mukhlin", "createdAt": "2020-04-08T04:13:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA2OTQyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3MTAxOQ==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r402071019", "bodyText": "I understand selectTargetDataModel returns a promise but do we have to await here for the promise to resolve? This is invoked from a click handler I believe. Is there a specific reason for wrapping it and making it a async function?", "author": "ajainarayanan", "createdAt": "2020-04-02T06:07:23Z", "path": "cdap-ui/app/cdap/components/DataPrep/Directives/MapToTarget/index.js", "diffHunk": "@@ -14,36 +14,367 @@\n  * the License.\n  */\n \n-import React, { Component } from 'react';\n+import React, { useEffect, useState } from 'react';\n import PropTypes from 'prop-types';\n import T from 'i18n-react';\n+import { makeStyles } from '@material-ui/core';\n+import Input from '@material-ui/core/Input';\n+import LinearProgress from '@material-ui/core/LinearProgress';\n+import List from '@material-ui/core/List';\n+import ListItem from '@material-ui/core/ListItem';\n+import ListItemText from '@material-ui/core/ListItemText';\n+import { UncontrolledTooltip } from 'reactstrap';\n import classnames from 'classnames';\n+import { preventPropagation, connectWithStore } from 'services/helpers';\n+import { setPopoverOffset } from 'components/DataPrep/helper';\n+import DataPrepStore from 'components/DataPrep/store';\n+import {\n+  execute,\n+  setError,\n+  loadTargetDataModelStates,\n+  saveTargetDataModelStates,\n+  setTargetDataModel,\n+  setTargetModel\n+} from 'components/DataPrep/store/DataPrepActionCreator';\n+\n+const useStyles = makeStyles(theme => ({\n+  secondLevelPopover: {\n+    width: '300px !important',\n+  },\n+  selectedItem: {\n+    display: 'flex',\n+    flexDirection: 'row',\n+  },\n+  selectedItemLabel: {\n+    whiteSpace: 'nowrap',\n+    textOverflow: 'ellipsis',\n+    overflow: 'hidden',\n+    fontWeight: 'bold',\n+  },\n+  selectedItemName: {\n+    flex: 1,\n+    whiteSpace: 'nowrap',\n+    textOverflow: 'ellipsis',\n+    overflow: 'hidden',\n+  },\n+  unselectIcon: {\n+    cursor: 'pointer',\n+    padding: theme.spacing(0.75),\n+    margin: '0 !important',\n+    '&:hover': {\n+      fontWeight: 'bold',\n+    },\n+  },\n+  optionSearch: {\n+    width: '100%',\n+    marginBottom: theme.spacing(0.5),\n+  },\n+  targetOptionList: {\n+    overflowX: 'hidden',\n+    overflowY: 'auto',\n+    maxHeight: '400px',\n+  },\n+  targetOption: {\n+    whiteSpace: 'nowrap',\n+    textOverflow: 'ellipsis',\n+    overflow: 'hidden',\n+  },\n+  highlight: {\n+    color: theme.palette.primary.contrastText,\n+    backgroundColor: theme.palette.primary.dark,\n+  },\n+}));\n \n const PREFIX = 'features.DataPrep.Directives.MapToTarget';\n \n-export default class MapToTarget extends Component {\n-  static propTypes = {\n-    isOpen: PropTypes.bool,\n-    isDisabled: PropTypes.bool,\n-    column: PropTypes.string,\n-    onComplete: PropTypes.func,\n+const MapToTarget = (props) => {\n+  const classes = useStyles(undefined);\n+  const {\n+    isOpen,\n+    isDisabled,\n+    column,\n+    onComplete,\n+    close,\n+    dataModelList,\n+    targetDataModel,\n+    targetModel,\n+  } = props;\n+  const [loading, setLoading] = useState('');\n+  const [searchText, setSearchText] = useState('');\n+\n+  useEffect(() => {\n+    let pending = true;\n+    setLoading(`${PREFIX}.initializingText`);\n+    (async () => {\n+      try {\n+        await loadTargetDataModelStates();\n+      } catch (error) {\n+        setError(error);\n+      } finally {\n+        if (pending) {\n+          setLoading('');\n+        }\n+      }\n+    })();\n+    return () => {\n+      pending = false;\n+    }\n+  }, []);\n+\n+  useEffect(() => {\n+    if (isOpen && !isDisabled) {\n+      setPopoverOffset(document.getElementById('map-to-target-directive'));\n+    }\n+  });\n+\n+  const applySearch = (options) => {\n+    const searchTextUpper = searchText.trim().toUpperCase();\n+    if (searchTextUpper) {\n+      return options.filter((option) => option.name.toUpperCase().indexOf(searchTextUpper) >= 0);\n+    }\n+    return options;\n   };\n \n-  render() {\n+  const highlightText = (text) => {\n+    const searchTextUpper = searchText.trim().toUpperCase();\n+    if (!searchTextUpper) {\n+      return text;\n+    }\n+    const index = text.toUpperCase().indexOf(searchTextUpper);\n+    if (index < 0) {\n+      return text;\n+    }\n+    const leadingText = text.substring(0, index);\n+    const highlightedText = text.substring(index, index + searchTextUpper.length);\n+    const trailingText = text.substring(index + searchTextUpper.length);\n     return (\n-      <div\n-        id='map-to-target-directive'\n-        className={classnames('clearfix action-item', {\n-          active: this.props.isOpen && !this.props.isDisabled,\n-          disabled: this.props.isDisabled,\n-        })}\n-      >\n-        <span>{T.translate(`${PREFIX}.title`)}</span>\n-        <span className='float-right'>\n-          <span className='fa fa-caret-right' />\n-        </span>\n+      <span>\n+        {leadingText}\n+        <span className={classes.highlight}>{highlightedText}</span>\n+        {trailingText}\n+      </span>\n+    );\n+  };\n+\n+  const resetTargetOptionsScroll = () => {\n+    const element = document.querySelector('.' + classes.targetOptionList);\n+    if (element) {\n+      element.scrollTop = 0;\n+    }\n+  };\n+\n+  const selectTargetDataModel = async (dataModel) => {\n+    setLoading(`${PREFIX}.loadingText`);\n+    try {\n+      setTargetModel(null);\n+      await setTargetDataModel(dataModel);\n+      setSearchText('');\n+      resetTargetOptionsScroll();\n+    } catch (error) {\n+      setError(error, 'Could not set target data model');\n+    } finally {\n+      setLoading('');\n+    }\n+  };\n+\n+  const selectTargetModel = (model) => {\n+    setTargetModel(model);\n+    setSearchText('');\n+    resetTargetOptionsScroll();\n+  };\n+\n+  const applyDirective = async (field) => {\n+    setLoading(`${PREFIX}.executingDirectiveText`);\n+    try {\n+      await saveTargetDataModelStates();\n+\n+      const directive = 'data-model-map-column ' +\n+        `'${targetDataModel.url}' '${targetDataModel.id}' ${targetDataModel.revision} ` +\n+        `'${targetModel.id}' '${field.id}' :${column}`;\n+\n+      await execute([directive], false, true).toPromise();\n+\n+      close();\n+      onComplete();\n+    } catch (error) {\n+      setError(error, 'Error executing Map to Target directive');\n+    } finally {\n+      setLoading('');\n+    }\n+  };\n+\n+  const renderHeader = (selection) => {\n+    return (\n+      <div>\n+        {selection.length === 0 ? <h5>{T.translate(`${PREFIX}.dataModelPlaceholder`)}</h5> : null}\n+        {selection.map(item => (\n+          <div id={`map-to-target-selected-${item.key}`} key={item.key} className={classes.selectedItem}>\n+            <span className={classes.selectedItemLabel}>{item.label}:&nbsp;</span>\n+            <span className={classes.selectedItemName}>{item.name}</span>\n+            {!loading // Hide [X] when loading\n+              ? <span className={classnames('fa fa-times', classes.unselectIcon)} onClick={item.unselectFn} />\n+              : null}\n+            <UncontrolledTooltip\n+              target={`map-to-target-selected-${item.key}`}\n+              placement='right-end'\n+              delay={{ show: 750, hide: 0 }}\n+            >\n+              {item.description || item.name}\n+            </UncontrolledTooltip>\n+          </div>\n+        ))}\n       </div>\n     );\n-  }\n+  };\n+\n+  const renderLoading = () => {\n+    if (!loading) {\n+      return <hr />;\n+    }\n+    return (\n+      <div>\n+        <LinearProgress />\n+        <div>{T.translate(loading)}</div>\n+      </div>\n+    );\n+  };\n+\n+  const renderFilter = (placeholder) => {\n+    if (loading || !targetDataModel) {\n+      return null;\n+    }\n+    return (\n+      <Input\n+        autoFocus={true}\n+        type='text'\n+        className={classes.optionSearch}\n+        value={searchText}\n+        placeholder={placeholder}\n+        onChange={(event) => setSearchText(event.target.value)}\n+      />\n+    );\n+  };\n+\n+  const renderOptions = (options, selectFn) => {\n+    if (loading) {\n+      return null;\n+    }\n+    return (\n+      <List dense={true} disablePadding={true} className={classes.targetOptionList} hidden={loading}>\n+        {options.map(option => (\n+          <ListItem\n+            button={true}\n+            key={option.id}\n+            id={`map-to-target-option-${option.uuid}`}\n+            onClick={() => selectFn(option)}\n+          >\n+            <ListItemText\n+              className={classes.targetOption}\n+              primary={highlightText(option.name)}\n+            />\n+            <UncontrolledTooltip\n+              target={`map-to-target-option-${option.uuid}`}\n+              modifiers={{\n+                preventOverflow: {\n+                  boundariesElement: 'window'\n+                }\n+              }}\n+              placement='right'\n+              delay={{ show: 500, hide: 0 }}\n+            >\n+              {option.description || option.name}\n+            </UncontrolledTooltip>\n+          </ListItem>\n+        ))}\n+      </List>\n+    );\n+  };\n+\n+  const renderDetail = () => {\n+    if (!isOpen || isDisabled) {\n+      return null;\n+    }\n+\n+    let options, selectFn;\n+    let filterPlaceholder;\n+    const selection = [];\n+\n+    if (targetDataModel) {\n+      selection.push(\n+        {\n+          key: 'datamodel',\n+          label: T.translate(`${PREFIX}.dataModelLabel`),\n+          unselectFn: () => (async() => await selectTargetDataModel(null))(),\n+          ...targetDataModel,\n+        }\n+      );\n+      if (targetModel) {\n+        selection.push(\n+          {\n+            key: 'model',\n+            label: T.translate(`${PREFIX}.modelLabel`),\n+            unselectFn: () => selectTargetModel(null),\n+            ...targetModel,\n+          }\n+        );\n+        filterPlaceholder = T.translate(`${PREFIX}.fieldFilterPlaceholder`);\n+        options = applySearch(targetModel.fields || []);\n+        selectFn = (field) => (async () => await applyDirective(field))();\n+      } else {\n+        filterPlaceholder = T.translate(`${PREFIX}.modelFilterPlaceholder`);\n+        options = applySearch(targetDataModel.models || []);\n+        selectFn = (model) => selectTargetModel(model);\n+      }\n+    } else {\n+      options = dataModelList || [];\n+      selectFn = (dataModel) => (async () => await selectTargetDataModel(dataModel))();", "originalCommit": "0e1943822df992b434cf9247afcc3647221f0a5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3MTQyNw==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r402071427", "bodyText": "Also what happens if the setTargetDataModel fails? Would a rejection here break the application because react unmounts the component if there is an error thrown in the render method.", "author": "ajainarayanan", "createdAt": "2020-04-02T06:08:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3MTAxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI0ODI5Ng==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r405248296", "bodyText": "Removed await statements in click handlers. If setTargetDataModel fails then error will be displayed and component will not be unmounted. I tested it with throw new Error() statement.", "author": "mukhlin", "createdAt": "2020-04-08T04:15:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3MTAxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3NDE0Mg==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r402074142", "bodyText": "Please use a named function here.\nuseEffect(() => {\n  ...\n  async function loadTargetModel() {\n    try {\n        await loadTargetDataModelStates();\n    } catch (error) {\n        setError(error);\n    } finally {\n        if (pending) {\n          setLoading('');\n        }\n    }\n  }\n  loadTargetModel();\n});\n\nMakes it slightly better for readability. Better yet if you could extract function outside of useEffect.", "author": "ajainarayanan", "createdAt": "2020-04-02T06:16:23Z", "path": "cdap-ui/app/cdap/components/DataPrep/Directives/MapToTarget/index.js", "diffHunk": "@@ -14,36 +14,367 @@\n  * the License.\n  */\n \n-import React, { Component } from 'react';\n+import React, { useEffect, useState } from 'react';\n import PropTypes from 'prop-types';\n import T from 'i18n-react';\n+import { makeStyles } from '@material-ui/core';\n+import Input from '@material-ui/core/Input';\n+import LinearProgress from '@material-ui/core/LinearProgress';\n+import List from '@material-ui/core/List';\n+import ListItem from '@material-ui/core/ListItem';\n+import ListItemText from '@material-ui/core/ListItemText';\n+import { UncontrolledTooltip } from 'reactstrap';\n import classnames from 'classnames';\n+import { preventPropagation, connectWithStore } from 'services/helpers';\n+import { setPopoverOffset } from 'components/DataPrep/helper';\n+import DataPrepStore from 'components/DataPrep/store';\n+import {\n+  execute,\n+  setError,\n+  loadTargetDataModelStates,\n+  saveTargetDataModelStates,\n+  setTargetDataModel,\n+  setTargetModel\n+} from 'components/DataPrep/store/DataPrepActionCreator';\n+\n+const useStyles = makeStyles(theme => ({\n+  secondLevelPopover: {\n+    width: '300px !important',\n+  },\n+  selectedItem: {\n+    display: 'flex',\n+    flexDirection: 'row',\n+  },\n+  selectedItemLabel: {\n+    whiteSpace: 'nowrap',\n+    textOverflow: 'ellipsis',\n+    overflow: 'hidden',\n+    fontWeight: 'bold',\n+  },\n+  selectedItemName: {\n+    flex: 1,\n+    whiteSpace: 'nowrap',\n+    textOverflow: 'ellipsis',\n+    overflow: 'hidden',\n+  },\n+  unselectIcon: {\n+    cursor: 'pointer',\n+    padding: theme.spacing(0.75),\n+    margin: '0 !important',\n+    '&:hover': {\n+      fontWeight: 'bold',\n+    },\n+  },\n+  optionSearch: {\n+    width: '100%',\n+    marginBottom: theme.spacing(0.5),\n+  },\n+  targetOptionList: {\n+    overflowX: 'hidden',\n+    overflowY: 'auto',\n+    maxHeight: '400px',\n+  },\n+  targetOption: {\n+    whiteSpace: 'nowrap',\n+    textOverflow: 'ellipsis',\n+    overflow: 'hidden',\n+  },\n+  highlight: {\n+    color: theme.palette.primary.contrastText,\n+    backgroundColor: theme.palette.primary.dark,\n+  },\n+}));\n \n const PREFIX = 'features.DataPrep.Directives.MapToTarget';\n \n-export default class MapToTarget extends Component {\n-  static propTypes = {\n-    isOpen: PropTypes.bool,\n-    isDisabled: PropTypes.bool,\n-    column: PropTypes.string,\n-    onComplete: PropTypes.func,\n+const MapToTarget = (props) => {\n+  const classes = useStyles(undefined);\n+  const {\n+    isOpen,\n+    isDisabled,\n+    column,\n+    onComplete,\n+    close,\n+    dataModelList,\n+    targetDataModel,\n+    targetModel,\n+  } = props;\n+  const [loading, setLoading] = useState('');\n+  const [searchText, setSearchText] = useState('');\n+\n+  useEffect(() => {\n+    let pending = true;\n+    setLoading(`${PREFIX}.initializingText`);\n+    (async () => {", "originalCommit": "0e1943822df992b434cf9247afcc3647221f0a5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI0ODg0NA==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r405248844", "bodyText": "Refactored to named function. I can extract this function outside of useEffect but it requires to move pending flag outside as well. The purpose of the pending flag is to prevent setLoading call on possibly detached component.", "author": "mukhlin", "createdAt": "2020-04-08T04:18:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3NDE0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3NTQxMw==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r402075413", "bodyText": "Any specific reason to not use existing styles? Why the override?", "author": "ajainarayanan", "createdAt": "2020-04-02T06:19:57Z", "path": "cdap-ui/app/cdap/components/DataPrep/Directives/MapToTarget/index.js", "diffHunk": "@@ -14,36 +14,367 @@\n  * the License.\n  */\n \n-import React, { Component } from 'react';\n+import React, { useEffect, useState } from 'react';\n import PropTypes from 'prop-types';\n import T from 'i18n-react';\n+import { makeStyles } from '@material-ui/core';\n+import Input from '@material-ui/core/Input';\n+import LinearProgress from '@material-ui/core/LinearProgress';\n+import List from '@material-ui/core/List';\n+import ListItem from '@material-ui/core/ListItem';\n+import ListItemText from '@material-ui/core/ListItemText';\n+import { UncontrolledTooltip } from 'reactstrap';\n import classnames from 'classnames';\n+import { preventPropagation, connectWithStore } from 'services/helpers';\n+import { setPopoverOffset } from 'components/DataPrep/helper';\n+import DataPrepStore from 'components/DataPrep/store';\n+import {\n+  execute,\n+  setError,\n+  loadTargetDataModelStates,\n+  saveTargetDataModelStates,\n+  setTargetDataModel,\n+  setTargetModel\n+} from 'components/DataPrep/store/DataPrepActionCreator';\n+\n+const useStyles = makeStyles(theme => ({\n+  secondLevelPopover: {\n+    width: '300px !important',\n+  },\n+  selectedItem: {\n+    display: 'flex',\n+    flexDirection: 'row',\n+  },\n+  selectedItemLabel: {\n+    whiteSpace: 'nowrap',\n+    textOverflow: 'ellipsis',\n+    overflow: 'hidden',\n+    fontWeight: 'bold',\n+  },\n+  selectedItemName: {\n+    flex: 1,\n+    whiteSpace: 'nowrap',\n+    textOverflow: 'ellipsis',\n+    overflow: 'hidden',\n+  },\n+  unselectIcon: {\n+    cursor: 'pointer',\n+    padding: theme.spacing(0.75),\n+    margin: '0 !important',", "originalCommit": "0e1943822df992b434cf9247afcc3647221f0a5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI0OTA0MA==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r405249040", "bodyText": "After refactoring to TypeScript this style was removed.", "author": "mukhlin", "createdAt": "2020-04-08T04:18:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3NTQxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3NTY1Mg==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r402075652", "bodyText": "Here as well. Please use <IconSVG /> component to render icons.", "author": "ajainarayanan", "createdAt": "2020-04-02T06:20:38Z", "path": "cdap-ui/app/cdap/components/DataPrep/Directives/MapToTarget/index.js", "diffHunk": "@@ -14,36 +14,367 @@\n  * the License.\n  */\n \n-import React, { Component } from 'react';\n+import React, { useEffect, useState } from 'react';\n import PropTypes from 'prop-types';\n import T from 'i18n-react';\n+import { makeStyles } from '@material-ui/core';\n+import Input from '@material-ui/core/Input';\n+import LinearProgress from '@material-ui/core/LinearProgress';\n+import List from '@material-ui/core/List';\n+import ListItem from '@material-ui/core/ListItem';\n+import ListItemText from '@material-ui/core/ListItemText';\n+import { UncontrolledTooltip } from 'reactstrap';\n import classnames from 'classnames';\n+import { preventPropagation, connectWithStore } from 'services/helpers';\n+import { setPopoverOffset } from 'components/DataPrep/helper';\n+import DataPrepStore from 'components/DataPrep/store';\n+import {\n+  execute,\n+  setError,\n+  loadTargetDataModelStates,\n+  saveTargetDataModelStates,\n+  setTargetDataModel,\n+  setTargetModel\n+} from 'components/DataPrep/store/DataPrepActionCreator';\n+\n+const useStyles = makeStyles(theme => ({\n+  secondLevelPopover: {\n+    width: '300px !important',\n+  },\n+  selectedItem: {\n+    display: 'flex',\n+    flexDirection: 'row',\n+  },\n+  selectedItemLabel: {\n+    whiteSpace: 'nowrap',\n+    textOverflow: 'ellipsis',\n+    overflow: 'hidden',\n+    fontWeight: 'bold',\n+  },\n+  selectedItemName: {\n+    flex: 1,\n+    whiteSpace: 'nowrap',\n+    textOverflow: 'ellipsis',\n+    overflow: 'hidden',\n+  },\n+  unselectIcon: {\n+    cursor: 'pointer',\n+    padding: theme.spacing(0.75),\n+    margin: '0 !important',\n+    '&:hover': {\n+      fontWeight: 'bold',\n+    },\n+  },\n+  optionSearch: {\n+    width: '100%',\n+    marginBottom: theme.spacing(0.5),\n+  },\n+  targetOptionList: {\n+    overflowX: 'hidden',\n+    overflowY: 'auto',\n+    maxHeight: '400px',\n+  },\n+  targetOption: {\n+    whiteSpace: 'nowrap',\n+    textOverflow: 'ellipsis',\n+    overflow: 'hidden',\n+  },\n+  highlight: {\n+    color: theme.palette.primary.contrastText,\n+    backgroundColor: theme.palette.primary.dark,\n+  },\n+}));\n \n const PREFIX = 'features.DataPrep.Directives.MapToTarget';\n \n-export default class MapToTarget extends Component {\n-  static propTypes = {\n-    isOpen: PropTypes.bool,\n-    isDisabled: PropTypes.bool,\n-    column: PropTypes.string,\n-    onComplete: PropTypes.func,\n+const MapToTarget = (props) => {\n+  const classes = useStyles(undefined);\n+  const {\n+    isOpen,\n+    isDisabled,\n+    column,\n+    onComplete,\n+    close,\n+    dataModelList,\n+    targetDataModel,\n+    targetModel,\n+  } = props;\n+  const [loading, setLoading] = useState('');\n+  const [searchText, setSearchText] = useState('');\n+\n+  useEffect(() => {\n+    let pending = true;\n+    setLoading(`${PREFIX}.initializingText`);\n+    (async () => {\n+      try {\n+        await loadTargetDataModelStates();\n+      } catch (error) {\n+        setError(error);\n+      } finally {\n+        if (pending) {\n+          setLoading('');\n+        }\n+      }\n+    })();\n+    return () => {\n+      pending = false;\n+    }\n+  }, []);\n+\n+  useEffect(() => {\n+    if (isOpen && !isDisabled) {\n+      setPopoverOffset(document.getElementById('map-to-target-directive'));\n+    }\n+  });\n+\n+  const applySearch = (options) => {\n+    const searchTextUpper = searchText.trim().toUpperCase();\n+    if (searchTextUpper) {\n+      return options.filter((option) => option.name.toUpperCase().indexOf(searchTextUpper) >= 0);\n+    }\n+    return options;\n   };\n \n-  render() {\n+  const highlightText = (text) => {\n+    const searchTextUpper = searchText.trim().toUpperCase();\n+    if (!searchTextUpper) {\n+      return text;\n+    }\n+    const index = text.toUpperCase().indexOf(searchTextUpper);\n+    if (index < 0) {\n+      return text;\n+    }\n+    const leadingText = text.substring(0, index);\n+    const highlightedText = text.substring(index, index + searchTextUpper.length);\n+    const trailingText = text.substring(index + searchTextUpper.length);\n     return (\n-      <div\n-        id='map-to-target-directive'\n-        className={classnames('clearfix action-item', {\n-          active: this.props.isOpen && !this.props.isDisabled,\n-          disabled: this.props.isDisabled,\n-        })}\n-      >\n-        <span>{T.translate(`${PREFIX}.title`)}</span>\n-        <span className='float-right'>\n-          <span className='fa fa-caret-right' />\n-        </span>\n+      <span>\n+        {leadingText}\n+        <span className={classes.highlight}>{highlightedText}</span>\n+        {trailingText}\n+      </span>\n+    );\n+  };\n+\n+  const resetTargetOptionsScroll = () => {\n+    const element = document.querySelector('.' + classes.targetOptionList);\n+    if (element) {\n+      element.scrollTop = 0;\n+    }\n+  };\n+\n+  const selectTargetDataModel = async (dataModel) => {\n+    setLoading(`${PREFIX}.loadingText`);\n+    try {\n+      setTargetModel(null);\n+      await setTargetDataModel(dataModel);\n+      setSearchText('');\n+      resetTargetOptionsScroll();\n+    } catch (error) {\n+      setError(error, 'Could not set target data model');\n+    } finally {\n+      setLoading('');\n+    }\n+  };\n+\n+  const selectTargetModel = (model) => {\n+    setTargetModel(model);\n+    setSearchText('');\n+    resetTargetOptionsScroll();\n+  };\n+\n+  const applyDirective = async (field) => {\n+    setLoading(`${PREFIX}.executingDirectiveText`);\n+    try {\n+      await saveTargetDataModelStates();\n+\n+      const directive = 'data-model-map-column ' +\n+        `'${targetDataModel.url}' '${targetDataModel.id}' ${targetDataModel.revision} ` +\n+        `'${targetModel.id}' '${field.id}' :${column}`;\n+\n+      await execute([directive], false, true).toPromise();\n+\n+      close();\n+      onComplete();\n+    } catch (error) {\n+      setError(error, 'Error executing Map to Target directive');\n+    } finally {\n+      setLoading('');\n+    }\n+  };\n+\n+  const renderHeader = (selection) => {\n+    return (\n+      <div>\n+        {selection.length === 0 ? <h5>{T.translate(`${PREFIX}.dataModelPlaceholder`)}</h5> : null}\n+        {selection.map(item => (\n+          <div id={`map-to-target-selected-${item.key}`} key={item.key} className={classes.selectedItem}>\n+            <span className={classes.selectedItemLabel}>{item.label}:&nbsp;</span>\n+            <span className={classes.selectedItemName}>{item.name}</span>\n+            {!loading // Hide [X] when loading\n+              ? <span className={classnames('fa fa-times', classes.unselectIcon)} onClick={item.unselectFn} />", "originalCommit": "0e1943822df992b434cf9247afcc3647221f0a5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI0OTA4NA==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r405249084", "bodyText": "Done.", "author": "mukhlin", "createdAt": "2020-04-08T04:19:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3NTY1Mg=="}], "type": "inlineReview"}, {"oid": "10f4bfb07a2297e4391d6f2a453eae0b5c4238e6", "url": "https://github.com/cdapio/cdap/commit/10f4bfb07a2297e4391d6f2a453eae0b5c4238e6", "message": "Merge branch 'develop' of https://github.com/cdapio/cdap into feature/wrangler-data-model", "committedDate": "2020-04-06T03:27:38Z", "type": "commit"}, {"oid": "2b395ba5bf262d55df2a6e5ed167fda51dc73cfe", "url": "https://github.com/cdapio/cdap/commit/2b395ba5bf262d55df2a6e5ed167fda51dc73cfe", "message": "Fixed code review remarks.", "committedDate": "2020-04-08T04:07:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA3NDY5NA==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r424074694", "bodyText": "This would make a POST request to add data model when the popover is opened right? Do we need this everytime the directives popover is opened?", "author": "ajainarayanan", "createdAt": "2020-05-12T22:41:31Z", "path": "cdap-ui/app/cdap/components/DataPrep/Directives/MapToTarget/index.tsx", "diffHunk": "@@ -0,0 +1,220 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+import React, { useEffect, useState } from 'react';\n+import T from 'i18n-react';\n+import { makeStyles } from '@material-ui/core';\n+import classnames from 'classnames';\n+import { preventPropagation, connectWithStore } from 'services/helpers';\n+import { setPopoverOffset } from 'components/DataPrep/helper';\n+import { CurrentSelection } from 'components/DataPrep/Directives/MapToTarget/CurrentSelection';\n+import { LoadingBar } from 'components/DataPrep/Directives/MapToTarget/LoadingBar';\n+import { OptionFilter } from 'components/DataPrep/Directives/MapToTarget/OptionFilter';\n+import { OptionList } from 'components/DataPrep/Directives/MapToTarget/OptionList';\n+import IconSVG from 'components/IconSVG';\n+import DataPrepStore, { IDataModel, IModel, IModelField } from 'components/DataPrep/store';\n+import {\n+  execute,\n+  setError,\n+  loadTargetDataModelStates,\n+  saveTargetDataModelStates,\n+  setTargetDataModel,\n+  setTargetModel,\n+} from 'components/DataPrep/store/DataPrepActionCreator';\n+\n+const PREFIX = 'features.DataPrep.Directives.MapToTarget';\n+\n+const useStyles = makeStyles({\n+  clearfix: {\n+    '&::after': {\n+      display: 'block',\n+      clear: 'both',\n+      content: 'none',\n+    },\n+  },\n+  floatRight: {\n+    float: 'right',\n+  },\n+});\n+\n+interface IMapToTargetProps {\n+  isOpen: boolean;\n+  isDisabled: boolean;\n+  column: string;\n+  onComplete: () => void;\n+  close: () => void;\n+  dataModelList?: IDataModel[];\n+  targetDataModel?: IDataModel;\n+  targetModel?: IModel;\n+}\n+\n+const MapToTarget = (props: IMapToTargetProps) => {\n+  const classes = useStyles(undefined);\n+\n+  const {\n+    isOpen,\n+    isDisabled,\n+    column,\n+    onComplete,\n+    close,\n+    dataModelList,\n+    targetDataModel,\n+    targetModel,\n+  } = props;\n+\n+  const [loadingText, setLoadingText] = useState('');\n+  const [searchText, setSearchText] = useState('');\n+\n+  useEffect(() => {\n+    let pending = true;\n+    setLoadingText(`${PREFIX}.initializingText`);\n+\n+    const initialize = async () => {\n+      try {\n+        await loadTargetDataModelStates();", "originalCommit": "2b395ba5bf262d55df2a6e5ed167fda51dc73cfe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEzNDI4Mg==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r424134282", "bodyText": "This would make a POST request to add data model when the popover is opened right?\n\nYes but first time only.\n\nDo we need this everytime the directives popover is opened?\n\nThe logic checks Redux store and if list of available data models have been loaded previously then no HTTP requests will be executed.\nSo 2 HTTP requests will be executed when user opens popover first time (one POST request to add data models from the configured URL, one GET request to load details of these data models).", "author": "mukhlin", "createdAt": "2020-05-13T02:13:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA3NDY5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA3NDk1NA==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r424074954", "bodyText": "This seems to be not useful. This is what I am seeing if the wrangler app is not configured properly to serve this request.", "author": "ajainarayanan", "createdAt": "2020-05-12T22:42:17Z", "path": "cdap-ui/app/cdap/components/DataPrep/Directives/MapToTarget/index.tsx", "diffHunk": "@@ -0,0 +1,220 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+import React, { useEffect, useState } from 'react';\n+import T from 'i18n-react';\n+import { makeStyles } from '@material-ui/core';\n+import classnames from 'classnames';\n+import { preventPropagation, connectWithStore } from 'services/helpers';\n+import { setPopoverOffset } from 'components/DataPrep/helper';\n+import { CurrentSelection } from 'components/DataPrep/Directives/MapToTarget/CurrentSelection';\n+import { LoadingBar } from 'components/DataPrep/Directives/MapToTarget/LoadingBar';\n+import { OptionFilter } from 'components/DataPrep/Directives/MapToTarget/OptionFilter';\n+import { OptionList } from 'components/DataPrep/Directives/MapToTarget/OptionList';\n+import IconSVG from 'components/IconSVG';\n+import DataPrepStore, { IDataModel, IModel, IModelField } from 'components/DataPrep/store';\n+import {\n+  execute,\n+  setError,\n+  loadTargetDataModelStates,\n+  saveTargetDataModelStates,\n+  setTargetDataModel,\n+  setTargetModel,\n+} from 'components/DataPrep/store/DataPrepActionCreator';\n+\n+const PREFIX = 'features.DataPrep.Directives.MapToTarget';\n+\n+const useStyles = makeStyles({\n+  clearfix: {\n+    '&::after': {\n+      display: 'block',\n+      clear: 'both',\n+      content: 'none',\n+    },\n+  },\n+  floatRight: {\n+    float: 'right',\n+  },\n+});\n+\n+interface IMapToTargetProps {\n+  isOpen: boolean;\n+  isDisabled: boolean;\n+  column: string;\n+  onComplete: () => void;\n+  close: () => void;\n+  dataModelList?: IDataModel[];\n+  targetDataModel?: IDataModel;\n+  targetModel?: IModel;\n+}\n+\n+const MapToTarget = (props: IMapToTargetProps) => {\n+  const classes = useStyles(undefined);\n+\n+  const {\n+    isOpen,\n+    isDisabled,\n+    column,\n+    onComplete,\n+    close,\n+    dataModelList,\n+    targetDataModel,\n+    targetModel,\n+  } = props;\n+\n+  const [loadingText, setLoadingText] = useState('');\n+  const [searchText, setSearchText] = useState('');\n+\n+  useEffect(() => {\n+    let pending = true;\n+    setLoadingText(`${PREFIX}.initializingText`);\n+\n+    const initialize = async () => {\n+      try {\n+        await loadTargetDataModelStates();\n+      } catch (error) {\n+        setError(error);", "originalCommit": "2b395ba5bf262d55df2a6e5ed167fda51dc73cfe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE0MzM4OQ==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r424143389", "bodyText": "Can you please provide details how to reproduce that?", "author": "mukhlin", "createdAt": "2020-05-13T02:49:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA3NDk1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY2MTgwMA==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r424661800", "bodyText": "I was able to reproduce it using wrangler app that does not have a valid handler for adding data models.", "author": "ajainarayanan", "createdAt": "2020-05-13T18:55:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA3NDk1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgyODcxMw==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r424828713", "bodyText": "It looks like the issue was fixed by adding check for error.response to setError() function. Anyway, I added prefix message saying Map to Target directive initialization failed.", "author": "mukhlin", "createdAt": "2020-05-14T02:00:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA3NDk1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA3NzQ4Nw==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r424077487", "bodyText": "Seems like this interface is having too many any types. Do we know the structure of the response? Using this many anys just takes away the point of using typescript though.", "author": "ajainarayanan", "createdAt": "2020-05-12T22:49:14Z", "path": "cdap-ui/app/cdap/components/DataPrep/store/index.ts", "diffHunk": "@@ -18,12 +18,65 @@ import { combineReducers, createStore } from 'redux';\n import DataPrepActions from 'components/DataPrep/store/DataPrepActions';\n import { composeEnhancers } from 'services/helpers';\n \n-const defaultAction = {\n+export interface IDataPrepAction {\n+  type: string;\n+  action?: string;\n+  payload?: any;\n+}\n+\n+const defaultAction: IDataPrepAction = {\n+  type: '',\n   action: '',\n   payload: {},\n };\n \n-const defaultInitialState = {\n+export interface IDataModel {\n+  uuid: string;\n+  id: string;\n+  revision: number;\n+  name: string;\n+  description?: string;\n+  url?: string;\n+  models?: IModel[];\n+}\n+\n+export interface IModel {\n+  uuid: string;\n+  id: string;\n+  name: string;\n+  description?: string;\n+  fields?: IModelField[];\n+}\n+\n+export interface IModelField {\n+  uuid: string;\n+  id: string;\n+  name: string;\n+  description?: string;\n+}\n+\n+export interface IDataPrepState {\n+  initialized?: boolean;\n+  workspaceId?: string;\n+  workspaceUri?: string;\n+  data?: any;\n+  headers?: any;\n+  types?: any; // pure column types from backend. Used for display\n+  typesCheck?: any; // case sensitive column types, Should be used when checking types of column\n+  selectedHeaders?: any;", "originalCommit": "2b395ba5bf262d55df2a6e5ed167fda51dc73cfe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEyOTA1MQ==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r424129051", "bodyText": "I can only guess on types because I don't know exact structure. I can extract types by looking at response data.\nPreviously you asked to add types to only modified fields:\n\nShould be good to add types for only those things that are being modified, for instance dataprep store", "author": "mukhlin", "createdAt": "2020-05-13T01:53:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA3NzQ4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY2MjEzMw==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r424662133", "bodyText": "Ok. If those are the fields that are not used by map-to-target directive then its ok leave it as is. But please a TODO to add types for unknown ones.", "author": "ajainarayanan", "createdAt": "2020-05-13T18:56:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA3NzQ4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgyODc3MA==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r424828770", "bodyText": "Done.", "author": "mukhlin", "createdAt": "2020-05-14T02:00:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA3NzQ4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA3ODAxNA==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r424078014", "bodyText": "nit: Please make this multiline comment.\n/**\n * example response\n */", "author": "ajainarayanan", "createdAt": "2020-05-12T22:50:43Z", "path": "cdap-ui/app/cdap/components/DataPrep/store/DataPrepActionCreator.js", "diffHunk": "@@ -296,3 +298,271 @@ export function setVisualizationState(state) {\n     },\n   });\n }\n+\n+export function setError(error, prefix) {\n+  const status = error.statusCode;\n+  const detail = error.message || error.response.message || 'Unknown error';\n+  const message = `${prefix || 'Error'}: ${status ? `${status}: ${detail}` : detail}`;\n+  DataPrepStore.dispatch({\n+    type: DataPrepActions.setError,\n+    payload: {\n+      message,\n+    },\n+  });\n+}\n+\n+export async function loadTargetDataModelStates() {\n+  // These properties were populated by MyDataPrepApi.getWorkspace API\n+  const {\n+    dataModel,\n+    dataModelRevision,\n+    dataModelModel,\n+  } = DataPrepStore.getState().dataprep.properties;\n+\n+  let { dataModelList } = DataPrepStore.getState().dataprep;\n+  if (!Array.isArray(dataModelList)) {\n+    dataModelList = await fetchDataModelList(Theme.wranglerDataModelUrl);\n+  }\n+\n+  const rev = Number(dataModelRevision);\n+  const targetDataModel = dataModelList.find((dm) => dm.id === dataModel && dm.revision === rev);\n+  await setTargetDataModel(targetDataModel);\n+  if (targetDataModel) {\n+    await setTargetModel(targetDataModel.models.find((m) => m.id === dataModelModel));\n+  } else {\n+    await setTargetModel(null);\n+  }\n+}\n+\n+export async function saveTargetDataModelStates() {\n+  const params = {\n+    context: NamespaceStore.getState().selectedNamespace,\n+    workspaceId: DataPrepStore.getState().dataprep.workspaceId,\n+  };\n+\n+  const { targetDataModel, targetModel } = DataPrepStore.getState().dataprep;\n+  const newDataModelId = targetDataModel ? targetDataModel.id : null;\n+  const newDataModelRevision = targetDataModel ? targetDataModel.revision : null;\n+  const newModelId = targetModel ? targetModel.id : null;\n+\n+  // These properties were populated by MyDataPrepApi.getWorkspace API\n+  const {\n+    dataModel,\n+    dataModelRevision,\n+    dataModelModel,\n+  } = DataPrepStore.getState().dataprep.properties;\n+  const oldDataModelId = dataModel || null;\n+  const oldDataModelRevision = isFinite(dataModelRevision) ? Number(dataModelRevision) : null;\n+  const oldModelId = dataModelModel || null;\n+\n+  if (oldDataModelId !== newDataModelId || oldDataModelRevision !== newDataModelRevision) {\n+    if (oldDataModelId !== null) {\n+      await MyDataPrepApi.detachDataModel(params).toPromise();\n+    }\n+    if (newDataModelId !== null) {\n+      await MyDataPrepApi.attachDataModel(params, {\n+        id: newDataModelId,\n+        revision: newDataModelRevision,\n+      }).toPromise();\n+    }\n+  }\n+\n+  if (oldModelId !== newModelId) {\n+    if (oldModelId !== null) {\n+      await MyDataPrepApi.detachModel(\n+        Object.assign(\n+          {\n+            modelId: oldModelId,\n+          },\n+          params\n+        )\n+      ).toPromise();\n+    }\n+    if (newModelId !== null) {\n+      await MyDataPrepApi.attachModel(params, {\n+        id: newModelId,\n+      }).toPromise();\n+    }\n+  }\n+\n+  DataPrepStore.dispatch({\n+    type: DataPrepActions.setProperties,\n+    payload: {\n+      properties: {\n+        dataModel: newDataModelId,\n+        dataModelRevision: newDataModelRevision,\n+        dataModelModel: newModelId,\n+      },\n+    },\n+  });\n+}\n+\n+export async function fetchDataModelList(url) {\n+  const namespace = NamespaceStore.getState().selectedNamespace;\n+  const params = {\n+    context: namespace,\n+  };\n+\n+  await MyDataPrepApi.addDataModels(params, { url }).toPromise();\n+  const response = await MyDataPrepApi.getDataModels(params).toPromise();\n+  const dataModelList = response.values.map((dataModel) => ({\n+    uuid: uuidV4(),\n+    id: dataModel['namespacedId'].id,\n+    revision: dataModel.revision,\n+    name: dataModel.displayName,\n+    description: dataModel.description,\n+    url,\n+  }));\n+  dataModelList.sort((a, b) => a.name.localeCompare(b.name));\n+\n+  DataPrepStore.dispatch({\n+    type: DataPrepActions.setDataModelList,\n+    payload: {\n+      dataModelList,\n+    },\n+  });\n+\n+  return dataModelList;\n+}\n+\n+export async function fetchModelList(dataModel) {\n+  const params = {\n+    context: NamespaceStore.getState().selectedNamespace,\n+    dataModelId: dataModel.id,\n+    dataModelRevision: dataModel.revision,\n+  };\n+\n+  // Response message example:\n+  // {", "originalCommit": "2b395ba5bf262d55df2a6e5ed167fda51dc73cfe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE0MzExMA==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r424143110", "bodyText": "Done.", "author": "mukhlin", "createdAt": "2020-05-13T02:48:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA3ODAxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA3OTc3OQ==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r424079779", "bodyText": "This could also be a 404 in which case the message will be in error.response. I understand this is not formalized yet but can we add a check for error.response to be a string and if so use that?", "author": "ajainarayanan", "createdAt": "2020-05-12T22:55:48Z", "path": "cdap-ui/app/cdap/components/DataPrep/store/DataPrepActionCreator.js", "diffHunk": "@@ -296,3 +298,271 @@ export function setVisualizationState(state) {\n     },\n   });\n }\n+\n+export function setError(error, prefix) {\n+  const status = error.statusCode;\n+  const detail = error.message || error.response.message || 'Unknown error';", "originalCommit": "2b395ba5bf262d55df2a6e5ed167fda51dc73cfe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE0MzEzMQ==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r424143131", "bodyText": "Done.", "author": "mukhlin", "createdAt": "2020-05-13T02:48:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA3OTc3OQ=="}], "type": "inlineReview"}, {"oid": "e9ce70fd10a591d475f550a5f2341b0e23b95e6d", "url": "https://github.com/cdapio/cdap/commit/e9ce70fd10a591d475f550a5f2341b0e23b95e6d", "message": "Merge branch 'develop' of https://github.com/cdapio/cdap into feature/wrangler-data-model", "committedDate": "2020-05-13T01:56:33Z", "type": "commit"}, {"oid": "aca362e895162bb4aa4da2563c740fb02e6aee95", "url": "https://github.com/cdapio/cdap/commit/aca362e895162bb4aa4da2563c740fb02e6aee95", "message": "Fixed code review comments.", "committedDate": "2020-05-13T02:48:04Z", "type": "commit"}, {"oid": "63f63db1964e502528caf8ec9eba83c3988e7019", "url": "https://github.com/cdapio/cdap/commit/63f63db1964e502528caf8ec9eba83c3988e7019", "message": "Fixed code review remarks.", "committedDate": "2020-05-14T01:55:56Z", "type": "commit"}, {"oid": "aa835488fe5de34c3df1abb3d8fb8b1b0354a1b1", "url": "https://github.com/cdapio/cdap/commit/aa835488fe5de34c3df1abb3d8fb8b1b0354a1b1", "message": "Adjusted font and size of menu items to be inline with menus of other directives.", "committedDate": "2020-05-15T09:42:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTg0MjY4Mg==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r425842682", "bodyText": "Can we please avoid inline styles. Can we see if we can increase the specificity of this styling?", "author": "ajainarayanan", "createdAt": "2020-05-15T14:32:10Z", "path": "cdap-ui/app/cdap/components/DataPrep/Directives/MapToTarget/index.tsx", "diffHunk": "@@ -0,0 +1,220 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+import React, { useEffect, useState } from 'react';\n+import T from 'i18n-react';\n+import { makeStyles } from '@material-ui/core';\n+import classnames from 'classnames';\n+import { preventPropagation, connectWithStore } from 'services/helpers';\n+import { setPopoverOffset } from 'components/DataPrep/helper';\n+import { CurrentSelection } from 'components/DataPrep/Directives/MapToTarget/CurrentSelection';\n+import { LoadingBar } from 'components/DataPrep/Directives/MapToTarget/LoadingBar';\n+import { OptionFilter } from 'components/DataPrep/Directives/MapToTarget/OptionFilter';\n+import { OptionList } from 'components/DataPrep/Directives/MapToTarget/OptionList';\n+import IconSVG from 'components/IconSVG';\n+import DataPrepStore, { IDataModel, IModel, IModelField } from 'components/DataPrep/store';\n+import {\n+  execute,\n+  setError,\n+  loadTargetDataModelStates,\n+  saveTargetDataModelStates,\n+  setTargetDataModel,\n+  setTargetModel,\n+} from 'components/DataPrep/store/DataPrepActionCreator';\n+\n+const PREFIX = 'features.DataPrep.Directives.MapToTarget';\n+\n+const useStyles = makeStyles({\n+  clearfix: {\n+    '&::after': {\n+      display: 'block',\n+      clear: 'both',\n+      content: 'none',\n+    },\n+  },\n+  floatRight: {\n+    float: 'right',\n+  },\n+});\n+\n+interface IMapToTargetProps {\n+  isOpen: boolean;\n+  isDisabled: boolean;\n+  column: string;\n+  onComplete: () => void;\n+  close: () => void;\n+  dataModelList?: IDataModel[];\n+  targetDataModel?: IDataModel;\n+  targetModel?: IModel;\n+}\n+\n+const MapToTarget = (props: IMapToTargetProps) => {\n+  const classes = useStyles(undefined);\n+\n+  const {\n+    isOpen,\n+    isDisabled,\n+    column,\n+    onComplete,\n+    close,\n+    dataModelList,\n+    targetDataModel,\n+    targetModel,\n+  } = props;\n+\n+  const [loadingText, setLoadingText] = useState('');\n+  const [searchText, setSearchText] = useState('');\n+\n+  useEffect(() => {\n+    let pending = true;\n+    setLoadingText(`${PREFIX}.initializingText`);\n+\n+    const initialize = async () => {\n+      try {\n+        await loadTargetDataModelStates();\n+      } catch (error) {\n+        setError(error, 'Map to Target directive initialization failed');\n+      } finally {\n+        if (pending) {\n+          setLoadingText('');\n+        }\n+      }\n+    };\n+\n+    initialize();\n+\n+    return () => {\n+      pending = false;\n+    };\n+  }, []);\n+\n+  useEffect(() => {\n+    if (isOpen && !isDisabled) {\n+      setPopoverOffset(document.getElementById('map-to-target-directive'));\n+    }\n+  });\n+\n+  const selectTargetDataModel = async (dataModel: IDataModel) => {\n+    setLoadingText(`${PREFIX}.loadingText`);\n+    try {\n+      setTargetModel(null);\n+      await setTargetDataModel(dataModel);\n+      setSearchText('');\n+    } catch (error) {\n+      setError(error, 'Could not set target data model');\n+    } finally {\n+      setLoadingText('');\n+    }\n+  };\n+\n+  const selectTargetModel = (model: IModel) => {\n+    setTargetModel(model);\n+    setSearchText('');\n+  };\n+\n+  const applyDirective = async (field: IModelField) => {\n+    setLoadingText(`${PREFIX}.executingDirectiveText`);\n+    try {\n+      await saveTargetDataModelStates();\n+    } catch (error) {\n+      setError(error, 'Could not save target data model states');\n+      setLoadingText('');\n+      return;\n+    }\n+\n+    executeDirective(field);\n+  };\n+\n+  const executeDirective = (field: IModelField) => {\n+    const directive =\n+      'data-model-map-column ' +\n+      `'${targetDataModel.url}' '${targetDataModel.id}' ${targetDataModel.revision} ` +\n+      `'${targetModel.id}' '${field.id}' :${column}`;\n+\n+    execute([directive], false, true).subscribe(\n+      () => {\n+        close();\n+        onComplete();\n+      },\n+      (error) => {\n+        setError(error, 'Error executing Map to Target directive');\n+      }\n+    );\n+  };\n+\n+  const renderDetail = () => {\n+    if (!isOpen || isDisabled) {\n+      return null;\n+    }\n+\n+    return (\n+      <div className=\"second-level-popover\" style={{ padding: 0 }} onClick={preventPropagation}>", "originalCommit": "aa835488fe5de34c3df1abb3d8fb8b1b0354a1b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjEwNzQyMA==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r426107420", "bodyText": "I know that it is not good idea. The problem is that .dataprep-columns-action-dropdown .action-item .second-level-popover combination defines padding of 10px. Because of that items highlighting does not look as in other menus (for example, Format directive). So I need to override this padding and reset it to 0. Another directives solve it in SCSS. For example:\n\n  \n    \n      cdap/cdap-ui/app/cdap/components/DataPrep/Directives/ChangeDataType/ChangeDataType.scss\n    \n    \n         Line 23\n      in\n      bb6621c\n    \n    \n    \n    \n\n        \n          \n           padding: 0; \n        \n    \n  \n\n\nI can't find how to do that in JSS except !important option that @Biao didn't accept previously.", "author": "mukhlin", "createdAt": "2020-05-16T02:08:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTg0MjY4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjEwODgxNA==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r426108814", "bodyText": "I am not sure if I understand. If we are trying to make things consistent why are we overriding second level popover padding here? We are rendering CurrentSelection, Options and OptionList with padding to the container. Can we remove those? This is just based on looking at the code, I am unable to pull the changes and try out locally otherwise can provide a very concrete feedback.", "author": "ajainarayanan", "createdAt": "2020-05-16T02:27:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTg0MjY4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM4MDc3MA==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r426380770", "bodyText": "Let me show you, for example, how Format directive looks like:\n\nAs you can see highlighted item takes all width of the popover.\nBut popover defines padding of 10px for its content and Format directive overrides it:\n\nLets see how Map to Target directive looks like when we do not override this padding:\n\nGreen border around is that padding from popover style.\nIn that case highlighted item will look as:\n\nSo the highlighted item does not take all the width because of popover padding.\nIf it is fine with you I can remove all the paddings I added and style style={{ padding: 0 }}.\nAnother option I can remove it as I said and add style to OptionList:\n\nIn that case it will look like this:\n\nWhat do you think?", "author": "mukhlin", "createdAt": "2020-05-18T05:44:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTg0MjY4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA3NDQ2Nw==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r427074467", "bodyText": "I think the second option looks good. We can give a negative margin for options list to cancel out the padding for second level popover. Thanks for taking the time to explain it.", "author": "ajainarayanan", "createdAt": "2020-05-19T07:05:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTg0MjY4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE2ODE3Ng==", "url": "https://github.com/cdapio/cdap/pull/11972#discussion_r427168176", "bodyText": "Done.", "author": "mukhlin", "createdAt": "2020-05-19T09:39:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTg0MjY4Mg=="}], "type": "inlineReview"}, {"oid": "5bc67c2bee57d67916e5645063aee032a1000b1a", "url": "https://github.com/cdapio/cdap/commit/5bc67c2bee57d67916e5645063aee032a1000b1a", "message": "Refactored styles.", "committedDate": "2020-05-19T09:39:29Z", "type": "commit"}]}