{"pr_number": 12782, "pr_title": "(CDAP-17287) Collects Spark execution event logs", "pr_createdAt": "2020-09-23T07:20:54Z", "pr_url": "https://github.com/cdapio/cdap/pull/12782", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg3NDMzOA==", "url": "https://github.com/cdapio/cdap/pull/12782#discussion_r493874338", "bodyText": "Maybe we can use javax.ws.rs.core.MediaType.APPLICATION_OCTET_STREAM?", "author": "dli357", "createdAt": "2020-09-23T20:26:51Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/runtime/monitor/RuntimeHandler.java", "diffHunk": "@@ -135,14 +153,77 @@ public BodyConsumer writeMessages(HttpRequest request, HttpResponder responder,\n     });\n   }\n \n+  /**\n+   * Handles call for Spark event logs upload.\n+   */\n+  @Path(\"/spark-event-logs/{id}\")\n+  @POST\n+  public BodyConsumer writeSparkEventLogs(HttpRequest request, HttpResponder responder,\n+                                          @PathParam(\"namespace\") String namespace,\n+                                          @PathParam(\"app\") String app,\n+                                          @PathParam(\"version\") String version,\n+                                          @PathParam(\"program-type\") String programType,\n+                                          @PathParam(\"program\") String program,\n+                                          @PathParam(\"run\") String run,\n+                                          @PathParam(\"id\") String id) throws Exception {\n+    if (!eventLogsEnabled) {\n+      throw new UnsupportedOperationException(\"Spark event logs collection is not enabled\");\n+    }\n+\n+    if (!\"application/octet-stream\".equals(request.headers().get(HttpHeaderNames.CONTENT_TYPE))) {", "originalCommit": "57e89749873dcd4d106a7b9e51f5259ddfbefb52", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg3NDQ1NQ==", "url": "https://github.com/cdapio/cdap/pull/12782#discussion_r493874455", "bodyText": "nit: \"refer back\" instead of \"rely back\"", "author": "dli357", "createdAt": "2020-09-23T20:27:04Z", "path": "cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/SparkRuntimeUtils.java", "diffHunk": "@@ -232,10 +258,68 @@ private void handleCompleted(boolean failure) {\n         if (failure && driverService instanceof SparkDriverService) {\n           ((SparkDriverService) driverService).stopWithoutComplete();\n         } else {\n-          driverService.stopAndWait();\n+          driverService.stop();\n         }\n+\n+        // Wait for the spark execution context to stop to make sure everything related\n+        // to the spark execution is shutdown properly before returning.\n+        // When this method returns, the driver's main thread returns, which will have system services shutdown\n+        // and process terminated. If system services stopped concurrently with the execution context, we may have some\n+        // logs and tasks missing.\n+        Uninterruptibles.awaitUninterruptibly(secStopLatch, 30, TimeUnit.SECONDS);\n+      }\n+    };\n+  }\n+\n+  /**\n+   * Adds a {@link EventLoggingListener} to the Spark context.\n+   *\n+   * @param runtimeContext the {@link SparkRuntimeContext} for connecting to CDAP services\n+   * @return A {@link Closeable} which should be called when the Spark application completed\n+   */\n+  public static Closeable addEventLoggingListener(SparkRuntimeContext runtimeContext) throws IOException {\n+    // If upload event logs is not enabled, just return a dummy closeable\n+    if (!runtimeContext.getCConfiguration().getBoolean(Constants.AppFabric.SPARK_EVENT_LOGS_ENABLED)) {\n+      return () -> { };\n+    }\n+\n+    SparkConf sparkConf = new SparkConf();\n+    sparkConf.set(\"spark.eventLog.enabled\", Boolean.toString(true));\n+    sparkConf.set(\"spark.eventLog.compress\", Boolean.toString(true));\n+\n+    ProgramRunId programRunId = runtimeContext.getProgramRunId();\n+\n+    File eventLogDir = Files.createTempDirectory(\"spark-events\").toFile();\n+    LOG.debug(\"Spark events log directory for {} is {}\", programRunId, eventLogDir);\n+\n+    // EvevntLogginginListener is Scala package private[spark] class.\n+    // However, since JVM bytecode doesn't really have this type of cross package private support, the class\n+    // is actually public class. This is why we can access it in Java code.\n+    EventLoggingListener listener = new EventLoggingListener(Long.toString(System.currentTimeMillis()), Option.empty(),\n+                                                             eventLogDir.toURI(), sparkConf) {\n+      @Override\n+      public void onApplicationStart(SparkListenerApplicationStart event) {\n+        // Rewrite the application start event with identifiable names based on the program run id such that\n+        // it can rely back to the program run.", "originalCommit": "57e89749873dcd4d106a7b9e51f5259ddfbefb52", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg5ODU2MA==", "url": "https://github.com/cdapio/cdap/pull/12782#discussion_r493898560", "bodyText": "fixed", "author": "chtyim", "createdAt": "2020-09-23T21:12:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg3NDQ1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg3NDQ3OQ==", "url": "https://github.com/cdapio/cdap/pull/12782#discussion_r493874479", "bodyText": "Looks like NullPointerException will be thrown if the log directory is empty. Can we expect there to always be exactly one log file?", "author": "dli357", "createdAt": "2020-09-23T20:27:07Z", "path": "cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/SparkRuntimeUtils.java", "diffHunk": "@@ -262,4 +346,54 @@ protected void doStop() {\n       }\n     };\n   }\n+\n+  /**\n+   * Uploads the spark event logs through the runtime service.\n+   */\n+  private static void uploadEventLogs(File eventLogDir, SparkRuntimeContext runtimeContext) throws IOException {\n+\n+    ProgramRunId programRunId = runtimeContext.getProgramRunId();\n+\n+    // Find the event file to upload. There should only be one for the current application.\n+    File eventFile = Optional.ofNullable(eventLogDir.listFiles())\n+      .map(Arrays::stream)\n+      .flatMap(Stream::findFirst)\n+      .orElse(null);", "originalCommit": "57e89749873dcd4d106a7b9e51f5259ddfbefb52", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg5ODU5OA==", "url": "https://github.com/cdapio/cdap/pull/12782#discussion_r493898598", "bodyText": "fixed", "author": "chtyim", "createdAt": "2020-09-23T21:12:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg3NDQ3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg3NDUwOQ==", "url": "https://github.com/cdapio/cdap/pull/12782#discussion_r493874509", "bodyText": "Maybe we can use javax.ws.rs.core.MediaType.APPLICATION_OCTET_STREAM?", "author": "dli357", "createdAt": "2020-09-23T20:27:11Z", "path": "cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/SparkRuntimeUtils.java", "diffHunk": "@@ -262,4 +346,54 @@ protected void doStop() {\n       }\n     };\n   }\n+\n+  /**\n+   * Uploads the spark event logs through the runtime service.\n+   */\n+  private static void uploadEventLogs(File eventLogDir, SparkRuntimeContext runtimeContext) throws IOException {\n+\n+    ProgramRunId programRunId = runtimeContext.getProgramRunId();\n+\n+    // Find the event file to upload. There should only be one for the current application.\n+    File eventFile = Optional.ofNullable(eventLogDir.listFiles())\n+      .map(Arrays::stream)\n+      .flatMap(Stream::findFirst)\n+      .orElse(null);\n+    LOG.debug(\"Uploading event file {} for program run {}\", eventFile, programRunId);\n+\n+    RemoteClient remoteClient = new RemoteClient(runtimeContext.getDiscoveryServiceClient(), Constants.Service.RUNTIME,\n+                                                 new DefaultHttpRequestConfig(false),\n+                                                 Constants.Gateway.INTERNAL_API_VERSION_3 + \"/runtime/namespaces/\");\n+    String path = String.format(\"%s/apps/%s/versions/%s/%s/%s/runs/%s/spark-event-logs/%s\",\n+                                programRunId.getNamespace(),\n+                                programRunId.getApplication(),\n+                                programRunId.getVersion(),\n+                                programRunId.getType().getCategoryName(),\n+                                programRunId.getProgram(),\n+                                programRunId.getRun(),\n+                                eventFile.getName());\n+\n+    Retries.runWithRetries(() -> {\n+      // Stream out the messages\n+      HttpURLConnection urlConn = remoteClient.openConnection(HttpMethod.POST, path);\n+      try {\n+        urlConn.setChunkedStreamingMode(CHUNK_SIZE);\n+        urlConn.setRequestProperty(HttpHeaders.CONTENT_TYPE, \"application/octet-stream\");", "originalCommit": "57e89749873dcd4d106a7b9e51f5259ddfbefb52", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg5ODYxOQ==", "url": "https://github.com/cdapio/cdap/pull/12782#discussion_r493898619", "bodyText": "fixed", "author": "chtyim", "createdAt": "2020-09-23T21:12:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg3NDUwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg3NDU1MA==", "url": "https://github.com/cdapio/cdap/pull/12782#discussion_r493874550", "bodyText": "nit: EventLoggingListener", "author": "dli357", "createdAt": "2020-09-23T20:27:15Z", "path": "cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/SparkRuntimeUtils.java", "diffHunk": "@@ -232,10 +258,68 @@ private void handleCompleted(boolean failure) {\n         if (failure && driverService instanceof SparkDriverService) {\n           ((SparkDriverService) driverService).stopWithoutComplete();\n         } else {\n-          driverService.stopAndWait();\n+          driverService.stop();\n         }\n+\n+        // Wait for the spark execution context to stop to make sure everything related\n+        // to the spark execution is shutdown properly before returning.\n+        // When this method returns, the driver's main thread returns, which will have system services shutdown\n+        // and process terminated. If system services stopped concurrently with the execution context, we may have some\n+        // logs and tasks missing.\n+        Uninterruptibles.awaitUninterruptibly(secStopLatch, 30, TimeUnit.SECONDS);\n+      }\n+    };\n+  }\n+\n+  /**\n+   * Adds a {@link EventLoggingListener} to the Spark context.\n+   *\n+   * @param runtimeContext the {@link SparkRuntimeContext} for connecting to CDAP services\n+   * @return A {@link Closeable} which should be called when the Spark application completed\n+   */\n+  public static Closeable addEventLoggingListener(SparkRuntimeContext runtimeContext) throws IOException {\n+    // If upload event logs is not enabled, just return a dummy closeable\n+    if (!runtimeContext.getCConfiguration().getBoolean(Constants.AppFabric.SPARK_EVENT_LOGS_ENABLED)) {\n+      return () -> { };\n+    }\n+\n+    SparkConf sparkConf = new SparkConf();\n+    sparkConf.set(\"spark.eventLog.enabled\", Boolean.toString(true));\n+    sparkConf.set(\"spark.eventLog.compress\", Boolean.toString(true));\n+\n+    ProgramRunId programRunId = runtimeContext.getProgramRunId();\n+\n+    File eventLogDir = Files.createTempDirectory(\"spark-events\").toFile();\n+    LOG.debug(\"Spark events log directory for {} is {}\", programRunId, eventLogDir);\n+\n+    // EvevntLogginginListener is Scala package private[spark] class.", "originalCommit": "57e89749873dcd4d106a7b9e51f5259ddfbefb52", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg5ODUzMg==", "url": "https://github.com/cdapio/cdap/pull/12782#discussion_r493898532", "bodyText": "fixed", "author": "chtyim", "createdAt": "2020-09-23T21:12:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg3NDU1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg3NzIyMg==", "url": "https://github.com/cdapio/cdap/pull/12782#discussion_r493877222", "bodyText": "Should we log a warning if the wait times out? That way if logs are missing we can easily tell that is was due to the timeout or some other reason.", "author": "dli357", "createdAt": "2020-09-23T20:32:17Z", "path": "cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/SparkRuntimeUtils.java", "diffHunk": "@@ -232,10 +258,68 @@ private void handleCompleted(boolean failure) {\n         if (failure && driverService instanceof SparkDriverService) {\n           ((SparkDriverService) driverService).stopWithoutComplete();\n         } else {\n-          driverService.stopAndWait();\n+          driverService.stop();\n         }\n+\n+        // Wait for the spark execution context to stop to make sure everything related\n+        // to the spark execution is shutdown properly before returning.\n+        // When this method returns, the driver's main thread returns, which will have system services shutdown\n+        // and process terminated. If system services stopped concurrently with the execution context, we may have some\n+        // logs and tasks missing.\n+        Uninterruptibles.awaitUninterruptibly(secStopLatch, 30, TimeUnit.SECONDS);", "originalCommit": "57e89749873dcd4d106a7b9e51f5259ddfbefb52", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg5ODQ4Mw==", "url": "https://github.com/cdapio/cdap/pull/12782#discussion_r493898483", "bodyText": "Added a log", "author": "chtyim", "createdAt": "2020-09-23T21:12:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg3NzIyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzkwODk3MQ==", "url": "https://github.com/cdapio/cdap/pull/12782#discussion_r493908971", "bodyText": "nit: EventLoggingListener instead of EvevntLoggingListener", "author": "dli357", "createdAt": "2020-09-23T21:35:20Z", "path": "cdap-spark-core-base/src/main/java/io/cdap/cdap/app/runtime/spark/SparkRuntimeUtils.java", "diffHunk": "@@ -292,15 +295,15 @@ public static Closeable addEventLoggingListener(SparkRuntimeContext runtimeConte\n     File eventLogDir = Files.createTempDirectory(\"spark-events\").toFile();\n     LOG.debug(\"Spark events log directory for {} is {}\", programRunId, eventLogDir);\n \n-    // EvevntLogginginListener is Scala package private[spark] class.\n+    // EvevntLoggingListener is Scala package private[spark] class.", "originalCommit": "5c65437c6416a142acb171443babf21f591e0c16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzkyMzQ0Mw==", "url": "https://github.com/cdapio/cdap/pull/12782#discussion_r493923443", "bodyText": "fixed", "author": "chtyim", "createdAt": "2020-09-23T22:09:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzkwODk3MQ=="}], "type": "inlineReview"}, {"oid": "0277c884f22733fef51fa556010aa83c015ed7a4", "url": "https://github.com/cdapio/cdap/commit/0277c884f22733fef51fa556010aa83c015ed7a4", "message": "(CDAP-17287) Collection of Spark execution event logs\n\n- Introducing the Spark event logging and upload of logs through the runtime service.\n  Based on the cConf settings, the event logging collection will be on/off regardless\n  of the Spark job spark.eventLog.* configurations.\n- Refactoring of the SparkRuntimeEnv class to simplify the logic by using CompletableFuture.\n- Make runtime system services shutdown after the SparkExecutionContext stopped.\n  Currently they stop concurrently. It is not a problem before this PR since we\n  are not doing any important work at the context stop.\n  However, this PR introduces uploading the event logs at the context stop,\n  which needs to be completed before the system services shutdown and process termination.", "committedDate": "2020-09-23T22:06:12Z", "type": "forcePushed"}, {"oid": "83144b472f95a44f94b5f9a675c994a7563e8042", "url": "https://github.com/cdapio/cdap/commit/83144b472f95a44f94b5f9a675c994a7563e8042", "message": "(CDAP-17287) Collection of Spark execution event logs\n\n- Introducing the Spark event logging and upload of logs through the runtime service.\n  Based on the cConf settings, the event logging collection will be on/off regardless\n  of the Spark job spark.eventLog.* configurations.\n- Refactoring of the SparkRuntimeEnv class to simplify the logic by using CompletableFuture.\n- Make runtime system services shutdown after the SparkExecutionContext stopped.\n  Currently they stop concurrently. It is not a problem before this PR since we\n  are not doing any important work at the context stop.\n  However, this PR introduces uploading the event logs at the context stop,\n  which needs to be completed before the system services shutdown and process termination.", "committedDate": "2020-09-23T22:33:52Z", "type": "forcePushed"}, {"oid": "63aa9a75cc72dbe0cc11b61f7a15fc0c12274427", "url": "https://github.com/cdapio/cdap/commit/63aa9a75cc72dbe0cc11b61f7a15fc0c12274427", "message": "(CDAP-17287) Collection of Spark execution event logs\n\n- Introducing the Spark event logging and upload of logs through the runtime service.\n  Based on the cConf settings, the event logging collection will be on/off regardless\n  of the Spark job spark.eventLog.* configurations.\n- Refactoring of the SparkRuntimeEnv class to simplify the logic by using CompletableFuture.\n- Make runtime system services shutdown after the SparkExecutionContext stopped.\n  Currently they stop concurrently. It is not a problem before this PR since we\n  are not doing any important work at the context stop.\n  However, this PR introduces uploading the event logs at the context stop,\n  which needs to be completed before the system services shutdown and process termination.", "committedDate": "2020-09-23T23:20:09Z", "type": "commit"}, {"oid": "63aa9a75cc72dbe0cc11b61f7a15fc0c12274427", "url": "https://github.com/cdapio/cdap/commit/63aa9a75cc72dbe0cc11b61f7a15fc0c12274427", "message": "(CDAP-17287) Collection of Spark execution event logs\n\n- Introducing the Spark event logging and upload of logs through the runtime service.\n  Based on the cConf settings, the event logging collection will be on/off regardless\n  of the Spark job spark.eventLog.* configurations.\n- Refactoring of the SparkRuntimeEnv class to simplify the logic by using CompletableFuture.\n- Make runtime system services shutdown after the SparkExecutionContext stopped.\n  Currently they stop concurrently. It is not a problem before this PR since we\n  are not doing any important work at the context stop.\n  However, this PR introduces uploading the event logs at the context stop,\n  which needs to be completed before the system services shutdown and process termination.", "committedDate": "2020-09-23T23:20:09Z", "type": "forcePushed"}]}