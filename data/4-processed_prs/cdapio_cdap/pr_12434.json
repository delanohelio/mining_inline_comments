{"pr_number": 12434, "pr_title": "[CDAP-17015] Update Preview UI to handle queued preview runs", "pr_createdAt": "2020-07-01T20:50:23Z", "pr_url": "https://github.com/cdapio/cdap/pull/12434", "timeline": [{"oid": "a89df0130aa4dd6393fbd47f814f344c0472c321", "url": "https://github.com/cdapio/cdap/commit/a89df0130aa4dd6393fbd47f814f344c0472c321", "message": "Add error message extracting helper function to myHelpers and clean up top panel ctrl", "committedDate": "2020-07-01T21:03:38Z", "type": "forcePushed"}, {"oid": "c2df23fbd0cbb19f796b7be9911f105909cd7b60", "url": "https://github.com/cdapio/cdap/commit/c2df23fbd0cbb19f796b7be9911f105909cd7b60", "message": "Add helper functions for setting timer label, title, and start time and for extracting error messages", "committedDate": "2020-07-01T21:10:08Z", "type": "forcePushed"}, {"oid": "fe105311b2585a874aa13141fe0566bd6c32bff5", "url": "https://github.com/cdapio/cdap/commit/fe105311b2585a874aa13141fe0566bd6c32bff5", "message": "Add helper functions for setting timer label, title, and start time\n\nAdd error message extracting helper function to myHelpers and clean up top panel ctrl", "committedDate": "2020-07-01T21:34:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3NTc5Nw==", "url": "https://github.com/cdapio/cdap/pull/12434#discussion_r448675797", "bodyText": "I18n?", "author": "njbriggs", "createdAt": "2020-07-01T23:59:27Z", "path": "cdap-ui/app/hydrator/controllers/create/toppanel-ctrl.js", "diffHunk": "@@ -294,10 +304,36 @@ class HydratorPlusPlusTopPanelCtrl {\n     seconds = seconds < 10 ? '0' + seconds : seconds;\n     minutes = minutes < 10 ? '0' + minutes : minutes;\n \n+    this.setDisplayDuration(minutes, seconds);\n+  }\n+\n+  setDisplayDuration(minutes, seconds) {\n     this.displayDuration = {\n-      minutes: minutes,\n-      seconds: seconds\n-    };\n+      minutes: !minutes ? '--' : minutes,\n+      seconds: !seconds ? '--' : seconds,\n+    }\n+  }\n+\n+  updateTimerLabelAndTitle(res) {\n+    // set default\n+    if (!res) {\n+      this.timerLabel = 'Duration';\n+      this.queueStatus = '';\n+      return;\n+    }\n+\n+    const { WAITING, ACQUIRED, INIT, RUNNING } = window.CaskCommon.PREVIEW_STATUS;\n+    if (res.status === WAITING) {\n+      const runsAheadInQueue = res.positionInWaitingQueue;\n+      this.queueStatus = `${runsAheadInQueue} ${runsAheadInQueue === 1? 'run' : 'runs'} ahead in queue`;", "originalCommit": "fe105311b2585a874aa13141fe0566bd6c32bff5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM2NjA3NQ==", "url": "https://github.com/cdapio/cdap/pull/12434#discussion_r450366075", "bodyText": "Good question - we don't have i18n for the angular app (just for the react side).", "author": "yukiej", "createdAt": "2020-07-06T17:13:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3NTc5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM3MjI4Mg==", "url": "https://github.com/cdapio/cdap/pull/12434#discussion_r450372282", "bodyText": "OK then. Is the plan to add I18n as components are converted to React?", "author": "njbriggs", "createdAt": "2020-07-06T17:25:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3NTc5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM4ODYxNA==", "url": "https://github.com/cdapio/cdap/pull/12434#discussion_r450388614", "bodyText": "I believe so. @ajainarayanan might be able to add more context!", "author": "yukiej", "createdAt": "2020-07-06T17:56:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3NTc5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg0MjEwMQ==", "url": "https://github.com/cdapio/cdap/pull/12434#discussion_r453842101", "bodyText": "We don't have a complete story on i18n. We need to rethink how we do i18n. Right now we have a yaml file that we build and ship along with code which takes the away the benefit of i18n (since we can change the language. If we need to we then have to generate a new build). We will have to revisit i18n once we migrate the entirety of angular to react.", "author": "ajainarayanan", "createdAt": "2020-07-13T18:20:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3NTc5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI2MjUxNg==", "url": "https://github.com/cdapio/cdap/pull/12434#discussion_r451262516", "bodyText": "Could we have enum for this?", "author": "jennac3", "createdAt": "2020-07-08T03:34:24Z", "path": "cdap-ui/app/cdap/components/Alert/index.js", "diffHunk": "@@ -61,12 +58,16 @@ export default class Alert extends Component {\n         element,\n       });\n     }\n-    if (this.state.type === 'success') {\n-      clearTimeout(this.successTimeout);\n-      this.successTimeout = setTimeout(this.onClose, SUCCESS_CLOSE_TIMEOUT);\n-    }\n+    this.resetTimeout();\n   }\n \n+  resetTimeout = () => {\n+    if (this.state.type === 'success' || this.state.type === 'info') {", "originalCommit": "fe105311b2585a874aa13141fe0566bd6c32bff5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzAwNDQ5Ng==", "url": "https://github.com/cdapio/cdap/pull/12434#discussion_r453004496", "bodyText": "Good idea, done!", "author": "yukiej", "createdAt": "2020-07-10T18:26:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI2MjUxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI2MjUzNA==", "url": "https://github.com/cdapio/cdap/pull/12434#discussion_r451262534", "bodyText": "Could we have enum for this?", "author": "jennac3", "createdAt": "2020-07-08T03:34:29Z", "path": "cdap-ui/app/services/alert-on-valium/alert-on-valium.js", "diffHunk": "@@ -19,14 +19,14 @@ angular.module(PKG.name + '.services')\n     var isAnAlertOpened = false,\n         alertObj;\n \n-    var SUCCESS_ALERT_DURATION = 4; // duration amount in seconds\n+    var SUCCESS_ALERT_DURATION = 3; // duration amount in seconds\n \n     function show(obj) {\n       if (alertObj) {\n         alertObj.hide();\n       }\n \n-      obj.duration = obj.type === 'success' ? SUCCESS_ALERT_DURATION : false;\n+      obj.duration = obj.type === 'success' || obj.type === 'info' ? SUCCESS_ALERT_DURATION : false;", "originalCommit": "fe105311b2585a874aa13141fe0566bd6c32bff5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzAwNDQ2MA==", "url": "https://github.com/cdapio/cdap/pull/12434#discussion_r453004460", "bodyText": "Done!", "author": "yukiej", "createdAt": "2020-07-10T18:26:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI2MjUzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI2Mjg2Mg==", "url": "https://github.com/cdapio/cdap/pull/12434#discussion_r451262862", "bodyText": "Is this intended to be \"{{HydratorPlusPlusTopPanelCtrl.queueStatus}}\"? Could it be perhaps {{HydratorPlusPlusTopPanelCtrl.queueStatus}} instead?", "author": "jennac3", "createdAt": "2020-07-08T03:35:43Z", "path": "cdap-ui/app/hydrator/templates/create/toppanel.html", "diffHunk": "@@ -232,12 +232,12 @@\n         </div>\n       </div>\n     </div>\n-    <div class=\"btn run-time\">\n+    <div class=\"btn run-time\" title=\"{{HydratorPlusPlusTopPanelCtrl.queueStatus}}\">", "originalCommit": "fe105311b2585a874aa13141fe0566bd6c32bff5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzAwNDM1OQ==", "url": "https://github.com/cdapio/cdap/pull/12434#discussion_r453004359", "bodyText": "Since the expression is being used for an attribute, we need double quotes around it.", "author": "yukiej", "createdAt": "2020-07-10T18:26:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI2Mjg2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3MTgyNA==", "url": "https://github.com/cdapio/cdap/pull/12434#discussion_r453071824", "bodyText": "Ah I see! Thanks for clarifying it :)", "author": "jennac3", "createdAt": "2020-07-10T20:52:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI2Mjg2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI2MzI4Ng==", "url": "https://github.com/cdapio/cdap/pull/12434#discussion_r451263286", "bodyText": "Could we use PREVIEW_STATUS for 'Running' and 'Duration'?", "author": "jennac3", "createdAt": "2020-07-08T03:37:09Z", "path": "cdap-ui/app/hydrator/controllers/create/toppanel-ctrl.js", "diffHunk": "@@ -294,10 +304,36 @@ class HydratorPlusPlusTopPanelCtrl {\n     seconds = seconds < 10 ? '0' + seconds : seconds;\n     minutes = minutes < 10 ? '0' + minutes : minutes;\n \n+    this.setDisplayDuration(minutes, seconds);\n+  }\n+\n+  setDisplayDuration(minutes, seconds) {\n     this.displayDuration = {\n-      minutes: minutes,\n-      seconds: seconds\n-    };\n+      minutes: !minutes ? '--' : minutes,\n+      seconds: !seconds ? '--' : seconds,\n+    }\n+  }\n+\n+  updateTimerLabelAndTitle(res) {\n+    // set default\n+    if (!res) {\n+      this.timerLabel = 'Duration';\n+      this.queueStatus = '';\n+      return;\n+    }\n+\n+    const { WAITING, ACQUIRED, INIT, RUNNING } = window.CaskCommon.PREVIEW_STATUS;\n+    if (res.status === WAITING) {\n+      const runsAheadInQueue = res.positionInWaitingQueue;\n+      this.queueStatus = `${runsAheadInQueue} ${runsAheadInQueue === 1? 'run' : 'runs'} ahead in queue`;\n+      this.timerLabel = `${runsAheadInQueue} Pending`;\n+    } else if ([ ACQUIRED, INIT, RUNNING ].includes(res.status) && this.loadingLabel !== 'Stopping') {\n+      this.timerLabel = 'Running';", "originalCommit": "fe105311b2585a874aa13141fe0566bd6c32bff5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk5NzA5MA==", "url": "https://github.com/cdapio/cdap/pull/12434#discussion_r452997090", "bodyText": "That is an interesting idea! I'm not sure it makes sense to use PREVIEW_STATUS for the timer labels, since they sometimes don't correlate and \"Duration\" is not a preview status.", "author": "yukiej", "createdAt": "2020-07-10T18:10:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI2MzI4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3MTk4Mg==", "url": "https://github.com/cdapio/cdap/pull/12434#discussion_r453071982", "bodyText": "Alrighty!", "author": "jennac3", "createdAt": "2020-07-10T20:53:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI2MzI4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgzNzQ5NQ==", "url": "https://github.com/cdapio/cdap/pull/12434#discussion_r453837495", "bodyText": "Since this is purely used in Alert component can we co-locate this with Alert component?\nWould be better if we convert the Alert to typescript and add the enum to the same class as a static variable. That way components using Alert don't need to import this as an extra they can just use it as a static variable.", "author": "ajainarayanan", "createdAt": "2020-07-13T18:12:15Z", "path": "cdap-ui/app/cdap/services/AlertStatus.ts", "diffHunk": "@@ -0,0 +1,23 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+enum ALERT_STATUS {\n+  Success = 'success',", "originalCommit": "f9767acc48d9dcfef882291d9a64bda0ce40e6c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjUwNjg0Nw==", "url": "https://github.com/cdapio/cdap/pull/12434#discussion_r456506847", "bodyText": "As we discussed, I've created a JIRA and TO DO comment to track converting the component to TS in a separate PR.", "author": "yukiej", "createdAt": "2020-07-17T15:15:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgzNzQ5NQ=="}], "type": "inlineReview"}, {"oid": "8e38cbaadae2353bcb68ef4b623d3a90839ed7d9", "url": "https://github.com/cdapio/cdap/commit/8e38cbaadae2353bcb68ef4b623d3a90839ed7d9", "message": "Update preview statuses and button messaging to include WAITING and ACQUIRED", "committedDate": "2020-07-20T20:57:57Z", "type": "forcePushed"}, {"oid": "f6ff517a472cbdee4e76b1f3090732133f0c9874", "url": "https://github.com/cdapio/cdap/commit/f6ff517a472cbdee4e76b1f3090732133f0c9874", "message": "Update preview statuses and button messaging to include WAITING and ACQUIRED", "committedDate": "2020-08-17T20:16:34Z", "type": "forcePushed"}, {"oid": "f320167677a4f1d0a4b7dbb1107df99e009c9d9f", "url": "https://github.com/cdapio/cdap/commit/f320167677a4f1d0a4b7dbb1107df99e009c9d9f", "message": "Update preview statuses and button messaging to include WAITING and ACQUIRED", "committedDate": "2020-08-17T22:34:12Z", "type": "forcePushed"}, {"oid": "9cf73bc35b721d409b4acfbfaf02acc07e539eed", "url": "https://github.com/cdapio/cdap/commit/9cf73bc35b721d409b4acfbfaf02acc07e539eed", "message": "Update alert component to handle info case", "committedDate": "2020-08-18T01:30:56Z", "type": "commit"}, {"oid": "70af6a87ce1a7b75e5c1387fe3949754c9abfd09", "url": "https://github.com/cdapio/cdap/commit/70af6a87ce1a7b75e5c1387fe3949754c9abfd09", "message": "Update preview statuses and button messaging to include WAITING and ACQUIRED", "committedDate": "2020-08-18T01:30:57Z", "type": "commit"}, {"oid": "70af6a87ce1a7b75e5c1387fe3949754c9abfd09", "url": "https://github.com/cdapio/cdap/commit/70af6a87ce1a7b75e5c1387fe3949754c9abfd09", "message": "Update preview statuses and button messaging to include WAITING and ACQUIRED", "committedDate": "2020-08-18T01:30:57Z", "type": "forcePushed"}]}