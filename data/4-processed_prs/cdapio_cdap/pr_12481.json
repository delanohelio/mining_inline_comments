{"pr_number": 12481, "pr_title": "(CDAP-17095) Add support for Distribution in AutoJoiner API", "pr_createdAt": "2020-07-21T23:36:19Z", "pr_url": "https://github.com/cdapio/cdap/pull/12481", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1Mjc2NA==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458452764", "bodyText": "Integer -> int, since we don't want it to ever be null", "author": "albertshau", "createdAt": "2020-07-21T23:48:59Z", "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDefinition.java", "diffHunk": "@@ -121,11 +129,25 @@ public Builder setOutputSchemaName(@Nullable String name) {\n       return this;\n     }\n \n+    /**\n+     * Set the distribution factor and stage name of the skewed stage. This should be set if the join being performed\n+     * is skewed (ie. joining a large dataset with a small dataset) and the \"small\" dataset is too large to broadcast.\n+     *\n+     * @param size      The number of distributions to split each key into. Note that the smaller dataset will grow by\n+     *                  this factor, values greater than 20 are not recommended\n+     * @param stageName The name of the input stage that contains the skewed data\n+     * @return\n+     */\n+    public Builder setDistributionFactor(Integer size, String stageName) {", "originalCommit": "ff1af39d142a30dca205c996568d0b53e77fd23e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4NDM0OQ==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458984349", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-07-22T18:05:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1Mjc2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1MzAwNQ==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458453005", "bodyText": "Integer -> int", "author": "albertshau", "createdAt": "2020-07-21T23:49:42Z", "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDistribution.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.etl.api.join;\n+\n+import io.cdap.cdap.etl.api.join.error.JoinError;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.List;\n+\n+/**\n+ * Join distribution settings for salting/exploding datasets to resolve skew\n+ */\n+public class JoinDistribution {\n+\n+  private final Integer distributionFactor;", "originalCommit": "ff1af39d142a30dca205c996568d0b53e77fd23e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4NDYyOA==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458984628", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-07-22T18:05:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1MzAwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1MzA4Ng==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458453086", "bodyText": "add space after )", "author": "albertshau", "createdAt": "2020-07-21T23:49:57Z", "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDistribution.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.etl.api.join;\n+\n+import io.cdap.cdap.etl.api.join.error.JoinError;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.List;\n+\n+/**\n+ * Join distribution settings for salting/exploding datasets to resolve skew\n+ */\n+public class JoinDistribution {\n+\n+  private final Integer distributionFactor;\n+  private final String skewedStageName;\n+\n+  public JoinDistribution(Integer distributionFactor, String skewedStageName) {\n+    this.distributionFactor = distributionFactor;\n+    this.skewedStageName = skewedStageName;\n+  }\n+\n+  public Integer getDistributionFactor() {\n+    return distributionFactor;\n+  }\n+\n+  public String getSkewedStageName() {\n+    return skewedStageName;\n+  }\n+\n+  public Collection<JoinError> validate(Collection<String> stageNames) {\n+    List<JoinError> errors = new ArrayList<>();\n+\n+    if (stageNames.size() > 2) {\n+      errors.add(new JoinError(\"Only two stages can be specified if a distribution factor is specified\"));\n+    }\n+\n+    if (distributionFactor == null || skewedStageName == null) {\n+      errors.add(new JoinError(\"Distribution factor requires both size and skewed stage name to be defined\"));\n+    }\n+\n+    if (distributionFactor!= null && distributionFactor < 1){", "originalCommit": "ff1af39d142a30dca205c996568d0b53e77fd23e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTEwOTM4OA==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r459109388", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-07-22T22:02:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1MzA4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1MzYzOA==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458453638", "bodyText": "this doesn't look like it belongs here, as these strings are a spark implementation detail.", "author": "albertshau", "createdAt": "2020-07-21T23:51:39Z", "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDistribution.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.etl.api.join;\n+\n+import io.cdap.cdap.etl.api.join.error.JoinError;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.List;\n+\n+/**\n+ * Join distribution settings for salting/exploding datasets to resolve skew\n+ */\n+public class JoinDistribution {\n+\n+  private final Integer distributionFactor;\n+  private final String skewedStageName;\n+\n+  public JoinDistribution(Integer distributionFactor, String skewedStageName) {\n+    this.distributionFactor = distributionFactor;\n+    this.skewedStageName = skewedStageName;\n+  }\n+\n+  public Integer getDistributionFactor() {\n+    return distributionFactor;\n+  }\n+\n+  public String getSkewedStageName() {\n+    return skewedStageName;\n+  }\n+\n+  public Collection<JoinError> validate(Collection<String> stageNames) {\n+    List<JoinError> errors = new ArrayList<>();\n+\n+    if (stageNames.size() > 2) {\n+      errors.add(new JoinError(\"Only two stages can be specified if a distribution factor is specified\"));\n+    }\n+\n+    if (distributionFactor == null || skewedStageName == null) {\n+      errors.add(new JoinError(\"Distribution factor requires both size and skewed stage name to be defined\"));\n+    }\n+\n+    if (distributionFactor!= null && distributionFactor < 1){\n+      errors.add(new JoinError(\"Distribution size must be greater than 0\"));\n+    }\n+\n+    //If skewedStageName does not match any of the names in stages\n+    if (skewedStageName != null && !stageNames.contains(skewedStageName)) {\n+      errors.add(new JoinError(\n+        String.format(\"Skewed stage name '%s' does not match any of the specified stages\", skewedStageName\n+        )));\n+    }\n+    return errors;\n+  }\n+\n+  public static List<String> getSupportedJoinTypes(){", "originalCommit": "ff1af39d142a30dca205c996568d0b53e77fd23e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTEwOTM0NA==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r459109344", "bodyText": "removed.", "author": "MEseifan", "createdAt": "2020-07-22T22:02:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1MzYzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1NDUzNA==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458454534", "bodyText": "nit: can be specified -> can be joined", "author": "albertshau", "createdAt": "2020-07-21T23:54:29Z", "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDistribution.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.etl.api.join;\n+\n+import io.cdap.cdap.etl.api.join.error.JoinError;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.List;\n+\n+/**\n+ * Join distribution settings for salting/exploding datasets to resolve skew\n+ */\n+public class JoinDistribution {\n+\n+  private final Integer distributionFactor;\n+  private final String skewedStageName;\n+\n+  public JoinDistribution(Integer distributionFactor, String skewedStageName) {\n+    this.distributionFactor = distributionFactor;\n+    this.skewedStageName = skewedStageName;\n+  }\n+\n+  public Integer getDistributionFactor() {\n+    return distributionFactor;\n+  }\n+\n+  public String getSkewedStageName() {\n+    return skewedStageName;\n+  }\n+\n+  public Collection<JoinError> validate(Collection<String> stageNames) {\n+    List<JoinError> errors = new ArrayList<>();\n+\n+    if (stageNames.size() > 2) {\n+      errors.add(new JoinError(\"Only two stages can be specified if a distribution factor is specified\"));", "originalCommit": "98597b426c327030b458967e156a33c67c4856a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4NDk3NQ==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458984975", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-07-22T18:06:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1NDUzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1NDc3MQ==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458454771", "bodyText": "should also check that this is an inner or left outer join, which just means checking that the skewed stage is required. Should also check that neither stage is being broadcast, as there is no point salting if a broadcast is done. You'll have to change the input to be the JoinStages instead of just the names.", "author": "albertshau", "createdAt": "2020-07-21T23:55:12Z", "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDistribution.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.etl.api.join;\n+\n+import io.cdap.cdap.etl.api.join.error.JoinError;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.List;\n+\n+/**\n+ * Join distribution settings for salting/exploding datasets to resolve skew\n+ */\n+public class JoinDistribution {\n+\n+  private final Integer distributionFactor;\n+  private final String skewedStageName;\n+\n+  public JoinDistribution(Integer distributionFactor, String skewedStageName) {\n+    this.distributionFactor = distributionFactor;\n+    this.skewedStageName = skewedStageName;\n+  }\n+\n+  public Integer getDistributionFactor() {\n+    return distributionFactor;\n+  }\n+\n+  public String getSkewedStageName() {\n+    return skewedStageName;\n+  }\n+\n+  public Collection<JoinError> validate(Collection<String> stageNames) {\n+    List<JoinError> errors = new ArrayList<>();\n+\n+    if (stageNames.size() > 2) {\n+      errors.add(new JoinError(\"Only two stages can be specified if a distribution factor is specified\"));\n+    }\n+\n+    if (distributionFactor == null || skewedStageName == null) {\n+      errors.add(new JoinError(\"Distribution factor requires both size and skewed stage name to be defined\"));\n+    }\n+\n+    if (distributionFactor != null && distributionFactor < 1) {\n+      errors.add(new JoinError(\"Distribution size must be greater than 0\"));\n+    }\n+\n+    //If skewedStageName does not match any of the names in stages\n+    if (skewedStageName != null && !stageNames.contains(skewedStageName)) {\n+      errors.add(new JoinError(\n+        String.format(\"Skewed stage name '%s' does not match any of the specified stages\", skewedStageName\n+        )));\n+    }\n+    return errors;", "originalCommit": "98597b426c327030b458967e156a33c67c4856a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwMDY0MA==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r459000640", "bodyText": "Done", "author": "MEseifan", "createdAt": "2020-07-22T18:34:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1NDc3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1NTM2NQ==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458455365", "bodyText": "this fits better in the spark code, as \"inner\" and \"leftouter\" are the string values used by spark and not used anywhere by this class.", "author": "albertshau", "createdAt": "2020-07-21T23:57:01Z", "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDistribution.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.etl.api.join;\n+\n+import io.cdap.cdap.etl.api.join.error.JoinError;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.List;\n+\n+/**\n+ * Join distribution settings for salting/exploding datasets to resolve skew\n+ */\n+public class JoinDistribution {\n+\n+  private final Integer distributionFactor;\n+  private final String skewedStageName;\n+\n+  public JoinDistribution(Integer distributionFactor, String skewedStageName) {\n+    this.distributionFactor = distributionFactor;\n+    this.skewedStageName = skewedStageName;\n+  }\n+\n+  public Integer getDistributionFactor() {\n+    return distributionFactor;\n+  }\n+\n+  public String getSkewedStageName() {\n+    return skewedStageName;\n+  }\n+\n+  public Collection<JoinError> validate(Collection<String> stageNames) {\n+    List<JoinError> errors = new ArrayList<>();\n+\n+    if (stageNames.size() > 2) {\n+      errors.add(new JoinError(\"Only two stages can be specified if a distribution factor is specified\"));\n+    }\n+\n+    if (distributionFactor == null || skewedStageName == null) {\n+      errors.add(new JoinError(\"Distribution factor requires both size and skewed stage name to be defined\"));\n+    }\n+\n+    if (distributionFactor != null && distributionFactor < 1) {\n+      errors.add(new JoinError(\"Distribution size must be greater than 0\"));\n+    }\n+\n+    //If skewedStageName does not match any of the names in stages\n+    if (skewedStageName != null && !stageNames.contains(skewedStageName)) {\n+      errors.add(new JoinError(\n+        String.format(\"Skewed stage name '%s' does not match any of the specified stages\", skewedStageName\n+        )));\n+    }\n+    return errors;\n+  }\n+\n+  public static List<String> getSupportedJoinTypes() {", "originalCommit": "98597b426c327030b458967e156a33c67c4856a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwMTcyOA==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r459001728", "bodyText": "I removed this and updated it to check if the left is required instead of doing a string comparison", "author": "MEseifan", "createdAt": "2020-07-22T18:35:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1NTM2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1NTQ5Ng==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458455496", "bodyText": "annotate as nullable", "author": "albertshau", "createdAt": "2020-07-21T23:57:30Z", "path": "cdap-app-templates/cdap-etl/hydrator-spark-core-base/src/main/java/io/cdap/cdap/etl/spark/join/JoinRequest.java", "diffHunk": "@@ -36,10 +37,11 @@\n   private final Schema outputSchema;\n   private final List<JoinCollection> toJoin;\n   private final Integer numPartitions;\n+  private final JoinDistribution distribution;\n \n   public JoinRequest(String stageName, String leftStage, List<String> leftKey, Schema leftSchema, boolean leftRequired,\n                      boolean nullSafe, List<JoinField> fields, Schema outputSchema, List<JoinCollection> toJoin,\n-                     @Nullable Integer numPartitions) {\n+                     @Nullable Integer numPartitions, JoinDistribution distribution) {", "originalCommit": "98597b426c327030b458967e156a33c67c4856a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwMTk0NQ==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r459001945", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-07-22T18:36:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1NTQ5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1NTUxNA==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458455514", "bodyText": "annotate as nullable", "author": "albertshau", "createdAt": "2020-07-21T23:57:33Z", "path": "cdap-app-templates/cdap-etl/hydrator-spark-core-base/src/main/java/io/cdap/cdap/etl/spark/join/JoinRequest.java", "diffHunk": "@@ -50,6 +52,11 @@ public JoinRequest(String stageName, String leftStage, List<String> leftKey, Sch\n     this.outputSchema = outputSchema;\n     this.toJoin = toJoin;\n     this.numPartitions = numPartitions;\n+    this.distribution = distribution;\n+  }\n+\n+  public JoinDistribution getDistribution() {", "originalCommit": "98597b426c327030b458967e156a33c67c4856a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwMjA3NQ==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r459002075", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-07-22T18:36:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1NTUxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1NTk3OQ==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458455979", "bodyText": "does the hardcoded udf name cause an issue if there are multiple salted joins that use different distribution factors?", "author": "albertshau", "createdAt": "2020-07-21T23:59:13Z", "path": "cdap-app-templates/cdap-etl/hydrator-spark-core/src/main/java/io/cdap/cdap/etl/spark/batch/RDDCollection.java", "diffHunk": "@@ -123,6 +126,54 @@ public RDDCollection(JavaSparkExecutionContext sec, JavaSparkContext jsc, SQLCon\n       }\n       seenRequired = seenRequired || toJoin.isRequired();\n \n+      // UUID for salt column name to avoid name collisions\n+      String saltColumn = UUID.randomUUID().toString();\n+      if (joinRequest.isDistributionEnabled() && JoinDistribution.getSupportedJoinTypes().contains(joinType)) {\n+\n+        final String SALT_UDF = \"salt\";\n+        final String PREPARE_EXPLODE_UDF = \"prepare_explode\";\n+\n+        //Array of [0,distributionFactor) to be used in the PrepareExplode step\n+        Integer[] numbers =\n+          IntStream.range(0, joinRequest.getDistribution().getDistributionFactor()).boxed().toArray(Integer[]::new);\n+\n+        // Register UserDefinedFunctions for use later\n+        sqlContext.udf().register(PREPARE_EXPLODE_UDF, prepareExplodeUDF(numbers),", "originalCommit": "98597b426c327030b458967e156a33c67c4856a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1NzAyOA==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458457028", "bodyText": "it may be more straightforward to map the RDDs before changing them to DataFrames instead of using UDFs.", "author": "albertshau", "createdAt": "2020-07-22T00:02:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1NTk3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTEwOTYwMw==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r459109603", "bodyText": "Removed the UDFs", "author": "MEseifan", "createdAt": "2020-07-22T22:03:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1NTk3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1NjUxMA==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458456510", "bodyText": "capitalized variables should be static (I thought checkstyle would complain about this?)", "author": "albertshau", "createdAt": "2020-07-22T00:01:00Z", "path": "cdap-app-templates/cdap-etl/hydrator-spark-core/src/main/java/io/cdap/cdap/etl/spark/batch/RDDCollection.java", "diffHunk": "@@ -123,6 +126,54 @@ public RDDCollection(JavaSparkExecutionContext sec, JavaSparkContext jsc, SQLCon\n       }\n       seenRequired = seenRequired || toJoin.isRequired();\n \n+      // UUID for salt column name to avoid name collisions\n+      String saltColumn = UUID.randomUUID().toString();\n+      if (joinRequest.isDistributionEnabled() && JoinDistribution.getSupportedJoinTypes().contains(joinType)) {\n+\n+        final String SALT_UDF = \"salt\";", "originalCommit": "98597b426c327030b458967e156a33c67c4856a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTEwOTgxNA==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r459109814", "bodyText": "It did...I fixed it in the following commit", "author": "MEseifan", "createdAt": "2020-07-22T22:03:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1NjUxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1NzI5MQ==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458457291", "bodyText": "don't need to be final", "author": "albertshau", "createdAt": "2020-07-22T00:03:35Z", "path": "cdap-app-templates/cdap-etl/hydrator-spark-core/src/main/java/io/cdap/cdap/etl/spark/batch/RDDCollection.java", "diffHunk": "@@ -123,6 +126,54 @@ public RDDCollection(JavaSparkExecutionContext sec, JavaSparkContext jsc, SQLCon\n       }\n       seenRequired = seenRequired || toJoin.isRequired();\n \n+      // UUID for salt column name to avoid name collisions\n+      String saltColumn = UUID.randomUUID().toString();\n+      if (joinRequest.isDistributionEnabled() && JoinDistribution.getSupportedJoinTypes().contains(joinType)) {\n+\n+        final String saltUDF = \"salt\";", "originalCommit": "81e9240e907c036f15eaaaf0c7529d4bf1498a18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwMjQ1NQ==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r459002455", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-07-22T18:37:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1NzI5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1NzQ3OA==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458457478", "bodyText": "is the name supposed to be unique? Seems like there would be issues if multiple salted joins are in the same pipeline, but they both use different distribution factors.", "author": "albertshau", "createdAt": "2020-07-22T00:04:10Z", "path": "cdap-app-templates/cdap-etl/hydrator-spark-core/src/main/java/io/cdap/cdap/etl/spark/batch/RDDCollection.java", "diffHunk": "@@ -123,6 +126,54 @@ public RDDCollection(JavaSparkExecutionContext sec, JavaSparkContext jsc, SQLCon\n       }\n       seenRequired = seenRequired || toJoin.isRequired();\n \n+      // UUID for salt column name to avoid name collisions\n+      String saltColumn = UUID.randomUUID().toString();\n+      if (joinRequest.isDistributionEnabled() && JoinDistribution.getSupportedJoinTypes().contains(joinType)) {\n+\n+        final String saltUDF = \"salt\";\n+        final String prepareExplodeUDF = \"prepare_explode\";\n+\n+        //Array of [0,distributionFactor) to be used in the PrepareExplode step\n+        Integer[] numbers =\n+          IntStream.range(0, joinRequest.getDistribution().getDistributionFactor()).boxed().toArray(Integer[]::new);\n+\n+        // Register UserDefinedFunctions for use later\n+        sqlContext.udf().register(prepareExplodeUDF, prepareExplodeUDF(numbers),", "originalCommit": "81e9240e907c036f15eaaaf0c7529d4bf1498a18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1OTQwNA==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458459404", "bodyText": "could this be done without a UDF? If there's a way to give a constant value followed by an explode?", "author": "albertshau", "createdAt": "2020-07-22T00:10:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1NzQ3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTEwOTE5OA==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r459109198", "bodyText": "Yes that is possible, I chose a UDF because that will probably be needed if we want to implement the option to filter which rows get exploded. But like we discussed offline, UDFs have some unknowns so I've updated this to use a constant value.", "author": "MEseifan", "createdAt": "2020-07-22T22:02:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1NzQ3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1ODYyNQ==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458458625", "bodyText": "shouldn't ignore case, stage names are case sensitive.", "author": "albertshau", "createdAt": "2020-07-22T00:08:05Z", "path": "cdap-app-templates/cdap-etl/hydrator-spark-core/src/main/java/io/cdap/cdap/etl/spark/batch/RDDCollection.java", "diffHunk": "@@ -123,6 +126,54 @@ public RDDCollection(JavaSparkExecutionContext sec, JavaSparkContext jsc, SQLCon\n       }\n       seenRequired = seenRequired || toJoin.isRequired();\n \n+      // UUID for salt column name to avoid name collisions\n+      String saltColumn = UUID.randomUUID().toString();\n+      if (joinRequest.isDistributionEnabled() && JoinDistribution.getSupportedJoinTypes().contains(joinType)) {\n+\n+        final String saltUDF = \"salt\";\n+        final String prepareExplodeUDF = \"prepare_explode\";\n+\n+        //Array of [0,distributionFactor) to be used in the PrepareExplode step\n+        Integer[] numbers =\n+          IntStream.range(0, joinRequest.getDistribution().getDistributionFactor()).boxed().toArray(Integer[]::new);\n+\n+        // Register UserDefinedFunctions for use later\n+        sqlContext.udf().register(prepareExplodeUDF, prepareExplodeUDF(numbers),\n+                                  DataTypes.createArrayType(DataTypes.IntegerType));\n+        sqlContext.udf().register(saltUDF, saltUDF(joinRequest.getDistribution().getDistributionFactor()),\n+                                  DataTypes.IntegerType);\n+\n+        // Assign the correct UFD to each side depending on the skew\n+        boolean isLeftStageSkewed =\n+          joinRequest.getLeftStage().equalsIgnoreCase(joinRequest.getDistribution().getSkewedStageName());", "originalCommit": "81e9240e907c036f15eaaaf0c7529d4bf1498a18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwNDc2Mw==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r459004763", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-07-22T18:41:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1ODYyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1ODc5NA==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458458794", "bodyText": "could this be done without a UDF? maybe using a combination of rand, multiplication, and floor?", "author": "albertshau", "createdAt": "2020-07-22T00:08:48Z", "path": "cdap-app-templates/cdap-etl/hydrator-spark-core/src/main/java/io/cdap/cdap/etl/spark/batch/RDDCollection.java", "diffHunk": "@@ -123,6 +126,54 @@ public RDDCollection(JavaSparkExecutionContext sec, JavaSparkContext jsc, SQLCon\n       }\n       seenRequired = seenRequired || toJoin.isRequired();\n \n+      // UUID for salt column name to avoid name collisions\n+      String saltColumn = UUID.randomUUID().toString();\n+      if (joinRequest.isDistributionEnabled() && JoinDistribution.getSupportedJoinTypes().contains(joinType)) {\n+\n+        final String saltUDF = \"salt\";\n+        final String prepareExplodeUDF = \"prepare_explode\";\n+\n+        //Array of [0,distributionFactor) to be used in the PrepareExplode step\n+        Integer[] numbers =\n+          IntStream.range(0, joinRequest.getDistribution().getDistributionFactor()).boxed().toArray(Integer[]::new);\n+\n+        // Register UserDefinedFunctions for use later\n+        sqlContext.udf().register(prepareExplodeUDF, prepareExplodeUDF(numbers),\n+                                  DataTypes.createArrayType(DataTypes.IntegerType));\n+        sqlContext.udf().register(saltUDF, saltUDF(joinRequest.getDistribution().getDistributionFactor()),", "originalCommit": "81e9240e907c036f15eaaaf0c7529d4bf1498a18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwNDU2Ng==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r459004566", "bodyText": "Yes that is an option, I was unsure if three built-in functions would be faster than one UDF. I will test it and update this thread", "author": "MEseifan", "createdAt": "2020-07-22T18:40:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1ODc5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAxNDk1NQ==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r459014955", "bodyText": "Discussed with Albert offline, we agreed that there is likely no performance difference between the two approaches but there are some unknowns around UDF registration/usage if there are multiple salted joins in the same pipeline. So for now, we will use the built-in functions", "author": "MEseifan", "createdAt": "2020-07-22T18:58:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1ODc5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1OTgzMA==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458459830", "bodyText": "JoinDistribution should validate the join type earlier, which will let you remove the type check.", "author": "albertshau", "createdAt": "2020-07-22T00:12:18Z", "path": "cdap-app-templates/cdap-etl/hydrator-spark-core/src/main/java/io/cdap/cdap/etl/spark/batch/RDDCollection.java", "diffHunk": "@@ -131,11 +182,20 @@ public RDDCollection(JavaSparkExecutionContext sec, JavaSparkContext jsc, SQLCon\n       // which allows us to use a different number of partitions per joiner instead of using the global\n       // spark.sql.shuffle.partitions setting in the spark conf\n       if (joinPartitions != null && !toJoin.isBroadcast()) {\n-        right = partitionOnKey(right, toJoin.getKey(), joinRequest.isNullSafe(), sparkSchema, joinPartitions);\n+        List<String> rightKeys = new ArrayList<>(toJoin.getKey());\n+        List<String> leftKeys = new ArrayList<>(joinRequest.getLeftKey());\n+\n+        // If distribution is enabled we need to add it to the partition keys to ensure we end up with the desired\n+        // number of partitions\n+        if (joinRequest.isDistributionEnabled() && JoinDistribution.getSupportedJoinTypes().contains(joinType)) {", "originalCommit": "81e9240e907c036f15eaaaf0c7529d4bf1498a18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwNTM1Mg==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r459005352", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-07-22T18:42:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1OTgzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1OTk4OQ==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458459989", "bodyText": "unintended newline?", "author": "albertshau", "createdAt": "2020-07-22T00:13:00Z", "path": "cdap-app-templates/cdap-etl/hydrator-spark-core/src/main/java/io/cdap/cdap/etl/spark/batch/RDDCollection.java", "diffHunk": "@@ -171,14 +231,16 @@ followed by (TMP1 inner join C on TMP1.B.id = C.id) as OUT\n \n     // select and alias fields in the expected order\n     List<Column> outputColumns = new ArrayList<>(joinRequest.getFields().size());\n-    for (JoinField field : joinRequest.getFields()) {\n+    for (\n+      JoinField field : joinRequest.getFields()) {", "originalCommit": "81e9240e907c036f15eaaaf0c7529d4bf1498a18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwNTY0NA==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r459005644", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-07-22T18:42:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ1OTk4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ2MDAzOA==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r458460038", "bodyText": "unintended new space?", "author": "albertshau", "createdAt": "2020-07-22T00:13:12Z", "path": "cdap-app-templates/cdap-etl/hydrator-test/src/main/java/io/cdap/cdap/etl/mock/batch/joiner/MockAutoJoiner.java", "diffHunk": "@@ -59,7 +60,7 @@\n   public static final PluginClass PLUGIN_CLASS = getPluginClass();\n   private static final Gson GSON = new Gson();\n   private static final Type LIST = new TypeToken<List<String>>() { }.getType();\n-  private static final Type SELECT_TYPE = new TypeToken<List<JoinField>>() { }.getType();\n+  private static final Type SELECT_TYPE = new TypeToken<List<JoinField>>() {  }.getType();", "originalCommit": "81e9240e907c036f15eaaaf0c7529d4bf1498a18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwNTk2Mw==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r459005963", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-07-22T18:43:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ2MDAzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTExNTA3Nw==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r459115077", "bodyText": "This check can be combined with previous one:\nJoinStage leftStage = stages.stream().filter(s -> s.getStageName().equals(skewedStageName)).findFirst().orElse(null);\n\nif (leftStage == null) {\n  errors.add(new JoinError(\n        String.format(\"Skewed stage name '%s' does not match any of the specified stages\", skewedStageName\n        )));\n} else if (!leftStage.isRequired()) {\n  ...\n}", "author": "chtyim", "createdAt": "2020-07-22T22:17:24Z", "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDistribution.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.etl.api.join;\n+\n+import io.cdap.cdap.etl.api.join.error.JoinError;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Join distribution settings for salting/exploding datasets to resolve skew\n+ */\n+public class JoinDistribution {\n+\n+  private final int distributionFactor;\n+  private final String skewedStageName;\n+\n+  public JoinDistribution(Integer distributionFactor, String skewedStageName) {\n+    this.distributionFactor = distributionFactor;\n+    this.skewedStageName = skewedStageName;\n+  }\n+\n+  public int getDistributionFactor() {\n+    return distributionFactor;\n+  }\n+\n+  public String getSkewedStageName() {\n+    return skewedStageName;\n+  }\n+\n+  public Collection<JoinError> validate(List<JoinStage> stages) {\n+    List<JoinError> errors = new ArrayList<>();\n+\n+    if (stages.size() > 2) {\n+      errors.add(new JoinError(\"Only two stages can be joined if a distribution factor is specified\"));\n+    }\n+\n+    if (skewedStageName == null) {\n+      errors.add(new JoinError(\"Distribution requires skewed stage name to be defined\"));\n+    }\n+\n+    if (distributionFactor < 1) {\n+      errors.add(new JoinError(\"Distribution size must be greater than 0\"));\n+    }\n+\n+    //If skewedStageName does not match any of the names in stages\n+    List<String> stageNames = stages.stream().map(JoinStage::getStageName).collect(Collectors.toList());\n+    if (skewedStageName != null && !stageNames.contains(skewedStageName)) {\n+      errors.add(new JoinError(\n+        String.format(\"Skewed stage name '%s' does not match any of the specified stages\", skewedStageName\n+        )));\n+    }\n+\n+    JoinStage leftStage = stages.stream().filter(s -> s.getStageName().equals(skewedStageName)).findFirst().get();", "originalCommit": "d118de2437020318d2b504356837765a3fbe0457", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE0ODc2Nw==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r459148767", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-07-22T23:59:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTExNTA3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTExNTYxNA==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r459115614", "bodyText": "Use if (stages.stream().anyMatch(JoinStage::isBroadcast))", "author": "chtyim", "createdAt": "2020-07-22T22:18:44Z", "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDistribution.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.etl.api.join;\n+\n+import io.cdap.cdap.etl.api.join.error.JoinError;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Join distribution settings for salting/exploding datasets to resolve skew\n+ */\n+public class JoinDistribution {\n+\n+  private final int distributionFactor;\n+  private final String skewedStageName;\n+\n+  public JoinDistribution(Integer distributionFactor, String skewedStageName) {\n+    this.distributionFactor = distributionFactor;\n+    this.skewedStageName = skewedStageName;\n+  }\n+\n+  public int getDistributionFactor() {\n+    return distributionFactor;\n+  }\n+\n+  public String getSkewedStageName() {\n+    return skewedStageName;\n+  }\n+\n+  public Collection<JoinError> validate(List<JoinStage> stages) {\n+    List<JoinError> errors = new ArrayList<>();\n+\n+    if (stages.size() > 2) {\n+      errors.add(new JoinError(\"Only two stages can be joined if a distribution factor is specified\"));\n+    }\n+\n+    if (skewedStageName == null) {\n+      errors.add(new JoinError(\"Distribution requires skewed stage name to be defined\"));\n+    }\n+\n+    if (distributionFactor < 1) {\n+      errors.add(new JoinError(\"Distribution size must be greater than 0\"));\n+    }\n+\n+    //If skewedStageName does not match any of the names in stages\n+    List<String> stageNames = stages.stream().map(JoinStage::getStageName).collect(Collectors.toList());\n+    if (skewedStageName != null && !stageNames.contains(skewedStageName)) {\n+      errors.add(new JoinError(\n+        String.format(\"Skewed stage name '%s' does not match any of the specified stages\", skewedStageName\n+        )));\n+    }\n+\n+    JoinStage leftStage = stages.stream().filter(s -> s.getStageName().equals(skewedStageName)).findFirst().get();\n+    if (!leftStage.isRequired()) {\n+      errors.add(new JoinError(\"Distribution only supports inner or left outer joins, the skewed side of the join \" +\n+                                 \"must be required\"));\n+    }\n+\n+    if (stages.get(0).isBroadcast() || stages.get(1).isBroadcast()) {", "originalCommit": "d118de2437020318d2b504356837765a3fbe0457", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE0OTQwNQ==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r459149405", "bodyText": "Done", "author": "MEseifan", "createdAt": "2020-07-23T00:01:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTExNTYxNA=="}], "type": "inlineReview"}, {"oid": "ea98bed5d7cb76fa7ceb0558aeba4022acf296e8", "url": "https://github.com/cdapio/cdap/commit/ea98bed5d7cb76fa7ceb0558aeba4022acf296e8", "message": "(CDAP-17095) Add support for Distribution in AutoJoiner API", "committedDate": "2020-07-23T21:49:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2MjUyNw==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r461062527", "bodyText": "can you add a line about how the given stage must be a required stage, and no stage should be broadcast.", "author": "albertshau", "createdAt": "2020-07-27T17:46:53Z", "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDefinition.java", "diffHunk": "@@ -121,11 +129,25 @@ public Builder setOutputSchemaName(@Nullable String name) {\n       return this;\n     }\n \n+    /**\n+     * Set the distribution factor and stage name of the skewed stage. This should be set if the join being performed\n+     * is skewed (ie. joining a large dataset with a small dataset) and the \"small\" dataset is too large to broadcast.", "originalCommit": "ea98bed5d7cb76fa7ceb0558aeba4022acf296e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTEyMTM3NQ==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r461121375", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-07-27T19:34:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2MjUyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2Mjk3Nw==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r461062977", "bodyText": "indentation", "author": "albertshau", "createdAt": "2020-07-27T17:47:39Z", "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDistribution.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.etl.api.join;\n+\n+import io.cdap.cdap.etl.api.join.error.JoinError;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+\n+/**\n+ * Join distribution settings for salting/exploding datasets to resolve skew\n+ */\n+public class JoinDistribution {\n+\n+  private final int distributionFactor;\n+  private final String skewedStageName;\n+\n+  public JoinDistribution(Integer distributionFactor, String skewedStageName) {\n+    this.distributionFactor = distributionFactor;\n+    this.skewedStageName = skewedStageName;\n+  }\n+\n+  public int getDistributionFactor() {\n+    return distributionFactor;\n+  }\n+\n+  public String getSkewedStageName() {\n+    return skewedStageName;\n+  }\n+\n+  public Collection<JoinError> validate(List<JoinStage> stages) {\n+    List<JoinError> errors = new ArrayList<>();\n+\n+    if (stages.size() > 2) {\n+      errors.add(new JoinError(\"Only two stages can be joined if a distribution factor is specified\"));\n+    }\n+\n+    if (skewedStageName == null) {\n+      errors.add(new JoinError(\"Distribution requires skewed stage name to be defined\"));\n+    }\n+\n+    if (distributionFactor < 1) {\n+      errors.add(new JoinError(\"Distribution size must be greater than 0\"));\n+    }\n+\n+    //If skewedStageName does not match any of the names in stages\n+    JoinStage leftStage = stages.stream().filter(s -> s.getStageName().equals(skewedStageName)).findFirst()\n+                                .orElse(null);", "originalCommit": "ea98bed5d7cb76fa7ceb0558aeba4022acf296e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTEyMjc1MA==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r461122750", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-07-27T19:36:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2Mjk3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2MzUwNg==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r461063506", "bodyText": "include the stage name in the message, similar to what you have above.", "author": "albertshau", "createdAt": "2020-07-27T17:48:39Z", "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDistribution.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.etl.api.join;\n+\n+import io.cdap.cdap.etl.api.join.error.JoinError;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+\n+/**\n+ * Join distribution settings for salting/exploding datasets to resolve skew\n+ */\n+public class JoinDistribution {\n+\n+  private final int distributionFactor;\n+  private final String skewedStageName;\n+\n+  public JoinDistribution(Integer distributionFactor, String skewedStageName) {\n+    this.distributionFactor = distributionFactor;\n+    this.skewedStageName = skewedStageName;\n+  }\n+\n+  public int getDistributionFactor() {\n+    return distributionFactor;\n+  }\n+\n+  public String getSkewedStageName() {\n+    return skewedStageName;\n+  }\n+\n+  public Collection<JoinError> validate(List<JoinStage> stages) {\n+    List<JoinError> errors = new ArrayList<>();\n+\n+    if (stages.size() > 2) {\n+      errors.add(new JoinError(\"Only two stages can be joined if a distribution factor is specified\"));\n+    }\n+\n+    if (skewedStageName == null) {\n+      errors.add(new JoinError(\"Distribution requires skewed stage name to be defined\"));\n+    }\n+\n+    if (distributionFactor < 1) {\n+      errors.add(new JoinError(\"Distribution size must be greater than 0\"));\n+    }\n+\n+    //If skewedStageName does not match any of the names in stages\n+    JoinStage leftStage = stages.stream().filter(s -> s.getStageName().equals(skewedStageName)).findFirst()\n+                                .orElse(null);\n+\n+    if (leftStage == null) {\n+      errors.add(new JoinError(\n+        String.format(\"Skewed stage name '%s' does not match any of the specified stages\", skewedStageName\n+        )));\n+    } else if (!leftStage.isRequired()) {\n+      errors.add(new JoinError(\"Distribution only supports inner or left outer joins, the skewed side of the join \" +", "originalCommit": "ea98bed5d7cb76fa7ceb0558aeba4022acf296e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2NzA4Nw==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r461067087", "bodyText": "we may want to use more specific errors than JoinError. The idea being that the plugin should be able to examine the error and figure out what property it needs to highlight as a problem during validation. It's ok to revisit this later, after seeing what the plugin would need.", "author": "albertshau", "createdAt": "2020-07-27T17:54:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2MzUwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTEyMzM4Ng==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r461123386", "bodyText": "Changed the message and agree on the second point. I wasnt sure which property this should highlight exactly since the error ties into two properties, we should definitely revisit later", "author": "MEseifan", "createdAt": "2020-07-27T19:38:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2MzUwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2NTAyMQ==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r461065021", "bodyText": "nit: stage name -> stage", "author": "albertshau", "createdAt": "2020-07-27T17:51:10Z", "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDistribution.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.etl.api.join;\n+\n+import io.cdap.cdap.etl.api.join.error.JoinError;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+\n+/**\n+ * Join distribution settings for salting/exploding datasets to resolve skew\n+ */\n+public class JoinDistribution {\n+\n+  private final int distributionFactor;\n+  private final String skewedStageName;\n+\n+  public JoinDistribution(Integer distributionFactor, String skewedStageName) {\n+    this.distributionFactor = distributionFactor;\n+    this.skewedStageName = skewedStageName;\n+  }\n+\n+  public int getDistributionFactor() {\n+    return distributionFactor;\n+  }\n+\n+  public String getSkewedStageName() {\n+    return skewedStageName;\n+  }\n+\n+  public Collection<JoinError> validate(List<JoinStage> stages) {\n+    List<JoinError> errors = new ArrayList<>();\n+\n+    if (stages.size() > 2) {\n+      errors.add(new JoinError(\"Only two stages can be joined if a distribution factor is specified\"));\n+    }\n+\n+    if (skewedStageName == null) {\n+      errors.add(new JoinError(\"Distribution requires skewed stage name to be defined\"));\n+    }\n+\n+    if (distributionFactor < 1) {\n+      errors.add(new JoinError(\"Distribution size must be greater than 0\"));\n+    }\n+\n+    //If skewedStageName does not match any of the names in stages\n+    JoinStage leftStage = stages.stream().filter(s -> s.getStageName().equals(skewedStageName)).findFirst()\n+                                .orElse(null);\n+\n+    if (leftStage == null) {\n+      errors.add(new JoinError(\n+        String.format(\"Skewed stage name '%s' does not match any of the specified stages\", skewedStageName", "originalCommit": "ea98bed5d7cb76fa7ceb0558aeba4022acf296e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTEyMjc5Mg==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r461122792", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-07-27T19:36:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2NTAyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2NTY4Mw==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r461065683", "bodyText": "nit: is not needed -> cannot be used\n\"is not needed\" sounds like a warning that can be ignored, whereas here we are failing.", "author": "albertshau", "createdAt": "2020-07-27T17:52:19Z", "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDistribution.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.etl.api.join;\n+\n+import io.cdap.cdap.etl.api.join.error.JoinError;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+\n+/**\n+ * Join distribution settings for salting/exploding datasets to resolve skew\n+ */\n+public class JoinDistribution {\n+\n+  private final int distributionFactor;\n+  private final String skewedStageName;\n+\n+  public JoinDistribution(Integer distributionFactor, String skewedStageName) {\n+    this.distributionFactor = distributionFactor;\n+    this.skewedStageName = skewedStageName;\n+  }\n+\n+  public int getDistributionFactor() {\n+    return distributionFactor;\n+  }\n+\n+  public String getSkewedStageName() {\n+    return skewedStageName;\n+  }\n+\n+  public Collection<JoinError> validate(List<JoinStage> stages) {\n+    List<JoinError> errors = new ArrayList<>();\n+\n+    if (stages.size() > 2) {\n+      errors.add(new JoinError(\"Only two stages can be joined if a distribution factor is specified\"));\n+    }\n+\n+    if (skewedStageName == null) {\n+      errors.add(new JoinError(\"Distribution requires skewed stage name to be defined\"));\n+    }\n+\n+    if (distributionFactor < 1) {\n+      errors.add(new JoinError(\"Distribution size must be greater than 0\"));\n+    }\n+\n+    //If skewedStageName does not match any of the names in stages\n+    JoinStage leftStage = stages.stream().filter(s -> s.getStageName().equals(skewedStageName)).findFirst()\n+                                .orElse(null);\n+\n+    if (leftStage == null) {\n+      errors.add(new JoinError(\n+        String.format(\"Skewed stage name '%s' does not match any of the specified stages\", skewedStageName\n+        )));\n+    } else if (!leftStage.isRequired()) {\n+      errors.add(new JoinError(\"Distribution only supports inner or left outer joins, the skewed side of the join \" +\n+                                 \"must be required\"));\n+    }\n+\n+    if (stages.stream().anyMatch(JoinStage::isBroadcast)) {\n+      errors.add(new JoinError(\"Distribution is not needed if either stage will be broadcast\"));", "originalCommit": "ea98bed5d7cb76fa7ceb0558aeba4022acf296e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTEyMzU3MQ==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r461123571", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-07-27T19:38:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2NTY4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2Nzc2NQ==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r461067765", "bodyText": "style: IDE settings seem to be off, method calls should be indented, not aligned to the previous line", "author": "albertshau", "createdAt": "2020-07-27T17:55:49Z", "path": "cdap-app-templates/cdap-etl/hydrator-spark-core/src/main/java/io/cdap/cdap/etl/spark/batch/RDDCollection.java", "diffHunk": "@@ -72,8 +80,8 @@ public RDDCollection(JavaSparkExecutionContext sec, JavaSparkContext jsc, SQLCon\n     collections.put(joinRequest.getLeftStage(), left);\n \n     List<Column> leftJoinColumns = joinRequest.getLeftKey().stream()\n-      .map(left::col)\n-      .collect(Collectors.toList());\n+                                              .map(left::col)", "originalCommit": "ea98bed5d7cb76fa7ceb0558aeba4022acf296e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTEyNDAwNQ==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r461124005", "bodyText": "Yes..I've fixed them now but I have a feeling that some of our other repos have them aligned not indented. I find myself repeatedly toggling this setting", "author": "MEseifan", "createdAt": "2020-07-27T19:39:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2Nzc2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE4MzY4NA==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r461183684", "bodyText": "method calls should be indented, but if you're in a middle of a method call, the arguments should be aligned.\n  x.stream()\n    .map()\n\nvs\n  x.call(a,\n         b);", "author": "albertshau", "createdAt": "2020-07-27T21:34:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2Nzc2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE5NTYzNQ==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r461195635", "bodyText": "Ah gotcha, that might be where the confusion came from. Thanks!", "author": "MEseifan", "createdAt": "2020-07-27T22:00:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2Nzc2NQ=="}], "type": "inlineReview"}, {"oid": "1c7e90218275bf8d7f9aafa6672c8604a710e230", "url": "https://github.com/cdapio/cdap/commit/1c7e90218275bf8d7f9aafa6672c8604a710e230", "message": "Addressed comments, added new error types and added distribution to spark 2", "committedDate": "2020-07-27T21:30:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE4NDA5NQ==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r461184095", "bodyText": "indentation", "author": "albertshau", "createdAt": "2020-07-27T21:35:09Z", "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDefinition.java", "diffHunk": "@@ -161,20 +186,24 @@ public JoinDefinition build() {\n         validateSchemaCompatibility(generatedOutputSchema, outputSchema, errors);\n       }\n \n+      if (distribution != null) {\n+        errors.addAll(distribution.validate(stages));\n+      }\n+\n       if (!errors.isEmpty()) {\n         throw new InvalidJoinException(errors);\n       }\n \n       return new JoinDefinition(selectedFields, stages, condition,\n-                                outputSchema == null ? generatedOutputSchema : outputSchema);\n+                                outputSchema == null ? generatedOutputSchema : outputSchema, distribution);\n     }\n \n     @Nullable\n     private Schema getOutputSchema(List<JoinError> errors) {\n       Set<String> outputFieldNames = new HashSet<>();\n       List<Schema.Field> outputFields = new ArrayList<>(selectedFields.size());\n       Map<String, JoinStage> stageMap = stages.stream()\n-        .collect(Collectors.toMap(JoinStage::getStageName, s -> s));\n+                                              .collect(Collectors.toMap(JoinStage::getStageName, s -> s));", "originalCommit": "1c7e90218275bf8d7f9aafa6672c8604a710e230", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE5MDI4Ng==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r461190286", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-07-27T21:48:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE4NDA5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE4NjYxMA==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r461186610", "bodyText": "should this also be a DistributionStageError?", "author": "albertshau", "createdAt": "2020-07-27T21:40:28Z", "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDistribution.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.etl.api.join;\n+\n+import io.cdap.cdap.etl.api.join.error.DistributionSizeError;\n+import io.cdap.cdap.etl.api.join.error.DistributionStageError;\n+import io.cdap.cdap.etl.api.join.error.JoinError;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+\n+/**\n+ * Join distribution settings for salting/exploding datasets to resolve skew\n+ */\n+public class JoinDistribution {\n+\n+  private final int distributionFactor;\n+  private final String skewedStageName;\n+\n+  public JoinDistribution(Integer distributionFactor, String skewedStageName) {\n+    this.distributionFactor = distributionFactor;\n+    this.skewedStageName = skewedStageName;\n+  }\n+\n+  public int getDistributionFactor() {\n+    return distributionFactor;\n+  }\n+\n+  public String getSkewedStageName() {\n+    return skewedStageName;\n+  }\n+\n+  public Collection<JoinError> validate(List<JoinStage> stages) {\n+    List<JoinError> errors = new ArrayList<>();\n+\n+    if (stages.size() > 2) {\n+      errors.add(new JoinError(\"Only two stages can be joined if a distribution factor is specified\"));\n+    }\n+\n+    if (skewedStageName == null) {\n+      errors.add(new DistributionStageError(\"Distribution requires skewed stage name to be defined\"));\n+    }\n+\n+    if (distributionFactor < 1) {\n+      errors.add(new DistributionSizeError(\"Distribution size must be greater than 0\"));\n+    }\n+\n+    //If skewedStageName does not match any of the names in stages\n+    JoinStage leftStage = stages.stream().filter(s -> s.getStageName().equals(skewedStageName)).findFirst()\n+      .orElse(null);\n+\n+    if (leftStage == null) {\n+      errors.add(new DistributionStageError(\n+        String.format(\"Skewed stage '%s' does not match any of the specified stages\", skewedStageName\n+        )));\n+    } else if (!leftStage.isRequired()) {\n+      errors.add(new JoinError(String.format(\"Distribution only supports inner or left outer joins, the skewed \" +", "originalCommit": "1c7e90218275bf8d7f9aafa6672c8604a710e230", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE5MTIwNg==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r461191206", "bodyText": "Hmm I guess it could be, I didnt mark it as a distribution error because it also relates to the join type parameter", "author": "MEseifan", "createdAt": "2020-07-27T21:50:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE4NjYxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE4NzEyNg==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r461187126", "bodyText": "this one seems like it should have its own type, as the plugin would want to highlight the broadcast property in this situation.", "author": "albertshau", "createdAt": "2020-07-27T21:41:37Z", "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDistribution.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.etl.api.join;\n+\n+import io.cdap.cdap.etl.api.join.error.DistributionSizeError;\n+import io.cdap.cdap.etl.api.join.error.DistributionStageError;\n+import io.cdap.cdap.etl.api.join.error.JoinError;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+\n+/**\n+ * Join distribution settings for salting/exploding datasets to resolve skew\n+ */\n+public class JoinDistribution {\n+\n+  private final int distributionFactor;\n+  private final String skewedStageName;\n+\n+  public JoinDistribution(Integer distributionFactor, String skewedStageName) {\n+    this.distributionFactor = distributionFactor;\n+    this.skewedStageName = skewedStageName;\n+  }\n+\n+  public int getDistributionFactor() {\n+    return distributionFactor;\n+  }\n+\n+  public String getSkewedStageName() {\n+    return skewedStageName;\n+  }\n+\n+  public Collection<JoinError> validate(List<JoinStage> stages) {\n+    List<JoinError> errors = new ArrayList<>();\n+\n+    if (stages.size() > 2) {\n+      errors.add(new JoinError(\"Only two stages can be joined if a distribution factor is specified\"));\n+    }\n+\n+    if (skewedStageName == null) {\n+      errors.add(new DistributionStageError(\"Distribution requires skewed stage name to be defined\"));\n+    }\n+\n+    if (distributionFactor < 1) {\n+      errors.add(new DistributionSizeError(\"Distribution size must be greater than 0\"));\n+    }\n+\n+    //If skewedStageName does not match any of the names in stages\n+    JoinStage leftStage = stages.stream().filter(s -> s.getStageName().equals(skewedStageName)).findFirst()\n+      .orElse(null);\n+\n+    if (leftStage == null) {\n+      errors.add(new DistributionStageError(\n+        String.format(\"Skewed stage '%s' does not match any of the specified stages\", skewedStageName\n+        )));\n+    } else if (!leftStage.isRequired()) {\n+      errors.add(new JoinError(String.format(\"Distribution only supports inner or left outer joins, the skewed \" +\n+        \"stage '%s' must be required\", skewedStageName)));\n+    }\n+\n+    if (stages.stream().anyMatch(JoinStage::isBroadcast)) {\n+      errors.add(new JoinError(\"Distribution cannot be used if either stage will be broadcast\"));", "originalCommit": "1c7e90218275bf8d7f9aafa6672c8604a710e230", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE5MzcxNw==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r461193717", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-07-27T21:56:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE4NzEyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwODA0MQ==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r461208041", "bodyText": "nit: move to previous line to have consistent style", "author": "albertshau", "createdAt": "2020-07-27T22:32:39Z", "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/join/JoinDistribution.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ * Copyright \u00a9 2020 Cask Data, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n+ * use this file except in compliance with the License. You may obtain a copy of\n+ * the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package io.cdap.cdap.etl.api.join;\n+\n+import io.cdap.cdap.etl.api.join.error.BroadcastError;\n+import io.cdap.cdap.etl.api.join.error.DistributionSizeError;\n+import io.cdap.cdap.etl.api.join.error.DistributionStageError;\n+import io.cdap.cdap.etl.api.join.error.JoinError;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+\n+/**\n+ * Join distribution settings for salting/exploding datasets to resolve skew\n+ */\n+public class JoinDistribution {\n+\n+  private final int distributionFactor;\n+  private final String skewedStageName;\n+\n+  public JoinDistribution(Integer distributionFactor, String skewedStageName) {\n+    this.distributionFactor = distributionFactor;\n+    this.skewedStageName = skewedStageName;\n+  }\n+\n+  public int getDistributionFactor() {\n+    return distributionFactor;\n+  }\n+\n+  public String getSkewedStageName() {\n+    return skewedStageName;\n+  }\n+\n+  public Collection<JoinError> validate(List<JoinStage> stages) {\n+    List<JoinError> errors = new ArrayList<>();\n+\n+    if (stages.size() > 2) {\n+      errors.add(new JoinError(\"Only two stages can be joined if a distribution factor is specified\"));\n+    }\n+\n+    if (skewedStageName == null) {\n+      errors.add(new DistributionStageError(\"Distribution requires skewed stage name to be defined\"));\n+    }\n+\n+    if (distributionFactor < 1) {\n+      errors.add(new DistributionSizeError(\"Distribution size must be greater than 0\"));\n+    }\n+\n+    //If skewedStageName does not match any of the names in stages\n+    JoinStage leftStage = stages.stream().filter(s -> s.getStageName().equals(skewedStageName)).findFirst()\n+      .orElse(null);\n+\n+    if (leftStage == null) {\n+      errors.add(new DistributionStageError(\n+        String.format(\"Skewed stage '%s' does not match any of the specified stages\", skewedStageName\n+        )));", "originalCommit": "d46e148197e68884a669dad26dcb06f111759bd4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIxOTUwMw==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r461219503", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-07-27T23:03:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwODA0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIyMjczMg==", "url": "https://github.com/cdapio/cdap/pull/12481#discussion_r461222732", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-07-27T23:13:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIwODA0MQ=="}], "type": "inlineReview"}, {"oid": "c2c7d8068451fab859f531c441c89ed531bbcd6f", "url": "https://github.com/cdapio/cdap/commit/c2c7d8068451fab859f531c441c89ed531bbcd6f", "message": "(CDAP-17095) Add support for Distribution in AutoJoiner API", "committedDate": "2020-07-27T23:04:35Z", "type": "commit"}, {"oid": "c2c7d8068451fab859f531c441c89ed531bbcd6f", "url": "https://github.com/cdapio/cdap/commit/c2c7d8068451fab859f531c441c89ed531bbcd6f", "message": "(CDAP-17095) Add support for Distribution in AutoJoiner API", "committedDate": "2020-07-27T23:04:35Z", "type": "forcePushed"}]}