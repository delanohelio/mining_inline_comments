{"pr_number": 12004, "pr_title": "(CDAP-16353) Move get artifact details for range into ArtifactRepositoryReader", "pr_createdAt": "2020-03-27T08:20:12Z", "pr_url": "https://github.com/cdapio/cdap/pull/12004", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI4MTc5OA==", "url": "https://github.com/cdapio/cdap/pull/12004#discussion_r399281798", "bodyText": "remove debug logs", "author": "albertshau", "createdAt": "2020-03-27T13:56:12Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/runtime/artifact/DefaultArtifactRepository.java", "diffHunk": "@@ -453,12 +454,15 @@ private boolean loadSystemArtifacts(ExecutorService executorService,\n   public void deleteArtifact(Id.Artifact artifactId) throws Exception {\n     // delete the artifact first and then privileges. Not the other way to avoid orphan artifact\n     // which does not have any privilege if the artifact delete from store fails. see CDAP-6648\n+    LOG.debug(\"wyzhang: delete artiact store: \" + artifactStore);\n+    LOG.debug(\"wyzhang: delete artiact id: \" + artifactId.toString());", "originalCommit": "d55b23ac0d496d1684647da5471e592cf823aa62", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2Njg4Mg==", "url": "https://github.com/cdapio/cdap/pull/12004#discussion_r399566882", "bodyText": "Done.\nForgot to clean them up.", "author": "wyzhang", "createdAt": "2020-03-27T22:29:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI4MTc5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI4MzQxNA==", "url": "https://github.com/cdapio/cdap/pull/12004#discussion_r399283414", "bodyText": "order.name()", "author": "albertshau", "createdAt": "2020-03-27T13:58:32Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/runtime/artifact/RemoteArtifactRepositoryReader.java", "diffHunk": "@@ -87,6 +92,30 @@ public ArtifactDetail getArtifact(Id.Artifact artifactId) throws Exception {\n     return artifactDetail;\n   }\n \n+  @Override\n+  public List<ArtifactDetail> getArtifactDetails(ArtifactRange range, int limit, ArtifactSortOrder order)\n+    throws Exception {\n+    String url = String.format(\"namespaces/%s/artifacts/%s/versions?lower=%s&upper=%s&limit=%s&order=%s\",\n+                               range.getNamespace(),\n+                               range.getName(),\n+                               range.getLower().toString(),\n+                               range.getUpper().toString(),\n+                               String.valueOf(limit),\n+                               String.valueOf(order));", "originalCommit": "d55b23ac0d496d1684647da5471e592cf823aa62", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2NzA4MA==", "url": "https://github.com/cdapio/cdap/pull/12004#discussion_r399567080", "bodyText": "Done", "author": "wyzhang", "createdAt": "2020-03-27T22:30:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI4MzQxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI4Mzg5Ng==", "url": "https://github.com/cdapio/cdap/pull/12004#discussion_r399283896", "bodyText": "I assume this means both lower and upper are always non-null?", "author": "albertshau", "createdAt": "2020-03-27T13:59:13Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/runtime/artifact/RemoteArtifactRepositoryReader.java", "diffHunk": "@@ -87,6 +92,30 @@ public ArtifactDetail getArtifact(Id.Artifact artifactId) throws Exception {\n     return artifactDetail;\n   }\n \n+  @Override\n+  public List<ArtifactDetail> getArtifactDetails(ArtifactRange range, int limit, ArtifactSortOrder order)\n+    throws Exception {\n+    String url = String.format(\"namespaces/%s/artifacts/%s/versions?lower=%s&upper=%s&limit=%s&order=%s\",\n+                               range.getNamespace(),\n+                               range.getName(),\n+                               range.getLower().toString(),", "originalCommit": "d55b23ac0d496d1684647da5471e592cf823aa62", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2ODM0MQ==", "url": "https://github.com/cdapio/cdap/pull/12004#discussion_r399568341", "bodyText": "Yes.\nVersion fields in ArtifactRange are not annotated with nullable.\nAlso quickly checked a number of callers, I don't see any null being used to construct ArtifactRange.", "author": "wyzhang", "createdAt": "2020-03-27T22:35:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI4Mzg5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI4ODc5MA==", "url": "https://github.com/cdapio/cdap/pull/12004#discussion_r399288790", "bodyText": "is there a reason this utility method is being used over locationFactory.create()? Are they different?", "author": "albertshau", "createdAt": "2020-03-27T14:06:26Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/app/runtime/artifact/RemoteArtifactRepositoryReader.java", "diffHunk": "@@ -87,6 +92,30 @@ public ArtifactDetail getArtifact(Id.Artifact artifactId) throws Exception {\n     return artifactDetail;\n   }\n \n+  @Override\n+  public List<ArtifactDetail> getArtifactDetails(ArtifactRange range, int limit, ArtifactSortOrder order)\n+    throws Exception {\n+    String url = String.format(\"namespaces/%s/artifacts/%s/versions?lower=%s&upper=%s&limit=%s&order=%s\",\n+                               range.getNamespace(),\n+                               range.getName(),\n+                               range.getLower().toString(),\n+                               range.getUpper().toString(),\n+                               String.valueOf(limit),\n+                               String.valueOf(order));\n+    HttpRequest.Builder requestBuilder = remoteClient.requestBuilder(HttpMethod.GET, url);\n+    HttpResponse httpResponse = execute(requestBuilder.build());\n+    List<ArtifactDetail> details = GSON.fromJson(httpResponse.getResponseBodyAsString(), ARTIFACT_DETAIL_LIST_TYPE);\n+    List<ArtifactDetail> detailList = new ArrayList<>();\n+    for (ArtifactDetail detail : details) {\n+      Location artifactLocation =\n+        Locations.getLocationFromAbsolutePath(locationFactory, detail.getDescriptor().getLocationURI().getPath());", "originalCommit": "d55b23ac0d496d1684647da5471e592cf823aa62", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2OTUzOQ==", "url": "https://github.com/cdapio/cdap/pull/12004#discussion_r399569539", "bodyText": "Fixed. We can use LocationFactory.create() directly. The util cleans up and validate the path. But we are guaranteed the location URI is valid, so can just use create.", "author": "wyzhang", "createdAt": "2020-03-27T22:39:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI4ODc5MA=="}], "type": "inlineReview"}, {"oid": "693f6cb1e6697c843a386c6195c37569a0823179", "url": "https://github.com/cdapio/cdap/commit/693f6cb1e6697c843a386c6195c37569a0823179", "message": "(CDAP-16353) Move get artifact details for range into ArtifactRepositoryReader\n\nMotivation:\nAppLifecycleDeployment use getArtifactDetails to find the artifact detail\nfor deploymnet. Moving this method into ArtifactRepositoryReader allows us\nto have remote vs local implication used by preview (when configured with\nlocal levelDB) and appfabric respectively.\n\nAdd implementation for this method in both LocalArtifactRepositoryReader\nand RemoteArtifactRepositoryReader. But the latter is not being used\nanywhere at the moment. A follow-up change will make preview to use\nRemoteArtifactRepositoryReader when configured with local levelDB.", "committedDate": "2020-03-28T00:17:17Z", "type": "forcePushed"}, {"oid": "192ee7046ae50481f9c70b1eaa2bfe645392fb90", "url": "https://github.com/cdapio/cdap/commit/192ee7046ae50481f9c70b1eaa2bfe645392fb90", "message": "(CDAP-16353) Move get artifact details for range into ArtifactRepositoryReader\n\nMotivation:\nAppLifecycleDeployment use getArtifactDetails to find the artifact detail\nfor deploymnet. Moving this method into ArtifactRepositoryReader allows us\nto have remote vs local implication used by preview (when configured with\nlocal levelDB) and appfabric respectively.\n\nAdd implementation for this method in both LocalArtifactRepositoryReader\nand RemoteArtifactRepositoryReader. But the latter is not being used\nanywhere at the moment. A follow-up change will make preview to use\nRemoteArtifactRepositoryReader when configured with local levelDB.", "committedDate": "2020-03-28T02:28:38Z", "type": "commit"}, {"oid": "192ee7046ae50481f9c70b1eaa2bfe645392fb90", "url": "https://github.com/cdapio/cdap/commit/192ee7046ae50481f9c70b1eaa2bfe645392fb90", "message": "(CDAP-16353) Move get artifact details for range into ArtifactRepositoryReader\n\nMotivation:\nAppLifecycleDeployment use getArtifactDetails to find the artifact detail\nfor deploymnet. Moving this method into ArtifactRepositoryReader allows us\nto have remote vs local implication used by preview (when configured with\nlocal levelDB) and appfabric respectively.\n\nAdd implementation for this method in both LocalArtifactRepositoryReader\nand RemoteArtifactRepositoryReader. But the latter is not being used\nanywhere at the moment. A follow-up change will make preview to use\nRemoteArtifactRepositoryReader when configured with local levelDB.", "committedDate": "2020-03-28T02:28:38Z", "type": "forcePushed"}]}