{"pr_number": 12520, "pr_title": "(CDAP-17130) Added Distribution to BatchJoiner API", "pr_createdAt": "2020-07-29T00:14:36Z", "pr_url": "https://github.com/cdapio/cdap/pull/12520", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk2NjY1Mw==", "url": "https://github.com/cdapio/cdap/pull/12520#discussion_r461966653", "bodyText": "nit: extra space before Engine", "author": "albertshau", "createdAt": "2020-07-29T00:19:57Z", "path": "cdap-app-templates/cdap-etl/cdap-data-pipeline/src/test/java/io/cdap/cdap/datapipeline/AutoJoinerTest.java", "diffHunk": "@@ -302,7 +302,8 @@ public void testAutoInnerJoinSkewed() throws Exception {\n                    .set(\"users_user_id\", 1)\n                    .set(\"users_name\", \"bob\").build());\n \n-    testSimpleAutoJoinSkewed(Arrays.asList(\"users\", \"interests\"), expected);\n+    testSimpleAutoJoinSkewed(Arrays.asList(\"users\", \"interests\"), expected,  Engine.SPARK);", "originalCommit": "90d5c4ba2fd39d1bfc0f01fb0a6771256330221b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQzNzA2MQ==", "url": "https://github.com/cdapio/cdap/pull/12520#discussion_r462437061", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-07-29T16:40:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk2NjY1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk2NjY3Nw==", "url": "https://github.com/cdapio/cdap/pull/12520#discussion_r461966677", "bodyText": "nit: extra space before Engine", "author": "albertshau", "createdAt": "2020-07-29T00:20:02Z", "path": "cdap-app-templates/cdap-etl/cdap-data-pipeline/src/test/java/io/cdap/cdap/datapipeline/AutoJoinerTest.java", "diffHunk": "@@ -302,7 +302,8 @@ public void testAutoInnerJoinSkewed() throws Exception {\n                    .set(\"users_user_id\", 1)\n                    .set(\"users_name\", \"bob\").build());\n \n-    testSimpleAutoJoinSkewed(Arrays.asList(\"users\", \"interests\"), expected);\n+    testSimpleAutoJoinSkewed(Arrays.asList(\"users\", \"interests\"), expected,  Engine.SPARK);\n+    testSimpleAutoJoinSkewed(Arrays.asList(\"users\", \"interests\"), expected,  Engine.MAPREDUCE);", "originalCommit": "90d5c4ba2fd39d1bfc0f01fb0a6771256330221b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQzNzEyNQ==", "url": "https://github.com/cdapio/cdap/pull/12520#discussion_r462437125", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-07-29T16:40:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk2NjY3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk2NjgwNQ==", "url": "https://github.com/cdapio/cdap/pull/12520#discussion_r461966805", "bodyText": "include a @deprecated in the javadoc and mention that getJoinKeys() should be used instead.", "author": "albertshau", "createdAt": "2020-07-29T00:20:32Z", "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/Joiner.java", "diffHunk": "@@ -36,8 +39,21 @@\n    * @return returns join key\n    * @throws Exception if there is some error getting the join key", "originalCommit": "90d5c4ba2fd39d1bfc0f01fb0a6771256330221b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQzODE0MQ==", "url": "https://github.com/cdapio/cdap/pull/12520#discussion_r462438141", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-07-29T16:42:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk2NjgwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk2Njk4Ng==", "url": "https://github.com/cdapio/cdap/pull/12520#discussion_r461966986", "bodyText": "add a space after Exception", "author": "albertshau", "createdAt": "2020-07-29T00:21:02Z", "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/Joiner.java", "diffHunk": "@@ -36,8 +39,21 @@\n    * @return returns join key\n    * @throws Exception if there is some error getting the join key\n    */\n+  @Deprecated\n   JOIN_KEY joinOn(String stageName, INPUT_RECORD inputRecord) throws Exception;\n \n+  /**\n+   * Return value for the join keys on which join will be performed\n+   *\n+   * @param stageName name of the stage to which records belongs to\n+   * @param inputRecord input record to be joined\n+   * @return returns a list of join keys\n+   * @throws Exception if there is some error getting the join key\n+   */\n+  default Collection<JOIN_KEY> getJoinKeys(String stageName, INPUT_RECORD inputRecord) throws Exception{", "originalCommit": "90d5c4ba2fd39d1bfc0f01fb0a6771256330221b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQzODMwNw==", "url": "https://github.com/cdapio/cdap/pull/12520#discussion_r462438307", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-07-29T16:42:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk2Njk4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk2NzE5Nw==", "url": "https://github.com/cdapio/cdap/pull/12520#discussion_r461967197", "bodyText": "return -> continue", "author": "albertshau", "createdAt": "2020-07-29T00:21:47Z", "path": "cdap-app-templates/cdap-etl/cdap-etl-batch/src/main/java/io/cdap/cdap/etl/batch/mapreduce/MapReduceTransformExecutorFactory.java", "diffHunk": "@@ -309,13 +310,16 @@ protected PipeStage getSinkPipeStage(StageSpec stageSpec) throws Exception {\n     public void transform(RecordInfo<INPUT_RECORD> input,\n                           Emitter<KeyValue<OUT_KEY, TaggedWritable<OUT_VALUE>>> emitter) throws Exception {\n       String stageName = input.getFromStage();\n-      JOIN_KEY key = joiner.joinOn(stageName, input.getValue());\n-      if (shouldFilter.test(stageName, key)) {\n-        return;\n+      Collection<JOIN_KEY> keys = joiner.getJoinKeys(stageName, input.getValue());\n+      for (JOIN_KEY key : keys) {\n+        if (shouldFilter.test(stageName, key)) {\n+          return;", "originalCommit": "90d5c4ba2fd39d1bfc0f01fb0a6771256330221b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQzODUyMQ==", "url": "https://github.com/cdapio/cdap/pull/12520#discussion_r462438521", "bodyText": "ah good catch, done", "author": "MEseifan", "createdAt": "2020-07-29T16:42:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk2NzE5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk2ODA5OA==", "url": "https://github.com/cdapio/cdap/pull/12520#discussion_r461968098", "bodyText": "can make this default as well, where the default implementation throws an exception. That way, plugins are not forced to implement this deprecated method.", "author": "albertshau", "createdAt": "2020-07-29T00:24:59Z", "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/Joiner.java", "diffHunk": "@@ -36,8 +39,21 @@\n    * @return returns join key\n    * @throws Exception if there is some error getting the join key\n    */\n+  @Deprecated\n   JOIN_KEY joinOn(String stageName, INPUT_RECORD inputRecord) throws Exception;", "originalCommit": "90d5c4ba2fd39d1bfc0f01fb0a6771256330221b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQzOTI0NA==", "url": "https://github.com/cdapio/cdap/pull/12520#discussion_r462439244", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-07-29T16:44:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk2ODA5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE3MTIyMw==", "url": "https://github.com/cdapio/cdap/pull/12520#discussion_r463171223", "bodyText": "avoid using classes from other libraries in the api modules. You can throw a UnsupportedOperationException instead.", "author": "albertshau", "createdAt": "2020-07-30T17:53:57Z", "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/Joiner.java", "diffHunk": "@@ -17,26 +17,48 @@\n package io.cdap.cdap.etl.api;\n \n import io.cdap.cdap.api.annotation.Beta;\n+import org.apache.commons.lang.NotImplementedException;", "originalCommit": "6bb15647603bc3af5c8798e8a0ade298f5d546c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE3NTUwMQ==", "url": "https://github.com/cdapio/cdap/pull/12520#discussion_r463175501", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-07-30T18:01:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE3MTIyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE3MjA0Mg==", "url": "https://github.com/cdapio/cdap/pull/12520#discussion_r463172042", "bodyText": "use {@link #getJoinKeys()} instead\nthat way the javadoc will link to the method.", "author": "albertshau", "createdAt": "2020-07-30T17:55:18Z", "path": "cdap-app-templates/cdap-etl/cdap-etl-api/src/main/java/io/cdap/cdap/etl/api/Joiner.java", "diffHunk": "@@ -17,26 +17,48 @@\n package io.cdap.cdap.etl.api;\n \n import io.cdap.cdap.api.annotation.Beta;\n+import org.apache.commons.lang.NotImplementedException;\n+\n+import java.util.Collection;\n+import java.util.Collections;\n \n /**\n  * Provides join keys on which join needs to be performed and merges the join results.\n  *\n- * @param <JOIN_KEY> type of the join key\n+ * @param <JOIN_KEY>     type of the join key\n  * @param <INPUT_RECORD> type of input records to be joined\n- * @param <OUT> type of output object\n+ * @param <OUT>          type of output object\n  */\n @Beta\n public interface Joiner<JOIN_KEY, INPUT_RECORD, OUT> {\n \n   /**\n    * Return value for the join key on which join will be performed\n    *\n-   * @param stageName name of the stage to which records belongs to\n+   * @param stageName   name of the stage to which records belongs to\n    * @param inputRecord input record to be joined\n    * @return returns join key\n    * @throws Exception if there is some error getting the join key\n+   * @deprecated getJoinKeys() should be used instead", "originalCommit": "6bb15647603bc3af5c8798e8a0ade298f5d546c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE3NTg5Nw==", "url": "https://github.com/cdapio/cdap/pull/12520#discussion_r463175897", "bodyText": "done", "author": "MEseifan", "createdAt": "2020-07-30T18:01:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE3MjA0Mg=="}], "type": "inlineReview"}, {"oid": "001f3d9fc3a3abffa56d82be5b623a2c1653271e", "url": "https://github.com/cdapio/cdap/commit/001f3d9fc3a3abffa56d82be5b623a2c1653271e", "message": "(CDAP-17130) Added Distribution to BatchJoiner API", "committedDate": "2020-07-30T18:02:26Z", "type": "commit"}, {"oid": "001f3d9fc3a3abffa56d82be5b623a2c1653271e", "url": "https://github.com/cdapio/cdap/commit/001f3d9fc3a3abffa56d82be5b623a2c1653271e", "message": "(CDAP-17130) Added Distribution to BatchJoiner API", "committedDate": "2020-07-30T18:02:26Z", "type": "forcePushed"}]}