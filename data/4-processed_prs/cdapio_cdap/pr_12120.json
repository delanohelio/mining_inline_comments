{"pr_number": 12120, "pr_title": "[CDAP-16656] Improve performance of schema editor", "pr_createdAt": "2020-04-24T19:17:55Z", "pr_url": "https://github.com/cdapio/cdap/pull/12120", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjg3ODE4MQ==", "url": "https://github.com/cdapio/cdap/pull/12120#discussion_r416878181", "bodyText": "I assume the 50 here is coming from DEFAULT_FIELD_WINDOW_SIZE? If yes, can we use the variable here instead?", "author": "yukiej", "createdAt": "2020-04-28T19:47:42Z", "path": "cdap-ui/app/cdap/components/AbstractWidget/SqlSelectorWidget/SchemaContainer.tsx", "diffHunk": "@@ -171,6 +188,105 @@ class SchemaContainer extends React.Component<ISchemaContainerProps, ISchemaCont\n     return validationError;\n   }\n \n+  private componentID = `sql-fields-${uuidV4()}`;\n+\n+  private io = new IntersectionObserver(\n+    (entries) => {\n+      let lastVisibleElement = this.state.fieldWindowSize;\n+      for (const entry of entries) {\n+        let id = entry.target.getAttribute('id');\n+        id = id.split('-').pop();\n+        const idInt = parseInt(id, 10);\n+        if (entry.isIntersecting) {\n+          lastVisibleElement =\n+            idInt + 50 > this.state.fieldWindowSize ? idInt + DEFAULT_FIELD_WINDOW_SIZE : idInt;", "originalCommit": "b04068ba68052e106ca503e12b0601e18881c65d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjg3ODYwMA==", "url": "https://github.com/cdapio/cdap/pull/12120#discussion_r416878600", "bodyText": "Where is 100 coming from here?", "author": "yukiej", "createdAt": "2020-04-28T19:48:28Z", "path": "cdap-ui/app/directives/complex-schema/complex-schema.js", "diffHunk": "@@ -25,6 +25,74 @@ function ComplexSchemaController (avsc, SCHEMA_TYPES, $scope, uuid, $timeout, Sc\n   let timeout;\n   let addFieldTimeout;\n   vm.emptySchema = false;\n+  // lazy loading parameters\n+  $scope.id = uuid.v4();\n+  $scope.lazyLoadedParsedSchema = [];\n+  vm.windowSize = 50;\n+  vm.DEFAULT_WINDOW_SIZE = 50;\n+  vm.lazyloading = false;\n+\n+  $scope.$watch('domLoaded', () => {\n+    /*\n+      Wait for the dom to be loaded\n+      Equivalent of componentDidMount :sigh:\n+    */\n+    if (!$scope.domLoaded) {\n+      return;\n+    }\n+    /*\n+      For some reason if the dom is loaded but none of the fields are\n+      rendered we don't need to do anything.\n+    */\n+    const fields = document.querySelectorAll(`#schema-container-${$scope.id} .field-row`);\n+    if (!fields.length) {\n+      return;\n+    }\n+    vm.io = new IntersectionObserver(\n+      (entries) => {\n+        let lastVisibleElement = vm.windowSize;\n+        for (const entry of entries) {\n+          const id = entry.target.getAttribute('lazyload-id');\n+          const numID = parseInt(id, 10);\n+          if (entry.isIntersecting) {\n+            lastVisibleElement = numID + 100 > vm.windowSize ? numID + vm.DEFAULT_WINDOW_SIZE : numID;", "originalCommit": "b04068ba68052e106ca503e12b0601e18881c65d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzAxNTM4Mw==", "url": "https://github.com/cdapio/cdap/pull/12120#discussion_r417015383", "bodyText": "Have replaced it with valid const", "author": "ajainarayanan", "createdAt": "2020-04-29T01:10:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjg3ODYwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjg4MDAxNQ==", "url": "https://github.com/cdapio/cdap/pull/12120#discussion_r416880015", "bodyText": "maybe say !vm.initCollapse instead for conciseness?", "author": "yukiej", "createdAt": "2020-04-28T19:50:56Z", "path": "cdap-ui/app/directives/complex-schema/embedded-schema-selector/embedded-schema-selector.js", "diffHunk": "@@ -24,13 +24,14 @@ angular.module(PKG.name+'.commons')\n       displayType: '=',\n       index: '=',\n       parentFormatOutput: '&',\n-      isDisabled: '='\n+      isDisabled: '=',\n+      initCollapse: '='\n     },\n     bindToController: true,\n     controller: function (SchemaHelper) {\n       var vm = this;\n       vm.checkComplexType = SchemaHelper.checkComplexType;\n-      vm.expanded = true;\n+      vm.expanded = vm.initCollapse === true ? false : true;", "originalCommit": "b04068ba68052e106ca503e12b0601e18881c65d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6c06ad0ae686c386816ca647797798e053516b17", "url": "https://github.com/cdapio/cdap/commit/6c06ad0ae686c386816ca647797798e053516b17", "message": "[CDAP-16656] Improve performance of schema editor\n\n - Default to collapse schema at all levels to minimize load on rendering\n - Converts ng-show to ng-if in input schema to avoid rendering schema hidden inside accordion\n - Adds lazy loading to schema editor\n - Adds lazyloading to sqlselectwidget", "committedDate": "2020-05-02T12:59:18Z", "type": "commit"}, {"oid": "6c06ad0ae686c386816ca647797798e053516b17", "url": "https://github.com/cdapio/cdap/commit/6c06ad0ae686c386816ca647797798e053516b17", "message": "[CDAP-16656] Improve performance of schema editor\n\n - Default to collapse schema at all levels to minimize load on rendering\n - Converts ng-show to ng-if in input schema to avoid rendering schema hidden inside accordion\n - Adds lazy loading to schema editor\n - Adds lazyloading to sqlselectwidget", "committedDate": "2020-05-02T12:59:18Z", "type": "forcePushed"}]}