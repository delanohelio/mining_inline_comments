{"pr_number": 12724, "pr_title": "[CDAP-17239] Fix AuthorizerInstantiator Classloading Bug", "pr_createdAt": "2020-08-26T19:02:37Z", "pr_url": "https://github.com/cdapio/cdap/pull/12724", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUzMDIxNQ==", "url": "https://github.com/cdapio/cdap/pull/12724#discussion_r477530215", "bodyText": "Can we put a comment here to explain what we expect for this cleanup in constructor.", "author": "shifuxu0301", "createdAt": "2020-08-26T19:12:38Z", "path": "cdap-standalone/src/main/java/io/cdap/cdap/StandaloneMain.java", "diffHunk": "@@ -162,6 +162,8 @@ private StandaloneMain(List<Module> modules, CConfiguration cConf) {\n     Thread.setDefaultUncaughtExceptionHandler(new UncaughtExceptionHandler());\n     this.cConf = cConf;\n \n+    cleanupTempDir();", "originalCommit": "b0c0fb152433c41a02c5ec30cc628a0fe0b23d5d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUzNDk0OQ==", "url": "https://github.com/cdapio/cdap/pull/12724#discussion_r477534949", "bodyText": "Fixed", "author": "dli357", "createdAt": "2020-08-26T19:21:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUzMDIxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU0NzUzMA==", "url": "https://github.com/cdapio/cdap/pull/12724#discussion_r477547530", "bodyText": "normally it's not a good idea to perform work in the constructor. I'm also confused how this fixes the problem, is the classloader mentioned in the bug created before Standalone is started?", "author": "albertshau", "createdAt": "2020-08-26T19:45:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUzMDIxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzgyNDUzMQ==", "url": "https://github.com/cdapio/cdap/pull/12724#discussion_r477824531", "bodyText": "I agree with moving the logic out of the constructor. Currently, StandaloneMain's constructor creates several other classes which eventually instantiates an instance of Authorizer, causing the AuthorizerInstantiator to unpack the provided JAR file into the tmp directory. Since cleanupTempDir is currently called in startup, it is called after the constructor finishes, deleting the loaded classpath.", "author": "dli357", "createdAt": "2020-08-27T00:56:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUzMDIxNQ=="}], "type": "inlineReview"}, {"oid": "cbd5637521fc759aaa049f16ba0361ced58443c9", "url": "https://github.com/cdapio/cdap/commit/cbd5637521fc759aaa049f16ba0361ced58443c9", "message": "[CDAP-17239] Fix classloading bug where the classpath directory is deleted in StandaloneMain\n\n[CDAP-17239] Added comment", "committedDate": "2020-08-26T19:24:44Z", "type": "forcePushed"}, {"oid": "f190a48593715706f33351e1320ab6b72ebc8622", "url": "https://github.com/cdapio/cdap/commit/f190a48593715706f33351e1320ab6b72ebc8622", "message": "[CDAP-17239] Fix classloading bug where the classpath directory is deleted in StandaloneMain\n\n[CDAP-17239] Added comment\n\n[CDAP-17239] Moved temporary directory cleanup logic out of constructor", "committedDate": "2020-08-26T20:28:04Z", "type": "forcePushed"}, {"oid": "ee371d22b6bda5af01f78bb92bd96e715ff9023c", "url": "https://github.com/cdapio/cdap/commit/ee371d22b6bda5af01f78bb92bd96e715ff9023c", "message": "[CDAP-17239] Fix classloading bug where the classpath directory is deleted in StandaloneMain\n\n    [CDAP-17239] Added comment\n\n    [CDAP-17239] Moved temporary directory cleanup logic out of constructor", "committedDate": "2020-08-26T20:49:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU5NTU1OQ==", "url": "https://github.com/cdapio/cdap/pull/12724#discussion_r477595559", "bodyText": "Construct the path at callsite and pass that in, so it is clear what state the function needs instead of passing the whole configuration structure that this function doesn't care about the other n-2 fields", "author": "wyzhang", "createdAt": "2020-08-26T21:19:08Z", "path": "cdap-standalone/src/main/java/io/cdap/cdap/StandaloneMain.java", "diffHunk": "@@ -392,7 +390,7 @@ public void shutDown() {\n     }\n   }\n \n-  private void cleanupTempDir() {\n+  private static void cleanupTempDir(CConfiguration cConf) {\n     File tmpDir = new File(cConf.get(Constants.CFG_LOCAL_DATA_DIR),\n                            cConf.get(Constants.AppFabric.TEMP_DIR)).getAbsoluteFile();\n ", "originalCommit": "ee371d22b6bda5af01f78bb92bd96e715ff9023c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzYxOTcxOQ==", "url": "https://github.com/cdapio/cdap/pull/12724#discussion_r477619719", "bodyText": "Fixed", "author": "dli357", "createdAt": "2020-08-26T22:15:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU5NTU1OQ=="}], "type": "inlineReview"}, {"oid": "e017022c3eddf70330947cb3f5c29cb55883b34f", "url": "https://github.com/cdapio/cdap/commit/e017022c3eddf70330947cb3f5c29cb55883b34f", "message": "[CDAP-17239] Fix classloading bug where the classpath directory is deleted in StandaloneMain\n\n    [CDAP-17239] Added comment\n\n    [CDAP-17239] Moved temporary directory cleanup logic out of constructor\n\n[CDAP-17239] Construct tmpDir outside of static method", "committedDate": "2020-08-26T22:15:17Z", "type": "commit"}, {"oid": "e017022c3eddf70330947cb3f5c29cb55883b34f", "url": "https://github.com/cdapio/cdap/commit/e017022c3eddf70330947cb3f5c29cb55883b34f", "message": "[CDAP-17239] Fix classloading bug where the classpath directory is deleted in StandaloneMain\n\n    [CDAP-17239] Added comment\n\n    [CDAP-17239] Moved temporary directory cleanup logic out of constructor\n\n[CDAP-17239] Construct tmpDir outside of static method", "committedDate": "2020-08-26T22:15:17Z", "type": "forcePushed"}]}