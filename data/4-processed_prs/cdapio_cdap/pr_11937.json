{"pr_number": 11937, "pr_title": "(CDAP-16243) Added upgrade mechanism System Apps managed by SystemAppManagementService", "pr_createdAt": "2020-03-09T21:37:03Z", "pr_url": "https://github.com/cdapio/cdap/pull/11937", "timeline": [{"oid": "27f7131e5b01603e887af3c0ad5f96510ef4ee28", "url": "https://github.com/cdapio/cdap/commit/27f7131e5b01603e887af3c0ad5f96510ef4ee28", "message": "Support force upgrade for system applications in CDAP", "committedDate": "2020-03-09T21:30:32Z", "type": "commit"}, {"oid": "4e711c946ef0adb6a3814da97487633bd8db8d6e", "url": "https://github.com/cdapio/cdap/commit/4e711c946ef0adb6a3814da97487633bd8db8d6e", "message": "Fixing unitended changes", "committedDate": "2020-03-09T21:41:55Z", "type": "commit"}, {"oid": "a4bbe783498e3c87f0be964c47dc526944eb69c4", "url": "https://github.com/cdapio/cdap/commit/a4bbe783498e3c87f0be964c47dc526944eb69c4", "message": "Adding a TODO", "committedDate": "2020-03-09T21:53:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk4MzM0Mg==", "url": "https://github.com/cdapio/cdap/pull/11937#discussion_r389983342", "bodyText": "don't need to document exceptions in a unit test case.", "author": "albertshau", "createdAt": "2020-03-09T21:54:27Z", "path": "cdap-app-fabric/src/test/java/io/cdap/cdap/internal/sysapp/SystemAppManagementServiceTest.java", "diffHunk": "@@ -123,4 +124,45 @@ public void testSystemAppManagementServiceE2E() throws Exception {\n     waitState(serviceId1, RUNNING);\n     Assert.assertEquals(RUNNING, getProgramStatus(serviceId1));\n   }\n+\n+  /**\n+   * Tests SystemAppManagementService's upgrade method end to end by running this scenario:\n+   * 1. Creates a system app config for an application into corresponding directory with artifact version VERSION1.\n+   * 2. Successfully read and load the config.\n+   * 3. Runs all steps to enable a system app , tests SystemAppEnableExecutor.\n+   * 4. Deploys the VERSION1 app and runs all programs corresponding to the app.\n+   * 6. Updates system app config with app version upgraded to VERSION2.\n+   * 7. On restart of SystemAppManagementService, app should kill old running programs and start program again.\n+   * @throws Exception", "originalCommit": "4e711c946ef0adb6a3814da97487633bd8db8d6e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk4NDg0MQ==", "url": "https://github.com/cdapio/cdap/pull/11937#discussion_r389984841", "bodyText": "I believe this can also throw a ConflictException if the program is already stopped. If so, it will be caught, then ignored and the program will never be started.\nShould wrap this in a try-catch as well, ignore the conflict, and move on to running it.", "author": "albertshau", "createdAt": "2020-03-09T21:57:56Z", "path": "cdap-app-fabric/src/main/java/io/cdap/cdap/internal/sysapp/SystemAppEnableExecutor.java", "diffHunk": "@@ -136,11 +136,13 @@ private ApplicationWithPrograms deploySystemApp(Arguments arguments) throws Exce\n \n   private void startProgram(ProgramId programId) throws Exception {\n     try {\n-      // TODO(CDAP-16243): Restart program if the application has changed.\n-      // do nothing if the program is already running\n       ProgramStatus currentStatus = programLifecycleService.getProgramStatus(programId);\n-      if (currentStatus != ProgramStatus.STOPPED) {\n-        return;\n+      // If a system app is already running, it needs to be restarted as app artifact/arguments might have changed.\n+      // Restart should trigger running programs with latest version.\n+      // TODO(CDAP-16243): Find smarter way to trigger restart of programs rather than always restarting. May be\n+      //                   checking if artifact version has changed would be a good start.\n+      if (currentStatus == ProgramStatus.RUNNING) {\n+        programLifecycleService.stop(programId);", "originalCommit": "a4bbe783498e3c87f0be964c47dc526944eb69c4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8ab02211c9f885d2f6c9fc9ed91c7fbbfa5143fa", "url": "https://github.com/cdapio/cdap/commit/8ab02211c9f885d2f6c9fc9ed91c7fbbfa5143fa", "message": "Resolving comments", "committedDate": "2020-03-09T23:24:22Z", "type": "commit"}, {"oid": "6de8a19e0bbd2310d288f26c366366afeb342a2f", "url": "https://github.com/cdapio/cdap/commit/6de8a19e0bbd2310d288f26c366366afeb342a2f", "message": "Stylecheck fixes", "committedDate": "2020-03-09T23:47:23Z", "type": "commit"}]}