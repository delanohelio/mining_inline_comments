{"pr_number": 1217, "pr_title": "GetStorage and Storage Messages", "pr_createdAt": "2020-04-17T13:57:29Z", "pr_url": "https://github.com/rsksmart/rskj/pull/1217", "timeline": [{"oid": "6fd3eb12669303318ef4f024b358fef747b77d4c", "url": "https://github.com/rsksmart/rskj/commit/6fd3eb12669303318ef4f024b358fef747b77d4c", "message": "init storage messages", "committedDate": "2020-04-16T19:15:18Z", "type": "commit"}, {"oid": "a93577270f7a0213f4f4e699f944b1c43aba4ca0", "url": "https://github.com/rsksmart/rskj/commit/a93577270f7a0213f4f4e699f944b1c43aba4ca0", "message": "get storage functionality", "committedDate": "2020-04-16T19:16:50Z", "type": "commit"}, {"oid": "fe30fb1d456d8803d42e7699164e92dbd9ffedb8", "url": "https://github.com/rsksmart/rskj/commit/fe30fb1d456d8803d42e7699164e92dbd9ffedb8", "message": "tests!", "committedDate": "2020-04-17T13:49:41Z", "type": "commit"}, {"oid": "911cdaef7757ff81dcbd630225f0d358cf1d995c", "url": "https://github.com/rsksmart/rskj/commit/911cdaef7757ff81dcbd630225f0d358cf1d995c", "message": "headers", "committedDate": "2020-04-17T14:15:08Z", "type": "commit"}, {"oid": "911cdaef7757ff81dcbd630225f0d358cf1d995c", "url": "https://github.com/rsksmart/rskj/commit/911cdaef7757ff81dcbd630225f0d358cf1d995c", "message": "headers", "committedDate": "2020-04-17T14:15:08Z", "type": "forcePushed"}, {"oid": "8196f3641ab40786228c8370d0ebf511da6b5fe7", "url": "https://github.com/rsksmart/rskj/commit/8196f3641ab40786228c8370d0ebf511da6b5fe7", "message": "forgotten break", "committedDate": "2020-04-17T14:34:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI3ODAyOQ==", "url": "https://github.com/rsksmart/rskj/pull/1217#discussion_r410278029", "bodyText": "Dont forget to log in the next way:\nString logBlockHash = Hex.toHexString(blockHash);\nlogger.trace(\"Processing block header request {} block {}\", id, logBlockHash);", "author": "julianlen", "createdAt": "2020-04-17T14:55:45Z", "path": "rskj-core/src/main/java/co/rsk/net/light/LightProcessor.java", "diffHunk": "@@ -185,4 +186,28 @@ public void processGetBlockBodyMessage(long id, byte[] blockHash, LightPeer ligh\n     public void processBlockBodyMessage(long id, List<BlockHeader> uncles, List<Transaction> transactions, LightPeer lightPeer) {\n         throw new UnsupportedOperationException(\"Not supported BlockBody processing\");\n     }\n+\n+    public void processGetStorageMessage(long id, byte[] blockHash, byte[] addressHash, byte[] storageKeyHash, LightPeer lightPeer) {\n+        final Block block = blockStore.getBlockByHash(blockHash);", "originalCommit": "8196f3641ab40786228c8370d0ebf511da6b5fe7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI5MDM5MA==", "url": "https://github.com/rsksmart/rskj/pull/1217#discussion_r410290390", "bodyText": "You should test the case in which the address has null storage", "author": "julianlen", "createdAt": "2020-04-17T15:15:08Z", "path": "rskj-core/src/test/java/co/rsk/net/LightProcessorTest.java", "diffHunk": "@@ -329,6 +330,45 @@ public void processBlockBodyMessageAndShouldThrowAnException() {\n         lightProcessor.processBlockBodyMessage(0, uncleList, transactionList,  lightPeer);\n     }\n \n+    @Test\n+    public void processGetStorageMessageAndShouldReturnsBlockBodyCorrectly() {\n+        long id = 0;\n+        final Block block = mock(Block.class);\n+        RskAddress address = randomAddress();\n+        DataWord storageKey = DataWord.valueOf(HashUtil.randomHash());\n+        final RepositorySnapshot repositorySnapshot = mock(RepositorySnapshot.class);\n+        byte[] storageValue = HashUtil.randomHash();\n+\n+        when(blockStore.getBlockByHash(blockHash.getBytes())).thenReturn(block);\n+        when(block.getHash()).thenReturn(blockHash);\n+        when(repositoryLocator.snapshotAt(block.getHeader())).thenReturn(repositorySnapshot);\n+        when(repositorySnapshot.getStorageBytes(address, storageKey)).thenReturn(storageValue);\n+\n+        StorageMessage expectedMessage = new StorageMessage(id, new byte[] {0x00}, storageValue);\n+\n+        ArgumentCaptor<StorageMessage> argument = forClass(StorageMessage.class);\n+        lightProcessor.processGetStorageMessage(id, blockHash.getBytes(), address.getBytes(),\n+                storageKey.getData(), lightPeer);\n+        verify(msgQueue).sendMessage(argument.capture());\n+\n+        assertArrayEquals(expectedMessage.getEncoded(), argument.getValue().getEncoded());\n+    }\n+\n+    @Test\n+    public void processGetStorageyMessageWithInvalidBlockHash() {\n+        when(blockStore.getBlockByHash(blockHash.getBytes())).thenReturn(null);\n+\n+        lightProcessor.processGetStorageMessage(100, blockHash.getBytes(), randomAddress().getBytes(),\n+                new byte[] {0x00}, lightPeer);\n+\n+        verify(msgQueue, times(0)).sendMessage(any());\n+    }\n+\n+    @Test(expected = UnsupportedOperationException.class)\n+    public void processStorageMessageAndShouldThrowAnException() {\n+        lightProcessor.processStorageMessage(0, new byte[] {0x00}, new byte[] {0x00}, lightPeer);\n+    }\n+", "originalCommit": "8196f3641ab40786228c8370d0ebf511da6b5fe7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8ff20ef9373fc0e856e5b415ea59a547379a09da", "url": "https://github.com/rsksmart/rskj/commit/8ff20ef9373fc0e856e5b415ea59a547379a09da", "message": "changes! (from juli's review)", "committedDate": "2020-04-17T15:29:15Z", "type": "commit"}, {"oid": "8ff20ef9373fc0e856e5b415ea59a547379a09da", "url": "https://github.com/rsksmart/rskj/commit/8ff20ef9373fc0e856e5b415ea59a547379a09da", "message": "changes! (from juli's review)", "committedDate": "2020-04-17T15:29:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDMxMjI1NA==", "url": "https://github.com/rsksmart/rskj/pull/1217#discussion_r410312254", "bodyText": "To fix the SonarCloud advice \"Invoke method only conditionally\", we will start to log these messages in the next manner:\nString logBlockHash = Hex.toHexString(blockHash);\n        logger.trace(\"Processing block header request {} block {}\", id, logBlockHash);", "author": "julianlen", "createdAt": "2020-04-17T15:50:44Z", "path": "rskj-core/src/main/java/co/rsk/net/light/LightProcessor.java", "diffHunk": "@@ -185,4 +186,30 @@ public void processGetBlockBodyMessage(long id, byte[] blockHash, LightPeer ligh\n     public void processBlockBodyMessage(long id, List<BlockHeader> uncles, List<Transaction> transactions, LightPeer lightPeer) {\n         throw new UnsupportedOperationException(\"Not supported BlockBody processing\");\n     }\n+\n+    public void processGetStorageMessage(long id, byte[] blockHash, byte[] addressHash, byte[] storageKeyHash, LightPeer lightPeer) {\n+        logger.trace(\"Processing storage request {} block {} address {} storage key {}\", id,", "originalCommit": "8ff20ef9373fc0e856e5b415ea59a547379a09da", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c4d48c24e2e977cad4e6b83d5a173b4bf4a59bd7", "url": "https://github.com/rsksmart/rskj/commit/c4d48c24e2e977cad4e6b83d5a173b4bf4a59bd7", "message": "fix sonar cloud issues", "committedDate": "2020-04-17T16:40:12Z", "type": "commit"}]}