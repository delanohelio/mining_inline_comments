{"pr_number": 1284, "pr_title": "Fix JSON RPC trace_transaction and trace_block", "pr_createdAt": "2020-07-31T14:29:06Z", "pr_url": "https://github.com/rsksmart/rskj/pull/1284", "timeline": [{"oid": "7d0b9debd2c70c730f6d95604096c7576cae43ec", "url": "https://github.com/rsksmart/rskj/commit/7d0b9debd2c70c730f6d95604096c7576cae43ec", "message": "CREATE2 code test", "committedDate": "2020-07-31T18:49:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzgyMTMzMg==", "url": "https://github.com/rsksmart/rskj/pull/1284#discussion_r463821332", "bodyText": "shouldn't be \"create2\" : \"create\" ?", "author": "patogallaiovlabs", "createdAt": "2020-07-31T20:31:22Z", "path": "rskj-core/src/main/java/co/rsk/rpc/modules/trace/ProgramSubtrace.java", "diffHunk": "@@ -29,26 +29,28 @@\n     private final TraceType traceType;\n     private final CallType callType;\n     private final CreationData creationData;\n+    private final String creationMethod;\n     private final InvokeData invokeData;\n     private final ProgramResult programResult;\n     private final List<ProgramSubtrace> subtraces;\n \n     public static ProgramSubtrace newSuicideSubtrace(InvokeData invokeData) {\n-        return new ProgramSubtrace(TraceType.SUICIDE, CallType.NONE, null, invokeData, null, Collections.emptyList());\n+        return new ProgramSubtrace(TraceType.SUICIDE, CallType.NONE, null, null, invokeData, null, Collections.emptyList());\n     }\n \n-    public static ProgramSubtrace newCreateSubtrace(CreationData creationData, InvokeData invokeData, ProgramResult programResult, List<ProgramSubtrace> subtraces) {\n-        return new ProgramSubtrace(TraceType.CREATE, CallType.NONE, creationData, invokeData, programResult, subtraces);\n+    public static ProgramSubtrace newCreateSubtrace(CreationData creationData, InvokeData invokeData, ProgramResult programResult, List<ProgramSubtrace> subtraces, boolean isCreate2) {\n+        return new ProgramSubtrace(TraceType.CREATE, CallType.NONE, creationData, isCreate2 ? \"create2\" : null, invokeData, programResult, subtraces);", "originalCommit": "7d0b9debd2c70c730f6d95604096c7576cae43ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMwNDk4Mw==", "url": "https://github.com/rsksmart/rskj/pull/1284#discussion_r466304983", "bodyText": "Well, the creation method field does not appear in Parity output when the creation use the CREATE opcode. Our object to be serialized to JSON DOES NOT serialize fields in null. So, providing null avoid the appearance of creationMethod field in the output JSON, as in Parity", "author": "ajlopezrsk", "createdAt": "2020-08-06T10:02:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzgyMTMzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU0MjAyNA==", "url": "https://github.com/rsksmart/rskj/pull/1284#discussion_r466542024", "bodyText": "Check this Besu doc:\nhttps://besu.hyperledger.org/en/stable/Reference/API-Methods/#trace_transaction\nIn the Example->Json result tab.", "author": "patogallaiovlabs", "createdAt": "2020-08-06T16:39:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzgyMTMzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgwNTA3MA==", "url": "https://github.com/rsksmart/rskj/pull/1284#discussion_r465805070", "bodyText": "what does this do? are you using this to simulate something related to create2? I don't really follow it.", "author": "nicops", "createdAt": "2020-08-05T15:18:21Z", "path": "rskj-core/src/test/java/co/rsk/test/dsl/WorldDslProcessor.java", "diffHunk": "@@ -121,14 +122,35 @@ private void processAccountNewCommand(DslCommand cmd) {\n         String name = cmd.getArgument(0);\n         builder.name(name);\n \n-        if (cmd.getArity() > 1)\n+        if (cmd.getArity() > 1) {\n             builder.balance(new Coin(new BigInteger(cmd.getArgument(1))));\n+        }\n+\n+        if (cmd.getArity() > 2) {\n+            builder.code(Hex.decode(expandAccounts(cmd.getArgument(2))));\n+        }\n \n         Account account = builder.build();\n \n         world.saveAccount(name, account);\n     }\n \n+    private String expandAccounts(String bytecodes) {", "originalCommit": "7d0b9debd2c70c730f6d95604096c7576cae43ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUyOTMyNg==", "url": "https://github.com/rsksmart/rskj/pull/1284#discussion_r466529326", "bodyText": "It's related with delegatecall01.txt test file:\naccount_new acc1 10000000\n\n# contract account with simple return\n\n# code\n# PUSH1 0x00\n# PUSH1 0x00\n# RETURN\n\naccount_new delegated 0 60006000f3\n\n# contract account with delegate call\n\n# code\n# PUSH1 0x00    (output data size)\n# PUSH1 0x00    (output data offset)\n# PUSH1 0x00    (input data size)\n# PUSH1 0x00    (input data offset)\n# PUSH20 <delegated contract address>\n# PUSH2 0x1000   (gas to use)\n# DELEGATECALL\n# STOP\n\naccount_new delegatecall 0 600060006000600073[delegated]611000f400\n\nit replace [delegated] by the address of that account. We needed that address in the code to invoke the call to that address. The bytecode `73  push the next 20 bytes into the stack.\nThere is also a test code WorldDslProcessorTest.processAccountNewCommandWithBalanceAndCodeWithOtherAccountAddress", "author": "ajlopezrsk", "createdAt": "2020-08-06T16:17:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgwNTA3MA=="}], "type": "inlineReview"}, {"oid": "06b3e2efe89c8f806125d2505737651ce44a1496", "url": "https://github.com/rsksmart/rskj/commit/06b3e2efe89c8f806125d2505737651ce44a1496", "message": "Add creationMethod to action that uses the CREATE opcode", "committedDate": "2020-08-13T20:06:24Z", "type": "forcePushed"}, {"oid": "97028d43f300862a55751a3b6aab3b2e29391ff4", "url": "https://github.com/rsksmart/rskj/commit/97028d43f300862a55751a3b6aab3b2e29391ff4", "message": "Add creationMethod to action that uses the CREATE opcode", "committedDate": "2020-08-14T17:43:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzAxNTI4MA==", "url": "https://github.com/rsksmart/rskj/pull/1284#discussion_r473015280", "bodyText": "Here you don't check codeAddress for null when calling codeAddress.getLast20Bytes(). But there are some places where null is being passed for the codeAddress argument, like here, so looks like this param is nullable.\nI understand that it could be the case (btw.. is it ? ) that according to the logic codeAddress should never be null when callType == CallType.DELEGATECALL, but I guess it should be explicitly specified here in the code and properly handled if for some odd reason codeAddress is null when callType == CallType.DELEGATECALL", "author": "Vovchyk", "createdAt": "2020-08-19T13:08:35Z", "path": "rskj-core/src/main/java/co/rsk/rpc/modules/trace/TraceTransformer.java", "diffHunk": "@@ -168,7 +176,14 @@ public static TraceAction toAction(TraceType traceType, InvokeData invoke, CallT\n         if (traceType == TraceType.CALL) {\n             input = TypeConverter.toUnformattedJsonHex(invoke.getDataCopy(DataWord.ZERO, invoke.getDataSize()));;\n             value = TypeConverter.toQuantityJsonHex(callValue.getData());\n-            to = new RskAddress(invoke.getOwnerAddress().getLast20Bytes()).toJsonString();\n+\n+            if (callType == CallType.DELEGATECALL) {\n+                to = new RskAddress(codeAddress.getLast20Bytes()).toJsonString();", "originalCommit": "97028d43f300862a55751a3b6aab3b2e29391ff4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA1ODUwNQ==", "url": "https://github.com/rsksmart/rskj/pull/1284#discussion_r473058505", "bodyText": "Done", "author": "ajlopezrsk", "createdAt": "2020-08-19T14:09:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzAxNTI4MA=="}], "type": "inlineReview"}, {"oid": "3a8871de1eb46cb0fc697ebc116c3617debc2fe6", "url": "https://github.com/rsksmart/rskj/commit/3a8871de1eb46cb0fc697ebc116c3617debc2fe6", "message": "Checking callAddress is not null in TraceTransformer", "committedDate": "2020-08-19T14:54:37Z", "type": "forcePushed"}, {"oid": "17da212fe8550809c33f7cf9873162e157fb0a1f", "url": "https://github.com/rsksmart/rskj/commit/17da212fe8550809c33f7cf9873162e157fb0a1f", "message": "Fix trace delegate call string", "committedDate": "2020-08-26T13:41:20Z", "type": "commit"}, {"oid": "b69a219de0890fab12d6e5925e6b2969da3b3db4", "url": "https://github.com/rsksmart/rskj/commit/b69a219de0890fab12d6e5925e6b2969da3b3db4", "message": "Add creationMethod in trace action when CREATE2", "committedDate": "2020-08-26T13:41:21Z", "type": "commit"}, {"oid": "350a46cda9979fb3e72a23f16bfa1fb630fff67b", "url": "https://github.com/rsksmart/rskj/commit/350a46cda9979fb3e72a23f16bfa1fb630fff67b", "message": "DSL account_new with code and account address expansion in code", "committedDate": "2020-08-26T13:41:21Z", "type": "commit"}, {"oid": "9009e400c7b3aee1b9ec7bc586558355555d498c", "url": "https://github.com/rsksmart/rskj/commit/9009e400c7b3aee1b9ec7bc586558355555d498c", "message": "Delegate call trace transaction DSL test", "committedDate": "2020-08-26T13:41:21Z", "type": "commit"}, {"oid": "8c00cbeebfc7dd89e14c391b5929773f38893329", "url": "https://github.com/rsksmart/rskj/commit/8c00cbeebfc7dd89e14c391b5929773f38893329", "message": "CREATE2 code test", "committedDate": "2020-08-26T13:41:21Z", "type": "commit"}, {"oid": "ee5dd60df461cfc5970e7c099b6c6a47ec629e06", "url": "https://github.com/rsksmart/rskj/commit/ee5dd60df461cfc5970e7c099b6c6a47ec629e06", "message": "Fix trace transaction delegate call action fields (from, to)", "committedDate": "2020-08-26T13:41:21Z", "type": "commit"}, {"oid": "26e5425b0ec730e94f134ec381869f577c0d4b49", "url": "https://github.com/rsksmart/rskj/commit/26e5425b0ec730e94f134ec381869f577c0d4b49", "message": "Add creationMethod to action that uses the CREATE opcode", "committedDate": "2020-08-26T13:41:21Z", "type": "commit"}, {"oid": "70798618540d3ffdd901c9c915015d790c529ca0", "url": "https://github.com/rsksmart/rskj/commit/70798618540d3ffdd901c9c915015d790c529ca0", "message": "Checking callAddress is not null in TraceTransformer", "committedDate": "2020-08-26T13:41:21Z", "type": "commit"}, {"oid": "70798618540d3ffdd901c9c915015d790c529ca0", "url": "https://github.com/rsksmart/rskj/commit/70798618540d3ffdd901c9c915015d790c529ca0", "message": "Checking callAddress is not null in TraceTransformer", "committedDate": "2020-08-26T13:41:21Z", "type": "forcePushed"}]}