{"pr_number": 1321, "pr_title": "Create PeginInformation class", "pr_createdAt": "2020-09-29T19:32:35Z", "pr_url": "https://github.com/rsksmart/rskj/pull/1321", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk5Njk0MA==", "url": "https://github.com/rsksmart/rskj/pull/1321#discussion_r496996940", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    logger.debug(\"[parse] Trying to parse peg-in information from btc tx {}\", btcTx.getHash());\n          \n          \n            \n                    logger.trace(\"[parse] Trying to parse peg-in information from btc tx {}\", btcTx.getHash());", "author": "josedahlquist", "createdAt": "2020-09-29T19:37:22Z", "path": "rskj-core/src/main/java/co/rsk/peg/PeginInformation.java", "diffHunk": "@@ -0,0 +1,102 @@\n+package co.rsk.peg;\n+\n+import co.rsk.bitcoinj.core.Address;\n+import co.rsk.bitcoinj.core.BtcTransaction;\n+import co.rsk.core.RskAddress;\n+import co.rsk.peg.btcLockSender.BtcLockSender;\n+import co.rsk.peg.btcLockSender.BtcLockSenderProvider;\n+import co.rsk.peg.pegininstructions.PeginInstructions;\n+import co.rsk.peg.pegininstructions.PeginInstructionsException;\n+import co.rsk.peg.pegininstructions.PeginInstructionsProvider;\n+import co.rsk.peg.pegininstructions.PeginInstructionsVersion1;\n+import java.util.Optional;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class PeginInformation {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(PeginInformation.class);\n+\n+    private final BtcLockSenderProvider btcLockSenderProvider;\n+    private final PeginInstructionsProvider peginInstructionsProvider;\n+\n+    private int protocolVersion;\n+    private RskAddress rskDestinationAddress;\n+    private Address btcRefundAddress;\n+\n+    public PeginInformation(\n+        BtcLockSenderProvider btcLockSenderProvider,\n+        PeginInstructionsProvider peginInstructionsProvider) {\n+        this.btcLockSenderProvider = btcLockSenderProvider;\n+        this.peginInstructionsProvider = peginInstructionsProvider;\n+    }\n+\n+    public int getProtocolVersion() {\n+        return protocolVersion;\n+    }\n+\n+    public RskAddress getRskDestinationAddress() {\n+        return this.rskDestinationAddress;\n+    }\n+\n+    public Address getBtcRefundAddress() {\n+        return this.btcRefundAddress;\n+    }\n+\n+    public void parse(BtcTransaction btcTx) throws PeginInstructionsException {\n+        logger.debug(\"[parse] Trying to parse peg-in information from btc tx {}\", btcTx.getHash());", "originalCommit": "9b07ce07a850ffb4fc558ac7d527108f75029fcd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk5NzEwNA==", "url": "https://github.com/rsksmart/rskj/pull/1321#discussion_r496997104", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if(btcLockSenderOptional.isPresent()) {\n          \n          \n            \n                    if (btcLockSenderOptional.isPresent()) {", "author": "josedahlquist", "createdAt": "2020-09-29T19:37:40Z", "path": "rskj-core/src/main/java/co/rsk/peg/PeginInformation.java", "diffHunk": "@@ -0,0 +1,102 @@\n+package co.rsk.peg;\n+\n+import co.rsk.bitcoinj.core.Address;\n+import co.rsk.bitcoinj.core.BtcTransaction;\n+import co.rsk.core.RskAddress;\n+import co.rsk.peg.btcLockSender.BtcLockSender;\n+import co.rsk.peg.btcLockSender.BtcLockSenderProvider;\n+import co.rsk.peg.pegininstructions.PeginInstructions;\n+import co.rsk.peg.pegininstructions.PeginInstructionsException;\n+import co.rsk.peg.pegininstructions.PeginInstructionsProvider;\n+import co.rsk.peg.pegininstructions.PeginInstructionsVersion1;\n+import java.util.Optional;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class PeginInformation {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(PeginInformation.class);\n+\n+    private final BtcLockSenderProvider btcLockSenderProvider;\n+    private final PeginInstructionsProvider peginInstructionsProvider;\n+\n+    private int protocolVersion;\n+    private RskAddress rskDestinationAddress;\n+    private Address btcRefundAddress;\n+\n+    public PeginInformation(\n+        BtcLockSenderProvider btcLockSenderProvider,\n+        PeginInstructionsProvider peginInstructionsProvider) {\n+        this.btcLockSenderProvider = btcLockSenderProvider;\n+        this.peginInstructionsProvider = peginInstructionsProvider;\n+    }\n+\n+    public int getProtocolVersion() {\n+        return protocolVersion;\n+    }\n+\n+    public RskAddress getRskDestinationAddress() {\n+        return this.rskDestinationAddress;\n+    }\n+\n+    public Address getBtcRefundAddress() {\n+        return this.btcRefundAddress;\n+    }\n+\n+    public void parse(BtcTransaction btcTx) throws PeginInstructionsException {\n+        logger.debug(\"[parse] Trying to parse peg-in information from btc tx {}\", btcTx.getHash());\n+\n+        // Get information from tx sender first\n+        Optional<BtcLockSender> btcLockSenderOptional = btcLockSenderProvider.tryGetBtcLockSender(btcTx);\n+        if(btcLockSenderOptional.isPresent()) {", "originalCommit": "9b07ce07a850ffb4fc558ac7d527108f75029fcd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk5Nzc5Mg==", "url": "https://github.com/rsksmart/rskj/pull/1321#discussion_r496997792", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        logger.error(\"[parse] {}\", message);\n          \n          \n            \n                        logger.warn(\"[parse] {}\", message);", "author": "josedahlquist", "createdAt": "2020-09-29T19:39:03Z", "path": "rskj-core/src/main/java/co/rsk/peg/PeginInformation.java", "diffHunk": "@@ -0,0 +1,102 @@\n+package co.rsk.peg;\n+\n+import co.rsk.bitcoinj.core.Address;\n+import co.rsk.bitcoinj.core.BtcTransaction;\n+import co.rsk.core.RskAddress;\n+import co.rsk.peg.btcLockSender.BtcLockSender;\n+import co.rsk.peg.btcLockSender.BtcLockSenderProvider;\n+import co.rsk.peg.pegininstructions.PeginInstructions;\n+import co.rsk.peg.pegininstructions.PeginInstructionsException;\n+import co.rsk.peg.pegininstructions.PeginInstructionsProvider;\n+import co.rsk.peg.pegininstructions.PeginInstructionsVersion1;\n+import java.util.Optional;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class PeginInformation {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(PeginInformation.class);\n+\n+    private final BtcLockSenderProvider btcLockSenderProvider;\n+    private final PeginInstructionsProvider peginInstructionsProvider;\n+\n+    private int protocolVersion;\n+    private RskAddress rskDestinationAddress;\n+    private Address btcRefundAddress;\n+\n+    public PeginInformation(\n+        BtcLockSenderProvider btcLockSenderProvider,\n+        PeginInstructionsProvider peginInstructionsProvider) {\n+        this.btcLockSenderProvider = btcLockSenderProvider;\n+        this.peginInstructionsProvider = peginInstructionsProvider;\n+    }\n+\n+    public int getProtocolVersion() {\n+        return protocolVersion;\n+    }\n+\n+    public RskAddress getRskDestinationAddress() {\n+        return this.rskDestinationAddress;\n+    }\n+\n+    public Address getBtcRefundAddress() {\n+        return this.btcRefundAddress;\n+    }\n+\n+    public void parse(BtcTransaction btcTx) throws PeginInstructionsException {\n+        logger.debug(\"[parse] Trying to parse peg-in information from btc tx {}\", btcTx.getHash());\n+\n+        // Get information from tx sender first\n+        Optional<BtcLockSender> btcLockSenderOptional = btcLockSenderProvider.tryGetBtcLockSender(btcTx);\n+        if(btcLockSenderOptional.isPresent()) {\n+            BtcLockSender btcLockSender = btcLockSenderOptional.get();\n+            parseFromBtcLockSender(btcLockSender);\n+        }\n+\n+        // If peg-in instructions were provided then override the info obtained from BtcLockSender\n+        Optional<PeginInstructions> peginInstructionsOptional = peginInstructionsProvider.buildPeginInstructions(btcTx);\n+        if (peginInstructionsOptional.isPresent()) {\n+            PeginInstructions peginInstructions = peginInstructionsOptional.get();\n+            parseFromPeginInstructions(peginInstructions);\n+        }\n+\n+        // If BtcLockSender could not be parsed and peg-in instructions were not provided, then this tx can't be processed\n+        if(!btcLockSenderOptional.isPresent() && !peginInstructionsOptional.isPresent()) {\n+            String message = String.format(\"Could not get peg-in information for tx %s\", btcTx.getHash());\n+            logger.error(\"[parse] {}\", message);", "originalCommit": "9b07ce07a850ffb4fc558ac7d527108f75029fcd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk5Nzk3Ng==", "url": "https://github.com/rsksmart/rskj/pull/1321#discussion_r496997976", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    logger.info(\"[parseFromBtcLockSender] RSK destination address: {}\", btcLockSender.getRskAddress());\n          \n          \n            \n                    logger.info(\"[parseFromBtcLockSender] BTC refund address: {}\", btcLockSender.getBTCAddress().toBase58());\n          \n          \n            \n                    logger.trace(\"[parseFromBtcLockSender] RSK destination address: {}\", btcLockSender.getRskAddress());\n          \n          \n            \n                    logger.trace(\"[parseFromBtcLockSender] BTC refund address: {}\", btcLockSender.getBTCAddress());\n          \n      \n    \n    \n  \n\nBesides the logging level, you don't need to call toBase58. Internally this method calls toString which is automatically called by the log, if the logging level is enabled.", "author": "josedahlquist", "createdAt": "2020-09-29T19:39:22Z", "path": "rskj-core/src/main/java/co/rsk/peg/PeginInformation.java", "diffHunk": "@@ -0,0 +1,102 @@\n+package co.rsk.peg;\n+\n+import co.rsk.bitcoinj.core.Address;\n+import co.rsk.bitcoinj.core.BtcTransaction;\n+import co.rsk.core.RskAddress;\n+import co.rsk.peg.btcLockSender.BtcLockSender;\n+import co.rsk.peg.btcLockSender.BtcLockSenderProvider;\n+import co.rsk.peg.pegininstructions.PeginInstructions;\n+import co.rsk.peg.pegininstructions.PeginInstructionsException;\n+import co.rsk.peg.pegininstructions.PeginInstructionsProvider;\n+import co.rsk.peg.pegininstructions.PeginInstructionsVersion1;\n+import java.util.Optional;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class PeginInformation {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(PeginInformation.class);\n+\n+    private final BtcLockSenderProvider btcLockSenderProvider;\n+    private final PeginInstructionsProvider peginInstructionsProvider;\n+\n+    private int protocolVersion;\n+    private RskAddress rskDestinationAddress;\n+    private Address btcRefundAddress;\n+\n+    public PeginInformation(\n+        BtcLockSenderProvider btcLockSenderProvider,\n+        PeginInstructionsProvider peginInstructionsProvider) {\n+        this.btcLockSenderProvider = btcLockSenderProvider;\n+        this.peginInstructionsProvider = peginInstructionsProvider;\n+    }\n+\n+    public int getProtocolVersion() {\n+        return protocolVersion;\n+    }\n+\n+    public RskAddress getRskDestinationAddress() {\n+        return this.rskDestinationAddress;\n+    }\n+\n+    public Address getBtcRefundAddress() {\n+        return this.btcRefundAddress;\n+    }\n+\n+    public void parse(BtcTransaction btcTx) throws PeginInstructionsException {\n+        logger.debug(\"[parse] Trying to parse peg-in information from btc tx {}\", btcTx.getHash());\n+\n+        // Get information from tx sender first\n+        Optional<BtcLockSender> btcLockSenderOptional = btcLockSenderProvider.tryGetBtcLockSender(btcTx);\n+        if(btcLockSenderOptional.isPresent()) {\n+            BtcLockSender btcLockSender = btcLockSenderOptional.get();\n+            parseFromBtcLockSender(btcLockSender);\n+        }\n+\n+        // If peg-in instructions were provided then override the info obtained from BtcLockSender\n+        Optional<PeginInstructions> peginInstructionsOptional = peginInstructionsProvider.buildPeginInstructions(btcTx);\n+        if (peginInstructionsOptional.isPresent()) {\n+            PeginInstructions peginInstructions = peginInstructionsOptional.get();\n+            parseFromPeginInstructions(peginInstructions);\n+        }\n+\n+        // If BtcLockSender could not be parsed and peg-in instructions were not provided, then this tx can't be processed\n+        if(!btcLockSenderOptional.isPresent() && !peginInstructionsOptional.isPresent()) {\n+            String message = String.format(\"Could not get peg-in information for tx %s\", btcTx.getHash());\n+            logger.error(\"[parse] {}\", message);\n+            throw new PeginInstructionsException(message);\n+        }\n+    }\n+\n+    private void parseFromBtcLockSender(BtcLockSender btcLockSender) {\n+        this.protocolVersion = 0;\n+        this.rskDestinationAddress = btcLockSender.getRskAddress();\n+        this.btcRefundAddress = btcLockSender.getBTCAddress();\n+\n+        logger.info(\"[parseFromBtcLockSender] RSK destination address: {}\", btcLockSender.getRskAddress());\n+        logger.info(\"[parseFromBtcLockSender] BTC refund address: {}\", btcLockSender.getBTCAddress().toBase58());", "originalCommit": "9b07ce07a850ffb4fc558ac7d527108f75029fcd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk5ODgwMw==", "url": "https://github.com/rsksmart/rskj/pull/1321#discussion_r496998803", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    logger.info(\"[parseFromPeginInstructions] Protocol version: {}\", peginInstructions.getProtocolVersion());\n          \n          \n            \n                    logger.info(\"[parseFromPeginInstructions] RSK destination address: {}\", peginInstructions.getRskDestinationAddress());\n          \n          \n            \n                    logger.trace(\"[parseFromPeginInstructions] Protocol version: {}\", peginInstructions.getProtocolVersion());\n          \n          \n            \n                    logger.trace(\"[parseFromPeginInstructions] RSK destination address: {}\", peginInstructions.getRskDestinationAddress());", "author": "josedahlquist", "createdAt": "2020-09-29T19:40:48Z", "path": "rskj-core/src/main/java/co/rsk/peg/PeginInformation.java", "diffHunk": "@@ -0,0 +1,102 @@\n+package co.rsk.peg;\n+\n+import co.rsk.bitcoinj.core.Address;\n+import co.rsk.bitcoinj.core.BtcTransaction;\n+import co.rsk.core.RskAddress;\n+import co.rsk.peg.btcLockSender.BtcLockSender;\n+import co.rsk.peg.btcLockSender.BtcLockSenderProvider;\n+import co.rsk.peg.pegininstructions.PeginInstructions;\n+import co.rsk.peg.pegininstructions.PeginInstructionsException;\n+import co.rsk.peg.pegininstructions.PeginInstructionsProvider;\n+import co.rsk.peg.pegininstructions.PeginInstructionsVersion1;\n+import java.util.Optional;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class PeginInformation {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(PeginInformation.class);\n+\n+    private final BtcLockSenderProvider btcLockSenderProvider;\n+    private final PeginInstructionsProvider peginInstructionsProvider;\n+\n+    private int protocolVersion;\n+    private RskAddress rskDestinationAddress;\n+    private Address btcRefundAddress;\n+\n+    public PeginInformation(\n+        BtcLockSenderProvider btcLockSenderProvider,\n+        PeginInstructionsProvider peginInstructionsProvider) {\n+        this.btcLockSenderProvider = btcLockSenderProvider;\n+        this.peginInstructionsProvider = peginInstructionsProvider;\n+    }\n+\n+    public int getProtocolVersion() {\n+        return protocolVersion;\n+    }\n+\n+    public RskAddress getRskDestinationAddress() {\n+        return this.rskDestinationAddress;\n+    }\n+\n+    public Address getBtcRefundAddress() {\n+        return this.btcRefundAddress;\n+    }\n+\n+    public void parse(BtcTransaction btcTx) throws PeginInstructionsException {\n+        logger.debug(\"[parse] Trying to parse peg-in information from btc tx {}\", btcTx.getHash());\n+\n+        // Get information from tx sender first\n+        Optional<BtcLockSender> btcLockSenderOptional = btcLockSenderProvider.tryGetBtcLockSender(btcTx);\n+        if(btcLockSenderOptional.isPresent()) {\n+            BtcLockSender btcLockSender = btcLockSenderOptional.get();\n+            parseFromBtcLockSender(btcLockSender);\n+        }\n+\n+        // If peg-in instructions were provided then override the info obtained from BtcLockSender\n+        Optional<PeginInstructions> peginInstructionsOptional = peginInstructionsProvider.buildPeginInstructions(btcTx);\n+        if (peginInstructionsOptional.isPresent()) {\n+            PeginInstructions peginInstructions = peginInstructionsOptional.get();\n+            parseFromPeginInstructions(peginInstructions);\n+        }\n+\n+        // If BtcLockSender could not be parsed and peg-in instructions were not provided, then this tx can't be processed\n+        if(!btcLockSenderOptional.isPresent() && !peginInstructionsOptional.isPresent()) {\n+            String message = String.format(\"Could not get peg-in information for tx %s\", btcTx.getHash());\n+            logger.error(\"[parse] {}\", message);\n+            throw new PeginInstructionsException(message);\n+        }\n+    }\n+\n+    private void parseFromBtcLockSender(BtcLockSender btcLockSender) {\n+        this.protocolVersion = 0;\n+        this.rskDestinationAddress = btcLockSender.getRskAddress();\n+        this.btcRefundAddress = btcLockSender.getBTCAddress();\n+\n+        logger.info(\"[parseFromBtcLockSender] RSK destination address: {}\", btcLockSender.getRskAddress());\n+        logger.info(\"[parseFromBtcLockSender] BTC refund address: {}\", btcLockSender.getBTCAddress().toBase58());\n+    }\n+\n+    private void parseFromPeginInstructions(PeginInstructions peginInstructions)  throws PeginInstructionsException {\n+        this.protocolVersion = peginInstructions.getProtocolVersion();\n+        this.rskDestinationAddress = peginInstructions.getRskDestinationAddress();\n+        logger.info(\"[parseFromPeginInstructions] Protocol version: {}\", peginInstructions.getProtocolVersion());\n+        logger.info(\"[parseFromPeginInstructions] RSK destination address: {}\", peginInstructions.getRskDestinationAddress());", "originalCommit": "9b07ce07a850ffb4fc558ac7d527108f75029fcd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk5OTEzMQ==", "url": "https://github.com/rsksmart/rskj/pull/1321#discussion_r496999131", "bodyText": "it would be nice to also log the protocol version in this case", "author": "josedahlquist", "createdAt": "2020-09-29T19:41:29Z", "path": "rskj-core/src/main/java/co/rsk/peg/PeginInformation.java", "diffHunk": "@@ -0,0 +1,102 @@\n+package co.rsk.peg;\n+\n+import co.rsk.bitcoinj.core.Address;\n+import co.rsk.bitcoinj.core.BtcTransaction;\n+import co.rsk.core.RskAddress;\n+import co.rsk.peg.btcLockSender.BtcLockSender;\n+import co.rsk.peg.btcLockSender.BtcLockSenderProvider;\n+import co.rsk.peg.pegininstructions.PeginInstructions;\n+import co.rsk.peg.pegininstructions.PeginInstructionsException;\n+import co.rsk.peg.pegininstructions.PeginInstructionsProvider;\n+import co.rsk.peg.pegininstructions.PeginInstructionsVersion1;\n+import java.util.Optional;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class PeginInformation {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(PeginInformation.class);\n+\n+    private final BtcLockSenderProvider btcLockSenderProvider;\n+    private final PeginInstructionsProvider peginInstructionsProvider;\n+\n+    private int protocolVersion;\n+    private RskAddress rskDestinationAddress;\n+    private Address btcRefundAddress;\n+\n+    public PeginInformation(\n+        BtcLockSenderProvider btcLockSenderProvider,\n+        PeginInstructionsProvider peginInstructionsProvider) {\n+        this.btcLockSenderProvider = btcLockSenderProvider;\n+        this.peginInstructionsProvider = peginInstructionsProvider;\n+    }\n+\n+    public int getProtocolVersion() {\n+        return protocolVersion;\n+    }\n+\n+    public RskAddress getRskDestinationAddress() {\n+        return this.rskDestinationAddress;\n+    }\n+\n+    public Address getBtcRefundAddress() {\n+        return this.btcRefundAddress;\n+    }\n+\n+    public void parse(BtcTransaction btcTx) throws PeginInstructionsException {\n+        logger.debug(\"[parse] Trying to parse peg-in information from btc tx {}\", btcTx.getHash());\n+\n+        // Get information from tx sender first\n+        Optional<BtcLockSender> btcLockSenderOptional = btcLockSenderProvider.tryGetBtcLockSender(btcTx);\n+        if(btcLockSenderOptional.isPresent()) {\n+            BtcLockSender btcLockSender = btcLockSenderOptional.get();\n+            parseFromBtcLockSender(btcLockSender);\n+        }\n+\n+        // If peg-in instructions were provided then override the info obtained from BtcLockSender\n+        Optional<PeginInstructions> peginInstructionsOptional = peginInstructionsProvider.buildPeginInstructions(btcTx);\n+        if (peginInstructionsOptional.isPresent()) {\n+            PeginInstructions peginInstructions = peginInstructionsOptional.get();\n+            parseFromPeginInstructions(peginInstructions);\n+        }\n+\n+        // If BtcLockSender could not be parsed and peg-in instructions were not provided, then this tx can't be processed\n+        if(!btcLockSenderOptional.isPresent() && !peginInstructionsOptional.isPresent()) {\n+            String message = String.format(\"Could not get peg-in information for tx %s\", btcTx.getHash());\n+            logger.error(\"[parse] {}\", message);\n+            throw new PeginInstructionsException(message);\n+        }\n+    }\n+\n+    private void parseFromBtcLockSender(BtcLockSender btcLockSender) {\n+        this.protocolVersion = 0;", "originalCommit": "9b07ce07a850ffb4fc558ac7d527108f75029fcd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk5OTcyNg==", "url": "https://github.com/rsksmart/rskj/pull/1321#discussion_r496999726", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                logger.info(\"[parseFromPeginInstructions] BTC refund address: {}\", btcRefundAddressOptional.get().toBase58());\n          \n          \n            \n                                logger.trace(\"[parseFromPeginInstructions] BTC refund address: {}\", btcRefundAddressOptional.get());", "author": "josedahlquist", "createdAt": "2020-09-29T19:42:38Z", "path": "rskj-core/src/main/java/co/rsk/peg/PeginInformation.java", "diffHunk": "@@ -0,0 +1,102 @@\n+package co.rsk.peg;\n+\n+import co.rsk.bitcoinj.core.Address;\n+import co.rsk.bitcoinj.core.BtcTransaction;\n+import co.rsk.core.RskAddress;\n+import co.rsk.peg.btcLockSender.BtcLockSender;\n+import co.rsk.peg.btcLockSender.BtcLockSenderProvider;\n+import co.rsk.peg.pegininstructions.PeginInstructions;\n+import co.rsk.peg.pegininstructions.PeginInstructionsException;\n+import co.rsk.peg.pegininstructions.PeginInstructionsProvider;\n+import co.rsk.peg.pegininstructions.PeginInstructionsVersion1;\n+import java.util.Optional;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class PeginInformation {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(PeginInformation.class);\n+\n+    private final BtcLockSenderProvider btcLockSenderProvider;\n+    private final PeginInstructionsProvider peginInstructionsProvider;\n+\n+    private int protocolVersion;\n+    private RskAddress rskDestinationAddress;\n+    private Address btcRefundAddress;\n+\n+    public PeginInformation(\n+        BtcLockSenderProvider btcLockSenderProvider,\n+        PeginInstructionsProvider peginInstructionsProvider) {\n+        this.btcLockSenderProvider = btcLockSenderProvider;\n+        this.peginInstructionsProvider = peginInstructionsProvider;\n+    }\n+\n+    public int getProtocolVersion() {\n+        return protocolVersion;\n+    }\n+\n+    public RskAddress getRskDestinationAddress() {\n+        return this.rskDestinationAddress;\n+    }\n+\n+    public Address getBtcRefundAddress() {\n+        return this.btcRefundAddress;\n+    }\n+\n+    public void parse(BtcTransaction btcTx) throws PeginInstructionsException {\n+        logger.debug(\"[parse] Trying to parse peg-in information from btc tx {}\", btcTx.getHash());\n+\n+        // Get information from tx sender first\n+        Optional<BtcLockSender> btcLockSenderOptional = btcLockSenderProvider.tryGetBtcLockSender(btcTx);\n+        if(btcLockSenderOptional.isPresent()) {\n+            BtcLockSender btcLockSender = btcLockSenderOptional.get();\n+            parseFromBtcLockSender(btcLockSender);\n+        }\n+\n+        // If peg-in instructions were provided then override the info obtained from BtcLockSender\n+        Optional<PeginInstructions> peginInstructionsOptional = peginInstructionsProvider.buildPeginInstructions(btcTx);\n+        if (peginInstructionsOptional.isPresent()) {\n+            PeginInstructions peginInstructions = peginInstructionsOptional.get();\n+            parseFromPeginInstructions(peginInstructions);\n+        }\n+\n+        // If BtcLockSender could not be parsed and peg-in instructions were not provided, then this tx can't be processed\n+        if(!btcLockSenderOptional.isPresent() && !peginInstructionsOptional.isPresent()) {\n+            String message = String.format(\"Could not get peg-in information for tx %s\", btcTx.getHash());\n+            logger.error(\"[parse] {}\", message);\n+            throw new PeginInstructionsException(message);\n+        }\n+    }\n+\n+    private void parseFromBtcLockSender(BtcLockSender btcLockSender) {\n+        this.protocolVersion = 0;\n+        this.rskDestinationAddress = btcLockSender.getRskAddress();\n+        this.btcRefundAddress = btcLockSender.getBTCAddress();\n+\n+        logger.info(\"[parseFromBtcLockSender] RSK destination address: {}\", btcLockSender.getRskAddress());\n+        logger.info(\"[parseFromBtcLockSender] BTC refund address: {}\", btcLockSender.getBTCAddress().toBase58());\n+    }\n+\n+    private void parseFromPeginInstructions(PeginInstructions peginInstructions)  throws PeginInstructionsException {\n+        this.protocolVersion = peginInstructions.getProtocolVersion();\n+        this.rskDestinationAddress = peginInstructions.getRskDestinationAddress();\n+        logger.info(\"[parseFromPeginInstructions] Protocol version: {}\", peginInstructions.getProtocolVersion());\n+        logger.info(\"[parseFromPeginInstructions] RSK destination address: {}\", peginInstructions.getRskDestinationAddress());\n+\n+        switch (protocolVersion) {\n+            case 1:\n+                PeginInstructionsVersion1 peginInstructionsV1 = (PeginInstructionsVersion1) peginInstructions;\n+                Optional<Address> btcRefundAddressOptional = peginInstructionsV1\n+                    .getBtcRefundAddress();\n+                if (btcRefundAddressOptional.isPresent()) {\n+                    this.btcRefundAddress = btcRefundAddressOptional.get();\n+                    logger.info(\"[parseFromPeginInstructions] BTC refund address: {}\", btcRefundAddressOptional.get().toBase58());", "originalCommit": "9b07ce07a850ffb4fc558ac7d527108f75029fcd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzAwMDEzNg==", "url": "https://github.com/rsksmart/rskj/pull/1321#discussion_r497000136", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            logger.error(\"[parseFromPeginInstructions] {}\", message);\n          \n          \n            \n                            logger.warn(\"[parseFromPeginInstructions] {}\", message);", "author": "josedahlquist", "createdAt": "2020-09-29T19:43:30Z", "path": "rskj-core/src/main/java/co/rsk/peg/PeginInformation.java", "diffHunk": "@@ -0,0 +1,102 @@\n+package co.rsk.peg;\n+\n+import co.rsk.bitcoinj.core.Address;\n+import co.rsk.bitcoinj.core.BtcTransaction;\n+import co.rsk.core.RskAddress;\n+import co.rsk.peg.btcLockSender.BtcLockSender;\n+import co.rsk.peg.btcLockSender.BtcLockSenderProvider;\n+import co.rsk.peg.pegininstructions.PeginInstructions;\n+import co.rsk.peg.pegininstructions.PeginInstructionsException;\n+import co.rsk.peg.pegininstructions.PeginInstructionsProvider;\n+import co.rsk.peg.pegininstructions.PeginInstructionsVersion1;\n+import java.util.Optional;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class PeginInformation {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(PeginInformation.class);\n+\n+    private final BtcLockSenderProvider btcLockSenderProvider;\n+    private final PeginInstructionsProvider peginInstructionsProvider;\n+\n+    private int protocolVersion;\n+    private RskAddress rskDestinationAddress;\n+    private Address btcRefundAddress;\n+\n+    public PeginInformation(\n+        BtcLockSenderProvider btcLockSenderProvider,\n+        PeginInstructionsProvider peginInstructionsProvider) {\n+        this.btcLockSenderProvider = btcLockSenderProvider;\n+        this.peginInstructionsProvider = peginInstructionsProvider;\n+    }\n+\n+    public int getProtocolVersion() {\n+        return protocolVersion;\n+    }\n+\n+    public RskAddress getRskDestinationAddress() {\n+        return this.rskDestinationAddress;\n+    }\n+\n+    public Address getBtcRefundAddress() {\n+        return this.btcRefundAddress;\n+    }\n+\n+    public void parse(BtcTransaction btcTx) throws PeginInstructionsException {\n+        logger.debug(\"[parse] Trying to parse peg-in information from btc tx {}\", btcTx.getHash());\n+\n+        // Get information from tx sender first\n+        Optional<BtcLockSender> btcLockSenderOptional = btcLockSenderProvider.tryGetBtcLockSender(btcTx);\n+        if(btcLockSenderOptional.isPresent()) {\n+            BtcLockSender btcLockSender = btcLockSenderOptional.get();\n+            parseFromBtcLockSender(btcLockSender);\n+        }\n+\n+        // If peg-in instructions were provided then override the info obtained from BtcLockSender\n+        Optional<PeginInstructions> peginInstructionsOptional = peginInstructionsProvider.buildPeginInstructions(btcTx);\n+        if (peginInstructionsOptional.isPresent()) {\n+            PeginInstructions peginInstructions = peginInstructionsOptional.get();\n+            parseFromPeginInstructions(peginInstructions);\n+        }\n+\n+        // If BtcLockSender could not be parsed and peg-in instructions were not provided, then this tx can't be processed\n+        if(!btcLockSenderOptional.isPresent() && !peginInstructionsOptional.isPresent()) {\n+            String message = String.format(\"Could not get peg-in information for tx %s\", btcTx.getHash());\n+            logger.error(\"[parse] {}\", message);\n+            throw new PeginInstructionsException(message);\n+        }\n+    }\n+\n+    private void parseFromBtcLockSender(BtcLockSender btcLockSender) {\n+        this.protocolVersion = 0;\n+        this.rskDestinationAddress = btcLockSender.getRskAddress();\n+        this.btcRefundAddress = btcLockSender.getBTCAddress();\n+\n+        logger.info(\"[parseFromBtcLockSender] RSK destination address: {}\", btcLockSender.getRskAddress());\n+        logger.info(\"[parseFromBtcLockSender] BTC refund address: {}\", btcLockSender.getBTCAddress().toBase58());\n+    }\n+\n+    private void parseFromPeginInstructions(PeginInstructions peginInstructions)  throws PeginInstructionsException {\n+        this.protocolVersion = peginInstructions.getProtocolVersion();\n+        this.rskDestinationAddress = peginInstructions.getRskDestinationAddress();\n+        logger.info(\"[parseFromPeginInstructions] Protocol version: {}\", peginInstructions.getProtocolVersion());\n+        logger.info(\"[parseFromPeginInstructions] RSK destination address: {}\", peginInstructions.getRskDestinationAddress());\n+\n+        switch (protocolVersion) {\n+            case 1:\n+                PeginInstructionsVersion1 peginInstructionsV1 = (PeginInstructionsVersion1) peginInstructions;\n+                Optional<Address> btcRefundAddressOptional = peginInstructionsV1\n+                    .getBtcRefundAddress();\n+                if (btcRefundAddressOptional.isPresent()) {\n+                    this.btcRefundAddress = btcRefundAddressOptional.get();\n+                    logger.info(\"[parseFromPeginInstructions] BTC refund address: {}\", btcRefundAddressOptional.get().toBase58());\n+                }\n+                break;\n+            default:\n+                String message = String.format(\"Invalid protocol version: %d\", protocolVersion);\n+                logger.error(\"[parseFromPeginInstructions] {}\", message);", "originalCommit": "9b07ce07a850ffb4fc558ac7d527108f75029fcd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5248667b3968da142b342958e1fb24fb8bf5a05e", "url": "https://github.com/rsksmart/rskj/commit/5248667b3968da142b342958e1fb24fb8bf5a05e", "message": "Create PeginInformation class\n\nThis class is responsible for parsing a btc lock tx and obtaining the rsk address to where the funds should be transferred, and a BTC refund address in case the lock can not be completed. This information is obtained from peg-in instructions included in an output with OP_RETURN in the tx, or from the tx sender using BtcLockSender class.", "committedDate": "2020-09-29T21:41:48Z", "type": "forcePushed"}, {"oid": "7a229a19e0c1020c47393766cd1eb219d6e44ad3", "url": "https://github.com/rsksmart/rskj/commit/7a229a19e0c1020c47393766cd1eb219d6e44ad3", "message": "Create PeginInformation class\n\nThis class is responsible for parsing a btc lock tx and obtaining the rsk address to where the funds should be transferred, and a BTC refund address in case the lock can not be completed. This information is obtained from peg-in instructions included in an output with OP_RETURN in the tx, or from the tx sender using BtcLockSender class.", "committedDate": "2020-09-30T13:15:14Z", "type": "commit"}, {"oid": "7a229a19e0c1020c47393766cd1eb219d6e44ad3", "url": "https://github.com/rsksmart/rskj/commit/7a229a19e0c1020c47393766cd1eb219d6e44ad3", "message": "Create PeginInformation class\n\nThis class is responsible for parsing a btc lock tx and obtaining the rsk address to where the funds should be transferred, and a BTC refund address in case the lock can not be completed. This information is obtained from peg-in instructions included in an output with OP_RETURN in the tx, or from the tx sender using BtcLockSender class.", "committedDate": "2020-09-30T13:15:14Z", "type": "forcePushed"}]}