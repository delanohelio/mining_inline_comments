{"pr_number": 1270, "pr_title": "Fix race condition around newPeers in ChannelManagerImpl", "pr_createdAt": "2020-07-08T19:03:34Z", "pr_url": "https://github.com/rsksmart/rskj/pull/1270", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTEwOTgyMg==", "url": "https://github.com/rsksmart/rskj/pull/1270#discussion_r455109822", "bodyText": "could we log both cases? \"new\" and \"active\"?", "author": "patogallaiovlabs", "createdAt": "2020-07-15T14:47:35Z", "path": "rskj-core/src/main/java/org/ethereum/net/server/ChannelManagerImpl.java", "diffHunk": "@@ -288,12 +290,14 @@ public void add(Channel peer) {\n     public void notifyDisconnect(Channel channel) {\n         logger.debug(\"Peer {}: notifies about disconnect\", channel.getPeerIdShort());\n         channel.onDisconnect();\n-        syncPool.onDisconnect(channel);\n-        synchronized (activePeersLock){\n-            activePeers.values().remove(channel);\n-        }\n-        if(newPeers.remove(channel)) {\n-            logger.info(\"Peer removed from active peers: {}\", channel.getPeerId());\n+        synchronized (newPeers) {\n+            if(newPeers.remove(channel)) {\n+                logger.info(\"Peer removed from active peers: {}\", channel.getPeerId());", "originalCommit": "be644bb9d2a883fcf978ef090454b92ab5f798f2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI1NjcwOQ==", "url": "https://github.com/rsksmart/rskj/pull/1270#discussion_r455256709", "bodyText": "Why not add synchronization to add(Channel peer)?", "author": "ajlopezrsk", "createdAt": "2020-07-15T18:28:34Z", "path": "rskj-core/src/main/java/org/ethereum/net/server/ChannelManagerImpl.java", "diffHunk": "@@ -288,12 +290,14 @@ public void add(Channel peer) {\n     public void notifyDisconnect(Channel channel) {\n         logger.debug(\"Peer {}: notifies about disconnect\", channel.getPeerIdShort());\n         channel.onDisconnect();\n-        syncPool.onDisconnect(channel);\n-        synchronized (activePeersLock){\n-            activePeers.values().remove(channel);\n-        }\n-        if(newPeers.remove(channel)) {\n-            logger.info(\"Peer removed from active peers: {}\", channel.getPeerId());\n+        synchronized (newPeers) {", "originalCommit": "be644bb9d2a883fcf978ef090454b92ab5f798f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTMyMjAxNg==", "url": "https://github.com/rsksmart/rskj/pull/1270#discussion_r455322016", "bodyText": "It wouldn't make a difference. The newPeers array itself is thread safe. EthereumChannelInitializer both calls this add method and registers the listener that will call notifyDisconnect, and it does the add first, so there is no possible race condition there.\nSee https://github.com/rsksmart/rskj/blob/master/rskj-core/src/main/java/org/ethereum/net/server/EthereumChannelInitializer.java#L119", "author": "nicops", "createdAt": "2020-07-15T20:27:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI1NjcwOQ=="}], "type": "inlineReview"}, {"oid": "979bc70e9e2b08364728c0adae4ad2510d190b46", "url": "https://github.com/rsksmart/rskj/commit/979bc70e9e2b08364728c0adae4ad2510d190b46", "message": "Removed extra tracing logging in MessageQueue", "committedDate": "2020-07-15T18:34:48Z", "type": "forcePushed"}, {"oid": "6de4214ec123d3e9981c474eee0738396dfd7773", "url": "https://github.com/rsksmart/rskj/commit/6de4214ec123d3e9981c474eee0738396dfd7773", "message": "Fix race condition around newPeers in ChannelManagerImpl, plus extra logs in MessageQueue", "committedDate": "2020-07-28T18:50:50Z", "type": "commit"}, {"oid": "14929adebeaf9b97dcb4b82dcf0a835e25a19b84", "url": "https://github.com/rsksmart/rskj/commit/14929adebeaf9b97dcb4b82dcf0a835e25a19b84", "message": "better logging in ChannelManagerImpl", "committedDate": "2020-07-28T18:50:50Z", "type": "commit"}, {"oid": "19adfbc7b5404c5cb5bb37307ecd67308b4d9ae8", "url": "https://github.com/rsksmart/rskj/commit/19adfbc7b5404c5cb5bb37307ecd67308b4d9ae8", "message": "Removed extra tracing logging in MessageQueue", "committedDate": "2020-07-28T18:50:50Z", "type": "commit"}, {"oid": "19adfbc7b5404c5cb5bb37307ecd67308b4d9ae8", "url": "https://github.com/rsksmart/rskj/commit/19adfbc7b5404c5cb5bb37307ecd67308b4d9ae8", "message": "Removed extra tracing logging in MessageQueue", "committedDate": "2020-07-28T18:50:50Z", "type": "forcePushed"}]}