{"pr_number": 161, "pr_title": "Add multiple DB credentials and roles/cloudsql.client for the GKE SAs", "pr_createdAt": "2020-04-16T19:49:13Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/161", "timeline": [{"oid": "454d8c616b2caa3bca3cb7f066e4f92cd981156e", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/454d8c616b2caa3bca3cb7f066e4f92cd981156e", "message": "Add multiple GKE service accounts and DB creds\n\nIn support of using different credentials for each GKE app.", "committedDate": "2020-04-16T19:47:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwOTMxMQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/161#discussion_r409809311", "bodyText": "nit: do we need the -sa suffix?", "author": "umairidris", "createdAt": "2020-04-16T19:50:30Z", "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-apps/apps/main.tf", "diffHunk": "@@ -31,3 +31,22 @@ module \"heroes_hat_cluster\" {\n   # Need to either disable private endpoint, or enable master auth networks.\n   enable_private_endpoint = false\n }\n+\n+# Create a separate service account for each app.\n+locals {\n+  apps = [\n+    \"auth-server\",\n+    \"response-server\",\n+    \"study-designer\",\n+    \"study-meta-data\",\n+    \"user-registration\",\n+  ]\n+}\n+\n+resource \"google_service_account\" \"apps_service_accounts\" {\n+  for_each = toset(local.apps)\n+\n+  account_id  = \"${each.key}-gke-sa\"", "originalCommit": "454d8c616b2caa3bca3cb7f066e4f92cd981156e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgyMDYxNQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/161#discussion_r409820615", "bodyText": "I guess not.", "author": "MartinPetkov", "createdAt": "2020-04-16T20:12:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwOTMxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgxMjUyMw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/161#discussion_r409812523", "bodyText": "can we move this to a new file secrets.tf or something?", "author": "umairidris", "createdAt": "2020-04-16T19:56:37Z", "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-data/data/main.tf", "diffHunk": "@@ -68,3 +68,70 @@ module \"my_studies_cloudsql\" {\n     verify_server_certificate = null\n   }\n }\n+\n+# Create a separate user for each app, generate a password, and store in secrets\n+locals {", "originalCommit": "454d8c616b2caa3bca3cb7f066e4f92cd981156e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgxNjM1MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/161#discussion_r409816351", "bodyText": "add new line", "author": "umairidris", "createdAt": "2020-04-16T20:03:45Z", "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-data/data/main.tf", "diffHunk": "@@ -68,3 +68,70 @@ module \"my_studies_cloudsql\" {\n     verify_server_certificate = null\n   }\n }\n+\n+# Create a separate user for each app, generate a password, and store in secrets\n+locals {\n+  apps = [\n+    \"auth-server\",\n+    \"response-server\",\n+    \"study-designer\",\n+    \"study-meta-data\",\n+    \"user-registration\",\n+  ]\n+}\n+resource \"random_password\" \"db_passwords\" {\n+  for_each = toset(local.apps)\n+\n+  length  = 16\n+  special = true\n+}\n+resource \"google_sql_user\" \"db_users\" {\n+  for_each = toset(local.apps)\n+\n+  name     = \"${each.key}-db-user\"\n+  instance = module.my_studies_cloudsql.instance_name\n+  host     = \"%\"\n+  password = random_password.db_passwords[each.key].result\n+}\n+\n+resource \"google_secret_manager_secret\" \"db_passwords_secrets\" {\n+  provider = google-beta\n+\n+  for_each = toset(local.apps)\n+\n+  secret_id = \"${each.key}-db-password\"\n+  project   = var.project_id\n+\n+  replication {\n+    automatic = true\n+  }\n+}\n+resource \"google_secret_manager_secret\" \"db_users_secrets\" {\n+  provider = google-beta\n+\n+  for_each = toset(local.apps)\n+\n+  secret_id = \"${each.key}-db-user\"\n+  project   = var.project_id\n+\n+  replication {\n+    automatic = true\n+  }\n+}\n+\n+resource \"google_secret_manager_secret_version\" \"db_passwords_secrets_values\" {\n+  provider = google-beta\n+\n+  for_each = toset(local.apps)\n+\n+  secret      = google_secret_manager_secret.db_passwords_secrets[each.key].id\n+  secret_data = random_password.db_passwords[each.key].result\n+}", "originalCommit": "454d8c616b2caa3bca3cb7f066e4f92cd981156e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgyMjgyMw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/161#discussion_r409822823", "bodyText": "Done.", "author": "MartinPetkov", "createdAt": "2020-04-16T20:16:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgxNjM1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgxNjk4Mg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/161#discussion_r409816982", "bodyText": "we shouldn't output password as it will show up when someone runs terraform apply", "author": "umairidris", "createdAt": "2020-04-16T20:05:06Z", "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-data/data/outputs.tf", "diffHunk": "@@ -0,0 +1,12 @@\n+output \"instance_name\" {\n+  value = module.my_studies_cloudsql.instance_name\n+}\n+\n+# This is not outputted by the safer_sql module, but allow dependents to treat\n+# it like it is.\n+output \"instance_user\" {\n+  value = \"default\"\n+}\n+output \"instance_user_password\" {", "originalCommit": "454d8c616b2caa3bca3cb7f066e4f92cd981156e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgyMzMwMw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/161#discussion_r409823303", "bodyText": "Done.", "author": "MartinPetkov", "createdAt": "2020-04-16T20:17:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgxNjk4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgxNzI2Mg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/161#discussion_r409817262", "bodyText": "maybe fill in with a dummy value?", "author": "umairidris", "createdAt": "2020-04-16T20:05:43Z", "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-data/iam/terragrunt.hcl", "diffHunk": "@@ -11,7 +11,8 @@ dependency \"apps\" {\n   config_path = \"../../project.heroes-hat-dev-apps/apps\"\n \n   mock_outputs = {\n-    service_account = \"mock-gke-service-account\"\n+    service_account       = \"mock-gke-service-account\"\n+    apps_service_accounts = {}", "originalCommit": "454d8c616b2caa3bca3cb7f066e4f92cd981156e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgyMzkwNw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/161#discussion_r409823907", "bodyText": "Done.", "author": "MartinPetkov", "createdAt": "2020-04-16T20:18:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgxNzI2Mg=="}], "type": "inlineReview"}, {"oid": "d4ed3680bd64ecb237c45d652cfde0bda722a7b0", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/d4ed3680bd64ecb237c45d652cfde0bda722a7b0", "message": "Address comments", "committedDate": "2020-04-16T20:21:00Z", "type": "commit"}, {"oid": "29d512d1962cb986db576974788181ca8fb09e4f", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/29d512d1962cb986db576974788181ca8fb09e4f", "message": "Merge branch 'terraform' into add-multiple-gke-sas-and-db-creds", "committedDate": "2020-04-17T13:35:52Z", "type": "commit"}, {"oid": "493f634fd157d22c8d0de8938d55d55db3c7770a", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/493f634fd157d22c8d0de8938d55d55db3c7770a", "message": "Move GKE SAs out, they're a separate PR now\n\nPR: https://github.com/GoogleCloudPlatform/fda-mystudies/pull/168", "committedDate": "2020-04-17T13:52:26Z", "type": "commit"}, {"oid": "e8756b20e38ecf6ac2c91c01d632f6e48a736bdd", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e8756b20e38ecf6ac2c91c01d632f6e48a736bdd", "message": "Merge branch 'terraform' into add-multiple-gke-sas-and-db-creds", "committedDate": "2020-04-17T14:45:01Z", "type": "commit"}]}