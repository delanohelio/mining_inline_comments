{"pr_number": 680, "pr_title": "Participant manager [PUT] /users/{superAdminUserId}/ endpoint implementation", "pr_createdAt": "2020-07-25T11:50:05Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/680", "timeline": [{"oid": "5a1e04b88828f56b21c78b99dbd18af82e248664", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/5a1e04b88828f56b21c78b99dbd18af82e248664", "message": "[PUT] /users/{superAdminUserId}/ endpoint implementation", "committedDate": "2020-07-25T11:16:17Z", "type": "commit"}, {"oid": "126eb218ea6c413a8a736b324419907a20c8c23f", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/126eb218ea6c413a8a736b324419907a20c8c23f", "message": "integration test cases added for update user api", "committedDate": "2020-07-25T11:47:16Z", "type": "commit"}, {"oid": "859fdeec1615a8cff06d8439e28cb22fe7639059", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/859fdeec1615a8cff06d8439e28cb22fe7639059", "message": "Merge branch 'participant-manager-add-new-user-integration-test-cases' into participant-manager-update-user-api-implementation", "committedDate": "2020-07-25T11:51:56Z", "type": "commit"}, {"oid": "e0ba4b3cea0a06e6e9e6831dbcf4a60d72ac6c35", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e0ba4b3cea0a06e6e9e6831dbcf4a60d72ac6c35", "message": "Merge branch 'participant-manager-add-new-user-integration-test-cases' into participant-manager-update-user-api-implementation\n\n# Conflicts:\n#\tparticipant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/UserControllerTest.java", "committedDate": "2020-07-25T12:05:20Z", "type": "commit"}, {"oid": "b7ce5c6fdf6516dbc6028e915eed6c281fa88f7e", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/b7ce5c6fdf6516dbc6028e915eed6c281fa88f7e", "message": "Merge branch 'participant-manager-update-user-api-implementation' of https://github.com/GoogleCloudPlatform/fda-mystudies into participant-manager-update-user-api-implementation\n\n# Conflicts:\n#\tparticipant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/UserControllerTest.java", "committedDate": "2020-07-25T12:07:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcwNTcwNw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/680#discussion_r462705707", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (!optAdminDeatils.isPresent()) {\n          \n          \n            \n                if (!optAdminDetails.isPresent()) {", "author": "saminguyen", "createdAt": "2020-07-30T03:00:41Z", "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/ManageUserServiceImpl.java", "diffHunk": "@@ -320,4 +320,125 @@ private AdminUserResponse saveSuperAdminDetails(UserRequest user) {\n     logger.exit(String.format(\"total app permissions=%d\", appPermissions.size()));\n     return appPermissions;\n   }\n+\n+  @Override\n+  @Transactional\n+  public AdminUserResponse updateUser(UserRequest user, String superAdminUserId) {\n+    logger.entry(String.format(\"updateUser() with isSuperAdmin=%b\", user.isSuperAdmin()));\n+    ErrorCode errorCode = validateUpdateUserRequest(user, superAdminUserId);\n+    if (errorCode != null) {\n+      logger.exit(String.format(CommonConstants.ERROR_CODE_LOG, errorCode));\n+      return new AdminUserResponse(errorCode);\n+    }\n+\n+    AdminUserResponse userResponse =\n+        user.isSuperAdmin()\n+            ? updateSuperAdminDetails(user, superAdminUserId)\n+            : updateAdminDetails(user, superAdminUserId);\n+\n+    logger.exit(String.format(CommonConstants.STATUS_LOG, userResponse.getHttpStatusCode()));\n+    return userResponse;\n+  }\n+\n+  private ErrorCode validateUpdateUserRequest(UserRequest user, String superAdminUserId) {\n+    logger.entry(\"validateUpdateUserRequest()\");\n+    Optional<UserRegAdminEntity> optAdminDetails = userAdminRepository.findById(superAdminUserId);\n+    if (!optAdminDetails.isPresent() || user.getUserId() == null) {\n+      return ErrorCode.USER_NOT_FOUND;\n+    }\n+\n+    UserRegAdminEntity loggedInUserDeatils = optAdminDetails.get();\n+    if (!loggedInUserDeatils.isSuperAdmin()) {\n+      return ErrorCode.NOT_SUPER_ADMIN_ACCESS;\n+    }\n+\n+    if (!user.isSuperAdmin() && !hasAtleastOnePermission(user)) {\n+      return ErrorCode.PERMISSION_MISSING;\n+    }\n+    logger.exit(\"Successfully validated user request\");\n+    return null;\n+  }\n+\n+  private AdminUserResponse updateSuperAdminDetails(UserRequest user, String superAdminUserId) {\n+    logger.entry(\"updateSuperAdminDetails()\");\n+    Optional<UserRegAdminEntity> optAdminDeatils = userAdminRepository.findById(user.getUserId());\n+\n+    if (!optAdminDeatils.isPresent()) {", "originalCommit": "b7ce5c6fdf6516dbc6028e915eed6c281fa88f7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA2ODcyMw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/680#discussion_r463068723", "bodyText": "typo fixed", "author": "chiranjibi009", "createdAt": "2020-07-30T15:10:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcwNTcwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcwOTgwOQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/680#discussion_r462709809", "bodyText": "saveAndFlush?", "author": "saminguyen", "createdAt": "2020-07-30T03:16:34Z", "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/ManageUserServiceImpl.java", "diffHunk": "@@ -320,4 +320,125 @@ private AdminUserResponse saveSuperAdminDetails(UserRequest user) {\n     logger.exit(String.format(\"total app permissions=%d\", appPermissions.size()));\n     return appPermissions;\n   }\n+\n+  @Override\n+  @Transactional\n+  public AdminUserResponse updateUser(UserRequest user, String superAdminUserId) {\n+    logger.entry(String.format(\"updateUser() with isSuperAdmin=%b\", user.isSuperAdmin()));\n+    ErrorCode errorCode = validateUpdateUserRequest(user, superAdminUserId);\n+    if (errorCode != null) {\n+      logger.exit(String.format(CommonConstants.ERROR_CODE_LOG, errorCode));\n+      return new AdminUserResponse(errorCode);\n+    }\n+\n+    AdminUserResponse userResponse =\n+        user.isSuperAdmin()\n+            ? updateSuperAdminDetails(user, superAdminUserId)\n+            : updateAdminDetails(user, superAdminUserId);\n+\n+    logger.exit(String.format(CommonConstants.STATUS_LOG, userResponse.getHttpStatusCode()));\n+    return userResponse;\n+  }\n+\n+  private ErrorCode validateUpdateUserRequest(UserRequest user, String superAdminUserId) {\n+    logger.entry(\"validateUpdateUserRequest()\");\n+    Optional<UserRegAdminEntity> optAdminDetails = userAdminRepository.findById(superAdminUserId);\n+    if (!optAdminDetails.isPresent() || user.getUserId() == null) {\n+      return ErrorCode.USER_NOT_FOUND;\n+    }\n+\n+    UserRegAdminEntity loggedInUserDeatils = optAdminDetails.get();\n+    if (!loggedInUserDeatils.isSuperAdmin()) {\n+      return ErrorCode.NOT_SUPER_ADMIN_ACCESS;\n+    }\n+\n+    if (!user.isSuperAdmin() && !hasAtleastOnePermission(user)) {\n+      return ErrorCode.PERMISSION_MISSING;\n+    }\n+    logger.exit(\"Successfully validated user request\");\n+    return null;\n+  }\n+\n+  private AdminUserResponse updateSuperAdminDetails(UserRequest user, String superAdminUserId) {\n+    logger.entry(\"updateSuperAdminDetails()\");\n+    Optional<UserRegAdminEntity> optAdminDeatils = userAdminRepository.findById(user.getUserId());\n+\n+    if (!optAdminDeatils.isPresent()) {\n+      return new AdminUserResponse(ErrorCode.USER_NOT_FOUND);\n+    }\n+\n+    UserRegAdminEntity adminDetails = optAdminDeatils.get();\n+    adminDetails = UserMapper.fromUpdateUserRequest(user, adminDetails);\n+\n+    deleteAllPermissions(user.getUserId());\n+\n+    user.setSuperAdminUserId(superAdminUserId);\n+\n+    List<AppPermissionEntity> appPermissions = getAppPermissisonsForSuperAdmin(user, adminDetails);\n+    adminDetails.getAppPermissions().addAll(appPermissions);\n+\n+    List<StudyPermissionEntity> studyPermissions =\n+        getStudyPermissisonsForSuperAdmin(user, adminDetails);\n+    adminDetails.getStudyPermissions().addAll(studyPermissions);\n+\n+    List<SitePermissionEntity> sitePermissions =\n+        getSitePermissisonsForSuperAdmin(user, adminDetails);\n+    adminDetails.getSitePermissions().addAll(sitePermissions);\n+\n+    userAdminRepository.save(adminDetails);\n+\n+    logger.exit(String.format(CommonConstants.MESSAGE_CODE_LOG, MessageCode.UPDATE_USER_SUCCESS));\n+    return new AdminUserResponse(MessageCode.UPDATE_USER_SUCCESS, adminDetails.getId());\n+  }\n+\n+  private AdminUserResponse updateAdminDetails(UserRequest user, String superAdminUserId) {\n+    logger.entry(\"updateAdminDetails()\");\n+\n+    Optional<UserRegAdminEntity> optAdminDeatils = userAdminRepository.findById(user.getUserId());\n+\n+    if (!optAdminDeatils.isPresent()) {\n+      return new AdminUserResponse(ErrorCode.USER_NOT_FOUND);\n+    }\n+\n+    UserRegAdminEntity adminDetails = optAdminDeatils.get();\n+    adminDetails = UserMapper.fromUpdateUserRequest(user, adminDetails);\n+    userAdminRepository.save(adminDetails);", "originalCommit": "b7ce5c6fdf6516dbc6028e915eed6c281fa88f7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA2OTM1MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/680#discussion_r463069350", "bodyText": "save() replaced with saveAndFlush()", "author": "chiranjibi009", "createdAt": "2020-07-30T15:11:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcwOTgwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcxMDIxMA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/680#discussion_r462710210", "bodyText": "saveAndFlush instead?", "author": "saminguyen", "createdAt": "2020-07-30T03:18:17Z", "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/ManageUserServiceImpl.java", "diffHunk": "@@ -320,4 +320,125 @@ private AdminUserResponse saveSuperAdminDetails(UserRequest user) {\n     logger.exit(String.format(\"total app permissions=%d\", appPermissions.size()));\n     return appPermissions;\n   }\n+\n+  @Override\n+  @Transactional\n+  public AdminUserResponse updateUser(UserRequest user, String superAdminUserId) {\n+    logger.entry(String.format(\"updateUser() with isSuperAdmin=%b\", user.isSuperAdmin()));\n+    ErrorCode errorCode = validateUpdateUserRequest(user, superAdminUserId);\n+    if (errorCode != null) {\n+      logger.exit(String.format(CommonConstants.ERROR_CODE_LOG, errorCode));\n+      return new AdminUserResponse(errorCode);\n+    }\n+\n+    AdminUserResponse userResponse =\n+        user.isSuperAdmin()\n+            ? updateSuperAdminDetails(user, superAdminUserId)\n+            : updateAdminDetails(user, superAdminUserId);\n+\n+    logger.exit(String.format(CommonConstants.STATUS_LOG, userResponse.getHttpStatusCode()));\n+    return userResponse;\n+  }\n+\n+  private ErrorCode validateUpdateUserRequest(UserRequest user, String superAdminUserId) {\n+    logger.entry(\"validateUpdateUserRequest()\");\n+    Optional<UserRegAdminEntity> optAdminDetails = userAdminRepository.findById(superAdminUserId);\n+    if (!optAdminDetails.isPresent() || user.getUserId() == null) {\n+      return ErrorCode.USER_NOT_FOUND;\n+    }\n+\n+    UserRegAdminEntity loggedInUserDeatils = optAdminDetails.get();\n+    if (!loggedInUserDeatils.isSuperAdmin()) {\n+      return ErrorCode.NOT_SUPER_ADMIN_ACCESS;\n+    }\n+\n+    if (!user.isSuperAdmin() && !hasAtleastOnePermission(user)) {\n+      return ErrorCode.PERMISSION_MISSING;\n+    }\n+    logger.exit(\"Successfully validated user request\");\n+    return null;\n+  }\n+\n+  private AdminUserResponse updateSuperAdminDetails(UserRequest user, String superAdminUserId) {\n+    logger.entry(\"updateSuperAdminDetails()\");\n+    Optional<UserRegAdminEntity> optAdminDeatils = userAdminRepository.findById(user.getUserId());\n+\n+    if (!optAdminDeatils.isPresent()) {\n+      return new AdminUserResponse(ErrorCode.USER_NOT_FOUND);\n+    }\n+\n+    UserRegAdminEntity adminDetails = optAdminDeatils.get();\n+    adminDetails = UserMapper.fromUpdateUserRequest(user, adminDetails);\n+\n+    deleteAllPermissions(user.getUserId());\n+\n+    user.setSuperAdminUserId(superAdminUserId);\n+\n+    List<AppPermissionEntity> appPermissions = getAppPermissisonsForSuperAdmin(user, adminDetails);\n+    adminDetails.getAppPermissions().addAll(appPermissions);\n+\n+    List<StudyPermissionEntity> studyPermissions =\n+        getStudyPermissisonsForSuperAdmin(user, adminDetails);\n+    adminDetails.getStudyPermissions().addAll(studyPermissions);\n+\n+    List<SitePermissionEntity> sitePermissions =\n+        getSitePermissisonsForSuperAdmin(user, adminDetails);\n+    adminDetails.getSitePermissions().addAll(sitePermissions);\n+\n+    userAdminRepository.save(adminDetails);", "originalCommit": "b7ce5c6fdf6516dbc6028e915eed6c281fa88f7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA2OTUwMg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/680#discussion_r463069502", "bodyText": "save() replaced with saveAndFlush()", "author": "chiranjibi009", "createdAt": "2020-07-30T15:11:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcxMDIxMA=="}], "type": "inlineReview"}, {"oid": "ff671c12ff6a6f37b9fce8dd7aba663a05dfb10b", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/ff671c12ff6a6f37b9fce8dd7aba663a05dfb10b", "message": "Merge branch 'participant-manager-add-new-user-integration-test-cases' into participant-manager-update-user-api-implementation", "committedDate": "2020-07-30T14:41:12Z", "type": "commit"}, {"oid": "d35333b1db378ea51c9fa19de311df0f89a252bf", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/d35333b1db378ea51c9fa19de311df0f89a252bf", "message": "commented PR fixed", "committedDate": "2020-07-30T15:07:21Z", "type": "commit"}, {"oid": "10bd3d1a79714a78e7337557644186e345cc87b3", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/10bd3d1a79714a78e7337557644186e345cc87b3", "message": "Merge branch 'participant-manager-add-new-user-integration-test-cases' into participant-manager-update-user-api-implementation", "committedDate": "2020-07-31T07:06:20Z", "type": "commit"}, {"oid": "a0e8d3af1623d134b24efb6a3a6ab076ea4f8665", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/a0e8d3af1623d134b24efb6a3a6ab076ea4f8665", "message": "Merge branch 'develop' into participant-manager-update-user-api-implementation", "committedDate": "2020-08-18T14:42:13Z", "type": "commit"}, {"oid": "a4159a1cfa7b731a20bd01dd21ba339edb2113e0", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/a4159a1cfa7b731a20bd01dd21ba339edb2113e0", "message": "Merge branch 'develop' of https://github.com/GoogleCloudPlatform/fda-mystudies into participant-manager-update-user-api-implementation\n\n# Conflicts:\n#\tcommon-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/MessageCode.java\n#\tparticipant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/common/TestConstants.java", "committedDate": "2020-08-18T14:56:46Z", "type": "commit"}, {"oid": "a4f394cddc7624d3ac6b2062d05427f347f7932e", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/a4f394cddc7624d3ac6b2062d05427f347f7932e", "message": "Merge branch 'participant-manager-update-user-api-implementation' of https://github.com/GoogleCloudPlatform/fda-mystudies into participant-manager-update-user-api-implementation\n\n# Conflicts:\n#\tcommon-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/MessageCode.java\n#\tparticipant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/common/TestConstants.java", "committedDate": "2020-08-18T14:59:39Z", "type": "commit"}, {"oid": "d0899c49a404d790461135dd189ec0b0ccb90019", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/d0899c49a404d790461135dd189ec0b0ccb90019", "message": "Merge branch 'develop' into participant-manager-update-user-api-implementation", "committedDate": "2020-08-18T15:03:09Z", "type": "commit"}]}