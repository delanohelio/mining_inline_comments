{"pr_number": 335, "pr_title": "Add firestore data export destinations.", "pr_createdAt": "2020-05-04T20:22:42Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/335", "timeline": [{"oid": "ef563d1298cd0d96ad9984c429021bb0d72b5992", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/ef563d1298cd0d96ad9984c429021bb0d72b5992", "message": "Add firestore data export destinations.", "committedDate": "2020-05-04T20:22:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcwNTIyNg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/335#discussion_r419705226", "bodyText": "@kuoyuchi let me know what specs I should set on these two data storage destination, such as IAM, expiration time, etc.", "author": "xingao267", "createdAt": "2020-05-04T20:23:50Z", "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-data/data/main.tf", "diffHunk": "@@ -90,3 +90,22 @@ module \"my_studies_cloudsql\" {\n     start_time         = \"20:55\"\n   }\n }\n+\n+# Firestore data export\n+module \"my_studies_firestore_data_bucket\" {", "originalCommit": "ef563d1298cd0d96ad9984c429021bb0d72b5992", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcxMTIyMw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/335#discussion_r419711223", "bodyText": "re: destination. SGTM to keep everything regional in the same region (i.e. us-east1).\nre: IAM. @Olamon can you comment on this?\nre: expiration time. The Cloud Storage bucket is meant to be a temporary export, so we shouldn't keep it for too long. Given that the pipeline runs daily, TTL=7d should be more than enough.", "author": "kuoyuchi", "createdAt": "2020-05-04T20:34:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcwNTIyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTczOTY1NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/335#discussion_r419739654", "bodyText": "Added TTL. The permissions can be configured by followup PRs.", "author": "xingao267", "createdAt": "2020-05-04T21:28:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcwNTIyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTIxMTcyMg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/335#discussion_r421211722", "bodyText": "Thanks Xin. I followed up with Ola. This is read and written by firebase functions, which by default uses this service account:\n{project-id}@appspot.gserviceaccount.com\nBut this is also something we can change on cloud function console. We have 3 cloud functions, and makes sense to go down the path of each running as a different service account.", "author": "kuoyuchi", "createdAt": "2020-05-07T03:04:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcwNTIyNg=="}], "type": "inlineReview"}, {"oid": "3408ce2500a77201b044c302ca05df18794f84d7", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/3408ce2500a77201b044c302ca05df18794f84d7", "message": "format", "committedDate": "2020-05-04T20:25:52Z", "type": "commit"}, {"oid": "2a976ab81d852252bb6cdaff0d2eee2990a3f876", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/2a976ab81d852252bb6cdaff0d2eee2990a3f876", "message": "Merge branch 'early-access' into data", "committedDate": "2020-05-04T21:04:11Z", "type": "commit"}, {"oid": "ddf7a4193db3fd597b5089b6bfb5235856cb7cfb", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/ddf7a4193db3fd597b5089b6bfb5235856cb7cfb", "message": "Add TTL", "committedDate": "2020-05-04T21:23:46Z", "type": "commit"}, {"oid": "31aed40c3479b4b89ed49e30392743b7ccc77f11", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/31aed40c3479b4b89ed49e30392743b7ccc77f11", "message": "format", "committedDate": "2020-05-04T21:38:40Z", "type": "commit"}, {"oid": "96861d5ae34ae73376d9f07ad77cfc6bc702d3e2", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/96861d5ae34ae73376d9f07ad77cfc6bc702d3e2", "message": "Merge branch 'early-access' into data", "committedDate": "2020-05-04T21:49:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc2MzE2OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/335#discussion_r419763169", "bodyText": "Sorry I wasn't clear about this. @Olamon to confirm but the bigquery data should contain no PII and it's for aggregated dashboards. I expect this to be retained for longer.", "author": "kuoyuchi", "createdAt": "2020-05-04T22:20:18Z", "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-data/data/main.tf", "diffHunk": "@@ -90,3 +90,35 @@ module \"my_studies_cloudsql\" {\n     start_time         = \"20:55\"\n   }\n }\n+\n+# Firestore data export\n+module \"my_studies_firestore_data_bucket\" {\n+  source  = \"terraform-google-modules/cloud-storage/google//modules/simple_bucket\"\n+  version = \"~> 1.4\"\n+\n+  name       = \"heroes-hat-dev-my-studies-firestore-data\"\n+  project_id = var.project_id\n+  location   = var.storage_location\n+\n+  # TTL 7 days.\n+  lifecycle_rules = [{\n+    action = {\n+      type = \"Delete\"\n+    }\n+    condition = {\n+      age        = 7 # 7 days\n+      with_state = \"ANY\"\n+    }\n+  }]\n+\n+}\n+\n+module \"my_studies_firestore_data_bigquery\" {\n+  source  = \"terraform-google-modules/bigquery/google\"\n+  version = \"~> 4.1.0\"\n+\n+  dataset_id                  = \"heroes_hat_dev_my_studies_firestore_data\"\n+  project_id                  = var.project_id\n+  location                    = var.storage_location\n+  default_table_expiration_ms = 7 * 8.64 * pow(10, 7) # 7 days", "originalCommit": "96861d5ae34ae73376d9f07ad77cfc6bc702d3e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc3NTAxMA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/335#discussion_r419775010", "bodyText": "removed the ttl for now. If there is a specific requirement on the ttl, we can add later", "author": "xingao267", "createdAt": "2020-05-04T22:52:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc2MzE2OQ=="}], "type": "inlineReview"}, {"oid": "ab2499d431d6dc777573b1fc68e834b77082ea79", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/ab2499d431d6dc777573b1fc68e834b77082ea79", "message": "remove ttl on bigquery", "committedDate": "2020-05-04T22:50:53Z", "type": "commit"}, {"oid": "5503a55d947a3773e2411aebebd956b50e6121af", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/5503a55d947a3773e2411aebebd956b50e6121af", "message": "Add subscription.", "committedDate": "2020-05-04T23:00:18Z", "type": "commit"}, {"oid": "868cb1c0d0272988d129124e9fc7235cafe1b158", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/868cb1c0d0272988d129124e9fc7235cafe1b158", "message": "Merge branch 'early-access' into data", "committedDate": "2020-05-04T23:00:54Z", "type": "commit"}, {"oid": "52274490f46b341eac3d1a5d582885857829af95", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/52274490f46b341eac3d1a5d582885857829af95", "message": "Merge branch 'early-access' into data", "committedDate": "2020-05-06T17:58:51Z", "type": "commit"}, {"oid": "274ada639ed9828501aaf373877e9dba38c8e86b", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/274ada639ed9828501aaf373877e9dba38c8e86b", "message": "Merge branch 'early-access' into data", "committedDate": "2020-05-07T14:29:25Z", "type": "commit"}]}