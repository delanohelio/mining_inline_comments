{"pr_number": 1080, "pr_title": "Hydra deployment", "pr_createdAt": "2020-09-29T17:26:05Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1080", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODIwNTQ4Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1080#discussion_r498205487", "bodyText": "CORS env variables can be removed. We are not calling Hydra API's from browser using Javascript/Typescript code.", "author": "dhanyak-btc", "createdAt": "2020-10-01T12:29:47Z", "path": "hydra/entrypoint.bash", "diffHunk": "@@ -0,0 +1,55 @@\n+#!/bin/bash\n+\n+# Copyright 2020 Google LLC\n+#\n+# Licensed under the Apache License, Version 2.0 (the \"License\");\n+# you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+#      http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+# Require ENVs:\n+# - BASE_URL: the base URL of your deployment.\n+# - DSN: format: \"mysql://${DB_USER?}:${DB_PASSWORD?}@tcp(${DB_PRIVATE_IP}:${DB_PORT})/${DB_NAME?}?sslmode=disable\"\n+\n+# Encryption support in database\n+# The system secret can only be set against a fresh database. Key rotation is currently not supported. This\n+# secret is used to encrypt the database and needs to be set to the same value every time the process (re-)starts.\n+# You can use /dev/urandom to generate a secret. But make sure that the secret must be the same anytime you define it.\n+# You could, for example, store the value somewhere.\n+export SECRETS_SYSTEM=${SECRETS_SYSTEM}\n+\n+# Points to database location\n+# mysql://user:pw@tcp(host:port)/database?someSetting=value&foo=bar\n+export DSN=mysql://${DB_USER}:${DB_PASS}@tcp(localhost:3306)/${DB_NAME}?sql_notes=false\n+\n+# CORS for public", "originalCommit": "11fe4e217463ea1ddd4c46acead5812ac8707733", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMxMjg3Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1080#discussion_r498312876", "bodyText": "updated. thanks", "author": "zohrehj", "createdAt": "2020-10-01T15:00:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODIwNTQ4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMyOTgyOA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1080#discussion_r498329828", "bodyText": "empty line at the end of file", "author": "xingao267", "createdAt": "2020-10-01T15:23:24Z", "path": "hydra/Dockerfile", "diffHunk": "@@ -0,0 +1,31 @@\n+# Copyright 2020 Google LLC\n+#\n+# Licensed under the Apache License, Version 2.0 (the \"License\");\n+# you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+#      http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+FROM golang:1.14.1-buster\n+\n+WORKDIR /\n+\n+ARG HYDRA_VERSION=v1.7.4\n+\n+# Install Hydra\n+RUN git clone https://github.com/ory/hydra.git && \\\n+    cd hydra && \\\n+    git checkout ${HYDRA_VERSION} && \\\n+    go build\n+\n+COPY hydra/entrypoint.bash /entrypoint.sh\n+\n+EXPOSE 4444 4445\n+\n+ENTRYPOINT [ \"/entrypoint.sh\" ]", "originalCommit": "120be7a428f0cd44ce5889048cf9c79d4978e865", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMyOTg4NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1080#discussion_r498329885", "bodyText": "empty line at the end of file", "author": "xingao267", "createdAt": "2020-10-01T15:23:30Z", "path": "hydra/cloudbuild.yaml", "diffHunk": "@@ -0,0 +1,22 @@\n+# Copyright 2020 Google LLC\n+#\n+# Licensed under the Apache License, Version 2.0 (the \"License\");\n+# you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+#      http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+# build the hydra-ic image for gke with cloudbuild:\n+# gcloud builds submit --config deploy/build-gke/hydra-ic/cloudbuild.yaml .\n+\n+steps:\n+- name: 'gcr.io/cloud-builders/docker'\n+  args: [ 'build', '-f', \"hydra/Dockerfile\", '-t', 'gcr.io/$PROJECT_ID/hydra', '.' ]\n+images:\n+- 'gcr.io/$PROJECT_ID/hydra'", "originalCommit": "120be7a428f0cd44ce5889048cf9c79d4978e865", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMzMDQyNA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1080#discussion_r498330424", "bodyText": "empty line at the end of file", "author": "xingao267", "createdAt": "2020-10-01T15:24:15Z", "path": "hydra/entrypoint.bash", "diffHunk": "@@ -0,0 +1,44 @@\n+#!/bin/bash\n+\n+# Copyright 2020 Google LLC\n+#\n+# Licensed under the Apache License, Version 2.0 (the \"License\");\n+# you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+#      http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+# Require ENVs:\n+# - BASE_URL: the base URL of your deployment.\n+# - DSN: format: \"mysql://${DB_USER?}:${DB_PASSWORD?}@tcp(${DB_PRIVATE_IP}:${DB_PORT})/${DB_NAME?}?sslmode=disable\"\n+\n+# Encryption support in database\n+# The system secret can only be set against a fresh database. Key rotation is currently not supported. This\n+# secret is used to encrypt the database and needs to be set to the same value every time the process (re-)starts.\n+# You can use /dev/urandom to generate a secret. But make sure that the secret must be the same anytime you define it.\n+# You could, for example, store the value somewhere.\n+export SECRETS_SYSTEM=${SECRETS_SYSTEM}\n+\n+# Points to database location\n+# mysql://user:pw@tcp(host:port)/database?someSetting=value&foo=bar\n+export DSN=mysql://${DB_USER}:${DB_PASS}@tcp(localhost:3306)/${DB_NAME}?sql_notes=false\n+\n+# issuer URL\n+export URLS_SELF_ISSUER=\"${BASE_URL}/hydra\"\n+# Login and consent app\n+export URLS_CONSENT=\"${BASE_URL}/oauth-scim-service/consent\"\n+export URLS_LOGIN=\"${BASE_URL}/oauth-scim-service/login\"\n+\n+# Setup database for hydra.\n+cd /hydra\n+./hydra migrate sql --yes $DSN\n+\n+# Start hydra\n+# use --dangerous-force-http because GCLB take care of https.\n+./hydra serve all --dangerous-force-http", "originalCommit": "120be7a428f0cd44ce5889048cf9c79d4978e865", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMzNTQ2Mg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1080#discussion_r498335462", "bodyText": "You should also add hydra_db_password to the random_password block at line 275 similar to the other ones.", "author": "xingao267", "createdAt": "2020-10-01T15:31:04Z", "path": "deployment.hcl", "diffHunk": "@@ -163,6 +163,18 @@ template \"project_secrets\" {\n           secret_id   = \"auto-auth-server-db-user\"\n           secret_data = \"$${random_string.strings[\\\"auth_server_db_user\\\"].result}\"\n         },\n+        {\n+          secret_id   = \"auto-hydra-db-password\"\n+          secret_data = \"$${random_password.passwords[\\\"hydra_db_password\\\"].result}\"", "originalCommit": "120be7a428f0cd44ce5889048cf9c79d4978e865", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMzNjAwNw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1080#discussion_r498336007", "bodyText": "You should also add hydra_db_user  to the random_string  block at line 258 similar to the other ones.", "author": "xingao267", "createdAt": "2020-10-01T15:31:53Z", "path": "deployment.hcl", "diffHunk": "@@ -163,6 +163,18 @@ template \"project_secrets\" {\n           secret_id   = \"auto-auth-server-db-user\"\n           secret_data = \"$${random_string.strings[\\\"auth_server_db_user\\\"].result}\"\n         },\n+        {\n+          secret_id   = \"auto-hydra-db-password\"\n+          secret_data = \"$${random_password.passwords[\\\"hydra_db_password\\\"].result}\"\n+        },\n+        {\n+          secret_id   = \"auto-hydra-db-user\"\n+          secret_data = \"$${random_string.strings[\\\"hydra_db_user\\\"].result}\"", "originalCommit": "120be7a428f0cd44ce5889048cf9c79d4978e865", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMzNzYzMQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1080#discussion_r498337631", "bodyText": "maybe name it as auto-hydra-secret-key to be consistent with other secret keys?\nAnd also add hydra_secret_key to the random_password block at line 275.", "author": "xingao267", "createdAt": "2020-10-01T15:34:10Z", "path": "deployment.hcl", "diffHunk": "@@ -163,6 +163,18 @@ template \"project_secrets\" {\n           secret_id   = \"auto-auth-server-db-user\"\n           secret_data = \"$${random_string.strings[\\\"auth_server_db_user\\\"].result}\"\n         },\n+        {\n+          secret_id   = \"auto-hydra-db-password\"\n+          secret_data = \"$${random_password.passwords[\\\"hydra_db_password\\\"].result}\"\n+        },\n+        {\n+          secret_id   = \"auto-hydra-db-user\"\n+          secret_data = \"$${random_string.strings[\\\"hydra_db_user\\\"].result}\"\n+        },\n+        {\n+          secret_id   = \"auto-hydra-secrets-system\"", "originalCommit": "120be7a428f0cd44ce5889048cf9c79d4978e865", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM0MjM1Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1080#discussion_r498342353", "bodyText": "I wanted to keep it separate, since the requirement is somewhat differet. This secrets_system value is a one time secretused for db encryption and requires a 32 character string.\ndocumentation of hydra uses this command to generate the value:\nexport SECRETS_SYSTEM=$(export LC_CTYPE=C; cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 32 | head -n 1)", "author": "zohrehj", "createdAt": "2020-10-01T15:40:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMzNzYzMQ=="}], "type": "inlineReview"}, {"oid": "089886147983a88bb6da370601b411dd26a2ced2", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/089886147983a88bb6da370601b411dd26a2ced2", "message": "Add deployment assets for hydra", "committedDate": "2020-10-01T19:29:27Z", "type": "commit"}, {"oid": "2c8206cb2779cb38f170f91935ee902e0e20496c", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/2c8206cb2779cb38f170f91935ee902e0e20496c", "message": "Update terraform files", "committedDate": "2020-10-01T19:31:27Z", "type": "commit"}, {"oid": "6544b8392fa145457d013067808180b991bc559c", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/6544b8392fa145457d013067808180b991bc559c", "message": "Remove CORS headers", "committedDate": "2020-10-01T19:31:31Z", "type": "commit"}, {"oid": "bd1cc53f7e9b5c33e91bd8657367f16dd81fd78d", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/bd1cc53f7e9b5c33e91bd8657367f16dd81fd78d", "message": "Fix hydra db user and password", "committedDate": "2020-10-01T19:31:31Z", "type": "commit"}, {"oid": "bd1cc53f7e9b5c33e91bd8657367f16dd81fd78d", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/bd1cc53f7e9b5c33e91bd8657367f16dd81fd78d", "message": "Fix hydra db user and password", "committedDate": "2020-10-01T19:31:31Z", "type": "forcePushed"}, {"oid": "1eaa0ffe893b15332d3cd6fd398a012b8eb35b94", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/1eaa0ffe893b15332d3cd6fd398a012b8eb35b94", "message": "Remove conflict mark", "committedDate": "2020-10-01T19:33:07Z", "type": "commit"}, {"oid": "7f6b9a85fe201632c261c5dbe8a68dc8321e5982", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/7f6b9a85fe201632c261c5dbe8a68dc8321e5982", "message": "Merge branch 'develop' into hydra", "committedDate": "2020-10-05T13:42:06Z", "type": "commit"}, {"oid": "5ce6658ef33a756e164896fe9b14ac0e6cd5b673", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/5ce6658ef33a756e164896fe9b14ac0e6cd5b673", "message": "Merge branch 'develop' into hydra", "committedDate": "2020-10-05T14:54:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY3MTg5NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1080#discussion_r499671895", "bodyText": "maybe rename strings to be secrets to be consistent", "author": "xingao267", "createdAt": "2020-10-05T15:10:06Z", "path": "deployment.hcl", "diffHunk": "@@ -273,10 +286,18 @@ resource \"random_password\" \"passwords\" {\n     \"study_metadata_db_password\",\n     \"user_registration_db_password\",\n     \"participant_manager_db_user\",\n+    \"hydra_db_password\",\n   ])\n   length  = 16\n   special = true\n }\n+\n+resource \"random_secret\" \"strings\" {", "originalCommit": "5ce6658ef33a756e164896fe9b14ac0e6cd5b673", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY4MzY3MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1080#discussion_r499683670", "bodyText": "updated!", "author": "zohrehj", "createdAt": "2020-10-05T15:26:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY3MTg5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY3MjIzNw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1080#discussion_r499672237", "bodyText": "git merge conflicts", "author": "xingao267", "createdAt": "2020-10-05T15:10:32Z", "path": "terraform/example-dev-apps/main.tf", "diffHunk": "@@ -43,9 +43,15 @@ resource \"google_compute_global_address\" \"ingress_static_ip\" {\n #     \"WCP\",\n #     \"WCP-WS\",\n #     \"auth-server-ws\",\n-#     \"user-registration-server-ws\",\n+#     \"user-registration-server-ws/consent-mgmt-module\",\n+#     \"user-registration-server-ws/enroll-mgmt-module\",\n+#     \"user-registration-server-ws/user-mgmt-module\",\n #     \"response-server-ws\",\n+<<<<<<< HEAD", "originalCommit": "5ce6658ef33a756e164896fe9b14ac0e6cd5b673", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY4MzYxNA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1080#discussion_r499683614", "bodyText": "fixed, thanks for catching", "author": "zohrehj", "createdAt": "2020-10-05T15:26:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY3MjIzNw=="}], "type": "inlineReview"}, {"oid": "885b19b19f4de52f0bdf1acebe5b5666967951d8", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/885b19b19f4de52f0bdf1acebe5b5666967951d8", "message": "Change random_secrets' output to secrets", "committedDate": "2020-10-05T15:22:57Z", "type": "commit"}, {"oid": "81f6009459c4b387f94d96383c23b8b87e1203a0", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/81f6009459c4b387f94d96383c23b8b87e1203a0", "message": "Remove merge conflict from main.tf", "committedDate": "2020-10-05T15:23:46Z", "type": "commit"}, {"oid": "a944a630a4d972304221dc820c997f6d4130edee", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/a944a630a4d972304221dc820c997f6d4130edee", "message": "Regenerate terraform files", "committedDate": "2020-10-05T15:26:16Z", "type": "commit"}, {"oid": "8f0ffb97ccf9bb640899dca5cea9a98e1424aa75", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/8f0ffb97ccf9bb640899dca5cea9a98e1424aa75", "message": "Merge branch 'develop' into hydra", "committedDate": "2020-10-05T15:26:47Z", "type": "commit"}]}