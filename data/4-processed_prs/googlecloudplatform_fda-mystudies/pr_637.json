{"pr_number": 637, "pr_title": "participant-manager GET /studies endpoint implementation", "pr_createdAt": "2020-07-14T15:25:59Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/637", "timeline": [{"oid": "9c06014be3338bacaeb48f006ef029c43cb63dd9", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/9c06014be3338bacaeb48f006ef029c43cb63dd9", "message": "participant-manager GET /studies endpoint implementation\n\nparticipant-manager GET /studies endpoint implementation", "committedDate": "2020-07-14T15:24:26Z", "type": "commit"}, {"oid": "770c83854e9dca404407b23b56addac1b2ae4654", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/770c83854e9dca404407b23b56addac1b2ae4654", "message": "Merge branch 'participant-manager-apps-endpoint-implementation' into participant-manager-studies-endpoint", "committedDate": "2020-07-14T15:35:37Z", "type": "commit"}, {"oid": "3b0f128522962eebb160ce5d1cddab0620cc6972", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/3b0f128522962eebb160ce5d1cddab0620cc6972", "message": "Reused CommonConstants and updated TestDataHelper\n\nReused CommonConstants and updated TestDataHelper", "committedDate": "2020-07-21T08:17:54Z", "type": "commit"}, {"oid": "d5119db182f28eb42c4053947d649107580e5857", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/d5119db182f28eb42c4053947d649107580e5857", "message": "Merge branch 'participant-manager-apps-endpoint-implementation' into participant-manager-studies-endpoint", "committedDate": "2020-07-23T12:36:37Z", "type": "commit"}, {"oid": "d1cfba5f0d52ac2d9f9e577ebcf8a99549d66897", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/d1cfba5f0d52ac2d9f9e577ebcf8a99549d66897", "message": "Added @componentscan to BaseMockIT to fix build issue\n\nAdded @componentscan to BaseMockIT to fix build issue", "committedDate": "2020-07-23T12:44:39Z", "type": "commit"}, {"oid": "bf7414804397fb58182a9a5b950fb3c89bd2cf5a", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/bf7414804397fb58182a9a5b950fb3c89bd2cf5a", "message": "Merge branch 'participant-manager-studies-endpoint' of https://github.com/GoogleCloudPlatform/fda-mystudies into participant-manager-studies-endpoint", "committedDate": "2020-07-23T12:46:00Z", "type": "commit"}, {"oid": "ac1b133e7f76db791900e787e9c1c599df6d5f94", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/ac1b133e7f76db791900e787e9c1c599df6d5f94", "message": "Updated StudyServiceImpl\n\nUpdated StudyServiceImpl", "committedDate": "2020-07-23T12:54:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY0NjE3Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/637#discussion_r459646173", "bodyText": "Use CommonConstants.CLOSE_STUDY", "author": "saminguyen", "createdAt": "2020-07-23T18:28:46Z", "path": "participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/helper/TestDataHelper.java", "diffHunk": "@@ -137,6 +137,7 @@ public AppEntity createAppEntity(UserRegAdminEntity userEntity) {\n \n   public StudyEntity createStudyEntity(UserRegAdminEntity userEntity, AppEntity appEntity) {\n     StudyEntity studyEntity = new StudyEntity();\n+    studyEntity.setType(\"CLOSE\");", "originalCommit": "ac1b133e7f76db791900e787e9c1c599df6d5f94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg2MDUwMg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/637#discussion_r459860502", "bodyText": "Changed to CommonConstants.CLOSE_STUDY.", "author": "monica-BTC", "createdAt": "2020-07-24T05:38:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY0NjE3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY1MTcyNw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/637#discussion_r459651727", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private Long totalSitesCount;\n          \n          \n            \n              private Long sitesCount;", "author": "saminguyen", "createdAt": "2020-07-23T18:38:49Z", "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/beans/StudyDetails.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.beans;\n+\n+import java.util.List;\n+\n+import lombok.Getter;\n+import lombok.Setter;\n+\n+@Setter\n+@Getter\n+public class StudyDetails {\n+  private String id;\n+\n+  private String customId;\n+\n+  private String name;\n+\n+  private Long totalSitesCount;", "originalCommit": "ac1b133e7f76db791900e787e9c1c599df6d5f94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg2MDU3NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/637#discussion_r459860574", "bodyText": "Changed to sitesCount.", "author": "monica-BTC", "createdAt": "2020-07-24T05:39:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY1MTcyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY1NTk4OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/637#discussion_r459655989", "bodyText": "you should extract entry.getKey() and getValue() out as local variable to make the code more readable.", "author": "saminguyen", "createdAt": "2020-07-23T18:46:11Z", "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/StudyServiceImpl.java", "diffHunk": "@@ -0,0 +1,220 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+package com.google.cloud.healthcare.fdamystudies.service;\n+\n+import static com.google.cloud.healthcare.fdamystudies.common.CommonConstants.CLOSE_STUDY;\n+import static com.google.cloud.healthcare.fdamystudies.common.CommonConstants.OPEN_STUDY;\n+import static com.google.cloud.healthcare.fdamystudies.common.CommonConstants.READ_AND_EDIT_PERMISSION;\n+import static com.google.cloud.healthcare.fdamystudies.common.CommonConstants.READ_PERMISSION;\n+import static com.google.cloud.healthcare.fdamystudies.common.CommonConstants.VIEW_VALUE;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+import com.google.cloud.healthcare.fdamystudies.beans.StudyDetails;\n+import com.google.cloud.healthcare.fdamystudies.beans.StudyResponse;\n+import com.google.cloud.healthcare.fdamystudies.common.ErrorCode;\n+import com.google.cloud.healthcare.fdamystudies.common.MessageCode;\n+import com.google.cloud.healthcare.fdamystudies.model.ParticipantRegistrySiteEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.ParticipantStudyEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.SitePermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.StudyEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.StudyPermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.repository.ParticipantRegistrySiteRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.ParticipantStudyRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.SitePermissionRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.StudyPermissionRepository;\n+\n+@Service\n+public class StudyServiceImpl implements StudyService {\n+  private XLogger logger = XLoggerFactory.getXLogger(StudyServiceImpl.class.getName());\n+\n+  @Autowired private StudyPermissionRepository studyPermissionRepository;\n+\n+  @Autowired private ParticipantRegistrySiteRepository participantRegistrySiteRepository;\n+\n+  @Autowired private ParticipantStudyRepository participantStudiesRepository;\n+\n+  @Autowired private SitePermissionRepository sitePermissionRepository;\n+\n+  @Override\n+  @Transactional(readOnly = true)\n+  public StudyResponse getStudies(String userId) {\n+    logger.entry(\"getStudies(String userId)\");\n+\n+    List<SitePermissionEntity> sitePermissions =\n+        sitePermissionRepository.findSitePermissionByUserId(userId);\n+\n+    if (CollectionUtils.isEmpty(sitePermissions)) {\n+      logger.exit(ErrorCode.STUDY_NOT_FOUND);\n+      return new StudyResponse(ErrorCode.STUDY_NOT_FOUND);\n+    }\n+\n+    Map<StudyEntity, List<SitePermissionEntity>> studyPermissionMap =\n+        sitePermissions.stream().collect(Collectors.groupingBy(SitePermissionEntity::getStudy));\n+\n+    List<String> usersStudyIds =\n+        sitePermissions\n+            .stream()\n+            .distinct()\n+            .map(studyEntity -> studyEntity.getStudy().getId())\n+            .collect(Collectors.toList());\n+\n+    Map<String, StudyPermissionEntity> studyPermissionsByStudyInfoId =\n+        getStudyPermissionsByStudyInfoId(userId, usersStudyIds);\n+\n+    List<String> usersSiteIds =\n+        sitePermissions\n+            .stream()\n+            .map(s -> s.getSite().getId())\n+            .distinct()\n+            .collect(Collectors.toList());\n+\n+    Map<String, Long> siteWithInvitedParticipantCountMap =\n+        getSiteWithInvitedParticipantCountMap(usersSiteIds);\n+\n+    Map<String, Long> siteWithEnrolledParticipantCountMap =\n+        getSiteWithEnrolledParticipantCountMap(usersSiteIds);\n+\n+    return prepareStudyResponse(\n+        sitePermissions,\n+        studyPermissionsByStudyInfoId,\n+        studyPermissionMap,\n+        siteWithInvitedParticipantCountMap,\n+        siteWithEnrolledParticipantCountMap);\n+  }\n+\n+  private Map<String, StudyPermissionEntity> getStudyPermissionsByStudyInfoId(\n+      String userId, List<String> usersStudyIds) {\n+    List<StudyPermissionEntity> studyPermissions =\n+        studyPermissionRepository.findStudyPermissionsOfUserByStudyIds(usersStudyIds, userId);\n+\n+    Map<String, StudyPermissionEntity> studyPermissionsByStudyInfoId = new HashMap<>();\n+    if (CollectionUtils.isNotEmpty(studyPermissions)) {\n+      studyPermissionsByStudyInfoId =\n+          studyPermissions\n+              .stream()\n+              .collect(Collectors.toMap(e -> e.getStudy().getId(), Function.identity()));\n+    }\n+    return studyPermissionsByStudyInfoId;\n+  }\n+\n+  private StudyResponse prepareStudyResponse(\n+      List<SitePermissionEntity> sitePermissions,\n+      Map<String, StudyPermissionEntity> studyPermissionsByStudyInfoId,\n+      Map<StudyEntity, List<SitePermissionEntity>> studyPermissionMap,\n+      Map<String, Long> siteWithInvitedParticipantCountMap,\n+      Map<String, Long> siteWithEnrolledParticipantCountMap) {\n+    List<StudyDetails> studies = new ArrayList<>();\n+    for (Map.Entry<StudyEntity, List<SitePermissionEntity>> entry : studyPermissionMap.entrySet()) {\n+      StudyDetails studyDetail = new StudyDetails();\n+      String studyId = entry.getKey().getId();\n+      studyDetail.setId(studyId);\n+      studyDetail.setCustomId(entry.getKey().getCustomId());\n+      studyDetail.setName(entry.getKey().getName());\n+      studyDetail.setType(entry.getKey().getType());\n+      studyDetail.setTotalSitesCount((long) entry.getValue().size());", "originalCommit": "ac1b133e7f76db791900e787e9c1c599df6d5f94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg2MDc2OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/637#discussion_r459860769", "bodyText": "Extracted key and value to local variable.", "author": "monica-BTC", "createdAt": "2020-07-24T05:39:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY1NTk4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY1NjMxNQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/637#discussion_r459656315", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  studyEnrolledCount =\n          \n          \n            \n                      studyEnrolledCount\n          \n          \n            \n                          + siteWithEnrolledParticipantCountMap.get(sitePermission.getSite().getId());\n          \n          \n            \n                  studyEnrolledCount += siteWithEnrolledParticipantCountMap.get(sitePermission.getSite().getId());", "author": "saminguyen", "createdAt": "2020-07-23T18:46:49Z", "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/StudyServiceImpl.java", "diffHunk": "@@ -0,0 +1,220 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+package com.google.cloud.healthcare.fdamystudies.service;\n+\n+import static com.google.cloud.healthcare.fdamystudies.common.CommonConstants.CLOSE_STUDY;\n+import static com.google.cloud.healthcare.fdamystudies.common.CommonConstants.OPEN_STUDY;\n+import static com.google.cloud.healthcare.fdamystudies.common.CommonConstants.READ_AND_EDIT_PERMISSION;\n+import static com.google.cloud.healthcare.fdamystudies.common.CommonConstants.READ_PERMISSION;\n+import static com.google.cloud.healthcare.fdamystudies.common.CommonConstants.VIEW_VALUE;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+import com.google.cloud.healthcare.fdamystudies.beans.StudyDetails;\n+import com.google.cloud.healthcare.fdamystudies.beans.StudyResponse;\n+import com.google.cloud.healthcare.fdamystudies.common.ErrorCode;\n+import com.google.cloud.healthcare.fdamystudies.common.MessageCode;\n+import com.google.cloud.healthcare.fdamystudies.model.ParticipantRegistrySiteEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.ParticipantStudyEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.SitePermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.StudyEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.StudyPermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.repository.ParticipantRegistrySiteRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.ParticipantStudyRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.SitePermissionRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.StudyPermissionRepository;\n+\n+@Service\n+public class StudyServiceImpl implements StudyService {\n+  private XLogger logger = XLoggerFactory.getXLogger(StudyServiceImpl.class.getName());\n+\n+  @Autowired private StudyPermissionRepository studyPermissionRepository;\n+\n+  @Autowired private ParticipantRegistrySiteRepository participantRegistrySiteRepository;\n+\n+  @Autowired private ParticipantStudyRepository participantStudiesRepository;\n+\n+  @Autowired private SitePermissionRepository sitePermissionRepository;\n+\n+  @Override\n+  @Transactional(readOnly = true)\n+  public StudyResponse getStudies(String userId) {\n+    logger.entry(\"getStudies(String userId)\");\n+\n+    List<SitePermissionEntity> sitePermissions =\n+        sitePermissionRepository.findSitePermissionByUserId(userId);\n+\n+    if (CollectionUtils.isEmpty(sitePermissions)) {\n+      logger.exit(ErrorCode.STUDY_NOT_FOUND);\n+      return new StudyResponse(ErrorCode.STUDY_NOT_FOUND);\n+    }\n+\n+    Map<StudyEntity, List<SitePermissionEntity>> studyPermissionMap =\n+        sitePermissions.stream().collect(Collectors.groupingBy(SitePermissionEntity::getStudy));\n+\n+    List<String> usersStudyIds =\n+        sitePermissions\n+            .stream()\n+            .distinct()\n+            .map(studyEntity -> studyEntity.getStudy().getId())\n+            .collect(Collectors.toList());\n+\n+    Map<String, StudyPermissionEntity> studyPermissionsByStudyInfoId =\n+        getStudyPermissionsByStudyInfoId(userId, usersStudyIds);\n+\n+    List<String> usersSiteIds =\n+        sitePermissions\n+            .stream()\n+            .map(s -> s.getSite().getId())\n+            .distinct()\n+            .collect(Collectors.toList());\n+\n+    Map<String, Long> siteWithInvitedParticipantCountMap =\n+        getSiteWithInvitedParticipantCountMap(usersSiteIds);\n+\n+    Map<String, Long> siteWithEnrolledParticipantCountMap =\n+        getSiteWithEnrolledParticipantCountMap(usersSiteIds);\n+\n+    return prepareStudyResponse(\n+        sitePermissions,\n+        studyPermissionsByStudyInfoId,\n+        studyPermissionMap,\n+        siteWithInvitedParticipantCountMap,\n+        siteWithEnrolledParticipantCountMap);\n+  }\n+\n+  private Map<String, StudyPermissionEntity> getStudyPermissionsByStudyInfoId(\n+      String userId, List<String> usersStudyIds) {\n+    List<StudyPermissionEntity> studyPermissions =\n+        studyPermissionRepository.findStudyPermissionsOfUserByStudyIds(usersStudyIds, userId);\n+\n+    Map<String, StudyPermissionEntity> studyPermissionsByStudyInfoId = new HashMap<>();\n+    if (CollectionUtils.isNotEmpty(studyPermissions)) {\n+      studyPermissionsByStudyInfoId =\n+          studyPermissions\n+              .stream()\n+              .collect(Collectors.toMap(e -> e.getStudy().getId(), Function.identity()));\n+    }\n+    return studyPermissionsByStudyInfoId;\n+  }\n+\n+  private StudyResponse prepareStudyResponse(\n+      List<SitePermissionEntity> sitePermissions,\n+      Map<String, StudyPermissionEntity> studyPermissionsByStudyInfoId,\n+      Map<StudyEntity, List<SitePermissionEntity>> studyPermissionMap,\n+      Map<String, Long> siteWithInvitedParticipantCountMap,\n+      Map<String, Long> siteWithEnrolledParticipantCountMap) {\n+    List<StudyDetails> studies = new ArrayList<>();\n+    for (Map.Entry<StudyEntity, List<SitePermissionEntity>> entry : studyPermissionMap.entrySet()) {\n+      StudyDetails studyDetail = new StudyDetails();\n+      String studyId = entry.getKey().getId();\n+      studyDetail.setId(studyId);\n+      studyDetail.setCustomId(entry.getKey().getCustomId());\n+      studyDetail.setName(entry.getKey().getName());\n+      studyDetail.setType(entry.getKey().getType());\n+      studyDetail.setTotalSitesCount((long) entry.getValue().size());\n+\n+      if (studyPermissionsByStudyInfoId.get(studyId) != null) {\n+        Integer studyEditPermission =\n+            studyPermissionsByStudyInfoId.get(entry.getKey().getId()).getEdit();\n+        studyDetail.setStudyPermission(\n+            studyEditPermission == VIEW_VALUE ? READ_PERMISSION : READ_AND_EDIT_PERMISSION);\n+        studyDetail.setStudyPermission(studyEditPermission);\n+      }\n+\n+      calculateEnrollmentPercentage(\n+          siteWithInvitedParticipantCountMap,\n+          siteWithEnrolledParticipantCountMap,\n+          entry,\n+          studyDetail);\n+      studies.add(studyDetail);\n+    }\n+\n+    StudyResponse studyResponse =\n+        new StudyResponse(MessageCode.GET_STUDIES_SUCCESS, studies, sitePermissions.size());\n+    logger.exit(String.format(\"total studies=%d\", studyResponse.getStudies().size()));\n+    return studyResponse;\n+  }\n+\n+  private void calculateEnrollmentPercentage(\n+      Map<String, Long> siteWithInvitedParticipantCountMap,\n+      Map<String, Long> siteWithEnrolledParticipantCountMap,\n+      Map.Entry<StudyEntity, List<SitePermissionEntity>> entry,\n+      StudyDetails studyDetail) {\n+    Long studyInvitedCount = 0L;\n+    Long studyEnrolledCount = 0L;\n+    for (SitePermissionEntity sitePermission : entry.getValue()) {\n+      studyInvitedCount =\n+          getStudyInvitedCount(\n+              siteWithInvitedParticipantCountMap, entry, studyInvitedCount, sitePermission);\n+\n+      studyEnrolledCount =\n+          studyEnrolledCount\n+              + siteWithEnrolledParticipantCountMap.get(sitePermission.getSite().getId());", "originalCommit": "ac1b133e7f76db791900e787e9c1c599df6d5f94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg2MDk0NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/637#discussion_r459860945", "bodyText": "Changed to \"+=\" operator.", "author": "monica-BTC", "createdAt": "2020-07-24T05:40:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY1NjMxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY1OTQxNw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/637#discussion_r459659417", "bodyText": "same as above", "author": "saminguyen", "createdAt": "2020-07-23T18:52:22Z", "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/StudyServiceImpl.java", "diffHunk": "@@ -0,0 +1,220 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+package com.google.cloud.healthcare.fdamystudies.service;\n+\n+import static com.google.cloud.healthcare.fdamystudies.common.CommonConstants.CLOSE_STUDY;\n+import static com.google.cloud.healthcare.fdamystudies.common.CommonConstants.OPEN_STUDY;\n+import static com.google.cloud.healthcare.fdamystudies.common.CommonConstants.READ_AND_EDIT_PERMISSION;\n+import static com.google.cloud.healthcare.fdamystudies.common.CommonConstants.READ_PERMISSION;\n+import static com.google.cloud.healthcare.fdamystudies.common.CommonConstants.VIEW_VALUE;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+import com.google.cloud.healthcare.fdamystudies.beans.StudyDetails;\n+import com.google.cloud.healthcare.fdamystudies.beans.StudyResponse;\n+import com.google.cloud.healthcare.fdamystudies.common.ErrorCode;\n+import com.google.cloud.healthcare.fdamystudies.common.MessageCode;\n+import com.google.cloud.healthcare.fdamystudies.model.ParticipantRegistrySiteEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.ParticipantStudyEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.SitePermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.StudyEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.StudyPermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.repository.ParticipantRegistrySiteRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.ParticipantStudyRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.SitePermissionRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.StudyPermissionRepository;\n+\n+@Service\n+public class StudyServiceImpl implements StudyService {\n+  private XLogger logger = XLoggerFactory.getXLogger(StudyServiceImpl.class.getName());\n+\n+  @Autowired private StudyPermissionRepository studyPermissionRepository;\n+\n+  @Autowired private ParticipantRegistrySiteRepository participantRegistrySiteRepository;\n+\n+  @Autowired private ParticipantStudyRepository participantStudiesRepository;\n+\n+  @Autowired private SitePermissionRepository sitePermissionRepository;\n+\n+  @Override\n+  @Transactional(readOnly = true)\n+  public StudyResponse getStudies(String userId) {\n+    logger.entry(\"getStudies(String userId)\");\n+\n+    List<SitePermissionEntity> sitePermissions =\n+        sitePermissionRepository.findSitePermissionByUserId(userId);\n+\n+    if (CollectionUtils.isEmpty(sitePermissions)) {\n+      logger.exit(ErrorCode.STUDY_NOT_FOUND);\n+      return new StudyResponse(ErrorCode.STUDY_NOT_FOUND);\n+    }\n+\n+    Map<StudyEntity, List<SitePermissionEntity>> studyPermissionMap =\n+        sitePermissions.stream().collect(Collectors.groupingBy(SitePermissionEntity::getStudy));\n+\n+    List<String> usersStudyIds =\n+        sitePermissions\n+            .stream()\n+            .distinct()\n+            .map(studyEntity -> studyEntity.getStudy().getId())\n+            .collect(Collectors.toList());\n+\n+    Map<String, StudyPermissionEntity> studyPermissionsByStudyInfoId =\n+        getStudyPermissionsByStudyInfoId(userId, usersStudyIds);\n+\n+    List<String> usersSiteIds =\n+        sitePermissions\n+            .stream()\n+            .map(s -> s.getSite().getId())\n+            .distinct()\n+            .collect(Collectors.toList());\n+\n+    Map<String, Long> siteWithInvitedParticipantCountMap =\n+        getSiteWithInvitedParticipantCountMap(usersSiteIds);\n+\n+    Map<String, Long> siteWithEnrolledParticipantCountMap =\n+        getSiteWithEnrolledParticipantCountMap(usersSiteIds);\n+\n+    return prepareStudyResponse(\n+        sitePermissions,\n+        studyPermissionsByStudyInfoId,\n+        studyPermissionMap,\n+        siteWithInvitedParticipantCountMap,\n+        siteWithEnrolledParticipantCountMap);\n+  }\n+\n+  private Map<String, StudyPermissionEntity> getStudyPermissionsByStudyInfoId(\n+      String userId, List<String> usersStudyIds) {\n+    List<StudyPermissionEntity> studyPermissions =\n+        studyPermissionRepository.findStudyPermissionsOfUserByStudyIds(usersStudyIds, userId);\n+\n+    Map<String, StudyPermissionEntity> studyPermissionsByStudyInfoId = new HashMap<>();\n+    if (CollectionUtils.isNotEmpty(studyPermissions)) {\n+      studyPermissionsByStudyInfoId =\n+          studyPermissions\n+              .stream()\n+              .collect(Collectors.toMap(e -> e.getStudy().getId(), Function.identity()));\n+    }\n+    return studyPermissionsByStudyInfoId;\n+  }\n+\n+  private StudyResponse prepareStudyResponse(\n+      List<SitePermissionEntity> sitePermissions,\n+      Map<String, StudyPermissionEntity> studyPermissionsByStudyInfoId,\n+      Map<StudyEntity, List<SitePermissionEntity>> studyPermissionMap,\n+      Map<String, Long> siteWithInvitedParticipantCountMap,\n+      Map<String, Long> siteWithEnrolledParticipantCountMap) {\n+    List<StudyDetails> studies = new ArrayList<>();\n+    for (Map.Entry<StudyEntity, List<SitePermissionEntity>> entry : studyPermissionMap.entrySet()) {\n+      StudyDetails studyDetail = new StudyDetails();\n+      String studyId = entry.getKey().getId();\n+      studyDetail.setId(studyId);\n+      studyDetail.setCustomId(entry.getKey().getCustomId());\n+      studyDetail.setName(entry.getKey().getName());\n+      studyDetail.setType(entry.getKey().getType());\n+      studyDetail.setTotalSitesCount((long) entry.getValue().size());\n+\n+      if (studyPermissionsByStudyInfoId.get(studyId) != null) {\n+        Integer studyEditPermission =\n+            studyPermissionsByStudyInfoId.get(entry.getKey().getId()).getEdit();\n+        studyDetail.setStudyPermission(\n+            studyEditPermission == VIEW_VALUE ? READ_PERMISSION : READ_AND_EDIT_PERMISSION);\n+        studyDetail.setStudyPermission(studyEditPermission);\n+      }\n+\n+      calculateEnrollmentPercentage(\n+          siteWithInvitedParticipantCountMap,\n+          siteWithEnrolledParticipantCountMap,\n+          entry,\n+          studyDetail);\n+      studies.add(studyDetail);\n+    }\n+\n+    StudyResponse studyResponse =\n+        new StudyResponse(MessageCode.GET_STUDIES_SUCCESS, studies, sitePermissions.size());\n+    logger.exit(String.format(\"total studies=%d\", studyResponse.getStudies().size()));\n+    return studyResponse;\n+  }\n+\n+  private void calculateEnrollmentPercentage(\n+      Map<String, Long> siteWithInvitedParticipantCountMap,\n+      Map<String, Long> siteWithEnrolledParticipantCountMap,\n+      Map.Entry<StudyEntity, List<SitePermissionEntity>> entry,\n+      StudyDetails studyDetail) {\n+    Long studyInvitedCount = 0L;\n+    Long studyEnrolledCount = 0L;\n+    for (SitePermissionEntity sitePermission : entry.getValue()) {\n+      studyInvitedCount =\n+          getStudyInvitedCount(\n+              siteWithInvitedParticipantCountMap, entry, studyInvitedCount, sitePermission);\n+\n+      studyEnrolledCount =\n+          studyEnrolledCount\n+              + siteWithEnrolledParticipantCountMap.get(sitePermission.getSite().getId());\n+    }\n+\n+    studyDetail.setEnrolled(studyEnrolledCount);\n+    studyDetail.setInvited(studyInvitedCount);\n+    if (studyDetail.getInvited() != 0 && studyDetail.getInvited() >= studyDetail.getEnrolled()) {\n+      Double percentage =\n+          (Double.valueOf(studyDetail.getEnrolled()) * 100)\n+              / Double.valueOf(studyDetail.getInvited());\n+      studyDetail.setEnrollmentPercentage(percentage);\n+    }\n+  }\n+\n+  private Long getStudyInvitedCount(\n+      Map<String, Long> siteWithInvitedParticipantCountMap,\n+      Map.Entry<StudyEntity, List<SitePermissionEntity>> entry,\n+      Long studyInvitedCount,\n+      SitePermissionEntity sitePermission) {\n+    String siteId = sitePermission.getSite().getId();\n+    String studyType = entry.getKey().getType();\n+    if (siteWithInvitedParticipantCountMap.get(siteId) != null && studyType.equals(CLOSE_STUDY)) {\n+      studyInvitedCount = studyInvitedCount + siteWithInvitedParticipantCountMap.get(siteId);", "originalCommit": "ac1b133e7f76db791900e787e9c1c599df6d5f94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg2MDk2Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/637#discussion_r459860967", "bodyText": "Changed to \"+=\" operator.", "author": "monica-BTC", "createdAt": "2020-07-24T05:40:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY1OTQxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY1OTUxNA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/637#discussion_r459659514", "bodyText": "same as above", "author": "saminguyen", "createdAt": "2020-07-23T18:52:35Z", "path": "participant-manager-module/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/StudyServiceImpl.java", "diffHunk": "@@ -0,0 +1,220 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+package com.google.cloud.healthcare.fdamystudies.service;\n+\n+import static com.google.cloud.healthcare.fdamystudies.common.CommonConstants.CLOSE_STUDY;\n+import static com.google.cloud.healthcare.fdamystudies.common.CommonConstants.OPEN_STUDY;\n+import static com.google.cloud.healthcare.fdamystudies.common.CommonConstants.READ_AND_EDIT_PERMISSION;\n+import static com.google.cloud.healthcare.fdamystudies.common.CommonConstants.READ_PERMISSION;\n+import static com.google.cloud.healthcare.fdamystudies.common.CommonConstants.VIEW_VALUE;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.slf4j.ext.XLogger;\n+import org.slf4j.ext.XLoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+import org.springframework.transaction.annotation.Transactional;\n+\n+import com.google.cloud.healthcare.fdamystudies.beans.StudyDetails;\n+import com.google.cloud.healthcare.fdamystudies.beans.StudyResponse;\n+import com.google.cloud.healthcare.fdamystudies.common.ErrorCode;\n+import com.google.cloud.healthcare.fdamystudies.common.MessageCode;\n+import com.google.cloud.healthcare.fdamystudies.model.ParticipantRegistrySiteEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.ParticipantStudyEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.SitePermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.StudyEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.StudyPermissionEntity;\n+import com.google.cloud.healthcare.fdamystudies.repository.ParticipantRegistrySiteRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.ParticipantStudyRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.SitePermissionRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.StudyPermissionRepository;\n+\n+@Service\n+public class StudyServiceImpl implements StudyService {\n+  private XLogger logger = XLoggerFactory.getXLogger(StudyServiceImpl.class.getName());\n+\n+  @Autowired private StudyPermissionRepository studyPermissionRepository;\n+\n+  @Autowired private ParticipantRegistrySiteRepository participantRegistrySiteRepository;\n+\n+  @Autowired private ParticipantStudyRepository participantStudiesRepository;\n+\n+  @Autowired private SitePermissionRepository sitePermissionRepository;\n+\n+  @Override\n+  @Transactional(readOnly = true)\n+  public StudyResponse getStudies(String userId) {\n+    logger.entry(\"getStudies(String userId)\");\n+\n+    List<SitePermissionEntity> sitePermissions =\n+        sitePermissionRepository.findSitePermissionByUserId(userId);\n+\n+    if (CollectionUtils.isEmpty(sitePermissions)) {\n+      logger.exit(ErrorCode.STUDY_NOT_FOUND);\n+      return new StudyResponse(ErrorCode.STUDY_NOT_FOUND);\n+    }\n+\n+    Map<StudyEntity, List<SitePermissionEntity>> studyPermissionMap =\n+        sitePermissions.stream().collect(Collectors.groupingBy(SitePermissionEntity::getStudy));\n+\n+    List<String> usersStudyIds =\n+        sitePermissions\n+            .stream()\n+            .distinct()\n+            .map(studyEntity -> studyEntity.getStudy().getId())\n+            .collect(Collectors.toList());\n+\n+    Map<String, StudyPermissionEntity> studyPermissionsByStudyInfoId =\n+        getStudyPermissionsByStudyInfoId(userId, usersStudyIds);\n+\n+    List<String> usersSiteIds =\n+        sitePermissions\n+            .stream()\n+            .map(s -> s.getSite().getId())\n+            .distinct()\n+            .collect(Collectors.toList());\n+\n+    Map<String, Long> siteWithInvitedParticipantCountMap =\n+        getSiteWithInvitedParticipantCountMap(usersSiteIds);\n+\n+    Map<String, Long> siteWithEnrolledParticipantCountMap =\n+        getSiteWithEnrolledParticipantCountMap(usersSiteIds);\n+\n+    return prepareStudyResponse(\n+        sitePermissions,\n+        studyPermissionsByStudyInfoId,\n+        studyPermissionMap,\n+        siteWithInvitedParticipantCountMap,\n+        siteWithEnrolledParticipantCountMap);\n+  }\n+\n+  private Map<String, StudyPermissionEntity> getStudyPermissionsByStudyInfoId(\n+      String userId, List<String> usersStudyIds) {\n+    List<StudyPermissionEntity> studyPermissions =\n+        studyPermissionRepository.findStudyPermissionsOfUserByStudyIds(usersStudyIds, userId);\n+\n+    Map<String, StudyPermissionEntity> studyPermissionsByStudyInfoId = new HashMap<>();\n+    if (CollectionUtils.isNotEmpty(studyPermissions)) {\n+      studyPermissionsByStudyInfoId =\n+          studyPermissions\n+              .stream()\n+              .collect(Collectors.toMap(e -> e.getStudy().getId(), Function.identity()));\n+    }\n+    return studyPermissionsByStudyInfoId;\n+  }\n+\n+  private StudyResponse prepareStudyResponse(\n+      List<SitePermissionEntity> sitePermissions,\n+      Map<String, StudyPermissionEntity> studyPermissionsByStudyInfoId,\n+      Map<StudyEntity, List<SitePermissionEntity>> studyPermissionMap,\n+      Map<String, Long> siteWithInvitedParticipantCountMap,\n+      Map<String, Long> siteWithEnrolledParticipantCountMap) {\n+    List<StudyDetails> studies = new ArrayList<>();\n+    for (Map.Entry<StudyEntity, List<SitePermissionEntity>> entry : studyPermissionMap.entrySet()) {\n+      StudyDetails studyDetail = new StudyDetails();\n+      String studyId = entry.getKey().getId();\n+      studyDetail.setId(studyId);\n+      studyDetail.setCustomId(entry.getKey().getCustomId());\n+      studyDetail.setName(entry.getKey().getName());\n+      studyDetail.setType(entry.getKey().getType());\n+      studyDetail.setTotalSitesCount((long) entry.getValue().size());\n+\n+      if (studyPermissionsByStudyInfoId.get(studyId) != null) {\n+        Integer studyEditPermission =\n+            studyPermissionsByStudyInfoId.get(entry.getKey().getId()).getEdit();\n+        studyDetail.setStudyPermission(\n+            studyEditPermission == VIEW_VALUE ? READ_PERMISSION : READ_AND_EDIT_PERMISSION);\n+        studyDetail.setStudyPermission(studyEditPermission);\n+      }\n+\n+      calculateEnrollmentPercentage(\n+          siteWithInvitedParticipantCountMap,\n+          siteWithEnrolledParticipantCountMap,\n+          entry,\n+          studyDetail);\n+      studies.add(studyDetail);\n+    }\n+\n+    StudyResponse studyResponse =\n+        new StudyResponse(MessageCode.GET_STUDIES_SUCCESS, studies, sitePermissions.size());\n+    logger.exit(String.format(\"total studies=%d\", studyResponse.getStudies().size()));\n+    return studyResponse;\n+  }\n+\n+  private void calculateEnrollmentPercentage(\n+      Map<String, Long> siteWithInvitedParticipantCountMap,\n+      Map<String, Long> siteWithEnrolledParticipantCountMap,\n+      Map.Entry<StudyEntity, List<SitePermissionEntity>> entry,\n+      StudyDetails studyDetail) {\n+    Long studyInvitedCount = 0L;\n+    Long studyEnrolledCount = 0L;\n+    for (SitePermissionEntity sitePermission : entry.getValue()) {\n+      studyInvitedCount =\n+          getStudyInvitedCount(\n+              siteWithInvitedParticipantCountMap, entry, studyInvitedCount, sitePermission);\n+\n+      studyEnrolledCount =\n+          studyEnrolledCount\n+              + siteWithEnrolledParticipantCountMap.get(sitePermission.getSite().getId());\n+    }\n+\n+    studyDetail.setEnrolled(studyEnrolledCount);\n+    studyDetail.setInvited(studyInvitedCount);\n+    if (studyDetail.getInvited() != 0 && studyDetail.getInvited() >= studyDetail.getEnrolled()) {\n+      Double percentage =\n+          (Double.valueOf(studyDetail.getEnrolled()) * 100)\n+              / Double.valueOf(studyDetail.getInvited());\n+      studyDetail.setEnrollmentPercentage(percentage);\n+    }\n+  }\n+\n+  private Long getStudyInvitedCount(\n+      Map<String, Long> siteWithInvitedParticipantCountMap,\n+      Map.Entry<StudyEntity, List<SitePermissionEntity>> entry,\n+      Long studyInvitedCount,\n+      SitePermissionEntity sitePermission) {\n+    String siteId = sitePermission.getSite().getId();\n+    String studyType = entry.getKey().getType();\n+    if (siteWithInvitedParticipantCountMap.get(siteId) != null && studyType.equals(CLOSE_STUDY)) {\n+      studyInvitedCount = studyInvitedCount + siteWithInvitedParticipantCountMap.get(siteId);\n+    }\n+\n+    if (studyType.equals(OPEN_STUDY)) {\n+      studyInvitedCount = studyInvitedCount + sitePermission.getSite().getTargetEnrollment();", "originalCommit": "ac1b133e7f76db791900e787e9c1c599df6d5f94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg2MDk5Mg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/637#discussion_r459860992", "bodyText": "Changed to \"+=\" operator.", "author": "monica-BTC", "createdAt": "2020-07-24T05:41:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY1OTUxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2MDI2MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/637#discussion_r459660260", "bodyText": "shouldReturnStudyNotFound", "author": "saminguyen", "createdAt": "2020-07-23T18:54:01Z", "path": "participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/StudyControllerTest.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.controller;\n+\n+import static org.junit.Assert.assertNotNull;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;\n+import static org.springframework.test.web.servlet.result.MockMvcResultHandlers.print;\n+import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.jsonPath;\n+import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;\n+\n+import java.util.Collections;\n+\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.HttpHeaders;\n+import org.springframework.http.MediaType;\n+\n+import com.google.cloud.healthcare.fdamystudies.common.ApiEndpoint;\n+import com.google.cloud.healthcare.fdamystudies.common.BaseMockIT;\n+import com.google.cloud.healthcare.fdamystudies.common.ErrorCode;\n+import com.google.cloud.healthcare.fdamystudies.common.IdGenerator;\n+import com.google.cloud.healthcare.fdamystudies.common.TestConstants;\n+import com.google.cloud.healthcare.fdamystudies.helper.TestDataHelper;\n+import com.google.cloud.healthcare.fdamystudies.model.AppEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.ParticipantRegistrySiteEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.ParticipantStudyEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.SiteEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.StudyEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.UserRegAdminEntity;\n+import com.google.cloud.healthcare.fdamystudies.service.StudyService;\n+\n+public class StudyControllerTest extends BaseMockIT {\n+\n+  @Autowired private StudyService studyService;\n+\n+  @Autowired private StudyController controller;\n+\n+  @Autowired private TestDataHelper testDataHelper;\n+\n+  private UserRegAdminEntity userRegAdminEntity;\n+\n+  private SiteEntity siteEntity;\n+\n+  private StudyEntity studyEntity;\n+\n+  private ParticipantRegistrySiteEntity participantRegistrySiteEntity;\n+\n+  private ParticipantStudyEntity participantStudyEntity;\n+\n+  private AppEntity appEntity;\n+\n+  @BeforeEach\n+  public void setUp() {\n+    userRegAdminEntity = testDataHelper.createUserRegAdminEntity();\n+    appEntity = testDataHelper.createAppEntity(userRegAdminEntity);\n+    studyEntity = testDataHelper.createStudyEntity(userRegAdminEntity, appEntity);\n+    siteEntity = testDataHelper.createSiteEntity(studyEntity, userRegAdminEntity, appEntity);\n+    participantRegistrySiteEntity =\n+        testDataHelper.createParticipantRegistrySite(siteEntity, studyEntity);\n+    participantStudyEntity =\n+        testDataHelper.createParticipantStudyEntity(\n+            siteEntity, studyEntity, participantRegistrySiteEntity);\n+  }\n+\n+  @Test\n+  public void contextLoads() {\n+    assertNotNull(controller);\n+    assertNotNull(mockMvc);\n+    assertNotNull(studyService);\n+  }\n+\n+  @Test\n+  public void shouldReturnStudies() throws Exception {\n+    HttpHeaders headers = newCommonHeaders();\n+    headers.add(TestConstants.USER_ID_HEADER, userRegAdminEntity.getId());\n+\n+    mockMvc\n+        .perform(\n+            get(ApiEndpoint.GET_STUDIES.getPath()).headers(headers).contextPath(getContextPath()))\n+        .andDo(print())\n+        .andExpect(status().isOk())\n+        .andExpect(jsonPath(\"$.studies\").isArray())\n+        .andExpect(jsonPath(\"$.studies[0].id\").isNotEmpty())\n+        .andExpect(jsonPath(\"$.sitePermissionCount\").value(1));\n+  }\n+\n+  @Test\n+  public void shouldReturnBadRequestForGetStudies() throws Exception {\n+    HttpHeaders headers = newCommonHeaders();\n+\n+    mockMvc\n+        .perform(\n+            get(ApiEndpoint.GET_STUDIES.getPath()).headers(headers).contextPath(getContextPath()))\n+        .andDo(print())\n+        .andExpect(status().isBadRequest())\n+        .andExpect(jsonPath(\"$.violations\").isArray())\n+        .andExpect(jsonPath(\"$.violations[0].path\").value(\"userId\"))\n+        .andExpect(jsonPath(\"$.violations[0].message\").value(\"header is required\"));\n+  }\n+\n+  @Test\n+  public void shouldNotReturnStudies() throws Exception {", "originalCommit": "ac1b133e7f76db791900e787e9c1c599df6d5f94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg2MTA3Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/637#discussion_r459861073", "bodyText": "Changed to shouldReturnStudyNotFound.", "author": "monica-BTC", "createdAt": "2020-07-24T05:41:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2MDI2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2MDQ1Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/637#discussion_r459660456", "bodyText": "check for expected array length", "author": "saminguyen", "createdAt": "2020-07-23T18:54:22Z", "path": "participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/StudyControllerTest.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.controller;\n+\n+import static org.junit.Assert.assertNotNull;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;\n+import static org.springframework.test.web.servlet.result.MockMvcResultHandlers.print;\n+import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.jsonPath;\n+import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;\n+\n+import java.util.Collections;\n+\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.HttpHeaders;\n+import org.springframework.http.MediaType;\n+\n+import com.google.cloud.healthcare.fdamystudies.common.ApiEndpoint;\n+import com.google.cloud.healthcare.fdamystudies.common.BaseMockIT;\n+import com.google.cloud.healthcare.fdamystudies.common.ErrorCode;\n+import com.google.cloud.healthcare.fdamystudies.common.IdGenerator;\n+import com.google.cloud.healthcare.fdamystudies.common.TestConstants;\n+import com.google.cloud.healthcare.fdamystudies.helper.TestDataHelper;\n+import com.google.cloud.healthcare.fdamystudies.model.AppEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.ParticipantRegistrySiteEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.ParticipantStudyEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.SiteEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.StudyEntity;\n+import com.google.cloud.healthcare.fdamystudies.model.UserRegAdminEntity;\n+import com.google.cloud.healthcare.fdamystudies.service.StudyService;\n+\n+public class StudyControllerTest extends BaseMockIT {\n+\n+  @Autowired private StudyService studyService;\n+\n+  @Autowired private StudyController controller;\n+\n+  @Autowired private TestDataHelper testDataHelper;\n+\n+  private UserRegAdminEntity userRegAdminEntity;\n+\n+  private SiteEntity siteEntity;\n+\n+  private StudyEntity studyEntity;\n+\n+  private ParticipantRegistrySiteEntity participantRegistrySiteEntity;\n+\n+  private ParticipantStudyEntity participantStudyEntity;\n+\n+  private AppEntity appEntity;\n+\n+  @BeforeEach\n+  public void setUp() {\n+    userRegAdminEntity = testDataHelper.createUserRegAdminEntity();\n+    appEntity = testDataHelper.createAppEntity(userRegAdminEntity);\n+    studyEntity = testDataHelper.createStudyEntity(userRegAdminEntity, appEntity);\n+    siteEntity = testDataHelper.createSiteEntity(studyEntity, userRegAdminEntity, appEntity);\n+    participantRegistrySiteEntity =\n+        testDataHelper.createParticipantRegistrySite(siteEntity, studyEntity);\n+    participantStudyEntity =\n+        testDataHelper.createParticipantStudyEntity(\n+            siteEntity, studyEntity, participantRegistrySiteEntity);\n+  }\n+\n+  @Test\n+  public void contextLoads() {\n+    assertNotNull(controller);\n+    assertNotNull(mockMvc);\n+    assertNotNull(studyService);\n+  }\n+\n+  @Test\n+  public void shouldReturnStudies() throws Exception {\n+    HttpHeaders headers = newCommonHeaders();\n+    headers.add(TestConstants.USER_ID_HEADER, userRegAdminEntity.getId());\n+\n+    mockMvc\n+        .perform(\n+            get(ApiEndpoint.GET_STUDIES.getPath()).headers(headers).contextPath(getContextPath()))\n+        .andDo(print())\n+        .andExpect(status().isOk())\n+        .andExpect(jsonPath(\"$.studies\").isArray())", "originalCommit": "ac1b133e7f76db791900e787e9c1c599df6d5f94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg2MTE4NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/637#discussion_r459861185", "bodyText": "Checked for array length.", "author": "monica-BTC", "createdAt": "2020-07-24T05:41:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2MDQ1Ng=="}], "type": "inlineReview"}, {"oid": "d4bae1b9b64a537cfec3cd996b7e64b9e79cb7df", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/d4bae1b9b64a537cfec3cd996b7e64b9e79cb7df", "message": "Fixed PR comments\n\nFixed PR comments", "committedDate": "2020-07-24T05:36:07Z", "type": "commit"}, {"oid": "25d72b9aa7b7eba531130d73309d504c26d49fb9", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/25d72b9aa7b7eba531130d73309d504c26d49fb9", "message": "Fixed build issue\n\nFixed build issue", "committedDate": "2020-07-24T05:45:05Z", "type": "commit"}, {"oid": "cfff6e9707178b73b26482c4cc4134a682a88d07", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/cfff6e9707178b73b26482c4cc4134a682a88d07", "message": "Added Required Condition\n\nAdded Required Condition", "committedDate": "2020-08-06T11:07:19Z", "type": "commit"}, {"oid": "97b1457a87f4ef2e43171ad8467fc4256d5301f2", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/97b1457a87f4ef2e43171ad8467fc4256d5301f2", "message": "Merge branch 'develop' into participant-manager-studies-endpoint", "committedDate": "2020-08-11T05:46:46Z", "type": "commit"}, {"oid": "3b899b879ecffae021042351a8394afcd8e54266", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/3b899b879ecffae021042351a8394afcd8e54266", "message": "resolved conflict errors\n\nresolved conflict errors", "committedDate": "2020-08-11T05:50:49Z", "type": "commit"}, {"oid": "0aa82de92af53f054ac42d585135de74dae16c22", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/0aa82de92af53f054ac42d585135de74dae16c22", "message": "Merge branch 'develop' into participant-manager-studies-endpoint", "committedDate": "2020-08-11T13:21:18Z", "type": "commit"}]}