{"pr_number": 1399, "pr_title": "add initial incomplete set of k8s secrets", "pr_createdAt": "2020-10-14T21:40:47Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA1Mzc1MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505053750", "bodyText": "missing participant-manager-datastore", "author": "zohrehj", "createdAt": "2020-10-14T23:11:32Z", "path": "deployment.hcl", "diffHunk": "@@ -747,6 +747,155 @@ provider \"kubernetes\" {\n   client_key             = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.client_key)\n   cluster_ca_certificate = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.cluster_ca_certificate)\n }\n+\n+locals {\n+  apps = [\n+    \"auth-server\",\n+    \"hydra\",\n+    \"response-datastore\",\n+    \"study-builder\",\n+    \"study-datastore\",\n+    \"participant-consent-datastore\",\n+    \"participant-enroll-datastore\",\n+    \"participant-user-datastore\",\n+    \"participant-manager\",", "originalCommit": "b8d644712cb60e8057a478961ca3462427897960", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA5Nzg4MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505097881", "bodyText": "The secret is actually called auto-participant-manager-db-password and auto-participant-manager-db-user, should we change those to be auto-participant-manager-datastore-db-user/password?", "author": "xingao267", "createdAt": "2020-10-15T00:36:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA1Mzc1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA1NjA2MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505056061", "bodyText": "participant-manager does need db access credentials, but participant-manager-datastore needs access", "author": "zohrehj", "createdAt": "2020-10-14T23:14:48Z", "path": "deployment.hcl", "diffHunk": "@@ -747,6 +747,155 @@ provider \"kubernetes\" {\n   client_key             = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.client_key)\n   cluster_ca_certificate = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.cluster_ca_certificate)\n }\n+\n+locals {\n+  apps = [\n+    \"auth-server\",\n+    \"hydra\",\n+    \"response-datastore\",\n+    \"study-builder\",\n+    \"study-datastore\",\n+    \"participant-consent-datastore\",\n+    \"participant-enroll-datastore\",\n+    \"participant-user-datastore\",\n+    \"participant-manager\",\n+  ]\n+  service_account_ids = [\n+    \"auth-server-gke-sa\",\n+    \"hydra-gke-sa\",\n+    \"response-datastore-gke-sa\",\n+    \"study-builder-gke-sa\",\n+    \"study-datastore-gke-sa\",\n+    \"consent-datastore-gke-sa\",\n+    \"enroll-datastore-gke-sa\",\n+    \"user-datastore-gke-sa\",\n+    \"manager-gke-sa\",\n+  ]\n+  apps_db_names = {\n+    \"auth-server\"                   = \"?\"\n+    \"hydra\"                         = \"?\"\n+    \"response-datastore\"            = \"?\"\n+    \"study-builder\"                 = \"?\"\n+    \"study-datastore\"               = \"?\"\n+    \"participant-consent-datastore\" = \"?\"\n+    \"participant-enroll-datastore\"  = \"?\"\n+    \"participant-user-datastore\"    = \"?\"\n+    \"participant-manager\"           = \"?\"", "originalCommit": "b8d644712cb60e8057a478961ca3462427897960", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA1OTI4MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505059281", "bodyText": "I think this is no longer needed. Now each app (except hydra) has a client id and secret, that will be later registered in hydra.\nAUTH SERVER, PARTICIPANT MANAGER AND MOBILE APPS (end user facing) should share the same CLIENT_ID and SECRET_KEY.", "author": "zohrehj", "createdAt": "2020-10-14T23:19:28Z", "path": "deployment.hcl", "diffHunk": "@@ -747,6 +747,155 @@ provider \"kubernetes\" {\n   client_key             = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.client_key)\n   cluster_ca_certificate = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.cluster_ca_certificate)\n }\n+\n+locals {\n+  apps = [\n+    \"auth-server\",\n+    \"hydra\",\n+    \"response-datastore\",\n+    \"study-builder\",\n+    \"study-datastore\",\n+    \"participant-consent-datastore\",\n+    \"participant-enroll-datastore\",\n+    \"participant-user-datastore\",\n+    \"participant-manager\",\n+  ]\n+  service_account_ids = [\n+    \"auth-server-gke-sa\",\n+    \"hydra-gke-sa\",\n+    \"response-datastore-gke-sa\",\n+    \"study-builder-gke-sa\",\n+    \"study-datastore-gke-sa\",\n+    \"consent-datastore-gke-sa\",\n+    \"enroll-datastore-gke-sa\",\n+    \"user-datastore-gke-sa\",\n+    \"manager-gke-sa\",\n+  ]\n+  apps_db_names = {\n+    \"auth-server\"                   = \"?\"\n+    \"hydra\"                         = \"?\"\n+    \"response-datastore\"            = \"?\"\n+    \"study-builder\"                 = \"?\"\n+    \"study-datastore\"               = \"?\"\n+    \"participant-consent-datastore\" = \"?\"\n+    \"participant-enroll-datastore\"  = \"?\"\n+    \"participant-user-datastore\"    = \"?\"\n+    \"participant-manager\"           = \"?\"\n+  }\n+  # App codes for auth server authentication.\n+  auth_server_app_codes = [\n+    \"ma\",       # Mobile App\n+    \"urs\",      # User Registration Server\n+    \"rs\",       # Response Server\n+    \"builder\",  # Study Builder\n+  ]", "originalCommit": "b8d644712cb60e8057a478961ca3462427897960", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY1Mjc3MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505652770", "bodyText": "One suggestion is to group them into client-side-secrets", "author": "zohrehj", "createdAt": "2020-10-15T15:50:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA1OTI4MQ=="}], "type": "inlineReview"}, {"oid": "6beba1a35551655ff6a77cdd5768d3c34d4e0571", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/6beba1a35551655ff6a77cdd5768d3c34d4e0571", "message": "add initial incomplete set of k8s secrets", "committedDate": "2020-10-15T17:33:06Z", "type": "commit"}, {"oid": "941310f8552f9e8c39e4a40edbff2513698d9107", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/941310f8552f9e8c39e4a40edbff2513698d9107", "message": "update", "committedDate": "2020-10-15T17:38:51Z", "type": "commit"}, {"oid": "4e186fefc4caf2c32882f2ead4336a9cf8250754", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/4e186fefc4caf2c32882f2ead4336a9cf8250754", "message": "fix key", "committedDate": "2020-10-15T17:38:55Z", "type": "commit"}, {"oid": "4e186fefc4caf2c32882f2ead4336a9cf8250754", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/4e186fefc4caf2c32882f2ead4336a9cf8250754", "message": "fix key", "committedDate": "2020-10-15T17:38:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcxNjYzOQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505716639", "bodyText": "what is the purpose of this password? and where is its corresponding user?", "author": "zohrehj", "createdAt": "2020-10-15T17:29:05Z", "path": "deployment.hcl", "diffHunk": "@@ -162,12 +162,8 @@ template \"project_secrets\" {\n           secret_id = \"manual-ios-certificate-password\"\n         },\n         {\n-          secret_id   = \"auto-auth-server-db-password\"\n-          secret_data = \"$${random_password.passwords[\\\"auth_server_db_password\\\"].result}\"\n-        },\n-        {\n-          secret_id   = \"auto-auth-server-db-user\"\n-          secret_data = \"$${random_string.strings[\\\"auth_server_db_user\\\"].result}\"\n+          secret_id   = \"auto-mystudies-sql-default-user-password\"\n+          secret_data = \"$${random_password.passwords[\\\"mystudies_sql_default_user_password\\\"].result}\"", "originalCommit": "dffbfdf0f51dd245c97994fc0b829eab55eb27f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc3NjQ4MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505776481", "bodyText": "addressed offline", "author": "xingao267", "createdAt": "2020-10-15T19:07:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcxNjYzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyMjI5NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505722294", "bodyText": "maybe these should be renamed to include db in the name?\ne.g. dbusername and dbpassword", "author": "zohrehj", "createdAt": "2020-10-15T17:38:18Z", "path": "deployment.hcl", "diffHunk": "@@ -747,6 +787,145 @@ provider \"kubernetes\" {\n   client_key             = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.client_key)\n   cluster_ca_certificate = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.cluster_ca_certificate)\n }\n+\n+locals {\n+  # hydra is treated separately.\n+  apps = [\n+    \"auth-server\",\n+    \"response-datastore\",\n+    \"study-builder\",\n+    \"study-datastore\",\n+    \"participant-consent-datastore\",\n+    \"participant-enroll-datastore\",\n+    \"participant-user-datastore\",\n+    \"participant-manager-datastore\",\n+  ]\n+  apps_db_names = {\n+    \"auth-server\"                   = \"oauth_server_hydra\"\n+    \"response-datastore\"            = \"mystudies_response_server\"\n+    \"study-builder\"                 = \"fda_hphc\"\n+    \"study-datastore\"               = \"fda_hphc\"\n+    \"participant-consent-datastore\" = \"mystudies_participant_datastore\"\n+    \"participant-enroll-datastore\"  = \"mystudies_participant_datastore\"\n+    \"participant-user-datastore\"    = \"mystudies_participant_datastore\"\n+    \"participant-manager-datastore\" = \"mystudies_participant_datastore\"\n+  }\n+  service_account_ids = [\n+    \"auth-server-gke-sa\",\n+    \"hydra-gke-sa\",\n+    \"response-datastore-gke-sa\",\n+    \"study-builder-gke-sa\",\n+    \"study-datastore-gke-sa\",\n+    \"consent-datastore-gke-sa\",\n+    \"enroll-datastore-gke-sa\",\n+    \"user-datastore-gke-sa\",\n+    \"participant-manager-gke-sa\",\n+  ]\n+}\n+\n+# Data sources from Secret Manager.\n+data \"google_secret_manager_secret_version\" \"secrets\" {\n+  provider = google-beta\n+  project  = \"{{$prefix}}-{{$env}}-secrets\"\n+  secret   = each.key\n+\n+  for_each = toset(concat(\n+    [\n+      \"manual-study-builder-user\",\n+      \"manual-study-builder-password\",\n+      \"manual-mystudies-email-address\",\n+      \"manual-mystudies-email-password\",\n+      \"manual-mobile-app-appid\",\n+      \"manual-android-bundle-id\",\n+      \"manual-android-server-key\",\n+      \"manual-ios-bundle-id\",\n+      \"manual-ios-certificate\",\n+      \"manual-ios-certificate-password\",\n+      \"auto-hydra-db-password\",\n+      \"auto-hydra-db-user\",\n+    ],\n+    formatlist(\"auto-%s-db-user\", local.apps),\n+    formatlist(\"auto-%s-db-password\", local.apps),\n+    formatlist(\"auto-%s-client-id\", local.apps),\n+    formatlist(\"auto-%s-secret-key\", local.apps))\n+  )\n+}\n+\n+# Shared secrets.\n+resource \"kubernetes_secret\" \"shared_secrets\" {\n+  metadata {\n+    name = \"shared-secrets\"\n+  }\n+\n+  data = {\n+    gcp_bucket_name = \"{{$prefix}}-{{$env}}-mystudies-consent-documents\"\n+    base_url        = \"https://{{$prefix}}-{{$env}}.{{$domain}}.\"\n+  }\n+}\n+\n+# App credentials.\n+resource \"kubernetes_secret\" \"apps_credentials\" {\n+  for_each = toset(local.apps)\n+\n+  metadata {\n+    name = \"$${each.key}-credentials\"\n+  }\n+\n+  data = {\n+    username   = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-db-user\"].secret_data", "originalCommit": "dffbfdf0f51dd245c97994fc0b829eab55eb27f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc3NjM3Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505776376", "bodyText": "done", "author": "xingao267", "createdAt": "2020-10-15T19:07:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyMjI5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyMzY2Mg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505723662", "bodyText": "smtp_hostname, from_email_domain and smtp_use_ip_whitelist\nthe values should come from 'manual-' secrets.", "author": "zohrehj", "createdAt": "2020-10-15T17:40:34Z", "path": "deployment.hcl", "diffHunk": "@@ -747,6 +787,145 @@ provider \"kubernetes\" {\n   client_key             = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.client_key)\n   cluster_ca_certificate = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.cluster_ca_certificate)\n }\n+\n+locals {\n+  # hydra is treated separately.\n+  apps = [\n+    \"auth-server\",\n+    \"response-datastore\",\n+    \"study-builder\",\n+    \"study-datastore\",\n+    \"participant-consent-datastore\",\n+    \"participant-enroll-datastore\",\n+    \"participant-user-datastore\",\n+    \"participant-manager-datastore\",\n+  ]\n+  apps_db_names = {\n+    \"auth-server\"                   = \"oauth_server_hydra\"\n+    \"response-datastore\"            = \"mystudies_response_server\"\n+    \"study-builder\"                 = \"fda_hphc\"\n+    \"study-datastore\"               = \"fda_hphc\"\n+    \"participant-consent-datastore\" = \"mystudies_participant_datastore\"\n+    \"participant-enroll-datastore\"  = \"mystudies_participant_datastore\"\n+    \"participant-user-datastore\"    = \"mystudies_participant_datastore\"\n+    \"participant-manager-datastore\" = \"mystudies_participant_datastore\"\n+  }\n+  service_account_ids = [\n+    \"auth-server-gke-sa\",\n+    \"hydra-gke-sa\",\n+    \"response-datastore-gke-sa\",\n+    \"study-builder-gke-sa\",\n+    \"study-datastore-gke-sa\",\n+    \"consent-datastore-gke-sa\",\n+    \"enroll-datastore-gke-sa\",\n+    \"user-datastore-gke-sa\",\n+    \"participant-manager-gke-sa\",\n+  ]\n+}\n+\n+# Data sources from Secret Manager.\n+data \"google_secret_manager_secret_version\" \"secrets\" {\n+  provider = google-beta\n+  project  = \"{{$prefix}}-{{$env}}-secrets\"\n+  secret   = each.key\n+\n+  for_each = toset(concat(\n+    [\n+      \"manual-study-builder-user\",\n+      \"manual-study-builder-password\",\n+      \"manual-mystudies-email-address\",\n+      \"manual-mystudies-email-password\",\n+      \"manual-mobile-app-appid\",\n+      \"manual-android-bundle-id\",\n+      \"manual-android-server-key\",\n+      \"manual-ios-bundle-id\",\n+      \"manual-ios-certificate\",\n+      \"manual-ios-certificate-password\",\n+      \"auto-hydra-db-password\",\n+      \"auto-hydra-db-user\",\n+    ],\n+    formatlist(\"auto-%s-db-user\", local.apps),\n+    formatlist(\"auto-%s-db-password\", local.apps),\n+    formatlist(\"auto-%s-client-id\", local.apps),\n+    formatlist(\"auto-%s-secret-key\", local.apps))\n+  )\n+}\n+\n+# Shared secrets.\n+resource \"kubernetes_secret\" \"shared_secrets\" {\n+  metadata {\n+    name = \"shared-secrets\"\n+  }\n+\n+  data = {\n+    gcp_bucket_name = \"{{$prefix}}-{{$env}}-mystudies-consent-documents\"\n+    base_url        = \"https://{{$prefix}}-{{$env}}.{{$domain}}.\"\n+  }\n+}\n+\n+# App credentials.\n+resource \"kubernetes_secret\" \"apps_credentials\" {\n+  for_each = toset(local.apps)\n+\n+  metadata {\n+    name = \"$${each.key}-credentials\"\n+  }\n+\n+  data = {\n+    username   = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-db-user\"].secret_data\n+    password   = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-db-password\"].secret_data\n+    client_id  = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-client-id\"].secret_data\n+    secret_key = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-secret-key\"].secret_data\n+    dbname     = local.apps_db_names[each.key]\n+  }\n+}\n+\n+# Hydra credentials.\n+resource \"kubernetes_secret\" \"hydra_credentials\" {\n+\n+  metadata {\n+    name = \"hydra-credentials\"\n+  }\n+\n+  data = {\n+    username = data.google_secret_manager_secret_version.secrets[\"auto-hydra-db-user\"].secret_data\n+    password = data.google_secret_manager_secret_version.secrets[\"auto-hydra-db-password\"].secret_data\n+    dbname   = \"hydra\"\n+  }\n+}\n+\n+# Email credentials.\n+resource \"kubernetes_secret\" \"email_credentials\" {\n+  metadata {\n+    name = \"email-credentials\"\n+  }\n+\n+  data = {\n+    email_address         = data.google_secret_manager_secret_version.secrets[\"manual-mystudies-email-address\"].secret_data\n+    email_password        = data.google_secret_manager_secret_version.secrets[\"manual-mystudies-email-password\"].secret_data\n+    contact_email_address = \"?\"\n+    from_email_address    = \"?\"\n+    smtp_host             = \"?\"", "originalCommit": "4e186fefc4caf2c32882f2ead4336a9cf8250754", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc3NjMxNA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505776314", "bodyText": "Added a TODO to add those secrets and fill in references", "author": "xingao267", "createdAt": "2020-10-15T19:07:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyMzY2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyNTE3OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505725179", "bodyText": "auth server client-id and secret-key are shared with participant-manager and mobile apps", "author": "zohrehj", "createdAt": "2020-10-15T17:43:07Z", "path": "deployment.hcl", "diffHunk": "@@ -182,96 +178,132 @@ template \"project_secrets\" {\n           secret_data = \"$${random_password.system_secrets[\\\"hydra_system_secret\\\"].result}\"\n         },\n         {\n-          secret_id   = \"auto-mystudies-ma-client-id\"\n-          secret_data = \"$${random_string.strings[\\\"mystudies_ma_client_id\\\"].result}\"\n+          secret_id   = \"auto-auth-server-db-user\"\n+          secret_data = \"$${random_string.strings[\\\"auth_server_db_user\\\"].result}\"\n         },\n         {\n-          secret_id   = \"auto-mystudies-ma-secret-key\"\n-          secret_data = \"$${random_password.passwords[\\\"mystudies_ma_secret_key\\\"].result}\"\n+          secret_id   = \"auto-auth-server-db-password\"\n+          secret_data = \"$${random_password.passwords[\\\"auth_server_db_password\\\"].result}\"\n         },\n         {\n-          secret_id   = \"auto-mystudies-rs-client-id\"\n-          secret_data = \"$${random_string.strings[\\\"mystudies_rs_client_id\\\"].result}\"\n+          secret_id   = \"auto-auth-server-client-id\"\n+          secret_data = \"$${random_string.strings[\\\"auth_server_client_id\\\"].result}\"\n         },\n         {\n-          secret_id   = \"auto-mystudies-rs-secret-key\"\n-          secret_data = \"$${random_password.passwords[\\\"mystudies_rs_secret_key\\\"].result}\"\n+          secret_id   = \"auto-auth-server-secret-key\"\n+          secret_data = \"$${random_password.passwords[\\\"auth_server_secret_key\\\"].result}\"\n         },", "originalCommit": "4e186fefc4caf2c32882f2ead4336a9cf8250754", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc3NjE1Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505776153", "bodyText": "done", "author": "xingao267", "createdAt": "2020-10-15T19:06:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcyNTE3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc2NzY2NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505767665", "bodyText": "can you please include system_secret for hydra in here as well?", "author": "zohrehj", "createdAt": "2020-10-15T18:51:04Z", "path": "deployment.hcl", "diffHunk": "@@ -747,6 +787,145 @@ provider \"kubernetes\" {\n   client_key             = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.client_key)\n   cluster_ca_certificate = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.cluster_ca_certificate)\n }\n+\n+locals {\n+  # hydra is treated separately.\n+  apps = [\n+    \"auth-server\",\n+    \"response-datastore\",\n+    \"study-builder\",\n+    \"study-datastore\",\n+    \"participant-consent-datastore\",\n+    \"participant-enroll-datastore\",\n+    \"participant-user-datastore\",\n+    \"participant-manager-datastore\",\n+  ]\n+  apps_db_names = {\n+    \"auth-server\"                   = \"oauth_server_hydra\"\n+    \"response-datastore\"            = \"mystudies_response_server\"\n+    \"study-builder\"                 = \"fda_hphc\"\n+    \"study-datastore\"               = \"fda_hphc\"\n+    \"participant-consent-datastore\" = \"mystudies_participant_datastore\"\n+    \"participant-enroll-datastore\"  = \"mystudies_participant_datastore\"\n+    \"participant-user-datastore\"    = \"mystudies_participant_datastore\"\n+    \"participant-manager-datastore\" = \"mystudies_participant_datastore\"\n+  }\n+  service_account_ids = [\n+    \"auth-server-gke-sa\",\n+    \"hydra-gke-sa\",\n+    \"response-datastore-gke-sa\",\n+    \"study-builder-gke-sa\",\n+    \"study-datastore-gke-sa\",\n+    \"consent-datastore-gke-sa\",\n+    \"enroll-datastore-gke-sa\",\n+    \"user-datastore-gke-sa\",\n+    \"participant-manager-gke-sa\",\n+  ]\n+}\n+\n+# Data sources from Secret Manager.\n+data \"google_secret_manager_secret_version\" \"secrets\" {\n+  provider = google-beta\n+  project  = \"{{$prefix}}-{{$env}}-secrets\"\n+  secret   = each.key\n+\n+  for_each = toset(concat(\n+    [\n+      \"manual-study-builder-user\",\n+      \"manual-study-builder-password\",\n+      \"manual-mystudies-email-address\",\n+      \"manual-mystudies-email-password\",\n+      \"manual-mobile-app-appid\",\n+      \"manual-android-bundle-id\",\n+      \"manual-android-server-key\",\n+      \"manual-ios-bundle-id\",\n+      \"manual-ios-certificate\",\n+      \"manual-ios-certificate-password\",\n+      \"auto-hydra-db-password\",\n+      \"auto-hydra-db-user\",\n+    ],\n+    formatlist(\"auto-%s-db-user\", local.apps),\n+    formatlist(\"auto-%s-db-password\", local.apps),\n+    formatlist(\"auto-%s-client-id\", local.apps),\n+    formatlist(\"auto-%s-secret-key\", local.apps))\n+  )\n+}\n+\n+# Shared secrets.\n+resource \"kubernetes_secret\" \"shared_secrets\" {\n+  metadata {\n+    name = \"shared-secrets\"\n+  }\n+\n+  data = {\n+    gcp_bucket_name = \"{{$prefix}}-{{$env}}-mystudies-consent-documents\"\n+    base_url        = \"https://{{$prefix}}-{{$env}}.{{$domain}}.\"\n+  }\n+}\n+\n+# App credentials.\n+resource \"kubernetes_secret\" \"apps_credentials\" {\n+  for_each = toset(local.apps)\n+\n+  metadata {\n+    name = \"$${each.key}-credentials\"\n+  }\n+\n+  data = {\n+    username   = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-db-user\"].secret_data\n+    password   = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-db-password\"].secret_data\n+    client_id  = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-client-id\"].secret_data\n+    secret_key = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-secret-key\"].secret_data\n+    dbname     = local.apps_db_names[each.key]\n+  }\n+}\n+\n+# Hydra credentials.\n+resource \"kubernetes_secret\" \"hydra_credentials\" {\n+\n+  metadata {\n+    name = \"hydra-credentials\"\n+  }\n+\n+  data = {\n+    username = data.google_secret_manager_secret_version.secrets[\"auto-hydra-db-user\"].secret_data\n+    password = data.google_secret_manager_secret_version.secrets[\"auto-hydra-db-password\"].secret_data\n+    dbname   = \"hydra\"", "originalCommit": "4e186fefc4caf2c32882f2ead4336a9cf8250754", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc3NjAzMg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505776032", "bodyText": "done", "author": "xingao267", "createdAt": "2020-10-15T19:06:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc2NzY2NQ=="}], "type": "inlineReview"}, {"oid": "6c364940ac4e50d5c845ef1aec8e26da5dd8c3f9", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/6c364940ac4e50d5c845ef1aec8e26da5dd8c3f9", "message": "add client side credentials", "committedDate": "2020-10-15T19:05:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc3Njc5Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505776793", "bodyText": "dbusername and dbpassword", "author": "zohrehj", "createdAt": "2020-10-15T19:07:56Z", "path": "deployment.hcl", "diffHunk": "@@ -747,6 +787,161 @@ provider \"kubernetes\" {\n   client_key             = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.client_key)\n   cluster_ca_certificate = base64decode(data.google_container_cluster.gke_cluster.master_auth.0.cluster_ca_certificate)\n }\n+\n+locals {\n+  # hydra is treated separately.\n+  apps = [\n+    \"auth-server\",\n+    \"response-datastore\",\n+    \"study-builder\",\n+    \"study-datastore\",\n+    \"participant-consent-datastore\",\n+    \"participant-enroll-datastore\",\n+    \"participant-user-datastore\",\n+    \"participant-manager-datastore\",\n+  ]\n+  apps_db_names = {\n+    \"auth-server\"                   = \"oauth_server_hydra\"\n+    \"response-datastore\"            = \"mystudies_response_server\"\n+    \"study-builder\"                 = \"fda_hphc\"\n+    \"study-datastore\"               = \"fda_hphc\"\n+    \"participant-consent-datastore\" = \"mystudies_participant_datastore\"\n+    \"participant-enroll-datastore\"  = \"mystudies_participant_datastore\"\n+    \"participant-user-datastore\"    = \"mystudies_participant_datastore\"\n+    \"participant-manager-datastore\" = \"mystudies_participant_datastore\"\n+  }\n+  service_account_ids = [\n+    \"auth-server-gke-sa\",\n+    \"hydra-gke-sa\",\n+    \"response-datastore-gke-sa\",\n+    \"study-builder-gke-sa\",\n+    \"study-datastore-gke-sa\",\n+    \"consent-datastore-gke-sa\",\n+    \"enroll-datastore-gke-sa\",\n+    \"user-datastore-gke-sa\",\n+    \"participant-manager-gke-sa\",\n+  ]\n+}\n+\n+# Data sources from Secret Manager.\n+data \"google_secret_manager_secret_version\" \"secrets\" {\n+  provider = google-beta\n+  project  = \"{{$prefix}}-{{$env}}-secrets\"\n+  secret   = each.key\n+\n+  for_each = toset(concat(\n+    [\n+      \"manual-study-builder-user\",\n+      \"manual-study-builder-password\",\n+      \"manual-mystudies-email-address\",\n+      \"manual-mystudies-email-password\",\n+      \"manual-mobile-app-appid\",\n+      \"manual-android-bundle-id\",\n+      \"manual-android-server-key\",\n+      \"manual-ios-bundle-id\",\n+      \"manual-ios-certificate\",\n+      \"manual-ios-certificate-password\",\n+      \"auto-hydra-db-password\",\n+      \"auto-hydra-db-user\",\n+    ],\n+    formatlist(\"auto-%s-db-user\", local.apps),\n+    formatlist(\"auto-%s-db-password\", local.apps),\n+    formatlist(\"auto-%s-client-id\", local.apps),\n+    formatlist(\"auto-%s-secret-key\", local.apps))\n+  )\n+}\n+\n+# Shared secrets.\n+resource \"kubernetes_secret\" \"shared_secrets\" {\n+  metadata {\n+    name = \"shared-secrets\"\n+  }\n+\n+  data = {\n+    gcp_bucket_name = \"{{$prefix}}-{{$env}}-mystudies-consent-documents\"\n+    base_url        = \"https://{{$prefix}}-{{$env}}.{{$domain}}.\"\n+  }\n+}\n+\n+# App credentials.\n+resource \"kubernetes_secret\" \"apps_credentials\" {\n+  for_each = toset(local.apps)\n+\n+  metadata {\n+    name = \"$${each.key}-credentials\"\n+  }\n+\n+  data = {\n+    dbusername  = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-db-user\"].secret_data\n+    dbpassword  = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-db-password\"].secret_data\n+    client_id   = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-client-id\"].secret_data\n+    secret_key  = data.google_secret_manager_secret_version.secrets[\"auto-$${each.key}-secret-key\"].secret_data\n+    dbname      = local.apps_db_names[each.key]\n+  }\n+}\n+\n+# Client-side credentials.\n+resource \"kubernetes_secret\" \"client_side_credentials\" {\n+\n+  metadata {\n+    name = \"client-side-credentials\"\n+  }\n+\n+  data = {\n+    client_id  = data.google_secret_manager_secret_version.secrets[\"auto-auth-server-client-id\"].secret_data\n+    secret_key = data.google_secret_manager_secret_version.secrets[\"auto-auth-server-secret-key\"].secret_data\n+  }\n+}\n+\n+\n+# Hydra credentials.\n+resource \"kubernetes_secret\" \"hydra_credentials\" {\n+\n+  metadata {\n+    name = \"hydra-credentials\"\n+  }\n+\n+  data = {\n+    username      = data.google_secret_manager_secret_version.secrets[\"auto-hydra-db-user\"].secret_data\n+    password      = data.google_secret_manager_secret_version.secrets[\"auto-hydra-db-password\"].secret_data", "originalCommit": "6c364940ac4e50d5c845ef1aec8e26da5dd8c3f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc3OTMxNg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1399#discussion_r505779316", "bodyText": "done", "author": "xingao267", "createdAt": "2020-10-15T19:12:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc3Njc5Mw=="}], "type": "inlineReview"}, {"oid": "b5d2abebdd0ddb99c008e2c413723ae737ee22e6", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/b5d2abebdd0ddb99c008e2c413723ae737ee22e6", "message": "minor naming", "committedDate": "2020-10-15T19:10:22Z", "type": "commit"}]}