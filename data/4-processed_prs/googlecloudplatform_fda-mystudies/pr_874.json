{"pr_number": 874, "pr_title": "Response Server: Added integration test cases for the ProcessActivityResponseController class ", "pr_createdAt": "2020-09-04T08:47:00Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/874", "timeline": [{"oid": "f5a82983fda530b28c747d4780040c5befed44a6", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/f5a82983fda530b28c747d4780040c5befed44a6", "message": "process activity response controller integration test cases", "committedDate": "2020-09-04T08:38:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ3OTU5NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/874#discussion_r483479594", "bodyText": "[response-server Checks] reported by reviewdog \ud83d\udc36\nMissing a Javadoc comment.", "author": "github-actions", "createdAt": "2020-09-04T08:47:43Z", "path": "response-server-module/response-server-service/src/test/java/com/google/cloud/healthcare/fdamystudies/helper/TestDataHelper.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.helper;\n+\n+import com.google.cloud.healthcare.fdamystudies.common.IdGenerator;\n+import com.google.cloud.healthcare.fdamystudies.model.ParticipantBo;\n+import com.google.cloud.healthcare.fdamystudies.repository.ParticipantBoRepository;\n+import lombok.Getter;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+\n+@Getter\n+@Component\n+public class TestDataHelper {\n+\n+  @Autowired private ParticipantBoRepository participantBoRepository;\n+\n+  public ParticipantBo saveParticipant() {", "originalCommit": "f5a82983fda530b28c747d4780040c5befed44a6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ3OTU5Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/874#discussion_r483479597", "bodyText": "[response-server Checks] reported by reviewdog \ud83d\udc36\nLocal variable name 'StoredResponseBean' must match pattern '^a-z?$'.", "author": "github-actions", "createdAt": "2020-09-04T08:47:44Z", "path": "response-server-module/response-server-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/ProcessActivityResponseControllerTest.java", "diffHunk": "@@ -0,0 +1,383 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.controller;\n+\n+import static com.google.cloud.healthcare.fdamystudies.common.JsonUtils.getObjectMapper;\n+import static com.google.cloud.healthcare.fdamystudies.common.JsonUtils.readJsonFile;\n+import static com.google.cloud.healthcare.fdamystudies.utils.AppConstants.PARTICIPANT_ID_KEY;\n+import static com.google.cloud.healthcare.fdamystudies.utils.AppConstants.PARTICIPANT_TOKEN_IDENTIFIER_KEY;\n+import static com.google.cloud.healthcare.fdamystudies.utils.Constants.ACTIVITY_COLLECTION_NAME_VALUE;\n+import static com.google.cloud.healthcare.fdamystudies.utils.Constants.ACTIVITY_ID_VALUE;\n+import static com.google.cloud.healthcare.fdamystudies.utils.Constants.PARTICIPANT_ID_NOT_EXISTS_MESSAGE;\n+import static com.google.cloud.healthcare.fdamystudies.utils.Constants.QUESTION_KEY_VALUE;\n+import static com.google.cloud.healthcare.fdamystudies.utils.Constants.SITE_ID_VALUE;\n+import static com.google.cloud.healthcare.fdamystudies.utils.Constants.STUDY_COLLECTION_NAME_VALUE;\n+import static com.google.cloud.healthcare.fdamystudies.utils.Constants.STUDY_ID_VALUE;\n+import static com.google.cloud.healthcare.fdamystudies.utils.Constants.SUCCESS;\n+import static com.google.cloud.healthcare.fdamystudies.utils.Constants.USER_ID_HEADER;\n+import static com.google.cloud.healthcare.fdamystudies.utils.Constants.VALID_USER_ID;\n+import static com.google.cloud.healthcare.fdamystudies.utils.ErrorCode.EC_701;\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.Mockito.doNothing;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;\n+import static org.springframework.test.web.servlet.result.MockMvcResultHandlers.print;\n+import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.jsonPath;\n+import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;\n+\n+import com.google.cloud.healthcare.fdamystudies.bean.ActivityResponseBean;\n+import com.google.cloud.healthcare.fdamystudies.bean.StoredResponseBean;\n+import com.google.cloud.healthcare.fdamystudies.common.ApiEndpoint;\n+import com.google.cloud.healthcare.fdamystudies.common.BaseMockIT;\n+import com.google.cloud.healthcare.fdamystudies.common.IdGenerator;\n+import com.google.cloud.healthcare.fdamystudies.common.JsonUtils;\n+import com.google.cloud.healthcare.fdamystudies.dao.CloudFirestoreResponsesDaoImpl;\n+import com.google.cloud.healthcare.fdamystudies.helper.TestDataHelper;\n+import com.google.cloud.healthcare.fdamystudies.model.ParticipantActivitiesBo;\n+import com.google.cloud.healthcare.fdamystudies.model.ParticipantBo;\n+import com.google.cloud.healthcare.fdamystudies.repository.ParticipantActivitiesRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.ParticipantBoRepository;\n+import com.google.cloud.healthcare.fdamystudies.utils.TestUtils;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Captor;\n+import org.skyscreamer.jsonassert.JSONAssert;\n+import org.skyscreamer.jsonassert.JSONCompareMode;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.test.mock.mockito.MockBean;\n+import org.springframework.http.HttpHeaders;\n+import org.springframework.test.annotation.DirtiesContext;\n+import org.springframework.test.web.servlet.MvcResult;\n+\n+@DirtiesContext(classMode = DirtiesContext.ClassMode.AFTER_CLASS)\n+public class ProcessActivityResponseControllerTest extends BaseMockIT {\n+\n+  @Autowired private TestDataHelper testDataHelper;\n+\n+  @Autowired private ParticipantBoRepository participantBoRepository;\n+\n+  private ParticipantBo participantBo;\n+\n+  @MockBean private CloudFirestoreResponsesDaoImpl responsesDaoMock;\n+\n+  @Captor ArgumentCaptor<String> studyCollectionNameCaptor;\n+  @Captor ArgumentCaptor<String> studyIdCaptor;\n+  @Captor ArgumentCaptor<String> siteIdCaptor;\n+  @Captor ArgumentCaptor<String> participantIdCaptor;\n+  @Captor ArgumentCaptor<String> activityIdCaptor;\n+  @Captor ArgumentCaptor<String> questionKeyCaptor;\n+  @Captor ArgumentCaptor<String> activityCollectionNameCaptor;\n+  @Captor ArgumentCaptor<Map<String, Object>> dataToStoreCaptor;\n+\n+  @Autowired private ParticipantActivitiesRepository participantActivitiesRepository;\n+\n+  @BeforeEach\n+  public void setUp() {\n+    participantBo = testDataHelper.saveParticipant();\n+  }\n+\n+  @Test\n+  public void shouldSaveProcessActivityResponse() throws Exception {\n+    Map<String, Object> dataToStore = new HashMap<>();\n+    dataToStore.put(PARTICIPANT_ID_KEY, participantBo.getParticipantIdentifier());\n+\n+    // Step-1 saveActivityResponseData\n+    doNothing()\n+        .when(responsesDaoMock)\n+        .saveActivityResponseData(\n+            STUDY_ID_VALUE,\n+            STUDY_COLLECTION_NAME_VALUE,\n+            ACTIVITY_COLLECTION_NAME_VALUE,\n+            dataToStore);\n+\n+    // Step-2 call API to details to save participant activities\n+    ActivityResponseBean activityResponseBean = setActivityResponseBean();\n+    HttpHeaders headers = TestUtils.newHeadersUser();\n+    mockMvc\n+        .perform(\n+            post(ApiEndpoint.PROCESS_ACTIVITY_RESPONSE.getPath())\n+                .contextPath(getContextPath())\n+                .content(JsonUtils.asJsonString(activityResponseBean))\n+                .headers(headers))\n+        .andDo(print())\n+        .andExpect(status().isOk())\n+        .andExpect(jsonPath(\"$.message\", is(SUCCESS)));\n+\n+    // Step-3: verify saved values\n+    List<ParticipantActivitiesBo> participantActivitiesList =\n+        participantActivitiesRepository.findByStudyIdAndParticipantId(\n+            STUDY_ID_VALUE, participantBo.getParticipantIdentifier());\n+\n+    assertNotNull(participantActivitiesList);\n+    assertEquals(1, participantActivitiesList.size());\n+\n+    verify(responsesDaoMock)\n+        .saveActivityResponseData(\n+            studyIdCaptor.capture(),\n+            studyCollectionNameCaptor.capture(),\n+            activityCollectionNameCaptor.capture(),\n+            dataToStoreCaptor.capture());\n+\n+    // Step-4: assert argument capture\n+\n+    assertEquals(STUDY_ID_VALUE, studyIdCaptor.getValue());\n+    assertEquals(STUDY_COLLECTION_NAME_VALUE, studyCollectionNameCaptor.getValue());\n+    assertEquals(ACTIVITY_COLLECTION_NAME_VALUE, activityCollectionNameCaptor.getValue());\n+    assertEquals(\n+        participantBo.getParticipantIdentifier(),\n+        dataToStoreCaptor.getValue().get(PARTICIPANT_ID_KEY));\n+  }\n+\n+  @Test\n+  public void shouldReturnBadRequestForEmptyInputsOfProccessActivityResponse() throws Exception {\n+    ActivityResponseBean activityResponseBean = new ActivityResponseBean();\n+    HttpHeaders headers = TestUtils.newHeadersUser();\n+    mockMvc\n+        .perform(\n+            post(ApiEndpoint.PROCESS_ACTIVITY_RESPONSE.getPath())\n+                .contextPath(getContextPath())\n+                .content(JsonUtils.asJsonString(activityResponseBean))\n+                .headers(headers))\n+        .andDo(print())\n+        .andExpect(status().isBadRequest())\n+        .andExpect(jsonPath(\"$.userMessage\", is(EC_701.errorMessage())));\n+  }\n+\n+  @Test\n+  public void shouldReturnBadRequestForInvalidParticipant() throws Exception {\n+    ActivityResponseBean activityResponseBean = setActivityResponseBean();\n+    activityResponseBean.setParticipantId(IdGenerator.id());\n+    HttpHeaders headers = TestUtils.newHeadersUser();\n+    mockMvc\n+        .perform(\n+            post(ApiEndpoint.PROCESS_ACTIVITY_RESPONSE.getPath())\n+                .contextPath(getContextPath())\n+                .content(JsonUtils.asJsonString(activityResponseBean))\n+                .headers(headers))\n+        .andDo(print())\n+        .andExpect(status().isBadRequest())\n+        .andExpect(jsonPath(\"$.detailMessage\", is(PARTICIPANT_ID_NOT_EXISTS_MESSAGE)));\n+  }\n+\n+  @Test\n+  public void shouldGetActivityResponse() throws Exception {\n+    String inputJsonContent = readJsonFile(\"/get_activity_response_data_for_participant.json\");\n+    StoredResponseBean StoredResponseBean =", "originalCommit": "f5a82983fda530b28c747d4780040c5befed44a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ4OTI5MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/874#discussion_r483489291", "bodyText": "Fixed.", "author": "madhurya-btc", "createdAt": "2020-09-04T09:04:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ3OTU5Nw=="}], "type": "inlineReview"}, {"oid": "db997825b99d9b4a98dfd645e63af757a5e9c1ab", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/db997825b99d9b4a98dfd645e63af757a5e9c1ab", "message": "build issue fixed", "committedDate": "2020-09-04T08:59:33Z", "type": "commit"}, {"oid": "d3cc2070058ae8d8ddf56e9b07dcec8e5cd1d8d2", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/d3cc2070058ae8d8ddf56e9b07dcec8e5cd1d8d2", "message": "Github action fix", "committedDate": "2020-09-04T09:03:27Z", "type": "commit"}, {"oid": "29e992542a8b494baedc358d47c0287bd0129b01", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/29e992542a8b494baedc358d47c0287bd0129b01", "message": "study metadata integration test cases", "committedDate": "2020-09-04T09:16:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTgwOTY3OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/874#discussion_r485809678", "bodyText": "remove, same as PROCESS_RESPONSE above!", "author": "saminguyen", "createdAt": "2020-09-09T17:55:41Z", "path": "response-server-module/response-server-service/src/test/java/com/google/cloud/healthcare/fdamystudies/common/ApiEndpoint.java", "diffHunk": "@@ -31,7 +26,15 @@\n       \"http://localhost:8004/mystudies-response-server/participant/update-activity-state\"),\n \n   GET_ACTIVITY_STATE(\n-      \"http://localhost:8004/mystudies-response-server/participant/get-activity-state\");\n+      \"http://localhost:8004/mystudies-response-server/participant/get-activity-state\"),\n+\n+  PROCESS_ACTIVITY_RESPONSE(", "originalCommit": "d3cc2070058ae8d8ddf56e9b07dcec8e5cd1d8d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg0MzM2Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/874#discussion_r485843367", "bodyText": "@madhurya-btc sorry for some reason I just clicked approve, please address above comment then request review", "author": "saminguyen", "createdAt": "2020-09-09T18:57:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTgwOTY3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY4NTQ4MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/874#discussion_r487685480", "bodyText": "Frixed review comment", "author": "madhurya-btc", "createdAt": "2020-09-14T06:47:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTgwOTY3OA=="}], "type": "inlineReview"}, {"oid": "3264505f4db5329788e8bd18d4568f93fb224b9d", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/3264505f4db5329788e8bd18d4568f93fb224b9d", "message": "PR review comment fix", "committedDate": "2020-09-11T06:03:53Z", "type": "commit"}, {"oid": "1ceef3cddadcedc728bcc8e8f8a77a59e77a8068", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/1ceef3cddadcedc728bcc8e8f8a77a59e77a8068", "message": "Merge branch 'develop' into response-server-process-activity-response-integration-test", "committedDate": "2020-09-11T06:04:27Z", "type": "commit"}, {"oid": "355d34ac4939a45ca94de1f7ae4116e0084482a6", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/355d34ac4939a45ca94de1f7ae4116e0084482a6", "message": "no message", "committedDate": "2020-09-11T06:09:49Z", "type": "commit"}, {"oid": "2c7df54eae3a1af597b30fa8a97aaf5900dbe4a6", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/2c7df54eae3a1af597b30fa8a97aaf5900dbe4a6", "message": "Merge branch 'response-server-process-activity-response-integration-test' of https://github.com/GoogleCloudPlatform/fda-mystudies into response-server-process-activity-response-integration-test", "committedDate": "2020-09-11T06:10:42Z", "type": "commit"}, {"oid": "99eba18cb8783a95b98210e634a38a38923d9d0c", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/99eba18cb8783a95b98210e634a38a38923d9d0c", "message": "Fixed build issue", "committedDate": "2020-09-11T06:13:57Z", "type": "commit"}, {"oid": "bc29ab6838797793062924eeeaef6b5cea751e89", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/bc29ab6838797793062924eeeaef6b5cea751e89", "message": "Merge branch 'response-server-process-activity-response-integration-test' of https://github.com/GoogleCloudPlatform/fda-mystudies into response-server-studymetadata-integration-test-cases", "committedDate": "2020-09-11T06:24:47Z", "type": "commit"}, {"oid": "c7b4bfc15c33b5b9489db4ab83f9bbd71a8a0c87", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/c7b4bfc15c33b5b9489db4ab83f9bbd71a8a0c87", "message": "Fixed build issue", "committedDate": "2020-09-11T06:29:25Z", "type": "commit"}, {"oid": "49d4f160872775e97e0389656db7d93bfe054e84", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/49d4f160872775e97e0389656db7d93bfe054e84", "message": "Merge pull request #876 from GoogleCloudPlatform/response-server-studymetadata-integration-test-cases\n\nResponse Server: Added integration test cases for the StudyMetadataController class", "committedDate": "2020-09-11T06:31:45Z", "type": "commit"}, {"oid": "00f8523efadc94ad93c90e05b35ccd5b16777493", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/00f8523efadc94ad93c90e05b35ccd5b16777493", "message": "Merge branch 'develop' into response-server-process-activity-response-integration-test", "committedDate": "2020-09-11T13:16:55Z", "type": "commit"}, {"oid": "c6d0a2fcef817e22793ff17e276301ef351578b0", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/c6d0a2fcef817e22793ff17e276301ef351578b0", "message": "Merge branch 'develop' into response-server-process-activity-response-integration-test", "committedDate": "2020-09-14T13:49:30Z", "type": "commit"}, {"oid": "7675b0e464916978e4a5ab81750258159d880e9d", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/7675b0e464916978e4a5ab81750258159d880e9d", "message": "Merge branch 'develop' into response-server-process-activity-response-integration-test", "committedDate": "2020-09-15T06:09:21Z", "type": "commit"}, {"oid": "1260e3d55782b65960bfca0327e317dc76a826d6", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/1260e3d55782b65960bfca0327e317dc76a826d6", "message": "build issue", "committedDate": "2020-09-15T08:11:42Z", "type": "commit"}, {"oid": "8b76090f667acd02d98a79c161aa49b8cfdae22d", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/8b76090f667acd02d98a79c161aa49b8cfdae22d", "message": "Revert \"build issue\"\n\nThis reverts commit 1260e3d55782b65960bfca0327e317dc76a826d6.", "committedDate": "2020-09-15T08:18:08Z", "type": "commit"}, {"oid": "149f289a18a58246b9af6bf4ed2ebdf1152f7430", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/149f289a18a58246b9af6bf4ed2ebdf1152f7430", "message": "issue", "committedDate": "2020-09-15T12:20:19Z", "type": "commit"}, {"oid": "f91ae718f0a58396989ccce6ec65b221a547bd9f", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/f91ae718f0a58396989ccce6ec65b221a547bd9f", "message": "Revert \"issue\"\n\nThis reverts commit 149f289a18a58246b9af6bf4ed2ebdf1152f7430.", "committedDate": "2020-09-15T12:23:32Z", "type": "commit"}, {"oid": "3a609fa2fba54fc05e8541e14b4e701c96a41cc4", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/3a609fa2fba54fc05e8541e14b4e701c96a41cc4", "message": "Build issue fix", "committedDate": "2020-09-15T13:57:45Z", "type": "commit"}, {"oid": "12551b15111c2e7d97174385a0d7a3c8e59a280b", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/12551b15111c2e7d97174385a0d7a3c8e59a280b", "message": "Method level context", "committedDate": "2020-09-15T15:21:41Z", "type": "commit"}, {"oid": "38021bd5042ae92e5df8b6bb6d2d0b09dbaf0140", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/38021bd5042ae92e5df8b6bb6d2d0b09dbaf0140", "message": "Revert \"Method level context\"\n\nThis reverts commit 12551b15111c2e7d97174385a0d7a3c8e59a280b.", "committedDate": "2020-09-15T15:29:39Z", "type": "commit"}, {"oid": "f44f51dc3d6909fde104363df01920f121eba654", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/f44f51dc3d6909fde104363df01920f121eba654", "message": "Merge branch 'develop' into response-server-process-activity-response-integration-test", "committedDate": "2020-09-18T09:48:49Z", "type": "commit"}, {"oid": "42653c38c66f01b549bb20cee6d8196d003c92c5", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/42653c38c66f01b549bb20cee6d8196d003c92c5", "message": "Added @FixMethodOrder to check build failed issue\n\nAdded @FixMethodOrder to check build failed issue", "committedDate": "2020-09-18T10:09:35Z", "type": "commit"}, {"oid": "cd50b2f4039d9d55682b7e00e679ddb79ebfdc21", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/cd50b2f4039d9d55682b7e00e679ddb79ebfdc21", "message": "Merge branch 'response-server-process-activity-response-integration-test' of https://github.com/GoogleCloudPlatform/fda-mystudies into response-server-process-activity-response-integration-test", "committedDate": "2020-09-18T10:10:12Z", "type": "commit"}, {"oid": "21ba261ed183b84e79620eab037c63944fe82ee5", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/21ba261ed183b84e79620eab037c63944fe82ee5", "message": "Revert \"Added @FixMethodOrder to check build failed issue\"\n\nThis reverts commit 42653c38c66f01b549bb20cee6d8196d003c92c5.", "committedDate": "2020-09-18T10:14:31Z", "type": "commit"}, {"oid": "26c3b447da37ecad0651c296db6113051be8aa06", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/26c3b447da37ecad0651c296db6113051be8aa06", "message": "Buils issue fix", "committedDate": "2020-09-23T08:50:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzMzMDQ0NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/874#discussion_r493330445", "bodyText": "[response-server Checks] reported by reviewdog \ud83d\udc36\nLine is longer than 100 characters (found 106).", "author": "github-actions", "createdAt": "2020-09-23T08:51:58Z", "path": "response-server-module/response-server-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/ProcessActivityResponseControllerTest.java", "diffHunk": "@@ -0,0 +1,396 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.controller;\n+\n+import static com.github.tomakehurst.wiremock.client.WireMock.getRequestedFor;\n+import static com.github.tomakehurst.wiremock.client.WireMock.urlEqualTo;\n+import static com.github.tomakehurst.wiremock.client.WireMock.verify;\n+import static com.google.cloud.healthcare.fdamystudies.common.JsonUtils.getObjectMapper;\n+import static com.google.cloud.healthcare.fdamystudies.common.JsonUtils.readJsonFile;\n+import static com.google.cloud.healthcare.fdamystudies.utils.AppConstants.PARTICIPANT_ID_KEY;\n+import static com.google.cloud.healthcare.fdamystudies.utils.AppConstants.PARTICIPANT_TOKEN_IDENTIFIER_KEY;\n+import static com.google.cloud.healthcare.fdamystudies.utils.Constants.ACTIVITY_COLLECTION_NAME_VALUE;\n+import static com.google.cloud.healthcare.fdamystudies.utils.Constants.ACTIVITY_ID_VALUE;\n+import static com.google.cloud.healthcare.fdamystudies.utils.Constants.PARTICIPANT_ID_NOT_EXISTS_MESSAGE;\n+import static com.google.cloud.healthcare.fdamystudies.utils.Constants.QUESTION_KEY_VALUE;\n+import static com.google.cloud.healthcare.fdamystudies.utils.Constants.SITE_ID_VALUE;\n+import static com.google.cloud.healthcare.fdamystudies.utils.Constants.STUDY_COLLECTION_NAME_VALUE;\n+import static com.google.cloud.healthcare.fdamystudies.utils.Constants.STUDY_ID_VALUE;\n+import static com.google.cloud.healthcare.fdamystudies.utils.Constants.SUCCESS;\n+import static com.google.cloud.healthcare.fdamystudies.utils.Constants.USER_ID_HEADER;\n+import static com.google.cloud.healthcare.fdamystudies.utils.Constants.VALID_USER_ID;\n+import static com.google.cloud.healthcare.fdamystudies.utils.ErrorCode.EC_701;\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.Mockito.doNothing;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;\n+import static org.springframework.test.web.servlet.result.MockMvcResultHandlers.print;\n+import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.jsonPath;\n+import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;\n+\n+import com.google.cloud.healthcare.fdamystudies.bean.ActivityResponseBean;\n+import com.google.cloud.healthcare.fdamystudies.bean.StoredResponseBean;\n+import com.google.cloud.healthcare.fdamystudies.common.ApiEndpoint;\n+import com.google.cloud.healthcare.fdamystudies.common.BaseMockIT;\n+import com.google.cloud.healthcare.fdamystudies.common.IdGenerator;\n+import com.google.cloud.healthcare.fdamystudies.common.JsonUtils;\n+import com.google.cloud.healthcare.fdamystudies.dao.CloudFirestoreResponsesDaoImpl;\n+import com.google.cloud.healthcare.fdamystudies.helper.TestDataHelper;\n+import com.google.cloud.healthcare.fdamystudies.model.ParticipantActivitiesBo;\n+import com.google.cloud.healthcare.fdamystudies.model.ParticipantBo;\n+import com.google.cloud.healthcare.fdamystudies.repository.ParticipantActivitiesRepository;\n+import com.google.cloud.healthcare.fdamystudies.repository.ParticipantBoRepository;\n+import com.google.cloud.healthcare.fdamystudies.utils.TestUtils;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Captor;\n+import org.skyscreamer.jsonassert.JSONAssert;\n+import org.skyscreamer.jsonassert.JSONCompareMode;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.test.mock.mockito.MockBean;\n+import org.springframework.http.HttpHeaders;\n+import org.springframework.test.annotation.DirtiesContext;\n+import org.springframework.test.web.servlet.MvcResult;\n+\n+@DirtiesContext(classMode = DirtiesContext.ClassMode.AFTER_CLASS)\n+public class ProcessActivityResponseControllerTest extends BaseMockIT {\n+\n+  @Autowired private TestDataHelper testDataHelper;\n+\n+  @Autowired private ParticipantBoRepository participantBoRepository;\n+\n+  private ParticipantBo participantBo;\n+\n+  @MockBean private CloudFirestoreResponsesDaoImpl responsesDaoMock;\n+\n+  @Captor ArgumentCaptor<String> studyCollectionNameCaptor;\n+  @Captor ArgumentCaptor<String> studyIdCaptor;\n+  @Captor ArgumentCaptor<String> siteIdCaptor;\n+  @Captor ArgumentCaptor<String> participantIdCaptor;\n+  @Captor ArgumentCaptor<String> activityIdCaptor;\n+  @Captor ArgumentCaptor<String> questionKeyCaptor;\n+  @Captor ArgumentCaptor<String> activityCollectionNameCaptor;\n+  @Captor ArgumentCaptor<Map<String, Object>> dataToStoreCaptor;\n+\n+  @Autowired private ParticipantActivitiesRepository participantActivitiesRepository;\n+\n+  @BeforeEach\n+  public void setUp() {\n+    participantBo = testDataHelper.saveParticipant();\n+  }\n+\n+  @Test\n+  public void shouldSaveProcessActivityResponse() throws Exception {\n+    Map<String, Object> dataToStore = new HashMap<>();\n+    dataToStore.put(PARTICIPANT_ID_KEY, participantBo.getParticipantIdentifier());\n+\n+    // Step-1 saveActivityResponseData\n+    doNothing()\n+        .when(responsesDaoMock)\n+        .saveActivityResponseData(\n+            STUDY_ID_VALUE,\n+            STUDY_COLLECTION_NAME_VALUE,\n+            ACTIVITY_COLLECTION_NAME_VALUE,\n+            dataToStore);\n+\n+    // Step-2 call API to details to save participant activities\n+    ActivityResponseBean activityResponseBean = setActivityResponseBean();\n+    HttpHeaders headers = TestUtils.newHeadersUser();\n+    mockMvc\n+        .perform(\n+            post(ApiEndpoint.PROCESS_ACTIVITY_RESPONSE.getPath())\n+                .contextPath(getContextPath())\n+                .content(JsonUtils.asJsonString(activityResponseBean))\n+                .headers(headers))\n+        .andDo(print())\n+        .andExpect(status().isOk())\n+        .andExpect(jsonPath(\"$.message\", is(SUCCESS)));\n+\n+    // Step-3: verify saved values\n+    List<ParticipantActivitiesBo> participantActivitiesList =\n+        participantActivitiesRepository.findByStudyIdAndParticipantId(\n+            STUDY_ID_VALUE, participantBo.getParticipantIdentifier());\n+\n+    assertNotNull(participantActivitiesList);\n+    assertEquals(1, participantActivitiesList.size());\n+\n+    verify(responsesDaoMock)\n+        .saveActivityResponseData(\n+            studyIdCaptor.capture(),\n+            studyCollectionNameCaptor.capture(),\n+            activityCollectionNameCaptor.capture(),\n+            dataToStoreCaptor.capture());\n+\n+    verify(\n+        1,\n+        getRequestedFor(\n+            urlEqualTo(\n+                \"/myStudiesEnrollmentMgmt/participantInfo?studyId=ASignature01&participantId=\"\n+                    + participantBo.getParticipantIdentifier())));\n+\n+    verify(\n+        1,\n+        getRequestedFor(\n+            urlEqualTo(\n+                \"/StudyMetaData/activity?studyId=ASignature01&activityId=Activity&activityVersion=1.0\")));", "originalCommit": "26c3b447da37ecad0651c296db6113051be8aa06", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQwNTkzOA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/874#discussion_r493405938", "bodyText": "Fixed", "author": "madhurya-btc", "createdAt": "2020-09-23T10:09:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzMzMDQ0NQ=="}], "type": "inlineReview"}, {"oid": "385b3dab6ea29025c8aa67bfaed2400a28101ef4", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/385b3dab6ea29025c8aa67bfaed2400a28101ef4", "message": "github action comment fix", "committedDate": "2020-09-23T09:03:59Z", "type": "commit"}, {"oid": "38ecbd401e8626da620a75f3e1c8f67fb7860236", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/38ecbd401e8626da620a75f3e1c8f67fb7860236", "message": "Merge branch 'develop' into response-server-process-activity-response-integration-test", "committedDate": "2020-09-23T09:05:10Z", "type": "commit"}]}