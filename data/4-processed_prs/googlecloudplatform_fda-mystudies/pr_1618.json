{"pr_number": 1618, "pr_title": "Add script to register applications in hydra", "pr_createdAt": "2020-10-22T16:52:05Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1618", "timeline": [{"oid": "6e5d670512352b1aa871f74b01da725e2e125f18", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/6e5d670512352b1aa871f74b01da725e2e125f18", "message": "Add script to register applications in hydra", "committedDate": "2020-10-22T16:48:24Z", "type": "commit"}, {"oid": "b329665e3521e7fa76f65a3c955e2ac02108e58d", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/b329665e3521e7fa76f65a3c955e2ac02108e58d", "message": "Fix mixed up steps", "committedDate": "2020-10-22T16:51:27Z", "type": "commit"}, {"oid": "150442937ff87fd622fe5595422e43f5f86517d7", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/150442937ff87fd622fe5595422e43f5f86517d7", "message": "Merge branch 'develop' into hydra-script", "committedDate": "2020-10-22T19:38:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEyNzcyMA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1618#discussion_r511127720", "bodyText": "remove trailing space", "author": "xingao267", "createdAt": "2020-10-23T19:57:44Z", "path": "deployment.md", "diffHunk": "@@ -301,14 +301,16 @@ regenerating the Terraform configs several times.\n \n ### Step 9: Secrets setup\n \n-1. Modify [copy_client_info_to_sql.sh](./scripts/copy_client_info_to_sql.sh) to\n-    reflect proper {PREFIX} and {ENV}, and run to copy client info from secrets\n-    into CloudSQL.\n+1. Run\n+   [register_clients_in_hydra.sh $PREFIX $ENV](./scripts/register_clients_in_hydra.sh.sh), \n+   passing your deployment PREFIX and ENV as parameters. \n+   This script will register each application in hydra using the generated \n+   client id and secret keys.\n \n 1. Modify\n-    [copy_mobile_app_info_to_sql.sh](./scripts/copy_mobile_app_info_to_sql.sh)\n-    to reflect proper {PREFIX} and {ENV}, and run to copy mobile app info from\n-    secrets into CloudSQL.\n+   [copy_mobile_app_info_to_sql.sh](./scripts/copy_mobile_app_info_to_sql.sh)\n+   to reflect proper {PREFIX} and {ENV}, and run to copy mobile app info from ", "originalCommit": "150442937ff87fd622fe5595422e43f5f86517d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAwODA3Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1618#discussion_r512008076", "bodyText": "fixed.", "author": "zohrehj", "createdAt": "2020-10-26T14:35:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEyNzcyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEyNzgyNw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1618#discussion_r511127827", "bodyText": "license header", "author": "xingao267", "createdAt": "2020-10-23T19:58:03Z", "path": "scripts/register_clients_in_hydra.sh", "diffHunk": "@@ -0,0 +1,71 @@\n+#!/bin/bash", "originalCommit": "150442937ff87fd622fe5595422e43f5f86517d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAwODIwOQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1618#discussion_r512008209", "bodyText": "added to all scripts.", "author": "zohrehj", "createdAt": "2020-10-26T14:35:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEyNzgyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAzMzMyOQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1618#discussion_r512033329", "bodyText": "just curious why MIT license is used here? Apache 2.0 is usually the default.", "author": "xingao267", "createdAt": "2020-10-26T15:06:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEyNzgyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA0Nzg0OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1618#discussion_r512047849", "bodyText": "MIT is the repository's default license (all Google generated code is in MIT), only the terraform assets are in Apache 2.0 and I assumed that was because a decision on the DPT side.", "author": "zohrehj", "createdAt": "2020-10-26T15:25:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEyNzgyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEyODc5Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1618#discussion_r511128793", "bodyText": "remove the second empty line", "author": "xingao267", "createdAt": "2020-10-23T20:00:13Z", "path": "scripts/register_clients_in_hydra.sh", "diffHunk": "@@ -0,0 +1,71 @@\n+#!/bin/bash\n+# Script to copy client id and secret keys from gcloud secret to CloudSQL.\n+if [ \"$#\" -ne 2 ]; then\n+  echo 'Please provide deployment prefix and env in the order of <prefix> <env>>'\n+  exit 1\n+fi\n+\n+PREFIX=${1}\n+ENV=${2}\n+shift 2\n+\n+set -e\n+\n+SECRET_PROJECT=${PREFIX}-${ENV}-secrets\n+DATA_PROJECT=${PREFIX}-${ENV}-data\n+SQL_IMPORT_BUCKET=${PREFIX}-${ENV}-mystudies-sql-import\n+SCIM_AUTH_URL=\"http://auth-server-np:50000\"\n+HYDRA_ADMIN_URL=\"http://hydra-np:4445\"\n+DATETIME=`date +\"%FT%TZ\"`\n+\n+# SCIM AUTH SERVER, PARTICIPANT MANAGER & MOBILE APPS are registered\n+# with the same client_id and secret_key\n+AUTH_CLIENT_ID=`gcloud --project=${SECRET_PROJECT} secrets versions access latest --secret=auto-auth-server-client-id`\n+AUTH_SECRET_KEY=`gcloud --project=${SECRET_PROJECT} secrets versions access latest --secret=auto-auth-server-secret-key`\n+\n+for CLIENT_NAME in \"SCIM AUTH SERVER\" \"PARTICIPANT MANAGER\" \"MOBILE APPS\"\n+do\n+  echo \"Register ${CLIENT_NAME} with Hydra\"\n+  OUTPUT=`curl --location --request POST \"${HYDRA_ADMIN_URL}/clients\" \\\n+  --header \"Content-Type: application/json\" \\\n+  --header \"Accept: application/json\" \\\n+  --data-raw \"{\n+    \\\"client_id\\\": \\\"${AUTH_CLIENT_ID}\\\",\n+    \\\"client_name\\\": \\\"${CLIENT_NAME}\\\",\n+    \\\"client_secret\\\": \\\"${AUTH_SECRET_KEY}\\\",\n+    \\\"client_secret_expires_at\\\": 0,\n+    \\\"created_at\\\": \\\"${DATETIME}\\\",\n+    \\\"grant_types\\\": [\\\"authorization_code\\\",\\\"refresh_token\\\",\\\"client_credentials\\\"],\n+    \\\"token_endpoint_auth_method\\\": \\\"client_secret_basic\\\",\n+    \\\"redirect_uris\\\": [\\\"${SCIM_AUTH_URL}/callback\\\"]\n+  }\"`\n+  echo \"${OUTPUT}\"\n+end\n+\n+# Loop over all applications to read secret and register with hydra.\n+for APPLICATION in participant-consent-datastore participant-enroll-datastore participant-manager-datastore participant-user-datastore response-datastore study-builder study-datastore\n+do\n+  CLIENT_NAME=`echo \"${APPLICATION}\" | tr '[:lower:]' '[:upper:]' | sed 's/-/ /'`\n+  echo \"Reading client id and secret key for: ${CLIENT_NAME}\"\n+  CLIENT_ID=`gcloud --project=${SECRET_PROJECT} secrets versions access latest --secret=auto-${APPLICATION}-client-id`\n+  SECRET_KEY=`gcloud --project=${SECRET_PROJECT} secrets versions access latest --secret=auto-${APPLICATION}-secret-key`\n+\n+  echo \"Register ${CLIENT_NAME} in Hydra\"\n+  OUTPUT=`curl --location --request POST \"${HYDRA_ADMIN_URL}/clients\" \\\n+--header \"Content-Type: application/json\" \\\n+--header \"Accept: application/json\" \\\n+--data-raw \"{\n+  \\\"client_id\\\": \\\"${CLIENT_ID}\\\",\n+  \\\"client_name\\\": \\\"${CLIENT_NAME}\\\",\n+  \\\"client_secret\\\": \\\"${CLIENT_SECRET}\\\",\n+  \\\"client_secret_expires_at\\\": 0,\n+  \\\"created_at\\\": \\\"${DATETIME}\\\",\n+  \\\"grant_types\\\": [\\\"client_credentials\\\"],\n+  \\\"token_endpoint_auth_method\\\": \\\"client_secret_basic\\\",\n+  \\\"redirect_uris\\\": [\\\"${SCIM_AUTH_URL}/callback\\\"]\n+  }\"`\n+\n+  echo \"${OUTPUT}\"\n+done\n+\n+", "originalCommit": "150442937ff87fd622fe5595422e43f5f86517d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAwOTI0Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1618#discussion_r512009246", "bodyText": "fixed.", "author": "zohrehj", "createdAt": "2020-10-26T14:36:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEyODc5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEyOTE4OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1618#discussion_r511129189", "bodyText": "nit: indentation", "author": "xingao267", "createdAt": "2020-10-23T20:01:10Z", "path": "scripts/register_clients_in_hydra.sh", "diffHunk": "@@ -0,0 +1,71 @@\n+#!/bin/bash\n+# Script to copy client id and secret keys from gcloud secret to CloudSQL.\n+if [ \"$#\" -ne 2 ]; then\n+  echo 'Please provide deployment prefix and env in the order of <prefix> <env>>'\n+  exit 1\n+fi\n+\n+PREFIX=${1}\n+ENV=${2}\n+shift 2\n+\n+set -e\n+\n+SECRET_PROJECT=${PREFIX}-${ENV}-secrets\n+DATA_PROJECT=${PREFIX}-${ENV}-data\n+SQL_IMPORT_BUCKET=${PREFIX}-${ENV}-mystudies-sql-import\n+SCIM_AUTH_URL=\"http://auth-server-np:50000\"\n+HYDRA_ADMIN_URL=\"http://hydra-np:4445\"\n+DATETIME=`date +\"%FT%TZ\"`\n+\n+# SCIM AUTH SERVER, PARTICIPANT MANAGER & MOBILE APPS are registered\n+# with the same client_id and secret_key\n+AUTH_CLIENT_ID=`gcloud --project=${SECRET_PROJECT} secrets versions access latest --secret=auto-auth-server-client-id`\n+AUTH_SECRET_KEY=`gcloud --project=${SECRET_PROJECT} secrets versions access latest --secret=auto-auth-server-secret-key`\n+\n+for CLIENT_NAME in \"SCIM AUTH SERVER\" \"PARTICIPANT MANAGER\" \"MOBILE APPS\"\n+do\n+  echo \"Register ${CLIENT_NAME} with Hydra\"\n+  OUTPUT=`curl --location --request POST \"${HYDRA_ADMIN_URL}/clients\" \\\n+  --header \"Content-Type: application/json\" \\\n+  --header \"Accept: application/json\" \\\n+  --data-raw \"{\n+    \\\"client_id\\\": \\\"${AUTH_CLIENT_ID}\\\",\n+    \\\"client_name\\\": \\\"${CLIENT_NAME}\\\",\n+    \\\"client_secret\\\": \\\"${AUTH_SECRET_KEY}\\\",\n+    \\\"client_secret_expires_at\\\": 0,\n+    \\\"created_at\\\": \\\"${DATETIME}\\\",\n+    \\\"grant_types\\\": [\\\"authorization_code\\\",\\\"refresh_token\\\",\\\"client_credentials\\\"],\n+    \\\"token_endpoint_auth_method\\\": \\\"client_secret_basic\\\",\n+    \\\"redirect_uris\\\": [\\\"${SCIM_AUTH_URL}/callback\\\"]\n+  }\"`\n+  echo \"${OUTPUT}\"\n+end\n+\n+# Loop over all applications to read secret and register with hydra.\n+for APPLICATION in participant-consent-datastore participant-enroll-datastore participant-manager-datastore participant-user-datastore response-datastore study-builder study-datastore\n+do\n+  CLIENT_NAME=`echo \"${APPLICATION}\" | tr '[:lower:]' '[:upper:]' | sed 's/-/ /'`\n+  echo \"Reading client id and secret key for: ${CLIENT_NAME}\"\n+  CLIENT_ID=`gcloud --project=${SECRET_PROJECT} secrets versions access latest --secret=auto-${APPLICATION}-client-id`\n+  SECRET_KEY=`gcloud --project=${SECRET_PROJECT} secrets versions access latest --secret=auto-${APPLICATION}-secret-key`\n+\n+  echo \"Register ${CLIENT_NAME} in Hydra\"\n+  OUTPUT=`curl --location --request POST \"${HYDRA_ADMIN_URL}/clients\" \\\n+--header \"Content-Type: application/json\" \\", "originalCommit": "150442937ff87fd622fe5595422e43f5f86517d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAwOTMyMA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1618#discussion_r512009320", "bodyText": "done", "author": "zohrehj", "createdAt": "2020-10-26T14:36:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEyOTE4OQ=="}], "type": "inlineReview"}, {"oid": "81677ebf916081358dfca74276e52aca03bad025", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/81677ebf916081358dfca74276e52aca03bad025", "message": "Merge branch 'develop' into hydra-script", "committedDate": "2020-10-26T14:22:43Z", "type": "commit"}, {"oid": "e7a4f9efc567d1ddd5cc9694603104295535909d", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e7a4f9efc567d1ddd5cc9694603104295535909d", "message": "Add copyright header to all scripts", "committedDate": "2020-10-26T14:35:13Z", "type": "commit"}, {"oid": "5275b8ee5074b023fe8f5a44f2ed28ed59a87be3", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/5275b8ee5074b023fe8f5a44f2ed28ed59a87be3", "message": "Fix indentation", "committedDate": "2020-10-26T14:36:40Z", "type": "commit"}]}