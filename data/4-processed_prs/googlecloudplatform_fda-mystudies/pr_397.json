{"pr_number": 397, "pr_title": "iOS - Fix stats filters navigation.", "pr_createdAt": "2020-05-14T07:29:18Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/397", "timeline": [{"oid": "471c0d30c95bef235e0901a1aa4f8b30283815ba", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/471c0d30c95bef235e0901a1aa4f8b30283815ba", "message": "Fix stats filters wrt to time.", "committedDate": "2020-05-14T07:16:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE2MDMwOQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/397#discussion_r425160309", "bodyText": "nextStartDateOfWeek?", "author": "nikklassen", "createdAt": "2020-05-14T14:01:01Z", "path": "iOS/HPHC/HPHC/Views/Cells/TableView/Study/StudyDashboardStatisticsTableViewCell.swift", "diffHunk": "@@ -198,59 +201,30 @@ class StudyDashboardStatisticsTableViewCell: UITableViewCell {\n     switch self.selectedTab {\n \n     case .Day:\n-\n-      self.buttonForward?.isEnabled = true\n-      self.buttonBackward?.isEnabled = true\n-      todaysDate = calendar.date(byAdding: .day, value: 1, to: todaysDate)!\n-      let stringDate = StudyDashboardStatisticsTableViewCell.formatter.string(\n-        from: todaysDate\n-      )\n-      let color = Utilities.getUIColorFromHex(0x007CBA)\n-\n-      let attributedStartDate: NSMutableAttributedString = NSMutableAttributedString(\n-        string: stringDate\n-      )\n-      attributedStartDate.addAttribute(\n-        NSAttributedString.Key.foregroundColor,\n-        value: color,\n-        range: NSRange(location: 0, length: 2)\n-      )\n-      labelDateValue?.attributedText = attributedStartDate\n-\n-      let result = todaysDate.compare(Date())\n-      if result == .orderedSame || result == .orderedDescending {\n-        self.buttonForward?.isEnabled = false\n+      if let nextDayDate = calendar.date(byAdding: .day, value: 1, to: todaysDate) {\n+        todaysDate = nextDayDate\n+        labelDateValue?.attributedText = getDayAttributedString()\n+        self.updateForwardBtnState()\n       }\n \n     case .Week:\n-\n-      self.buttonForward?.isEnabled = true\n-      self.buttonBackward?.isEnabled = true\n-\n-      startDateOfWeek = calendar.date(byAdding: .day, value: 7, to: startDateOfWeek!)\n-      endDateOfWeek = calendar.date(byAdding: .day, value: 7, to: endDateOfWeek!)\n-\n-      let attributedText = self.getWeeklyAttributedText()\n-      labelDateValue?.attributedText = attributedText\n-\n-      let result = todaysDate.compare(Date())\n-      if result == .orderedSame || result == .orderedDescending {\n-        self.buttonForward?.isEnabled = false\n+      if let currentStartDateOfWeek = startDateOfWeek,\n+        let currentEndDateOfWeek = endDateOfWeek {\n+        startDateOfWeek = calendar.date(byAdding: .day, value: 7, to: currentStartDateOfWeek)", "originalCommit": "471c0d30c95bef235e0901a1aa4f8b30283815ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI3MDczOA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/397#discussion_r425270738", "bodyText": "startDateOfWeek is global property, updating it directly here. This is derived from todaysDate initially when a user selects a week filter.", "author": "tushar-boston", "createdAt": "2020-05-14T16:27:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE2MDMwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE2Mjc0OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/397#discussion_r425162749", "bodyText": "This should be currentWeekStartDate right? The end and start of a week can't be the same day", "author": "nikklassen", "createdAt": "2020-05-14T14:04:27Z", "path": "iOS/HPHC/HPHC/Views/Cells/TableView/Study/StudyDashboardStatisticsTableViewCell.swift", "diffHunk": "@@ -198,59 +201,30 @@ class StudyDashboardStatisticsTableViewCell: UITableViewCell {\n     switch self.selectedTab {\n \n     case .Day:\n-\n-      self.buttonForward?.isEnabled = true\n-      self.buttonBackward?.isEnabled = true\n-      todaysDate = calendar.date(byAdding: .day, value: 1, to: todaysDate)!\n-      let stringDate = StudyDashboardStatisticsTableViewCell.formatter.string(\n-        from: todaysDate\n-      )\n-      let color = Utilities.getUIColorFromHex(0x007CBA)\n-\n-      let attributedStartDate: NSMutableAttributedString = NSMutableAttributedString(\n-        string: stringDate\n-      )\n-      attributedStartDate.addAttribute(\n-        NSAttributedString.Key.foregroundColor,\n-        value: color,\n-        range: NSRange(location: 0, length: 2)\n-      )\n-      labelDateValue?.attributedText = attributedStartDate\n-\n-      let result = todaysDate.compare(Date())\n-      if result == .orderedSame || result == .orderedDescending {\n-        self.buttonForward?.isEnabled = false\n+      if let nextDayDate = calendar.date(byAdding: .day, value: 1, to: todaysDate) {\n+        todaysDate = nextDayDate\n+        labelDateValue?.attributedText = getDayAttributedString()\n+        self.updateForwardBtnState()\n       }\n \n     case .Week:\n-\n-      self.buttonForward?.isEnabled = true\n-      self.buttonBackward?.isEnabled = true\n-\n-      startDateOfWeek = calendar.date(byAdding: .day, value: 7, to: startDateOfWeek!)\n-      endDateOfWeek = calendar.date(byAdding: .day, value: 7, to: endDateOfWeek!)\n-\n-      let attributedText = self.getWeeklyAttributedText()\n-      labelDateValue?.attributedText = attributedText\n-\n-      let result = todaysDate.compare(Date())\n-      if result == .orderedSame || result == .orderedDescending {\n-        self.buttonForward?.isEnabled = false\n+      if let currentStartDateOfWeek = startDateOfWeek,\n+        let currentEndDateOfWeek = endDateOfWeek {\n+        startDateOfWeek = calendar.date(byAdding: .day, value: 7, to: currentStartDateOfWeek)\n+        endDateOfWeek = calendar.date(byAdding: .day, value: 7, to: currentEndDateOfWeek)\n+        let attributedText = self.getWeeklyAttributedText()\n+        labelDateValue?.attributedText = attributedText\n+        if let currentWeekEndDate = startDateOfWeek {", "originalCommit": "471c0d30c95bef235e0901a1aa4f8b30283815ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI3MDk2MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/397#discussion_r425270961", "bodyText": "I named it incorrectly here. The value assigned it correct thou. I've updated this. Thank you.", "author": "tushar-boston", "createdAt": "2020-05-14T16:27:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE2Mjc0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTIwODMwNQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/397#discussion_r425208305", "bodyText": "This seems pretty hacky. It seems like we should just be initializing a variable with the current date to control what date the user is looking at, and then never use Date() again.", "author": "nikklassen", "createdAt": "2020-05-14T15:03:56Z", "path": "iOS/HPHC/HPHC/Views/Cells/TableView/Study/StudyDashboardStatisticsTableViewCell.swift", "diffHunk": "@@ -123,21 +142,10 @@ class StudyDashboardStatisticsTableViewCell: UITableViewCell {\n       buttonMonth?.backgroundColor = UIColor.white\n \n       self.selectedTab = .Day\n-      todaysDate = Date()\n-\n-      let stringDate = StudyDashboardStatisticsTableViewCell.formatter.string(from: Date())\n-      let color = Utilities.getUIColorFromHex(0x007CBA)\n-\n-      let attributedStartDate: NSMutableAttributedString = NSMutableAttributedString(\n-        string: stringDate\n-      )\n-      attributedStartDate.addAttribute(\n-        NSAttributedString.Key.foregroundColor,\n-        value: color,\n-        range: NSRange(location: 0, length: 2)\n-      )\n-      labelDateValue?.attributedText = attributedStartDate\n-      self.buttonForward?.isEnabled = false\n+      \n+      todaysDate = todaysDate > Date() ? Date() : todaysDate", "originalCommit": "471c0d30c95bef235e0901a1aa4f8b30283815ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI3MTIyMw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/397#discussion_r425271223", "bodyText": "todaysDate gets initialized as Date() initially, which is a global property. In case of the month filter, it gets updated to todaysDate.endOfMonth(), so when a user selects back the day filter, I'm resetting it back to the current date and later the stats are filtered using todaysDate.endOfDay as per existing implementation.\nThis was implemented to block users checking future stats which will be NA.", "author": "tushar-boston", "createdAt": "2020-05-14T16:27:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTIwODMwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTIxMzQwNw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/397#discussion_r425213407", "bodyText": "Seems cleaner to take the current date, subtract 7 days, then use .startOfWeek", "author": "nikklassen", "createdAt": "2020-05-14T15:10:58Z", "path": "iOS/HPHC/HPHC/Views/Cells/TableView/Study/StudyDashboardStatisticsTableViewCell.swift", "diffHunk": "@@ -198,59 +201,30 @@ class StudyDashboardStatisticsTableViewCell: UITableViewCell {\n     switch self.selectedTab {\n \n     case .Day:\n-\n-      self.buttonForward?.isEnabled = true\n-      self.buttonBackward?.isEnabled = true\n-      todaysDate = calendar.date(byAdding: .day, value: 1, to: todaysDate)!\n-      let stringDate = StudyDashboardStatisticsTableViewCell.formatter.string(\n-        from: todaysDate\n-      )\n-      let color = Utilities.getUIColorFromHex(0x007CBA)\n-\n-      let attributedStartDate: NSMutableAttributedString = NSMutableAttributedString(\n-        string: stringDate\n-      )\n-      attributedStartDate.addAttribute(\n-        NSAttributedString.Key.foregroundColor,\n-        value: color,\n-        range: NSRange(location: 0, length: 2)\n-      )\n-      labelDateValue?.attributedText = attributedStartDate\n-\n-      let result = todaysDate.compare(Date())\n-      if result == .orderedSame || result == .orderedDescending {\n-        self.buttonForward?.isEnabled = false\n+      if let nextDayDate = calendar.date(byAdding: .day, value: 1, to: todaysDate) {\n+        todaysDate = nextDayDate\n+        labelDateValue?.attributedText = getDayAttributedString()\n+        self.updateForwardBtnState()\n       }\n \n     case .Week:\n-\n-      self.buttonForward?.isEnabled = true\n-      self.buttonBackward?.isEnabled = true\n-\n-      startDateOfWeek = calendar.date(byAdding: .day, value: 7, to: startDateOfWeek!)\n-      endDateOfWeek = calendar.date(byAdding: .day, value: 7, to: endDateOfWeek!)\n-\n-      let attributedText = self.getWeeklyAttributedText()\n-      labelDateValue?.attributedText = attributedText\n-\n-      let result = todaysDate.compare(Date())\n-      if result == .orderedSame || result == .orderedDescending {\n-        self.buttonForward?.isEnabled = false\n+      if let currentStartDateOfWeek = startDateOfWeek,\n+        let currentEndDateOfWeek = endDateOfWeek {\n+        startDateOfWeek = calendar.date(byAdding: .day, value: 7, to: currentStartDateOfWeek)", "originalCommit": "471c0d30c95bef235e0901a1aa4f8b30283815ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI3MjAzMQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/397#discussion_r425272031", "bodyText": "This gets updated when user selects a week filter.\nstartDateOfWeek = todaysDate.startOfWeek\nendDateOfWeek = todaysDate.endOfWeek", "author": "tushar-boston", "createdAt": "2020-05-14T16:29:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTIxMzQwNw=="}], "type": "inlineReview"}, {"oid": "7ccf71d66f8dca076c376605e31508159cc75da8", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/7ccf71d66f8dca076c376605e31508159cc75da8", "message": "Refactor naming conventions.", "committedDate": "2020-05-14T16:22:43Z", "type": "commit"}, {"oid": "df797d978e788ced8e97546178e60b463394bab0", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/df797d978e788ced8e97546178e60b463394bab0", "message": "Merge branch 'early-access' into ios-stats-fix", "committedDate": "2020-05-18T05:37:04Z", "type": "commit"}]}