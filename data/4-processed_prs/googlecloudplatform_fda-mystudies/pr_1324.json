{"pr_number": 1324, "pr_title": "Participant Manager: Fixed issue #1322", "pr_createdAt": "2020-10-13T06:02:49Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1324", "timeline": [{"oid": "dca34d3349509e2cce9c634fd5cacd4cecb71712", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/dca34d3349509e2cce9c634fd5cacd4cecb71712", "message": "Fixed issue #1322\n\nFixed issue #1322", "committedDate": "2020-10-13T05:56:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU2MTIwNQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1324#discussion_r504561205", "bodyText": "nit: Just initialize enrolledInvitedCountList as empty ArrayList in line 1007 and you do not need to do emptyIfNull here.", "author": "saminguyen", "createdAt": "2020-10-14T10:11:52Z", "path": "participant-manager-datastore/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/SiteServiceImpl.java", "diffHunk": "@@ -970,120 +975,132 @@ public ParticipantStatusResponse updateOnboardingStatus(\n   public SiteDetailsResponse getSites(String userId) {\n     logger.entry(\"getSites(userId)\");\n \n+    Optional<UserRegAdminEntity> optUser = userRegAdminRepository.findById(userId);\n+    if (optUser.isPresent() && optUser.get().isSuperAdmin()) {\n+      List<StudyDetails> studies = getSitesForSuperAdmin();\n+      return new SiteDetailsResponse(studies, MessageCode.GET_SITES_SUCCESS);\n+    }\n+\n+    List<StudyPermissionEntity> studyPermissions =\n+        studyPermissionRepository.findByAdminUserId(userId);\n+\n     List<SitePermissionEntity> sitePermissions =\n         sitePermissionRepository.findSitePermissionByUserId(userId);\n-    if (CollectionUtils.isEmpty(sitePermissions)) {\n-      throw new ErrorCodeException(ErrorCode.SITE_NOT_FOUND);\n+\n+    if (CollectionUtils.isEmpty(studyPermissions)) {\n+      throw new ErrorCodeException(ErrorCode.STUDY_PERMISSION_ACCESS_DENIED);\n     }\n \n-    List<String> siteIds =\n-        sitePermissions\n+    Map<String, StudyPermissionEntity> studyPermissionsByStudyId = new HashMap<>();\n+\n+    List<StudyEntity> userStudies =\n+        studyPermissions\n             .stream()\n-            .map(s -> s.getSite().getId())\n             .distinct()\n+            .map(\n+                studyPermissionEntity -> {\n+                  StudyEntity study = studyPermissionEntity.getStudy();\n+                  studyPermissionsByStudyId.put(study.getId(), studyPermissionEntity);\n+                  return study;\n+                })\n             .collect(Collectors.toList());\n+    List<EnrolledInvitedCount> enrolledInvitedCountList = null;\n+    if (CollectionUtils.isNotEmpty(sitePermissions)) {\n+      enrolledInvitedCountList = siteRepository.getEnrolledInvitedCountByUserId(userId);\n+    }\n \n-    Map<String, Long> invitedCountBySiteIdMap = getInvitedCountBySiteId(siteIds);\n-\n-    Map<String, Long> enrolledCountBySiteIdMap = getEnrolledCountBySiteId(siteIds);\n-\n-    Map<StudyEntity, List<SitePermissionEntity>> sitePermissionsByStudy =\n-        sitePermissions.stream().collect(Collectors.groupingBy(SitePermissionEntity::getStudy));\n-\n-    Map<String, StudyPermissionEntity> studyPermissionsByStudyInfoId =\n-        getStudyPermissionsByStudyId(userId, sitePermissions);\n+    Map<String, EnrolledInvitedCount> enrolledInvitedCountMap =\n+        CollectionUtils.emptyIfNull(enrolledInvitedCountList)", "originalCommit": "dca34d3349509e2cce9c634fd5cacd4cecb71712", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY1MDMyNQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1324#discussion_r504650325", "bodyText": "initialized to ArrayList", "author": "Kantharajut-btc", "createdAt": "2020-10-14T12:51:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU2MTIwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU2MTQ4Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1324#discussion_r504561483", "bodyText": "same as above", "author": "saminguyen", "createdAt": "2020-10-14T10:12:24Z", "path": "participant-manager-datastore/participant-manager-service/src/main/java/com/google/cloud/healthcare/fdamystudies/service/SiteServiceImpl.java", "diffHunk": "@@ -970,120 +975,132 @@ public ParticipantStatusResponse updateOnboardingStatus(\n   public SiteDetailsResponse getSites(String userId) {\n     logger.entry(\"getSites(userId)\");\n \n+    Optional<UserRegAdminEntity> optUser = userRegAdminRepository.findById(userId);\n+    if (optUser.isPresent() && optUser.get().isSuperAdmin()) {\n+      List<StudyDetails> studies = getSitesForSuperAdmin();\n+      return new SiteDetailsResponse(studies, MessageCode.GET_SITES_SUCCESS);\n+    }\n+\n+    List<StudyPermissionEntity> studyPermissions =\n+        studyPermissionRepository.findByAdminUserId(userId);\n+\n     List<SitePermissionEntity> sitePermissions =\n         sitePermissionRepository.findSitePermissionByUserId(userId);\n-    if (CollectionUtils.isEmpty(sitePermissions)) {\n-      throw new ErrorCodeException(ErrorCode.SITE_NOT_FOUND);\n+\n+    if (CollectionUtils.isEmpty(studyPermissions)) {\n+      throw new ErrorCodeException(ErrorCode.STUDY_PERMISSION_ACCESS_DENIED);\n     }\n \n-    List<String> siteIds =\n-        sitePermissions\n+    Map<String, StudyPermissionEntity> studyPermissionsByStudyId = new HashMap<>();\n+\n+    List<StudyEntity> userStudies =\n+        studyPermissions\n             .stream()\n-            .map(s -> s.getSite().getId())\n             .distinct()\n+            .map(\n+                studyPermissionEntity -> {\n+                  StudyEntity study = studyPermissionEntity.getStudy();\n+                  studyPermissionsByStudyId.put(study.getId(), studyPermissionEntity);\n+                  return study;\n+                })\n             .collect(Collectors.toList());\n+    List<EnrolledInvitedCount> enrolledInvitedCountList = null;\n+    if (CollectionUtils.isNotEmpty(sitePermissions)) {\n+      enrolledInvitedCountList = siteRepository.getEnrolledInvitedCountByUserId(userId);\n+    }\n \n-    Map<String, Long> invitedCountBySiteIdMap = getInvitedCountBySiteId(siteIds);\n-\n-    Map<String, Long> enrolledCountBySiteIdMap = getEnrolledCountBySiteId(siteIds);\n-\n-    Map<StudyEntity, List<SitePermissionEntity>> sitePermissionsByStudy =\n-        sitePermissions.stream().collect(Collectors.groupingBy(SitePermissionEntity::getStudy));\n-\n-    Map<String, StudyPermissionEntity> studyPermissionsByStudyInfoId =\n-        getStudyPermissionsByStudyId(userId, sitePermissions);\n+    Map<String, EnrolledInvitedCount> enrolledInvitedCountMap =\n+        CollectionUtils.emptyIfNull(enrolledInvitedCountList)\n+            .stream()\n+            .collect(Collectors.toMap(EnrolledInvitedCount::getSiteId, Function.identity()));\n \n     List<StudyDetails> studies = new ArrayList<>();\n-    for (Map.Entry<StudyEntity, List<SitePermissionEntity>> entry :\n-        sitePermissionsByStudy.entrySet()) {\n-      StudyEntity study = entry.getKey();\n-      StudyDetails studyDetail = StudyMapper.toStudyDetails(studyPermissionsByStudyInfoId, study);\n+    for (StudyEntity study : userStudies) {\n+      StudyDetails studyDetail = StudyMapper.toStudyDetails(study);\n+\n+      if (studyPermissionsByStudyId.get(study.getId()) != null) {\n+        Integer studyEditPermission =\n+            studyPermissionsByStudyId.get(study.getId()).getEdit().value();\n+        studyDetail.setStudyPermission(\n+            studyEditPermission == Permission.NO_PERMISSION.value()\n+                ? Permission.VIEW.value()\n+                : Permission.EDIT.value());\n+        studyDetail.setStudyPermission(studyEditPermission);\n+      }\n \n-      addSites(invitedCountBySiteIdMap, enrolledCountBySiteIdMap, study, studyDetail);\n-      studyDetail.setSitesCount((long) studyDetail.getSites().size());\n+      if (CollectionUtils.isNotEmpty(study.getSites())) {\n+        addSites(enrolledInvitedCountMap, study, studyDetail);\n+      }\n \n+      studyDetail.setSitesCount((long) studyDetail.getSites().size());\n       studies.add(studyDetail);\n     }\n \n     logger.exit(String.format(\"%d studies found\", studies.size()));\n     return new SiteDetailsResponse(studies, MessageCode.GET_SITES_SUCCESS);\n   }\n \n-  private Map<String, StudyPermissionEntity> getStudyPermissionsByStudyId(\n-      String userId, List<SitePermissionEntity> sitePermissions) {\n-    List<String> usersStudyIds =\n-        sitePermissions\n-            .stream()\n-            .distinct()\n-            .map(studyEntity -> studyEntity.getStudy().getId())\n-            .collect(Collectors.toList());\n-\n-    List<StudyPermissionEntity> studyPermissions =\n-        studyPermissionRepository.findByStudyIds(usersStudyIds, userId);\n+  private List<StudyDetails> getSitesForSuperAdmin() {\n \n-    Map<String, StudyPermissionEntity> studyPermissionsByStudyInfoId = new HashMap<>();\n-    if (CollectionUtils.isNotEmpty(studyPermissions)) {\n-      studyPermissionsByStudyInfoId =\n-          studyPermissions\n-              .stream()\n-              .collect(Collectors.toMap(e -> e.getStudy().getId(), Function.identity()));\n-    }\n-    return studyPermissionsByStudyInfoId;\n-  }\n+    List<StudyDetails> studies = new ArrayList<>();\n+    List<StudyEntity> studyList = studyRepository.findAll();\n \n-  private Map<String, Long> getInvitedCountBySiteId(List<String> usersSiteIds) {\n-    List<ParticipantRegistrySiteEntity> participantRegistry =\n-        participantRegistrySiteRepository.findBySiteIds(usersSiteIds);\n+    if (CollectionUtils.isNotEmpty(studyList)) {\n+      for (StudyEntity study : studyList) {\n+        StudyDetails studyDetail = StudyMapper.toStudyDetails(study);\n+        studyDetail.setStudyPermission(Permission.EDIT.value());\n \n-    return participantRegistry\n-        .stream()\n-        .collect(\n-            Collectors.groupingBy(\n-                e -> e.getSite().getId(),\n-                Collectors.summingLong(ParticipantRegistrySiteEntity::getInvitationCount)));\n-  }\n+        List<EnrolledInvitedCount> enrolledInvitedCountList =\n+            siteRepository.getEnrolledInvitedCount();\n \n-  private Map<String, Long> getEnrolledCountBySiteId(List<String> usersSiteIds) {\n-    List<ParticipantStudyEntity> participantsEnrollments =\n-        participantStudyRepository.findBySiteIds(usersSiteIds);\n+        Map<String, EnrolledInvitedCount> enrolledInvitedCountMap =\n+            CollectionUtils.emptyIfNull(enrolledInvitedCountList)", "originalCommit": "dca34d3349509e2cce9c634fd5cacd4cecb71712", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY1MDQ0Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1324#discussion_r504650446", "bodyText": "initialized to ArrayList", "author": "Kantharajut-btc", "createdAt": "2020-10-14T12:51:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU2MTQ4Mw=="}], "type": "inlineReview"}, {"oid": "9698efead5fff2edb13790f69ba55becce30b646", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/9698efead5fff2edb13790f69ba55becce30b646", "message": "fixed PR comments\n\nfixed PR comments", "committedDate": "2020-10-14T12:50:24Z", "type": "commit"}, {"oid": "27229462b38368fc3d86100850853b5b66581188", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/27229462b38368fc3d86100850853b5b66581188", "message": "Merge branch 'develop' into get-sites-super-admin-changes", "committedDate": "2020-10-14T12:50:56Z", "type": "commit"}]}