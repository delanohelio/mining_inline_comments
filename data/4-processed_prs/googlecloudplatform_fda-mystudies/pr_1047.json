{"pr_number": 1047, "pr_title": "Study Builder - Audit log Implementation for Login and Users Controller with Test Cases", "pr_createdAt": "2020-09-26T15:26:14Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1047", "timeline": [{"oid": "b1bc93afd8b911c9a0e331d61105573b7e7be9d0", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/b1bc93afd8b911c9a0e331d61105573b7e7be9d0", "message": "user and login controller test cases has been implemented", "committedDate": "2020-09-25T08:24:50Z", "type": "commit"}, {"oid": "bba595c71c716857dea31077a6b1a405aed19675", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/bba595c71c716857dea31077a6b1a405aed19675", "message": "audit log test cases implemented for login controller", "committedDate": "2020-09-25T15:46:03Z", "type": "commit"}, {"oid": "0386e5a0582e19de170375c63828cd48a43a114f", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/0386e5a0582e19de170375c63828cd48a43a114f", "message": "user controller auditlog test cases implemented", "committedDate": "2020-09-26T08:05:45Z", "type": "commit"}, {"oid": "12251136e8bc83a830f8416a945e1a3a81843266", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/12251136e8bc83a830f8416a945e1a3a81843266", "message": "code formatted and bug fixed for login and user controller", "committedDate": "2020-09-26T14:48:26Z", "type": "commit"}, {"oid": "fb1a5e589dc3aeded860f9225959a3ff473cf738", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/fb1a5e589dc3aeded860f9225959a3ff473cf738", "message": "Merge branch 'develop' of https://github.com/GoogleCloudPlatform/fda-mystudies into study-builder-login-user-controller-auditlog-test-cases\n\n# Conflicts:\n#\tWCP/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/common/StudyBuilderAuditEvent.java\n#\tWCP/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/common/StudyBuilderConstants.java\n#\tWCP/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/controller/DashBoardAndProfileController.java\n#\tWCP/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/controller/NotificationController.java\n#\tWCP/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/controller/UsersController.java\n#\tWCP/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/dao/NotificationDAOImpl.java\n#\tWCP/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/dao/StudyDAO.java\n#\tWCP/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/service/DashBoardAndProfileServiceImpl.java\n#\tWCP/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/service/LoginServiceImpl.java\n#\tWCP/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/service/UsersServiceImpl.java\n#\tWCP/fdahpStudyDesigner/src/test/java/com/fdahpstudydesigner/common/BaseMockIT.java\n#\tWCP/fdahpStudyDesigner/src/test/java/com/fdahpstudydesigner/common/PathMappingUri.java\n#\tWCP/fdahpStudyDesigner/src/test/resources/import.sql", "committedDate": "2020-09-26T15:23:27Z", "type": "commit"}, {"oid": "85bdafd1a2e014acf672a47d668fa81e0c2e67dc", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/85bdafd1a2e014acf672a47d668fa81e0c2e67dc", "message": "code formatted and organized imported", "committedDate": "2020-09-26T15:25:14Z", "type": "commit"}, {"oid": "1261aa43921fe1558e70a3e32399018da1be5333", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/1261aa43921fe1558e70a3e32399018da1be5333", "message": "build issue fixed", "committedDate": "2020-09-28T09:25:15Z", "type": "commit"}, {"oid": "3985904233a8dfe2e82e26fed44a05794eb2a04e", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/3985904233a8dfe2e82e26fed44a05794eb2a04e", "message": "Merge branch 'develop' into study-builder-login-user-controller-auditlog-test-cases", "committedDate": "2020-09-28T14:02:12Z", "type": "commit"}, {"oid": "b06a33f2a822bfdd914e2be5fc5518c478c9482d", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/b06a33f2a822bfdd914e2be5fc5518c478c9482d", "message": "Merge branch 'develop' into study-builder-login-user-controller-auditlog-test-cases", "committedDate": "2020-09-28T17:12:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjEzOTg2MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1047#discussion_r496139861", "bodyText": "typo, please rename", "author": "saminguyen", "createdAt": "2020-09-28T18:08:25Z", "path": "WCP/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/controller/UsersController.java", "diffHunk": "@@ -62,6 +79,8 @@\n \n   @Autowired private UsersService usersService;\n \n+  @Autowired private StudyBuilderAuditEventHelper auditLogEvEntHelper;", "originalCommit": "b06a33f2a822bfdd914e2be5fc5518c478c9482d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE1MzUwOQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1047#discussion_r496153509", "bodyText": "Do we not check for the values being passed into the audit event in unit tests? We should check if the audit event call has the correct ${edited_user_id}, and same with other audit log requests", "author": "saminguyen", "createdAt": "2020-09-28T18:33:42Z", "path": "WCP/fdahpStudyDesigner/src/test/java/com/fdahpstudydesigner/controller/UsersControllerTest.java", "diffHunk": "@@ -0,0 +1,204 @@\n+package com.fdahpstudydesigner.controller;\n+\n+import static com.fdahpstudydesigner.common.StudyBuilderAuditEvent.ACCOUNT_DETAILS_VIEWED;\n+import static com.fdahpstudydesigner.common.StudyBuilderAuditEvent.NEW_USER_CREATION_FAILED;\n+import static com.fdahpstudydesigner.common.StudyBuilderAuditEvent.PASSWORD_CHANGE_ENFORCED_FOR_ALL_USERS;\n+import static com.fdahpstudydesigner.common.StudyBuilderAuditEvent.PASSWORD_CHANGE_ENFORCED_FOR_USER;\n+import static com.fdahpstudydesigner.common.StudyBuilderAuditEvent.PASSWORD_CHANGE_ENFORCEMENT_EMAIL_FAILED;\n+import static com.fdahpstudydesigner.common.StudyBuilderAuditEvent.PASSWORD_HELP_EMAIL_FAILED;\n+import static com.fdahpstudydesigner.common.StudyBuilderAuditEvent.USER_ACCOUNT_UPDATED_FAILED;\n+import static com.fdahpstudydesigner.common.StudyBuilderAuditEvent.USER_RECORD_VIEWED;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;\n+import static org.springframework.test.web.servlet.result.MockMvcResultHandlers.print;\n+import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;\n+import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.view;\n+import com.fdahpstudydesigner.common.BaseMockIT;\n+import com.fdahpstudydesigner.common.PathMappingUri;\n+import com.fdahpstudydesigner.util.FdahpStudyDesignerConstants;\n+import com.fdahpstudydesigner.util.SessionObject;\n+import java.util.HashMap;\n+import java.util.UUID;\n+import org.junit.Test;\n+import org.springframework.http.HttpHeaders;\n+\n+public class UsersControllerTest extends BaseMockIT {\n+\n+  @Test\n+  public void shouldViewUserDetails() throws Exception {\n+    HttpHeaders headers = getCommonHeaders();\n+\n+    mockMvc\n+        .perform(\n+            post(PathMappingUri.VIEW_USER_DETAILS.getPath())\n+                .param(\"userId\", \"2\")\n+                .param(\"checkViewRefreshFlag\", \"true\")\n+                .headers(headers)\n+                .sessionAttrs(getSession()))\n+        .andDo(print())\n+        .andExpect(status().isOk())\n+        .andExpect(view().name(\"addOrEditUserPage\"));\n+\n+    verifyAuditEventCall(ACCOUNT_DETAILS_VIEWED);\n+  }\n+\n+  @Test\n+  public void shouldUserRecordViewed() throws Exception {\n+    HttpHeaders headers = getCommonHeaders();\n+\n+    SessionObject session = new SessionObject();\n+    session.setSessionId(UUID.randomUUID().toString());\n+    session.setEmail(\"super@gmail.com\");\n+    session.setFirstName(\"firstname\");\n+    session.setLastName(\"lastname\");\n+    session.setAccessLevel(\"2\");\n+    session.setUserId(1);\n+\n+    HashMap<String, Object> sessionAttributes = new HashMap<String, Object>();\n+    sessionAttributes.put(FdahpStudyDesignerConstants.SESSION_OBJECT, session);\n+\n+    mockMvc\n+        .perform(\n+            post(PathMappingUri.VIEW_USER_DETAILS.getPath())\n+                .param(\"userId\", \"2\")\n+                .param(\"checkViewRefreshFlag\", \"true\")\n+                .headers(headers)\n+                .sessionAttrs(sessionAttributes))\n+        .andDo(print())\n+        .andExpect(status().isOk())\n+        .andExpect(view().name(\"addOrEditUserPage\"));\n+\n+    verifyAuditEventCall(USER_RECORD_VIEWED);\n+  }\n+\n+  @Test\n+  public void shouldResendActivateDetailsLink() throws Exception {\n+    HttpHeaders headers = getCommonHeaders();\n+\n+    mockMvc\n+        .perform(\n+            post(PathMappingUri.RESEND_ACTIVATE_DETAILS_LINK.getPath())\n+                .param(\"userId\", \"2\")\n+                .headers(headers)\n+                .sessionAttrs(getSession()))\n+        .andDo(print())\n+        .andExpect(status().isFound())\n+        .andExpect(view().name(\"redirect:/adminUsersView/getUserList.do\"));\n+\n+    // H2 database doesn't support Column \"BINARY\". Expect LoginDAOImpl throws\n+    // org.h2.jdbc.JdbcSQLException: Column \"BINARY\" not found;\n+    verifyAuditEventCall(PASSWORD_HELP_EMAIL_FAILED);\n+  }\n+\n+  @Test\n+  public void shouldEnforcePasswordChange() throws Exception {\n+    HttpHeaders headers = getCommonHeaders();\n+\n+    mockMvc\n+        .perform(\n+            post(PathMappingUri.ENFORCE_PASSWORD_CHANGE.getPath())\n+                .param(\"changePassworduserId\", \"2\")\n+                .param(\"emailId\", \"super@gmail.com\")\n+                .headers(headers)\n+                .sessionAttrs(getSession()))\n+        .andDo(print())\n+        .andExpect(status().isFound())\n+        .andExpect(view().name(\"redirect:/adminUsersView/getUserList.do\"));\n+\n+    verifyAuditEventCall(PASSWORD_CHANGE_ENFORCED_FOR_USER);", "originalCommit": "b06a33f2a822bfdd914e2be5fc5518c478c9482d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjgzOTMwNg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1047#discussion_r496839306", "bodyText": "We are setting all the required values in the session object.\nAll the required validations for audit log events are written in BaseMockIT class.", "author": "chiranjibi009", "createdAt": "2020-09-29T15:51:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE1MzUwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA0NDk5NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1047#discussion_r497044994", "bodyText": "Yes, I do see that that is the case. The only thing that is checked in the audit request's description though is that it does not contain any \"{\", \"}\". I am suggesting it might be helpful to check what values are actually being passed in the description, but that would probably be an enhancement for the future. I will approve this PR for now", "author": "saminguyen", "createdAt": "2020-09-29T20:51:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE1MzUwOQ=="}], "type": "inlineReview"}, {"oid": "a611ef53a9c51c67bc8ccf3def2ddc1c43540c8b", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/a611ef53a9c51c67bc8ccf3def2ddc1c43540c8b", "message": "typo error fixed", "committedDate": "2020-09-29T04:33:23Z", "type": "commit"}, {"oid": "87dc720f8a200e91c5663dac0212f3900dd04d13", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/87dc720f8a200e91c5663dac0212f3900dd04d13", "message": "Merge branch 'develop' of https://github.com/GoogleCloudPlatform/fda-mystudies into study-builder-login-user-controller-auditlog-test-cases\n\n# Conflicts:\n#\tWCP/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/common/StudyBuilderAuditEvent.java\n#\tWCP/fdahpStudyDesigner/src/test/java/com/fdahpstudydesigner/common/PathMappingUri.java\n#\tWCP/fdahpStudyDesigner/src/test/java/com/fdahpstudydesigner/controller/StudyControllerTest.java\n#\tWCP/fdahpStudyDesigner/src/test/resources/import.sql", "committedDate": "2020-09-29T05:28:42Z", "type": "commit"}, {"oid": "570ceb527046eff0396181d4ee4f044f149dab2c", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/570ceb527046eff0396181d4ee4f044f149dab2c", "message": "missing audit log added", "committedDate": "2020-09-29T08:58:28Z", "type": "commit"}, {"oid": "3a9710d53b3c0bc40659dcaf7b89ac2b3ef6ebeb", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/3a9710d53b3c0bc40659dcaf7b89ac2b3ef6ebeb", "message": "events added with test cases", "committedDate": "2020-09-29T11:57:47Z", "type": "commit"}, {"oid": "0e66df7e36dcd6d224f02d7830ce0507c9a8f5f1", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/0e66df7e36dcd6d224f02d7830ce0507c9a8f5f1", "message": "Merge branch 'develop' of https://github.com/GoogleCloudPlatform/fda-mystudies into study-builder-login-user-controller-auditlog-test-cases\n\n# Conflicts:\n#\tWCP/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/service/LoginServiceImpl.java\n#\tWCP/fdahpStudyDesigner/src/test/resources/import.sql", "committedDate": "2020-09-29T16:38:08Z", "type": "commit"}, {"oid": "566e5b6240ec497525e44a93e71f4acfa006f17f", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/566e5b6240ec497525e44a93e71f4acfa006f17f", "message": "typo error fixed", "committedDate": "2020-09-29T16:42:54Z", "type": "commit"}, {"oid": "afa6c3b5b6f47918e4107dfdd8add72ae55150df", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/afa6c3b5b6f47918e4107dfdd8add72ae55150df", "message": "Merge branch 'develop' into study-builder-login-user-controller-auditlog-test-cases", "committedDate": "2020-09-29T20:51:25Z", "type": "commit"}, {"oid": "ec6ff0c3cc9a8e2f69a3bb8b17d4d0c38140529a", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/ec6ff0c3cc9a8e2f69a3bb8b17d4d0c38140529a", "message": "Merge branch 'develop' of https://github.com/GoogleCloudPlatform/fda-mystudies into study-builder-login-user-controller-auditlog-test-cases\n\n# Conflicts:\n#\tWCP/fdahpStudyDesigner/src/main/java/com/fdahpstudydesigner/common/StudyBuilderAuditEvent.java", "committedDate": "2020-09-30T05:43:00Z", "type": "commit"}]}