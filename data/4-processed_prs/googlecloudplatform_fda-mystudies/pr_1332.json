{"pr_number": 1332, "pr_title": "Participant Manager : Fixed issue #1322, for GET /apps endpoint", "pr_createdAt": "2020-10-13T07:53:48Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1332", "timeline": [{"oid": "be38cf1ed47c8fbe7b31a2aeede56265576aa3c6", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/be38cf1ed47c8fbe7b31a2aeede56265576aa3c6", "message": "Fixed issue #1322\n\nFixed issue #1322", "committedDate": "2020-10-13T07:50:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDczODY2NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1332#discussion_r504738665", "bodyText": "Could you briefly explain this query and why this is needed to be created specifically for superadmin cases? Could we get the invited count for superadmin and other users in the same query?", "author": "saminguyen", "createdAt": "2020-10-14T14:46:30Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/repository/AppRepository.java", "diffHunk": "@@ -24,4 +26,31 @@\n \n   @Query(\"SELECT app from AppEntity app where app.appId=:appId\")\n   public Optional<AppEntity> findByAppId(String appId);\n+\n+  @Query(\n+      value =\n+          \"SELECT appId, SUM(target_invited_count) AS count \"\n+              + \"FROM ( \"\n+              + \"SELECT app.id AS appId, SUM(site.target_enrollment) AS target_invited_count \"\n+              + \"FROM app_info app, study_info AS si, sites site \"\n+              + \"WHERE app.id=si.app_info_id AND si.id=site.study_id AND si.type='OPEN' \"\n+              + \"GROUP BY app.id \"\n+              + \"UNION ALL \"\n+              + \"SELECT app.id AS appId, SUM(invitation_count) AS target_invited_count \"\n+              + \"FROM app_info app, study_info AS si, participant_registry_site prs \"\n+              + \"WHERE app.id=si.app_info_id AND si.id=prs.study_info_id \"\n+              + \"GROUP BY app.id \"\n+              + \") rstAlias \"\n+              + \"GROUP BY appId \",", "originalCommit": "be38cf1ed47c8fbe7b31a2aeede56265576aa3c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTUzNTQ2OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1332#discussion_r505535468", "bodyText": "For non super admin, we were calculating the invited count based on the site permission. By default super admin will be having all the permissions. So this query is written for Super Admin to calculate the invited count.", "author": "monica-BTC", "createdAt": "2020-10-15T13:20:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDczODY2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDczOTQ2Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1332#discussion_r504739466", "bodyText": "Check for other values in app details as well? Like the invited, enrollment counts and enrollmentPercentage", "author": "saminguyen", "createdAt": "2020-10-14T14:47:33Z", "path": "participant-manager-datastore/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/AppControllerTest.java", "diffHunk": "@@ -79,8 +79,29 @@ public void contextLoads() {\n     assertNotNull(appService);\n   }\n \n+  @Test\n+  public void shouldReturnAppsRegisteredByUserForSuperAdmin() throws Exception {\n+    HttpHeaders headers = testDataHelper.newCommonHeaders();\n+    headers.add(USER_ID_HEADER, userRegAdminEntity.getId());\n+\n+    mockMvc\n+        .perform(get(ApiEndpoint.GET_APPS.getPath()).headers(headers).contextPath(getContextPath()))\n+        .andDo(print())\n+        .andExpect(status().isOk())\n+        .andExpect(jsonPath(\"$.apps\").isArray())\n+        .andExpect(jsonPath(\"$.apps\", hasSize(1)))\n+        .andExpect(jsonPath(\"$.apps[0].customId\").value(appEntity.getAppId()))\n+        .andExpect(jsonPath(\"$.apps[0].name\").value(appEntity.getAppName()))\n+        .andExpect(jsonPath(\"$.superAdmin\").value(true));\n+", "originalCommit": "be38cf1ed47c8fbe7b31a2aeede56265576aa3c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTUzNTcwOQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1332#discussion_r505535709", "bodyText": "Fixed Review comment", "author": "monica-BTC", "createdAt": "2020-10-15T13:20:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDczOTQ2Ng=="}], "type": "inlineReview"}, {"oid": "9e84a1aae67c42aab0d80e3d3319f6c2104e224e", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/9e84a1aae67c42aab0d80e3d3319f6c2104e224e", "message": "Merge branch 'develop' into participant-manager-getApps-for-superAdmin-user", "committedDate": "2020-10-14T16:16:30Z", "type": "commit"}, {"oid": "458267111591cea9f3738b1c8f4dc995328c0879", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/458267111591cea9f3738b1c8f4dc995328c0879", "message": "fixed review comment\n\nfixed review comment", "committedDate": "2020-10-14T16:42:33Z", "type": "commit"}, {"oid": "6dc08884ee9b510a0c195003c5a493fb56a96296", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/6dc08884ee9b510a0c195003c5a493fb56a96296", "message": "Merge branch 'participant-manager-getApps-for-superAdmin-user' of https://github.com/GoogleCloudPlatform/fda-mystudies into participant-manager-getApps-for-superAdmin-user", "committedDate": "2020-10-14T16:43:13Z", "type": "commit"}, {"oid": "cfcd7cb9930d243a483ce30972dc9afd4a42d3a5", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/cfcd7cb9930d243a483ce30972dc9afd4a42d3a5", "message": "Merge branch 'develop' into participant-manager-getApps-for-superAdmin-user", "committedDate": "2020-10-15T13:33:24Z", "type": "commit"}, {"oid": "8e7e20d44afc6c538214839c89bb6b6822580e98", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/8e7e20d44afc6c538214839c89bb6b6822580e98", "message": "Merge branch 'develop' into participant-manager-getApps-for-superAdmin-user", "committedDate": "2020-10-15T14:21:48Z", "type": "commit"}]}