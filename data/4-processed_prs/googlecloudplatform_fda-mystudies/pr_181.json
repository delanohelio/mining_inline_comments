{"pr_number": 181, "pr_title": "Document the GKE cluster setup steps", "pr_createdAt": "2020-04-20T15:39:10Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/181", "timeline": [{"oid": "ecc5918fe037a3a7141caf168ece95946370f093", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/ecc5918fe037a3a7141caf168ece95946370f093", "message": "Add pointer to Kubernetes setup instructions", "committedDate": "2020-04-20T14:46:02Z", "type": "commit"}, {"oid": "3cd7b77dfd0108131854d3c6bbcbe6bf9c89b42c", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/3cd7b77dfd0108131854d3c6bbcbe6bf9c89b42c", "message": "Document the GKE cluster setup steps", "committedDate": "2020-04-20T15:38:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU0MzI4MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/181#discussion_r411543280", "bodyText": "Let's say  instead of . db-name refers to something different in MySQL. Same below.", "author": "kuoyuchi", "createdAt": "2020-04-20T17:04:10Z", "path": "kubernetes/README.md", "diffHunk": "@@ -0,0 +1,161 @@\n+# Kubernetes Setup\n+\n+This directory contains some Kubernetes resources common to all the apps.\n+\n+## Kubernetes Files Locations\n+\n+All files below are relative to the root of the repo.\n+\n+*   kubernetes/\n+    *   cert.yaml\n+        *   A Kubernetes ManagedCertificate for using\n+            [Google-managed SSL certificates](https://cloud.google.com/kubernetes-engine/docs/how-to/managed-certs).\n+    *   ingress.yaml\n+        *   A Kubernetes Ingress for routing HTTP calls to services in the\n+            cluster.\n+    *   pod_security_policy.yaml\n+        *   A restrictive Pod Security Policy that applies to the cluster apps.\n+    *   pod_security_policy-istio.yaml\n+        *   A looser Pod Security Policy that only applies to Istio containers\n+            in the cluster.\n+    *   kubeapply.sh\n+        *   A helper script that applies all resources to the cluster. Not\n+            required, the manual steps will be described below.\n+*   auth-server-ws/\n+    *   deployment.yaml\n+        *   A Kubernetes Deployment, deploying the app along with its secrets.\n+    *   service.yaml\n+        *   A Kubernetes Service, exposing the app to communicate with other\n+            apps and the Ingress.\n+*   response-server-ws/\n+    *   <same as auth-server-ws>\n+*   WCP/\n+    *   <same as auth-server-ws>\n+*   WCP-WS/\n+    *   <same as auth-server-ws>\n+*   user-registration-server-ws/\n+    *   <same as auth-server-ws>\n+\n+## Setup\n+\n+### Prerequisites\n+\n+Install the following dependencies and add them to your PATH:\n+\n+*   [gcloud](https://cloud.google.com/sdk/gcloud)\n+*   [gsutil](https://cloud.google.com/storage/docs/gsutil_install)\n+*   [kubectl](https://kubernetes.io/docs/tasks/tools/install-kubectl)\n+\n+Find the following project IDs:\n+\n+*   `<apps-project-id>`\n+*   `<data-project-id>`\n+\n+Substitute these in the following instructions.\n+\n+### Terraform\n+\n+Follow the [Terraform README.md](../Terraform/README.md) to create the\n+infrastructure. This will create a GKE cluster and a Cloud SQL MySQL database\n+instance.\n+\n+### SQL\n+\n+There are some SQL dump files in this repo that need to be imported before\n+deploying the apps.\n+\n+The gcloud import command only imports from GCS buckets, so first create a\n+bucket:\n+\n+```\n+$ gsutil mb gs://<data-project-id>-sql-import\n+```\n+\n+Now upload the files to the bucket:\n+\n+```\n+$ gsutil cp \\\n+  ./auth-server-ws/auth_server_db_script.sql \\\n+  ./WCP/sqlscript/HPHC_My_Studies_DB_Create_Script.sql \\\n+  ./response-server-ws/mystudies_response_server_db_script.sql \\\n+  ./user-registration-server-ws/sqlscript/mystudies_app_info_update_db_script.sql \\\n+  ./user-registration-server-ws/sqlscript/mystudies_user_registration_db_script.sql \\\n+gs://<data-project-id>-sql-import\n+```\n+\n+Find the name of your Cloud SQL DB instance and use it for importing the\n+scripts, in this order:\n+\n+```\n+$ gcloud sql import sql --project=<data-project-id> <db-name> gs://<data-project-id>-sql-import/auth_server_db_script.sql", "originalCommit": "80501448aad95c2bc9c6d733e5261b1f203057c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU0NDYwOA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/181#discussion_r411544608", "bodyText": "Sorry, I don't think I understand. Should I change \"db-name\" to something else?", "author": "MartinPetkov", "createdAt": "2020-04-20T17:06:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU0MzI4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU5MjM1NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/181#discussion_r411592354", "bodyText": "Got it. Changed it to \"instance-name\".", "author": "MartinPetkov", "createdAt": "2020-04-20T18:20:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU0MzI4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU0ODQ0Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/181#discussion_r411548447", "bodyText": "there are multiple files here that should all be run. You could simply use ./WCP/sqlscript/*\ne.g. procedures have all been moved to procedures.sql and there are some initial enum data in a third script required for applications to run.", "author": "zohrehj", "createdAt": "2020-04-20T17:12:02Z", "path": "kubernetes/README.md", "diffHunk": "@@ -0,0 +1,161 @@\n+# Kubernetes Setup\n+\n+This directory contains some Kubernetes resources common to all the apps.\n+\n+## Kubernetes Files Locations\n+\n+All files below are relative to the root of the repo.\n+\n+*   kubernetes/\n+    *   cert.yaml\n+        *   A Kubernetes ManagedCertificate for using\n+            [Google-managed SSL certificates](https://cloud.google.com/kubernetes-engine/docs/how-to/managed-certs).\n+    *   ingress.yaml\n+        *   A Kubernetes Ingress for routing HTTP calls to services in the\n+            cluster.\n+    *   pod_security_policy.yaml\n+        *   A restrictive Pod Security Policy that applies to the cluster apps.\n+    *   pod_security_policy-istio.yaml\n+        *   A looser Pod Security Policy that only applies to Istio containers\n+            in the cluster.\n+    *   kubeapply.sh\n+        *   A helper script that applies all resources to the cluster. Not\n+            required, the manual steps will be described below.\n+*   auth-server-ws/\n+    *   deployment.yaml\n+        *   A Kubernetes Deployment, deploying the app along with its secrets.\n+    *   service.yaml\n+        *   A Kubernetes Service, exposing the app to communicate with other\n+            apps and the Ingress.\n+*   response-server-ws/\n+    *   <same as auth-server-ws>\n+*   WCP/\n+    *   <same as auth-server-ws>\n+*   WCP-WS/\n+    *   <same as auth-server-ws>\n+*   user-registration-server-ws/\n+    *   <same as auth-server-ws>\n+\n+## Setup\n+\n+### Prerequisites\n+\n+Install the following dependencies and add them to your PATH:\n+\n+*   [gcloud](https://cloud.google.com/sdk/gcloud)\n+*   [gsutil](https://cloud.google.com/storage/docs/gsutil_install)\n+*   [kubectl](https://kubernetes.io/docs/tasks/tools/install-kubectl)\n+\n+Find the following project IDs:\n+\n+*   `<apps-project-id>`\n+*   `<data-project-id>`\n+\n+Substitute these in the following instructions.\n+\n+### Terraform\n+\n+Follow the [Terraform README.md](../Terraform/README.md) to create the\n+infrastructure. This will create a GKE cluster and a Cloud SQL MySQL database\n+instance.\n+\n+### SQL\n+\n+There are some SQL dump files in this repo that need to be imported before\n+deploying the apps.\n+\n+The gcloud import command only imports from GCS buckets, so first create a\n+bucket:\n+\n+```\n+$ gsutil mb gs://<data-project-id>-sql-import\n+```\n+\n+Now upload the files to the bucket:\n+\n+```\n+$ gsutil cp \\\n+  ./auth-server-ws/auth_server_db_script.sql \\\n+  ./WCP/sqlscript/HPHC_My_Studies_DB_Create_Script.sql \\", "originalCommit": "80501448aad95c2bc9c6d733e5261b1f203057c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU0ODY3MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/181#discussion_r411548671", "bodyText": "I am guessing other components have the same requirement", "author": "zohrehj", "createdAt": "2020-04-20T17:12:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU0ODQ0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU3NTM1MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/181#discussion_r411575350", "bodyText": "I looked in the early-access branch, and that's the only one that looks different. All the other .sql scripts are the same name.\nI've changed this to WCP/* and updated the import lines.", "author": "MartinPetkov", "createdAt": "2020-04-20T17:52:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU0ODQ0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU1NDU5Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/181#discussion_r411554597", "bodyText": "I am not sure what this line means, can you clarify what this is referring to?\nIf it's Cloud SQL DB instance, then maybe we could move this sentence above to maintain the context.", "author": "zohrehj", "createdAt": "2020-04-20T17:21:20Z", "path": "kubernetes/README.md", "diffHunk": "@@ -0,0 +1,161 @@\n+# Kubernetes Setup\n+\n+This directory contains some Kubernetes resources common to all the apps.\n+\n+## Kubernetes Files Locations\n+\n+All files below are relative to the root of the repo.\n+\n+*   kubernetes/\n+    *   cert.yaml\n+        *   A Kubernetes ManagedCertificate for using\n+            [Google-managed SSL certificates](https://cloud.google.com/kubernetes-engine/docs/how-to/managed-certs).\n+    *   ingress.yaml\n+        *   A Kubernetes Ingress for routing HTTP calls to services in the\n+            cluster.\n+    *   pod_security_policy.yaml\n+        *   A restrictive Pod Security Policy that applies to the cluster apps.\n+    *   pod_security_policy-istio.yaml\n+        *   A looser Pod Security Policy that only applies to Istio containers\n+            in the cluster.\n+    *   kubeapply.sh\n+        *   A helper script that applies all resources to the cluster. Not\n+            required, the manual steps will be described below.\n+*   auth-server-ws/\n+    *   deployment.yaml\n+        *   A Kubernetes Deployment, deploying the app along with its secrets.\n+    *   service.yaml\n+        *   A Kubernetes Service, exposing the app to communicate with other\n+            apps and the Ingress.\n+*   response-server-ws/\n+    *   <same as auth-server-ws>\n+*   WCP/\n+    *   <same as auth-server-ws>\n+*   WCP-WS/\n+    *   <same as auth-server-ws>\n+*   user-registration-server-ws/\n+    *   <same as auth-server-ws>\n+\n+## Setup\n+\n+### Prerequisites\n+\n+Install the following dependencies and add them to your PATH:\n+\n+*   [gcloud](https://cloud.google.com/sdk/gcloud)\n+*   [gsutil](https://cloud.google.com/storage/docs/gsutil_install)\n+*   [kubectl](https://kubernetes.io/docs/tasks/tools/install-kubectl)\n+\n+Find the following project IDs:\n+\n+*   `<apps-project-id>`\n+*   `<data-project-id>`\n+\n+Substitute these in the following instructions.\n+\n+### Terraform\n+\n+Follow the [Terraform README.md](../Terraform/README.md) to create the\n+infrastructure. This will create a GKE cluster and a Cloud SQL MySQL database\n+instance.\n+\n+### SQL\n+\n+There are some SQL dump files in this repo that need to be imported before\n+deploying the apps.\n+\n+The gcloud import command only imports from GCS buckets, so first create a\n+bucket:\n+\n+```\n+$ gsutil mb gs://<data-project-id>-sql-import\n+```\n+\n+Now upload the files to the bucket:\n+\n+```\n+$ gsutil cp \\\n+  ./auth-server-ws/auth_server_db_script.sql \\\n+  ./WCP/sqlscript/HPHC_My_Studies_DB_Create_Script.sql \\\n+  ./response-server-ws/mystudies_response_server_db_script.sql \\\n+  ./user-registration-server-ws/sqlscript/mystudies_app_info_update_db_script.sql \\\n+  ./user-registration-server-ws/sqlscript/mystudies_user_registration_db_script.sql \\\n+gs://<data-project-id>-sql-import\n+```\n+\n+Find the name of your Cloud SQL DB instance and use it for importing the\n+scripts, in this order:\n+\n+```\n+$ gcloud sql import sql --project=<data-project-id> <db-name> gs://<data-project-id>-sql-import/auth_server_db_script.sql\n+$ gcloud sql import sql --project=<data-project-id> <db-name> gs://<data-project-id>-sql-import/HPHC_My_Studies_DB_Create_Script.sql\n+$ gcloud sql import sql --project=<data-project-id> <db-name> gs://<data-project-id>-sql-import/mystudies_response_server_db_script.sql\n+$ gcloud sql import sql --project=<data-project-id> <db-name> gs://<data-project-id>-sql-import/mystudies_app_info_update_db_script.sql\n+$ gcloud sql import sql --project=<data-project-id> <db-name> gs://<data-project-id>-sql-import/mystudies_user_registration_db_script.sql\n+```\n+\n+Not that this is just the instance name, **not** the \"connection name\".", "originalCommit": "80501448aad95c2bc9c6d733e5261b1f203057c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU3ODIzMw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/181#discussion_r411578233", "bodyText": "If you go to the GCP console and see the instance details, there's a field called \"Instance connection name\". It might seem reasonable to use that in this command, but you're actually supposed to use just the instance name. This wasn't obvious to me when I was trying out commands, so I thought it worth mentioning.\nI've reworded this.", "author": "MartinPetkov", "createdAt": "2020-04-20T17:57:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU1NDU5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU1NTM2OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/181#discussion_r411555368", "bodyText": "Do we need to make a note that these values should also be replaced in the rest of the deployment files listed above?", "author": "zohrehj", "createdAt": "2020-04-20T17:22:33Z", "path": "kubernetes/README.md", "diffHunk": "@@ -0,0 +1,161 @@\n+# Kubernetes Setup\n+\n+This directory contains some Kubernetes resources common to all the apps.\n+\n+## Kubernetes Files Locations\n+\n+All files below are relative to the root of the repo.\n+\n+*   kubernetes/\n+    *   cert.yaml\n+        *   A Kubernetes ManagedCertificate for using\n+            [Google-managed SSL certificates](https://cloud.google.com/kubernetes-engine/docs/how-to/managed-certs).\n+    *   ingress.yaml\n+        *   A Kubernetes Ingress for routing HTTP calls to services in the\n+            cluster.\n+    *   pod_security_policy.yaml\n+        *   A restrictive Pod Security Policy that applies to the cluster apps.\n+    *   pod_security_policy-istio.yaml\n+        *   A looser Pod Security Policy that only applies to Istio containers\n+            in the cluster.\n+    *   kubeapply.sh\n+        *   A helper script that applies all resources to the cluster. Not\n+            required, the manual steps will be described below.\n+*   auth-server-ws/\n+    *   deployment.yaml\n+        *   A Kubernetes Deployment, deploying the app along with its secrets.\n+    *   service.yaml\n+        *   A Kubernetes Service, exposing the app to communicate with other\n+            apps and the Ingress.\n+*   response-server-ws/\n+    *   <same as auth-server-ws>\n+*   WCP/\n+    *   <same as auth-server-ws>\n+*   WCP-WS/\n+    *   <same as auth-server-ws>\n+*   user-registration-server-ws/\n+    *   <same as auth-server-ws>\n+\n+## Setup\n+\n+### Prerequisites\n+\n+Install the following dependencies and add them to your PATH:\n+\n+*   [gcloud](https://cloud.google.com/sdk/gcloud)\n+*   [gsutil](https://cloud.google.com/storage/docs/gsutil_install)\n+*   [kubectl](https://kubernetes.io/docs/tasks/tools/install-kubectl)\n+\n+Find the following project IDs:\n+\n+*   `<apps-project-id>`\n+*   `<data-project-id>`\n+\n+Substitute these in the following instructions.", "originalCommit": "80501448aad95c2bc9c6d733e5261b1f203057c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU3ODc5NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/181#discussion_r411578795", "bodyText": "Yes, probably. I'll add a section.", "author": "MartinPetkov", "createdAt": "2020-04-20T17:58:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU1NTM2OA=="}], "type": "inlineReview"}, {"oid": "e24a94124ee427dd580472b3b5d6d8812775abdb", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e24a94124ee427dd580472b3b5d6d8812775abdb", "message": "Merge branch 'terraform' into document-kubernetes-setup", "committedDate": "2020-04-20T18:03:38Z", "type": "commit"}, {"oid": "16dc9a36a66559bdd8f8a5f5947cba094b060936", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/16dc9a36a66559bdd8f8a5f5947cba094b060936", "message": "Address comments", "committedDate": "2020-04-20T18:05:44Z", "type": "commit"}, {"oid": "62576cce4ff7b71a8189e3bb2186e2b2d3114e64", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/62576cce4ff7b71a8189e3bb2186e2b2d3114e64", "message": "Change \"db-name\" to \"instance-name\"", "committedDate": "2020-04-20T18:19:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY0NDcxMA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/181#discussion_r411644710", "bodyText": "not sure if the order matters, but in case it does we should put procedures above the version_info", "author": "zohrehj", "createdAt": "2020-04-20T19:46:32Z", "path": "kubernetes/README.md", "diffHunk": "@@ -76,25 +76,52 @@ Now upload the files to the bucket:\n ```\n $ gsutil cp \\\n   ./auth-server-ws/auth_server_db_script.sql \\\n-  ./WCP/sqlscript/HPHC_My_Studies_DB_Create_Script.sql \\\n+  ./WCP/sqlscript/* \\\n   ./response-server-ws/mystudies_response_server_db_script.sql \\\n   ./user-registration-server-ws/sqlscript/mystudies_app_info_update_db_script.sql \\\n   ./user-registration-server-ws/sqlscript/mystudies_user_registration_db_script.sql \\\n gs://<data-project-id>-sql-import\n ```\n \n-Find the name of your Cloud SQL DB instance and use it for importing the\n-scripts, in this order:\n+Find the name of your Cloud SQL DB instance. If looking at the GCP Console, this\n+is just the instance name, is **not** the \"Instance connection name\". Example:\n+if the connection name is \"myproject-data:us-east1:my-studies-2\", you should use\n+just \"my-studies-2\".\n+\n+Import the scripts, in this order:\n \n ```\n $ gcloud sql import sql --project=<data-project-id> <db-name> gs://<data-project-id>-sql-import/auth_server_db_script.sql\n+$ gcloud sql import sql --project=<data-project-id> <db-name> gs://<data-project-id>-sql-import/version_info_script.sql\n+$ gcloud sql import sql --project=<data-project-id> <db-name> gs://<data-project-id>-sql-import/procedures.sql", "originalCommit": "16dc9a36a66559bdd8f8a5f5947cba094b060936", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY0NzY1NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/181#discussion_r411647655", "bodyText": "Done.", "author": "MartinPetkov", "createdAt": "2020-04-20T19:51:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY0NDcxMA=="}], "type": "inlineReview"}, {"oid": "71a0635ef377f58cc96586cda8123601ecc0c8d2", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/71a0635ef377f58cc96586cda8123601ecc0c8d2", "message": "Move procedures before version_info import", "committedDate": "2020-04-20T19:50:27Z", "type": "commit"}, {"oid": "626d55fc22ab00718a13de7fe3fe36216f66c406", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/626d55fc22ab00718a13de7fe3fe36216f66c406", "message": "Merge branch 'terraform' into document-kubernetes-setup", "committedDate": "2020-04-20T19:51:51Z", "type": "commit"}, {"oid": "73fb2c2f2044a7ea5079883df2b1ed4689f789f4", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/73fb2c2f2044a7ea5079883df2b1ed4689f789f4", "message": "Merge branch 'terraform' into document-kubernetes-setup", "committedDate": "2020-04-21T13:57:22Z", "type": "commit"}]}