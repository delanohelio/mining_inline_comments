{"pr_number": 1377, "pr_title": "Fixed issue #1205 Weak password generation process", "pr_createdAt": "2020-10-14T11:42:32Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1377", "timeline": [{"oid": "7eccaf42284504afb807d623ea4b060cd4153c85", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/7eccaf42284504afb807d623ea4b060cd4153c85", "message": "Fixed security issue Weak password generation process #1205\n\nFixed security issue Weak password generation process #1205.\nAdded test case.\ncode format + organize import.", "committedDate": "2020-10-14T11:39:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcxMzgwMQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1377#discussion_r504713801", "bodyText": "You are still using shuffle, the bug specifically asking to not use shuffle.", "author": "zohrehj", "createdAt": "2020-10-14T14:15:52Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/PasswordGenerator.java", "diffHunk": "@@ -8,42 +8,40 @@\n \n package com.google.cloud.healthcare.fdamystudies.common;\n \n-import java.security.SecureRandom;\n-import java.util.Arrays;\n import java.util.Collections;\n import java.util.List;\n+import java.util.stream.Collectors;\n+import org.apache.commons.text.RandomStringGenerator;\n+import org.apache.commons.text.RandomStringGenerator.Builder;\n+import org.apache.syncope.common.lib.SecureTextRandomProvider;\n \n public final class PasswordGenerator {\n \n-  private static final String[] ALLOWED_CHAR_GROUPS =\n-      new String[] {\n-        \"abcdefghijklmnopqrstuvwxyz\", \"ABCDEFGHIJKLMNOPQRSTUVWXYZ\", \"0123456789\", \"!#$%&\"\n-      };\n-\n-  private static SecureRandom secureRandom = new SecureRandom();\n+  public static final String SPECIAL_CHARS = \"!#$%&()*?@{}\";\n \n   private PasswordGenerator() {}\n \n   public static String generate(int length) {\n-    StringBuilder password = new StringBuilder();\n+    int count = length / 4;\n+    int extra = length % 4;\n \n-    while (password.length() < length) {\n-      for (int i = 0; i < ALLOWED_CHAR_GROUPS.length; i++) {\n-        int randomIndex = secureRandom.nextInt(ALLOWED_CHAR_GROUPS[i].length());\n-        password.append(ALLOWED_CHAR_GROUPS[i].charAt(randomIndex));\n-      }\n-    }\n+    Builder builder =\n+        new RandomStringGenerator.Builder().usingRandom(new SecureTextRandomProvider());\n \n-    return shuffle(password.toString());\n-  }\n-\n-  private static String shuffle(String value) {\n-    List<String> letters = Arrays.asList(value.split(\"\"));\n-    Collections.shuffle(letters);\n-    StringBuilder builder = new StringBuilder();\n-    for (String letter : letters) {\n-      builder.append(letter);\n-    }\n-    return builder.toString();\n+    StringBuilder password = new StringBuilder();\n+    password\n+        .append(builder.withinRange(48, 57).build().generate(count)) // numbers\n+        .append(builder.withinRange(65, 90).build().generate(count + extra)) // upper case letters\n+        .append(builder.withinRange(97, 122).build().generate(count)) // lower case letters\n+        .append(builder.selectFrom(SPECIAL_CHARS.toCharArray()).build().generate(count));\n+\n+    List<Character> passwordChars =\n+        password.chars().mapToObj(data -> (char) data).collect(Collectors.toList());\n+    Collections.shuffle(passwordChars);", "originalCommit": "7eccaf42284504afb807d623ea4b060cd4153c85", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc0MTk3OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1377#discussion_r504741979", "bodyText": "I have referred Generate a Secure Random Password in Java", "author": "harisboston", "createdAt": "2020-10-14T14:50:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcxMzgwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcxNDIwOQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1377#discussion_r504714209", "bodyText": "How about allowing your RandomStringGenerator to choose the order and placement of characters?\nnew RandomStringGenerator.Builder()\n            .usingRandom(new SecureTextRandomProvider())\n            .filteredBy(\n                    codePoint -> (codePoint >= 'a' && codePoint <= 'z') || (codePoint >= '0' && codePoint <= '9') || (codePoint >= 'A' && codePoint <= 'Z'))\n            .build();", "author": "zohrehj", "createdAt": "2020-10-14T14:16:26Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/PasswordGenerator.java", "diffHunk": "@@ -8,42 +8,40 @@\n \n package com.google.cloud.healthcare.fdamystudies.common;\n \n-import java.security.SecureRandom;\n-import java.util.Arrays;\n import java.util.Collections;\n import java.util.List;\n+import java.util.stream.Collectors;\n+import org.apache.commons.text.RandomStringGenerator;\n+import org.apache.commons.text.RandomStringGenerator.Builder;\n+import org.apache.syncope.common.lib.SecureTextRandomProvider;\n \n public final class PasswordGenerator {\n \n-  private static final String[] ALLOWED_CHAR_GROUPS =\n-      new String[] {\n-        \"abcdefghijklmnopqrstuvwxyz\", \"ABCDEFGHIJKLMNOPQRSTUVWXYZ\", \"0123456789\", \"!#$%&\"\n-      };\n-\n-  private static SecureRandom secureRandom = new SecureRandom();\n+  public static final String SPECIAL_CHARS = \"!#$%&()*?@{}\";\n \n   private PasswordGenerator() {}\n \n   public static String generate(int length) {\n-    StringBuilder password = new StringBuilder();\n+    int count = length / 4;\n+    int extra = length % 4;\n \n-    while (password.length() < length) {\n-      for (int i = 0; i < ALLOWED_CHAR_GROUPS.length; i++) {\n-        int randomIndex = secureRandom.nextInt(ALLOWED_CHAR_GROUPS[i].length());\n-        password.append(ALLOWED_CHAR_GROUPS[i].charAt(randomIndex));\n-      }\n-    }\n+    Builder builder =\n+        new RandomStringGenerator.Builder().usingRandom(new SecureTextRandomProvider());\n \n-    return shuffle(password.toString());\n-  }\n-\n-  private static String shuffle(String value) {\n-    List<String> letters = Arrays.asList(value.split(\"\"));\n-    Collections.shuffle(letters);\n-    StringBuilder builder = new StringBuilder();\n-    for (String letter : letters) {\n-      builder.append(letter);\n-    }\n-    return builder.toString();\n+    StringBuilder password = new StringBuilder();", "originalCommit": "7eccaf42284504afb807d623ea4b060cd4153c85", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc0MzE4Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1377#discussion_r504743183", "bodyText": "I am using withinRange to restrict the characters.", "author": "harisboston", "createdAt": "2020-10-14T14:52:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcxNDIwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc5MTk2Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1377#discussion_r504791963", "bodyText": "Using filter is easier to read, less code and removes the need to shuffle the characters afterwards. Please use filter.", "author": "zohrehj", "createdAt": "2020-10-14T15:56:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcxNDIwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg2MTUzMg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1377#discussion_r504861532", "bodyText": "We used filter but the generated password didn't match the password criteria - minimum 1 lowercase, uppercase, digit and special character. I've added below sample password generated when filter is used.  We replaced the decimal value with character to improve the readability in withinRange(). Reference: Class RandomStringGenerator\nT7JJX{GH\nTHsNf&Cb\nr?micyrz\neUN?sRur\ntVx6%RwD\nz%uctvj2\nI@YdoDjP\nMfMbB@Qf\ntdnk{Hry\na6W$gBH1\nqu&RmDyO\n7#yKvpEu", "author": "dhanyak-btc", "createdAt": "2020-10-14T17:47:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcxNDIwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk3MDc1Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1377#discussion_r504970753", "bodyText": "these are temporary passwords and do not need to match all conditions. Furthermore, your approach will always result in strings that are approximately 1/4 lowercase, 1/4 uppercase, etc; that is weaker than a fully randomly generated password.", "author": "zohrehj", "createdAt": "2020-10-14T21:03:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcxNDIwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTMxODI4OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1377#discussion_r505318288", "bodyText": "We are using the regex pattern in client-side and server-side to validate the password so temporary password must match the criteria. I've refactored the code to fix review comment.", "author": "dhanyak-btc", "createdAt": "2020-10-15T08:13:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcxNDIwOQ=="}], "type": "inlineReview"}, {"oid": "6b2ceb452487dedaa8ba8f5fd2e03b6904afe17e", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/6b2ceb452487dedaa8ba8f5fd2e03b6904afe17e", "message": "Merge branch 'develop' into oauth-server-password-generation-issue-1205", "committedDate": "2020-10-14T14:52:25Z", "type": "commit"}, {"oid": "21f6b4213a5c72ed98ea741f1c2645188515e5f8", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/21f6b4213a5c72ed98ea741f1c2645188515e5f8", "message": "Used number/letters instead of ASCII code\n\nUsed number/letters instead of ASCII code", "committedDate": "2020-10-14T17:45:51Z", "type": "commit"}, {"oid": "7c51f46c23a41a59d2133f246969c950db5a7d68", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/7c51f46c23a41a59d2133f246969c950db5a7d68", "message": "Refactored the code to match password criteria and fix review comments\n\nRefactored the code to match password criteria and fix review comments", "committedDate": "2020-10-15T10:35:53Z", "type": "commit"}, {"oid": "44fa888d187ee5dad6768692aaa446e07763c5d8", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/44fa888d187ee5dad6768692aaa446e07763c5d8", "message": "Merge branch 'develop' into oauth-server-password-generation-issue-1205", "committedDate": "2020-10-15T10:52:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTYwMTA1Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1377#discussion_r505601053", "bodyText": "please generate multiple passwords, e.g. 100, verify that each password is unique and that they are all valid.", "author": "zohrehj", "createdAt": "2020-10-15T14:44:08Z", "path": "oauth-scim-module/oauth-scim-service/src/test/java/com/google/cloud/healthcare/fdamystudies/oauthscim/common/PasswordGeneratorTest.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.oauthscim.common;\n+\n+import static org.junit.Assert.assertTrue;\n+\n+import com.google.cloud.healthcare.fdamystudies.common.PasswordGenerator;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.ValueSource;\n+\n+public class PasswordGeneratorTest {\n+\n+  @ParameterizedTest\n+  @ValueSource(ints = {8, 10, 12})\n+  public void isValidPassword(int passwordLength) {\n+    String password = PasswordGenerator.generate(passwordLength);", "originalCommit": "44fa888d187ee5dad6768692aaa446e07763c5d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDA3MTA2Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1377#discussion_r510071066", "bodyText": "Fixed review comment", "author": "harisboston", "createdAt": "2020-10-22T11:00:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTYwMTA1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTYwMjI0Mg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1377#discussion_r505602242", "bodyText": "Sort gets called when countMap is missing one of the categories, which means it only contains 2 keys at most.\nSort is a bit of an overkill when comparing these two keys; also you only want one that has > 1 character really.", "author": "zohrehj", "createdAt": "2020-10-15T14:45:40Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/PasswordGenerator.java", "diffHunk": "@@ -9,41 +9,134 @@\n package com.google.cloud.healthcare.fdamystudies.common;\n \n import java.security.SecureRandom;\n-import java.util.Arrays;\n-import java.util.Collections;\n-import java.util.List;\n+import java.util.Comparator;\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+import org.apache.commons.lang3.RandomStringUtils;\n+import org.apache.commons.text.RandomStringGenerator;\n+import org.apache.syncope.common.lib.SecureTextRandomProvider;\n \n public final class PasswordGenerator {\n \n-  private static final String[] ALLOWED_CHAR_GROUPS =\n-      new String[] {\n-        \"abcdefghijklmnopqrstuvwxyz\", \"ABCDEFGHIJKLMNOPQRSTUVWXYZ\", \"0123456789\", \"!#$%&\"\n-      };\n+  private static final String UPPERCASE_KEY = \"uppercase\";\n+\n+  private static final String LOWERCASE_KEY = \"lowercase\";\n+\n+  private static final String DIGITS_KEY = \"digits\";\n \n   private static SecureRandom secureRandom = new SecureRandom();\n \n+  public static final String SPECIAL_CHARS = \"!#$%&()*?@{}\";\n+\n   private PasswordGenerator() {}\n \n   public static String generate(int length) {\n-    StringBuilder password = new StringBuilder();\n+    if (length < 8) {\n+      throw new IllegalArgumentException(\"Password should be 8 characters long\");\n+    }\n+\n+    String password =\n+        new RandomStringGenerator.Builder()\n+            .usingRandom(new SecureTextRandomProvider())\n+            .filteredBy(\n+                codePoint ->\n+                    (codePoint >= 'a' && codePoint <= 'z')\n+                        || (codePoint >= '0' && codePoint <= '9')\n+                        || (codePoint >= 'A' && codePoint <= 'Z'))\n+            .build()\n+            .generate(length - 1);\n+\n+    StringBuilder builder = new StringBuilder(password);\n+    char specialChar = SPECIAL_CHARS.charAt(secureRandom.nextInt(SPECIAL_CHARS.length()));\n+    int position = secureRandom.nextInt(password.length());\n+    builder.insert(position, specialChar);\n \n-    while (password.length() < length) {\n-      for (int i = 0; i < ALLOWED_CHAR_GROUPS.length; i++) {\n-        int randomIndex = secureRandom.nextInt(ALLOWED_CHAR_GROUPS[i].length());\n-        password.append(ALLOWED_CHAR_GROUPS[i].charAt(randomIndex));\n+    return convertToValidPassword(builder.toString());\n+  }\n+\n+  private static String convertToValidPassword(String password) {\n+    char[] passwordChars = password.toCharArray();\n+    Map<String, Integer> countMap = new HashMap<>();\n+    for (char c : passwordChars) {\n+      if (Character.isDigit(c)) {\n+        incrementCount(countMap, DIGITS_KEY);\n+      } else if (Character.isLowerCase(c)) {\n+        incrementCount(countMap, LOWERCASE_KEY);\n+      } else if (Character.isUpperCase(c)) {\n+        incrementCount(countMap, UPPERCASE_KEY);\n       }\n     }\n \n-    return shuffle(password.toString());\n+    if (countMap.containsKey(DIGITS_KEY)\n+        && countMap.containsKey(LOWERCASE_KEY)\n+        && countMap.containsKey(UPPERCASE_KEY)) {\n+      return password;\n+    }\n+\n+    addMissingChar(passwordChars, countMap, DIGITS_KEY);\n+    addMissingChar(passwordChars, countMap, LOWERCASE_KEY);\n+    addMissingChar(passwordChars, countMap, UPPERCASE_KEY);\n+    return String.valueOf(passwordChars);\n+  }\n+\n+  private static void addMissingChar(\n+      char[] passwordChars, Map<String, Integer> countMap, String key) {\n+    char randomChar = getRandomChar(key);\n+    if (!countMap.containsKey(key)) {\n+      countMap = sortMapByValue(countMap);\n+      String firstKey = countMap.entrySet().iterator().next().getKey();\n+      int position = findFirstIndexOf(passwordChars, firstKey);\n+      passwordChars[position] = randomChar;\n+      countMap.put(key, 1);\n+    }\n+  }\n+\n+  private static char getRandomChar(String key) {\n+    char value = 0;\n+    if (DIGITS_KEY.equals(key)) {\n+      int digit = secureRandom.nextInt(9);\n+      value = Character.forDigit(digit, 10);\n+    } else if (LOWERCASE_KEY.equals(key)) {\n+      value = RandomStringUtils.randomAlphabetic(1).toLowerCase().charAt(0);\n+    } else if (UPPERCASE_KEY.equals(key)) {\n+      value = RandomStringUtils.randomAlphabetic(1).toUpperCase().charAt(0);\n+    }\n+    return value;\n   }\n \n-  private static String shuffle(String value) {\n-    List<String> letters = Arrays.asList(value.split(\"\"));\n-    Collections.shuffle(letters);\n-    StringBuilder builder = new StringBuilder();\n-    for (String letter : letters) {\n-      builder.append(letter);\n+  private static void incrementCount(Map<String, Integer> countMap, String key) {\n+    if (countMap.containsKey(key)) {\n+      countMap.put(key, countMap.get(key) + 1);\n+    } else {\n+      countMap.put(key, 1);\n     }\n-    return builder.toString();\n+  }\n+\n+  private static int findFirstIndexOf(char[] letters, String key) {\n+    for (int i = 0; i < letters.length; i++) {\n+      if (Character.isDigit(letters[i]) && DIGITS_KEY.equals(key)) {\n+        return i;\n+      } else if (Character.isLowerCase(letters[i]) && LOWERCASE_KEY.equals(key)) {\n+        return i;\n+      } else if (Character.isUpperCase(letters[i]) && UPPERCASE_KEY.equals(key)) {\n+        return i;\n+      }\n+    }\n+    return 0;\n+  }\n+\n+  private static Map<String, Integer> sortMapByValue(Map<String, Integer> countMap) {\n+    return countMap\n+        .entrySet()\n+        .stream()\n+        .sorted(Map.Entry.comparingByValue(Comparator.reverseOrder()))\n+        .collect(\n+            Collectors.toMap(\n+                Map.Entry::getKey,\n+                Map.Entry::getValue,\n+                (oldValue, newValue) -> oldValue,\n+                LinkedHashMap::new));\n   }\n }", "originalCommit": "44fa888d187ee5dad6768692aaa446e07763c5d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDA3MTEzMQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1377#discussion_r510071131", "bodyText": "Fixed review comment", "author": "harisboston", "createdAt": "2020-10-22T11:00:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTYwMjI0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTYxNDc0Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1377#discussion_r505614746", "bodyText": "instead of doing this, I would select a random position; check if the countMap for that key exists and if it does whether there are more than one, then replace it with my random character of different type. Finally update the countMap for both keys.\nprivate static bool insertNewChar(Map<String, Integer> countMap, String key) {\n  int position = secureRandom.nextInt(password.length());\n  char newChar = getRandomChar(key);\n  char oldChar = passwordChars[position];\n  if (Character.isDigit(oldChar) && CountMap.get(DIGITS_KEY) > 1) {\n    passwordChars[position] = newChar;\n    incrementCount(countMap, key);\n    decrementCount(countMap, DIGITS_KEY);\n    return true;\n  } else if (Character.isLowerCase(oldChar) && LOWERCASE_KEY.equals(key)) {\n    // same for other two\n  } else {\n    return false;\n  }\n}\n\n// inside addMissingChar ...\n...\nwhile !insertNewChar(countMap, key) {}", "author": "zohrehj", "createdAt": "2020-10-15T15:00:43Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/PasswordGenerator.java", "diffHunk": "@@ -9,41 +9,134 @@\n package com.google.cloud.healthcare.fdamystudies.common;\n \n import java.security.SecureRandom;\n-import java.util.Arrays;\n-import java.util.Collections;\n-import java.util.List;\n+import java.util.Comparator;\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+import org.apache.commons.lang3.RandomStringUtils;\n+import org.apache.commons.text.RandomStringGenerator;\n+import org.apache.syncope.common.lib.SecureTextRandomProvider;\n \n public final class PasswordGenerator {\n \n-  private static final String[] ALLOWED_CHAR_GROUPS =\n-      new String[] {\n-        \"abcdefghijklmnopqrstuvwxyz\", \"ABCDEFGHIJKLMNOPQRSTUVWXYZ\", \"0123456789\", \"!#$%&\"\n-      };\n+  private static final String UPPERCASE_KEY = \"uppercase\";\n+\n+  private static final String LOWERCASE_KEY = \"lowercase\";\n+\n+  private static final String DIGITS_KEY = \"digits\";\n \n   private static SecureRandom secureRandom = new SecureRandom();\n \n+  public static final String SPECIAL_CHARS = \"!#$%&()*?@{}\";\n+\n   private PasswordGenerator() {}\n \n   public static String generate(int length) {\n-    StringBuilder password = new StringBuilder();\n+    if (length < 8) {\n+      throw new IllegalArgumentException(\"Password should be 8 characters long\");\n+    }\n+\n+    String password =\n+        new RandomStringGenerator.Builder()\n+            .usingRandom(new SecureTextRandomProvider())\n+            .filteredBy(\n+                codePoint ->\n+                    (codePoint >= 'a' && codePoint <= 'z')\n+                        || (codePoint >= '0' && codePoint <= '9')\n+                        || (codePoint >= 'A' && codePoint <= 'Z'))\n+            .build()\n+            .generate(length - 1);\n+\n+    StringBuilder builder = new StringBuilder(password);\n+    char specialChar = SPECIAL_CHARS.charAt(secureRandom.nextInt(SPECIAL_CHARS.length()));\n+    int position = secureRandom.nextInt(password.length());\n+    builder.insert(position, specialChar);\n \n-    while (password.length() < length) {\n-      for (int i = 0; i < ALLOWED_CHAR_GROUPS.length; i++) {\n-        int randomIndex = secureRandom.nextInt(ALLOWED_CHAR_GROUPS[i].length());\n-        password.append(ALLOWED_CHAR_GROUPS[i].charAt(randomIndex));\n+    return convertToValidPassword(builder.toString());\n+  }\n+\n+  private static String convertToValidPassword(String password) {\n+    char[] passwordChars = password.toCharArray();\n+    Map<String, Integer> countMap = new HashMap<>();\n+    for (char c : passwordChars) {\n+      if (Character.isDigit(c)) {\n+        incrementCount(countMap, DIGITS_KEY);\n+      } else if (Character.isLowerCase(c)) {\n+        incrementCount(countMap, LOWERCASE_KEY);\n+      } else if (Character.isUpperCase(c)) {\n+        incrementCount(countMap, UPPERCASE_KEY);\n       }\n     }\n \n-    return shuffle(password.toString());\n+    if (countMap.containsKey(DIGITS_KEY)\n+        && countMap.containsKey(LOWERCASE_KEY)\n+        && countMap.containsKey(UPPERCASE_KEY)) {\n+      return password;\n+    }\n+\n+    addMissingChar(passwordChars, countMap, DIGITS_KEY);\n+    addMissingChar(passwordChars, countMap, LOWERCASE_KEY);\n+    addMissingChar(passwordChars, countMap, UPPERCASE_KEY);\n+    return String.valueOf(passwordChars);\n+  }\n+\n+  private static void addMissingChar(\n+      char[] passwordChars, Map<String, Integer> countMap, String key) {\n+    char randomChar = getRandomChar(key);\n+    if (!countMap.containsKey(key)) {\n+      countMap = sortMapByValue(countMap);\n+      String firstKey = countMap.entrySet().iterator().next().getKey();\n+      int position = findFirstIndexOf(passwordChars, firstKey);\n+      passwordChars[position] = randomChar;", "originalCommit": "44fa888d187ee5dad6768692aaa446e07763c5d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDA3MTE5Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1377#discussion_r510071196", "bodyText": "Fixed review comment", "author": "harisboston", "createdAt": "2020-10-22T11:01:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTYxNDc0Ng=="}], "type": "inlineReview"}, {"oid": "1e8f40c8cb708de57a5a105064c81bb52ec9143b", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/1e8f40c8cb708de57a5a105064c81bb52ec9143b", "message": "Modified test case\n\nModified test case", "committedDate": "2020-10-16T17:02:23Z", "type": "commit"}, {"oid": "f97a68ab6109a91bd712d3e933622e330ce055ff", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/f97a68ab6109a91bd712d3e933622e330ce055ff", "message": "working on PR\n\nworking on PR", "committedDate": "2020-10-18T17:39:32Z", "type": "commit"}, {"oid": "b2872577dffd6fd7a72570fa4b10ba14358b750d", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/b2872577dffd6fd7a72570fa4b10ba14358b750d", "message": "Fixed issue #1205 Weak password generation process #1377\n\nFixed issue #1205 Weak password generation process\n#1377", "committedDate": "2020-10-22T10:22:41Z", "type": "commit"}, {"oid": "060565dd86b52ec713f1262c5148210a4f7bbc6a", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/060565dd86b52ec713f1262c5148210a4f7bbc6a", "message": "Fixed issue #1205 Weak password generation process #1377\n\nFixed issue #1205 Weak password generation process\n#1377", "committedDate": "2020-10-22T10:56:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDA2OTM3NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1377#discussion_r510069375", "bodyText": "[auth-server Checks] reported by reviewdog \ud83d\udc36\nMissing a Javadoc comment.", "author": "github-actions", "createdAt": "2020-10-22T10:57:54Z", "path": "oauth-scim-module/oauth-scim-service/src/test/java/com/google/cloud/healthcare/fdamystudies/oauthscim/common/PasswordGeneratorTest.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.oauthscim.common;\n+\n+import static org.junit.Assert.assertTrue;\n+\n+import com.google.cloud.healthcare.fdamystudies.common.PasswordGenerator;\n+import java.util.HashSet;\n+import java.util.Set;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.ValueSource;\n+\n+public class PasswordGeneratorTest {\n+\n+  @ParameterizedTest", "originalCommit": "060565dd86b52ec713f1262c5148210a4f7bbc6a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDA2OTM3OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1377#discussion_r510069378", "bodyText": "[auth-server Checks] reported by reviewdog \ud83d\udc36\nMissing a Javadoc comment.", "author": "github-actions", "createdAt": "2020-10-22T10:57:54Z", "path": "oauth-scim-module/oauth-scim-service/src/test/java/com/google/cloud/healthcare/fdamystudies/oauthscim/common/PasswordGeneratorTest.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.oauthscim.common;\n+\n+import static org.junit.Assert.assertTrue;\n+\n+import com.google.cloud.healthcare.fdamystudies.common.PasswordGenerator;\n+import java.util.HashSet;\n+import java.util.Set;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.ValueSource;\n+\n+public class PasswordGeneratorTest {\n+\n+  @ParameterizedTest\n+  @ValueSource(ints = {8, 10, 12})\n+  public void genaratePassword(int passwordLength) {\n+    Set<String> passwords = new HashSet<>();\n+    for (int i = 0; i < 100; i++) {\n+      String password = genarateUniqueValidPassword(passwordLength);\n+      assertTrue(passwords.add(password));\n+    }\n+  }\n+\n+  public String genarateUniqueValidPassword(int passwordLength) {", "originalCommit": "060565dd86b52ec713f1262c5148210a4f7bbc6a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDE4Nzk4OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1377#discussion_r510187989", "bodyText": "the list is very limited, some other possible characters to consider: .;:,-_'\"/\\|=+^", "author": "zohrehj", "createdAt": "2020-10-22T14:03:14Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/PasswordGenerator.java", "diffHunk": "@@ -9,41 +9,134 @@\n package com.google.cloud.healthcare.fdamystudies.common;\n \n import java.security.SecureRandom;\n-import java.util.Arrays;\n-import java.util.Collections;\n-import java.util.List;\n+import java.util.HashMap;\n+import java.util.Map;\n+import org.apache.commons.lang3.RandomStringUtils;\n+import org.apache.commons.text.RandomStringGenerator;\n+import org.apache.syncope.common.lib.SecureTextRandomProvider;\n \n public final class PasswordGenerator {\n \n-  private static final String[] ALLOWED_CHAR_GROUPS =\n-      new String[] {\n-        \"abcdefghijklmnopqrstuvwxyz\", \"ABCDEFGHIJKLMNOPQRSTUVWXYZ\", \"0123456789\", \"!#$%&\"\n-      };\n+  private static final String UPPERCASE_KEY = \"uppercase\";\n+\n+  private static final String LOWERCASE_KEY = \"lowercase\";\n+\n+  private static final String DIGITS_KEY = \"digits\";\n \n   private static SecureRandom secureRandom = new SecureRandom();\n \n+  public static final String SPECIAL_CHARS = \"!#$%&()*?@{}\";", "originalCommit": "060565dd86b52ec713f1262c5148210a4f7bbc6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM2MTM1Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1377#discussion_r510361353", "bodyText": "Fixed review comment", "author": "harisboston", "createdAt": "2020-10-22T18:11:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDE4Nzk4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDE5MTk4NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1377#discussion_r510191984", "bodyText": "these two lines are not checking anything; your if condition matches your assertTrue condition.\nAlso considering we test for length 8, 10 and 12, password.length() should never be zero, if that happens your test should fail.", "author": "zohrehj", "createdAt": "2020-10-22T14:08:29Z", "path": "oauth-scim-module/oauth-scim-service/src/test/java/com/google/cloud/healthcare/fdamystudies/oauthscim/common/PasswordGeneratorTest.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Use of this source code is governed by an MIT-style\n+ * license that can be found in the LICENSE file or at\n+ * https://opensource.org/licenses/MIT.\n+ */\n+\n+package com.google.cloud.healthcare.fdamystudies.oauthscim.common;\n+\n+import static org.junit.Assert.assertTrue;\n+\n+import com.google.cloud.healthcare.fdamystudies.common.PasswordGenerator;\n+import java.util.HashSet;\n+import java.util.Set;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.ValueSource;\n+\n+public class PasswordGeneratorTest {\n+\n+  @ParameterizedTest\n+  @ValueSource(ints = {8, 10, 12})\n+  public void genaratePassword(int passwordLength) {\n+    Set<String> passwords = new HashSet<>();\n+    for (int i = 0; i < 100; i++) {\n+      String password = genarateUniqueValidPassword(passwordLength);\n+      assertTrue(passwords.add(password));\n+    }\n+  }\n+\n+  public String genarateUniqueValidPassword(int passwordLength) {\n+    String password = PasswordGenerator.generate(passwordLength);\n+\n+    boolean lowerCase = false;\n+    boolean upperCase = false;\n+    boolean numeric = false;\n+    boolean specialChar = false;\n+\n+    for (char c : password.toCharArray()) {\n+      if (Character.isDigit(c)) {\n+        numeric = true;\n+      } else if (Character.isLowerCase(c)) {\n+        lowerCase = true;\n+      } else if (Character.isUpperCase(c)) {\n+        upperCase = true;\n+      } else if (PasswordGenerator.SPECIAL_CHARS.contains(String.valueOf(c))) {\n+        specialChar = true;\n+      }\n+    }\n+\n+    if (password.length() == 0) {\n+      assertTrue(\"should return empty value\", password.length() == 0);", "originalCommit": "060565dd86b52ec713f1262c5148210a4f7bbc6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM2MTQzOQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1377#discussion_r510361439", "bodyText": "Fixed review comment", "author": "harisboston", "createdAt": "2020-10-22T18:11:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDE5MTk4NA=="}], "type": "inlineReview"}, {"oid": "d2d767154fcecd54ed9775898f0ba00b7929d52b", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/d2d767154fcecd54ed9775898f0ba00b7929d52b", "message": "Firxed review comments #1377\n\nFirxed review comments #1377", "committedDate": "2020-10-22T15:16:38Z", "type": "commit"}, {"oid": "24b2b36eba3e858890df0e4c73a64dc3ff143bea", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/24b2b36eba3e858890df0e4c73a64dc3ff143bea", "message": "Merge branch 'develop' into oauth-server-password-generation-issue-1205", "committedDate": "2020-10-22T15:20:03Z", "type": "commit"}, {"oid": "e4b1b4a77dbc7b1318afe5ff07c5202a8800a725", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e4b1b4a77dbc7b1318afe5ff07c5202a8800a725", "message": "Fixed build issue\n\nFixed build issue", "committedDate": "2020-10-22T17:30:38Z", "type": "commit"}, {"oid": "d3147d497bea02da38b7421319a044404dfcfa5a", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/d3147d497bea02da38b7421319a044404dfcfa5a", "message": "Fixed build issue\n\nFixed build issue", "committedDate": "2020-10-22T17:52:44Z", "type": "commit"}, {"oid": "85f8f626ec617ea3fa376a192f7adb1dd4598369", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/85f8f626ec617ea3fa376a192f7adb1dd4598369", "message": "Merge branch 'develop' into oauth-server-password-generation-issue-1205", "committedDate": "2020-10-22T18:02:08Z", "type": "commit"}, {"oid": "572756f44f64e243240c4f9fb0b0ae8dbc1d5468", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/572756f44f64e243240c4f9fb0b0ae8dbc1d5468", "message": "Merge branch 'develop' into oauth-server-password-generation-issue-1205", "committedDate": "2020-10-23T04:03:58Z", "type": "commit"}]}