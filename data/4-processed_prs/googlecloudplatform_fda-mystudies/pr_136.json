{"pr_number": 136, "pr_title": "Add bastion host.", "pr_createdAt": "2020-04-12T19:14:52Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/136", "timeline": [{"oid": "86b4a01ed17c35a5989db79f37156b81f468dcdf", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/86b4a01ed17c35a5989db79f37156b81f468dcdf", "message": "Add bastion host.", "committedDate": "2020-04-12T19:17:07Z", "type": "forcePushed"}, {"oid": "ac6eb464411ed38128127ddd55694a43f15330b3", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/ac6eb464411ed38128127ddd55694a43f15330b3", "message": "Add bastion host.", "committedDate": "2020-04-12T19:22:07Z", "type": "forcePushed"}, {"oid": "1b7b4137d430a54128055a8a560a96fc941a7819", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/1b7b4137d430a54128055a8a560a96fc941a7819", "message": "Add bastion host.", "committedDate": "2020-04-12T19:26:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE5ODQ0OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/136#discussion_r408198448", "bodyText": "Do you need to run apt-get -y update first?", "author": "MartinPetkov", "createdAt": "2020-04-14T14:50:30Z", "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-networks/networks/bastion.tf", "diffHunk": "@@ -0,0 +1,48 @@\n+# Copyright 2020 Google Inc.\n+#\n+# Licensed under the Apache License, Version 2.0 (the \"License\");\n+# you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+#      http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+# $ gcloud compute ssh bastion-vm --zone=<var.zone> --project=<var.project_id>\n+# $ sudo apt install mysql-client-core-5.7", "originalCommit": "bcfe9119e6fa47e7f6cbd2e72d06b528c3e43087", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM5MjU2NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/136#discussion_r408392565", "bodyText": "Done.", "author": "xingao267", "createdAt": "2020-04-14T19:48:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE5ODQ0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIwMjQ1Mg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/136#discussion_r408202452", "bodyText": "My preference would be to continue calling this \"gke_region\", since the module is a generic \"networks\", and it might not be obvious to someone passing in variables that \"region\" also affects the GKE cluster.", "author": "MartinPetkov", "createdAt": "2020-04-14T14:55:18Z", "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-networks/networks/variables.tf", "diffHunk": "@@ -2,9 +2,13 @@ variable \"project_id\" {\n   type = string\n }\n \n-variable \"gke_region\" {\n-  description = \"The region where the network and subnets will be created for the GKE clusters\"\n-  default     = \"us-central1\"\n+variable \"region\" {", "originalCommit": "bcfe9119e6fa47e7f6cbd2e72d06b528c3e43087", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1ODEzOA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/136#discussion_r408258138", "bodyText": "I would actually lean towards the change here -- this network is shared amongst GKE and cloud sql and the terragrunt dependency tree clarifies that. So being gke centric probably isn't completely accurate. It would make sense if we create dedicated GKE networks and dedicated cloud sql networks in different regions, etc.", "author": "umairidris", "createdAt": "2020-04-14T16:08:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIwMjQ1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI4NjkwNg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/136#discussion_r408286906", "bodyText": "Ack. I suppose if we ever start doing that, we can split the naming and have two variables.", "author": "MartinPetkov", "createdAt": "2020-04-14T16:50:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIwMjQ1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIwNDMxNg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/136#discussion_r408204316", "bodyText": "How come the bastion host is in the same subnet as the GKE clusters?", "author": "MartinPetkov", "createdAt": "2020-04-14T14:57:27Z", "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-networks/networks/bastion.tf", "diffHunk": "@@ -0,0 +1,48 @@\n+# Copyright 2020 Google Inc.\n+#\n+# Licensed under the Apache License, Version 2.0 (the \"License\");\n+# you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+#      http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+# $ gcloud compute ssh bastion-vm --zone=<var.zone> --project=<var.project_id>\n+# $ sudo apt install mysql-client-core-5.7\n+# $ mysql -h <sql_internal_ip> -u root\n+module \"iap_bastion\" {\n+  source = \"terraform-google-modules/bastion-host/google\"\n+\n+  name         = \"bastion-vm\"\n+  host_project = var.project_id\n+  project      = var.project_id\n+  region       = var.region\n+  zone         = var.zone\n+  network      = module.private.network_self_link\n+  subnet       = local.gke_subnet.self_link", "originalCommit": "bcfe9119e6fa47e7f6cbd2e72d06b528c3e43087", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ3MDc4Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/136#discussion_r408470786", "bodyText": "Created a separate subnet and used that in NAT.", "author": "xingao267", "createdAt": "2020-04-14T22:22:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIwNDMxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIwNTI3MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/136#discussion_r408205271", "bodyText": "Could this be done through the startup_script parameter?", "author": "MartinPetkov", "createdAt": "2020-04-14T14:58:37Z", "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-networks/networks/bastion.tf", "diffHunk": "@@ -0,0 +1,48 @@\n+# Copyright 2020 Google Inc.\n+#\n+# Licensed under the Apache License, Version 2.0 (the \"License\");\n+# you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+#      http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+# $ gcloud compute ssh bastion-vm --zone=<var.zone> --project=<var.project_id>", "originalCommit": "bcfe9119e6fa47e7f6cbd2e72d06b528c3e43087", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ3MDY0NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/136#discussion_r408470644", "bodyText": "Done.", "author": "xingao267", "createdAt": "2020-04-14T22:22:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIwNTI3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIwNjE5Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/136#discussion_r408206197", "bodyText": "I think this is brittle, in that a user could easily forget to remove this block and re-apply the Terraform configs. Is there maybe a VM family that already has this package installed?", "author": "MartinPetkov", "createdAt": "2020-04-14T14:59:36Z", "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-networks/networks/bastion.tf", "diffHunk": "@@ -0,0 +1,48 @@\n+# Copyright 2020 Google Inc.\n+#\n+# Licensed under the Apache License, Version 2.0 (the \"License\");\n+# you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+#      http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+# $ gcloud compute ssh bastion-vm --zone=<var.zone> --project=<var.project_id>\n+# $ sudo apt install mysql-client-core-5.7\n+# $ mysql -h <sql_internal_ip> -u root\n+module \"iap_bastion\" {\n+  source = \"terraform-google-modules/bastion-host/google\"\n+\n+  name         = \"bastion-vm\"\n+  host_project = var.project_id\n+  project      = var.project_id\n+  region       = var.region\n+  zone         = var.zone\n+  network      = module.private.network_self_link\n+  subnet       = local.gke_subnet.self_link\n+  image_family = \"ubuntu-1804-lts\"\n+  members      = var.bastion_users\n+}\n+\n+# Temporarily allow bastion-VM to connect to the Internet to install `mysql-client-core-5.7`.", "originalCommit": "bcfe9119e6fa47e7f6cbd2e72d06b528c3e43087", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ0NzIwNQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/136#discussion_r408447205", "bodyText": "I think we can set source_subnetwork_ip_ranges_to_nat on the NAT to be a specific subnet and then create the bastion host in that subnet. Then other resources can't access the NAT and we can just leave the NAT resource on that subnet (don't need to delete). That should simplify the setup as well.", "author": "umairidris", "createdAt": "2020-04-14T21:29:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIwNjE5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ3MDYxNg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/136#discussion_r408470616", "bodyText": "Done.", "author": "xingao267", "createdAt": "2020-04-14T22:22:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIwNjE5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1ODM0Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/136#discussion_r408258346", "bodyText": "The default settings are likely suitable here, no need to set them", "author": "umairidris", "createdAt": "2020-04-14T16:08:37Z", "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-networks/networks/bastion.tf", "diffHunk": "@@ -0,0 +1,48 @@\n+# Copyright 2020 Google Inc.\n+#\n+# Licensed under the Apache License, Version 2.0 (the \"License\");\n+# you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+#      http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+# $ gcloud compute ssh bastion-vm --zone=<var.zone> --project=<var.project_id>\n+# $ sudo apt install mysql-client-core-5.7\n+# $ mysql -h <sql_internal_ip> -u root\n+module \"iap_bastion\" {\n+  source = \"terraform-google-modules/bastion-host/google\"\n+\n+  name         = \"bastion-vm\"\n+  host_project = var.project_id\n+  project      = var.project_id\n+  region       = var.region\n+  zone         = var.zone\n+  network      = module.private.network_self_link\n+  subnet       = local.gke_subnet.self_link\n+  image_family = \"ubuntu-1804-lts\"\n+  members      = var.bastion_users\n+}\n+\n+# Temporarily allow bastion-VM to connect to the Internet to install `mysql-client-core-5.7`.\n+# Remove after installation.\n+module \"cloud-nat\" {\n+  source  = \"terraform-google-modules/cloud-router/google\"\n+  name    = \"bastion-router\"\n+  region  = var.region\n+  project = var.project_id\n+  network = module.private.network_name\n+  nats = [{\n+    name                             = \"bastion-nat\"\n+    min_ports_per_vm                 = \"64\"", "originalCommit": "bcfe9119e6fa47e7f6cbd2e72d06b528c3e43087", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM5MzgyNg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/136#discussion_r408393826", "bodyText": "Done.", "author": "xingao267", "createdAt": "2020-04-14T19:50:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1ODM0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI2NjQwMg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/136#discussion_r408266402", "bodyText": "Isn't there a startup script that can be set?", "author": "umairidris", "createdAt": "2020-04-14T16:20:15Z", "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-networks/networks/bastion.tf", "diffHunk": "@@ -0,0 +1,48 @@\n+# Copyright 2020 Google Inc.\n+#\n+# Licensed under the Apache License, Version 2.0 (the \"License\");\n+# you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+#      http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+# $ gcloud compute ssh bastion-vm --zone=<var.zone> --project=<var.project_id>\n+# $ sudo apt install mysql-client-core-5.7", "originalCommit": "bcfe9119e6fa47e7f6cbd2e72d06b528c3e43087", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ3MDU4Mg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/136#discussion_r408470582", "bodyText": "Done.", "author": "xingao267", "createdAt": "2020-04-14T22:21:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI2NjQwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI3MTI0MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/136#discussion_r408271241", "bodyText": "This doesn't make a difference btw, it will just set the min to be 2.2 but if there is a version higher than 2.2 then it will pick that anyway when doing 2.0. That's why I typically prefer doing x.0 versions just to pin to a major version for most modules that are not complex.", "author": "umairidris", "createdAt": "2020-04-14T16:27:12Z", "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-networks/networks/main.tf", "diffHunk": "@@ -8,7 +8,7 @@ locals {\n \n module \"private\" {\n   source  = \"terraform-google-modules/network/google\"\n-  version = \"~> 2.0\"\n+  version = \"~> 2.2\"", "originalCommit": "bcfe9119e6fa47e7f6cbd2e72d06b528c3e43087", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI3MzQ1Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/136#discussion_r408273456", "bodyText": "Though the way you did it is probably good because we don't want versions below 2.2 since we use some features from 2.2", "author": "umairidris", "createdAt": "2020-04-14T16:30:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI3MTI0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQwMDQ0NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/136#discussion_r408400445", "bodyText": "I actually got an error because of the network output feature you added in 2.2 so I set it to 2.2.", "author": "xingao267", "createdAt": "2020-04-14T20:02:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI3MTI0MQ=="}], "type": "inlineReview"}, {"oid": "803792e991edd2198cc7fe2ca3712b3b27f7bf0b", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/803792e991edd2198cc7fe2ca3712b3b27f7bf0b", "message": "Add bastion host.", "committedDate": "2020-04-14T22:21:28Z", "type": "commit"}, {"oid": "e0522b44d8ebbcd3828182cc3dd801ed7a1c2b0d", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e0522b44d8ebbcd3828182cc3dd801ed7a1c2b0d", "message": "Add NAT.", "committedDate": "2020-04-14T22:21:28Z", "type": "commit"}, {"oid": "3572cc305718000d863afd41a6f964456daa3a65", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/3572cc305718000d863afd41a6f964456daa3a65", "message": "Fix format.", "committedDate": "2020-04-14T22:21:29Z", "type": "commit"}, {"oid": "ac2a37ba89177e01b76790c907c15d99db32e1a0", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/ac2a37ba89177e01b76790c907c15d99db32e1a0", "message": "Add VM startup script and restrict NAT source IP range.", "committedDate": "2020-04-14T22:21:29Z", "type": "commit"}, {"oid": "ac2a37ba89177e01b76790c907c15d99db32e1a0", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/ac2a37ba89177e01b76790c907c15d99db32e1a0", "message": "Add VM startup script and restrict NAT source IP range.", "committedDate": "2020-04-14T22:21:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ3NzIyOQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/136#discussion_r408477229", "bodyText": "cloud_nat", "author": "umairidris", "createdAt": "2020-04-14T22:39:27Z", "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-networks/networks/bastion.tf", "diffHunk": "@@ -0,0 +1,57 @@\n+# Copyright 2020 Google Inc.\n+#\n+# Licensed under the Apache License, Version 2.0 (the \"License\");\n+# you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+#      http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+# $ gcloud compute ssh bastion-vm --zone=<var.zone> --project=<var.project_id>\n+# $ mysql -h <sql_internal_ip> -u root\n+module \"iap_bastion\" {\n+  source = \"terraform-google-modules/bastion-host/google\"\n+\n+  name           = \"bastion-vm\"\n+  host_project   = var.project_id\n+  project        = var.project_id\n+  region         = var.region\n+  zone           = var.zone\n+  network        = module.private.network_self_link\n+  subnet         = module.private.subnets[\"${var.region}/${local.bastion_subnet_name}\"].self_link\n+  image_family   = \"ubuntu-1804-lts\"\n+  members        = var.bastion_users\n+  startup_script = <<EOF\n+#!/bin/bash\n+dpkg -l mysql-client-core-5.7\n+if [ $? -eq 0 ]; then\n+  echo \"mysql-client already installed\"\n+else\n+  sudo apt-get -y update\n+  sudo apt-get -y install mysql-client-core-5.7\n+fi\n+EOF\n+}\n+\n+# NAT to allow bastion-VM to connect to the Internet to install `mysql-client-core-5.7`.\n+module \"cloud-nat\" {", "originalCommit": "ac2a37ba89177e01b76790c907c15d99db32e1a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ3NzMyOQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/136#discussion_r408477329", "bodyText": "Or actually, bastion_router is probably a better name", "author": "umairidris", "createdAt": "2020-04-14T22:39:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ3NzIyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ3Nzk1OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/136#discussion_r408477958", "bodyText": "Done.", "author": "xingao267", "createdAt": "2020-04-14T22:41:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ3NzIyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ3NzY3NA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/136#discussion_r408477674", "bodyText": "Do we still need to check or we can always just install mysql?", "author": "umairidris", "createdAt": "2020-04-14T22:40:40Z", "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-networks/networks/bastion.tf", "diffHunk": "@@ -0,0 +1,57 @@\n+# Copyright 2020 Google Inc.\n+#\n+# Licensed under the Apache License, Version 2.0 (the \"License\");\n+# you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+#      http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+# $ gcloud compute ssh bastion-vm --zone=<var.zone> --project=<var.project_id>\n+# $ mysql -h <sql_internal_ip> -u root\n+module \"iap_bastion\" {\n+  source = \"terraform-google-modules/bastion-host/google\"\n+\n+  name           = \"bastion-vm\"\n+  host_project   = var.project_id\n+  project        = var.project_id\n+  region         = var.region\n+  zone           = var.zone\n+  network        = module.private.network_self_link\n+  subnet         = module.private.subnets[\"${var.region}/${local.bastion_subnet_name}\"].self_link\n+  image_family   = \"ubuntu-1804-lts\"\n+  members        = var.bastion_users\n+  startup_script = <<EOF\n+#!/bin/bash\n+dpkg -l mysql-client-core-5.7", "originalCommit": "ac2a37ba89177e01b76790c907c15d99db32e1a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ3ODMwNQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/136#discussion_r408478305", "bodyText": "Still put it here just in case the nat got removed.", "author": "xingao267", "createdAt": "2020-04-14T22:42:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ3NzY3NA=="}], "type": "inlineReview"}, {"oid": "e0bc1d0b87e9b6abca10eca2d4dfab116e7f3ea9", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e0bc1d0b87e9b6abca10eca2d4dfab116e7f3ea9", "message": "naming", "committedDate": "2020-04-14T22:42:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ3OTE2MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/136#discussion_r408479161", "bodyText": "Nit, but this could just be\nif dpkg -l mysql-client-core-5.7; then\n...", "author": "MartinPetkov", "createdAt": "2020-04-14T22:44:54Z", "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-networks/networks/bastion.tf", "diffHunk": "@@ -0,0 +1,57 @@\n+# Copyright 2020 Google Inc.\n+#\n+# Licensed under the Apache License, Version 2.0 (the \"License\");\n+# you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+#      http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+# $ gcloud compute ssh bastion-vm --zone=<var.zone> --project=<var.project_id>\n+# $ mysql -h <sql_internal_ip> -u root\n+module \"bastion\" {\n+  source = \"terraform-google-modules/bastion-host/google\"\n+\n+  name           = \"bastion-vm\"\n+  host_project   = var.project_id\n+  project        = var.project_id\n+  region         = var.region\n+  zone           = var.zone\n+  network        = module.private.network_self_link\n+  subnet         = module.private.subnets[\"${var.region}/${local.bastion_subnet_name}\"].self_link\n+  image_family   = \"ubuntu-1804-lts\"\n+  members        = var.bastion_users\n+  startup_script = <<EOF\n+#!/bin/bash\n+dpkg -l mysql-client-core-5.7", "originalCommit": "e0bc1d0b87e9b6abca10eca2d4dfab116e7f3ea9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUwNTgwNg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/136#discussion_r408505806", "bodyText": "Done.", "author": "xingao267", "createdAt": "2020-04-15T00:06:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ3OTE2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ4MDQwNQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/136#discussion_r408480405", "bodyText": "This comment is a great idea, thanks.", "author": "MartinPetkov", "createdAt": "2020-04-14T22:48:28Z", "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-networks/networks/main.tf", "diffHunk": "@@ -4,21 +4,33 @@ terraform {\n \n locals {\n   gke_clusters_subnet_name = \"gke-clusters-subnet\"\n+  bastion_subnet_name      = \"bastion-subnet\"\n }\n \n module \"private\" {\n   source  = \"terraform-google-modules/network/google\"\n-  version = \"~> 2.0\"\n+  version = \"~> 2.2\"\n \n   project_id   = var.project_id\n   network_name = \"private\"\n \n-  # Multiple clusters can be in the same network and subnet.\n   subnets = [\n     {\n-      subnet_name      = local.gke_clusters_subnet_name\n+      # Multiple clusters can be in the same network and subnet.\n+      subnet_name = local.gke_clusters_subnet_name\n+      # 10.0.0.0 --> 10.0.127.255", "originalCommit": "e0bc1d0b87e9b6abca10eca2d4dfab116e7f3ea9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUwMzk2Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/136#discussion_r408503967", "bodyText": "np", "author": "xingao267", "createdAt": "2020-04-15T00:00:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ4MDQwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ4MTIyNA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/136#discussion_r408481224", "bodyText": "Nit: I don't see a reason to reserve 255 IPs for just one host, I suspect this would work with a /30 range too. But if it works, I don't insist on changing it.", "author": "MartinPetkov", "createdAt": "2020-04-14T22:50:40Z", "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-networks/networks/main.tf", "diffHunk": "@@ -4,21 +4,33 @@ terraform {\n \n locals {\n   gke_clusters_subnet_name = \"gke-clusters-subnet\"\n+  bastion_subnet_name      = \"bastion-subnet\"\n }\n \n module \"private\" {\n   source  = \"terraform-google-modules/network/google\"\n-  version = \"~> 2.0\"\n+  version = \"~> 2.2\"\n \n   project_id   = var.project_id\n   network_name = \"private\"\n \n-  # Multiple clusters can be in the same network and subnet.\n   subnets = [\n     {\n-      subnet_name      = local.gke_clusters_subnet_name\n+      # Multiple clusters can be in the same network and subnet.\n+      subnet_name = local.gke_clusters_subnet_name\n+      # 10.0.0.0 --> 10.0.127.255\n       subnet_ip        = \"10.0.0.0/17\"\n-      subnet_region    = var.gke_region\n+      subnet_region    = var.region\n+      subnet_flow_logs = \"true\"\n+\n+      # Needed for access to Cloud SQL.\n+      subnet_private_access = \"true\"\n+    },\n+    {\n+      subnet_name = local.bastion_subnet_name\n+      # 10.0.128.0 --> 10.0.128.255\n+      subnet_ip        = \"10.0.128.0/24\"", "originalCommit": "e0bc1d0b87e9b6abca10eca2d4dfab116e7f3ea9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUwMzkyMg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/136#discussion_r408503922", "bodyText": "Yea, i know. Just reserve in case we later add other stuff to this subnet. And also, when you destroy and recreate VM, it takes a new IP.", "author": "xingao267", "createdAt": "2020-04-15T00:00:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ4MTIyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ4MjUyMw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/136#discussion_r408482523", "bodyText": "remove quotes", "author": "umairidris", "createdAt": "2020-04-14T22:54:24Z", "path": "Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-networks/networks/main.tf", "diffHunk": "@@ -4,21 +4,33 @@ terraform {\n \n locals {\n   gke_clusters_subnet_name = \"gke-clusters-subnet\"\n+  bastion_subnet_name      = \"bastion-subnet\"\n }\n \n module \"private\" {\n   source  = \"terraform-google-modules/network/google\"\n-  version = \"~> 2.0\"\n+  version = \"~> 2.2\"\n \n   project_id   = var.project_id\n   network_name = \"private\"\n \n-  # Multiple clusters can be in the same network and subnet.\n   subnets = [\n     {\n-      subnet_name      = local.gke_clusters_subnet_name\n+      # Multiple clusters can be in the same network and subnet.\n+      subnet_name = local.gke_clusters_subnet_name\n+      # 10.0.0.0 --> 10.0.127.255\n       subnet_ip        = \"10.0.0.0/17\"\n-      subnet_region    = var.gke_region\n+      subnet_region    = var.region\n+      subnet_flow_logs = \"true\"", "originalCommit": "e0bc1d0b87e9b6abca10eca2d4dfab116e7f3ea9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUwMzYwNA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/136#discussion_r408503604", "bodyText": "Done", "author": "xingao267", "createdAt": "2020-04-14T23:59:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ4MjUyMw=="}], "type": "inlineReview"}, {"oid": "71104bc82052a81cef5b214bbb52f8cfe663c181", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/71104bc82052a81cef5b214bbb52f8cfe663c181", "message": "address code review comments", "committedDate": "2020-04-15T00:06:24Z", "type": "commit"}]}