{"pr_number": 1235, "pr_title": "Add script to create superadmin account for Participant Manager", "pr_createdAt": "2020-10-08T18:44:42Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1235", "timeline": [{"oid": "26077b80727609a3916d842842b13cf703eca0e8", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/26077b80727609a3916d842842b13cf703eca0e8", "message": "Add script to create superadmin account for Participant Manager", "committedDate": "2020-10-14T18:36:17Z", "type": "commit"}, {"oid": "0b2e271bb0dca7acb529b4fb8bdb9449d20d3feb", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/0b2e271bb0dca7acb529b4fb8bdb9449d20d3feb", "message": "Use replace instead of update", "committedDate": "2020-10-14T18:36:23Z", "type": "commit"}, {"oid": "28085b4a761e1a4fb85081d22240e0c9937c8722", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/28085b4a761e1a4fb85081d22240e0c9937c8722", "message": "Update script with latest password hash changes", "committedDate": "2020-10-14T18:40:07Z", "type": "commit"}, {"oid": "28085b4a761e1a4fb85081d22240e0c9937c8722", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/28085b4a761e1a4fb85081d22240e0c9937c8722", "message": "Update script with latest password hash changes", "committedDate": "2020-10-14T18:40:07Z", "type": "forcePushed"}, {"oid": "50d3a7e7272a09f624e64fbc611b684fac77032d", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/50d3a7e7272a09f624e64fbc611b684fac77032d", "message": "Translate participant-datastore superadmin sql to bash", "committedDate": "2020-10-14T20:02:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk2NjI0NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1235#discussion_r504966245", "bodyText": "@aswinijena100 I copied the security code from the sql script in participant manager, where is this value coming from?", "author": "zohrehj", "createdAt": "2020-10-14T20:54:42Z", "path": "scripts/create_participant_manager_superadmin.sh", "diffHunk": "@@ -0,0 +1,66 @@\n+# Script to insert the first participant manager superadmin into auth server.\n+# Run like:\n+# $ ./scripts/create_participant_manager_superadmin.sh <email> <password>\n+\n+#!/bin/bash\n+\n+if [ \"$#\" -ne 2 ]; then\n+  echo 'Please provide email and password in the order of <email> <password>'\n+  exit 1\n+fi\n+\n+EMAIL=\"${1}\"\n+PWD=\"${2}\"\n+shift 2\n+\n+set -e\n+\n+DATA_PROJECT=${PREFIX}-${ENV}-data\n+SQL_IMPORT_BUCKET=${PREFIX}-${ENV}-mystudies-sql-import\n+\n+echo \"Inserting/updating superadmin user in 'oauth_server_hydra' database\"\n+echo \"USE \\`oauth_server_hydra\\`;\" >> ${TMPFILE}\n+\n+SALT=`printf \"%s\" uuidgen | iconv -t utf-8 | openssl dgst -sha512 | sed 's/^.* //'`\n+HASH=`printf \"%s%s\" $SALT $PWD | iconv -t utf-8 | openssl dgst -sha512 | sed 's/^.* //'`\n+DATE=`date -v +30d +\"%F %T\"`\n+TIMESTAMP=`date -d \"$DATE\" +'%s.%3N'`\n+\n+TMPFILE=$(mktemp)\n+\n+echo \"REPLACE into users (id, app_id, email, status, temp_reg_id, user_id, user_info)\n+  values(\n+  \\\"8ad16a8c74f823a10174f82c9a300001\\\",\n+  \\\"PARTICIPANT MANAGER\\\",\n+  \\\"${EMAIL}\\\",\n+  0,\n+  \\\"bd676334dd745c6afaa6547f9736a4c4df411a3ca2c4f514070daae31008cd9d\\\",\n+  \\\"96494ebc2ae5ac344437ec19bfc0b09267a876015b277e1f6e9bfc871f578508\\\",\n+  \\\"{\\\"password\\\": {\\\"hash\\\": \\\"${HASH}\\\", \\\"salt\\\": \\\"${SALT}\\\", \\\"expire_timestamp\\\":${TIMESTAMP}}, \\\"password_history\\\": [{\\\"hash\\\": \\\"${HASH}\\\", \\\"salt\\\": \\\"${SALT}\\\", \\\"expire_timestamp\\\":${TIMESTAMP}}]}\\\");\n+\" >> ${TMPFILE}\n+\n+\n+echo \"USE \\`mystudies_participant_datastore\\`;\" >> ${TMPFILE}\n+echo \"Insert default location\"\n+echo \"REPLACE INTO locations\n+  (id, custom_id, is_default, name, status)\n+VALUES\n+\t(\\\"1\\\", \\\"location1\\\", \\\"Y\\\", \\\"Default Location\\\", 1);\n+\" >> ${TMPFILE}\n+\n+echo \"Insert ur_admin_user record in 'mystudies_participant_datastore' database\"\n+echo \"REPLACE INTO ur_admin_user\n+  (id, created_by, email, first_name, location_permission, security_code, security_code_expire_date, status, super_admin, ur_admin_auth_id)\n+VALUES\n+  (\\\"c9d30d67-0477-4a8c-8490-0fa1e0300bd0\\\", \\\"1\\\", \\\"${EMAIL}\\\", \\\"Admin\\\", 1, \\\"af92f34e0ae6fc3c707446797b7db5b4be78ec699899061a448f8bc18990d75f\\\", \\\"2022-09-25 20:06:43\\\", 1, b'1', \\\"96494ebc2ae5ac344437ec19bfc0b09267a876015b277e1f6e9bfc871f578508\\\");", "originalCommit": "50d3a7e7272a09f624e64fbc611b684fac77032d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTM1NjY4Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1235#discussion_r505356686", "bodyText": "@zohrehj The security code generated in the application itself while adding a user.  We are using IdGenerator.java to generate the security code.", "author": "aswinijena100", "createdAt": "2020-10-15T08:46:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk2NjI0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjYxODk2MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1235#discussion_r506618961", "bodyText": "@aswinijena100 any updates on where this security code is used?", "author": "zohrehj", "createdAt": "2020-10-16T17:26:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk2NjI0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjYyNjYzNQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1235#discussion_r506626635", "bodyText": "@zohrehj sorry for the delay in response. This security code is used to validate the account activation link sent to user's email  when a new user is added to Participant Manager. Please find code snippet for your refence in UserProfileController.java in participant manager datastore.\n@GetMapping(\nvalue = \"/users/securitycodes/{securityCode}\",\nproduces = MediaType.APPLICATION_JSON_VALUE)\npublic ResponseEntity getUserDetails(\n@PathVariable String securityCode, HttpServletRequest request) {\nlogger.entry(String.format(BEGIN_REQUEST_LOG, request.getRequestURI()));\nAuditLogEventRequest auditRequest = AuditEventMapper.fromHttpServletRequest(request);\nUserProfileResponse userProfileResponse =\nuserProfileService.findUserProfileBySecurityCode(securityCode, auditRequest);\nlogger.exit(String.format(STATUS_LOG, userProfileResponse.getHttpStatusCode()));\nreturn ResponseEntity.status(userProfileResponse.getHttpStatusCode()).body(userProfileResponse);\n\n}", "author": "aswinijena100", "createdAt": "2020-10-16T17:39:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk2NjI0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg1NzIzMQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/1235#discussion_r507857231", "bodyText": "Updated, thanks", "author": "zohrehj", "createdAt": "2020-10-19T15:44:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk2NjI0NQ=="}], "type": "inlineReview"}, {"oid": "059fa019dfc7bafb4fb0f1f676398851c5e388c5", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/059fa019dfc7bafb4fb0f1f676398851c5e388c5", "message": "Merge branch 'develop' into superadmin", "committedDate": "2020-10-16T17:26:57Z", "type": "commit"}, {"oid": "f19ab8a4aaa64d88cca8e212ecfede28d8d285bb", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/f19ab8a4aaa64d88cca8e212ecfede28d8d285bb", "message": "Merge branch 'develop' into superadmin", "committedDate": "2020-10-19T14:35:30Z", "type": "commit"}, {"oid": "de66fff06a029b747099b10ac8b19d885a078d17", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/de66fff06a029b747099b10ac8b19d885a078d17", "message": "Update superadmin script to generate securityCode", "committedDate": "2020-10-19T15:43:17Z", "type": "commit"}, {"oid": "8d3d7179c348a6710188b1cc541d4fca2afe7b23", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/8d3d7179c348a6710188b1cc541d4fca2afe7b23", "message": "Merge branch 'develop' into superadmin", "committedDate": "2020-10-19T15:44:12Z", "type": "commit"}]}