{"pr_number": 414, "pr_title": "Fix storing dashboard data back to DB on new session.", "pr_createdAt": "2020-05-21T18:08:55Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/414", "timeline": [{"oid": "0527d345e1f4ba968d4cb67ee5b0ada99f56473f", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/0527d345e1f4ba968d4cb67ee5b0ada99f56473f", "message": "Fix storing dashboard data back to DB on new session.", "committedDate": "2020-05-21T18:04:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgzOTI5MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/414#discussion_r428839290", "bodyText": "why is \"labkeyresponse\" text is needed?\nincidentally, I would prefer if we remove the work labkey entirely from the code, since it is accurate anymore.", "author": "zohrehj", "createdAt": "2020-05-21T18:37:04Z", "path": "iOS/HPHC/HPHC/Views/UIViews+Additions/Activity/ActivitySchedule/ActivitySchedules.swift", "diffHunk": "@@ -228,29 +228,30 @@ class ResponseDataFetch: NMWebServiceDelegate {\n           let count = (value[\"count\"] as? Float)!\n           let dateString = value[\"date\"] as? String ?? \"\"\n           // SetData Format\n-          if let date = ResponseDataFetch.responseDateFormatter.date(from: dateString) {\n-            let localDateAsString = ResponseDataFetch.localDateFormatter.string(from: date)\n-            if let localDate = ResponseDataFetch.localDateFormatter.date(\n-              from: localDateAsString\n-            ) {\n-              // Save Stats to DB\n-              DBHandler.saveStatisticsDataFor(\n-                activityId: activityId!,\n-                key: key!,\n-                data: responseValue,\n-                fkDuration: Int(count),\n-                date: localDate\n-              )\n-            }\n+          if let date = ResponseDataFetch.responseDateFormatter.date(from: dateString),\n+            let key = key,\n+            let activityID = activityId\n+          {\n+            // Save Stats to DB\n+            DBHandler.saveStatisticsDataFor(\n+              activityId: activityID,\n+              key: key,\n+              data: responseValue,\n+              fkDuration: Int(count),\n+              date: date\n+            )\n           }\n         }\n       }\n-      let key = \"LabKeyResponse\" + (Study.currentStudy?.studyId)!\n+    }\n+\n+    if let studyID = Study.currentStudy?.studyId {\n+      let key = \"LabKeyResponse\" + studyID", "originalCommit": "0527d345e1f4ba968d4cb67ee5b0ada99f56473f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMzNDUyOA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/414#discussion_r429334528", "bodyText": "I see it has been used at a couple of other places as a hardcoded String. Do you want me to update that in this PR or shall I make changes and open another PR?\nChanges will require one round of QA testing.", "author": "tushar-boston", "createdAt": "2020-05-22T16:13:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgzOTI5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk1NTgwMQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/414#discussion_r429955801", "bodyText": "feel free to open another PR.", "author": "zohrehj", "createdAt": "2020-05-25T14:11:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgzOTI5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg0MTAzMQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/414#discussion_r428841031", "bodyText": "what happens if the casting fails? it doesn't look like the case is handled.", "author": "zohrehj", "createdAt": "2020-05-21T18:40:23Z", "path": "iOS/HPHC/HPHC/Views/UIViews+Additions/Activity/ActivitySchedule/ActivitySchedules.swift", "diffHunk": "@@ -228,29 +228,30 @@ class ResponseDataFetch: NMWebServiceDelegate {\n           let count = (value[\"count\"] as? Float)!\n           let dateString = value[\"date\"] as? String ?? \"\"\n           // SetData Format\n-          if let date = ResponseDataFetch.responseDateFormatter.date(from: dateString) {\n-            let localDateAsString = ResponseDataFetch.localDateFormatter.string(from: date)\n-            if let localDate = ResponseDataFetch.localDateFormatter.date(\n-              from: localDateAsString\n-            ) {\n-              // Save Stats to DB\n-              DBHandler.saveStatisticsDataFor(\n-                activityId: activityId!,\n-                key: key!,\n-                data: responseValue,\n-                fkDuration: Int(count),\n-                date: localDate\n-              )\n-            }\n+          if let date = ResponseDataFetch.responseDateFormatter.date(from: dateString),\n+            let key = key,\n+            let activityID = activityId\n+          {\n+            // Save Stats to DB\n+            DBHandler.saveStatisticsDataFor(\n+              activityId: activityID,\n+              key: key,\n+              data: responseValue,\n+              fkDuration: Int(count),\n+              date: date\n+            )\n           }\n         }\n       }\n-      let key = \"LabKeyResponse\" + (Study.currentStudy?.studyId)!\n+    }\n+\n+    if let studyID = Study.currentStudy?.studyId {\n+      let key = \"LabKeyResponse\" + studyID\n       UserDefaults.standard.set(true, forKey: key)\n+    }\n \n-      let appDelegate = (UIApplication.shared.delegate as? AppDelegate)!\n+    if let appDelegate = UIApplication.shared.delegate as? AppDelegate {", "originalCommit": "0527d345e1f4ba968d4cb67ee5b0ada99f56473f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg0MTUyMw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/414#discussion_r428841523", "bodyText": "if it's not an expected case, maybe use as! instead?", "author": "zohrehj", "createdAt": "2020-05-21T18:41:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg0MTAzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMzMjUxMA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/414#discussion_r429332510", "bodyText": "what happens if the casting fails? it doesn't look like the case is handled.\n\nIt wouldn't fail since AppDelegate is the starting point of the App. However, it's good to safely unwrap it.", "author": "tushar-boston", "createdAt": "2020-05-22T16:09:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg0MTAzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk1NjIzMw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/414#discussion_r429956233", "bodyText": "then it doesn't matter if you use as! instead?", "author": "zohrehj", "createdAt": "2020-05-25T14:12:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg0MTAzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE5MjgxOQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/414#discussion_r430192819", "bodyText": "Since its an optional type, force casting is a violation here.", "author": "tushar-boston", "createdAt": "2020-05-26T06:54:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg0MTAzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg1MDUzMg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/414#discussion_r428850532", "bodyText": "why are you removing the unwrapping of activityID and key?", "author": "zohrehj", "createdAt": "2020-05-21T18:58:20Z", "path": "iOS/HPHC/HPHC/Views/UIViews+Additions/Activity/ActivitySchedule/ActivitySchedules.swift", "diffHunk": "@@ -228,29 +228,30 @@ class ResponseDataFetch: NMWebServiceDelegate {\n           let count = (value[\"count\"] as? Float)!\n           let dateString = value[\"date\"] as? String ?? \"\"\n           // SetData Format\n-          if let date = ResponseDataFetch.responseDateFormatter.date(from: dateString) {\n-            let localDateAsString = ResponseDataFetch.localDateFormatter.string(from: date)\n-            if let localDate = ResponseDataFetch.localDateFormatter.date(\n-              from: localDateAsString\n-            ) {\n-              // Save Stats to DB\n-              DBHandler.saveStatisticsDataFor(\n-                activityId: activityId!,\n-                key: key!,\n-                data: responseValue,\n-                fkDuration: Int(count),\n-                date: localDate\n-              )\n-            }\n+          if let date = ResponseDataFetch.responseDateFormatter.date(from: dateString),\n+            let key = key,\n+            let activityID = activityId\n+          {\n+            // Save Stats to DB\n+            DBHandler.saveStatisticsDataFor(\n+              activityId: activityID,\n+              key: key,", "originalCommit": "0527d345e1f4ba968d4cb67ee5b0ada99f56473f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMzNDQ0OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/414#discussion_r429334449", "bodyText": "It an optional type and it was forced unwrapped which isn't a good practice. I'm unwrapping it safely now to avoid the crash if there's no key or activityID.", "author": "tushar-boston", "createdAt": "2020-05-22T16:13:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg1MDUzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk1NzQ3NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/414#discussion_r429957475", "bodyText": "where is the case where the value is nil being handled?", "author": "zohrehj", "createdAt": "2020-05-25T14:14:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg1MDUzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE5Mzc2OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/414#discussion_r430193768", "bodyText": "If it's nil means there wasn't any value from the server response and it'd just not save it in DB.", "author": "tushar-boston", "createdAt": "2020-05-26T06:56:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg1MDUzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg2NzU2Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/414#discussion_r428867563", "bodyText": "this code is deeply nested and very complex, please consider refactoring it into smaller methods.", "author": "zohrehj", "createdAt": "2020-05-21T19:32:05Z", "path": "iOS/HPHC/HPHC/Networking/APIs/ResponseServices.swift", "diffHunk": "@@ -371,28 +359,28 @@ class ResponseServices: NSObject {\n             }\n \n           } else {\n-            for responseData in dashBoardResponse {\n-\n-              if let keyValue = data[responseData.key!] as? [String: Any] {\n-\n-                if Utilities.isValidValue(\n-                  someObject: keyValue[\"value\"] as AnyObject?\n-                ) {\n-                  var value: Float = 0.0\n-                  if let n = keyValue[\"value\"] as? NSNumber {\n-                    value = n.floatValue\n-                  }\n-                  let valueDetail =\n-                    [\n-                      \"value\": value,\n-                      \"count\": Float(0.0),\n-                      \"date\": date,\n-                    ] as [String: Any]\n-\n-                  responseData.values.append(valueDetail)\n-                }\n+            for (index, dict) in dataDictArr.enumerated() {", "originalCommit": "0527d345e1f4ba968d4cb67ee5b0ada99f56473f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM0NjA4Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/414#discussion_r429346083", "bodyText": "I've made some changes by adding an initializer for DashboardResponse class and a method to parse those values from the Dictionary.", "author": "tushar-boston", "createdAt": "2020-05-22T16:37:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg2NzU2Mw=="}], "type": "inlineReview"}, {"oid": "78d1e6540e10b6e39a5d8b57a9f4c1ab6bbc5171", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/78d1e6540e10b6e39a5d8b57a9f4c1ab6bbc5171", "message": "Refactor DashboardResponse.", "committedDate": "2020-05-22T16:31:09Z", "type": "commit"}, {"oid": "4d72a1fdf33c9cd198d0396553de5e9728fa1ad6", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/4d72a1fdf33c9cd198d0396553de5e9728fa1ad6", "message": "Update StudyDashboard copyrights.", "committedDate": "2020-05-22T16:31:49Z", "type": "commit"}, {"oid": "606d4113c013fe9e204b89de38770dec58f4c658", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/606d4113c013fe9e204b89de38770dec58f4c658", "message": "Merge branch 'early-access' into ios-dashboard-response-patch", "committedDate": "2020-05-22T16:39:50Z", "type": "commit"}, {"oid": "4304e0562689c188f2860bb9ccf91120fcd06c44", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/4304e0562689c188f2860bb9ccf91120fcd06c44", "message": "Fix init.", "committedDate": "2020-05-26T08:07:09Z", "type": "commit"}, {"oid": "fc3472f1fbd71e9bd25a62adb452037ff9df0c91", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/fc3472f1fbd71e9bd25a62adb452037ff9df0c91", "message": "Merge branch 'early-access' into ios-dashboard-response-patch", "committedDate": "2020-05-28T13:12:27Z", "type": "commit"}]}