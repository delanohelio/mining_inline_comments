{"pr_number": 650, "pr_title": "OAuth Scim Service - Removed OrgId and /v1 from endpoints", "pr_createdAt": "2020-07-19T10:16:00Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650", "timeline": [{"oid": "33d99208e9e797ca844dde535d89c587a4ae8c52", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/33d99208e9e797ca844dde535d89c587a4ae8c52", "message": "/consent endpoint implementation with integration tests\n\n1. /consent endpoint implementation with integration tests\n2. Removed /v1 from endpoints\n3. Removed orgId", "committedDate": "2020-07-19T09:49:53Z", "type": "commit"}, {"oid": "6cc1a931a4bb49432f3659dfd0d01687ae2ec368", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/6cc1a931a4bb49432f3659dfd0d01687ae2ec368", "message": "Added singup and forgot password links to model\n\nAdded singup and forgot password links to model", "committedDate": "2020-07-19T10:03:38Z", "type": "commit"}, {"oid": "6e34b5d6d187702024324b94f38d7c8e77a1da83", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/6e34b5d6d187702024324b94f38d7c8e77a1da83", "message": "Removed ConsentController & ConsentControllerTest to reduce PR size\n\nRemoved ConsentController & ConsentControllerTest to reduce PR size", "committedDate": "2020-07-19T10:08:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE0NDgyNQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r460144825", "bodyText": "these two files, seem to be out of the scope of this PR.", "author": "zohrehj", "createdAt": "2020-07-24T16:01:07Z", "path": "common-modules/common-tests/src/main/resources/__files/hydra/auth_requests_consent_response.json", "diffHunk": "@@ -0,0 +1,57 @@\n+{\n+  \"challenge\": \"c11e62a0-5555-4b0e-b498-c878f5e4bd85\",\n+  \"requested_scope\": [\n+    \"offline_access\"\n+  ],", "originalCommit": "6e34b5d6d187702024324b94f38d7c8e77a1da83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMzNzk0Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r461337947", "bodyText": "I implemented complete functionality, but later decided to split into 2 PR to reduce the size so I kept these files in this PR because LOC <500. I've removed the consent related JSON files.", "author": "dhanyak-btc", "createdAt": "2020-07-28T06:02:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE0NDgyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMzOTk1Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r461339956", "bodyText": "Created an issue #688  Please also remove OrgID from other modules, WCP, mobile apps. And also update the db scripts accordingly.", "author": "dhanyak-btc", "createdAt": "2020-07-28T06:08:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE0NDgyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE0NTExNQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r460145115", "bodyText": "out of scope of this PR", "author": "zohrehj", "createdAt": "2020-07-24T16:01:35Z", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/common/AuthScimConstants.java", "diffHunk": "@@ -86,4 +84,10 @@ private AuthScimConstants() {}\n   public static final String OTP_USED = \"otp_used\";\n \n   public static final String ACCOUNT_LOCK_EMAIL_TIMESTAMP = \"account_lock_email_timestamp\";\n+\n+  public static final String CONSENT_CHALLENGE = \"consent_challenge\";\n+\n+  public static final String FORGOT_PASSWORD_LINK = \"forgot_password_link\";\n+\n+  public static final String SIGNUP_LINK = \"signup_link\";", "originalCommit": "6e34b5d6d187702024324b94f38d7c8e77a1da83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMzODU3MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r461338570", "bodyText": "I mentioned what is covered in this PR in description. Kindly review.", "author": "dhanyak-btc", "createdAt": "2020-07-28T06:04:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE0NTExNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcwMzYxNQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r461703615", "bodyText": "my bad.\nStill, in future please keep each PR centered around one main change and move these smaller changes to a separate PR; for one, they do not need to be included in a long chain of dependent PRs.", "author": "zohrehj", "createdAt": "2020-07-28T16:13:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE0NTExNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUxNjI2Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r465516263", "bodyText": "I've informed the team to keep the PR focused on one feature/issue. I've noted this point, will avoid adding multiple things into single PR.", "author": "dhanyak-btc", "createdAt": "2020-08-05T07:03:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE0NTExNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE0NTI2NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r460145265", "bodyText": "out of scope", "author": "zohrehj", "createdAt": "2020-07-24T16:01:48Z", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/config/RedirectConfig.java", "diffHunk": "@@ -32,6 +32,33 @@\n   @Value(\"${mystudies.android.app.callback-url}\")\n   private String myStudiesAndroidAppCallbackUrl;\n \n+  @Value(\"${participant.manager.forgot-password-url}\")\n+  private String participantManagerForgotPasswordUrl;\n+\n+  @Value(\"${mystudies.ios.app.forgot-password-url}\")\n+  private String myStudiesIosAppForgotPasswordUrl;\n+\n+  @Value(\"${mystudies.android.app.forgot-password-url}\")\n+  private String myStudiesAndroidAppForgotPasswordUrl;\n+\n+  @Value(\"${mystudies.ios.app.signup-url}\")\n+  private String myStudiesIosAppSignupUrl;\n+\n+  @Value(\"${mystudies.android.app.signup-url}\")\n+  private String myStudiesAndroidAppSignupUrl;\n+\n+  @Value(\"${participant.manager.signup-url}\")\n+  private String participantManagerSignupUrl;\n+\n+  @Value(\"${mystudies.ios.app.error-url}\")\n+  private String myStudiesIosAppErrorUrl;\n+\n+  @Value(\"${mystudies.android.app.error-url}\")\n+  private String myStudiesAndroidAppErrorUrl;\n+\n+  @Value(\"${participant.manager.error-url}\")\n+  private String participantManagerErrorUrl;", "originalCommit": "6e34b5d6d187702024324b94f38d7c8e77a1da83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMzODY2OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r461338669", "bodyText": "I mentioned what is covered in this PR in description. Kindly review.", "author": "dhanyak-btc", "createdAt": "2020-07-28T06:04:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE0NTI2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcwNzYzMg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r461707632", "bodyText": "I don't see why these should be included here. Please keep all participantManager related changes together. It is very hard. to review unrelated changes out of their context.", "author": "zohrehj", "createdAt": "2020-07-28T16:19:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE0NTI2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg1NzkyMw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r466857923", "bodyText": "@zohrehj In PR #615 you added a review comment \"so why is it returning string \"error\"? not a meaningful string, and/or an exception?\"\nMy reply was  \"error\" - is a placeholder. I need to configure error urls for android/ios/participant manager and redirect to respective error url.\nI've configured the redirect URLs in this PR.", "author": "dhanyak-btc", "createdAt": "2020-08-07T06:59:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE0NTI2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkxMTE4OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r468911188", "bodyText": "makes sense. But does not answer why it is included in this PR.", "author": "zohrehj", "createdAt": "2020-08-11T23:00:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE0NTI2NQ=="}], "type": "inlineReview"}, {"oid": "fd987a41b5430f79f3777a10e4dd5e6619dedfb1", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/fd987a41b5430f79f3777a10e4dd5e6619dedfb1", "message": "Removed consent related JSON files and fixed issue due to DigestUtils.sha3_512Hex\n\nRemoved consent related JSON files and fixed issue due to DigestUtils.sha3_512Hex", "committedDate": "2020-07-28T06:05:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcwNTcyOQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r461705729", "bodyText": "why not just check for error status code?", "author": "zohrehj", "createdAt": "2020-07-28T16:16:10Z", "path": "oauth-scim-module/oauth-scim-service/src/test/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/LoginControllerTest.java", "diffHunk": "@@ -78,31 +79,32 @@\n   public void shouldReturnLoginPage() throws Exception {\n     MultiValueMap<String, String> queryParams = new LinkedMultiValueMap<>();\n     queryParams.add(LOGIN_CHALLENGE, LOGIN_CHALLENGE_VALUE);\n-\n+    String forgotPasswordRedirectUrl =\n+        redirectConfig.getForgotPasswordUrl(DevicePlatform.UNKNOWN.getValue());\n+    String signupRedirectUrl = redirectConfig.getSignupUrl(DevicePlatform.UNKNOWN.getValue());\n     mockMvc\n         .perform(\n             get(ApiEndpoint.LOGIN_PAGE.getPath())\n                 .contextPath(getContextPath())\n                 .queryParams(queryParams))\n         .andDo(print())\n         .andExpect(status().isOk())\n+        .andExpect(model().attribute(FORGOT_PASSWORD_LINK, forgotPasswordRedirectUrl))\n+        .andExpect(model().attribute(SIGNUP_LINK, signupRedirectUrl))\n         .andExpect(content().string(containsString(\"<title>Login</title>\")))\n         .andReturn();\n   }\n \n   @Test\n   public void shouldReturnErrorPage() throws Exception {\n     MultiValueMap<String, String> queryParams = new LinkedMultiValueMap<>();\n-\n     mockMvc\n         .perform(\n             get(ApiEndpoint.LOGIN_PAGE.getPath())\n                 .contextPath(getContextPath())\n                 .queryParams(queryParams))\n         .andDo(print())\n-        .andExpect(status().isOk())\n-        .andExpect(content().string(containsString(\"<title>Error</title>\")))\n-        .andReturn();\n+        .andExpect(view().name(\"http://localhost:8003/participant-manager/error\"));", "originalCommit": "fd987a41b5430f79f3777a10e4dd5e6619dedfb1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUxNzczOQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r465517739", "bodyText": "Controller tries to redirect to the error url and then throws below error as this url not implemented in this service. So comparing the expected url with the view name.\nError resolving template [http://localhost:8003/participant-manager/error], template might not exist or might not be accessible by any of the configured Template Resolvers", "author": "dhanyak-btc", "createdAt": "2020-08-05T07:06:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcwNTcyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcwNjE2Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r461706166", "bodyText": "participant manager URLs are out of scope of this PR", "author": "zohrehj", "createdAt": "2020-07-28T16:16:52Z", "path": "oauth-scim-module/oauth-scim-service/src/main/resources/application-local.properties", "diffHunk": "@@ -60,9 +62,21 @@ spring.mail.properties.mail.smtp.starttls.enable=true\n spring.mail.properties.mail.smtp.ssl.enable = true\n \n # audit log endpoints\n-auditlog.events_endpoint=http://localhost:8001/audit-log-service/v1/events\n+auditlog.events_endpoint=http://localhost:8001/audit-log-service/events\n \n # Redirect URL's\n participant.manager.callback-url=http://localhost:8003/participant-manager/callback\n-mystudies.ios.app.callback-url=\n-mystudies.android.app.callback-url=\n\\ No newline at end of file\n+mystudies.ios.app.callback-url=http://localhost:8005/ios/deeplinks/callback\n+mystudies.android.app.callback-url=http://localhost:8006/android/deeplinks/callback\n+\n+participant.manager.forgot-password-url=http://localhost:8003/participant-manager/forgot-password", "originalCommit": "fd987a41b5430f79f3777a10e4dd5e6619dedfb1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg1ODk1OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r466858959", "bodyText": "I've answered to this in above review comment.", "author": "dhanyak-btc", "createdAt": "2020-08-07T07:02:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcwNjE2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcwNjY0NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r461706645", "bodyText": "nit: this is out of scope, and I have seen it in your other auth PR. Is there an issue with the base of this PR?", "author": "zohrehj", "createdAt": "2020-07-28T16:17:37Z", "path": "common-modules/common-service/src/main/java/com/google/cloud/healthcare/fdamystudies/common/EncryptionUtils.java", "diffHunk": "@@ -21,7 +21,7 @@\n   private EncryptionUtils() {}\n \n   public static String salt() {\n-    return DigestUtils.sha3_512Hex(IdGenerator.id());\n+    return DigestUtils.sha512Hex(IdGenerator.id());", "originalCommit": "fd987a41b5430f79f3777a10e4dd5e6619dedfb1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUyMjQxNw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r465522417", "bodyText": "I replaced DigestUtils.sha3_512Hex() method with DigestUtils.sha512Hex() as it was throwing NoSuchAlgorithmException .This error was happening for other developers, I was able to reproduce this by changing IDE build path to java-1.8.0-openjdk-1.8.0.252.", "author": "dhanyak-btc", "createdAt": "2020-08-05T07:16:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcwNjY0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcwMjU1OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r465702559", "bodyText": "ok, but it could have been fixed in a separate independent PR. It would have probably been merged a lot faster that way.", "author": "zohrehj", "createdAt": "2020-08-05T12:50:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcwNjY0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcwNTEzMQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r465705131", "bodyText": "still out of scope. I am letting one slide in order to save us some time, but please in future move small fixes into separate PRs. That way they can be merged in quickly and unblock other devs without the need to wait for a chain of dependent PRs to go in.\nIt will also make your PRs more straight forward and easier to review.", "author": "zohrehj", "createdAt": "2020-08-05T12:54:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcwNjY0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg1OTI5OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r466859298", "bodyText": "Thanks @zohrehj", "author": "dhanyak-btc", "createdAt": "2020-08-07T07:02:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcwNjY0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcwODYzMQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r461708631", "bodyText": "\ud83d\udc4d on the thorough comment here", "author": "zohrehj", "createdAt": "2020-07-28T16:20:36Z", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/LoginController.java", "diffHunk": "@@ -74,6 +73,16 @@\n \n   @Autowired private AppPropertyConfig appConfig;\n \n+  /**", "originalCommit": "fd987a41b5430f79f3777a10e4dd5e6619dedfb1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcxMjkwOA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r461712908", "bodyText": "I am not clear as to why you are returning the redirect URL with redirect: prefix.\nWhy is that? and where is it handled?", "author": "zohrehj", "createdAt": "2020-07-28T16:26:56Z", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/controller/LoginController.java", "diffHunk": "@@ -240,6 +262,14 @@ private String redirect(HttpServletResponse response, String redirectUrl) {\n     return \"redirect:\" + redirectUrl;\n   }\n \n+  private String redirectToError(HttpServletRequest request, HttpServletResponse response) {\n+    String devicePlatform = WebUtils.getCookie(request, DEVICE_PLATFORM).getValue();\n+    String redirectUrl = redirectConfig.getErrorUrl(devicePlatform);\n+    response.setHeader(\"Location\", redirectUrl);\n+    response.setStatus(HttpStatus.FOUND.value());\n+    return \"redirect:\" + redirectUrl;", "originalCommit": "fd987a41b5430f79f3777a10e4dd5e6619dedfb1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUyNDc1Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r465524753", "bodyText": "Please refer https://www.logicbig.com/tutorials/spring-framework/spring-web-mvc/redirect-prefix.html", "author": "dhanyak-btc", "createdAt": "2020-08-05T07:21:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcxMjkwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcwMzE0Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r465703143", "bodyText": "I see. thanks for the link.", "author": "zohrehj", "createdAt": "2020-08-05T12:51:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcxMjkwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcxMzU0OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r461713548", "bodyText": "out of scope of this PR.", "author": "zohrehj", "createdAt": "2020-07-28T16:27:57Z", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/HydraOAuthServiceImpl.java", "diffHunk": "@@ -143,4 +161,63 @@ public void init() {\n \n     return response;\n   }\n+\n+  @Override\n+  public ResponseEntity<JsonNode> requestConsent(MultiValueMap<String, String> paramMap) {\n+    HttpHeaders headers = new HttpHeaders();\n+    headers.add(CONTENT_TYPE, APPLICATION_X_WWW_FORM_URLENCODED_CHARSET_UTF_8);\n+    headers.setAccept(Collections.singletonList(MediaType.APPLICATION_JSON));\n+\n+    StringBuilder url = new StringBuilder(consentEndpoint);\n+    url.append(\"?consent_challenge=\").append(paramMap.getFirst(CONSENT_CHALLENGE));\n+\n+    return getRestTemplate().getForEntity(url.toString(), JsonNode.class);\n+  }\n+\n+  @Override\n+  public ResponseEntity<JsonNode> consentAccept(MultiValueMap<String, String> paramMap) {\n+\n+    ArrayNode scopes = createArrayNode();\n+    scopes.add(\"offline_access\");\n+    scopes.add(\"offline\");\n+    scopes.add(\"openid\");\n+\n+    ObjectNode accessTokenNode = getObjectNode();\n+    accessTokenNode.put(\"val\", IdGenerator.id());\n+\n+    ObjectNode idTokenNode = getObjectNode();\n+    idTokenNode.put(\"val\", IdGenerator.id());\n+\n+    ObjectNode session = getObjectNode();\n+    session.set(\"access_token\", accessTokenNode);\n+    session.set(\"id_token\", idTokenNode);\n+\n+    ObjectNode request = getObjectNode();\n+    request.set(\"grant_scope\", scopes);\n+    request.put(\"remember\", remember);\n+    request.set(\"session\", session);\n+\n+    HttpHeaders headers = new HttpHeaders();\n+    headers.setContentType(MediaType.APPLICATION_JSON);\n+    headers.setAccept(Collections.singletonList(MediaType.APPLICATION_JSON));\n+\n+    StringBuilder url = new StringBuilder(consentAcceptEndpoint);\n+    url.append(\"?\")\n+        .append(CONSENT_CHALLENGE)\n+        .append(\"=\")\n+        .append(paramMap.getFirst(CONSENT_CHALLENGE));\n+\n+    HttpEntity<Object> requestEntity = new HttpEntity<>(request, headers);\n+    ResponseEntity<JsonNode> response =\n+        getRestTemplate().exchange(url.toString(), HttpMethod.PUT, requestEntity, JsonNode.class);\n+\n+    if (!response.getStatusCode().is2xxSuccessful()) {\n+      logger.error(\n+          String.format(\n+              \"consent accept failed with status %d and response=%s\",\n+              response.getStatusCodeValue(), response.getBody()));\n+    }\n+\n+    return response;\n+  }", "originalCommit": "fd987a41b5430f79f3777a10e4dd5e6619dedfb1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcwOTA1NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r465709055", "bodyText": "Please remove these out of scope code out of the PR.\nIf you disagree, please provide why they need to stay, and provide enough context for me to review. Without proper context I am not able to review the code. where is it being tested, etc\ni.e. what is the purpose of this code, what part of the code uses it.", "author": "zohrehj", "createdAt": "2020-08-05T13:01:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcxMzU0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg2ODcxNQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r466868715", "bodyText": "Sorry for the confusion, let me explain what went wrong here. This PR was raised ~2 weeks ago. We used to raise PR's with more than 500 LOC that discussion came during technical catch up meetings. I remember, it was OK to split the code into multiple PRs. So If you see my commit history above, I split the implementation into 2 PR's #650 and #651 just to keep the PR below around 500 LOC. Follow up PR #651\nI agree with you it's very difficult for reviewers with this approach but each week we are learning something new about the review processes and the team is quickly aligning to new suggestions. This is the first time I got \"out of scope\" review comment, so I've informed the team about keeping the PR focused on one feature/issue. Kindly review this PR and approve.", "author": "dhanyak-btc", "createdAt": "2020-08-07T07:25:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcxMzU0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIzODU4MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r467238581", "bodyText": "I assumed this was the case. Still my initial comment stands, if you can't remove it, which seems to be the case here, please provide context for this code.\ni.e. what is the purpose of this code, what part of the code uses it.", "author": "zohrehj", "createdAt": "2020-08-07T19:50:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcxMzU0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIzOTkxNA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r467239914", "bodyText": "I am also not seeing any tests covering these methods. Please add tests.", "author": "zohrehj", "createdAt": "2020-08-07T19:53:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcxMzU0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc1MzUxMw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r468753513", "bodyText": "In ORY HYDRA REST API documentation, request body is not required but API invocation returns an error if request body is null. Below error message was not useful to fix the issue, so during POC I prepared the request body as per the documentation with dummy values. I removed the dummy values, passing empty JSON fixed the issue and tests are successful. ConsentControllerTest is in PR #651 so I fixed this comment in PR #651\nPUT /oauth2/auth/requests/consent/accept?consent_challenge=0ab55b85d7f8408eb9eb1260fa3e58b3\n{\"error\":\"error\",\"error_description\":\"The error is unrecognizable.\",\"status_code\":500,\"error_debug\":\"EOF\",\"request_id\":\"\"}", "author": "dhanyak-btc", "createdAt": "2020-08-11T17:41:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcxMzU0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkxMTQ3Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r468911477", "bodyText": "Please move the code to PR 651 if the tests are in there. I would prefer all code + tests to be merged together.", "author": "zohrehj", "createdAt": "2020-08-11T23:01:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcxMzU0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE5OTE3OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r469199179", "bodyText": "PR 651 created from PR 650 branch, so code already present in that branch. I'm making changes directly in PR 651.\nI agree with you, it's better to keep the code+tests together, this saves time for developers and makes it easy to test the review fixes. Sometimes, PR may exceed 500 LOC.", "author": "dhanyak-btc", "createdAt": "2020-08-12T11:47:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcxMzU0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcxNDMyNg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r461714326", "bodyText": "Not sure how these are related to the orgID and version removal and needed to be included here.\nIf they can be removed, please move them into a separate PR.", "author": "zohrehj", "createdAt": "2020-07-28T16:29:07Z", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/OAuthService.java", "diffHunk": "@@ -27,4 +27,8 @@\n   public ResponseEntity<JsonNode> requestLogin(MultiValueMap<String, String> paramMap);\n \n   public ResponseEntity<JsonNode> loginAccept(String email, String loginChallenge);\n+\n+  public ResponseEntity<JsonNode> requestConsent(MultiValueMap<String, String> paramMap);\n+\n+  public ResponseEntity<JsonNode> consentAccept(MultiValueMap<String, String> paramMap);", "originalCommit": "fd987a41b5430f79f3777a10e4dd5e6619dedfb1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUyODk3Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r465528977", "bodyText": "Sorry, I was trying to complete multiple things (provided<500 LOC)  so that Participant Manager & Mobile Apps can start the integration with new auth server. Now, I learnt it's a bad approach, so I'll try to keep the future PR's focused on one feature/issue.", "author": "dhanyak-btc", "createdAt": "2020-08-05T07:30:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcxNDMyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcwOTYxNg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r465709616", "bodyText": "same as my previous comment, I can't review code out of context. either remove or provide context.", "author": "zohrehj", "createdAt": "2020-08-05T13:02:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcxNDMyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njg3MDE3Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r466870173", "bodyText": "Please see above comment reply.", "author": "dhanyak-btc", "createdAt": "2020-08-07T07:28:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcxNDMyNg=="}], "type": "inlineReview"}, {"oid": "70ae96f33a8bb944215f6035a445291370bea859", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/70ae96f33a8bb944215f6035a445291370bea859", "message": "Removed @TestMethodOrder(OrderAnnotation.class) as @Order not used for tests\n\nRemoved @TestMethodOrder(OrderAnnotation.class) as @Order not used for tests", "committedDate": "2020-08-05T07:30:55Z", "type": "commit"}, {"oid": "95c1fbcab7e9f0fb39559ddceb1df1bbc9ac0945", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/95c1fbcab7e9f0fb39559ddceb1df1bbc9ac0945", "message": "Removed unused variable ORG_ID_VALUE\n\nRemoved unused variable ORG_ID_VALUE", "committedDate": "2020-08-07T08:36:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIzNzY3OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r467237678", "bodyText": "what is this feature referring to? can you please point me to how this functionality works and where it is used?", "author": "zohrehj", "createdAt": "2020-08-07T19:47:57Z", "path": "oauth-scim-module/oauth-scim-service/src/main/java/com/google/cloud/healthcare/fdamystudies/oauthscim/service/HydraOAuthServiceImpl.java", "diffHunk": "@@ -124,11 +138,15 @@ public void init() {\n     StringBuilder url = new StringBuilder(loginAcceptEndpoint);\n     url.append(\"?\").append(LOGIN_CHALLENGE).append(\"=\").append(loginChallenge);\n \n-    ObjectNode requestParams = JsonUtils.getObjectNode();\n+    ObjectNode requestParams = getObjectNode();\n     requestParams.put(\"subject\", email);\n-    requestParams.put(\"remember\", true);\n-    requestParams.put(\"remember_for\", REMEMBER_FOR_SECONDS);\n \n+    // if ORY Hydra should remember the subject's subject agent for future authentication attempts\n+    // by setting a cookie.\n+    requestParams.put(\"remember\", remember);\n+    if (remember) {\n+      requestParams.put(\"remember_for\", rememberForSeconds);\n+    }", "originalCommit": "95c1fbcab7e9f0fb39559ddceb1df1bbc9ac0945", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc0NDU5MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r468744590", "bodyText": "In ORY REST API documentation, the request body is not required but API invocation returns status code 500 if request body is empty or null.\nPUT /oauth2/auth/requests/login/accept?login_challenge=bcf381e940644757a09ed1f31b982ebc\n{\"error\":\"error\",\"error_description\":\"The error is unrecognizable.\",\"status_code\":500,\"error_debug\":\"Subject from payload can not be empty\",\"request_id\":\"\"}\n\nRemember, if set to true, tells ORY Hydra to remember this user by telling the user agent (browser) to store a cookie with authentication data. If the same user performs another OAuth 2.0 Authorization Request, he/she will not be asked to log in again. The default value is set to FALSE so we are not using this functionality.", "author": "dhanyak-btc", "createdAt": "2020-08-11T17:26:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIzNzY3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODkxMDk2Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r468910966", "bodyText": "What is the remember_for parameter then? why not use cookie expiration instead?", "author": "zohrehj", "createdAt": "2020-08-11T22:59:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIzNzY3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIwMjczOA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/650#discussion_r469202738", "bodyText": "I referred the ORY Hydra REST API documentation, remember and remember_for both are optional fields hence removed from request body.\nIn ORY Hydra documentation, Subject is the user ID of the end-user that authenticated. I was passing email instead of userId, I fixed this issue in PR #651 . Please review and approve.", "author": "dhanyak-btc", "createdAt": "2020-08-12T11:55:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIzNzY3OA=="}], "type": "inlineReview"}, {"oid": "57d0ce1da5387f2a5bab4d924ff663521fb984bf", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/57d0ce1da5387f2a5bab4d924ff663521fb984bf", "message": "Removed requestConsent() and consentAccept() methods to fix review comments\n\nRemoved requestConsent() and consentAccept() methods to fix review comments", "committedDate": "2020-08-12T14:39:57Z", "type": "commit"}, {"oid": "e65593fa6aa2549f7c4ad4580a3e13b2fc9cf4e7", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e65593fa6aa2549f7c4ad4580a3e13b2fc9cf4e7", "message": "Merge branch 'develop' into oauth_scim_consent", "committedDate": "2020-08-13T08:08:16Z", "type": "commit"}, {"oid": "de632dcec8a2f27ddff936e9eb9ce81e39e2c4a1", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/de632dcec8a2f27ddff936e9eb9ce81e39e2c4a1", "message": "Resolved conflicts to merge into develop\n\nResolved conflicts to merge into develop", "committedDate": "2020-08-13T08:08:52Z", "type": "commit"}, {"oid": "bfd0b18c1728ad070399040a2344c172e1ff579a", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/bfd0b18c1728ad070399040a2344c172e1ff579a", "message": "Fixed build issues\n\nFixed build issues", "committedDate": "2020-08-13T09:25:46Z", "type": "commit"}, {"oid": "6e98e225aae6c8f8e8cc95b198533dfe8dbac1c7", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/6e98e225aae6c8f8e8cc95b198533dfe8dbac1c7", "message": "Merge branch 'develop' into oauth_scim_consent", "committedDate": "2020-08-14T13:06:11Z", "type": "commit"}, {"oid": "7c4514a59afe459a8e4d2b1659f1d73172fe8885", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/7c4514a59afe459a8e4d2b1659f1d73172fe8885", "message": "Code Formatting  & Organize Imports\n\nCode Formatting  & Organize Imports", "committedDate": "2020-08-14T13:10:07Z", "type": "commit"}]}