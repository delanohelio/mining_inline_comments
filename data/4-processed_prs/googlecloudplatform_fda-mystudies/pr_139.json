{"pr_number": 139, "pr_title": "Add README for CICD.", "pr_createdAt": "2020-04-13T18:58:33Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/139", "timeline": [{"oid": "68c4f9aceacbe3eba74e8ad8859fac79b0c71cb4", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/68c4f9aceacbe3eba74e8ad8859fac79b0c71cb4", "message": "Add README for CICD.", "committedDate": "2020-04-13T18:57:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE4OTI4MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/139#discussion_r408189281", "bodyText": "Isn't this technically just logging in as you? Maybe the user does not have admin access for the GCP project.", "author": "MartinPetkov", "createdAt": "2020-04-14T14:39:14Z", "path": "Terraform/README.md", "diffHunk": "@@ -102,40 +104,65 @@ A deployment typically contains the following files:\n \n ## Deployment Steps\n \n-1. Authenticate as a super admin using `gcloud auth login`.\n+1.  Authenticate as a super admin using `gcloud auth login`.", "originalCommit": "68c4f9aceacbe3eba74e8ad8859fac79b0c71cb4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIwOTczMw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/139#discussion_r408209733", "bodyText": "Added [ACCOUNT] to be clearer.", "author": "xingao267", "createdAt": "2020-04-14T15:04:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE4OTI4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE5MjI4Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/139#discussion_r408192286", "bodyText": "I see in two places users are asked to uncomment code and re-run, which seems like a bad user experience. Maybe for the future, we can have a separate \"post-bootstrap\" or \"cicd\" module to run, which has a dependency on the bootstrap one.", "author": "MartinPetkov", "createdAt": "2020-04-14T14:43:08Z", "path": "Terraform/README.md", "diffHunk": "@@ -102,40 +104,65 @@ A deployment typically contains the following files:\n \n ## Deployment Steps\n \n-1. Authenticate as a super admin using `gcloud auth login`.\n+1.  Authenticate as a super admin using `gcloud auth login`.\n+\n+    WARNING: remember to run `gcloud auth revoke` to logout as a super admin.\n+    Being logged in as a super admin beyond the initial setup is dangerous!\n+\n+1.  Checkout the Terraform configs and set some helper environment variables.\n+\n+    ```\n+    $ git clone my-repo\n+    $ cd my-repo\n+    $ ROOT=$PWD\n+    ```\n+\n+1.  The bootstrap config must be deployed first in order to create the devops\n+    project which will host your Terraform state and CICD pipelines.\n+\n+    ```\n+    $ cd $ROOT/boootstrap\n+    $ terraform init\n+    $ terraform plan\n+    $ terraform apply\n+    ```\n \n-   WARNING: remember to run `gcloud auth revoke` to logout as a super admin.\n-   Being logged in as a super admin beyond the initial setup is dangerous!\n+    Your devops project should now be ready.\n \n-1. Checkout the Terraform configs and set some helper environment variables.\n+1.  Backup the state of the devops project to the newly created state bucket by\n+    uncommenting out the STEP 2 `terraform` block in `$ROOT/bootstrap/main.tf`\n+    and running:\n \n-   ```\n-   $ git clone my-repo\n-   $ cd my-repo\n-   $ ROOT=$PWD\n-   ```\n+    ```\n+    $ terraform init\n+    ```\n \n-1. The bootstrap config must be deployed first in order to create the devops\n-   project which will host your Terraform state and CICD pipelines.\n+1.  Follow\n+    [instructions](https://cloud.google.com/cloud-build/docs/automating-builds/create-github-app-triggers#installing_the_cloud_build_app)\n+    to install the Cloud Build app and connect your GitHub repository to your\n+    Cloud project.\n \n-   ```\n-   $ cd $ROOT/boootstrap\n-   $ terraform init\n-   $ terraform plan\n-   $ terraform apply\n-   ```\n+1.  Deploy the CICD Cloud Build Triggers by uncommenting out the STEP 4", "originalCommit": "68c4f9aceacbe3eba74e8ad8859fac79b0c71cb4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIwOTQ2MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/139#discussion_r408209461", "bodyText": "Martin has a good point. The state bucket -> uncomment -> backup state for the state bucket is a bit unavoidable but maybe the cicd stuff should go under a new deployment in /cicd? and the current cicd configs move to /cicd/configs?", "author": "umairidris", "createdAt": "2020-04-14T15:03:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE5MjI4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI5ODQ5Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/139#discussion_r408298496", "bodyText": "Done", "author": "xingao267", "createdAt": "2020-04-14T17:08:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE5MjI4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE5MzM1Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/139#discussion_r408193357", "bodyText": "Maybe clarify where they need to set this, since it may not be obvious.", "author": "MartinPetkov", "createdAt": "2020-04-14T14:44:20Z", "path": "Terraform/README.md", "diffHunk": "@@ -102,40 +104,65 @@ A deployment typically contains the following files:\n \n ## Deployment Steps\n \n-1. Authenticate as a super admin using `gcloud auth login`.\n+1.  Authenticate as a super admin using `gcloud auth login`.\n+\n+    WARNING: remember to run `gcloud auth revoke` to logout as a super admin.\n+    Being logged in as a super admin beyond the initial setup is dangerous!\n+\n+1.  Checkout the Terraform configs and set some helper environment variables.\n+\n+    ```\n+    $ git clone my-repo\n+    $ cd my-repo\n+    $ ROOT=$PWD\n+    ```\n+\n+1.  The bootstrap config must be deployed first in order to create the devops\n+    project which will host your Terraform state and CICD pipelines.\n+\n+    ```\n+    $ cd $ROOT/boootstrap\n+    $ terraform init\n+    $ terraform plan\n+    $ terraform apply\n+    ```\n \n-   WARNING: remember to run `gcloud auth revoke` to logout as a super admin.\n-   Being logged in as a super admin beyond the initial setup is dangerous!\n+    Your devops project should now be ready.\n \n-1. Checkout the Terraform configs and set some helper environment variables.\n+1.  Backup the state of the devops project to the newly created state bucket by\n+    uncommenting out the STEP 2 `terraform` block in `$ROOT/bootstrap/main.tf`\n+    and running:\n \n-   ```\n-   $ git clone my-repo\n-   $ cd my-repo\n-   $ ROOT=$PWD\n-   ```\n+    ```\n+    $ terraform init\n+    ```\n \n-1. The bootstrap config must be deployed first in order to create the devops\n-   project which will host your Terraform state and CICD pipelines.\n+1.  Follow\n+    [instructions](https://cloud.google.com/cloud-build/docs/automating-builds/create-github-app-triggers#installing_the_cloud_build_app)\n+    to install the Cloud Build app and connect your GitHub repository to your\n+    Cloud project.\n \n-   ```\n-   $ cd $ROOT/boootstrap\n-   $ terraform init\n-   $ terraform plan\n-   $ terraform apply\n-   ```\n+1.  Deploy the CICD Cloud Build Triggers by uncommenting out the STEP 4\n+    `terraform` block in `$ROOT/bootstrap/main.tf`, reviewing the triggering\n+    configurations, and running:\n \n-   Your devops project should now be ready.\n+    ```\n+    $ terraform init\n+    $ terraform plan\n+    $ terraform apply\n+    ```\n \n-1. Backup the state of the devops project to the newly created state bucket by\n-   uncommenting out the `terraform` block in `$ROOT/bootstrap/main.tf` and\n-   running:\n+    Two presubmit triggers are created by default and results are posted in the\n+    Pull Request. Failing these presubmits will block Pull Request submission.\n \n-   ```\n-   $ terraform init\n-   ```\n+    1.  `tf-validate`: Perform Terraform format and syntax check.\n+    1.  `tf-plan`: Generate speculative plans to show a set of possible changes\n+        if the pending config changes are deployed.\n \n-1. TODO(xingao): describe how to setup CICD pipeline\n+    Optionally, set `continuous_deployment_enabled` to `true` to create an", "originalCommit": "68c4f9aceacbe3eba74e8ad8859fac79b0c71cb4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIwMzgxNw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/139#discussion_r408203817", "bodyText": "Done.", "author": "xingao267", "createdAt": "2020-04-14T14:56:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE5MzM1Nw=="}], "type": "inlineReview"}, {"oid": "834ec3c961d01632de93369916d33eb9e73a8f06", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/834ec3c961d01632de93369916d33eb9e73a8f06", "message": "Merge branch 'terraform' into doc", "committedDate": "2020-04-14T14:52:42Z", "type": "commit"}, {"oid": "90f9680443850fd1cc0aa2957dc3ea51c858cd30", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/90f9680443850fd1cc0aa2957dc3ea51c858cd30", "message": "Pull cicd to a separate deployment.", "committedDate": "2020-04-14T16:21:11Z", "type": "commit"}, {"oid": "510caa7e620e335a87d2c3dd09f099b9abe8894f", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/510caa7e620e335a87d2c3dd09f099b9abe8894f", "message": "Merge branch 'terraform' into doc", "committedDate": "2020-04-14T17:07:32Z", "type": "commit"}, {"oid": "f2b24f6521a30d9f75e7aaaa7f592e963d5d7c76", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/f2b24f6521a30d9f75e7aaaa7f592e963d5d7c76", "message": "Merge branch 'terraform' into doc", "committedDate": "2020-04-14T18:11:00Z", "type": "commit"}, {"oid": "a7be18d62eadc4c0ecf06d5b1f0e6b44ba71b310", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/a7be18d62eadc4c0ecf06d5b1f0e6b44ba71b310", "message": "Add operation doc.", "committedDate": "2020-04-14T18:11:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODMzOTA3MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/139#discussion_r408339070", "bodyText": "Nit: It's better to use positive booleans, i.e. \"trigger_enabled\" with default \"true\".", "author": "MartinPetkov", "createdAt": "2020-04-14T18:14:18Z", "path": "Terraform/cicd/variables.tf", "diffHunk": "@@ -0,0 +1,55 @@\n+# Copyright 2020 Google Inc.\n+#\n+# Licensed under the Apache License, Version 2.0 (the \"License\");\n+# you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+#      http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+variable \"org_id\" {\n+  description = \"GCP Organization ID that Cloud Build Service Account will have purview over\"\n+  type        = string\n+}\n+\n+variable \"devops_project_id\" {\n+  description = \"Project ID of the devops project to create the Cloud Build Triggers\"\n+  type        = string\n+}\n+\n+variable \"state_bucket\" {\n+  description = \"Name of the Terraform state bucket\"\n+  type        = string\n+}\n+\n+variable \"repo_owner\" {\n+  description = \"Owner of the GitHub repo\"\n+  type        = string\n+}\n+\n+variable \"repo_name\" {\n+  description = \"Name of the GitHub repo\"\n+  type        = string\n+}\n+\n+variable \"cloudbuild_trigger_branch\" {\n+  description = \"Name of the branch to set the Cloud Build Triggers to watch for\"\n+  type        = string\n+}\n+\n+variable \"continuous_deployment_enabled\" {\n+  description = \"Whether or not to enable continuous deployment of Terraform configs\"\n+  type        = bool\n+  default     = false\n+}\n+\n+variable \"trigger_disabled\" {", "originalCommit": "a7be18d62eadc4c0ecf06d5b1f0e6b44ba71b310", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM0NzMyMQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/139#discussion_r408347321", "bodyText": "Done.", "author": "xingao267", "createdAt": "2020-04-14T18:28:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODMzOTA3MA=="}], "type": "inlineReview"}, {"oid": "a755beac5685929bd793f4ff55fa3e90c9555ac3", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/a755beac5685929bd793f4ff55fa3e90c9555ac3", "message": "Use positive boolean.", "committedDate": "2020-04-14T18:20:34Z", "type": "commit"}, {"oid": "16752d638e374f0b362e39ff39c8dc148c2bece0", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/16752d638e374f0b362e39ff39c8dc148c2bece0", "message": "Merge branch 'terraform' into doc", "committedDate": "2020-04-14T19:01:06Z", "type": "commit"}, {"oid": "1182c1cc21671c79ff46c3013bd909300b05325d", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/1182c1cc21671c79ff46c3013bd909300b05325d", "message": "Fix merge issues.", "committedDate": "2020-04-14T19:03:10Z", "type": "commit"}, {"oid": "a5adb7a8aa4a1a31a5a2aa9b0343487203dbea8c", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/a5adb7a8aa4a1a31a5a2aa9b0343487203dbea8c", "message": "one more nit", "committedDate": "2020-04-14T19:05:29Z", "type": "commit"}]}