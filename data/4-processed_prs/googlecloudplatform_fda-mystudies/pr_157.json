{"pr_number": 157, "pr_title": "Update k8s deployments and add cluster-wide configs", "pr_createdAt": "2020-04-16T14:44:38Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/157", "timeline": [{"oid": "aff23ec18e44684ea74037dcf451316495221827", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/aff23ec18e44684ea74037dcf451316495221827", "message": "Update k8s deployments and add cluster-wide configs\n\nChanges:\n* Update all services to use NodePort and Container-Native Load Balancing.\n* Update all deployments to refer to services by name, not IP address.\n* Move the ingress and cert configs to a separate folder \"kubernetes/\".\n* Add Pod Security Policies for the cluster and Istio.\n* Add helper script for applying the k8s configs.\n* Add helper script for moving Docker images from the main registry.", "committedDate": "2020-04-16T14:40:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTYyNjk4MQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/157#discussion_r409626981", "bodyText": "Is it possible to keep this branch deployment neutral? i.e. pick these values from configs or leave as generic names?", "author": "zohrehj", "createdAt": "2020-04-16T15:00:01Z", "path": "kubernetes/heroes-hat-cert.yaml", "diffHunk": "@@ -0,0 +1,7 @@\n+apiVersion: networking.gke.io/v1beta1\n+kind: ManagedCertificate\n+metadata:\n+  name: heroes-hat-cert\n+spec:\n+  domains:\n+    - heroes-hat.rocketturtle.net", "originalCommit": "aff23ec18e44684ea74037dcf451316495221827", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTYyOTEzMQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/157#discussion_r409629131", "bodyText": "I'm not sure I understand well enough what you mean. Do you mean that the domain here should be something generic and not \"heroes-hat.rocketturtle.net\"? I'm not sure how to take if from configs.", "author": "MartinPetkov", "createdAt": "2020-04-16T15:02:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTYyNjk4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTYzNTgxNg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/157#discussion_r409635816", "bodyText": "maybe that's something that we can look into at a later date.", "author": "zohrehj", "createdAt": "2020-04-16T15:12:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTYyNjk4MQ=="}], "type": "inlineReview"}, {"oid": "6c38d0f0fba45d0f0510893d928c78e88a4fea4a", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/6c38d0f0fba45d0f0510893d928c78e88a4fea4a", "message": "Remove the response-server-ws-gcloud-key user-registration-server-ws-gcloud-key secrets\n\nThese aren't needed, as these apps can use the GKE credentials.\nSee https://cloud.google.com/docs/authentication/production", "committedDate": "2020-04-16T16:33:21Z", "type": "commit"}, {"oid": "607de0b2be3adc44a920617c7778153d593d4403", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/607de0b2be3adc44a920617c7778153d593d4403", "message": "Revert \"Remove the response-server-ws-gcloud-key user-registration-server-ws-gcloud-key secrets\"\n\nThis reverts commit 6c38d0f0fba45d0f0510893d928c78e88a4fea4a.", "committedDate": "2020-04-16T17:05:20Z", "type": "commit"}, {"oid": "4927cffc9eedc2d63442863c4cc19912d62e30b4", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/4927cffc9eedc2d63442863c4cc19912d62e30b4", "message": "Make apps use separate SAs, gcloud keys, and DB creds", "committedDate": "2020-04-17T17:24:55Z", "type": "commit"}, {"oid": "e7dc1c024caea4315ec650d477fb5e5deae57107", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e7dc1c024caea4315ec650d477fb5e5deae57107", "message": "Merge branch 'terraform' into add-kubernetes-yamls", "committedDate": "2020-04-17T17:28:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM2OTQ5Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/157#discussion_r410369496", "bodyText": "We updated ingress.yaml to include most services now. Can you update this file as well?\nhttps://github.com/GoogleCloudPlatform/fda-mystudies/blob/early-access/ingress.yaml", "author": "kuoyuchi", "createdAt": "2020-04-17T17:33:08Z", "path": "kubernetes/ingress.yaml", "diffHunk": "@@ -0,0 +1,15 @@\n+apiVersion: networking.k8s.io/v1beta1\n+kind: Ingress\n+metadata:\n+  name: heroes-hat-dev\n+  annotations:\n+    kubernetes.io/ingress.global-static-ip-name: heroes-hat\n+    networking.gke.io/managed-certificates: heroes-hat-cert\n+spec:\n+  rules:\n+    - http:", "originalCommit": "e7dc1c024caea4315ec650d477fb5e5deae57107", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM3MDY2Nw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/157#discussion_r410370667", "bodyText": "I thought the image management would be part of CI/CD. What is this script for?", "author": "kuoyuchi", "createdAt": "2020-04-17T17:35:25Z", "path": "kubernetes/push_images.sh", "diffHunk": "@@ -0,0 +1,8 @@\n+#!/usr/bin/env bash", "originalCommit": "e7dc1c024caea4315ec650d477fb5e5deae57107", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM4NDY3NQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/157#discussion_r410384675", "bodyText": "I imagine that in the final repo, you would have CI/CD (separate from the Terraform CI/CD) scripts that build your images and push them to the right repos. How are you currently building and pushing images?\nOtherwise this script is just for me/umair/xin. It technically doesn't need to go in the final repo. Let me know and I can remove it from this PR.", "author": "MartinPetkov", "createdAt": "2020-04-17T18:02:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM3MDY2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQwNTUxNg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/157#discussion_r410405516", "bodyText": "SGTM to keep it for now. Can you add some file-level comments to explain how to use this? We've been manually running docker and cloud build commands.", "author": "kuoyuchi", "createdAt": "2020-04-17T18:43:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM3MDY2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQxNjcwNw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/157#discussion_r410416707", "bodyText": "Done.\nAnd I just discovered that we have triggers for rebuilding images on push: https://github.com/GoogleCloudPlatform/fda-mystudies/blob/terraform/Terraform/org/folder.fda-my-studies/project.heroes-hat-dev-apps/apps/cloudbuild.tf\nAnd there are cloudbuild.yaml files in each of the app directories. So this is likely what will be used in the final deployment, instead of this migration script.", "author": "MartinPetkov", "createdAt": "2020-04-17T19:06:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM3MDY2Nw=="}], "type": "inlineReview"}, {"oid": "2ba0451b0f0a743d41885286caa29081f6b5dc7a", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/2ba0451b0f0a743d41885286caa29081f6b5dc7a", "message": "Include changes to ingress.yaml from early-access", "committedDate": "2020-04-17T18:09:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM5NjQzNg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/157#discussion_r410396436", "bodyText": "this seems to be different from the previous instance, both database name and region are changed. Is that intentional?\nnit: would be great if we could extract all these values out of the yaml files and make the deployment configurable.", "author": "zohrehj", "createdAt": "2020-04-17T18:24:51Z", "path": "WCP/deployment.yaml", "diffHunk": "@@ -1,54 +1,60 @@\n-apiVersion: apps/v1 \n-kind: Deployment \n-metadata: \n-  name: study-designer \n-  labels: \n-    app: study-designer \n-spec: \n-  replicas: 1 \n-  selector: \n-    matchLabels: \n-      app: study-designer \n-  template: \n-    metadata: \n-      labels: \n-        app: study-designer \n-    spec: \n-      containers: \n-        - name: study-designer \n-          image: gcr.io/heroes-hat-dev/study-designer:latest\n-          env: \n-            - name: DB_USER \n-              valueFrom: \n-                secretKeyRef: \n-                  name: cloudsql-db-credentials \n-                  key: username \n-            - name: DB_PASS \n-              valueFrom: \n-                secretKeyRef: \n-                  name: cloudsql-db-credentials \n-                  key: password \n-            - name: DB_NAME \n-              valueFrom: \n-                secretKeyRef: \n-                  name: cloudsql-db-credentials \n-                  key: dbname \n+apiVersion: apps/v1\n+kind: Deployment\n+metadata:\n+  name: study-designer\n+  labels:\n+    app: study-designer\n+spec:\n+  replicas: 1\n+  selector:\n+    matchLabels:\n+      app: study-designer\n+  template:\n+    metadata:\n+      labels:\n+        app: study-designer\n+    spec:\n+      containers:\n+        - name: study-designer\n+          image: gcr.io/heroes-hat-dev-apps/study-designer:latest\n+          env:\n+            - name: DB_USER\n+              valueFrom:\n+                secretKeyRef:\n+                  name: study-designer-db-credentials\n+                  key: username\n+            - name: DB_PASS\n+              valueFrom:\n+                secretKeyRef:\n+                  name: study-designer-db-credentials\n+                  key: password\n+            - name: DB_NAME\n+              valueFrom:\n+                secretKeyRef:\n+                  name: study-designer-db-credentials\n+                  key: dbname\n             - name: REGISTRATION_SERVER_URL\n-              value: \"35.196.79.108:60000\"\n+              value: \"user-registration-server-np:60000\"\n             - name: RESPONSE_SERVER_URL\n-              value: \"35.196.119.71:60000\"\n+              value: \"response-server-np:50000\"\n+            - name: GOOGLE_APPLICATION_CREDENTIALS\n+              value: \"/secrets/gcloud_key/key.json\"\n           ports:\n           - containerPort: 8080\n-        - name: cloudsql-proxy \n-          image: gcr.io/cloudsql-docker/gce-proxy:latest \n-          command: [\"/cloud_sql_proxy\", \n-            \"-instances=heroes-hat-dev:us-east1:my-studies2=tcp:3306\", \n-            \"-credential_file=/secrets/cloudsql/sql_credentials.json\"] \n-          volumeMounts: \n-            - name: my-secrets-volume \n-              mountPath: /secrets/cloudsql \n-              readOnly: true \n-      volumes: \n-        - name: my-secrets-volume \n-          secret: \n-            secretName: cloudsql-instance-credentials\n+          volumeMounts:\n+          - name: gcloud-key-volume\n+            mountPath: /secrets/gcloud_key\n+            readOnly: true\n+        - name: cloudsql-proxy\n+          image: gcr.io/cloudsql-docker/gce-proxy:latest\n+          command: [\"/cloud_sql_proxy\",\n+            \"-instances=heroes-hat-dev-data:us-central1:my-studies-1=tcp:3306\",", "originalCommit": "2ba0451b0f0a743d41885286caa29081f6b5dc7a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM5OTg1OQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/157#discussion_r410399859", "bodyText": "They are different, these are for the project we've been deploying to, not the main heroes-hat-dev. These would presumably have to change before going to UNC, to point to their particular project(s).\nI'll look into making this configurable, though I'm not very familiar with customizable Kubernetes configs. Maybe we need something like kustomize, but I haven't explored it yet.", "author": "MartinPetkov", "createdAt": "2020-04-17T18:31:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM5NjQzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQzNTQwNA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/157#discussion_r410435404", "bodyText": "So I did a small literature review, and none of the options seem great. In particular, this is a great overview.\n\nkustomize\n\n\nSeems very heavyweight and complex to use.\nWould not be able to replace i.e. the path to the database in the cloudsql_proxy command.\n\n\nyq\n\n\nEasier to use, could probably be used to replace image paths.\nAlso cannot replace the path to the database.\n\n\nHelm charts and templated yaml files\n\n\nCould replace fields freely.\nRequires all files to be in a particular \"chart\" structure.\nFiles are no usable on their own, i.e. you can't kubectl apply -f an untemplated file.\nYou need to use Helm, which adds yet another tool and dependency.\n\n\nBash scripting and sed\n\n\nThis honestly seems like the most straightforward and simple approach, albeit the least robust.\nIt would be two sed commands replacing i.e. gcr.io/heroes-hat-dev with gcr.io/, and same with the -instances=heroes-hat-dev-data:us-central1:my-studies-1=tcp:3306 flags, in all the deployment.yaml files.\n\n\nUsing the Terraform Engine\n\n\nThe Terraform Engine would be able to do this here by generating the files from templates, but it's not ready at the moment.\n\nAll that said, I think it's simplest to just replace the values (either manually or via sed) before attempting to deploy in the final GCP project.\nLet me know if you'd still like to discuss, or if I can resolve.", "author": "MartinPetkov", "createdAt": "2020-04-17T19:47:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM5NjQzNg=="}], "type": "inlineReview"}, {"oid": "8a20f3ff3641329337830d806964d79a1ef8d2d8", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/8a20f3ff3641329337830d806964d79a1ef8d2d8", "message": "Add usage and args to the push_images.sh script", "committedDate": "2020-04-17T19:03:53Z", "type": "commit"}]}