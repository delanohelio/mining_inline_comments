{"pr_number": 595, "pr_title": "iOS - Start activity with local notification action.", "pr_createdAt": "2020-07-06T12:49:55Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/595", "timeline": [{"oid": "a07faa06ad0c1759feb9cddf46ac161ca93fe6f1", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/a07faa06ad0c1759feb9cddf46ac161ca93fe6f1", "message": "Start run with local notification action.", "committedDate": "2020-07-06T12:43:47Z", "type": "commit"}, {"oid": "d609b3b3122261843cbfb559947c4c426327516d", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/d609b3b3122261843cbfb559947c4c426327516d", "message": "fix method reference.", "committedDate": "2020-07-06T13:01:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ3MzM5Mg==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/595#discussion_r454473392", "bodyText": "should completion handler only run when application state is active or backgroud?\nWhat are the states that this should not run in?", "author": "zohrehj", "createdAt": "2020-07-14T16:11:39Z", "path": "iOS/HPHC/HPHC/AppDelegate.swift", "diffHunk": "@@ -1757,12 +1758,9 @@ extension AppDelegate: UNUserNotificationCenterDelegate {\n       self.updateNotification()\n \n     } else {\n-      if UIApplication.shared.applicationState == UIApplication.State.background\n-        || (UIApplication.shared.applicationState == UIApplication.State.inactive)\n-      {\n-        self.handleLocalNotification(userInfoDetails: (userInfo as? [String: Any])!)\n-      }\n+      self.handleLocalNotification(userInfoDetails: userInfo as? JSONDictionary ?? [:])\n     }\n+    completionHandler()", "originalCommit": "d609b3b3122261843cbfb559947c4c426327516d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkyODI3MA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/595#discussion_r454928270", "bodyText": "It should be called at the end after performing other tasks on the same thread irrespective of state.", "author": "tushar-boston", "createdAt": "2020-07-15T09:46:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ3MzM5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI0Mzg5OA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/595#discussion_r455243898", "bodyText": "then maybe move it outside of the initial if", "author": "zohrehj", "createdAt": "2020-07-15T18:07:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ3MzM5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkxOTAyOQ==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/595#discussion_r455919029", "bodyText": "It's outside only on the main function block and getting called at the end.", "author": "tushar-boston", "createdAt": "2020-07-16T16:33:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ3MzM5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ3NDM1Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/595#discussion_r454474353", "bodyText": "what happens if tableViewSections[0] does not exist? i.e. tableViewSections is null or empty?", "author": "zohrehj", "createdAt": "2020-07-14T16:13:08Z", "path": "iOS/HPHC/HPHC/Controllers/StudyUI/ActivityUI/ActivitiesViewController.swift", "diffHunk": "@@ -214,23 +214,27 @@ class ActivitiesViewController: UIViewController {\n \n     } else {\n       /// check if user navigated from notification\n-      if NotificationHandler.instance.activityId.count > 0 {\n-\n-        let activityId = NotificationHandler.instance.activityId\n-\n-        let rowDetail = tableViewSections[0]\n-        let activities = (rowDetail[\"activities\"] as? [Activity])!\n-        let index = activities.firstIndex(where: { $0.actvityId == activityId })\n-        let ip = IndexPath.init(row: index!, section: 0)\n-        self.selectedIndexPath = ip\n-        self.tableView?.selectRow(at: ip, animated: true, scrollPosition: .middle)\n-        self.tableView?.delegate?.tableView!(self.tableView!, didSelectRowAt: ip)\n-\n-        NotificationHandler.instance.activityId = \"\"\n+      if !NotificationHandler.instance.activityId.isEmpty {\n+        userDidNavigateFromNotification()\n       }\n     }\n   }\n \n+  func userDidNavigateFromNotification() {\n+    let activityId = NotificationHandler.instance.activityId\n+    let rowDetail = tableViewSections[0]\n+    let activities = rowDetail[\"activities\"] as? [Activity] ?? []", "originalCommit": "d609b3b3122261843cbfb559947c4c426327516d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkyOTA1Ng==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/595#discussion_r454929056", "bodyText": "tableViewSections is hardcoded. However, there's a possibility of empty rowDetail for which I've added the proper checks.", "author": "tushar-boston", "createdAt": "2020-07-15T09:47:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ3NDM1Mw=="}], "type": "inlineReview"}, {"oid": "7d1f94ed7cfdc8e9ba20ee94bdd80873701a64f9", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/7d1f94ed7cfdc8e9ba20ee94bdd80873701a64f9", "message": "Merge branch 'early-access' into ios-notifications-patch", "committedDate": "2020-07-16T16:34:00Z", "type": "commit"}]}