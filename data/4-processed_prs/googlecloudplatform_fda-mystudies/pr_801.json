{"pr_number": 801, "pr_title": "Participant Manager Service : Audit Events with Integration Test Cases", "pr_createdAt": "2020-08-25T16:14:39Z", "pr_url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/801", "timeline": [{"oid": "4af1f6adb1f81f721610cbf1ba55cd8f8a2c68a0", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/4af1f6adb1f81f721610cbf1ba55cd8f8a2c68a0", "message": "AuditLog Implementation\n\nAuditLog Implementation", "committedDate": "2020-08-25T15:02:45Z", "type": "commit"}, {"oid": "7dc1bba482d1897f219d06e5aed34a753988a28d", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/7dc1bba482d1897f219d06e5aed34a753988a28d", "message": "AuditLog event with tests\n\nAuditLog event with tests", "committedDate": "2020-08-25T15:25:50Z", "type": "commit"}, {"oid": "2867d2c61c97a4bef455b94ce8638038edfd4fa2", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/2867d2c61c97a4bef455b94ce8638038edfd4fa2", "message": "audit logs for location and update profile", "committedDate": "2020-08-25T15:46:15Z", "type": "commit"}, {"oid": "29b05b6f2fd9634dc39b381db56807d21e5ad863", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/29b05b6f2fd9634dc39b381db56807d21e5ad863", "message": "site controller test audit logging", "committedDate": "2020-08-25T16:05:12Z", "type": "commit"}, {"oid": "85691eb52b0576c63dd8917c3077db844aabd1f2", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/85691eb52b0576c63dd8917c3077db844aabd1f2", "message": "Organized imports\n\nOrganized imports", "committedDate": "2020-08-25T16:12:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Nzk4MTEyNw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/801#discussion_r477981127", "bodyText": "nit: Inactive, not Deactive", "author": "saminguyen", "createdAt": "2020-08-27T02:48:28Z", "path": "participant-manager-module/participant-manager-service/src/test/java/com/google/cloud/healthcare/fdamystudies/controller/LocationControllerTest.java", "diffHunk": "@@ -314,6 +336,57 @@ public void shouldUpdateToReactiveLocation() throws Exception {\n     LocationEntity locationEntity = optLocationEntity.get();\n     assertNotNull(locationEntity);\n     assertEquals(ACTIVE_STATUS, locationEntity.getStatus());\n+\n+    AuditLogEventRequest auditRequest = new AuditLogEventRequest();\n+    auditRequest.setUserId(userRegAdminEntity.getId());\n+\n+    Map<String, AuditLogEventRequest> auditEventMap = new HashedMap<>();\n+    auditEventMap.put(LOCATION_ACTIVATED.getEventCode(), auditRequest);\n+\n+    verifyAuditEventCall(auditEventMap, LOCATION_ACTIVATED);\n+  }\n+\n+  @Test\n+  public void shouldUpdateToDeactiveLocation() throws Exception {", "originalCommit": "85691eb52b0576c63dd8917c3077db844aabd1f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTA0MzIyMA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/801#discussion_r479043220", "bodyText": "Fixed Review comment.", "author": "monica-BTC", "createdAt": "2020-08-28T09:48:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Nzk4MTEyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Nzk5NzQ5Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/801#discussion_r477997493", "bodyText": "Why are you capturing the request here, I do not see argument.getAllValues() being called.", "author": "saminguyen", "createdAt": "2020-08-27T03:00:32Z", "path": "common-modules/common-tests/src/main/java/com/google/cloud/healthcare/fdamystudies/common/BaseMockIT.java", "diffHunk": "@@ -149,10 +170,96 @@ protected MvcResult performPost(\n         .andReturn();\n   }\n \n+  /**\n+   * @param assertOptionalFieldsForEvent is a {@link Map} collection that contains {@link eventCode}\n+   *     as key and {@link AuditLogEventRequest} with optional field values as value.\n+   * @param auditEvents audit event enums\n+   */\n+  protected void verifyAuditEventCall(\n+      Map<String, AuditLogEventRequest> assertOptionalFieldsForEvent,\n+      AuditLogEvent... auditEvents) {\n+\n+    verifyAuditEventCall(auditEvents);\n+\n+    Map<String, AuditLogEventRequest> auditRequestByEventCode =\n+        auditRequests\n+            .stream()\n+            .collect(Collectors.toMap(AuditLogEventRequest::getEventCode, Function.identity()));\n+\n+    assertOptionalFieldsForEvent.forEach(\n+        (eventCode, expectedAuditRequest) -> {\n+          AuditLogEventRequest auditRequest = auditRequestByEventCode.get(eventCode);\n+          assertEquals(expectedAuditRequest.getUserId(), auditRequest.getUserId());\n+          assertEquals(expectedAuditRequest.getParticipantId(), auditRequest.getParticipantId());\n+          assertEquals(expectedAuditRequest.getStudyId(), auditRequest.getStudyId());\n+          assertEquals(expectedAuditRequest.getStudyVersion(), auditRequest.getStudyVersion());\n+        });\n+  }\n+\n+  protected void verifyAuditEventCall(AuditLogEvent... auditEvents) {\n+    ArgumentCaptor<AuditLogEventRequest> argument =\n+        ArgumentCaptor.forClass(AuditLogEventRequest.class);\n+    verify(mockAuditService, atLeastOnce()).postAuditLogEvent(argument.capture());", "originalCommit": "85691eb52b0576c63dd8917c3077db844aabd1f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTE2MzAzMA==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/801#discussion_r479163030", "bodyText": "We tried with argument.getAllValues() but the Mockito is overriding the values with the last method call argument so need to handle this differently. We are using same auditRequest object for multiple audit events.", "author": "dhanyak-btc", "createdAt": "2020-08-28T11:29:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Nzk5NzQ5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQ1NTk2Mw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/801#discussion_r479455963", "bodyText": "I see! @monica-BTC can we remove the argument captor from this method then?", "author": "saminguyen", "createdAt": "2020-08-28T17:59:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Nzk5NzQ5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDAwMTkzNw==", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/pull/801#discussion_r480001937", "bodyText": "I tried by removing argument captor from this method. I got below error.\nArgument(s) are different! Wanted:\nauditEventServiceImpl.postAuditLogEvent(\nAuditLogEventRequest(correlationId=null, eventCode=null, source=null, destination=null, resourceServer=null, userAccessLevel=null, sourceApplicationVersion=null, destinationApplicationVersion=null, platformVersion=null, occured=null, appId=null, mobilePlatform=null, appVersion=null, participantId=null, studyId=null, studyVersion=null, siteId=null)\n);", "author": "monica-BTC", "createdAt": "2020-08-31T09:17:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Nzk5NzQ5Mw=="}], "type": "inlineReview"}, {"oid": "dcb4032ea99d51fa4fcdfecd1d48bf2ae45fa4d3", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/dcb4032ea99d51fa4fcdfecd1d48bf2ae45fa4d3", "message": "Fixed review comment", "committedDate": "2020-08-27T08:08:59Z", "type": "commit"}, {"oid": "0853279d9f29bff5de17a5a28646c00fb75d1cea", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/0853279d9f29bff5de17a5a28646c00fb75d1cea", "message": "Merge branch 'develop' into participant-manager-audit-logs", "committedDate": "2020-08-31T09:14:01Z", "type": "commit"}, {"oid": "e07bbb5fcafc82ad2f148a4059c899cf0f8a64b5", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/e07bbb5fcafc82ad2f148a4059c899cf0f8a64b5", "message": "Fixed Build Issue\n\nFixed Build Issue", "committedDate": "2020-08-31T09:36:14Z", "type": "commit"}, {"oid": "bff06b452d2de59c9d28c683e695f1f5a9f590a8", "url": "https://github.com/GoogleCloudPlatform/fda-mystudies/commit/bff06b452d2de59c9d28c683e695f1f5a9f590a8", "message": "Merge branch 'develop' into participant-manager-audit-logs", "committedDate": "2020-08-31T14:58:41Z", "type": "commit"}]}