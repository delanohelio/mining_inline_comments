{"pr_number": 1664, "pr_title": "[SCB-1822]fix problems when using multiple consumer interface for one\u2026", "pr_createdAt": "2020-03-25T09:30:17Z", "pr_url": "https://github.com/apache/servicecomb-java-chassis/pull/1664", "timeline": [{"oid": "d8e6c3895c899a0fddfaa296b14b90dcae05b165", "url": "https://github.com/apache/servicecomb-java-chassis/commit/d8e6c3895c899a0fddfaa296b14b90dcae05b165", "message": "[SCB-1822]fix problems when using multiple consumer interface for one operation and using CseHttpEntity to set localcontext", "committedDate": "2020-03-25T09:28:39Z", "type": "commit"}, {"oid": "478643f1f8ce88ba7edbe76af108d12144d2e678", "url": "https://github.com/apache/servicecomb-java-chassis/commit/478643f1f8ce88ba7edbe76af108d12144d2e678", "message": "[SCB-1822]fix random test error", "committedDate": "2020-03-25T13:11:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcyMTE0OQ==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1664#discussion_r398721149", "bodyText": "not so good.\nthis makes parse endpoint for each invocation?", "author": "wujimin", "createdAt": "2020-03-26T16:40:06Z", "path": "demo/demo-springmvc/springmvc-client/src/main/java/org/apache/servicecomb/demo/springmvc/client/TestDateTimeSchema.java", "diffHunk": "@@ -92,4 +119,39 @@ private void testDateTimeSchema() {\n         dateTimeSchemaInf.postLocalDateTime(localDateTime)\n             .format(DateTimeFormatter.ofPattern(\"yyyy-MM-dd'T'HH:mm:ss.SSS\")));\n   }\n+\n+  private void testDateTimeSchemaMulticast() {\n+    DiscoveryContext context = new DiscoveryContext();\n+    VersionedCache serversVersionedCache = discoveryTree.discovery(context, \"springmvctest\", \"springmvc\", \"0+\");\n+    List<String> enpoints = serversVersionedCache.data();\n+\n+    for (String endpoint : enpoints) {\n+      InvocationContext invocationContext = new InvocationContext();\n+      invocationContext.addLocalContext(LoadbalanceHandler.SERVICECOMB_SERVER_ENDPOINT, endpoint);\n+      Date date = new Date();\n+      TestMgr.check(date.getTime(), dateTimeSchemaWithContextInf.getDate(invocationContext, date).getTime());", "originalCommit": "478643f1f8ce88ba7edbe76af108d12144d2e678", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk4MjEyMw==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1664#discussion_r398982123", "bodyText": "we have to now, because LoadBalanceHandler read string endpoint.", "author": "liubao68", "createdAt": "2020-03-27T01:16:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcyMTE0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAwODE1Mg==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1664#discussion_r399008152", "bodyText": "when optimize this, LB should be change too.", "author": "wujimin", "createdAt": "2020-03-27T02:56:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcyMTE0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAxODAzMw==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1664#discussion_r399018033", "bodyText": "I create a issue for this : https://issues.apache.org/jira/browse/SCB-1831", "author": "liubao68", "createdAt": "2020-03-27T03:39:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcyMTE0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcyMzAxMA==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1664#discussion_r398723010", "bodyText": "maybe there are different consumer interfaces.\nif set back to operationMeta, will cause problem.", "author": "wujimin", "createdAt": "2020-03-26T16:42:39Z", "path": "providers/provider-pojo/src/main/java/org/apache/servicecomb/provider/pojo/Invoker.java", "diffHunk": "@@ -162,6 +162,8 @@ public Object invoke(Object proxy, Method method, Object[] args) {\n \n     SwaggerConsumerOperation consumerOperation = pojoConsumerOperationMeta.getSwaggerConsumerOperation();\n     OperationMeta operationMeta = pojoConsumerOperationMeta.getOperationMeta();\n+    // operation meta is static data based on swagger, while consumer operation based on invoker, have interface info\n+    operationMeta.setSwaggerConsumerOperation(consumerOperation);", "originalCommit": "478643f1f8ce88ba7edbe76af108d12144d2e678", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk2Njg4Nw==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1664#discussion_r398966887", "bodyText": "begin from scb-1706, that modify is not a good idea.", "author": "wujimin", "createdAt": "2020-03-27T00:17:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcyMzAxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk4NDA2NQ==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1664#discussion_r398984065", "bodyText": "From invocation, can only get OperationMeta. Current code put all invocation data(e.g. response type) to OperationMeta. This is not good, need refactor in future, but this PR not working on this refactoring, because it is related to some other parts besides this issue.  I create an issue and refactoring the code later.", "author": "liubao68", "createdAt": "2020-03-27T01:23:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcyMzAxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAwNzkzNw==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1664#discussion_r399007937", "bodyText": "as we disscussed, we create new issue to resolve this.", "author": "wujimin", "createdAt": "2020-03-27T02:55:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcyMzAxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcyNjU3MQ==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1664#discussion_r398726571", "bodyText": "consumerMeta only belongs to this invoker instance\nonly relate to this one consumerIntf class\nseems no need to build a complex key?", "author": "wujimin", "createdAt": "2020-03-26T16:47:16Z", "path": "providers/provider-pojo/src/main/java/org/apache/servicecomb/provider/pojo/Invoker.java", "diffHunk": "@@ -148,7 +148,7 @@ public Object invoke(Object proxy, Method method, Object[] args) {\n     }\n \n     PojoConsumerOperationMeta pojoConsumerOperationMeta = consumerMeta\n-        .findOperationMeta(MethodUtils.findSwaggerMethodName(method));\n+        .findOperationMeta(MethodUtils.findSwaggerMethodName(method), consumerIntf);", "originalCommit": "478643f1f8ce88ba7edbe76af108d12144d2e678", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk4MjUzMQ==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1664#discussion_r398982531", "bodyText": "This is what this PR for , two interfaces should working in one consumer\ninterface DateTimeSchemaInf {\n  Date getDate(Date date);\t\n}\n\n\ninterface DateTimeSchemaWithContextInf {\n  Date getDate(InvocationContext context, Date date);\n}", "author": "liubao68", "createdAt": "2020-03-27T01:17:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcyNjU3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAwNzc3Mw==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1664#discussion_r399007773", "bodyText": "meta from Invoker should not set in OperationMeta\nbecause as you said, there are different invokers\nwe can create a new issue to optimize this.", "author": "wujimin", "createdAt": "2020-03-27T02:55:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcyNjU3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAxODIyMA==", "url": "https://github.com/apache/servicecomb-java-chassis/pull/1664#discussion_r399018220", "bodyText": "issue: https://issues.apache.org/jira/browse/SCB-1830", "author": "liubao68", "createdAt": "2020-03-27T03:40:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcyNjU3MQ=="}], "type": "inlineReview"}]}