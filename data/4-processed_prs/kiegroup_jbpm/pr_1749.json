{"pr_number": 1749, "pr_title": "[JBPM-9178] Immutable springboot images / adding the capability to re\u2026", "pr_createdAt": "2020-09-02T14:19:55Z", "pr_url": "https://github.com/kiegroup/jbpm/pull/1749", "timeline": [{"oid": "131dd9e6ed68ed957809aaf10e3d124ce07c31b8", "url": "https://github.com/kiegroup/jbpm/commit/131dd9e6ed68ed957809aaf10e3d124ce07c31b8", "message": "[JBPM-9178] Immutable springboot images / adding the capability to read kie deployment descriptor from classpath", "committedDate": "2020-09-03T06:45:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQzMTkyOQ==", "url": "https://github.com/kiegroup/jbpm/pull/1749#discussion_r483431929", "bodyText": "try-with-resources might be another option here.", "author": "afalhambra", "createdAt": "2020-09-04T07:13:40Z", "path": "jbpm-runtime-manager/src/main/java/org/jbpm/runtime/manager/impl/deploy/DeploymentDescriptorManagerUtil.java", "diffHunk": "@@ -66,18 +81,23 @@ protected static DeploymentDescriptor getDescriptorFromKModule(InternalKieModule\n         DeploymentDescriptor desc = null;\n         if (kmodule.isAvailable(DeploymentDescriptor.META_INF_LOCATION)) {\n             byte[] content = kmodule.getBytes(DeploymentDescriptor.META_INF_LOCATION);\n-            ByteArrayInputStream input = new ByteArrayInputStream(content);\n-            try {\n-                desc = DeploymentDescriptorIO.fromXml(input);\n-            } finally {\n-                try {\n-                    input.close();\n-                } catch (IOException e) {\n-                    logger.debug(\"Error when closing stream of kie-deployment-descriptor.xml\");\n-                }\n-            }\n+            desc = getDescriptorFromContent(content);\n         }\n \n         return desc;\n     }\n+\n+\n+    protected static DeploymentDescriptor getDescriptorFromContent(byte[] content) {\n+        ByteArrayInputStream input = new ByteArrayInputStream(content);\n+        try {\n+            return DeploymentDescriptorIO.fromXml(input);\n+        } finally {\n+            try {\n+                input.close();\n+            } catch (IOException e) {\n+                logger.debug(\"Error when closing stream of kie-deployment-descriptor.xml\");\n+            }\n+        }", "originalCommit": "131dd9e6ed68ed957809aaf10e3d124ce07c31b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI1NTc4NQ==", "url": "https://github.com/kiegroup/jbpm/pull/1749#discussion_r484255785", "bodyText": "done", "author": "elguardian", "createdAt": "2020-09-07T07:58:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQzMTkyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQzMjY2Ng==", "url": "https://github.com/kiegroup/jbpm/pull/1749#discussion_r483432666", "bodyText": "I would add a little more info about this exception and we can follow same approach as per other IOExceptions here in this class.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            logger.debug(\"Error when closing stream of kie-deployment-descriptor.xml\");\n          \n          \n            \n                            logger.warn(\"Error when closing stream of kie-deployment-descriptor.xml\", e);", "author": "afalhambra", "createdAt": "2020-09-04T07:15:23Z", "path": "jbpm-runtime-manager/src/main/java/org/jbpm/runtime/manager/impl/deploy/DeploymentDescriptorManagerUtil.java", "diffHunk": "@@ -66,18 +81,23 @@ protected static DeploymentDescriptor getDescriptorFromKModule(InternalKieModule\n         DeploymentDescriptor desc = null;\n         if (kmodule.isAvailable(DeploymentDescriptor.META_INF_LOCATION)) {\n             byte[] content = kmodule.getBytes(DeploymentDescriptor.META_INF_LOCATION);\n-            ByteArrayInputStream input = new ByteArrayInputStream(content);\n-            try {\n-                desc = DeploymentDescriptorIO.fromXml(input);\n-            } finally {\n-                try {\n-                    input.close();\n-                } catch (IOException e) {\n-                    logger.debug(\"Error when closing stream of kie-deployment-descriptor.xml\");\n-                }\n-            }\n+            desc = getDescriptorFromContent(content);\n         }\n \n         return desc;\n     }\n+\n+\n+    protected static DeploymentDescriptor getDescriptorFromContent(byte[] content) {\n+        ByteArrayInputStream input = new ByteArrayInputStream(content);\n+        try {\n+            return DeploymentDescriptorIO.fromXml(input);\n+        } finally {\n+            try {\n+                input.close();\n+            } catch (IOException e) {\n+                logger.debug(\"Error when closing stream of kie-deployment-descriptor.xml\");", "originalCommit": "131dd9e6ed68ed957809aaf10e3d124ce07c31b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI1NjI4Ng==", "url": "https://github.com/kiegroup/jbpm/pull/1749#discussion_r484256286", "bodyText": "ok", "author": "elguardian", "createdAt": "2020-09-07T07:58:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQzMjY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDMwMTMzOA==", "url": "https://github.com/kiegroup/jbpm/pull/1749#discussion_r484301338", "bodyText": "I can't see this yet?", "author": "afalhambra", "createdAt": "2020-09-07T09:14:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQzMjY2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQzODkyNA==", "url": "https://github.com/kiegroup/jbpm/pull/1749#discussion_r483438924", "bodyText": "typo\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                logger.warn(\"Cound not read deployment descriptor on classpath\", e);\n          \n          \n            \n                                logger.warn(\"Could not read deployment descriptor on classpath\", e);", "author": "afalhambra", "createdAt": "2020-09-04T07:29:18Z", "path": "jbpm-runtime-manager/src/main/java/org/jbpm/runtime/manager/impl/deploy/DeploymentDescriptorManagerUtil.java", "diffHunk": "@@ -38,9 +42,20 @@\n     public static List<DeploymentDescriptor> getDeploymentDescriptorHierarchy(DeploymentDescriptorManager manager, KieContainer kieContainer) {\n         List<DeploymentDescriptor> descriptorHierarchy = new ArrayList<DeploymentDescriptor>();\n \n-        if (((KieContainerImpl)kieContainer).getKieProject() instanceof KieModuleKieProject) {\n-            InternalKieModule module = ((KieModuleKieProject) ((KieContainerImpl)kieContainer).getKieProject()).getInternalKieModule();\n+        KieProject kieProject = ((KieContainerImpl)kieContainer).getKieProject();\n+        if (kieProject instanceof KieModuleKieProject) {\n+            InternalKieModule module = ((KieModuleKieProject) kieProject).getInternalKieModule();\n             collectDeploymentDescriptors(module, descriptorHierarchy);\n+        } else if (kieProject instanceof ClasspathKieProject) {\n+            InputStream is = ((ClasspathKieProject) kieProject).getClassLoader().getResourceAsStream(DeploymentDescriptor.META_INF_LOCATION);\n+            if(is != null) {\n+                try {\n+                    descriptorHierarchy.add(getDescriptorFromContent(IoUtils.readBytesFromInputStream(is)));\n+                } catch (IOException e) {\n+                    logger.warn(\"Cound not read deployment descriptor on classpath\", e);", "originalCommit": "131dd9e6ed68ed957809aaf10e3d124ce07c31b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDI1NjM4NA==", "url": "https://github.com/kiegroup/jbpm/pull/1749#discussion_r484256384", "bodyText": "ok", "author": "elguardian", "createdAt": "2020-09-07T07:58:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQzODkyNA=="}], "type": "inlineReview"}, {"oid": "d090fe4588afd8b585405e4e9d96b51dcf2d296e", "url": "https://github.com/kiegroup/jbpm/commit/d090fe4588afd8b585405e4e9d96b51dcf2d296e", "message": "[JBPM-9178] Immutable springboot images / adding the capability to read kie deployment descriptor from classpath", "committedDate": "2020-09-07T07:59:16Z", "type": "forcePushed"}, {"oid": "de601b19fbb443d9e26bd74ee7d04c08878b82ad", "url": "https://github.com/kiegroup/jbpm/commit/de601b19fbb443d9e26bd74ee7d04c08878b82ad", "message": "[JBPM-9178] Immutable springboot images / adding the capability to read kie deployment descriptor from classpath", "committedDate": "2020-09-07T13:12:39Z", "type": "commit"}, {"oid": "de601b19fbb443d9e26bd74ee7d04c08878b82ad", "url": "https://github.com/kiegroup/jbpm/commit/de601b19fbb443d9e26bd74ee7d04c08878b82ad", "message": "[JBPM-9178] Immutable springboot images / adding the capability to read kie deployment descriptor from classpath", "committedDate": "2020-09-07T13:12:39Z", "type": "forcePushed"}]}