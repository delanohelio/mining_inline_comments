{"pr_number": 3278, "pr_title": "Completed futures should operate on provided context", "pr_createdAt": "2020-02-06T17:20:16Z", "pr_url": "https://github.com/eclipse-vertx/vert.x/pull/3278", "timeline": [{"oid": "52cb285d46c44e0290db825d1221b6b05f4998df", "url": "https://github.com/eclipse-vertx/vert.x/commit/52cb285d46c44e0290db825d1221b6b05f4998df", "message": "Completed futures should operate on provided context\n\nSucceededFuture and FailedFuture, like other futures, take a context as constructor param.\nIf not null, this context should be used to dispatch the execution of future handlers.\n\nSigned-off-by: Thomas Segismont <tsegismont@gmail.com>", "committedDate": "2020-02-06T17:19:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMzNDUwNA==", "url": "https://github.com/eclipse-vertx/vert.x/pull/3278#discussion_r376334504", "bodyText": "can you replace this check with event-loop thread instead of not being the junit thread ?", "author": "vietj", "createdAt": "2020-02-07T11:01:59Z", "path": "src/test/java/io/vertx/core/FutureTest.java", "diffHunk": "@@ -1570,4 +1573,38 @@ public void testFromCompletionStageWithContext() {\n \n     await();\n   }\n+\n+  @Test\n+  public void testCompletedFuturesContext() {\n+    waitFor(4);\n+\n+    Thread testThread = Thread.currentThread();\n+    ContextInternal context = (ContextInternal) vertx.getOrCreateContext();\n+\n+    Future.succeededFuture().onSuccess(v -> {\n+      assertSame(testThread, Thread.currentThread());\n+      assertNull(Vertx.currentContext());\n+      complete();\n+    });\n+\n+    context.succeededFuture().onSuccess(v -> {\n+      assertNotSame(testThread, Thread.currentThread());", "originalCommit": "52cb285d46c44e0290db825d1221b6b05f4998df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM0MDAxMw==", "url": "https://github.com/eclipse-vertx/vert.x/pull/3278#discussion_r376340013", "bodyText": "Do you mean this?\n    context.succeededFuture().onSuccess(v -> {\n      assertNotSame(testThread, Thread.currentThread());\n      assertThat(Thread.currentThread(), is(instanceOf(VertxThread.class)));\n      assertSame(context, Vertx.currentContext());\n      complete();\n    });", "author": "tsegismont", "createdAt": "2020-02-07T11:16:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMzNDUwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM4NzEwMA==", "url": "https://github.com/eclipse-vertx/vert.x/pull/3278#discussion_r376387100", "bodyText": "or even better the thread of the context that is associated with the future (that you can latch before)", "author": "vietj", "createdAt": "2020-02-07T13:24:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMzNDUwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM4Nzg1MQ==", "url": "https://github.com/eclipse-vertx/vert.x/pull/3278#discussion_r376387851", "bodyText": "I think something like:\nctx.runOnContext(v -> {\n  Thread ctxThread = Thread.currentThread();\n  new Thread(() -> {\n    ctx.succeededFuture().onSuccess(v -> {\n      // Checks here\n    });\n  }).start();\n});", "author": "vietj", "createdAt": "2020-02-07T13:26:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMzNDUwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQxNTM3Mw==", "url": "https://github.com/eclipse-vertx/vert.x/pull/3278#discussion_r376415373", "bodyText": "What do we want to verify here? That a standard context always operates on the same thread? I believe we could take this for granted here.", "author": "tsegismont", "createdAt": "2020-02-07T14:23:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMzNDUwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY2MzY5MQ==", "url": "https://github.com/eclipse-vertx/vert.x/pull/3278#discussion_r376663691", "bodyText": "this is what should be checked, given that this implementation is different from FutureImpl. I was taking for granted that this impl was bug free 2 days ago :-)", "author": "vietj", "createdAt": "2020-02-08T00:11:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMzNDUwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY5MTM4Ng==", "url": "https://github.com/eclipse-vertx/vert.x/pull/3278#discussion_r376691386", "bodyText": "@vietj I've added some checks. PTAL", "author": "tsegismont", "createdAt": "2020-02-08T06:22:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMzNDUwNA=="}], "type": "inlineReview"}, {"oid": "1b9c1647307dfa34f8ce0c5b477796299aeaf2fc", "url": "https://github.com/eclipse-vertx/vert.x/commit/1b9c1647307dfa34f8ce0c5b477796299aeaf2fc", "message": "Added context thread checks\n\nSigned-off-by: Thomas Segismont <tsegismont@gmail.com>", "committedDate": "2020-02-08T06:21:41Z", "type": "commit"}]}