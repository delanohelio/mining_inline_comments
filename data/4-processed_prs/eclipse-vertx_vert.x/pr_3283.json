{"pr_number": 3283, "pr_title": "Use a http server to hold the port busy before the real test.", "pr_createdAt": "2020-02-12T14:58:09Z", "pr_url": "https://github.com/eclipse-vertx/vert.x/pull/3283", "timeline": [{"oid": "a74f7170ee6622d923b45d56eee2c78ee3cb8deb", "url": "https://github.com/eclipse-vertx/vert.x/commit/a74f7170ee6622d923b45d56eee2c78ee3cb8deb", "message": "Use a http server to hold the port busy before the real test.\n\nSigned-off-by: Rodrigo Salado Anaya <rodrigo.salado.anaya@gmail.com>", "committedDate": "2020-02-12T14:54:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODMyMDk0MQ==", "url": "https://github.com/eclipse-vertx/vert.x/pull/3283#discussion_r378320941", "bodyText": "can you use the onSuccess / onFailure lambdas to improve the test ?", "author": "vietj", "createdAt": "2020-02-12T15:23:45Z", "path": "src/test/java/io/vertx/core/net/NetTest.java", "diffHunk": "@@ -903,16 +903,21 @@ public void testConnectInvalidConnectHandler() throws Exception {\n \n   @Test\n   public void testListenInvalidPort() {\n-    /* Port 80 is free to use by any application on Windows, so this test fails. */\n-    Assume.assumeFalse(System.getProperty(\"os.name\").startsWith(\"Windows\"));\n-    server.close();\n-    server = vertx.createNetServer(new NetServerOptions().setPort(80));\n-    server.connectHandler((netSocket) -> {\n-    }).listen(ar -> {\n-      assertTrue(ar.failed());\n-      assertFalse(ar.succeeded());\n-      assertNotNull(ar.cause());\n-      testComplete();\n+    final int port = 9090;\n+    final HttpServer httpServer = vertx.createHttpServer();\n+    httpServer.requestHandler(r -> {}).listen(port, httpResult -> {", "originalCommit": "a74f7170ee6622d923b45d56eee2c78ee3cb8deb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bf15c5365786f4c17e447ce399da3ba1d2ae3e79", "url": "https://github.com/eclipse-vertx/vert.x/commit/bf15c5365786f4c17e447ce399da3ba1d2ae3e79", "message": "Use the onSuccess / onFailure lambdas to improve the test\n\nSigned-off-by: Rodrigo Salado Anaya <rodrigo.salado.anaya@gmail.com>", "committedDate": "2020-02-12T16:28:24Z", "type": "commit"}, {"oid": "1da4245ddf4fe052086ffba8bbd81e0be89f8717", "url": "https://github.com/eclipse-vertx/vert.x/commit/1da4245ddf4fe052086ffba8bbd81e0be89f8717", "message": "Following the recommendation of use AsyncTestBase.onFailure()\n\nSigned-off-by: Rodrigo Salado Anaya <rodrigo.salado.anaya@gmail.com>", "committedDate": "2020-02-13T15:04:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMyMDg1MQ==", "url": "https://github.com/eclipse-vertx/vert.x/pull/3283#discussion_r379320851", "bodyText": "I think here we need an onSuccess(...) block", "author": "vietj", "createdAt": "2020-02-14T09:13:37Z", "path": "src/test/java/io/vertx/core/net/NetTest.java", "diffHunk": "@@ -903,18 +903,18 @@ public void testConnectInvalidConnectHandler() throws Exception {\n \n   @Test\n   public void testListenInvalidPort() {\n-    /* Port 80 is free to use by any application on Windows, so this test fails. */\n-    Assume.assumeFalse(System.getProperty(\"os.name\").startsWith(\"Windows\"));\n-    server.close();\n-    server = vertx.createNetServer(new NetServerOptions().setPort(80));\n-    server.connectHandler((netSocket) -> {\n-    }).listen(ar -> {\n-      assertTrue(ar.failed());\n-      assertFalse(ar.succeeded());\n-      assertNotNull(ar.cause());\n-      testComplete();\n-    });\n+    final int port = 9090;\n+    final HttpServer httpServer = vertx.createHttpServer()\n+      .requestHandler(ignore -> {})\n+      .listen(port, httpResult ->", "originalCommit": "1da4245ddf4fe052086ffba8bbd81e0be89f8717", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0ed9f538c6b482701143939d99f7ba60a91d2484", "url": "https://github.com/eclipse-vertx/vert.x/commit/0ed9f538c6b482701143939d99f7ba60a91d2484", "message": "Use onSuccess to check the port in the http server\n\nSigned-off-by: Rodrigo Salado Anaya <rodrigo.salado.anaya@gmail.com>", "committedDate": "2020-02-14T14:42:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQ0OTIwMg==", "url": "https://github.com/eclipse-vertx/vert.x/pull/3283#discussion_r381449202", "bodyText": "we need this close to be in a finally block", "author": "vietj", "createdAt": "2020-02-19T18:05:06Z", "path": "src/test/java/io/vertx/core/net/NetTest.java", "diffHunk": "@@ -903,18 +903,18 @@ public void testConnectInvalidConnectHandler() throws Exception {\n \n   @Test\n   public void testListenInvalidPort() {\n-    /* Port 80 is free to use by any application on Windows, so this test fails. */\n-    Assume.assumeFalse(System.getProperty(\"os.name\").startsWith(\"Windows\"));\n-    server.close();\n-    server = vertx.createNetServer(new NetServerOptions().setPort(80));\n-    server.connectHandler((netSocket) -> {\n-    }).listen(ar -> {\n-      assertTrue(ar.failed());\n-      assertFalse(ar.succeeded());\n-      assertNotNull(ar.cause());\n-      testComplete();\n-    });\n+    final int port = 9090;\n+    final HttpServer httpServer = vertx.createHttpServer()\n+      .requestHandler(ignore -> {})\n+      .listen(port, onSuccess(s ->\n+        vertx.createNetServer()\n+          .connectHandler(ignore -> {})\n+          .listen(port, onFailure(error -> {\n+            assertNotNull(error);\n+            testComplete();\n+          }))));\n     await();\n+    httpServer.close();", "originalCommit": "0ed9f538c6b482701143939d99f7ba60a91d2484", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a486cf64c1e26ee929475ae1d6cea563e3c1444b", "url": "https://github.com/eclipse-vertx/vert.x/commit/a486cf64c1e26ee929475ae1d6cea563e3c1444b", "message": "Use a finally block to close the http server\n\nSigned-off-by: Rodrigo Salado Anaya <rodrigo.salado.anaya@gmail.com>", "committedDate": "2020-02-19T19:18:16Z", "type": "commit"}]}