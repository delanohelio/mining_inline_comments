{"pr_number": 7709, "pr_title": "xds: move subchannel TLS context attaching code to cluster_impl LB policy", "pr_createdAt": "2020-12-08T01:18:59Z", "pr_url": "https://github.com/grpc/grpc-java/pull/7709", "timeline": [{"oid": "2c2ddfbad20a0e2b53586480e04b9821765450d7", "url": "https://github.com/grpc/grpc-java/commit/2c2ddfbad20a0e2b53586480e04b9821765450d7", "message": "Add TLS context to cluster_impl LB policy config.", "committedDate": "2020-12-08T00:59:38Z", "type": "commit"}, {"oid": "74676a409e6598fcc487440f3bdf9e7df92dbde5", "url": "https://github.com/grpc/grpc-java/commit/74676a409e6598fcc487440f3bdf9e7df92dbde5", "message": "buildscripts: add missing CI coverage for examples (#7708)\n\nAdds CI coverage for building example/android/strictmode and examples/example-jwt-auth. Also cleans up existing Gradle and Maven build command in the CIs.", "committedDate": "2020-12-08T00:59:38Z", "type": "commit"}, {"oid": "d2369d1e93a9d9ba05bb72d12a4cb86da4b57888", "url": "https://github.com/grpc/grpc-java/commit/d2369d1e93a9d9ba05bb72d12a4cb86da4b57888", "message": "Decorating LB Helper with logic of attaching SSL context provider supplier to EAGs when creating subchannels in cluster_resolver LB policy.", "committedDate": "2020-12-08T00:59:38Z", "type": "commit"}, {"oid": "ade2cb0a4ed41c23a2b540e350f3a20366234e47", "url": "https://github.com/grpc/grpc-java/commit/ade2cb0a4ed41c23a2b540e350f3a20366234e47", "message": "Pass TLS context through EDS LB policy.", "committedDate": "2020-12-08T00:59:38Z", "type": "commit"}, {"oid": "29c3b031bda88cfd6163276e8fe735d58c3a666b", "url": "https://github.com/grpc/grpc-java/commit/29c3b031bda88cfd6163276e8fe735d58c3a666b", "message": "Delete logic for wrapping LB helper with logic of attaching TLS context to EAGs when creating subchannels in CDS LB policy.", "committedDate": "2020-12-08T00:59:38Z", "type": "commit"}, {"oid": "4fa43a68a75ffe3b9f26453eddbfcfaf74723bcf", "url": "https://github.com/grpc/grpc-java/commit/4fa43a68a75ffe3b9f26453eddbfcfaf74723bcf", "message": "Merge branch 'master' of github.com:grpc/grpc-java into impl/move_endpoint_tls_context_decor_logic_into_cluster_impl_lb_policy", "committedDate": "2020-12-08T01:20:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc3OTAwMw==", "url": "https://github.com/grpc/grpc-java/pull/7709#discussion_r540779003", "bodyText": "Why is this called populate...? It is misleading. It is just extracting a tlsContext from the child policy of a priority. extractTlsContext would be more appropriate.", "author": "sanjaypujare", "createdAt": "2020-12-11T08:40:18Z", "path": "xds/src/test/java/io/grpc/xds/EdsLoadBalancer2Test.java", "diffHunk": "@@ -493,16 +489,30 @@ private Long populateMaxConcurrentRequests(PriorityLbConfig config, String prior\n     return clusterImplConfig.maxConcurrentRequests;\n   }\n \n-  private PolicySelection populateLeafLbPolicy(PriorityLbConfig config, String priority,\n-      Locality locality) {\n+  @Test\n+  public void configUpdate_changeTlsContext_propagateToChildLb() {\n+    deliverSimpleClusterLoadAssignment(EDS_SERVICE_NAME);\n+    FakeLoadBalancer childBalancer = Iterables.getOnlyElement(childBalancers);\n+    PriorityLbConfig childLbConfig = (PriorityLbConfig) childBalancer.config;\n+    assertThat(populateTlsContext(childLbConfig, \"priority1\")).isNull();\n+\n+    UpstreamTlsContext upstreamTlsContext =\n+        CommonTlsContextTestsUtil.buildUpstreamTlsContextFromFilenames(\n+            CommonTlsContextTestsUtil.CLIENT_KEY_FILE,\n+            CommonTlsContextTestsUtil.CLIENT_PEM_FILE,\n+            CommonTlsContextTestsUtil.CA_PEM_FILE);\n+    EdsConfig config = new EdsConfig(CLUSTER, EDS_SERVICE_NAME, LRS_SERVER_NAME, 100L,\n+        upstreamTlsContext, weightedTarget, roundRobin);\n+    deliverConfig(config);\n+    assertThat(Iterables.getOnlyElement(childBalancers)).isSameInstanceAs(childBalancer);\n+    childLbConfig = (PriorityLbConfig) childBalancer.config;\n+    assertThat(populateTlsContext(childLbConfig, \"priority1\")).isEqualTo(upstreamTlsContext);\n+  }\n+\n+  private UpstreamTlsContext populateTlsContext(PriorityLbConfig config, String priority) {", "originalCommit": "4fa43a68a75ffe3b9f26453eddbfcfaf74723bcf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ0NjEyMw==", "url": "https://github.com/grpc/grpc-java/pull/7709#discussion_r541446123", "bodyText": "Well this is private and in test, and the EDS LB policy will soon be replaced by the cluster_resolver LB policy (#7685 and #7722 migrates to it, then this will be deleted). So we probably don't bother picking these things. \ud83d\ude04", "author": "voidzcy", "createdAt": "2020-12-12T00:13:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc3OTAwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTI3MTUwMw==", "url": "https://github.com/grpc/grpc-java/pull/7709#discussion_r541271503", "bodyText": "How does tlsContext.toString() look? Seems it contains nested Any field.", "author": "dapengzhang0", "createdAt": "2020-12-11T20:46:23Z", "path": "xds/src/main/java/io/grpc/xds/EdsLoadBalancerProvider.java", "diffHunk": "@@ -78,23 +82,50 @@ public ConfigOrError parseLoadBalancingPolicyConfig(\n         @Nullable String edsServiceName,\n         @Nullable String lrsServerName,\n         @Nullable Long maxConcurrentRequests,\n+        @Nullable UpstreamTlsContext tlsContext,\n         PolicySelection localityPickingPolicy,\n         PolicySelection endpointPickingPolicy) {\n       this.clusterName = checkNotNull(clusterName, \"clusterName\");\n       this.edsServiceName = edsServiceName;\n       this.lrsServerName = lrsServerName;\n       this.maxConcurrentRequests = maxConcurrentRequests;\n+      this.tlsContext = tlsContext;\n       this.localityPickingPolicy = checkNotNull(localityPickingPolicy, \"localityPickingPolicy\");\n       this.endpointPickingPolicy = checkNotNull(endpointPickingPolicy, \"endpointPickingPolicy\");\n     }\n \n+    @Override\n+    public int hashCode() {\n+      return Objects.hash(clusterName, edsServiceName, lrsServerName, maxConcurrentRequests,\n+          tlsContext, localityPickingPolicy, endpointPickingPolicy);\n+    }\n+\n+    @Override\n+    public boolean equals(Object o) {\n+      if (this == o) {\n+        return true;\n+      }\n+      if (o == null || getClass() != o.getClass()) {\n+        return false;\n+      }\n+      EdsConfig that = (EdsConfig) o;\n+      return Objects.equals(clusterName, that.clusterName)\n+          && Objects.equals(edsServiceName, that.edsServiceName)\n+          && Objects.equals(lrsServerName, that.lrsServerName)\n+          && Objects.equals(maxConcurrentRequests, that.maxConcurrentRequests)\n+          && Objects.equals(tlsContext, that.tlsContext)\n+          && Objects.equals(localityPickingPolicy, that.localityPickingPolicy)\n+          && Objects.equals(endpointPickingPolicy, that.endpointPickingPolicy);\n+    }\n+\n     @Override\n     public String toString() {\n       return MoreObjects.toStringHelper(this)\n           .add(\"clusterName\", clusterName)\n           .add(\"edsServiceName\", edsServiceName)\n           .add(\"lrsServerName\", lrsServerName)\n           .add(\"maxConcurrentRequests\", maxConcurrentRequests)\n+          .add(\"tlsContext\", tlsContext)", "originalCommit": "4fa43a68a75ffe3b9f26453eddbfcfaf74723bcf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ0OTI5Ng==", "url": "https://github.com/grpc/grpc-java/pull/7709#discussion_r541449296", "bodyText": "Well, the class UpstreamTlsContext is weird, it does nothing but just wrap the proto. Its toString() is causing the problem (and its @Nullable annotations are completely a mess...). Probably I should just drop it in the toString() here.", "author": "voidzcy", "createdAt": "2020-12-12T00:17:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTI3MTUwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ1MzAyMQ==", "url": "https://github.com/grpc/grpc-java/pull/7709#discussion_r541453021", "bodyText": "Removed UpstreamTlsContext from toStings of data structures including it.", "author": "voidzcy", "createdAt": "2020-12-12T00:30:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTI3MTUwMw=="}], "type": "inlineReview"}, {"oid": "c3e942776925a74d9b0c36bcec714bc679be2c8f", "url": "https://github.com/grpc/grpc-java/commit/c3e942776925a74d9b0c36bcec714bc679be2c8f", "message": "Remove printing UpstreamTlsContext in data structures including it.", "committedDate": "2020-12-12T00:27:43Z", "type": "commit"}]}