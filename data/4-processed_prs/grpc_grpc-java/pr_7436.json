{"pr_number": 7436, "pr_title": "xds: bootstrapper fixes: remove extra readBootstrap & avoid parseConfig", "pr_createdAt": "2020-09-17T05:18:37Z", "pr_url": "https://github.com/grpc/grpc-java/pull/7436", "timeline": [{"oid": "fb68eb0ce77add1ee52c4c6f73c259f18c5dc364", "url": "https://github.com/grpc/grpc-java/commit/fb68eb0ce77add1ee52c4c6f73c259f18c5dc364", "message": "xds: bootstrapper fixes: remove extra readBootstrap & avoid parseConfig", "committedDate": "2020-09-17T05:14:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUzNDQzOA==", "url": "https://github.com/grpc/grpc-java/pull/7436#discussion_r490534438", "bodyText": "This is a wrong usage. Since this is your utility method go generating a BootstrapInfo used in tests, it should handle all errors internally by itself. That is, exceptions thrown in this utility method should not account for test failures. So basically, you would do:\ntry {\n   ...\n} catch (IOException e) {\n   throw AssertionError(e);\n}", "author": "voidzcy", "createdAt": "2020-09-17T20:13:22Z", "path": "xds/src/test/java/io/grpc/xds/CommonBootstrapperTestUtils.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 The gRPC Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.grpc.xds;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import io.grpc.internal.JsonParser;\n+import java.io.IOException;\n+import java.util.Map;\n+\n+public class CommonBootstrapperTestUtils {\n+  private static final String FILE_WATCHER_CONFIG = \"{\\\"path\\\": \\\"/etc/secret/certs\\\"}\";\n+  private static final String MESHCA_CONFIG =\n+      \"{\\n\"\n+          + \"        \\\"server\\\": {\\n\"\n+          + \"          \\\"api_type\\\": \\\"GRPC\\\",\\n\"\n+          + \"          \\\"grpc_services\\\": [{\\n\"\n+          + \"            \\\"google_grpc\\\": {\\n\"\n+          + \"              \\\"target_uri\\\": \\\"meshca.com\\\",\\n\"\n+          + \"              \\\"channel_credentials\\\": {\\\"google_default\\\": {}},\\n\"\n+          + \"              \\\"call_credentials\\\": [{\\n\"\n+          + \"                \\\"sts_service\\\": {\\n\"\n+          + \"                  \\\"token_exchange_service\\\": \\\"securetoken.googleapis.com\\\",\\n\"\n+          + \"                  \\\"subject_token_path\\\": \\\"/etc/secret/sajwt.token\\\"\\n\"\n+          + \"                }\\n\"\n+          + \"              }]\\n\" // end call_credentials\n+          + \"            },\\n\" // end google_grpc\n+          + \"            \\\"time_out\\\": {\\\"seconds\\\": 10}\\n\"\n+          + \"          }]\\n\" // end grpc_services\n+          + \"        },\\n\" // end server\n+          + \"        \\\"certificate_lifetime\\\": {\\\"seconds\\\": 86400},\\n\"\n+          + \"        \\\"renewal_grace_period\\\": {\\\"seconds\\\": 3600},\\n\"\n+          + \"        \\\"key_type\\\": \\\"RSA\\\",\\n\"\n+          + \"        \\\"key_size\\\": 2048,\\n\"\n+          + \"        \\\"location\\\": \\\"https://container.googleapis.com/v1/project/test-project1/locations/test-zone2/clusters/test-cluster3\\\"\\n\"\n+          + \"      }\";\n+\n+  /** Creates a test bootstrap info object. */\n+  @SuppressWarnings(\"unchecked\")\n+  public static Bootstrapper.BootstrapInfo getTestBootstrapInfo()\n+          throws XdsInitializationException {\n+    try {\n+      Bootstrapper.CertificateProviderInfo gcpId =\n+          new Bootstrapper.CertificateProviderInfo(\n+              \"testca\", (Map<String, ?>) JsonParser.parse(MESHCA_CONFIG));\n+      Bootstrapper.CertificateProviderInfo fileProvider =\n+          new Bootstrapper.CertificateProviderInfo(\n+              \"file_watcher\", (Map<String, ?>) JsonParser.parse(FILE_WATCHER_CONFIG));\n+      Map<String, Bootstrapper.CertificateProviderInfo> certProviders =\n+          ImmutableMap.of(\"gcp_id\", gcpId, \"file_provider\", fileProvider);\n+      Bootstrapper.BootstrapInfo bootstrapInfo =\n+          new Bootstrapper.BootstrapInfo(\n+              ImmutableList.<Bootstrapper.ServerInfo>of(),\n+              EnvoyProtoData.Node.newBuilder().build(),\n+              certProviders);\n+      return bootstrapInfo;\n+    } catch (IOException e) {\n+      throw new XdsInitializationException(\"\", e);", "originalCommit": "fb68eb0ce77add1ee52c4c6f73c259f18c5dc364", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzNTQ1Ng==", "url": "https://github.com/grpc/grpc-java/pull/7436#discussion_r490635456", "bodyText": "The catch/Exception stuff is there only to satisfy the compiler since the actual exception never happens. I'll change it to AssertionError but it's purely hypothetical.", "author": "sanjaypujare", "createdAt": "2020-09-18T00:36:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUzNDQzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzNzc3Mw==", "url": "https://github.com/grpc/grpc-java/pull/7436#discussion_r490637773", "bodyText": "Done.", "author": "sanjaypujare", "createdAt": "2020-09-18T00:45:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUzNDQzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUzNzE5OA==", "url": "https://github.com/grpc/grpc-java/pull/7436#discussion_r490537198", "bodyText": "Is this change necessary? For tests you are using the other constructor, but for real instantiation it just calls Bootstrapper.getInstance() inside the constructor to get the default implementation. That doesn't sound wrong. It doesn't need to leave this burden to the caller of this class.", "author": "voidzcy", "createdAt": "2020-09-17T20:18:48Z", "path": "xds/src/main/java/io/grpc/xds/internal/sds/ClientSslContextProviderFactory.java", "diffHunk": "@@ -34,8 +34,8 @@\n   private final CertProviderClientSslContextProvider.Factory\n       certProviderClientSslContextProviderFactory;\n \n-  ClientSslContextProviderFactory() {\n-    this(Bootstrapper.getInstance(), CertProviderClientSslContextProvider.Factory.getInstance());\n+  ClientSslContextProviderFactory(Bootstrapper bootstrapper) {", "originalCommit": "fb68eb0ce77add1ee52c4c6f73c259f18c5dc364", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzNzExNw==", "url": "https://github.com/grpc/grpc-java/pull/7436#discussion_r490637117", "bodyText": "This is highly desirable. The Bootstrapper.getInstance() is now called in only one place: io.grpc.xds.internal.sds.TlsContextManagerImpl.getInstance() and that instance is then propagated to all the members. Similar to how the abstract Factories are used wherever possible.", "author": "sanjaypujare", "createdAt": "2020-09-18T00:42:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUzNzE5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY0MzAzOQ==", "url": "https://github.com/grpc/grpc-java/pull/7436#discussion_r490643039", "bodyText": "It doesn't matter as Bootstrap.getInstance returns the singleton.", "author": "voidzcy", "createdAt": "2020-09-18T01:06:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUzNzE5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY5MzQwMg==", "url": "https://github.com/grpc/grpc-java/pull/7436#discussion_r490693402", "bodyText": "Yes, but it returns an implementation that is fixed and that reads from disk.", "author": "sanjaypujare", "createdAt": "2020-09-18T04:20:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUzNzE5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUzODIxOA==", "url": "https://github.com/grpc/grpc-java/pull/7436#discussion_r490538218", "bodyText": "Same comment as for ClientSslContextProviderFactory.", "author": "voidzcy", "createdAt": "2020-09-17T20:20:40Z", "path": "xds/src/main/java/io/grpc/xds/internal/sds/ServerSslContextProviderFactory.java", "diffHunk": "@@ -34,8 +34,8 @@\n   private final CertProviderServerSslContextProvider.Factory\n       certProviderServerSslContextProviderFactory;\n \n-  ServerSslContextProviderFactory() {\n-    this(Bootstrapper.getInstance(), CertProviderServerSslContextProvider.Factory.getInstance());\n+  ServerSslContextProviderFactory(Bootstrapper bootstrapper) {\n+    this(bootstrapper, CertProviderServerSslContextProvider.Factory.getInstance());", "originalCommit": "fb68eb0ce77add1ee52c4c6f73c259f18c5dc364", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzNzE4NQ==", "url": "https://github.com/grpc/grpc-java/pull/7436#discussion_r490637185", "bodyText": "Same answer as above.", "author": "sanjaypujare", "createdAt": "2020-09-18T00:43:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUzODIxOA=="}], "type": "inlineReview"}, {"oid": "b0ae4f76c00b0bd4b0fc3bb1a0ad122fdd35fccc", "url": "https://github.com/grpc/grpc-java/commit/b0ae4f76c00b0bd4b0fc3bb1a0ad122fdd35fccc", "message": "address review comments", "committedDate": "2020-09-18T00:44:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY0MzY3MA==", "url": "https://github.com/grpc/grpc-java/pull/7436#discussion_r490643670", "bodyText": "nit: map is a bad variable name. Same for other places.", "author": "voidzcy", "createdAt": "2020-09-18T01:08:58Z", "path": "xds/src/test/java/io/grpc/xds/internal/certprovider/MeshCaCertificateProviderProviderTest.java", "diffHunk": "@@ -107,10 +106,11 @@ public void providerRegisteredName() {\n   }\n \n   @Test\n-  public void createProvider_minimalConfig() throws XdsInitializationException {\n+  public void createProvider_minimalConfig() throws IOException {\n     CertificateProvider.DistributorWatcher distWatcher =\n         new CertificateProvider.DistributorWatcher();\n-    Map<String, ?> map = buildMinimalConfig();\n+    @SuppressWarnings(\"unchecked\")\n+    Map<String, ?> map = (Map<String, ?>) JsonParser.parse(MINIMAL_MESHCA_CONFIG);", "originalCommit": "b0ae4f76c00b0bd4b0fc3bb1a0ad122fdd35fccc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}