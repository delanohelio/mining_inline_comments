{"pr_number": 7170, "pr_title": "xds: 1st part of implementation of CertificateProvider for agentless", "pr_createdAt": "2020-06-30T02:10:03Z", "pr_url": "https://github.com/grpc/grpc-java/pull/7170", "timeline": [{"oid": "4e529756e14aca57872b16e0542776878c023a0f", "url": "https://github.com/grpc/grpc-java/commit/4e529756e14aca57872b16e0542776878c023a0f", "message": "xds: 1st part of implementation of CertificateProvider for agentless", "committedDate": "2020-06-30T02:08:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAyMTYxNg==", "url": "https://github.com/grpc/grpc-java/pull/7170#discussion_r448021616", "bodyText": "This is a regular comment or TODO comment rather than javadoc. Ditto for the other class.", "author": "dapengzhang0", "createdAt": "2020-06-30T22:49:28Z", "path": "xds/src/main/java/io/grpc/xds/internal/certprovider/CertificateProvider.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Copyright 2020 The gRPC Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.grpc.xds.internal.certprovider;\n+\n+import java.security.PrivateKey;\n+import java.security.cert.X509Certificate;\n+import java.util.List;\n+\n+/**\n+ * A plug-in that provides certificates required by the xDS security component and created\n+ * using the certificate-provider config from the xDS server.\n+ *\n+ * <p>We may move this out of the internal package and make this an official API in the future.", "originalCommit": "4e529756e14aca57872b16e0542776878c023a0f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODE1NTY0Mw==", "url": "https://github.com/grpc/grpc-java/pull/7170#discussion_r448155643", "bodyText": "This is meant to be a regular comment and not a TODO comment because this is not a short-term workaround but rather a long term goal documented in the comment.", "author": "sanjaypujare", "createdAt": "2020-07-01T07:00:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAyMTYxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAyNTM2Nw==", "url": "https://github.com/grpc/grpc-java/pull/7170#discussion_r448025367", "bodyText": "{@link #close()} is called to \u201cshut down\u201d the provider. looks redundant as the javadoc for the close() method covers it well.\nbtw. Any reason not implementing java.io.Closable interface?", "author": "dapengzhang0", "createdAt": "2020-06-30T23:00:24Z", "path": "xds/src/main/java/io/grpc/xds/internal/certprovider/CertificateProvider.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Copyright 2020 The gRPC Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.grpc.xds.internal.certprovider;\n+\n+import java.security.PrivateKey;\n+import java.security.cert.X509Certificate;\n+import java.util.List;\n+\n+/**\n+ * A plug-in that provides certificates required by the xDS security component and created\n+ * using the certificate-provider config from the xDS server.\n+ *\n+ * <p>We may move this out of the internal package and make this an official API in the future.\n+ *\n+ * <p>The plugin fetches certificates - root and optionally identity cert - required by xDS\n+ * security.  {@link #close()} is called to \u201cshut down\u201d the provider.", "originalCommit": "4e529756e14aca57872b16e0542776878c023a0f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAyNjE5OQ==", "url": "https://github.com/grpc/grpc-java/pull/7170#discussion_r448026199", "bodyText": "These can be final?", "author": "dapengzhang0", "createdAt": "2020-06-30T23:02:52Z", "path": "xds/src/main/java/io/grpc/xds/internal/certprovider/CertificateProvider.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Copyright 2020 The gRPC Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.grpc.xds.internal.certprovider;\n+\n+import java.security.PrivateKey;\n+import java.security.cert.X509Certificate;\n+import java.util.List;\n+\n+/**\n+ * A plug-in that provides certificates required by the xDS security component and created\n+ * using the certificate-provider config from the xDS server.\n+ *\n+ * <p>We may move this out of the internal package and make this an official API in the future.\n+ *\n+ * <p>The plugin fetches certificates - root and optionally identity cert - required by xDS\n+ * security.  {@link #close()} is called to \u201cshut down\u201d the provider.\n+ */\n+public abstract class CertificateProvider {\n+\n+  /** A watcher is registered via the constructor to receive updates for the certificates. */\n+  public interface Watcher {\n+    void updateCertificate(PrivateKey key, List<X509Certificate> certChain);\n+\n+    void updateTrustedRoots(List<X509Certificate> trustedRoots);\n+\n+    void onError(io.grpc.Status errorStatus);\n+  }\n+\n+  /**\n+   * Concrete subclasses will call this to register the {@link Watcher}.\n+   *\n+   * @param watcher to register\n+   * @param notifyCertUpdates if true, the provider is required to call the watcher\u2019s\n+   *     updateCertificate method. Implies the Provider is capable of minting certificates.\n+   *     Used by server-side and mTLS client-side. Note the Provider is always required\n+   *     to call updateTrustedRoots to provide trusted-root updates.\n+   */\n+  protected CertificateProvider(Watcher watcher, boolean notifyCertUpdates) {\n+    this.watcher = watcher;\n+    this.notifyCertUpdates = notifyCertUpdates;\n+  }\n+\n+  /**\n+   * Called by CertificateProviderStore to ask the plugin to release all resources and stop\n+   * cert refreshes and watcher updates. The instance will be released from the store and will be\n+   * garbage collected.\n+   */\n+  public abstract void close();\n+\n+  protected Watcher watcher;", "originalCommit": "4e529756e14aca57872b16e0542776878c023a0f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "db1746bc540d363091f42487a032954860826165", "url": "https://github.com/grpc/grpc-java/commit/db1746bc540d363091f42487a032954860826165", "message": "address review comments", "committedDate": "2020-07-01T07:23:36Z", "type": "commit"}]}