{"pr_number": 7059, "pr_title": "xds: replace generic with individual client and server SslContextProviders", "pr_createdAt": "2020-05-22T00:17:00Z", "pr_url": "https://github.com/grpc/grpc-java/pull/7059", "timeline": [{"oid": "3d551954c2c5ced9cba30e2cb5aa668b76e447d4", "url": "https://github.com/grpc/grpc-java/commit/3d551954c2c5ced9cba30e2cb5aa668b76e447d4", "message": "xds: replace generic with individual client and server SslContextProviders", "committedDate": "2020-05-22T00:14:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk4Mzg1MQ==", "url": "https://github.com/grpc/grpc-java/pull/7059#discussion_r428983851", "bodyText": "nit: those finals are unnecessary.", "author": "creamsoup", "createdAt": "2020-05-22T00:30:20Z", "path": "xds/src/main/java/io/grpc/xds/internal/sds/ReferenceCountingSslContextProviderMap.java", "diffHunk": "@@ -65,29 +66,29 @@\n    * <p>Caller must not release a reference more than once. It's advised that you clear the\n    * reference to the instance with the null returned by this method.\n    *\n+   * @param key for the instance to be released\n    * @param value the instance to be released\n    * @return a null which the caller can use to clear the reference to that instance.\n    */\n-  public SslContextProvider<K> release(final SslContextProvider<K> value) {\n+  public P release(K key, final P value) {\n+    checkNotNull(key, \"key\");\n     checkNotNull(value, \"value\");\n-    K key = value.getSource();\n     return releaseInternal(key, value);\n   }\n \n-  private synchronized SslContextProvider<K> getInternal(K key) {\n-    Instance<K> instance = instances.get(key);\n+  private synchronized P getInternal(K key) {\n+    Instance<K, P> instance = instances.get(key);\n     if (instance == null) {\n-      instance = new Instance<>(sslContextProviderFactory.createSslContextProvider(key));\n+      instance = new Instance<K, P>(sslContextProviderFactory.createSslContextProvider(key));\n       instances.put(key, instance);\n       return instance.sslContextProvider;\n     } else {\n       return instance.acquire();\n     }\n   }\n \n-  private synchronized SslContextProvider<K> releaseInternal(\n-      final K key, final SslContextProvider<K> instance) {\n-    final Instance<K> cached = instances.get(key);\n+  private synchronized P releaseInternal(final K key, final P instance) {", "originalCommit": "3d551954c2c5ced9cba30e2cb5aa668b76e447d4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDU5MDU3Mg==", "url": "https://github.com/grpc/grpc-java/pull/7059#discussion_r430590572", "bodyText": "helper using helpee is weird. is there way to avoid this circular dependency? btw, this class makes sense as an abstract class, but not as a helper class.", "author": "creamsoup", "createdAt": "2020-05-26T17:39:24Z", "path": "xds/src/main/java/io/grpc/xds/internal/sds/SdsSslContextProviderHelper.java", "diffHunk": "@@ -178,9 +104,9 @@ public void addCallback(Callback callback, Executor executor) {\n   }\n \n   private void callPerformCallback(\n-      Callback callback, Executor executor, final SslContext sslContextCopy) {\n-    performCallback(\n-        new SslContextGetter() {\n+      SslContextProvider.Callback callback, Executor executor, final SslContext sslContextCopy) {\n+    sslContextProvider.performCallback(", "originalCommit": "3d551954c2c5ced9cba30e2cb5aa668b76e447d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDc2MzUxOA==", "url": "https://github.com/grpc/grpc-java/pull/7059#discussion_r430763518", "bodyText": "Yes I realized that but Java doesn't have multiple inheritance (unlike C++) so my only alternative was to inject the helper to achieve code reuse - I really would have hated code duplication.\nI was also aware of the Helper class calling back into the caller of the helper but again I thought this is the best way to structure the code without unnecessarily duplicating it. Let me see if I can achieve the same result by restructuring this.", "author": "sanjaypujare", "createdAt": "2020-05-26T23:34:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDU5MDU3Mg=="}], "type": "inlineReview"}, {"oid": "08e20237c86f983ca6f72627cd73c81a4fe85718", "url": "https://github.com/grpc/grpc-java/commit/08e20237c86f983ca6f72627cd73c81a4fe85718", "message": "xds: remove unnecessary final", "committedDate": "2020-05-27T01:17:27Z", "type": "commit"}, {"oid": "1e3f30bd72222fe474c78f26172d2ae3cba8beca", "url": "https://github.com/grpc/grpc-java/commit/1e3f30bd72222fe474c78f26172d2ae3cba8beca", "message": "xds: address review comments get rid of the Helper class", "committedDate": "2020-05-27T05:14:03Z", "type": "commit"}, {"oid": "a708edc9be9e808ae54b1fb8ebb199695b3d0125", "url": "https://github.com/grpc/grpc-java/commit/a708edc9be9e808ae54b1fb8ebb199695b3d0125", "message": "xds: clean up code/format", "committedDate": "2020-05-27T05:54:21Z", "type": "commit"}, {"oid": "b4764ca53ee0213c68ef151c3ef03e05d84325b5", "url": "https://github.com/grpc/grpc-java/commit/b4764ca53ee0213c68ef151c3ef03e05d84325b5", "message": "xds: minor cleanup1", "committedDate": "2020-05-27T06:03:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTI5OTkxNQ==", "url": "https://github.com/grpc/grpc-java/pull/7059#discussion_r431299915", "bodyText": "@Nullable", "author": "creamsoup", "createdAt": "2020-05-27T16:58:52Z", "path": "xds/src/main/java/io/grpc/xds/internal/sds/CommonTlsContextUtil.java", "diffHunk": "@@ -40,4 +47,52 @@ static boolean hasAllSecretsUsingSds(CommonTlsContext commonTlsContext) {\n     return (commonTlsContext.getTlsCertificatesCount() == 0)\n         && !commonTlsContext.hasValidationContext();\n   }\n+\n+  static CertificateValidationContext getCertificateValidationContext(", "originalCommit": "b4764ca53ee0213c68ef151c3ef03e05d84325b5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTMwMTM3Ng==", "url": "https://github.com/grpc/grpc-java/pull/7059#discussion_r431301376", "bodyText": "nit: move this next to the other getter? (i am not sure about the class structure)", "author": "creamsoup", "createdAt": "2020-05-27T17:01:13Z", "path": "xds/src/main/java/io/grpc/xds/internal/sds/DownstreamTlsContextHolder.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Copyright 2020 The gRPC Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.grpc.xds.internal.sds;\n+\n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n+import io.envoyproxy.envoy.api.v2.auth.CommonTlsContext;\n+import io.envoyproxy.envoy.api.v2.auth.DownstreamTlsContext;\n+\n+class DownstreamTlsContextHolder implements TlsContextHolder {\n+\n+  public DownstreamTlsContext getDownstreamTlsContext() {", "originalCommit": "b4764ca53ee0213c68ef151c3ef03e05d84325b5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTMwMTYzMg==", "url": "https://github.com/grpc/grpc-java/pull/7059#discussion_r431301632", "bodyText": "can be a final class", "author": "creamsoup", "createdAt": "2020-05-27T17:01:38Z", "path": "xds/src/main/java/io/grpc/xds/internal/sds/DownstreamTlsContextHolder.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Copyright 2020 The gRPC Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.grpc.xds.internal.sds;\n+\n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n+import io.envoyproxy.envoy.api.v2.auth.CommonTlsContext;\n+import io.envoyproxy.envoy.api.v2.auth.DownstreamTlsContext;\n+\n+class DownstreamTlsContextHolder implements TlsContextHolder {", "originalCommit": "b4764ca53ee0213c68ef151c3ef03e05d84325b5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM1NzkyMQ==", "url": "https://github.com/grpc/grpc-java/pull/7059#discussion_r431357921", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return ((DownstreamTlsContextHolder)tlsContextHolder).getDownstreamTlsContext();\n          \n          \n            \n                return ((DownstreamTlsContextHolder) tlsContextHolder).getDownstreamTlsContext();", "author": "creamsoup", "createdAt": "2020-05-27T18:32:51Z", "path": "xds/src/main/java/io/grpc/xds/internal/sds/SslContextProvider.java", "diffHunk": "@@ -97,6 +77,20 @@ protected void setClientAuthValues(\n     }\n   }\n \n+  /** Returns the DownstreamTlsContext in this SslContextProvider if this is server side. **/\n+  public DownstreamTlsContext getDownstreamTlsContext() {\n+    checkState(tlsContextHolder instanceof DownstreamTlsContextHolder,\n+        \"expected DownstreamTlsContextHolder\");\n+    return ((DownstreamTlsContextHolder)tlsContextHolder).getDownstreamTlsContext();", "originalCommit": "b4764ca53ee0213c68ef151c3ef03e05d84325b5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM1Nzk5OQ==", "url": "https://github.com/grpc/grpc-java/pull/7059#discussion_r431357999", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return ((UpstreamTlsContextHolder)tlsContextHolder).getUpstreamTlsContext();\n          \n          \n            \n                return ((UpstreamTlsContextHolder) tlsContextHolder).getUpstreamTlsContext();", "author": "creamsoup", "createdAt": "2020-05-27T18:32:59Z", "path": "xds/src/main/java/io/grpc/xds/internal/sds/SslContextProvider.java", "diffHunk": "@@ -97,6 +77,20 @@ protected void setClientAuthValues(\n     }\n   }\n \n+  /** Returns the DownstreamTlsContext in this SslContextProvider if this is server side. **/\n+  public DownstreamTlsContext getDownstreamTlsContext() {\n+    checkState(tlsContextHolder instanceof DownstreamTlsContextHolder,\n+        \"expected DownstreamTlsContextHolder\");\n+    return ((DownstreamTlsContextHolder)tlsContextHolder).getDownstreamTlsContext();\n+  }\n+\n+  /** Returns the UpstreamTlsContext in this SslContextProvider if this is client side. **/\n+  public UpstreamTlsContext getUpstreamTlsContext() {\n+    checkState(tlsContextHolder instanceof UpstreamTlsContextHolder,\n+        \"expected UpstreamTlsContextHolder\");\n+    return ((UpstreamTlsContextHolder)tlsContextHolder).getUpstreamTlsContext();", "originalCommit": "b4764ca53ee0213c68ef151c3ef03e05d84325b5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM1ODkyNg==", "url": "https://github.com/grpc/grpc-java/pull/7059#discussion_r431358926", "bodyText": "can it be a final class?", "author": "creamsoup", "createdAt": "2020-05-27T18:34:36Z", "path": "xds/src/main/java/io/grpc/xds/internal/sds/UpstreamTlsContextHolder.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Copyright 2020 The gRPC Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.grpc.xds.internal.sds;\n+\n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n+import io.envoyproxy.envoy.api.v2.auth.CommonTlsContext;\n+import io.envoyproxy.envoy.api.v2.auth.UpstreamTlsContext;\n+\n+class UpstreamTlsContextHolder implements TlsContextHolder {", "originalCommit": "b4764ca53ee0213c68ef151c3ef03e05d84325b5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM2MDU2Mg==", "url": "https://github.com/grpc/grpc-java/pull/7059#discussion_r431360562", "bodyText": "nit: move it before/after L37?", "author": "creamsoup", "createdAt": "2020-05-27T18:37:31Z", "path": "xds/src/main/java/io/grpc/xds/internal/sds/UpstreamTlsContextHolder.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Copyright 2020 The gRPC Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.grpc.xds.internal.sds;\n+\n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n+import io.envoyproxy.envoy.api.v2.auth.CommonTlsContext;\n+import io.envoyproxy.envoy.api.v2.auth.UpstreamTlsContext;\n+\n+class UpstreamTlsContextHolder implements TlsContextHolder {\n+\n+  public UpstreamTlsContext getUpstreamTlsContext() {", "originalCommit": "b4764ca53ee0213c68ef151c3ef03e05d84325b5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "91f08b1d112fca0b1fdf0be0c05f70228c84cdaa", "url": "https://github.com/grpc/grpc-java/commit/91f08b1d112fca0b1fdf0be0c05f70228c84cdaa", "message": "Update xds/src/main/java/io/grpc/xds/internal/sds/SslContextProvider.java\n\nCo-authored-by: Jihun Cho <jihuncho@google.com>", "committedDate": "2020-05-27T19:04:37Z", "type": "commit"}, {"oid": "b230ba7140e5e117b1059963f360a3caaa3269e9", "url": "https://github.com/grpc/grpc-java/commit/b230ba7140e5e117b1059963f360a3caaa3269e9", "message": "Update xds/src/main/java/io/grpc/xds/internal/sds/SslContextProvider.java\n\nCo-authored-by: Jihun Cho <jihuncho@google.com>", "committedDate": "2020-05-27T19:04:46Z", "type": "commit"}, {"oid": "9234a373fd4f13082867374179a4502419e712b6", "url": "https://github.com/grpc/grpc-java/commit/9234a373fd4f13082867374179a4502419e712b6", "message": "xds: minor cleanup2", "committedDate": "2020-05-27T19:14:30Z", "type": "commit"}]}