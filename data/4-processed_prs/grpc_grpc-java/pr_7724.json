{"pr_number": 7724, "pr_title": "Add exporting SSL/TLS master key log feature", "pr_createdAt": "2020-12-12T09:38:49Z", "pr_url": "https://github.com/grpc/grpc-java/pull/7724", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYwMzM3Ng==", "url": "https://github.com/grpc/grpc-java/pull/7724#discussion_r542603376", "bodyText": "These resets don't do anything, as the test is over. Remove them?", "author": "ejona86", "createdAt": "2020-12-14T18:18:30Z", "path": "netty/src/test/java/io/grpc/netty/ProtocolNegotiatorsTest.java", "diffHunk": "@@ -179,6 +195,10 @@ public void tearDown() {\n       chan.close();\n     }\n     group.shutdownGracefully();\n+\n+    Mockito.reset(mockLogger4KeyLog);", "originalCommit": "e4bf807750284aa297a8d3aaa568184c1b1418f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYwMzk2OA==", "url": "https://github.com/grpc/grpc-java/pull/7724#discussion_r542603968", "bodyText": "This should be part of the one test that actually uses it.", "author": "ejona86", "createdAt": "2020-12-14T18:19:16Z", "path": "netty/src/test/java/io/grpc/netty/ProtocolNegotiatorsTest.java", "diffHunk": "@@ -168,6 +179,11 @@ public void setUp() throws Exception {\n         .ciphers(TestUtils.preferredTestCiphers(), SupportedCipherSuiteFilter.INSTANCE).build();\n     engine = SSLContext.getDefault().createSSLEngine();\n     engine.setUseClientMode(true);\n+\n+    oldLoggerFactory = InternalLoggerFactory.getDefaultFactory();\n+    mockLogger4KeyLog = mock(InternalLogger.class);\n+    mockLogger4Others = mock(InternalLogger.class);\n+    InternalLoggerFactory.setDefaultFactory(new FakeLoggerFactory());", "originalCommit": "e4bf807750284aa297a8d3aaa568184c1b1418f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYwNTkyNQ==", "url": "https://github.com/grpc/grpc-java/pull/7724#discussion_r542605925", "bodyText": "Merge this mock initialization with the declaration on lines 170-171.", "author": "ejona86", "createdAt": "2020-12-14T18:21:03Z", "path": "netty/src/test/java/io/grpc/netty/ProtocolNegotiatorsTest.java", "diffHunk": "@@ -168,6 +179,11 @@ public void setUp() throws Exception {\n         .ciphers(TestUtils.preferredTestCiphers(), SupportedCipherSuiteFilter.INSTANCE).build();\n     engine = SSLContext.getDefault().createSSLEngine();\n     engine.setUseClientMode(true);\n+\n+    oldLoggerFactory = InternalLoggerFactory.getDefaultFactory();\n+    mockLogger4KeyLog = mock(InternalLogger.class);", "originalCommit": "e4bf807750284aa297a8d3aaa568184c1b1418f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYwNzk3Nw==", "url": "https://github.com/grpc/grpc-java/pull/7724#discussion_r542607977", "bodyText": "any(String.class). Ditto elsewhere.", "author": "ejona86", "createdAt": "2020-12-14T18:22:54Z", "path": "netty/src/test/java/io/grpc/netty/ProtocolNegotiatorsTest.java", "diffHunk": "@@ -1190,4 +1210,81 @@ public void handlerAdded(ChannelHandlerContext ctx) throws Exception {\n       ctx.pipeline().fireUserEventTriggered(ProtocolNegotiationEvent.DEFAULT);\n     }\n   }\n+\n+  @Test\n+  public void clientTlsHandler_serverTlsHandler_sslMasterKeyLog() throws Exception {\n+    // The master key log feature should be disabled\n+    // when the \"io.netty.ssl.masterKeyHandler\" property is missing.\n+    System.clearProperty(SslMasterKeyHandler.SYSTEM_PROP_KEY);\n+    clientTlsHandler_firesNegotiation();\n+    verify(mockLogger4KeyLog, never()).warn(argThat(new ArgumentMatcher<String>() {\n+      @Override\n+      public boolean matches(String arg) {\n+        return arg.contains(\" Master-Key:\");\n+      }\n+    }), argThat(new ArgumentMatcher<String>() {", "originalCommit": "e4bf807750284aa297a8d3aaa568184c1b1418f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjYwODc4MA==", "url": "https://github.com/grpc/grpc-java/pull/7724#discussion_r542608780", "bodyText": "ArgumentMatchers.contains(\" Master-Key:\"). Ditto elsewhere.", "author": "ejona86", "createdAt": "2020-12-14T18:23:39Z", "path": "netty/src/test/java/io/grpc/netty/ProtocolNegotiatorsTest.java", "diffHunk": "@@ -1190,4 +1210,81 @@ public void handlerAdded(ChannelHandlerContext ctx) throws Exception {\n       ctx.pipeline().fireUserEventTriggered(ProtocolNegotiationEvent.DEFAULT);\n     }\n   }\n+\n+  @Test\n+  public void clientTlsHandler_serverTlsHandler_sslMasterKeyLog() throws Exception {\n+    // The master key log feature should be disabled\n+    // when the \"io.netty.ssl.masterKeyHandler\" property is missing.\n+    System.clearProperty(SslMasterKeyHandler.SYSTEM_PROP_KEY);\n+    clientTlsHandler_firesNegotiation();\n+    verify(mockLogger4KeyLog, never()).warn(argThat(new ArgumentMatcher<String>() {", "originalCommit": "e4bf807750284aa297a8d3aaa568184c1b1418f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY5OTk4Nw==", "url": "https://github.com/grpc/grpc-java/pull/7724#discussion_r542699987", "bodyText": "Instead of returning this mockLogger4Others, how about the factory delegate to oldLoggerFactory?\nHonestly, even for mockLogger4KeyLog it'd probably be better to use AdditionalAnswers.delegatesTo() and delegate to a real instance. That gets you the recording capability of the mock while not needing to define Answers. Right now if the code under test did things like calling isWarnEnabled() it would be returned false and so may not log at all. That would fail one of the tests, but it is still good to back mocks with real objects for anything other than Listeners.", "author": "ejona86", "createdAt": "2020-12-14T19:44:45Z", "path": "netty/src/test/java/io/grpc/netty/ProtocolNegotiatorsTest.java", "diffHunk": "@@ -160,6 +167,10 @@ public static void loadCerts() throws Exception {\n   private SSLEngine engine;\n   private ChannelHandlerContext channelHandlerCtx;\n \n+  private InternalLogger mockLogger4KeyLog;\n+  private InternalLogger mockLogger4Others;", "originalCommit": "e4bf807750284aa297a8d3aaa568184c1b1418f5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6fd225cd3aa9035a865a9d46ddd1056bb600d7d0", "url": "https://github.com/grpc/grpc-java/commit/6fd225cd3aa9035a865a9d46ddd1056bb600d7d0", "message": "Add exporting SSL/TLS master key log feature\n\nEnable this feature by setting the system property\n   -Dio.netty.ssl.masterKeyHandler=true\nor\n   System.setProperty(SslMasterKeyHandler.SYSTEM_PROP_KEY, \"true\");\nThe keys will be written to the log named \"io.netty.wireshark\" in\nthe warnning level. To export the keys to a file, you can configure\nlog factory like: (with log4j.xml for example)\n<appender name=\"key-file\" class=\"org.apache.log4j.RollingFileAppender\">\n\t<param name=\"file\" value=\"d:/keyfile.txt\"/>\n\t<layout class=\"org.apache.log4j.PatternLayout\">\n\t\t<param name=\"ConversionPattern\" value=\"%m%n\"/>\n\t</layout>\n</appender>\n<category name=\"io.netty.wireshark\">\n\t<priority value=\"DEBUG\" />\n\t<appender-ref ref=\"key-file\" />\n</category>\n\nWireshark can analyze the messages gRPC over TLS with this\nkey log file.\n\nclose #7199", "committedDate": "2020-12-15T11:28:41Z", "type": "commit"}, {"oid": "6fd225cd3aa9035a865a9d46ddd1056bb600d7d0", "url": "https://github.com/grpc/grpc-java/commit/6fd225cd3aa9035a865a9d46ddd1056bb600d7d0", "message": "Add exporting SSL/TLS master key log feature\n\nEnable this feature by setting the system property\n   -Dio.netty.ssl.masterKeyHandler=true\nor\n   System.setProperty(SslMasterKeyHandler.SYSTEM_PROP_KEY, \"true\");\nThe keys will be written to the log named \"io.netty.wireshark\" in\nthe warnning level. To export the keys to a file, you can configure\nlog factory like: (with log4j.xml for example)\n<appender name=\"key-file\" class=\"org.apache.log4j.RollingFileAppender\">\n\t<param name=\"file\" value=\"d:/keyfile.txt\"/>\n\t<layout class=\"org.apache.log4j.PatternLayout\">\n\t\t<param name=\"ConversionPattern\" value=\"%m%n\"/>\n\t</layout>\n</appender>\n<category name=\"io.netty.wireshark\">\n\t<priority value=\"DEBUG\" />\n\t<appender-ref ref=\"key-file\" />\n</category>\n\nWireshark can analyze the messages gRPC over TLS with this\nkey log file.\n\nclose #7199", "committedDate": "2020-12-15T11:28:41Z", "type": "forcePushed"}]}