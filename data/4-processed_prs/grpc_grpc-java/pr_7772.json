{"pr_number": 7772, "pr_title": "xds: fix LB policy address and balancing state update propagations", "pr_createdAt": "2020-12-30T22:45:32Z", "pr_url": "https://github.com/grpc/grpc-java/pull/7772", "timeline": [{"oid": "2188552cb24588662547979d8b3b442cade0cd1c", "url": "https://github.com/grpc/grpc-java/commit/2188552cb24588662547979d8b3b442cade0cd1c", "message": "cluster_manager LB policy: Do not delay propagation of address update to child LB policies, but instead delay balancing state update upcalls.", "committedDate": "2020-12-30T22:40:33Z", "type": "commit"}, {"oid": "b3fe536c021ec6a53853a2da83d3d4ea1ad1dcf5", "url": "https://github.com/grpc/grpc-java/commit/b3fe536c021ec6a53853a2da83d3d4ea1ad1dcf5", "message": "priority_lb: Propagate address update to child LB policies directly, delay balancing state update upcall instead.", "committedDate": "2020-12-30T22:42:02Z", "type": "commit"}, {"oid": "85e8d6648e125758fb7362e0d1cad0cfcffea029", "url": "https://github.com/grpc/grpc-java/commit/85e8d6648e125758fb7362e0d1cad0cfcffea029", "message": "weighted_target LB policy: Propagate address update to child LB policies directly, delay balancing state update upcall instead. Always return a picker and the latest balancing state when receiving new address updates.", "committedDate": "2020-12-30T22:44:08Z", "type": "commit"}, {"oid": "da1212291e229228df278dd8b004b216cb5f0667", "url": "https://github.com/grpc/grpc-java/commit/da1212291e229228df278dd8b004b216cb5f0667", "message": "Fix test breakage in cluster_impl LB policy, which instantiates real weighted_target LB instances.", "committedDate": "2020-12-30T22:44:42Z", "type": "commit"}, {"oid": "e3bf724f1bde09c1e441000517bb4f08ecf18150", "url": "https://github.com/grpc/grpc-java/commit/e3bf724f1bde09c1e441000517bb4f08ecf18150", "message": "Revert the change that refactors cluster_manager LB policy's test. It's irrelavant to the fix.", "committedDate": "2020-12-30T22:49:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjg0MzE0MQ==", "url": "https://github.com/grpc/grpc-java/pull/7772#discussion_r552843141", "bodyText": "I would enqueue connectivityState = newState; picker = newPicker together with tryNextPriority(). The state update should be \"atomic\". Same for other balancers.", "author": "dapengzhang0", "createdAt": "2021-01-06T17:36:28Z", "path": "xds/src/main/java/io/grpc/xds/PriorityLoadBalancer.java", "diffHunk": "@@ -287,7 +280,12 @@ public void updateBalancingState(ConnectivityState newState, SubchannelPicker ne\n             failOverTimer.cancel();\n           }\n         }\n-        tryNextPriority(true);\n+        syncContext.execute(new Runnable() {", "originalCommit": "e3bf724f1bde09c1e441000517bb4f08ecf18150", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk2NTc0OQ==", "url": "https://github.com/grpc/grpc-java/pull/7772#discussion_r552965749", "bodyText": "Fixed.", "author": "voidzcy", "createdAt": "2021-01-06T21:18:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjg0MzE0MQ=="}], "type": "inlineReview"}, {"oid": "d1b511243c822d7dab6ef5f8b9cfdc6aeda82a3a", "url": "https://github.com/grpc/grpc-java/commit/d1b511243c822d7dab6ef5f8b9cfdc6aeda82a3a", "message": "Make balancing state local update and propagation atomic.", "committedDate": "2021-01-06T21:17:53Z", "type": "commit"}]}