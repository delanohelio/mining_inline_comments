{"pr_number": 7096, "pr_title": "xds: retain locality stats counter when the child balancer for that locality is deactivated", "pr_createdAt": "2020-06-05T18:37:48Z", "pr_url": "https://github.com/grpc/grpc-java/pull/7096", "timeline": [{"oid": "b7681aa56ca544ca971faf8447058c3317b02b57", "url": "https://github.com/grpc/grpc-java/commit/b7681aa56ca544ca971faf8447058c3317b02b57", "message": "Create the counter for recording per locality stats upon creating the child balancer for that locality. Delete it when the child balancer for that locality is shutted down. This change also refactored class organizations in LocalityStore.", "committedDate": "2020-06-05T18:26:37Z", "type": "commit"}, {"oid": "c9f142bb206cfb40756e6615f21cd489ba3b9921", "url": "https://github.com/grpc/grpc-java/commit/c9f142bb206cfb40756e6615f21cd489ba3b9921", "message": "Removed unused field.", "committedDate": "2020-06-05T18:47:22Z", "type": "forcePushed"}, {"oid": "1802e4e73a725a40f2296fe3b9c63824d58b7719", "url": "https://github.com/grpc/grpc-java/commit/1802e4e73a725a40f2296fe3b9c63824d58b7719", "message": "Removed unused field.", "committedDate": "2020-06-05T18:59:03Z", "type": "commit"}, {"oid": "1802e4e73a725a40f2296fe3b9c63824d58b7719", "url": "https://github.com/grpc/grpc-java/commit/1802e4e73a725a40f2296fe3b9c63824d58b7719", "message": "Removed unused field.", "committedDate": "2020-06-05T18:59:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE4MDI2OQ==", "url": "https://github.com/grpc/grpc-java/pull/7096#discussion_r436180269", "bodyText": "BTW, this was also a bug. You should pass in the  ChildHelper instance of the LocalityLbInfo instead of just helper. It's lucky that ChildHelper's SynchronizationContext is just a delegation to helper's, so it did not cause problem. But this is wrong.\nArgument-passing, object ownership, lifecycle, etc. A lot of things in LocalityStore are messy. I hate this class, really. It might still contain unnoticed bug. Hope we can refactor to the LB structure and get rid of this early.", "author": "voidzcy", "createdAt": "2020-06-05T21:52:26Z", "path": "xds/src/main/java/io/grpc/xds/LocalityStore.java", "diffHunk": "@@ -202,56 +198,20 @@ public void reset() {\n         localityMap.get(locality).shutdown();\n       }\n       localityMap.clear();\n-\n-      for (Locality locality : localities) {\n-        loadStatsStore.removeLocality(locality);\n-      }\n-      localities = ImmutableSet.of();\n-\n       priorityManager.reset();\n     }\n \n     @Override\n     public void updateLocalityStore(final Map<Locality, LocalityLbEndpoints> localityInfoMap) {\n-\n       Set<Locality> newLocalities = localityInfoMap.keySet();\n       // TODO: put endPointWeights into attributes for WRR.\n       for (Locality locality : newLocalities) {\n         if (localityMap.containsKey(locality)) {\n-          LocalityLbInfo localityLbInfo = localityMap.get(locality);\n-          LocalityLbEndpoints localityLbEndpoints = localityInfoMap.get(locality);\n-          handleEagsOnChildBalancer(helper, localityLbInfo, localityLbEndpoints, locality);", "originalCommit": "1802e4e73a725a40f2296fe3b9c63824d58b7719", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE4Njk0MQ==", "url": "https://github.com/grpc/grpc-java/pull/7096#discussion_r436186941", "bodyText": "It should not pass any helper now. It should pass a SynchronizationContext. Helper's SynchronizationContext should guarantee it works properly with load balancer's synchronization.", "author": "dapengzhang0", "createdAt": "2020-06-05T22:10:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE4MDI2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE4NzU0OQ==", "url": "https://github.com/grpc/grpc-java/pull/7096#discussion_r436187549", "bodyText": "A lot of argument-passing, object ownership, lifecycle issues are messed up by load stats. Spec of both EDS and load reporting are constantly changing, it's just unfortunate.", "author": "dapengzhang0", "createdAt": "2020-06-05T22:12:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE4MDI2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE5Mzg5NA==", "url": "https://github.com/grpc/grpc-java/pull/7096#discussion_r436193894", "bodyText": "It should not pass any helper now. It should pass a SynchronizationContext. Helper's SynchronizationContext should guarantee it works properly with load balancer's synchronization.\n\nI refactored it to not do that.\nThings were just working fortunately correct. But the idea and the way it was coded is wrong.", "author": "voidzcy", "createdAt": "2020-06-05T22:35:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE4MDI2OQ=="}], "type": "inlineReview"}, {"oid": "ad31d85b3dfb3b7c5fff75d0c5d99aaf68588d22", "url": "https://github.com/grpc/grpc-java/commit/ad31d85b3dfb3b7c5fff75d0c5d99aaf68588d22", "message": "Revert class name change.", "committedDate": "2020-06-06T00:34:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIyMDUzMw==", "url": "https://github.com/grpc/grpc-java/pull/7096#discussion_r436220533", "bodyText": "nit: All diffs except these 5 lines in ChildHelper class are unrelated.", "author": "dapengzhang0", "createdAt": "2020-06-06T00:47:35Z", "path": "xds/src/main/java/io/grpc/xds/LocalityStore.java", "diffHunk": "@@ -375,73 +361,62 @@ void reactivate() {\n       boolean isDeactivated() {\n         return delayedDeletionTimer != null;\n       }\n-    }\n-\n-    class ChildHelper extends ForwardingLoadBalancerHelper {\n \n-      private final OrcaReportingHelperWrapper orcaReportingHelperWrapper;\n+      class ChildHelper extends ForwardingLoadBalancerHelper {\n \n-      private SubchannelPicker currentChildPicker = XdsSubchannelPickers.BUFFER_PICKER;\n-      private ConnectivityState currentChildState = CONNECTING;\n+        private final OrcaReportingHelperWrapper orcaReportingHelperWrapper;\n+        private SubchannelPicker currentChildPicker = XdsSubchannelPickers.BUFFER_PICKER;\n+        private ConnectivityState currentChildState = CONNECTING;\n \n-      ChildHelper(final Locality locality, final ClientLoadCounter counter,\n-          OrcaOobUtil orcaOobUtil) {\n-        checkNotNull(locality, \"locality\");\n-        checkNotNull(counter, \"counter\");\n-        checkNotNull(orcaOobUtil, \"orcaOobUtil\");", "originalCommit": "ad31d85b3dfb3b7c5fff75d0c5d99aaf68588d22", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIyMTAwMQ==", "url": "https://github.com/grpc/grpc-java/pull/7096#discussion_r436221001", "bodyText": "Now ChildHelper is an inner class of LocalityLbInfo, these fields no longer need to be passed in. Can just directly access, without confusion of which instance they are referring to.", "author": "voidzcy", "createdAt": "2020-06-06T00:51:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIyMDUzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIyNDEzMA==", "url": "https://github.com/grpc/grpc-java/pull/7096#discussion_r436224130", "bodyText": "I mean diffs other than these line.", "author": "dapengzhang0", "createdAt": "2020-06-06T01:19:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIyMDUzMw=="}], "type": "inlineReview"}]}