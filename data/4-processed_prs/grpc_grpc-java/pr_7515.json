{"pr_number": 7515, "pr_title": "xds: implement the temporary xDS creds+fallback API", "pr_createdAt": "2020-10-13T16:06:40Z", "pr_url": "https://github.com/grpc/grpc-java/pull/7515", "timeline": [{"oid": "fabd39e8a1fcec7b86a1dfa638412919dd2a8d17", "url": "https://github.com/grpc/grpc-java/commit/fabd39e8a1fcec7b86a1dfa638412919dd2a8d17", "message": "xds: implement the temporary xDS creds+fallback API", "committedDate": "2020-10-13T16:03:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA4Mjg0NA==", "url": "https://github.com/grpc/grpc-java/pull/7515#discussion_r504082844", "bodyText": "Now, that I'm looking at the code, I think the environment variable isn't entirely necessary here, since the user already has to opt-in via an API. If we were silently enabling code paths based on I/O, that could be a problem, which might be a bigger concern in places like XdsClient. You probably don't even need setXdsSecurity(), as the useXdsSecurityWithPlaintextFallback() call itself is opting in.", "author": "ejona86", "createdAt": "2020-10-13T16:16:23Z", "path": "xds/src/main/java/io/grpc/xds/internal/sds/XdsServerBuilder.java", "diffHunk": "@@ -29,20 +32,29 @@\n import io.grpc.ServerTransportFilter;\n import io.grpc.Status;\n import io.grpc.netty.InternalProtocolNegotiator.ProtocolNegotiator;\n+import io.grpc.netty.InternalProtocolNegotiators;\n import io.grpc.netty.NettyServerBuilder;\n+import io.grpc.xds.XdsClientWrapperForServerSds;\n import io.grpc.xds.internal.sds.SdsProtocolNegotiators.ServerSdsProtocolNegotiator;\n+import io.netty.handler.ssl.SslContext;\n+import io.netty.handler.ssl.SslContextBuilder;\n import java.io.File;\n+import java.io.InputStream;\n import java.net.InetSocketAddress;\n import java.util.concurrent.Executor;\n import java.util.concurrent.TimeUnit;\n import javax.annotation.Nullable;\n+import javax.net.ssl.SSLException;\n \n /**\n  * A version of {@link ServerBuilder} to create xDS managed servers that will use SDS to set up SSL\n  * with peers. Note, this is not ready to use yet.\n  */\n public final class XdsServerBuilder extends ServerBuilder<XdsServerBuilder> {\n \n+  private static final String XDS_SECURITY_ENV_VAR = \"GRPC_XDS_EXPERIMENTAL_SECURITY_SUPPORT\";", "originalCommit": "fabd39e8a1fcec7b86a1dfa638412919dd2a8d17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEzMDgxNw==", "url": "https://github.com/grpc/grpc-java/pull/7515#discussion_r504130817", "bodyText": "In that case I will remove both the env var and the boolean (in effect the isXdsSecurityEnabled() method) after I make sure we are not inadvertently enabling some xds/sds related code paths when xDS security is not in force.", "author": "sanjaypujare", "createdAt": "2020-10-13T17:23:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA4Mjg0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA4NjE1Nw==", "url": "https://github.com/grpc/grpc-java/pull/7515#discussion_r504086157", "bodyText": "Make it clear this is experimental functionality that is not ready for wide usage. It is clearly an experimental API, but that doesn't make it clear if the code is ready to be widely used.", "author": "ejona86", "createdAt": "2020-10-13T16:20:52Z", "path": "xds/src/main/java/io/grpc/xds/internal/sds/XdsServerBuilder.java", "diffHunk": "@@ -103,7 +126,52 @@ public XdsServerBuilder fallbackHandlerRegistry(@Nullable HandlerRegistry fallba\n \n   @Override\n   public XdsServerBuilder useTransportSecurity(File certChain, File privateKey) {\n-    throw new UnsupportedOperationException(\"Cannot set security parameters on XdsServerBuilder\");\n+    delegate.useTransportSecurity(certChain, privateKey);\n+    return this;\n+  }\n+\n+  @Override\n+  public XdsServerBuilder useTransportSecurity(InputStream certChain, InputStream privateKey) {\n+    delegate.useTransportSecurity(certChain, privateKey);\n+    return this;\n+  }\n+\n+  /** Use xDS provided security with plaintext as fallback. */", "originalCommit": "fabd39e8a1fcec7b86a1dfa638412919dd2a8d17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEzMTAxNw==", "url": "https://github.com/grpc/grpc-java/pull/7515#discussion_r504131017", "bodyText": "SG. will do", "author": "sanjaypujare", "createdAt": "2020-10-13T17:24:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA4NjE1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcyOTg2Ng==", "url": "https://github.com/grpc/grpc-java/pull/7515#discussion_r504729866", "bodyText": "I was not talking about the API. I was talking about the implementation. The implementation itself is experimental/not stable.", "author": "ejona86", "createdAt": "2020-10-14T14:35:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA4NjE1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc5NjU2NQ==", "url": "https://github.com/grpc/grpc-java/pull/7515#discussion_r504796565", "bodyText": "Oh okay. I will change the wording and make a new PR. I thought the idea was to mention that the useXdsSecurityWith* methods are experimental/temporary. The new wording will be:\n\"Note, this experimental functionality is not ready for wide usage.\"", "author": "sanjaypujare", "createdAt": "2020-10-14T16:02:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA4NjE1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc5ODg1MQ==", "url": "https://github.com/grpc/grpc-java/pull/7515#discussion_r504798851", "bodyText": "SGTM", "author": "ejona86", "createdAt": "2020-10-14T16:06:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA4NjE1Nw=="}], "type": "inlineReview"}, {"oid": "97cbf4d5373d85a97e613f5ed4002fb0a95e014a", "url": "https://github.com/grpc/grpc-java/commit/97cbf4d5373d85a97e613f5ed4002fb0a95e014a", "message": "address review comments", "committedDate": "2020-10-14T04:50:32Z", "type": "commit"}]}