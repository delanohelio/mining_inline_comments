{"pr_number": 7441, "pr_title": "xds: log raw response messages in sync context", "pr_createdAt": "2020-09-18T22:38:01Z", "pr_url": "https://github.com/grpc/grpc-java/pull/7441", "timeline": [{"oid": "73f83753ecdf107379abd8c9526d6bb6cd614285", "url": "https://github.com/grpc/grpc-java/commit/73f83753ecdf107379abd8c9526d6bb6cd614285", "message": "Logging LRS raw response should be together (run by the same thread) withlogging the parsed data.", "committedDate": "2020-09-18T22:26:39Z", "type": "commit"}, {"oid": "35b3ce2943519a3fd053ccc5e0ab4322d75cef79", "url": "https://github.com/grpc/grpc-java/commit/35b3ce2943519a3fd053ccc5e0ab4322d75cef79", "message": "Logging xDS response should be together (run by the same thread) with logging the parsed data.", "committedDate": "2020-09-18T22:26:46Z", "type": "commit"}, {"oid": "0913171088615b933fa23cbf9656fb976f7e7dcc", "url": "https://github.com/grpc/grpc-java/commit/0913171088615b933fa23cbf9656fb976f7e7dcc", "message": "Use implementation types for debug log messages.", "committedDate": "2020-09-18T22:31:05Z", "type": "commit"}, {"oid": "b2d4c907de27afb6160fad037334253fc1be4563", "url": "https://github.com/grpc/grpc-java/commit/b2d4c907de27afb6160fad037334253fc1be4563", "message": "Improve method names.", "committedDate": "2020-09-18T22:33:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTIzOTM1Mg==", "url": "https://github.com/grpc/grpc-java/pull/7441#discussion_r491239352", "bodyText": "Why change the logging message?", "author": "dapengzhang0", "createdAt": "2020-09-18T23:57:53Z", "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -1737,27 +1723,40 @@ void start() {\n       StreamObserver<io.envoyproxy.envoy.api.v2.DiscoveryResponse> responseReaderV2 =\n           new StreamObserver<io.envoyproxy.envoy.api.v2.DiscoveryResponse>() {\n             @Override\n-            public void onNext(io.envoyproxy.envoy.api.v2.DiscoveryResponse response) {\n-              DiscoveryResponseData responseData =\n-                  DiscoveryResponseData.fromEnvoyProtoV2(response);\n-              if (logger.isLoggable(XdsLogLevel.DEBUG)) {\n-                logger.log(\n-                    XdsLogLevel.DEBUG,\n-                    \"Received {0} response:\\n{1}\",\n-                    responseData.getResourceType(),\n-                    respPrinter.print(response));\n-              }\n-              onDiscoveryResponse(responseData);\n+            public void onNext(final io.envoyproxy.envoy.api.v2.DiscoveryResponse response) {\n+              syncContext.execute(new Runnable() {\n+                @Override\n+                public void run() {\n+                  if (logger.isLoggable(XdsLogLevel.DEBUG)) {\n+                    logger.log(\n+                        XdsLogLevel.DEBUG,\n+                        \"Received DiscoveryResponse:\\n{0}\", respPrinter.print(response));", "originalCommit": "b2d4c907de27afb6160fad037334253fc1be4563", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTI0MDYwNw==", "url": "https://github.com/grpc/grpc-java/pull/7441#discussion_r491240607", "bodyText": "Well, it's a small cosmetic change. Two reasons:\n\nMake this logging the first operation to be run in the handler, without needing information from parsed data. This seems a bit more elegant?\nJust log out the implementation types for DEBUG logs, indicating the content being logged is the actual code.", "author": "voidzcy", "createdAt": "2020-09-19T00:06:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTIzOTM1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTI0NTM2NA==", "url": "https://github.com/grpc/grpc-java/pull/7441#discussion_r491245364", "bodyText": "You can still add resource type information, which is more user-friendly\nResourceType.fromTypeUrl(response.getTypeUrl())", "author": "dapengzhang0", "createdAt": "2020-09-19T00:39:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTIzOTM1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTI0NTczMw==", "url": "https://github.com/grpc/grpc-java/pull/7441#discussion_r491245733", "bodyText": "That's a long URL, not good. Also, the raw response already contains everything, so not bother do anything excessive.", "author": "voidzcy", "createdAt": "2020-09-19T00:41:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTIzOTM1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTI0NjA2Mg==", "url": "https://github.com/grpc/grpc-java/pull/7441#discussion_r491246062", "bodyText": "That's a long URL\n\nIt's converted to type enum.\n\nthe raw response already contains everything,\n\nThat's long URL, it's hard to eyeball the type quickly.", "author": "dapengzhang0", "createdAt": "2020-09-19T00:44:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTIzOTM1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTI0NzA2Ng==", "url": "https://github.com/grpc/grpc-java/pull/7441#discussion_r491247066", "bodyText": "It's converted to type enum.\n\nOh you mean converted parsed data. But as I said, it's better to just log everything raw.\n\nThat's long URL, it's hard to eyeball the type quickly.\n\nActually it works pretty good from my experience, as people usually care more about Listener/RouteConfiguration/Cluster/ClusterLoadAssignment rather than xDS. IMO, it's better not to add anything excessive to raw data logs.", "author": "voidzcy", "createdAt": "2020-09-19T00:53:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTIzOTM1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTI0ODUxNA==", "url": "https://github.com/grpc/grpc-java/pull/7441#discussion_r491248514", "bodyText": "Also, those are DEBUG level logs, they are intended to be read carefully when enabled for debugging, instead of quick eyeballing for what happens.", "author": "voidzcy", "createdAt": "2020-09-19T01:06:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTIzOTM1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTI1MTk3Nw==", "url": "https://github.com/grpc/grpc-java/pull/7441#discussion_r491251977", "bodyText": "Oh you mean converted parsed data. But as I said, it's better to just log everything raw.\n\nNot the parsed data, ResourceType.fromTypeUrl(response.getTypeUrl()) is the raw data.", "author": "dapengzhang0", "createdAt": "2020-09-19T01:29:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTIzOTM1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTI1MjM2Nw==", "url": "https://github.com/grpc/grpc-java/pull/7441#discussion_r491252367", "bodyText": "Why do you want to decorate the raw data? Keeping the plain data is concise.", "author": "voidzcy", "createdAt": "2020-09-19T01:33:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTIzOTM1Mg=="}], "type": "inlineReview"}, {"oid": "c6d30f15cb009f9ab9b2d381f2c931107546f3d7", "url": "https://github.com/grpc/grpc-java/commit/c6d30f15cb009f9ab9b2d381f2c931107546f3d7", "message": "Format log messages.", "committedDate": "2020-09-22T23:44:06Z", "type": "commit"}]}