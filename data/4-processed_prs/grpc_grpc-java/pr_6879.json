{"pr_number": 6879, "pr_title": "xds: migrating XdsNameResolver to \"xds\" scheme", "pr_createdAt": "2020-03-31T22:11:23Z", "pr_url": "https://github.com/grpc/grpc-java/pull/6879", "timeline": [{"oid": "f107ed894e85e2dca73307e3894782ad6341f705", "url": "https://github.com/grpc/grpc-java/commit/f107ed894e85e2dca73307e3894782ad6341f705", "message": "xds: migrating XdsNameResolver to \"xds\" scheme", "committedDate": "2020-03-31T22:10:06Z", "type": "commit"}, {"oid": "7c4020daa705c4025cc33aeb2a1a5192ee955364", "url": "https://github.com/grpc/grpc-java/commit/7c4020daa705c4025cc33aeb2a1a5192ee955364", "message": "complete copy of XdsNameResolverProvider", "committedDate": "2020-03-31T22:50:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM3Mzc2MA==", "url": "https://github.com/grpc/grpc-java/pull/6879#discussion_r403373760", "bodyText": "nit: final.", "author": "voidzcy", "createdAt": "2020-04-03T22:53:48Z", "path": "xds/src/main/java/io/grpc/xds/XdsExperimentalNameResolverProvider.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 The gRPC Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.grpc.xds;\n+\n+import com.google.common.base.Preconditions;\n+import io.grpc.Internal;\n+import io.grpc.NameResolver;\n+import io.grpc.NameResolver.Args;\n+import io.grpc.NameResolverProvider;\n+import io.grpc.internal.ExponentialBackoffPolicy;\n+import io.grpc.internal.GrpcUtil;\n+import io.grpc.xds.XdsClient.XdsChannelFactory;\n+import java.net.URI;\n+\n+/** A deprecated provider for {@link XdsNameResolver}. */\n+// TODO(zdapeng): remove this class once it's not needed for interop testing.\n+@Deprecated\n+@Internal\n+public class XdsExperimentalNameResolverProvider extends NameResolverProvider {", "originalCommit": "7c4020daa705c4025cc33aeb2a1a5192ee955364", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2e28674cedac1de4844cb62d806ea6e1100d101f", "url": "https://github.com/grpc/grpc-java/commit/2e28674cedac1de4844cb62d806ea6e1100d101f", "message": "final", "committedDate": "2020-04-07T00:06:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ2NDY1OA==", "url": "https://github.com/grpc/grpc-java/pull/6879#discussion_r404464658", "bodyText": "No tests will verify that xds-experimental still works?", "author": "ericgribkoff", "createdAt": "2020-04-07T00:19:44Z", "path": "xds/src/test/java/io/grpc/xds/XdsNameResolverProviderTest.java", "diffHunk": "@@ -91,22 +91,22 @@ public void newNameResolver() {\n   public void validName_withAuthority() {\n     XdsNameResolver resolver =\n         provider.newNameResolver(\n-            URI.create(\"xds-experimental://trafficdirector.google.com/foo.googleapis.com\"), args);\n+            URI.create(\"xds://trafficdirector.google.com/foo.googleapis.com\"), args);\n     assertThat(resolver).isNotNull();\n     assertThat(resolver.getServiceAuthority()).isEqualTo(\"foo.googleapis.com\");\n   }\n \n   @Test\n   public void validName_noAuthority() {\n     XdsNameResolver resolver =\n-        provider.newNameResolver(URI.create(\"xds-experimental:///foo.googleapis.com\"), args);\n+        provider.newNameResolver(URI.create(\"xds:///foo.googleapis.com\"), args);\n     assertThat(resolver).isNotNull();\n     assertThat(resolver.getServiceAuthority()).isEqualTo(\"foo.googleapis.com\");\n   }\n \n   @Test\n   public void invalidName_hostnameContainsUnderscore() {\n-    URI uri = URI.create(\"xds-experimental:///foo_bar.googleapis.com\");\n+    URI uri = URI.create(\"xds:///foo_bar.googleapis.com\");", "originalCommit": "2e28674cedac1de4844cb62d806ea6e1100d101f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ2NzU0OA==", "url": "https://github.com/grpc/grpc-java/pull/6879#discussion_r404467548", "bodyText": "We can copy the test class as well. @ericgribkoff The interop test is testing explicitly with xds-experimental right?", "author": "dapengzhang0", "createdAt": "2020-04-07T00:29:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ2NDY1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ3MDMwMg==", "url": "https://github.com/grpc/grpc-java/pull/6879#discussion_r404470302", "bodyText": "Not sure it's worth copying the whole test class. Was thinking about that one test here could verify that the xds-experimental provider at least exists but I guess that might be awkward to reference XdsExperimentalNameResolverProviderTest.java since this is XdsNameResolverProviderTest.\nYes, the interop testing is explicitly using xds-experimental for now. But we could actually switch it in this PR on master: the scheme is specified in https://github.com/grpc/grpc-java/blob/master/buildscripts/kokoro/xds.sh.\nAre we really only keeping around xds-experimental for interop testing and plan to have it fully removed in the next release? Or will there be some overlap period where users can specify xds or xds-experimental?", "author": "ericgribkoff", "createdAt": "2020-04-07T00:39:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ2NDY1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ3MTM0NA==", "url": "https://github.com/grpc/grpc-java/pull/6879#discussion_r404471344", "bodyText": "Not sure it's worth copying the whole test class.\n\nCopying is simple and it's super easy to remove when it's ready to.", "author": "dapengzhang0", "createdAt": "2020-04-07T00:43:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ2NDY1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ3MzExMg==", "url": "https://github.com/grpc/grpc-java/pull/6879#discussion_r404473112", "bodyText": "I guess we can directly do the swap. The scheme is sort of arbitrary and the only impact is the resolver being loaded in gRPC client. Seems no value to do a transition period.", "author": "voidzcy", "createdAt": "2020-04-07T00:49:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ2NDY1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ3MzI0Mw==", "url": "https://github.com/grpc/grpc-java/pull/6879#discussion_r404473243", "bodyText": "Yes, the interop testing is explicitly using xds-experimental for now. But we could actually switch it in this PR on master: the scheme is specified in https://github.com/grpc/grpc-java/blob/master/buildscripts/kokoro/xds.sh\n\nI thought the scheme xds-experimental is specified in some other repo than grpc-java. Will change it in https://github.com/grpc/grpc-java/blob/master/buildscripts/kokoro/xds.sh as well.\n\nAre we really only keeping around xds-experimental for interop testing and plan to have it fully removed in the next release? Or will there be some overlap period where users can specify xds or xds-experimental?\n\nI don't know. @srini100 Do we want to keep the 'xds-experimental' scheme working for our customers who are testing against master or next releases (1.29, 1.30) for a while?", "author": "dapengzhang0", "createdAt": "2020-04-07T00:49:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ2NDY1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ3NDE2OQ==", "url": "https://github.com/grpc/grpc-java/pull/6879#discussion_r404474169", "bodyText": "@ericgribkoff Does changing https://github.com/grpc/grpc-java/blob/master/buildscripts/kokoro/xds.sh with 'xds' scheme affect other languages? I mean is there java server against go client and vice versa?\nEdit: never mind, I see the command line with the scheme is only for the java binary. So it does not affect cross-language tests.", "author": "dapengzhang0", "createdAt": "2020-04-07T00:53:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ2NDY1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDUwNjkwNQ==", "url": "https://github.com/grpc/grpc-java/pull/6879#discussion_r404506905", "bodyText": "We talked about keeping xds-experimental for at least one more release (1.29.0) and remove it in 1.30.0. This should be same across other langs so discuss with other lang owners too.", "author": "srini100", "createdAt": "2020-04-07T02:57:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ2NDY1OA=="}], "type": "inlineReview"}, {"oid": "1669b508230fe5973ea92de5fb021c3446ef485a", "url": "https://github.com/grpc/grpc-java/commit/1669b508230fe5973ea92de5fb021c3446ef485a", "message": "copy unit test", "committedDate": "2020-04-07T00:40:22Z", "type": "commit"}, {"oid": "98a182351d0a85b886b2bc9d9122d8ef0ee84e7d", "url": "https://github.com/grpc/grpc-java/commit/98a182351d0a85b886b2bc9d9122d8ef0ee84e7d", "message": "update xds.sh", "committedDate": "2020-04-07T01:01:55Z", "type": "commit"}]}