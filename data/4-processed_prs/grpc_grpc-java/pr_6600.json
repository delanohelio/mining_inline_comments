{"pr_number": 6600, "pr_title": "core: fix bugs in service config error handling", "pr_createdAt": "2020-01-14T01:37:44Z", "pr_url": "https://github.com/grpc/grpc-java/pull/6600", "timeline": [{"oid": "ccc793831f6c236bed89faeb2a347b6aab5baaab", "url": "https://github.com/grpc/grpc-java/commit/ccc793831f6c236bed89faeb2a347b6aab5baaab", "message": "core: fix service config error handling\n\n1. Allow legacy way to pass service config via attributes\n2. fix AutoConfiguredLBFactory may populate ConfigOrError instead of\nactual config.", "committedDate": "2020-01-14T01:33:29Z", "type": "commit"}, {"oid": "8afd89b00e1247851d1e48ca417b5788131acd15", "url": "https://github.com/grpc/grpc-java/commit/8afd89b00e1247851d1e48ca417b5788131acd15", "message": "add a test case for testinlg service config only in attribute", "committedDate": "2020-01-17T19:03:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE2MTkwMQ==", "url": "https://github.com/grpc/grpc-java/pull/6600#discussion_r368161901", "bodyText": "Looks like there isn't a case where selection.config is an error. We may just change PolicySelection.config from ConfigOrError to Object.", "author": "zhangkun83", "createdAt": "2020-01-17T22:26:14Z", "path": "core/src/main/java/io/grpc/internal/AutoConfiguredLoadBalancerFactory2.java", "diffHunk": "@@ -167,7 +167,7 @@ Status tryHandleResolvedAddresses(ResolvedAddresses resolvedAddresses) {\n             ResolvedAddresses.newBuilder()\n                 .setAddresses(resolvedSelection.serverList)\n                 .setAttributes(attributes)\n-                .setLoadBalancingPolicyConfig(lbConfig)\n+                .setLoadBalancingPolicyConfig(lbConfig != null ? lbConfig.getConfig() : null)", "originalCommit": "8afd89b00e1247851d1e48ca417b5788131acd15", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE2NDczOA==", "url": "https://github.com/grpc/grpc-java/pull/6600#discussion_r368164738", "bodyText": "I think the original code is correct.\nFor a LoadBalancer that's still on the old service config path, it won't override LoadBalancerProvider.parseLoadBalancingPolicyConfig, thus configOrError would be LoadBalancerProvider.UNKNOWN_CONFIG, which is non-null, thus NAME_RESOLVER_SERVICE_CONFIG will get populated. We shouldn't call parseServiceConfig again.", "author": "zhangkun83", "createdAt": "2020-01-17T22:37:09Z", "path": "core/src/main/java/io/grpc/internal/ManagedChannelImpl2.java", "diffHunk": "@@ -1332,9 +1333,13 @@ public void run() {\n           ConfigOrError configOrError = resolutionResult.getServiceConfig();\n           ServiceConfigHolder validServiceConfig = null;\n           Status serviceConfigError = null;\n+          Map<String, ?> rawServiceConfig =\n+              resolutionResult.getAttributes().get(GrpcAttributes.NAME_RESOLVER_SERVICE_CONFIG);\n+          if (configOrError == null && rawServiceConfig != null) {\n+            // use service config json in deprecated attributes\n+            configOrError = serviceConfigParser.parseServiceConfig(rawServiceConfig);\n+          }\n           if (configOrError != null) {", "originalCommit": "8afd89b00e1247851d1e48ca417b5788131acd15", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE5MDY3Nw==", "url": "https://github.com/grpc/grpc-java/pull/6600#discussion_r368190677", "bodyText": "Some 1st/3rd party name resolver might not use the serviceConfig field which can be ignored in current implementation even if the deprecated Attribute is set.\nLoadBalancerProvider.UNKNOWN_CONFIG is still a valid config from the name resolver point of view, thus those aren't consumed.", "author": "creamsoup", "createdAt": "2020-01-18T00:46:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE2NDczOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTczODIwOQ==", "url": "https://github.com/grpc/grpc-java/pull/6600#discussion_r369738209", "bodyText": "Now I see this is for \"old\" NameResolvers that don't call parseServiceConfig() at all but emit the raw config. Granted the raw config attribute is defined in the internal GrpcAttributes thus no third-party NameResolvers are expected to do that. It's fine to call parser here if that makes the migration for first-party NameResolver easier. It's going to be removed along with GrpcAttributes.NAME_RESOLVER_SERVICE_CONFIG anyway so not a big deal.", "author": "zhangkun83", "createdAt": "2020-01-22T18:48:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE2NDczOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg3NTA4OA==", "url": "https://github.com/grpc/grpc-java/pull/6600#discussion_r369875088", "bodyText": "it turns out that internal migration was easy. Thus, as pointed out the attributes shouldn't be used out side of gRPC. removing the service config parsing in ManagedChannelImpl2.", "author": "creamsoup", "createdAt": "2020-01-23T00:15:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE2NDczOA=="}], "type": "inlineReview"}, {"oid": "a3bcdcce5d46489d5a5d08239b5a241da5fca850", "url": "https://github.com/grpc/grpc-java/commit/a3bcdcce5d46489d5a5d08239b5a241da5fca850", "message": "core: make policy selection accepts parsed config object instead of ConfigOrError", "committedDate": "2020-01-18T00:24:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc0MDMzNQ==", "url": "https://github.com/grpc/grpc-java/pull/6600#discussion_r369740335", "bodyText": "An \"old\" NameResolver that doesn't do service config parsing should call listener.onAddresses(), not onResult(). This makes sure the compatibility logic in Listener2#onAddresses() is exercised.", "author": "zhangkun83", "createdAt": "2020-01-22T18:52:27Z", "path": "core/src/test/java/io/grpc/internal/ServiceConfigErrorHandlingTest.java", "diffHunk": "@@ -541,7 +571,17 @@ public NameResolver newNameResolver(final URI targetUri, NameResolver.Args args)\n         return null;\n       }\n       assertEquals(DEFAULT_PORT, args.getDefaultPort());\n-      FakeNameResolver resolver = new FakeNameResolver(args.getServiceConfigParser());\n+      FakeNameResolver resolver;\n+      if (enableServiceConfigParsing) {", "originalCommit": "a3bcdcce5d46489d5a5d08239b5a241da5fca850", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d1e0602308cfad6a0cc0d1b88f6a6d305a1aad2e", "url": "https://github.com/grpc/grpc-java/commit/d1e0602308cfad6a0cc0d1b88f6a6d305a1aad2e", "message": "remove service config parsing in ManagedChannelImpl", "committedDate": "2020-01-23T00:12:15Z", "type": "commit"}]}