{"pr_number": 1903, "pr_title": "[ISSUE #1904] Print log when flush timeout", "pr_createdAt": "2020-04-01T05:29:21Z", "pr_url": "https://github.com/apache/rocketmq/pull/1903", "timeline": [{"oid": "4871108ec95f0a13ba6204b53982d92c2b6871b7", "url": "https://github.com/apache/rocketmq/commit/4871108ec95f0a13ba6204b53982d92c2b6871b7", "message": "rollback my code", "committedDate": "2020-04-01T10:02:12Z", "type": "commit"}, {"oid": "4871108ec95f0a13ba6204b53982d92c2b6871b7", "url": "https://github.com/apache/rocketmq/commit/4871108ec95f0a13ba6204b53982d92c2b6871b7", "message": "rollback my code", "committedDate": "2020-04-01T10:02:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjkwOTE0NQ==", "url": "https://github.com/apache/rocketmq/pull/1903#discussion_r402909145", "bodyText": "If the disk flashing has failed, and continue to log here, it will increase the system load and increase disk IO.\nIMO, as the status will be sent to the client, it is better to remove the error log here.", "author": "ShannonDing", "createdAt": "2020-04-03T10:25:56Z", "path": "store/src/main/java/org/apache/rocketmq/store/CommitLog.java", "diffHunk": "@@ -761,15 +767,20 @@ public long getBeginTimeInLock() {\n         storeStatsService.getSinglePutMessageTopicTimesTotal(messageExtBatch.getTopic()).addAndGet(result.getMsgNum());\n         storeStatsService.getSinglePutMessageTopicSizeTotal(messageExtBatch.getTopic()).addAndGet(result.getWroteBytes());\n \n-        CompletableFuture<PutMessageStatus> flushOKFuture = submitFlushRequest(result, putMessageResult, messageExtBatch);\n-        CompletableFuture<PutMessageStatus> replicaOKFuture = submitReplicaRequest(result, putMessageResult, messageExtBatch);\n+        CompletableFuture<PutMessageStatus> flushOKFuture = submitFlushRequest(result, messageExtBatch);\n+        CompletableFuture<PutMessageStatus> replicaOKFuture = submitReplicaRequest(result, messageExtBatch);\n         return flushOKFuture.thenCombine(replicaOKFuture, (flushStatus, replicaStatus) -> {\n             if (flushStatus != PutMessageStatus.PUT_OK) {\n-                putMessageResult.setPutMessageStatus(PutMessageStatus.FLUSH_DISK_TIMEOUT);\n+                putMessageResult.setPutMessageStatus(flushStatus);\n+                log.error(\"do groupcommit, wait for flush failed, topic: {} tags: {} client address: {}\",", "originalCommit": "4871108ec95f0a13ba6204b53982d92c2b6871b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA3NDI3Mw==", "url": "https://github.com/apache/rocketmq/pull/1903#discussion_r403074273", "bodyText": "Indeed so.\nI still have a question about [#1894 pr]\nreq.wakeupCustomer(flushOK ? PutMessageStatus.PUT_OK : PutMessageStatus.FLUSH_DISK_TIMEOUT);\nflushOK is false means FLUSH_DISK_TIMEOUT?", "author": "rushsky518", "createdAt": "2020-04-03T15:09:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjkwOTE0NQ=="}], "type": "inlineReview"}, {"oid": "b3c1ba7dcbaa4f40f0e26f1834df5f118c65e3f1", "url": "https://github.com/apache/rocketmq/commit/b3c1ba7dcbaa4f40f0e26f1834df5f118c65e3f1", "message": "avoid log when disk flush", "committedDate": "2020-04-03T14:58:44Z", "type": "commit"}, {"oid": "80ebef3120d9c66d916a0fbbdf665be7b7d1033e", "url": "https://github.com/apache/rocketmq/commit/80ebef3120d9c66d916a0fbbdf665be7b7d1033e", "message": "when msg is in next file, flushOK value may be wrong", "committedDate": "2020-04-04T02:27:33Z", "type": "commit"}]}