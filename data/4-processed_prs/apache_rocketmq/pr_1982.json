{"pr_number": 1982, "pr_title": "[ISSUE #2006] Add request-reply doc", "pr_createdAt": "2020-05-11T02:32:27Z", "pr_url": "https://github.com/apache/rocketmq/pull/1982", "timeline": [{"oid": "e95c90bf2e10b3642f1f6adbdf2702cc6b013cc5", "url": "https://github.com/apache/rocketmq/commit/e95c90bf2e10b3642f1f6adbdf2702cc6b013cc5", "message": "add request-reply doc", "committedDate": "2020-05-11T01:57:09Z", "type": "commit"}, {"oid": "408eead2bbc81a0bd2378a1e00fb0d10b94fd8cd", "url": "https://github.com/apache/rocketmq/commit/408eead2bbc81a0bd2378a1e00fb0d10b94fd8cd", "message": "modify request-reply doc", "committedDate": "2020-05-11T02:08:31Z", "type": "commit"}, {"oid": "ff1a6282b90cd97cbf2638b3a2bd45dea3c37261", "url": "https://github.com/apache/rocketmq/commit/ff1a6282b90cd97cbf2638b3a2bd45dea3c37261", "message": "modify request-reply doc", "committedDate": "2020-05-11T02:13:10Z", "type": "commit"}, {"oid": "6594c72944d104d2a123a83119fd44ca0a43d813", "url": "https://github.com/apache/rocketmq/commit/6594c72944d104d2a123a83119fd44ca0a43d813", "message": "modify request-reply doc", "committedDate": "2020-05-11T02:20:13Z", "type": "commit"}, {"oid": "d70a745ee0e165b5a0a973ea39608e45e97cfb1c", "url": "https://github.com/apache/rocketmq/commit/d70a745ee0e165b5a0a973ea39608e45e97cfb1c", "message": "modify request-reply doc", "committedDate": "2020-05-11T02:25:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDUzODg1Ng==", "url": "https://github.com/apache/rocketmq/pull/1982#discussion_r424538856", "bodyText": "It would be better that interfaces are not be used as level 3 titles", "author": "RongtongJin", "createdAt": "2020-05-13T15:41:25Z", "path": "docs/cn/rpc_request.md", "diffHunk": "@@ -0,0 +1,140 @@\n+# \u201cRequest-Reply\u201d\u7279\u6027\n+---\n+\n+## 1 \u4f7f\u7528\u573a\u666f\n+\u968f\u7740\u670d\u52a1\u89c4\u6a21\u7684\u6269\u5927\uff0c\u5355\u673a\u670d\u52a1\u65e0\u6cd5\u6ee1\u8db3\u6027\u80fd\u548c\u5bb9\u91cf\u7684\u8981\u6c42\uff0c\u6b64\u65f6\u9700\u8981\u5c06\u670d\u52a1\u62c6\u5206\u4e3a\u66f4\u5c0f\u7c92\u5ea6\u7684\u670d\u52a1\u6216\u8005\u90e8\u7f72\u591a\u4e2a\u670d\u52a1\u5b9e\u4f8b\u6784\u6210\u96c6\u7fa4\u6765\u63d0\u4f9b\u670d\u52a1\u3002\u5728\u5206\u5e03\u5f0f\u573a\u666f\u4e0b\uff0cRPC\u662f\u6700\u5e38\u7528\u7684\u8054\u673a\u8c03\u7528\u7684\u65b9\u5f0f\u3002\n+\n+\u5728\u6784\u5efa\u5206\u5e03\u5f0f\u5e94\u7528\u65f6\uff0c\u6709\u4e9b\u9886\u57df\uff0c\u4f8b\u5982\u91d1\u878d\u670d\u52a1\u9886\u57df\uff0c\u5e38\u5e38\u4f7f\u7528\u6d88\u606f\u961f\u5217\u6765\u6784\u5efa\u670d\u52a1\u603b\u7ebf\uff0c\u5b9e\u73b0\u8054\u673a\u8c03\u7528\u7684\u76ee\u7684\u3002\u6d88\u606f\u961f\u5217\u7684\u4e3b\u8981\u573a\u666f\u662f\u89e3\u8026\u3001\u524a\u5cf0\u586b\u8c37\uff0c\u5728\u8054\u673a\u8c03\u7528\u7684\u573a\u666f\u4e0b\uff0c\u9700\u8981\u5c06\u670d\u52a1\u7684\u8c03\u7528\u62bd\u8c61\u6210\u57fa\u4e8e\u6d88\u606f\u7684\u4ea4\u4e92\uff0c\u5e76\u589e\u5f3a\u540c\u6b65\u8c03\u7528\u7684\u8fd9\u79cd\u4ea4\u4e92\u903b\u8f91\u3002\u4e3a\u4e86\u66f4\u597d\u5730\u652f\u6301\u6d88\u606f\u961f\u5217\u5728\u8054\u673a\u8c03\u7528\u573a\u666f\u4e0b\u7684\u5e94\u7528\uff0crocketmq-4.7.0\u63a8\u51fa\u4e86\u201cRequest-Reply\u201d\u7279\u6027\u6765\u652f\u6301RPC\u8c03\u7528\u3002\n+\n+## 2 \u8bbe\u8ba1\u601d\u8def\n+\u5728rocketmq\u4e2d\uff0c\u6574\u4e2a\u540c\u6b65\u8c03\u7528\u4e3b\u8981\u5305\u62ec\u4e24\u4e2a\u8fc7\u7a0b\uff1a\n+\n+\uff081\uff09\u8bf7\u6c42\u65b9\u751f\u6210\u6d88\u606f\uff0c\u53d1\u9001\u7ed9\u54cd\u5e94\u65b9\uff0c\u5e76\u7b49\u5f85\u54cd\u5e94\u65b9\u56de\u5305\uff1b\n+\n+\uff082\uff09\u54cd\u5e94\u65b9\u6536\u5230\u8bf7\u6c42\u6d88\u606f\u540e\uff0c\u6d88\u8d39\u8fd9\u6761\u6d88\u606f\uff0c\u5e76\u53d1\u51fa\u4e00\u6761\u54cd\u5e94\u6d88\u606f\u7ed9\u8bf7\u6c42\u65b9\u3002\n+\n+\u6574\u4e2a\u8fc7\u7a0b\u5b9e\u8d28\u4e0a\u662f\u4e24\u4e2a\u6d88\u606f\u6536\u53d1\u8fc7\u7a0b\u7684\u7ec4\u5408\u3002\u6240\u4ee5\u8fd9\u91cc\u6700\u5173\u952e\u7684\u95ee\u9898\u662f\u5982\u4f55\u5c06\u5f02\u6b65\u7684\u6d88\u606f\u6536\u53d1\u8fc7\u7a0b\u6784\u5efa\u6210\u4e00\u4e2a\u540c\u6b65\u7684\u8fc7\u7a0b\u3002\u5176\u4e2d\u4e3b\u8981\u6709\u4e24\u4e2a\u95ee\u9898\u9700\u8981\u89e3\u51b3\uff1a\n+\n+### 2.1 \u8bf7\u6c42\u65b9\u5982\u4f55\u540c\u6b65\u7b49\u5f85\u56de\u5305\n+\n+\u8fd9\u4e2a\u95ee\u9898\u7684\u89e3\u51b3\u65b9\u6848\u4e2d\uff0c\u4e00\u4e2a\u5173\u952e\u7684\u6570\u636e\u7ed3\u6784\u662fRequestResponseFuture\u3002\n+\n+```\n+public class RequestResponseFuture {\n+    private final String correlationId;\n+    private final RequestCallback requestCallback;\n+    private final long beginTimestamp = System.currentTimeMillis();\n+    private final Message requestMsg = null;\n+    private long timeoutMillis;\n+    private CountDownLatch countDownLatch = new CountDownLatch(1);\n+    private volatile Message responseMsg = null;\n+    private volatile boolean sendRequestOk = true;\n+    private volatile Throwable cause = null;\n+}\n+```\n+RequestResponseFuture\u4e2d\uff0c\u5229\u7528correlationId\u6765\u6807\u8bc6\u4e00\u4e2a\u8bf7\u6c42\u3002\u5982\u4e0b\u56fe\u6240\u793a\uff0cProducer\u53d1\u9001request\u65f6\u521b\u5efa\u4e00\u4e2aRequestResponseFuture\uff0c\u4ee5correlationId\u4e3akey\uff0cRequestResponseFuture\u4e3avalue\u5b58\u5165map\uff0c\u540c\u65f6\u8bf7\u6c42\u4e2d\u5e26\u4e0aRequestResponseFuture\u4e2d\u7684correlationId\uff0c\u6536\u5230\u56de\u5305\u540e\u6839\u636ecorrelationId\u62ff\u5230\u5bf9\u5e94\u7684RequestResponseFuture\uff0c\u5e76\u8bbe\u7f6e\u56de\u5305\u5185\u5bb9\u3002\n+![](image/producer_send_request.png)\n+\n+### 2.2 consumer\u6d88\u8d39\u6d88\u606f\u540e\uff0c\u5982\u4f55\u51c6\u786e\u56de\u5305\n+\n+\uff081\uff09producer\u5728\u53d1\u9001\u6d88\u606f\u7684\u65f6\u5019\uff0c\u4f1a\u7ed9\u6bcf\u6761\u6d88\u606f\u751f\u6210\u552f\u4e00\u7684\u6807\u8bc6\u7b26\uff0c\u540c\u65f6\u8fd8\u5e26\u4e0a\u4e86producer\u7684clientId\u3002\u5f53consumer\u6536\u5230\u5e76\u6d88\u8d39\u6d88\u606f\u540e\uff0c\u4ece\u6d88\u606f\u4e2d\u53d6\u51fa\u6d88\u606f\u7684\u6807\u8bc6\u7b26correlationId\u548cproducer\u7684\u6807\u8bc6\u7b26clientId\uff0c\u653e\u5165\u54cd\u5e94\u6d88\u606f\uff0c\u7528\u6765\u786e\u5b9a\u6b64\u54cd\u5e94\u6d88\u606f\u662f\u54ea\u6761\u8bf7\u6c42\u6d88\u606f\u7684\u56de\u5305\uff0c\u4ee5\u53ca\u6b64\u54cd\u5e94\u6d88\u606f\u5e94\u8be5\u53d1\u7ed9\u54ea\u4e2aproducer\u3002\u540c\u65f6\u54cd\u5e94\u6d88\u606f\u4e2d\u8bbe\u7f6e\u4e86\u6d88\u606f\u7684\u7c7b\u578b\u4ee5\u53ca\u54cd\u5e94\u6d88\u606f\u7684topic\uff0c\u7136\u540econsumer\u5c06\u6d88\u606f\u53d1\u7ed9broker\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002\n+![](image/consumer_reply.png)\n+\n+\uff082\uff09broker\u6536\u5230\u54cd\u5e94\u6d88\u606f\u540e\uff0c\u9700\u8981\u5c06\u6d88\u606f\u53d1\u56de\u7ed9\u6307\u5b9a\u7684producer\u3002Broker\u5982\u4f55\u77e5\u9053\u53d1\u56de\u7ed9\u54ea\u4e2aproducer\uff1f\u56e0\u4e3a\u6d88\u606f\u4e2d\u5305\u542b\u4e86producer\u7684\u6807\u8bc6\u7b26clientId\uff0c\u5728ProducerManager\u4e2d\uff0c\u7ef4\u62a4\u4e86\u6807\u8bc6\u7b26\u548cchannel\u4fe1\u606f\u7684\u5bf9\u5e94\u5173\u7cfb\uff0c\u901a\u8fc7\u8fd9\u4e2a\u5bf9\u5e94\u5173\u7cfb\uff0c\u5c31\u80fd\u628a\u56de\u5305\u53d1\u7ed9\u5bf9\u5e94\u7684producer\u3002\n+\n+\u54cd\u5e94\u6d88\u606f\u53d1\u9001\u548c\u4e00\u822c\u7684\u6d88\u606f\u53d1\u9001\u6d41\u7a0b\u533a\u522b\u5728\u4e8e\uff0c\u54cd\u5e94\u6d88\u606f\u4e0d\u9700\u8981producer\u62c9\u53d6\uff0c\u800c\u662f\u7531broker\u76f4\u63a5\u63a8\u7ed9producer\u3002\u540c\u65f6\u9009\u62e9broker\u7684\u7b56\u7565\u4e5f\u6709\u53d8\u5316\uff1a\u8bf7\u6c42\u6d88\u606f\u4ece\u54ea\u4e2abroker\u53d1\u8fc7\u6765\uff0c\u54cd\u5e94\u6d88\u606f\u4e5f\u53d1\u5230\u5bf9\u5e94\u7684broker\u4e0a\u3002\n+\n+Producer\u6536\u5230\u54cd\u5e94\u6d88\u606f\u540e\uff0c\u6839\u636e\u6d88\u606f\u4e2d\u7684\u552f\u4e00\u6807\u8bc6\u7b26\uff0c\u4eceRequestResponseFuture\u7684map\u4e2d\u627e\u5230\u5bf9\u5e94\u7684RequestResponseFuture\u7ed3\u6784\uff0c\u8bbe\u7f6e\u54cd\u5e94\u6d88\u606f\uff0c\u540c\u65f6\u8ba1\u6570\u5668\u51cf\u4e00\uff0c\u89e3\u9664\u7b49\u5f85\u72b6\u6001\uff0c\u4f7f\u8bf7\u6c42\u65b9\u6536\u5230\u54cd\u5e94\u6d88\u606f\u3002\n+\n+## 3 \u4f7f\u7528\u65b9\u6cd5\n+\n+\u540c\u6b65\u8c03\u7528\u7684\u793a\u4f8b\u5728example\u6587\u4ef6\u5939\u7684rpc\u76ee\u5f55\u4e0b\u3002\n+\n+### 3.1 Producer\n+```\n+Message msg = new Message(topic,\n+                \"\",\n+                \"Hello world\".getBytes(RemotingHelper.DEFAULT_CHARSET));\n+\n+            long begin = System.currentTimeMillis();\n+            Message retMsg = producer.request(msg, ttl);\n+            long cost = System.currentTimeMillis() - begin;\n+            System.out.printf(\"request to <%s> cost: %d replyMessage: %s %n\", topic, cost, retMsg);\n+```\n+\u8c03\u7528\u63a5\u53e3\u66ff\u6362\u4e3arequest\u5373\u53ef\u3002\n+\n+### 3.2 Consumer\n+\u9700\u8981\u542f\u52a8\u4e00\u4e2aproducer\uff0c\u540c\u65f6\u5728\u8986\u5199consumeMessage\u65b9\u6cd5\u7684\u65f6\u5019\uff0c\u81ea\u5b9a\u4e49\u54cd\u5e94\u6d88\u606f\u5e76\u53d1\u9001\u3002\n+\n+```\n+            @Override\n+            public ConsumeConcurrentlyStatus consumeMessage(List<MessageExt> msgs, ConsumeConcurrentlyContext context) {\n+                System.out.printf(\"%s Receive New Messages: %s %n\", Thread.currentThread().getName(), msgs);\n+                for (MessageExt msg : msgs) {\n+                    try {\n+                        System.out.printf(\"handle message: %s\", msg.toString());\n+                        String replyTo = MessageUtil.getReplyToClient(msg);\n+                        byte[] replyContent = \"reply message contents.\".getBytes();\n+                        // create reply message with given util, do not create reply message by yourself\n+                        Message replyMessage = MessageUtil.createReplyMessage(msg, replyContent);\n+\n+                        // send reply message with producer\n+                        SendResult replyResult = replyProducer.send(replyMessage, 3000);\n+                        System.out.printf(\"reply to %s , %s %n\", replyTo, replyResult.toString());\n+                    } catch (MQClientException | RemotingException | MQBrokerException | InterruptedException e) {\n+                        e.printStackTrace();\n+                    }\n+                }\n+                return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;\n+            }\n+```\n+\n+## 4 \u63a5\u53e3\u53c2\u6570\n+### 4.1 public Message request(Message msg,long timeout)", "originalCommit": "d70a745ee0e165b5a0a973ea39608e45e97cfb1c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU2MTk2Nw==", "url": "https://github.com/apache/rocketmq/pull/1982#discussion_r426561967", "bodyText": "get it, I modify the interfaces to plain text", "author": "keranbingaa", "createdAt": "2020-05-18T11:38:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDUzODg1Ng=="}], "type": "inlineReview"}, {"oid": "4d2dea18cb6ff22adcec437d9bdbb1b36afd32a1", "url": "https://github.com/apache/rocketmq/commit/4d2dea18cb6ff22adcec437d9bdbb1b36afd32a1", "message": "modify request-reply doc", "committedDate": "2020-05-18T11:09:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU2Nzc3Ng==", "url": "https://github.com/apache/rocketmq/pull/1982#discussion_r426567776", "bodyText": "It would be better if the code was aligned", "author": "RongtongJin", "createdAt": "2020-05-18T11:49:46Z", "path": "docs/cn/rpc_request.md", "diffHunk": "@@ -0,0 +1,146 @@\n+# \u201cRequest-Reply\u201d\u7279\u6027\n+---\n+\n+## 1 \u4f7f\u7528\u573a\u666f\n+\u968f\u7740\u670d\u52a1\u89c4\u6a21\u7684\u6269\u5927\uff0c\u5355\u673a\u670d\u52a1\u65e0\u6cd5\u6ee1\u8db3\u6027\u80fd\u548c\u5bb9\u91cf\u7684\u8981\u6c42\uff0c\u6b64\u65f6\u9700\u8981\u5c06\u670d\u52a1\u62c6\u5206\u4e3a\u66f4\u5c0f\u7c92\u5ea6\u7684\u670d\u52a1\u6216\u8005\u90e8\u7f72\u591a\u4e2a\u670d\u52a1\u5b9e\u4f8b\u6784\u6210\u96c6\u7fa4\u6765\u63d0\u4f9b\u670d\u52a1\u3002\u5728\u5206\u5e03\u5f0f\u573a\u666f\u4e0b\uff0cRPC\u662f\u6700\u5e38\u7528\u7684\u8054\u673a\u8c03\u7528\u7684\u65b9\u5f0f\u3002\n+\n+\u5728\u6784\u5efa\u5206\u5e03\u5f0f\u5e94\u7528\u65f6\uff0c\u6709\u4e9b\u9886\u57df\uff0c\u4f8b\u5982\u91d1\u878d\u670d\u52a1\u9886\u57df\uff0c\u5e38\u5e38\u4f7f\u7528\u6d88\u606f\u961f\u5217\u6765\u6784\u5efa\u670d\u52a1\u603b\u7ebf\uff0c\u5b9e\u73b0\u8054\u673a\u8c03\u7528\u7684\u76ee\u7684\u3002\u6d88\u606f\u961f\u5217\u7684\u4e3b\u8981\u573a\u666f\u662f\u89e3\u8026\u3001\u524a\u5cf0\u586b\u8c37\uff0c\u5728\u8054\u673a\u8c03\u7528\u7684\u573a\u666f\u4e0b\uff0c\u9700\u8981\u5c06\u670d\u52a1\u7684\u8c03\u7528\u62bd\u8c61\u6210\u57fa\u4e8e\u6d88\u606f\u7684\u4ea4\u4e92\uff0c\u5e76\u589e\u5f3a\u540c\u6b65\u8c03\u7528\u7684\u8fd9\u79cd\u4ea4\u4e92\u903b\u8f91\u3002\u4e3a\u4e86\u66f4\u597d\u5730\u652f\u6301\u6d88\u606f\u961f\u5217\u5728\u8054\u673a\u8c03\u7528\u573a\u666f\u4e0b\u7684\u5e94\u7528\uff0crocketmq-4.7.0\u63a8\u51fa\u4e86\u201cRequest-Reply\u201d\u7279\u6027\u6765\u652f\u6301RPC\u8c03\u7528\u3002\n+\n+## 2 \u8bbe\u8ba1\u601d\u8def\n+\u5728rocketmq\u4e2d\uff0c\u6574\u4e2a\u540c\u6b65\u8c03\u7528\u4e3b\u8981\u5305\u62ec\u4e24\u4e2a\u8fc7\u7a0b\uff1a\n+\n+\uff081\uff09\u8bf7\u6c42\u65b9\u751f\u6210\u6d88\u606f\uff0c\u53d1\u9001\u7ed9\u54cd\u5e94\u65b9\uff0c\u5e76\u7b49\u5f85\u54cd\u5e94\u65b9\u56de\u5305\uff1b\n+\n+\uff082\uff09\u54cd\u5e94\u65b9\u6536\u5230\u8bf7\u6c42\u6d88\u606f\u540e\uff0c\u6d88\u8d39\u8fd9\u6761\u6d88\u606f\uff0c\u5e76\u53d1\u51fa\u4e00\u6761\u54cd\u5e94\u6d88\u606f\u7ed9\u8bf7\u6c42\u65b9\u3002\n+\n+\u6574\u4e2a\u8fc7\u7a0b\u5b9e\u8d28\u4e0a\u662f\u4e24\u4e2a\u6d88\u606f\u6536\u53d1\u8fc7\u7a0b\u7684\u7ec4\u5408\u3002\u6240\u4ee5\u8fd9\u91cc\u6700\u5173\u952e\u7684\u95ee\u9898\u662f\u5982\u4f55\u5c06\u5f02\u6b65\u7684\u6d88\u606f\u6536\u53d1\u8fc7\u7a0b\u6784\u5efa\u6210\u4e00\u4e2a\u540c\u6b65\u7684\u8fc7\u7a0b\u3002\u5176\u4e2d\u4e3b\u8981\u6709\u4e24\u4e2a\u95ee\u9898\u9700\u8981\u89e3\u51b3\uff1a\n+\n+### 2.1 \u8bf7\u6c42\u65b9\u5982\u4f55\u540c\u6b65\u7b49\u5f85\u56de\u5305\n+\n+\u8fd9\u4e2a\u95ee\u9898\u7684\u89e3\u51b3\u65b9\u6848\u4e2d\uff0c\u4e00\u4e2a\u5173\u952e\u7684\u6570\u636e\u7ed3\u6784\u662fRequestResponseFuture\u3002\n+\n+```\n+public class RequestResponseFuture {\n+    private final String correlationId;\n+    private final RequestCallback requestCallback;\n+    private final long beginTimestamp = System.currentTimeMillis();\n+    private final Message requestMsg = null;\n+    private long timeoutMillis;\n+    private CountDownLatch countDownLatch = new CountDownLatch(1);\n+    private volatile Message responseMsg = null;\n+    private volatile boolean sendRequestOk = true;\n+    private volatile Throwable cause = null;\n+}\n+```\n+RequestResponseFuture\u4e2d\uff0c\u5229\u7528correlationId\u6765\u6807\u8bc6\u4e00\u4e2a\u8bf7\u6c42\u3002\u5982\u4e0b\u56fe\u6240\u793a\uff0cProducer\u53d1\u9001request\u65f6\u521b\u5efa\u4e00\u4e2aRequestResponseFuture\uff0c\u4ee5correlationId\u4e3akey\uff0cRequestResponseFuture\u4e3avalue\u5b58\u5165map\uff0c\u540c\u65f6\u8bf7\u6c42\u4e2d\u5e26\u4e0aRequestResponseFuture\u4e2d\u7684correlationId\uff0c\u6536\u5230\u56de\u5305\u540e\u6839\u636ecorrelationId\u62ff\u5230\u5bf9\u5e94\u7684RequestResponseFuture\uff0c\u5e76\u8bbe\u7f6e\u56de\u5305\u5185\u5bb9\u3002\n+![](image/producer_send_request.png)\n+\n+### 2.2 consumer\u6d88\u8d39\u6d88\u606f\u540e\uff0c\u5982\u4f55\u51c6\u786e\u56de\u5305\n+\n+\uff081\uff09producer\u5728\u53d1\u9001\u6d88\u606f\u7684\u65f6\u5019\uff0c\u4f1a\u7ed9\u6bcf\u6761\u6d88\u606f\u751f\u6210\u552f\u4e00\u7684\u6807\u8bc6\u7b26\uff0c\u540c\u65f6\u8fd8\u5e26\u4e0a\u4e86producer\u7684clientId\u3002\u5f53consumer\u6536\u5230\u5e76\u6d88\u8d39\u6d88\u606f\u540e\uff0c\u4ece\u6d88\u606f\u4e2d\u53d6\u51fa\u6d88\u606f\u7684\u6807\u8bc6\u7b26correlationId\u548cproducer\u7684\u6807\u8bc6\u7b26clientId\uff0c\u653e\u5165\u54cd\u5e94\u6d88\u606f\uff0c\u7528\u6765\u786e\u5b9a\u6b64\u54cd\u5e94\u6d88\u606f\u662f\u54ea\u6761\u8bf7\u6c42\u6d88\u606f\u7684\u56de\u5305\uff0c\u4ee5\u53ca\u6b64\u54cd\u5e94\u6d88\u606f\u5e94\u8be5\u53d1\u7ed9\u54ea\u4e2aproducer\u3002\u540c\u65f6\u54cd\u5e94\u6d88\u606f\u4e2d\u8bbe\u7f6e\u4e86\u6d88\u606f\u7684\u7c7b\u578b\u4ee5\u53ca\u54cd\u5e94\u6d88\u606f\u7684topic\uff0c\u7136\u540econsumer\u5c06\u6d88\u606f\u53d1\u7ed9broker\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002\n+![](image/consumer_reply.png)\n+\n+\uff082\uff09broker\u6536\u5230\u54cd\u5e94\u6d88\u606f\u540e\uff0c\u9700\u8981\u5c06\u6d88\u606f\u53d1\u56de\u7ed9\u6307\u5b9a\u7684producer\u3002Broker\u5982\u4f55\u77e5\u9053\u53d1\u56de\u7ed9\u54ea\u4e2aproducer\uff1f\u56e0\u4e3a\u6d88\u606f\u4e2d\u5305\u542b\u4e86producer\u7684\u6807\u8bc6\u7b26clientId\uff0c\u5728ProducerManager\u4e2d\uff0c\u7ef4\u62a4\u4e86\u6807\u8bc6\u7b26\u548cchannel\u4fe1\u606f\u7684\u5bf9\u5e94\u5173\u7cfb\uff0c\u901a\u8fc7\u8fd9\u4e2a\u5bf9\u5e94\u5173\u7cfb\uff0c\u5c31\u80fd\u628a\u56de\u5305\u53d1\u7ed9\u5bf9\u5e94\u7684producer\u3002\n+\n+\u54cd\u5e94\u6d88\u606f\u53d1\u9001\u548c\u4e00\u822c\u7684\u6d88\u606f\u53d1\u9001\u6d41\u7a0b\u533a\u522b\u5728\u4e8e\uff0c\u54cd\u5e94\u6d88\u606f\u4e0d\u9700\u8981producer\u62c9\u53d6\uff0c\u800c\u662f\u7531broker\u76f4\u63a5\u63a8\u7ed9producer\u3002\u540c\u65f6\u9009\u62e9broker\u7684\u7b56\u7565\u4e5f\u6709\u53d8\u5316\uff1a\u8bf7\u6c42\u6d88\u606f\u4ece\u54ea\u4e2abroker\u53d1\u8fc7\u6765\uff0c\u54cd\u5e94\u6d88\u606f\u4e5f\u53d1\u5230\u5bf9\u5e94\u7684broker\u4e0a\u3002\n+\n+Producer\u6536\u5230\u54cd\u5e94\u6d88\u606f\u540e\uff0c\u6839\u636e\u6d88\u606f\u4e2d\u7684\u552f\u4e00\u6807\u8bc6\u7b26\uff0c\u4eceRequestResponseFuture\u7684map\u4e2d\u627e\u5230\u5bf9\u5e94\u7684RequestResponseFuture\u7ed3\u6784\uff0c\u8bbe\u7f6e\u54cd\u5e94\u6d88\u606f\uff0c\u540c\u65f6\u8ba1\u6570\u5668\u51cf\u4e00\uff0c\u89e3\u9664\u7b49\u5f85\u72b6\u6001\uff0c\u4f7f\u8bf7\u6c42\u65b9\u6536\u5230\u54cd\u5e94\u6d88\u606f\u3002\n+\n+## 3 \u4f7f\u7528\u65b9\u6cd5\n+\n+\u540c\u6b65\u8c03\u7528\u7684\u793a\u4f8b\u5728example\u6587\u4ef6\u5939\u7684rpc\u76ee\u5f55\u4e0b\u3002\n+\n+### 3.1 Producer\n+```\n+Message msg = new Message(topic,\n+                \"\",\n+                \"Hello world\".getBytes(RemotingHelper.DEFAULT_CHARSET));\n+\n+            long begin = System.currentTimeMillis();\n+            Message retMsg = producer.request(msg, ttl);\n+            long cost = System.currentTimeMillis() - begin;\n+            System.out.printf(\"request to <%s> cost: %d replyMessage: %s %n\", topic, cost, retMsg);\n+```", "originalCommit": "4d2dea18cb6ff22adcec437d9bdbb1b36afd32a1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU2Nzg2NA==", "url": "https://github.com/apache/rocketmq/pull/1982#discussion_r426567864", "bodyText": "It would be better if the code was aligned", "author": "RongtongJin", "createdAt": "2020-05-18T11:49:57Z", "path": "docs/cn/rpc_request.md", "diffHunk": "@@ -0,0 +1,146 @@\n+# \u201cRequest-Reply\u201d\u7279\u6027\n+---\n+\n+## 1 \u4f7f\u7528\u573a\u666f\n+\u968f\u7740\u670d\u52a1\u89c4\u6a21\u7684\u6269\u5927\uff0c\u5355\u673a\u670d\u52a1\u65e0\u6cd5\u6ee1\u8db3\u6027\u80fd\u548c\u5bb9\u91cf\u7684\u8981\u6c42\uff0c\u6b64\u65f6\u9700\u8981\u5c06\u670d\u52a1\u62c6\u5206\u4e3a\u66f4\u5c0f\u7c92\u5ea6\u7684\u670d\u52a1\u6216\u8005\u90e8\u7f72\u591a\u4e2a\u670d\u52a1\u5b9e\u4f8b\u6784\u6210\u96c6\u7fa4\u6765\u63d0\u4f9b\u670d\u52a1\u3002\u5728\u5206\u5e03\u5f0f\u573a\u666f\u4e0b\uff0cRPC\u662f\u6700\u5e38\u7528\u7684\u8054\u673a\u8c03\u7528\u7684\u65b9\u5f0f\u3002\n+\n+\u5728\u6784\u5efa\u5206\u5e03\u5f0f\u5e94\u7528\u65f6\uff0c\u6709\u4e9b\u9886\u57df\uff0c\u4f8b\u5982\u91d1\u878d\u670d\u52a1\u9886\u57df\uff0c\u5e38\u5e38\u4f7f\u7528\u6d88\u606f\u961f\u5217\u6765\u6784\u5efa\u670d\u52a1\u603b\u7ebf\uff0c\u5b9e\u73b0\u8054\u673a\u8c03\u7528\u7684\u76ee\u7684\u3002\u6d88\u606f\u961f\u5217\u7684\u4e3b\u8981\u573a\u666f\u662f\u89e3\u8026\u3001\u524a\u5cf0\u586b\u8c37\uff0c\u5728\u8054\u673a\u8c03\u7528\u7684\u573a\u666f\u4e0b\uff0c\u9700\u8981\u5c06\u670d\u52a1\u7684\u8c03\u7528\u62bd\u8c61\u6210\u57fa\u4e8e\u6d88\u606f\u7684\u4ea4\u4e92\uff0c\u5e76\u589e\u5f3a\u540c\u6b65\u8c03\u7528\u7684\u8fd9\u79cd\u4ea4\u4e92\u903b\u8f91\u3002\u4e3a\u4e86\u66f4\u597d\u5730\u652f\u6301\u6d88\u606f\u961f\u5217\u5728\u8054\u673a\u8c03\u7528\u573a\u666f\u4e0b\u7684\u5e94\u7528\uff0crocketmq-4.7.0\u63a8\u51fa\u4e86\u201cRequest-Reply\u201d\u7279\u6027\u6765\u652f\u6301RPC\u8c03\u7528\u3002\n+\n+## 2 \u8bbe\u8ba1\u601d\u8def\n+\u5728rocketmq\u4e2d\uff0c\u6574\u4e2a\u540c\u6b65\u8c03\u7528\u4e3b\u8981\u5305\u62ec\u4e24\u4e2a\u8fc7\u7a0b\uff1a\n+\n+\uff081\uff09\u8bf7\u6c42\u65b9\u751f\u6210\u6d88\u606f\uff0c\u53d1\u9001\u7ed9\u54cd\u5e94\u65b9\uff0c\u5e76\u7b49\u5f85\u54cd\u5e94\u65b9\u56de\u5305\uff1b\n+\n+\uff082\uff09\u54cd\u5e94\u65b9\u6536\u5230\u8bf7\u6c42\u6d88\u606f\u540e\uff0c\u6d88\u8d39\u8fd9\u6761\u6d88\u606f\uff0c\u5e76\u53d1\u51fa\u4e00\u6761\u54cd\u5e94\u6d88\u606f\u7ed9\u8bf7\u6c42\u65b9\u3002\n+\n+\u6574\u4e2a\u8fc7\u7a0b\u5b9e\u8d28\u4e0a\u662f\u4e24\u4e2a\u6d88\u606f\u6536\u53d1\u8fc7\u7a0b\u7684\u7ec4\u5408\u3002\u6240\u4ee5\u8fd9\u91cc\u6700\u5173\u952e\u7684\u95ee\u9898\u662f\u5982\u4f55\u5c06\u5f02\u6b65\u7684\u6d88\u606f\u6536\u53d1\u8fc7\u7a0b\u6784\u5efa\u6210\u4e00\u4e2a\u540c\u6b65\u7684\u8fc7\u7a0b\u3002\u5176\u4e2d\u4e3b\u8981\u6709\u4e24\u4e2a\u95ee\u9898\u9700\u8981\u89e3\u51b3\uff1a\n+\n+### 2.1 \u8bf7\u6c42\u65b9\u5982\u4f55\u540c\u6b65\u7b49\u5f85\u56de\u5305\n+\n+\u8fd9\u4e2a\u95ee\u9898\u7684\u89e3\u51b3\u65b9\u6848\u4e2d\uff0c\u4e00\u4e2a\u5173\u952e\u7684\u6570\u636e\u7ed3\u6784\u662fRequestResponseFuture\u3002\n+\n+```\n+public class RequestResponseFuture {\n+    private final String correlationId;\n+    private final RequestCallback requestCallback;\n+    private final long beginTimestamp = System.currentTimeMillis();\n+    private final Message requestMsg = null;\n+    private long timeoutMillis;\n+    private CountDownLatch countDownLatch = new CountDownLatch(1);\n+    private volatile Message responseMsg = null;\n+    private volatile boolean sendRequestOk = true;\n+    private volatile Throwable cause = null;\n+}\n+```\n+RequestResponseFuture\u4e2d\uff0c\u5229\u7528correlationId\u6765\u6807\u8bc6\u4e00\u4e2a\u8bf7\u6c42\u3002\u5982\u4e0b\u56fe\u6240\u793a\uff0cProducer\u53d1\u9001request\u65f6\u521b\u5efa\u4e00\u4e2aRequestResponseFuture\uff0c\u4ee5correlationId\u4e3akey\uff0cRequestResponseFuture\u4e3avalue\u5b58\u5165map\uff0c\u540c\u65f6\u8bf7\u6c42\u4e2d\u5e26\u4e0aRequestResponseFuture\u4e2d\u7684correlationId\uff0c\u6536\u5230\u56de\u5305\u540e\u6839\u636ecorrelationId\u62ff\u5230\u5bf9\u5e94\u7684RequestResponseFuture\uff0c\u5e76\u8bbe\u7f6e\u56de\u5305\u5185\u5bb9\u3002\n+![](image/producer_send_request.png)\n+\n+### 2.2 consumer\u6d88\u8d39\u6d88\u606f\u540e\uff0c\u5982\u4f55\u51c6\u786e\u56de\u5305\n+\n+\uff081\uff09producer\u5728\u53d1\u9001\u6d88\u606f\u7684\u65f6\u5019\uff0c\u4f1a\u7ed9\u6bcf\u6761\u6d88\u606f\u751f\u6210\u552f\u4e00\u7684\u6807\u8bc6\u7b26\uff0c\u540c\u65f6\u8fd8\u5e26\u4e0a\u4e86producer\u7684clientId\u3002\u5f53consumer\u6536\u5230\u5e76\u6d88\u8d39\u6d88\u606f\u540e\uff0c\u4ece\u6d88\u606f\u4e2d\u53d6\u51fa\u6d88\u606f\u7684\u6807\u8bc6\u7b26correlationId\u548cproducer\u7684\u6807\u8bc6\u7b26clientId\uff0c\u653e\u5165\u54cd\u5e94\u6d88\u606f\uff0c\u7528\u6765\u786e\u5b9a\u6b64\u54cd\u5e94\u6d88\u606f\u662f\u54ea\u6761\u8bf7\u6c42\u6d88\u606f\u7684\u56de\u5305\uff0c\u4ee5\u53ca\u6b64\u54cd\u5e94\u6d88\u606f\u5e94\u8be5\u53d1\u7ed9\u54ea\u4e2aproducer\u3002\u540c\u65f6\u54cd\u5e94\u6d88\u606f\u4e2d\u8bbe\u7f6e\u4e86\u6d88\u606f\u7684\u7c7b\u578b\u4ee5\u53ca\u54cd\u5e94\u6d88\u606f\u7684topic\uff0c\u7136\u540econsumer\u5c06\u6d88\u606f\u53d1\u7ed9broker\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002\n+![](image/consumer_reply.png)\n+\n+\uff082\uff09broker\u6536\u5230\u54cd\u5e94\u6d88\u606f\u540e\uff0c\u9700\u8981\u5c06\u6d88\u606f\u53d1\u56de\u7ed9\u6307\u5b9a\u7684producer\u3002Broker\u5982\u4f55\u77e5\u9053\u53d1\u56de\u7ed9\u54ea\u4e2aproducer\uff1f\u56e0\u4e3a\u6d88\u606f\u4e2d\u5305\u542b\u4e86producer\u7684\u6807\u8bc6\u7b26clientId\uff0c\u5728ProducerManager\u4e2d\uff0c\u7ef4\u62a4\u4e86\u6807\u8bc6\u7b26\u548cchannel\u4fe1\u606f\u7684\u5bf9\u5e94\u5173\u7cfb\uff0c\u901a\u8fc7\u8fd9\u4e2a\u5bf9\u5e94\u5173\u7cfb\uff0c\u5c31\u80fd\u628a\u56de\u5305\u53d1\u7ed9\u5bf9\u5e94\u7684producer\u3002\n+\n+\u54cd\u5e94\u6d88\u606f\u53d1\u9001\u548c\u4e00\u822c\u7684\u6d88\u606f\u53d1\u9001\u6d41\u7a0b\u533a\u522b\u5728\u4e8e\uff0c\u54cd\u5e94\u6d88\u606f\u4e0d\u9700\u8981producer\u62c9\u53d6\uff0c\u800c\u662f\u7531broker\u76f4\u63a5\u63a8\u7ed9producer\u3002\u540c\u65f6\u9009\u62e9broker\u7684\u7b56\u7565\u4e5f\u6709\u53d8\u5316\uff1a\u8bf7\u6c42\u6d88\u606f\u4ece\u54ea\u4e2abroker\u53d1\u8fc7\u6765\uff0c\u54cd\u5e94\u6d88\u606f\u4e5f\u53d1\u5230\u5bf9\u5e94\u7684broker\u4e0a\u3002\n+\n+Producer\u6536\u5230\u54cd\u5e94\u6d88\u606f\u540e\uff0c\u6839\u636e\u6d88\u606f\u4e2d\u7684\u552f\u4e00\u6807\u8bc6\u7b26\uff0c\u4eceRequestResponseFuture\u7684map\u4e2d\u627e\u5230\u5bf9\u5e94\u7684RequestResponseFuture\u7ed3\u6784\uff0c\u8bbe\u7f6e\u54cd\u5e94\u6d88\u606f\uff0c\u540c\u65f6\u8ba1\u6570\u5668\u51cf\u4e00\uff0c\u89e3\u9664\u7b49\u5f85\u72b6\u6001\uff0c\u4f7f\u8bf7\u6c42\u65b9\u6536\u5230\u54cd\u5e94\u6d88\u606f\u3002\n+\n+## 3 \u4f7f\u7528\u65b9\u6cd5\n+\n+\u540c\u6b65\u8c03\u7528\u7684\u793a\u4f8b\u5728example\u6587\u4ef6\u5939\u7684rpc\u76ee\u5f55\u4e0b\u3002\n+\n+### 3.1 Producer\n+```\n+Message msg = new Message(topic,\n+                \"\",\n+                \"Hello world\".getBytes(RemotingHelper.DEFAULT_CHARSET));\n+\n+            long begin = System.currentTimeMillis();\n+            Message retMsg = producer.request(msg, ttl);\n+            long cost = System.currentTimeMillis() - begin;\n+            System.out.printf(\"request to <%s> cost: %d replyMessage: %s %n\", topic, cost, retMsg);\n+```\n+\u8c03\u7528\u63a5\u53e3\u66ff\u6362\u4e3arequest\u5373\u53ef\u3002\n+\n+### 3.2 Consumer\n+\u9700\u8981\u542f\u52a8\u4e00\u4e2aproducer\uff0c\u540c\u65f6\u5728\u8986\u5199consumeMessage\u65b9\u6cd5\u7684\u65f6\u5019\uff0c\u81ea\u5b9a\u4e49\u54cd\u5e94\u6d88\u606f\u5e76\u53d1\u9001\u3002\n+\n+```\n+            @Override\n+            public ConsumeConcurrentlyStatus consumeMessage(List<MessageExt> msgs, ConsumeConcurrentlyContext context) {\n+                System.out.printf(\"%s Receive New Messages: %s %n\", Thread.currentThread().getName(), msgs);\n+                for (MessageExt msg : msgs) {\n+                    try {\n+                        System.out.printf(\"handle message: %s\", msg.toString());\n+                        String replyTo = MessageUtil.getReplyToClient(msg);\n+                        byte[] replyContent = \"reply message contents.\".getBytes();\n+                        // create reply message with given util, do not create reply message by yourself\n+                        Message replyMessage = MessageUtil.createReplyMessage(msg, replyContent);\n+\n+                        // send reply message with producer\n+                        SendResult replyResult = replyProducer.send(replyMessage, 3000);\n+                        System.out.printf(\"reply to %s , %s %n\", replyTo, replyResult.toString());\n+                    } catch (MQClientException | RemotingException | MQBrokerException | InterruptedException e) {\n+                        e.printStackTrace();\n+                    }\n+                }", "originalCommit": "4d2dea18cb6ff22adcec437d9bdbb1b36afd32a1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}