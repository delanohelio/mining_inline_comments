{"pr_number": 2343, "pr_title": "[ISSUE# 2330] Store the properties of MessageBatch", "pr_createdAt": "2020-10-09T13:59:40Z", "pr_url": "https://github.com/apache/rocketmq/pull/2343", "timeline": [{"oid": "bb264617dab545ea180425d9493d537c857eda13", "url": "https://github.com/apache/rocketmq/commit/bb264617dab545ea180425d9493d537c857eda13", "message": "[ISSUE# 2330]store the properties of MessageBatch", "committedDate": "2020-10-09T13:56:10Z", "type": "commit"}, {"oid": "18e2acc4fda9bfdfc73794cb0518653ff407cc05", "url": "https://github.com/apache/rocketmq/commit/18e2acc4fda9bfdfc73794cb0518653ff407cc05", "message": "[ISSUE# 2330]fix style problem", "committedDate": "2020-10-09T16:32:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjg1MTg5OA==", "url": "https://github.com/apache/rocketmq/pull/2343#discussion_r502851898", "bodyText": "IMO, set properties has been done in this code MessageAccessor.setProperties(messageExtBatch, MessageDecoder.string2messageProperties(requestHeader.getProperties()));, so we don't need add a new variable named propertiesString to MessageExtBatch to do this thing.", "author": "RongtongJin", "createdAt": "2020-10-11T01:27:58Z", "path": "broker/src/main/java/org/apache/rocketmq/broker/processor/SendMessageProcessor.java", "diffHunk": "@@ -577,6 +577,7 @@ private RemotingCommand handlePutMessageResult(PutMessageResult putMessageResult\n         messageExtBatch.setFlag(requestHeader.getFlag());\n         MessageAccessor.setProperties(messageExtBatch, MessageDecoder.string2messageProperties(requestHeader.getProperties()));\n         messageExtBatch.setBody(request.getBody());\n+        messageExtBatch.setPropertiesString(requestHeader.getProperties());", "originalCommit": "18e2acc4fda9bfdfc73794cb0518653ff407cc05", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3NzYzNw==", "url": "https://github.com/apache/rocketmq/pull/2343#discussion_r503877637", "bodyText": "Yes, I agree with you. My Intention was to avoid another transformation since there was already a transformed string.  I thought that MessageExtBrokerInner is out of the same consideration.", "author": "AVP42", "createdAt": "2020-10-13T11:34:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjg1MTg5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjg1MjYxNg==", "url": "https://github.com/apache/rocketmq/pull/2343#discussion_r502852616", "bodyText": "Just put properties of MessageExtBatch into msgBatchMemory. The original code takes the properties of a single message, so it does not exist.", "author": "RongtongJin", "createdAt": "2020-10-11T01:38:16Z", "path": "store/src/main/java/org/apache/rocketmq/store/CommitLog.java", "diffHunk": "@@ -1871,9 +1878,13 @@ public ByteBuffer encode(final MessageExtBatch messageExtBatch) {\n                 this.msgBatchMemory.put((byte) topicLength);\n                 this.msgBatchMemory.put(topicData);\n                 // 17 PROPERTIES\n-                this.msgBatchMemory.putShort(propertiesLen);\n-                if (propertiesLen > 0)\n+                this.msgBatchMemory.putShort((short) (propertiesLen + batchPropLen));\n+                if (propertiesLen > 0) {\n                     this.msgBatchMemory.put(messagesByteBuff.array(), propertiesPos, propertiesLen);\n+                }\n+                if (batchPropLen > 0) {\n+                    this.msgBatchMemory.put(batchPropData, 0, batchPropLen);\n+                }", "originalCommit": "18e2acc4fda9bfdfc73794cb0518653ff407cc05", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3ODMzNg==", "url": "https://github.com/apache/rocketmq/pull/2343#discussion_r503878336", "bodyText": "Sure.", "author": "AVP42", "createdAt": "2020-10-13T11:35:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjg1MjYxNg=="}], "type": "inlineReview"}, {"oid": "ced727e63abe3b8c5237a7c0fe3ecc3fdc2ecc47", "url": "https://github.com/apache/rocketmq/commit/ced727e63abe3b8c5237a7c0fe3ecc3fdc2ecc47", "message": "[ISSUE# 2330]Undo newly added property in the MessageBatch", "committedDate": "2020-10-13T11:34:29Z", "type": "commit"}]}