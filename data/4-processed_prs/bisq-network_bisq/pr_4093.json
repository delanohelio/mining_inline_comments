{"pr_number": 4093, "pr_title": "Prevent dust outputs from being created during withdraw from wallet", "pr_createdAt": "2020-03-24T14:50:52Z", "pr_url": "https://github.com/bisq-network/bisq/pull/4093", "timeline": [{"oid": "057e2c5e7cbb7c13cfe3b36df2583338cbf2982c", "url": "https://github.com/bisq-network/bisq/commit/057e2c5e7cbb7c13cfe3b36df2583338cbf2982c", "message": "Remove dust outputs created during withdraw from wallet\n\nThis change fixes an issue whereby dust change outputs are\ninadvertently created when users make withdrawals from their\nwallets.  (Funds -> Send Funds)\n\nThe solution taken here is to detect a dust TXO during the withdrawal\nfee estimation process and add that amount to the fee thus eliminating\nthe dust output.\n\nFor example if the user has 1 BTC and goes to withdraw 0.99999900 BTC\nit will detect a change TXO of 100 sats which is below the dust limit,\nincrease the fee by 100 sats and therefore withdraw 1 BTC.\n\nThis fix only applies to user withdrawals from their wallet.  Other\nuse cases such as P2P trading, deposits and fees will be handled\nseparately.\n\nRelated to #4039", "committedDate": "2020-03-24T14:23:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU0MzIwMg==", "url": "https://github.com/bisq-network/bisq/pull/4093#discussion_r398543202", "bodyText": "Better use a constant for values like the dust limit.", "author": "sqrrm", "createdAt": "2020-03-26T12:45:50Z", "path": "desktop/src/main/java/bisq/desktop/main/funds/withdrawal/WithdrawalView.java", "diffHunk": "@@ -629,6 +631,17 @@ public void updateItem(final WithdrawalListItem item, boolean empty) {\n                     }\n                 });\n     }\n+\n+    private Coin getDust(Transaction tx) {\n+        Coin dust = Coin.ZERO;\n+        for (TransactionOutput txo: tx.getOutputs()) {\n+            if (txo.getValue().value < 546) {", "originalCommit": "057e2c5e7cbb7c13cfe3b36df2583338cbf2982c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTg3MDE0Ng==", "url": "https://github.com/bisq-network/bisq/pull/4093#discussion_r399870146", "bodyText": "Changed to use Restrictions.getMinNonDustOutput() which equates to 546 sats", "author": "jmacxx", "createdAt": "2020-03-29T23:30:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU0MzIwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU2MDY1Mg==", "url": "https://github.com/bisq-network/bisq/pull/4093#discussion_r398560652", "bodyText": "The added complexity of the dust on top of the fee makes this code really hard to read. It's not transparent to neither the developer nor the user what will happen here. The dust amount is so low that it's unlikely to cause monetary damage, but users expect a certain amount to be sent and when the dust is added it might cause confusion. (If I got it right,the dust is added as fee or sent amount depending on whether feeExcluded is set or not)\nI suggest making this code easier to follow, and adding a notice to the user that dust might be padded to the fee and make sure it's only padding the fee.", "author": "sqrrm", "createdAt": "2020-03-26T13:13:37Z", "path": "desktop/src/main/java/bisq/desktop/main/funds/withdrawal/WithdrawalView.java", "diffHunk": "@@ -330,8 +331,9 @@ private void onWithdraw() {\n                     feeEstimationTransaction = walletService.getFeeEstimationTransactionForMultipleAddresses(fromAddresses, sendersAmount);\n                 }\n                 checkNotNull(feeEstimationTransaction, \"feeEstimationTransaction must not be null\");\n-                Coin fee = feeEstimationTransaction.getFee();\n-                sendersAmount = feeExcluded ? amountAsCoin.add(fee) : amountAsCoin;\n+                Coin dust = getDust(feeEstimationTransaction);\n+                Coin fee = feeEstimationTransaction.getFee().add(dust);\n+                sendersAmount = feeExcluded ? amountAsCoin.add(fee) : amountAsCoin.add(dust);", "originalCommit": "057e2c5e7cbb7c13cfe3b36df2583338cbf2982c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAxMzI0Mw==", "url": "https://github.com/bisq-network/bisq/pull/4093#discussion_r399013243", "bodyText": "\ud83d\udc4d @sqrrm your suggestions sound great, I am working on implementing them!", "author": "jmacxx", "createdAt": "2020-03-27T03:18:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU2MDY1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTczNTM3Nw==", "url": "https://github.com/bisq-network/bisq/pull/4093#discussion_r399735377", "bodyText": "adding a notice to the user that dust might be padded to the fee\n\nI propose the following message in cases where dust is detected (shown in the following screenshot at the top of the popup):", "author": "jmacxx", "createdAt": "2020-03-29T02:33:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU2MDY1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA4MTk2Mw==", "url": "https://github.com/bisq-network/bisq/pull/4093#discussion_r400081963", "bodyText": "@m52go could you have a look at the user facing language. We're trying to avoid confusion and I feel I might be too deep here to have a good judgement of what a normal user will find helpful and what's just adding to extra confusion.", "author": "sqrrm", "createdAt": "2020-03-30T10:20:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU2MDY1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDE5MTE4Nw==", "url": "https://github.com/bisq-network/bisq/pull/4093#discussion_r400191187", "bodyText": "Seems straightforward to me overall.\n2 small things.\n\n\nsatoshi should be plural. It's already pluralized below in the 'required transaction fee' line\n\n\nmight be nice to change the 2 \"transaction fee\" mentions to \"mining fee\" to be more specific and match the text on the 'send funds' screen", "author": "m52go", "createdAt": "2020-03-30T13:29:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU2MDY1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYwMzQ0MQ==", "url": "https://github.com/bisq-network/bisq/pull/4093#discussion_r400603441", "bodyText": "@m52go @sqrrm your changes have been implemented.", "author": "jmacxx", "createdAt": "2020-03-31T02:19:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU2MDY1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU2MTUyMw==", "url": "https://github.com/bisq-network/bisq/pull/4093#discussion_r398561523", "bodyText": "As an avid log reader, a bit more context will really help understand what's going on here.", "author": "sqrrm", "createdAt": "2020-03-26T13:15:01Z", "path": "desktop/src/main/java/bisq/desktop/main/funds/withdrawal/WithdrawalView.java", "diffHunk": "@@ -629,6 +631,17 @@ public void updateItem(final WithdrawalListItem item, boolean empty) {\n                     }\n                 });\n     }\n+\n+    private Coin getDust(Transaction tx) {\n+        Coin dust = Coin.ZERO;\n+        for (TransactionOutput txo: tx.getOutputs()) {\n+            if (txo.getValue().value < 546) {\n+                dust = dust.add(txo.getValue());\n+                log.info(\"dust TXO = {}\", txo.getValue().toFriendlyString());", "originalCommit": "057e2c5e7cbb7c13cfe3b36df2583338cbf2982c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTczNTUzNw==", "url": "https://github.com/bisq-network/bisq/pull/4093#discussion_r399735537", "bodyText": "Done:\nMar-28 21:25:47.953 [JavaFX Application Thread] INFO  b.d.m.f.w.WithdrawalView: dust TXO = TxOut of 0.000001 BTC to msskpXKKdJdQL82zB76VRU5o5qcoXu1aYf script:DUP HASH160 PUSHDATA(20)[8790aa8150dd74fe091af8253760a23772d2e62a] EQUALVERIFY CHECKSIG \nMar-28 21:25:47.953 [JavaFX Application Thread] INFO  b.d.m.f.w.WithdrawalView: Dust output (100 satoshi) was detected, the dust amount has been added to the fee (was 4068, now 4168)", "author": "jmacxx", "createdAt": "2020-03-29T02:36:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU2MTUyMw=="}], "type": "inlineReview"}, {"oid": "378c57492b5653bb0ce576d3fa3329718fd094c8", "url": "https://github.com/bisq-network/bisq/commit/378c57492b5653bb0ce576d3fa3329718fd094c8", "message": "Address issues raised in review by sqrrm on 2020-03-26\n\n- added a comment describing the `removeDust` method and its effects.\n- use more descriptive variable names.\n- made the logging more verbose to help log readers.\n- use a constant for the dust limit\n- add a notice to the user when dust is padded to the fee", "committedDate": "2020-03-29T02:22:40Z", "type": "commit"}, {"oid": "ea8b327f7be087299420db2011ddc5ee4cc9d1fc", "url": "https://github.com/bisq-network/bisq/commit/ea8b327f7be087299420db2011ddc5ee4cc9d1fc", "message": "Change the constant used to determine what amount is considered dust\n\nNow using `Restrictions.getMinNonDustOutput()` which equates to 546 sats", "committedDate": "2020-03-29T23:23:48Z", "type": "commit"}, {"oid": "f1de0799013ada943cb2f498d3d402977d25b4a7", "url": "https://github.com/bisq-network/bisq/commit/f1de0799013ada943cb2f498d3d402977d25b4a7", "message": "Change wording of the dust informative message per review by m52go\n\nMoved message text into displaystrings.properties", "committedDate": "2020-03-31T02:09:19Z", "type": "commit"}]}