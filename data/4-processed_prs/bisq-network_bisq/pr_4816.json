{"pr_number": 4816, "pr_title": "Fix issues with missing persistence for trade state", "pr_createdAt": "2020-11-18T00:18:39Z", "pr_url": "https://github.com/bisq-network/bisq/pull/4816", "timeline": [{"oid": "6fc36d48dbec360ad6d0b622a579af46f6753361", "url": "https://github.com/bisq-network/bisq/commit/6fc36d48dbec360ad6d0b622a579af46f6753361", "message": "Reduce interval for persistence\n\nSeems the persistence at shutdown is too unsafe and we got bug reports where data was missing.\nhttps://github.com/bisq-network/bisq/issues/4806\n\nUse millisec instead of sec for delay\nRename delayInSec to delay", "committedDate": "2020-11-18T00:15:59Z", "type": "commit"}, {"oid": "fa0c28adf6933a86adabf0f8db52e5e2632276a8", "url": "https://github.com/bisq-network/bisq/commit/fa0c28adf6933a86adabf0f8db52e5e2632276a8", "message": "Add requestPersistence calls\n\nWe relied on the shutdwon routine to be called reliably but it seems that is not the case as some bug reports show.\nSo we call requestPersistence at every write access of the trade object", "committedDate": "2020-11-18T03:35:51Z", "type": "commit"}, {"oid": "9517f427b6d9dd2e1a2b019790fc0a7a4494a992", "url": "https://github.com/bisq-network/bisq/commit/9517f427b6d9dd2e1a2b019790fc0a7a4494a992", "message": "Refactoring: Extract requestPersistence method", "committedDate": "2020-11-18T17:12:59Z", "type": "commit"}, {"oid": "255460e5d502146d420f716737bbaa4de1d84a55", "url": "https://github.com/bisq-network/bisq/commit/255460e5d502146d420f716737bbaa4de1d84a55", "message": "Add more requestPersistence for data changes in ProcessModel and TradingPeer", "committedDate": "2020-11-18T17:38:39Z", "type": "commit"}, {"oid": "6fb36dcd41023381e9a372b5e0b1c789daa62257", "url": "https://github.com/bisq-network/bisq/commit/6fb36dcd41023381e9a372b5e0b1c789daa62257", "message": "Add more requestPersistence calls", "committedDate": "2020-11-18T17:51:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUwMTk4Ng==", "url": "https://github.com/bisq-network/bisq/pull/4816#discussion_r526501986", "bodyText": "I'm getting a NPE here, processModel.tradeManager is null", "author": "jmacxx", "createdAt": "2020-11-18T23:58:17Z", "path": "core/src/main/java/bisq/core/trade/protocol/BuyerAsTakerProtocol.java", "diffHunk": "@@ -65,6 +65,7 @@ public BuyerAsTakerProtocol(BuyerAsTakerTrade trade) {\n \n         Offer offer = checkNotNull(trade.getOffer());\n         processModel.getTradingPeer().setPubKeyRing(offer.getPubKeyRing());\n+        processModel.getTradeManager().requestPersistence();", "originalCommit": "6fb36dcd41023381e9a372b5e0b1c789daa62257", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUyMjc3NA==", "url": "https://github.com/bisq-network/bisq/pull/4816#discussion_r526522774", "bodyText": "Ah in the constructor it must not be called as trademanager is not set yet. I will remove that.", "author": "chimp1984", "createdAt": "2020-11-19T00:59:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUwMTk4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUwMjE4MA==", "url": "https://github.com/bisq-network/bisq/pull/4816#discussion_r526502180", "bodyText": "I get a NPE here, processModel.tradeManager is null.", "author": "jmacxx", "createdAt": "2020-11-18T23:58:50Z", "path": "core/src/main/java/bisq/core/trade/protocol/SellerAsTakerProtocol.java", "diffHunk": "@@ -59,6 +59,7 @@ public SellerAsTakerProtocol(SellerAsTakerTrade trade) {\n         super(trade);\n         Offer offer = checkNotNull(trade.getOffer());\n         processModel.getTradingPeer().setPubKeyRing(offer.getPubKeyRing());\n+        processModel.getTradeManager().requestPersistence();", "originalCommit": "6fb36dcd41023381e9a372b5e0b1c789daa62257", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUyMjgwMA==", "url": "https://github.com/bisq-network/bisq/pull/4816#discussion_r526522800", "bodyText": "Ah in the constructor it must not be called as trademanager is not set yet. I will remove that.", "author": "chimp1984", "createdAt": "2020-11-19T00:59:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUwMjE4MA=="}], "type": "inlineReview"}, {"oid": "438a0d8217d9d86111f7017ba7f3194d69c6aa1c", "url": "https://github.com/bisq-network/bisq/commit/438a0d8217d9d86111f7017ba7f3194d69c6aa1c", "message": "Remove requestPersistence in constructor as TradeManager is not set at that moment.", "committedDate": "2020-11-19T00:58:20Z", "type": "commit"}, {"oid": "706ec5a2ed495e7317956f82c674d0efe255ee2d", "url": "https://github.com/bisq-network/bisq/commit/706ec5a2ed495e7317956f82c674d0efe255ee2d", "message": "Add null checks for tradeManager\n\nWe get called some setter methods from protobuf methods before tradeManager is set.", "committedDate": "2020-11-19T05:07:34Z", "type": "commit"}, {"oid": "da9b42fb839f170374ef48c4e150d3793b81ff29", "url": "https://github.com/bisq-network/bisq/commit/da9b42fb839f170374ef48c4e150d3793b81ff29", "message": "Handle potential deposit confirmed state issues\n\nThe deposit confirmed state is set after we applied the mailbox messages,\nwhich led to a task failure due wrong phase and the message was not applied.\nFurther it can be that the wallet is still syncing and the deposit\nconfirmed state is set in any time in the future.\n\nTo fix the first problem we add a bit of delay so that the trade has\nbeen updated when we apply the mailbox messages. A better fix would be to change\nthe order of the methods but that is a bit tricky to get right and I dont want to\nrisk that for that release.\n\nThe second problem would require a large change to trigger the mailbox\nprocessing based on wallet state. We prefer to be more tolerant with\nthe expected phase instead so allow the mailbox message to be processed\nalso in the DEPOSIT_PUBLISHED state.\nThis has no risks as the payout tx would be invalid anyway if the\nbuyer has cheated and sent the msg in not confirmed deposit tx state (only\npossible with code manipulation).\n\nA better fix would to add a listener for the wallet and process\nthe mailbox msg once wallet is ready and trade state set, but I\nleave that for another PR.", "committedDate": "2020-11-19T05:34:40Z", "type": "commit"}, {"oid": "d6f4eed39e99f810d58e19d546e156aeba319a7c", "url": "https://github.com/bisq-network/bisq/commit/d6f4eed39e99f810d58e19d546e156aeba319a7c", "message": "Add requestPersistence call at TradeTask.complete call.\n\nThis is not really needed as we call it at each state change of the\ntrade but gives more redundancy in case we missed one or once\nchanges are applied and a dev forgets to call it.\n\nMultiple repeated calls do have close to zero costs.", "committedDate": "2020-11-19T14:51:06Z", "type": "commit"}, {"oid": "a4db09fe1deeefdbc22f707a1a51094028f9ebf7", "url": "https://github.com/bisq-network/bisq/commit/a4db09fe1deeefdbc22f707a1a51094028f9ebf7", "message": "Move delay for applying mailbox messages inside onInitialized\n\nWe need to set addDecryptedDirectMessageListener without\ndelay as otherwise we could miss direct messages (detected\nwith localhost testing, with tor its likely slower and\nwould not have been triggered).", "committedDate": "2020-11-19T15:19:48Z", "type": "commit"}]}