{"pr_number": 4611, "pr_title": "New trade statistics", "pr_createdAt": "2020-10-08T23:53:14Z", "pr_url": "https://github.com/bisq-network/bisq/pull/4611", "timeline": [{"oid": "9404e8fa87cc51073823aa2207c23134c2c1d876", "url": "https://github.com/bisq-network/bisq/commit/9404e8fa87cc51073823aa2207c23134c2c1d876", "message": "Add NO_ADDRESS_PRE_FIX capability.\nAdd `boolean contains(Capability capability)` method", "committedDate": "2020-10-08T23:23:00Z", "type": "commit"}, {"oid": "e73a4b4ae44529816407838c70ee79ea704dd138", "url": "https://github.com/bisq-network/bisq/commit/e73a4b4ae44529816407838c70ee79ea704dd138", "message": "Cleanups\n\nRemove debug log, remove annotation", "committedDate": "2020-10-08T23:23:00Z", "type": "commit"}, {"oid": "6f7dfcf4efcdbdd42d2ac56fa1618a4df2b2bed9", "url": "https://github.com/bisq-network/bisq/commit/6f7dfcf4efcdbdd42d2ac56fa1618a4df2b2bed9", "message": "Make onRemoved default in interface", "committedDate": "2020-10-08T23:23:00Z", "type": "commit"}, {"oid": "40f9cfb7c59a448067843717afdb44224edfdadb", "url": "https://github.com/bisq-network/bisq/commit/40f9cfb7c59a448067843717afdb44224edfdadb", "message": "Add methods for getting peers capabilities", "committedDate": "2020-10-08T23:23:00Z", "type": "commit"}, {"oid": "8aec30615922f368e98904fa9c9370cad141876c", "url": "https://github.com/bisq-network/bisq/commit/8aec30615922f368e98904fa9c9370cad141876c", "message": "Remove verification for address prefix\n\nSet address prefix to empty bytes in case we know that peer has capability (updated version)\nBatch process mailbox messages in a thread.\nRefactor handling of mailbox messages", "committedDate": "2020-10-08T23:23:01Z", "type": "commit"}, {"oid": "9821dd62719ea354c3d52edff8c4d57568d946d4", "url": "https://github.com/bisq-network/bisq/commit/9821dd62719ea354c3d52edff8c4d57568d946d4", "message": "Clear capabilitiesListeners at shutdown\nImprove logs", "committedDate": "2020-10-08T23:23:01Z", "type": "commit"}, {"oid": "17974f3dcc358c9ca47f28aec97f4cf6c95f39c5", "url": "https://github.com/bisq-network/bisq/commit/17974f3dcc358c9ca47f28aec97f4cf6c95f39c5", "message": "Refactor: move SupportedCapabilitiesMessage handling code out to a method\nReturn early", "committedDate": "2020-10-08T23:23:01Z", "type": "commit"}, {"oid": "1c07be05074f79b75a0064fee12c6e483762be56", "url": "https://github.com/bisq-network/bisq/commit/1c07be05074f79b75a0064fee12c6e483762be56", "message": "Use only node address for equals and hashcode\nMake capabilities final\n\nIf capability changes we would have had duplicate entries", "committedDate": "2020-10-08T23:23:01Z", "type": "commit"}, {"oid": "bf659a1e6d0d235a2e85e0efab74fff39d6682a9", "url": "https://github.com/bisq-network/bisq/commit/bf659a1e6d0d235a2e85e0efab74fff39d6682a9", "message": "Pass supportedCapabilities to PeerManager. Not further processed yet, will be done in next commits\n\nCleanups", "committedDate": "2020-10-08T23:23:01Z", "type": "commit"}, {"oid": "2523c2e9146c0c26e4a551716dcbecf77c0a2e8b", "url": "https://github.com/bisq-network/bisq/commit/2523c2e9146c0c26e4a551716dcbecf77c0a2e8b", "message": "Use getSingleThreadListeningExecutor, cleanups", "committedDate": "2020-10-08T23:23:01Z", "type": "commit"}, {"oid": "765f9ea940fde8ae0b938c352a96461614131629", "url": "https://github.com/bisq-network/bisq/commit/765f9ea940fde8ae0b938c352a96461614131629", "message": "Apply code inspection suggestions\n\nThe check for AckMessage is not needed anymore as we remove the interface from AckMessage", "committedDate": "2020-10-08T23:23:01Z", "type": "commit"}, {"oid": "186a9d670d33993a31bfba367eba5bb4261f3340", "url": "https://github.com/bisq-network/bisq/commit/186a9d670d33993a31bfba367eba5bb4261f3340", "message": "Add findPeersCapabilities method", "committedDate": "2020-10-08T23:23:01Z", "type": "commit"}, {"oid": "7af16d7af35a4a820e6de8c093dac8b472ff1281", "url": "https://github.com/bisq-network/bisq/commit/7af16d7af35a4a820e6de8c093dac8b472ff1281", "message": "Add getDateAsLong method, add setter for capabilities", "committedDate": "2020-10-08T23:23:01Z", "type": "commit"}, {"oid": "25bfe2d6adf8e0b9e3ecfa180fa05359696f2b54", "url": "https://github.com/bisq-network/bisq/commit/25bfe2d6adf8e0b9e3ecfa180fa05359696f2b54", "message": "Add findPeersCapabilities method\n\nImpl. applyCapabilities\n\nCleanups", "committedDate": "2020-10-08T23:23:02Z", "type": "commit"}, {"oid": "25526750a81dffd2b8c75fae4beb575a6f27b035", "url": "https://github.com/bisq-network/bisq/commit/25526750a81dffd2b8c75fae4beb575a6f27b035", "message": "Replace persistedPeers with peerList", "committedDate": "2020-10-08T23:23:02Z", "type": "commit"}, {"oid": "bf674ea0cf3c67b4dcfd6a2ae437bdd30ed96066", "url": "https://github.com/bisq-network/bisq/commit/bf674ea0cf3c67b4dcfd6a2ae437bdd30ed96066", "message": "Use getPersistedPeers for peerList.getList() calls\nRename getOptionalPersistedPeer to findPersistedPeer\nImprove getConnectedReportedPeers method", "committedDate": "2020-10-08T23:23:02Z", "type": "commit"}, {"oid": "cf0693098f5aee9d2a795ced5a241652882e0709", "url": "https://github.com/bisq-network/bisq/commit/cf0693098f5aee9d2a795ced5a241652882e0709", "message": "Update common/src/main/java/bisq/common/app/Capability.java\n\nCo-authored-by: sqrrm <sqrrm@users.noreply.github.com>", "committedDate": "2020-10-08T23:23:02Z", "type": "commit"}, {"oid": "983f610e730c2417773220deae779b6bfe014cc0", "url": "https://github.com/bisq-network/bisq/commit/983f610e730c2417773220deae779b6bfe014cc0", "message": "Update p2p/src/main/java/bisq/network/p2p/network/Connection.java\n\nCo-authored-by: sqrrm <sqrrm@users.noreply.github.com>", "committedDate": "2020-10-08T23:23:02Z", "type": "commit"}, {"oid": "31e7e2655792b656ee6747919c7fd449a2d96850", "url": "https://github.com/bisq-network/bisq/commit/31e7e2655792b656ee6747919c7fd449a2d96850", "message": "Fix incorrect handling of decryptedEntries size", "committedDate": "2020-10-08T23:23:02Z", "type": "commit"}, {"oid": "4575516d19293fe535eddbd54ef9146d69e6e349", "url": "https://github.com/bisq-network/bisq/commit/4575516d19293fe535eddbd54ef9146d69e6e349", "message": "Refactor: Return early", "committedDate": "2020-10-08T23:23:02Z", "type": "commit"}, {"oid": "ed960aba3fc7a60233c08402cff2ad4d73bc7b01", "url": "https://github.com/bisq-network/bisq/commit/ed960aba3fc7a60233c08402cff2ad4d73bc7b01", "message": "Refactor: Rearrange code, remove unused methods, renamings (no functional change)", "committedDate": "2020-10-08T23:23:02Z", "type": "commit"}, {"oid": "0686079946fe35f15f1ba8d6f8892142c9069550", "url": "https://github.com/bisq-network/bisq/commit/0686079946fe35f15f1ba8d6f8892142c9069550", "message": "Refactor: Rename method", "committedDate": "2020-10-08T23:23:02Z", "type": "commit"}, {"oid": "31ce5ccf671c99adc222c564098a95ee745b53b0", "url": "https://github.com/bisq-network/bisq/commit/31ce5ccf671c99adc222c564098a95ee745b53b0", "message": "Use connection.getPeersNodeAddressOptional().isPresent() instead of connection.hasPeersNodeAddress() which does the same internally", "committedDate": "2020-10-08T23:23:03Z", "type": "commit"}, {"oid": "cfda0aff68f314b14d6d5eb9a59c7c10dfbc4d3c", "url": "https://github.com/bisq-network/bisq/commit/cfda0aff68f314b14d6d5eb9a59c7c10dfbc4d3c", "message": "Fix tests", "committedDate": "2020-10-08T23:23:03Z", "type": "commit"}, {"oid": "351db88992e65eaccb5a545b35c7f1b274e49156", "url": "https://github.com/bisq-network/bisq/commit/351db88992e65eaccb5a545b35c7f1b274e49156", "message": "Use a hashset instead of list to avoid duplicates. Filter out my own node from persisted peers.\n\nRemove log in DisputeAgentManager which gets called repeatedly", "committedDate": "2020-10-08T23:23:03Z", "type": "commit"}, {"oid": "2fd010498d379eee40796196e06811a8c6844148", "url": "https://github.com/bisq-network/bisq/commit/2fd010498d379eee40796196e06811a8c6844148", "message": "Decrease failedConnectionAttempts onConnection\nRename method", "committedDate": "2020-10-08T23:23:03Z", "type": "commit"}, {"oid": "f36a17389e735ec4b80e75f5287d7e5d38c6c112", "url": "https://github.com/bisq-network/bisq/commit/f36a17389e735ec4b80e75f5287d7e5d38c6c112", "message": "Fix incorrect collection used in == 1 check", "committedDate": "2020-10-08T23:23:03Z", "type": "commit"}, {"oid": "b748bffbfe31aa81a524affe997124aad9044dbc", "url": "https://github.com/bisq-network/bisq/commit/b748bffbfe31aa81a524affe997124aad9044dbc", "message": "Add isPresent check", "committedDate": "2020-10-08T23:23:03Z", "type": "commit"}, {"oid": "c7f23e8deb3266502607b682a75afbccba727a1a", "url": "https://github.com/bisq-network/bisq/commit/c7f23e8deb3266502607b682a75afbccba727a1a", "message": "Do not log size as we don't want to call potentially expensive toProtoMessage method", "committedDate": "2020-10-08T23:23:03Z", "type": "commit"}, {"oid": "f53290b8174614efbd031a7e6db69f4e18077bcf", "url": "https://github.com/bisq-network/bisq/commit/f53290b8174614efbd031a7e6db69f4e18077bcf", "message": "Copy peers in a new hashset to avoid concurrent modification exc at serialisation\nRemove final\nCleanups", "committedDate": "2020-10-08T23:23:03Z", "type": "commit"}, {"oid": "447235c2afe2ed1d50bd68ca941e6c41df548ffc", "url": "https://github.com/bisq-network/bisq/commit/447235c2afe2ed1d50bd68ca941e6c41df548ffc", "message": "Dont reassign param", "committedDate": "2020-10-08T23:23:03Z", "type": "commit"}, {"oid": "c88bc1c99c918997b7b2f1ad18330c171a5b3f1c", "url": "https://github.com/bisq-network/bisq/commit/c88bc1c99c918997b7b2f1ad18330c171a5b3f1c", "message": "Use custom class MailboxItem instead of Tuple\nRename mailboxMap to mailboxItemsByUid", "committedDate": "2020-10-08T23:23:04Z", "type": "commit"}, {"oid": "c8feef150e002803799b95b9e121f7854ad699de", "url": "https://github.com/bisq-network/bisq/commit/c8feef150e002803799b95b9e121f7854ad699de", "message": "Apply code review suggestions\nFix incorrectly commented out code (was for dev testing commented out)", "committedDate": "2020-10-08T23:23:04Z", "type": "commit"}, {"oid": "4f685f8f4becfc77e2e3be61645c2cff857668ee", "url": "https://github.com/bisq-network/bisq/commit/4f685f8f4becfc77e2e3be61645c2cff857668ee", "message": "When updating the capability from a reported peer we check if the reported one has higher capabilities, otherwise we ignore it.", "committedDate": "2020-10-08T23:23:04Z", "type": "commit"}, {"oid": "6e3fdbc96ab5c2ab2c58a452b5e42031dca262d6", "url": "https://github.com/bisq-network/bisq/commit/6e3fdbc96ab5c2ab2c58a452b5e42031dca262d6", "message": "Apply codacy suggestions", "committedDate": "2020-10-08T23:23:04Z", "type": "commit"}, {"oid": "00bed02839a0be741dad3eef578c7ad530cda093", "url": "https://github.com/bisq-network/bisq/commit/00bed02839a0be741dad3eef578c7ad530cda093", "message": "Add TradeStatistics3 and related classes\n\nAdd TRADE_STATISTICS_3 Capability\nAdd TradeStatistics3 to proto resolvers\nMake message TradeStatistics2 deprecated", "committedDate": "2020-10-08T23:48:17Z", "type": "commit"}, {"oid": "406bcfb06474831638c975da836a4ca066262df9", "url": "https://github.com/bisq-network/bisq/commit/406bcfb06474831638c975da836a4ca066262df9", "message": "Remove PublishTradeStatistics from buyer protocol\n\nWe let seller publish trade stats to avoid those issues with duplicated entries as trade date is different.\nWe could fix that to use the same trade date,  but it seems to be not needed that both traders are publishing and the\nrisk if a trade stat does not get successfully published does not cause real problems.\nThere is guarantee anyway that the data is broadcast even if both do it.\n\nIn case we still want to do it from both sides we need to use the sellers trade date which is exchanged early in the trade\nprotocol but yet not further used beside for account age check.", "committedDate": "2020-10-08T23:48:17Z", "type": "commit"}, {"oid": "b75aa6771f286d09a227acbcb125bc84d905ae94", "url": "https://github.com/bisq-network/bisq/commit/b75aa6771f286d09a227acbcb125bc84d905ae94", "message": "Refactor: Move class", "committedDate": "2020-10-08T23:48:17Z", "type": "commit"}, {"oid": "a522d0ade9870af3c4a51dc4d6ce59a123e1e34a", "url": "https://github.com/bisq-network/bisq/commit/a522d0ade9870af3c4a51dc4d6ce59a123e1e34a", "message": "Refactor: Rename class", "committedDate": "2020-10-08T23:48:17Z", "type": "commit"}, {"oid": "b2665bdd2cf73659e41fa763f05abb19654560d8", "url": "https://github.com/bisq-network/bisq/commit/b2665bdd2cf73659e41fa763f05abb19654560d8", "message": "let seller publish trade statistics only if peer is updated user. If not the peer will publish only.", "committedDate": "2020-10-08T23:48:52Z", "type": "commit"}, {"oid": "6d43c09b33e4a5de6fb0cae17d3430c13d89b9f1", "url": "https://github.com/bisq-network/bisq/commit/6d43c09b33e4a5de6fb0cae17d3430c13d89b9f1", "message": "Delete TradeStatistics (version 1)", "committedDate": "2020-10-08T23:48:52Z", "type": "commit"}, {"oid": "98207518d61bdabfc3c26a285c096aa6b8df41cc", "url": "https://github.com/bisq-network/bisq/commit/98207518d61bdabfc3c26a285c096aa6b8df41cc", "message": "We \"hack\" TradeStatistics2StorageService to fulfill our needs:\n1. We do not want that initial data request/response use old trades statistics for excluded key hashes.\nThats why we return an empty map in getMap.\n2. We do not read resource file as we have removed that.\n3. We do not persist as we convert the existing data and re-publish as new data, or at startup we convert the old data to the new one and then delete the file.", "committedDate": "2020-10-08T23:48:52Z", "type": "commit"}, {"oid": "c4a4c878b86830adaf8fb20899123034a508a4a2", "url": "https://github.com/bisq-network/bisq/commit/c4a4c878b86830adaf8fb20899123034a508a4a2", "message": "Apply TradeStatistics3 to TradeStatisticsManager and some related classes", "committedDate": "2020-10-08T23:48:52Z", "type": "commit"}, {"oid": "52be1266673675b6dbc5a2fbce96876deb989fc0", "url": "https://github.com/bisq-network/bisq/commit/52be1266673675b6dbc5a2fbce96876deb989fc0", "message": "Apply TradeStatistics3 to client classes", "committedDate": "2020-10-08T23:49:13Z", "type": "commit"}, {"oid": "0e70a99c42a002f6e38a77621e8e18168176196c", "url": "https://github.com/bisq-network/bisq/commit/0e70a99c42a002f6e38a77621e8e18168176196c", "message": "Adjust tests, remove tests which do not make sense anymore", "committedDate": "2020-10-08T23:49:13Z", "type": "commit"}, {"oid": "6766835af61b5cff514c53cee703ee2904ebfd4f", "url": "https://github.com/bisq-network/bisq/commit/6766835af61b5cff514c53cee703ee2904ebfd4f", "message": "Use TradeStatistics3 in protobuf file", "committedDate": "2020-10-08T23:49:14Z", "type": "commit"}, {"oid": "b14266d815ab79b3b15fa925e715d203a0daad7c", "url": "https://github.com/bisq-network/bisq/commit/b14266d815ab79b3b15fa925e715d203a0daad7c", "message": "Remove resource file", "committedDate": "2020-10-08T23:49:14Z", "type": "commit"}, {"oid": "9016cb6c32e355abc100b30a36fc6cd217aea02c", "url": "https://github.com/bisq-network/bisq/commit/9016cb6c32e355abc100b30a36fc6cd217aea02c", "message": "Prune mediator and refund agent entries for all entries beside the last 100 we use for the selection algorithm.", "committedDate": "2020-10-08T23:49:14Z", "type": "commit"}, {"oid": "f56fe42ae13993b472d87f8ac6145b6d2bab9d3d", "url": "https://github.com/bisq-network/bisq/commit/f56fe42ae13993b472d87f8ac6145b6d2bab9d3d", "message": "Add injector.getInstance(TradeStatisticsConverter.class) to BisqExecutable to enforce inclusion.\n\nCleanups, renamings", "committedDate": "2020-10-08T23:49:14Z", "type": "commit"}, {"oid": "fa374b99fb09d5d238c5adec330c9f08861fe693", "url": "https://github.com/bisq-network/bisq/commit/fa374b99fb09d5d238c5adec330c9f08861fe693", "message": "Do conversion in a thread to not block UI thread. takes about 4 seconds on my machine.\nAdd shutdown method to TradeStatisticsConverter and call it via TradeStatisticsManager. Now as we have a reference to TradeStatisticsConverter in we don't need the hack anymore in applyInjector.\nSet log level for com.neemre.btcdcli4j.core.client.ClientConfigurator to error as there is an expected warn log because of the outdated version.", "committedDate": "2020-10-08T23:49:14Z", "type": "commit"}, {"oid": "213050c3d14a658b3035fafce647c328dc658037", "url": "https://github.com/bisq-network/bisq/commit/213050c3d14a658b3035fafce647c328dc658037", "message": "Add filter for excluding null objects", "committedDate": "2020-10-08T23:49:14Z", "type": "commit"}, {"oid": "17f4ae2b541e4700562f3a13faf0d7ff5309911d", "url": "https://github.com/bisq-network/bisq/commit/17f4ae2b541e4700562f3a13faf0d7ff5309911d", "message": "Add check that size is > LOOK_BACK_RANGE", "committedDate": "2020-10-08T23:49:14Z", "type": "commit"}, {"oid": "e95ab2a0b41a6a6b9d986b7118d99fb384f506a1", "url": "https://github.com/bisq-network/bisq/commit/e95ab2a0b41a6a6b9d986b7118d99fb384f506a1", "message": "Add resource file for 1.4.0 (should be updated at release time)", "committedDate": "2020-10-08T23:49:15Z", "type": "commit"}, {"oid": "58d2f1bda92521408757dc55e11662369f14105b", "url": "https://github.com/bisq-network/bisq/commit/58d2f1bda92521408757dc55e11662369f14105b", "message": "Apply codacy suggestions\n\n@ripcurl: The complaint about private constructors (using guice this is legit) should be removed IMO.", "committedDate": "2020-10-08T23:49:15Z", "type": "commit"}, {"oid": "197d8c1e0d78acc638571ea801516b445c4e28bd", "url": "https://github.com/bisq-network/bisq/commit/197d8c1e0d78acc638571ea801516b445c4e28bd", "message": "Remove copy&past mistake", "committedDate": "2020-10-08T23:49:15Z", "type": "commit"}, {"oid": "18a27e90676c91e3b107355e1d85378a56981069", "url": "https://github.com/bisq-network/bisq/commit/18a27e90676c91e3b107355e1d85378a56981069", "message": "Republish trade statistics from seller side if peer capability is know. This is not the case without getting PR #4609 merges as well.\nWe only do it for 2 weeks after planned release time as then it can be assumed that enough nodes have updated that the normal publishing will distribute the object sufficiently.", "committedDate": "2020-10-08T23:49:15Z", "type": "commit"}, {"oid": "68a10cf5a17f914a2e1f9f1d0e559c707d89262e", "url": "https://github.com/bisq-network/bisq/commit/68a10cf5a17f914a2e1f9f1d0e559c707d89262e", "message": "Remove comment line", "committedDate": "2020-10-08T23:51:24Z", "type": "commit"}, {"oid": "66740b7dc1113e72f17c2df15c92e4135568d414", "url": "https://github.com/bisq-network/bisq/commit/66740b7dc1113e72f17c2df15c92e4135568d414", "message": "Remove unused variable", "committedDate": "2020-10-09T00:02:51Z", "type": "commit"}, {"oid": "39c8ade5ef30ac28fe3b465674ea74c3f7efcc98", "url": "https://github.com/bisq-network/bisq/commit/39c8ade5ef30ac28fe3b465674ea74c3f7efcc98", "message": "Cleanups: Remove outdated TODOs, fix typos", "committedDate": "2020-10-09T03:00:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM3ODQxNQ==", "url": "https://github.com/bisq-network/bisq/pull/4611#discussion_r502378415", "bodyText": "Date is not excluded from Json serialization. I think that's correct though since only seller is publishing.\nI think this comment is wrong.", "author": "sqrrm", "createdAt": "2020-10-09T12:00:11Z", "path": "core/src/main/java/bisq/core/trade/statistics/TradeStatistics3.java", "diffHunk": "@@ -0,0 +1,355 @@\n+/*\n+ * This file is part of Bisq.\n+ *\n+ * Bisq is free software: you can redistribute it and/or modify it\n+ * under the terms of the GNU Affero General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or (at\n+ * your option) any later version.\n+ *\n+ * Bisq is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public\n+ * License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with Bisq. If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package bisq.core.trade.statistics;\n+\n+import bisq.core.monetary.Altcoin;\n+import bisq.core.monetary.AltcoinExchangeRate;\n+import bisq.core.monetary.Price;\n+import bisq.core.monetary.Volume;\n+import bisq.core.offer.OfferUtil;\n+\n+import bisq.network.p2p.storage.payload.CapabilityRequiringPayload;\n+import bisq.network.p2p.storage.payload.PersistableNetworkPayload;\n+import bisq.network.p2p.storage.payload.ProcessOncePersistableNetworkPayload;\n+\n+import bisq.common.app.Capabilities;\n+import bisq.common.app.Capability;\n+import bisq.common.crypto.Hash;\n+import bisq.common.proto.ProtoUtil;\n+import bisq.common.util.CollectionUtils;\n+import bisq.common.util.ExtraDataMapValidator;\n+import bisq.common.util.JsonExclude;\n+import bisq.common.util.Utilities;\n+\n+import com.google.protobuf.ByteString;\n+\n+import org.bitcoinj.core.Coin;\n+import org.bitcoinj.utils.ExchangeRate;\n+import org.bitcoinj.utils.Fiat;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.base.Charsets;\n+\n+import java.util.Arrays;\n+import java.util.Date;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+import lombok.Getter;\n+import lombok.extern.slf4j.Slf4j;\n+\n+import javax.annotation.Nullable;\n+\n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n+/**\n+ * This new trade statistics class uses only the bare minimum of data.\n+ * Data size is about 50 bytes in average\n+ */\n+@Slf4j\n+@Getter\n+public final class TradeStatistics3 implements ProcessOncePersistableNetworkPayload, PersistableNetworkPayload,\n+        CapabilityRequiringPayload {\n+\n+    // This enum must not change the order as we use the ordinal for storage to reduce data size.\n+    // The payment method string can be quite long and would consume 15% more space.\n+    // When we get a new payment method we can add it to the enum at the end. Old users would add it as string if not\n+    // recognized.\n+    private enum PaymentMethodMapper {\n+        OK_PAY,\n+        CASH_APP,\n+        VENMO,\n+        AUSTRALIA_PAYID, // seems there is a dev trade\n+        UPHOLD,\n+        MONEY_BEAM,\n+        POPMONEY,\n+        REVOLUT,\n+        PERFECT_MONEY,\n+        SEPA,\n+        SEPA_INSTANT,\n+        FASTER_PAYMENTS,\n+        NATIONAL_BANK,\n+        JAPAN_BANK,\n+        SAME_BANK,\n+        SPECIFIC_BANKS,\n+        SWISH,\n+        ALI_PAY,\n+        WECHAT_PAY,\n+        CLEAR_X_CHANGE,\n+        CHASE_QUICK_PAY,\n+        INTERAC_E_TRANSFER,\n+        US_POSTAL_MONEY_ORDER,\n+        CASH_DEPOSIT,\n+        MONEY_GRAM,\n+        WESTERN_UNION,\n+        HAL_CASH,\n+        F2F,\n+        BLOCK_CHAINS,\n+        PROMPT_PAY,\n+        ADVANCED_CASH,\n+        BLOCK_CHAINS_INSTANT\n+    }\n+\n+    private final String currency;\n+    private final long price;\n+    private final long amount;\n+    private final String paymentMethod;\n+    // As only seller is publishing it is the sellers trade date\n+    private final long date;\n+\n+    // Old converted trade stat objects might not have it set\n+    @Nullable\n+    @JsonExclude\n+    private String mediator;\n+    @Nullable\n+    @JsonExclude\n+    private String refundAgent;\n+\n+    // todo should we add referrerId as well? get added to extra map atm but not used so far\n+\n+    // Hash get set in constructor from json of all the other data fields (with hash = null).\n+    @JsonExclude\n+    private final byte[] hash;\n+    // Should be only used in emergency case if we need to add data but do not want to break backward compatibility\n+    // at the P2P network storage checks. The hash of the object will be used to verify if the data is valid. Any new\n+    // field in a class would break that hash and therefore break the storage mechanism.\n+    @Nullable\n+    @JsonExclude\n+    private final Map<String, String> extraDataMap;\n+\n+    public TradeStatistics3(String currency,\n+                            long price,\n+                            long amount,\n+                            String paymentMethod,\n+                            long date,\n+                            String mediator,\n+                            String refundAgent,\n+                            @Nullable Map<String, String> extraDataMap) {\n+        this(currency,\n+                price,\n+                amount,\n+                paymentMethod,\n+                date,\n+                mediator,\n+                refundAgent,\n+                extraDataMap,\n+                null);\n+    }\n+\n+    // Used from conversion method where we use the hash of the TradeStatistics2 objects to avoid duplicate entries\n+    public TradeStatistics3(String currency,\n+                            long price,\n+                            long amount,\n+                            String paymentMethod,\n+                            long date,\n+                            String mediator,\n+                            String refundAgent,\n+                            @Nullable byte[] hash) {\n+        this(currency,\n+                price,\n+                amount,\n+                paymentMethod,\n+                date,\n+                mediator,\n+                refundAgent,\n+                null,\n+                hash);\n+    }\n+\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+    // PROTO BUFFER\n+    ///////////////////////////////////////////////////////////////////////////////////////////\n+\n+    @VisibleForTesting\n+    public TradeStatistics3(String currency,\n+                            long price,\n+                            long amount,\n+                            String paymentMethod,\n+                            long date,\n+                            @Nullable String mediator,\n+                            @Nullable String refundAgent,\n+                            @Nullable Map<String, String> extraDataMap,\n+                            @Nullable byte[] hash) {\n+        this.currency = currency;\n+        this.price = price;\n+        this.amount = amount;\n+        String tempPaymentMethod;\n+        try {\n+            tempPaymentMethod = String.valueOf(PaymentMethodMapper.valueOf(paymentMethod).ordinal());\n+        } catch (Throwable t) {\n+            tempPaymentMethod = paymentMethod;\n+        }\n+        this.paymentMethod = tempPaymentMethod;\n+        this.date = date;\n+        this.mediator = mediator;\n+        this.refundAgent = refundAgent;\n+        this.extraDataMap = ExtraDataMapValidator.getValidatedExtraDataMap(extraDataMap);\n+\n+        this.hash = hash == null ? createHash() : hash;\n+    }\n+\n+    public byte[] createHash() {\n+        // We create hash from all fields excluding hash itself. We use json as simple data serialisation.\n+        // TradeDate is different for both peers so we ignore it for hash. ExtraDataMap is ignored as well as at", "originalCommit": "39c8ade5ef30ac28fe3b465674ea74c3f7efcc98", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQ4MTk3Mw==", "url": "https://github.com/bisq-network/bisq/pull/4611#discussion_r502481973", "bodyText": "Yes will change the comment.", "author": "chimp1984", "createdAt": "2020-10-09T14:48:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM3ODQxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQ4NzI3MA==", "url": "https://github.com/bisq-network/bisq/pull/4611#discussion_r502487270", "bodyText": "Will add if there is any new bugfix PR...", "author": "chimp1984", "createdAt": "2020-10-09T14:54:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM3ODQxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM3OTY5Nw==", "url": "https://github.com/bisq-network/bisq/pull/4611#discussion_r502379697", "bodyText": "Why not save this as a long? Could set first element as UNKNOWN for clients that haven't upgraded after a new method is added.", "author": "sqrrm", "createdAt": "2020-10-09T12:02:48Z", "path": "core/src/main/java/bisq/core/trade/statistics/TradeStatistics3.java", "diffHunk": "@@ -0,0 +1,355 @@\n+/*\n+ * This file is part of Bisq.\n+ *\n+ * Bisq is free software: you can redistribute it and/or modify it\n+ * under the terms of the GNU Affero General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or (at\n+ * your option) any later version.\n+ *\n+ * Bisq is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public\n+ * License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with Bisq. If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package bisq.core.trade.statistics;\n+\n+import bisq.core.monetary.Altcoin;\n+import bisq.core.monetary.AltcoinExchangeRate;\n+import bisq.core.monetary.Price;\n+import bisq.core.monetary.Volume;\n+import bisq.core.offer.OfferUtil;\n+\n+import bisq.network.p2p.storage.payload.CapabilityRequiringPayload;\n+import bisq.network.p2p.storage.payload.PersistableNetworkPayload;\n+import bisq.network.p2p.storage.payload.ProcessOncePersistableNetworkPayload;\n+\n+import bisq.common.app.Capabilities;\n+import bisq.common.app.Capability;\n+import bisq.common.crypto.Hash;\n+import bisq.common.proto.ProtoUtil;\n+import bisq.common.util.CollectionUtils;\n+import bisq.common.util.ExtraDataMapValidator;\n+import bisq.common.util.JsonExclude;\n+import bisq.common.util.Utilities;\n+\n+import com.google.protobuf.ByteString;\n+\n+import org.bitcoinj.core.Coin;\n+import org.bitcoinj.utils.ExchangeRate;\n+import org.bitcoinj.utils.Fiat;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.base.Charsets;\n+\n+import java.util.Arrays;\n+import java.util.Date;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+import lombok.Getter;\n+import lombok.extern.slf4j.Slf4j;\n+\n+import javax.annotation.Nullable;\n+\n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n+/**\n+ * This new trade statistics class uses only the bare minimum of data.\n+ * Data size is about 50 bytes in average\n+ */\n+@Slf4j\n+@Getter\n+public final class TradeStatistics3 implements ProcessOncePersistableNetworkPayload, PersistableNetworkPayload,\n+        CapabilityRequiringPayload {\n+\n+    // This enum must not change the order as we use the ordinal for storage to reduce data size.\n+    // The payment method string can be quite long and would consume 15% more space.\n+    // When we get a new payment method we can add it to the enum at the end. Old users would add it as string if not\n+    // recognized.\n+    private enum PaymentMethodMapper {\n+        OK_PAY,\n+        CASH_APP,\n+        VENMO,\n+        AUSTRALIA_PAYID, // seems there is a dev trade\n+        UPHOLD,\n+        MONEY_BEAM,\n+        POPMONEY,\n+        REVOLUT,\n+        PERFECT_MONEY,\n+        SEPA,\n+        SEPA_INSTANT,\n+        FASTER_PAYMENTS,\n+        NATIONAL_BANK,\n+        JAPAN_BANK,\n+        SAME_BANK,\n+        SPECIFIC_BANKS,\n+        SWISH,\n+        ALI_PAY,\n+        WECHAT_PAY,\n+        CLEAR_X_CHANGE,\n+        CHASE_QUICK_PAY,\n+        INTERAC_E_TRANSFER,\n+        US_POSTAL_MONEY_ORDER,\n+        CASH_DEPOSIT,\n+        MONEY_GRAM,\n+        WESTERN_UNION,\n+        HAL_CASH,\n+        F2F,\n+        BLOCK_CHAINS,\n+        PROMPT_PAY,\n+        ADVANCED_CASH,\n+        BLOCK_CHAINS_INSTANT\n+    }\n+\n+    private final String currency;\n+    private final long price;\n+    private final long amount;\n+    private final String paymentMethod;", "originalCommit": "39c8ade5ef30ac28fe3b465674ea74c3f7efcc98", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQ4NDE4MQ==", "url": "https://github.com/bisq-network/bisq/pull/4611#discussion_r502484181", "bodyText": "Because its more flexible for future changes. If we add a new method and a not updated user gets that data it will now show the string even the payment method is not included yet, otherwise it would show Unknown.", "author": "chimp1984", "createdAt": "2020-10-09T14:51:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM3OTY5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQ4NTM3Ng==", "url": "https://github.com/bisq-network/bisq/pull/4611#discussion_r502485376", "bodyText": "As we store only the ordinal as string, its from data size same...only when paymentMethod is stored as full string we get a bit more data.", "author": "chimp1984", "createdAt": "2020-10-09T14:52:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM3OTY5Nw=="}], "type": "inlineReview"}]}