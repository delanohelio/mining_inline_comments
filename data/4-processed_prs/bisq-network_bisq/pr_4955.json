{"pr_number": 4955, "pr_title": "Cache results of isFiatCurrency and isCryptoCurrency", "pr_createdAt": "2020-12-15T06:17:06Z", "pr_url": "https://github.com/bisq-network/bisq/pull/4955", "timeline": [{"oid": "5112b1a54b7a8f118e6bcc9c90815aea5f1524ea", "url": "https://github.com/bisq-network/bisq/commit/5112b1a54b7a8f118e6bcc9c90815aea5f1524ea", "message": "Cache results of isFiatCurrency and isCryptoCurrency\n\nThey are called very often and accumulate cpu time as\nshown in profilers.", "committedDate": "2020-12-15T05:54:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzE4MDAyMg==", "url": "https://github.com/bisq-network/bisq/pull/4955#discussion_r543180022", "bodyText": "I think these should be concurrent hash maps, to preserve thread safety (unless it's certain that the two methods will only be called from the user thread).", "author": "stejbac", "createdAt": "2020-12-15T09:26:05Z", "path": "core/src/main/java/bisq/core/locale/CurrencyUtil.java", "diffHunk": "@@ -62,6 +62,10 @@ public static void setup() {\n \n     private static String baseCurrencyCode = \"BTC\";\n \n+    // Calls to isFiatCurrency and isCryptoCurrency are very frequent so we use a cache of the results\n+    private static final Map<String, Boolean> isFiatCurrencyMap = new HashMap<>();\n+    private static final Map<String, Boolean> isCryptoCurrencyMap = new HashMap<>();", "originalCommit": "5112b1a54b7a8f118e6bcc9c90815aea5f1524ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM2ODU4Nw==", "url": "https://github.com/bisq-network/bisq/pull/4955#discussion_r543368587", "bodyText": "Made a commit with the suggestion", "author": "chimp1984", "createdAt": "2020-12-15T14:06:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzE4MDAyMg=="}], "type": "inlineReview"}, {"oid": "0f084d3aece19310d61fd0740d3544491c6478f8", "url": "https://github.com/bisq-network/bisq/commit/0f084d3aece19310d61fd0740d3544491c6478f8", "message": "Use ConcurrentHashMap\nAdd comment", "committedDate": "2020-12-15T14:05:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcyMzcwMw==", "url": "https://github.com/bisq-network/bisq/pull/4955#discussion_r543723703", "bodyText": "100% improvement sounds wrong, 10%?", "author": "sqrrm", "createdAt": "2020-12-15T22:10:45Z", "path": "core/src/main/java/bisq/core/locale/CurrencyUtil.java", "diffHunk": "@@ -62,6 +62,14 @@ public static void setup() {\n \n     private static String baseCurrencyCode = \"BTC\";\n \n+    // Calls to isFiatCurrency and isCryptoCurrency are very frequent so we use a cache of the results.\n+    // The main improvement was already achieved with using memoize for the source maps, but\n+    // the caching still improves performance by about 20% for isCryptoCurrency and about 100%", "originalCommit": "0f084d3aece19310d61fd0740d3544491c6478f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc3OTgxMw==", "url": "https://github.com/bisq-network/bisq/pull/4955#discussion_r543779813", "bodyText": "Wording is a bit bad... old version consumes double the time so new version has a 100% improvement. 1777 ms vs 3467 ms. I will rephrase is....", "author": "chimp1984", "createdAt": "2020-12-16T00:10:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcyMzcwMw=="}], "type": "inlineReview"}, {"oid": "ecad724046160951618e773f0b26acca61f28a22", "url": "https://github.com/bisq-network/bisq/commit/ecad724046160951618e773f0b26acca61f28a22", "message": "Add null checks, improve comment", "committedDate": "2020-12-16T00:08:37Z", "type": "commit"}]}