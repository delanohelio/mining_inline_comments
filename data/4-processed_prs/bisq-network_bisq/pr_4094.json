{"pr_number": 4094, "pr_title": "Prevent dust outputs from being created during the trade process", "pr_createdAt": "2020-03-24T16:50:38Z", "pr_url": "https://github.com/bisq-network/bisq/pull/4094", "timeline": [{"oid": "92530bda5047dff8b57b650d671fa6a756e512d8", "url": "https://github.com/bisq-network/bisq/commit/92530bda5047dff8b57b650d671fa6a756e512d8", "message": "Remove dust outputs created during the trade process\n\nThis change fixes an issue whereby dust change outputs are\ninadvertently created during the trading process, unbenownst to the\nuser.  The dust outputs cause the Bitcoin node to reject the\ntransaction and the trade then becomes stuck.\n\nThe solution taken here is to detect a dust TXO during the trade\nprocess and remove it from the transaction before broadcasting.\n\nRelated to #4039", "committedDate": "2020-03-23T17:56:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc1NTcyMQ==", "url": "https://github.com/bisq-network/bisq/pull/4094#discussion_r398755721", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    List<TransactionOutput> toKeep = new ArrayList<TransactionOutput>();\n          \n          \n            \n                    List<TransactionOutput> toKeep = new ArrayList<>();", "author": "sqrrm", "createdAt": "2020-03-26T17:26:53Z", "path": "core/src/main/java/bisq/core/btc/wallet/TradeWalletService.java", "diffHunk": "@@ -1216,4 +1219,25 @@ private void applyLockTime(long lockTime, Transaction tx) {\n         tx.getInputs().forEach(input -> input.setSequenceNumber(TransactionInput.NO_SEQUENCE - 1));\n         tx.setLockTime(lockTime);\n     }\n+\n+    private boolean removeDust(Transaction tx) {\n+        List<TransactionOutput> txos = tx.getOutputs();\n+        List<TransactionOutput> toKeep = new ArrayList<TransactionOutput>();", "originalCommit": "92530bda5047dff8b57b650d671fa6a756e512d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc1NjQ4NA==", "url": "https://github.com/bisq-network/bisq/pull/4094#discussion_r398756484", "bodyText": "More descriptive variable names are preferred...", "author": "sqrrm", "createdAt": "2020-03-26T17:27:56Z", "path": "core/src/main/java/bisq/core/btc/wallet/TradeWalletService.java", "diffHunk": "@@ -1216,4 +1219,25 @@ private void applyLockTime(long lockTime, Transaction tx) {\n         tx.getInputs().forEach(input -> input.setSequenceNumber(TransactionInput.NO_SEQUENCE - 1));\n         tx.setLockTime(lockTime);\n     }\n+\n+    private boolean removeDust(Transaction tx) {\n+        List<TransactionOutput> txos = tx.getOutputs();", "originalCommit": "92530bda5047dff8b57b650d671fa6a756e512d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc1ODA4Nw==", "url": "https://github.com/bisq-network/bisq/pull/4094#discussion_r398758087", "bodyText": "...especially names like zz are very hard to follow except in the most simple cases. Calling it output or txOutput to make it more readable is preferred.", "author": "sqrrm", "createdAt": "2020-03-26T17:30:05Z", "path": "core/src/main/java/bisq/core/btc/wallet/TradeWalletService.java", "diffHunk": "@@ -1216,4 +1219,25 @@ private void applyLockTime(long lockTime, Transaction tx) {\n         tx.getInputs().forEach(input -> input.setSequenceNumber(TransactionInput.NO_SEQUENCE - 1));\n         tx.setLockTime(lockTime);\n     }\n+\n+    private boolean removeDust(Transaction tx) {\n+        List<TransactionOutput> txos = tx.getOutputs();\n+        List<TransactionOutput> toKeep = new ArrayList<TransactionOutput>();\n+        for (TransactionOutput zz: txos) {", "originalCommit": "92530bda5047dff8b57b650d671fa6a756e512d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc1OTYwMg==", "url": "https://github.com/bisq-network/bisq/pull/4094#discussion_r398759602", "bodyText": "A more verbose log will help log readers.", "author": "sqrrm", "createdAt": "2020-03-26T17:31:47Z", "path": "core/src/main/java/bisq/core/btc/wallet/TradeWalletService.java", "diffHunk": "@@ -1216,4 +1219,25 @@ private void applyLockTime(long lockTime, Transaction tx) {\n         tx.getInputs().forEach(input -> input.setSequenceNumber(TransactionInput.NO_SEQUENCE - 1));\n         tx.setLockTime(lockTime);\n     }\n+\n+    private boolean removeDust(Transaction tx) {\n+        List<TransactionOutput> txos = tx.getOutputs();\n+        List<TransactionOutput> toKeep = new ArrayList<TransactionOutput>();\n+        for (TransactionOutput zz: txos) {\n+            if (zz.getValue().value >= 546) {\n+                toKeep.add(zz);\n+            }\n+            else {\n+                log.info(\"removing dust TXO = {}\", zz.getValue().toFriendlyString());", "originalCommit": "92530bda5047dff8b57b650d671fa6a756e512d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAwNzk1NQ==", "url": "https://github.com/bisq-network/bisq/pull/4094#discussion_r399007955", "bodyText": "Thankyou for the review!  I have made the changes you suggested.  Here is an example of the more verbose logging as a result of this change:", "author": "jmacxx", "createdAt": "2020-03-27T02:56:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc1OTYwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc2MTUzNA==", "url": "https://github.com/bisq-network/bisq/pull/4094#discussion_r398761534", "bodyText": "Please use a more descriptive variable name", "author": "sqrrm", "createdAt": "2020-03-26T17:34:26Z", "path": "core/src/main/java/bisq/core/btc/wallet/TradeWalletService.java", "diffHunk": "@@ -1216,4 +1219,25 @@ private void applyLockTime(long lockTime, Transaction tx) {\n         tx.getInputs().forEach(input -> input.setSequenceNumber(TransactionInput.NO_SEQUENCE - 1));\n         tx.setLockTime(lockTime);\n     }\n+\n+    private boolean removeDust(Transaction tx) {\n+        List<TransactionOutput> txos = tx.getOutputs();\n+        List<TransactionOutput> toKeep = new ArrayList<TransactionOutput>();\n+        for (TransactionOutput zz: txos) {\n+            if (zz.getValue().value >= 546) {\n+                toKeep.add(zz);\n+            }\n+            else {\n+                log.info(\"removing dust TXO = {}\", zz.getValue().toFriendlyString());\n+            }\n+        }\n+        if (toKeep.size() != txos.size()) {\n+            tx.clearOutputs();\n+            for (TransactionOutput zz : toKeep) {", "originalCommit": "92530bda5047dff8b57b650d671fa6a756e512d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bd5044a3151c3a8d78960f5a009d323651c79d0f", "url": "https://github.com/bisq-network/bisq/commit/bd5044a3151c3a8d78960f5a009d323651c79d0f", "message": "Address issues raised in review by sqrrm on 2020-03-26\n\n- added a comment describing the `removeDust` method and its effects.\n- applied a fix to the declaration of an ArrayList.\n- use more descriptive variable names.\n- made the logging more verbose to help log readers.", "committedDate": "2020-03-27T02:40:51Z", "type": "commit"}, {"oid": "4fce853dec2b65f907cb692524a771acc8e36212", "url": "https://github.com/bisq-network/bisq/commit/4fce853dec2b65f907cb692524a771acc8e36212", "message": "Apply the dust fix to trades which use BSQ for the fee\n\nAlso, use `Restrictions.getMinNonDustOutput()` for the dust limit", "committedDate": "2020-03-30T01:23:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA3ODk3Nw==", "url": "https://github.com/bisq-network/bisq/pull/4094#discussion_r400078977", "bodyText": "I think this will cause BSQ change that lower than dust to be used as extra fee. That could be a non trivial amount (5.46 BSQ > USD3). While that's not a huge amount it's still too big to be an acceptable loss for users. If BSQ prices rise it will become even less so.\nI think we'll have to fail transactions that try to pay the fee using BSQ if the change is less than dust. Best would be to show something at the time the fee is selected that it's likely to result in a dust change output and thus not be possible to continue. I think that should be doable, the fees are known at the time of setting up the trade so we can calculate the BSQ dust. One thing we need to do is make sure that if there is enough BSQ but split over 2 or more outputs, it's aggregated to avoid dust outputs. Example, counting satoshis:\nFee: 1000\nBSQ wallet outputs:\n\n1200\n900\n\nI think the tx might be constructed using only outputs 1. leaving a change output of 200, but it would be possible to construct the tx to take both 1. and 2. to pay the 1000 in fee and get the change 1100.", "author": "sqrrm", "createdAt": "2020-03-30T10:15:49Z", "path": "core/src/main/java/bisq/core/btc/wallet/TradeWalletService.java", "diffHunk": "@@ -257,6 +260,7 @@ public Transaction completeBsqTradingFeeTx(Transaction preparedBsqTx,\n         checkNotNull(wallet, \"Wallet must not be null\");\n         wallet.completeTx(sendRequest);\n         Transaction resultTx = sendRequest.tx;\n+        removeDust(resultTx);", "originalCommit": "4fce853dec2b65f907cb692524a771acc8e36212", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI0MDE3Nw==", "url": "https://github.com/bisq-network/bisq/pull/4094#discussion_r400240177", "bodyText": "@sqrrm From what I've seen there is existing code which checks the BSQ for dust before building the transaction (see #3688).  The removeDust insertion here looks at the transaction after it is built, just before broadcasting, to remove any dust change BTC.  I will look more into how it works though.", "author": "jmacxx", "createdAt": "2020-03-30T14:33:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA3ODk3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMzNzExNw==", "url": "https://github.com/bisq-network/bisq/pull/4094#discussion_r400337117", "bodyText": "It's possible the check during tx build is not there but rather later, causing it to look like a bug. Still, that's at least better than burning BSQ unwittingly. If you could check that it's handled properly and not as a bug report that would be best of course.", "author": "sqrrm", "createdAt": "2020-03-30T16:42:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA3ODk3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU3NTYzMA==", "url": "https://github.com/bisq-network/bisq/pull/4094#discussion_r400575630", "bodyText": "At the moment there is only one way to get messages back to the GUI - via the errorMessage property on the Offer which is used by numerous exceptional events.  I looked into reporting warnings back via adding a warningMessage property and will propose that as a new PR to address #3688.  (Its a non-trivial change and I don't want to complicate this PR by adding it in here).", "author": "jmacxx", "createdAt": "2020-03-31T00:37:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA3ODk3Nw=="}], "type": "inlineReview"}]}