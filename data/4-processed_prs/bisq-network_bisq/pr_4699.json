{"pr_number": 4699, "pr_title": "Refactor PendingTradesViewModel methods -> TradeUtil & OfferUtil", "pr_createdAt": "2020-10-25T13:45:01Z", "pr_url": "https://github.com/bisq-network/bisq/pull/4699", "timeline": [{"oid": "cb65de6d2e1497eb8eaf86404fc3285729aba87c", "url": "https://github.com/bisq-network/bisq/commit/cb65de6d2e1497eb8eaf86404fc3285729aba87c", "message": "Block on tx-fee-request in core TakeOfferModel init\n\nAdded license comment too.", "committedDate": "2020-10-23T15:47:06Z", "type": "commit"}, {"oid": "ab20225cd2d50003a8f7f45feca6227a2370a9fb", "url": "https://github.com/bisq-network/bisq/commit/ab20225cd2d50003a8f7f45feca6227a2370a9fb", "message": "Add compiler warning suppression, remove comment", "committedDate": "2020-10-24T19:25:20Z", "type": "commit"}, {"oid": "63cf4369904855013ac5b8e37de43462c02e1551", "url": "https://github.com/bisq-network/bisq/commit/63cf4369904855013ac5b8e37de43462c02e1551", "message": "Add fields to grpc TradeInfo proto & wrapper", "committedDate": "2020-10-24T19:27:03Z", "type": "commit"}, {"oid": "296e4f98cb6231ed2226e72d95c1317981a9d008", "url": "https://github.com/bisq-network/bisq/commit/296e4f98cb6231ed2226e72d95c1317981a9d008", "message": "Replace static TradeUtil with singleton TradeUtil\n\nThe API is going to need some desktop trade utilities, which should be\nshared between :desktop and :core.api.", "committedDate": "2020-10-24T20:26:10Z", "type": "commit"}, {"oid": "ccd3c99f2e5b9cf276e6b70bceb34e73fb0a6858", "url": "https://github.com/bisq-network/bisq/commit/ccd3c99f2e5b9cf276e6b70bceb34e73fb0a6858", "message": "Fix comment typos", "committedDate": "2020-10-24T20:45:01Z", "type": "commit"}, {"oid": "24ba9215cd12f65605b23c2f5d53037258afd019", "url": "https://github.com/bisq-network/bisq/commit/24ba9215cd12f65605b23c2f5d53037258afd019", "message": "Refactor PendingTradesViewModel methods -> TradeUtil & OfferUtil", "committedDate": "2020-10-25T13:41:19Z", "type": "commit"}, {"oid": "36ad1379496d29bf26d6d3c90c4cc50b8c74b928", "url": "https://github.com/bisq-network/bisq/commit/36ad1379496d29bf26d6d3c90c4cc50b8c74b928", "message": "Remove trailing spaces for codacy", "committedDate": "2020-10-25T13:54:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYwOTkxOQ==", "url": "https://github.com/bisq-network/bisq/pull/4699#discussion_r514609919", "bodyText": "I think a check for non null Trade would be good here.", "author": "sqrrm", "createdAt": "2020-10-29T22:45:50Z", "path": "desktop/src/main/java/bisq/desktop/main/portfolio/pendingtrades/PendingTradesViewModel.java", "diffHunk": "@@ -199,55 +205,30 @@ private void onMessageStateChanged(MessageState messageState) {\n     }\n \n     public String getPayoutAmount() {\n-        return dataModel.getTrade() != null ? btcFormatter.formatCoinWithCode(dataModel.getTrade().getPayoutAmount()) : \"\";\n+        return dataModel.getTrade() != null\n+                ? btcFormatter.formatCoinWithCode(dataModel.getTrade().getPayoutAmount())\n+                : \"\";\n     }\n \n     String getMarketLabel(PendingTradesListItem item) {\n-        if ((item == null))\n-            return \"\";\n-\n-        checkNotNull(item.getTrade().getOffer());\n-        checkNotNull(item.getTrade().getOffer().getCurrencyCode());\n-        return CurrencyUtil.getCurrencyPair(item.getTrade().getOffer().getCurrencyCode());\n-    }\n-\n-    private long getMaxTradePeriod() {\n-        return dataModel.getOffer() != null ? dataModel.getOffer().getPaymentMethod().getMaxTradePeriod() : 0;\n-    }\n-\n-    @Nullable\n-    private Date getMaxTradePeriodDate() {\n-        return dataModel.getTrade() != null ? dataModel.getTrade().getMaxTradePeriodDate() : null;\n-    }\n-\n-    @Nullable\n-    private Date getHalfTradePeriodDate() {\n-        return dataModel.getTrade() != null ? dataModel.getTrade().getHalfTradePeriodDate() : null;\n-    }\n-\n-    private long getRemainingTradeDuration() {\n-        return getMaxTradePeriodDate() != null ? getMaxTradePeriodDate().getTime() - new Date().getTime() : getMaxTradePeriod();\n+        return item == null ? \"\" : tradeUtil.getMarketDescription(item.getTrade());\n     }\n \n     public String getRemainingTradeDurationAsWords() {\n-        return FormattingUtils.formatDurationAsWords(Math.max(0, getRemainingTradeDuration()));\n+        return tradeUtil.getRemainingTradeDurationAsWords(dataModel.getTrade());", "originalCommit": "24ba9215cd12f65605b23c2f5d53037258afd019", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYyMDg5NQ==", "url": "https://github.com/bisq-network/bisq/pull/4699#discussion_r514620895", "bodyText": "Fixes for these problems will go into a new 'reviewer's changes' PR based on the last branch in the chain.\nOK with you?", "author": "ghubstan", "createdAt": "2020-10-29T23:17:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYwOTkxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk5MDY5NQ==", "url": "https://github.com/bisq-network/bisq/pull/4699#discussion_r514990695", "bodyText": "Acceptable", "author": "sqrrm", "createdAt": "2020-10-30T10:09:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYwOTkxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTE0MDY1NQ==", "url": "https://github.com/bisq-network/bisq/pull/4699#discussion_r515140655", "bodyText": "Resolved in PR #4731, commit 0656c57.", "author": "ghubstan", "createdAt": "2020-10-30T14:32:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYwOTkxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYxNDA1Mw==", "url": "https://github.com/bisq-network/bisq/pull/4699#discussion_r514614053", "bodyText": "Also no check for null Trade", "author": "sqrrm", "createdAt": "2020-10-29T22:56:45Z", "path": "desktop/src/main/java/bisq/desktop/main/portfolio/pendingtrades/PendingTradesViewModel.java", "diffHunk": "@@ -199,55 +205,30 @@ private void onMessageStateChanged(MessageState messageState) {\n     }\n \n     public String getPayoutAmount() {\n-        return dataModel.getTrade() != null ? btcFormatter.formatCoinWithCode(dataModel.getTrade().getPayoutAmount()) : \"\";\n+        return dataModel.getTrade() != null\n+                ? btcFormatter.formatCoinWithCode(dataModel.getTrade().getPayoutAmount())\n+                : \"\";\n     }\n \n     String getMarketLabel(PendingTradesListItem item) {\n-        if ((item == null))\n-            return \"\";\n-\n-        checkNotNull(item.getTrade().getOffer());\n-        checkNotNull(item.getTrade().getOffer().getCurrencyCode());\n-        return CurrencyUtil.getCurrencyPair(item.getTrade().getOffer().getCurrencyCode());\n-    }\n-\n-    private long getMaxTradePeriod() {\n-        return dataModel.getOffer() != null ? dataModel.getOffer().getPaymentMethod().getMaxTradePeriod() : 0;\n-    }\n-\n-    @Nullable\n-    private Date getMaxTradePeriodDate() {\n-        return dataModel.getTrade() != null ? dataModel.getTrade().getMaxTradePeriodDate() : null;\n-    }\n-\n-    @Nullable\n-    private Date getHalfTradePeriodDate() {\n-        return dataModel.getTrade() != null ? dataModel.getTrade().getHalfTradePeriodDate() : null;\n-    }\n-\n-    private long getRemainingTradeDuration() {\n-        return getMaxTradePeriodDate() != null ? getMaxTradePeriodDate().getTime() - new Date().getTime() : getMaxTradePeriod();\n+        return item == null ? \"\" : tradeUtil.getMarketDescription(item.getTrade());\n     }\n \n     public String getRemainingTradeDurationAsWords() {\n-        return FormattingUtils.formatDurationAsWords(Math.max(0, getRemainingTradeDuration()));\n+        return tradeUtil.getRemainingTradeDurationAsWords(dataModel.getTrade());\n     }\n \n     public double getRemainingTradeDurationAsPercentage() {\n-        long maxPeriod = getMaxTradePeriod();\n-        long remaining = getRemainingTradeDuration();\n-        if (maxPeriod != 0) {\n-            return 1 - (double) remaining / (double) maxPeriod;\n-        } else\n-            return 0;\n+        return tradeUtil.getRemainingTradeDurationAsPercentage(dataModel.getTrade());\n     }\n \n     public String getDateForOpenDispute() {\n-        return DisplayUtils.formatDateTime(new Date(new Date().getTime() + getRemainingTradeDuration()));\n+        return DisplayUtils.formatDateTime(tradeUtil.getDateForOpenDispute(dataModel.getTrade()));", "originalCommit": "24ba9215cd12f65605b23c2f5d53037258afd019", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTE0MDc5Mw==", "url": "https://github.com/bisq-network/bisq/pull/4699#discussion_r515140793", "bodyText": "Resolved in PR #4731, commit 0656c57.", "author": "ghubstan", "createdAt": "2020-10-30T14:32:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYxNDA1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYxNzM4Ng==", "url": "https://github.com/bisq-network/bisq/pull/4699#discussion_r514617386", "bodyText": "Prefer to return early, ie\nif (trade == null)\n    return;\n\nOffer offer = checkNotNull(trade.getOffer());\ncheckNotNull(offer.getPaymentMethod());\nreturn offer.getPaymentMethodNameWithCountryCode();", "author": "sqrrm", "createdAt": "2020-10-29T23:06:45Z", "path": "core/src/main/java/bisq/core/trade/TradeUtil.java", "diffHunk": "@@ -108,4 +118,90 @@ public TradeUtil(BtcWalletService btcWalletService, KeyRing keyRing) {\n \n         return new Tuple2<>(multiSigAddress.getAddressString(), payoutAddress);\n     }\n+\n+    public long getRemainingTradeDuration(Trade trade) {\n+        return trade.getMaxTradePeriodDate() != null\n+                ? trade.getMaxTradePeriodDate().getTime() - new Date().getTime()\n+                : getMaxTradePeriod(trade);\n+    }\n+\n+    public long getMaxTradePeriod(Trade trade) {\n+        return trade.getOffer() != null\n+                ? trade.getOffer().getPaymentMethod().getMaxTradePeriod()\n+                : 0;\n+    }\n+\n+    public double getRemainingTradeDurationAsPercentage(Trade trade) {\n+        long maxPeriod = getMaxTradePeriod(trade);\n+        long remaining = getRemainingTradeDuration(trade);\n+        if (maxPeriod != 0) {\n+            return 1 - (double) remaining / (double) maxPeriod;\n+        } else\n+            return 0;\n+    }\n+\n+    public String getRemainingTradeDurationAsWords(Trade trade) {\n+        return formatDurationAsWords(Math.max(0, getRemainingTradeDuration(trade)));\n+    }\n+\n+    @Nullable\n+    public Date getHalfTradePeriodDate(Trade trade) {\n+        return trade != null ? trade.getHalfTradePeriodDate() : null;\n+    }\n+\n+    public Date getDateForOpenDispute(Trade trade) {\n+        return new Date(new Date().getTime() + getRemainingTradeDuration(trade));\n+    }\n+\n+    public String getMarketDescription(Trade trade) {\n+        if (trade == null)\n+            return \"\";\n+\n+        checkNotNull(trade.getOffer());\n+        checkNotNull(trade.getOffer().getCurrencyCode());\n+        return getCurrencyPair(trade.getOffer().getCurrencyCode());\n+    }\n+\n+    public String getPaymentMethodNameWithCountryCode(Trade trade) {\n+        String paymentMethodDescription = \"\";\n+        if (trade != null) {", "originalCommit": "24ba9215cd12f65605b23c2f5d53037258afd019", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTE0MTQwOA==", "url": "https://github.com/bisq-network/bisq/pull/4699#discussion_r515141408", "bodyText": "Resolved in PR #4731, commit f764e9f.", "author": "ghubstan", "createdAt": "2020-10-30T14:33:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDYxNzM4Ng=="}], "type": "inlineReview"}]}