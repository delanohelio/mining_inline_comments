{"pr_number": 97, "pr_title": "Integration with Ultrawarm - Follow up", "pr_createdAt": "2020-05-01T05:39:23Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/97", "timeline": [{"oid": "840fc07f5e3ac71ad0176fb688d7ad64f7009b33", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/840fc07f5e3ac71ad0176fb688d7ad64f7009b33", "message": "Integration with Ultrawarm - Follow up\n\nThis is a follow up PR to address comments.\n\nTesting done:\n1. gradle build passes\n2. Verified AD runs only in hot nodes.\n3. stats API and HourlyCron still works.", "committedDate": "2020-05-01T05:37:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYyMzkwOA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/97#discussion_r418623908", "bodyText": "question. Just to confirm this if-and-only-if behavior since it is different from the last change, any data nodes that are marked but not marked hot are not eligible? if a data node is marked with some unknown new value, it would be ineligible based on this rule.", "author": "wnbts", "createdAt": "2020-05-01T16:38:51Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/DiscoveryNodeFilterer.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.ad.util;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.function.Predicate;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.cluster.ClusterState;\n+import org.elasticsearch.cluster.node.DiscoveryNode;\n+import org.elasticsearch.cluster.service.ClusterService;\n+\n+import com.amazon.opendistroforelasticsearch.ad.constant.CommonName;\n+\n+public class DiscoveryNodeFilterer {\n+    private static final Logger LOG = LogManager.getLogger(DiscoveryNodeFilterer.class);\n+    private final ClusterService clusterService;\n+\n+    public DiscoveryNodeFilterer(ClusterService clusterService) {\n+        this.clusterService = clusterService;\n+    }\n+\n+    /**\n+     * Find nodes that are elibile to be used by us.  For example, Ultrawarm\n+     *  introduces warm nodes into the ES cluster. Currently, we distribute\n+     *   model partitions to all data nodes in the cluster randomly, which\n+     *    could cause a model performance downgrade issue once warm nodes\n+     *     are throttled due to resource limitations. The PR excludes warm nodes to place model partitions.\n+     * @return an array of eligible data nodes\n+     */\n+    public DiscoveryNode[] getEligibleDataNodes() {\n+        ClusterState state = this.clusterService.state();\n+        final List<DiscoveryNode> eligibleNodes = new ArrayList<>();\n+        final HotDataNodePredicate eligibleNodeFilter = new HotDataNodePredicate();\n+        for (DiscoveryNode node : state.nodes()) {\n+            if (eligibleNodeFilter.test(node)) {\n+                eligibleNodes.add(node);\n+            }\n+        }\n+        return eligibleNodes.toArray(new DiscoveryNode[0]);\n+    }\n+\n+    /**\n+     * @param node a discovery node\n+     * @return whether we should use this node for AD\n+     */\n+    public boolean isEligibleNode(DiscoveryNode node) {\n+        return new HotDataNodePredicate().test(node);\n+    }\n+\n+    static class HotDataNodePredicate implements Predicate<DiscoveryNode> {\n+        @Override\n+        public boolean test(DiscoveryNode discoveryNode) {", "originalCommit": "840fc07f5e3ac71ad0176fb688d7ad64f7009b33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTUzNjMxMw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/97#discussion_r419536313", "bodyText": "Currently, there are only hot and warm data nodes.\nPreviously, if a data node is marked with warm node, we ignore it\nNow, if a data node is marked with hot node or not marked at all, we use it.\nIf a data node is marked with some unknown new value in the future, it would be ineligible.", "author": "kaituo", "createdAt": "2020-05-04T15:48:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYyMzkwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTU2MzY0Mg==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/97#discussion_r419563642", "bodyText": "Suggestion. Since this business logic/decision has important effects on system behavior, it is better to document it. Also, the documentation at line 49 is outdated based on this new change.", "author": "wnbts", "createdAt": "2020-05-04T16:27:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYyMzkwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYyNTUwMw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/97#discussion_r418625503", "bodyText": "issue. this predicate should be instantiated, maybe injected, and reused for calls and should not be instantiated once for every call.", "author": "wnbts", "createdAt": "2020-05-01T16:42:44Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/DiscoveryNodeFilterer.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.ad.util;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.function.Predicate;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.cluster.ClusterState;\n+import org.elasticsearch.cluster.node.DiscoveryNode;\n+import org.elasticsearch.cluster.service.ClusterService;\n+\n+import com.amazon.opendistroforelasticsearch.ad.constant.CommonName;\n+\n+public class DiscoveryNodeFilterer {\n+    private static final Logger LOG = LogManager.getLogger(DiscoveryNodeFilterer.class);\n+    private final ClusterService clusterService;\n+\n+    public DiscoveryNodeFilterer(ClusterService clusterService) {\n+        this.clusterService = clusterService;\n+    }\n+\n+    /**\n+     * Find nodes that are elibile to be used by us.  For example, Ultrawarm\n+     *  introduces warm nodes into the ES cluster. Currently, we distribute\n+     *   model partitions to all data nodes in the cluster randomly, which\n+     *    could cause a model performance downgrade issue once warm nodes\n+     *     are throttled due to resource limitations. The PR excludes warm nodes to place model partitions.\n+     * @return an array of eligible data nodes\n+     */\n+    public DiscoveryNode[] getEligibleDataNodes() {\n+        ClusterState state = this.clusterService.state();\n+        final List<DiscoveryNode> eligibleNodes = new ArrayList<>();\n+        final HotDataNodePredicate eligibleNodeFilter = new HotDataNodePredicate();\n+        for (DiscoveryNode node : state.nodes()) {\n+            if (eligibleNodeFilter.test(node)) {\n+                eligibleNodes.add(node);\n+            }\n+        }\n+        return eligibleNodes.toArray(new DiscoveryNode[0]);\n+    }\n+\n+    /**\n+     * @param node a discovery node\n+     * @return whether we should use this node for AD\n+     */\n+    public boolean isEligibleNode(DiscoveryNode node) {\n+        return new HotDataNodePredicate().test(node);", "originalCommit": "840fc07f5e3ac71ad0176fb688d7ad64f7009b33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTUzNjQyMg==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/97#discussion_r419536422", "bodyText": "good point.  Changed.", "author": "kaituo", "createdAt": "2020-05-04T15:48:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYyNTUwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYyNjE3MA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/97#discussion_r418626170", "bodyText": "suggestion. stream helps improve code efficiency (eliminating need for intermediary data structures, variables creation and operation) and readability.", "author": "wnbts", "createdAt": "2020-05-01T16:44:17Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/DiscoveryNodeFilterer.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.ad.util;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.function.Predicate;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.cluster.ClusterState;\n+import org.elasticsearch.cluster.node.DiscoveryNode;\n+import org.elasticsearch.cluster.service.ClusterService;\n+\n+import com.amazon.opendistroforelasticsearch.ad.constant.CommonName;\n+\n+public class DiscoveryNodeFilterer {\n+    private static final Logger LOG = LogManager.getLogger(DiscoveryNodeFilterer.class);\n+    private final ClusterService clusterService;\n+\n+    public DiscoveryNodeFilterer(ClusterService clusterService) {\n+        this.clusterService = clusterService;\n+    }\n+\n+    /**\n+     * Find nodes that are elibile to be used by us.  For example, Ultrawarm\n+     *  introduces warm nodes into the ES cluster. Currently, we distribute\n+     *   model partitions to all data nodes in the cluster randomly, which\n+     *    could cause a model performance downgrade issue once warm nodes\n+     *     are throttled due to resource limitations. The PR excludes warm nodes to place model partitions.\n+     * @return an array of eligible data nodes\n+     */\n+    public DiscoveryNode[] getEligibleDataNodes() {\n+        ClusterState state = this.clusterService.state();\n+        final List<DiscoveryNode> eligibleNodes = new ArrayList<>();\n+        final HotDataNodePredicate eligibleNodeFilter = new HotDataNodePredicate();\n+        for (DiscoveryNode node : state.nodes()) {", "originalCommit": "840fc07f5e3ac71ad0176fb688d7ad64f7009b33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTUzNjU3NQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/97#discussion_r419536575", "bodyText": "It is personal coding style.  Thanks for the suggestions.", "author": "kaituo", "createdAt": "2020-05-04T15:48:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYyNjE3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYyOTk2MA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/97#discussion_r418629960", "bodyText": "Minor. class documentation is missing. For public classes and methods, the responsibilities should be summarized for clients and readers.", "author": "wnbts", "createdAt": "2020-05-01T16:52:50Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/DiscoveryNodeFilterer.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.ad.util;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.function.Predicate;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.cluster.ClusterState;\n+import org.elasticsearch.cluster.node.DiscoveryNode;\n+import org.elasticsearch.cluster.service.ClusterService;\n+\n+import com.amazon.opendistroforelasticsearch.ad.constant.CommonName;\n+\n+public class DiscoveryNodeFilterer {", "originalCommit": "840fc07f5e3ac71ad0176fb688d7ad64f7009b33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTUzNjcwMw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/97#discussion_r419536703", "bodyText": "done", "author": "kaituo", "createdAt": "2020-05-04T15:48:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYyOTk2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYyODcwNg==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/97#discussion_r418628706", "bodyText": "minor: indentation is not needed in java docs", "author": "sohami", "createdAt": "2020-05-01T16:50:00Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/DiscoveryNodeFilterer.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.ad.util;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.function.Predicate;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.cluster.ClusterState;\n+import org.elasticsearch.cluster.node.DiscoveryNode;\n+import org.elasticsearch.cluster.service.ClusterService;\n+\n+import com.amazon.opendistroforelasticsearch.ad.constant.CommonName;\n+\n+public class DiscoveryNodeFilterer {\n+    private static final Logger LOG = LogManager.getLogger(DiscoveryNodeFilterer.class);\n+    private final ClusterService clusterService;\n+\n+    public DiscoveryNodeFilterer(ClusterService clusterService) {\n+        this.clusterService = clusterService;\n+    }\n+\n+    /**\n+     * Find nodes that are elibile to be used by us.  For example, Ultrawarm\n+     *  introduces warm nodes into the ES cluster. Currently, we distribute\n+     *   model partitions to all data nodes in the cluster randomly, which\n+     *    could cause a model performance downgrade issue once warm nodes\n+     *     are throttled due to resource limitations. The PR excludes warm nodes to place model partitions.\n+     * @return an array of eligible data nodes", "originalCommit": "840fc07f5e3ac71ad0176fb688d7ad64f7009b33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTUzNjc4NA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/97#discussion_r419536784", "bodyText": "Changed.", "author": "kaituo", "createdAt": "2020-05-04T15:48:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYyODcwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYyOTU3MQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/97#discussion_r418629571", "bodyText": "minor: typo nodes r", "author": "sohami", "createdAt": "2020-05-01T16:51:56Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/ml/ModelManager.java", "diffHunk": "@@ -119,7 +119,7 @@ public String getName() {\n     /**\n      * Constructor.\n      *\n-     * @param clusterStateUtils cluster info\n+     * @param nodeFilter utility class to select nodesr", "originalCommit": "840fc07f5e3ac71ad0176fb688d7ad64f7009b33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTUzNjg0Mw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/97#discussion_r419536843", "bodyText": "Changed.", "author": "kaituo", "createdAt": "2020-05-04T15:48:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYyOTU3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYzMzM2MQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/97#discussion_r418633361", "bodyText": "I don't see any UT for this class. Would be great to add some.", "author": "sohami", "createdAt": "2020-05-01T17:00:14Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/DiscoveryNodeFilterer.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistroforelasticsearch.ad.util;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.function.Predicate;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.cluster.ClusterState;\n+import org.elasticsearch.cluster.node.DiscoveryNode;\n+import org.elasticsearch.cluster.service.ClusterService;\n+\n+import com.amazon.opendistroforelasticsearch.ad.constant.CommonName;\n+\n+public class DiscoveryNodeFilterer {", "originalCommit": "840fc07f5e3ac71ad0176fb688d7ad64f7009b33", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTUzNjk4NQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/97#discussion_r419536985", "bodyText": "We have coverage tool to check coverage (75% line and 60% branch coverage). Without enough coverage, build would fail.  This class is covered by its callers\u2019 tests.", "author": "kaituo", "createdAt": "2020-05-04T15:49:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYzMzM2MQ=="}], "type": "inlineReview"}, {"oid": "837b44f4e532a432b2372255b3f7ede55983552b", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/837b44f4e532a432b2372255b3f7ede55983552b", "message": "Address comments", "committedDate": "2020-05-04T15:47:16Z", "type": "commit"}]}