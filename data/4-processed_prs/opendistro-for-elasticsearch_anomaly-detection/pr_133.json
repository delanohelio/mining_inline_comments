{"pr_number": 133, "pr_title": "Add CI/CD workflows", "pr_createdAt": "2020-05-21T21:57:08Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/133", "timeline": [{"oid": "b530acfafd75a5b10c72ed98e3fb88029c78a30f", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/b530acfafd75a5b10c72ed98e3fb88029c78a30f", "message": "Added CI/CD workflows\n\nThis PR adds CI/CD workflows. CI workflow builds a zip file, installs that on the official odfe docker image, and runs rest test case.  CI workflow is triggered via branch pushing.  CD workflow builds zip, rpm, deb files and uploads those files to s3.  CD workflow is triggered via tag creation.\n\nThis PR also increases model initialization waiting time as needed on an rest test case as that time can be can be longer on a remote cluster.\n\nTesting done:\n1. run the scripts on CI/CD workflow on Mac and tested it works.\n2. make sure local gradle build time does not increase.", "committedDate": "2020-05-21T21:44:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM2MzI3Ng==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/133#discussion_r429363276", "bodyText": "if it is timed out, is it better to fail fast?", "author": "wnbts", "createdAt": "2020-05-22T17:13:22Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/ad/e2e/DetectionResultEvalutationIT.java", "diffHunk": "@@ -172,7 +172,22 @@ private void startDetector(\n             } catch (Exception e) {}\n         }\n         Thread.sleep(5_000);\n-        getDetectionResult(detectorId, begin, end, client);\n+        // It takes more time to wait for model initialization on a remote cluster\n+        long startTime = System.currentTimeMillis();\n+        while (true) {\n+            try {\n+                getDetectionResult(detectorId, begin, end, client);\n+                break;\n+            } catch (Exception e) {\n+                long duration = System.currentTimeMillis() - startTime;\n+                // we wait at most 60 secs\n+                if (duration < 60_000) {\n+                    Thread.sleep(2_000);\n+                } else {", "originalCommit": "b530acfafd75a5b10c72ed98e3fb88029c78a30f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTUwMjgxNg==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/133#discussion_r429502816", "bodyText": "yeah, changed to throw exception.", "author": "kaituo", "createdAt": "2020-05-23T01:39:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM2MzI3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM2MzU5Ng==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/133#discussion_r429363596", "bodyText": "this wait can be merged to the wait below now", "author": "wnbts", "createdAt": "2020-05-22T17:14:06Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/ad/e2e/DetectionResultEvalutationIT.java", "diffHunk": "@@ -172,7 +172,22 @@ private void startDetector(\n             } catch (Exception e) {}\n         }\n         Thread.sleep(5_000);", "originalCommit": "b530acfafd75a5b10c72ed98e3fb88029c78a30f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTUwMjgyNw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/133#discussion_r429502827", "bodyText": "merged", "author": "kaituo", "createdAt": "2020-05-23T01:39:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM2MzU5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ5MjM3MQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/133#discussion_r429492371", "bodyText": "This won't run if the first one fails. just wanna confirm if this is what we expect", "author": "weicongs-amazon", "createdAt": "2020-05-22T23:56:58Z", "path": ".github/workflows/CI.yml", "diffHunk": "@@ -0,0 +1,63 @@\n+name: Build and Test Anomaly detection\n+on:\n+  push:\n+    branches:\n+      - master\n+      - opendistro-*\n+\n+jobs:\n+  Build-ad:\n+    strategy:\n+      matrix:\n+        java: [14]\n+\n+    name: Build and Test Anomaly detection Plugin\n+    runs-on: ubuntu-latest\n+\n+    steps:\n+      - name: Checkout AD\n+        uses: actions/checkout@v1\n+\n+      - name: Setup Java ${{ matrix.java }}\n+        uses: actions/setup-java@v1\n+        with:\n+          java-version: ${{ matrix.java }}\n+\n+      - name: Run build\n+        run: |\n+          ./gradlew build\n+          ls -ltr build/distributions/\n+\n+      - name: Pull and Run Docker\n+        run: |\n+          plugin=`ls build/distributions/*.zip`\n+          version=`echo $plugin|awk -F- '{print $4}'| cut -d. -f 1-3`\n+          plugin_version=`echo $plugin|awk -F- '{print $4}'| cut -d. -f 1-4`\n+          echo $version\n+          cd ..\n+\n+          if docker pull opendistroforelasticsearch/opendistroforelasticsearch:$version\n+          then\n+            echo \"FROM opendistroforelasticsearch/opendistroforelasticsearch:$version\" >> Dockerfile\n+\n+            ## The ESRestTest Client uses http by default.\n+            ## Need to disable the security plugin to call the rest api over http.\n+            echo \"RUN if [ -d /usr/share/elasticsearch/plugins/opendistro_security ]; then /usr/share/elasticsearch/bin/elasticsearch-plugin remove opendistro_security; fi\" >> Dockerfile\n+            echo \"RUN if [ -d /usr/share/elasticsearch/plugins/opendistro-anomaly-detection ]; then /usr/share/elasticsearch/bin/elasticsearch-plugin remove opendistro-anomaly-detection; fi\" >> Dockerfile\n+            echo \"ADD anomaly-detection/build/distributions/opendistro-anomaly-detection-$plugin_version.zip /tmp/\" >> Dockerfile\n+            echo \"RUN /usr/share/elasticsearch/bin/elasticsearch-plugin install --batch file:/tmp/opendistro-anomaly-detection-$plugin_version.zip\" >> Dockerfile\n+\n+            docker build -t odfe-ad:test .\n+          fi\n+\n+      - name: Run Docker Image\n+        run: |\n+          cd ..\n+          docker run -p 9200:9200 -d -p 9600:9600 -e \"discovery.type=single-node\" odfe-ad:test\n+          sleep 90\n+          curl -XGET http://localhost:9200/_cat/plugins\n+\n+      - name: Run AD Test\n+        run: |\n+          ./gradlew ':integTestRunner' --tests \"com.amazon.opendistroforelasticsearch.ad.rest.*IT\" -Dtests.rest.cluster=localhost:9200 -Dtests.cluster=localhost:9200 -Dtests.clustername=\"docker-cluster\"\n+          ./gradlew :integTestRunner --tests \"com.amazon.opendistroforelasticsearch.ad.e2e.*IT\"  -Dtests.rest.cluster=localhost:9200 -Dtests.cluster=localhost:9200 -Dtests.clustername=\"docker-cluster\"", "originalCommit": "b530acfafd75a5b10c72ed98e3fb88029c78a30f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTUwNjk0MQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/133#discussion_r429506941", "bodyText": "good point.  Merged these 2 lines into one.", "author": "kaituo", "createdAt": "2020-05-23T02:40:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ5MjM3MQ=="}], "type": "inlineReview"}, {"oid": "02b38770c3b9b078b1d03758c6e5d555e1e363d2", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/02b38770c3b9b078b1d03758c6e5d555e1e363d2", "message": "Merge multiple test commands into one and refactor test case", "committedDate": "2020-05-23T02:39:28Z", "type": "commit"}]}