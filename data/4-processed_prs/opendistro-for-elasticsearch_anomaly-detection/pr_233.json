{"pr_number": 233, "pr_title": "CLI: Update Detector Configurations", "pr_createdAt": "2020-09-14T22:12:43Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/233", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDAwOTg2Mw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/233#discussion_r500009863", "bodyText": "User can only \"restart\" a running detector? If current detector hasn't been started, is it possible user only set \"restart\" as true to start it after update ?\nFrom the description \"Will start detector if update is successful\", it's better to name the flag as \"start\".", "author": "ylwu-amzn", "createdAt": "2020-10-06T05:13:59Z", "path": "cli/cmd/update.go", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package cmd\n+\n+import (\n+\thandler \"esad/internal/handler/ad\"\n+\t\"fmt\"\n+\n+\t\"github.com/spf13/cobra\"\n+)\n+\n+const (\n+\tcommandUpdate = \"update\"\n+\tflagForce     = \"force\"\n+\tflagRestart   = \"restart\"", "originalCommit": "37d4c624ef096e2694ae8ba4e354089ee938dd67", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDYzNTI2NA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/233#discussion_r500635264", "bodyText": "Ack", "author": "VijayanB", "createdAt": "2020-10-06T22:38:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDAwOTg2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDAxMTYyNQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/233#discussion_r500011625", "bodyText": "If \"force\" is false, no need to stop detector.", "author": "ylwu-amzn", "createdAt": "2020-10-06T05:20:56Z", "path": "cli/internal/controller/ad/ad.go", "diffHunk": "@@ -520,3 +521,48 @@ func (c controller) GetDetectorsByName(ctx context.Context, pattern string, disp\n \t}\n \treturn output, nil\n }\n+\n+//UpdateDetector updates detector based on DetectorID, if force is enabled, it overrides without checking whether\n+// user downloaded latest version before updating it, if restart is true, detector will be started after update\n+func (c controller) UpdateDetector(ctx context.Context, input entity.UpdateDetectorUserInput, force bool, restart bool) error {\n+\tif len(input.ID) < 1 {\n+\t\treturn fmt.Errorf(\"detector Id cannot be empty\")\n+\t}\n+\tif !force {\n+\t\tlatestDetector, err := c.GetDetector(ctx, input.ID)\n+\t\tif err != nil {\n+\t\t\treturn err\n+\t\t}\n+\t\tif latestDetector.LastUpdatedAt > input.LastUpdatedAt {\n+\t\t\treturn fmt.Errorf(\n+\t\t\t\t\"new version for detector is available. Please fetch latest version and then merge your changes\")\n+\t\t}\n+\t}\n+\tproceed := c.askForConfirmation(\n+\t\tcmapper.StringToStringPtr(\n+\t\t\tfmt.Sprintf(\n+\t\t\t\t\"esad will update detector: %s . Do you want to proceed? please type (y)es or (n)o and then press enter:\",\n+\t\t\t\tinput.ID,\n+\t\t\t),\n+\t\t),\n+\t)\n+\tif !proceed {\n+\t\treturn nil\n+\t}\n+\terr := c.StopDetector(ctx, input.ID)", "originalCommit": "37d4c624ef096e2694ae8ba4e354089ee938dd67", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDYzMjkwMA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/233#discussion_r500632900", "bodyText": "Ack", "author": "VijayanB", "createdAt": "2020-10-06T22:31:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDAxMTYyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDAxMjc4MQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/233#discussion_r500012781", "bodyText": "Check if detector is running? If detector is running and force is false, we should fail immediately.", "author": "ylwu-amzn", "createdAt": "2020-10-06T05:25:24Z", "path": "cli/internal/controller/ad/ad.go", "diffHunk": "@@ -520,3 +521,48 @@ func (c controller) GetDetectorsByName(ctx context.Context, pattern string, disp\n \t}\n \treturn output, nil\n }\n+\n+//UpdateDetector updates detector based on DetectorID, if force is enabled, it overrides without checking whether\n+// user downloaded latest version before updating it, if restart is true, detector will be started after update\n+func (c controller) UpdateDetector(ctx context.Context, input entity.UpdateDetectorUserInput, force bool, restart bool) error {\n+\tif len(input.ID) < 1 {\n+\t\treturn fmt.Errorf(\"detector Id cannot be empty\")\n+\t}\n+\tif !force {\n+\t\tlatestDetector, err := c.GetDetector(ctx, input.ID)\n+\t\tif err != nil {\n+\t\t\treturn err\n+\t\t}\n+\t\tif latestDetector.LastUpdatedAt > input.LastUpdatedAt {\n+\t\t\treturn fmt.Errorf(\n+\t\t\t\t\"new version for detector is available. Please fetch latest version and then merge your changes\")\n+\t\t}", "originalCommit": "37d4c624ef096e2694ae8ba4e354089ee938dd67", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDYzNDk2Mg==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/233#discussion_r500634962", "bodyText": "Ack.", "author": "VijayanB", "createdAt": "2020-10-06T22:37:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDAxMjc4MQ=="}], "type": "inlineReview"}, {"oid": "31d789a1091915fb9fe2ad40d21fb501525ac0b7", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/31d789a1091915fb9fe2ad40d21fb501525ac0b7", "message": "CLI: Update Detector Gateway\n\nAdd Update detector method to call update rest api.", "committedDate": "2020-10-06T22:30:45Z", "type": "commit"}, {"oid": "17c1a99c3e0bd4a76d977c99f5beff70c5a10749", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/17c1a99c3e0bd4a76d977c99f5beff70c5a10749", "message": "CLI: Update Detector Entity\n\nCreate Update Detector Entity as an alias from Create Detector.", "committedDate": "2020-10-06T22:30:45Z", "type": "commit"}, {"oid": "609edfc57e7cc8c8ea6c45a9c5fdf247b22375b3", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/609edfc57e7cc8c8ea6c45a9c5fdf247b22375b3", "message": "CLI: Update Detector Mapper\n\nAdd mapper function to map user input to request", "committedDate": "2020-10-06T22:30:45Z", "type": "commit"}, {"oid": "7ba6ab89915fa2dea09acd35cad10009d2092ac3", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/7ba6ab89915fa2dea09acd35cad10009d2092ac3", "message": "CLI: Update Detector Controller\n\nAdd controller method to update detecor based on configurations.", "committedDate": "2020-10-06T22:30:45Z", "type": "commit"}, {"oid": "a0b8dac2620f36ff2703c297cc29741d9a6ab80f", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/a0b8dac2620f36ff2703c297cc29741d9a6ab80f", "message": "CLI: Update Detector Input/Output Handler\n\nAdded handler to process user input and call controller method,\nlater process output from controller for command status.", "committedDate": "2020-10-06T22:30:45Z", "type": "commit"}, {"oid": "643f595530ee6895ea2cd4762c17aebba188dbf7", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/643f595530ee6895ea2cd4762c17aebba188dbf7", "message": "CLI: Update Command\n\nCreate Update command to accept update detector's configuration.", "committedDate": "2020-10-06T22:30:45Z", "type": "commit"}, {"oid": "d7ce4180f0c69a87f32f78c785d73435a0e23a08", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/d7ce4180f0c69a87f32f78c785d73435a0e23a08", "message": "Address Feedback\n\nUpdated restart to start\nOnly stop detector if force is true", "committedDate": "2020-10-06T22:30:45Z", "type": "commit"}, {"oid": "d7ce4180f0c69a87f32f78c785d73435a0e23a08", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/d7ce4180f0c69a87f32f78c785d73435a0e23a08", "message": "Address Feedback\n\nUpdated restart to start\nOnly stop detector if force is true", "committedDate": "2020-10-06T22:30:45Z", "type": "forcePushed"}]}