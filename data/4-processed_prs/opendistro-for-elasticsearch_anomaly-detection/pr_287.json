{"pr_number": 287, "pr_title": "Fix for stats API", "pr_createdAt": "2020-10-22T16:35:54Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/287", "timeline": [{"oid": "251a0fcf9f0f9e5ae461ed5bdd6204f6f341d0f2", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/251a0fcf9f0f9e5ae461ed5bdd6204f6f341d0f2", "message": "Add more tests", "committedDate": "2020-10-22T03:53:30Z", "type": "commit"}, {"oid": "aa50ad5c739e6dc7053429ff4be975fa9db0e577", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/aa50ad5c739e6dc7053429ff4be975fa9db0e577", "message": "Fix for stats API\n\nThis PR fixes two issues for the stats API.\n\nFirst, we didn't propagate multi-entity detectors' models execution exceptions for the remote invocation. \u00a0This problem may impact stats' API ability to report the total failures count and thus hide an issue we should have reported during monitoring. \u00a0This PR fixes the issue by collecting model host nodes' exceptions from coordinating nodes.\n\nSecond, we didn't show active multi-entity detectors' models information on stats API.\u00a0 This PR places this information into stats API output.\n\nThis PR also adds unit tests for ModelManager.\n\nTesting done:\n1. added unit tests\n2. manually verified the two issues are resolved.", "committedDate": "2020-10-22T03:53:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDMyNzQyMA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/287#discussion_r510327420", "bodyText": "Clarification: why does this need to be called if nodeCount = responseCount.incrementAndGet?", "author": "jmazanec15", "createdAt": "2020-10-22T17:14:35Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/transport/AnomalyResultTransportAction.java", "diffHunk": "@@ -1015,18 +1022,47 @@ private void coldStart(AnomalyDetector detector) {\n     class EntityResultListener implements ActionListener<AcknowledgedResponse> {\n         private String nodeId;\n         private final String adID;\n+        private AtomicInteger responseCount;\n+        private int nodeCount;\n+        private ActionListener<AnomalyResultResponse> listener;\n+        private ClientException clientException;\n+        private List<AcknowledgedResponse> ackResponses;\n+        private AtomicReference<AnomalyDetectionException> failure;\n \n-        EntityResultListener(String nodeId, String adID) {\n+        EntityResultListener(\n+            String nodeId,\n+            String adID,\n+            AtomicInteger responseCount,\n+            int nodeCount,\n+            AtomicReference<AnomalyDetectionException> failure,\n+            ActionListener<AnomalyResultResponse> listener\n+        ) {\n             this.nodeId = nodeId;\n             this.adID = adID;\n+            this.responseCount = responseCount;\n+            this.nodeCount = nodeCount;\n+            this.failure = failure;\n+            this.listener = listener;\n+            this.clientException = null;\n+            this.ackResponses = new ArrayList<>();\n         }\n \n         @Override\n         public void onResponse(AcknowledgedResponse response) {\n-            stateManager.resetBackpressureCounter(nodeId);\n-            if (response.isAcknowledged() == false) {\n-                LOG.error(\"Cannot send entities' features to {} for {}\", nodeId, adID);\n-                stateManager.addPressure(nodeId);\n+            try {\n+                stateManager.resetBackpressureCounter(nodeId);\n+                if (response.isAcknowledged() == false) {\n+                    LOG.error(\"Cannot send entities' features to {} for {}\", nodeId, adID);\n+                    stateManager.addPressure(nodeId);\n+                } else {\n+                    ackResponses.add(response);\n+                }\n+            } catch (Exception ex) {\n+                LOG.error(\"Unexpected exception: {} for {}\", ex, adID);\n+            } finally {\n+                if (nodeCount == responseCount.incrementAndGet()) {\n+                    handleEntityException();", "originalCommit": "aa50ad5c739e6dc7053429ff4be975fa9db0e577", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDMzMTUwMw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/287#discussion_r510331503", "bodyText": "because I send requests to multiple nodes.  Want to  process all responses after collecting all of them.  responseCount would increment every time I receive a response.  handleEntityException is a bad name.  I'll rename it to handleEntityResponses.", "author": "kaituo", "createdAt": "2020-10-22T17:21:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDMyNzQyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDMyODI2Nw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/287#discussion_r510328267", "bodyText": "Just want to confirm: this wont lead to the same model being printed twice correct? Like a model returned from modelManager wont also be returned but the cache, correct?", "author": "jmazanec15", "createdAt": "2020-10-22T17:15:59Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/stats/suppliers/ModelsOnNodeSupplier.java", "diffHunk": "@@ -45,16 +48,18 @@\n      * Constructor\n      *\n      * @param modelManager object that manages the model partitions hosted on the node\n+     * @param cache object that manages multi-entity detectors' models\n      */\n-    public ModelsOnNodeSupplier(ModelManager modelManager) {\n+    public ModelsOnNodeSupplier(ModelManager modelManager, CacheProvider cache) {\n         this.modelManager = modelManager;\n+        this.cache = cache;\n     }\n \n     @Override\n     public List<Map<String, Object>> get() {\n         List<Map<String, Object>> values = new ArrayList<>();\n-        modelManager\n-            .getAllModels()\n+        Stream\n+            .concat(modelManager.getAllModels().stream(), cache.get().getAllModels().stream())", "originalCommit": "aa50ad5c739e6dc7053429ff4be975fa9db0e577", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDMzMDAxMQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/287#discussion_r510330011", "bodyText": "yeah, it won't.  They have different models.", "author": "kaituo", "createdAt": "2020-10-22T17:18:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDMyODI2Nw=="}], "type": "inlineReview"}, {"oid": "21a8a54623a533ffefa72c72ca110e8368f04ff1", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/21a8a54623a533ffefa72c72ca110e8368f04ff1", "message": "Rename function", "committedDate": "2020-10-22T19:10:28Z", "type": "commit"}, {"oid": "5d27bfb04e9438de9cdf2f330cfce921691bf57c", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/5d27bfb04e9438de9cdf2f330cfce921691bf57c", "message": "remove unused variable", "committedDate": "2020-10-22T20:33:12Z", "type": "commit"}]}