{"pr_number": 340, "pr_title": "Fix the profile API returns prematurely.", "pr_createdAt": "2020-12-23T19:25:04Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/340", "timeline": [{"oid": "4fb17b0470484cd161d4a985a3b95eeaac50c321", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/4fb17b0470484cd161d4a985a3b95eeaac50c321", "message": "Fix the profile API returns prematurely.\n\nMultiResponsesDelegateActionListener helps send multiple requests asynchronously and return one final response altogether. While waiting for all inflight requests, the method respondImmediately and failImmediately can stop waiting and return immediately. While these two methods are convenient, it is easy to misuse them and cause bugs (see https://github.com/opendistro-for-elasticsearch/anomaly-detection/issues/339 for example). This PR removes the method respondImmediately and failImmediately and refactor profile runner to avoid using them.\n\nThis PR also stops printing out the unknown entity state since it is not useful.\n\nTesting done:\n1. Added unit tests to verify the bug fix.\n2. Manual tests to run profile calls for single-stream and multi-entity detectors for different phases of the detector lifecycle (disabled, init, running). Verified profile results make sense.", "committedDate": "2020-12-23T19:23:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODczMTk2Ng==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/340#discussion_r548731966", "bodyText": "why use logger.warn instead of logger.error?", "author": "yizheliu-amazon", "createdAt": "2020-12-24T19:44:06Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/AnomalyDetectorProfileRunner.java", "diffHunk": "@@ -261,20 +258,19 @@ private void profileEntityStats(MultiResponsesDelegateActionListener<DetectorPro\n                 DetectorProfile.Builder profileBuilder = new DetectorProfile.Builder();\n                 DetectorProfile profile = profileBuilder.totalEntities(value).build();\n                 listener.onResponse(profile);\n-            }, searchException -> { listener.failImmediately(CommonErrorMessages.FAIL_TO_GET_TOTAL_ENTITIES + detector.getDetectorId()); })\n-            );\n+            }, searchException -> {\n+                logger.warn(CommonErrorMessages.FAIL_TO_GET_TOTAL_ENTITIES + detector.getDetectorId());", "originalCommit": "4fb17b0470484cd161d4a985a3b95eeaac50c321", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODc0NjEwOA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/340#discussion_r548746108", "bodyText": "It is possible that users haven't created their source index yet.  Since it is a user error, I make it warn instead of error.", "author": "kaituo", "createdAt": "2020-12-24T20:42:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODczMTk2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODczMjQ3NQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/340#discussion_r548732475", "bodyText": "may replace with FAIL_FETCH_ERR_MSG", "author": "yizheliu-amazon", "createdAt": "2020-12-24T19:44:55Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/EntityProfileRunner.java", "diffHunk": "@@ -184,6 +164,25 @@ private void getJob(\n                     ensureExpectedToken(XContentParser.Token.START_OBJECT, parser.nextToken(), parser);\n                     AnomalyDetectorJob job = AnomalyDetectorJob.parse(parser);\n \n+                    int totalResponsesToWait = 0;\n+                    if (profilesToCollect.contains(EntityProfileName.INIT_PROGRESS)\n+                        || profilesToCollect.contains(EntityProfileName.STATE)) {\n+                        totalResponsesToWait++;\n+                    }\n+                    if (profilesToCollect.contains(EntityProfileName.ENTITY_INFO)) {\n+                        totalResponsesToWait++;\n+                    }\n+                    if (profilesToCollect.contains(EntityProfileName.MODELS)) {\n+                        totalResponsesToWait++;\n+                    }\n+                    MultiResponsesDelegateActionListener<EntityProfile> delegateListener =\n+                        new MultiResponsesDelegateActionListener<EntityProfile>(\n+                            listener,\n+                            totalResponsesToWait,\n+                            \"Fail to fetch profile for \" + entityValue + \" of detector \" + detectorId,", "originalCommit": "4fb17b0470484cd161d4a985a3b95eeaac50c321", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODc0NjYyNg==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/340#discussion_r548746626", "bodyText": "replaced", "author": "kaituo", "createdAt": "2020-12-24T20:46:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODczMjQ3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODczNjY2MA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/340#discussion_r548736660", "bodyText": "is it possible for state to be null? Do we still need to keep checking if state is null?", "author": "yizheliu-amazon", "createdAt": "2020-12-24T19:51:25Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/model/EntityProfile.java", "diffHunk": "@@ -214,7 +214,7 @@ public XContentBuilder toXContent(XContentBuilder builder, Params params) throws\n         if (modelProfile != null) {\n             builder.field(CommonName.MODEL, modelProfile);\n         }\n-        if (state != null) {\n+        if (state != EntityState.UNKNOWN) {", "originalCommit": "4fb17b0470484cd161d4a985a3b95eeaac50c321", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODc0NzA2OA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/340#discussion_r548747068", "bodyText": "It is possible.  Added back.", "author": "kaituo", "createdAt": "2020-12-24T20:51:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODczNjY2MA=="}], "type": "inlineReview"}, {"oid": "114c948ec1d1c2f48632725ef98ab45688c43f6e", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/114c948ec1d1c2f48632725ef98ab45688c43f6e", "message": "Add back enum null check and replace string with constant", "committedDate": "2020-12-24T21:14:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkwMjY5OA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/340#discussion_r548902698", "bodyText": "Why not use AnomalyDetectionException here? Same question for other places", "author": "ylwu-amzn", "createdAt": "2020-12-25T19:03:15Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/AnomalyDetectorProfileRunner.java", "diffHunk": "@@ -118,10 +117,38 @@ private void calculateTotalResponsesToWait(\n                 ) {\n                     ensureExpectedToken(XContentParser.Token.START_OBJECT, xContentParser.nextToken(), xContentParser);\n                     AnomalyDetector detector = AnomalyDetector.parse(xContentParser, detectorId);\n+\n+                    prepareProfile(detector, listener, profilesToCollect);\n+                } catch (Exception e) {\n+                    listener.onFailure(new RuntimeException(CommonErrorMessages.FAIL_TO_FIND_DETECTOR_MSG + detectorId, e));\n+                }\n+            } else {\n+                listener.onFailure(new RuntimeException(CommonErrorMessages.FAIL_TO_FIND_DETECTOR_MSG + detectorId));", "originalCommit": "114c948ec1d1c2f48632725ef98ab45688c43f6e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ0OTQ1NQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/340#discussion_r549449455", "bodyText": "I can do it.  Most of transport APIs use AnomalyDetectionException (except the recent ones added by Sarat).  When I reviewed Sarat's PRs, I thought about pointing it out, but didn't because changing to use AnomalyDetectionException does not add too much benefit except that we have standardized the exceptions we throw.  Our public APIs do not standardize the exception it throws back to the user.   Take profile API as an example, sometimes it throws IOException, sometimes NullPointerException, and sometimes RuntimeException.  Do you think we should change all of public APIs and transport APIs to use AnomalyDetectionException?  The benefit is that we can have a standard wrapper exception to throw.  The drawback is that this might be another PR due to the large changes.", "author": "kaituo", "createdAt": "2020-12-28T18:43:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkwMjY5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ3ODA2OA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/340#discussion_r549478068", "bodyText": "Currently we only catch exceptions in AD realtime job and count in failure stats. We may need to count all exceptions from other places, then we need to wrap the exception.\nNo so urgent. We can fix it later.", "author": "ylwu-amzn", "createdAt": "2020-12-28T20:30:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkwMjY5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ4MzEzNA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/340#discussion_r549483134", "bodyText": "Make sense.", "author": "kaituo", "createdAt": "2020-12-28T20:51:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkwMjY5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkwMzAwMw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/340#discussion_r548903003", "bodyText": "When will the entity state be UNKNOWN ?", "author": "ylwu-amzn", "createdAt": "2020-12-25T19:06:43Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/model/EntityProfile.java", "diffHunk": "@@ -214,7 +214,7 @@ public XContentBuilder toXContent(XContentBuilder builder, Params params) throws\n         if (modelProfile != null) {\n             builder.field(CommonName.MODEL, modelProfile);\n         }\n-        if (state != null) {\n+        if (state != null && state != EntityState.UNKNOWN) {", "originalCommit": "114c948ec1d1c2f48632725ef98ab45688c43f6e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ1MDk2OQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/340#discussion_r549450969", "bodyText": "When we cannot get an entity's state.  For example, a user wants to profile an entity's state.  If we cannot find the associated detector's job, I will mark the state as unknown since I find no way to prove it is in INIT or RUNNING.\npublic enum EntityState {\nUNKNOWN,\nINIT,\nRUNNING\n}", "author": "kaituo", "createdAt": "2020-12-28T18:49:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkwMzAwMw=="}], "type": "inlineReview"}]}