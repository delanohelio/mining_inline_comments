{"pr_number": 188, "pr_title": "Implement a REST API for developers to manage CORS at the application level", "pr_createdAt": "2020-07-15T13:08:01Z", "pr_url": "https://github.com/wso2/identity-api-server/pull/188", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjI0NzUxOA==", "url": "https://github.com/wso2/identity-api-server/pull/188#discussion_r456247518", "bodyText": "inline lines 115 and 116", "author": "emswbandara", "createdAt": "2020-07-17T06:38:20Z", "path": "components/org.wso2.carbon.identity.api.server.application.management/org.wso2.carbon.identity.api.server.application.management.common/src/main/java/org/wso2/carbon/identity/api/server/application/management/common/ApplicationManagementServiceHolder.java", "diffHunk": "@@ -110,4 +106,15 @@ public void setTemplateManager(TemplateManager templateManager) {\n \n         ApplicationManagementServiceHolder.templateManager = templateManager;\n     }\n+\n+    public CORSManagementService getCorsManagementService() {\n+\n+        return corsManagementService;\n+    }\n+\n+    public void setCorsManagementService(", "originalCommit": "d3e3dc40473d6833bdbcb13ad76f248ea1b0ce77", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjI0ODI3MQ==", "url": "https://github.com/wso2/identity-api-server/pull/188#discussion_r456248271", "bodyText": "no need to log here.. handleException will log the exception IINM", "author": "emswbandara", "createdAt": "2020-07-17T06:40:22Z", "path": "components/org.wso2.carbon.identity.api.server.application.management/org.wso2.carbon.identity.api.server.application.management.v1/src/main/java/org/wso2/carbon/identity/api/server/application/management/v1/core/functions/application/inbound/oauth2/OAuthInboundFunctions.java", "diffHunk": "@@ -69,30 +95,40 @@ public static InboundAuthenticationRequestConfig putOAuthInbound(ServiceProvider\n                 String updatedClientId = appToUpdate.getOauthConsumerKey();\n                 return createInboundAuthRequestConfig(updatedClientId);\n             } else {\n+                // Create a new application.\n                 return createOAuthInbound(application.getApplicationName(), oidcConfigModel);\n             }\n \n-        } catch (IdentityOAuthAdminException e) {\n-            throw handleOAuthException(e);\n+        } catch (IdentityOAuthAdminException | CORSManagementServiceException e) {\n+            if (e instanceof IdentityOAuthAdminException) {\n+                // If an IdentityOAuthAdminException exception is thrown after the CORS update, then the application\n+                // update has failed. Therefore rollback the update on CORS origins.\n+                try {\n+                    ApplicationManagementServiceHolder.getInstance()\n+                            .getCorsManagementService().setApplicationCORSOrigins(tenantDomain,\n+                            String.valueOf(application.getApplicationID()), existingCORSOrigins);\n+                } catch (CORSManagementServiceException corsManagementServiceException) {\n+                    log.error(\"Failed to update the CORS origins on rollback.\", e);", "originalCommit": "d3e3dc40473d6833bdbcb13ad76f248ea1b0ce77", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjI0OTI5NQ==", "url": "https://github.com/wso2/identity-api-server/pull/188#discussion_r456249295", "bodyText": "shall we remove unncessary new lines to be consistent of previously defined error enums", "author": "emswbandara", "createdAt": "2020-07-17T06:43:02Z", "path": "components/org.wso2.carbon.identity.api.server.configs/org.wso2.carbon.identity.api.server.configs.common/src/main/java/org/wso2/carbon/identity/api/server/configs/common/Constants.java", "diffHunk": "@@ -46,13 +62,49 @@ private Constants() {\n         ERROR_CODE_ERROR_RETRIEVING_AUTHENTICATOR(\"65003\",\n                 \"Unable to retrieve authenticator.\",\n                 \"Server encountered an error while retrieving the authenticator for the identifier %s.\"),\n-        ERROR_CODE_AUTHENTICATOR_NOT_FOUND(\"60002\", \"Resource not found.\",\n+        ERROR_CODE_AUTHENTICATOR_NOT_FOUND(\"60002\",\n+                \"Resource not found.\",\n                 \"Unable to find a resource matching the provided authenticator identifier %s.\"),\n-        ERROR_CODE_INVALID_INPUT(\"60003\", \"Invalid input.\", \"One of the given inputs is invalid. %s.\"),\n-        ERROR_CODE_ERROR_UPDATING_CONFIGS(\"65004\", \"Unable to update server configs.\", \"Server encountered an \" +\n+        ERROR_CODE_INVALID_INPUT(\"60003\",\n+                \"Invalid input.\",\n+                \"One of the given inputs is invalid. %s.\"),\n+        ERROR_CODE_ERROR_UPDATING_CONFIGS(\"65004\",\n+                \"Unable to update server configs.\",\n+                \"Server encountered an \" +\n                 \"error while updating the server configs.\"),\n-        ERROR_CODE_ERROR_RETRIEVING_CONFIGS(\"65005\", \"Unable to retrieve server configs.\", \"Server encountered an \" +\n-                \"error while retrieving the server configs.\");\n+        ERROR_CODE_ERROR_RETRIEVING_CONFIGS(\"65005\",\n+                \"Unable to retrieve server configs.\",\n+                \"Server encountered an \" +\n+                \"error while retrieving the server configs.\"),\n+\n+        //TODO: What should be the error prefix?\n+        /**\n+         * Unable to retrieve CORS origins.\n+         */\n+        ERROR_CODE_CORS_CONFIG_RETRIEVE(\"RST-65001\",\n+                \"Unable to retrieve CORS configuration.\",\n+                \"Server encountered an error while retrieving the CORS configuration.\"),\n+", "originalCommit": "d3e3dc40473d6833bdbcb13ad76f248ea1b0ce77", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjI1MDY3MA==", "url": "https://github.com/wso2/identity-api-server/pull/188#discussion_r456250670", "bodyText": "add license header", "author": "emswbandara", "createdAt": "2020-07-17T06:46:26Z", "path": "components/org.wso2.carbon.identity.api.server.configs/org.wso2.carbon.identity.api.server.configs.v1/src/main/java/org/wso2/carbon/identity/api/server/configs/v1/function/CORSConfigurationToCORSConfig.java", "diffHunk": "@@ -0,0 +1,30 @@\n+package org.wso2.carbon.identity.api.server.configs.v1.function;", "originalCommit": "d3e3dc40473d6833bdbcb13ad76f248ea1b0ce77", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjI1MDg2Mg==", "url": "https://github.com/wso2/identity-api-server/pull/188#discussion_r456250862", "bodyText": "add license header", "author": "emswbandara", "createdAt": "2020-07-17T06:46:52Z", "path": "components/org.wso2.carbon.identity.api.server.configs/org.wso2.carbon.identity.api.server.configs.v1/src/main/java/org/wso2/carbon/identity/api/server/configs/v1/function/CORSOriginToCORSOriginGetObject.java", "diffHunk": "@@ -0,0 +1,23 @@\n+package org.wso2.carbon.identity.api.server.configs.v1.function;", "originalCommit": "d3e3dc40473d6833bdbcb13ad76f248ea1b0ce77", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjI1MTIyMw==", "url": "https://github.com/wso2/identity-api-server/pull/188#discussion_r456251223", "bodyText": "why was this changed?", "author": "emswbandara", "createdAt": "2020-07-17T06:47:45Z", "path": "components/org.wso2.carbon.identity.api.server.configs/org.wso2.carbon.identity.api.server.configs.v1/src/main/resources/configs.yaml", "diffHunk": "@@ -14,7 +14,7 @@ security:\n   - OAuth2: []\n   - BasicAuth: []\n paths:\n-  /configs:\n+  /configs/:", "originalCommit": "d3e3dc40473d6833bdbcb13ad76f248ea1b0ce77", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "26c01aaee8dd90b64e818bb3be64f84da9ea3990", "url": "https://github.com/wso2/identity-api-server/commit/26c01aaee8dd90b64e818bb3be64f84da9ea3990", "message": "Add CORS API for developers", "committedDate": "2020-07-17T09:43:14Z", "type": "forcePushed"}, {"oid": "e164d6e1af7c476ca265c9a7865d15a76e3ecd0f", "url": "https://github.com/wso2/identity-api-server/commit/e164d6e1af7c476ca265c9a7865d15a76e3ecd0f", "message": "Add CORS API for developers", "committedDate": "2020-07-17T09:45:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM0MDg4NQ==", "url": "https://github.com/wso2/identity-api-server/pull/188#discussion_r456340885", "bodyText": "better to use a multi-line comment here.", "author": "dewniMW", "createdAt": "2020-07-17T09:50:32Z", "path": "components/org.wso2.carbon.identity.api.server.application.management/org.wso2.carbon.identity.api.server.application.management.v1/src/main/java/org/wso2/carbon/identity/api/server/application/management/v1/core/functions/application/inbound/oauth2/OAuthInboundFunctions.java", "diffHunk": "@@ -69,30 +95,39 @@ public static InboundAuthenticationRequestConfig putOAuthInbound(ServiceProvider\n                 String updatedClientId = appToUpdate.getOauthConsumerKey();\n                 return createInboundAuthRequestConfig(updatedClientId);\n             } else {\n+                // Create a new application.\n                 return createOAuthInbound(application.getApplicationName(), oidcConfigModel);\n             }\n \n-        } catch (IdentityOAuthAdminException e) {\n-            throw handleOAuthException(e);\n+        } catch (IdentityOAuthAdminException | CORSManagementServiceException e) {\n+            if (e instanceof IdentityOAuthAdminException) {\n+                // If an IdentityOAuthAdminException exception is thrown after the CORS update, then the application\n+                // update has failed. Therefore rollback the update on CORS origins.", "originalCommit": "e164d6e1af7c476ca265c9a7865d15a76e3ecd0f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1d7dfe0dbe9fcbd799bf13ad17477b382e1c6f96", "url": "https://github.com/wso2/identity-api-server/commit/1d7dfe0dbe9fcbd799bf13ad17477b382e1c6f96", "message": "Add CORS API for developers", "committedDate": "2020-07-21T03:30:48Z", "type": "forcePushed"}, {"oid": "2f1a5a45bf9da858254873884fb5ae161b0ce68d", "url": "https://github.com/wso2/identity-api-server/commit/2f1a5a45bf9da858254873884fb5ae161b0ce68d", "message": "Add CORS API for developers", "committedDate": "2020-07-21T03:32:50Z", "type": "forcePushed"}, {"oid": "887d5381ad4103344b39698d583a468b657d208d", "url": "https://github.com/wso2/identity-api-server/commit/887d5381ad4103344b39698d583a468b657d208d", "message": "Add CORS API for developers", "committedDate": "2020-07-22T06:07:48Z", "type": "forcePushed"}, {"oid": "6296257581a3fd55170d7dd72fa53cd6552eaceb", "url": "https://github.com/wso2/identity-api-server/commit/6296257581a3fd55170d7dd72fa53cd6552eaceb", "message": "Add CORS API for developers", "committedDate": "2020-07-22T10:21:28Z", "type": "forcePushed"}, {"oid": "b039927ad66610df2a452f788a217d16ddd9a94f", "url": "https://github.com/wso2/identity-api-server/commit/b039927ad66610df2a452f788a217d16ddd9a94f", "message": "Add CORS API for developers", "committedDate": "2020-07-28T10:26:31Z", "type": "forcePushed"}, {"oid": "98e0dbe68bb162d51bfc33ee343a52efb5b990df", "url": "https://github.com/wso2/identity-api-server/commit/98e0dbe68bb162d51bfc33ee343a52efb5b990df", "message": "Add CORS API for developers", "committedDate": "2020-08-05T02:56:38Z", "type": "forcePushed"}, {"oid": "143eeb50f46c2a7da30f4b416e7573a11f6f61eb", "url": "https://github.com/wso2/identity-api-server/commit/143eeb50f46c2a7da30f4b416e7573a11f6f61eb", "message": "Add CORS API for developers", "committedDate": "2020-08-05T03:31:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY2MjUxOA==", "url": "https://github.com/wso2/identity-api-server/pull/188#discussion_r465662518", "bodyText": "Shall we add a constant for \"oauth2\"?", "author": "ashensw", "createdAt": "2020-08-05T11:34:30Z", "path": "components/org.wso2.carbon.identity.api.server.application.management/org.wso2.carbon.identity.api.server.application.management.v1/src/main/java/org/wso2/carbon/identity/api/server/application/management/v1/core/functions/application/inbound/oauth2/OAuthInboundFunctions.java", "diffHunk": "@@ -131,22 +169,68 @@ public static OpenIDConnectConfiguration getOAuthConfiguration(InboundAuthentica\n             OAuthConsumerAppDTO oauthApp =\n                     ApplicationManagementServiceHolder.getInstance().getOAuthAdminService().getOAuthApplicationData\n                             (clientId);\n-            return new OAuthConsumerAppToApiModel().apply(oauthApp);\n \n-        } catch (IdentityOAuthAdminException e) {\n+            OpenIDConnectConfiguration openIDConnectConfiguration = new OAuthConsumerAppToApiModel().apply(oauthApp);\n+\n+            // Set CORS origins as allowed domains.\n+            String tenantDomain = ContextLoader.getTenantDomainFromContext();\n+            String applicationResourceId = ApplicationManagementServiceHolder.getInstance()\n+                    .getApplicationManagementService()\n+                    .getServiceProviderByClientId(clientId, \"oauth2\", tenantDomain).getApplicationResourceId();", "originalCommit": "143eeb50f46c2a7da30f4b416e7573a11f6f61eb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "09b7b0a666c449bde5853aeec1bf7d1b07a319fb", "url": "https://github.com/wso2/identity-api-server/commit/09b7b0a666c449bde5853aeec1bf7d1b07a319fb", "message": "Add CORS API for developers", "committedDate": "2020-08-05T17:06:11Z", "type": "forcePushed"}, {"oid": "45ece91274d72ad69c76df9fd45fa7c188c3567d", "url": "https://github.com/wso2/identity-api-server/commit/45ece91274d72ad69c76df9fd45fa7c188c3567d", "message": "Add CORS API for developers", "committedDate": "2020-08-06T14:41:19Z", "type": "commit"}, {"oid": "45ece91274d72ad69c76df9fd45fa7c188c3567d", "url": "https://github.com/wso2/identity-api-server/commit/45ece91274d72ad69c76df9fd45fa7c188c3567d", "message": "Add CORS API for developers", "committedDate": "2020-08-06T14:41:19Z", "type": "forcePushed"}]}