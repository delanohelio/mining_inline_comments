{"pr_number": 687, "pr_title": "Service configuration validation ", "pr_createdAt": "2020-06-03T15:17:34Z", "pr_url": "https://github.com/zowe/api-layer/pull/687", "timeline": [{"oid": "7254c0c59621f12ae68d86783e73cdd2cb6c5bee", "url": "https://github.com/zowe/api-layer/commit/7254c0c59621f12ae68d86783e73cdd2cb6c5bee", "message": "Enhancement of validator and more unit tests\n\nSigned-off-by: at670475 <andrea.tabone@broadcom.com>", "committedDate": "2020-06-04T09:13:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEwOTQwNw==", "url": "https://github.com/zowe/api-layer/pull/687#discussion_r435109407", "bodyText": "I would keep only the ServiceDefinitionException.", "author": "balhar-jakub", "createdAt": "2020-06-04T09:14:45Z", "path": "onboarding-enabler-java/src/main/java/org/zowe/apiml/eurekaservice/client/ApiMediationClient.java", "diffHunk": "@@ -26,7 +28,7 @@\n      * @param config\n      * @throws ServiceDefinitionException - checked exception encapsulating the real reason why registration has failed.\n      */\n-    void register(ApiMediationServiceConfig config) throws ServiceDefinitionException;\n+    void register(ApiMediationServiceConfig config) throws ServiceDefinitionException, MalformedURLException;\n ", "originalCommit": "76be3cd8bc2e9039eace4260af5c99027d2ca82b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTExMDcwOA==", "url": "https://github.com/zowe/api-layer/pull/687#discussion_r435110708", "bodyText": "I would catch the Exception here and then throw a RuntimeException as the failure should never happen here", "author": "balhar-jakub", "createdAt": "2020-06-04T09:16:53Z", "path": "onboarding-enabler-java/src/main/java/org/zowe/apiml/eurekaservice/client/util/EurekaInstanceConfigCreator.java", "diffHunk": "@@ -27,21 +27,14 @@\n \n public class EurekaInstanceConfigCreator {\n \n-    public EurekaInstanceConfig createEurekaInstanceConfig(ApiMediationServiceConfig config) throws ServiceDefinitionException {\n+    public EurekaInstanceConfig createEurekaInstanceConfig(ApiMediationServiceConfig config) throws ServiceDefinitionException, MalformedURLException {\n+        EurekaInstanceConfigValidator eurekaInstanceConfigValidator = new EurekaInstanceConfigValidator();\n+        eurekaInstanceConfigValidator.validate(config);\n         ApimlEurekaInstanceConfig result = new ApimlEurekaInstanceConfig();\n \n-        String hostname;\n-        int port;\n-        URL baseUrl;\n-\n-        try {\n-            baseUrl = new URL(config.getBaseUrl());\n-            hostname = baseUrl.getHost();\n-            port = baseUrl.getPort();\n-        } catch (MalformedURLException e) {\n-            String message = String.format(\"baseUrl: [%s] is not valid URL\", config.getBaseUrl());\n-            throw new ServiceDefinitionException(message, e);\n-        }\n+        URL baseUrl = new URL(config.getBaseUrl());", "originalCommit": "7254c0c59621f12ae68d86783e73cdd2cb6c5bee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTExMTYzOQ==", "url": "https://github.com/zowe/api-layer/pull/687#discussion_r435111639", "bodyText": "What about extracting it to something like:\nprivate boolean isInvalid(String value) {\nreturn value == null || value.isEmpty() || value.contains(\"{apiml.\")\n}\nThis way you could use it for verification of all the properties", "author": "balhar-jakub", "createdAt": "2020-06-04T09:18:24Z", "path": "onboarding-enabler-java/src/main/java/org/zowe/apiml/eurekaservice/client/util/EurekaInstanceConfigValidator.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * This program and the accompanying materials are made available under the terms of the\n+ * Eclipse Public License v2.0 which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-v20.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Copyright Contributors to the Zowe Project.\n+ */\n+\n+package org.zowe.apiml.eurekaservice.client.util;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.zowe.apiml.eurekaservice.client.config.ApiMediationServiceConfig;\n+import org.zowe.apiml.eurekaservice.client.config.Route;\n+import org.zowe.apiml.eurekaservice.client.config.Ssl;\n+import org.zowe.apiml.exception.MetadataValidationException;\n+\n+import java.net.MalformedURLException;\n+import java.net.URL;\n+import java.util.List;\n+\n+/**\n+ * Class that validates a service configuration before the registration with API ML\n+ */\n+@Slf4j\n+public class EurekaInstanceConfigValidator {\n+\n+    /**\n+     * Validation method that validates mandatory and non-mandatory parameters\n+     * @param config\n+     * @throws MetadataValidationException if the validation fails\n+     */\n+    public void validate(ApiMediationServiceConfig config) {\n+        URL baseUrl;\n+        validateRoutes(config.getRoutes());\n+\n+        validateSsl(config.getSsl());\n+\n+        try {\n+            baseUrl = new URL(config.getBaseUrl());\n+            baseUrl.getHost();\n+            baseUrl.getPort();\n+        } catch (MalformedURLException e) {\n+            String message = String.format(\"baseUrl: [%s] is not valid URL\", config.getBaseUrl());\n+            throw new MetadataValidationException(message, e);\n+        }\n+\n+        String protocol = baseUrl.getProtocol();\n+        if (!protocol.equals(\"http\") && !protocol.equals(\"https\")) {\n+            throw new MetadataValidationException(String.format(\"'%s' is not valid protocol for baseUrl property\", protocol));\n+        }\n+        if (config.getCatalog() == null) {\n+            log.warn(\"The API Catalog UI tile configuration is not provided. Try to add apiml.service.catalog.tile section.\");\n+        }\n+\n+        if (config.getHomePageRelativeUrl() == null || config.getHomePageRelativeUrl().isEmpty() || config.getHomePageRelativeUrl().contains(\"${apiml.\")) {\n+            log.warn(\"The home page URL is not provided. Try to add apiml.service.homePageRelativeUrl property or check its value.\");\n+        }\n+\n+        if (config.getApiInfo() == null || config.getApiInfo().isEmpty()) {\n+            log.warn(\"The API info configuration is not provided. Try to add apiml.service.apiInfo section.\");\n+        }\n+    }\n+\n+    private void validateRoutes(List<Route> routes) {\n+        if (routes == null || routes.isEmpty()) {\n+            throw new MetadataValidationException(\"Routes configuration was not provided. Try to add apiml.service.routes section.\");\n+        }\n+        routes.forEach(route -> {\n+            if (route.getGatewayUrl() == null ||\n+                route.getGatewayUrl().isEmpty() ||\n+                route.getGatewayUrl().contains(\"{apiml.\") ||", "originalCommit": "7254c0c59621f12ae68d86783e73cdd2cb6c5bee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "48024abf9cb48716948e4c739542f2c9590ef1be", "url": "https://github.com/zowe/api-layer/commit/48024abf9cb48716948e4c739542f2c9590ef1be", "message": "Add validation for routes and catalog tile params\n\nSigned-off-by: at670475 <andrea.tabone@broadcom.com>", "committedDate": "2020-06-05T07:19:50Z", "type": "commit"}, {"oid": "20d977c5bed386ada9f6bedb5cc15580639dd2e5", "url": "https://github.com/zowe/api-layer/commit/20d977c5bed386ada9f6bedb5cc15580639dd2e5", "message": "Add class to centralize validation\n\nSigned-off-by: at670475 <andrea.tabone@broadcom.com>", "committedDate": "2020-06-05T07:19:50Z", "type": "commit"}, {"oid": "58a686bd9b56e38fabc561564edb52a7d3db1317", "url": "https://github.com/zowe/api-layer/commit/58a686bd9b56e38fabc561564edb52a7d3db1317", "message": "Add unit tests and change exception to runtime\n\nSigned-off-by: at670475 <andrea.tabone@broadcom.com>", "committedDate": "2020-06-05T07:19:50Z", "type": "commit"}, {"oid": "7937469a8f756fc5af73654eef8d2ec52e8f43c2", "url": "https://github.com/zowe/api-layer/commit/7937469a8f756fc5af73654eef8d2ec52e8f43c2", "message": "Enhancement of validator and more unit tests\n\nSigned-off-by: at670475 <andrea.tabone@broadcom.com>", "committedDate": "2020-06-05T07:19:50Z", "type": "commit"}, {"oid": "fb6002a2665d82bbdd98f9ed65d7128468de3a2a", "url": "https://github.com/zowe/api-layer/commit/fb6002a2665d82bbdd98f9ed65d7128468de3a2a", "message": "Address requested changes\n\nSigned-off-by: at670475 <andrea.tabone@broadcom.com>", "committedDate": "2020-06-05T07:19:50Z", "type": "commit"}, {"oid": "5d46b70ca11b791944fa3e2720e605ff3dc29874", "url": "https://github.com/zowe/api-layer/commit/5d46b70ca11b791944fa3e2720e605ff3dc29874", "message": "Remove MalformedUrl Exception from Interface\n\nSigned-off-by: Jakub Balhar <jakub.balhar@broadcom.com>", "committedDate": "2020-06-05T07:19:50Z", "type": "commit"}, {"oid": "40712328733fb5a379ff7e6eb95cd0ca8d421eef", "url": "https://github.com/zowe/api-layer/commit/40712328733fb5a379ff7e6eb95cd0ca8d421eef", "message": "Remove unused import\n\nSigned-off-by: at670475 <andrea.tabone@broadcom.com>", "committedDate": "2020-06-05T07:19:50Z", "type": "commit"}, {"oid": "dde1064f10f289f1e49a23cfd298a0cdc4495a36", "url": "https://github.com/zowe/api-layer/commit/dde1064f10f289f1e49a23cfd298a0cdc4495a36", "message": "Remove Malformed URL Exception from further places\n\nSigned-off-by: Jakub Balhar <jakub.balhar@broadcom.com>", "committedDate": "2020-06-05T07:19:50Z", "type": "commit"}, {"oid": "ff1f79ab8ae8c8ebb6e40a807b7dd79304377daa", "url": "https://github.com/zowe/api-layer/commit/ff1f79ab8ae8c8ebb6e40a807b7dd79304377daa", "message": "Remove unused import\n\nSigned-off-by: Jakub Balhar <jakub.balhar@broadcom.com>", "committedDate": "2020-06-05T07:19:50Z", "type": "commit"}, {"oid": "8bb259125bde910c6063cbe4bfdade0a0d0efb8a", "url": "https://github.com/zowe/api-layer/commit/8bb259125bde910c6063cbe4bfdade0a0d0efb8a", "message": "Fix dc tests failing caused by missing configuration\n\nSigned-off-by: at670475 <andrea.tabone@broadcom.com>", "committedDate": "2020-06-05T07:19:50Z", "type": "commit"}, {"oid": "8bb259125bde910c6063cbe4bfdade0a0d0efb8a", "url": "https://github.com/zowe/api-layer/commit/8bb259125bde910c6063cbe4bfdade0a0d0efb8a", "message": "Fix dc tests failing caused by missing configuration\n\nSigned-off-by: at670475 <andrea.tabone@broadcom.com>", "committedDate": "2020-06-05T07:19:50Z", "type": "forcePushed"}, {"oid": "c1c189ed1d7c15edf1c3dfdd35fc2b75ba70c955", "url": "https://github.com/zowe/api-layer/commit/c1c189ed1d7c15edf1c3dfdd35fc2b75ba70c955", "message": "Fix code smells\n\nSigned-off-by: at670475 <andrea.tabone@broadcom.com>", "committedDate": "2020-06-05T07:30:36Z", "type": "commit"}, {"oid": "083cd213b54cad649bece1679fb7a7d4b12e197b", "url": "https://github.com/zowe/api-layer/commit/083cd213b54cad649bece1679fb7a7d4b12e197b", "message": "Fix 1 more code smell\n\nSigned-off-by: at670475 <andrea.tabone@broadcom.com>", "committedDate": "2020-06-05T07:41:21Z", "type": "commit"}, {"oid": "65832f39c499aa3a71ba432baaa2d8ce53853302", "url": "https://github.com/zowe/api-layer/commit/65832f39c499aa3a71ba432baaa2d8ce53853302", "message": "Merge branch 'master' into private/taban03/config_validation", "committedDate": "2020-06-05T07:49:02Z", "type": "commit"}, {"oid": "21838a8008d2db3a0529be9b2f6cf766b42d1d8b", "url": "https://github.com/zowe/api-layer/commit/21838a8008d2db3a0529be9b2f6cf766b42d1d8b", "message": "Fix 1 more code smell\n\nSigned-off-by: at670475 <andrea.tabone@broadcom.com>", "committedDate": "2020-06-05T08:48:13Z", "type": "commit"}]}