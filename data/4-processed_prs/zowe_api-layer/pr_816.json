{"pr_number": 816, "pr_title": "Protectors - Support HTTP only in ZAAS client", "pr_createdAt": "2020-09-01T21:07:23Z", "pr_url": "https://github.com/zowe/api-layer/pull/816", "timeline": [{"oid": "364d0b6dc05b839a4561bbc8175ac07a53838186", "url": "https://github.com/zowe/api-layer/commit/364d0b6dc05b839a4561bbc8175ac07a53838186", "message": "Support HTTP only in ZAAS client", "committedDate": "2020-09-01T14:37:29Z", "type": "commit"}, {"oid": "993e633df4f5490c9582c731236bffa53eb32fe8", "url": "https://github.com/zowe/api-layer/commit/993e633df4f5490c9582c731236bffa53eb32fe8", "message": "Merge branch 'master' into protectors/zaas-client-http", "committedDate": "2020-09-01T21:09:21Z", "type": "commit"}, {"oid": "dee991de9e0bf36cea8854fcf089a9ddb226a0bf", "url": "https://github.com/zowe/api-layer/commit/dee991de9e0bf36cea8854fcf089a9ddb226a0bf", "message": "ZaasHttpClientProviderTests", "committedDate": "2020-09-03T11:41:31Z", "type": "commit"}, {"oid": "f55c12be300239b0064bc04bdd5b1743568a96df", "url": "https://github.com/zowe/api-layer/commit/f55c12be300239b0064bc04bdd5b1743568a96df", "message": "HttpOnly ZaasClientTests", "committedDate": "2020-09-03T11:50:59Z", "type": "commit"}, {"oid": "841c028e8d10915144dfad4e52e2aa12334ba06f", "url": "https://github.com/zowe/api-layer/commit/841c028e8d10915144dfad4e52e2aa12334ba06f", "message": "SonarQube", "committedDate": "2020-09-03T13:08:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA1MjYyNA==", "url": "https://github.com/zowe/api-layer/pull/816#discussion_r483052624", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import java.io.IOException;\n          \n          \n            \n            import java.io.IOException;\n          \n          \n            \n            import org.apache.http.HttpHeaders;\n          \n          \n            \n            import org.apache.http.cookie.SM;", "author": "pj892031", "createdAt": "2020-09-03T15:09:20Z", "path": "zaas-client/src/main/java/org/zowe/apiml/zaasclient/service/internal/PassTicketServiceImpl.java", "diffHunk": "@@ -25,41 +25,35 @@\n import java.io.IOException;", "originalCommit": "841c028e8d10915144dfad4e52e2aa12334ba06f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA1MjY3OA==", "url": "https://github.com/zowe/api-layer/pull/816#discussion_r483052678", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        httpPost.setHeader(\"Content-Type\", \"application/json\");\n          \n          \n            \n                        httpPost.setHeader(\"Cookie\", TOKEN_PREFIX + \"=\" + jwtToken);\n          \n          \n            \n                        httpPost.setHeader(HttpHeaders.CONTENT_TYPE, \"application/json\");\n          \n          \n            \n                        httpPost.setHeader(SM.COOKIE, TOKEN_PREFIX + \"=\" + jwtToken);", "author": "pj892031", "createdAt": "2020-09-03T15:09:25Z", "path": "zaas-client/src/main/java/org/zowe/apiml/zaasclient/service/internal/PassTicketServiceImpl.java", "diffHunk": "@@ -25,41 +25,35 @@\n import java.io.IOException;\n \n @Slf4j\n-class PassTicketServiceHttps implements PassTicketService {\n+class PassTicketServiceImpl implements PassTicketService {\n     private static final String TOKEN_PREFIX = \"apimlAuthenticationToken\";\n \n-    private HttpsClientProvider httpsClientProvider;\n+    private final CloseableClientProvider httpClientProvider;\n     private final String ticketUrl;\n \n-    public PassTicketServiceHttps(HttpsClientProvider client, String baseUrl) {\n-        this.httpsClientProvider = client;\n-\n+    public PassTicketServiceImpl(CloseableClientProvider client, String baseUrl) {\n+        httpClientProvider = client;\n         ticketUrl = baseUrl + \"/ticket\";\n     }\n \n     @Override\n     public String passTicket(String jwtToken, String applicationId) throws ZaasClientException, ZaasConfigurationException {\n-        CloseableHttpResponse response = null;\n-        CloseableHttpClient closeableHttpsClient = null;\n-        try {\n-            closeableHttpsClient = httpsClientProvider.getHttpsClientWithKeyStoreAndTrustStore();\n+        try (CloseableHttpClient closeableHttpsClient = httpClientProvider.getHttpClient()) {\n             ZaasClientTicketRequest zaasClientTicketRequest = new ZaasClientTicketRequest();\n             ObjectMapper mapper = new ObjectMapper();\n             zaasClientTicketRequest.setApplicationName(applicationId);\n \n             HttpPost httpPost = new HttpPost(ticketUrl);\n             httpPost.setEntity(new StringEntity(mapper.writeValueAsString(zaasClientTicketRequest)));\n-            httpPost.setHeader(\"Content-type\", \"application/json\");\n+            httpPost.setHeader(\"Content-Type\", \"application/json\");\n             httpPost.setHeader(\"Cookie\", TOKEN_PREFIX + \"=\" + jwtToken);", "originalCommit": "841c028e8d10915144dfad4e52e2aa12334ba06f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA2MjE4OQ==", "url": "https://github.com/zowe/api-layer/pull/816#discussion_r483062189", "bodyText": "Thanks :)", "author": "plavjanik", "createdAt": "2020-09-03T15:22:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA1MjY3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA1NjA3NQ==", "url": "https://github.com/zowe/api-layer/pull/816#discussion_r483056075", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import org.apache.http.impl.client.HttpClientBuilder;\n          \n          \n            \n            \n          \n          \n            \n            public class ZaasHttpClientProvider implements CloseableClientProvider {\n          \n          \n            \n                private final CloseableHttpClient httpClient;\n          \n          \n            \n            \n          \n          \n            \n                public ZaasHttpClientProvider() {\n          \n          \n            \n                    httpClient = HttpClientBuilder.create().disableCookieManagement().disableAuthCaching().build();\n          \n          \n            \n                }\n          \n          \n            \n            \n          \n          \n            \n                @Override\n          \n          \n            \n                public CloseableHttpClient getHttpClient() {\n          \n          \n            \n                    return httpClient;\n          \n          \n            \n                }\n          \n          \n            \n            import org.apache.http.impl.client.HttpClientBuilder;\n          \n          \n            \n            import lombok.Getter;\n          \n          \n            \n            \n          \n          \n            \n            public class ZaasHttpClientProvider implements CloseableClientProvider {\n          \n          \n            \n            \n          \n          \n            \n                @Getter\n          \n          \n            \n                private final CloseableHttpClient httpClient;\n          \n          \n            \n            \n          \n          \n            \n                public ZaasHttpClientProvider() {\n          \n          \n            \n                    httpClient = HttpClientBuilder.create().disableCookieManagement().disableAuthCaching().build();\n          \n          \n            \n                }", "author": "pj892031", "createdAt": "2020-09-03T15:14:18Z", "path": "zaas-client/src/main/java/org/zowe/apiml/zaasclient/service/internal/ZaasHttpClientProvider.java", "diffHunk": "@@ -0,0 +1,26 @@\n+/*\n+ * This program and the accompanying materials are made available under the terms of the\n+ * Eclipse Public License v2.0 which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-v20.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Copyright Contributors to the Zowe Project.\n+ */\n+package org.zowe.apiml.zaasclient.service.internal;\n+\n+import org.apache.http.impl.client.CloseableHttpClient;\n+import org.apache.http.impl.client.HttpClientBuilder;\n+\n+public class ZaasHttpClientProvider implements CloseableClientProvider {\n+    private final CloseableHttpClient httpClient;\n+\n+    public ZaasHttpClientProvider() {\n+        httpClient = HttpClientBuilder.create().disableCookieManagement().disableAuthCaching().build();\n+    }\n+\n+    @Override\n+    public CloseableHttpClient getHttpClient() {\n+        return httpClient;\n+    }", "originalCommit": "841c028e8d10915144dfad4e52e2aa12334ba06f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA1NzkxNg==", "url": "https://github.com/zowe/api-layer/pull/816#discussion_r483057916", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    httpGet.addHeader(\"Cookie\", TOKEN_PREFIX + \"=\" + jwtToken);\n          \n          \n            \n                    httpGet.addHeader(SM.COOKIE, TOKEN_PREFIX + \"=\" + jwtToken);", "author": "pj892031", "createdAt": "2020-09-03T15:16:53Z", "path": "zaas-client/src/main/java/org/zowe/apiml/zaasclient/service/internal/ZaasJwtService.java", "diffHunk": "@@ -86,7 +86,7 @@ public ZaasToken query(String jwtToken) throws ZaasClientException {\n     }\n \n     private ClientWithResponse queryWithJwtToken(String jwtToken) throws ZaasConfigurationException, IOException {\n-        CloseableHttpClient client = httpsClientProvider.getHttpsClientWithTrustStore();\n+        CloseableHttpClient client = httpClientProvider.getHttpClient();\n         HttpGet httpGet = new HttpGet(queryEndpoint);\n         httpGet.addHeader(\"Cookie\", TOKEN_PREFIX + \"=\" + jwtToken);", "originalCommit": "841c028e8d10915144dfad4e52e2aa12334ba06f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA1OTM0MQ==", "url": "https://github.com/zowe/api-layer/pull/816#discussion_r483059341", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import java.util.stream.Stream;\n          \n          \n            \n            import java.util.stream.Stream;\n          \n          \n            \n            import org.apache.http.cookie.SM;", "author": "pj892031", "createdAt": "2020-09-03T15:18:45Z", "path": "zaas-client/src/main/java/org/zowe/apiml/zaasclient/service/internal/ZaasJwtService.java", "diffHunk": "@@ -32,15 +32,15 @@\n import java.util.stream.Stream;", "originalCommit": "841c028e8d10915144dfad4e52e2aa12334ba06f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA1OTc1Nw==", "url": "https://github.com/zowe/api-layer/pull/816#discussion_r483059757", "bodyText": "Also possible to replace \"Set-cookie\" with SM.SET_COOKIE (line 118)", "author": "pj892031", "createdAt": "2020-09-03T15:19:13Z", "path": "zaas-client/src/main/java/org/zowe/apiml/zaasclient/service/internal/ZaasJwtService.java", "diffHunk": "@@ -32,15 +32,15 @@\n import java.util.stream.Stream;", "originalCommit": "841c028e8d10915144dfad4e52e2aa12334ba06f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA3MzgzNg==", "url": "https://github.com/zowe/api-layer/pull/816#discussion_r483073836", "bodyText": "Done", "author": "plavjanik", "createdAt": "2020-09-03T15:38:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA1OTc1Nw=="}], "type": "inlineReview"}, {"oid": "dafc76fbf33b08b4d64756672929afdaa7a99058", "url": "https://github.com/zowe/api-layer/commit/dafc76fbf33b08b4d64756672929afdaa7a99058", "message": "Update zaas-client/src/main/java/org/zowe/apiml/zaasclient/service/internal/PassTicketServiceImpl.java\n\nCo-authored-by: Pavel Jare\u0161 <58428711+pj892031@users.noreply.github.com>", "committedDate": "2020-09-03T15:23:25Z", "type": "commit"}, {"oid": "19432be684a069d4b24e3d48693e5f785e7e8ce4", "url": "https://github.com/zowe/api-layer/commit/19432be684a069d4b24e3d48693e5f785e7e8ce4", "message": "Update zaas-client/src/main/java/org/zowe/apiml/zaasclient/service/internal/PassTicketServiceImpl.java\n\nCo-authored-by: Pavel Jare\u0161 <58428711+pj892031@users.noreply.github.com>", "committedDate": "2020-09-03T15:23:32Z", "type": "commit"}, {"oid": "198e9972aa004241e0232c4ec7b9a5a294274e18", "url": "https://github.com/zowe/api-layer/commit/198e9972aa004241e0232c4ec7b9a5a294274e18", "message": "Update zaas-client/src/main/java/org/zowe/apiml/zaasclient/service/internal/ZaasHttpClientProvider.java\n\nCo-authored-by: Pavel Jare\u0161 <58428711+pj892031@users.noreply.github.com>", "committedDate": "2020-09-03T15:23:39Z", "type": "commit"}, {"oid": "cf9c50384d2b199795af8384d62c3c1e9b3ba573", "url": "https://github.com/zowe/api-layer/commit/cf9c50384d2b199795af8384d62c3c1e9b3ba573", "message": "Update zaas-client/src/main/java/org/zowe/apiml/zaasclient/service/internal/ZaasJwtService.java\n\nCo-authored-by: Pavel Jare\u0161 <58428711+pj892031@users.noreply.github.com>", "committedDate": "2020-09-03T15:23:47Z", "type": "commit"}, {"oid": "f8c5eede8bb1272bc15a9c6fb3e5dfbcec8a23b2", "url": "https://github.com/zowe/api-layer/commit/f8c5eede8bb1272bc15a9c6fb3e5dfbcec8a23b2", "message": "Update zaas-client/src/main/java/org/zowe/apiml/zaasclient/service/internal/ZaasJwtService.java\n\nCo-authored-by: Pavel Jare\u0161 <58428711+pj892031@users.noreply.github.com>", "committedDate": "2020-09-03T15:23:54Z", "type": "commit"}, {"oid": "85424c5219afdd82d778656a20dc6814dec6019d", "url": "https://github.com/zowe/api-layer/commit/85424c5219afdd82d778656a20dc6814dec6019d", "message": "Use constant instead of inline string", "committedDate": "2020-09-03T15:37:30Z", "type": "commit"}]}