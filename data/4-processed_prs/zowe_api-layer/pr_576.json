{"pr_number": 576, "pr_title": "zowe-api-dev deploy", "pr_createdAt": "2020-03-30T09:49:33Z", "pr_url": "https://github.com/zowe/api-layer/pull/576", "timeline": [{"oid": "4bfb89a1ad1c9a3f8e04ce0a45dc96b406ef78d3", "url": "https://github.com/zowe/api-layer/commit/4bfb89a1ad1c9a3f8e04ce0a45dc96b406ef78d3", "message": "template jcl for starting zowe-api-dev job\n\nSigned-off-by: jandadav <janda.david@gmail.com>", "committedDate": "2020-03-31T06:37:25Z", "type": "commit"}, {"oid": "1cb8e20cd92962614214869fe3b35c4e842bfa11", "url": "https://github.com/zowe/api-layer/commit/1cb8e20cd92962614214869fe3b35c4e842bfa11", "message": "fixes to jcl\ndoc\nzowe-api-dev configuration\n\nSigned-off-by: jandadav <janda.david@gmail.com>", "committedDate": "2020-03-31T06:37:25Z", "type": "commit"}, {"oid": "66288397e42608b6ac40dbb6bd44e58d413ed26a", "url": "https://github.com/zowe/api-layer/commit/66288397e42608b6ac40dbb6bd44e58d413ed26a", "message": "thin jar support for Gateway\n\nSigned-off-by: jandadav <janda.david@gmail.com>", "committedDate": "2020-03-31T06:37:25Z", "type": "commit"}, {"oid": "7db2d0560e2dcf8f99301eeb43e8837665038104", "url": "https://github.com/zowe/api-layer/commit/7db2d0560e2dcf8f99301eeb43e8837665038104", "message": "thin jar for core services\ndeployment of libs\nlib inflate on z\n\nSigned-off-by: jandadav <janda.david@gmail.com>", "committedDate": "2020-03-31T06:37:25Z", "type": "commit"}, {"oid": "10ec508e73cc13332b2f35671bbe28523f3f98ab", "url": "https://github.com/zowe/api-layer/commit/10ec508e73cc13332b2f35671bbe28523f3f98ab", "message": "link in to zowe start script\n\nSigned-off-by: jandadav <janda.david@gmail.com>", "committedDate": "2020-03-31T06:37:25Z", "type": "commit"}, {"oid": "b167580fd7da82e6fd4c88c034791e04169b8ac6", "url": "https://github.com/zowe/api-layer/commit/b167580fd7da82e6fd4c88c034791e04169b8ac6", "message": "fix for missing springfox in thin jars classpath\n\nSigned-off-by: jandadav <janda.david@gmail.com>", "committedDate": "2020-03-31T06:37:25Z", "type": "commit"}, {"oid": "53a40727f91ede4603563bf0c53581f79d99645e", "url": "https://github.com/zowe/api-layer/commit/53a40727f91ede4603563bf0c53581f79d99645e", "message": "fix for missing springfox in thin jars classpath\n\nSigned-off-by: jandadav <janda.david@gmail.com>", "committedDate": "2020-03-31T06:37:25Z", "type": "commit"}, {"oid": "d8a3163bc4b3713e58eef61e8715e32c518bcbbc", "url": "https://github.com/zowe/api-layer/commit/d8a3163bc4b3713e58eef61e8715e32c518bcbbc", "message": "add zosmf apidef\nexternalize hostname\n\nSigned-off-by: jandadav <janda.david@gmail.com>", "committedDate": "2020-03-31T06:37:25Z", "type": "commit"}, {"oid": "80aa44785121fc41d3f5427d8d19984fbb7d0e84", "url": "https://github.com/zowe/api-layer/commit/80aa44785121fc41d3f5427d8d19984fbb7d0e84", "message": "changed loading of resources from CP\nadded manifest\n\nSigned-off-by: jandadav <janda.david@gmail.com>", "committedDate": "2020-03-31T06:37:25Z", "type": "commit"}, {"oid": "4688c040d88d5d8327bfe418685bb91ef1e91851", "url": "https://github.com/zowe/api-layer/commit/4688c040d88d5d8327bfe418685bb91ef1e91851", "message": "added ignore for ehcache and zowe-api-dev\n\nSigned-off-by: jandadav <janda.david@gmail.com>", "committedDate": "2020-03-31T06:37:25Z", "type": "commit"}, {"oid": "5b4028c270f29b7bcaa6334fb597be8cef708dc2", "url": "https://github.com/zowe/api-layer/commit/5b4028c270f29b7bcaa6334fb597be8cef708dc2", "message": "Documentation\n\nSigned-off-by: jandadav <janda.david@gmail.com>", "committedDate": "2020-03-31T06:37:25Z", "type": "commit"}, {"oid": "ac464905b3c86dbad7bd38e2e421918de020e485", "url": "https://github.com/zowe/api-layer/commit/ac464905b3c86dbad7bd38e2e421918de020e485", "message": "Documentation improvements\n\nSigned-off-by: jandadav <janda.david@gmail.com>", "committedDate": "2020-03-31T06:37:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY3NDcxOA==", "url": "https://github.com/zowe/api-layer/pull/576#discussion_r400674718", "bodyText": "We will implement it. It was one of the feature of mfaas-auto :)", "author": "plavjanik", "createdAt": "2020-03-31T06:38:03Z", "path": "zowe-api.json", "diffHunk": "@@ -0,0 +1,63 @@\n+{\n+    \"name\": \"API Mediation Layer\",\n+    \"defaultDirName\": \"api-mediation-layer\",\n+    \"defaultHlqSegment\": \"ZADSMP\",\n+    \"zfsMegabytes\": 500,\n+\n+    \"deployment\": {\n+        \"files\": {\n+            \"discovery-service/build/libs/discovery-service-thin.jar\": {\n+                \"target\": \"components/api-mediation/discovery-service.jar\",\n+                \"binary\": true\n+            },\n+            \"gateway-service/build/libs/gateway-service-thin.jar\": {\n+                \"target\": \"components/api-mediation/gateway-service.jar\",\n+                \"binary\": true\n+            },\n+            \"api-catalog-services/build/libs/api-catalog-services-thin.jar\": {\n+                \"target\": \"components/api-mediation/api-catalog-services.jar\",\n+                \"binary\": true\n+            },\n+            \"build/libraries.zip\": {\n+                \"target\": \"components/api-mediation/lib/libraries.zip\",\n+                \"binary\": true\n+            }\n+        }\n+    },\n+\n+    \"shellStartCommand\": \"echo 'Not supported until variable replacement is implemented by Zowe SDK team'\",", "originalCommit": "35cf834d5fa30d96b9e3fa886fad4a60a10864ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY3NTA3Ng==", "url": "https://github.com/zowe/api-layer/pull/576#discussion_r400675076", "bodyText": "great!", "author": "jandadav", "createdAt": "2020-03-31T06:38:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY3NDcxOA=="}], "type": "inlineReview"}, {"oid": "ac464905b3c86dbad7bd38e2e421918de020e485", "url": "https://github.com/zowe/api-layer/commit/ac464905b3c86dbad7bd38e2e421918de020e485", "message": "Documentation improvements\n\nSigned-off-by: jandadav <janda.david@gmail.com>", "committedDate": "2020-03-31T06:37:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY3NTUyOA==", "url": "https://github.com/zowe/api-layer/pull/576#discussion_r400675528", "bodyText": "Thin jar are a great idea. A good thing is that Zowe SMP/E packaging does not create an element for each .jar file so it should work without changes no matter how many .jar files will be in the api-layer.", "author": "plavjanik", "createdAt": "2020-03-31T06:39:58Z", "path": "docs/ad-hoc-mainframe-deployment.md", "diffHunk": "@@ -0,0 +1,129 @@\n+## Ad-Hoc deployment of API Mediation Layer to Mainframe system\n+\n+## Technology\n+\n+Using [zowe-api-dev](https://github.com/zowe/sample-spring-boot-api-service/blob/master/zowe-rest-api-sample-spring/docs/devtool.md\n+) tool from Zowe SDK.\n+\n+Underlying technology is Zowe CLI.\n+\n+**WARNING: TECHNOLOGY AND IMPLEMENTATION IS STILL IN EXPERIMENTAL STAGE**\n+\n+### Prerequisities\n+ - Install Zowe CLI - https://docs.zowe.org/stable/user-guide/cli-installcli.html#installing-zowe-cli\n+ - Install zowe-api-dev\n+   ```\n+   npm -g install @zowedev/zowe-api-dev\n+   ```\n+ - Create Zowe CLI profiles for Z/OSMF and USS\n+   ```\n+   zowe profiles create zosmf-profile <profile_id> --host <hostname> --port <port> --user <userid> --pass \"<password>\" --reject-unauthorized false\n+   zowe profiles create ssh-profile <profile_id> --host <hostname> --user <userid> --password \"<password>\"\n+   ```\n+### Procedure\n+\n+Procedure is separated into 3 distinct phases\n+\n+*All commands are run from repository root folder*\n+\n+#### Phase 1 - Initial run\n+\n+objective of this phase is to setup zowe-api-dev and perform first deployment\n+\n+ - Run 'zowe-api-dev init --account=<mf-account-id>'. 'user-zowe-api.json' will be generated in repository root folder.\n+\n+  - Create `user-zowe-api.json` file in repository root folder. Fill in specific information. \n+  \n+    *Keep ports and job identifiers unique so you do not overlap other developers deployments*\n+\n+    *Sample user-zowe-api.json*\n+    ```json\n+    {\n+    \"javaHome\": \"<java home path>\",\n+    \"javaLoadlib\": \"\",\n+    \"jobcard\": [\n+        \"//<job id> JOB <your mainframe account number>,'APIML',MSGCLASS=A,CLASS=A,\",\n+        \"//  MSGLEVEL=(1,1),REGION=0M\",\n+        \"/*JOBPARM SYSAFF=*\"\n+    ],\n+    \"zosHlq\": \"<dataset hlq for zfs>\",\n+    \"zosTargetDir\": \"<deployment directory, use home directory>\",\n+    \"zoweProfileName\": \"<name of zowe profile for zosmf  and uss>\",\n+    \"basePort\": <base port for deployment>,\n+    \"systemHostname\": \"<hostname of deployment system>\"\n+    }\n+    ```\n+ - Create a directory next to your API Mediation layer repository called `api-layer-deploy`. Place the following files inside:\n+\n+   ```\n+   |\n+   +- api-layer\n+   | +- / api layer repository /\n+   | ...\n+   +- api-layer-deploy\n+     +- apiml.keystore.p12\n+     +- apiml.truststore.p12\n+     +- zosmf.yml\n+   ```\n+\n+    - apiml.keystore.p12 - Keystore containing certificate with alias `apiml` to be used by deployed services\n+    - apiml.truststore.p12 - Kestore with CA certs and trust chain to be used to verify certificates\n+    - zosmf.yml - zosmf static definition\n+\n+ - Run `zowe-api-dev zfs`. ZFS filesystem is be created and mounted to the `zosTargetDir`.\n+ \n+ - Build deployment artifacts.\n+   - Run Gradle build task\n+   - Run Gradle packageLibs task\n+ \n+ - Run `zowe-api-dev deploy`. Binaries are be deployed. \n+ \n+ - Run `zowe-api-dev config --name zos`. Configuration is deployed.\n+ \n+ - Start deployed instance by running 'zowe-api-dev start --job'. JES Job is started. You will get Job ID of started job.\n+\n+ *At this point you can go and use the deployment. You will not have to repeat these steps (Except the zfs mount if you dispose of it)*\n+\n+#### Phase 2 - Operate the solution\n+\n+`zowe-api-dev status` - To understand the state of your job.\n+\n+`zowe-api-dev start --job` - Starts the deployment job. Make sure the job is not running before.\n+\n+`zowe-api-dev deploy` - After code change, you can rerun this command to redeploy the binaries again. Only patch is deployed for efficiency. You can use `--force` to redeploy everything.\n+\n+`zowe-api-dev config --name zos` - After configuration change, you can run this command to redeploy changed files. There is no force and the redeployment sometimes finds no changes, even when changes have been made. In that case, inspect `.zowe-api-dev` folder and remove the mirrored deployment files and rerun the command.\n+\n+`zowe zos-jobs cancel job <job id>` - Stop your running job. There is no better way at the moment. We have issue pending with zowe-api-dev.\n+\n+#### Phase 3 - Dispose of the deployment\n+\n+*Make sure the deployment is not started, stop the job if it is*\n+\n+`zowe-api-dev zfs --unmount --delete` - Unmount and delete zfs. *Not tested*\n+\n+### Flow of configuration\n+\n+User variables are stored in `user-zowe-api.json`. You should not need to change `zowe-api.json`. `config/zowe-api-dev/template-bpxbatch.jcl` is used to run main run script on mainframe. This sets the deployment configuration into the stdenv on mainframe.\n+\n+Wrapper script `config/zowe-api-dev/run-wrapper.sh` is launched on mainframe. This is where you can change things and configure the deployment. This wrapper sets environment, unpacks dependencies and runs Zowe's Apiml start script `zowe-install/src/main/resources/component-scripts/start.sh`, which in turn starts Apiml.\n+\n+*You can use the config deploy to upload the config changes only.*\n+\n+### Notes and Known issues\n+\n+ - The delta algorithm that zowe-api-dev is using is not perfect. Sometimes manual delete of `.zowe-api-dev/uploadedFiles` cache is needed to force deployment.\n+ - Zowe CLI sometimes fails to upload large files with error: `FATAL ERROR: Ineffective mark-compacts near heap limit Allocation failed - JavaScript heap out of memory\n+`. When retried, upload passes. Further optimization can be done to reduce size of our deployment.\n+\n+### Deployment size optimization\n+\n+*Following changes are additional to standard packaging*\n+\n+Code packaging into jars is enhanced. \n+\n+#### Thin jars package", "originalCommit": "ac464905b3c86dbad7bd38e2e421918de020e485", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY3NjAzNQ==", "url": "https://github.com/zowe/api-layer/pull/576#discussion_r400676035", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              - Create `user-zowe-api.json` file in repository root folder. Fill in specific information. \n          \n          \n            \n              - Update the `user-zowe-api.json` file in the repository root folder. Fill in specific information. \n          \n      \n    \n    \n  \n\nI would use update since the user-zowe-api.json is already created by zowe-api-dev init.", "author": "plavjanik", "createdAt": "2020-03-31T06:41:23Z", "path": "docs/ad-hoc-mainframe-deployment.md", "diffHunk": "@@ -0,0 +1,129 @@\n+## Ad-Hoc deployment of API Mediation Layer to Mainframe system\n+\n+## Technology\n+\n+Using [zowe-api-dev](https://github.com/zowe/sample-spring-boot-api-service/blob/master/zowe-rest-api-sample-spring/docs/devtool.md\n+) tool from Zowe SDK.\n+\n+Underlying technology is Zowe CLI.\n+\n+**WARNING: TECHNOLOGY AND IMPLEMENTATION IS STILL IN EXPERIMENTAL STAGE**\n+\n+### Prerequisities\n+ - Install Zowe CLI - https://docs.zowe.org/stable/user-guide/cli-installcli.html#installing-zowe-cli\n+ - Install zowe-api-dev\n+   ```\n+   npm -g install @zowedev/zowe-api-dev\n+   ```\n+ - Create Zowe CLI profiles for Z/OSMF and USS\n+   ```\n+   zowe profiles create zosmf-profile <profile_id> --host <hostname> --port <port> --user <userid> --pass \"<password>\" --reject-unauthorized false\n+   zowe profiles create ssh-profile <profile_id> --host <hostname> --user <userid> --password \"<password>\"\n+   ```\n+### Procedure\n+\n+Procedure is separated into 3 distinct phases\n+\n+*All commands are run from repository root folder*\n+\n+#### Phase 1 - Initial run\n+\n+objective of this phase is to setup zowe-api-dev and perform first deployment\n+\n+ - Run 'zowe-api-dev init --account=<mf-account-id>'. 'user-zowe-api.json' will be generated in repository root folder.\n+\n+  - Create `user-zowe-api.json` file in repository root folder. Fill in specific information. ", "originalCommit": "ac464905b3c86dbad7bd38e2e421918de020e485", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY3ODQ4NA==", "url": "https://github.com/zowe/api-layer/pull/576#discussion_r400678484", "bodyText": "good point, i need to adjust, but the other way around", "author": "jandadav", "createdAt": "2020-03-31T06:47:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY3NjAzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY3OTk4OQ==", "url": "https://github.com/zowe/api-layer/pull/576#discussion_r400679989", "bodyText": "We would want to init with custom parameters. Since it's not available and you need to edit the file anyway, it's without init at the moment", "author": "jandadav", "createdAt": "2020-03-31T06:50:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY3NjAzNQ=="}], "type": "inlineReview"}, {"oid": "29ce780d17b21a1b5ca9b5126a9ead9c51fc0c95", "url": "https://github.com/zowe/api-layer/commit/29ce780d17b21a1b5ca9b5126a9ead9c51fc0c95", "message": "Remove init step\n\nSigned-off-by: jandadav <janda.david@gmail.com>", "committedDate": "2020-03-31T06:49:10Z", "type": "commit"}]}