{"pr_number": 714, "pr_title": "Private/dj/retry loadbalancer race condition", "pr_createdAt": "2020-06-16T08:19:34Z", "pr_url": "https://github.com/zowe/api-layer/pull/714", "timeline": [{"oid": "c98dd0abbbf4d214556fc81249cb87061e5f1ea5", "url": "https://github.com/zowe/api-layer/commit/c98dd0abbbf4d214556fc81249cb87061e5f1ea5", "message": "add test service for rebuilding\n\nSigned-off-by: jandadav <janda.david@gmail.com>", "committedDate": "2020-06-08T10:53:59Z", "type": "commit"}, {"oid": "bf7c485f2fc6d3a3241419bb46145fa68f986cc4", "url": "https://github.com/zowe/api-layer/commit/bf7c485f2fc6d3a3241419bb46145fa68f986cc4", "message": "add logging\n\nSigned-off-by: jandadav <janda.david@gmail.com>", "committedDate": "2020-06-08T14:11:18Z", "type": "commit"}, {"oid": "6633ff4f42be40f55558823e5980bf732b910342", "url": "https://github.com/zowe/api-layer/commit/6633ff4f42be40f55558823e5980bf732b910342", "message": "another debug fixture\n\nSigned-off-by: jandadav <janda.david@gmail.com>", "committedDate": "2020-06-09T11:13:06Z", "type": "commit"}, {"oid": "912df85bb795e7c3121f24a959a645b6b8ea456b", "url": "https://github.com/zowe/api-layer/commit/912df85bb795e7c3121f24a959a645b6b8ea456b", "message": "RC identified\n\nSigned-off-by: jandadav <janda.david@gmail.com>", "committedDate": "2020-06-11T08:16:05Z", "type": "commit"}, {"oid": "57dc57df377763b8a1f95f5e833253689b9533e4", "url": "https://github.com/zowe/api-layer/commit/57dc57df377763b8a1f95f5e833253689b9533e4", "message": "keep LB instances in map\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>", "committedDate": "2020-06-11T14:32:48Z", "type": "commit"}, {"oid": "ca638fa2e4e17831e15372f82dae8b0f0997e60e", "url": "https://github.com/zowe/api-layer/commit/ca638fa2e4e17831e15372f82dae8b0f0997e60e", "message": "remove test\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>", "committedDate": "2020-06-11T14:33:59Z", "type": "commit"}, {"oid": "e2c8d225a1e67130d760a649531e34d9a50f09a2", "url": "https://github.com/zowe/api-layer/commit/e2c8d225a1e67130d760a649531e34d9a50f09a2", "message": "format\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>", "committedDate": "2020-06-11T14:34:31Z", "type": "commit"}, {"oid": "eb8dbef59f5a60fc6b8d1dfc3767f61f92196743", "url": "https://github.com/zowe/api-layer/commit/eb8dbef59f5a60fc6b8d1dfc3767f61f92196743", "message": "Merge remote-tracking branch 'origin/private/dj/retry-loadbalancer-race-condition' into private/dj/retry-loadbalancer-race-condition\n\n# Conflicts:\n#\tgateway-service/src/main/java/org/zowe/apiml/gateway/cache/ServiceCacheEvictor.java\n#\tgateway-service/src/main/java/org/zowe/apiml/gateway/ribbon/ApimlZoneAwareLoadBalancer.java", "committedDate": "2020-06-11T14:36:01Z", "type": "commit"}, {"oid": "bd22e9d48620f412fa702d7682c7f38e18cfd097", "url": "https://github.com/zowe/api-layer/commit/bd22e9d48620f412fa702d7682c7f38e18cfd097", "message": ".\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>", "committedDate": "2020-06-15T13:54:28Z", "type": "commit"}, {"oid": "2dd7794300db43f4667b4aa1f4c13da016281026", "url": "https://github.com/zowe/api-layer/commit/2dd7794300db43f4667b4aa1f4c13da016281026", "message": "refactor, server list update moved\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>", "committedDate": "2020-06-15T14:33:56Z", "type": "commit"}, {"oid": "0c81d815a01143dc2834f2fae674cf99cb8308e2", "url": "https://github.com/zowe/api-layer/commit/0c81d815a01143dc2834f2fae674cf99cb8308e2", "message": "test correction\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>", "committedDate": "2020-06-15T14:55:33Z", "type": "commit"}, {"oid": "d797e8279f7bb5d67f233d0d1b5efd9d944b9280", "url": "https://github.com/zowe/api-layer/commit/d797e8279f7bb5d67f233d0d1b5efd9d944b9280", "message": "reload all existing loadbalancers, add integrations test for reregistration\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>", "committedDate": "2020-06-16T07:10:09Z", "type": "commit"}, {"oid": "08b09b89c5c795c2d454720bff3235450bd26a29", "url": "https://github.com/zowe/api-layer/commit/08b09b89c5c795c2d454720bff3235450bd26a29", "message": "Merge branch 'master' into private/dj/retry-loadbalancer-race-condition\n\n# Conflicts:\n#\tintegration-tests/src/test/java/org/zowe/apiml/gatewayservice/AuthenticationOnDeploymentTest.java", "committedDate": "2020-06-16T07:27:05Z", "type": "commit"}, {"oid": "aa8dfd2452e27a7db6ccbf1eaa7b0d3adc1bfcf1", "url": "https://github.com/zowe/api-layer/commit/aa8dfd2452e27a7db6ccbf1eaa7b0d3adc1bfcf1", "message": "remove debug level\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>", "committedDate": "2020-06-16T08:12:46Z", "type": "commit"}, {"oid": "7a71c053f935969f5e3804385a591c59f0914b64", "url": "https://github.com/zowe/api-layer/commit/7a71c053f935969f5e3804385a591c59f0914b64", "message": "remove logger\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>", "committedDate": "2020-06-16T08:17:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY3Nzc0OQ==", "url": "https://github.com/zowe/api-layer/pull/714#discussion_r440677749", "bodyText": "Any reason why the filter is commented out?", "author": "balhar-jakub", "createdAt": "2020-06-16T08:30:01Z", "path": "apiml-common/src/main/resources/logback.xml", "diffHunk": "@@ -5,9 +5,9 @@\n     <turboFilter class=\"org.zowe.apiml.product.logging.UseridFilter\"/>\n     <turboFilter class=\"org.zowe.apiml.product.logging.ApimlDependencyLogHider\"/>\n     <turboFilter class=\"org.zowe.apiml.product.logging.LogLevelInfoFilter\"/>\n-    <turboFilter class=\"ch.qos.logback.classic.turbo.DuplicateMessageFilter\">", "originalCommit": "7a71c053f935969f5e3804385a591c59f0914b64", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY3ODExMA==", "url": "https://github.com/zowe/api-layer/pull/714#discussion_r440678110", "bodyText": "Isn't the closing tag missing?", "author": "balhar-jakub", "createdAt": "2020-06-16T08:30:37Z", "path": "gateway-service/src/main/java/org/zowe/apiml/gateway/cache/ServiceCacheEvictor.java", "diffHunk": "@@ -9,38 +9,41 @@\n  */\n package org.zowe.apiml.gateway.cache;\n \n-import org.zowe.apiml.gateway.discovery.ApimlDiscoveryClient;\n-import org.zowe.apiml.gateway.ribbon.ApimlZoneAwareLoadBalancer;\n import com.netflix.discovery.CacheRefreshedEvent;\n import com.netflix.discovery.EurekaEvent;\n import com.netflix.discovery.EurekaEventListener;\n import lombok.Value;\n+import lombok.extern.slf4j.Slf4j;\n import org.springframework.stereotype.Component;\n+import org.zowe.apiml.gateway.discovery.ApimlDiscoveryClient;\n+import org.zowe.apiml.gateway.ribbon.ApimlZoneAwareLoadBalancer;\n import org.zowe.apiml.gateway.security.service.ServiceCacheEvict;\n \n import java.util.HashSet;\n import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n \n /**\n  * This class is responsible for evicting cache after new registry is loaded. This avoid race condition. Scenario is:\n  * 1. discovery service changed\n- *  a. about change is notified all gateways\n- *  b. gateways evict caches and start with mirroring of discovery into discoveryClient\n+ * a. about change is notified all gateways\n+ * b. gateways evict caches and start with mirroring of discovery into discoveryClient\n  * 2. now is possible cache again data with old settings from discovery service, because fetching new is asynchronous\n  * 3. after make fetching this beans is notified from discovery client and evict caches again\n- *\n+ * <p>", "originalCommit": "7a71c053f935969f5e3804385a591c59f0914b64", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY3ODIzOQ==", "url": "https://github.com/zowe/api-layer/pull/714#discussion_r440678239", "bodyText": "What is the impact of this change?", "author": "balhar-jakub", "createdAt": "2020-06-16T08:30:49Z", "path": "discovery-service/src/main/resources/application.yml", "diffHunk": "@@ -75,6 +75,7 @@ eureka:\n             defaultZone: ${apiml.discovery.allPeersUrls}\n     server:\n         useReadOnlyResponseCache: false\n+        enable-self-preservation: false", "originalCommit": "7a71c053f935969f5e3804385a591c59f0914b64", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3ea32c5bc985b442f3f4fe0252749b98cc8bceaf", "url": "https://github.com/zowe/api-layer/commit/3ea32c5bc985b442f3f4fe0252749b98cc8bceaf", "message": "review\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>", "committedDate": "2020-06-16T08:37:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY3ODkxMg==", "url": "https://github.com/zowe/api-layer/pull/714#discussion_r440678912", "bodyText": "What is this one?", "author": "balhar-jakub", "createdAt": "2020-06-16T08:31:56Z", "path": "settings.gradle", "diffHunk": "@@ -33,4 +33,4 @@ include 'security-service-client-spring'\n include 'onboarding-enabler-java'\n include 'onboarding-enabler-spring'\n include 'zaas-client'\n-\n+include 'oes-app'", "originalCommit": "7a71c053f935969f5e3804385a591c59f0914b64", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY3OTEyNw==", "url": "https://github.com/zowe/api-layer/pull/714#discussion_r440679127", "bodyText": "Why do you remove the functionality?", "author": "balhar-jakub", "createdAt": "2020-06-16T08:32:17Z", "path": "integration-tests/src/test/java/org/zowe/apiml/util/service/RequestVerifier.java", "diffHunk": "@@ -121,12 +121,6 @@ public String getHeader(String name) {\n             return list.get(0);\n         }\n \n-        public Enumeration<String> getHeaders(String name) {\n-            List list = headersData.get(name);\n-            if (list == null) list = Collections.emptyList();\n-            return Collections.enumeration(list);\n-        }", "originalCommit": "7a71c053f935969f5e3804385a591c59f0914b64", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cfde6d7b6a24c49441ea4ad72c820e202ebb78bc", "url": "https://github.com/zowe/api-layer/commit/cfde6d7b6a24c49441ea4ad72c820e202ebb78bc", "message": "remove oes-app\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>", "committedDate": "2020-06-16T08:48:04Z", "type": "commit"}, {"oid": "8f2b0605ce0ba1e3c48034f2dad9b5306db61380", "url": "https://github.com/zowe/api-layer/commit/8f2b0605ce0ba1e3c48034f2dad9b5306db61380", "message": "Merge branch 'master' into private/dj/retry-loadbalancer-race-condition", "committedDate": "2020-06-16T09:10:24Z", "type": "commit"}, {"oid": "e36e3ab998db4595541dcb7ba6b50c8fb6f94a2e", "url": "https://github.com/zowe/api-layer/commit/e36e3ab998db4595541dcb7ba6b50c8fb6f94a2e", "message": "fix code smells\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>", "committedDate": "2020-06-16T09:20:20Z", "type": "commit"}, {"oid": "03c7a745a63f49a80931b33610ab24410436e65d", "url": "https://github.com/zowe/api-layer/commit/03c7a745a63f49a80931b33610ab24410436e65d", "message": "cc refactor\ngenerify cache evictor\n\nSigned-off-by: jandadav <janda.david@gmail.com>", "committedDate": "2020-06-16T09:41:33Z", "type": "commit"}, {"oid": "05ec9eb719992c8a2d683f8a2c325a500fc6fe9f", "url": "https://github.com/zowe/api-layer/commit/05ec9eb719992c8a2d683f8a2c325a500fc6fe9f", "message": "refactor load balancer name\n\nSigned-off-by: jandadav <janda.david@gmail.com>", "committedDate": "2020-06-16T09:43:01Z", "type": "commit"}, {"oid": "ee173c325c0c78dbc37221d78f9f3989fa4346c5", "url": "https://github.com/zowe/api-layer/commit/ee173c325c0c78dbc37221d78f9f3989fa4346c5", "message": "fix ports\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>", "committedDate": "2020-06-16T12:27:03Z", "type": "commit"}, {"oid": "b5cd6a507bba03e971150fe0c53e7d2f4fe7163c", "url": "https://github.com/zowe/api-layer/commit/b5cd6a507bba03e971150fe0c53e7d2f4fe7163c", "message": "Merge remote-tracking branch 'origin/private/dj/retry-loadbalancer-race-condition' into private/dj/retry-loadbalancer-race-condition", "committedDate": "2020-06-16T12:27:13Z", "type": "commit"}, {"oid": "178aad441733787d81ec74aee831a59afe1d72a1", "url": "https://github.com/zowe/api-layer/commit/178aad441733787d81ec74aee831a59afe1d72a1", "message": "fix code smells\n\nSigned-off-by: jandadav <janda.david@gmail.com>", "committedDate": "2020-06-16T12:43:18Z", "type": "commit"}, {"oid": "9f0d07e42806f0701ddf747b246288f9c3120f23", "url": "https://github.com/zowe/api-layer/commit/9f0d07e42806f0701ddf747b246288f9c3120f23", "message": "Merge branch 'master' into private/dj/retry-loadbalancer-race-condition", "committedDate": "2020-06-16T13:02:49Z", "type": "commit"}]}