{"pr_number": 4688, "pr_title": "DB-10878 more server-side logging.", "pr_createdAt": "2020-11-24T16:25:25Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/4688", "timeline": [{"oid": "eabf7d6e7a40ad9d890e268061ba2f43c645b4f8", "url": "https://github.com/splicemachine/spliceengine/commit/eabf7d6e7a40ad9d890e268061ba2f43c645b4f8", "message": "DB-10878 more server-side logging.", "committedDate": "2020-11-24T16:04:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgxNjY0Mg==", "url": "https://github.com/splicemachine/spliceengine/pull/4688#discussion_r529816642", "bodyText": "log -> LOG for consistency", "author": "OlegMazurov", "createdAt": "2020-11-24T19:12:11Z", "path": "db-drda/src/main/java/com/splicemachine/db/impl/drda/DRDAConnThread.java", "diffHunk": "@@ -97,6 +97,8 @@\n \n     private static final Logger AUDITLOG =Logger.getLogger(\"splice-audit\");\n \n+    private static final Logger log = Logger.getLogger(DRDAConnThread.class);", "originalCommit": "eabf7d6e7a40ad9d890e268061ba2f43c645b4f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMwMDE4NQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4688#discussion_r530300185", "bodyText": "done.", "author": "hatyo", "createdAt": "2020-11-25T11:23:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgxNjY0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgxOTU3NQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4688#discussion_r529819575", "bodyText": "The reason we redundantly check if Debug/Trace levels are enabled outside the logging methods is to avoid argument evaluation which is done unconditionally and may have quite noticeable overhead.\nIntroducing an intermediate convenience method apparently defeats the purpose.\nThe existing trace() method doesn't conform to that principle and should be reworked (separately from this PR; also to use Logger). It should not be considered as acceptable still.", "author": "OlegMazurov", "createdAt": "2020-11-24T19:17:31Z", "path": "db-drda/src/main/java/com/splicemachine/db/impl/drda/DRDAConnThread.java", "diffHunk": "@@ -306,13 +309,22 @@ private void parsePRDDTA() throws DRDAProtocolException\n         initialize();\n     }\n \n+    private String getSessionName() {\n+        return session == null ? \"\" : session.toString();\n+    }\n+\n+    private void debug(String message) {\n+        if(log.isDebugEnabled()) {", "originalCommit": "eabf7d6e7a40ad9d890e268061ba2f43c645b4f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMwNDE1OQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4688#discussion_r530304159", "bodyText": "The reason we redundantly check if Debug/Trace levels are enabled outside the logging methods is to avoid argument evaluation which is done unconditionally and may have quite noticeable overhead.\nIntroducing an intermediate convenience method apparently defeats the purpose.\n\nGood point, I will remove it, it looks like org.apache.log4j.Category#debug(java.lang.Object) itself it doing the check again:\n   public void debug(Object message) {\n        if (!this.repository.isDisabled(10000)) {\n            if (Level.DEBUG.isGreaterOrEqual(this.getEffectiveLevel())) {\n                this.forcedLog(FQCN, Level.DEBUG, message, (Throwable)null);\n            }\n\n        }\n    }\n\nIf the cost of evaluation is considerable, maybe we should extend the implementation and add a new version of debug which accepts a vararg and does the evaluation only inside the if branch, i.e. something like this:\n    public void debug(String format, Object... args ) {\n        if (!this.repository.isDisabled(10000)) {\n            if (Level.DEBUG.isGreaterOrEqual(this.getEffectiveLevel())) {\n                this.forcedLog(FQCN, Level.DEBUG, String.format(format, args), (Throwable)null);\n            }\n        }\n    }\n\n\n\nThe existing trace() method doesn't conform to that principle and should be reworked (separately from this PR; also to use Logger). It should not be considered as acceptable still.\n\nYes, I also think we should change trace() to use our Logger but I would do it separately since it is orthogonal to this change.", "author": "hatyo", "createdAt": "2020-11-25T11:30:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgxOTU3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgyNTg5MQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4688#discussion_r529825891", "bodyText": "Use LOG.debug(message, error). It will also print the error.getMessage() and the stack trace.", "author": "OlegMazurov", "createdAt": "2020-11-24T19:28:39Z", "path": "db-drda/src/main/java/com/splicemachine/db/impl/drda/DRDAConnThread.java", "diffHunk": "@@ -380,6 +393,8 @@ public void run() {\n                 // TODO: Could make use of Throwable.addSuppressed here when\n                 //       compiled as Java 7 (or newer).\n                 try {\n+                    debug(\"encountered error \" + error.getMessage());", "originalCommit": "eabf7d6e7a40ad9d890e268061ba2f43c645b4f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMxNDI3MA==", "url": "https://github.com/splicemachine/spliceengine/pull/4688#discussion_r530314270", "bodyText": "done.", "author": "hatyo", "createdAt": "2020-11-25T11:48:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgyNTg5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgyODEwNg==", "url": "https://github.com/splicemachine/spliceengine/pull/4688#discussion_r529828106", "bodyText": "Use LOG. Ideally we'll have just one logging system and it won't be the Derby one.", "author": "OlegMazurov", "createdAt": "2020-11-24T19:32:22Z", "path": "db-drda/src/main/java/com/splicemachine/db/impl/drda/DRDAConnThread.java", "diffHunk": "@@ -1188,6 +1200,9 @@ private void processCommands() throws DRDAProtocolException\n                     server.consoleExceptionPrint(sqle);\n                     SanityManager.THROWASSERT(\"Unexpected exception after \" +\n                             \"codePoint \"+cpStr, sqle);\n+                } catch (Exception e) {\n+                    server.consoleExceptionPrint(e);", "originalCommit": "eabf7d6e7a40ad9d890e268061ba2f43c645b4f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMxNzY4NA==", "url": "https://github.com/splicemachine/spliceengine/pull/4688#discussion_r530317684", "bodyText": "Yes, that's definitely something we should do, I didn't want to introduce that here because I thought it is out of scope. Will should at least have a JIRA for tracking this.\nFor now, I would prefer to keep it like this, because the error will appear anyway (although in a different log file).", "author": "hatyo", "createdAt": "2020-11-25T11:54:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgyODEwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgyODUwOQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4688#discussion_r529828509", "bodyText": "LOG.debug(message, error)", "author": "OlegMazurov", "createdAt": "2020-11-24T19:33:09Z", "path": "db-drda/src/main/java/com/splicemachine/db/impl/drda/DRDAConnThread.java", "diffHunk": "@@ -8697,14 +8714,24 @@ private void closeSession()\n         server.removeFromSessionTable(session.connNum);\n         try {\n             session.close();\n-        } catch (SQLException se)\n+            debug(getSessionName() + \" closed\");\n+        }\n+        catch (SQLException se)\n         {\n             // If something went wrong closing down the session.\n             // Print an error to the console and close this\n             //thread. (6013)\n+            debug(\"encountered exception while closing session \" + getSessionName());\n             sendUnexpectedException(se);\n             close();\n         }\n+        catch (Exception e)\n+        {\n+            // log the exception and rethrow.\n+            debug(\"encountered exception while closing session \"+ getSessionName());", "originalCommit": "eabf7d6e7a40ad9d890e268061ba2f43c645b4f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMxODg4NQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4688#discussion_r530318885", "bodyText": "done.", "author": "hatyo", "createdAt": "2020-11-25T11:56:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgyODUwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgyODcyNg==", "url": "https://github.com/splicemachine/spliceengine/pull/4688#discussion_r529828726", "bodyText": "LOG.debug(message, error)", "author": "OlegMazurov", "createdAt": "2020-11-24T19:33:34Z", "path": "db-drda/src/main/java/com/splicemachine/db/impl/drda/DRDAConnThread.java", "diffHunk": "@@ -8725,6 +8752,7 @@ private void handleException(Exception e)\n             if (e instanceof DRDAProtocolException) {\n                 // protocol error - write error message\n                 sendProtocolException((DRDAProtocolException) e);\n+                server.consoleExceptionPrintTrace(e);", "originalCommit": "eabf7d6e7a40ad9d890e268061ba2f43c645b4f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMxOTYxMA==", "url": "https://github.com/splicemachine/spliceengine/pull/4688#discussion_r530319610", "bodyText": "I would make it part of this JIRA.", "author": "hatyo", "createdAt": "2020-11-25T11:57:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgyODcyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgyOTM3MQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4688#discussion_r529829371", "bodyText": "LOG.debug(message, error)", "author": "OlegMazurov", "createdAt": "2020-11-24T19:34:42Z", "path": "db-drda/src/main/java/com/splicemachine/db/impl/drda/NetworkServerControlImpl.java", "diffHunk": "@@ -3973,6 +3972,10 @@ void addSession(Socket clientSocket) throws Exception {\n                 if ((maxThreads == 0) || (threadList.size() < maxThreads)) {\n                     thread = new DRDAConnThread(session, this, getTimeSlice(),\n                                                 getLogConnections());\n+                    thread.setUncaughtExceptionHandler((t, e) -> {\n+                        consoleMessage(\"tracing unhandled exception originating from thread: '\" + t.getName() + \"'\", true);", "originalCommit": "eabf7d6e7a40ad9d890e268061ba2f43c645b4f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMxOTgwOA==", "url": "https://github.com/splicemachine/spliceengine/pull/4688#discussion_r530319808", "bodyText": "I would make it part of this JIRA.", "author": "hatyo", "createdAt": "2020-11-25T11:57:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgyOTM3MQ=="}], "type": "inlineReview"}, {"oid": "f450bc03a75ab1409bdbfe727fc4be9e13eb298c", "url": "https://github.com/splicemachine/spliceengine/commit/f450bc03a75ab1409bdbfe727fc4be9e13eb298c", "message": "DB-10878 address comments.", "committedDate": "2020-11-25T12:02:01Z", "type": "commit"}, {"oid": "ddd53184e2c43a1b29497aab300c71d5a9dde53b", "url": "https://github.com/splicemachine/spliceengine/commit/ddd53184e2c43a1b29497aab300c71d5a9dde53b", "message": "Merge remote-tracking branch 'origin/master' into DB-10878", "committedDate": "2020-11-25T17:52:38Z", "type": "commit"}]}