{"pr_number": 3859, "pr_title": "DB-9867: make sure to raise an exception if unique constraint is violated for system tables", "pr_createdAt": "2020-07-17T22:05:24Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/3859", "timeline": [{"oid": "04d59f87c9260a9df922d5cb99d9eabcf5f79242", "url": "https://github.com/splicemachine/spliceengine/commit/04d59f87c9260a9df922d5cb99d9eabcf5f79242", "message": "DB-9867: make sure to raise an exception if unique constraint is violated for system tables", "committedDate": "2020-07-17T22:04:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU2MzkyOA==", "url": "https://github.com/splicemachine/spliceengine/pull/3859#discussion_r457563928", "bodyText": "you could refactor this in a method called insertOrThrow and reuse it everywhere :)", "author": "hatyo", "createdAt": "2020-07-20T17:09:29Z", "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/catalog/DataDictionaryImpl.java", "diffHunk": "@@ -1183,14 +1183,20 @@ public boolean existsSchemaOwnedBy(String authid,TransactionController tc) throw\n     public void addColumnStatistics(ExecRow row,\n                               TransactionController tc) throws StandardException{\n         TabInfoImpl ti=getNonCoreTI(SYSCOLUMNSTATS_CATALOG_NUM);\n-        ti.insertRow(row,tc);\n+        int insertRetCode = ti.insertRow(row,tc);\n+        if (insertRetCode != TabInfoImpl.ROWNOTDUPLICATE)\n+            throw StandardException.newException(SQLState.LANG_DUPLICATE_KEY_CONSTRAINT,\n+                    \"SYSCOLUMNSTATISTICS_INDEX1\", SYSCOLUMNSTATISTICSRowFactory.TABLENAME_STRING);", "originalCommit": "04d59f87c9260a9df922d5cb99d9eabcf5f79242", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQyNzUyNQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3859#discussion_r458427525", "bodyText": "The thrown exception, number of parameter, and error code are not the same. Need to write at least three versions of insertOrThrow. I may do this later if that can make code much cleaner.", "author": "jyuanca", "createdAt": "2020-07-21T22:33:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU2MzkyOA=="}], "type": "inlineReview"}]}