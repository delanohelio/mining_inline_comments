{"pr_number": 4763, "pr_title": "DB-10918 DB-10940 Allow parameters on both sides of a binary comparison operator", "pr_createdAt": "2020-12-02T15:12:04Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/4763", "timeline": [{"oid": "cae738263432ae7440a6baef622856b64b93b0e2", "url": "https://github.com/splicemachine/spliceengine/commit/cae738263432ae7440a6baef622856b64b93b0e2", "message": "DB-10940 Fix parameterized constant restriction in prepared statement", "committedDate": "2020-12-02T14:46:21Z", "type": "commit"}, {"oid": "162127727c1941f2285c4d146a685e8063f4a72a", "url": "https://github.com/splicemachine/spliceengine/commit/162127727c1941f2285c4d146a685e8063f4a72a", "message": "DB-10918 Allow parameters on both sides of a binary comparison operator", "committedDate": "2020-12-02T14:48:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI5NTQ1Mg==", "url": "https://github.com/splicemachine/spliceengine/pull/4763#discussion_r534295452", "bodyText": "Change this to 'else if'", "author": "msirek", "createdAt": "2020-12-02T16:16:01Z", "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/BinaryComparisonOperatorNode.java", "diffHunk": "@@ -116,6 +116,24 @@ boolean getBetweenSelectivity() {\n         return betweenSelectivity;\n     }\n \n+    @Override\n+    protected void bindParameters() throws StandardException {\n+        if (leftOperand.requiresTypeFromContext()) {\n+            if (rightOperand.requiresTypeFromContext()) {\n+                // DB2 compatible behavior\n+                DataTypeDescriptor dtd = DataTypeDescriptor.getBuiltInDataTypeDescriptor(Types.VARCHAR, false, 254);\n+                leftOperand.setType(dtd);\n+                rightOperand.setType(dtd);\n+                return;\n+            } else {\n+                leftOperand.setType(rightOperand.getTypeServices());\n+            }\n+        }\n+\n+        if (rightOperand.requiresTypeFromContext()) {", "originalCommit": "162127727c1941f2285c4d146a685e8063f4a72a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDMyNTQ2Mw==", "url": "https://github.com/splicemachine/spliceengine/pull/4763#discussion_r534325463", "bodyText": "Done.", "author": "ascend1", "createdAt": "2020-12-02T16:54:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI5NTQ1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI5NTk2NQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4763#discussion_r534295965", "bodyText": "Change to 'else if'", "author": "msirek", "createdAt": "2020-12-02T16:16:36Z", "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/BinaryOperatorNode.java", "diffHunk": "@@ -322,6 +322,31 @@ public void printSubNodes(int depth)\n         }\n     }\n \n+    protected void bindParameters() throws StandardException {\n+        /* Is there a ? parameter on the left? */\n+        if (leftOperand.requiresTypeFromContext()) {\n+            /* Default Splice behavior:\n+             * It's an error if both operands are ? parameters.\n+             * This is overridden is some of the derived classes to be DB2 compatible.\n+             * DB2 doc on this:\n+             * https://www.ibm.com/support/knowledgecenter/SSEPGG_11.5.0/com.ibm.db2.luw.sql.ref.doc/doc/r0053561.html\n+             */\n+            if (rightOperand.requiresTypeFromContext()) {\n+                throw StandardException.newException(SQLState.LANG_BINARY_OPERANDS_BOTH_PARMS,\n+                        operator);\n+            }\n+\n+            /* Set the left operand to the type of right parameter. */\n+            leftOperand.setType(rightOperand.getTypeServices());\n+        }\n+\n+        /* Is there a ? parameter on the right? */\n+        if (rightOperand.requiresTypeFromContext()) {", "originalCommit": "162127727c1941f2285c4d146a685e8063f4a72a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDMyNjI2MQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4763#discussion_r534326261", "bodyText": "Done.", "author": "ascend1", "createdAt": "2020-12-02T16:55:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI5NTk2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI5ODU0OA==", "url": "https://github.com/splicemachine/spliceengine/pull/4763#discussion_r534298548", "bodyText": "Since you are not using the collected nodes, it would be more efficient to have a mode where CollectNodesVisitor stops searching once the first node is found.  Maybe create a new constructor that accepts a boolean as a 2nd parameter.", "author": "msirek", "createdAt": "2020-12-02T16:19:55Z", "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/ProjectRestrictNode.java", "diffHunk": "@@ -1719,6 +1721,10 @@ private void generateMinion(ExpressionClassBuilder acb,\n             // which is the static field that \"points\" to the userExprFun\n             // that evaluates the where clause.\n             acb.pushMethodReference(mb,userExprFun);\n+\n+            CollectNodesVisitor cnv = new CollectNodesVisitor(ParameterNode.class);\n+            constantRestriction.accept(cnv);\n+            mb.push(!cnv.getList().isEmpty());", "originalCommit": "162127727c1941f2285c4d146a685e8063f4a72a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDMyMzU2MQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4763#discussion_r534323561", "bodyText": "You're right. I just remember that we have a HasNodeVisitor. Will use that instead.", "author": "ascend1", "createdAt": "2020-12-02T16:52:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI5ODU0OA=="}], "type": "inlineReview"}, {"oid": "2278b3bb07f5112c4273f1956f073a8b4574bcd3", "url": "https://github.com/splicemachine/spliceengine/commit/2278b3bb07f5112c4273f1956f073a8b4574bcd3", "message": "DB-10918 Address comments", "committedDate": "2020-12-02T17:19:57Z", "type": "commit"}]}