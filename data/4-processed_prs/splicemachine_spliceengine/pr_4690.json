{"pr_number": 4690, "pr_title": "DB-10654 Hit an assertion error during restore", "pr_createdAt": "2020-11-24T19:11:06Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/4690", "timeline": [{"oid": "b411684f60b2739842848adb772e4405ff18e2f1", "url": "https://github.com/splicemachine/spliceengine/commit/b411684f60b2739842848adb772e4405ff18e2f1", "message": "DB-10654 referencecount is calculated dynamically", "committedDate": "2020-11-23T16:39:05Z", "type": "commit"}, {"oid": "0af3eb4781bbacc5979c30c713b106ade5c00e18", "url": "https://github.com/splicemachine/spliceengine/commit/0af3eb4781bbacc5979c30c713b106ade5c00e18", "message": "DB-10654 referencecount droped", "committedDate": "2020-11-24T19:03:06Z", "type": "commit"}, {"oid": "9dee802cd7a1c5bb61ccc8b97f63a948c6c63055", "url": "https://github.com/splicemachine/spliceengine/commit/9dee802cd7a1c5bb61ccc8b97f63a948c6c63055", "message": "DB-10654 small message fixes", "committedDate": "2020-11-24T19:05:23Z", "type": "commit"}, {"oid": "0046fb4beb7e77bc9998995da4b0c7d844e2d38a", "url": "https://github.com/splicemachine/spliceengine/commit/0046fb4beb7e77bc9998995da4b0c7d844e2d38a", "message": "master merged into DB-10654", "committedDate": "2020-11-24T19:09:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg0MTQ2Mg==", "url": "https://github.com/splicemachine/spliceengine/pull/4690#discussion_r529841462", "bodyText": "This drops SYSCONSTRAINTS table. However, you only want to drop a column from it.\nIf this is an extra column that's to be ignored, it is OK not to drop it.", "author": "jyuanca", "createdAt": "2020-11-24T19:56:43Z", "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/SpliceDataDictionary.java", "diffHunk": "@@ -1925,4 +1904,18 @@ public long getSystablesMinRetentionPeriod() {\n     public boolean useTxnAwareCache() {\n         return !SpliceClient.isRegionServer;\n     }\n+\n+    public void updateSysConstraintTable(TransactionController tc) throws StandardException {\n+        SchemaDescriptor sd = getSystemSchemaDescriptor();\n+        tc.elevate(\"dictionary\");\n+\n+        TableDescriptor td = getTableDescriptor(\"SYSCONSTRAINTS\", sd, tc);\n+        if (td != null) {\n+            dropAllColumnDescriptors(td.getUUID(), tc);\n+            dropTableDescriptor(td, sd, tc);\n+        }\n+\n+        createNaturalNumbersTable(tc);", "originalCommit": "0046fb4beb7e77bc9998995da4b0c7d844e2d38a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEwNzE2NQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4690#discussion_r530107165", "bodyText": "I'm interested to see the final code here before reviewing this.", "author": "msirek", "createdAt": "2020-11-25T04:53:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg0MTQ2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI0MDU0Ng==", "url": "https://github.com/splicemachine/spliceengine/pull/4690#discussion_r535240546", "bodyText": "I've rolled back my changes. The field will not be dropped.", "author": "ipraznik-splice", "createdAt": "2020-12-03T13:48:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg0MTQ2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIzMTA1OQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4690#discussion_r530231059", "bodyText": "Should we keep writing something here to prevent issues if we rollback to a previous version?\nSay we upgrade to this version, create a constraint, we write only 6 values. There's an issue with the upgrade, so we rollback to the previous version. When deserializing the descriptor for the new constraint we try to read the 7th column but fail.", "author": "dgomezferro", "createdAt": "2020-11-25T09:37:30Z", "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/catalog/SYSCONSTRAINTSRowFactory.java", "diffHunk": "@@ -198,9 +195,6 @@ public ExecRow makeRow(boolean latestVersion, TupleDescriptor td,TupleDescriptor\n \t\t/* 6th column is STATE (char(1)) */\n         row.setColumn(SYSCONSTRAINTS_STATE,new SQLChar(isEnabled?\"E\":\"D\"));\n \n-\t\t/* 7th column is REFERENCED */\n-        row.setColumn(SYSCONSTRAINTS_REFERENCECOUNT,new SQLInteger(referenceCount));\n-", "originalCommit": "0046fb4beb7e77bc9998995da4b0c7d844e2d38a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU0ODA4OA==", "url": "https://github.com/splicemachine/spliceengine/pull/4690#discussion_r530548088", "bodyText": "I recommend not to drop the column even it is not used", "author": "jyuanca", "createdAt": "2020-11-25T17:44:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIzMTA1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTI0MDY3NA==", "url": "https://github.com/splicemachine/spliceengine/pull/4690#discussion_r535240674", "bodyText": "I've rolled back my changes. The field will not be dropped.", "author": "ipraznik-splice", "createdAt": "2020-12-03T13:48:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIzMTA1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIzNTEzMw==", "url": "https://github.com/splicemachine/spliceengine/pull/4690#discussion_r530235133", "bodyText": "The optimization in getForeignKeyConstraints() no longer applies, because for the \"fast\" path we are getting the list of foreign keys from the data dictionary. It actually hurts because if we have the list cached we will always request it from the DD first. Please remove the optimization there and coordinate with @hatyo to make sure this doesn't make the creation of large FK hierarchies too slow.", "author": "dgomezferro", "createdAt": "2020-11-25T09:43:33Z", "path": "db-engine/src/main/java/com/splicemachine/db/iapi/sql/dictionary/ReferencedKeyConstraintDescriptor.java", "diffHunk": "@@ -270,9 +263,8 @@ else if (type == DISABLED)\n \t *\n \t * @return false\n \t */\n-\tpublic boolean isReferenced()\n-\t{\n-\t\treturn referenceCount != 0;\n+\tpublic boolean isReferenced() throws StandardException {\n+\t\treturn getReferenceCount() > 0;", "originalCommit": "0046fb4beb7e77bc9998995da4b0c7d844e2d38a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIzNjUyNA==", "url": "https://github.com/splicemachine/spliceengine/pull/4690#discussion_r530236524", "bodyText": "Thinking a bit more about it, we could use the same cache field fkConstraintList in getReferenceCount(), if it's already populated we have the list and don't need to retrieve it from the DD. If we haven't, we retrieve the list and update the field.", "author": "dgomezferro", "createdAt": "2020-11-25T09:45:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIzNTEzMw=="}], "type": "inlineReview"}, {"oid": "4a96a13fd6017fba5c7cea664b6282f497615f65", "url": "https://github.com/splicemachine/spliceengine/commit/4a96a13fd6017fba5c7cea664b6282f497615f65", "message": "DB-10654 rollback of dropnig of SYS column referencecount", "committedDate": "2020-11-25T12:15:17Z", "type": "commit"}, {"oid": "f09ca6d7f11fb46e16b4eaa3992f6d7d87d6d38d", "url": "https://github.com/splicemachine/spliceengine/commit/f09ca6d7f11fb46e16b4eaa3992f6d7d87d6d38d", "message": "DB-10654 conter is taken from cached list, cache is invalidated on update", "committedDate": "2020-11-26T14:27:17Z", "type": "commit"}, {"oid": "1f14f3d85d2dd7fde75911844e911d94168f99fa", "url": "https://github.com/splicemachine/spliceengine/commit/1f14f3d85d2dd7fde75911844e911d94168f99fa", "message": "master merged into DB-10654", "committedDate": "2020-11-26T17:19:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU3MTM2MA==", "url": "https://github.com/splicemachine/spliceengine/pull/4690#discussion_r531571360", "bodyText": "Do we need the throws here?", "author": "dgomezferro", "createdAt": "2020-11-27T12:22:31Z", "path": "db-engine/src/main/java/com/splicemachine/db/iapi/sql/dictionary/ReferencedKeyConstraintDescriptor.java", "diffHunk": "@@ -318,8 +284,7 @@ public int decrementReferenceCount()\n \t *\n \t * @return true/false\n \t */\n-\tpublic boolean needsToFire(int stmtType, int[] modifiedCols)\n-\t{\n+\tpublic boolean needsToFire(int stmtType, int[] modifiedCols) throws StandardException {", "originalCommit": "1f14f3d85d2dd7fde75911844e911d94168f99fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzI3NTM4MA==", "url": "https://github.com/splicemachine/spliceengine/pull/4690#discussion_r533275380", "bodyText": "please see below", "author": "ipraznik-splice", "createdAt": "2020-12-01T10:14:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU3MTM2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU3NzQ1OA==", "url": "https://github.com/splicemachine/spliceengine/pull/4690#discussion_r531577458", "bodyText": "Is the throws needed?", "author": "dgomezferro", "createdAt": "2020-11-27T12:35:53Z", "path": "db-engine/src/main/java/com/splicemachine/db/iapi/sql/dictionary/ConstraintDescriptor.java", "diffHunk": "@@ -308,7 +306,7 @@ public int getReferenceCount()\n \t *\n \t * @return true/false\n \t */\n-\tpublic abstract boolean needsToFire(int stmtType, int[] modifiedCols);\n+\tpublic abstract boolean needsToFire(int stmtType, int[] modifiedCols) throws StandardException;", "originalCommit": "1f14f3d85d2dd7fde75911844e911d94168f99fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzI3NDk4OA==", "url": "https://github.com/splicemachine/spliceengine/pull/4690#discussion_r533274988", "bodyText": "the methods isReferenced and getReferenceCount are changed to use fkConstraintList directly or to load from DataDictionary via getForeignKeys. The method getForeignKeys throws StandardException. I've added throws StandardException to this chain of methods. I can of course wrap with try/catch in getOrLoadFKConstraintList, but with throws is cleaner from my point of view.", "author": "ipraznik-splice", "createdAt": "2020-12-01T10:14:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU3NzQ1OA=="}], "type": "inlineReview"}, {"oid": "59c069765c30bd19456ef5a2fbd2d11c96514db0", "url": "https://github.com/splicemachine/spliceengine/commit/59c069765c30bd19456ef5a2fbd2d11c96514db0", "message": "Merge branch 'master' into DB-10654", "committedDate": "2020-12-01T13:59:22Z", "type": "commit"}, {"oid": "d39988b3895ee8333b4ffe1c68fdab77cc8bd7eb", "url": "https://github.com/splicemachine/spliceengine/commit/d39988b3895ee8333b4ffe1c68fdab77cc8bd7eb", "message": "DB-10654 table cache updated", "committedDate": "2020-12-03T13:41:30Z", "type": "commit"}, {"oid": "90c1ab10acf6ff30eb2c9f5ea4517dcc1c12c91f", "url": "https://github.com/splicemachine/spliceengine/commit/90c1ab10acf6ff30eb2c9f5ea4517dcc1c12c91f", "message": "Merge branch 'master' into DB-10654", "committedDate": "2020-12-03T13:45:54Z", "type": "commit"}, {"oid": "57a05cdcbd7b563ada6734556eeaec75d5dc9900", "url": "https://github.com/splicemachine/spliceengine/commit/57a05cdcbd7b563ada6734556eeaec75d5dc9900", "message": "DB-10654 spotbugs", "committedDate": "2020-12-03T14:29:55Z", "type": "commit"}]}