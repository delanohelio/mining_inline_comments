{"pr_number": 3663, "pr_title": "DB-9615 Add file logging to SQL shell.", "pr_createdAt": "2020-06-08T22:01:37Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/3663", "timeline": [{"oid": "1700fb2dbf30a73b179fa5f6262ff6ce94bdd4bd", "url": "https://github.com/splicemachine/spliceengine/commit/1700fb2dbf30a73b179fa5f6262ff6ce94bdd4bd", "message": "Add file logging to SQL shell.\n\n- Add commands spool <filename>, spool stop, and spool clear which\n  give the user the ability to log SQL statements to a local file.\n- spool <path> requires quoting the file path, i.e. spool '/tmp/log.txt'", "committedDate": "2020-06-26T13:47:45Z", "type": "commit"}, {"oid": "1700fb2dbf30a73b179fa5f6262ff6ce94bdd4bd", "url": "https://github.com/splicemachine/spliceengine/commit/1700fb2dbf30a73b179fa5f6262ff6ce94bdd4bd", "message": "Add file logging to SQL shell.\n\n- Add commands spool <filename>, spool stop, and spool clear which\n  give the user the ability to log SQL statements to a local file.\n- spool <path> requires quoting the file path, i.e. spool '/tmp/log.txt'", "committedDate": "2020-06-26T13:47:45Z", "type": "forcePushed"}, {"oid": "1a0c4020d39fcd5c9886e4d3fcdee627082cdcd6", "url": "https://github.com/splicemachine/spliceengine/commit/1a0c4020d39fcd5c9886e4d3fcdee627082cdcd6", "message": "Fix SpotBugs issues.", "committedDate": "2020-06-29T16:20:39Z", "type": "forcePushed"}, {"oid": "715199745c7e544031541daa25e0669469d3008b", "url": "https://github.com/splicemachine/spliceengine/commit/715199745c7e544031541daa25e0669469d3008b", "message": "Fix Spotbug issues.\n\n- add generated code the exclusion list of spotbug.", "committedDate": "2020-06-29T22:01:28Z", "type": "forcePushed"}, {"oid": "885c33d3e07aa5c5296d82f0298b842d0f271d84", "url": "https://github.com/splicemachine/spliceengine/commit/885c33d3e07aa5c5296d82f0298b842d0f271d84", "message": "Fix Spotbug issues.\n\n- add generated code the exclusion list of spotbug.", "committedDate": "2020-06-30T12:38:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY1NzE5MQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3663#discussion_r447657191", "bodyText": "You could use try with resource for both zf and bis to make this cleaner.", "author": "arnaud-splice", "createdAt": "2020-06-30T12:51:43Z", "path": "db-drda/src/main/java/com/splicemachine/db/impl/tools/sysinfo/Main.java", "diffHunk": "@@ -1035,43 +1022,61 @@ private static ZipInfoProperties checkDirectory(String dirname)\n     private static ZipInfoProperties checkFile(String filename)\n     {\n         // try to create a ZipFile from it\n+        InputStream bis = null;\n+        ZipFile zf = null;\n         try\n         {\n-            ZipFile zf = new ZipFile(filename);\n+            zf = new ZipFile(filename);", "originalCommit": "885c33d3e07aa5c5296d82f0298b842d0f271d84", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY1ODYzMA==", "url": "https://github.com/splicemachine/spliceengine/pull/3663#discussion_r447658630", "bodyText": "Why is this necessary?", "author": "arnaud-splice", "createdAt": "2020-06-30T12:54:09Z", "path": "db-tools-ij/src/main/grammar/ij.jj", "diffHunk": "@@ -3374,6 +3378,7 @@ HelpStatement() :\n \t\twhile (st.hasMoreTokens()) {\n \t\t    v.addElement(st.nextToken());\n \t\t}\n+\t\tv.addElement(\"Something\");", "originalCommit": "885c33d3e07aa5c5296d82f0298b842d0f271d84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE4NDk1Nw==", "url": "https://github.com/splicemachine/spliceengine/pull/3663#discussion_r450184957", "bodyText": "I was experimenting with something and this slipped through, thanks for finding it out.", "author": "hatyo", "createdAt": "2020-07-06T12:26:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY1ODYzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY1OTk2OQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3663#discussion_r447659969", "bodyText": "You don't need lookaheads in the next functions if you have one function that consumes SPOOL in which you have the three alternatives that call their respective functions.", "author": "arnaud-splice", "createdAt": "2020-06-30T12:56:18Z", "path": "db-tools-ij/src/main/grammar/ij.jj", "diffHunk": "@@ -4043,7 +4061,42 @@ ijResult CP_DisconnectStatement() throws SQLException\n \n }\n \n+ijResult LogToStatement() throws IOException", "originalCommit": "885c33d3e07aa5c5296d82f0298b842d0f271d84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIwMjAzMA==", "url": "https://github.com/splicemachine/spliceengine/pull/3663#discussion_r450202030", "bodyText": "That makes sense, thanks.", "author": "hatyo", "createdAt": "2020-07-06T12:57:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY1OTk2OQ=="}], "type": "inlineReview"}, {"oid": "ca3670857c0de63ddbd0a9ef99659d62d6ec4476", "url": "https://github.com/splicemachine/spliceengine/commit/ca3670857c0de63ddbd0a9ef99659d62d6ec4476", "message": "Fix Spotbug issues.\n\n- add generated code the exclusion list of spotbug.\n- address comments.", "committedDate": "2020-07-06T13:10:42Z", "type": "commit"}, {"oid": "ca3670857c0de63ddbd0a9ef99659d62d6ec4476", "url": "https://github.com/splicemachine/spliceengine/commit/ca3670857c0de63ddbd0a9ef99659d62d6ec4476", "message": "Fix Spotbug issues.\n\n- add generated code the exclusion list of spotbug.\n- address comments.", "committedDate": "2020-07-06T13:10:42Z", "type": "forcePushed"}, {"oid": "da34950a266bfe071cd31a7adf905bedd3b66892", "url": "https://github.com/splicemachine/spliceengine/commit/da34950a266bfe071cd31a7adf905bedd3b66892", "message": "Merge remote-tracking branch 'origin/master' into DB-9615", "committedDate": "2020-07-06T13:12:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIxMzI1OA==", "url": "https://github.com/splicemachine/spliceengine/pull/3663#discussion_r450213258", "bodyText": "You don't need this zf.close anymore", "author": "arnaud-splice", "createdAt": "2020-07-06T13:17:40Z", "path": "db-drda/src/main/java/com/splicemachine/db/impl/tools/sysinfo/Main.java", "diffHunk": "@@ -1027,52 +1014,42 @@ private static ZipInfoProperties checkDirectory(String dirname)\n     /**\n      * Check inside a jar file for the presence of a Derby info properties file.\n      * \n-     * @param filename\n-     *            the jar file to check\n+     * @param filename the jar file to check\n      * @return ZipInfoProperties with the jar file set as the location or null\n-     *         if not found.\n+     *  if not found, or an IOException occurs.\n      */\n     private static ZipInfoProperties checkFile(String filename)\n     {\n-        // try to create a ZipFile from it\n-        try\n+        // try to create a ZipFile from the file name\n+        try(ZipFile zf = new ZipFile(filename))\n         {\n-            ZipFile zf = new ZipFile(filename);\n             // try to get a ZipEntry from the ZipFile\n-\n             ZipEntry thisEntry = null;\n-\n-            for (int i =0; i < infoNames.length; i++)\n-            {\n-                thisEntry = zf.getEntry(infoNames[i]);\n-                if (thisEntry != null)\n-                {\n+            for (String infoName : infoNames) {\n+                thisEntry = zf.getEntry(infoName);\n+                if (thisEntry != null) {\n                     break;\n                 }\n             }\n-\n             if (thisEntry == null)\n             {\n+                zf.close();", "originalCommit": "da34950a266bfe071cd31a7adf905bedd3b66892", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bb2907da9ee0c66877ef505a24673cd9e90311b8", "url": "https://github.com/splicemachine/spliceengine/commit/bb2907da9ee0c66877ef505a24673cd9e90311b8", "message": "Address further comments.", "committedDate": "2020-07-06T14:18:56Z", "type": "commit"}, {"oid": "bb2907da9ee0c66877ef505a24673cd9e90311b8", "url": "https://github.com/splicemachine/spliceengine/commit/bb2907da9ee0c66877ef505a24673cd9e90311b8", "message": "Address further comments.", "committedDate": "2020-07-06T14:18:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc3NDE4NQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3663#discussion_r451774185", "bodyText": "We should close the FileOutputStream, relying on finalizers is very finicky", "author": "dgomezferro", "createdAt": "2020-07-08T19:23:41Z", "path": "db-tools-ij/src/main/java/com/splicemachine/db/impl/tools/ij/utilMain.java", "diffHunk": "@@ -845,4 +820,26 @@ int getCurrentRowNumber(ResultSet rs)\n \tpublic final Object run() {\n \t\treturn  getClass().getResourceAsStream(ProductGenusNames.TOOLS_INFO);\n \t}\n+\t@SuppressFBWarnings(value = \"RV_RETURN_VALUE_IGNORED_BAD_PRACTICE\",justification = \"Intentional, we don't care if the file already exists\")\n+\tpublic void startSpooling(String path) throws IOException {\n+\t\tdoSpool = true;\n+\t\tlogFileName = path;\n+\t\tFile f = new File(logFileName);\n+\t\tf.createNewFile(); // no-op if file exists.\n+\t\tthis.out = new LocalizedOutput(new ForkOutputStream(new FileOutputStream(f)));\n+\t}\n+\n+\tpublic void stopSpooling() {\n+\t\tdoSpool = false;\n+\t\tthis.out.flush();\n+\t\tthis.out = new LocalizedOutput(System.out);", "originalCommit": "bb2907da9ee0c66877ef505a24673cd9e90311b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjMzMDAwMw==", "url": "https://github.com/splicemachine/spliceengine/pull/3663#discussion_r452330003", "bodyText": "ok", "author": "hatyo", "createdAt": "2020-07-09T16:08:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc3NDE4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc3NTU4Mw==", "url": "https://github.com/splicemachine/spliceengine/pull/3663#discussion_r451775583", "bodyText": "Does this echo the commands to the terminal too? Is that what we want?", "author": "dgomezferro", "createdAt": "2020-07-08T19:26:22Z", "path": "db-tools-ij/src/main/java/com/splicemachine/db/impl/tools/ij/utilMain.java", "diffHunk": "@@ -320,6 +295,11 @@ private int runScriptGuts() {\n \t\t\t\tout.flush();\n \t\t\t\tcommand = commandGrabber[currCE].nextStatement();\n \n+\t\t\t\tif(doSpool) {", "originalCommit": "bb2907da9ee0c66877ef505a24673cd9e90311b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjMzMTM5MA==", "url": "https://github.com/splicemachine/spliceengine/pull/3663#discussion_r452331390", "bodyText": "From the JIRA ticket:\n\nthey asked for a function that would allow them to log sqlshell commands AND results to a file on demand\n\nLet's discuss improvements in a different JIRA maybe?", "author": "hatyo", "createdAt": "2020-07-09T16:10:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc3NTU4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM0NDE5Mg==", "url": "https://github.com/splicemachine/spliceengine/pull/3663#discussion_r452344192", "bodyText": "I mean this code seems to be echoing the typed command back to the terminal, so the users would see what they typed twice (once when they type it, once when it's echoed) and then the result. The spooled file would have the command once and the result once, which is correct. I might be wrong and we might not be echoing the command to the terminal again, but I wanted to make sure whether that's the case.", "author": "dgomezferro", "createdAt": "2020-07-09T16:31:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc3NTU4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgwNTk5NA==", "url": "https://github.com/splicemachine/spliceengine/pull/3663#discussion_r452805994", "bodyText": "Hi Daniel,\nsorry I misread you comment, you're right, we're writing the command twice to tty, I will adapt the change accordingly.", "author": "hatyo", "createdAt": "2020-07-10T12:15:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc3NTU4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgxMjAwNQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3663#discussion_r452812005", "bodyText": "No worries! Change looks good, thanks!", "author": "dgomezferro", "createdAt": "2020-07-10T12:29:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc3NTU4Mw=="}], "type": "inlineReview"}, {"oid": "e4fbe29b299c6d6e36c14d20e8aa25d1282becfb", "url": "https://github.com/splicemachine/spliceengine/commit/e4fbe29b299c6d6e36c14d20e8aa25d1282becfb", "message": "Merge remote-tracking branch 'origin/master' into DB-9615", "committedDate": "2020-07-09T16:05:37Z", "type": "commit"}, {"oid": "461510e9a6f95fee3f86dcb7dfb9acaeedc8ee7b", "url": "https://github.com/splicemachine/spliceengine/commit/461510e9a6f95fee3f86dcb7dfb9acaeedc8ee7b", "message": "Address further comments.", "committedDate": "2020-07-09T16:33:09Z", "type": "commit"}, {"oid": "a32754731d77606963f2e4c79ee0aeac97e4e578", "url": "https://github.com/splicemachine/spliceengine/commit/a32754731d77606963f2e4c79ee0aeac97e4e578", "message": "Address Daniel's comment about writing twice to std out.", "committedDate": "2020-07-10T12:21:18Z", "type": "commit"}, {"oid": "2ccf4be3eb095222f98897f1e7f56547479bf920", "url": "https://github.com/splicemachine/spliceengine/commit/2ccf4be3eb095222f98897f1e7f56547479bf920", "message": "Merge remote-tracking branch 'origin/master' into DB-9615", "committedDate": "2020-07-10T12:21:50Z", "type": "commit"}, {"oid": "bee802718a2528227168fcb9ece5c58d5397430b", "url": "https://github.com/splicemachine/spliceengine/commit/bee802718a2528227168fcb9ece5c58d5397430b", "message": "Address SpotBug issue.", "committedDate": "2020-07-10T12:58:23Z", "type": "commit"}]}