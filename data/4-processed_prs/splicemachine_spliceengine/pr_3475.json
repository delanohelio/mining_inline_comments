{"pr_number": 3475, "pr_title": "DB-9439 Handle carried bytes correctly when computing cutpoints", "pr_createdAt": "2020-04-23T11:36:34Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/3475", "timeline": [{"oid": "949f73d6bdcb44cc507a2122d7f1910ed1f99e7b", "url": "https://github.com/splicemachine/spliceengine/commit/949f73d6bdcb44cc507a2122d7f1910ed1f99e7b", "message": "DB-9439 Handle carried bytes correctly when computing cutpoints", "committedDate": "2020-04-23T11:34:44Z", "type": "commit"}, {"oid": "11b572fd16c283f60cf0ec4f712c79e1e8f6bcaa", "url": "https://github.com/splicemachine/spliceengine/commit/11b572fd16c283f60cf0ec4f712c79e1e8f6bcaa", "message": "DB-9439 Always check source for region sizes when computing splits", "committedDate": "2020-04-23T16:08:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE2NzkyMg==", "url": "https://github.com/splicemachine/spliceengine/pull/3475#discussion_r414167922", "bodyText": "Why do we need to add store.getMemStoreSize() in the calculation? How do we compute the cutpoint for content in memStore? I don't see any logic about it. Will all content in memStore go into one split?\nA few lines below bytesPerSplitEvenDistribution is computed which is the value eventually used as the splitBlockSize to calculate the cutpoints. And it uses this formula:\n            long bytesPerSplitEvenDistribution = totalStoreFileInBytes / numSplits;\n\nThis does not consider memStoreSize. is it intended?", "author": "yxia92", "createdAt": "2020-04-23T22:33:11Z", "path": "hbase_storage/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionUtil.java", "diffHunk": "@@ -98,7 +98,7 @@ public static void updateReadRequests(HRegion region,long numReads){\n                     totalStoreFileInBytes += ((HStoreFile) file).getFileInfo().getFileStatus().getLen();\n                 }\n             }\n-            numSplits = totalStoreFileInBytes / bytesPerSplit;\n+            numSplits = (totalStoreFileInBytes + store.getMemStoreSize()) / bytesPerSplit;", "originalCommit": "11b572fd16c283f60cf0ec4f712c79e1e8f6bcaa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQwMTAzOA==", "url": "https://github.com/splicemachine/spliceengine/pull/3475#discussion_r414401038", "bodyText": "Yes, it is intended. I added some comments to clarify since it can be confusing.\nBasically, we take into account the memstore size when computing bytesPerSplit but we weren't taking it into account when computing the splits, so we always were creating less splits than intended.\nBy taking into account the memstore size when computing the right numSplits, we make sure that at least we end up with the right amount of splits, even though some might be skewed if the data in the MemStore doesn't follow the same distribution as the data in the HFiles.", "author": "dgomezferro", "createdAt": "2020-04-24T08:41:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE2NzkyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDcwMjI5MQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3475#discussion_r414702291", "bodyText": "Thanks for the explanation!", "author": "yxia92", "createdAt": "2020-04-24T16:23:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE2NzkyMg=="}], "type": "inlineReview"}, {"oid": "f9693f9579bceb7de6fb777dae5c29603702f5df", "url": "https://github.com/splicemachine/spliceengine/commit/f9693f9579bceb7de6fb777dae5c29603702f5df", "message": "DB-9439 Add clarifying comments", "committedDate": "2020-04-24T08:38:42Z", "type": "commit"}, {"oid": "622e23edd31ce1d3ecfb9152884e3084ba56ae9c", "url": "https://github.com/splicemachine/spliceengine/commit/622e23edd31ce1d3ecfb9152884e3084ba56ae9c", "message": "DB-9439 Fix build, 2.0 API change", "committedDate": "2020-04-24T15:59:49Z", "type": "commit"}]}