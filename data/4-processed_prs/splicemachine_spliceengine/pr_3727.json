{"pr_number": 3727, "pr_title": "DB-9173 Select on SYS.SYSCOLUMNS fails when there is a table with column default specified.", "pr_createdAt": "2020-06-26T15:01:54Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/3727", "timeline": [{"oid": "f7ecca7040796cd4d2bc9144996884beb82ab0cd", "url": "https://github.com/splicemachine/spliceengine/commit/f7ecca7040796cd4d2bc9144996884beb82ab0cd", "message": "DB-9173 Select on SYS.SYSCOLUMNS fails when there is a table with column default specified.", "committedDate": "2020-06-25T08:11:46Z", "type": "commit"}, {"oid": "875a214bf656489515e7beeca98ed08b0f7c8120", "url": "https://github.com/splicemachine/spliceengine/commit/875a214bf656489515e7beeca98ed08b0f7c8120", "message": "DB-9173 SYSVM upgrade", "committedDate": "2020-06-25T08:18:03Z", "type": "commit"}, {"oid": "4946f5de15f9c6d10ffdec5cef8a140eed01060c", "url": "https://github.com/splicemachine/spliceengine/commit/4946f5de15f9c6d10ffdec5cef8a140eed01060c", "message": "DB-9173 SpotBugs fixed", "committedDate": "2020-06-25T12:24:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE0Mzg0Mg==", "url": "https://github.com/splicemachine/spliceengine/pull/3727#discussion_r447143842", "bodyText": "The view is in SYSVW not SYSVM. Could you correct?", "author": "yxia92", "createdAt": "2020-06-29T17:44:02Z", "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/SpliceDataDictionary.java", "diffHunk": "@@ -360,16 +360,25 @@ public void updateColumnViewInSysIBM(TransactionController tc) throws StandardEx\n                 // drop the view deifnition\n                 dropAllColumnDescriptors(td.getUUID(), tc);\n                 dropViewDescriptor(vd, tc);\n-                dropTableDescriptor(td, sysIBMSchemaDesc, tc);\n+                dropTableDescriptor(td, schemaDescriptor, tc);\n             }\n \n             // add new view deifnition\n-            createOneSystemView(tc, SYSCOLUMNS_CATALOG_NUM, \"SYSCOLUMNS\", 1, sysIBMSchemaDesc, SYSCOLUMNSRowFactory.SYSCOLUMNS_VIEW_IN_SYSIBM);\n+            createOneSystemView(tc, SYSCOLUMNS_CATALOG_NUM, tableName, viewIndex, schemaDescriptor, viewDef);\n \n-            SpliceLogUtils.info(LOG, \"The view syscolumns in SYSIBM has been updated with default column!\");\n+            SpliceLogUtils.info(LOG, String.format(\"The view %s in %s has been updated with default column!\", tableName, schemaDescriptor.getSchemaName()));\n         }\n     }\n \n+\n+    public void updateColumnViewInSysIBM(TransactionController tc) throws StandardException {\n+        updateColumnViewInSys(tc, \"SYSCOLUMNS\", 1, sysIBMSchemaDesc, SYSCOLUMNSRowFactory.SYSCOLUMNS_VIEW_IN_SYSIBM);\n+    }\n+\n+    public void updateColumnViewInSysVM(TransactionController tc) throws StandardException {", "originalCommit": "4946f5de15f9c6d10ffdec5cef8a140eed01060c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU5MzQ5Mw==", "url": "https://github.com/splicemachine/spliceengine/pull/3727#discussion_r447593493", "bodyText": "fixed", "author": "ipraznik-splice", "createdAt": "2020-06-30T10:52:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE0Mzg0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE0NDI0NQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3727#discussion_r447144245", "bodyText": "It is in SYSVW schema.", "author": "yxia92", "createdAt": "2020-06-29T17:44:43Z", "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/upgrade/UpgradeScriptForAddDefaultToColumnViewInSYSVM.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ * Copyright (c) 2012 - 2020 Splice Machine, Inc.\n+ *\n+ * This file is part of Splice Machine.\n+ * Splice Machine is free software: you can redistribute it and/or modify it under the terms of the\n+ * GNU Affero General Public License as published by the Free Software Foundation, either\n+ * version 3, or (at your option) any later version.\n+ * Splice Machine is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;\n+ * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n+ * See the GNU Affero General Public License for more details.\n+ * You should have received a copy of the GNU Affero General Public License along with Splice Machine.\n+ * If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package com.splicemachine.derby.impl.sql.catalog.upgrade;\n+\n+import com.splicemachine.db.iapi.error.StandardException;\n+import com.splicemachine.db.iapi.store.access.TransactionController;\n+import com.splicemachine.derby.impl.sql.catalog.SpliceDataDictionary;\n+import com.splicemachine.utils.SpliceLogUtils;\n+\n+/**\n+ * Created by Igor Praznik on 06/24/2020.\n+ */\n+public class UpgradeScriptForAddDefaultToColumnViewInSYSVM extends UpgradeScriptBase {\n+    public UpgradeScriptForAddDefaultToColumnViewInSYSVM(SpliceDataDictionary sdd, TransactionController tc) {\n+        super(sdd, tc);\n+    }\n+\n+    @Override\n+    protected void upgradeSystemTables() throws StandardException {\n+        sdd.updateColumnViewInSysVM(tc);\n+\n+        // we need to re-generate the metadataSPS if it is a change of definition of the table/column views in sysVM\n+        sdd.updateMetadataSPSes(tc);\n+\n+        SpliceLogUtils.info(LOG, \"Catalog upgraded: updated syscolumns view in SYSVM schema\");", "originalCommit": "4946f5de15f9c6d10ffdec5cef8a140eed01060c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU5MzYwMg==", "url": "https://github.com/splicemachine/spliceengine/pull/3727#discussion_r447593602", "bodyText": "fixed", "author": "ipraznik-splice", "createdAt": "2020-06-30T10:52:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE0NDI0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU5NDAzNg==", "url": "https://github.com/splicemachine/spliceengine/pull/3727#discussion_r447594036", "bodyText": "the upgrade has been tested, as you described", "author": "ipraznik-splice", "createdAt": "2020-06-30T10:53:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE0NDI0NQ=="}], "type": "inlineReview"}, {"oid": "d9eec80c1d648bb3222589e582fe1323a3747181", "url": "https://github.com/splicemachine/spliceengine/commit/d9eec80c1d648bb3222589e582fe1323a3747181", "message": "DB-9173 SYSVM typo corrected", "committedDate": "2020-06-30T10:17:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYwNjA4MA==", "url": "https://github.com/splicemachine/spliceengine/pull/3727#discussion_r447606080", "bodyText": "If we target this week's build, you will need to set this to 1962", "author": "arnaud-splice", "createdAt": "2020-06-30T11:18:25Z", "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/upgrade/SpliceCatalogUpgradeScripts.java", "diffHunk": "@@ -83,6 +83,7 @@ else if(v1==v2)\n         scripts.put(new Splice_DD_Version(sdd,3,1,0, 1953), new UpgradeScriptForRemoveUnusedIndexInSYSFILESTable(sdd,tc));\n         scripts.put(new Splice_DD_Version(sdd,3,1,0, 1954), new UpgradeScriptToInvalidateStoredStatement(sdd,tc));\n         scripts.put(new Splice_DD_Version(sdd,3,1,0, 1959), new UpgradeScriptForTriggerMultipleStatements(sdd,tc));\n+        scripts.put(new Splice_DD_Version(sdd,3,1,0, 1961), new UpgradeScriptForAddDefaultToColumnViewInSYSVW(sdd,tc));", "originalCommit": "d9eec80c1d648bb3222589e582fe1323a3747181", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg5MzkwNg==", "url": "https://github.com/splicemachine/spliceengine/pull/3727#discussion_r448893906", "bodyText": "The version has been updated", "author": "ipraznik-splice", "createdAt": "2020-07-02T10:06:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYwNjA4MA=="}], "type": "inlineReview"}, {"oid": "8802a4f2897bbb45996ecbdda97e0be6e6249c44", "url": "https://github.com/splicemachine/spliceengine/commit/8802a4f2897bbb45996ecbdda97e0be6e6249c44", "message": "DB-9173 Build version in upgrade updated", "committedDate": "2020-07-02T10:03:58Z", "type": "commit"}]}