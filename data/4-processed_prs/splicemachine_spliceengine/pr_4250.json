{"pr_number": 4250, "pr_title": "DB-10431 Fix row decoding in inserting into table with expr index", "pr_createdAt": "2020-10-08T14:10:43Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/4250", "timeline": [{"oid": "bdcc4c6bd9522f1f34dcf0b626072650029e4f8c", "url": "https://github.com/splicemachine/spliceengine/commit/bdcc4c6bd9522f1f34dcf0b626072650029e4f8c", "message": "DB-10431 Fix row decoding in inserting into table with expr index", "committedDate": "2020-10-08T13:29:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzgxNTU2MA==", "url": "https://github.com/splicemachine/spliceengine/pull/4250#discussion_r503815560", "bodyText": "could you also verify the results of these operations?", "author": "hatyo", "createdAt": "2020-10-13T09:45:38Z", "path": "splice_machine/src/test/java/com/splicemachine/derby/impl/sql/actions/index/IndexIT.java", "diffHunk": "@@ -964,6 +964,21 @@ public void testCreateIndexAndInsertWithExpressionsNullInput() throws Exception\n          */\n     }\n \n+    // DB-10431\n+    @Test\n+    public void testCreateIndexAndInsertWithExpressionsBatchWithFullNullRow() throws Exception {\n+        String tableName = \"TEST_IDX_BATCH_INSERT\";\n+        methodWatcher.executeUpdate(format(\"create table %s (c char(4), i int, d double)\", tableName));\n+        methodWatcher.executeUpdate(format(\"insert into %s values ('abc', 10, 1.1), ('def', 20, 2.2)\", tableName));\n+\n+        methodWatcher.executeUpdate(format(\"CREATE INDEX %s_IDX ON %s (upper(c), i + 2)\", tableName, tableName));\n+\n+        // Without the fix, the following insert fails sporadically. It depends on the order of inserting rows. If\n+        // (NULL, NULL, NULL) is inserted first, it fails. With the fix, it should never fail.\n+        methodWatcher.executeUpdate(format(\"insert into %s values ('jkl', 30, 2.2), (NULL, NULL, NULL)\", tableName));\n+        methodWatcher.executeUpdate(format(\"update %s set c = 'def' where i = 10\", tableName));", "originalCommit": "bdcc4c6bd9522f1f34dcf0b626072650029e4f8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk2OTM2MQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4250#discussion_r504969361", "bodyText": "Yes. Since we have only the index expr DDL/DML changes in master, we cannot query using the index yet. Nevertheless, I verify the result by issuing a select without the expr index to make sure insert and update ops modify data as expected.", "author": "ascend1", "createdAt": "2020-10-14T21:00:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzgxNTU2MA=="}], "type": "inlineReview"}, {"oid": "4731e2fde88f6cc20ef50faaab242d6f11b9e833", "url": "https://github.com/splicemachine/spliceengine/commit/4731e2fde88f6cc20ef50faaab242d6f11b9e833", "message": "DB-10431 Address comment", "committedDate": "2020-10-14T20:56:17Z", "type": "commit"}, {"oid": "16e476a80bec213c622115102d08d57328d84e9e", "url": "https://github.com/splicemachine/spliceengine/commit/16e476a80bec213c622115102d08d57328d84e9e", "message": "Merge branch 'master' into DB-10431", "committedDate": "2020-10-14T20:57:02Z", "type": "commit"}]}