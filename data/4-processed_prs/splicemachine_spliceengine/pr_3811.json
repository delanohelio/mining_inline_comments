{"pr_number": 3811, "pr_title": "DB-9782 improve ExternalTableIT to handle more column types / unify tests", "pr_createdAt": "2020-07-12T21:03:59Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/3811", "timeline": [{"oid": "32dc47f9fddf01c4111716c3cc97436256cca2a4", "url": "https://github.com/splicemachine/spliceengine/commit/32dc47f9fddf01c4111716c3cc97436256cca2a4", "message": "DB-9782 better ExternalTableIT\n\nnow for ORC/PARQUET/AVRO in one function:\n- testCannotDeleteOrUpdateExternalTable\n- testEmptyDirectory\n- testLocationCannotBeAFile\n- refreshRequireExternalTable", "committedDate": "2020-07-12T19:46:20Z", "type": "commit"}, {"oid": "732880a64c5fbf9fe1eb29c83e766387b79053f9", "url": "https://github.com/splicemachine/spliceengine/commit/732880a64c5fbf9fe1eb29c83e766387b79053f9", "message": "DB-9782 testModifyExtTableFails\n\nreplacing\n- testCannotAlterExternalTable/Avro\n- testCannotAddIndexToExternalTable/Avro\n- testCannotAddTriggerToExternalTable/Avro", "committedDate": "2020-07-12T19:50:32Z", "type": "commit"}, {"oid": "70cd60f4f87a23e0b329c48bcfc610a645d381e0", "url": "https://github.com/splicemachine/spliceengine/commit/70cd60f4f87a23e0b329c48bcfc610a645d381e0", "message": "DB-9782 testWriteX\n\nfor Parquet/AVRO/ORC\n- testWriteToWrongPartitionedParquetExternalTable\n- testWriteToNotPermittedLocation", "committedDate": "2020-07-12T19:52:40Z", "type": "commit"}, {"oid": "74d6e813b831b24b4acfd76eec59aa37dc6eb921", "url": "https://github.com/splicemachine/spliceengine/commit/74d6e813b831b24b4acfd76eec59aa37dc6eb921", "message": "DB-9782 testCollectStats/testWriteReadArrays\n\nreplacing\n- testCollectStats/Text/Parquet/Avro\n- testWriteReadArraysParquet/Avro/ORC\n- testWriteReadArraysWithStatsParquet/Avro", "committedDate": "2020-07-12T19:54:03Z", "type": "commit"}, {"oid": "acc4b1bd1f11ff309d1806c2f95ae6a17a2e2d67", "url": "https://github.com/splicemachine/spliceengine/commit/acc4b1bd1f11ff309d1806c2f95ae6a17a2e2d67", "message": "DB-9782 testShowCreateTableOrcExternalTable\n\nreplacing\n- testShowCreateTable{Parquet/Avro/Orc}ExternalTable", "committedDate": "2020-07-12T19:58:28Z", "type": "commit"}, {"oid": "64904f9dcaab697737e062e33851dde77e86feb2", "url": "https://github.com/splicemachine/spliceengine/commit/64904f9dcaab697737e062e33851dde77e86feb2", "message": "DB-9782 simplifying tests for invalid syntax / unsupported ops on ext.tables", "committedDate": "2020-07-12T20:04:47Z", "type": "commit"}, {"oid": "ee4f7f689b0c0ad79480b146e3538078de586a00", "url": "https://github.com/splicemachine/spliceengine/commit/ee4f7f689b0c0ad79480b146e3538078de586a00", "message": "DB-9782 unifying write/read from ext tables with all column types", "committedDate": "2020-07-12T20:57:50Z", "type": "commit"}, {"oid": "41935beb67f161ea0d395570ba993ecc4c0eafb1", "url": "https://github.com/splicemachine/spliceengine/commit/41935beb67f161ea0d395570ba993ecc4c0eafb1", "message": "DB-9782 ExternalTableIT: repair broken IT", "committedDate": "2020-07-13T14:13:39Z", "type": "commit"}, {"oid": "ec0cf8c7913a1caca33446f2fd2a26f34400baf6", "url": "https://github.com/splicemachine/spliceengine/commit/ec0cf8c7913a1caca33446f2fd2a26f34400baf6", "message": "DB-9782 Use streams", "committedDate": "2020-07-15T06:34:49Z", "type": "commit"}, {"oid": "e0e3d1f8f0251dd4538209bddc065ee1dc2abaab", "url": "https://github.com/splicemachine/spliceengine/commit/e0e3d1f8f0251dd4538209bddc065ee1dc2abaab", "message": "DB-9782 simplify ExternalTablePartitionIT", "committedDate": "2020-07-15T09:23:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkyNTM5Mw==", "url": "https://github.com/splicemachine/spliceengine/pull/3811#discussion_r454925393", "bodyText": "I guess this could also be replaced by streams, but that's not blocking", "author": "arnaud-splice", "createdAt": "2020-07-15T09:41:30Z", "path": "hbase_sql/src/test/java/com/splicemachine/derby/impl/sql/execute/operations/CreateTableTypeHelper.java", "diffHunk": "@@ -0,0 +1,243 @@\n+package com.splicemachine.derby.impl.sql.execute.operations;\n+\n+import org.junit.Assert;\n+\n+import java.sql.Clob;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.sql.Types;\n+import java.time.format.DateTimeFormatter;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Locale;\n+import java.util.function.Consumer;\n+import java.util.function.IntFunction;\n+import java.util.stream.Collectors;\n+\n+/// a helper class to define column types, and then create external tables and insert data into them\n+/// to make writing tests for all column types easier.\n+\n+public class CreateTableTypeHelper {\n+    /// @param types: an array of Types that should be used\n+    /// @param ivalues: an array of values to use. 0 is NULL value, all other values will\n+    /// generate corresponding entries that are somewhat associated with the integer val\n+    /// e.g. mostly if the int values increase, the corresponding e.g. date value also increases.\n+    public CreateTableTypeHelper(int[] types, int[] ivalues)\n+    {\n+        schema = Arrays.stream(types).mapToObj(this::getTypesName).collect(Collectors.joining(\", \"));\n+        suggestedTypes = Arrays.stream(types).mapToObj(this::getTypesNameInfered).collect(Collectors.joining(\", \"));\n+\n+        IntFunction<String> iValueStringFunc = ivalue -> Arrays.stream(types)\n+                .mapToObj(type -> getTypeValue(type, ivalue))\n+                .collect(Collectors.joining(\", \"));\n+\n+        values2 = Arrays.stream(ivalues).mapToObj(iValueStringFunc).sorted().collect(Collectors.toList());\n+        insertValues = Arrays.stream(ivalues).mapToObj(iValueStringFunc).map(s -> \"(\" + s + \")\").collect(Collectors.joining(\", \"));\n+    }\n+\n+    public String getInsertValues() {\n+        return insertValues;\n+    }\n+\n+    /// @return schema as to be used in `create external table <NAME> ( <SCHEMA> ) ...`\n+    public String getSchema()\n+    {\n+        return schema;\n+    }\n+\n+    /// @return schema that will be returned when suggesting a schema to the user.\n+    public String getSuggestedTypes() {\n+        return suggestedTypes;\n+    }\n+\n+\n+    /// @return types that are supported by Parquet\n+    static public int[] getParquetTypes() {\n+        return new int[]{\n+                Types.VARCHAR, Types.CHAR,\n+                Types.DATE, Types.TIMESTAMP,\n+                // Types.TIME, // supported, but will be written as TIMESTAMP\n+                Types.TINYINT, Types.SMALLINT, Types.INTEGER, Types.BIGINT,\n+                Types.DOUBLE, Types.REAL, Types.DECIMAL, Types.BOOLEAN\n+        };\n+    }\n+\n+    /// @return types that are supported by ORC\n+    static public int[] getORCTypes() {\n+        return new int[]{\n+                Types.VARCHAR, Types.CHAR,\n+                Types.DATE, Types.TIMESTAMP,\n+                // Types.TIME, // supported, but will be written as TIMESTAMP\n+                Types.TINYINT, Types.SMALLINT, Types.INTEGER, Types.BIGINT,\n+                Types.DOUBLE, Types.REAL, Types.DECIMAL, Types.BOOLEAN\n+        };\n+    }\n+\n+    /// @return types that are supported by Avro\n+    static public int[] getAvroTypes() {\n+        return new int[]{\n+                Types.VARCHAR, Types.CHAR,\n+                // Types.DATE, Types.TIME // not supported\n+                Types.TIMESTAMP,\n+                //Types.TINYINT, Types.SMALLINT, // not supported\n+                Types.INTEGER, Types.BIGINT,\n+                Types.DOUBLE, Types.REAL,\n+                // Types.DECIMAL, // not supported\n+                Types.BOOLEAN\n+        };\n+    }\n+\n+    /// @return supported types by fileFormat PARQUET, ORC or AVRO\n+    static public int[] getTypes(String fileFormat) {\n+        if(fileFormat.equalsIgnoreCase(\"PARQUET\"))\n+            return getParquetTypes();\n+        else if(fileFormat.equalsIgnoreCase(\"ORC\"))\n+            return getORCTypes();\n+        else if(fileFormat.equalsIgnoreCase(\"AVRO\"))\n+            return getAvroTypes();\n+        throw new RuntimeException(\"unsupported fileformat \" + fileFormat);\n+    }\n+\n+    /// compare that result in ResultSet rs is the same as from the generated insert values.\n+    public void checkResultSetSelectAll(ResultSet rs) throws SQLException {\n+        ArrayList<String> results = new ArrayList<>();\n+        int nCols = rs.getMetaData().getColumnCount();\n+        while (rs.next()) {\n+            StringBuilder sb = new StringBuilder();\n+            for (int i = 1; i <= nCols; i++) {\n+                Object value = rs.getObject(i);\n+                if (value != null && value instanceof Clob) {\n+                    throw new RuntimeException(\"Clob not supported\");\n+                } else {\n+                    if( i > 1 ) sb.append(\", \");\n+                    if( value != null && value.toString() != null ) {\n+                        sb.append(\"'\");\n+                        sb.append(value.toString());\n+                        sb.append(\"'\");\n+                    }\n+                    else {\n+                        sb.append(\"NULL\");\n+                    }\n+                }\n+            }\n+            results.add(sb.toString());\n+        }\n+        results.sort(String::compareTo);", "originalCommit": "e0e3d1f8f0251dd4538209bddc065ee1dc2abaab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk4Njc1MQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3811#discussion_r454986751", "bodyText": "ResultSet doesn't have streaming interface, would need 1-2 helper classes for this.", "author": "martinrupp", "createdAt": "2020-07-15T11:38:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkyNTM5Mw=="}], "type": "inlineReview"}, {"oid": "98032803ba19149df80b3b5649f265bfda31278e", "url": "https://github.com/splicemachine/spliceengine/commit/98032803ba19149df80b3b5649f265bfda31278e", "message": "DB-9782 code review: fix javadoc comments", "committedDate": "2020-07-15T12:59:01Z", "type": "commit"}]}