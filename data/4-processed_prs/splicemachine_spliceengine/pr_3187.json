{"pr_number": 3187, "pr_title": "DB-8893 Time travel at session level", "pr_createdAt": "2020-02-03T11:04:04Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/3187", "timeline": [{"oid": "4c23f1411dc39dc0b54dfa7535e96ce72b501c04", "url": "https://github.com/splicemachine/spliceengine/commit/4c23f1411dc39dc0b54dfa7535e96ce72b501c04", "message": "DB-8893 Time travel at session level", "committedDate": "2020-02-03T11:00:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI3NDIxNQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3187#discussion_r380274215", "bodyText": "We could catch NumberFormatException rather than the all catching Exception\nAlso, rename parseIntE to parseLongE", "author": "arnaud-splice", "createdAt": "2020-02-17T16:24:12Z", "path": "db-engine/src/main/java/com/splicemachine/db/iapi/sql/conn/SessionProperties.java", "diffHunk": "@@ -114,6 +115,14 @@ public int getId() {\n                 if (recursivequeryIterationLimit <= 0)\n                     throw StandardException.newException(SQLState.LANG_INVALID_SESSION_PROPERTY_VALUE, valString, \"value should be a positive integer or null\");\n                 break;\n+            case SNAPSHOT_TIMESTAMP:\n+                long timestamp;\n+                try {\n+                    timestamp = Long.parseLong(valString);\n+                } catch (Exception parseIntE) {", "originalCommit": "4c23f1411dc39dc0b54dfa7535e96ce72b501c04", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjE0MzA0MQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3187#discussion_r382143041", "bodyText": "Done", "author": "dgomezferro", "createdAt": "2020-02-20T17:19:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI3NDIxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI3NDU2Nw==", "url": "https://github.com/splicemachine/spliceengine/pull/3187#discussion_r380274567", "bodyText": "You don't test for positive long here, only long. If you wanna test positive, add an if after the try_catch. Or change the error message", "author": "arnaud-splice", "createdAt": "2020-02-17T16:24:55Z", "path": "db-engine/src/main/java/com/splicemachine/db/iapi/sql/conn/SessionProperties.java", "diffHunk": "@@ -114,6 +115,14 @@ public int getId() {\n                 if (recursivequeryIterationLimit <= 0)\n                     throw StandardException.newException(SQLState.LANG_INVALID_SESSION_PROPERTY_VALUE, valString, \"value should be a positive integer or null\");\n                 break;\n+            case SNAPSHOT_TIMESTAMP:\n+                long timestamp;\n+                try {\n+                    timestamp = Long.parseLong(valString);\n+                } catch (Exception parseIntE) {\n+                    throw StandardException.newException(SQLState.LANG_INVALID_SESSION_PROPERTY_VALUE, valString, \"value should be a positive long\");", "originalCommit": "4c23f1411dc39dc0b54dfa7535e96ce72b501c04", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI3OTc3Mg==", "url": "https://github.com/splicemachine/spliceengine/pull/3187#discussion_r380279772", "bodyText": "Is it even possible to combine !read_only with a snapshot timestamp? Shouldn't we throw something then?\nWhat about line 523 of this file where we call !isReadOnly, should we also check against SNAPSHOT_TIMESTAMP?\nWhat about SYSSTATEMENTSRowFactory.java:301?\nIf a check could be applied to all those, I'd push the session check inside isReadOnlyUpgrade(llc)", "author": "arnaud-splice", "createdAt": "2020-02-17T16:34:47Z", "path": "db-engine/src/main/java/com/splicemachine/db/iapi/sql/dictionary/SPSDescriptor.java", "diffHunk": "@@ -298,7 +299,8 @@ private void compileStatement(LanguageConnectionContext lcc,\n         setCompileTime();\n         setParams(preparedStatement.getParameterTypes());\n \n-        if (!dd.isReadOnlyUpgrade()) {\n+        if (!dd.isReadOnlyUpgrade() &&", "originalCommit": "4c23f1411dc39dc0b54dfa7535e96ce72b501c04", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjEyNDY2Mw==", "url": "https://github.com/splicemachine/spliceengine/pull/3187#discussion_r382124663", "bodyText": "I'm not sure what you mean with the first question. !readOnlyUpgrade is the \"default\" state, and whenever we have a snapshot timestamp readOnlyUpgrade will most likely be false. What I don't think should ever happen is readOnlyUpgrade==true && snapshotTimestamp != null. Does that answer your question?\nOn line 523 and SYSSTATEMENTSRowFactory.java:301 we don't need to check for a snapshotTimestamp, on the first case we end up checking on updateSYSSTATEMENTS() line 905 (we want to compile the statement, and avoid writing it to the DB)", "author": "dgomezferro", "createdAt": "2020-02-20T16:47:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI3OTc3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjU0MTEwOQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3187#discussion_r382541109", "bodyText": "All right, makes sense :)", "author": "arnaud-splice", "createdAt": "2020-02-21T11:50:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI3OTc3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI4MjY1MA==", "url": "https://github.com/splicemachine/spliceengine/pull/3187#discussion_r380282650", "bodyText": "This \"snapshot\" kinda looks like a magic value here.\nSince both \"olapQueue\" and \"snapshot\" are magic'ed in GenericLanguageConnectionContext, why not define constants there and use it here?\nAlthough, does that even work? I'd think that sessionProperties are set in GenericLanguageConnectionContext with enums already and that \"snapshot\" would only be available in the connectionProperties", "author": "arnaud-splice", "createdAt": "2020-02-17T16:40:47Z", "path": "db-engine/src/main/java/com/splicemachine/db/impl/db/BasicDatabase.java", "diffHunk": "@@ -279,7 +280,14 @@ public LanguageConnectionContext setupConnection(ContextManager cm, String user,\n \t\t\t\t\t\t\t\t\t\t\t\t\t Properties sessionProperties)\n \t\tthrows StandardException {\n \n-\t\tTransactionController tc = getConnectionTransaction(cm);\n+\t\tString snapshot = sessionProperties.getProperty(\"snapshot\");", "originalCommit": "4c23f1411dc39dc0b54dfa7535e96ce72b501c04", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjE0NDExMg==", "url": "https://github.com/splicemachine/spliceengine/pull/3187#discussion_r382144112", "bodyText": "I moved all hardcoded strings to com.splicemachine.db.iapi.reference.Property", "author": "dgomezferro", "createdAt": "2020-02-20T17:21:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI4MjY1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI4NTc0MA==", "url": "https://github.com/splicemachine/spliceengine/pull/3187#discussion_r380285740", "bodyText": "unnecessary new line", "author": "arnaud-splice", "createdAt": "2020-02-17T16:47:41Z", "path": "db-tools-i18n/src/main/resources/com/splicemachine/db/loc/messages.xml", "diffHunk": "@@ -8928,6 +8933,7 @@ Shutting down instance {0} on database directory {1} with class loader {2} </tex\n                <arg>configurationField</arg>\n            </msg>\n \n+", "originalCommit": "4c23f1411dc39dc0b54dfa7535e96ce72b501c04", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI4NjQ4NQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3187#discussion_r380286485", "bodyText": "update copyright", "author": "arnaud-splice", "createdAt": "2020-02-17T16:49:20Z", "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/store/access/PastTransaction.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright (c) 2012 - 2019 Splice Machine, Inc.", "originalCommit": "4c23f1411dc39dc0b54dfa7535e96ce72b501c04", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI4NzYzNQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3187#discussion_r380287635", "bodyText": "Should we throw an exception?\nIn any case, this XXX should either be addressed or removed. We might wanna replace the whole thing with assert cm != null", "author": "arnaud-splice", "createdAt": "2020-02-17T16:51:45Z", "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/store/access/SpliceAccessManager.java", "diffHunk": "@@ -326,6 +326,48 @@ public TransactionController getTransaction(ContextManager cm) throws StandardEx\n         return getAndNameTransaction(cm, AccessFactoryGlobals.USER_TRANS_NAME);\n     }\n \n+    public TransactionController getReadOnlyTransaction(ContextManager cm, long id) throws StandardException {\n+        String transName = AccessFactoryGlobals.USER_TRANS_NAME;\n+\n+        /*\n+         * This call represents the top-level transactional access point. E.g., the top-level user transaction\n+         * is created by a call to this method. In this case we are creating a read only transaction at a predefined point\n+         */\n+        if (LOG.isDebugEnabled())\n+            LOG.debug(\"in SpliceAccessManager - getAndNameTransaction, transName=\" + transName);\n+        if (cm == null)\n+            return null;  // XXX (nat) should throw exception", "originalCommit": "4c23f1411dc39dc0b54dfa7535e96ce72b501c04", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjE0NDM1Mg==", "url": "https://github.com/splicemachine/spliceengine/pull/3187#discussion_r382144352", "bodyText": "I raise an NPE here", "author": "dgomezferro", "createdAt": "2020-02-20T17:21:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI4NzYzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDMwODE4OA==", "url": "https://github.com/splicemachine/spliceengine/pull/3187#discussion_r380308188", "bodyText": "copyright", "author": "arnaud-splice", "createdAt": "2020-02-17T17:43:46Z", "path": "splice_si_api/src/main/java/com/splicemachine/si/impl/PastTransactionImpl.java", "diffHunk": "@@ -0,0 +1,136 @@\n+/*\n+ * Copyright (c) 2012 - 2019 Splice Machine, Inc.", "originalCommit": "4c23f1411dc39dc0b54dfa7535e96ce72b501c04", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDMxMjUxOQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3187#discussion_r380312519", "bodyText": "Should that include the timestamp of our time travel?", "author": "arnaud-splice", "createdAt": "2020-02-17T17:55:56Z", "path": "splice_si_api/src/main/java/com/splicemachine/si/impl/PastTransactionImpl.java", "diffHunk": "@@ -0,0 +1,136 @@\n+/*\n+ * Copyright (c) 2012 - 2019 Splice Machine, Inc.\n+ *\n+ * This file is part of Splice Machine.\n+ * Splice Machine is free software: you can redistribute it and/or modify it under the terms of the\n+ * GNU Affero General Public License as published by the Free Software Foundation, either\n+ * version 3, or (at your option) any later version.\n+ * Splice Machine is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;\n+ * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n+ * See the GNU Affero General Public License for more details.\n+ * You should have received a copy of the GNU Affero General Public License along with Splice Machine.\n+ * If not, see <http://www.gnu.org/licenses/>.\n+ *\n+ */\n+\n+package com.splicemachine.si.impl;\n+\n+import com.splicemachine.si.api.data.ExceptionFactory;\n+import com.splicemachine.si.api.txn.Txn;\n+import com.splicemachine.si.api.txn.TxnLifecycleManager;\n+import com.splicemachine.si.api.txn.TxnView;\n+import com.splicemachine.si.impl.driver.SIDriver;\n+import com.splicemachine.si.impl.txn.PastTxn;\n+import com.splicemachine.si.impl.txn.ReadOnlyTxn;\n+import com.splicemachine.utils.SpliceLogUtils;\n+import org.apache.log4j.Logger;\n+\n+import java.io.IOException;\n+import java.util.Deque;\n+import java.util.Iterator;\n+import java.util.LinkedList;\n+\n+public class PastTransactionImpl extends TransactionImpl {\n+    private static Logger LOG=Logger.getLogger(PastTransactionImpl.class);\n+    Txn txn;\n+\n+    public PastTransactionImpl(String transName, long transactionId){\n+        super(transName, false, null);\n+        SpliceLogUtils.trace(LOG,\"Instantiating Splice past transaction\");\n+        this.txn = new PastTxn(transactionId);\n+    }\n+\n+    @Override\n+    public int setSavePoint(String name,Object kindOfSavepoint) throws IOException{\n+        return 1;\n+    }\n+\n+    @Override\n+    public int releaseSavePoint(String name,Object kindOfSavepoint) throws IOException{\n+        return 1;\n+    }\n+\n+    public String getActiveStateTxnName(){\n+        return \"PAST_TRANSACTION\";", "originalCommit": "4c23f1411dc39dc0b54dfa7535e96ce72b501c04", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjEzMzA3OQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3187#discussion_r382133079", "bodyText": "I added it, but it never gets called", "author": "dgomezferro", "createdAt": "2020-02-20T17:01:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDMxMjUxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDMxNDE2MQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3187#discussion_r380314161", "bodyText": "copyright", "author": "arnaud-splice", "createdAt": "2020-02-17T18:00:49Z", "path": "splice_si_api/src/main/java/com/splicemachine/si/impl/txn/PastTxn.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Copyright (c) 2012 - 2019 Splice Machine, Inc.", "originalCommit": "4c23f1411dc39dc0b54dfa7535e96ce72b501c04", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk0MzE2NQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3187#discussion_r380943165", "bodyText": "Debug tracing message may be confusing. Either change it or refactor code to avoid copying code.", "author": "jyuanca", "createdAt": "2020-02-18T21:23:52Z", "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/store/access/SpliceAccessManager.java", "diffHunk": "@@ -326,6 +326,48 @@ public TransactionController getTransaction(ContextManager cm) throws StandardEx\n         return getAndNameTransaction(cm, AccessFactoryGlobals.USER_TRANS_NAME);\n     }\n \n+    public TransactionController getReadOnlyTransaction(ContextManager cm, long id) throws StandardException {\n+        String transName = AccessFactoryGlobals.USER_TRANS_NAME;\n+\n+        /*\n+         * This call represents the top-level transactional access point. E.g., the top-level user transaction\n+         * is created by a call to this method. In this case we are creating a read only transaction at a predefined point\n+         */\n+        if (LOG.isDebugEnabled())\n+            LOG.debug(\"in SpliceAccessManager - getAndNameTransaction, transName=\" + transName);", "originalCommit": "4c23f1411dc39dc0b54dfa7535e96ce72b501c04", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk0MzI1Mg==", "url": "https://github.com/splicemachine/spliceengine/pull/3187#discussion_r380943252", "bodyText": "Ditto", "author": "jyuanca", "createdAt": "2020-02-18T21:24:03Z", "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/store/access/SpliceAccessManager.java", "diffHunk": "@@ -326,6 +326,48 @@ public TransactionController getTransaction(ContextManager cm) throws StandardEx\n         return getAndNameTransaction(cm, AccessFactoryGlobals.USER_TRANS_NAME);\n     }\n \n+    public TransactionController getReadOnlyTransaction(ContextManager cm, long id) throws StandardException {\n+        String transName = AccessFactoryGlobals.USER_TRANS_NAME;\n+\n+        /*\n+         * This call represents the top-level transactional access point. E.g., the top-level user transaction\n+         * is created by a call to this method. In this case we are creating a read only transaction at a predefined point\n+         */\n+        if (LOG.isDebugEnabled())\n+            LOG.debug(\"in SpliceAccessManager - getAndNameTransaction, transName=\" + transName);\n+        if (cm == null)\n+            return null;  // XXX (nat) should throw exception\n+\n+        /*\n+         * See if there's already a transaction context. If there is, then we just work with the one\n+         * already created. Otherwise, we have to make a new one\n+         */\n+        SpliceTransactionManagerContext rtc = (SpliceTransactionManagerContext)\n+                cm.getContext(AccessFactoryGlobals.RAMXACT_CONTEXT_ID);\n+\n+        if (rtc != null)\n+            return rtc.getTransactionManager(); //we already have a transaction from the context\n+\n+        if (LOG.isDebugEnabled())\n+            LOG.debug(\"in SpliceAccessManager - getAndNameTransaction, SpliceTransactionManagerContext is null\");\n+        /*", "originalCommit": "4c23f1411dc39dc0b54dfa7535e96ce72b501c04", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "75314eb45c5f2e8d64240666710f9cb460626570", "url": "https://github.com/splicemachine/spliceengine/commit/75314eb45c5f2e8d64240666710f9cb460626570", "message": "DB-8893 Address review comments", "committedDate": "2020-02-20T17:03:23Z", "type": "commit"}, {"oid": "3b28ab8aad3dfda9f5932c4544549aa3fd33e2ea", "url": "https://github.com/splicemachine/spliceengine/commit/3b28ab8aad3dfda9f5932c4544549aa3fd33e2ea", "message": "Merge remote-tracking branch 'origin/master' into DB-8893", "committedDate": "2020-02-20T17:25:51Z", "type": "commit"}, {"oid": "73501e6f218bfb82bd142c8b7ce316e81b25469e", "url": "https://github.com/splicemachine/spliceengine/commit/73501e6f218bfb82bd142c8b7ce316e81b25469e", "message": "Merge remote-tracking branch 'origin/master' into DB-8893", "committedDate": "2020-02-25T15:20:38Z", "type": "commit"}]}