{"pr_number": 4071, "pr_title": "DB-9682 Restrict columns for CSV external tables to be exact", "pr_createdAt": "2020-09-02T09:45:53Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/4071", "timeline": [{"oid": "e98b1f2d6545460a0a37e7d057885070b964649e", "url": "https://github.com/splicemachine/spliceengine/commit/e98b1f2d6545460a0a37e7d057885070b964649e", "message": "DB-9682 Restrict columns for CSV external tables to be exact\n\nWhile this would also work ignoring additional columns, this would lead\nto problems when tables are also used for writing.\nPARQUET/ORC also fail if num cols not exact. Accessing fewer columns\ncan be achieved by using VIEWS or only SELECT parts.", "committedDate": "2020-09-02T10:39:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY2NzAyNQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4071#discussion_r484667025", "bodyText": "I think it is better to do the following:\n\nMake sure you create all tables under the schema you set (line 55). Put all create table statements in the test preamble if possible.\nUse unique table names in the same test suite.\nRemove all drop statements, the schema watcher will take care of that for you since it is dropping the schema when the test suite is finished.", "author": "hatyo", "createdAt": "2020-09-08T05:57:03Z", "path": "hbase_sql/src/test/java/com/splicemachine/derby/impl/sql/execute/operations/ExternalTableIT.java", "diffHunk": "@@ -1010,6 +1010,23 @@ public void testReadTextMismatchSchema() throws Exception {\n                             \"(_c0 CHAR/VARCHAR(x), _c1 CHAR/VARCHAR(x), _c2 CHAR/VARCHAR(x));'.'\",\n                     e.getMessage() );\n         }\n+        methodWatcher.execute(\"drop table external_t2\");\n+\n+        methodWatcher.executeUpdate(String.format(\"create external table external_t3 (col1 int, col2 varchar(20) )\" +\n+                \"ROW FORMAT DELIMITED FIELDS TERMINATED BY '|' ESCAPED BY '\\\\\\\\' LINES TERMINATED BY '\\\\n'\" +\n+                \" STORED AS TEXTFILE LOCATION '%s'\", file));\n+        try {\n+            methodWatcher.executeQuery(\"select * from external_t3\");\n+            Assert.fail(\"Exception not thrown\");\n+        } catch (SQLException e) {\n+            Assert.assertEquals(\"Wrong Exception (\" + e.getMessage() + \")\", EXTERNAL_TABLES_READ_FAILURE, e.getSQLState());\n+            Assert.assertEquals( \"wrong exception message\",\n+                    \"External Table read failed with exception '2 attribute(s) defined but 3 present \" +\n+                            \"in the external file : '\" + file + \"'. Suggested Schema is 'CREATE EXTERNAL TABLE T \" +\n+                            \"(_c0 CHAR/VARCHAR(x), _c1 CHAR/VARCHAR(x), _c2 CHAR/VARCHAR(x));'.'\",\n+                    e.getMessage() );\n+        }\n+        methodWatcher.execute(\"drop table external_t3\");", "originalCommit": "e98b1f2d6545460a0a37e7d057885070b964649e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODY0MDAzNQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4071#discussion_r488640035", "bodyText": "Hi you're correct for other tests, however here we create many different tables, adding them to the preamble would mean creating 50 tables there, which is - in context of external tables - not really great for overview.", "author": "martinrupp", "createdAt": "2020-09-15T12:50:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY2NzAyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODY0NTg5MQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4071#discussion_r488645891", "bodyText": "ok :)", "author": "hatyo", "createdAt": "2020-09-15T12:59:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY2NzAyNQ=="}], "type": "inlineReview"}, {"oid": "b4fe047b5cd658e2d953b6e8b6fa1794109c3259", "url": "https://github.com/splicemachine/spliceengine/commit/b4fe047b5cd658e2d953b6e8b6fa1794109c3259", "message": "DB-9682 CSV tables check column count to be exactly equal to table definition", "committedDate": "2020-09-15T12:43:36Z", "type": "forcePushed"}, {"oid": "5dbe310d40d83656e7c6f05bbb1ef2e2284ca730", "url": "https://github.com/splicemachine/spliceengine/commit/5dbe310d40d83656e7c6f05bbb1ef2e2284ca730", "message": "DB-9682 CSV tables check column count to be exactly equal to table definition", "committedDate": "2020-09-15T12:46:52Z", "type": "forcePushed"}, {"oid": "1a45b21d874b7aaf0ed3472aa4645ecfb6b0e7bd", "url": "https://github.com/splicemachine/spliceengine/commit/1a45b21d874b7aaf0ed3472aa4645ecfb6b0e7bd", "message": "DB-9682 CSV tables check column count to be exactly equal to table definition", "committedDate": "2020-09-15T14:43:06Z", "type": "commit"}, {"oid": "1a45b21d874b7aaf0ed3472aa4645ecfb6b0e7bd", "url": "https://github.com/splicemachine/spliceengine/commit/1a45b21d874b7aaf0ed3472aa4645ecfb6b0e7bd", "message": "DB-9682 CSV tables check column count to be exactly equal to table definition", "committedDate": "2020-09-15T14:43:06Z", "type": "forcePushed"}]}