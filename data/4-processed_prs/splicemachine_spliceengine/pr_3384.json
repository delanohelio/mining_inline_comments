{"pr_number": 3384, "pr_title": "DB-9327 allow SSQ in update statement to be flattened, and disable BatchOnce optimization", "pr_createdAt": "2020-04-04T06:21:59Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/3384", "timeline": [{"oid": "d9403e3a49db9966335466b6683574d0eb95c273", "url": "https://github.com/splicemachine/spliceengine/commit/d9403e3a49db9966335466b6683574d0eb95c273", "message": "DB-9327 Project rowid for update\nDB-9327 Handle distinct expressions in BatchOnceFunction\nDB-9327 Fix BatchOnce resultcolumn list", "committedDate": "2020-04-04T05:58:53Z", "type": "commit"}, {"oid": "242d1c898bdcf1d79eed509277587e715cf16a7c", "url": "https://github.com/splicemachine/spliceengine/commit/242d1c898bdcf1d79eed509277587e715cf16a7c", "message": "DB-9327 allow SSQ in update statement to be flattened, and disable BatchOnce optimization", "committedDate": "2020-04-04T05:58:53Z", "type": "commit"}, {"oid": "c4dad049ed9cb6fd06bc25142a1eabd0ee28b26f", "url": "https://github.com/splicemachine/spliceengine/commit/c4dad049ed9cb6fd06bc25142a1eabd0ee28b26f", "message": "DB-9343 fix wrong result for flattened SSQ where correlation is in a single table condition", "committedDate": "2020-04-04T05:58:53Z", "type": "commit"}, {"oid": "c2e7f08a7d8554f2e8aaae53f6d31c9df492219c", "url": "https://github.com/splicemachine/spliceengine/commit/c2e7f08a7d8554f2e8aaae53f6d31c9df492219c", "message": "DB-9327 add database property to disable SSQ flattening for update statement", "committedDate": "2020-04-04T05:58:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA1MjQ5NQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3384#discussion_r404052495", "bodyText": "A warning could be logged here.", "author": "arnaud-splice", "createdAt": "2020-04-06T12:29:42Z", "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/GenericStatement.java", "diffHunk": "@@ -591,6 +591,20 @@ else if (nativeSparkAggregationModeString.equals(\"forced\"))\n                 }\n                 cc.setSparkVersion(sparkVersion);\n             }\n+\n+            String ssqFlatteningForUpdateDisabledString =\n+                    PropertyUtil.getCachedDatabaseProperty(lcc, Property.SSQ_FLATTENING_FOR_UPDATE_DISABLED);\n+            boolean ssqFlatteningForUpdateDisabled = CompilerContext.DEFAULT_SSQ_FLATTENING_FOR_UPDATE_DISABLED;\n+            try {\n+                if (ssqFlatteningForUpdateDisabledString != null)\n+                    ssqFlatteningForUpdateDisabled =\n+                            Boolean.valueOf(ssqFlatteningForUpdateDisabledString);\n+            } catch (Exception e) {\n+                // If the property value failed to convert to a boolean, don't throw an error,", "originalCommit": "c2e7f08a7d8554f2e8aaae53f6d31c9df492219c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYzMjQ1Ng==", "url": "https://github.com/splicemachine/spliceengine/pull/3384#discussion_r404632456", "bodyText": "Are we forcing the recompilation of stored prepared statements? Otherwise we might break some with this change (triggers for instance)", "author": "dgomezferro", "createdAt": "2020-04-07T08:32:33Z", "path": "db-engine/src/main/java/com/splicemachine/db/iapi/sql/execute/ResultSetFactory.java", "diffHunk": "@@ -2105,60 +2105,62 @@ NoPutResultSet getRowCountResultSet(\n     /**\n      * Export\n      */\n-\tNoPutResultSet getExportResultSet(NoPutResultSet source,\n-\t\t\t\t\t\t\t\t\t  Activation activation,\n-\t\t\t\t\t\t\t\t\t  int resultSetNumber,\n-\t\t\t\t\t\t\t\t\t  String exportPath,\n-\t\t\t\t\t\t\t\t\t  String compression,\n-\t\t\t\t\t\t\t\t\t  int replicationCount,\n-\t\t\t\t\t\t\t\t\t  String encoding,\n-\t\t\t\t\t\t\t\t\t  String fieldSeparator,\n-\t\t\t\t\t\t\t\t\t  String quoteChar,\n-\t\t\t\t\t\t\t\t\t  int srcResultDescriptionSavedObjectNum) throws StandardException;\n-\n-\n-\t/**\n-\t * Binary Export\n-\t */\n-\tNoPutResultSet getBinaryExportResultSet(NoPutResultSet source,\n-\t\t\t\t\t\t\t\t\t  Activation activation,\n-\t\t\t\t\t\t\t\t\t  int resultSetNumber,\n-\t\t\t\t\t\t\t\t\t  String exportPath,\n-\t\t\t\t\t\t\t\t\t  String compression,\n-\t\t\t\t\t\t\t\t\t  String format,\n-\t\t\t\t\t\t\t\t\t  int srcResultDescriptionSavedObjectNum) throws StandardException;\n+    NoPutResultSet getExportResultSet(NoPutResultSet source,\n+                                      Activation activation,\n+                                      int resultSetNumber,\n+                                      String exportPath,\n+                                      String compression,\n+                                      int replicationCount,\n+                                      String encoding,\n+                                      String fieldSeparator,\n+                                      String quoteChar,\n+                                      int srcResultDescriptionSavedObjectNum) throws StandardException;\n+\n+\n+    /**\n+     * Binary Export\n+     */\n+    NoPutResultSet getBinaryExportResultSet(NoPutResultSet source,\n+                                      Activation activation,\n+                                      int resultSetNumber,\n+                                      String exportPath,\n+                                      String compression,\n+                                      String format,\n+                                      int srcResultDescriptionSavedObjectNum) throws StandardException;\n     /**\n      * Batch Once\n      */\n-\tNoPutResultSet getBatchOnceResultSet(NoPutResultSet source,\n-\t\t\t\t\t\t\t\t\t\t Activation activation,\n-\t\t\t\t\t\t\t\t\t\t int resultSetNumber,\n-\t\t\t\t\t\t\t\t\t\t NoPutResultSet subqueryResultSet,\n-\t\t\t\t\t\t\t\t\t\t String updateResultSetFieldName,\n-\t\t\t\t\t\t\t\t\t\t int sourceCorrelatedColumnItem,\n-\t\t\t\t\t\t\t\t\t\t int subqueryCorrelatedColumnItem) throws StandardException;\n-\n-\t/**\n-\t * Recursive query\n-\t */\n-\tNoPutResultSet getSelfReferenceResultSet(Activation activation,\n-\t\t\t\t\t\t\t\t\t\t\t GeneratedMethod rowAllocator,\n-\t\t\t\t\t\t\t\t\t\t\t int resultSetNumber,\n-\t\t\t\t\t\t\t\t\t\t\t double optimizerEstimatedRowCount,\n-\t\t\t\t\t\t\t\t\t\t\t double optimizerEstimatedCost,\n-\t\t\t\t\t\t\t\t\t\t\t String explainPlan) throws StandardException;\n-\n-\tNoPutResultSet getRecursiveUnionResultSet(NoPutResultSet leftResultSet,\n-\t\t\t\t\t\t\t\t\t\t\t  NoPutResultSet rightResultSet,\n-\t\t\t\t\t\t\t\t\t\t\t  int resultSetNumber,\n-\t\t\t\t\t\t\t\t\t\t\t  double optimizerEstimatedRowCount,\n-\t\t\t\t\t\t\t\t\t\t\t  double optimizerEstimatedCost,\n-\t\t\t\t\t\t\t\t\t\t\t  String explainPlan,\n-\t\t\t\t\t\t\t\t\t\t\t  int iterationLimit) throws StandardException;\n-\n-\tNoPutResultSet getSignalResultSet(Activation activation,\n-\t                                  String sqlState,\n-\t                                  GeneratedMethod errorTextGenerator) throws StandardException;\n+    NoPutResultSet getBatchOnceResultSet(NoPutResultSet source,\n+                                         Activation activation,\n+                                         int resultSetNumber,\n+                                         NoPutResultSet subqueryResultSet,\n+                                         String updateResultSetFieldName,\n+                                         int sourceCorrelatedColumnItem,\n+                                         int subqueryCorrelatedColumnItem,\n+                                         int sourceRowLoationColumnPosition,\n+                                         int cardinalityCheck) throws StandardException;", "originalCommit": "c2e7f08a7d8554f2e8aaae53f6d31c9df492219c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY0NzM0OQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3384#discussion_r405647349", "bodyText": "Thanks Daniel! Yes, we need to force a re=compilation of stored prepared statement. I've added an upgrade script to do that and tested upgrade with a trigger case.", "author": "yxia92", "createdAt": "2020-04-08T16:17:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYzMjQ1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYzNjIwNw==", "url": "https://github.com/splicemachine/spliceengine/pull/3384#discussion_r404636207", "bodyText": "If we remove it from here we won't be using it anymore, right? I'd remove it altogether (BOVisitor, BONode and BOOperation)", "author": "dgomezferro", "createdAt": "2020-04-07T08:38:31Z", "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/db/SpliceDatabase.java", "diffHunk": "@@ -129,7 +128,7 @@ private void setupASTVisitors(LanguageConnectionContext lctx) {\n         afterOptVisitors.add(RowLocationColumnVisitor.class);\n         afterOptVisitors.add(FixSubqueryColRefs.class);\n         afterOptVisitors.add(JoinConditionVisitor.class);\n-        afterOptVisitors.add(BatchOnceVisitor.class);\n+    //    afterOptVisitors.add(BatchOnceVisitor.class);", "originalCommit": "c2e7f08a7d8554f2e8aaae53f6d31c9df492219c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY0ODE1Ng==", "url": "https://github.com/splicemachine/spliceengine/pull/3384#discussion_r405648156", "bodyText": "They are removed.", "author": "yxia92", "createdAt": "2020-04-08T16:18:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYzNjIwNw=="}], "type": "inlineReview"}, {"oid": "bebebd1360314680b08695853863efeaa2e8383e", "url": "https://github.com/splicemachine/spliceengine/commit/bebebd1360314680b08695853863efeaa2e8383e", "message": "DB-9327 remove BatchOnce related modules and settings;\nDB-9327 add update script to invalidate all the stored prepared statements.", "committedDate": "2020-04-08T15:46:04Z", "type": "commit"}]}