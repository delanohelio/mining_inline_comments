{"pr_number": 4547, "pr_title": "DB-10708 SpliceCK interactive mode and other improvements", "pr_createdAt": "2020-11-11T15:36:12Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/4547", "timeline": [{"oid": "1319c246be285b62f5951d7d670f50344e13c56a", "url": "https://github.com/splicemachine/spliceengine/commit/1319c246be285b62f5951d7d670f50344e13c56a", "message": "DB-10708 spliceck: more options for rget / tlist filter\n\n-L / --limit maximum number of rows to print (default is 100)\nall : print all rows\n-V / --versions : versions to display. 0 = all (default is 0)\n--hbase : output data like hbase\n\ntlist <asterix filter>\n\ne.g. tlist *SYS????S\nor tlist SPLICE*", "committedDate": "2020-11-12T21:54:47Z", "type": "forcePushed"}, {"oid": "94dafd7146db65456b70f792a492c90406ceaea4", "url": "https://github.com/splicemachine/spliceengine/commit/94dafd7146db65456b70f792a492c90406ceaea4", "message": "DB-10708 spliceck: more options for rget / tlist filter\n\n-L / --limit maximum number of rows to print (default is 100)\nall : print all rows\n-V / --versions : versions to display. 0 = all (default is 0)\n--hbase : output data like hbase\n\ntlist <asterix filter>\n\ne.g. tlist *SYS????S\nor tlist SPLICE*", "committedDate": "2020-11-12T22:00:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI2NDYzMQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4547#discussion_r524264631", "bodyText": "Rename to ConnectionSingleton.", "author": "hatyo", "createdAt": "2020-11-16T13:25:11Z", "path": "splice_ck/src/main/java/com/splicemachine/ck/ConnectionCache.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package com.splicemachine.ck;\n+\n+import com.splicemachine.ck.hwrap.ConnectionWrapper;\n+import org.apache.hadoop.conf.Configuration;\n+\n+import java.io.IOException;\n+\n+public class ConnectionCache {", "originalCommit": "2f323ab356d2d50aaeb3ac1b2e625cddcb619950", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk5NDA4OQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4547#discussion_r524994089", "bodyText": "done", "author": "martinrupp", "createdAt": "2020-11-17T09:11:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI2NDYzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI2NTQ3Ng==", "url": "https://github.com/splicemachine/spliceengine/pull/4547#discussion_r524265476", "bodyText": "move to Utils.java.", "author": "hatyo", "createdAt": "2020-11-16T13:26:33Z", "path": "splice_ck/src/main/java/com/splicemachine/ck/HBaseInspector.java", "diffHunk": "@@ -54,41 +57,66 @@ public HBaseInspector(final Configuration config) {\n         this.config = config;\n     }\n \n-    public String scanRow(final String region, final String rowKey, final Utils.SQLType[] cols) throws Exception {\n+    String limitString(int limit)\n+    {\n+        return \"   .\\n   .\\n   .\\n\" + Utils.Colored.red(\n+                \"--- Result list was limited to \" + limit + \" entries, \" + \"result was cut off ---\");\n+    }", "originalCommit": "2f323ab356d2d50aaeb3ac1b2e625cddcb619950", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk5NDgzNQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4547#discussion_r524994835", "bodyText": "done", "author": "martinrupp", "createdAt": "2020-11-17T09:12:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI2NTQ3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI2NjMwMw==", "url": "https://github.com/splicemachine/spliceengine/pull/4547#discussion_r524266303", "bodyText": "Needs rephrasing maybe?", "author": "hatyo", "createdAt": "2020-11-16T13:27:52Z", "path": "splice_ck/src/main/java/com/splicemachine/ck/HBaseInspector.java", "diffHunk": "@@ -54,41 +57,66 @@ public HBaseInspector(final Configuration config) {\n         this.config = config;\n     }\n \n-    public String scanRow(final String region, final String rowKey, final Utils.SQLType[] cols) throws Exception {\n+    String limitString(int limit)\n+    {\n+        return \"   .\\n   .\\n   .\\n\" + Utils.Colored.red(\n+                \"--- Result list was limited to \" + limit + \" entries, \" + \"result was cut off ---\");\n+    }\n+\n+    public String scanRow(final String region, final String rowKey, final Utils.SQLType[] cols,\n+                          int limit, int versions, boolean hbase) throws Exception {\n+\n         StringBuilder result = new StringBuilder();\n-        try(final ConnectionWrapper connectionWrapper = new ConnectionWrapper();\n-            final ResultScanner rs = connectionWrapper.withConfiguration(config).connect().withRegion(region).scanSingleRowAllVersions(rowKey)) {\n-            TableRowPrinter rowVisitor = new TableRowPrinter(cols == null ? null : new UserDefinedDataDecoder(cols, 4));\n+        UserDataDecoder decoder = cols == null ? null : new UserDefinedDataDecoder(cols, 4);\n+\n+        // scan for one more than the limit so now if we truncated", "originalCommit": "2f323ab356d2d50aaeb3ac1b2e625cddcb619950", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk5NTQ1Mg==", "url": "https://github.com/splicemachine/spliceengine/pull/4547#discussion_r524995452", "bodyText": "done. sorry i meant \"so that we KNOW if we truncated\" not \"now\" :-P", "author": "martinrupp", "createdAt": "2020-11-17T09:13:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI2NjMwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI2NzQ4Mw==", "url": "https://github.com/splicemachine/spliceengine/pull/4547#discussion_r524267483", "bodyText": "please put in a separate method (something like: generateRowId) and put it in Utils.java, or, even better, make it part of the processRow method.", "author": "hatyo", "createdAt": "2020-11-16T13:29:41Z", "path": "splice_ck/src/main/java/com/splicemachine/ck/HBaseInspector.java", "diffHunk": "@@ -54,41 +57,66 @@ public HBaseInspector(final Configuration config) {\n         this.config = config;\n     }\n \n-    public String scanRow(final String region, final String rowKey, final Utils.SQLType[] cols) throws Exception {\n+    String limitString(int limit)\n+    {\n+        return \"   .\\n   .\\n   .\\n\" + Utils.Colored.red(\n+                \"--- Result list was limited to \" + limit + \" entries, \" + \"result was cut off ---\");\n+    }\n+\n+    public String scanRow(final String region, final String rowKey, final Utils.SQLType[] cols,\n+                          int limit, int versions, boolean hbase) throws Exception {\n+\n         StringBuilder result = new StringBuilder();\n-        try(final ConnectionWrapper connectionWrapper = new ConnectionWrapper();\n-            final ResultScanner rs = connectionWrapper.withConfiguration(config).connect().withRegion(region).scanSingleRowAllVersions(rowKey)) {\n-            TableRowPrinter rowVisitor = new TableRowPrinter(cols == null ? null : new UserDefinedDataDecoder(cols, 4));\n+        UserDataDecoder decoder = cols == null ? null : new UserDefinedDataDecoder(cols, 4);\n+\n+        // scan for one more than the limit so now if we truncated\n+        int scanLimit = limit == 0 ? 0 : limit+1;\n+        int count = 0;\n+        ConnectionWrapper c = getCachedConnection().withRegion(region);\n+        try(final ResultScanner rs = rowKey == null ?\n+                c.scanVersions(scanLimit, versions) :\n+                c.scanSingleRow(rowKey, versions)) {\n             for(Result row : rs) {\n+                if( count++ == limit ) {\n+                    result.append(limitString(limit));\n+                    break;\n+                }\n+                TableRowPrinter rowVisitor = new TableRowPrinter(decoder, hbase);\n+                String hbaseStr = !hbase ? \"\" : \" / \" + com.splicemachine.primitives.Bytes.toStringBinary(row.getRow());\n+                result.append(Utils.Colored.red(\"[ Row \" + Hex.encodeHexString(row.getRow()) + hbaseStr + \" ]\\n\"));", "originalCommit": "2f323ab356d2d50aaeb3ac1b2e625cddcb619950", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTAwMTkzMQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4547#discussion_r525001931", "bodyText": "done", "author": "martinrupp", "createdAt": "2020-11-17T09:22:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI2NzQ4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI3MTY2OQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4547#discussion_r524271669", "bodyText": "is this necessary?", "author": "hatyo", "createdAt": "2020-11-16T13:36:33Z", "path": "splice_ck/src/main/java/com/splicemachine/ck/command/RootCommand.java", "diffHunk": "@@ -14,19 +14,54 @@\n \n package com.splicemachine.ck.command;\n \n+import com.splicemachine.ck.ConnectionCache;\n+import com.splicemachine.ck.Utils;\n import org.apache.log4j.Level;\n import org.apache.log4j.Logger;\n import picocli.CommandLine;\n import picocli.CommandLine.Command;\n \n-@Command(mixinStandardHelpOptions = true, name = \"spliceck\", description = \"SpliceMachine check command suite\", descriptionHeading = \"Description:%n\",\n+import java.util.Arrays;\n+import java.util.Scanner;\n+\n+@Command(mixinStandardHelpOptions = true, name = \"spliceck\", description = \"SpliceMachine check command suite\",\n+        descriptionHeading = \"Description:%n\",\n         optionListHeading = \"Options:%n\", subcommands = {TListCommand.class,\n         TColsCommand.class, RegionOfCommand.class, TableOfCommand.class, RGetCommand.class, RPutCommand.class,\n         TxListCommand.class, SListCommand.class})\n class RootCommand {\n     public static void main(String... args) {\n         Logger.getRootLogger().setLevel(Level.OFF);\n-        int exitCode = new CommandLine(new RootCommand()).setExecutionStrategy(new CommandLine.RunLast()).execute(args);\n+        ConnectionCache c = new ConnectionCache();\n+\n+        int exitCode = 0;\n+        if(!args[0].equals(\"interactive\")) {\n+            exitCode = new CommandLine(new RootCommand()).setExecutionStrategy(new CommandLine.RunLast()).execute(args);\n+        }\n+        else {\n+            Scanner command = new Scanner(System.in);\n+            CommandLine cl = new CommandLine(new RootCommand()).setExecutionStrategy(new CommandLine.RunLast());\n+            while (true) {\n+                System.out.print(\"spliceck> \");\n+                String s = command.nextLine();\n+                if (s.equals(\"exit\")) break;\n+                if (s.trim().length() == 0) continue;\n+                String[] args2 = s.split(\" \");\n+                exitCode = cl.execute(args2);\n+                if( exitCode == 0 )\n+                    System.out.println(Utils.Colored.green( \"return code \" + exitCode + \"\\n\") );", "originalCommit": "2f323ab356d2d50aaeb3ac1b2e625cddcb619950", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTAwMjM0OQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4547#discussion_r525002349", "bodyText": "not really super necessary. i thought it's maybe interesting if the last command succeeded, but i guess that's visible from the command output as well.\nremoved.", "author": "martinrupp", "createdAt": "2020-11-17T09:23:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI3MTY2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI3NDA3OA==", "url": "https://github.com/splicemachine/spliceengine/pull/4547#discussion_r524274078", "bodyText": "I think this is redundant, ConnectionWrapper is AutoCloseable, the static object will be destroyed when the process finishes closing it resource.", "author": "hatyo", "createdAt": "2020-11-16T13:40:30Z", "path": "splice_ck/src/main/java/com/splicemachine/ck/command/RootCommand.java", "diffHunk": "@@ -14,19 +14,54 @@\n \n package com.splicemachine.ck.command;\n \n+import com.splicemachine.ck.ConnectionCache;\n+import com.splicemachine.ck.Utils;\n import org.apache.log4j.Level;\n import org.apache.log4j.Logger;\n import picocli.CommandLine;\n import picocli.CommandLine.Command;\n \n-@Command(mixinStandardHelpOptions = true, name = \"spliceck\", description = \"SpliceMachine check command suite\", descriptionHeading = \"Description:%n\",\n+import java.util.Arrays;\n+import java.util.Scanner;\n+\n+@Command(mixinStandardHelpOptions = true, name = \"spliceck\", description = \"SpliceMachine check command suite\",\n+        descriptionHeading = \"Description:%n\",\n         optionListHeading = \"Options:%n\", subcommands = {TListCommand.class,\n         TColsCommand.class, RegionOfCommand.class, TableOfCommand.class, RGetCommand.class, RPutCommand.class,\n         TxListCommand.class, SListCommand.class})\n class RootCommand {\n     public static void main(String... args) {\n         Logger.getRootLogger().setLevel(Level.OFF);\n-        int exitCode = new CommandLine(new RootCommand()).setExecutionStrategy(new CommandLine.RunLast()).execute(args);\n+        ConnectionCache c = new ConnectionCache();\n+\n+        int exitCode = 0;\n+        if(!args[0].equals(\"interactive\")) {\n+            exitCode = new CommandLine(new RootCommand()).setExecutionStrategy(new CommandLine.RunLast()).execute(args);\n+        }\n+        else {\n+            Scanner command = new Scanner(System.in);\n+            CommandLine cl = new CommandLine(new RootCommand()).setExecutionStrategy(new CommandLine.RunLast());\n+            while (true) {\n+                System.out.print(\"spliceck> \");\n+                String s = command.nextLine();\n+                if (s.equals(\"exit\")) break;\n+                if (s.trim().length() == 0) continue;\n+                String[] args2 = s.split(\" \");\n+                exitCode = cl.execute(args2);\n+                if( exitCode == 0 )\n+                    System.out.println(Utils.Colored.green( \"return code \" + exitCode + \"\\n\") );\n+                else\n+                    System.out.println(Utils.Colored.red( \"return code \" + exitCode + \"\\n\") );\n+\n+            }\n+            command.close();\n+        }\n+\n+        try {\n+            c.close();\n+        } catch (Exception e) {\n+            e.printStackTrace();\n+        }", "originalCommit": "2f323ab356d2d50aaeb3ac1b2e625cddcb619950", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTAwMzQyMg==", "url": "https://github.com/splicemachine/spliceengine/pull/4547#discussion_r525003422", "bodyText": "i wanted to make sure here we're closing the hbase connection as soon as possible", "author": "martinrupp", "createdAt": "2020-11-17T09:24:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI3NDA3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI3NDI3MQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4547#discussion_r524274271", "bodyText": "probably not needed.", "author": "hatyo", "createdAt": "2020-11-16T13:40:50Z", "path": "splice_ck/src/main/java/com/splicemachine/ck/ConnectionCache.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package com.splicemachine.ck;\n+\n+import com.splicemachine.ck.hwrap.ConnectionWrapper;\n+import org.apache.hadoop.conf.Configuration;\n+\n+import java.io.IOException;\n+\n+public class ConnectionCache {\n+\n+    static ConnectionWrapper c;\n+    public static ConnectionWrapper getConnection(final Configuration config) throws IOException {\n+        if( c == null ) {\n+            System.out.print(\"Trying to connect... \");\n+            c = new ConnectionWrapper().withConfiguration(config).connect();\n+            System.out.println(\"connected!\");\n+        }\n+        return c;\n+    }\n+\n+    public static void close() throws Exception {\n+        if( c != null ) {\n+            c.close();\n+            c = null;\n+        }\n+    }", "originalCommit": "2f323ab356d2d50aaeb3ac1b2e625cddcb619950", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTAwMzU5Mw==", "url": "https://github.com/splicemachine/spliceengine/pull/4547#discussion_r525003593", "bodyText": "as above", "author": "martinrupp", "createdAt": "2020-11-17T09:25:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI3NDI3MQ=="}], "type": "inlineReview"}, {"oid": "cfccf3907742766757ab805616da2c095de4906e", "url": "https://github.com/splicemachine/spliceengine/commit/cfccf3907742766757ab805616da2c095de4906e", "message": "DB-10708 SpliceCK interactive mode / keep connection open", "committedDate": "2020-11-17T09:10:02Z", "type": "commit"}, {"oid": "366660e8641638c66eff448062958e44afc25c11", "url": "https://github.com/splicemachine/spliceengine/commit/366660e8641638c66eff448062958e44afc25c11", "message": "DB-10708 spliceck: more options for rget / tlist filter\n\n-L / --limit maximum number of rows to print (default is 100)\nall : print all rows\n-V / --versions : versions to display. 0 = all (default is 0)\n--hbase : output data like hbase\n\ntlist <asterix filter>\n\ne.g. tlist *SYS????S\nor tlist SPLICE*", "committedDate": "2020-11-17T09:10:02Z", "type": "commit"}, {"oid": "cd939d9970752ace42f5c16046cbc872775ddb80", "url": "https://github.com/splicemachine/spliceengine/commit/cd939d9970752ace42f5c16046cbc872775ddb80", "message": "DB-10708 spliceck: limit for txlist", "committedDate": "2020-11-17T09:10:02Z", "type": "commit"}, {"oid": "10c19432fdccdaac6e7e38c6e87d5f80c25f2175", "url": "https://github.com/splicemachine/spliceengine/commit/10c19432fdccdaac6e7e38c6e87d5f80c25f2175", "message": "DB-10708 address code review", "committedDate": "2020-11-17T09:34:35Z", "type": "commit"}, {"oid": "10c19432fdccdaac6e7e38c6e87d5f80c25f2175", "url": "https://github.com/splicemachine/spliceengine/commit/10c19432fdccdaac6e7e38c6e87d5f80c25f2175", "message": "DB-10708 address code review", "committedDate": "2020-11-17T09:34:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTA1NDU2Mw==", "url": "https://github.com/splicemachine/spliceengine/pull/4547#discussion_r525054563", "bodyText": "maybe separate to two lines instead of using comma", "author": "ascend1", "createdAt": "2020-11-17T10:41:21Z", "path": "splice_ck/src/main/java/com/splicemachine/ck/HBaseInspector.java", "diffHunk": "@@ -125,40 +144,52 @@ private String schemaIdOf(String schemaName) throws Exception {\n         return schemaId.get().getSecond();\n     }\n \n-    private Utils.Tabular getListTransactions() throws Exception {\n+    public String getListTransactions(int limit) throws Exception {\n         String region = SPLICE_PREFIX + HBaseConfiguration.TRANSACTION_TABLE;\n         Utils.Tabular tabular = new Utils.Tabular(Utils.Tabular.SortHint.AsInteger,\n                 TBL_TXN_COL0, TBL_TXN_COL1, TBL_TXN_COL2, TBL_TXN_COL3, TBL_TXN_COL4,\n                 TBL_TXN_COL5, TBL_TXN_COL6, TBL_TXN_COL7, TBL_TXN_COL8, TBL_TXN_COL9);\n         TxnTableRowPrinter rowVisitor = new TxnTableRowPrinter();\n-        try(final ConnectionWrapper connectionWrapper = new ConnectionWrapper();\n-            final ResultScanner rs = connectionWrapper.withConfiguration(config).connect().withRegion(region).scan()) {\n+\n+        // scan for one more than the limit so the we know if we truncated\n+        int scanLimit = limit == 0 ? 0 : limit+1, count = 0;", "originalCommit": "10c19432fdccdaac6e7e38c6e87d5f80c25f2175", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTA3MTA3MQ==", "url": "https://github.com/splicemachine/spliceengine/pull/4547#discussion_r525071071", "bodyText": "that is really hard to read, agreed!", "author": "martinrupp", "createdAt": "2020-11-17T11:08:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTA1NDU2Mw=="}], "type": "inlineReview"}, {"oid": "f170458e0065874c69fdf29c36b9c61a9be6498f", "url": "https://github.com/splicemachine/spliceengine/commit/f170458e0065874c69fdf29c36b9c61a9be6498f", "message": "DB-10708 code review 2", "committedDate": "2020-11-17T11:09:16Z", "type": "commit"}, {"oid": "786bba77264a9a79af5b42a590fa1851fa100fa5", "url": "https://github.com/splicemachine/spliceengine/commit/786bba77264a9a79af5b42a590fa1851fa100fa5", "message": "DB-10708 fix Spotbugs", "committedDate": "2020-11-17T12:16:31Z", "type": "commit"}, {"oid": "e12f3ef5fc8fd7906a894bee488ffc4f91a9c0dc", "url": "https://github.com/splicemachine/spliceengine/commit/e12f3ef5fc8fd7906a894bee488ffc4f91a9c0dc", "message": "Merge remote-tracking branch 'origin/master' into DB-10708", "committedDate": "2020-11-18T19:49:26Z", "type": "commit"}, {"oid": "6bc5bd7609e1c0b06234e64dc8bb2baa78931853", "url": "https://github.com/splicemachine/spliceengine/commit/6bc5bd7609e1c0b06234e64dc8bb2baa78931853", "message": "DB-10708 add newline after row id", "committedDate": "2020-11-23T10:03:58Z", "type": "commit"}]}