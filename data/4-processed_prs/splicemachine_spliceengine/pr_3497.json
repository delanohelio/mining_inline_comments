{"pr_number": 3497, "pr_title": "DB-9434 ORDER BY can use the aliases defined in SELECT AS", "pr_createdAt": "2020-04-29T07:32:59Z", "pr_url": "https://github.com/splicemachine/spliceengine/pull/3497", "timeline": [{"oid": "d7975b4310384d9a89fa18ea785f5416817e97f0", "url": "https://github.com/splicemachine/spliceengine/commit/d7975b4310384d9a89fa18ea785f5416817e97f0", "message": "DB-9434 ORDER BY can use the aliases defined in SELECT AS\n\ne.g. as in\n  select C as C2+1 from A order by -C2;", "committedDate": "2020-04-29T18:25:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzUyMzAxMQ==", "url": "https://github.com/splicemachine/spliceengine/pull/3497#discussion_r417523011", "bodyText": "from spotbugs", "author": "martinrupp", "createdAt": "2020-04-29T18:27:05Z", "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/ResultColumnList.java", "diffHunk": "@@ -3622,7 +3640,7 @@ private static void updateArrays(int[] mapArray,\n     }\n \n \n-    public class ColumnMapping{\n+    public static class ColumnMapping{", "originalCommit": "d7975b4310384d9a89fa18ea785f5416817e97f0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzUyNjIyMw==", "url": "https://github.com/splicemachine/spliceengine/pull/3497#discussion_r417526223", "bodyText": "As the comment says, this makes sure we disable access to alias for WHERE, HAVING and GROUP BY.\nCurrently, this is not supported. If we remove the line with clearAliases we can enable this. @yxia92 and i agreed on it might be safe currently to not change the behavior here.", "author": "martinrupp", "createdAt": "2020-04-29T18:32:38Z", "path": "splice_machine/src/test/java/com/splicemachine/derby/impl/sql/execute/operations/OrderByIT.java", "diffHunk": "@@ -377,4 +382,48 @@ public void testOrderByClauseWithNullInWindowFunctionThroughSparkPath() throws E\n         rs.close();\n     }\n \n+    @Test\n+    public void testAliasInOrderComplex() throws Exception {\n+        String sqlText = \"select sum(a1) as ALIAS from t2 order by -ALIAS\";\n+        String expected = \"ALIAS |\\n\" +\n+                         \"--------\\n\" +\n+                         \"  15   |\" ;\n+        SqlExpectToString( methodWatcher, sqlText, expected, false );\n+\n+        sqlText = \"select sqrt(a1*a1)*2 as ALIAS from t2 order by -2*ALIAS+a1\";\n+        expected = \"ALIAS |\\n\" +\n+                  \"--------\\n\" +\n+                  \" 10.0  |\\n\" +\n+                  \"  8.0  |\\n\" +\n+                  \"  6.0  |\\n\" +\n+                  \"  4.0  |\\n\" +\n+                  \"  2.0  |\";\n+        SqlExpectToString( methodWatcher, sqlText, expected, false );\n+    }\n+\n+    @Test\n+    public void testAliasInOrderSimple() throws Exception {\n+        // use these TWO order by to make sure ResultColumnList correctly calculates getFirstOrderByIndex.\n+        String sqlText = \"select a1 as ALIAS from t2 order by -ALIAS, -2*ALIAS\";\n+        String expected = \"ALIAS |\\n--------\\n   5   |\\n   4   |\\n   3   |\\n   2   |\\n   1   |\";\n+        SqlExpectToString( methodWatcher, sqlText, expected, false );\n+    }\n+\n+    // make sure we disable access to alias for WHERE, HAVING and GROUP BY\n+    @Test\n+    public void testUsingAliasOnlyInOrderBy() throws Exception {\n+        String sqlTexts[] =\n+                {       \"select a1+1 as ALIAS from t2 WHERE ALIAS > 0 ORDER BY -ALIAS\",\n+                        \"select a1+1 as ALIAS from t2 GROUP BY ALIAS ORDER BY -ALIAS\",\n+                        \"select a1, sum(b1+1) as ALIAS from t1 GROUP BY a1 HAVING ALIAS > 0 ORDER BY -ALIAS\"\n+                        };\n+        for( String sqlText : sqlTexts ) {\n+            SqlExpectException( methodWatcher, sqlText, \"42X04\" );\n+        }\n+    }", "originalCommit": "d7975b4310384d9a89fa18ea785f5416817e97f0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2f5ba7c3bd34934f8c6a67c4b295af0c03464c73", "url": "https://github.com/splicemachine/spliceengine/commit/2f5ba7c3bd34934f8c6a67c4b295af0c03464c73", "message": "DB-9434 ORDER BY can use the aliases defined in SELECT AS\n\ne.g. as in\n  select C as C2+1 from A order by -C2;", "committedDate": "2020-05-04T19:58:50Z", "type": "commit"}, {"oid": "2f5ba7c3bd34934f8c6a67c4b295af0c03464c73", "url": "https://github.com/splicemachine/spliceengine/commit/2f5ba7c3bd34934f8c6a67c4b295af0c03464c73", "message": "DB-9434 ORDER BY can use the aliases defined in SELECT AS\n\ne.g. as in\n  select C as C2+1 from A order by -C2;", "committedDate": "2020-05-04T19:58:50Z", "type": "forcePushed"}]}