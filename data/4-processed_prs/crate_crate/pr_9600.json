{"pr_number": 9600, "pr_title": "Add documentation for returning for insert", "pr_createdAt": "2020-01-30T10:57:33Z", "pr_url": "https://github.com/crate/crate/pull/9600", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg4NjQwOA==", "url": "https://github.com/crate/crate/pull/9600#discussion_r372886408", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The optional RETURNING clause causes INSERT to compute and return value(s)\n          \n          \n            \n            The optional ``RETURNING`` clause causes ``INSERT`` to compute and return value(s)\n          \n      \n    \n    \n  \n\nsame for the rest SQL keywords", "author": "kovrus", "createdAt": "2020-01-30T11:04:41Z", "path": "docs/sql/statements/insert.rst", "diffHunk": "@@ -42,6 +43,23 @@ filled.\n If the expression for any column is not of the correct data type, automatic\n type conversion will be attempted.\n \n+The optional RETURNING clause causes INSERT to compute and return value(s)", "originalCommit": "f1b3cf65c9efd0c42c81c20fe1f2c037cc3eb0ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk1NTkxMA==", "url": "https://github.com/crate/crate/pull/9600#discussion_r372955910", "bodyText": "My fault, we left the highlighting out in https://github.com/crate/crate/blob/master/docs/sql/statements/update.rst in the description so i thought it should be here the same.", "author": "mkleen", "createdAt": "2020-01-30T13:47:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg4NjQwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjkzMTYwMQ==", "url": "https://github.com/crate/crate/pull/9600#discussion_r372931601", "bodyText": "Maybe rephrase it  a little bit, because it is not that obvious what the output list of SELECT and RETURNING list are. Maybe we can talk about expression items of the SELECT and RETURNING clauses or smth like that. On the other hand, do we even need to mention SELECT?", "author": "kovrus", "createdAt": "2020-01-30T12:56:34Z", "path": "docs/sql/statements/insert.rst", "diffHunk": "@@ -42,6 +43,23 @@ filled.\n If the expression for any column is not of the correct data type, automatic\n type conversion will be attempted.\n \n+The optional RETURNING clause causes INSERT to compute and return value(s)\n+based from each row actually inserted (or updated, if an ON CONFLICT DO UPDATE\n+clause was used). This is primarily useful for obtaining values that were\n+supplied by defaults, such as a :ref:`sequence number\n+<sql_administration_system_columns_seq_no>`.\n+However, any expression using the table's columns is allowed. The syntax of\n+the RETURNING list is identical to that of the output list of SELECT.", "originalCommit": "f1b3cf65c9efd0c42c81c20fe1f2c037cc3eb0ac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjkzNjU4OA==", "url": "https://github.com/crate/crate/pull/9600#discussion_r372936588", "bodyText": "the grammar states this * | output_expression, but the param description states that output_expression can be * as well which is not right.", "author": "kovrus", "createdAt": "2020-01-30T13:07:59Z", "path": "docs/sql/statements/insert.rst", "diffHunk": "@@ -119,14 +137,22 @@ Parameters\n ==========\n \n :table_ident:\n-  The identifier (optionally schema-qualified) of an existing table.\n+    The identifier (optionally schema-qualified) of an existing table.\n \n :column_ident:\n-  The name of a column or field in the table pointed to by *table_ident*.\n+    The name of a column or field in the table pointed to by *table_ident*.\n \n :expression:\n-  An expression or value to assign to the corresponding column.\n+    An expression or value to assign to the corresponding column.\n \n :query:\n-  A query (SELECT statement) that supplies the rows to be inserted.\n-  Refer to the ``SELECT`` statement for a description of the syntax.\n+    A query (SELECT statement) that supplies the rows to be inserted.\n+    Refer to the ``SELECT`` statement for a description of the syntax.\n+\n+:output_expression:\n+    An expression to be computed and returned by the INSERT command after each\n+    row is updated. The expression can use any column names of the table or\n+    ``*`` to return all columns.", "originalCommit": "f1b3cf65c9efd0c42c81c20fe1f2c037cc3eb0ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzA2NjMwOQ==", "url": "https://github.com/crate/crate/pull/9600#discussion_r373066309", "bodyText": "?", "author": "mkleen", "createdAt": "2020-01-30T16:48:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjkzNjU4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk0OTYzNA==", "url": "https://github.com/crate/crate/pull/9600#discussion_r372949634", "bodyText": "We don't have a WHERE clause for ON CONFLICT... , do we?", "author": "mfussenegger", "createdAt": "2020-01-30T13:35:33Z", "path": "docs/sql/statements/insert.rst", "diffHunk": "@@ -42,6 +43,23 @@ filled.\n If the expression for any column is not of the correct data type, automatic\n type conversion will be attempted.\n \n+The optional RETURNING clause causes INSERT to compute and return value(s)\n+based from each row actually inserted (or updated, if an ON CONFLICT DO UPDATE\n+clause was used). This is primarily useful for obtaining values that were\n+supplied by defaults, such as a :ref:`sequence number\n+<sql_administration_system_columns_seq_no>`.\n+However, any expression using the table's columns is allowed. The syntax of\n+the RETURNING list is identical to that of the output list of SELECT.\n+Only rows that were successfully inserted or updated will be returned.\n+For example, if a row was locked but not updated because an\n+ON CONFLICT DO UPDATE ... WHERE clause condition was not satisfied, the row", "originalCommit": "f1b3cf65c9efd0c42c81c20fe1f2c037cc3eb0ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk1NDgxMQ==", "url": "https://github.com/crate/crate/pull/9600#discussion_r372954811", "bodyText": "good point, thank you.", "author": "mkleen", "createdAt": "2020-01-30T13:45:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk0OTYzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk1MTIxMQ==", "url": "https://github.com/crate/crate/pull/9600#discussion_r372951211", "bodyText": "Isn't seq_no quite advanced already? I think the most popular and simple use-case is to return generated primary keys, e.g. _id or  md5(random()::text || current_timestamp::text)", "author": "seut", "createdAt": "2020-01-30T13:38:23Z", "path": "docs/sql/statements/insert.rst", "diffHunk": "@@ -42,6 +43,23 @@ filled.\n If the expression for any column is not of the correct data type, automatic\n type conversion will be attempted.\n \n+The optional RETURNING clause causes INSERT to compute and return value(s)\n+based from each row actually inserted (or updated, if an ON CONFLICT DO UPDATE\n+clause was used). This is primarily useful for obtaining values that were\n+supplied by defaults, such as a :ref:`sequence number\n+<sql_administration_system_columns_seq_no>`.", "originalCommit": "f1b3cf65c9efd0c42c81c20fe1f2c037cc3eb0ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk1NDQzNg==", "url": "https://github.com/crate/crate/pull/9600#discussion_r372954436", "bodyText": "Sequence number was used in the original psql documentation and it is also one of our usecases, but we could go indeed for something simpler.", "author": "mkleen", "createdAt": "2020-01-30T13:44:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk1MTIxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk1OTU3OA==", "url": "https://github.com/crate/crate/pull/9600#discussion_r372959578", "bodyText": "No strong opinion, just an idea.\nBtw. postgresql documentation talks about a serial sequence number in general. Also just to mention, our _seq_no is only serial per shard.", "author": "seut", "createdAt": "2020-01-30T13:53:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk1MTIxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzA1ODk3Ng==", "url": "https://github.com/crate/crate/pull/9600#discussion_r373058976", "bodyText": "I think _id is a good.", "author": "mkleen", "createdAt": "2020-01-30T16:35:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk1MTIxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk1MjAxMg==", "url": "https://github.com/crate/crate/pull/9600#discussion_r372952012", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            For example, if a row was locked but not updated because an\n          \n          \n            \n            For example, if a row was matched but not updated because an", "author": "seut", "createdAt": "2020-01-30T13:39:55Z", "path": "docs/sql/statements/insert.rst", "diffHunk": "@@ -42,6 +43,23 @@ filled.\n If the expression for any column is not of the correct data type, automatic\n type conversion will be attempted.\n \n+The optional RETURNING clause causes INSERT to compute and return value(s)\n+based from each row actually inserted (or updated, if an ON CONFLICT DO UPDATE\n+clause was used). This is primarily useful for obtaining values that were\n+supplied by defaults, such as a :ref:`sequence number\n+<sql_administration_system_columns_seq_no>`.\n+However, any expression using the table's columns is allowed. The syntax of\n+the RETURNING list is identical to that of the output list of SELECT.\n+Only rows that were successfully inserted or updated will be returned.\n+For example, if a row was locked but not updated because an", "originalCommit": "f1b3cf65c9efd0c42c81c20fe1f2c037cc3eb0ac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk1MjYzNw==", "url": "https://github.com/crate/crate/pull/9600#discussion_r372952637", "bodyText": "If you use the query clause to insert rows from a query, you of course need to have SELECT privilege on any table or column used in the query.\n\nThis is subselect related only and afaik documented there, so I'd not repeat it here", "author": "seut", "createdAt": "2020-01-30T13:41:15Z", "path": "docs/sql/statements/insert.rst", "diffHunk": "@@ -42,6 +43,23 @@ filled.\n If the expression for any column is not of the correct data type, automatic\n type conversion will be attempted.\n \n+The optional RETURNING clause causes INSERT to compute and return value(s)\n+based from each row actually inserted (or updated, if an ON CONFLICT DO UPDATE\n+clause was used). This is primarily useful for obtaining values that were\n+supplied by defaults, such as a :ref:`sequence number\n+<sql_administration_system_columns_seq_no>`.\n+However, any expression using the table's columns is allowed. The syntax of\n+the RETURNING list is identical to that of the output list of SELECT.\n+Only rows that were successfully inserted or updated will be returned.\n+For example, if a row was locked but not updated because an\n+ON CONFLICT DO UPDATE ... WHERE clause condition was not satisfied, the row\n+will not be returned.\n+\n+Use of the RETURNING clause requires SELECT privilege on all columns mentioned\n+in RETURNING. If you use the query clause to insert rows from a query, you\n+of course need to have SELECT privilege on any table or column used in the\n+query.", "originalCommit": "f1b3cf65c9efd0c42c81c20fe1f2c037cc3eb0ac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzA2MTkwNA==", "url": "https://github.com/crate/crate/pull/9600#discussion_r373061904", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            mentioned in ``RETURNING``.\n          \n          \n            \n            involved.", "author": "norosa", "createdAt": "2020-01-30T16:40:43Z", "path": "docs/sql/statements/insert.rst", "diffHunk": "@@ -42,6 +43,17 @@ filled.\n If the expression for any column is not of the correct data type, automatic\n type conversion will be attempted.\n \n+The optional ``RETURNING`` clause causes ``INSERT`` to compute and return\n+value(s) based from each row actually inserted (or updated, if an ``ON\n+CONFLICT DO UPDATE`` clause was used). This is primarily useful for obtaining\n+values that were supplied by defaults, such as a :ref:`sequence number\n+<sql_administration_system_columns_seq_no>`.\n+However, any expression using the table's columns is allowed. The syntax of\n+the ``RETURNING`` list is identical to that of the output list of ``SELECT``.\n+Only rows that were successfully inserted or updated will be returned.\n+\n+Use of the ``RETURNING`` clause requires ``SELECT`` privilege on all columns\n+mentioned in ``RETURNING``.", "originalCommit": "dfbbb96f2c416a74c0e7ca1064428d193582d529", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7fcb48313de047a2816e08bf1a0fd28c2f0af976", "url": "https://github.com/crate/crate/commit/7fcb48313de047a2816e08bf1a0fd28c2f0af976", "message": "Add more feedback", "committedDate": "2020-01-30T16:52:12Z", "type": "forcePushed"}, {"oid": "6d1efa914cc13ca3e71c344fd58c5b0b7f78bba0", "url": "https://github.com/crate/crate/commit/6d1efa914cc13ca3e71c344fd58c5b0b7f78bba0", "message": "Add feedback", "committedDate": "2020-01-31T07:57:11Z", "type": "forcePushed"}, {"oid": "973ab6027c91a973a9df1e5cee09a5ad86c15e3e", "url": "https://github.com/crate/crate/commit/973ab6027c91a973a9df1e5cee09a5ad86c15e3e", "message": "Add feedback", "committedDate": "2020-01-31T08:09:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzM3MDYyOA==", "url": "https://github.com/crate/crate/pull/9600#discussion_r373370628", "bodyText": "The lexical order part is actually outdated, we changed that behavior. We should follow up on this with a PR against master.", "author": "mfussenegger", "createdAt": "2020-01-31T08:50:26Z", "path": "docs/sql/statements/insert.rst", "diffHunk": "@@ -24,24 +24,31 @@ Synopsis\n       { VALUES ( expression [, ...] ) [, ...] | ( query ) | query }\n       [ ON CONFLICT (column_ident [, ...]) DO UPDATE SET { column_ident = expression [, ...] } |\n         ON CONFLICT [ ( column_ident [, ...] ) ] DO NOTHING ]\n+      [ RETURNING { * | output_expression [ [ AS ] output_name ] | relation.* } [, ...] ]\n \n Description\n ===========\n \n-INSERT creates one or more rows specified by value expressions.\n+``INSERT`` creates one or more rows specified by value expressions.\n \n The target column names can be listed in any order. If no list of column names\n is given at all, the default is all the columns of the table in lexical order;", "originalCommit": "973ab6027c91a973a9df1e5cee09a5ad86c15e3e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "09bd6d9852a506c1223c6a9d2ae5dd2aba722294", "url": "https://github.com/crate/crate/commit/09bd6d9852a506c1223c6a9d2ae5dd2aba722294", "message": "Add documentation for returning clause for insert", "committedDate": "2020-01-31T12:05:05Z", "type": "forcePushed"}, {"oid": "c5c01727936ac0ba8d63e86a831abf61d4ba953e", "url": "https://github.com/crate/crate/commit/c5c01727936ac0ba8d63e86a831abf61d4ba953e", "message": "Add documentation for returning clause for insert", "committedDate": "2020-01-31T12:06:26Z", "type": "forcePushed"}, {"oid": "48372f6d482cf877df37f081223656850209cbf6", "url": "https://github.com/crate/crate/commit/48372f6d482cf877df37f081223656850209cbf6", "message": "Add documentation for returning clause for insert", "committedDate": "2020-01-31T12:07:10Z", "type": "commit"}, {"oid": "48372f6d482cf877df37f081223656850209cbf6", "url": "https://github.com/crate/crate/commit/48372f6d482cf877df37f081223656850209cbf6", "message": "Add documentation for returning clause for insert", "committedDate": "2020-01-31T12:07:10Z", "type": "forcePushed"}]}