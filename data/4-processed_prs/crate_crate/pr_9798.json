{"pr_number": 9798, "pr_title": "Add an assertion to limit allocated bytes for current thread", "pr_createdAt": "2020-03-25T09:22:57Z", "pr_url": "https://github.com/crate/crate/pull/9798", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzcyMjY3NQ==", "url": "https://github.com/crate/crate/pull/9798#discussion_r397722675", "bodyText": "Why is this limited to 8MB?", "author": "seut", "createdAt": "2020-03-25T09:44:20Z", "path": "sql/src/test/java/io/crate/planner/operators/LogicalPlannerTest.java", "diffHunk": "@@ -60,16 +56,17 @@\n \n     @Before\n     public void prepare() throws IOException {\n+        tableStats = new TableStats();\n         sqlExecutor = SQLExecutor.builder(clusterService)\n             .enableDefaultTables()\n+            .setTableStats(tableStats)\n             .addView(new RelationName(\"doc\", \"v2\"), \"select a, x from doc.t1\")\n             .addView(new RelationName(\"doc\", \"v3\"), \"select a, x from doc.t1\")\n             .build();\n-        tableStats = new TableStats();\n     }\n \n     private LogicalPlan plan(String statement) {\n-        return plan(statement, sqlExecutor, clusterService, tableStats);\n+        return withMemoryLimit(ByteSizeUnit.MB.toBytes(8), () -> sqlExecutor.logicalPlan(statement));", "originalCommit": "4f3f5d6d2650d7de84f5c587e6b7b77fe114dbc6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzcyNTg2MA==", "url": "https://github.com/crate/crate/pull/9798#discussion_r397725860", "bodyText": "Currently the plan method allocates around 5-7 MB. The intention here is to have a regression check to make sure we don't increase the allocations a lot and also to make us aware of what various methods are allocating. For example, the deleted block below caused an extra ~40MB to be allocated: (probably due to getFunctions())\nPlannerContext context = sqlExecutor.getPlannerContext(clusterService.state());\n        AnalyzedRelation relation = sqlExecutor.analyze(statement);\n        LogicalPlanner logicalPlanner = new LogicalPlanner(\n            getFunctions(),\n            tableStats,\n            () -> clusterService.state().nodes().getMinNodeVersion()\n        );\n        SubqueryPlanner subqueryPlanner = new SubqueryPlanner((s) -> logicalPlanner.planSubSelect(s, context));\n\nMaybe limit is the wrong term. Do you have a suggestion? assertLessBytesAllocated ?", "author": "mfussenegger", "createdAt": "2020-03-25T09:49:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzcyMjY3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzcyODY1MA==", "url": "https://github.com/crate/crate/pull/9798#discussion_r397728650", "bodyText": "I see thanks, yes wording was a bit confusing. I'd suggest assertMaxBytesAllocated.", "author": "seut", "createdAt": "2020-03-25T09:54:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzcyMjY3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzgzNjg2OA==", "url": "https://github.com/crate/crate/pull/9798#discussion_r397836868", "bodyText": "@seut Changed it.", "author": "mfussenegger", "createdAt": "2020-03-25T13:05:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzcyMjY3NQ=="}], "type": "inlineReview"}, {"oid": "6675a3ba852c02c2c4b84709648fd2b80ddd9d60", "url": "https://github.com/crate/crate/commit/6675a3ba852c02c2c4b84709648fd2b80ddd9d60", "message": "Add an assertion to limit allocated bytes for current thread", "committedDate": "2020-03-25T13:02:20Z", "type": "commit"}, {"oid": "6675a3ba852c02c2c4b84709648fd2b80ddd9d60", "url": "https://github.com/crate/crate/commit/6675a3ba852c02c2c4b84709648fd2b80ddd9d60", "message": "Add an assertion to limit allocated bytes for current thread", "committedDate": "2020-03-25T13:02:20Z", "type": "forcePushed"}]}