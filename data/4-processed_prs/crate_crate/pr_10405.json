{"pr_number": 10405, "pr_title": "Clarify documentation of `ignored` object types", "pr_createdAt": "2020-08-19T15:16:51Z", "pr_url": "https://github.com/crate/crate/pull/10405", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE2NTEzNg==", "url": "https://github.com/crate/crate/pull/10405#discussion_r473165136", "bodyText": "The (if not disabled) part left me wondering a bit before I figured out what it means.\nMaybe something like the following would clarify it?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            every other object type, values are validated and indexed (if not disabled).\n          \n          \n            \n            every other object type, values are validated and indexed, unless an explicit ``INDEX OFF`` clause is used to disable indexing.", "author": "mfussenegger", "createdAt": "2020-08-19T16:32:14Z", "path": "docs/general/ddl/data-types.rst", "diffHunk": "@@ -968,9 +968,11 @@ not mapped according to their type, which is therefor not guessed as well. You\n can in fact add any value to an added column of the same name. The first value\n added does not determine what you can add further, like with ``dynamic``\n objects.\n+Subcolumn definitions inside an ``ignored`` object will behave the same like on\n+every other object type, values are validated and indexed (if not disabled).", "originalCommit": "018dc1883ede4ab37cf473d5b49c0a46365753e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE3NjAzOQ==", "url": "https://github.com/crate/crate/pull/10405#discussion_r473176039", "bodyText": "I wonder if we should actually re-phrase the full paragraph. Something like the following maybe?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            every other object type, values are validated and indexed (if not disabled).\n          \n          \n            \n            The third option is ``ignored``. Explicitly defined columns within an ``ignored`` object behave the same as those within object columns declared as ``dynamic`` or ``strict``. The columns are indexed unless indexing is explicitly turned off using ``INDEX OFF`` and values inserted are validated. The difference is that with ``ignored``, dynamically added columns do not result in a schema update, and the values won't be indexed. This allows to store values with a mixed type under the same key.\n          \n          \n            \n            \n          \n          \n            \n            An example::\n          \n          \n            \n            \n          \n          \n            \n              cr> CREATE TABLE metrics (\n          \n          \n            \n              ...   id TEXT PRIMARY KEY,\n          \n          \n            \n              ...   payload OBJECT (IGNORED) as (\n          \n          \n            \n              ...     tag TEXT\n          \n          \n            \n              ...   )\n          \n          \n            \n              ... );\n          \n          \n            \n            \n          \n          \n            \n              cr> INSERT INTO metrics (id, payload) values ('1', {\"tag\"='AT', \"value\"=30}');\n          \n          \n            \n              cr> INSERT INTO metrics (id, payload) values ('2', {\"tag\": 'AT', \"value\"='str'});\n          \n          \n            \n            \n          \n          \n            \n              cr> SELECT payload FROM metrics ORDER BY id;", "author": "mfussenegger", "createdAt": "2020-08-19T16:48:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE2NTEzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE4NjM0MQ==", "url": "https://github.com/crate/crate/pull/10405#discussion_r473186341", "bodyText": "Also a suggestion here to elaborate a bit on why it is slower and to distinguish between the ordering and filtering case, because ordering is not that much more expensive compared to the difference when using these columns in the WHERE clause. I also noticed that the part about not being able to use aggregations is incorrect:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               Filtering by and ordering on any undefined subcolumn is possible but very\n          \n          \n            \n               performance intensive. Undefined subcolumns of ``ignored`` objects are a\n          \n          \n            \n               *black box* for the storage engine, so the filtering/ordering is done using\n          \n          \n            \n               an expensive table scan and a filter/order function outside of the storage\n          \n          \n            \n               engine. Using undefined subcolumns of ``ignored`` objects for grouping or\n          \n          \n            \n               aggregations is not possible and will result in an exception unless explicit\n          \n          \n            \n               casted.\n          \n          \n            \n               Given that dynamically added sub-columns of an ``ignored`` objects are not indexed, filter operations on these columns cannot utilize the index and instead a value lookup is performed for each matching row. This can be mitigated by combining a filter using the ``AND`` clause with other predicates on indexed columns.\n          \n          \n            \n            \n          \n          \n            \n               Futhermore, values for dynamically added sub-columns of an ``ignored`` objects aren't stored in a column store, which means that ordering on these columns or using them with aggregates is also slower than using the same operations on regular columns. For some operations it may also be necessary to add an explicit type cast because there is no type information available in the schema. An example::\n          \n          \n            \n            \n          \n          \n            \n            \n          \n          \n            \n               cr> SELECT arbitrary(payload['value']::text) FROM metrics;\n          \n          \n            \n            \n          \n          \n            \n            \n          \n          \n            \n            Given that it is possible have values of different types within the same sub-column of an ignored objects, aggregations may fail at runtime::\n          \n          \n            \n            \n          \n          \n            \n            \n          \n          \n            \n               cr> SELECT sum(payload['value']::bigint) FROM metrics;", "author": "mfussenegger", "createdAt": "2020-08-19T17:01:22Z", "path": "docs/general/ddl/data-types.rst", "diffHunk": "@@ -991,12 +993,13 @@ inserted into it, but otherwise ignore them.\n .. NOTE::\n \n    ``Ignored`` objects should be mainly used for storing and fetching.\n-   Filtering by and ordering on them is possible but very performance\n-   intensive. ``Ignored`` objects are a *black box* for the storage engine, so\n-   the filtering/ordering is done using an expensive table scan and a\n-   filter/order function outside of the storage engine. Using ``ignored``\n-   objects for grouping or aggregations is not possible at all and will result\n-   in an exception or ``NULL`` value if used with excplicit casts.\n+   Filtering by and ordering on any undefined subcolumn is possible but very\n+   performance intensive. Undefined subcolumns of ``ignored`` objects are a\n+   *black box* for the storage engine, so the filtering/ordering is done using\n+   an expensive table scan and a filter/order function outside of the storage\n+   engine. Using undefined subcolumns of ``ignored`` objects for grouping or\n+   aggregations is not possible and will result in an exception unless explicit\n+   casted.", "originalCommit": "018dc1883ede4ab37cf473d5b49c0a46365753e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE5MDA3Mg==", "url": "https://github.com/crate/crate/pull/10405#discussion_r473190072", "bodyText": "The arbitrary example is probably not deterministic, so maybe a filter or so will be needed in addition - or you could come up with a better example?", "author": "mfussenegger", "createdAt": "2020-08-19T17:05:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE4NjM0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzcwMzYzOQ==", "url": "https://github.com/crate/crate/pull/10405#discussion_r473703639", "bodyText": "For some operations it may also be necessary to add an explicit type cast because there is no type information available in the schema\n\nAfaik the explicit type cast is always  needed despite simple selecting the column. (functions, aggs, grouping, ordering, filtering, etc.)", "author": "seut", "createdAt": "2020-08-20T07:38:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE4NjM0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzcyMDY0MA==", "url": "https://github.com/crate/crate/pull/10405#discussion_r473720640", "bodyText": "Afaik the explicit type cast is always needed despite simple selecting the column. (functions, aggs, grouping, ordering, filtering, etc.)\n\nI think due to the type inference it can be omitted if a function overload is restrictive enough. The following works:\ncreate table tbl (id text primary key, payload object (ignored));\ninsert into tbl (id, payload) values ('1', {x=10});\ninsert into tbl (id, payload) values ('2', {x=10});\nrefresh table tbl;\nselect sum(payload['x']) from tbl;", "author": "mfussenegger", "createdAt": "2020-08-20T07:51:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE4NjM0MQ=="}], "type": "inlineReview"}, {"oid": "533039778d5778cb5689d9ca695d63ac833d3fb6", "url": "https://github.com/crate/crate/commit/533039778d5778cb5689d9ca695d63ac833d3fb6", "message": "fixup! Clarify documentation of `ignored` object types", "committedDate": "2020-08-20T08:49:39Z", "type": "forcePushed"}, {"oid": "727d4de6e0799258415efe1656f580e1e2e30cfb", "url": "https://github.com/crate/crate/commit/727d4de6e0799258415efe1656f580e1e2e30cfb", "message": "fixup! Clarify documentation of `ignored` object types", "committedDate": "2020-08-20T08:51:26Z", "type": "forcePushed"}, {"oid": "c01b2381b013f6650a1a951beb46ef2ad4dfe12a", "url": "https://github.com/crate/crate/commit/c01b2381b013f6650a1a951beb46ef2ad4dfe12a", "message": "Clarify documentation of `ignored` object types\n\nHighlight that values of defined subcolumns are indeed validate/index,\nonly new/unknown subcolumns aren\u2019t.", "committedDate": "2020-08-20T09:13:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg4Nzg4Mg==", "url": "https://github.com/crate/crate/pull/10405#discussion_r473887882", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            update, and the values won't be indexed. This allows to store values with a\n          \n          \n            \n            update and the values won't be indexed. This allows you to store values with a", "author": "norosa", "createdAt": "2020-08-20T11:04:31Z", "path": "docs/general/ddl/data-types.rst", "diffHunk": "@@ -962,41 +962,92 @@ subcolumns. One can retrieve them, sort by them and use them in where clauses.\n ``ignored``\n -----------\n \n-The third option is ``ignored`` which results in an object that allows\n-inserting new subcolumns but this adding will not affect the schema, they are\n-not mapped according to their type, which is therefor not guessed as well. You\n-can in fact add any value to an added column of the same name. The first value\n-added does not determine what you can add further, like with ``dynamic``\n-objects.\n-\n-An object configured like this will simply accept and return the columns\n-inserted into it, but otherwise ignore them.\n-\n+The third option is ``ignored``. Explicitly defined columns within an\n+``ignored`` object behave the same as those within object columns declared as\n+``dynamic`` or ``strict``. The columns are indexed unless indexing is explicitly\n+turned off using ``INDEX OFF`` and values inserted are validated. The difference\n+is that with ``ignored``, dynamically added columns do not result in a schema\n+update, and the values won't be indexed. This allows to store values with a", "originalCommit": "c01b2381b013f6650a1a951beb46ef2ad4dfe12a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg5MDIwMg==", "url": "https://github.com/crate/crate/pull/10405#discussion_r473890202", "bodyText": "can you clarify what \"and values inserted are validated\" means? the passive voice makes it a little ambiguous. a switch to active voice would probably clear it up\nis the user expected to validate values when inserting, or does CrateDB validate values when the user tries to insert them? (another way of putting it: is the validation a part of a \"columns are indexed unless X and Y\" precondition or is validation dependant upon indexing?)", "author": "norosa", "createdAt": "2020-08-20T11:08:49Z", "path": "docs/general/ddl/data-types.rst", "diffHunk": "@@ -962,41 +962,92 @@ subcolumns. One can retrieve them, sort by them and use them in where clauses.\n ``ignored``\n -----------\n \n-The third option is ``ignored`` which results in an object that allows\n-inserting new subcolumns but this adding will not affect the schema, they are\n-not mapped according to their type, which is therefor not guessed as well. You\n-can in fact add any value to an added column of the same name. The first value\n-added does not determine what you can add further, like with ``dynamic``\n-objects.\n-\n-An object configured like this will simply accept and return the columns\n-inserted into it, but otherwise ignore them.\n-\n+The third option is ``ignored``. Explicitly defined columns within an\n+``ignored`` object behave the same as those within object columns declared as\n+``dynamic`` or ``strict``. The columns are indexed unless indexing is explicitly\n+turned off using ``INDEX OFF`` and values inserted are validated. The difference", "originalCommit": "c01b2381b013f6650a1a951beb46ef2ad4dfe12a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzkyMDY3NA==", "url": "https://github.com/crate/crate/pull/10405#discussion_r473920674", "bodyText": "CrateDB validates the values according to the defined schema.  So the type must fit, and if there are further constraints, like CHECK the values must pass these checks.\nNot sure how to phrase that better in a succinct way.", "author": "mfussenegger", "createdAt": "2020-08-20T12:08:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg5MDIwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzkyMjc2Nw==", "url": "https://github.com/crate/crate/pull/10405#discussion_r473922767", "bodyText": "Sorry but I don't get what can be ambiguous with \"values are validated\".\nIf a user should validate it, then it wouldn't be \"are validated\".\nCould you please make a suggestion?\nWould using ... and column constraints and data type restrictions are ensured instead help?", "author": "seut", "createdAt": "2020-08-20T12:12:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg5MDIwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzk3MzkzMQ==", "url": "https://github.com/crate/crate/pull/10405#discussion_r473973931", "bodyText": "@seut the sentence can be read two ways:\n\n\n\"The columns are indexed unless indexing is explicitly turned off using INDEX OFF and, separately, values inserted are validated.\"\n\n\n\"The columns are indexed unless indexing is explicitly turned off using INDEX OFF and unless values inserted are validated.\" (which doesn't make much logical sense to me but the grammar is ambiguous enough to give me pause)\n\n\nbased on @mfussenegger's response, I take it that the first is the correct interpretation. so how about this:\n\nExplicitly defined columns within an ignored object behave the same as those within object columns declared as dynamic or strict (e.g., column constraints are still enforced, columns that would be indexed are still indexed, and so on).", "author": "norosa", "createdAt": "2020-08-20T13:29:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg5MDIwMg=="}], "type": "inlineReview"}, {"oid": "f9608c3ec305a15da9c0044d1856a7ef70217db4", "url": "https://github.com/crate/crate/commit/f9608c3ec305a15da9c0044d1856a7ef70217db4", "message": "fixup! Clarify documentation of `ignored` object types", "committedDate": "2020-08-20T13:56:55Z", "type": "forcePushed"}, {"oid": "110c73b97ebfbce6c899a3c5664badcc46c40ce8", "url": "https://github.com/crate/crate/commit/110c73b97ebfbce6c899a3c5664badcc46c40ce8", "message": "Clarify documentation of `ignored` object types\n\nHighlight that values of defined subcolumns are indeed validate/index,\nonly new/unknown subcolumns aren\u2019t.", "committedDate": "2020-08-24T11:49:55Z", "type": "forcePushed"}, {"oid": "fd45bc5e212b8b19de2fb824f5614b33f655f921", "url": "https://github.com/crate/crate/commit/fd45bc5e212b8b19de2fb824f5614b33f655f921", "message": "Clarify documentation of `ignored` object types\n\nHighlight that values of defined subcolumns are indeed validate/index,\nonly new/unknown subcolumns aren\u2019t.", "committedDate": "2020-08-26T06:04:11Z", "type": "forcePushed"}, {"oid": "56eda37eb2088c9cae2926d20a194a310297d19f", "url": "https://github.com/crate/crate/commit/56eda37eb2088c9cae2926d20a194a310297d19f", "message": "Clarify documentation of `ignored` object types\n\nHighlight that values of defined subcolumns are indeed validate/index,\nonly new/unknown subcolumns aren\u2019t.", "committedDate": "2020-08-26T14:03:01Z", "type": "commit"}, {"oid": "56eda37eb2088c9cae2926d20a194a310297d19f", "url": "https://github.com/crate/crate/commit/56eda37eb2088c9cae2926d20a194a310297d19f", "message": "Clarify documentation of `ignored` object types\n\nHighlight that values of defined subcolumns are indeed validate/index,\nonly new/unknown subcolumns aren\u2019t.", "committedDate": "2020-08-26T14:03:01Z", "type": "forcePushed"}]}