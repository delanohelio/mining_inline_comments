{"pr_number": 10011, "pr_title": "Introduce clear boundaries between implicit, explicit and try cast functions.", "pr_createdAt": "2020-05-27T13:38:45Z", "pr_url": "https://github.com/crate/crate/pull/10011", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE0ODM1Mw==", "url": "https://github.com/crate/crate/pull/10011#discussion_r431148353", "bodyText": "probably cast(Object value, boolean explicitCast) should be ok?", "author": "kovrus", "createdAt": "2020-05-27T13:52:21Z", "path": "server/src/main/java/io/crate/types/DataType.java", "diffHunk": "@@ -82,6 +83,17 @@\n \n     public abstract Streamer<T> streamer();\n \n+    /**\n+     * Must be used only in the cast functions.\n+     *\n+     * @param value The value to cast to the target {@link DataType}.\n+     * @param mode  The {@link CastMode} mode.\n+     * @return The value of the target {@link DataType}.\n+     */\n+    public T cast(Object value, CastMode mode) throws IllegalArgumentException, ClassCastException {", "originalCommit": "3394af88ce64c0024505b0e2b5f9d9af9cac31ca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE0OTI2Mw==", "url": "https://github.com/crate/crate/pull/10011#discussion_r431149263", "bodyText": "Would also be okay. Or a new method? explicitCast and implicitCast ? explicitCast could default to implicitCast if there is no additional logic. Would at least help with readability on the call-sites (no guessing what false or true is referring to - without having a IDE that provides a hint what the parameter is called)", "author": "mfussenegger", "createdAt": "2020-05-27T13:53:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE0ODM1Mw=="}], "type": "inlineReview"}, {"oid": "598d77e76bf1e96cc4d34cc353427ba439be8140", "url": "https://github.com/crate/crate/commit/598d77e76bf1e96cc4d34cc353427ba439be8140", "message": "fixup! Add explicit and explicit cast methods for data types.", "committedDate": "2020-05-28T08:47:45Z", "type": "forcePushed"}, {"oid": "5704e9d2ac75140a2303313b3070f0c4fdcb080e", "url": "https://github.com/crate/crate/commit/5704e9d2ac75140a2303313b3070f0c4fdcb080e", "message": "Add explicit and explicit cast methods for data types.", "committedDate": "2020-05-28T08:49:57Z", "type": "forcePushed"}, {"oid": "a8af99e7cc866e2a2b1b2996d3fc128870880385", "url": "https://github.com/crate/crate/commit/a8af99e7cc866e2a2b1b2996d3fc128870880385", "message": "Add explicit and explicit cast methods for data types.", "committedDate": "2020-05-28T08:50:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY4NjI1Nw==", "url": "https://github.com/crate/crate/pull/10011#discussion_r431686257", "bodyText": "looks like the default impl so it could be removed.", "author": "seut", "createdAt": "2020-05-28T08:59:19Z", "path": "server/src/main/java/io/crate/types/IpType.java", "diffHunk": "@@ -35,6 +35,16 @@ public int id() {\n         return ID;\n     }\n \n+    @Override\n+    public String implicitCast(Object value) throws IllegalArgumentException, ClassCastException {\n+        return value(value);\n+    }\n+\n+    @Override\n+    public String explicitCast(Object value) throws IllegalArgumentException, ClassCastException {", "originalCommit": "a8af99e7cc866e2a2b1b2996d3fc128870880385", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY5ODI5Mg==", "url": "https://github.com/crate/crate/pull/10011#discussion_r431698292", "bodyText": "thought so, but IpType extends the StringType so the String#explicitCast method will be invoked :/\nI'll split these types later.", "author": "kovrus", "createdAt": "2020-05-28T09:20:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY4NjI1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcwMDU5Nw==", "url": "https://github.com/crate/crate/pull/10011#discussion_r431700597", "bodyText": "Ah right. +1 to separate them completely.", "author": "seut", "createdAt": "2020-05-28T09:24:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY4NjI1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcwMjM3Nw==", "url": "https://github.com/crate/crate/pull/10011#discussion_r431702377", "bodyText": "\ud83d\udc4d I'll follow up on it in a separate PR.", "author": "kovrus", "createdAt": "2020-05-28T09:27:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY4NjI1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcwMTc5Ng==", "url": "https://github.com/crate/crate/pull/10011#discussion_r431701796", "bodyText": "I am not sure about this point, both implicit and explicit cast functions are printed under the same name cast now. I think it would be better to print implicit cast function under its own name _cast and adjust tests. wdyt?", "author": "kovrus", "createdAt": "2020-05-28T09:26:25Z", "path": "server/src/main/java/io/crate/expression/symbol/Function.java", "diffHunk": "@@ -364,7 +367,12 @@ private void printCastFunction(StringBuilder builder, Style style) {\n         } else {\n             asTypeName = \" AS \" + dataType.getName();\n         }\n-        builder.append(info.ident().name())\n+        var name = info.ident().name();\n+        // print cast implicit function under 'cast' name.\n+        if (name.equalsIgnoreCase(IMPLICIT_CAST_NAME)) {", "originalCommit": "a8af99e7cc866e2a2b1b2996d3fc128870880385", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcwNzQyOQ==", "url": "https://github.com/crate/crate/pull/10011#discussion_r431707429", "bodyText": "We could also consider to omit implicit casts when printing an expression, so that the printed expression is closer to the original input.\nMight make testing for casts a bit more troublesome, but we can use the isFunction matcher if we want to ensure that a certain cast happens", "author": "mfussenegger", "createdAt": "2020-05-28T09:36:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcwMTc5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcxMTAyNA==", "url": "https://github.com/crate/crate/pull/10011#discussion_r431711024", "bodyText": "Some planner tests would still have to be adjusted to the generic way of printing the implicit cast function. Would it be ok? In most of the rest tests, we can go with isFunction.", "author": "kovrus", "createdAt": "2020-05-28T09:42:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcwMTc5Ng=="}], "type": "inlineReview"}, {"oid": "bdece1fe7ede8465cd663d1bb68f89a23daacfe2", "url": "https://github.com/crate/crate/commit/bdece1fe7ede8465cd663d1bb68f89a23daacfe2", "message": "Add explicit and explicit cast methods for data types.", "committedDate": "2020-05-28T13:27:50Z", "type": "forcePushed"}, {"oid": "87e7c819d475d5ab69c968f923c869c3af05f07f", "url": "https://github.com/crate/crate/commit/87e7c819d475d5ab69c968f923c869c3af05f07f", "message": "Add explicit and explicit cast methods for data types.", "committedDate": "2020-05-28T13:47:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkwNzc1OQ==", "url": "https://github.com/crate/crate/pull/10011#discussion_r431907759", "bodyText": "I wonder if we should make 3 concrete implementations instead.  At this point pretty much everything this function does is abstracted away.  WDYT?", "author": "mfussenegger", "createdAt": "2020-05-28T15:03:00Z", "path": "server/src/main/java/io/crate/expression/scalar/cast/CastFunction.java", "diffHunk": "@@ -55,45 +56,80 @@ public static void register(ScalarFunctionModule module) {\n                     parseTypeSignature(\"V\"),\n                     parseTypeSignature(\"V\"))\n                 .withTypeVariableConstraints(typeVariable(\"E\"), typeVariable(\"V\")),\n-            (signature, args) -> new CastFunction(\n-                new FunctionInfo(new FunctionIdent(CAST_NAME, args), args.get(1)),\n-                signature,\n-                (argument, returnType) -> {\n-                    throw new ConversionException(argument, returnType);\n-                },\n-                (argument, returnType) -> {\n-                    throw new ConversionException(argument, returnType);\n-                }\n-            )\n+            (signature, args) -> {\n+                var targetType = args.get(1);\n+                return new CastFunction(\n+                    new FunctionInfo(new FunctionIdent(CAST_NAME, args), targetType),\n+                    targetType::explicitCast,\n+                    signature,\n+                    (argument, returnType) -> {\n+                        throw new ConversionException(argument, returnType);\n+                    },\n+                    (argument, returnType) -> {\n+                        throw new ConversionException(argument, returnType);\n+                    }\n+                );\n+            }\n         );\n         module.register(\n             Signature\n-                .scalar(TRY_CAST_NAME,\n-                        parseTypeSignature(\"E\"),\n-                        parseTypeSignature(\"V\"),\n-                        parseTypeSignature(\"V\"))\n+                .scalar(\n+                    TRY_CAST_NAME,\n+                    parseTypeSignature(\"E\"),\n+                    parseTypeSignature(\"V\"),\n+                    parseTypeSignature(\"V\"))\n                 .withTypeVariableConstraints(typeVariable(\"E\"), typeVariable(\"V\")),\n-            (signature, args) -> new CastFunction(\n-                new FunctionInfo(new FunctionIdent(TRY_CAST_NAME, args), args.get(1)),\n-                signature,\n-                (argument, returnType) -> Literal.NULL,\n-                (argument, returnType) -> null\n-            )\n+            (signature, args) -> {\n+                var targetType = args.get(1);\n+                return new CastFunction(\n+                    new FunctionInfo(new FunctionIdent(TRY_CAST_NAME, args), targetType),\n+                    targetType::explicitCast,\n+                    signature,\n+                    (argument, returnType) -> Literal.NULL,\n+                    (argument, returnType) -> null\n+                );\n+            }\n+        );\n+        module.register(\n+            Signature\n+                .scalar(\n+                    IMPLICIT_CAST_NAME,\n+                    parseTypeSignature(\"E\"),\n+                    parseTypeSignature(\"V\"),\n+                    parseTypeSignature(\"V\"))\n+                .withTypeVariableConstraints(typeVariable(\"E\"), typeVariable(\"V\")),\n+            (signature, args) -> {\n+                var targetType = args.get(1);\n+                return new CastFunction(\n+                    new FunctionInfo(new FunctionIdent(IMPLICIT_CAST_NAME, args), targetType),\n+                    targetType::implicitCast,\n+                    signature,\n+                    (argument, returnType) -> {\n+                        throw new ConversionException(argument, returnType);\n+                    },\n+                    (argument, returnType) -> {\n+                        throw new ConversionException(argument, returnType);\n+                    }\n+                );\n+            }\n         );\n     }\n \n \n     private final DataType<?> returnType;\n+    private final Function<Object, Object> cast;\n     private final FunctionInfo info;\n     private final Signature signature;\n     private final BiFunction<Symbol, DataType<?>, Symbol> onNormalizeException;\n     private final BiFunction<Object, DataType<?>, Object> onEvaluateException;\n \n     private CastFunction(FunctionInfo info,\n+                         Function<Object, Object> cast,", "originalCommit": "87e7c819d475d5ab69c968f923c869c3af05f07f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkyMTIzNg==", "url": "https://github.com/crate/crate/pull/10011#discussion_r431921236", "bodyText": "yes, I thought of splitting it, but was dragged away by cast function printing stuff.", "author": "kovrus", "createdAt": "2020-05-28T15:21:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkwNzc1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkwOTI4Ng==", "url": "https://github.com/crate/crate/pull/10011#discussion_r431909286", "bodyText": "could this replace value already,  or should we look later into stripping down value?", "author": "mfussenegger", "createdAt": "2020-05-28T15:05:07Z", "path": "server/src/main/java/io/crate/types/IpType.java", "diffHunk": "@@ -35,6 +35,16 @@ public int id() {\n         return ID;\n     }\n \n+    @Override\n+    public String implicitCast(Object value) throws IllegalArgumentException, ClassCastException {", "originalCommit": "87e7c819d475d5ab69c968f923c869c3af05f07f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkyMjQ3OA==", "url": "https://github.com/crate/crate/pull/10011#discussion_r431922478", "bodyText": "I'd prefer to follow up on it right after the varchar(length) implementation. Would it be ok?", "author": "kovrus", "createdAt": "2020-05-28T15:23:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkwOTI4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkyNTczMg==", "url": "https://github.com/crate/crate/pull/10011#discussion_r431925732", "bodyText": "Sure \ud83d\udc4d", "author": "mfussenegger", "createdAt": "2020-05-28T15:27:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkwOTI4Ng=="}], "type": "inlineReview"}, {"oid": "ae09ff1589eccfb334944e6ceb42e6e5d9bed8a1", "url": "https://github.com/crate/crate/commit/ae09ff1589eccfb334944e6ceb42e6e5d9bed8a1", "message": "fixup! Add explicit and explicit cast methods for data types.", "committedDate": "2020-05-29T10:44:45Z", "type": "forcePushed"}, {"oid": "73dcae2ce2b081c13511cb326b662c0a91743b2b", "url": "https://github.com/crate/crate/commit/73dcae2ce2b081c13511cb326b662c0a91743b2b", "message": "fixup! Add explicit and explicit cast methods for data types.", "committedDate": "2020-05-29T10:46:23Z", "type": "forcePushed"}, {"oid": "3ffd91fb80b613ed950445c6ba838f741d6def4a", "url": "https://github.com/crate/crate/commit/3ffd91fb80b613ed950445c6ba838f741d6def4a", "message": "Replace `Symbol#cast` cast mode flags with the CastMode enum.", "committedDate": "2020-05-29T15:02:27Z", "type": "commit"}, {"oid": "5fbec16dc24a980961a86f3a23ffaa27eb6beea6", "url": "https://github.com/crate/crate/commit/5fbec16dc24a980961a86f3a23ffaa27eb6beea6", "message": "Split cast functions into implicit, explicit, try cast functions.", "committedDate": "2020-05-29T15:02:27Z", "type": "commit"}, {"oid": "3ea995a95866457747caf36a7f14393bdcb054d3", "url": "https://github.com/crate/crate/commit/3ea995a95866457747caf36a7f14393bdcb054d3", "message": "Make the second _cast argument to accept the target type as a string.", "committedDate": "2020-05-29T15:02:27Z", "type": "forcePushed"}, {"oid": "83d67b0e9ede40147511cd2953a5fd15fb7074e6", "url": "https://github.com/crate/crate/commit/83d67b0e9ede40147511cd2953a5fd15fb7074e6", "message": "Make the second _cast argument to accept the target type as a string.", "committedDate": "2020-05-29T15:09:36Z", "type": "forcePushed"}, {"oid": "0fe6a17b0db1954a06956deefefc85a69e50015a", "url": "https://github.com/crate/crate/commit/0fe6a17b0db1954a06956deefefc85a69e50015a", "message": "Make the second _cast argument to accept the target type as a string.", "committedDate": "2020-05-29T15:28:18Z", "type": "commit"}, {"oid": "0fe6a17b0db1954a06956deefefc85a69e50015a", "url": "https://github.com/crate/crate/commit/0fe6a17b0db1954a06956deefefc85a69e50015a", "message": "Make the second _cast argument to accept the target type as a string.", "committedDate": "2020-05-29T15:28:18Z", "type": "forcePushed"}, {"oid": "027547a7129530f351769d6ba3ed736a46e57ded", "url": "https://github.com/crate/crate/commit/027547a7129530f351769d6ba3ed736a46e57ded", "message": "Merge branch 'master' into r/varchar-data-type-cast-method", "committedDate": "2020-06-02T07:18:52Z", "type": "commit"}]}