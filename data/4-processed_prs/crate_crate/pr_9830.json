{"pr_number": 9830, "pr_title": "Use BlockBasedRamAccounting for nested loop & hash join", "pr_createdAt": "2020-03-30T15:37:42Z", "pr_url": "https://github.com/crate/crate/pull/9830", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI5MTgyNg==", "url": "https://github.com/crate/crate/pull/9830#discussion_r400291826", "bodyText": "Not sure why there was a special exception for blockNestedLoop. To me it seems like there is also a single thread that uses the ramAccounting instance.", "author": "mfussenegger", "createdAt": "2020-03-30T15:38:49Z", "path": "sql/src/main/java/io/crate/execution/jobs/JobSetup.java", "diffHunk": "@@ -883,7 +883,7 @@ public Boolean visitNestedLoopPhase(NestedLoopPhase phase, Context context) {\n                 joinCondition,\n                 phase.joinType(),\n                 breaker(),\n-                phase.blockNestedLoop ? ramAccounting : ramAccountingOfOperation,", "originalCommit": "6aeab12859cd4839c406de1a06d721ea6402864c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDczNzE2Ng==", "url": "https://github.com/crate/crate/pull/9830#discussion_r400737166", "bodyText": "Maybe it was just a mistake by me? I agree that only 1 thread will use it concurrently.", "author": "seut", "createdAt": "2020-03-31T08:36:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI5MTgyNg=="}], "type": "inlineReview"}, {"oid": "db9499f557e3574d8a58aa295f5cae76d43986b0", "url": "https://github.com/crate/crate/commit/db9499f557e3574d8a58aa295f5cae76d43986b0", "message": "Use BlockBasedRamAccounting for HashJoin operation\n\n    V1: 4.2.0-ac8af037f046b1a7c8a8167dea4d6381348e1c8a\n    V2: 4.2.0-a0d2624c739a8e456db99e53891416196c06c7f4\n\n    Q: select * from articles inner join colors on articles.id = colors.id order by articles.id limit 1000\n    C: 1\n    | Version |         Mean \u00b1    Stdev |        Min |     Median |         Q3 |        Max |\n    |   V1    |      129.933 \u00b1   26.256 |     91.958 |    125.718 |    128.930 |    347.124 |\n    |   V2    |      100.603 \u00b1   31.283 |     63.374 |     94.106 |     99.388 |    422.406 |\n    mean:   -  25.45%\n    median: -  28.76%", "committedDate": "2020-03-30T16:56:13Z", "type": "forcePushed"}, {"oid": "abe0e8e94a954a524ee5d963b4918710319fd7a1", "url": "https://github.com/crate/crate/commit/abe0e8e94a954a524ee5d963b4918710319fd7a1", "message": "Use BlockBasedRamAccounting for HashJoin operation\n\n    V1: 4.2.0-ac8af037f046b1a7c8a8167dea4d6381348e1c8a\n    V2: 4.2.0-a0d2624c739a8e456db99e53891416196c06c7f4\n\n    Q: select * from articles inner join colors on articles.id = colors.id order by articles.id limit 1000\n    C: 1\n    | Version |         Mean \u00b1    Stdev |        Min |     Median |         Q3 |        Max |\n    |   V1    |      129.933 \u00b1   26.256 |     91.958 |    125.718 |    128.930 |    347.124 |\n    |   V2    |      100.603 \u00b1   31.283 |     63.374 |     94.106 |     99.388 |    422.406 |\n    mean:   -  25.45%\n    median: -  28.76%", "committedDate": "2020-03-30T17:00:00Z", "type": "forcePushed"}, {"oid": "2f89cfc07ae851592635f15ca9d921c49dca4c26", "url": "https://github.com/crate/crate/commit/2f89cfc07ae851592635f15ca9d921c49dca4c26", "message": "Use BlockBasedRamAccounting for nested loop\n\nUsing `ConcurrentRamAccounting` per row is expensive:\n\n    # Results (server side duration in ms)\n    V1: 4.2.0-ac8af037f046b1a7c8a8167dea4d6381348e1c8a\n    V2: 4.2.0-21a155bf0387798958bf6eaf2c27585784cea62f\n\n    Q: select * from articles CROSS JOIN colors limit 1 offset 10000\n    C: 1\n    | Version |         Mean \u00b1    Stdev |        Min |     Median |         Q3 |        Max |\n    |   V1    |       61.793 \u00b1   10.154 |     39.975 |     60.937 |     63.207 |    176.193 |\n    |   V2    |       13.667 \u00b1    8.858 |     10.774 |     12.397 |     13.342 |    133.641 |\n    mean:   - 127.55%\n    median: - 132.38%\n    Likely significant", "committedDate": "2020-03-31T09:44:28Z", "type": "commit"}, {"oid": "48ffbaaa8acd5cb4265049d96b4dc8d7dd08c4c4", "url": "https://github.com/crate/crate/commit/48ffbaaa8acd5cb4265049d96b4dc8d7dd08c4c4", "message": "Use BlockBasedRamAccounting for HashJoin operation\n\n    V1: 4.2.0-ac8af037f046b1a7c8a8167dea4d6381348e1c8a\n    V2: 4.2.0-a0d2624c739a8e456db99e53891416196c06c7f4\n\n    Q: select * from articles inner join colors on articles.id = colors.id order by articles.id limit 1000\n    C: 1\n    | Version |         Mean \u00b1    Stdev |        Min |     Median |         Q3 |        Max |\n    |   V1    |      129.933 \u00b1   26.256 |     91.958 |    125.718 |    128.930 |    347.124 |\n    |   V2    |      100.603 \u00b1   31.283 |     63.374 |     94.106 |     99.388 |    422.406 |\n    mean:   -  25.45%\n    median: -  28.76%", "committedDate": "2020-03-31T09:44:28Z", "type": "commit"}, {"oid": "48ffbaaa8acd5cb4265049d96b4dc8d7dd08c4c4", "url": "https://github.com/crate/crate/commit/48ffbaaa8acd5cb4265049d96b4dc8d7dd08c4c4", "message": "Use BlockBasedRamAccounting for HashJoin operation\n\n    V1: 4.2.0-ac8af037f046b1a7c8a8167dea4d6381348e1c8a\n    V2: 4.2.0-a0d2624c739a8e456db99e53891416196c06c7f4\n\n    Q: select * from articles inner join colors on articles.id = colors.id order by articles.id limit 1000\n    C: 1\n    | Version |         Mean \u00b1    Stdev |        Min |     Median |         Q3 |        Max |\n    |   V1    |      129.933 \u00b1   26.256 |     91.958 |    125.718 |    128.930 |    347.124 |\n    |   V2    |      100.603 \u00b1   31.283 |     63.374 |     94.106 |     99.388 |    422.406 |\n    mean:   -  25.45%\n    median: -  28.76%", "committedDate": "2020-03-31T09:44:28Z", "type": "forcePushed"}]}