{"pr_number": 9722, "pr_title": "Improve table recreation sys check docs", "pr_createdAt": "2020-03-03T14:39:27Z", "pr_url": "https://github.com/crate/crate/pull/9722", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA5NzY1Ng==", "url": "https://github.com/crate/crate/pull/9722#discussion_r387097656", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            CrateDB Table Version Compatibility Scheme\n          \n          \n            \n            CrateDB table version compatibility scheme", "author": "norosa", "createdAt": "2020-03-03T15:28:19Z", "path": "docs/admin/system-information.rst", "diffHunk": "@@ -1574,49 +1574,161 @@ Tables need to be recreated\n    cluster check is failing. Follow the instructions below to get this cluster\n    check passing.\n \n-This check warns you if there are tables that need to be recreated for\n-compatibility with future major versions of CrateDB.\n+This check warns you if your cluster contains tables that you need to reindex\n+before you can upgrade to a future major version of CrateDB.\n \n-If you try to upgrade to the next major version of CrateDB with tables that\n-have not been recreated, CrateDB will refuse to start.\n+If you try to upgrade to a later major CrateDB version without reindexing the\n+tables, CrateDB will refuse to start.\n \n-To recreate a table, you have to create new tables, copy over the data and\n-rename or remove the old table.\n+CrateDB Table Version Compatibility Scheme", "originalCommit": "6c617fbb0e58556a723f170b7693cab81b6f7c23", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEwNTE0OA==", "url": "https://github.com/crate/crate/pull/9722#discussion_r387105148", "bodyText": "we switched to sentence case for all headings last year (it is considered better style. see parameter one here: https://practicaltypography.com/headings.html)", "author": "norosa", "createdAt": "2020-03-03T15:39:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA5NzY1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA5ODEyNw==", "url": "https://github.com/crate/crate/pull/9722#discussion_r387098127", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Avoiding Reindex Using Partitioned Tables\n          \n          \n            \n            Avoiding reindex using partitioned tables", "author": "norosa", "createdAt": "2020-03-03T15:28:56Z", "path": "docs/admin/system-information.rst", "diffHunk": "@@ -1574,49 +1574,161 @@ Tables need to be recreated\n    cluster check is failing. Follow the instructions below to get this cluster\n    check passing.\n \n-This check warns you if there are tables that need to be recreated for\n-compatibility with future major versions of CrateDB.\n+This check warns you if your cluster contains tables that you need to reindex\n+before you can upgrade to a future major version of CrateDB.\n \n-If you try to upgrade to the next major version of CrateDB with tables that\n-have not been recreated, CrateDB will refuse to start.\n+If you try to upgrade to a later major CrateDB version without reindexing the\n+tables, CrateDB will refuse to start.\n \n-To recreate a table, you have to create new tables, copy over the data and\n-rename or remove the old table.\n+CrateDB Table Version Compatibility Scheme\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n \n-1) Use :ref:`ref-show-create-table` to get the schema required to create an\n-empty copy of the table to recreate::\n+CrateDB maintains backward compatibility for tables created in ``majorVersion - 1``:\n \n-    SHOW CREATE TABLE your_table;\n-\n-2) Create a new temporary table, using the schema returned from\n-:ref:`ref-show-create-table`::\n-\n-    CREATE TABLE tmp_your_table (...);\n-\n-3) Prevent inserts to the original table::\n-\n-    ALTER TABLE your_table SET (\"blocks.read_only\" = true);\n-\n-4) Copy the data::\n+.. list-table::\n \n-    INSERT INTO tmp_your_table (...) (SELECT ... FROM your_table);\n+    * - Table Origin\n+      - Current Version\n+      - Current Version\n+      - Current Version\n+    * - \n+      - 3.x\n+      - 4.x\n+      - 5.x\n+    * - 3.x\n+      - \u2714\ufe0f\n+      - \u2714\ufe0f\n+      - \u274c\n+    * - 4.x\n+      - \u274c\n+      - \u2714\ufe0f\n+      - \u2714\ufe0f\n+    * - 5.x\n+      - \u274c\n+      - \u274c\n+      - \u2714\ufe0f\n+\n+\n+Avoiding Reindex Using Partitioned Tables", "originalCommit": "6c617fbb0e58556a723f170b7693cab81b6f7c23", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA5ODYzOA==", "url": "https://github.com/crate/crate/pull/9722#discussion_r387098638", "bodyText": "might convey your meaning a little better if you phrase it \"and intend to delete old data\"", "author": "norosa", "createdAt": "2020-03-03T15:29:43Z", "path": "docs/admin/system-information.rst", "diffHunk": "@@ -1574,49 +1574,161 @@ Tables need to be recreated\n    cluster check is failing. Follow the instructions below to get this cluster\n    check passing.\n \n-This check warns you if there are tables that need to be recreated for\n-compatibility with future major versions of CrateDB.\n+This check warns you if your cluster contains tables that you need to reindex\n+before you can upgrade to a future major version of CrateDB.\n \n-If you try to upgrade to the next major version of CrateDB with tables that\n-have not been recreated, CrateDB will refuse to start.\n+If you try to upgrade to a later major CrateDB version without reindexing the\n+tables, CrateDB will refuse to start.\n \n-To recreate a table, you have to create new tables, copy over the data and\n-rename or remove the old table.\n+CrateDB Table Version Compatibility Scheme\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n \n-1) Use :ref:`ref-show-create-table` to get the schema required to create an\n-empty copy of the table to recreate::\n+CrateDB maintains backward compatibility for tables created in ``majorVersion - 1``:\n \n-    SHOW CREATE TABLE your_table;\n-\n-2) Create a new temporary table, using the schema returned from\n-:ref:`ref-show-create-table`::\n-\n-    CREATE TABLE tmp_your_table (...);\n-\n-3) Prevent inserts to the original table::\n-\n-    ALTER TABLE your_table SET (\"blocks.read_only\" = true);\n-\n-4) Copy the data::\n+.. list-table::\n \n-    INSERT INTO tmp_your_table (...) (SELECT ... FROM your_table);\n+    * - Table Origin\n+      - Current Version\n+      - Current Version\n+      - Current Version\n+    * - \n+      - 3.x\n+      - 4.x\n+      - 5.x\n+    * - 3.x\n+      - \u2714\ufe0f\n+      - \u2714\ufe0f\n+      - \u274c\n+    * - 4.x\n+      - \u274c\n+      - \u2714\ufe0f\n+      - \u2714\ufe0f\n+    * - 5.x\n+      - \u274c\n+      - \u274c\n+      - \u2714\ufe0f\n+\n+\n+Avoiding Reindex Using Partitioned Tables\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+Reindexing tables is an expensive operation which can take a long time. If you\n+are storing time series data for a certain retention period and delete old", "originalCommit": "6c617fbb0e58556a723f170b7693cab81b6f7c23", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA5ODk0Nw==", "url": "https://github.com/crate/crate/pull/9722#discussion_r387098947", "bodyText": "for numbers 0-9, it's good style to spell them out (see https://oreillymedia.github.io/production-resources/styleguide/#dates_and_numbers). so, \"nine\", in this instance\nnote: this doesn't apply to literals", "author": "norosa", "createdAt": "2020-03-03T15:30:11Z", "path": "docs/admin/system-information.rst", "diffHunk": "@@ -1574,49 +1574,161 @@ Tables need to be recreated\n    cluster check is failing. Follow the instructions below to get this cluster\n    check passing.\n \n-This check warns you if there are tables that need to be recreated for\n-compatibility with future major versions of CrateDB.\n+This check warns you if your cluster contains tables that you need to reindex\n+before you can upgrade to a future major version of CrateDB.\n \n-If you try to upgrade to the next major version of CrateDB with tables that\n-have not been recreated, CrateDB will refuse to start.\n+If you try to upgrade to a later major CrateDB version without reindexing the\n+tables, CrateDB will refuse to start.\n \n-To recreate a table, you have to create new tables, copy over the data and\n-rename or remove the old table.\n+CrateDB Table Version Compatibility Scheme\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n \n-1) Use :ref:`ref-show-create-table` to get the schema required to create an\n-empty copy of the table to recreate::\n+CrateDB maintains backward compatibility for tables created in ``majorVersion - 1``:\n \n-    SHOW CREATE TABLE your_table;\n-\n-2) Create a new temporary table, using the schema returned from\n-:ref:`ref-show-create-table`::\n-\n-    CREATE TABLE tmp_your_table (...);\n-\n-3) Prevent inserts to the original table::\n-\n-    ALTER TABLE your_table SET (\"blocks.read_only\" = true);\n-\n-4) Copy the data::\n+.. list-table::\n \n-    INSERT INTO tmp_your_table (...) (SELECT ... FROM your_table);\n+    * - Table Origin\n+      - Current Version\n+      - Current Version\n+      - Current Version\n+    * - \n+      - 3.x\n+      - 4.x\n+      - 5.x\n+    * - 3.x\n+      - \u2714\ufe0f\n+      - \u2714\ufe0f\n+      - \u274c\n+    * - 4.x\n+      - \u274c\n+      - \u2714\ufe0f\n+      - \u2714\ufe0f\n+    * - 5.x\n+      - \u274c\n+      - \u274c\n+      - \u2714\ufe0f\n+\n+\n+Avoiding Reindex Using Partitioned Tables\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+Reindexing tables is an expensive operation which can take a long time. If you\n+are storing time series data for a certain retention period and delete old\n+data, it is possible to use the :ref:`partitioned_tables` feature to avoid\n+reindex operations.\n+\n+You will have to partition a table by a column that denotes time. For example,\n+if you have a retention period of 9 months, you could partition a table by a", "originalCommit": "6c617fbb0e58556a723f170b7693cab81b6f7c23", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA5OTk2Nw==", "url": "https://github.com/crate/crate/pull/9722#discussion_r387099967", "bodyText": "how about:\n\"Then, every month, the system will create a new partition.\"", "author": "norosa", "createdAt": "2020-03-03T15:31:36Z", "path": "docs/admin/system-information.rst", "diffHunk": "@@ -1574,49 +1574,161 @@ Tables need to be recreated\n    cluster check is failing. Follow the instructions below to get this cluster\n    check passing.\n \n-This check warns you if there are tables that need to be recreated for\n-compatibility with future major versions of CrateDB.\n+This check warns you if your cluster contains tables that you need to reindex\n+before you can upgrade to a future major version of CrateDB.\n \n-If you try to upgrade to the next major version of CrateDB with tables that\n-have not been recreated, CrateDB will refuse to start.\n+If you try to upgrade to a later major CrateDB version without reindexing the\n+tables, CrateDB will refuse to start.\n \n-To recreate a table, you have to create new tables, copy over the data and\n-rename or remove the old table.\n+CrateDB Table Version Compatibility Scheme\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n \n-1) Use :ref:`ref-show-create-table` to get the schema required to create an\n-empty copy of the table to recreate::\n+CrateDB maintains backward compatibility for tables created in ``majorVersion - 1``:\n \n-    SHOW CREATE TABLE your_table;\n-\n-2) Create a new temporary table, using the schema returned from\n-:ref:`ref-show-create-table`::\n-\n-    CREATE TABLE tmp_your_table (...);\n-\n-3) Prevent inserts to the original table::\n-\n-    ALTER TABLE your_table SET (\"blocks.read_only\" = true);\n-\n-4) Copy the data::\n+.. list-table::\n \n-    INSERT INTO tmp_your_table (...) (SELECT ... FROM your_table);\n+    * - Table Origin\n+      - Current Version\n+      - Current Version\n+      - Current Version\n+    * - \n+      - 3.x\n+      - 4.x\n+      - 5.x\n+    * - 3.x\n+      - \u2714\ufe0f\n+      - \u2714\ufe0f\n+      - \u274c\n+    * - 4.x\n+      - \u274c\n+      - \u2714\ufe0f\n+      - \u2714\ufe0f\n+    * - 5.x\n+      - \u274c\n+      - \u274c\n+      - \u2714\ufe0f\n+\n+\n+Avoiding Reindex Using Partitioned Tables\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+Reindexing tables is an expensive operation which can take a long time. If you\n+are storing time series data for a certain retention period and delete old\n+data, it is possible to use the :ref:`partitioned_tables` feature to avoid\n+reindex operations.\n+\n+You will have to partition a table by a column that denotes time. For example,\n+if you have a retention period of 9 months, you could partition a table by a\n+``month`` column. Then every month the system creates a new partition. This new", "originalCommit": "6c617fbb0e58556a723f170b7693cab81b6f7c23", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEwMTg3NQ==", "url": "https://github.com/crate/crate/pull/9722#discussion_r387101875", "bodyText": "it's not clear to me how this fits:\n\"You will also have to delete the oldest partition.\"\nI think maybe this para could start with an \"If\" condition, i.e., \"If you wish to achieve GOAL, then you must...\"\nthat would make it more clear that you are outlining a procedure. as it stands, the bit before this sentence about deleting a partition reads more like a general description of how partitioning works", "author": "norosa", "createdAt": "2020-03-03T15:34:32Z", "path": "docs/admin/system-information.rst", "diffHunk": "@@ -1574,49 +1574,161 @@ Tables need to be recreated\n    cluster check is failing. Follow the instructions below to get this cluster\n    check passing.\n \n-This check warns you if there are tables that need to be recreated for\n-compatibility with future major versions of CrateDB.\n+This check warns you if your cluster contains tables that you need to reindex\n+before you can upgrade to a future major version of CrateDB.\n \n-If you try to upgrade to the next major version of CrateDB with tables that\n-have not been recreated, CrateDB will refuse to start.\n+If you try to upgrade to a later major CrateDB version without reindexing the\n+tables, CrateDB will refuse to start.\n \n-To recreate a table, you have to create new tables, copy over the data and\n-rename or remove the old table.\n+CrateDB Table Version Compatibility Scheme\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n \n-1) Use :ref:`ref-show-create-table` to get the schema required to create an\n-empty copy of the table to recreate::\n+CrateDB maintains backward compatibility for tables created in ``majorVersion - 1``:\n \n-    SHOW CREATE TABLE your_table;\n-\n-2) Create a new temporary table, using the schema returned from\n-:ref:`ref-show-create-table`::\n-\n-    CREATE TABLE tmp_your_table (...);\n-\n-3) Prevent inserts to the original table::\n-\n-    ALTER TABLE your_table SET (\"blocks.read_only\" = true);\n-\n-4) Copy the data::\n+.. list-table::\n \n-    INSERT INTO tmp_your_table (...) (SELECT ... FROM your_table);\n+    * - Table Origin\n+      - Current Version\n+      - Current Version\n+      - Current Version\n+    * - \n+      - 3.x\n+      - 4.x\n+      - 5.x\n+    * - 3.x\n+      - \u2714\ufe0f\n+      - \u2714\ufe0f\n+      - \u274c\n+    * - 4.x\n+      - \u274c\n+      - \u2714\ufe0f\n+      - \u2714\ufe0f\n+    * - 5.x\n+      - \u274c\n+      - \u274c\n+      - \u2714\ufe0f\n+\n+\n+Avoiding Reindex Using Partitioned Tables\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+Reindexing tables is an expensive operation which can take a long time. If you\n+are storing time series data for a certain retention period and delete old\n+data, it is possible to use the :ref:`partitioned_tables` feature to avoid\n+reindex operations.\n+\n+You will have to partition a table by a column that denotes time. For example,\n+if you have a retention period of 9 months, you could partition a table by a\n+``month`` column. Then every month the system creates a new partition. This new\n+partition is created using the active CrateDB version and is compatible with\n+the next major CrateDB version. You will also have to delete the oldest\n+partition. By doing this you will have rolled through all partitions after 9", "originalCommit": "6c617fbb0e58556a723f170b7693cab81b6f7c23", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEwMjA4MQ==", "url": "https://github.com/crate/crate/pull/9722#discussion_r387102081", "bodyText": "also, minor: comma after \"By doing this\"", "author": "norosa", "createdAt": "2020-03-03T15:34:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEwMTg3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEwMjEzOQ==", "url": "https://github.com/crate/crate/pull/9722#discussion_r387102139", "bodyText": "also, \"nine\" :)", "author": "norosa", "createdAt": "2020-03-03T15:34:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEwMTg3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEzMzE1Ng==", "url": "https://github.com/crate/crate/pull/9722#discussion_r387133156", "bodyText": "@mechanomi Tried to rephrase it, maybe you can have another look", "author": "mfussenegger", "createdAt": "2020-03-03T16:19:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEwMTg3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY3ODA5MQ==", "url": "https://github.com/crate/crate/pull/9722#discussion_r387678091", "bodyText": "@mfussenegger big improvement! thx!", "author": "norosa", "createdAt": "2020-03-04T13:51:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEwMTg3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEwMjMxMA==", "url": "https://github.com/crate/crate/pull/9722#discussion_r387102310", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            How To Reindex\n          \n          \n            \n            How to reindex", "author": "norosa", "createdAt": "2020-03-03T15:35:09Z", "path": "docs/admin/system-information.rst", "diffHunk": "@@ -1574,49 +1574,161 @@ Tables need to be recreated\n    cluster check is failing. Follow the instructions below to get this cluster\n    check passing.\n \n-This check warns you if there are tables that need to be recreated for\n-compatibility with future major versions of CrateDB.\n+This check warns you if your cluster contains tables that you need to reindex\n+before you can upgrade to a future major version of CrateDB.\n \n-If you try to upgrade to the next major version of CrateDB with tables that\n-have not been recreated, CrateDB will refuse to start.\n+If you try to upgrade to a later major CrateDB version without reindexing the\n+tables, CrateDB will refuse to start.\n \n-To recreate a table, you have to create new tables, copy over the data and\n-rename or remove the old table.\n+CrateDB Table Version Compatibility Scheme\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n \n-1) Use :ref:`ref-show-create-table` to get the schema required to create an\n-empty copy of the table to recreate::\n+CrateDB maintains backward compatibility for tables created in ``majorVersion - 1``:\n \n-    SHOW CREATE TABLE your_table;\n-\n-2) Create a new temporary table, using the schema returned from\n-:ref:`ref-show-create-table`::\n-\n-    CREATE TABLE tmp_your_table (...);\n-\n-3) Prevent inserts to the original table::\n-\n-    ALTER TABLE your_table SET (\"blocks.read_only\" = true);\n-\n-4) Copy the data::\n+.. list-table::\n \n-    INSERT INTO tmp_your_table (...) (SELECT ... FROM your_table);\n+    * - Table Origin\n+      - Current Version\n+      - Current Version\n+      - Current Version\n+    * - \n+      - 3.x\n+      - 4.x\n+      - 5.x\n+    * - 3.x\n+      - \u2714\ufe0f\n+      - \u2714\ufe0f\n+      - \u274c\n+    * - 4.x\n+      - \u274c\n+      - \u2714\ufe0f\n+      - \u2714\ufe0f\n+    * - 5.x\n+      - \u274c\n+      - \u274c\n+      - \u2714\ufe0f\n+\n+\n+Avoiding Reindex Using Partitioned Tables\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+Reindexing tables is an expensive operation which can take a long time. If you\n+are storing time series data for a certain retention period and delete old\n+data, it is possible to use the :ref:`partitioned_tables` feature to avoid\n+reindex operations.\n+\n+You will have to partition a table by a column that denotes time. For example,\n+if you have a retention period of 9 months, you could partition a table by a\n+``month`` column. Then every month the system creates a new partition. This new\n+partition is created using the active CrateDB version and is compatible with\n+the next major CrateDB version. You will also have to delete the oldest\n+partition. By doing this you will have rolled through all partitions after 9\n+months and all partitions will be compatible with the next major CrateDB\n+version.\n+\n+\n+How To Reindex", "originalCommit": "6c617fbb0e58556a723f170b7693cab81b6f7c23", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEwMzAwNw==", "url": "https://github.com/crate/crate/pull/9722#discussion_r387103007", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            6. Drop the now obsolete old table::\n          \n          \n            \n            6. Drop the old table, as it is now obsolete::\n          \n      \n    \n    \n  \n\n\"now obsolete\" is a bit confusing as an adjective phrase (also known as a compound adjective) as it is used here, especially when combined with the additional adjective, \"old\". if you do want to keep it this way, it should be styled \"now-obsolete\" to disambiguate the adjectives", "author": "norosa", "createdAt": "2020-03-03T15:36:10Z", "path": "docs/admin/system-information.rst", "diffHunk": "@@ -1574,49 +1574,161 @@ Tables need to be recreated\n    cluster check is failing. Follow the instructions below to get this cluster\n    check passing.\n \n-This check warns you if there are tables that need to be recreated for\n-compatibility with future major versions of CrateDB.\n+This check warns you if your cluster contains tables that you need to reindex\n+before you can upgrade to a future major version of CrateDB.\n \n-If you try to upgrade to the next major version of CrateDB with tables that\n-have not been recreated, CrateDB will refuse to start.\n+If you try to upgrade to a later major CrateDB version without reindexing the\n+tables, CrateDB will refuse to start.\n \n-To recreate a table, you have to create new tables, copy over the data and\n-rename or remove the old table.\n+CrateDB Table Version Compatibility Scheme\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n \n-1) Use :ref:`ref-show-create-table` to get the schema required to create an\n-empty copy of the table to recreate::\n+CrateDB maintains backward compatibility for tables created in ``majorVersion - 1``:\n \n-    SHOW CREATE TABLE your_table;\n-\n-2) Create a new temporary table, using the schema returned from\n-:ref:`ref-show-create-table`::\n-\n-    CREATE TABLE tmp_your_table (...);\n-\n-3) Prevent inserts to the original table::\n-\n-    ALTER TABLE your_table SET (\"blocks.read_only\" = true);\n-\n-4) Copy the data::\n+.. list-table::\n \n-    INSERT INTO tmp_your_table (...) (SELECT ... FROM your_table);\n+    * - Table Origin\n+      - Current Version\n+      - Current Version\n+      - Current Version\n+    * - \n+      - 3.x\n+      - 4.x\n+      - 5.x\n+    * - 3.x\n+      - \u2714\ufe0f\n+      - \u2714\ufe0f\n+      - \u274c\n+    * - 4.x\n+      - \u274c\n+      - \u2714\ufe0f\n+      - \u2714\ufe0f\n+    * - 5.x\n+      - \u274c\n+      - \u274c\n+      - \u2714\ufe0f\n+\n+\n+Avoiding Reindex Using Partitioned Tables\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+Reindexing tables is an expensive operation which can take a long time. If you\n+are storing time series data for a certain retention period and delete old\n+data, it is possible to use the :ref:`partitioned_tables` feature to avoid\n+reindex operations.\n+\n+You will have to partition a table by a column that denotes time. For example,\n+if you have a retention period of 9 months, you could partition a table by a\n+``month`` column. Then every month the system creates a new partition. This new\n+partition is created using the active CrateDB version and is compatible with\n+the next major CrateDB version. You will also have to delete the oldest\n+partition. By doing this you will have rolled through all partitions after 9\n+months and all partitions will be compatible with the next major CrateDB\n+version.\n+\n+\n+How To Reindex\n+~~~~~~~~~~~~~~\n+\n+.. hide:\n+\n+    cr> CREATE TABLE rx.metrics (id TEXT PRIMARY KEY, temperature REAL);\n+    CREATE OK, 1 row affected (... sec)\n+\n+    cr> INSERT INTO rx.metrics (id, temperature) VALUES ('1', 38.4), ('2', 42.7);\n+    INSERT OK, 2 rows affected  (... sec)\n+\n+    cr> REFRESH TABLE rx.metrics;\n+    REFRESH OK, 1 row affected  (... sec)\n+\n+1. Use :ref:`ref-show-create-table` to get the schema required to create an\n+   empty copy of the table to recreate::\n+\n+    cr> SHOW CREATE TABLE rx.metrics;\n+    +-----------------------------------------------------+\n+    | SHOW CREATE TABLE rx.metrics                        |\n+    +-----------------------------------------------------+\n+    | CREATE TABLE IF NOT EXISTS \"rx\".\"metrics\" (         |\n+    |    \"id\" TEXT,                                       |\n+    |    \"temperature\" REAL,                              |\n+    |    PRIMARY KEY (\"id\")                               |\n+    | )                                                   |\n+    | CLUSTERED BY (\"id\") INTO 4 SHARDS                   |\n+    | WITH (                                              |\n+    |    \"allocation.max_retries\" = 5,                    |\n+    |    \"blocks.metadata\" = false,                       |\n+    |    \"blocks.read\" = false,                           |\n+    |    \"blocks.read_only\" = false,                      |\n+    |    \"blocks.read_only_allow_delete\" = false,         |\n+    |    \"blocks.write\" = false,                          |\n+    |    codec = 'default',                               |\n+    |    column_policy = 'strict',                        |\n+    |    \"mapping.total_fields.limit\" = 1000,             |\n+    |    max_ngram_diff = 1,                              |\n+    |    max_shingle_diff = 3,                            |\n+    |    number_of_replicas = '0-1',                      |\n+    |    refresh_interval = 1000,                         |\n+    |    \"routing.allocation.enable\" = 'all',             |\n+    |    \"routing.allocation.total_shards_per_node\" = -1, |\n+    |    \"store.type\" = 'fs',                             |\n+    |    \"translog.durability\" = 'REQUEST',               |\n+    |    \"translog.flush_threshold_size\" = 536870912,     |\n+    |    \"translog.sync_interval\" = 5000,                 |\n+    |    \"unassigned.node_left.delayed_timeout\" = 60000,  |\n+    |    \"warmer.enabled\" = true,                         |\n+    |    \"write.wait_for_active_shards\" = '1'             |\n+    | )                                                   |\n+    +-----------------------------------------------------+\n+    SHOW 1 row in set (... sec)\n+\n+2. Create a new temporary table, using the schema returned from\n+   :ref:`ref-show-create-table`::\n+\n+    cr> CREATE TABLE rx.tmp_metrics (id TEXT PRIMARY KEY, temperature REAL);\n+    CREATE OK, 1 row affected (... sec)\n+\n+3. Copy the data::\n+\n+    cr> INSERT INTO rx.tmp_metrics (id, temperature) (SELECT id, temperature FROM rx.metrics);\n+    INSERT OK, 2 rows affected (... sec)\n+\n+4. Swap the tables::\n+\n+    cr> ALTER CLUSTER SWAP TABLE rx.tmp_metrics TO rx.metrics;\n+    ALTER OK, 1 row affected  (... sec)\n+\n+5. Confirm the new ``your_table`` contains all data and has the new version::\n+\n+    cr> SELECT count(*) FROM rx.metrics;\n+    +----------+\n+    | count(*) |\n+    +----------+\n+    |        2 |\n+    +----------+\n+    SELECT 1 row in set (... sec)\n \n-5) Swap the tables::\n+    cr> SELECT version['created'] FROM information_schema.tables \n+    ... WHERE table_schema = 'rx' AND table_name = 'metrics';\n+    +--------------------+\n+    | version['created'] |\n+    +--------------------+\n+    | 4.2.0              |\n+    +--------------------+\n+    SELECT 1 row in set (... sec)\n \n-    ALTER CLUSTER SWAP TABLE tmp_your_table TO your_table;\n+6. Drop the now obsolete old table::", "originalCommit": "6c617fbb0e58556a723f170b7693cab81b6f7c23", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEwODU5MQ==", "url": "https://github.com/crate/crate/pull/9722#discussion_r387108591", "bodyText": "some related reading here: https://english.stackexchange.com/a/461189 (fun fact: this is one element of typographic style I'm fascinated with and have done far too much research on than I care to admit)", "author": "norosa", "createdAt": "2020-03-03T15:44:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEwMzAwNw=="}], "type": "inlineReview"}, {"oid": "6594b5ca5151cfa2cdc29f8ff6c44e5064465203", "url": "https://github.com/crate/crate/commit/6594b5ca5151cfa2cdc29f8ff6c44e5064465203", "message": "Improve table recreation sys check docs\n\n- Make sure the examples are tested\n- Document version compatibility\n- Add hint to avoiding reindex using partitions\n\nReplaces https://github.com/crate/crate/pull/8941", "committedDate": "2020-03-03T16:17:00Z", "type": "commit"}, {"oid": "6594b5ca5151cfa2cdc29f8ff6c44e5064465203", "url": "https://github.com/crate/crate/commit/6594b5ca5151cfa2cdc29f8ff6c44e5064465203", "message": "Improve table recreation sys check docs\n\n- Make sure the examples are tested\n- Document version compatibility\n- Add hint to avoiding reindex using partitions\n\nReplaces https://github.com/crate/crate/pull/8941", "committedDate": "2020-03-03T16:17:00Z", "type": "forcePushed"}]}