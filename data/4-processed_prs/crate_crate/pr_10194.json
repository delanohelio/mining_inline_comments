{"pr_number": 10194, "pr_title": "Add recursive deletes for BlobContainers and fix Snapshot Deletion", "pr_createdAt": "2020-07-09T10:10:15Z", "pr_url": "https://github.com/crate/crate/pull/10194", "timeline": [{"oid": "c6c50037c81981ce63ce8b959c4977cca648b2ae", "url": "https://github.com/crate/crate/commit/c6c50037c81981ce63ce8b959c4977cca648b2ae", "message": "Add recursive deletes for BlobContainers\n\nBackport of https://github.com/elastic/elasticsearch/pull/43281", "committedDate": "2020-07-09T11:37:21Z", "type": "forcePushed"}, {"oid": "915fcc8434f21be9ffb1c3e9540ec7e294f7697a", "url": "https://github.com/crate/crate/commit/915fcc8434f21be9ffb1c3e9540ec7e294f7697a", "message": "Remove unused code from BlobStoreRepository", "committedDate": "2020-07-09T13:03:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjIwNjQzMA==", "url": "https://github.com/crate/crate/pull/10194#discussion_r452206430", "bodyText": "This was the part which had to be adapted for correct deletions.", "author": "mkleen", "createdAt": "2020-07-09T13:12:48Z", "path": "server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java", "diffHunk": "@@ -927,24 +930,7 @@ long readSnapshotIndexLatestBlob() throws IOException {\n     }\n \n     private long listBlobsToGetLatestIndexId() throws IOException {\n-        Map<String, BlobMetadata> blobs = blobContainer().listBlobsByPrefix(INDEX_FILE_PREFIX);\n-        long latest = RepositoryData.EMPTY_REPO_GEN;\n-        if (blobs.isEmpty()) {\n-            // no snapshot index blobs have been written yet\n-            return latest;\n-        }\n-        for (final BlobMetadata blobMetadata : blobs.values()) {\n-            final String blobName = blobMetadata.name();\n-            try {\n-                final long curr = Long.parseLong(blobName.substring(INDEX_FILE_PREFIX.length()));\n-                latest = Math.max(latest, curr);\n-            } catch (NumberFormatException nfe) {\n-                // the index- blob wasn't of the format index-N where N is a number,\n-                // no idea what this blob is but it doesn't belong in the repository!\n-                LOGGER.debug(\"[{}] Unknown blob in the repository: {}\", metadata.name(), blobName);\n-            }\n-        }\n-        return latest;\n+        return latestGeneration(blobContainer().listBlobsByPrefix(INDEX_FILE_PREFIX).keySet());", "originalCommit": "915fcc8434f21be9ffb1c3e9540ec7e294f7697a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "542927a0036b0ef2d399abff3179634f7a150268", "url": "https://github.com/crate/crate/commit/542927a0036b0ef2d399abff3179634f7a150268", "message": "Remove unused code from BlobStoreRepository", "committedDate": "2020-07-09T13:15:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjIxMzM0MQ==", "url": "https://github.com/crate/crate/pull/10194#discussion_r452213341", "bodyText": "Should the client be closed eventually, or is that not necessary?", "author": "mfussenegger", "createdAt": "2020-07-09T13:23:01Z", "path": "blackbox/test_s3.py", "diffHunk": "@@ -103,6 +107,11 @@ def tearDownClass(cls):\n         crate_node.stop()\n \n     def test_copy_to_s3_copy_from_s3_roundtrip(self):\n+        client = Minio('127.0.0.1:9000',", "originalCommit": "542927a0036b0ef2d399abff3179634f7a150268", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjIxODgwMA==", "url": "https://github.com/crate/crate/pull/10194#discussion_r452218800", "bodyText": "It is not necessary according to https://github.com/minio/minio-py", "author": "mkleen", "createdAt": "2020-07-09T13:31:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjIxMzM0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjIzOTI4NA==", "url": "https://github.com/crate/crate/pull/10194#discussion_r452239284", "bodyText": "Maybe clarify that this affected Azure repositories? Or was it also the case for S3?", "author": "mfussenegger", "createdAt": "2020-07-09T14:00:01Z", "path": "docs/appendices/release-notes/unreleased.rst", "diffHunk": "@@ -268,5 +268,8 @@ Performance improvements\n Fixes\n =====\n \n+- Fixed an issue where :ref:`drop snapshots <ref-drop-snapshot>` would not\n+  delete all the related data.", "originalCommit": "0826dd7249e9549a5208b1a77f4e6b7b6444f97a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "18fa7e67ad1b1b247b461177feac0ba0768c2251", "url": "https://github.com/crate/crate/commit/18fa7e67ad1b1b247b461177feac0ba0768c2251", "message": "Remove unused code from BlobStoreRepository", "committedDate": "2020-07-09T14:12:40Z", "type": "forcePushed"}, {"oid": "83b90f275eb1d85d7acaae9e5aba8e9df0e62035", "url": "https://github.com/crate/crate/commit/83b90f275eb1d85d7acaae9e5aba8e9df0e62035", "message": "Remove unused code from BlobStoreRepository", "committedDate": "2020-07-09T14:16:01Z", "type": "forcePushed"}, {"oid": "143c92c53bc5b3b84a88f00c83057e56b13e1242", "url": "https://github.com/crate/crate/commit/143c92c53bc5b3b84a88f00c83057e56b13e1242", "message": "Remove unused code from BlobStoreRepository", "committedDate": "2020-07-09T14:17:02Z", "type": "forcePushed"}, {"oid": "2b1ad0c0af482cef39b6f18f259337352d4e62d6", "url": "https://github.com/crate/crate/commit/2b1ad0c0af482cef39b6f18f259337352d4e62d6", "message": "Add recursive deletes for BlobContainers and fix Snapshot Deletion\n\nBackport of https://github.com/elastic/elasticsearch/pull/43281\nThis fixes the snapshot deletion on azure where files would not\nhave been deleted.", "committedDate": "2020-07-09T14:19:18Z", "type": "commit"}, {"oid": "b6870cfc71e9e4b6ec05246ca55a43c51dd5b24f", "url": "https://github.com/crate/crate/commit/b6870cfc71e9e4b6ec05246ca55a43c51dd5b24f", "message": "Remove unused code from BlobStoreRepository", "committedDate": "2020-07-09T14:21:22Z", "type": "commit"}, {"oid": "b6870cfc71e9e4b6ec05246ca55a43c51dd5b24f", "url": "https://github.com/crate/crate/commit/b6870cfc71e9e4b6ec05246ca55a43c51dd5b24f", "message": "Remove unused code from BlobStoreRepository", "committedDate": "2020-07-09T14:21:22Z", "type": "forcePushed"}, {"oid": "b3f9e787225ee2b6365b6853eb5d888cfdc8c45d", "url": "https://github.com/crate/crate/commit/b3f9e787225ee2b6365b6853eb5d888cfdc8c45d", "message": "Merge branch 'master' into mkleen/fix_deletes", "committedDate": "2020-07-09T14:57:49Z", "type": "commit"}]}