{"pr_number": 10770, "pr_title": "Added ``rank`` window function", "pr_createdAt": "2020-11-12T15:51:52Z", "pr_url": "https://github.com/crate/crate/pull/10770", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM3ODg1Mw==", "url": "https://github.com/crate/crate/pull/10770#discussion_r522378853", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Within each partition, the rank of the first row is 1. Subsequent identical\n          \n          \n            \n            Within each partition, the rank of the first row is `1`. Subsequent identical", "author": "norosa", "createdAt": "2020-11-12T19:49:02Z", "path": "docs/general/builtins/window-functions.rst", "diffHunk": "@@ -607,6 +607,55 @@ Example::\n    +---------+------+--------+-------------+\n    SELECT 5 rows in set (... sec)\n \n+\n+.. _window-function-rank:\n+\n+``rank()``\n+----------\n+\n+.. note::\n+\n+    The ``rank`` window function is an :ref:`enterprise feature\n+    <enterprise-features>`.\n+\n+Synopsis\n+........\n+\n+::\n+\n+    rank()\n+\n+Returns the rank of every row within a partition of a result set.\n+\n+Within each partition, the rank of the first row is 1. Subsequent identical", "originalCommit": "f8f2d9e700ec19dacfd262a6581fead0566ea0ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjg0NTExMg==", "url": "https://github.com/crate/crate/pull/10770#discussion_r522845112", "bodyText": "oops this should be double backticks sorry!", "author": "norosa", "createdAt": "2020-11-13T09:57:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM3ODg1Mw=="}], "type": "inlineReview"}, {"oid": "b10d6b1e8202e13f0681e0bd9418a744b7e03b56", "url": "https://github.com/crate/crate/commit/b10d6b1e8202e13f0681e0bd9418a744b7e03b56", "message": "Added ``rank`` window function", "committedDate": "2020-11-17T09:18:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTAwNTY3Ng==", "url": "https://github.com/crate/crate/pull/10770#discussion_r525005676", "bodyText": "Could these be int to avoid boxing?", "author": "mfussenegger", "createdAt": "2020-11-17T09:28:04Z", "path": "enterprise/functions/src/main/java/io/crate/window/RankFunctions.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * This file is part of a module with proprietary Enterprise Features.\n+ *\n+ * Licensed to Crate.io Inc. (\"Crate.io\") under one or more contributor\n+ * license agreements.  See the NOTICE file distributed with this work for\n+ * additional information regarding copyright ownership.\n+ *\n+ * Unauthorized copying of this file, via any medium is strictly prohibited.\n+ *\n+ * To use this file, Crate.io must have given you permission to enable and\n+ * use such Enterprise Features and you must have a valid Enterprise or\n+ * Subscription Agreement with Crate.io.  If you enable or use the Enterprise\n+ * Features, you represent and warrant that you have a valid Enterprise or\n+ * Subscription Agreement with Crate.io.  Your use of the Enterprise Features\n+ * if governed by the terms and conditions of your Enterprise or Subscription\n+ * Agreement with Crate.io.\n+ */\n+\n+package io.crate.window;\n+\n+import io.crate.data.Input;\n+import io.crate.data.Row;\n+import io.crate.execution.engine.collect.CollectExpression;\n+import io.crate.execution.engine.window.WindowFrameState;\n+import io.crate.execution.engine.window.WindowFunction;\n+import io.crate.metadata.functions.Signature;\n+import io.crate.module.EnterpriseFunctionsModule;\n+import io.crate.types.DataTypes;\n+\n+import java.util.List;\n+\n+\n+public class RankFunctions implements WindowFunction {\n+\n+    private static final String RANK_NAME = \"rank\";\n+\n+    private final Signature signature;\n+    private final Signature boundSignature;\n+    private Integer seenLastUpperBound;\n+    private Integer rank;", "originalCommit": "b10d6b1e8202e13f0681e0bd9418a744b7e03b56", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTAxMzYzNw==", "url": "https://github.com/crate/crate/pull/10770#discussion_r525013637", "bodyText": "Do you think it would help users if we used some more realistic data set to also illustrate a common use case for the rank function?\nFor example, in https://www.sqltutorial.org/sql-window-functions/sql-rank/ they rank the salary.", "author": "mfussenegger", "createdAt": "2020-11-17T09:39:39Z", "path": "docs/general/builtins/window-functions.rst", "diffHunk": "@@ -607,6 +607,56 @@ Example::\n    +---------+------+--------+-------------+\n    SELECT 5 rows in set (... sec)\n \n+\n+.. _window-function-rank:\n+\n+``rank()``\n+----------\n+\n+.. note::\n+\n+    The ``rank`` window function is an :ref:`enterprise feature\n+    <enterprise-features>`.\n+\n+Synopsis\n+........\n+\n+::\n+\n+    rank()\n+\n+Returns the rank of every row within a partition of a result set.\n+\n+Within each partition, the rank of the first row is ``1``. Subsequent tied\n+rows are given the same rank, and the potential rank of the next row\n+is incremented. Because of this, ranks may not be sequential.\n+\n+Example::\n+\n+    cr> SELECT\n+    ...   col1,\n+    ...   col2,\n+    ...   RANK() OVER (ORDER BY col1) as rank\n+    ... FROM (VALUES", "originalCommit": "b10d6b1e8202e13f0681e0bd9418a744b7e03b56", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTAxNjE2MA==", "url": "https://github.com/crate/crate/pull/10770#discussion_r525016160", "bodyText": "Yeah, that's a good idea! Will do so.", "author": "autophagy", "createdAt": "2020-11-17T09:43:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTAxMzYzNw=="}], "type": "inlineReview"}, {"oid": "7c0786258a9dd696a7a9705d11a9b1bd68c3302c", "url": "https://github.com/crate/crate/commit/7c0786258a9dd696a7a9705d11a9b1bd68c3302c", "message": "Added ``rank`` window function", "committedDate": "2020-11-17T13:29:42Z", "type": "forcePushed"}, {"oid": "eaef0ec065ab5e085593888be0976e0662dc8258", "url": "https://github.com/crate/crate/commit/eaef0ec065ab5e085593888be0976e0662dc8258", "message": "Added ``rank`` window function", "committedDate": "2020-11-17T15:19:39Z", "type": "forcePushed"}, {"oid": "1ae65229a2f1c4e4e22f2ae31cda489f0a775bbd", "url": "https://github.com/crate/crate/commit/1ae65229a2f1c4e4e22f2ae31cda489f0a775bbd", "message": "Added ``rank`` window function", "committedDate": "2020-11-17T21:20:32Z", "type": "commit"}, {"oid": "1ae65229a2f1c4e4e22f2ae31cda489f0a775bbd", "url": "https://github.com/crate/crate/commit/1ae65229a2f1c4e4e22f2ae31cda489f0a775bbd", "message": "Added ``rank`` window function", "committedDate": "2020-11-17T21:20:32Z", "type": "forcePushed"}]}