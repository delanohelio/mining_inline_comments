{"pr_number": 9880, "pr_title": "Use the new func registry for the generate_series function.", "pr_createdAt": "2020-04-23T08:54:41Z", "pr_url": "https://github.com/crate/crate/pull/9880", "timeline": [{"oid": "1aed97bff743ea8f74b7310cdea86f20ea12f4e3", "url": "https://github.com/crate/crate/commit/1aed97bff743ea8f74b7310cdea86f20ea12f4e3", "message": "Use the new func registry for the generate_series function.", "committedDate": "2020-04-23T12:44:41Z", "type": "forcePushed"}, {"oid": "ac0390c67e474834bd36db79fd822ece147df5e0", "url": "https://github.com/crate/crate/commit/ac0390c67e474834bd36db79fd822ece147df5e0", "message": "Use the new func registry for the generate_series function.", "committedDate": "2020-04-23T14:11:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzgyODk4OQ==", "url": "https://github.com/crate/crate/pull/9880#discussion_r413828989", "bodyText": "hm shall we really catch unsupported argument types here instead of just letting it throw an unsupported function exception? I wouldn't introduce (or take further) such a special pattern, we don't do that anywhere else afaik.", "author": "seut", "createdAt": "2020-04-23T14:11:05Z", "path": "sql/src/main/java/io/crate/expression/tablefunctions/GenerateSeries.java", "diffHunk": "@@ -71,69 +65,104 @@\n public final class GenerateSeries<T extends Number> extends TableFunctionImplementation<T> {\n \n     public static final FunctionName NAME = new FunctionName(PgCatalogSchemaInfo.NAME, \"generate_series\");\n-    private final FunctionInfo info;\n-    private final T defaultStep;\n-    private final BinaryOperator<T> minus;\n-    private final BinaryOperator<T> plus;\n-    private final BinaryOperator<T> divide;\n-    private final Comparator<T> comparator;\n-    private final RowType returnType;\n \n     public static void register(TableFunctionModule module) {\n-        Param startAndEnd = Param.of(DataTypes.LONG, DataTypes.INTEGER, DataTypes.TIMESTAMPZ, DataTypes.TIMESTAMP);\n-        Param stepType = Param.of(DataTypes.LONG, DataTypes.INTEGER, DataTypes.INTERVAL);\n-        FuncParams.Builder paramsBuilder = FuncParams\n-            .builder(startAndEnd, startAndEnd)\n-            .withVarArgs(stepType)\n-            .limitVarArgOccurrences(1);\n-        module.register(NAME, new BaseFunctionResolver(paramsBuilder.build()) {\n-            @Override\n-            public FunctionImplementation getForTypes(List<DataType> types) throws IllegalArgumentException {\n-                DataType<?> startType = types.get(0);\n-                DataType<?> stopType = types.get(1);\n-                assert startType.equals(stopType) : \"Start and stop type must be the same, got: \" + startType + \" and \" + stopType;\n-                if (types.size() == 2 && !startType.equals(DataTypes.INTEGER) && !startType.equals(DataTypes.LONG)) {\n+        // without step\n+        module.register(\n+            Signature.table(\n+                NAME,\n+                DataTypes.LONG.getTypeSignature(),\n+                DataTypes.LONG.getTypeSignature(),\n+                new RowType(List.of(DataTypes.LONG)).getTypeSignature()),\n+            (signature, argTypes) -> new GenerateSeries<>(\n+                signature, argTypes, 1L, (x, y) -> x - y, Long::sum, (x, y) -> x / y, Long::compare)\n+        );\n+        module.register(\n+            Signature.table(\n+                NAME,\n+                DataTypes.INTEGER.getTypeSignature(),\n+                DataTypes.INTEGER.getTypeSignature(),\n+                new RowType(List.of(DataTypes.INTEGER)).getTypeSignature()),\n+            (signature, argTypes) -> new GenerateSeries<>(\n+                signature, argTypes, 1, (x, y) -> x - y, Integer::sum, (x, y) -> x / y, Integer::compare)\n+        );\n+\n+        // with step\n+        module.register(\n+            Signature.table(\n+                NAME,\n+                DataTypes.LONG.getTypeSignature(),\n+                DataTypes.LONG.getTypeSignature(),\n+                DataTypes.LONG.getTypeSignature(),\n+                new RowType(List.of(DataTypes.LONG)).getTypeSignature()),\n+            (signature, argTypes) -> new GenerateSeries<>(\n+                signature, argTypes, 1L, (x, y) -> x - y, Long::sum, (x, y) -> x / y, Long::compare)\n+        );\n+        module.register(\n+            Signature.table(\n+                NAME,\n+                DataTypes.INTEGER.getTypeSignature(),\n+                DataTypes.INTEGER.getTypeSignature(),\n+                DataTypes.INTEGER.getTypeSignature(),\n+                new RowType(List.of(DataTypes.INTEGER)).getTypeSignature()),\n+            (signature, argTypes) -> new GenerateSeries<>(\n+                signature, argTypes, 1, (x, y) -> x - y, Integer::sum, (x, y) -> x / y, Integer::compare)\n+        );\n+\n+        // generate_series(ts, ts, interval)\n+        for (var supportedType : List.of(DataTypes.TIMESTAMP, DataTypes.TIMESTAMPZ)) {\n+            module.register(\n+                Signature.table(\n+                    NAME,\n+                    supportedType.getTypeSignature(),\n+                    supportedType.getTypeSignature(),\n+                    DataTypes.INTERVAL.getTypeSignature(),\n+                    new RowType(List.of(supportedType)).getTypeSignature()),\n+                GenerateSeriesIntervals::new\n+            );\n+            module.register(\n+                Signature.table(\n+                    NAME,\n+                    supportedType.getTypeSignature(),\n+                    supportedType.getTypeSignature(),\n+                    new RowType(List.of(supportedType)).getTypeSignature()),\n+                (signature, argTypes) -> {\n                     throw new IllegalArgumentException(\n-                        \"generate_series(start, stop) has type `\" + startType.getName() +\n+                        \"generate_series(start, stop) has type `\" + argTypes.get(0).getName() +\n                         \"` for start, but requires long/int values for start and stop, \" +\n                         \"or if used with timestamps, it requires a third argument for the step (interval)\");", "originalCommit": "1aed97bff743ea8f74b7310cdea86f20ea12f4e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzg0NTE1NA==", "url": "https://github.com/crate/crate/pull/9880#discussion_r413845154", "bodyText": "I am not sure about this case either. I did it to make this test pass \n  \n    \n      crate/sql/src/test/java/io/crate/expression/tablefunctions/GenerateSeriesTest.java\n    \n    \n         Line 155\n      in\n      c455f66\n    \n    \n    \n    \n\n        \n          \n           public void test_step_is_mandatory_for_timestamps() { \n        \n    \n  \n\n\nBefore doing that I tried out two approaches:\n\nI didn't register this function signature, then the generate_series(ts, ts) function call would result in generate_series(long, long). I am not sure whether this behaviour is acceptable? wdyt?\nI tried to forbid coercion on  generate_series(long, long) and  generate_series(int, int), then the generate_series(ts, ts) won't be resolved of course, but also function calls like generate_series(1, null) won't be resolved either.", "author": "kovrus", "createdAt": "2020-04-23T14:29:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzgyODk4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzg2NjA3Ng==", "url": "https://github.com/crate/crate/pull/9880#discussion_r413866076", "bodyText": "Ah right, thx for the info.\nPitty, so we are missing a possibility to forbid coercion from a specific type. I wouldn't implement that now but will keep it in mind for maybe future adjustments.", "author": "seut", "createdAt": "2020-04-23T14:53:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzgyODk4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzg4Nzc0NQ==", "url": "https://github.com/crate/crate/pull/9880#discussion_r413887745", "bodyText": "Ah right, thx for the info.\nPitty, so we are missing a possibility to forbid coercion from a specific type. I wouldn't implement that now but will keep it in mind for maybe future adjustments.\n\nMaybe we can start a draft/meta issue for potential casting changes for 5.0 to gather examples like this.\nI think this is another case where the leniency causes trouble and we'd be better off making it more strict.", "author": "mfussenegger", "createdAt": "2020-04-23T15:18:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzgyODk4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM2NTg3Nw==", "url": "https://github.com/crate/crate/pull/9880#discussion_r414365877", "bodyText": "\ud83d\udc4d Yes, I can start with a draft for now and convert it into an issue after migrating few more functions.", "author": "kovrus", "createdAt": "2020-04-24T07:43:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzgyODk4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzgzMDM1OQ==", "url": "https://github.com/crate/crate/pull/9880#discussion_r413830359", "bodyText": "minor: I'd prefer having each argument in a dedicated line for improved readability (also related to the other registrations below).", "author": "seut", "createdAt": "2020-04-23T14:12:38Z", "path": "sql/src/main/java/io/crate/expression/tablefunctions/GenerateSeries.java", "diffHunk": "@@ -71,69 +65,104 @@\n public final class GenerateSeries<T extends Number> extends TableFunctionImplementation<T> {\n \n     public static final FunctionName NAME = new FunctionName(PgCatalogSchemaInfo.NAME, \"generate_series\");\n-    private final FunctionInfo info;\n-    private final T defaultStep;\n-    private final BinaryOperator<T> minus;\n-    private final BinaryOperator<T> plus;\n-    private final BinaryOperator<T> divide;\n-    private final Comparator<T> comparator;\n-    private final RowType returnType;\n \n     public static void register(TableFunctionModule module) {\n-        Param startAndEnd = Param.of(DataTypes.LONG, DataTypes.INTEGER, DataTypes.TIMESTAMPZ, DataTypes.TIMESTAMP);\n-        Param stepType = Param.of(DataTypes.LONG, DataTypes.INTEGER, DataTypes.INTERVAL);\n-        FuncParams.Builder paramsBuilder = FuncParams\n-            .builder(startAndEnd, startAndEnd)\n-            .withVarArgs(stepType)\n-            .limitVarArgOccurrences(1);\n-        module.register(NAME, new BaseFunctionResolver(paramsBuilder.build()) {\n-            @Override\n-            public FunctionImplementation getForTypes(List<DataType> types) throws IllegalArgumentException {\n-                DataType<?> startType = types.get(0);\n-                DataType<?> stopType = types.get(1);\n-                assert startType.equals(stopType) : \"Start and stop type must be the same, got: \" + startType + \" and \" + stopType;\n-                if (types.size() == 2 && !startType.equals(DataTypes.INTEGER) && !startType.equals(DataTypes.LONG)) {\n+        // without step\n+        module.register(\n+            Signature.table(\n+                NAME,\n+                DataTypes.LONG.getTypeSignature(),\n+                DataTypes.LONG.getTypeSignature(),\n+                new RowType(List.of(DataTypes.LONG)).getTypeSignature()),\n+            (signature, argTypes) -> new GenerateSeries<>(\n+                signature, argTypes, 1L, (x, y) -> x - y, Long::sum, (x, y) -> x / y, Long::compare)", "originalCommit": "ac0390c67e474834bd36db79fd822ece147df5e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "370f72c22171e2ae3a0d60064b3b5a373e780f4c", "url": "https://github.com/crate/crate/commit/370f72c22171e2ae3a0d60064b3b5a373e780f4c", "message": "Use the new func registry for the generate_series function.", "committedDate": "2020-04-23T14:20:49Z", "type": "forcePushed"}, {"oid": "2ae10ee16ab7312703004368a67fa8a204afdc6d", "url": "https://github.com/crate/crate/commit/2ae10ee16ab7312703004368a67fa8a204afdc6d", "message": "Use the new func registry for the generate_series function.", "committedDate": "2020-04-24T07:48:03Z", "type": "commit"}, {"oid": "2ae10ee16ab7312703004368a67fa8a204afdc6d", "url": "https://github.com/crate/crate/commit/2ae10ee16ab7312703004368a67fa8a204afdc6d", "message": "Use the new func registry for the generate_series function.", "committedDate": "2020-04-24T07:48:03Z", "type": "forcePushed"}, {"oid": "fdeb2c97287230bf794384e3c736b60654371bd7", "url": "https://github.com/crate/crate/commit/fdeb2c97287230bf794384e3c736b60654371bd7", "message": "Merge branch 'master' into r/generate-series-reg", "committedDate": "2020-04-24T08:24:08Z", "type": "commit"}, {"oid": "0188f53f0c7769f6ed1e4044cc828acf4af2782b", "url": "https://github.com/crate/crate/commit/0188f53f0c7769f6ed1e4044cc828acf4af2782b", "message": "Merge branch 'master' into r/generate-series-reg", "committedDate": "2020-04-24T08:57:03Z", "type": "commit"}]}