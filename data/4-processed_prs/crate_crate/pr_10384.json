{"pr_number": 10384, "pr_title": "Add doc-values aggregators for the arbitrary aggregation.", "pr_createdAt": "2020-08-17T14:57:38Z", "pr_url": "https://github.com/crate/crate/pull/10384", "timeline": [{"oid": "99a35442de74f665b6fce6937303ae24e4675e8c", "url": "https://github.com/crate/crate/commit/99a35442de74f665b6fce6937303ae24e4675e8c", "message": "Add doc-values aggregators for the arbitrary aggregation.\n\nIt improves the performance of the global standard deviation aggregations.\nSee https://github.com/crate/crate/pull/10048 for more information.", "committedDate": "2020-08-17T15:21:47Z", "type": "forcePushed"}, {"oid": "599f3285af5546829d386f68df6f1d8147613583", "url": "https://github.com/crate/crate/commit/599f3285af5546829d386f68df6f1d8147613583", "message": "Add doc-values aggregators for the arbitrary aggregation.\n\nIt improves the performance of the global standard deviation aggregations.\nSee https://github.com/crate/crate/pull/10048 for more information.", "committedDate": "2020-08-17T15:36:20Z", "type": "forcePushed"}, {"oid": "24950717d34dd3dc0d49651dbff77e9041a1f60d", "url": "https://github.com/crate/crate/commit/24950717d34dd3dc0d49651dbff77e9041a1f60d", "message": "Add doc-values aggregators for the arbitrary aggregation.\n\nIt improves the performance of the global standard deviation aggregations.\nSee https://github.com/crate/crate/pull/10048 for more information.", "committedDate": "2020-08-17T15:37:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTk1NzY3Mw==", "url": "https://github.com/crate/crate/pull/10384#discussion_r471957673", "bodyText": "I think we could use the value directly without the wrapper in this case. There is no primitive type involved, so it doesn't avoid boxing. Or am I missing something?", "author": "mfussenegger", "createdAt": "2020-08-18T07:02:46Z", "path": "server/src/main/java/io/crate/execution/engine/aggregation/impl/ArbitraryAggregation.java", "diffHunk": "@@ -108,4 +125,97 @@ public Object reduce(RamAccounting ramAccounting, Object state1, Object state2)\n     public Object terminatePartial(RamAccounting ramAccounting, Object state) {\n         return state;\n     }\n+\n+    @Nullable\n+    @Override\n+    public DocValueAggregator<?> getDocValueAggregator(List<DataType<?>> argumentTypes,\n+                                                       List<MappedFieldType> fieldTypes) {\n+        var dataType = argumentTypes.get(0);\n+        switch (dataType.id()) {\n+            case ByteType.ID:\n+            case ShortType.ID:\n+            case IntegerType.ID:\n+            case LongType.ID:\n+            case TimestampType.ID_WITH_TZ:\n+            case TimestampType.ID_WITHOUT_TZ:\n+                return new ArbitraryNumericDocValueAggregator(\n+                    fieldTypes.get(0).name(),\n+                    dataType,\n+                    (values, state) -> {\n+                        if (!state.hasValue()) {\n+                            state.setValue(values.nextValue());\n+                        }\n+                    }\n+                );\n+            case FloatType.ID:\n+                return new ArbitraryNumericDocValueAggregator(\n+                    fieldTypes.get(0).name(),\n+                    dataType,\n+                    (values, state) -> {\n+                        if (!state.hasValue()) {\n+                            var value = NumericUtils.sortableIntToFloat((int) values.nextValue());\n+                            state.setValue(value);\n+                        }\n+                    }\n+                );\n+            case DoubleType.ID:\n+                return new ArbitraryNumericDocValueAggregator(\n+                    fieldTypes.get(0).name(),\n+                    dataType,\n+                    (values, state) -> {\n+                        if (!state.hasValue()) {\n+                            var value = NumericUtils.sortableLongToDouble(values.nextValue());\n+                            state.setValue(value);\n+                        }\n+                    }\n+                );\n+            case IpType.ID:\n+            case StringType.ID:\n+                return new BinaryDocValueAggregator<>(\n+                    fieldTypes.get(0).name(),\n+                    MutableObject::new,", "originalCommit": "24950717d34dd3dc0d49651dbff77e9041a1f60d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjAyMzEwNA==", "url": "https://github.com/crate/crate/pull/10384#discussion_r472023104", "bodyText": "But I still need to have the state represented by some kind of a reference holder, otherwise, if it would be e.g. just an object ref it won't be possible to set/point the state to the extracted doc value.", "author": "kovrus", "createdAt": "2020-08-18T08:53:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTk1NzY3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjAyNTA0NQ==", "url": "https://github.com/crate/crate/pull/10384#discussion_r472025045", "bodyText": "Ah right, the apply of the DocValueAggregator only works with side effects.", "author": "mfussenegger", "createdAt": "2020-08-18T08:57:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTk1NzY3Mw=="}], "type": "inlineReview"}, {"oid": "9acf7dc0adbd40d5167a25d8ff93e60265146adf", "url": "https://github.com/crate/crate/commit/9acf7dc0adbd40d5167a25d8ff93e60265146adf", "message": "Add doc-values aggregators for the arbitrary aggregation.\n\nIt improves the performance of the global standard deviation aggregations.\nSee https://github.com/crate/crate/pull/10048 for more information.", "committedDate": "2020-08-18T09:13:34Z", "type": "commit"}, {"oid": "9acf7dc0adbd40d5167a25d8ff93e60265146adf", "url": "https://github.com/crate/crate/commit/9acf7dc0adbd40d5167a25d8ff93e60265146adf", "message": "Add doc-values aggregators for the arbitrary aggregation.\n\nIt improves the performance of the global standard deviation aggregations.\nSee https://github.com/crate/crate/pull/10048 for more information.", "committedDate": "2020-08-18T09:13:34Z", "type": "forcePushed"}, {"oid": "3d4dfe5a0872fa79130bd980ac7e5b2a934a68e8", "url": "https://github.com/crate/crate/commit/3d4dfe5a0872fa79130bd980ac7e5b2a934a68e8", "message": "Merge branch 'master' into r/doc-values-agg-arbitrary", "committedDate": "2020-08-18T09:51:40Z", "type": "commit"}]}