{"pr_number": 9650, "pr_title": "Terminate ordered lucene collector on cancel/kill ", "pr_createdAt": "2020-02-11T15:32:53Z", "pr_url": "https://github.com/crate/crate/pull/9650", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcxNDMyMQ==", "url": "https://github.com/crate/crate/pull/9650#discussion_r377714321", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                                                Consumer<Throwable> beforeExceptional) {\n          \n          \n            \n                                                                Consumer<Throwable> onKill) {", "author": "mfussenegger", "createdAt": "2020-02-11T15:37:56Z", "path": "shared/src/main/java/io/crate/concurrent/CompletableFutures.java", "diffHunk": "@@ -57,4 +67,349 @@ private CompletableFutures() {\n         }\n     }\n \n+    public static <T> CompletionStage<T> asKillable(CompletableFuture<T> delegate,\n+                                                    Consumer<Throwable> beforeExceptional) {", "originalCommit": "063d6f3a73eb39336ced0ce957ec440a97f39a16", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcxNTY4MA==", "url": "https://github.com/crate/crate/pull/9650#discussion_r377715680", "bodyText": "Just curious, what's the forbidden part here?", "author": "mfussenegger", "createdAt": "2020-02-11T15:39:58Z", "path": "shared/src/main/java/io/crate/concurrent/CompletableFutures.java", "diffHunk": "@@ -57,4 +67,349 @@ private CompletableFutures() {\n         }\n     }\n \n+    public static <T> CompletionStage<T> asKillable(CompletableFuture<T> delegate,\n+                                                    Consumer<Throwable> beforeExceptional) {\n+        return new KillableCompletableFuture<>(delegate, beforeExceptional);\n+    }\n+\n+    @SuppressForbidden", "originalCommit": "063d6f3a73eb39336ced0ce957ec440a97f39a16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc0MjU1Ng==", "url": "https://github.com/crate/crate/pull/9650#discussion_r377742556", "bodyText": "See https://github.com/crate/crate/blob/master/gradle/forbidden-signatures.txt#L5", "author": "seut", "createdAt": "2020-02-11T16:19:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcxNTY4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcxOTQxNw==", "url": "https://github.com/crate/crate/pull/9650#discussion_r377719417", "bodyText": "I am not sure if we need both of these to be volatile.\nWe could probably remove the check here https://github.com/crate/crate/pull/9650/files#diff-1360f05e99db1b25d5f53dec74c7abb2R137 and always depend on the kill raising via the Collector. I think the operations happening between those actions are cheap enough to ignore.", "author": "mfussenegger", "createdAt": "2020-02-11T15:45:20Z", "path": "sql/src/main/java/io/crate/execution/engine/collect/collectors/LuceneOrderedDocCollector.java", "diffHunk": "@@ -72,6 +79,11 @@\n     private int batchSize;\n     private boolean batchSizeReduced = false;\n \n+    @Nullable\n+    private volatile KillableCollector currentCollector;\n+\n+    @Nullable\n+    private volatile Throwable killed;", "originalCommit": "063d6f3a73eb39336ced0ce957ec440a97f39a16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc0NjM1Ng==", "url": "https://github.com/crate/crate/pull/9650#discussion_r377746356", "bodyText": "I am not sure if we need both of these to be volatile.\n\nBoth can be set and used from different threads.\n    t1                       t2\n                          OrderedDocCollector\n                          -> collect()\n                            -> set currentCollector\n                            -> check killed and raise\n\n  kill()\n      ------------------> OrderedDocCollector\n                        -> set killed\n                        -> check currentCollector and call kill()  if set", "author": "seut", "createdAt": "2020-02-11T16:25:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcxOTQxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc0NjU4OQ==", "url": "https://github.com/crate/crate/pull/9650#discussion_r377746589", "bodyText": "We could probably remove the check here https://github.com/crate/crate/pull/9650/files#diff-1360f05e99db1b25d5f53dec74c7abb2R137 and always depend on the kill raising via the Collector. I think the operations happening between those actions are cheap enough to ignore.\n\nYep agree.", "author": "seut", "createdAt": "2020-02-11T16:26:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcxOTQxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcyMzY3NA==", "url": "https://github.com/crate/crate/pull/9650#discussion_r377723674", "bodyText": "I think there is a race condition between getLeafCollector and kill:\nt1: Is before `killed = t;`\nt2: Is past `raiseIfKilled(killed);` but hasn`t done the assignment to `currentLeafCollector`\n\nIn that case the kill would be swallowed I think. Could probably be solved with a compare and set operation", "author": "mfussenegger", "createdAt": "2020-02-11T15:51:42Z", "path": "sql/src/main/java/io/crate/execution/engine/collect/collectors/LuceneOrderedDocCollector.java", "diffHunk": "@@ -205,4 +231,83 @@ private Query query(FieldDoc lastDoc) {\n         searchAfterQuery.add(optimizedQuery, BooleanClause.Occur.MUST_NOT);\n         return searchAfterQuery.build();\n     }\n+\n+    private static void raiseIfKilled(@Nullable Throwable t) {\n+        if (t != null) {\n+            Exceptions.rethrowUnchecked(t);\n+        }\n+    }\n+\n+    private static class KillableCollector implements Collector, Killable {\n+\n+        private final Collector delegate;\n+\n+        @Nullable\n+        private volatile KillableLeafCollector currentLeafCollector;\n+\n+        @Nullable\n+        private volatile Throwable killed;\n+\n+        public KillableCollector(Collector delegate, @Nullable Throwable killed) {\n+            this.delegate = delegate;\n+            this.killed = killed;\n+        }\n+\n+        @Override\n+        public LeafCollector getLeafCollector(LeafReaderContext context) throws IOException {\n+            raiseIfKilled(killed);\n+            currentLeafCollector = new KillableLeafCollector(delegate.getLeafCollector(context), killed);\n+            return currentLeafCollector;\n+        }\n+\n+        @Override\n+        public ScoreMode scoreMode() {\n+            return delegate.scoreMode();\n+        }\n+\n+        @Override\n+        public void kill(@Nonnull Throwable t) {\n+            if (killed != null) {\n+                return;\n+            }\n+            killed = t;\n+            var leafCollector = currentLeafCollector;\n+            if (leafCollector != null) {", "originalCommit": "063d6f3a73eb39336ced0ce957ec440a97f39a16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc0MTk5Nw==", "url": "https://github.com/crate/crate/pull/9650#discussion_r377741997", "bodyText": "I don't think so as killed is passed to the leaf collector ctor.", "author": "seut", "createdAt": "2020-02-11T16:19:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcyMzY3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODEyNzEwMg==", "url": "https://github.com/crate/crate/pull/9650#discussion_r378127102", "bodyText": "Yes, but only if killed has been assigned before the leaf collector is created.\nThe scenario I have in mind is that killed hasn't been assignd to yet, and the other thread read the volatile (unassigned) 'killed' but didn't finish the 'currentLeafCollector'  assignment yet.\nHow about having a final AtomicReference in the top most class and the collector + leaf collector receive a reference to that? That would replace the individual killed attributes.", "author": "mfussenegger", "createdAt": "2020-02-12T09:24:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcyMzY3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE0OTkzNw==", "url": "https://github.com/crate/crate/pull/9650#discussion_r378149937", "bodyText": "Right, there is still a race condition, good catch.\n\nHow about having a final AtomicReference in the top most class and the collector + leaf collector receive a reference to that? That would replace the individual killed attributes.\n\nYep, sounds good.", "author": "seut", "createdAt": "2020-02-12T10:04:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcyMzY3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE2MDYwOA==", "url": "https://github.com/crate/crate/pull/9650#discussion_r378160608", "bodyText": "Pushed a fixup.", "author": "seut", "createdAt": "2020-02-12T10:23:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcyMzY3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcyNTUxNA==", "url": "https://github.com/crate/crate/pull/9650#discussion_r377725514", "bodyText": "I think here we could actually return the new KillableCompletableFuture. Otherwise the call-site has to know that this might implement Killable, that is not very common.\nBy changing the interface to return CompletionStage I was referring to loadNextBatch, but that could probably be a dedicated PR, as it isn't involved here at all.", "author": "mfussenegger", "createdAt": "2020-02-11T15:54:30Z", "path": "sql/src/main/java/io/crate/execution/engine/collect/collectors/OrderedLuceneBatchIteratorFactory.java", "diffHunk": "@@ -102,22 +104,24 @@\n             );\n         }\n \n-        private CompletableFuture<List<KeyIterable<ShardId, Row>>> tryFetchMore(ShardId shardId) {\n+        private CompletionStage<List<KeyIterable<ShardId, Row>>> tryFetchMore(ShardId shardId) {", "originalCommit": "063d6f3a73eb39336ced0ce957ec440a97f39a16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzczNTA3MQ==", "url": "https://github.com/crate/crate/pull/9650#discussion_r377735071", "bodyText": "Or maybe we expose a KillableCompletionStage here?", "author": "mfussenegger", "createdAt": "2020-02-11T16:08:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcyNTUxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzczNjcyOA==", "url": "https://github.com/crate/crate/pull/9650#discussion_r377736728", "bodyText": "By changing the interface to return CompletionStage I was referring to loadNextBatch\n\nThat's already in place.", "author": "seut", "createdAt": "2020-02-11T16:10:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcyNTUxNA=="}], "type": "inlineReview"}, {"oid": "24ab00eb94ab06fbfa150a1b26874612ee463009", "url": "https://github.com/crate/crate/commit/24ab00eb94ab06fbfa150a1b26874612ee463009", "message": "fixup! fixup! Terminate ordered lucene collector on cancel/kill", "committedDate": "2020-02-11T19:49:02Z", "type": "forcePushed"}, {"oid": "eab3bdb91d8d7ce5188d82ba03beb8c7e2e80243", "url": "https://github.com/crate/crate/commit/eab3bdb91d8d7ce5188d82ba03beb8c7e2e80243", "message": "fixup! fixup! Terminate ordered lucene collector on cancel/kill", "committedDate": "2020-02-11T19:51:55Z", "type": "forcePushed"}, {"oid": "3f751c3aa98b59a0648c32c5d3c9109d5eeada5f", "url": "https://github.com/crate/crate/commit/3f751c3aa98b59a0648c32c5d3c9109d5eeada5f", "message": "fixup! fixup! Terminate ordered lucene collector on cancel/kill", "committedDate": "2020-02-11T19:53:36Z", "type": "forcePushed"}, {"oid": "ca52c75556965792960ec7e8a4b7993166c1b464", "url": "https://github.com/crate/crate/commit/ca52c75556965792960ec7e8a4b7993166c1b464", "message": "fixup! fixup! Terminate ordered lucene collector on cancel/kill", "committedDate": "2020-02-11T19:57:39Z", "type": "forcePushed"}, {"oid": "779d1e5fd1d79fdf604ea3e8e72ddacf1b13aecb", "url": "https://github.com/crate/crate/commit/779d1e5fd1d79fdf604ea3e8e72ddacf1b13aecb", "message": "Terminate ordered lucene collector on cancel/kill\n\nIf an ordered lucene collector is running inside a child thread, it\nshould stop processing and the thread should terminate if cancelled/killed.\nOtherwise it may still occupy resources (e.g. account memory) AFTER the\njob was killed and shared resources (ram accounting) are released.", "committedDate": "2020-02-12T08:30:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE2NzUzOA==", "url": "https://github.com/crate/crate/pull/9650#discussion_r378167538", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    public KillableCollector(Collector delegate, Consumer<Void> raiseIfKilled) {\n          \n          \n            \n                    public KillableCollector(Collector delegate, Runnable raiseIfKilled) {", "author": "mfussenegger", "createdAt": "2020-02-12T10:36:30Z", "path": "sql/src/main/java/io/crate/execution/engine/collect/collectors/LuceneOrderedDocCollector.java", "diffHunk": "@@ -231,82 +222,55 @@ private Query query(FieldDoc lastDoc) {\n         return searchAfterQuery.build();\n     }\n \n-    private static void raiseIfKilled(@Nullable Throwable t) {\n+    private void raiseIfKilled() {\n+        var t = killed.get();\n         if (t != null) {\n             Exceptions.rethrowUnchecked(t);\n         }\n     }\n \n-    private static class KillableCollector implements Collector, Killable {\n+    private static class KillableCollector implements Collector {\n \n         private final Collector delegate;\n+        private final Consumer<Void> raiseIfKilled;\n \n-        @Nullable\n-        private volatile KillableLeafCollector currentLeafCollector;\n-\n-        @Nullable\n-        private volatile Throwable killed;\n-\n-        public KillableCollector(Collector delegate, @Nullable Throwable killed) {\n+        public KillableCollector(Collector delegate, Consumer<Void> raiseIfKilled) {", "originalCommit": "f68cde661b0a04409a7fa8f2a0a45f9c7c916221", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7c23a88568ea92f6e83aa32b55b0f739e9414728", "url": "https://github.com/crate/crate/commit/7c23a88568ea92f6e83aa32b55b0f739e9414728", "message": "Terminate ordered lucene collector on cancel/kill\n\nIf an ordered lucene collector is running inside a child thread, it\nshould stop processing and the thread should terminate if cancelled/killed.\nOtherwise it may still occupy resources (e.g. account memory) AFTER the\njob was killed and shared resources (ram accounting) are released.", "committedDate": "2020-02-12T10:44:59Z", "type": "commit"}, {"oid": "7c23a88568ea92f6e83aa32b55b0f739e9414728", "url": "https://github.com/crate/crate/commit/7c23a88568ea92f6e83aa32b55b0f739e9414728", "message": "Terminate ordered lucene collector on cancel/kill\n\nIf an ordered lucene collector is running inside a child thread, it\nshould stop processing and the thread should terminate if cancelled/killed.\nOtherwise it may still occupy resources (e.g. account memory) AFTER the\njob was killed and shared resources (ram accounting) are released.", "committedDate": "2020-02-12T10:44:59Z", "type": "forcePushed"}]}