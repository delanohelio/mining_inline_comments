{"pr_number": 9601, "pr_title": "Add returning clause for insert to grammar and parser", "pr_createdAt": "2020-01-30T12:54:35Z", "pr_url": "https://github.com/crate/crate/pull/9601", "timeline": [{"oid": "80c97d77ec14300b936d4c12c046a5da803eb84d", "url": "https://github.com/crate/crate/commit/80c97d77ec14300b936d4c12c046a5da803eb84d", "message": "Add insert to sqlformatter and teststatementbuilder", "committedDate": "2020-01-30T18:10:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzM2NDM3Mw==", "url": "https://github.com/crate/crate/pull/9601#discussion_r373364373", "bodyText": "Could Insert and InsertFromSubquery merged into one class ?  Looks like everywhere InsertFromSubquery is used.", "author": "mkleen", "createdAt": "2020-01-31T08:32:58Z", "path": "sql-parser/src/main/java/io/crate/sql/tree/Insert.java", "diffHunk": "@@ -31,11 +31,16 @@\n     protected final Table<T> table;\n     private final DuplicateKeyContext<T> duplicateKeyContext;\n     protected final List<String> columns;\n+    protected final List<SelectItem> returning;\n \n-    Insert(Table<T> table, List<String> columns, DuplicateKeyContext<T> duplicateKeyContext) {\n+    Insert(Table<T> table,", "originalCommit": "80c97d77ec14300b936d4c12c046a5da803eb84d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzM3MTI0MQ==", "url": "https://github.com/crate/crate/pull/9601#discussion_r373371241", "bodyText": "Yes we should do that. Could you follow up on that against master before continueing with this here?", "author": "mfussenegger", "createdAt": "2020-01-31T08:52:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzM2NDM3Mw=="}], "type": "inlineReview"}, {"oid": "f020bb3113557a4d5b16f6386e32b9d001948eb6", "url": "https://github.com/crate/crate/commit/f020bb3113557a4d5b16f6386e32b9d001948eb6", "message": "Add returning clause for insert to grammar and parser", "committedDate": "2020-01-31T08:35:50Z", "type": "forcePushed"}, {"oid": "aea04f5cb0c2f5fadefd0ca8c9e77091cb686872", "url": "https://github.com/crate/crate/commit/aea04f5cb0c2f5fadefd0ca8c9e77091cb686872", "message": "Remove InsertFromSubquery", "committedDate": "2020-01-31T15:12:05Z", "type": "forcePushed"}, {"oid": "e0c710f303a2d28b8888c29e2db2e795e8b12f73", "url": "https://github.com/crate/crate/commit/e0c710f303a2d28b8888c29e2db2e795e8b12f73", "message": "Add returning clause for insert to grammar and parser", "committedDate": "2020-01-31T15:17:16Z", "type": "forcePushed"}, {"oid": "ed66293237238e4f29aea017d24e75a4a2de910c", "url": "https://github.com/crate/crate/commit/ed66293237238e4f29aea017d24e75a4a2de910c", "message": "Add returning clause for insert to grammar and parser", "committedDate": "2020-01-31T15:28:16Z", "type": "forcePushed"}, {"oid": "774166eaae9e4d232804be7879ed08145bdf1500", "url": "https://github.com/crate/crate/commit/774166eaae9e4d232804be7879ed08145bdf1500", "message": "Add returning clause for insert to grammar and parser", "committedDate": "2020-01-31T15:31:57Z", "type": "forcePushed"}, {"oid": "4bbba73933a795ced2350452b90a17654ee30e88", "url": "https://github.com/crate/crate/commit/4bbba73933a795ced2350452b90a17654ee30e88", "message": "Add returning clause for insert to grammar and parser", "committedDate": "2020-02-01T02:49:09Z", "type": "forcePushed"}, {"oid": "87a1a1355fbc2d5c2d98e472a262257a0e47906c", "url": "https://github.com/crate/crate/commit/87a1a1355fbc2d5c2d98e472a262257a0e47906c", "message": "Add returning clause for insert to grammar and parser", "committedDate": "2020-02-01T02:52:46Z", "type": "forcePushed"}, {"oid": "5b8e4eca2de88b426585e4016a157e2019be05fe", "url": "https://github.com/crate/crate/commit/5b8e4eca2de88b426585e4016a157e2019be05fe", "message": "Add returning clause for insert to grammar and parser", "committedDate": "2020-02-01T02:54:49Z", "type": "forcePushed"}, {"oid": "8414f06a897ed08ea0a564b7b94ee69f79e1b323", "url": "https://github.com/crate/crate/commit/8414f06a897ed08ea0a564b7b94ee69f79e1b323", "message": "Add returning clause for insert to grammar and parser", "committedDate": "2020-02-02T03:27:10Z", "type": "forcePushed"}, {"oid": "a29d155350f59b4f0fea0583167adef0a012a134", "url": "https://github.com/crate/crate/commit/a29d155350f59b4f0fea0583167adef0a012a134", "message": "Add returning clause for insert to grammar and parser", "committedDate": "2020-02-03T05:50:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDAxMTk5NQ==", "url": "https://github.com/crate/crate/pull/9601#discussion_r374011995", "bodyText": "minor note: maybe instead of going with the returning rule, we can better introduce the selectItems rule that we can re-use in few places. Then we would avoid this special handling of the rule context, namely getReturningItems, and can reuse visitCollection without null checks, etc.  imho, going for the more common selectItems denominator gives a bit more beneficial.\notherwise, lgtm", "author": "kovrus", "createdAt": "2020-02-03T10:00:27Z", "path": "sql-parser/src/main/antlr/SqlBase.g4", "diffHunk": "@@ -139,6 +140,10 @@ where\n     : WHERE condition=booleanExpression\n     ;\n \n+returning\n+    : RETURNING selectItem (',' selectItem)*", "originalCommit": "a29d155350f59b4f0fea0583167adef0a012a134", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDAxNzg5Mw==", "url": "https://github.com/crate/crate/pull/9601#discussion_r374017893", "bodyText": "Thanks for the feedback. Do you mean something like this:\nINSERT INTO table ('(' ident (',' ident)* ')')? insertSource\n        onConflict?\n        (RETURNING selectItems)?   \n\nselectItems\n    : selectItem (',' selectItem)*\n    ;", "author": "mkleen", "createdAt": "2020-02-03T10:12:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDAxMTk5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDAxOTcwMg==", "url": "https://github.com/crate/crate/pull/9601#discussion_r374019702", "bodyText": "yes, ah but actually it probably won't work as i thought coz of the optional (RETURNING selectItems)?, so just ignore the comment", "author": "kovrus", "createdAt": "2020-02-03T10:16:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDAxMTk5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDA1MTEyOQ==", "url": "https://github.com/crate/crate/pull/9601#discussion_r374051129", "bodyText": "\ud83d\udc4d", "author": "mkleen", "createdAt": "2020-02-03T11:27:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDAxMTk5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDAzMjYzOA==", "url": "https://github.com/crate/crate/pull/9601#discussion_r374032638", "bodyText": "The indentation here looks way off?", "author": "mfussenegger", "createdAt": "2020-02-03T10:44:04Z", "path": "sql-parser/src/main/antlr/SqlBase.g4", "diffHunk": "@@ -40,7 +40,7 @@ statement\n     | UPDATE aliasedRelation\n         SET assignment (',' assignment)*\n         where?\n-        (RETURNING selectItem (',' selectItem)*)?      \t\t\t\t\t\t\t\t\t\t\t\t\t \t   #update\n+        returning?      \t\t\t\t\t\t\t\t                             #update", "originalCommit": "a29d155350f59b4f0fea0583167adef0a012a134", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDA1MDgwMA==", "url": "https://github.com/crate/crate/pull/9601#discussion_r374050800", "bodyText": "Would\nUPDATE aliasedRelation SET assignment (',' assignment)* where? returning?\nthe way to go ?", "author": "mkleen", "createdAt": "2020-02-03T11:26:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDAzMjYzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDA1ODkzMw==", "url": "https://github.com/crate/crate/pull/9601#discussion_r374058933", "bodyText": "Ah sorry should have been more specific. It was related to the extra whitespace before the #update (all the others were aligned)", "author": "mfussenegger", "createdAt": "2020-02-03T11:46:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDAzMjYzOA=="}], "type": "inlineReview"}, {"oid": "c6b8e8dce43a15ce72c0c1b49fe5f717e109af32", "url": "https://github.com/crate/crate/commit/c6b8e8dce43a15ce72c0c1b49fe5f717e109af32", "message": "Add returning clause for insert to grammar and parser", "committedDate": "2020-02-03T15:29:32Z", "type": "commit"}, {"oid": "c6b8e8dce43a15ce72c0c1b49fe5f717e109af32", "url": "https://github.com/crate/crate/commit/c6b8e8dce43a15ce72c0c1b49fe5f717e109af32", "message": "Add returning clause for insert to grammar and parser", "committedDate": "2020-02-03T15:29:32Z", "type": "forcePushed"}]}