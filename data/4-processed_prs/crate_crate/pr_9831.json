{"pr_number": 9831, "pr_title": "CONSTRAINT CHECK feature (create table, alter table add column check, alter table drop constraint)", "pr_createdAt": "2020-03-31T09:41:35Z", "pr_url": "https://github.com/crate/crate/pull/9831", "timeline": [{"oid": "fab1e8e96db68c2b224b5a2c1a3e4d76b21ea476", "url": "https://github.com/crate/crate/commit/fab1e8e96db68c2b224b5a2c1a3e4d76b21ea476", "message": "Allow the definition of check constraints in ALTER ADD COLUMN statements\n\nWith the caveat that such check constraints can only refer to the column\nbeing defined, to not invalidate existing data.", "committedDate": "2020-04-01T14:35:47Z", "type": "forcePushed"}, {"oid": "c491de2fe8fdc554c49a5acf0a91ebd1edc29dfa", "url": "https://github.com/crate/crate/commit/c491de2fe8fdc554c49a5acf0a91ebd1edc29dfa", "message": "Allow the definition of check constraints in ALTER ADD COLUMN statements\n\nWith the caveat that such check constraints can only refer to the column\nbeing defined, to not invalidate existing data.", "committedDate": "2020-04-01T16:14:07Z", "type": "forcePushed"}, {"oid": "9c9c0760603fd42924b5a5bba46b92bd30959831", "url": "https://github.com/crate/crate/commit/9c9c0760603fd42924b5a5bba46b92bd30959831", "message": "Allow the definition of check constraints in ALTER ADD COLUMN statements\n\nWith the caveat that such check constraints can only refer to the column\nbeing defined, to not invalidate existing data.", "committedDate": "2020-04-02T09:59:22Z", "type": "forcePushed"}, {"oid": "e8565ae7ea4617f4a1e34394cb5b29bcfa1721dd", "url": "https://github.com/crate/crate/commit/e8565ae7ea4617f4a1e34394cb5b29bcfa1721dd", "message": "Allow the definition of check constraints in ALTER ADD COLUMN statements\n\nWith the caveat that such check constraints can only refer to the column\nbeing defined, to not invalidate existing data.", "committedDate": "2020-04-02T13:59:38Z", "type": "forcePushed"}, {"oid": "1dd3a562d49cc880c3b0549a4f42f0989d79a8c3", "url": "https://github.com/crate/crate/commit/1dd3a562d49cc880c3b0549a4f42f0989d79a8c3", "message": "Add syntax ALTER TABLE t DROP CHECK CONSTRAINT name\n\nWhich will remove the constraint from the table if it exists.", "committedDate": "2020-04-03T11:41:25Z", "type": "forcePushed"}, {"oid": "e0eea3f7e9584be56c864542e9718d98d0a0aa56", "url": "https://github.com/crate/crate/commit/e0eea3f7e9584be56c864542e9718d98d0a0aa56", "message": "Add syntax ALTER TABLE t DROP CHECK CONSTRAINT name\n\nWhich will remove the constraint from the table if it exists.", "committedDate": "2020-04-03T13:28:48Z", "type": "forcePushed"}, {"oid": "85d856f65e23bae9235e9b90cd6e7d4d6dc4ebc1", "url": "https://github.com/crate/crate/commit/85d856f65e23bae9235e9b90cd6e7d4d6dc4ebc1", "message": "Add syntax ALTER TABLE t DROP CHECK CONSTRAINT name\n\nWhich will remove the constraint from the table if it exists.", "committedDate": "2020-04-03T14:38:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA2Nzk1Ng==", "url": "https://github.com/crate/crate/pull/9831#discussion_r403067956", "bodyText": "I would not do this / thing, I don't think it adds clarity. A general plural (\"values\", \"columns\") is fine.", "author": "matthijskrul", "createdAt": "2020-04-03T15:00:21Z", "path": "docs/appendices/release-notes/unreleased.rst", "diffHunk": "@@ -69,14 +69,18 @@ None\n Changes\n =======\n \n+- Add the :ref:`CHECK <check_constraint>` constraint syntax, which specifies", "originalCommit": "a880343c623174910a113e74635b6586631786c8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA2ODE1MQ==", "url": "https://github.com/crate/crate/pull/9831#discussion_r403068151", "bodyText": "As above", "author": "matthijskrul", "createdAt": "2020-04-03T15:00:39Z", "path": "docs/sql/general/constraints.rst", "diffHunk": "@@ -53,6 +53,96 @@ constraint or a table constraint.\n For further details about the meaning of the options see\n :ref:`indices_and_fulltext`.\n \n+.. _check_constraint:\n+\n+``CHECK``\n+---------\n+\n+The CHECK constraint specifies that the value/s of certain column/s must satisfy", "originalCommit": "a880343c623174910a113e74635b6586631786c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkyMDk0OA==", "url": "https://github.com/crate/crate/pull/9831#discussion_r403920948", "bodyText": "thank you! both corrected to plural then.", "author": "marregui", "createdAt": "2020-04-06T08:39:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA2ODE1MQ=="}], "type": "inlineReview"}, {"oid": "8efa15d0d21b5f2917ca0f6124ab1e099e2a027c", "url": "https://github.com/crate/crate/commit/8efa15d0d21b5f2917ca0f6124ab1e099e2a027c", "message": "Add unreleased notes and documentation on the constraints section", "committedDate": "2020-04-06T08:32:40Z", "type": "forcePushed"}, {"oid": "eefcb809c5e1ebbcb8434ae2dbe9cb3839750a0c", "url": "https://github.com/crate/crate/commit/eefcb809c5e1ebbcb8434ae2dbe9cb3839750a0c", "message": "Add unreleased notes and documentation on the constraints section", "committedDate": "2020-04-06T08:39:22Z", "type": "forcePushed"}, {"oid": "71f91a67f0c2ee89f299ddc46d9868b90f11e2f7", "url": "https://github.com/crate/crate/commit/71f91a67f0c2ee89f299ddc46d9868b90f11e2f7", "message": "Fix reference", "committedDate": "2020-04-06T11:21:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYzNzM4Mw==", "url": "https://github.com/crate/crate/pull/9831#discussion_r404637383", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            A check constraint allows you to specify that the values in a  certain column\n          \n          \n            \n            A check constraint allows you to specify that the values in a certain column", "author": "seut", "createdAt": "2020-04-07T08:40:24Z", "path": "docs/general/ddl/constraints.rst", "diffHunk": "@@ -65,9 +65,37 @@ Example::\n     ... );\n     CREATE OK, 1 row affected (... sec)\n \n+.. NOTE::\n+\n+   For further details see :ref:`not_null_constraint`.\n+\n+Check\n+=====\n+\n+A check constraint allows you to specify that the values in a  certain column", "originalCommit": "71f91a67f0c2ee89f299ddc46d9868b90f11e2f7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYzOTg1NQ==", "url": "https://github.com/crate/crate/pull/9831#discussion_r404639855", "bodyText": "Maybe worth adding a note or warning that it cannot be re-added to an existing table once dropped.", "author": "seut", "createdAt": "2020-04-07T08:44:23Z", "path": "docs/sql/statements/drop-constraint.rst", "diffHunk": "@@ -0,0 +1,33 @@\n+.. _drop-constraint:\n+\n+===================\n+``DROP CONSTRAINT``\n+===================\n+\n+Remove a :ref:`check_constraint` constraint from a table.", "originalCommit": "71f91a67f0c2ee89f299ddc46d9868b90f11e2f7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY0MTg2Ng==", "url": "https://github.com/crate/crate/pull/9831#discussion_r404641866", "bodyText": "Could we use a simple string concat here instead? this avoids unnecessary goggle common dependencies.", "author": "seut", "createdAt": "2020-04-07T08:47:29Z", "path": "sql-parser/src/main/java/io/crate/sql/tree/CheckColumnConstraint.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Licensed to Crate under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.  Crate licenses this file\n+ * to you under the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.  You may\n+ * obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or\n+ * implied.  See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ *\n+ * However, if you have executed another commercial license agreement\n+ * with Crate these terms will supersede the license and you may use the\n+ * software solely pursuant to the terms of the relevant commercial\n+ * agreement.\n+ */\n+\n+package io.crate.sql.tree;\n+\n+import com.google.common.base.MoreObjects;\n+import com.google.common.base.Objects;\n+\n+import javax.annotation.Nullable;\n+import java.util.function.Consumer;\n+import java.util.function.Function;\n+\n+public class CheckColumnConstraint<T> extends ColumnConstraint<T> {\n+\n+    @Nullable\n+    private final String name;\n+    private final String columnName;\n+    private final T expression;\n+    private final String expressionStr;\n+\n+    public CheckColumnConstraint(@Nullable String name, String columnName, T expression, String expressionStr) {\n+        this.name = name;\n+        this.columnName = columnName;\n+        this.expression = expression;\n+        this.expressionStr = expressionStr;\n+    }\n+\n+    public String columnName() {\n+        return columnName;\n+    }\n+\n+    @Nullable\n+    public String name() {\n+        return name;\n+    }\n+\n+    public T expression() {\n+        return expression;\n+    }\n+\n+    public String expressionStr() {\n+        return expressionStr;\n+    }\n+\n+    @Override\n+    public int hashCode() {\n+        return Objects.hashCode(name, columnName, expression);\n+    }\n+\n+    @Override\n+    public boolean equals(Object o) {\n+        if (this == o) {\n+            return true;\n+        }\n+        if (null == o || false == o instanceof CheckColumnConstraint) {\n+            return false;\n+        }\n+        CheckColumnConstraint that = (CheckColumnConstraint) o;\n+        return Objects.equal(expression, that.expression) &&\n+               Objects.equal(columnName, that.columnName) &&\n+               Objects.equal(name, that.name);\n+    }\n+\n+    @Override\n+    public <R, C> R accept(AstVisitor<R, C> visitor, C context) {\n+        return visitor.visitCheckColumnConstraint(this, context);\n+    }\n+\n+    @Override\n+    public <U> ColumnConstraint<U> map(Function<? super T, ? extends U> mapper) {\n+        return new CheckColumnConstraint<>(name, columnName, mapper.apply(expression), expressionStr);\n+    }\n+\n+    @Override\n+    public void visit(Consumer<? super T> consumer) {\n+        consumer.accept(expression);\n+    }\n+\n+    @Override\n+    public String toString() {\n+        return MoreObjects.toStringHelper(this)", "originalCommit": "71f91a67f0c2ee89f299ddc46d9868b90f11e2f7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY0MjA4OQ==", "url": "https://github.com/crate/crate/pull/9831#discussion_r404642089", "bodyText": "same here, pls use string concat instead.", "author": "seut", "createdAt": "2020-04-07T08:47:51Z", "path": "sql-parser/src/main/java/io/crate/sql/tree/CheckConstraint.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Licensed to CRATE Technology GmbH (\"Crate\") under one or more contributor\n+ * license agreements.  See the NOTICE file distributed with this work for\n+ * additional information regarding copyright ownership.  Crate licenses\n+ * this file to you under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.  You may\n+ * obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ *\n+ * However, if you have executed another commercial license agreement\n+ * with Crate these terms will supersede the license and you may use the\n+ * software solely pursuant to the terms of the relevant commercial agreement.\n+ */\n+\n+package io.crate.sql.tree;\n+\n+import com.google.common.base.MoreObjects;\n+import com.google.common.base.Objects;\n+\n+import javax.annotation.Nullable;\n+import java.util.function.Consumer;\n+import java.util.function.Function;\n+\n+public class CheckConstraint<T> extends TableElement<T> {\n+\n+    @Nullable\n+    private final String name;\n+    @Nullable\n+    private final String columnName;\n+    private final T expression;\n+    private final String expressionStr;\n+\n+    public CheckConstraint(@Nullable String name, @Nullable String columnName, T expression, String expressionStr) {\n+        this.name = name;\n+        this.columnName = columnName;\n+        this.expression = expression;\n+        this.expressionStr = expressionStr;\n+    }\n+\n+    @Nullable\n+    public String name() {\n+        return name;\n+    }\n+\n+    @Nullable\n+    public String columnName() {\n+        return columnName;\n+    }\n+\n+    public T expression() {\n+        return expression;\n+    }\n+\n+    public String expressionStr() {\n+        return expressionStr;\n+    }\n+\n+    @Override\n+    public int hashCode() {\n+        return Objects.hashCode(name, columnName, expression);\n+    }\n+\n+    @Override\n+    public boolean equals(Object o) {\n+        if (this == o) {\n+            return true;\n+        }\n+        if (o == null || false == o instanceof CheckConstraint) {\n+            return false;\n+        }\n+        CheckConstraint that = (CheckConstraint) o;\n+        return Objects.equal(expression, that.expression) &&\n+               Objects.equal(name, that.name) &&\n+               Objects.equal(columnName, that.columnName);\n+    }\n+\n+    @Override\n+    public <R, C> R accept(AstVisitor<R, C> visitor, C context) {\n+        return visitor.visitCheckConstraint(this, context);\n+    }\n+\n+    @Override\n+    public <U> TableElement<U> map(Function<? super T, ? extends U> mapper) {\n+        return new CheckConstraint<>(name, columnName, mapper.apply(expression), expressionStr);\n+    }\n+\n+    @Override\n+    public void visit(Consumer<? super T> consumer) {\n+        consumer.accept(expression);\n+    }\n+\n+    @Override\n+    public String toString() {\n+        return MoreObjects.toStringHelper(this)", "originalCommit": "71f91a67f0c2ee89f299ddc46d9868b90f11e2f7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY0MjU3NA==", "url": "https://github.com/crate/crate/pull/9831#discussion_r404642574", "bodyText": "and here ;) string concatenation would we preferable.", "author": "seut", "createdAt": "2020-04-07T08:48:35Z", "path": "sql-parser/src/main/java/io/crate/sql/tree/DropCheckConstraint.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Licensed to CRATE Technology GmbH (\"Crate\") under one or more contributor\n+ * license agreements.  See the NOTICE file distributed with this work for\n+ * additional information regarding copyright ownership.  Crate licenses\n+ * this file to you under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.  You may\n+ * obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ *\n+ * However, if you have executed another commercial license agreement\n+ * with Crate these terms will supersede the license and you may use the\n+ * software solely pursuant to the terms of the relevant commercial agreement.\n+ */\n+\n+package io.crate.sql.tree;\n+\n+import com.google.common.base.MoreObjects;\n+import com.google.common.base.Objects;\n+\n+public class DropCheckConstraint<T> extends Statement {\n+\n+    private final Table<T> table;\n+    private final String name;\n+\n+    public DropCheckConstraint(Table<T> table, String name) {\n+        this.table = table;\n+        this.name = name;\n+    }\n+\n+    public String name() {\n+        return name;\n+    }\n+\n+    public Table<T> table() {\n+        return table;\n+    }\n+\n+    @Override\n+    public <R, C> R accept(AstVisitor<R, C> visitor, C context) {\n+        return visitor.visitDropCheckConstraint(this, context);\n+    }\n+\n+    @Override\n+    public int hashCode() {\n+        return Objects.hashCode(table, name);\n+    }\n+\n+    @Override\n+    public boolean equals(Object obj) {\n+        if (this == obj) {\n+            return true;\n+        }\n+        if (false == obj instanceof DropCheckConstraint) {\n+            return false;\n+        }\n+        DropCheckConstraint<T> that = (DropCheckConstraint<T>) obj;\n+        return name.equals(that.name) && table.equals(that.table);\n+\n+    }\n+\n+    @Override\n+    public String toString() {\n+        return MoreObjects.toStringHelper(this)", "originalCommit": "71f91a67f0c2ee89f299ddc46d9868b90f11e2f7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY0ODczOA==", "url": "https://github.com/crate/crate/pull/9831#discussion_r404648738", "bodyText": "when using a normal for loop above, this additional loop could be avoided.", "author": "seut", "createdAt": "2020-04-07T08:58:00Z", "path": "sql/src/main/java/io/crate/analyze/CreateTableStatementAnalyzer.java", "diffHunk": "@@ -85,6 +91,15 @@ public AnalyzedCreateTable analyze(CreateTable<Expression> createTable,\n                 return symbol;\n             }));\n         }\n+        List<TableElement<Symbol>> analyzedCheckConstraints = createTable.tableElements()\n+            .stream()\n+            .filter(x -> x instanceof CheckConstraint)\n+            .map(x -> (CheckConstraint<Expression>) x)\n+            .map(x -> x.map(y -> exprAnalyzerWithReferences.convert(y, exprCtx)))\n+            .collect(Collectors.toList());\n+        tableElementsWithExpressions.addAll(analyzedCheckConstraints);\n+        analyzedCreateTable.tableElements().addAll(analyzedCheckConstraints);\n+        analyzedCheckConstraints.forEach(c -> analyzedTableElements.addCheckConstraint(relationName, (CheckConstraint<Symbol>) c));", "originalCommit": "71f91a67f0c2ee89f299ddc46d9868b90f11e2f7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY1MTM4OA==", "url": "https://github.com/crate/crate/pull/9831#discussion_r404651388", "bodyText": "why is this needed? if needed, could this maybe solved without mutating?", "author": "seut", "createdAt": "2020-04-07T09:01:57Z", "path": "sql/src/main/java/io/crate/analyze/CreateTableStatementAnalyzer.java", "diffHunk": "@@ -94,4 +109,39 @@ public AnalyzedCreateTable analyze(CreateTable<Expression> createTable,\n             analyzedTableElementsWithExpressions\n         );\n     }\n+\n+    private static List<TableElement<Symbol>> analyzeButCheckConstraints(CreateTable<Expression> createTable,\n+                                                                         ExpressionAnalyzer exprAnalyzerWithFieldsAsString,\n+                                                                         ExpressionAnalysisContext exprCtx) {\n+        List<TableElement<Expression>> notCheckConstraints = createTable.tableElements()\n+            .stream()\n+            .filter(x -> false == x instanceof CheckConstraint)\n+            .collect(Collectors.toList());\n+        List<TableElement<Symbol>> analyzed = new ArrayList<>(notCheckConstraints.size());\n+        Set<CheckColumnConstraint<Expression>> checkColumnConstraints = new HashSet<>(notCheckConstraints.size());\n+        for (int i = 0; i < notCheckConstraints.size(); i++) {\n+            TableElement<Expression> te = notCheckConstraints.get(i);\n+            if (te instanceof ColumnDefinition) {\n+                ColumnDefinition<Expression> def = (ColumnDefinition<Expression>) te;\n+                List<ColumnConstraint<Expression>> constraints = def.constraints();\n+                for (int j = 0; j < constraints.size(); j++) {\n+                    ColumnConstraint<Expression> cc = constraints.get(j);\n+                    if (cc instanceof CheckColumnConstraint) {\n+                        CheckColumnConstraint<Expression> check = (CheckColumnConstraint<Expression>) cc;\n+                        checkColumnConstraints.add(check);\n+                        // Re-frame the column constraint as a table constraint\n+                        createTable.tableElements().add(new CheckConstraint<>(\n+                            check.name(),\n+                            def.ident(),\n+                            check.expression(),\n+                            check.expressionStr()\n+                        ));\n+                    }\n+                }\n+                def.constraints().removeAll(checkColumnConstraints);", "originalCommit": "71f91a67f0c2ee89f299ddc46d9868b90f11e2f7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg1MDAzOQ==", "url": "https://github.com/crate/crate/pull/9831#discussion_r404850039", "bodyText": "In this case, what we are doing is treating a check constraint definition at the column level as if it were defined at the table level. During the first pass of the analysis we cannot process check constraints because we do not have references to the columns yet (they are being created).", "author": "marregui", "createdAt": "2020-04-07T14:24:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY1MTM4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAxNzY1Nw==", "url": "https://github.com/crate/crate/pull/9831#discussion_r405017657", "bodyText": "will have a better look at this", "author": "marregui", "createdAt": "2020-04-07T18:19:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY1MTM4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY1MjA4MQ==", "url": "https://github.com/crate/crate/pull/9831#discussion_r404652081", "bodyText": "minor (maybe personal preference): could be also done with simple for(var checkContraint : checkConstraints)", "author": "seut", "createdAt": "2020-04-07T09:03:15Z", "path": "sql/src/main/java/io/crate/analyze/DropCheckConstraintAnalyzer.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Licensed to CRATE Technology GmbH (\"Crate\") under one or more contributor\n+ * license agreements.  See the NOTICE file distributed with this work for\n+ * additional information regarding copyright ownership.  Crate licenses\n+ * this file to you under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.  You may\n+ * obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ *\n+ * However, if you have executed another commercial license agreement\n+ * with Crate these terms will supersede the license and you may use the\n+ * software solely pursuant to the terms of the relevant commercial agreement.\n+ */\n+\n+package io.crate.analyze;\n+\n+import io.crate.common.collections.Lists2;\n+import io.crate.expression.symbol.Symbol;\n+import io.crate.metadata.CoordinatorTxnCtx;\n+import io.crate.metadata.Schemas;\n+import io.crate.metadata.doc.DocTableInfo;\n+import io.crate.metadata.table.Operation;\n+import io.crate.sql.tree.CheckConstraint;\n+import io.crate.sql.tree.Table;\n+\n+import java.util.List;\n+import java.util.Locale;\n+\n+class DropCheckConstraintAnalyzer {\n+\n+    private final Schemas schemas;\n+\n+    DropCheckConstraintAnalyzer(Schemas schemas) {\n+        this.schemas = schemas;\n+    }\n+\n+    public AnalyzedAlterTableDropCheckConstraint analyze(Table<?> table, String name, CoordinatorTxnCtx txnCtx) {\n+        DocTableInfo tableInfo = (DocTableInfo) schemas.resolveTableInfo(\n+            table.getName(),\n+            Operation.ALTER,\n+            txnCtx.sessionContext().user(),\n+            txnCtx.sessionContext().searchPath());\n+        List<CheckConstraint<Symbol>> checkConstraints = tableInfo.checkConstraints();\n+        for (int i = 0; i < checkConstraints.size(); i++) {", "originalCommit": "71f91a67f0c2ee89f299ddc46d9868b90f11e2f7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY1MzkyNw==", "url": "https://github.com/crate/crate/pull/9831#discussion_r404653927", "bodyText": "maybe worth adding an assertion to ensure its a boolean? Is this ensured somewhere else? otherwise it should throw an exception here.", "author": "seut", "createdAt": "2020-04-07T09:06:14Z", "path": "sql/src/main/java/io/crate/execution/dml/upsert/CheckConstraints.java", "diffHunk": "@@ -71,5 +78,22 @@ public void validate(T values) {\n                 throw new IllegalArgumentException(\"\\\"\" + notNullColumns.get(i) + \"\\\" must not be null\");\n             }\n         }\n+        for (int i = 0; i < checkConstraints.size(); i++) {\n+            Tuple<? extends Input<?>, CheckConstraint<Symbol>> checkEntry = checkConstraints.get(i);\n+            Input<?> checkInput = checkEntry.v1();\n+            Boolean value = (Boolean) checkInput.value();", "originalCommit": "71f91a67f0c2ee89f299ddc46d9868b90f11e2f7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg2MzYwMA==", "url": "https://github.com/crate/crate/pull/9831#discussion_r404863600", "bodyText": "the grammar makes it be the result of a boolean expression, so it will always be boolean", "author": "marregui", "createdAt": "2020-04-07T14:41:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY1MzkyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjEyMTU4Mw==", "url": "https://github.com/crate/crate/pull/9831#discussion_r406121583", "bodyText": "I think it's worth adding an assertion or inline comment that clarifies that", "author": "mfussenegger", "createdAt": "2020-04-09T10:52:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY1MzkyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE4ODE4OQ==", "url": "https://github.com/crate/crate/pull/9831#discussion_r411188189", "bodyText": "Yes lets please add at least a comment, I'd even add an assertion.", "author": "seut", "createdAt": "2020-04-20T08:24:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY1MzkyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI2MjIzNg==", "url": "https://github.com/crate/crate/pull/9831#discussion_r411262236", "bodyText": "Assertion added.", "author": "marregui", "createdAt": "2020-04-20T10:18:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY1MzkyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY1ODIzMw==", "url": "https://github.com/crate/crate/pull/9831#discussion_r404658233", "bodyText": "isn't this a duplicate of https://github.com/crate/crate/pull/9831/files#diff-288536de2bb838c7a805c32bcc63f8ddR397", "author": "seut", "createdAt": "2020-04-07T09:13:15Z", "path": "sql/src/test/java/io/crate/analyze/CreateAlterTableStatementAnalyzerTest.java", "diffHunk": "@@ -1204,6 +1221,43 @@ private void assertDuplicatePrimaryKey(String stmt) {\n         }\n     }\n \n+    @Test\n+    public void testCreateTableWithCheckConstraints() {\n+        String stmt = \"create table t (\" +\n+                      \"    id int primary key, \" +\n+                      \"    qty int constraint check_qty_gt_zero check(qty > 0), \" +\n+                      \"    constraint check_id_ge_zero check (id >= 0)\" +\n+                      \")\";\n+        BoundCreateTable analysis = analyze(stmt);\n+        Map<String, Object> mapping = analysis.mapping();\n+        Map<String, String> checkConstraints = analysis.analyzedTableElements().getCheckConstraints();\n+        assertEquals(checkConstraints.get(\"check_id_ge_zero\"),\n+                     Maps.getByPath(mapping, Arrays.asList(\"_meta\", \"check_constraints\", \"check_id_ge_zero\")));\n+        assertEquals(checkConstraints.get(\"check_qty_gt_zero\"),\n+                     Maps.getByPath(mapping, Arrays.asList(\"_meta\", \"check_constraints\", \"check_qty_gt_zero\")));\n+    }\n+\n+    @Test\n+    public void testAlterTableAddColumnWithCheckConstraint() throws Exception {", "originalCommit": "71f91a67f0c2ee89f299ddc46d9868b90f11e2f7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY2MDI3OA==", "url": "https://github.com/crate/crate/pull/9831#discussion_r404660278", "bodyText": "sqlExecutor, docTableInfo and  tnxCtx can be all a local variables.", "author": "seut", "createdAt": "2020-04-07T09:16:26Z", "path": "sql/src/test/java/io/crate/execution/dml/upsert/CheckConstraintsTest.java", "diffHunk": "@@ -0,0 +1,125 @@\n+/*\n+ * Licensed to Crate under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.  Crate licenses this file\n+ * to you under the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.  You may\n+ * obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or\n+ * implied.  See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ *\n+ * However, if you have executed another commercial license agreement\n+ * with Crate these terms will supersede the license and you may use the\n+ * software solely pursuant to the terms of the relevant commercial\n+ * agreement.\n+ */\n+\n+package io.crate.execution.dml.upsert;\n+\n+import io.crate.expression.InputFactory;\n+import io.crate.metadata.CoordinatorTxnCtx;\n+import io.crate.metadata.TransactionContext;\n+import io.crate.metadata.doc.DocTableInfo;\n+import io.crate.test.integration.CrateDummyClusterServiceUnitTest;\n+import io.crate.testing.SQLExecutor;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.util.LinkedHashMap;\n+import java.util.Locale;\n+import java.util.Map;\n+\n+/**\n+ * Testing {@linkplain io.crate.execution.dml.upsert.CheckConstraints},\n+ * as well as various cases related to:\n+ *\n+ * <pre>\n+ *     CONSTRAINT &lt;name&gt; CHECK &lt;boolean expression&gt;\n+ * </pre>\n+ */\n+public class CheckConstraintsTest extends CrateDummyClusterServiceUnitTest {\n+\n+    private SQLExecutor sqlExecutor;\n+    private DocTableInfo docTableInfo;\n+    private CheckConstraints checkConstraints;\n+    private TransactionContext txnCtx;\n+\n+    @Before\n+    public void setUpExecutor() throws Exception {\n+        sqlExecutor = SQLExecutor.builder(clusterService)\n+            .addTable(\"CREATE TABLE t (\" +\n+                      \"    id int,\" +\n+                      \"    qty int,\" +\n+                      \"    sentinel boolean CONSTRAINT sentinel CHECK(sentinel),\" +\n+                      \"    CONSTRAINT id_is_even CHECK(id % 2 = 0))\")\n+            .build();\n+        docTableInfo = sqlExecutor.resolveTableInfo(\"t\");\n+        txnCtx = CoordinatorTxnCtx.systemTransactionContext();", "originalCommit": "71f91a67f0c2ee89f299ddc46d9868b90f11e2f7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a7a3a2ca80cca799d916730764ec1ae09e1b4ea7", "url": "https://github.com/crate/crate/commit/a7a3a2ca80cca799d916730764ec1ae09e1b4ea7", "message": "Change style of loop", "committedDate": "2020-04-08T08:30:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA1MDQ1Nw==", "url": "https://github.com/crate/crate/pull/9831#discussion_r406050457", "bodyText": "I don't think that this complexity is really worth it for simple toString methods. Also, most IDE's have nice toString method generators.", "author": "seut", "createdAt": "2020-04-09T08:44:50Z", "path": "common/src/main/java/io/crate/common/StringUtils.java", "diffHunk": "@@ -24,11 +24,31 @@\n \n import java.util.ArrayList;\n import java.util.List;\n+import java.util.Objects;\n \n import javax.annotation.Nullable;\n \n public final class StringUtils {\n \n+    public static String toString(Class<?> clazz, Object...attributes) {\n+        if (attributes.length % 2 != 0) {\n+            throw new IllegalArgumentException(\"expected event number of entries\");\n+        }\n+        StringBuilder sb = new StringBuilder(32);\n+        sb.append(clazz.getClass().getName()).append('{');\n+        if (attributes.length > 0) {\n+            for (int i = 0; i <= attributes.length / 2; i += 2) {\n+                sb.append(Objects.requireNonNull(attributes[i]))\n+                    .append(\"=\")\n+                    .append(attributes[i + 1])\n+                    .append(\", \");\n+            }\n+            sb.setLength(sb.length() - 2);\n+        }\n+        sb.append(\"}\");", "originalCommit": "c0cc534d5078166a8195e08c0da6c7709f6f1201", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA1MTY0OA==", "url": "https://github.com/crate/crate/pull/9831#discussion_r406051648", "bodyText": "is it expected behaviour that this is now possible?", "author": "seut", "createdAt": "2020-04-09T08:46:54Z", "path": "sql/src/test/java/io/crate/analyze/CreateAlterTableStatementAnalyzerTest.java", "diffHunk": "@@ -1086,8 +1087,6 @@ public void testCreateTableGeneratedColumnWithMatch() {\n \n     @Test\n     public void testCreateTableGeneratedColumnBasedOnGeneratedColumn() {\n-        expectedException.expect(IllegalArgumentException.class);\n-        expectedException.expectMessage(\"A generated column cannot be based on a generated column\");", "originalCommit": "09a25b17d6e8706474db95749e82f23785ea47e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjEyMDc3NQ==", "url": "https://github.com/crate/crate/pull/9831#discussion_r406120775", "bodyText": "I'd be in favour of reverting this behavior change and do it in a separate PR - together with change log entry + dedicated tests (also for the execution layer)", "author": "mfussenegger", "createdAt": "2020-04-09T10:50:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA1MTY0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY1MTc0OQ==", "url": "https://github.com/crate/crate/pull/9831#discussion_r406651749", "bodyText": "nope, that was corrected, restoring original behaviour, apologies for the confusion", "author": "marregui", "createdAt": "2020-04-10T08:04:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA1MTY0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY1NDQ0MQ==", "url": "https://github.com/crate/crate/pull/9831#discussion_r406654441", "bodyText": "Hi @mfussenegger,  just so that I have it correct:\n create table foo (\n   ts timestamp with time zone,\n   day as date_trunc('day', ts),\n   date_string as cast(day as string))\n\nyou are saying that column date_string cannot be defined because is defined from day?\nwith my solution you may. Should I revert that?\nThank you", "author": "marregui", "createdAt": "2020-04-10T08:12:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA1MTY0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY5NzM0MA==", "url": "https://github.com/crate/crate/pull/9831#discussion_r408697340", "bodyText": "I will revert this.", "author": "marregui", "createdAt": "2020-04-15T09:14:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA1MTY0OA=="}], "type": "inlineReview"}, {"oid": "c510c1d9ded76c7014efa37c678182dbcfb1ac22", "url": "https://github.com/crate/crate/commit/c510c1d9ded76c7014efa37c678182dbcfb1ac22", "message": "Make toString something simple for the classes in this PR", "committedDate": "2020-04-10T08:01:51Z", "type": "forcePushed"}, {"oid": "cdff9466a1ae82c24a27efade35a6b159cbe7fb2", "url": "https://github.com/crate/crate/commit/cdff9466a1ae82c24a27efade35a6b159cbe7fb2", "message": "A generated column cannot be based on a generated column", "committedDate": "2020-04-15T10:34:29Z", "type": "forcePushed"}, {"oid": "75c0b3ed94ab34b7de9e8a7d36c748f7250ed149", "url": "https://github.com/crate/crate/commit/75c0b3ed94ab34b7de9e8a7d36c748f7250ed149", "message": "Assert that the boolean expression value's is a boolean", "committedDate": "2020-04-20T10:04:38Z", "type": "forcePushed"}, {"oid": "0099bde632c45cd8023f970dae3508a3bbb8f65a", "url": "https://github.com/crate/crate/commit/0099bde632c45cd8023f970dae3508a3bbb8f65a", "message": "Add CHECK constraint syntax to create table statement\n\nA check constraint allows you to specify that the values in a\ncertain column must satisfy a boolean expression. This can be\nused to ensure data integrity.\n\nSyntax:\n\n  [CONSTRAINT check_name] CHECK (boolean_expression)\n\nE.g.:\n\n    create table metrics (\n       id TEXT PRIMARY KEY,\n       weight double CHECK (weight >= 0)\n    )", "committedDate": "2020-04-20T20:53:30Z", "type": "commit"}, {"oid": "0099bde632c45cd8023f970dae3508a3bbb8f65a", "url": "https://github.com/crate/crate/commit/0099bde632c45cd8023f970dae3508a3bbb8f65a", "message": "Add CHECK constraint syntax to create table statement\n\nA check constraint allows you to specify that the values in a\ncertain column must satisfy a boolean expression. This can be\nused to ensure data integrity.\n\nSyntax:\n\n  [CONSTRAINT check_name] CHECK (boolean_expression)\n\nE.g.:\n\n    create table metrics (\n       id TEXT PRIMARY KEY,\n       weight double CHECK (weight >= 0)\n    )", "committedDate": "2020-04-20T20:53:30Z", "type": "forcePushed"}]}