{"pr_number": 2912, "pr_title": "NMS-12578: Confd templates for Minion configuration", "pr_createdAt": "2020-03-05T17:07:04Z", "pr_url": "https://github.com/OpenNMS/opennms/pull/2912", "timeline": [{"oid": "4ccccd41c3e8ef3d725db74b605c577447fe2c02", "url": "https://github.com/OpenNMS/opennms/commit/4ccccd41c3e8ef3d725db74b605c577447fe2c02", "message": "NMS-12578: Confd templates for Minion configuration", "committedDate": "2020-03-05T16:57:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ0OTA2NA==", "url": "https://github.com/OpenNMS/opennms/pull/2912#discussion_r388449064", "bodyText": "Can we update the default/existing system.properties files to include a statement like ${optionals} = confd.system.properties  and append the properties there rather than templating this file?\nThat would save us from having to maintain this template for Karaf upgrades going forward.", "author": "j-white", "createdAt": "2020-03-05T17:31:21Z", "path": "opennms-container/minion/confd/templates/system.properties.tmpl", "diffHunk": "@@ -0,0 +1,161 @@\n+################################################################################", "originalCommit": "4ccccd41c3e8ef3d725db74b605c577447fe2c02", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ2MjA3NQ==", "url": "https://github.com/OpenNMS/opennms/pull/2912#discussion_r388462075", "bodyText": "Yes, that should work. Do we have to worry about duplicates in that case? Or would we treat the values that are currently in the file as non-configurable by confd.", "author": "mattixtech", "createdAt": "2020-03-05T17:55:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ0OTA2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ2NzA0MQ==", "url": "https://github.com/OpenNMS/opennms/pull/2912#discussion_r388467041", "bodyText": "Karaf documents this as \"Included files will override the values specified in this file\", so shouldn't have to worry about dupes.", "author": "j-white", "createdAt": "2020-03-05T18:03:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ0OTA2NA=="}], "type": "inlineReview"}, {"oid": "eccf9eef9d116218e2b02f34e21cf3b0e0a636a2", "url": "https://github.com/OpenNMS/opennms/commit/eccf9eef9d116218e2b02f34e21cf3b0e0a636a2", "message": "Review feedback", "committedDate": "2020-03-05T22:39:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk3NzAyMg==", "url": "https://github.com/OpenNMS/opennms/pull/2912#discussion_r388977022", "bodyText": "\ud83d\udc4d", "author": "indigo423", "createdAt": "2020-03-06T15:42:14Z", "path": "opennms-container/minion/Dockerfile", "diffHunk": "@@ -68,6 +68,15 @@ RUN if [[ \"$(ls -1 /tmp/rpms/*.rpm 2>/dev/null | wc -l)\" != 0 ]]; then dnf -y in\n \n COPY ./assets/* /\n \n+# Install confd\n+ARG CONFD_VERSION=\"0.16.0\"\n+ARG CONFD_ARCH=\"amd64\"", "originalCommit": "eccf9eef9d116218e2b02f34e21cf3b0e0a636a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk4MzM2MA==", "url": "https://github.com/OpenNMS/opennms/pull/2912#discussion_r388983360", "bodyText": "Just to be sure, we nail it down to use only the minion-config.yaml file and don't allow other configuration backends right? Just as a quick idea, we could gain some flexibility using a confd.toml and call the binary with -config-file. By default it picks up a confd.toml from /etc/confd/confd.toml.\nconfdir = \"/etc/confd\"\nbackend = \"file\"\nfile = \"/opt/minion/minion-config.yaml\"\n\nI don't worry much - no blocker for and really just a minor comment.", "author": "indigo423", "createdAt": "2020-03-06T15:53:10Z", "path": "opennms-container/minion/assets/entrypoint.sh", "diffHunk": "@@ -149,12 +152,42 @@ applyOverlayConfig() {\n   fi\n }\n \n+applyConfd() {\n+  if [ -f \"${CONFD_KEY_STORE}\" ]; then\n+    echo \"Found a configuration key store, applying configuration via confd.\"\n+    runConfd\n+  else\n+    echo \"No configuration key store present, skipping confd configuration.\"\n+  fi\n+}\n+\n start() {\n     export KARAF_EXEC=\"exec\"\n     cd ${MINION_HOME}/bin\n     exec ./karaf server\n }\n \n+runConfd() {\n+  # Create any directories that confd might write to\n+  while IFS= read -r dir; do\n+    local dirToCreate=\"$MINION_HOME\"/\"$dir\"\n+    echo \"Creating $dirToCreate so confd can write to it\"\n+    mkdir -p \"$dirToCreate\"\n+  done < \"$CONFD_CONFIG_DIR\"/directories\n+\n+  \"$CONFD_BIN\" -log-level debug -onetime -backend=file -file \"$CONFD_KEY_STORE\" -confdir \"$CONFD_CONFIG_DIR\"", "originalCommit": "eccf9eef9d116218e2b02f34e21cf3b0e0a636a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTExMjc1Nw==", "url": "https://github.com/OpenNMS/opennms/pull/2912#discussion_r389112757", "bodyText": "I didn't mean to lock it down to a file. Agreed using a confd.toml will allow us to be more flexible since this file could be optionally mounted to changed the config. Will use it.", "author": "mattixtech", "createdAt": "2020-03-06T19:53:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk4MzM2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA0MTQ2Ng==", "url": "https://github.com/OpenNMS/opennms/pull/2912#discussion_r389041466", "bodyText": "Given this is in the default system.properties file and not just in the container, maybe we should actually rename it.\nKaraf has this stanza in their default configuration, maybe we just reuse it? https://github.com/apache/karaf/blob/master/assemblies/features/base/src/main/resources/resources/etc/system.properties#L25\nNote that it's also at the top of the time, and not the bottom, not sure if that makes a difference.", "author": "j-white", "createdAt": "2020-03-06T17:31:07Z", "path": "features/container/minion/src/main/filtered-resources/etc/system.properties", "diffHunk": "@@ -148,3 +148,5 @@ karaf.secured.services = (&(osgi.command.scope=*)(osgi.command.function=*))\n \n # OPENNMS: Enable SNMP4J Log4j logging\n snmp4j.LogFactory=org.snmp4j.log.Log4jLogFactory\n+\n+${optionals} = confd.system.properties", "originalCommit": "eccf9eef9d116218e2b02f34e21cf3b0e0a636a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTExMDM4NA==", "url": "https://github.com/OpenNMS/opennms/pull/2912#discussion_r389110384", "bodyText": "Will follow the pattern from the default config.", "author": "mattixtech", "createdAt": "2020-03-06T19:48:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA0MTQ2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA0MTcyNg==", "url": "https://github.com/OpenNMS/opennms/pull/2912#discussion_r389041726", "bodyText": "Should be be strongly modeling all of the system properties, or try and keep this generic from a template perspective?", "author": "j-white", "createdAt": "2020-03-06T17:31:38Z", "path": "opennms-container/minion/confd/templates/confd.system.properties.tmpl", "diffHunk": "@@ -0,0 +1,10 @@\n+{{$snmp2In1Key := \"/snmp/snmp4j/org.opennms.snmp.snmp4j.allowSNMPv2InV1\" -}}", "originalCommit": "eccf9eef9d116218e2b02f34e21cf3b0e0a636a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTExMDE1MQ==", "url": "https://github.com/OpenNMS/opennms/pull/2912#discussion_r389110151", "bodyText": "Generic will let us be a lot more flexible, will update.", "author": "mattixtech", "createdAt": "2020-03-06T19:47:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA0MTcyNg=="}], "type": "inlineReview"}, {"oid": "d0872476f759ed2da5c65432f09e7a131706c0fe", "url": "https://github.com/OpenNMS/opennms/commit/d0872476f759ed2da5c65432f09e7a131706c0fe", "message": "More review feedback", "committedDate": "2020-03-06T20:08:33Z", "type": "commit"}, {"oid": "5b7d2ac016fe95b48c9efdf58a6e352941ed0f71", "url": "https://github.com/OpenNMS/opennms/commit/5b7d2ac016fe95b48c9efdf58a6e352941ed0f71", "message": "In the case of no single port telemetry config, don't provide a default configuration (will rely on overlay to configure that for now)", "committedDate": "2020-03-09T16:08:12Z", "type": "commit"}, {"oid": "18aace38d733c283cd7f54514806d85a51c2c437", "url": "https://github.com/OpenNMS/opennms/commit/18aace38d733c283cd7f54514806d85a51c2c437", "message": "Update smoke tests to use minion-config.yaml", "committedDate": "2020-03-10T18:59:20Z", "type": "commit"}, {"oid": "44171535c0de168100d087d6be8aa847b29062d5", "url": "https://github.com/OpenNMS/opennms/commit/44171535c0de168100d087d6be8aa847b29062d5", "message": "Tweak smoke tests", "committedDate": "2020-03-10T20:48:45Z", "type": "commit"}, {"oid": "100c10a8963489543aafb03f7fa59adea972f24e", "url": "https://github.com/OpenNMS/opennms/commit/100c10a8963489543aafb03f7fa59adea972f24e", "message": "Fix typo", "committedDate": "2020-03-10T20:54:44Z", "type": "commit"}, {"oid": "0075c44624a188272ac6333edb8987e5cc348194", "url": "https://github.com/OpenNMS/opennms/commit/0075c44624a188272ac6333edb8987e5cc348194", "message": "Include id, location, and broker settings in yaml config", "committedDate": "2020-03-11T01:24:21Z", "type": "commit"}, {"oid": "7f55688a089a26dea1f1a444725d11dffc0fc78f", "url": "https://github.com/OpenNMS/opennms/commit/7f55688a089a26dea1f1a444725d11dffc0fc78f", "message": "TODO: Need to figure out what we want to be configurable via yaml for flows", "committedDate": "2020-03-11T01:35:54Z", "type": "commit"}, {"oid": "56e46985491ba678133c105bbbba1ce8792589c5", "url": "https://github.com/OpenNMS/opennms/commit/56e46985491ba678133c105bbbba1ce8792589c5", "message": "Typo!!! :(", "committedDate": "2020-03-11T14:08:22Z", "type": "commit"}, {"oid": "fc15ad35be184d18fdac1926128e299b717837a2", "url": "https://github.com/OpenNMS/opennms/commit/fc15ad35be184d18fdac1926128e299b717837a2", "message": "Expand confd configuration of flows", "committedDate": "2020-03-11T20:21:30Z", "type": "commit"}, {"oid": "67ccfdc061fc712cb971fcc19c13b345cd0b9f51", "url": "https://github.com/OpenNMS/opennms/commit/67ccfdc061fc712cb971fcc19c13b345cd0b9f51", "message": "Add an assert to the test, oops!\n[skip-ci]", "committedDate": "2020-03-12T16:14:36Z", "type": "commit"}]}