{"pr_number": 2995, "pr_title": "NMS-12687: Additional Confd templates for Minion configuration", "pr_createdAt": "2020-05-04T16:35:34Z", "pr_url": "https://github.com/OpenNMS/opennms/pull/2995", "timeline": [{"oid": "21cfd45fab272aba5fa58f19e0a75eca21de866a", "url": "https://github.com/OpenNMS/opennms/commit/21cfd45fab272aba5fa58f19e0a75eca21de866a", "message": "Add confd templates for Minion: Karaf configuration", "committedDate": "2020-04-28T15:56:10Z", "type": "commit"}, {"oid": "900b1a3b3b2e9b3e33289bcf666982e5c38f6281", "url": "https://github.com/OpenNMS/opennms/commit/900b1a3b3b2e9b3e33289bcf666982e5c38f6281", "message": "Fix smoke tests", "committedDate": "2020-05-01T19:47:43Z", "type": "commit"}, {"oid": "dc3a75b0eb0c2f3e84259c9af40a07722403b157", "url": "https://github.com/OpenNMS/opennms/commit/dc3a75b0eb0c2f3e84259c9af40a07722403b157", "message": "Add CONFD template for Jetty port for minion (used by jolokia)", "committedDate": "2020-05-05T05:11:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDEyMzk1OQ==", "url": "https://github.com/OpenNMS/opennms/pull/2995#discussion_r420123959", "bodyText": "Should rename this to jetty - it's also used by Hawtio and other webapps.", "author": "j-white", "createdAt": "2020-05-05T13:49:55Z", "path": "opennms-container/minion/CONFD_README.md", "diffHunk": "@@ -161,3 +161,33 @@ system:\n ```\n Config specified will be written to `etc/confd.system.properties` which gets automatically appended to `etc/system.properties`. Additionally, provided the\n `jaeger-agent-host` key is specified, `etc/featuresBoot.d/jaeger.boot` will also be updated.\n+\n+### Karaf Properties\n+```\n+---\n+karaf:\n+    shell:\n+        ssh:\n+            host: \"0.0.0.0\"\n+            port: 8201\n+    management:\n+        rmi:\n+            registry:\n+                host: \"127.0.0.1\"\n+                port: 1299\n+            server:\n+                host: \"127.0.0.1\"\n+                port: 45444\n+```\n+Config specified will be written to:\n+- `etc/org.apache.karaf.shell.cfg` for content under `shell`.\n+- `etc/org.apache.karaf.management.cfg` for content under `management`.\n+\n+### Jolokia Properties\n+```\n+---\n+jolokia:", "originalCommit": "dc3a75b0eb0c2f3e84259c9af40a07722403b157", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDIxNTQzOA==", "url": "https://github.com/OpenNMS/opennms/pull/2995#discussion_r420215438", "bodyText": "Sounds good; re-named.", "author": "bouff", "createdAt": "2020-05-05T15:50:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDEyMzk1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDEyNDYxMQ==", "url": "https://github.com/OpenNMS/opennms/pull/2995#discussion_r420124611", "bodyText": "Can we add the host as well? We should be able to bind this to the loopback.\norg.ops4j.pax.web.listening.addresses may work - see https://ops4j1.jira.com/wiki/spaces/paxweb/pages/12059275/Basic+Configuration", "author": "j-white", "createdAt": "2020-05-05T13:50:46Z", "path": "opennms-container/minion/CONFD_README.md", "diffHunk": "@@ -161,3 +161,33 @@ system:\n ```\n Config specified will be written to `etc/confd.system.properties` which gets automatically appended to `etc/system.properties`. Additionally, provided the\n `jaeger-agent-host` key is specified, `etc/featuresBoot.d/jaeger.boot` will also be updated.\n+\n+### Karaf Properties\n+```\n+---\n+karaf:\n+    shell:\n+        ssh:\n+            host: \"0.0.0.0\"\n+            port: 8201\n+    management:\n+        rmi:\n+            registry:\n+                host: \"127.0.0.1\"\n+                port: 1299\n+            server:\n+                host: \"127.0.0.1\"\n+                port: 45444\n+```\n+Config specified will be written to:\n+- `etc/org.apache.karaf.shell.cfg` for content under `shell`.\n+- `etc/org.apache.karaf.management.cfg` for content under `management`.\n+\n+### Jolokia Properties\n+```\n+---\n+jolokia:\n+    web:\n+        port: 8181", "originalCommit": "dc3a75b0eb0c2f3e84259c9af40a07722403b157", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDIxNTU4Mg==", "url": "https://github.com/OpenNMS/opennms/pull/2995#discussion_r420215582", "bodyText": "Yup org.ops4j.pax.web.listening.addresses works.  Added.", "author": "bouff", "createdAt": "2020-05-05T15:50:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDEyNDYxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDEyNTUzOQ==", "url": "https://github.com/OpenNMS/opennms/pull/2995#discussion_r420125539", "bodyText": "I don't think we've done this yet - but maybe we should add a # Managed with confd - DO NOT EDIT style \"header\" to these files.", "author": "j-white", "createdAt": "2020-05-05T13:52:01Z", "path": "opennms-container/minion/container-fs/confd/templates/org.apache.karaf.management.cfg.tmpl", "diffHunk": "@@ -0,0 +1,104 @@\n+", "originalCommit": "dc3a75b0eb0c2f3e84259c9af40a07722403b157", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDIxNjM2OA==", "url": "https://github.com/OpenNMS/opennms/pull/2995#discussion_r420216368", "bodyText": "Added header to the new templates I introduced.", "author": "bouff", "createdAt": "2020-05-05T15:52:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDEyNTUzOQ=="}], "type": "inlineReview"}, {"oid": "8f3868aac45d6a7e42e92fe7d54dbb0c04207ed9", "url": "https://github.com/OpenNMS/opennms/commit/8f3868aac45d6a7e42e92fe7d54dbb0c04207ed9", "message": "Review Feedback", "committedDate": "2020-05-05T15:48:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQyMjM1Mw==", "url": "https://github.com/OpenNMS/opennms/pull/2995#discussion_r420422353", "bodyText": "This is fine, however we could make the restriction broader to avoid having to update the keys in the future.\nCould just use /karaf/management/rmi then you will get access to all the children as well.\nSame for the other toml's.", "author": "mattixtech", "createdAt": "2020-05-05T21:38:29Z", "path": "opennms-container/minion/container-fs/confd/conf.d/org.apache.karaf.management.cfg.toml", "diffHunk": "@@ -0,0 +1,9 @@\n+[template]\n+src = \"org.apache.karaf.management.cfg.tmpl\"\n+dest = \"/opt/minion/etc/org.apache.karaf.management.cfg\"\n+keys = [\n+    \"/karaf/management/rmi/registry/host\",", "originalCommit": "8f3868aac45d6a7e42e92fe7d54dbb0c04207ed9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ0NTY0OQ==", "url": "https://github.com/OpenNMS/opennms/pull/2995#discussion_r420445649", "bodyText": "Good to know, will do this.", "author": "bouff", "createdAt": "2020-05-05T22:32:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQyMjM1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQyNDAyNg==", "url": "https://github.com/OpenNMS/opennms/pull/2995#discussion_r420424026", "bodyText": "Not strictly necessary, but it may be a good idea to assign the common parts of the path to a variable and then concatenate to get the full path. Avoids churning in the future should we change key paths (not that its likely). See confd-telemetry-feature.xml.tmpl $flowsPath variable as example.\nSame for other templates here.", "author": "mattixtech", "createdAt": "2020-05-05T21:41:54Z", "path": "opennms-container/minion/container-fs/confd/templates/org.apache.karaf.management.cfg.tmpl", "diffHunk": "@@ -0,0 +1,107 @@\n+#\n+# DON'T EDIT THIS FILE :: GENERATED WITH CONFD\n+#\n+\n+#\n+# The properties in this file define the configuration of Apache Karaf's JMX Management\n+#\n+\n+#\n+# Port number for RMI registry connection\n+#\n+rmiRegistryPort = {{getv \"/karaf/management/rmi/registry/port\" \"1299\"}}", "originalCommit": "8f3868aac45d6a7e42e92fe7d54dbb0c04207ed9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ0NTU0Ng==", "url": "https://github.com/OpenNMS/opennms/pull/2995#discussion_r420445546", "bodyText": "Sure, will do", "author": "bouff", "createdAt": "2020-05-05T22:31:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQyNDAyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQyNTU0MA==", "url": "https://github.com/OpenNMS/opennms/pull/2995#discussion_r420425540", "bodyText": "Looks like this is the default. Could remove it, s'pose it doesn't hurt though.", "author": "mattixtech", "createdAt": "2020-05-05T21:45:10Z", "path": "smoke-test/src/main/resources/minion-config/minion-config.yaml", "diffHunk": "@@ -22,3 +22,9 @@ telemetry:\n netmgt:\n   traps:\n     trapd.listen.interface: \"0.0.0.0\"\n+\n+karaf:\n+  shell:\n+    ssh:\n+      host: \"0.0.0.0\"\n+      port: 8201", "originalCommit": "8f3868aac45d6a7e42e92fe7d54dbb0c04207ed9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQzODIyOQ==", "url": "https://github.com/OpenNMS/opennms/pull/2995#discussion_r420438229", "bodyText": "Will remove port - but host definitely has to stay.", "author": "bouff", "createdAt": "2020-05-05T22:13:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQyNTU0MA=="}], "type": "inlineReview"}, {"oid": "8cad950996553297f5bc74ce6e8adc80616efbe7", "url": "https://github.com/OpenNMS/opennms/commit/8cad950996553297f5bc74ce6e8adc80616efbe7", "message": "Review Feedback 2.", "committedDate": "2020-05-05T23:43:37Z", "type": "commit"}]}