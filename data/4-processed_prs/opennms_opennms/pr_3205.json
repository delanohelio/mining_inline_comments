{"pr_number": 3205, "pr_title": "NMS-12982: Add Slack confd templates", "pr_createdAt": "2020-11-03T13:02:22Z", "pr_url": "https://github.com/OpenNMS/opennms/pull/3205", "timeline": [{"oid": "e26c30debd75a36ad2c229e6ac453ac07a14b7e6", "url": "https://github.com/OpenNMS/opennms/commit/e26c30debd75a36ad2c229e6ac453ac07a14b7e6", "message": "Add Slack confd templates", "committedDate": "2020-11-03T12:59:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg5MzE4Ng==", "url": "https://github.com/OpenNMS/opennms/pull/3205#discussion_r519893186", "bodyText": "We can simplify this to just include the base path for slack\nkeys = [\n   \"opennms/notifd/slack\"\n]", "author": "mattixtech", "createdAt": "2020-11-09T15:21:03Z", "path": "opennms-container/horizon/container-fs/confd/conf.d/slack.properties.toml", "diffHunk": "@@ -0,0 +1,10 @@\n+[template]\n+src = \"slack.properties.tpl\"\n+dest = \"/opt/opennms/etc/opennms.properties.d/_confd.slack.properties\"\n+keys = [\n+   \"opennms/notifd/slack/channel\",\n+   \"opennms/notifd/slack/userName\",\n+   \"opennms/notifd/slack/iconEmoji\",\n+   \"opennms/notifd/slack/iconURL\",\n+   \"opennms/notifd/slack/useSystemProxy\"", "originalCommit": "e26c30debd75a36ad2c229e6ac453ac07a14b7e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTkwNTczOQ==", "url": "https://github.com/OpenNMS/opennms/pull/3205#discussion_r519905739", "bodyText": "I just looked at some of the other horizon templates and noticed they are using the convention of listing the individual keys, so if you want to continue that in your change you can to remain consistent. Up to you.", "author": "mattixtech", "createdAt": "2020-11-09T15:37:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg5MzE4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk1Njc3OA==", "url": "https://github.com/OpenNMS/opennms/pull/3205#discussion_r519956778", "bodyText": "Let's make it less redundant.", "author": "mfuhrmann", "createdAt": "2020-11-09T16:45:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg5MzE4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg5NjM2OA==", "url": "https://github.com/OpenNMS/opennms/pull/3205#discussion_r519896368", "bodyText": "We should add the base path to a variable and then reference it throughout:\n{{$slackPath := \"/opennms/notifd/slack/\" -}}\n\norg.opennms.netmgt.notifd.slack.username={{getv (print $slackPath \"userName\") \"none\"}}\n\nThe print above concatenates the variable and string to form the full path.", "author": "mattixtech", "createdAt": "2020-11-09T15:24:58Z", "path": "opennms-container/horizon/container-fs/confd/templates/slack.properties.tpl", "diffHunk": "@@ -0,0 +1,10 @@\n+#\n+# DON'T EDIT THIS FILE :: GENERATED WITH CONFD\n+#\n+\n+# Configure storage strategy\n+org.opennms.netmgt.notifd.slack.channel={{getv \"opennms/notifd/slack/channel\" \"Webhook\"}}", "originalCommit": "e26c30debd75a36ad2c229e6ac453ac07a14b7e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk1NzAyNw==", "url": "https://github.com/OpenNMS/opennms/pull/3205#discussion_r519957027", "bodyText": "Cool. I didn't know that. Thanks!", "author": "mfuhrmann", "createdAt": "2020-11-09T16:45:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg5NjM2OA=="}], "type": "inlineReview"}, {"oid": "76dda66232f7368993b01506ec06030c3842f511", "url": "https://github.com/OpenNMS/opennms/commit/76dda66232f7368993b01506ec06030c3842f511", "message": "Added requested changes", "committedDate": "2020-11-09T16:44:16Z", "type": "commit"}, {"oid": "f6d726d5fbc0ebdd808c6267572be8e00490e5c9", "url": "https://github.com/OpenNMS/opennms/commit/f6d726d5fbc0ebdd808c6267572be8e00490e5c9", "message": "Add confd readme file", "committedDate": "2020-11-11T17:34:05Z", "type": "commit"}, {"oid": "bcc549c8b737b2ab3c62428a30a546c3cf693191", "url": "https://github.com/OpenNMS/opennms/commit/bcc549c8b737b2ab3c62428a30a546c3cf693191", "message": "Added docs hint for more details", "committedDate": "2020-11-11T17:40:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjExNTE3NA==", "url": "https://github.com/OpenNMS/opennms/pull/3205#discussion_r522115174", "bodyText": "The slack path is $slackPath := \"/opennms/notifd/slack/\". Should it be then:\n---\nopennms:\n  notifd:\n    slack:\n      channel: ...", "author": "indigo423", "createdAt": "2020-11-12T13:44:59Z", "path": "opennms-container/horizon/CONFD_README.md", "diffHunk": "@@ -0,0 +1,26 @@\n+# Configuring Horizon via confd\n+(instructions for testing/developing confd templates are given at the end of this document)\n+## Mounting\n+When starting the Horizon container, mount a yaml file to the following path `/opt/minion/horizon-config.yaml`.\n+\n+Any configuration provided to confd will overwrite configuration specified as environment variables. Direct overlay of\n+specific configuration files will overwrite the corresponding config provided by confd.\n+\n+## Contents\n+The following describes the keys that can be specified in `horizon-config.yaml` to configure Horizon via confd.\n+\n+### Slack\n+\n+```\n+--- \n+notifd:", "originalCommit": "bcc549c8b737b2ab3c62428a30a546c3cf693191", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjE4MzE3MQ==", "url": "https://github.com/OpenNMS/opennms/pull/3205#discussion_r522183171", "bodyText": "Looks like it should be.", "author": "mattixtech", "createdAt": "2020-11-12T15:15:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjExNTE3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjc0Mjc5MA==", "url": "https://github.com/OpenNMS/opennms/pull/3205#discussion_r522742790", "bodyText": "That's my fault. I just copied the notifd part out of the file. Sorry for the confusion.\nIt looks like this:\nmf1045@mf1045-nb115:~/Dokumente/git/onms/stack-play/minimal-horizon/container-fs/opt/opennms-overlay/confd$ cat horizon-config.yaml \n---\npostgres:\n  host: database\n  port: 5432\n  user: postgres\n  password: postgres\n\nopennms:\n  dbname: opennms\n  dbuser: opennms\n  dbpass: opennms\n\n  timeseries:\n    strategy: rrd\n\n  rrd:\n    storebyforeignsource: true\n    strategyclass: org.opennms.netmgt.rrd.rrdtool.MultithreadedJniRrdStrategy\n\n  library:\n    jrrd2: /usr/lib64/libjrrd2.so\n\n  notifd:\n    slack:\n      channel: Alerting\n      userName: AlertingUser\n      iconEmoji: AlertingIcon\n      iconURL: AlertingURL", "author": "mfuhrmann", "createdAt": "2020-11-13T07:45:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjExNTE3NA=="}], "type": "inlineReview"}, {"oid": "90482cc94612c48484ce07b34fa41e793546cb9e", "url": "https://github.com/OpenNMS/opennms/commit/90482cc94612c48484ce07b34fa41e793546cb9e", "message": "Test: Using ENV variables in confd templates", "committedDate": "2020-11-16T16:29:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDU1MzgxNw==", "url": "https://github.com/OpenNMS/opennms/pull/3205#discussion_r524553817", "bodyText": "I don't think these should be in this file. When I was talking about testing using environment variables I meant as an alternative key source rather than a yaml file. When confd runs it can pull keys out of the ENV to write to the template.", "author": "mattixtech", "createdAt": "2020-11-16T20:31:30Z", "path": "opennms-container/horizon/container-fs/confd/templates/slack.properties.tpl", "diffHunk": "@@ -2,11 +2,17 @@\n # DON'T EDIT THIS FILE :: GENERATED WITH CONFD\n #\n \n+export OPENNMS_NOTIFD_SLACK_CHANNEL", "originalCommit": "90482cc94612c48484ce07b34fa41e793546cb9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDU2MDcyMw==", "url": "https://github.com/OpenNMS/opennms/pull/3205#discussion_r524560723", "bodyText": "@mattixtech I accidentally pushed this state. Sorry about that.\nRight now I have two versions that work. One using the YAML. One using ENV variables. I'm still figuring out how to combine that \ud83d\ude02", "author": "mfuhrmann", "createdAt": "2020-11-16T20:44:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDU1MzgxNw=="}], "type": "inlineReview"}, {"oid": "5af95179e57387c42a20c661393999fc0c91752d", "url": "https://github.com/OpenNMS/opennms/commit/5af95179e57387c42a20c661393999fc0c91752d", "message": "Added support for ENV or YAML input", "committedDate": "2020-11-17T18:40:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI2NjY0Nw==", "url": "https://github.com/OpenNMS/opennms/pull/3205#discussion_r526266647", "bodyText": "You can get rid of this along with the conditional. When confd is invoked you can tell it to source keys from the environment rather than yaml or another key source. We don't want to be explicitly checking for the env vars in the template.\nOnce that is done I'm good with this PR. I'm not familiar with what confd key source horizon is using so I don't need to see the env test work if we aren't using it, Ronny could provide guidance there perhaps.", "author": "mattixtech", "createdAt": "2020-11-18T17:20:56Z", "path": "opennms-container/horizon/container-fs/confd/templates/slack.properties.tpl", "diffHunk": "@@ -2,17 +2,22 @@\n # DON'T EDIT THIS FILE :: GENERATED WITH CONFD\n #\n \n-export OPENNMS_NOTIFD_SLACK_CHANNEL\n-export OPENNMS_NOTIFD_SLACK_USERNAME\n-export OPENNMS_NOTIFD_SLACK_ICONEMOJI\n-export OPENNMS_NOTIFD_SLACK_ICONURL\n-export OPENNMS_NOTIFD_SLACK_USESYSTEMPROXY\n+{{ if getenv \"OPENNMS_NOTIFD_SLACK_CHANNEL\" }}\n+\n+org.opennms.netmgt.notifd.slack.channel={{getenv \"OPENNMS_NOTIFD_SLACK_CHANNEL\" \"Webhook\"}}\n+org.opennms.netmgt.notifd.slack.username={{getenv \"OPENNMS_NOTIFD_SLACK_USERNAME\" \"none\"}}\n+org.opennms.netmgt.notifd.slack.iconEmoji={{getenv \"OPENNMS_NOTIFD_SLACK_ICONEMOJI\" \"\"}}\n+org.opennms.netmgt.notifd.slack.iconURL={{getenv \"OPENNMS_NOTIFD_SLACK_ICONURL\" \"\"}}\n+org.opennms.netmgt.notifd.slack.useSystemProxy={{getenv \"OPENNMS_NOTIFD_SLACK_USESYSTEMPROXY\" \"true\"}}\n+\n+{{ else }}", "originalCommit": "5af95179e57387c42a20c661393999fc0c91752d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "15b96c30d251a3a4044e9aa312af7e05f52f1c91", "url": "https://github.com/OpenNMS/opennms/commit/15b96c30d251a3a4044e9aa312af7e05f52f1c91", "message": "Revert to old state\n\nJust use the YAML settings instead of ENV and/or YAML.", "committedDate": "2020-11-24T19:41:41Z", "type": "commit"}]}