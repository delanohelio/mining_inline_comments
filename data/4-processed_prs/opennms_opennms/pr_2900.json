{"pr_number": 2900, "pr_title": "NMS-12547: Use ProtoBuf to transport BMP messages", "pr_createdAt": "2020-02-24T21:13:48Z", "pr_url": "https://github.com/OpenNMS/opennms/pull/2900", "timeline": [{"oid": "5d64ac636484f79132ed59a5504cad11bced8acd", "url": "https://github.com/OpenNMS/opennms/commit/5d64ac636484f79132ed59a5504cad11bced8acd", "message": "NMS-12547: Use ProtoBuf to transport BMP messages\n\nUsing a BMP-specific ProtoBuf transport format instead of BSON based\nformat.", "committedDate": "2020-02-24T21:36:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzczMDE2NA==", "url": "https://github.com/OpenNMS/opennms/pull/2900#discussion_r383730164", "bodyText": "Should call this something other than document now?", "author": "j-white", "createdAt": "2020-02-25T08:44:06Z", "path": "features/telemetry/protocols/bmp/adapter/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/adapter/BmpPeerStatusAdapter.java", "diffHunk": "@@ -77,13 +74,18 @@ public BmpPeerStatusAdapter(final AdapterDefinition adapterConfig,\n     public void handleMessage(final TelemetryMessageLogEntry message,\n                               final TelemetryMessageLog messageLog) {\n         LOG.trace(\"Parsing packet: {}\", message);\n-        final BsonDocument document = new RawBsonDocument(message.getByteArray());\n+        final Transport.Message document;", "originalCommit": "5d64ac636484f79132ed59a5504cad11bced8acd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzc1ODcyNQ==", "url": "https://github.com/OpenNMS/opennms/pull/2900#discussion_r383758725", "bodyText": "There is no good name I can come up with - message is already in use.", "author": "fooker", "createdAt": "2020-02-25T09:36:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzczMDE2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzczMjExMg==", "url": "https://github.com/OpenNMS/opennms/pull/2900#discussion_r383732112", "bodyText": "Worth creating a JIRA for this?", "author": "j-white", "createdAt": "2020-02-25T08:48:03Z", "path": "features/telemetry/protocols/bmp/adapter/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/adapter/BmpTelemetryAdapter.java", "diffHunk": "@@ -99,40 +100,46 @@ public BmpTelemetryAdapter(final AdapterDefinition adapterConfig,\n         final CollectionAgent agent = this.collectionAgentFactory.createCollectionAgent(Integer.toString(exporterNodeId.get()), exporterAddress);\n \n         // Extract peer details\n-        final String peerAddress = getString(document, \"peer\", \"address\").get();\n-        final Instant timestamp = Instant.ofEpochSecond(getInt64(document, \"peer\", \"timestamp\", \"epoch\").get(),\n-                                                        getInt64(document, \"peer\", \"timestamp\", \"nanos\").orElse(0L));\n-        final String as = Long.toString(getInt64(document, \"peer\", \"as\").get());\n-        final String id = Long.toString(getInt64(document, \"peer\", \"id\").get());\n+        final String peerAddress = InetAddressUtils.str(address(stats.getPeer().getAddress()));\n \n         // Build resource for the peer\n         final NodeLevelResource nodeResource = new NodeLevelResource(agent.getNodeId());\n         final DeferredGenericTypeResource peerResource = new DeferredGenericTypeResource(nodeResource, \"bmp\", peerAddress);\n \n         // Build the collection set for the peer\n         final CollectionSetBuilder builder = new CollectionSetBuilder(agent);\n-        builder.withTimestamp(Date.from(timestamp));\n+        builder.withTimestamp(Date.from(timestamp(stats.getPeer().getTimestamp())));\n         builder.withStringAttribute(peerResource, \"bmp\", \"address\", peerAddress);\n-        builder.withStringAttribute(peerResource, \"bmp\", \"as\", as);\n-        builder.withStringAttribute(peerResource, \"bmp\", \"id\", id);\n-\n-        final BsonDocument stats = document.getDocument(\"stats\");\n-        for (final String key : stats.keySet()) {\n-            final BsonDocument metric = stats.getDocument(key);\n-\n-            final String identifier = String.format(\"bmp_%s_%s\", peerAddress, key);\n-\n-            getInt64(metric, \"counter\").ifPresent(counter -> {\n-                Optional.ofNullable(METRIC_ATTRIBUTE_MAP.get(key)).ifPresent(name -> {\n-                    builder.withIdentifiedNumericAttribute(peerResource, \"bmp\", name, counter, AttributeType.COUNTER, identifier);\n-                });\n-            });\n-            getInt64(metric, \"gauge\").ifPresent(gauge -> {\n-                Optional.ofNullable(METRIC_ATTRIBUTE_MAP.get(key)).ifPresent(name -> {\n-                    builder.withIdentifiedNumericAttribute(peerResource, \"bmp\", name, gauge, AttributeType.GAUGE, identifier);\n-                });\n-            });\n-        }\n+        builder.withStringAttribute(peerResource, \"bmp\", \"as\", Long.toString(stats.getPeer().getAs()));\n+        builder.withStringAttribute(peerResource, \"bmp\", \"id\", Long.toString(stats.getPeer().getId()));\n+\n+        final Function<String, Consumer<Transport.StatisticsReportPacket.Counter>> addCounter = (name) -> (counter) -> {\n+            final String identifier = String.format(\"bmp_%s_%s\", peerAddress, name);\n+            builder.withIdentifiedNumericAttribute(peerResource, \"bmp\", name, counter.getCount(), AttributeType.COUNTER, identifier);\n+        };\n+\n+        final Function<String, Consumer<Transport.StatisticsReportPacket.Gauge>> addGauge = (name) -> (gauge) -> {\n+            final String identifier = String.format(\"bmp_%s_%s\", peerAddress, name);\n+            builder.withIdentifiedNumericAttribute(peerResource, \"bmp\", name, gauge.getValue(), AttributeType.COUNTER, identifier);\n+        };\n+\n+        Optional.ofNullable(stats.getRejected()).ifPresent(addCounter.apply(\"rejected\"));\n+        Optional.ofNullable(stats.getDuplicatePrefix()).ifPresent(addCounter.apply(\"duplicate_prefix\"));\n+        Optional.ofNullable(stats.getDuplicateWithdraw()).ifPresent(addCounter.apply(\"duplicate_withdraw\"));\n+        Optional.ofNullable(stats.getInvalidUpdateDueToAsConfedLoop()).ifPresent(addCounter.apply(\"inv_as_confed_loop\"));\n+        Optional.ofNullable(stats.getInvalidUpdateDueToAsPathLoop()).ifPresent(addCounter.apply(\"inv_as_path_loop\"));\n+        Optional.ofNullable(stats.getInvalidUpdateDueToClusterListLoop()).ifPresent(addCounter.apply(\"inv_cl_loop\"));\n+        Optional.ofNullable(stats.getInvalidUpdateDueToOriginatorId()).ifPresent(addCounter.apply(\"inv_originator_id\"));\n+        Optional.ofNullable(stats.getAdjRibIn()).ifPresent(addGauge.apply(\"adj_rib_in\"));\n+        Optional.ofNullable(stats.getAdjRibOut()).ifPresent(addGauge.apply(\"adj_rib_out\"));\n+\n+        // TODO fooker: Add per AFI counters (perAfiAdjRibIn and perAfiLocRib)", "originalCommit": "5d64ac636484f79132ed59a5504cad11bced8acd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzc1NzkzMQ==", "url": "https://github.com/OpenNMS/opennms/pull/2900#discussion_r383757931", "bodyText": "Tracking issue is https://issues.opennms.org/browse/NMS-12553", "author": "fooker", "createdAt": "2020-02-25T09:35:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzczMjExMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzczMjI4Nw==", "url": "https://github.com/OpenNMS/opennms/pull/2900#discussion_r383732287", "bodyText": "Similarly here.", "author": "j-white", "createdAt": "2020-02-25T08:48:23Z", "path": "features/telemetry/protocols/bmp/adapter/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/adapter/BmpTelemetryAdapter.java", "diffHunk": "@@ -77,15 +75,18 @@ public BmpTelemetryAdapter(final AdapterDefinition adapterConfig,\n     @Override\n     public Stream<CollectionSetWithAgent> handleCollectionMessage(final TelemetryMessageLogEntry message,\n                                                                   final TelemetryMessageLog messageLog) {\n-        LOG.debug(\"Received {} telemetry messages\", messageLog.getMessageList().size());\n-\n         LOG.trace(\"Parsing packet: {}\", message);\n-        final BsonDocument document = new RawBsonDocument(message.getByteArray());\n+        final Transport.Message document;", "originalCommit": "5d64ac636484f79132ed59a5504cad11bced8acd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "44b7b707422e924510d626760d283361c3fee4ba", "url": "https://github.com/OpenNMS/opennms/commit/44b7b707422e924510d626760d283361c3fee4ba", "message": "NMS-12547: Use ProtoBuf to transport BMP messages\n\nUsing a BMP-specific ProtoBuf transport format instead of BSON based\nformat.", "committedDate": "2020-02-25T09:36:18Z", "type": "forcePushed"}, {"oid": "2c6d3ed89b7ed51c74e9e7e9c862b5680b4d2002", "url": "https://github.com/OpenNMS/opennms/commit/2c6d3ed89b7ed51c74e9e7e9c862b5680b4d2002", "message": "NMS-12547: Use ProtoBuf to transport BMP messages\n\nUsing a BMP-specific ProtoBuf transport format instead of BSON based\nformat.", "committedDate": "2020-02-25T09:40:06Z", "type": "commit"}, {"oid": "2c6d3ed89b7ed51c74e9e7e9c862b5680b4d2002", "url": "https://github.com/OpenNMS/opennms/commit/2c6d3ed89b7ed51c74e9e7e9c862b5680b4d2002", "message": "NMS-12547: Use ProtoBuf to transport BMP messages\n\nUsing a BMP-specific ProtoBuf transport format instead of BSON based\nformat.", "committedDate": "2020-02-25T09:40:06Z", "type": "forcePushed"}]}