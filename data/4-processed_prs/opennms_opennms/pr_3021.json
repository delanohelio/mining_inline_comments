{"pr_number": 3021, "pr_title": "NMS-12678: added RemotePollerd configuration reloading", "pr_createdAt": "2020-05-26T18:57:45Z", "pr_url": "https://github.com/OpenNMS/opennms/pull/3021", "timeline": [{"oid": "7218f6be03a233c742dc45c972ec0b442904e2f7", "url": "https://github.com/OpenNMS/opennms/commit/7218f6be03a233c742dc45c972ec0b442904e2f7", "message": "NMS-12678: added RemotePollerd configuration reloading", "committedDate": "2020-05-26T18:46:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzkxMzUwOA==", "url": "https://github.com/OpenNMS/opennms/pull/3021#discussion_r433913508", "bodyText": "This is basically a duplicate of the code in {{scheduleAllServices}}. Can we deduplicate this?", "author": "fooker", "createdAt": "2020-06-02T14:18:32Z", "path": "features/remotepollerng/daemon/src/main/java/org/opennms/netmgt/remotepollerng/RemotePollerd.java", "diffHunk": "@@ -196,6 +199,88 @@ public void scheduleAllServices() {\n         });\n     }\n \n+    private Map<JobKey, RemotePolledService> getMapOfScheduledServices(final String locationName) {\n+        final Map<JobKey, RemotePolledService> mapOfScheduledServices = new TreeMap<>();\n+        try {\n+            for(final JobKey jobKey : scheduler.getJobKeys(GroupMatcher.jobGroupEquals(locationName))) {\n+                try {\n+                    final JobDetail jobDetail = scheduler.getJobDetail(jobKey);\n+\n+                    if (locationName.equals(jobDetail.getJobDataMap().get(RemotePollJob.LOCATION_NAME)) &&\n+                        jobDetail.getJobDataMap().get(RemotePollJob.REMOTE_POLLER_BACKEND) == this) {\n+                        mapOfScheduledServices.put(jobKey, (RemotePolledService) jobDetail.getJobDataMap().get(RemotePollJob.POLLED_SERVICE));\n+                    }\n+                } catch (SchedulerException e) {\n+                    LOG.warn(\"Failed to retrieve job details {}.\", jobKey, e);\n+                }\n+            }\n+        } catch (SchedulerException e) {\n+            LOG.warn(\"Failed to query scheduled jobs.\", e);\n+        }\n+\n+        return mapOfScheduledServices;\n+    }\n+\n+    public void handleConfigurationChanged() {\n+        final Map<String, List<RemotePolledService>> servicesByPackage = new HashMap<>();\n+\n+        try {\n+            this.pollerConfig.update();\n+        } catch (IOException e) {\n+            LOG.warn(\"Error reloading poller-configuration.xml\");\n+        }\n+\n+        LOG.info(\"Re-scheduling all services...\");\n+        sessionUtils.withReadOnlyTransaction(() -> {\n+            for (final OnmsMonitoringLocation loc : monitoringLocationDao.findAll()) {\n+                final List<String> pollingPackageNames = loc.getPollingPackageNames();\n+                LOG.debug(\"Location '{}' has polling packages: {}\", loc.getLocationName(), pollingPackageNames);\n+\n+                final Set<RemotePolledService> servicesToBeScheduled = new HashSet<>();\n+\n+                for (final String pollingPackageName : pollingPackageNames) {", "originalCommit": "7218f6be03a233c742dc45c972ec0b442904e2f7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk0NDgwNQ==", "url": "https://github.com/OpenNMS/opennms/pull/3021#discussion_r433944805", "bodyText": "done", "author": "christianpape", "createdAt": "2020-06-02T15:01:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzkxMzUwOA=="}], "type": "inlineReview"}, {"oid": "c1314195694278788dbe0863e696e490748edf62", "url": "https://github.com/OpenNMS/opennms/commit/c1314195694278788dbe0863e696e490748edf62", "message": "NMS-12678: Review changes", "committedDate": "2020-06-02T15:00:39Z", "type": "commit"}]}