{"pr_number": 3239, "pr_title": "NMS-12963: Enhance routes with ASN/Route info", "pr_createdAt": "2020-12-07T22:11:48Z", "pr_url": "https://github.com/OpenNMS/opennms/pull/3239", "timeline": [{"oid": "b02c0a54ef42b04f6f41a830b55f2f92debc3689", "url": "https://github.com/OpenNMS/opennms/commit/b02c0a54ef42b04f6f41a830b55f2f92debc3689", "message": "NMS-12949: Persist BMP messages", "committedDate": "2020-10-21T21:41:13Z", "type": "commit"}, {"oid": "b641d4e6eb9c5e64bf746d28e600447e646fd2c8", "url": "https://github.com/OpenNMS/opennms/commit/b641d4e6eb9c5e64bf746d28e600447e646fd2c8", "message": "NMS-12952: Persist stats for BMP", "committedDate": "2020-11-18T14:51:41Z", "type": "commit"}, {"oid": "d876bd790e2967c6448bd666dc04071a73240c97", "url": "https://github.com/OpenNMS/opennms/commit/d876bd790e2967c6448bd666dc04071a73240c97", "message": "NMS-12949: Handle review comments", "committedDate": "2020-11-30T21:13:01Z", "type": "commit"}, {"oid": "90549259dc8416a1fae053f38e8d4b6a3d079204", "url": "https://github.com/OpenNMS/opennms/commit/90549259dc8416a1fae053f38e8d4b6a3d079204", "message": "NMS-12949: Handle review comments", "committedDate": "2020-12-01T15:47:04Z", "type": "commit"}, {"oid": "f1e2e9bfb8f8a1cbd34d8d3b03edc8a7740181b0", "url": "https://github.com/OpenNMS/opennms/commit/f1e2e9bfb8f8a1cbd34d8d3b03edc8a7740181b0", "message": "NMS-12963: Add ASN info and path tables", "committedDate": "2020-12-03T23:03:53Z", "type": "commit"}, {"oid": "243519e42f4a3bb5e4d834a1c98b1c2333c761b5", "url": "https://github.com/OpenNMS/opennms/commit/243519e42f4a3bb5e4d834a1c98b1c2333c761b5", "message": "Merge branch 'features/bmp' into jira/NMS-12963", "committedDate": "2020-12-06T00:41:20Z", "type": "commit"}, {"oid": "9b54e4e0c94cd9b41cba79abaac5dde0e2d53b7b", "url": "https://github.com/OpenNMS/opennms/commit/9b54e4e0c94cd9b41cba79abaac5dde0e2d53b7b", "message": "NMS-12963: Add asn_path_analysis", "committedDate": "2020-12-07T22:02:58Z", "type": "commit"}, {"oid": "a7467030aba1188a6b3e79ae24037d204024bd73", "url": "https://github.com/OpenNMS/opennms/commit/a7467030aba1188a6b3e79ae24037d204024bd73", "message": "Merge branch 'features/bmp' into jira/NMS-12963", "committedDate": "2021-01-05T19:40:56Z", "type": "commit"}, {"oid": "fe25755a341bb4351f444cf1acd84122d35ed948", "url": "https://github.com/OpenNMS/opennms/commit/fe25755a341bb4351f444cf1acd84122d35ed948", "message": "Merge branch 'features/bmp' into jira/NMS-12963", "committedDate": "2021-01-05T22:07:34Z", "type": "commit"}, {"oid": "7afa55ceba910ea7f2ade0d2f88517ece05c3323", "url": "https://github.com/OpenNMS/opennms/commit/7afa55ceba910ea7f2ade0d2f88517ece05c3323", "message": "NMS-12964: Add BMP route info", "committedDate": "2021-01-06T14:52:44Z", "type": "commit"}, {"oid": "ac5cf17fe9802fbf3c243d5ef901da0de2d1b74b", "url": "https://github.com/OpenNMS/opennms/commit/ac5cf17fe9802fbf3c243d5ef901da0de2d1b74b", "message": "NMS-12964: Add RouteInfo table", "committedDate": "2021-01-06T14:52:55Z", "type": "commit"}, {"oid": "302e52f427bda38a6b9f6e081a83ec47594ac836", "url": "https://github.com/OpenNMS/opennms/commit/302e52f427bda38a6b9f6e081a83ec47594ac836", "message": "Merge branch 'develop' into jira/NMS-12963", "committedDate": "2021-01-13T15:26:12Z", "type": "commit"}, {"oid": "87f009bf7b4014d6c366485c93e794e694d72146", "url": "https://github.com/OpenNMS/opennms/commit/87f009bf7b4014d6c366485c93e794e694d72146", "message": "Merge branch 'features/bmp' into jira/NMS-12963", "committedDate": "2021-01-13T17:46:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Nzk4MTkyMA==", "url": "https://github.com/OpenNMS/opennms/pull/3239#discussion_r557981920", "bodyText": "Maybe this should be updated to 2021 now", "author": "christianpape", "createdAt": "2021-01-15T07:57:26Z", "path": "features/telemetry/protocols/bmp/adapter/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/adapter/AsnInfo.java", "diffHunk": "@@ -0,0 +1,200 @@\n+/*******************************************************************************\n+ * This file is part of OpenNMS(R).\n+ *\n+ * Copyright (C) 2020 The OpenNMS Group, Inc.", "originalCommit": "87f009bf7b4014d6c366485c93e794e694d72146", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODAxNDkyNA==", "url": "https://github.com/OpenNMS/opennms/pull/3239#discussion_r558014924", "bodyText": "This applies to all the other new headers too", "author": "christianpape", "createdAt": "2021-01-15T08:18:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Nzk4MTkyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Nzk4OTg4MQ==", "url": "https://github.com/OpenNMS/opennms/pull/3239#discussion_r557989881", "bodyText": "Is OrgName ||\u00a0descr right? Isn't it something like OrgName || orgname?", "author": "christianpape", "createdAt": "2021-01-15T08:01:39Z", "path": "features/telemetry/protocols/bmp/adapter/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/adapter/AsnInfo.java", "diffHunk": "@@ -0,0 +1,200 @@\n+/*******************************************************************************\n+ * This file is part of OpenNMS(R).\n+ *\n+ * Copyright (C) 2020 The OpenNMS Group, Inc.\n+ * OpenNMS(R) is Copyright (C) 1999-2020 The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is a registered trademark of The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Affero General Public License as published\n+ * by the Free Software Foundation, either version 3 of the License,\n+ * or (at your option) any later version.\n+ *\n+ * OpenNMS(R) is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU Affero General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with OpenNMS(R).  If not, see:\n+ *      http://www.gnu.org/licenses/\n+ *\n+ * For more information contact:\n+ *     OpenNMS(R) Licensing <license@opennms.org>\n+ *     http://www.opennms.org/\n+ *     http://www.opennms.com/\n+ *******************************************************************************/\n+\n+package org.opennms.netmgt.telemetry.protocols.bmp.adapter;\n+\n+import java.util.Optional;\n+\n+public class AsnInfo {\n+\n+    private Long asn;\n+    private String asName;\n+    private String orgId;\n+    private String orgName;\n+    private String address;\n+    private String city;\n+    private String stateProv;\n+    private String postalCode;\n+    private String country;\n+    private String source;\n+    private String rawOutput;\n+    private String remarks;\n+\n+    public AsnInfo(Long asn, String source, String rawOutput) {\n+        this.asn = asn;\n+        this.source = source;\n+        this.rawOutput = rawOutput;\n+    }\n+\n+    public Long getAsn() {\n+        return asn;\n+    }\n+\n+    public void setAsn(Long asn) {\n+        this.asn = asn;\n+    }\n+\n+    public String getAsName() {\n+        return asName;\n+    }\n+\n+    public void setAsName(String asName) {\n+        this.asName = asName;\n+    }\n+\n+    public String getOrgId() {\n+        return orgId;\n+    }\n+\n+    public void setOrgId(String orgId) {\n+        this.orgId = orgId;\n+    }\n+\n+    public String getOrgName() {\n+        return orgName;\n+    }\n+\n+    public void setOrgName(String orgName) {\n+        this.orgName = orgName;\n+    }\n+\n+    public String getAddress() {\n+        return address;\n+    }\n+\n+    public void setAddress(String address) {\n+        this.address = address;\n+    }\n+\n+    public String getCity() {\n+        return city;\n+    }\n+\n+    public void setCity(String city) {\n+        this.city = city;\n+    }\n+\n+    public String getStateProv() {\n+        return stateProv;\n+    }\n+\n+    public void setStateProv(String stateProv) {\n+        this.stateProv = stateProv;\n+    }\n+\n+    public String getPostalCode() {\n+        return postalCode;\n+    }\n+\n+    public void setPostalCode(String postalCode) {\n+        this.postalCode = postalCode;\n+    }\n+\n+    public String getCountry() {\n+        return country;\n+    }\n+\n+    public void setCountry(String country) {\n+        this.country = country;\n+    }\n+\n+    public String getSource() {\n+        return source;\n+    }\n+\n+    public void setSource(String source) {\n+        this.source = source;\n+    }\n+\n+    public String getRawOutput() {\n+        return rawOutput;\n+    }\n+\n+    public void setRawOutput(String rawOutput) {\n+        this.rawOutput = rawOutput;\n+    }\n+\n+    public String getRemarks() {\n+        return remarks;\n+    }\n+\n+    public void setRemarks(String remarks) {\n+        this.remarks = remarks;\n+    }\n+\n+    public static AsnInfo parseOutput(Long asn, String source, String rawOutput) {\n+        AsnInfo asnInfo = new AsnInfo(asn, source, rawOutput);\n+        // Split output into lines\n+        String[] lines = rawOutput.split(\"\\\\r?\\\\n\");\n+        for (String line : lines) {\n+            if (line.contains(\"ASName\") || line.contains(\"as-name\")) {\n+                getSubStringAfterColon(line).ifPresent(asnInfo::setAsName);\n+                continue;\n+            }\n+            if (line.contains(\"OrgName\") || line.contains(\"descr\")) {", "originalCommit": "87f009bf7b4014d6c366485c93e794e694d72146", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Nzk5MDI2Ng==", "url": "https://github.com/OpenNMS/opennms/pull/3239#discussion_r557990266", "bodyText": "Same here", "author": "christianpape", "createdAt": "2021-01-15T08:01:52Z", "path": "features/telemetry/protocols/bmp/adapter/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/adapter/AsnInfo.java", "diffHunk": "@@ -0,0 +1,200 @@\n+/*******************************************************************************\n+ * This file is part of OpenNMS(R).\n+ *\n+ * Copyright (C) 2020 The OpenNMS Group, Inc.\n+ * OpenNMS(R) is Copyright (C) 1999-2020 The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is a registered trademark of The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Affero General Public License as published\n+ * by the Free Software Foundation, either version 3 of the License,\n+ * or (at your option) any later version.\n+ *\n+ * OpenNMS(R) is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU Affero General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with OpenNMS(R).  If not, see:\n+ *      http://www.gnu.org/licenses/\n+ *\n+ * For more information contact:\n+ *     OpenNMS(R) Licensing <license@opennms.org>\n+ *     http://www.opennms.org/\n+ *     http://www.opennms.com/\n+ *******************************************************************************/\n+\n+package org.opennms.netmgt.telemetry.protocols.bmp.adapter;\n+\n+import java.util.Optional;\n+\n+public class AsnInfo {\n+\n+    private Long asn;\n+    private String asName;\n+    private String orgId;\n+    private String orgName;\n+    private String address;\n+    private String city;\n+    private String stateProv;\n+    private String postalCode;\n+    private String country;\n+    private String source;\n+    private String rawOutput;\n+    private String remarks;\n+\n+    public AsnInfo(Long asn, String source, String rawOutput) {\n+        this.asn = asn;\n+        this.source = source;\n+        this.rawOutput = rawOutput;\n+    }\n+\n+    public Long getAsn() {\n+        return asn;\n+    }\n+\n+    public void setAsn(Long asn) {\n+        this.asn = asn;\n+    }\n+\n+    public String getAsName() {\n+        return asName;\n+    }\n+\n+    public void setAsName(String asName) {\n+        this.asName = asName;\n+    }\n+\n+    public String getOrgId() {\n+        return orgId;\n+    }\n+\n+    public void setOrgId(String orgId) {\n+        this.orgId = orgId;\n+    }\n+\n+    public String getOrgName() {\n+        return orgName;\n+    }\n+\n+    public void setOrgName(String orgName) {\n+        this.orgName = orgName;\n+    }\n+\n+    public String getAddress() {\n+        return address;\n+    }\n+\n+    public void setAddress(String address) {\n+        this.address = address;\n+    }\n+\n+    public String getCity() {\n+        return city;\n+    }\n+\n+    public void setCity(String city) {\n+        this.city = city;\n+    }\n+\n+    public String getStateProv() {\n+        return stateProv;\n+    }\n+\n+    public void setStateProv(String stateProv) {\n+        this.stateProv = stateProv;\n+    }\n+\n+    public String getPostalCode() {\n+        return postalCode;\n+    }\n+\n+    public void setPostalCode(String postalCode) {\n+        this.postalCode = postalCode;\n+    }\n+\n+    public String getCountry() {\n+        return country;\n+    }\n+\n+    public void setCountry(String country) {\n+        this.country = country;\n+    }\n+\n+    public String getSource() {\n+        return source;\n+    }\n+\n+    public void setSource(String source) {\n+        this.source = source;\n+    }\n+\n+    public String getRawOutput() {\n+        return rawOutput;\n+    }\n+\n+    public void setRawOutput(String rawOutput) {\n+        this.rawOutput = rawOutput;\n+    }\n+\n+    public String getRemarks() {\n+        return remarks;\n+    }\n+\n+    public void setRemarks(String remarks) {\n+        this.remarks = remarks;\n+    }\n+\n+    public static AsnInfo parseOutput(Long asn, String source, String rawOutput) {\n+        AsnInfo asnInfo = new AsnInfo(asn, source, rawOutput);\n+        // Split output into lines\n+        String[] lines = rawOutput.split(\"\\\\r?\\\\n\");\n+        for (String line : lines) {\n+            if (line.contains(\"ASName\") || line.contains(\"as-name\")) {\n+                getSubStringAfterColon(line).ifPresent(asnInfo::setAsName);\n+                continue;\n+            }\n+            if (line.contains(\"OrgName\") || line.contains(\"descr\")) {\n+                getSubStringAfterColon(line).ifPresent(asnInfo::setOrgName);\n+                continue;\n+            }\n+            if (line.contains(\"OrgId\") || line.contains(\"org\")) {\n+                getSubStringAfterColon(line).ifPresent(asnInfo::setOrgId);\n+                continue;\n+            }\n+            if (line.contains(\"Address\") || line.contains(\"descr\")) {", "originalCommit": "87f009bf7b4014d6c366485c93e794e694d72146", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Nzk5OTQyMQ==", "url": "https://github.com/OpenNMS/opennms/pull/3239#discussion_r557999421", "bodyText": "Remarks are missing, right?", "author": "christianpape", "createdAt": "2021-01-15T08:08:26Z", "path": "features/telemetry/protocols/bmp/adapter/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/adapter/BmpMessagePersister.java", "diffHunk": "@@ -540,6 +600,119 @@ private BmpGlobalIpRib buildGlobalIpRib(PrefixByAS prefixByAS) {\n \n     }\n \n+    private BmpAsnInfo fetchAndBuildAsnInfo(Long asn) {\n+        Optional<AsnInfo> asnInfoOptional = BmpWhoIsClient.getAsnInfo(asn);\n+        if (asnInfoOptional.isPresent()) {\n+            BmpAsnInfo bmpAsnInfo = new BmpAsnInfo();\n+            AsnInfo asnInfo = asnInfoOptional.get();\n+            bmpAsnInfo.setAsn(asnInfo.getAsn());\n+            bmpAsnInfo.setOrgId(asnInfo.getOrgId());\n+            bmpAsnInfo.setAsName(asnInfo.getAsName());\n+            bmpAsnInfo.setOrgName(asnInfo.getOrgName());\n+            bmpAsnInfo.setAddress(asnInfo.getAddress());\n+            bmpAsnInfo.setCity(asnInfo.getCity());\n+            bmpAsnInfo.setStateProv(asnInfo.getStateProv());\n+            bmpAsnInfo.setPostalCode(asnInfo.getPostalCode());\n+            bmpAsnInfo.setCountry(asnInfo.getCountry());\n+            bmpAsnInfo.setSource(asnInfo.getSource());\n+            bmpAsnInfo.setRawOutput(asnInfo.getRawOutput());\n+            bmpAsnInfo.setLastUpdated(Date.from(Instant.now()));", "originalCommit": "87f009bf7b4014d6c366485c93e794e694d72146", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODA0MDg4OA==", "url": "https://github.com/OpenNMS/opennms/pull/3239#discussion_r558040888", "bodyText": "I do not understand why the prefix is tried to be parsed twice. StringUtils.parseInt also uses Integer.parseInt().", "author": "christianpape", "createdAt": "2021-01-15T08:36:14Z", "path": "features/telemetry/protocols/bmp/adapter/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/adapter/RouteInfo.java", "diffHunk": "@@ -0,0 +1,149 @@\n+/*******************************************************************************\n+ * This file is part of OpenNMS(R).\n+ *\n+ * Copyright (C) 2020 The OpenNMS Group, Inc.\n+ * OpenNMS(R) is Copyright (C) 1999-2020 The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is a registered trademark of The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Affero General Public License as published\n+ * by the Free Software Foundation, either version 3 of the License,\n+ * or (at your option) any later version.\n+ *\n+ * OpenNMS(R) is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU Affero General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with OpenNMS(R).  If not, see:\n+ *      http://www.gnu.org/licenses/\n+ *\n+ * For more information contact:\n+ *     OpenNMS(R) Licensing <license@opennms.org>\n+ *     http://www.opennms.org/\n+ *     http://www.opennms.com/\n+ *******************************************************************************/\n+\n+package org.opennms.netmgt.telemetry.protocols.bmp.adapter;\n+\n+import java.net.InetAddress;\n+import java.util.Optional;\n+\n+import org.opennms.core.utils.StringUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class RouteInfo {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(RouteInfo.class);\n+\n+    private String prefix;\n+\n+    private Integer prefixLen;\n+\n+    private String description;\n+\n+    private Long originAs;\n+\n+    private String source;\n+\n+    public String getPrefix() {\n+        return prefix;\n+    }\n+\n+    public void setPrefix(String prefix) {\n+        this.prefix = prefix;\n+    }\n+\n+    public Integer getPrefixLen() {\n+        return prefixLen;\n+    }\n+\n+    public void setPrefixLen(Integer prefixLen) {\n+        this.prefixLen = prefixLen;\n+    }\n+\n+    public String getDescription() {\n+        return description;\n+    }\n+\n+    public void setDescription(String description) {\n+        this.description = description;\n+    }\n+\n+    public Long getOriginAs() {\n+        return originAs;\n+    }\n+\n+    public void setOriginAs(Long originAs) {\n+        this.originAs = originAs;\n+    }\n+\n+    public String getSource() {\n+        return source;\n+    }\n+\n+    public void setSource(String source) {\n+        this.source = source;\n+    }\n+\n+    public static RouteInfo parseOutput(String rawOutput) {\n+        RouteInfo routeInfo = new RouteInfo();\n+        // Split output into lines\n+        String[] lines = rawOutput.split(\"\\\\r?\\\\n\");\n+        for (String line : lines) {\n+            if (line.contains(\"route\")) {\n+                getSubStringAfterColon(line).ifPresent(route -> {\n+                    if (route.contains(\"/\")) {\n+                        String[] prefixArray = route.split(\"/\", 2);\n+                        if(isValidIpAddress(prefixArray[0])) {\n+                            routeInfo.setPrefix(prefixArray[0]);\n+                        }\n+                        Integer prefixLen = StringUtils.parseInt(prefixArray[1], null);\n+                        if (prefixLen != null) {\n+                            routeInfo.setPrefixLen(Integer.parseInt(prefixArray[1]));", "originalCommit": "87f009bf7b4014d6c366485c93e794e694d72146", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODA0OTM4Mg==", "url": "https://github.com/OpenNMS/opennms/pull/3239#discussion_r558049382", "bodyText": "should the subCode added here too?", "author": "christianpape", "createdAt": "2021-01-15T08:41:32Z", "path": "features/telemetry/protocols/bmp/persistence/api/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/persistence/api/BmpPeer.java", "diffHunk": "@@ -397,6 +419,7 @@ public boolean equals(Object o) {\n                 Objects.equals(bmpRouter, bmpPeer.bmpRouter) &&\n                 Objects.equals(peerRd, bmpPeer.peerRd) &&\n                 Objects.equals(peerAddr, bmpPeer.peerAddr) &&\n+                Objects.equals(peerAsn, bmpPeer.peerAsn) &&", "originalCommit": "87f009bf7b4014d6c366485c93e794e694d72146", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODA0OTcxMg==", "url": "https://github.com/OpenNMS/opennms/pull/3239#discussion_r558049712", "bodyText": "same here", "author": "christianpape", "createdAt": "2021-01-15T08:41:44Z", "path": "features/telemetry/protocols/bmp/persistence/api/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/persistence/api/BmpPeer.java", "diffHunk": "@@ -419,7 +442,7 @@ public boolean equals(Object o) {\n \n     @Override\n     public int hashCode() {\n-        return Objects.hash(hashId, bmpRouter, peerRd, isIpv4, peerAddr, name, peerBgpId, state, isL3VPNPeer, timestamp, isPrePolicy, geoIpStart, localIp, localBgpId, localPort, localHoldTime, localAsn, remotePort, remoteHoldTime, sentCapabilities, receivedCapabilities, bmpReason, bgpErrCode, errorText, isLocRib, isLocRibFiltered, tableName);\n+        return Objects.hash(hashId, bmpRouter, peerRd, isIpv4, peerAddr, peerAsn, name, peerBgpId, state, isL3VPNPeer, timestamp, isPrePolicy, geoIpStart, localIp, localBgpId, localPort, localHoldTime, localAsn, remotePort, remoteHoldTime, sentCapabilities, receivedCapabilities, bmpReason, bgpErrCode, errorText, isLocRib, isLocRibFiltered, tableName);", "originalCommit": "87f009bf7b4014d6c366485c93e794e694d72146", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODA0OTk2NQ==", "url": "https://github.com/OpenNMS/opennms/pull/3239#discussion_r558049965", "bodyText": "...and here", "author": "christianpape", "createdAt": "2021-01-15T08:41:53Z", "path": "features/telemetry/protocols/bmp/persistence/api/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/persistence/api/BmpPeer.java", "diffHunk": "@@ -431,6 +454,7 @@ public String toString() {\n                 \", peerRd='\" + peerRd + '\\'' +\n                 \", isIpv4=\" + isIpv4 +\n                 \", peerAddr='\" + peerAddr + '\\'' +\n+                \", peerAsn='\" + peerAsn + '\\'' +", "originalCommit": "87f009bf7b4014d6c366485c93e794e694d72146", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODIyNzAzMA==", "url": "https://github.com/OpenNMS/opennms/pull/3239#discussion_r558227030", "bodyText": "As far as I know, there can be entries can appear more than once. For instance there can be multiple address entries if the address is more than one line. The OpenBMP-implementation concatenates these strings before persisting them. So, this is missing here.", "author": "christianpape", "createdAt": "2021-01-15T10:49:38Z", "path": "features/telemetry/protocols/bmp/adapter/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/adapter/AsnInfo.java", "diffHunk": "@@ -0,0 +1,200 @@\n+/*******************************************************************************\n+ * This file is part of OpenNMS(R).\n+ *\n+ * Copyright (C) 2020 The OpenNMS Group, Inc.\n+ * OpenNMS(R) is Copyright (C) 1999-2020 The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is a registered trademark of The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Affero General Public License as published\n+ * by the Free Software Foundation, either version 3 of the License,\n+ * or (at your option) any later version.\n+ *\n+ * OpenNMS(R) is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU Affero General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with OpenNMS(R).  If not, see:\n+ *      http://www.gnu.org/licenses/\n+ *\n+ * For more information contact:\n+ *     OpenNMS(R) Licensing <license@opennms.org>\n+ *     http://www.opennms.org/\n+ *     http://www.opennms.com/\n+ *******************************************************************************/\n+\n+package org.opennms.netmgt.telemetry.protocols.bmp.adapter;\n+\n+import java.util.Optional;\n+\n+public class AsnInfo {\n+\n+    private Long asn;\n+    private String asName;\n+    private String orgId;\n+    private String orgName;\n+    private String address;\n+    private String city;\n+    private String stateProv;\n+    private String postalCode;\n+    private String country;\n+    private String source;\n+    private String rawOutput;\n+    private String remarks;\n+\n+    public AsnInfo(Long asn, String source, String rawOutput) {\n+        this.asn = asn;\n+        this.source = source;\n+        this.rawOutput = rawOutput;\n+    }\n+\n+    public Long getAsn() {\n+        return asn;\n+    }\n+\n+    public void setAsn(Long asn) {\n+        this.asn = asn;\n+    }\n+\n+    public String getAsName() {\n+        return asName;\n+    }\n+\n+    public void setAsName(String asName) {\n+        this.asName = asName;\n+    }\n+\n+    public String getOrgId() {\n+        return orgId;\n+    }\n+\n+    public void setOrgId(String orgId) {\n+        this.orgId = orgId;\n+    }\n+\n+    public String getOrgName() {\n+        return orgName;\n+    }\n+\n+    public void setOrgName(String orgName) {\n+        this.orgName = orgName;\n+    }\n+\n+    public String getAddress() {\n+        return address;\n+    }\n+\n+    public void setAddress(String address) {\n+        this.address = address;\n+    }\n+\n+    public String getCity() {\n+        return city;\n+    }\n+\n+    public void setCity(String city) {\n+        this.city = city;\n+    }\n+\n+    public String getStateProv() {\n+        return stateProv;\n+    }\n+\n+    public void setStateProv(String stateProv) {\n+        this.stateProv = stateProv;\n+    }\n+\n+    public String getPostalCode() {\n+        return postalCode;\n+    }\n+\n+    public void setPostalCode(String postalCode) {\n+        this.postalCode = postalCode;\n+    }\n+\n+    public String getCountry() {\n+        return country;\n+    }\n+\n+    public void setCountry(String country) {\n+        this.country = country;\n+    }\n+\n+    public String getSource() {\n+        return source;\n+    }\n+\n+    public void setSource(String source) {\n+        this.source = source;\n+    }\n+\n+    public String getRawOutput() {\n+        return rawOutput;\n+    }\n+\n+    public void setRawOutput(String rawOutput) {\n+        this.rawOutput = rawOutput;\n+    }\n+\n+    public String getRemarks() {\n+        return remarks;\n+    }\n+\n+    public void setRemarks(String remarks) {\n+        this.remarks = remarks;\n+    }\n+\n+    public static AsnInfo parseOutput(Long asn, String source, String rawOutput) {\n+        AsnInfo asnInfo = new AsnInfo(asn, source, rawOutput);\n+        // Split output into lines\n+        String[] lines = rawOutput.split(\"\\\\r?\\\\n\");\n+        for (String line : lines) {", "originalCommit": "87f009bf7b4014d6c366485c93e794e694d72146", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDYxOTg0OA==", "url": "https://github.com/OpenNMS/opennms/pull/3239#discussion_r560619848", "bodyText": "yeah, OpenBMP has this handling for RIPE. I m looking for an example AS number to properly implement this.  Currently all the responses I'm getting are from ARIN and RTT.", "author": "cgorantla", "createdAt": "2021-01-20T01:50:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODIyNzAzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjAwMzIyNw==", "url": "https://github.com/OpenNMS/opennms/pull/3239#discussion_r562003227", "bodyText": "I updated few things but still didn't get an example for having Address in multiple lines even with RIPE. We can address this later if we find such scenarios.", "author": "cgorantla", "createdAt": "2021-01-21T16:07:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODIyNzAzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjQ2OTgyNQ==", "url": "https://github.com/OpenNMS/opennms/pull/3239#discussion_r562469825", "bodyText": "Ok", "author": "christianpape", "createdAt": "2021-01-22T08:39:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODIyNzAzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjcxMzQ4Mg==", "url": "https://github.com/OpenNMS/opennms/pull/3239#discussion_r562713482", "bodyText": "@cgorantla https://www.ripe.net/manage-ips-and-asns/db/support/querying-the-ripe-database has some examples showing multiple address lines. What do you need for testing? Maybe I can provide something.", "author": "fooker", "createdAt": "2021-01-22T15:33:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODIyNzAzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjcxNzg2MA==", "url": "https://github.com/OpenNMS/opennms/pull/3239#discussion_r562717860", "bodyText": "I was looking for an AS number that can give us output just like above example.\nWe need to split multiple address lines into  address, city,  state and country. I'm looking if there is any standard way to do that.", "author": "cgorantla", "createdAt": "2021-01-22T15:40:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODIyNzAzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mjc1Nzg4NA==", "url": "https://github.com/OpenNMS/opennms/pull/3239#discussion_r562757884", "bodyText": "My understanding of the code above is that it will overwrite with the last encountered address value. Maybe it would be more suitable to concatenate the multiple lines separated by \\n. Looks like that's what openbmp is doing: https://github.com/SNAS/openbmp-mysql-consumer/blob/master/cron_scripts/gen-whois/gen-whois-asn.py#L186 .\nThe reference code calls the whois command, which by default also fetches related entries. Maybe org.apache.commons.net.whois.WhoisClient does not do this?\nwhois -h whois.ripe.net AS8319 shows some output with multiple address lines.\nThis is not only true for the address field but for almost all fields (RIPE marks them as multiple in the link above).", "author": "fooker", "createdAt": "2021-01-22T16:39:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODIyNzAzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mjc5MjMxMw==", "url": "https://github.com/OpenNMS/opennms/pull/3239#discussion_r562792313", "bodyText": "Removing optional a with the query a AS8319 seems to give the output identical to whois client.  Updated code to append multiple lines in address/remarks/orgId as per link above.", "author": "cgorantla", "createdAt": "2021-01-22T17:34:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODIyNzAzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDU2NTUxNw==", "url": "https://github.com/OpenNMS/opennms/pull/3239#discussion_r564565517", "bodyText": "@fooker  This is taken care with dc3c5b6.  Can you take a look", "author": "cgorantla", "createdAt": "2021-01-26T14:45:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODIyNzAzMA=="}], "type": "inlineReview"}, {"oid": "9b529b5e499a96ec8c6087694bd59c3e5911fe9c", "url": "https://github.com/OpenNMS/opennms/commit/9b529b5e499a96ec8c6087694bd59c3e5911fe9c", "message": "NMS-12963: Handle review comments", "committedDate": "2021-01-20T01:46:41Z", "type": "forcePushed"}, {"oid": "d0e49e8b033f585eab78160db5fa6e83a25e6b01", "url": "https://github.com/OpenNMS/opennms/commit/d0e49e8b033f585eab78160db5fa6e83a25e6b01", "message": "NMS-12963: Handle review comments", "committedDate": "2021-01-21T16:04:56Z", "type": "commit"}, {"oid": "d0e49e8b033f585eab78160db5fa6e83a25e6b01", "url": "https://github.com/OpenNMS/opennms/commit/d0e49e8b033f585eab78160db5fa6e83a25e6b01", "message": "NMS-12963: Handle review comments", "committedDate": "2021-01-21T16:04:56Z", "type": "forcePushed"}, {"oid": "dc3c5b6fb7a86fc012d0719c2cdee6aba5cc34ff", "url": "https://github.com/OpenNMS/opennms/commit/dc3c5b6fb7a86fc012d0719c2cdee6aba5cc34ff", "message": "NMS-12963: Handle review comments\n\nremove a for AS query.\nHandle multiple lines in address/remarks/orgId", "committedDate": "2021-01-22T17:30:57Z", "type": "commit"}, {"oid": "34e49f4cb8ca5ba1010b4747a7497c82b11d5e0b", "url": "https://github.com/OpenNMS/opennms/commit/34e49f4cb8ca5ba1010b4747a7497c82b11d5e0b", "message": "Merge branch 'develop' into jira/NMS-12963", "committedDate": "2021-01-26T13:55:02Z", "type": "commit"}, {"oid": "89f2214ddb4c883f05780435c9ee9d051c9daf46", "url": "https://github.com/OpenNMS/opennms/commit/89f2214ddb4c883f05780435c9ee9d051c9daf46", "message": "Merge branch 'features/bmp' into jira/NMS-12963", "committedDate": "2021-01-26T13:55:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODQ5MDM1NQ==", "url": "https://github.com/OpenNMS/opennms/pull/3239#discussion_r568490355", "bodyText": "Can we have a test for this?", "author": "fooker", "createdAt": "2021-02-02T10:28:07Z", "path": "features/telemetry/protocols/bmp/adapter/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/adapter/BmpMessagePersister.java", "diffHunk": "@@ -540,6 +600,120 @@ private BmpGlobalIpRib buildGlobalIpRib(PrefixByAS prefixByAS) {\n \n     }\n \n+    private BmpAsnInfo fetchAndBuildAsnInfo(Long asn) {\n+        Optional<AsnInfo> asnInfoOptional = BmpWhoIsClient.getAsnInfo(asn);\n+        if (asnInfoOptional.isPresent()) {\n+            BmpAsnInfo bmpAsnInfo = new BmpAsnInfo();\n+            AsnInfo asnInfo = asnInfoOptional.get();\n+            bmpAsnInfo.setAsn(asnInfo.getAsn());\n+            bmpAsnInfo.setOrgId(asnInfo.getOrgId());\n+            bmpAsnInfo.setAsName(asnInfo.getAsName());\n+            bmpAsnInfo.setOrgName(asnInfo.getOrgName());\n+            bmpAsnInfo.setAddress(asnInfo.getAddress());\n+            bmpAsnInfo.setCity(asnInfo.getCity());\n+            bmpAsnInfo.setStateProv(asnInfo.getStateProv());\n+            bmpAsnInfo.setPostalCode(asnInfo.getPostalCode());\n+            bmpAsnInfo.setCountry(asnInfo.getCountry());\n+            bmpAsnInfo.setSource(asnInfo.getSource());\n+            bmpAsnInfo.setRawOutput(asnInfo.getRawOutput());\n+            bmpAsnInfo.setRemarks(asnInfo.getRemarks());\n+            bmpAsnInfo.setLastUpdated(Date.from(Instant.now()));\n+            return bmpAsnInfo;\n+        }\n+        return null;\n+    }\n+\n+    private BmpRouteInfo fetchAndBuildRouteInfo(String prefix) {\n+        Optional<RouteInfo> routeInfoOptional = BmpWhoIsClient.getRouteInfo(prefix);\n+        if (routeInfoOptional.isPresent() && routeInfoOptional.get().getPrefix() != null) {\n+            RouteInfo routeInfo = routeInfoOptional.get();\n+            Integer prefixLen = routeInfo.getPrefixLen();\n+            Long originAs = routeInfo.getOriginAs();\n+            BmpRouteInfo bmpRouteInfo = bmpRouteInfoDao.findByPrefix(routeInfo.getPrefix(), prefixLen, originAs);\n+            if (bmpRouteInfo == null) {\n+                bmpRouteInfo = new BmpRouteInfo();\n+                bmpRouteInfo.setPrefix(routeInfo.getPrefix());\n+                bmpRouteInfo.setPrefixLen(routeInfo.getPrefixLen());\n+                bmpRouteInfo.setDescr(routeInfo.getDescription());\n+                bmpRouteInfo.setOriginAs(routeInfo.getOriginAs());\n+                bmpRouteInfo.setSource(routeInfo.getSource());\n+            }\n+            bmpRouteInfo.setLastUpdated(Date.from(Instant.now()));\n+            return bmpRouteInfo;\n+        }\n+        return null;\n+    }\n+\n+    private List<BmpAsnPathAnalysis> buildBmpAsnPath(String asnPath) {", "originalCommit": "89f2214ddb4c883f05780435c9ee9d051c9daf46", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQzNTA3MA==", "url": "https://github.com/OpenNMS/opennms/pull/3239#discussion_r569435070", "bodyText": "Simplified this and added a test case for expected output.", "author": "cgorantla", "createdAt": "2021-02-03T14:01:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODQ5MDM1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODQ5MTY2NQ==", "url": "https://github.com/OpenNMS/opennms/pull/3239#discussion_r568491665", "bodyText": "This code path is never taken if i == 0 because asn will always be 0 on the first iteration.", "author": "fooker", "createdAt": "2021-02-02T10:29:58Z", "path": "features/telemetry/protocols/bmp/adapter/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/adapter/BmpMessagePersister.java", "diffHunk": "@@ -540,6 +600,120 @@ private BmpGlobalIpRib buildGlobalIpRib(PrefixByAS prefixByAS) {\n \n     }\n \n+    private BmpAsnInfo fetchAndBuildAsnInfo(Long asn) {\n+        Optional<AsnInfo> asnInfoOptional = BmpWhoIsClient.getAsnInfo(asn);\n+        if (asnInfoOptional.isPresent()) {\n+            BmpAsnInfo bmpAsnInfo = new BmpAsnInfo();\n+            AsnInfo asnInfo = asnInfoOptional.get();\n+            bmpAsnInfo.setAsn(asnInfo.getAsn());\n+            bmpAsnInfo.setOrgId(asnInfo.getOrgId());\n+            bmpAsnInfo.setAsName(asnInfo.getAsName());\n+            bmpAsnInfo.setOrgName(asnInfo.getOrgName());\n+            bmpAsnInfo.setAddress(asnInfo.getAddress());\n+            bmpAsnInfo.setCity(asnInfo.getCity());\n+            bmpAsnInfo.setStateProv(asnInfo.getStateProv());\n+            bmpAsnInfo.setPostalCode(asnInfo.getPostalCode());\n+            bmpAsnInfo.setCountry(asnInfo.getCountry());\n+            bmpAsnInfo.setSource(asnInfo.getSource());\n+            bmpAsnInfo.setRawOutput(asnInfo.getRawOutput());\n+            bmpAsnInfo.setRemarks(asnInfo.getRemarks());\n+            bmpAsnInfo.setLastUpdated(Date.from(Instant.now()));\n+            return bmpAsnInfo;\n+        }\n+        return null;\n+    }\n+\n+    private BmpRouteInfo fetchAndBuildRouteInfo(String prefix) {\n+        Optional<RouteInfo> routeInfoOptional = BmpWhoIsClient.getRouteInfo(prefix);\n+        if (routeInfoOptional.isPresent() && routeInfoOptional.get().getPrefix() != null) {\n+            RouteInfo routeInfo = routeInfoOptional.get();\n+            Integer prefixLen = routeInfo.getPrefixLen();\n+            Long originAs = routeInfo.getOriginAs();\n+            BmpRouteInfo bmpRouteInfo = bmpRouteInfoDao.findByPrefix(routeInfo.getPrefix(), prefixLen, originAs);\n+            if (bmpRouteInfo == null) {\n+                bmpRouteInfo = new BmpRouteInfo();\n+                bmpRouteInfo.setPrefix(routeInfo.getPrefix());\n+                bmpRouteInfo.setPrefixLen(routeInfo.getPrefixLen());\n+                bmpRouteInfo.setDescr(routeInfo.getDescription());\n+                bmpRouteInfo.setOriginAs(routeInfo.getOriginAs());\n+                bmpRouteInfo.setSource(routeInfo.getSource());\n+            }\n+            bmpRouteInfo.setLastUpdated(Date.from(Instant.now()));\n+            return bmpRouteInfo;\n+        }\n+        return null;\n+    }\n+\n+    private List<BmpAsnPathAnalysis> buildBmpAsnPath(String asnPath) {\n+\n+        List<BmpAsnPathAnalysis> bmpAsnPathAnalyses = new ArrayList<>();\n+        String[] asnArray = asnPath.split(\" \");\n+\n+        Long leftAsn = 0L;\n+        Long rightAsn = 0L;\n+        Long asn = 0L;\n+        for (int i = 0; i < asnArray.length; i++) {\n+            if (asnArray[i].length() <= 0)\n+                break;\n+\n+            try {\n+                asn = Long.valueOf(asnArray[i]);\n+            } catch (NumberFormatException e) {\n+                e.printStackTrace();\n+                break;\n+            }\n+\n+            if (asn > 0) {\n+                if (i + 1 < asnArray.length) {\n+\n+                    if (asnArray[i + 1].length() <= 0)\n+                        break;\n+\n+                    try {\n+                        rightAsn = Long.valueOf(asnArray[i + 1]);\n+\n+                    } catch (NumberFormatException e) {\n+                        e.printStackTrace();\n+                        break;\n+                    }\n+\n+                    if (rightAsn.equals(asn)) {\n+                        continue;\n+                    }\n+\n+                    Boolean isPeeringAsn = (i == 0 || i == 1) ? TRUE : FALSE;", "originalCommit": "89f2214ddb4c883f05780435c9ee9d051c9daf46", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODQ5Mzc5NA==", "url": "https://github.com/OpenNMS/opennms/pull/3239#discussion_r568493794", "bodyText": "Why not parse the ASNs into longs here? this would save some error handling in the loop.\nBy doing so, we can skip the whole update if the path in invalid.", "author": "fooker", "createdAt": "2021-02-02T10:33:12Z", "path": "features/telemetry/protocols/bmp/adapter/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/adapter/BmpMessagePersister.java", "diffHunk": "@@ -540,6 +600,120 @@ private BmpGlobalIpRib buildGlobalIpRib(PrefixByAS prefixByAS) {\n \n     }\n \n+    private BmpAsnInfo fetchAndBuildAsnInfo(Long asn) {\n+        Optional<AsnInfo> asnInfoOptional = BmpWhoIsClient.getAsnInfo(asn);\n+        if (asnInfoOptional.isPresent()) {\n+            BmpAsnInfo bmpAsnInfo = new BmpAsnInfo();\n+            AsnInfo asnInfo = asnInfoOptional.get();\n+            bmpAsnInfo.setAsn(asnInfo.getAsn());\n+            bmpAsnInfo.setOrgId(asnInfo.getOrgId());\n+            bmpAsnInfo.setAsName(asnInfo.getAsName());\n+            bmpAsnInfo.setOrgName(asnInfo.getOrgName());\n+            bmpAsnInfo.setAddress(asnInfo.getAddress());\n+            bmpAsnInfo.setCity(asnInfo.getCity());\n+            bmpAsnInfo.setStateProv(asnInfo.getStateProv());\n+            bmpAsnInfo.setPostalCode(asnInfo.getPostalCode());\n+            bmpAsnInfo.setCountry(asnInfo.getCountry());\n+            bmpAsnInfo.setSource(asnInfo.getSource());\n+            bmpAsnInfo.setRawOutput(asnInfo.getRawOutput());\n+            bmpAsnInfo.setRemarks(asnInfo.getRemarks());\n+            bmpAsnInfo.setLastUpdated(Date.from(Instant.now()));\n+            return bmpAsnInfo;\n+        }\n+        return null;\n+    }\n+\n+    private BmpRouteInfo fetchAndBuildRouteInfo(String prefix) {\n+        Optional<RouteInfo> routeInfoOptional = BmpWhoIsClient.getRouteInfo(prefix);\n+        if (routeInfoOptional.isPresent() && routeInfoOptional.get().getPrefix() != null) {\n+            RouteInfo routeInfo = routeInfoOptional.get();\n+            Integer prefixLen = routeInfo.getPrefixLen();\n+            Long originAs = routeInfo.getOriginAs();\n+            BmpRouteInfo bmpRouteInfo = bmpRouteInfoDao.findByPrefix(routeInfo.getPrefix(), prefixLen, originAs);\n+            if (bmpRouteInfo == null) {\n+                bmpRouteInfo = new BmpRouteInfo();\n+                bmpRouteInfo.setPrefix(routeInfo.getPrefix());\n+                bmpRouteInfo.setPrefixLen(routeInfo.getPrefixLen());\n+                bmpRouteInfo.setDescr(routeInfo.getDescription());\n+                bmpRouteInfo.setOriginAs(routeInfo.getOriginAs());\n+                bmpRouteInfo.setSource(routeInfo.getSource());\n+            }\n+            bmpRouteInfo.setLastUpdated(Date.from(Instant.now()));\n+            return bmpRouteInfo;\n+        }\n+        return null;\n+    }\n+\n+    private List<BmpAsnPathAnalysis> buildBmpAsnPath(String asnPath) {\n+\n+        List<BmpAsnPathAnalysis> bmpAsnPathAnalyses = new ArrayList<>();\n+        String[] asnArray = asnPath.split(\" \");", "originalCommit": "89f2214ddb4c883f05780435c9ee9d051c9daf46", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODQ5NTg3Nw==", "url": "https://github.com/OpenNMS/opennms/pull/3239#discussion_r568495877", "bodyText": "The loop can be simplified by iterating from i = 1 to i = asnArray.length - . The  you can use i-1 and i+1 for left and right ASN inside the loop.\nIn addition, the Origin AS handling can be done out of loop at the end.", "author": "fooker", "createdAt": "2021-02-02T10:36:23Z", "path": "features/telemetry/protocols/bmp/adapter/src/main/java/org/opennms/netmgt/telemetry/protocols/bmp/adapter/BmpMessagePersister.java", "diffHunk": "@@ -540,6 +600,120 @@ private BmpGlobalIpRib buildGlobalIpRib(PrefixByAS prefixByAS) {\n \n     }\n \n+    private BmpAsnInfo fetchAndBuildAsnInfo(Long asn) {\n+        Optional<AsnInfo> asnInfoOptional = BmpWhoIsClient.getAsnInfo(asn);\n+        if (asnInfoOptional.isPresent()) {\n+            BmpAsnInfo bmpAsnInfo = new BmpAsnInfo();\n+            AsnInfo asnInfo = asnInfoOptional.get();\n+            bmpAsnInfo.setAsn(asnInfo.getAsn());\n+            bmpAsnInfo.setOrgId(asnInfo.getOrgId());\n+            bmpAsnInfo.setAsName(asnInfo.getAsName());\n+            bmpAsnInfo.setOrgName(asnInfo.getOrgName());\n+            bmpAsnInfo.setAddress(asnInfo.getAddress());\n+            bmpAsnInfo.setCity(asnInfo.getCity());\n+            bmpAsnInfo.setStateProv(asnInfo.getStateProv());\n+            bmpAsnInfo.setPostalCode(asnInfo.getPostalCode());\n+            bmpAsnInfo.setCountry(asnInfo.getCountry());\n+            bmpAsnInfo.setSource(asnInfo.getSource());\n+            bmpAsnInfo.setRawOutput(asnInfo.getRawOutput());\n+            bmpAsnInfo.setRemarks(asnInfo.getRemarks());\n+            bmpAsnInfo.setLastUpdated(Date.from(Instant.now()));\n+            return bmpAsnInfo;\n+        }\n+        return null;\n+    }\n+\n+    private BmpRouteInfo fetchAndBuildRouteInfo(String prefix) {\n+        Optional<RouteInfo> routeInfoOptional = BmpWhoIsClient.getRouteInfo(prefix);\n+        if (routeInfoOptional.isPresent() && routeInfoOptional.get().getPrefix() != null) {\n+            RouteInfo routeInfo = routeInfoOptional.get();\n+            Integer prefixLen = routeInfo.getPrefixLen();\n+            Long originAs = routeInfo.getOriginAs();\n+            BmpRouteInfo bmpRouteInfo = bmpRouteInfoDao.findByPrefix(routeInfo.getPrefix(), prefixLen, originAs);\n+            if (bmpRouteInfo == null) {\n+                bmpRouteInfo = new BmpRouteInfo();\n+                bmpRouteInfo.setPrefix(routeInfo.getPrefix());\n+                bmpRouteInfo.setPrefixLen(routeInfo.getPrefixLen());\n+                bmpRouteInfo.setDescr(routeInfo.getDescription());\n+                bmpRouteInfo.setOriginAs(routeInfo.getOriginAs());\n+                bmpRouteInfo.setSource(routeInfo.getSource());\n+            }\n+            bmpRouteInfo.setLastUpdated(Date.from(Instant.now()));\n+            return bmpRouteInfo;\n+        }\n+        return null;\n+    }\n+\n+    private List<BmpAsnPathAnalysis> buildBmpAsnPath(String asnPath) {\n+\n+        List<BmpAsnPathAnalysis> bmpAsnPathAnalyses = new ArrayList<>();\n+        String[] asnArray = asnPath.split(\" \");\n+\n+        Long leftAsn = 0L;\n+        Long rightAsn = 0L;\n+        Long asn = 0L;\n+        for (int i = 0; i < asnArray.length; i++) {", "originalCommit": "89f2214ddb4c883f05780435c9ee9d051c9daf46", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "15b6f07c83165fa93cd0c8129ccfedffd08e4973", "url": "https://github.com/OpenNMS/opennms/commit/15b6f07c83165fa93cd0c8129ccfedffd08e4973", "message": "NMS-12963: Handle review comments", "committedDate": "2021-02-03T13:59:03Z", "type": "commit"}]}