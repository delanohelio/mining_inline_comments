{"pr_number": 2999, "pr_title": "NMS-12684: Added upgrade task to enable RemotePollerNG", "pr_createdAt": "2020-05-06T14:16:33Z", "pr_url": "https://github.com/OpenNMS/opennms/pull/2999", "timeline": [{"oid": "59ee090d17a8db724a28edff3e35642f37f1bb8e", "url": "https://github.com/OpenNMS/opennms/commit/59ee090d17a8db724a28edff3e35642f37f1bb8e", "message": "NMS-12684: Added upgrade task to enable RemotePollerNG", "committedDate": "2020-05-05T16:39:25Z", "type": "commit"}, {"oid": "6569954f9c80a60a5a75e1836058f0fdbfd6e42f", "url": "https://github.com/OpenNMS/opennms/commit/6569954f9c80a60a5a75e1836058f0fdbfd6e42f", "message": "Merge branch 'features/rpwm' into jira/NMS-12684", "committedDate": "2020-05-06T14:14:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ3MDgzMQ==", "url": "https://github.com/OpenNMS/opennms/pull/2999#discussion_r422470831", "bodyText": "deprecated vs existing", "author": "fooker", "createdAt": "2020-05-09T08:45:31Z", "path": "core/upgrade/src/main/java/org/opennms/upgrade/implementations/RemotePollerServiceConfigMigratorOffline.java", "diffHunk": "@@ -0,0 +1,177 @@\n+/*******************************************************************************\n+ * This file is part of OpenNMS(R).\n+ *\n+ * Copyright (C) 2020 The OpenNMS Group, Inc.\n+ * OpenNMS(R) is Copyright (C) 1999-2020 The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is a registered trademark of The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Affero General Public License as published\n+ * by the Free Software Foundation, either version 3 of the License,\n+ * or (at your option) any later version.\n+ *\n+ * OpenNMS(R) is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU Affero General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with OpenNMS(R).  If not, see:\n+ *      http://www.gnu.org/licenses/\n+ *\n+ * For more information contact:\n+ *     OpenNMS(R) Licensing <license@opennms.org>\n+ *     http://www.opennms.org/\n+ *     http://www.opennms.com/\n+ *******************************************************************************/\n+\n+package org.opennms.upgrade.implementations;\n+\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.io.StringWriter;\n+import java.util.Collections;\n+\n+import org.apache.commons.io.FileUtils;\n+import org.opennms.core.utils.ConfigFileConstants;\n+import org.opennms.core.xml.JaxbUtils;\n+import org.opennms.netmgt.config.service.Attribute;\n+import org.opennms.netmgt.config.service.Invoke;\n+import org.opennms.netmgt.config.service.InvokeAtType;\n+import org.opennms.netmgt.config.service.Service;\n+import org.opennms.netmgt.config.service.ServiceConfiguration;\n+import org.opennms.upgrade.api.AbstractOnmsUpgrade;\n+import org.opennms.upgrade.api.OnmsUpgradeException;\n+\n+import com.google.common.collect.Lists;\n+\n+public class RemotePollerServiceConfigMigratorOffline extends AbstractOnmsUpgrade {\n+\n+    private File configFile;\n+\n+    public static final String DEPRECATED_REMOTE_POLLER_SERVICENAME = \"OpenNMS:Name=PollerBackEnd\";\n+    public static final String REMOTE_POLLER_NG_SERVICENAME = \"OpenNMS:Name=RemotePollerNG\";\n+\n+    public RemotePollerServiceConfigMigratorOffline() throws OnmsUpgradeException {\n+        super();\n+        try {\n+            configFile = ConfigFileConstants.getFile(ConfigFileConstants.SERVICE_CONF_FILE_NAME);\n+        } catch (final IOException e) {\n+            throw new OnmsUpgradeException(\"Can't find Services Configuration file\", e);\n+        }\n+    }\n+\n+    @Override\n+    public int getOrder() {\n+        return 14;\n+    }\n+\n+    @Override\n+    public String getDescription() {\n+        return \"Remove deprecated RemotePoller service entry from service-configuration.xml, see NMS-12684\";\n+    }\n+\n+    @Override\n+    public void preExecute() throws OnmsUpgradeException {\n+        try {\n+            log(\"Creating backup of %s\\n\", configFile);\n+            zipFile(configFile);\n+        } catch (Exception e) {\n+            throw new OnmsUpgradeException(\"Can't backup service-configurations.xml because \" + e.getMessage());\n+        }\n+\n+    }\n+\n+    @Override\n+    public void postExecute() throws OnmsUpgradeException {\n+        File zip = new File(configFile.getAbsolutePath() + ZIP_EXT);\n+        if (zip.exists()) {\n+            log(\"Removing backup %s\\n\", zip);\n+            FileUtils.deleteQuietly(zip);\n+        }\n+    }\n+\n+    @Override\n+    public void rollback() throws OnmsUpgradeException {\n+        log(\"Restoring backup %s\\n\", configFile);\n+        File zip = new File(configFile.getAbsolutePath() + ZIP_EXT);\n+        FileUtils.deleteQuietly(configFile);\n+        unzipFile(zip, zip.getParentFile());\n+    }\n+\n+    @Override\n+    public void execute() throws OnmsUpgradeException {\n+        try {\n+            final ServiceConfiguration currentCfg = JaxbUtils.unmarshal(ServiceConfiguration.class, configFile);\n+            boolean skipRemovePollerNgEntryCreation = false;\n+            boolean deprecatedServiceEnabled = true;\n+\n+            log(\"Current configuration: \" + currentCfg.getServices().size() + \" services.\\n\");\n+\n+            for (int i = currentCfg.getServices().size() - 1; i >= 0; i--) {\n+                final Service localSvc = currentCfg.getServices().get(i);\n+                final String name = localSvc.getName();\n+\n+                if (DEPRECATED_REMOTE_POLLER_SERVICENAME.equals(name)) {\n+                    // Perhaps the administrator has intentionally disabled it, so RemotePollerNg should only be\n+                    // enabled if deprecated RemotePoller was enabled. If no entry was found this value defaults to true.\n+                    deprecatedServiceEnabled = localSvc.isEnabled();\n+\n+                    // remote the entry from the configuration\n+                    currentCfg.getServices().remove(i);\n+                    log(\"Removing deprecated '%s' entry\\n\", DEPRECATED_REMOTE_POLLER_SERVICENAME);\n+                }\n+\n+\n+                if (REMOTE_POLLER_NG_SERVICENAME.equals(name)) {\n+                    // if a deprecated RemotePollerNg entry exists, do not touch it's configuration", "originalCommit": "6569954f9c80a60a5a75e1836058f0fdbfd6e42f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjYxNjExMg==", "url": "https://github.com/OpenNMS/opennms/pull/2999#discussion_r422616112", "bodyText": "ok", "author": "christianpape", "createdAt": "2020-05-10T09:19:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ3MDgzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ3MTA3NA==", "url": "https://github.com/OpenNMS/opennms/pull/2999#discussion_r422471074", "bodyText": "for (final Service localSvc : Lists.reverse(currentCfg.getServices())) { looks more modern", "author": "fooker", "createdAt": "2020-05-09T08:48:37Z", "path": "core/upgrade/src/main/java/org/opennms/upgrade/implementations/RemotePollerServiceConfigMigratorOffline.java", "diffHunk": "@@ -0,0 +1,177 @@\n+/*******************************************************************************\n+ * This file is part of OpenNMS(R).\n+ *\n+ * Copyright (C) 2020 The OpenNMS Group, Inc.\n+ * OpenNMS(R) is Copyright (C) 1999-2020 The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is a registered trademark of The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Affero General Public License as published\n+ * by the Free Software Foundation, either version 3 of the License,\n+ * or (at your option) any later version.\n+ *\n+ * OpenNMS(R) is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU Affero General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with OpenNMS(R).  If not, see:\n+ *      http://www.gnu.org/licenses/\n+ *\n+ * For more information contact:\n+ *     OpenNMS(R) Licensing <license@opennms.org>\n+ *     http://www.opennms.org/\n+ *     http://www.opennms.com/\n+ *******************************************************************************/\n+\n+package org.opennms.upgrade.implementations;\n+\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.io.StringWriter;\n+import java.util.Collections;\n+\n+import org.apache.commons.io.FileUtils;\n+import org.opennms.core.utils.ConfigFileConstants;\n+import org.opennms.core.xml.JaxbUtils;\n+import org.opennms.netmgt.config.service.Attribute;\n+import org.opennms.netmgt.config.service.Invoke;\n+import org.opennms.netmgt.config.service.InvokeAtType;\n+import org.opennms.netmgt.config.service.Service;\n+import org.opennms.netmgt.config.service.ServiceConfiguration;\n+import org.opennms.upgrade.api.AbstractOnmsUpgrade;\n+import org.opennms.upgrade.api.OnmsUpgradeException;\n+\n+import com.google.common.collect.Lists;\n+\n+public class RemotePollerServiceConfigMigratorOffline extends AbstractOnmsUpgrade {\n+\n+    private File configFile;\n+\n+    public static final String DEPRECATED_REMOTE_POLLER_SERVICENAME = \"OpenNMS:Name=PollerBackEnd\";\n+    public static final String REMOTE_POLLER_NG_SERVICENAME = \"OpenNMS:Name=RemotePollerNG\";\n+\n+    public RemotePollerServiceConfigMigratorOffline() throws OnmsUpgradeException {\n+        super();\n+        try {\n+            configFile = ConfigFileConstants.getFile(ConfigFileConstants.SERVICE_CONF_FILE_NAME);\n+        } catch (final IOException e) {\n+            throw new OnmsUpgradeException(\"Can't find Services Configuration file\", e);\n+        }\n+    }\n+\n+    @Override\n+    public int getOrder() {\n+        return 14;\n+    }\n+\n+    @Override\n+    public String getDescription() {\n+        return \"Remove deprecated RemotePoller service entry from service-configuration.xml, see NMS-12684\";\n+    }\n+\n+    @Override\n+    public void preExecute() throws OnmsUpgradeException {\n+        try {\n+            log(\"Creating backup of %s\\n\", configFile);\n+            zipFile(configFile);\n+        } catch (Exception e) {\n+            throw new OnmsUpgradeException(\"Can't backup service-configurations.xml because \" + e.getMessage());\n+        }\n+\n+    }\n+\n+    @Override\n+    public void postExecute() throws OnmsUpgradeException {\n+        File zip = new File(configFile.getAbsolutePath() + ZIP_EXT);\n+        if (zip.exists()) {\n+            log(\"Removing backup %s\\n\", zip);\n+            FileUtils.deleteQuietly(zip);\n+        }\n+    }\n+\n+    @Override\n+    public void rollback() throws OnmsUpgradeException {\n+        log(\"Restoring backup %s\\n\", configFile);\n+        File zip = new File(configFile.getAbsolutePath() + ZIP_EXT);\n+        FileUtils.deleteQuietly(configFile);\n+        unzipFile(zip, zip.getParentFile());\n+    }\n+\n+    @Override\n+    public void execute() throws OnmsUpgradeException {\n+        try {\n+            final ServiceConfiguration currentCfg = JaxbUtils.unmarshal(ServiceConfiguration.class, configFile);\n+            boolean skipRemovePollerNgEntryCreation = false;\n+            boolean deprecatedServiceEnabled = true;\n+\n+            log(\"Current configuration: \" + currentCfg.getServices().size() + \" services.\\n\");\n+\n+            for (int i = currentCfg.getServices().size() - 1; i >= 0; i--) {", "originalCommit": "6569954f9c80a60a5a75e1836058f0fdbfd6e42f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0ac099f46d016f7720718dacf797d18ce43bbfa4", "url": "https://github.com/OpenNMS/opennms/commit/0ac099f46d016f7720718dacf797d18ce43bbfa4", "message": "NMS-12684: Review changes", "committedDate": "2020-05-10T09:19:42Z", "type": "commit"}]}