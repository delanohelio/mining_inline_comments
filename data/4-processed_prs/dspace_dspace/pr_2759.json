{"pr_number": 2759, "pr_title": "DS-4499 Fix cleanup of test environment in earlier Integration Test", "pr_createdAt": "2020-05-11T13:34:49Z", "pr_url": "https://github.com/DSpace/DSpace/pull/2759", "timeline": [{"oid": "1c4a43c36e5893a6d1743eef4e022fbc41b220e1", "url": "https://github.com/DSpace/DSpace/commit/1c4a43c36e5893a6d1743eef4e022fbc41b220e1", "message": "added context.restoreAuthSystemState(), where was missing", "committedDate": "2020-05-06T11:43:23Z", "type": "commit"}, {"oid": "c21ef22290b195c83353f1c4664cbade83f6abe5", "url": "https://github.com/DSpace/DSpace/commit/c21ef22290b195c83353f1c4664cbade83f6abe5", "message": "fixed error", "committedDate": "2020-05-06T12:23:35Z", "type": "commit"}, {"oid": "8c9e809f8fd425f9dbe4078a271380b49cb8ab52", "url": "https://github.com/DSpace/DSpace/commit/8c9e809f8fd425f9dbe4078a271380b49cb8ab52", "message": "added context.restoreAuthSystemState() and delete static methods", "committedDate": "2020-05-06T13:34:25Z", "type": "commit"}, {"oid": "a975daa1dbc43f6fade28ce355d0645acd34b203", "url": "https://github.com/DSpace/DSpace/commit/a975daa1dbc43f6fade28ce355d0645acd34b203", "message": "removed unused dipendensies", "committedDate": "2020-05-06T13:35:50Z", "type": "commit"}, {"oid": "3b22efd05dfc2310a6f69b2671d5d433fe1ca81e", "url": "https://github.com/DSpace/DSpace/commit/3b22efd05dfc2310a6f69b2671d5d433fe1ca81e", "message": "refactored RelationshipRestRepositoryIT", "committedDate": "2020-05-06T15:20:34Z", "type": "commit"}, {"oid": "f91724dbff1fcca593a4874edab5a9e4a41d4008", "url": "https://github.com/DSpace/DSpace/commit/f91724dbff1fcca593a4874edab5a9e4a41d4008", "message": "cleanup of test environment", "committedDate": "2020-05-07T07:23:04Z", "type": "commit"}, {"oid": "a2e617521ad9fceabbef863980961f0795809a2d", "url": "https://github.com/DSpace/DSpace/commit/a2e617521ad9fceabbef863980961f0795809a2d", "message": "cleanup of test environment in WorkspaceItemRestRepositoryIT and WorkflowItemRestRepositoryIT", "committedDate": "2020-05-07T09:03:50Z", "type": "commit"}, {"oid": "95d089a306ce08939a62a9f782e82b832e533d93", "url": "https://github.com/DSpace/DSpace/commit/95d089a306ce08939a62a9f782e82b832e533d93", "message": "cleanup of CollectionRestRepositoryIT and ItemRestRepositoryIT", "committedDate": "2020-05-07T11:26:45Z", "type": "commit"}, {"oid": "47411d8614ff0dc1417e33a86573799e4d00fb71", "url": "https://github.com/DSpace/DSpace/commit/47411d8614ff0dc1417e33a86573799e4d00fb71", "message": "cleanup of CollectionGroupRestControllerIT and CommunityAdminGroupRestControllerIT", "committedDate": "2020-05-07T17:48:19Z", "type": "commit"}, {"oid": "6c24ff84ad5f16c0bd18d5ae36ea18c5d1943384", "url": "https://github.com/DSpace/DSpace/commit/6c24ff84ad5f16c0bd18d5ae36ea18c5d1943384", "message": "added deleteAdminGroup method for cleanup in CommunityBuilder", "committedDate": "2020-05-07T21:16:18Z", "type": "commit"}, {"oid": "7fc6f6cc325e072834bf7a05b4181079d077d269", "url": "https://github.com/DSpace/DSpace/commit/7fc6f6cc325e072834bf7a05b4181079d077d269", "message": "refactoring of some builder classes", "committedDate": "2020-05-08T09:48:37Z", "type": "commit"}, {"oid": "f0ec92dafbc08358c5ce3dc967503f59a79e5022", "url": "https://github.com/DSpace/DSpace/commit/f0ec92dafbc08358c5ce3dc967503f59a79e5022", "message": "refactoring of the cleanup method in Builder classes", "committedDate": "2020-05-11T10:53:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUxODgxNA==", "url": "https://github.com/DSpace/DSpace/pull/2759#discussion_r423518814", "bodyText": "@Micheleboychuk remove this commented out method", "author": "abollini", "createdAt": "2020-05-12T07:27:56Z", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/builder/AbstractDSpaceObjectBuilder.java", "diffHunk": "@@ -233,17 +233,25 @@ protected AbstractDSpaceObjectBuilder(Context context) {\n \n     public abstract T build() throws SQLException, AuthorizeException;\n \n-    public void delete(T dso) throws Exception {\n+//    public void delete(T dso) throws Exception {", "originalCommit": "f0ec92dafbc08358c5ce3dc967503f59a79e5022", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyMDcyMA==", "url": "https://github.com/DSpace/DSpace/pull/2759#discussion_r423520720", "bodyText": "for other reviewers please note this comment as it explains the need of the refactoring done in all the Builder about the cleanup process", "author": "abollini", "createdAt": "2020-05-12T07:31:16Z", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/CommunityAdminGroupRestControllerIT.java", "diffHunk": "@@ -138,6 +138,8 @@ public void postCommunityAdminGroupCreateAdminGroupSuccess() throws Exception {\n                         .andDo(result -> idRef\n                             .set(UUID.fromString(read(result.getResponse().getContentAsString(), \"$.id\")))\n                         );\n+        // no needs to explicitly cleanup the group created as the community comes", "originalCommit": "f0ec92dafbc08358c5ce3dc967503f59a79e5022", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyNzA1MQ==", "url": "https://github.com/DSpace/DSpace/pull/2759#discussion_r423527051", "bodyText": "This is a comment for other reviewers to explain the reasoning behind this change (and the same in all the other builder).\nIt is better to reload the primary object as this will guarantee us to access also fresh related objects during the cleanup, in this case the Admin Group.\nBefore, all the related objects where reloaded just before to be deleted (see previous implementeation of the deleteWorkflowGroups) but this approach have several issues:\n\nit is easy to forget about it, indeed when the deleteAdminGroup method was added the first time the build was failing due to that\ndoing that manually each time duplicate lot of code\nas you only reload the object that was attached to the \"old\" copy of the primary object you will fail to find related object created in outside thread. If the admin group has been created via a REST call collection.getAdministrators() run before the refresh of the community object would have returned null", "author": "abollini", "createdAt": "2020-05-12T07:42:49Z", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/builder/CollectionBuilder.java", "diffHunk": "@@ -164,58 +165,54 @@ public Collection build() {\n \n     @Override\n     public void cleanup() throws Exception {\n-        deleteAdminGroup();\n-        deleteDefaultReadGroups(collection);\n-        deleteWorkflowGroups(collection);\n-        delete(collection);\n-    }\n-\n-    private void deleteAdminGroup() throws SQLException, AuthorizeException {\n-        if (collection.getAdministrators() != null) {\n-            try (Context c = new Context()) {\n-                c.turnOffAuthorisationSystem();\n-                collectionService.removeAdministrators(c, collection);\n+       try (Context c = new Context()) {\n+            c.turnOffAuthorisationSystem();\n+            collection = c.reloadEntity(collection);", "originalCommit": "f0ec92dafbc08358c5ce3dc967503f59a79e5022", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg2MDg4MA==", "url": "https://github.com/DSpace/DSpace/pull/2759#discussion_r423860880", "bodyText": "Just a minor comment, I wonder if we should add a small inline comment here to remind ourselves why the reloadEntity is necessary. That way we don't accidentally refactor it out at a later time.\nWe could just say:\n// Ensure object and any related objects are reloaded before checking to see what needs cleanup", "author": "tdonohue", "createdAt": "2020-05-12T16:14:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyNzA1MQ=="}], "type": "inlineReview"}, {"oid": "8c5ff93bd9400f5fe0264c8f82eb59ec2e883eef", "url": "https://github.com/DSpace/DSpace/commit/8c5ff93bd9400f5fe0264c8f82eb59ec2e883eef", "message": "removed a note", "committedDate": "2020-05-12T08:04:43Z", "type": "commit"}, {"oid": "02a9a3f514f8db17593101885d6a4e96fc41e21e", "url": "https://github.com/DSpace/DSpace/commit/02a9a3f514f8db17593101885d6a4e96fc41e21e", "message": "Merge master into DS-4499-CleanupTestEnviroment", "committedDate": "2020-05-12T08:31:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg0OTI5MQ==", "url": "https://github.com/DSpace/DSpace/pull/2759#discussion_r423849291", "bodyText": "It looks like there's accidentally two context.restoreAuthSystemState() calls in this method now. This second one can be removed.", "author": "tdonohue", "createdAt": "2020-05-12T15:58:35Z", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/EPersonRestRepositoryIT.java", "diffHunk": "@@ -1523,6 +1535,8 @@ public void patchMultipleOperationsWithFailure() throws Exception {\n                                         .withEmail(\"Johndoe@example.com\")\n                                         .build();\n \n+        context.restoreAuthSystemState();\n+\n         String token = getAuthToken(admin.getEmail(), password);\n \n         context.restoreAuthSystemState();", "originalCommit": "02a9a3f514f8db17593101885d6a4e96fc41e21e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg1Nzg1NQ==", "url": "https://github.com/DSpace/DSpace/pull/2759#discussion_r423857855", "bodyText": "This method is misspelled.  It should be deleteBundle.  Obviously, you'll need to also cleanup the places it's used in ITs.", "author": "tdonohue", "createdAt": "2020-05-12T16:10:43Z", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/builder/BundleBuilder.java", "diffHunk": "@@ -67,4 +76,20 @@ public Bundle build() throws SQLException, AuthorizeException {\n \n         return bundle;\n     }\n+\n+    public static void deleteBundel(UUID uuid) throws SQLException, IOException {", "originalCommit": "02a9a3f514f8db17593101885d6a4e96fc41e21e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4ab860578d567c3712a74601fc29cf6d196137e5", "url": "https://github.com/DSpace/DSpace/commit/4ab860578d567c3712a74601fc29cf6d196137e5", "message": "Implement community feedbacks", "committedDate": "2020-05-13T16:36:42Z", "type": "commit"}, {"oid": "d462aa767600846eb16c8e0740dfb8223f6f1a2d", "url": "https://github.com/DSpace/DSpace/commit/d462aa767600846eb16c8e0740dfb8223f6f1a2d", "message": "Implement community feedbacks", "committedDate": "2020-05-13T17:10:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzg3MzM4NA==", "url": "https://github.com/DSpace/DSpace/pull/2759#discussion_r427873384", "bodyText": "seems a risk to keep the context open?", "author": "benbosman", "createdAt": "2020-05-20T09:34:13Z", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/builder/BitstreamBuilder.java", "diffHunk": "@@ -152,7 +152,15 @@ public Bitstream build() {\n \n     @Override\n     public void cleanup() throws Exception {\n-        delete(bitstream);\n+       try (Context c = new Context()) {\n+            c.turnOffAuthorisationSystem();\n+            // Ensure object and any related objects are reloaded before checking to see what needs cleanup\n+            bitstream = c.reloadEntity(bitstream);\n+            if (bitstream != null) {\n+                delete(c, bitstream);\n+                c.complete();", "originalCommit": "d462aa767600846eb16c8e0740dfb8223f6f1a2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA1MDQ3Nw==", "url": "https://github.com/DSpace/DSpace/pull/2759#discussion_r428050477", "bodyText": "it uses the try-with-resource syntax (it is used also in other recent part of the sourcecode)\nhttps://docs.oracle.com/javase/tutorial/essential/exceptions/tryResourceClose.html", "author": "abollini", "createdAt": "2020-05-20T14:18:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzg3MzM4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzg3Mzc4Nw==", "url": "https://github.com/DSpace/DSpace/pull/2759#discussion_r427873787", "bodyText": "seems a risk to keep the context open, there are more such use cases below", "author": "benbosman", "createdAt": "2020-05-20T09:34:52Z", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/builder/BundleBuilder.java", "diffHunk": "@@ -51,7 +53,15 @@ public BundleBuilder withBitstream(Bitstream bitstream) {\n     }\n \n     public void cleanup() throws Exception {\n-        delete(bundle);\n+        try (Context c = new Context()) {\n+            c.turnOffAuthorisationSystem();\n+            // Ensure object and any related objects are reloaded before checking to see what needs cleanup\n+            bundle = c.reloadEntity(bundle);\n+            if (bundle != null) {\n+                delete(c, bundle);\n+                c.complete();", "originalCommit": "d462aa767600846eb16c8e0740dfb8223f6f1a2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA1MDU2OA==", "url": "https://github.com/DSpace/DSpace/pull/2759#discussion_r428050568", "bodyText": "it uses the try-with-resource syntax (it is used also in other recent part of the sourcecode)\nhttps://docs.oracle.com/javase/tutorial/essential/exceptions/tryResourceClose.html", "author": "abollini", "createdAt": "2020-05-20T14:18:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzg3Mzc4Nw=="}], "type": "inlineReview"}]}