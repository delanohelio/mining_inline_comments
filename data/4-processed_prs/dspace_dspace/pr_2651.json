{"pr_number": 2651, "pr_title": "Dspace 7 shibboleth (REST)", "pr_createdAt": "2020-01-23T13:36:40Z", "pr_url": "https://github.com/DSpace/DSpace/pull/2651", "timeline": [{"oid": "13482c2eb7fb5d6c16e66daebe60faf9bfd6180d", "url": "https://github.com/DSpace/DSpace/commit/13482c2eb7fb5d6c16e66daebe60faf9bfd6180d", "message": "Added a cookie with JWT to response", "committedDate": "2019-11-22T16:07:00Z", "type": "commit"}, {"oid": "abbf3f736194f864581bcc9bf289a8c9e6749f0c", "url": "https://github.com/DSpace/DSpace/commit/abbf3f736194f864581bcc9bf289a8c9e6749f0c", "message": "Handle redirect to client after shibboleth authentication succeded", "committedDate": "2019-11-22T16:07:13Z", "type": "commit"}, {"oid": "705c8879988883c411ae1e06bf90c397cd3dd031", "url": "https://github.com/DSpace/DSpace/commit/705c8879988883c411ae1e06bf90c397cd3dd031", "message": "Added login filter to /api/authn/shibboleth", "committedDate": "2019-11-22T16:07:23Z", "type": "commit"}, {"oid": "85e253bb9fa8f789cc091d182bf2d2d45a6c2bd4", "url": "https://github.com/DSpace/DSpace/commit/85e253bb9fa8f789cc091d182bf2d2d45a6c2bd4", "message": "Added shibboleth authentication filter", "committedDate": "2019-11-22T16:07:29Z", "type": "commit"}, {"oid": "8ce9c2d98fd46a26373acd645c0f0e6c5e5d1d47", "url": "https://github.com/DSpace/DSpace/commit/8ce9c2d98fd46a26373acd645c0f0e6c5e5d1d47", "message": "Chack if authentication cookie is present in Authentication Data", "committedDate": "2019-11-22T16:07:36Z", "type": "commit"}, {"oid": "ccb0efd2ea1260434dfa176b66535663b2a79de0", "url": "https://github.com/DSpace/DSpace/commit/ccb0efd2ea1260434dfa176b66535663b2a79de0", "message": "use X-Requested-With header if Referer is empty", "committedDate": "2019-11-22T16:07:41Z", "type": "commit"}, {"oid": "787e2bbc97c926f238cff3b18a7ec0ca70828f62", "url": "https://github.com/DSpace/DSpace/commit/787e2bbc97c926f238cff3b18a7ec0ca70828f62", "message": "Merge remote-tracking branch 'origin/master' into dspace-7-shibboleth", "committedDate": "2020-01-02T17:28:30Z", "type": "commit"}, {"oid": "4ce3c8cbda4b070b68673caefc4e70e91bfb8340", "url": "https://github.com/DSpace/DSpace/commit/4ce3c8cbda4b070b68673caefc4e70e91bfb8340", "message": "Fixed checkstyle violations", "committedDate": "2020-01-08T17:38:41Z", "type": "commit"}, {"oid": "10bbf8079b3f54be7b60d5ed973605dafb6d73b8", "url": "https://github.com/DSpace/DSpace/commit/10bbf8079b3f54be7b60d5ed973605dafb6d73b8", "message": "Retrieve token from cookie only when checking an authenticated eperson", "committedDate": "2020-01-09T11:08:55Z", "type": "commit"}, {"oid": "e5074004f4469f3268f6139e3a2e6e0996aace6f", "url": "https://github.com/DSpace/DSpace/commit/e5074004f4469f3268f6139e3a2e6e0996aace6f", "message": "Revert \"Retrieve token from cookie only when checking an authenticated eperson\"\n\nThis reverts commit 10bbf8079b3f54be7b60d5ed973605dafb6d73b8.", "committedDate": "2020-01-09T12:11:22Z", "type": "commit"}, {"oid": "1e1de3c2e9d94bfae9e1fde1a075fb3917a4de37", "url": "https://github.com/DSpace/DSpace/commit/1e1de3c2e9d94bfae9e1fde1a075fb3917a4de37", "message": "Add authorization cookie only in ShibbolethAuthenticationFilter", "committedDate": "2020-01-09T12:41:43Z", "type": "commit"}, {"oid": "44210f92edcd5e5dddf1a95bc90dcd68619fd3b2", "url": "https://github.com/DSpace/DSpace/commit/44210f92edcd5e5dddf1a95bc90dcd68619fd3b2", "message": "Fixed AuthenticationRestControllerIT", "committedDate": "2020-01-09T14:20:34Z", "type": "commit"}, {"oid": "bbfc373bdc24e795a9cf596084051283e3169108", "url": "https://github.com/DSpace/DSpace/commit/bbfc373bdc24e795a9cf596084051283e3169108", "message": "Fixed checkstyle violations", "committedDate": "2020-01-09T14:58:17Z", "type": "commit"}, {"oid": "bf1e9780d4e39eb3dabe6b48aabdd40d772bb41b", "url": "https://github.com/DSpace/DSpace/commit/bf1e9780d4e39eb3dabe6b48aabdd40d772bb41b", "message": "Invalidate authorization cookie on logout", "committedDate": "2020-01-09T15:29:55Z", "type": "commit"}, {"oid": "64bc25f7c9f9e03f878809982235022bbe3af339", "url": "https://github.com/DSpace/DSpace/commit/64bc25f7c9f9e03f878809982235022bbe3af339", "message": "add context commit after invalidating token", "committedDate": "2020-01-09T17:04:42Z", "type": "commit"}, {"oid": "2a1cb37bbdec5187cdb3096fa6bb4436935a2ac8", "url": "https://github.com/DSpace/DSpace/commit/2a1cb37bbdec5187cdb3096fa6bb4436935a2ac8", "message": "Revert \"add context commit after invalidating token\"\n\nThis reverts commit 64bc25f7c9f9e03f878809982235022bbe3af339.", "committedDate": "2020-01-09T17:19:06Z", "type": "commit"}, {"oid": "15087db2b6d9d70303d23623f9044af20b813af2", "url": "https://github.com/DSpace/DSpace/commit/15087db2b6d9d70303d23623f9044af20b813af2", "message": "use authorization cookie only to check", "committedDate": "2020-01-09T17:25:10Z", "type": "commit"}, {"oid": "4210605503eb9afdfbfc2659ab063183caa1ee5d", "url": "https://github.com/DSpace/DSpace/commit/4210605503eb9afdfbfc2659ab063183caa1ee5d", "message": "fix use authorization cookie only to check", "committedDate": "2020-01-09T17:36:41Z", "type": "commit"}, {"oid": "beb975281d50bf8346e7e1f820d88c730ecc91b4", "url": "https://github.com/DSpace/DSpace/commit/beb975281d50bf8346e7e1f820d88c730ecc91b4", "message": "Invalidate authentication cookie once used", "committedDate": "2020-01-09T18:02:31Z", "type": "commit"}, {"oid": "5530e7b7a3dbbe5ca264659f2b4516382d0692fd", "url": "https://github.com/DSpace/DSpace/commit/5530e7b7a3dbbe5ca264659f2b4516382d0692fd", "message": "Add checck to user and password blank", "committedDate": "2020-01-10T08:49:55Z", "type": "commit"}, {"oid": "15d6b18ebf009328a9c0083e1da9078ea1cdfa8f", "url": "https://github.com/DSpace/DSpace/commit/15d6b18ebf009328a9c0083e1da9078ea1cdfa8f", "message": "fix check user and password blank", "committedDate": "2020-01-10T09:09:19Z", "type": "commit"}, {"oid": "a32d11eb85eb50f122e718a8af60678176c33706", "url": "https://github.com/DSpace/DSpace/commit/a32d11eb85eb50f122e718a8af60678176c33706", "message": "Revert check", "committedDate": "2020-01-10T09:20:21Z", "type": "commit"}, {"oid": "462f20a3389b6e9641a9af7f6992f3266bce6b45", "url": "https://github.com/DSpace/DSpace/commit/462f20a3389b6e9641a9af7f6992f3266bce6b45", "message": "Check session salt in shib auth", "committedDate": "2020-01-10T09:25:58Z", "type": "commit"}, {"oid": "ba9d2095dc4317587ad2d42a57cba9f15e8362ea", "url": "https://github.com/DSpace/DSpace/commit/ba9d2095dc4317587ad2d42a57cba9f15e8362ea", "message": "Revert \"Check session salt in shib auth\"\n\nThis reverts commit 462f20a3389b6e9641a9af7f6992f3266bce6b45.", "committedDate": "2020-01-10T13:33:05Z", "type": "commit"}, {"oid": "50cf9b742ff3f0256e6d8605b5cf0225179bc3af", "url": "https://github.com/DSpace/DSpace/commit/50cf9b742ff3f0256e6d8605b5cf0225179bc3af", "message": "add attemptAuthentication method to ShibbolethAuthenticationFilter", "committedDate": "2020-01-10T13:39:54Z", "type": "commit"}, {"oid": "e884cc3d8cb738e1491fe08070a22082175dc6fd", "url": "https://github.com/DSpace/DSpace/commit/e884cc3d8cb738e1491fe08070a22082175dc6fd", "message": "fix attemptAuthentication method on ShibbolethAuthenticationFilter", "committedDate": "2020-01-10T13:53:03Z", "type": "commit"}, {"oid": "1e919f99349de3b23f4509d9ad682ec603e8f40d", "url": "https://github.com/DSpace/DSpace/commit/1e919f99349de3b23f4509d9ad682ec603e8f40d", "message": "Added WWW-Authenticate header to authn/status response", "committedDate": "2020-01-16T14:02:02Z", "type": "commit"}, {"oid": "0910916903f9ca45ec817530046a74057d59260c", "url": "https://github.com/DSpace/DSpace/commit/0910916903f9ca45ec817530046a74057d59260c", "message": "Revert \"use authorization cookie only to check\"", "committedDate": "2020-01-17T08:14:33Z", "type": "commit"}, {"oid": "8531f43266096ee4c3eec7e4888023582d72aa9f", "url": "https://github.com/DSpace/DSpace/commit/8531f43266096ee4c3eec7e4888023582d72aa9f", "message": "Merge remote-tracking branch 'origin/master' into dspace-7-shibboleth", "committedDate": "2020-01-17T11:21:48Z", "type": "commit"}, {"oid": "4dba3836067b954c4df097724edf8040e313a20e", "url": "https://github.com/DSpace/DSpace/commit/4dba3836067b954c4df097724edf8040e313a20e", "message": "replace Boolean type with primitive type", "committedDate": "2020-01-20T16:22:36Z", "type": "commit"}, {"oid": "4bb4b539d6c16828d64230675443fcfa3b149962", "url": "https://github.com/DSpace/DSpace/commit/4bb4b539d6c16828d64230675443fcfa3b149962", "message": "use invalidateAuthenticationCookie method", "committedDate": "2020-01-21T10:17:36Z", "type": "commit"}, {"oid": "c63b88141c70e998ee2c2c58521b5e952d693426", "url": "https://github.com/DSpace/DSpace/commit/c63b88141c70e998ee2c2c58521b5e952d693426", "message": "Merge remote-tracking branch 'origin/master' into dspace-7-shibboleth", "committedDate": "2020-01-23T13:15:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg3NjQ1Mg==", "url": "https://github.com/DSpace/DSpace/pull/2651#discussion_r371876452", "bodyText": "Can you add inline comments explaining this is required for Angular to display the authentication options", "author": "benbosman", "createdAt": "2020-01-28T15:33:52Z", "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/AuthenticationRestController.java", "diffHunk": "@@ -86,6 +92,12 @@ public AuthenticationStatusResource status(HttpServletRequest request) throws SQ\n         }\n \n         AuthenticationStatusRest authenticationStatusRest = new AuthenticationStatusRest(ePersonRest);\n+        if (!authenticationStatusRest.isAuthenticated()) {", "originalCommit": "c63b88141c70e998ee2c2c58521b5e952d693426", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg3OTUxNw==", "url": "https://github.com/DSpace/DSpace/pull/2651#discussion_r371879517", "bodyText": "Can you add inline info explaining we need authentication cookies because Shibboleth can't use the authentication headers due to the redirects", "author": "benbosman", "createdAt": "2020-01-28T15:38:31Z", "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/security/jwt/JWTTokenRestAuthenticationServiceImpl.java", "diffHunk": "@@ -140,18 +155,40 @@ public String getWwwAuthenticateHeaderValue(final HttpServletRequest request, fi\n         return wwwAuthenticate.toString();\n     }\n \n-    private void addTokenToResponse(final HttpServletResponse response, final String token) throws IOException {\n+    private void addTokenToResponse(final HttpServletResponse response, final String token, final Boolean addCookie)", "originalCommit": "c63b88141c70e998ee2c2c58521b5e952d693426", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg4ODc4OA==", "url": "https://github.com/DSpace/DSpace/pull/2651#discussion_r371888788", "bodyText": "Please add setSecure. If necessary it can be explicitly configured to bypass setSecure for local development. But the default should enable setSecure", "author": "benbosman", "createdAt": "2020-01-28T15:51:53Z", "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/security/jwt/JWTTokenRestAuthenticationServiceImpl.java", "diffHunk": "@@ -140,18 +155,40 @@ public String getWwwAuthenticateHeaderValue(final HttpServletRequest request, fi\n         return wwwAuthenticate.toString();\n     }\n \n-    private void addTokenToResponse(final HttpServletResponse response, final String token) throws IOException {\n+    private void addTokenToResponse(final HttpServletResponse response, final String token, final Boolean addCookie)\n+            throws IOException {\n+        if (addCookie) {\n+            Cookie cookie = new Cookie(AUTHORIZATION_COOKIE, token);\n+            cookie.setHttpOnly(true);", "originalCommit": "c63b88141c70e998ee2c2c58521b5e952d693426", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0336e831241f63f8f64c0d0963ba40ab4ea953f8", "url": "https://github.com/DSpace/DSpace/commit/0336e831241f63f8f64c0d0963ba40ab4ea953f8", "message": "Added setSecure option to authetication cookie", "committedDate": "2020-02-05T10:49:59Z", "type": "commit"}, {"oid": "6230a88b8a4d9fb2534203cd72a68cadc587c9c5", "url": "https://github.com/DSpace/DSpace/commit/6230a88b8a4d9fb2534203cd72a68cadc587c9c5", "message": "Added inline comment", "committedDate": "2020-02-05T10:50:18Z", "type": "commit"}, {"oid": "7b3db78e4b7edc0b4f8f67eed6ea83015302c7df", "url": "https://github.com/DSpace/DSpace/commit/7b3db78e4b7edc0b4f8f67eed6ea83015302c7df", "message": "Added more integration test for shibboleth authentication", "committedDate": "2020-02-06T14:15:36Z", "type": "commit"}, {"oid": "82f2f60fc993b0fe670050aa4a9dd8ae11f3fe78", "url": "https://github.com/DSpace/DSpace/commit/82f2f60fc993b0fe670050aa4a9dd8ae11f3fe78", "message": "Added integration test fo ShibbolethRestController", "committedDate": "2020-02-06T14:15:54Z", "type": "commit"}, {"oid": "cc439d34719421c2003f761693a7220a573556df", "url": "https://github.com/DSpace/DSpace/commit/cc439d34719421c2003f761693a7220a573556df", "message": "Fixed the default value of authentication-shibboleth.lazysession.loginurl param", "committedDate": "2020-02-06T14:20:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTg2MTY4Mw==", "url": "https://github.com/DSpace/DSpace/pull/2651#discussion_r375861683", "bodyText": "Please note that this property it's about to be changed to: dspace.server.url", "author": "paulo-graca", "createdAt": "2020-02-06T14:23:25Z", "path": "dspace-api/src/main/java/org/dspace/authenticate/ShibAuthentication.java", "diffHunk": "@@ -509,19 +510,17 @@ public String loginPageURL(Context context, HttpServletRequest request, HttpServ\n             int port = request.getServerPort();\n             String contextPath = request.getContextPath();\n \n-            String returnURL = request.getHeader(\"Referer\");\n-            if (returnURL == null) {\n-                if (request.isSecure() || forceHTTPS) {\n-                    returnURL = \"https://\";\n-                } else {\n-                    returnURL = \"http://\";\n-                }\n-                returnURL += host;\n-                if (!(port == 443 || port == 80)) {\n-                    returnURL += \":\" + port;\n-                }\n+            String redirectUrl = null;\n+            if (request.getHeader(\"Referer\") != null && StringUtils.isNotBlank(request.getHeader(\"Referer\"))) {\n+                redirectUrl = request.getHeader(\"Referer\");\n+            } else if (request.getHeader(\"X-Requested-With\") != null\n+                    && StringUtils.isNotBlank(request.getHeader(\"X-Requested-With\"))) {\n+                redirectUrl = request.getHeader(\"X-Requested-With\");\n             }\n \n+            String returnURL = ConfigurationManager.getProperty(\"dspace.baseUrl\") + \"/api/authn/shibboleth\"", "originalCommit": "cc439d34719421c2003f761693a7220a573556df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1Mjg3OQ==", "url": "https://github.com/DSpace/DSpace/pull/2651#discussion_r379152879", "bodyText": "Yes, this config now needs to be updated to dspace.server.url, as #2657 was merged.  This also should use configurationService.getProperty() instead of the ConfigurationManager", "author": "tdonohue", "createdAt": "2020-02-13T22:22:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTg2MTY4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTg3MDQwMQ==", "url": "https://github.com/DSpace/DSpace/pull/2651#discussion_r375870401", "bodyText": "Please note that this property it's about to be changed to: dspace.server.url", "author": "paulo-graca", "createdAt": "2020-02-06T14:38:16Z", "path": "dspace/config/modules/authentication-shibboleth.cfg", "diffHunk": "@@ -38,7 +38,7 @@\n authentication-shibboleth.lazysession = true\n \n # The url to start a shibboleth session (only for lazy sessions)\n-authentication-shibboleth.lazysession.loginurl = /Shibboleth.sso/Login\n+authentication-shibboleth.lazysession.loginurl = ${dspace.baseUrl}/Shibboleth.sso/Login", "originalCommit": "cc439d34719421c2003f761693a7220a573556df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI4MDAxOQ==", "url": "https://github.com/DSpace/DSpace/pull/2651#discussion_r376280019", "bodyText": "We have to be careful which property is used here. It should not redirect to /server/Shibboleth.sso/Login (which it currently does in my installation)\nI'd recommend to revisit this once #2657 is merged because there's a risk the URL is invalid", "author": "benbosman", "createdAt": "2020-02-07T09:02:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTg3MDQwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NjUyNw==", "url": "https://github.com/DSpace/DSpace/pull/2651#discussion_r379156527", "bodyText": "@atarix83 : I'm unclear why this change is needed.  If we leave this setting as it was (authentication-shibboleth.lazysession.loginurl = /Shibboleth.sso/Login), that should cause the redirect to be to the servlet container root path.  That means if you were running DSpace REST API at http://localhost:8080/server/ then the path \"/Shibbboleth.sso/Login\" should cause the redirect to be to http://localhost:8080/Shibboleth.sso/Login.\nI believe that's how this setting worked in DSpace 6 and it also is how relative paths are described to work in HttpServletResponse.sendRedirect(): https://tomcat.apache.org/tomcat-8.5-doc/servletapi/javax/servlet/http/HttpServletResponse.html?is-external=true#sendRedirect(java.lang.String)  (This is the method that ultimately gets called with this relative URL)\nSo, I guess I'm asking why we need to turn this configuration into an absolute/full URL, as it worked previously as a relative URL?", "author": "tdonohue", "createdAt": "2020-02-13T22:31:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTg3MDQwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIwMDM3Mg==", "url": "https://github.com/DSpace/DSpace/pull/2651#discussion_r381200372", "bodyText": "In DSpace 7, the difference is that the hostname of REST and Angular may differ\nWhen logging in from the Angular UI, Angular should link to https://dspace7-rest/Shibboleth.sso/Login (not https://dspace7-rest/server/Shibboleth.sso/Login nor https://dspace7-angular/Shibboleth.sso/Login)\nAt this point in time, this would requiring taking ${dspace.server.url}, stripping the context path off, and adding /Shibboleth.sso/Login to it. That makes it hard to configure", "author": "benbosman", "createdAt": "2020-02-19T10:21:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTg3MDQwMQ=="}], "type": "inlineReview"}, {"oid": "c65bb086ef6777b27bf8b4a112ccfefca7e14ecb", "url": "https://github.com/DSpace/DSpace/commit/c65bb086ef6777b27bf8b4a112ccfefca7e14ecb", "message": "Fixed checkstyle violations", "committedDate": "2020-02-07T13:49:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1ODY3MA==", "url": "https://github.com/DSpace/DSpace/pull/2651#discussion_r379158670", "bodyText": "Just a note here. You shouldn't need to import the ConfigurationManager, as this class already has access to the ConfigurationService.  The ConfigurationManager is deprecated in favor of the ConfigurationService.  So, you should remove this import and just use configurationService instead.", "author": "tdonohue", "createdAt": "2020-02-13T22:37:07Z", "path": "dspace-api/src/main/java/org/dspace/authenticate/ShibAuthentication.java", "diffHunk": "@@ -33,6 +33,7 @@\n import org.dspace.content.factory.ContentServiceFactory;\n import org.dspace.content.service.MetadataFieldService;\n import org.dspace.content.service.MetadataSchemaService;\n+import org.dspace.core.ConfigurationManager;", "originalCommit": "c65bb086ef6777b27bf8b4a112ccfefca7e14ecb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1OTM0Mw==", "url": "https://github.com/DSpace/DSpace/pull/2651#discussion_r379159343", "bodyText": "This configuration needs updating as well to be dspace.ui.url.  Also, you should use ConfigurationService (which can be @Autowired like other services)", "author": "tdonohue", "createdAt": "2020-02-13T22:38:55Z", "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/ShibbolethRestController.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.app.rest;\n+\n+import java.io.IOException;\n+import java.util.Arrays;\n+\n+import javax.servlet.http.HttpServletResponse;\n+\n+import org.dspace.app.rest.model.AuthnRest;\n+import org.dspace.core.ConfigurationManager;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.InitializingBean;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.hateoas.Link;\n+import org.springframework.web.bind.annotation.RequestMapping;\n+import org.springframework.web.bind.annotation.RequestMethod;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.bind.annotation.RestController;\n+\n+/**\n+ * Rest controller that handles redirect after shibboleth authentication succeded\n+ *\n+ * @author Andrea Bollini (andrea dot bollini at 4science dot it)\n+ * @author Giuseppe Digilio (giuseppe dot digilio at 4science dot it)\n+ */\n+@RequestMapping(value = \"/api/\" + AuthnRest.CATEGORY + \"/shibboleth\")\n+@RestController\n+public class ShibbolethRestController implements InitializingBean {\n+\n+    private static final Logger log = LoggerFactory.getLogger(ShibbolethRestController.class);\n+\n+    @Autowired\n+    DiscoverableEndpointsService discoverableEndpointsService;\n+\n+    @Override\n+    public void afterPropertiesSet() {\n+        discoverableEndpointsService\n+            .register(this, Arrays.asList(new Link(\"/api/\" + AuthnRest.CATEGORY, \"shibboleth\")));\n+    }\n+\n+    @RequestMapping(method = RequestMethod.GET)\n+    public void shibboleth(HttpServletResponse response,\n+            @RequestParam(name = \"redirectUrl\", required = false) String redirectUrl) throws IOException {\n+        if (redirectUrl == null) {\n+            redirectUrl = ConfigurationManager.getProperty(\"dspace.url\");", "originalCommit": "c65bb086ef6777b27bf8b4a112ccfefca7e14ecb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQyODI0NA==", "url": "https://github.com/DSpace/DSpace/pull/2651#discussion_r379428244", "bodyText": "A logout configuration can be added to specify the path\nauthentication-shibboleth.lazysession.logouturl = ${dspace.baseUrl}/Shibboleth.sso/Logout", "author": "paulo-graca", "createdAt": "2020-02-14T13:26:29Z", "path": "dspace/config/modules/authentication-shibboleth.cfg", "diffHunk": "@@ -38,7 +38,7 @@\n authentication-shibboleth.lazysession = true\n \n # The url to start a shibboleth session (only for lazy sessions)\n-authentication-shibboleth.lazysession.loginurl = /Shibboleth.sso/Login\n+authentication-shibboleth.lazysession.loginurl = ${dspace.baseUrl}/Shibboleth.sso/Login", "originalCommit": "c65bb086ef6777b27bf8b4a112ccfefca7e14ecb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE5NTMwMA==", "url": "https://github.com/DSpace/DSpace/pull/2651#discussion_r381195300", "bodyText": "If it's not specified, it would be a local-only logout.\nThis will leave at least system administrators with the choice on how to setup their DSpace (based on policies)\nThis would be a redirect", "author": "benbosman", "createdAt": "2020-02-19T10:12:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQyODI0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIwNzcxOQ==", "url": "https://github.com/DSpace/DSpace/pull/2651#discussion_r380207719", "bodyText": "A verification can be used to identify if the current session is a shibboleth session and then call the configured logout parameter", "author": "paulo-graca", "createdAt": "2020-02-17T14:19:33Z", "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/security/CustomLogoutHandler.java", "diffHunk": "@@ -45,7 +45,7 @@ public void logout(HttpServletRequest httpServletRequest, HttpServletResponse ht\n                        Authentication authentication) {\n         try {\n             Context context = ContextUtil.obtainContext(httpServletRequest);\n-            restAuthenticationService.invalidateAuthenticationData(httpServletRequest, context);\n+            restAuthenticationService.invalidateAuthenticationData(httpServletRequest, httpServletResponse, context);", "originalCommit": "c65bb086ef6777b27bf8b4a112ccfefca7e14ecb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a28cb7551c3ffe5d8e7e30bafc1a2e22308dc4f0", "url": "https://github.com/DSpace/DSpace/commit/a28cb7551c3ffe5d8e7e30bafc1a2e22308dc4f0", "message": "Merge remote-tracking branch 'origin/master' into dspace-7-shibboleth", "committedDate": "2020-02-20T13:40:41Z", "type": "commit"}, {"oid": "8cbe3e1f308707734e5772713ae0edda9f9d739d", "url": "https://github.com/DSpace/DSpace/commit/8cbe3e1f308707734e5772713ae0edda9f9d739d", "message": "Added getBaseUrl to Utils", "committedDate": "2020-02-24T09:02:49Z", "type": "commit"}, {"oid": "0fee734a2af8446ecc544d091fb9dc8b7eebf1f5", "url": "https://github.com/DSpace/DSpace/commit/0fee734a2af8446ecc544d091fb9dc8b7eebf1f5", "message": "Fixed default value of authentication-shibboleth.lazysession.loginurl", "committedDate": "2020-02-24T09:15:11Z", "type": "commit"}, {"oid": "a49bf4b3430eab3c695afeeb2f941809e1ce8e16", "url": "https://github.com/DSpace/DSpace/commit/a49bf4b3430eab3c695afeeb2f941809e1ce8e16", "message": "Replace ConfigurationManager with ConfigurationService", "committedDate": "2020-02-24T09:15:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg0ODkzNw==", "url": "https://github.com/DSpace/DSpace/pull/2651#discussion_r387848937", "bodyText": "A small comment.  You don't need to do all this string parsing of shibURL, as the ConfigurationService is much \"smarter\" than the old ConfigurationManager.  The string will already be trimmed.  Additionally, the if just before this is unneeded, as you can pass in a default value if it's unspecified.  So, both the if and the trim() can be removed in favor of just calling\nString shibURL = configurationService.getProperty(\"authentication-shibboleth.lazysession.loginurl\", \"/Shibboleth.sso/Login\");", "author": "tdonohue", "createdAt": "2020-03-04T18:22:12Z", "path": "dspace-api/src/main/java/org/dspace/authenticate/ShibAuthentication.java", "diffHunk": "@@ -1258,6 +1246,28 @@ protected String findSingleAttribute(HttpServletRequest request, String name) {\n         return valueList;\n     }\n \n+    private String getShibURL(HttpServletRequest request) {\n+        String shibURL = configurationService.getProperty(\"authentication-shibboleth.lazysession.loginurl\");\n+        boolean forceHTTPS =\n+                configurationService.getBooleanProperty(\"authentication-shibboleth.lazysession.secure\",true);\n+\n+        // Shibboleth authentication initiator\n+        if (shibURL == null || shibURL.length() == 0) {\n+            shibURL = \"/Shibboleth.sso/Login\";\n+        }\n+        shibURL = shibURL.trim();", "originalCommit": "a49bf4b3430eab3c695afeeb2f941809e1ce8e16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQwNzM5Nw==", "url": "https://github.com/DSpace/DSpace/pull/2651#discussion_r392407397", "bodyText": "done", "author": "atarix83", "createdAt": "2020-03-13T18:42:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg0ODkzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg1MjA3MA==", "url": "https://github.com/DSpace/DSpace/pull/2651#discussion_r387852070", "bodyText": "@atarix83  What would happen if the Base URL includes a port number?  While it's less frequently seen, I have seen sites that run their DSpace on port 8080, for example.  It looks to me like Utils.getBaseUrl() would fail if the port is not either 80 (HTTP) or 443 (HTTPS)", "author": "tdonohue", "createdAt": "2020-03-04T18:27:58Z", "path": "dspace-api/src/test/java/org/dspace/core/UtilsTest.java", "diffHunk": "@@ -22,6 +22,27 @@\n  */\n public class UtilsTest extends AbstractUnitTest {\n \n+    /**\n+     * Test of getBaseUrl method, of class Utils\n+     */\n+    @Test\n+    public void testGetBaseUrl() {\n+        assertEquals(\"Test remove /server\", \"http://dspace.org\",\n+                     Utils.getBaseUrl(\"http://dspace.org/server\"));\n+\n+        assertEquals(\"Test remove /server/api/core/items\", \"https://dspace.org\",\n+                     Utils.getBaseUrl(\"https://dspace.org/server/api/core/items\"));\n+\n+        assertEquals(\"Test remove trailing slash\", \"https://dspace.org\",\n+                     Utils.getBaseUrl(\"https://dspace.org/\"));\n+\n+        assertEquals(\"Test keep url\", \"https://demo.dspace.org\",\n+                     Utils.getBaseUrl(\"https://demo.dspace.org\"));", "originalCommit": "a49bf4b3430eab3c695afeeb2f941809e1ce8e16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQwNzY4NA==", "url": "https://github.com/DSpace/DSpace/pull/2651#discussion_r392407684", "bodyText": "added compatibility with url that contains port", "author": "atarix83", "createdAt": "2020-03-13T18:42:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg1MjA3MA=="}], "type": "inlineReview"}, {"oid": "3989987a41223ddbcbfd4ce30f29e091fdbccdb4", "url": "https://github.com/DSpace/DSpace/commit/3989987a41223ddbcbfd4ce30f29e091fdbccdb4", "message": "Merge remote-tracking branch 'origin/master' into dspace-7-shibboleth", "committedDate": "2020-03-13T11:52:19Z", "type": "commit"}, {"oid": "d66512578834cff29139bd6dfe631bf7e1dd008f", "url": "https://github.com/DSpace/DSpace/commit/d66512578834cff29139bd6dfe631bf7e1dd008f", "message": "Added port to getBaseUrl", "committedDate": "2020-03-13T18:30:45Z", "type": "commit"}, {"oid": "2044d33908872a1f2edbe369bd31a57d182b7bdf", "url": "https://github.com/DSpace/DSpace/commit/2044d33908872a1f2edbe369bd31a57d182b7bdf", "message": "Use configurationService to set default authentication-shibboleth.lazysession.loginurl in getShibURL method", "committedDate": "2020-03-13T18:31:50Z", "type": "commit"}, {"oid": "1a3bce8eabe888b20963bc825a8bcbab05b2c74b", "url": "https://github.com/DSpace/DSpace/commit/1a3bce8eabe888b20963bc825a8bcbab05b2c74b", "message": "Added methods to test shibboleth url using port", "committedDate": "2020-03-13T18:33:13Z", "type": "commit"}, {"oid": "0951d0ae077af78014f153cdb36da4f3f46b0ee6", "url": "https://github.com/DSpace/DSpace/commit/0951d0ae077af78014f153cdb36da4f3f46b0ee6", "message": "Added comments for authentication-shibboleth.lazysession.loginurl in authentication-shibboleth.cfg", "committedDate": "2020-03-13T18:40:43Z", "type": "commit"}, {"oid": "0d7ba9b841c5d8433caf71912bf18933e25c588b", "url": "https://github.com/DSpace/DSpace/commit/0d7ba9b841c5d8433caf71912bf18933e25c588b", "message": "Merge remote-tracking branch 'origin/master' into dspace-7-shibboleth", "committedDate": "2020-03-24T20:25:50Z", "type": "commit"}, {"oid": "671faf3569a05ad7fc28bcf23a40203212f21253", "url": "https://github.com/DSpace/DSpace/commit/671faf3569a05ad7fc28bcf23a40203212f21253", "message": "Fixed checkstyle violations", "committedDate": "2020-03-25T09:28:40Z", "type": "commit"}]}