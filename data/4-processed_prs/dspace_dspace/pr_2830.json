{"pr_number": 2830, "pr_title": "Parent links for bitstream->bundle->item", "pr_createdAt": "2020-07-08T11:47:32Z", "pr_url": "https://github.com/DSpace/DSpace/pull/2830", "timeline": [{"oid": "dfe33d273e2c1189b4eae54041e8c45914e07c17", "url": "https://github.com/DSpace/DSpace/commit/dfe33d273e2c1189b4eae54041e8c45914e07c17", "message": "71701: item link on BundleRest + embedded parent tests for bundle and bitstream", "committedDate": "2020-07-08T10:59:36Z", "type": "commit"}, {"oid": "3243f19127f61f793598fe8e6dab19c522b0f5ec", "url": "https://github.com/DSpace/DSpace/commit/3243f19127f61f793598fe8e6dab19c522b0f5ec", "message": "71701: Additional parent link tests for Bitstream and Bundle + JavaDocs", "committedDate": "2020-07-08T10:59:36Z", "type": "commit"}, {"oid": "3e33a866c6af5cd885770aba53aae92fdc323f6c", "url": "https://github.com/DSpace/DSpace/commit/3e33a866c6af5cd885770aba53aae92fdc323f6c", "message": "71701: Checkstyle fixes", "committedDate": "2020-07-08T10:59:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM5ODA4OQ==", "url": "https://github.com/DSpace/DSpace/pull/2830#discussion_r452398089", "bodyText": "I would just say: get the Item where the bundle resides in. We should not support bundle shared between multiple items", "author": "abollini", "createdAt": "2020-07-09T18:06:06Z", "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/BundleItemLinkRepository.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.app.rest.repository;\n+\n+import java.sql.SQLException;\n+import java.util.UUID;\n+import javax.annotation.Nullable;\n+import javax.servlet.http.HttpServletRequest;\n+\n+import org.dspace.app.rest.model.BundleRest;\n+import org.dspace.app.rest.model.ItemRest;\n+import org.dspace.app.rest.projection.Projection;\n+import org.dspace.content.Bundle;\n+import org.dspace.content.Item;\n+import org.dspace.content.service.BundleService;\n+import org.dspace.core.Context;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.data.domain.Pageable;\n+import org.springframework.data.rest.webmvc.ResourceNotFoundException;\n+import org.springframework.security.access.prepost.PreAuthorize;\n+import org.springframework.stereotype.Component;\n+\n+/**\n+ * Link repository for \"item\" subresource of an individual bundle.\n+ */\n+@Component(BundleRest.CATEGORY + \".\" + BundleRest.NAME + \".\" + BundleRest.ITEM)\n+public class BundleItemLinkRepository extends AbstractDSpaceRestRepository\n+        implements LinkRestRepository {\n+\n+    @Autowired\n+    BundleService bundleService;\n+\n+    /**\n+     * Get the first item the provided bundle resides in\n+     */\n+    @PreAuthorize(\"hasPermission(#bundleId, 'BUNDLE', 'READ')\")", "originalCommit": "3e33a866c6af5cd885770aba53aae92fdc323f6c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM5ODk4Ng==", "url": "https://github.com/DSpace/DSpace/pull/2830#discussion_r452398986", "bodyText": "I would prefer to remove this test as this is an use case that we don't want to support", "author": "abollini", "createdAt": "2020-07-09T18:07:49Z", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/BitstreamRestRepositoryIT.java", "diffHunk": "@@ -1143,5 +1146,133 @@ public void testHiddenMetadataForUserWithWriteRights() throws Exception {\n \n     }\n \n+    @Test\n+    public void getEmbeddedBundleForBitstream() throws Exception {\n+        //We turn off the authorization system in order to create the structure as defined below\n+        context.turnOffAuthorisationSystem();\n+\n+        //** GIVEN **\n+        //1. A community-collection structure with one parent community with sub-community and one collection.\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                .withName(\"Parent Community\")\n+                .build();\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                .withName(\"Sub Community\")\n+                .build();\n+        Collection col1 = CollectionBuilder.createCollection(context, child1).withName(\"Collection 1\").build();\n+\n+        //2. One public items that is readable by Anonymous\n+        Item publicItem1 = ItemBuilder.createItem(context, col1)\n+                .withTitle(\"Test\")\n+                .withIssueDate(\"2010-10-17\")\n+                .withAuthor(\"Smith, Donald\")\n+                .withSubject(\"ExtraEntry\")\n+                .build();\n+\n+        String bitstreamContent = \"ThisIsSomeDummyText\";\n+\n+        //Add a bitstream to an item\n+        Bitstream bitstream = null;\n+        try (InputStream is = IOUtils.toInputStream(bitstreamContent, CharEncoding.UTF_8)) {\n+            bitstream = BitstreamBuilder.\n+                    createBitstream(context, publicItem1, is)\n+                    .withName(\"Bitstream\")\n+                    .withDescription(\"Description\")\n+                    .withMimeType(\"text/plain\")\n+                    .build();\n+        }\n+\n+        Bundle bundle = bitstream.getBundles().get(0);\n+\n+        //Get the bitstream with embedded bundle\n+        getClient().perform(get(\"/api/core/bitstreams/\" + bitstream.getID() + \"?embed=bundle\"))\n+                .andExpect(status().isOk())\n+                .andExpect(content().contentType(contentType))\n+                .andExpect(jsonPath(\"$._embedded.bundle\",\n+                        BundleMatcher.matchProperties(\n+                                bundle.getName(),\n+                                bundle.getID(),\n+                                bundle.getHandle(),\n+                                bundle.getType()\n+                        )\n+                ));\n+    }\n+\n+    @Test\n+    public void linksToFirstBundleWhenMultipleBundles() throws Exception {", "originalCommit": "3e33a866c6af5cd885770aba53aae92fdc323f6c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE4NDA1Nw==", "url": "https://github.com/DSpace/DSpace/pull/2830#discussion_r458184057", "bodyText": "I'm OK with this test, as it proves that we are only ever returning the FIRST bundle if somehow an Item did exist in multiple bundles.\nThat said, I think @abollini is correct that we need to add a special comment on this method.  I'd recommend we add JavaDocs or a comment above this test method to say:\nThis test proves that, if a bitstream is linked to multiple bundles, we only ever return the first bundle.  **NOTE: DSpace does NOT support or expect to have a bitstream linked to multiple bundles**.  But, because the database does allow for it, this test simply proves the REST API will respond without an error.", "author": "tdonohue", "createdAt": "2020-07-21T15:24:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM5ODk4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM5OTIwNQ==", "url": "https://github.com/DSpace/DSpace/pull/2830#discussion_r452399205", "bodyText": "I would prefer to remove this test as this is an use case that we don't want to support", "author": "abollini", "createdAt": "2020-07-09T18:08:15Z", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/BundleRestRepositoryIT.java", "diffHunk": "@@ -636,4 +641,49 @@ public void deleteBundle_NoAuthToken() throws Exception {\n                 .andExpect(status().isOk());\n     }\n \n+    @Test\n+    public void getEmbeddedItemForBundle() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        bundle1 = BundleBuilder.createBundle(context, item)\n+                .withName(\"testname\")\n+                .build();\n+\n+        context.restoreAuthSystemState();\n+\n+        getClient().perform(get(\"/api/core/bundles/\" + bundle1.getID() + \"?embed=item\"))\n+                .andExpect(status().isOk())\n+                .andExpect(content().contentType(contentType))\n+                .andExpect(jsonPath(\"$._embedded.item\",\n+                        ItemMatcher.matchItemWithTitleAndDateIssued(item, \"Public item 1\", \"2017-10-17\")\n+                ));\n+    }\n+\n+    @Test\n+    public void linksToFirstItemWhenMultipleItems() throws Exception {", "originalCommit": "3e33a866c6af5cd885770aba53aae92fdc323f6c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE4NTg0MA==", "url": "https://github.com/DSpace/DSpace/pull/2830#discussion_r458185840", "bodyText": "Again, as before, I'm OK with this test, as it proves our REST API won't completely error out if somehow a site has a Bundle belonging to two Items.\nThat said, I agree with @abollini  that this isn't something we should actively support.  So, again, let's add some JavaDocs/comments to this test method to say something like:\nThis test proves that, if a bundle is linked to multiple items, we only ever return the first item. **NOTE: DSpace does NOT support or expect to have a bundle linked to multiple items**. But, because the database does allow for it, this test simply proves the REST API will respond without an error.", "author": "tdonohue", "createdAt": "2020-07-21T15:26:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM5OTIwNQ=="}], "type": "inlineReview"}, {"oid": "836876508f42f44583b8aadd22d4859473b3b9d9", "url": "https://github.com/DSpace/DSpace/commit/836876508f42f44583b8aadd22d4859473b3b9d9", "message": "Addition of explanation to tests + Small comment update", "committedDate": "2020-07-23T06:59:10Z", "type": "commit"}]}