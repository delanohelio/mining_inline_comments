{"pr_number": 2934, "pr_title": "Scripts and processes - Script output", "pr_createdAt": "2020-08-20T11:52:16Z", "pr_url": "https://github.com/DSpace/DSpace/pull/2934", "timeline": [{"oid": "26935f9d2353967780dc328c2f4dca84be37aa07", "url": "https://github.com/DSpace/DSpace/commit/26935f9d2353967780dc328c2f4dca84be37aa07", "message": "intermittent commit", "committedDate": "2020-08-14T08:15:06Z", "type": "commit"}, {"oid": "fd22cfe7dac4ffedafe7e1d5daf043db035755c5", "url": "https://github.com/DSpace/DSpace/commit/fd22cfe7dac4ffedafe7e1d5daf043db035755c5", "message": "managed context", "committedDate": "2020-08-14T08:58:30Z", "type": "commit"}, {"oid": "eb79a859e086180d971b6162b158308059dd2a02", "url": "https://github.com/DSpace/DSpace/commit/eb79a859e086180d971b6162b158308059dd2a02", "message": "[Task 72494] added Context.Mode.MANAGED to all contexts in the RestDSpaceRunnableHandler", "committedDate": "2020-08-14T09:11:38Z", "type": "commit"}, {"oid": "df06b330fd6d7128ab850bbfa29456c7f07e34ff", "url": "https://github.com/DSpace/DSpace/commit/df06b330fd6d7128ab850bbfa29456c7f07e34ff", "message": "72494: Scripts and processes: Export script output", "committedDate": "2020-08-14T11:54:10Z", "type": "commit"}, {"oid": "7c8270f1c3b8149c5802b20f410c57b53c2f2f39", "url": "https://github.com/DSpace/DSpace/commit/7c8270f1c3b8149c5802b20f410c57b53c2f2f39", "message": "Revert \"[Task 72494] added Context.Mode.MANAGED to all contexts in the RestDSpaceRunnableHandler\"\n\nThis reverts commit eb79a859e086180d971b6162b158308059dd2a02.", "committedDate": "2020-08-18T13:46:55Z", "type": "commit"}, {"oid": "f995007511aef5f60af9bbe455619d10d5098875", "url": "https://github.com/DSpace/DSpace/commit/f995007511aef5f60af9bbe455619d10d5098875", "message": "Revert \"managed context\"\n\nThis reverts commit fd22cfe7dac4ffedafe7e1d5daf043db035755c5.", "committedDate": "2020-08-18T13:51:56Z", "type": "commit"}, {"oid": "3f4015e291722881bba1c70812b466fd688a8cf9", "url": "https://github.com/DSpace/DSpace/commit/3f4015e291722881bba1c70812b466fd688a8cf9", "message": "72494: Scripts and processes: Export script output", "committedDate": "2020-08-18T13:53:36Z", "type": "commit"}, {"oid": "1947b48a4bafaed8581508437934cf7f56a50d48", "url": "https://github.com/DSpace/DSpace/commit/1947b48a4bafaed8581508437934cf7f56a50d48", "message": "Fixing checkstyle warnings", "committedDate": "2020-08-19T07:09:26Z", "type": "commit"}, {"oid": "d32c32e4ab025cd2a767c7e31c1a8d840cff91f4", "url": "https://github.com/DSpace/DSpace/commit/d32c32e4ab025cd2a767c7e31c1a8d840cff91f4", "message": "Additional checkstyle fixes + part of LGTM fix", "committedDate": "2020-08-21T08:34:59Z", "type": "commit"}, {"oid": "80d64e73ec810239b71c1809ddc7444c5dbf9c81", "url": "https://github.com/DSpace/DSpace/commit/80d64e73ec810239b71c1809ddc7444c5dbf9c81", "message": "72494: Fix issue with task executor being used in tests", "committedDate": "2020-08-28T11:07:26Z", "type": "commit"}, {"oid": "959109a6a1f29bb372ee61acc82370ecadfa629b", "url": "https://github.com/DSpace/DSpace/commit/959109a6a1f29bb372ee61acc82370ecadfa629b", "message": "Merge remote-tracking branch 'upstream/main' into w2p-72494_Export-script-output", "committedDate": "2020-08-28T15:03:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQwNDQwNw==", "url": "https://github.com/DSpace/DSpace/pull/2934#discussion_r481404407", "bodyText": "Is this System.out really needed?  It seems like something we should remove as it's not used in tests.", "author": "tdonohue", "createdAt": "2020-09-01T20:14:25Z", "path": "dspace-api/src/test/java/org/dspace/eperson/GroupTest.java", "diffHunk": "@@ -171,7 +171,7 @@ public void findByName() throws SQLException {\n     public void findAll() throws SQLException {\n         List<Group> groups = groupService.findAll(context, null);\n         assertThat(\"findAll 1\", groups, notNullValue());\n-        System.out.println(\"TEST GROUP OUTPUT \" + groups);\n+        System.out.println(\"TEST GROUP OUTPUT_TYPE \" + groups);", "originalCommit": "959109a6a1f29bb372ee61acc82370ecadfa629b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQwNDc4Ng==", "url": "https://github.com/DSpace/DSpace/pull/2934#discussion_r481404786", "bodyText": "Please add JavaDocs at the top of this new Class to describe it", "author": "tdonohue", "createdAt": "2020-09-01T20:15:05Z", "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/ProcessOutputLinkRepository.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.app.rest.repository;\n+\n+import java.sql.SQLException;\n+import javax.annotation.Nullable;\n+import javax.servlet.http.HttpServletRequest;\n+\n+import org.dspace.app.rest.model.BitstreamRest;\n+import org.dspace.app.rest.model.ProcessRest;\n+import org.dspace.app.rest.projection.Projection;\n+import org.dspace.authorize.AuthorizeException;\n+import org.dspace.authorize.service.AuthorizeService;\n+import org.dspace.content.Bitstream;\n+import org.dspace.core.Context;\n+import org.dspace.scripts.Process;\n+import org.dspace.scripts.service.ProcessService;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.data.domain.Pageable;\n+import org.springframework.security.access.prepost.PreAuthorize;\n+import org.springframework.stereotype.Component;\n+\n+@Component(ProcessRest.CATEGORY + \".\" + ProcessRest.NAME + \".\" + ProcessRest.OUTPUT)\n+public class ProcessOutputLinkRepository extends AbstractDSpaceRestRepository implements LinkRestRepository {", "originalCommit": "959109a6a1f29bb372ee61acc82370ecadfa629b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQwNTI0Nw==", "url": "https://github.com/DSpace/DSpace/pull/2934#discussion_r481405247", "bodyText": "The above JavaDocs are somehow double-commented (and misaligned).  You can remove all the // on each line to line them back up.", "author": "tdonohue", "createdAt": "2020-09-01T20:15:48Z", "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/ProcessOutputLinkRepository.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.app.rest.repository;\n+\n+import java.sql.SQLException;\n+import javax.annotation.Nullable;\n+import javax.servlet.http.HttpServletRequest;\n+\n+import org.dspace.app.rest.model.BitstreamRest;\n+import org.dspace.app.rest.model.ProcessRest;\n+import org.dspace.app.rest.projection.Projection;\n+import org.dspace.authorize.AuthorizeException;\n+import org.dspace.authorize.service.AuthorizeService;\n+import org.dspace.content.Bitstream;\n+import org.dspace.core.Context;\n+import org.dspace.scripts.Process;\n+import org.dspace.scripts.service.ProcessService;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.data.domain.Pageable;\n+import org.springframework.security.access.prepost.PreAuthorize;\n+import org.springframework.stereotype.Component;\n+\n+@Component(ProcessRest.CATEGORY + \".\" + ProcessRest.NAME + \".\" + ProcessRest.OUTPUT)\n+public class ProcessOutputLinkRepository extends AbstractDSpaceRestRepository implements LinkRestRepository {\n+\n+    @Autowired\n+    private ProcessService processService;\n+\n+    @Autowired\n+    private AuthorizeService authorizeService;\n+\n+    //    /**\n+//     * This method will retrieve the list of {@link ProcessLog} objects from the {@link Process} as defined through\n+//     the\n+//     * given ID in the rest call and it'll wrap this in a {@link ProcessOutputRest} object to return these\n+//     * @param request           The current request\n+//     * @param processId         The given processId for the {@link Process}\n+//     * @param optionalPageable  Pageable if applicable\n+//     * @param projection        The current projection\n+//     * @return                  The {@link ProcessOutputRest} containing the list of all {@link ProcessLog} for the\n+//     *                          given {@link Process}\n+//     * @throws SQLException         If something goes wrong\n+//     * @throws AuthorizeException   If something goes wrong\n+//     */", "originalCommit": "959109a6a1f29bb372ee61acc82370ecadfa629b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQwNjAxOA==", "url": "https://github.com/DSpace/DSpace/pull/2934#discussion_r481406018", "bodyText": "New methods both need JavaDocs added", "author": "tdonohue", "createdAt": "2020-09-01T20:17:17Z", "path": "dspace-api/src/main/java/org/dspace/scripts/service/ProcessService.java", "diffHunk": "@@ -189,4 +190,7 @@ public void appendFile(Context context, Process process, InputStream is, String\n      */\n     public List<String> getFileTypesForProcessBitstreams(Context context, Process process);\n \n+    void appendLog(int processId, String scriptName, String output, ProcessLogLevel processLogLevel) throws IOException;\n+    void createLogBitstream(Context context, Process process)\n+             throws IOException, SQLException, AuthorizeException;", "originalCommit": "959109a6a1f29bb372ee61acc82370ecadfa629b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQwNjM1Ng==", "url": "https://github.com/DSpace/DSpace/pull/2934#discussion_r481406356", "bodyText": "Missing an @Override", "author": "tdonohue", "createdAt": "2020-09-01T20:17:59Z", "path": "dspace-api/src/main/java/org/dspace/scripts/ProcessServiceImpl.java", "diffHunk": "@@ -245,4 +255,45 @@ public int countTotal(Context context) throws SQLException {\n         return new ArrayList<>(fileTypesSet);\n     }\n \n+    @Override\n+    public void appendLog(int processId, String scriptName, String output, ProcessLogLevel processLogLevel)\n+            throws IOException {\n+        File tmpDir = FileUtils.getTempDirectory();\n+        File tempFile = new File(tmpDir, scriptName + processId + \".log\");\n+        FileWriter out = new FileWriter(tempFile, true);\n+        try {\n+            try (BufferedWriter writer = new BufferedWriter(out)) {\n+                writer.append(formatLogLine(processId, scriptName, output, processLogLevel));\n+                writer.newLine();\n+            }\n+        } finally {\n+            out.close();\n+        }\n+    }\n+\n+    public void createLogBitstream(Context context, Process process)", "originalCommit": "959109a6a1f29bb372ee61acc82370ecadfa629b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQwODEzMg==", "url": "https://github.com/DSpace/DSpace/pull/2934#discussion_r481408132", "bodyText": "This method accidentally removed the finally clause.  It should be added back in to ensure that the Context is aborted whenever an error occurs.", "author": "tdonohue", "createdAt": "2020-09-01T20:21:26Z", "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/scripts/handler/impl/RestDSpaceRunnableHandler.java", "diffHunk": "@@ -96,14 +103,18 @@ public void handleCompletion() {\n         try {\n             Process process = processService.find(context, processId);\n             processService.complete(context, process);\n-            context.complete();\n             logInfo(\"The script has completed\");\n+\n+            addLogBitstreamToProcess(context);\n+\n+            context.complete();\n         } catch (SQLException e) {\n             log.error(\"RestDSpaceRunnableHandler with process: \" + processId + \" could not be completed\", e);\n-        } finally {\n-            if (context.isValid()) {\n-                context.abort();\n-            }\n+        } catch (IOException | AuthorizeException e) {\n+            log.error(\"RestDSpaceRunnableHandler with process: \" + processId + \" could not be completed due to an \" +\n+                              \"error with the logging bitstream\", e);\n+        } catch (Exception e) {\n+            log.error(e.getMessage(), e);", "originalCommit": "959109a6a1f29bb372ee61acc82370ecadfa629b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQwOTA4NQ==", "url": "https://github.com/DSpace/DSpace/pull/2934#discussion_r481409085", "bodyText": "Why is this entire test commented out?", "author": "tdonohue", "createdAt": "2020-09-01T20:23:18Z", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/ProcessRestRepositoryIT.java", "diffHunk": "@@ -322,6 +322,50 @@ public void getProcessFilesTypesRandomProcessId() throws Exception {\n \n     }\n \n+//    @Test\n+//    public void getProcessOutput() throws Exception {", "originalCommit": "959109a6a1f29bb372ee61acc82370ecadfa629b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQxMTgzMA==", "url": "https://github.com/DSpace/DSpace/pull/2934#discussion_r481411830", "bodyText": "Could you add a comment to explain why this is set to 5?\nI'm also curious why the production version of dspaceRunnableThreadExecutor is of type ThreadPoolTaskExecutor, while all the tests use SyncTaskExecutor.  Shouldn't the tests use the same type of TaskExecutor as the main code?  If not, I think we should add an inline comment to describe the reason for the difference (it's not obvious to me).", "author": "tdonohue", "createdAt": "2020-09-01T20:28:36Z", "path": "dspace/config/spring/api/scripts.xml", "diffHunk": "@@ -4,6 +4,10 @@\n     xsi:schemaLocation=\"http://www.springframework.org/schema/beans\n            http://www.springframework.org/schema/beans/spring-beans-2.5.xsd\">\n \n+    <bean id=\"dspaceRunnableThreadExecutor\" class=\"org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor\">\n+        <property name=\"corePoolSize\" value=\"5\"/>", "originalCommit": "959109a6a1f29bb372ee61acc82370ecadfa629b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc0MTM1OA==", "url": "https://github.com/DSpace/DSpace/pull/2934#discussion_r484741358", "bodyText": "Could you add a comment to explain why this is set to 5?\nThere is no particular reason that this is set to 5, it\u2019s just a default to not allow too many threads to be working at the same time and potentially cause memory issues or other performance issues.  This was previously also set to 5, so we kept this as is\nI\u2019m also curious why the production version of dspaceRunnableThreadExecutor is of type ThreadPoolTaskExecutor, while all the tests use SyncTaskExecutor. Shouldn\u2019t the tests use the same type of TaskExecutor as the main code? If not, I think we should add an inline comment to describe the reason for the difference (it\u2019s not obvious to me).\nThe DSpaceRunnableThreadExecutor is responsible for executing the Process. This Process will either run synchronously or asynchronously.\nIn the production code, it\u2019s desirable that this happens asynchronously because we don\u2019t want the user to wait for his/her REST response until a Process is done with the execution, it\u2019ll return almost immediately and give a \u201crunning\u201d or \u201cscheduled\u201d if it\u2019s not done yet, but it\u2019ll continue to run in a different thread and the Process db object will be updated when this background thread is done running.\nThis way the user won\u2019t ever have to wait ages for the REST reply even when executing large scripts. We don\u2019t want the user to wait or any front-ends to be blocked whilst waiting for a response on the call when it could just be ran in the background and update the db when it\u2019s finished executing.\nIn the test code however, we want to actually test things after a REST call is made. This means that we can\u2019t have processes making alterations to the DB or be stuck in execution whilst the assertions are being tested in the tests. The result that\u2019s coming from the REST api has to be consistent and represent a state in which the Process is fully finished executing, whether it\u2019s completed or failed. This is necessary because otherwise our tests aren\u2019t going to be the same every time they\u2019re ran and they\u2019ll cause failures and inconsistencies.\nImplementing this SyncThreadExecutor ensures that any Processes started by the DSpaceRunnableThreadExecutor will have to fully run and be fully done before the REST response is sent. This means that we can check for completed or failed instead of sometimes running into \u201crunning\u201d status when the Process would still be executing. We\u2019re simply forcing the Process to fully finish its execution before we construct the REST response so that it\u2019s always consistent and non-variable.\nIf you remember from a while back, I mentioned that the tests were failing inconsistently, this was mostly because of the executor that was used.\nBecause of the asynchronous run that was being done at that point in time, the tests did not correctly await the responses/checked the assertions as was described above.\nWe did removed an unneeded dspaceRunnableThreadExecutor in the api scripts.xml. This is a bean that\u2019s only needed in the server module, so it should be in the REST package only if I\u2019m not horribly mistaken", "author": "jonas-atmire", "createdAt": "2020-09-08T08:26:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQxMTgzMA=="}], "type": "inlineReview"}, {"oid": "f537eadcc3909dc730d200bf6aa4903901e5a6c9", "url": "https://github.com/DSpace/DSpace/commit/f537eadcc3909dc730d200bf6aa4903901e5a6c9", "message": "[Task 73019] applied feedback to the export script output", "committedDate": "2020-09-08T07:13:57Z", "type": "commit"}, {"oid": "7484e476949734446503f101eace33ddda802eab", "url": "https://github.com/DSpace/DSpace/commit/7484e476949734446503f101eace33ddda802eab", "message": "Merge remote-tracking branch 'dspace/main' into w2p-72494_Export-script-output", "committedDate": "2020-09-08T07:29:52Z", "type": "commit"}]}