{"pr_number": 2791, "pr_title": "DS-4514 Start new submission by uploading a Bibliographic File (using Live Import)", "pr_createdAt": "2020-06-25T16:07:33Z", "pr_url": "https://github.com/DSpace/DSpace/pull/2791", "timeline": [{"oid": "64046093d2cb45ec2bcf6f3396953c9d2f9f9315", "url": "https://github.com/DSpace/DSpace/commit/64046093d2cb45ec2bcf6f3396953c9d2f9f9315", "message": "Bibtex file import", "committedDate": "2020-06-22T09:46:53Z", "type": "commit"}, {"oid": "aef91df802af0144df8dcc0d040c664d9170741d", "url": "https://github.com/DSpace/DSpace/commit/aef91df802af0144df8dcc0d040c664d9170741d", "message": "Use metadataField as unnamed bean", "committedDate": "2020-06-22T13:43:48Z", "type": "commit"}, {"oid": "8ad4b0ed39252e9e58adde4f6ac062df2a43c16e", "url": "https://github.com/DSpace/DSpace/commit/8ad4b0ed39252e9e58adde4f6ac062df2a43c16e", "message": "Implement FileSource in PubmedImportMetadataSourceServiceImpl", "committedDate": "2020-06-22T23:51:59Z", "type": "commit"}, {"oid": "3c4a46377175fc7caeeacb55f653880b7f7f4d4f", "url": "https://github.com/DSpace/DSpace/commit/3c4a46377175fc7caeeacb55f653880b7f7f4d4f", "message": "pubmed test data", "committedDate": "2020-06-22T23:58:42Z", "type": "commit"}, {"oid": "530a9d5fac9eee6fdaa075619087fa519fa11b3d", "url": "https://github.com/DSpace/DSpace/commit/530a9d5fac9eee6fdaa075619087fa519fa11b3d", "message": "Tests and minor fix", "committedDate": "2020-06-23T15:11:56Z", "type": "commit"}, {"oid": "ecefb1a30222dbf664f5f3fe59245274111d9875", "url": "https://github.com/DSpace/DSpace/commit/ecefb1a30222dbf664f5f3fe59245274111d9875", "message": "Comment and minor improvements", "committedDate": "2020-06-24T12:52:33Z", "type": "commit"}, {"oid": "9208879abffaf2866a3e7460ad3a4f32c0fc5f00", "url": "https://github.com/DSpace/DSpace/commit/9208879abffaf2866a3e7460ad3a4f32c0fc5f00", "message": "Update test", "committedDate": "2020-06-25T09:57:05Z", "type": "commit"}, {"oid": "c0b92196f3e1489bac5a475369890c0df3fd60cc", "url": "https://github.com/DSpace/DSpace/commit/c0b92196f3e1489bac5a475369890c0df3fd60cc", "message": "Fix multifile import", "committedDate": "2020-06-25T11:43:26Z", "type": "commit"}, {"oid": "014c623256364e8088d710c48c7c73a7de624db4", "url": "https://github.com/DSpace/DSpace/commit/014c623256364e8088d710c48c7c73a7de624db4", "message": "Manage empty or invalid files in multiple submission", "committedDate": "2020-06-25T12:15:20Z", "type": "commit"}, {"oid": "a3a95a81f073b8ff09d965c2dae2c193000bee5f", "url": "https://github.com/DSpace/DSpace/commit/a3a95a81f073b8ff09d965c2dae2c193000bee5f", "message": "Merge branch 'master' of https://github.com/DSpace/DSpace into CST-3091", "committedDate": "2020-06-29T21:38:16Z", "type": "commit"}, {"oid": "cfc53c98d21b1726c7a921d3ea8f30e1176b2874", "url": "https://github.com/DSpace/DSpace/commit/cfc53c98d21b1726c7a921d3ea8f30e1176b2874", "message": "Live import minor changes + LGTM alert fix", "committedDate": "2020-07-01T08:52:49Z", "type": "commit"}, {"oid": "eb4abb7d515a825d744424dfc99d6606a2b0d756", "url": "https://github.com/DSpace/DSpace/commit/eb4abb7d515a825d744424dfc99d6606a2b0d756", "message": "Merge branch 'CST-3091' of https://github.com/4Science/DSpace into CST-3091", "committedDate": "2020-07-01T09:00:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYzOTY5OQ==", "url": "https://github.com/DSpace/DSpace/pull/2791#discussion_r456639699", "bodyText": "Tiny thing. We may want to call this getRecordsCount.... I initially didn't understand what \"Nb\" stands for, but it looks like it's the number/count of records.", "author": "tdonohue", "createdAt": "2020-07-17T19:41:54Z", "path": "dspace-api/src/main/java/org/dspace/importer/external/service/components/QuerySource.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+\n+package org.dspace.importer.external.service.components;\n+\n+import java.util.Collection;\n+\n+import org.dspace.content.Item;\n+import org.dspace.importer.external.datamodel.ImportRecord;\n+import org.dspace.importer.external.datamodel.Query;\n+import org.dspace.importer.external.exception.MetadataSourceException;\n+\n+\n+/**\n+ * Common interface for database-based imports.\n+ *\n+ * @author Roeland Dillen (roeland at atmire dot com)\n+ * @author Pasquale Cavallo (pasquale.cavallo@4science.it)\n+ */\n+\n+public interface QuerySource extends MetadataSource {\n+\n+    /**\n+     * Get a single record from the source.\n+     * The first match will be returned\n+     *\n+     * @param id identifier for the record\n+     * @return a matching record\n+     * @throws MetadataSourceException if the underlying methods throw any exception.\n+     */\n+    public ImportRecord getRecord(String id) throws MetadataSourceException;\n+\n+    /**\n+     * Gets the number of records matching a query\n+     *\n+     * @param query the query in string format\n+     * @return the number of records matching the query\n+     * @throws MetadataSourceException if the underlying methods throw any exception.\n+     */\n+    public int getNbRecords(String query) throws MetadataSourceException;", "originalCommit": "eb4abb7d515a825d744424dfc99d6606a2b0d756", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYzOTgyOA==", "url": "https://github.com/DSpace/DSpace/pull/2791#discussion_r456639828", "bodyText": "Same here, I'd call this getRecordsCount to make it clearer.", "author": "tdonohue", "createdAt": "2020-07-17T19:42:11Z", "path": "dspace-api/src/main/java/org/dspace/importer/external/service/components/QuerySource.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+\n+package org.dspace.importer.external.service.components;\n+\n+import java.util.Collection;\n+\n+import org.dspace.content.Item;\n+import org.dspace.importer.external.datamodel.ImportRecord;\n+import org.dspace.importer.external.datamodel.Query;\n+import org.dspace.importer.external.exception.MetadataSourceException;\n+\n+\n+/**\n+ * Common interface for database-based imports.\n+ *\n+ * @author Roeland Dillen (roeland at atmire dot com)\n+ * @author Pasquale Cavallo (pasquale.cavallo@4science.it)\n+ */\n+\n+public interface QuerySource extends MetadataSource {\n+\n+    /**\n+     * Get a single record from the source.\n+     * The first match will be returned\n+     *\n+     * @param id identifier for the record\n+     * @return a matching record\n+     * @throws MetadataSourceException if the underlying methods throw any exception.\n+     */\n+    public ImportRecord getRecord(String id) throws MetadataSourceException;\n+\n+    /**\n+     * Gets the number of records matching a query\n+     *\n+     * @param query the query in string format\n+     * @return the number of records matching the query\n+     * @throws MetadataSourceException if the underlying methods throw any exception.\n+     */\n+    public int getNbRecords(String query) throws MetadataSourceException;\n+\n+    /**\n+     * Gets the number of records matching a query\n+     *\n+     * @param query the query object\n+     * @return the number of records matching the query\n+     * @throws MetadataSourceException if the underlying methods throw any exception.\n+     */\n+    public int getNbRecords(Query query) throws MetadataSourceException;", "originalCommit": "eb4abb7d515a825d744424dfc99d6606a2b0d756", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY0MTMyNg==", "url": "https://github.com/DSpace/DSpace/pull/2791#discussion_r456641326", "bodyText": "Thanks for this update.  This originally seemed odd that we were renaming the parameter.  But, it looks like our Contract does say it should be owningCollection and not collection: https://github.com/DSpace/Rest7Contract/blob/main/workspaceitems.md#multipart-post-method", "author": "tdonohue", "createdAt": "2020-07-17T19:45:37Z", "path": "dspace-server-webapp/src/main/java/org/dspace/app/rest/repository/WorkspaceItemRestRepository.java", "diffHunk": "@@ -360,147 +357,87 @@ protected void delete(Context context, Integer id) throws AuthorizeException {\n \n     @Override\n     public Iterable<WorkspaceItemRest> upload(Context context, HttpServletRequest request,\n-            MultipartFile uploadfile)\n+            List<MultipartFile> uploadfiles)\n         throws SQLException, FileNotFoundException, IOException, AuthorizeException {\n-        File file = Utils.getFile(uploadfile, \"upload-loader\", \"filedataloader\");\n         List<WorkspaceItemRest> results = new ArrayList<>();\n \n-        try {\n-            String uuid = request.getParameter(\"collection\");\n-            if (StringUtils.isBlank(uuid)) {\n-                uuid = configurationService.getProperty(\"submission.default.collection\");\n-            }\n-\n-            Collection collection = null;\n-            if (StringUtils.isNotBlank(uuid)) {\n-                collection = collectionService.find(context, UUID.fromString(uuid));\n-            } else {\n-                collection = collectionService.findAuthorizedOptimized(context, Constants.ADD).get(0);\n-            }\n-\n-            SubmissionConfig submissionConfig =\n-                submissionConfigReader.getSubmissionConfigByCollection(collection.getHandle());\n-\n-\n-            List<ItemSubmissionLookupDTO> tmpResult = new ArrayList<ItemSubmissionLookupDTO>();\n-\n-            TransformationEngine transformationEngine1 = submissionLookupService.getPhase1TransformationEngine();\n-            TransformationSpec spec = new TransformationSpec();\n-            // FIXME this is mostly due to the need to test. The BTE framework has an assert statement that check if the\n-            // number of found record is less than the requested and treat 0 as is, instead, the implementation assume\n-            // 0=unlimited this lead to test failure.\n-            // It is unclear if BTE really respect values other than 0/MAX allowing us to put a protection against heavy\n-            // load\n-            spec.setNumberOfRecords(Integer.MAX_VALUE);\n-            if (transformationEngine1 != null) {\n-                MultipleSubmissionLookupDataLoader dataLoader =\n-                    (MultipleSubmissionLookupDataLoader) transformationEngine1.getDataLoader();\n-\n-                List<String> fileDataLoaders = submissionLookupService.getFileProviders();\n-                for (String fileDataLoader : fileDataLoaders) {\n-                    dataLoader.setFile(file.getAbsolutePath(), fileDataLoader);\n-\n-                    try {\n-                        SubmissionLookupOutputGenerator outputGenerator =\n-                            (SubmissionLookupOutputGenerator) transformationEngine1.getOutputGenerator();\n-                        outputGenerator.setDtoList(new ArrayList<ItemSubmissionLookupDTO>());\n-                        log.debug(\"BTE transformation is about to start!\");\n-                        transformationEngine1.transform(spec);\n-                        log.debug(\"BTE transformation finished!\");\n-                        tmpResult.addAll(outputGenerator.getDtoList());\n-                        if (!tmpResult.isEmpty()) {\n-                            //exit with the results founded on the first data provided\n-                            break;\n-                        }\n-                    } catch (BadTransformationSpec e1) {\n-                        log.error(e1.getMessage(), e1);\n-                    } catch (MalformedSourceException e1) {\n-                        log.error(e1.getMessage(), e1);\n-                    }\n-                }\n-            }\n+        String uuid = request.getParameter(\"owningCollection\");", "originalCommit": "eb4abb7d515a825d744424dfc99d6606a2b0d756", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY0Mzg4Mw==", "url": "https://github.com/DSpace/DSpace/pull/2791#discussion_r456643883", "bodyText": "Tiny thing.  This takes in a file, not an inputstream.  Also, the description here is wrong.  It is not taking in an InputStream, and it also is closing the InputStream it uses to read the file.  So, I think this should be updated.", "author": "tdonohue", "createdAt": "2020-07-17T19:51:12Z", "path": "dspace-api/src/main/java/org/dspace/importer/external/service/ImportService.java", "diffHunk": "@@ -272,6 +296,36 @@ public ImportRecord getRecord(String uri, Query query) throws MetadataSourceExce\n         return importSources.keySet();\n     }\n \n+    /*\n+     * Get a collection of record from InputStream,\n+     * The first match will be return.\n+     * This method doesn't close the InputStream.\n+     * \n+     * @param fileInputStream the input stream to the resource", "originalCommit": "eb4abb7d515a825d744424dfc99d6606a2b0d756", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY0NTYxMQ==", "url": "https://github.com/DSpace/DSpace/pull/2791#discussion_r456645611", "bodyText": "Tiny thing here. This comment is wrongly describing the test.  The below test seems to be verifying we only create one workspaceitem, even if we upload multiple bibliographic files.  The test is correct, but this description is incorrect, as we are not creating multiple workspaceitems here.", "author": "tdonohue", "createdAt": "2020-07-17T19:55:05Z", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java", "diffHunk": "@@ -907,42 +907,245 @@ public void createMultipleWorkspaceItemFromFileTest() throws Exception {\n                         is(\"My Article\")))\n                 .andExpect(\n                         jsonPath(\"$._embedded.workspaceitems[0]._embedded.collection.id\", is(col1.getID().toString())))\n-                .andExpect(jsonPath(\"$._embedded.workspaceitems[1].sections.traditionalpageone['dc.title'][0].value\",\n-                        is(\"My Article 2\")))\n-                .andExpect(\n-                        jsonPath(\"$._embedded.workspaceitems[1]._embedded.collection.id\", is(col1.getID().toString())))\n-                .andExpect(jsonPath(\"$._embedded.workspaceitems[2].sections.traditionalpageone['dc.title'][0].value\",\n-                        is(\"My Article 3\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[0]\"\n+                     + \".metadata['dc.source'][0].value\",\n+                        is(\"/local/path/bibtex-test.bib\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[0]\"\n+                     + \".metadata['dc.title'][0].value\",\n+                        is(\"bibtex-test.bib\")))\n                 .andExpect(\n-                        jsonPath(\"$._embedded.workspaceitems[2]._embedded.collection.id\", is(col1.getID().toString())))\n-                .andExpect(\n-                        jsonPath(\"$._embedded.workspaceitems[*]._embedded.upload\").doesNotExist())\n+                        jsonPath(\"$._embedded.workspaceitems[*]._embedded.upload\").doesNotExist());\n         ;\n \n         // bulk create workspaceitems explicitly in the col2\n         getClient(authToken).perform(fileUpload(\"/api/submission/workspaceitems\")\n                     .file(bibtexFile)\n-                    .param(\"collection\", col2.getID().toString()))\n+                    .param(\"owningCollection\", col2.getID().toString()))\n                 .andExpect(status().isOk())\n                 .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.traditionalpageone['dc.title'][0].value\",\n                         is(\"My Article\")))\n                 .andExpect(\n                         jsonPath(\"$._embedded.workspaceitems[0]._embedded.collection.id\", is(col2.getID().toString())))\n-                .andExpect(jsonPath(\"$._embedded.workspaceitems[1].sections.traditionalpageone['dc.title'][0].value\",\n-                        is(\"My Article 2\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[0]\"\n+                     + \".metadata['dc.source'][0].value\",\n+                        is(\"/local/path/bibtex-test.bib\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload\"\n+                     + \".files[0].metadata['dc.title'][0].value\",\n+                        is(\"bibtex-test.bib\")))\n                 .andExpect(\n-                        jsonPath(\"$._embedded.workspaceitems[1]._embedded.collection.id\", is(col2.getID().toString())))\n-                .andExpect(jsonPath(\"$._embedded.workspaceitems[2].sections.traditionalpageone['dc.title'][0].value\",\n-                        is(\"My Article 3\")))\n+                        jsonPath(\"$._embedded.workspaceitems[*]._embedded.upload\").doesNotExist());\n+\n+        bibtex.close();\n+    }\n+\n+\n+\n+    @Test\n+    /**\n+     * Test the creation of workspaceitems POSTing to the resource collection endpoint a\n+     * bibtex and pubmed files\n+     *\n+     * @throws Exception\n+     */\n+    public void createSingleWorkspaceItemFromMultipleFilesWithOneEntryTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+        //** GIVEN **\n+        //1. A community-collection structure with one parent community with sub-community and two collections.\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                                          .withName(\"Parent Community\")\n+                                          .build();\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                                           .withName(\"Sub Community\")\n+                                           .build();\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                                           .withName(\"Collection 1\")\n+                                           .withSubmitterGroup(eperson)\n+                                           .build();\n+        Collection col2 = CollectionBuilder.createCollection(context, child1)\n+                                           .withName(\"Collection 2\")\n+                                           .withSubmitterGroup(eperson)\n+                                           .build();\n+\n+        InputStream bibtex = getClass().getResourceAsStream(\"bibtex-test.bib\");\n+        final MockMultipartFile bibtexFile = new MockMultipartFile(\"file\", \"/local/path/bibtex-test.bib\",\n+            \"application/x-bibtex\", bibtex);\n+        InputStream xmlIS = getClass().getResourceAsStream(\"pubmed-test.xml\");\n+        final MockMultipartFile pubmedFile = new MockMultipartFile(\"file\", \"/local/path/pubmed-test.xml\",\n+            \"application/xml\", xmlIS);\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+        // bulk create workspaceitems in the default collection (col1)\n+        getClient(authToken).perform(fileUpload(\"/api/submission/workspaceitems\")\n+                    .file(bibtexFile).file(pubmedFile))\n+                // bulk create should return 200, 201 (created) is better for single resource\n+                .andExpect(status().isOk())\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.traditionalpageone['dc.title'][0].value\",\n+                        is(\"My Article\")))\n                 .andExpect(\n-                        jsonPath(\"$._embedded.workspaceitems[2]._embedded.collection.id\", is(col2.getID().toString())))\n+                        jsonPath(\"$._embedded.workspaceitems[0]._embedded.collection.id\", is(col1.getID().toString())))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[0]\"\n+                     + \".metadata['dc.source'][0].value\",\n+                        is(\"/local/path/bibtex-test.bib\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[0]\"\n+                     + \".metadata['dc.title'][0].value\",\n+                        is(\"bibtex-test.bib\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.traditionalpageone['dc.title'][1].value\")\n+                    .doesNotExist())\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[1]\"\n+                        + \".metadata['dc.source'][0].value\",\n+                            is(\"/local/path/pubmed-test.xml\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[1]\"\n+                        + \".metadata['dc.title'][0].value\",\n+                            is(\"pubmed-test.xml\")));\n+\n+        // bulk create workspaceitems explicitly in the col2", "originalCommit": "eb4abb7d515a825d744424dfc99d6606a2b0d756", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY0NjEyMQ==", "url": "https://github.com/DSpace/DSpace/pull/2791#discussion_r456646121", "bodyText": "Inline comments here are wrong (on lines 1068 and 1065).  This code is correctly returning a 422 because we don't allow/support bibliographic files that have multiple metadata records.", "author": "tdonohue", "createdAt": "2020-07-17T19:56:20Z", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java", "diffHunk": "@@ -907,42 +907,245 @@ public void createMultipleWorkspaceItemFromFileTest() throws Exception {\n                         is(\"My Article\")))\n                 .andExpect(\n                         jsonPath(\"$._embedded.workspaceitems[0]._embedded.collection.id\", is(col1.getID().toString())))\n-                .andExpect(jsonPath(\"$._embedded.workspaceitems[1].sections.traditionalpageone['dc.title'][0].value\",\n-                        is(\"My Article 2\")))\n-                .andExpect(\n-                        jsonPath(\"$._embedded.workspaceitems[1]._embedded.collection.id\", is(col1.getID().toString())))\n-                .andExpect(jsonPath(\"$._embedded.workspaceitems[2].sections.traditionalpageone['dc.title'][0].value\",\n-                        is(\"My Article 3\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[0]\"\n+                     + \".metadata['dc.source'][0].value\",\n+                        is(\"/local/path/bibtex-test.bib\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[0]\"\n+                     + \".metadata['dc.title'][0].value\",\n+                        is(\"bibtex-test.bib\")))\n                 .andExpect(\n-                        jsonPath(\"$._embedded.workspaceitems[2]._embedded.collection.id\", is(col1.getID().toString())))\n-                .andExpect(\n-                        jsonPath(\"$._embedded.workspaceitems[*]._embedded.upload\").doesNotExist())\n+                        jsonPath(\"$._embedded.workspaceitems[*]._embedded.upload\").doesNotExist());\n         ;\n \n         // bulk create workspaceitems explicitly in the col2\n         getClient(authToken).perform(fileUpload(\"/api/submission/workspaceitems\")\n                     .file(bibtexFile)\n-                    .param(\"collection\", col2.getID().toString()))\n+                    .param(\"owningCollection\", col2.getID().toString()))\n                 .andExpect(status().isOk())\n                 .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.traditionalpageone['dc.title'][0].value\",\n                         is(\"My Article\")))\n                 .andExpect(\n                         jsonPath(\"$._embedded.workspaceitems[0]._embedded.collection.id\", is(col2.getID().toString())))\n-                .andExpect(jsonPath(\"$._embedded.workspaceitems[1].sections.traditionalpageone['dc.title'][0].value\",\n-                        is(\"My Article 2\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[0]\"\n+                     + \".metadata['dc.source'][0].value\",\n+                        is(\"/local/path/bibtex-test.bib\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload\"\n+                     + \".files[0].metadata['dc.title'][0].value\",\n+                        is(\"bibtex-test.bib\")))\n                 .andExpect(\n-                        jsonPath(\"$._embedded.workspaceitems[1]._embedded.collection.id\", is(col2.getID().toString())))\n-                .andExpect(jsonPath(\"$._embedded.workspaceitems[2].sections.traditionalpageone['dc.title'][0].value\",\n-                        is(\"My Article 3\")))\n+                        jsonPath(\"$._embedded.workspaceitems[*]._embedded.upload\").doesNotExist());\n+\n+        bibtex.close();\n+    }\n+\n+\n+\n+    @Test\n+    /**\n+     * Test the creation of workspaceitems POSTing to the resource collection endpoint a\n+     * bibtex and pubmed files\n+     *\n+     * @throws Exception\n+     */\n+    public void createSingleWorkspaceItemFromMultipleFilesWithOneEntryTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+        //** GIVEN **\n+        //1. A community-collection structure with one parent community with sub-community and two collections.\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                                          .withName(\"Parent Community\")\n+                                          .build();\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                                           .withName(\"Sub Community\")\n+                                           .build();\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                                           .withName(\"Collection 1\")\n+                                           .withSubmitterGroup(eperson)\n+                                           .build();\n+        Collection col2 = CollectionBuilder.createCollection(context, child1)\n+                                           .withName(\"Collection 2\")\n+                                           .withSubmitterGroup(eperson)\n+                                           .build();\n+\n+        InputStream bibtex = getClass().getResourceAsStream(\"bibtex-test.bib\");\n+        final MockMultipartFile bibtexFile = new MockMultipartFile(\"file\", \"/local/path/bibtex-test.bib\",\n+            \"application/x-bibtex\", bibtex);\n+        InputStream xmlIS = getClass().getResourceAsStream(\"pubmed-test.xml\");\n+        final MockMultipartFile pubmedFile = new MockMultipartFile(\"file\", \"/local/path/pubmed-test.xml\",\n+            \"application/xml\", xmlIS);\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+        // bulk create workspaceitems in the default collection (col1)\n+        getClient(authToken).perform(fileUpload(\"/api/submission/workspaceitems\")\n+                    .file(bibtexFile).file(pubmedFile))\n+                // bulk create should return 200, 201 (created) is better for single resource\n+                .andExpect(status().isOk())\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.traditionalpageone['dc.title'][0].value\",\n+                        is(\"My Article\")))\n                 .andExpect(\n-                        jsonPath(\"$._embedded.workspaceitems[2]._embedded.collection.id\", is(col2.getID().toString())))\n+                        jsonPath(\"$._embedded.workspaceitems[0]._embedded.collection.id\", is(col1.getID().toString())))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[0]\"\n+                     + \".metadata['dc.source'][0].value\",\n+                        is(\"/local/path/bibtex-test.bib\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[0]\"\n+                     + \".metadata['dc.title'][0].value\",\n+                        is(\"bibtex-test.bib\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.traditionalpageone['dc.title'][1].value\")\n+                    .doesNotExist())\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[1]\"\n+                        + \".metadata['dc.source'][0].value\",\n+                            is(\"/local/path/pubmed-test.xml\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[1]\"\n+                        + \".metadata['dc.title'][0].value\",\n+                            is(\"pubmed-test.xml\")));\n+\n+        // bulk create workspaceitems explicitly in the col2\n+        getClient(authToken).perform(fileUpload(\"/api/submission/workspaceitems\")\n+                    .file(bibtexFile).file(pubmedFile)\n+                    .param(\"owningCollection\", col2.getID().toString()))\n+                .andExpect(status().isOk())\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.traditionalpageone['dc.title'][0].value\",\n+                        is(\"My Article\")))\n                 .andExpect(\n-                        jsonPath(\"$._embedded.workspaceitems[*]._embedded.upload\").doesNotExist())\n-        ;\n+                        jsonPath(\"$._embedded.workspaceitems[0]._embedded.collection.id\", is(col2.getID().toString())))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[0]\"\n+                     + \".metadata['dc.source'][0].value\",\n+                        is(\"/local/path/bibtex-test.bib\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload\"\n+                     + \".files[0].metadata['dc.title'][0].value\",\n+                        is(\"bibtex-test.bib\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.traditionalpageone['dc.title'][1].value\")\n+                        .doesNotExist())\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[1]\"\n+                     + \".metadata['dc.source'][0].value\",\n+                         is(\"/local/path/pubmed-test.xml\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[1]\"\n+                     + \".metadata['dc.title'][0].value\",\n+                         is(\"pubmed-test.xml\")));\n+        bibtex.close();\n+        xmlIS.close();\n+    }\n+\n+    @Test\n+    /**\n+     * Test the creation of workspaceitems POSTing to the resource collection endpoint a bibtex file\n+     * contains more than one entry.\n+     * \n+     * @throws Exception\n+     */\n+    public void createSingleWorkspaceItemsFromSingleFileWithMultipleEntriesTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n \n+        //** GIVEN **\n+        //1. A community-collection structure with one parent community with sub-community and two collections.\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                                          .withName(\"Parent Community\")\n+                                          .build();\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                                           .withName(\"Sub Community\")\n+                                           .build();\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                                           .withName(\"Collection 1\")\n+                                           .withSubmitterGroup(eperson)\n+                                           .build();\n+        Collection col2 = CollectionBuilder.createCollection(context, child1)\n+                                           .withName(\"Collection 2\")\n+                                           .withSubmitterGroup(eperson)\n+                                           .build();\n+\n+        InputStream bibtex = getClass().getResourceAsStream(\"bibtex-test-3-entries.bib\");\n+        final MockMultipartFile bibtexFile = new MockMultipartFile(\"file\", \"bibtex-test-3-entries.bib\",\n+            \"application/x-bibtex\",\n+                bibtex);\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+        // bulk create workspaceitems in the default collection (col1)\n+        getClient(authToken).perform(fileUpload(\"/api/submission/workspaceitems\")\n+                    .file(bibtexFile))\n+                // bulk create should return 200, 201 (created) is better for single resource\n+                .andExpect(status().is(422));", "originalCommit": "eb4abb7d515a825d744424dfc99d6606a2b0d756", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY0NjcwNw==", "url": "https://github.com/DSpace/DSpace/pull/2791#discussion_r456646707", "bodyText": "Again, test looks good. But comments on line 1109 and 1106 are wrong. We're not doing a bulk create test. This is testing a single PubMed file upload is working as expected.", "author": "tdonohue", "createdAt": "2020-07-17T19:57:36Z", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java", "diffHunk": "@@ -907,42 +907,245 @@ public void createMultipleWorkspaceItemFromFileTest() throws Exception {\n                         is(\"My Article\")))\n                 .andExpect(\n                         jsonPath(\"$._embedded.workspaceitems[0]._embedded.collection.id\", is(col1.getID().toString())))\n-                .andExpect(jsonPath(\"$._embedded.workspaceitems[1].sections.traditionalpageone['dc.title'][0].value\",\n-                        is(\"My Article 2\")))\n-                .andExpect(\n-                        jsonPath(\"$._embedded.workspaceitems[1]._embedded.collection.id\", is(col1.getID().toString())))\n-                .andExpect(jsonPath(\"$._embedded.workspaceitems[2].sections.traditionalpageone['dc.title'][0].value\",\n-                        is(\"My Article 3\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[0]\"\n+                     + \".metadata['dc.source'][0].value\",\n+                        is(\"/local/path/bibtex-test.bib\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[0]\"\n+                     + \".metadata['dc.title'][0].value\",\n+                        is(\"bibtex-test.bib\")))\n                 .andExpect(\n-                        jsonPath(\"$._embedded.workspaceitems[2]._embedded.collection.id\", is(col1.getID().toString())))\n-                .andExpect(\n-                        jsonPath(\"$._embedded.workspaceitems[*]._embedded.upload\").doesNotExist())\n+                        jsonPath(\"$._embedded.workspaceitems[*]._embedded.upload\").doesNotExist());\n         ;\n \n         // bulk create workspaceitems explicitly in the col2\n         getClient(authToken).perform(fileUpload(\"/api/submission/workspaceitems\")\n                     .file(bibtexFile)\n-                    .param(\"collection\", col2.getID().toString()))\n+                    .param(\"owningCollection\", col2.getID().toString()))\n                 .andExpect(status().isOk())\n                 .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.traditionalpageone['dc.title'][0].value\",\n                         is(\"My Article\")))\n                 .andExpect(\n                         jsonPath(\"$._embedded.workspaceitems[0]._embedded.collection.id\", is(col2.getID().toString())))\n-                .andExpect(jsonPath(\"$._embedded.workspaceitems[1].sections.traditionalpageone['dc.title'][0].value\",\n-                        is(\"My Article 2\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[0]\"\n+                     + \".metadata['dc.source'][0].value\",\n+                        is(\"/local/path/bibtex-test.bib\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload\"\n+                     + \".files[0].metadata['dc.title'][0].value\",\n+                        is(\"bibtex-test.bib\")))\n                 .andExpect(\n-                        jsonPath(\"$._embedded.workspaceitems[1]._embedded.collection.id\", is(col2.getID().toString())))\n-                .andExpect(jsonPath(\"$._embedded.workspaceitems[2].sections.traditionalpageone['dc.title'][0].value\",\n-                        is(\"My Article 3\")))\n+                        jsonPath(\"$._embedded.workspaceitems[*]._embedded.upload\").doesNotExist());\n+\n+        bibtex.close();\n+    }\n+\n+\n+\n+    @Test\n+    /**\n+     * Test the creation of workspaceitems POSTing to the resource collection endpoint a\n+     * bibtex and pubmed files\n+     *\n+     * @throws Exception\n+     */\n+    public void createSingleWorkspaceItemFromMultipleFilesWithOneEntryTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+        //** GIVEN **\n+        //1. A community-collection structure with one parent community with sub-community and two collections.\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                                          .withName(\"Parent Community\")\n+                                          .build();\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                                           .withName(\"Sub Community\")\n+                                           .build();\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                                           .withName(\"Collection 1\")\n+                                           .withSubmitterGroup(eperson)\n+                                           .build();\n+        Collection col2 = CollectionBuilder.createCollection(context, child1)\n+                                           .withName(\"Collection 2\")\n+                                           .withSubmitterGroup(eperson)\n+                                           .build();\n+\n+        InputStream bibtex = getClass().getResourceAsStream(\"bibtex-test.bib\");\n+        final MockMultipartFile bibtexFile = new MockMultipartFile(\"file\", \"/local/path/bibtex-test.bib\",\n+            \"application/x-bibtex\", bibtex);\n+        InputStream xmlIS = getClass().getResourceAsStream(\"pubmed-test.xml\");\n+        final MockMultipartFile pubmedFile = new MockMultipartFile(\"file\", \"/local/path/pubmed-test.xml\",\n+            \"application/xml\", xmlIS);\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+        // bulk create workspaceitems in the default collection (col1)\n+        getClient(authToken).perform(fileUpload(\"/api/submission/workspaceitems\")\n+                    .file(bibtexFile).file(pubmedFile))\n+                // bulk create should return 200, 201 (created) is better for single resource\n+                .andExpect(status().isOk())\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.traditionalpageone['dc.title'][0].value\",\n+                        is(\"My Article\")))\n                 .andExpect(\n-                        jsonPath(\"$._embedded.workspaceitems[2]._embedded.collection.id\", is(col2.getID().toString())))\n+                        jsonPath(\"$._embedded.workspaceitems[0]._embedded.collection.id\", is(col1.getID().toString())))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[0]\"\n+                     + \".metadata['dc.source'][0].value\",\n+                        is(\"/local/path/bibtex-test.bib\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[0]\"\n+                     + \".metadata['dc.title'][0].value\",\n+                        is(\"bibtex-test.bib\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.traditionalpageone['dc.title'][1].value\")\n+                    .doesNotExist())\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[1]\"\n+                        + \".metadata['dc.source'][0].value\",\n+                            is(\"/local/path/pubmed-test.xml\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[1]\"\n+                        + \".metadata['dc.title'][0].value\",\n+                            is(\"pubmed-test.xml\")));\n+\n+        // bulk create workspaceitems explicitly in the col2\n+        getClient(authToken).perform(fileUpload(\"/api/submission/workspaceitems\")\n+                    .file(bibtexFile).file(pubmedFile)\n+                    .param(\"owningCollection\", col2.getID().toString()))\n+                .andExpect(status().isOk())\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.traditionalpageone['dc.title'][0].value\",\n+                        is(\"My Article\")))\n                 .andExpect(\n-                        jsonPath(\"$._embedded.workspaceitems[*]._embedded.upload\").doesNotExist())\n-        ;\n+                        jsonPath(\"$._embedded.workspaceitems[0]._embedded.collection.id\", is(col2.getID().toString())))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[0]\"\n+                     + \".metadata['dc.source'][0].value\",\n+                        is(\"/local/path/bibtex-test.bib\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload\"\n+                     + \".files[0].metadata['dc.title'][0].value\",\n+                        is(\"bibtex-test.bib\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.traditionalpageone['dc.title'][1].value\")\n+                        .doesNotExist())\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[1]\"\n+                     + \".metadata['dc.source'][0].value\",\n+                         is(\"/local/path/pubmed-test.xml\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[1]\"\n+                     + \".metadata['dc.title'][0].value\",\n+                         is(\"pubmed-test.xml\")));\n+        bibtex.close();\n+        xmlIS.close();\n+    }\n+\n+    @Test\n+    /**\n+     * Test the creation of workspaceitems POSTing to the resource collection endpoint a bibtex file\n+     * contains more than one entry.\n+     * \n+     * @throws Exception\n+     */\n+    public void createSingleWorkspaceItemsFromSingleFileWithMultipleEntriesTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n \n+        //** GIVEN **\n+        //1. A community-collection structure with one parent community with sub-community and two collections.\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                                          .withName(\"Parent Community\")\n+                                          .build();\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                                           .withName(\"Sub Community\")\n+                                           .build();\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                                           .withName(\"Collection 1\")\n+                                           .withSubmitterGroup(eperson)\n+                                           .build();\n+        Collection col2 = CollectionBuilder.createCollection(context, child1)\n+                                           .withName(\"Collection 2\")\n+                                           .withSubmitterGroup(eperson)\n+                                           .build();\n+\n+        InputStream bibtex = getClass().getResourceAsStream(\"bibtex-test-3-entries.bib\");\n+        final MockMultipartFile bibtexFile = new MockMultipartFile(\"file\", \"bibtex-test-3-entries.bib\",\n+            \"application/x-bibtex\",\n+                bibtex);\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+        // bulk create workspaceitems in the default collection (col1)\n+        getClient(authToken).perform(fileUpload(\"/api/submission/workspaceitems\")\n+                    .file(bibtexFile))\n+                // bulk create should return 200, 201 (created) is better for single resource\n+                .andExpect(status().is(422));\n         bibtex.close();\n     }\n \n+    @Test\n+    /**\n+     * Test the creation of workspaceitems POSTing to the resource collection endpoint a pubmed XML\n+     * file.\n+     * \n+     * @throws Exception\n+     */\n+    public void createPubmedWorkspaceItemFromFileTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        //** GIVEN **\n+        //1. A community-collection structure with one parent community with sub-community and two collections.\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                                          .withName(\"Parent Community\")\n+                                          .build();\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                                           .withName(\"Sub Community\")\n+                                           .build();\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                                           .withName(\"Collection 1\")\n+                                           .withSubmitterGroup(eperson)\n+                                           .build();\n+        Collection col2 = CollectionBuilder.createCollection(context, child1)\n+                                           .withName(\"Collection 2\")\n+                                           .withSubmitterGroup(eperson)\n+                                           .build();\n+        InputStream xmlIS = getClass().getResourceAsStream(\"pubmed-test.xml\");\n+        final MockMultipartFile pubmedFile = new MockMultipartFile(\"file\", \"/local/path/pubmed-test.xml\",\n+            \"application/xml\", xmlIS);\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+        // bulk create workspaceitems in the default collection (col1)\n+        getClient(authToken).perform(fileUpload(\"/api/submission/workspaceitems\")\n+                    .file(pubmedFile))\n+                // bulk create should return 200, 201 (created) is better for single resource\n+                .andExpect(status().isOk())", "originalCommit": "eb4abb7d515a825d744424dfc99d6606a2b0d756", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjY0NzQxNw==", "url": "https://github.com/DSpace/DSpace/pull/2791#discussion_r456647417", "bodyText": "Test is again correct, but the comment is slightly wrong.  This test is making sure we can create a single workspaceitem in a specific collection.", "author": "tdonohue", "createdAt": "2020-07-17T19:59:11Z", "path": "dspace-server-webapp/src/test/java/org/dspace/app/rest/WorkspaceItemRestRepositoryIT.java", "diffHunk": "@@ -907,42 +907,245 @@ public void createMultipleWorkspaceItemFromFileTest() throws Exception {\n                         is(\"My Article\")))\n                 .andExpect(\n                         jsonPath(\"$._embedded.workspaceitems[0]._embedded.collection.id\", is(col1.getID().toString())))\n-                .andExpect(jsonPath(\"$._embedded.workspaceitems[1].sections.traditionalpageone['dc.title'][0].value\",\n-                        is(\"My Article 2\")))\n-                .andExpect(\n-                        jsonPath(\"$._embedded.workspaceitems[1]._embedded.collection.id\", is(col1.getID().toString())))\n-                .andExpect(jsonPath(\"$._embedded.workspaceitems[2].sections.traditionalpageone['dc.title'][0].value\",\n-                        is(\"My Article 3\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[0]\"\n+                     + \".metadata['dc.source'][0].value\",\n+                        is(\"/local/path/bibtex-test.bib\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[0]\"\n+                     + \".metadata['dc.title'][0].value\",\n+                        is(\"bibtex-test.bib\")))\n                 .andExpect(\n-                        jsonPath(\"$._embedded.workspaceitems[2]._embedded.collection.id\", is(col1.getID().toString())))\n-                .andExpect(\n-                        jsonPath(\"$._embedded.workspaceitems[*]._embedded.upload\").doesNotExist())\n+                        jsonPath(\"$._embedded.workspaceitems[*]._embedded.upload\").doesNotExist());\n         ;\n \n         // bulk create workspaceitems explicitly in the col2\n         getClient(authToken).perform(fileUpload(\"/api/submission/workspaceitems\")\n                     .file(bibtexFile)\n-                    .param(\"collection\", col2.getID().toString()))\n+                    .param(\"owningCollection\", col2.getID().toString()))\n                 .andExpect(status().isOk())\n                 .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.traditionalpageone['dc.title'][0].value\",\n                         is(\"My Article\")))\n                 .andExpect(\n                         jsonPath(\"$._embedded.workspaceitems[0]._embedded.collection.id\", is(col2.getID().toString())))\n-                .andExpect(jsonPath(\"$._embedded.workspaceitems[1].sections.traditionalpageone['dc.title'][0].value\",\n-                        is(\"My Article 2\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[0]\"\n+                     + \".metadata['dc.source'][0].value\",\n+                        is(\"/local/path/bibtex-test.bib\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload\"\n+                     + \".files[0].metadata['dc.title'][0].value\",\n+                        is(\"bibtex-test.bib\")))\n                 .andExpect(\n-                        jsonPath(\"$._embedded.workspaceitems[1]._embedded.collection.id\", is(col2.getID().toString())))\n-                .andExpect(jsonPath(\"$._embedded.workspaceitems[2].sections.traditionalpageone['dc.title'][0].value\",\n-                        is(\"My Article 3\")))\n+                        jsonPath(\"$._embedded.workspaceitems[*]._embedded.upload\").doesNotExist());\n+\n+        bibtex.close();\n+    }\n+\n+\n+\n+    @Test\n+    /**\n+     * Test the creation of workspaceitems POSTing to the resource collection endpoint a\n+     * bibtex and pubmed files\n+     *\n+     * @throws Exception\n+     */\n+    public void createSingleWorkspaceItemFromMultipleFilesWithOneEntryTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+        //** GIVEN **\n+        //1. A community-collection structure with one parent community with sub-community and two collections.\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                                          .withName(\"Parent Community\")\n+                                          .build();\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                                           .withName(\"Sub Community\")\n+                                           .build();\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                                           .withName(\"Collection 1\")\n+                                           .withSubmitterGroup(eperson)\n+                                           .build();\n+        Collection col2 = CollectionBuilder.createCollection(context, child1)\n+                                           .withName(\"Collection 2\")\n+                                           .withSubmitterGroup(eperson)\n+                                           .build();\n+\n+        InputStream bibtex = getClass().getResourceAsStream(\"bibtex-test.bib\");\n+        final MockMultipartFile bibtexFile = new MockMultipartFile(\"file\", \"/local/path/bibtex-test.bib\",\n+            \"application/x-bibtex\", bibtex);\n+        InputStream xmlIS = getClass().getResourceAsStream(\"pubmed-test.xml\");\n+        final MockMultipartFile pubmedFile = new MockMultipartFile(\"file\", \"/local/path/pubmed-test.xml\",\n+            \"application/xml\", xmlIS);\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+        // bulk create workspaceitems in the default collection (col1)\n+        getClient(authToken).perform(fileUpload(\"/api/submission/workspaceitems\")\n+                    .file(bibtexFile).file(pubmedFile))\n+                // bulk create should return 200, 201 (created) is better for single resource\n+                .andExpect(status().isOk())\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.traditionalpageone['dc.title'][0].value\",\n+                        is(\"My Article\")))\n                 .andExpect(\n-                        jsonPath(\"$._embedded.workspaceitems[2]._embedded.collection.id\", is(col2.getID().toString())))\n+                        jsonPath(\"$._embedded.workspaceitems[0]._embedded.collection.id\", is(col1.getID().toString())))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[0]\"\n+                     + \".metadata['dc.source'][0].value\",\n+                        is(\"/local/path/bibtex-test.bib\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[0]\"\n+                     + \".metadata['dc.title'][0].value\",\n+                        is(\"bibtex-test.bib\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.traditionalpageone['dc.title'][1].value\")\n+                    .doesNotExist())\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[1]\"\n+                        + \".metadata['dc.source'][0].value\",\n+                            is(\"/local/path/pubmed-test.xml\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[1]\"\n+                        + \".metadata['dc.title'][0].value\",\n+                            is(\"pubmed-test.xml\")));\n+\n+        // bulk create workspaceitems explicitly in the col2\n+        getClient(authToken).perform(fileUpload(\"/api/submission/workspaceitems\")\n+                    .file(bibtexFile).file(pubmedFile)\n+                    .param(\"owningCollection\", col2.getID().toString()))\n+                .andExpect(status().isOk())\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.traditionalpageone['dc.title'][0].value\",\n+                        is(\"My Article\")))\n                 .andExpect(\n-                        jsonPath(\"$._embedded.workspaceitems[*]._embedded.upload\").doesNotExist())\n-        ;\n+                        jsonPath(\"$._embedded.workspaceitems[0]._embedded.collection.id\", is(col2.getID().toString())))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[0]\"\n+                     + \".metadata['dc.source'][0].value\",\n+                        is(\"/local/path/bibtex-test.bib\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload\"\n+                     + \".files[0].metadata['dc.title'][0].value\",\n+                        is(\"bibtex-test.bib\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.traditionalpageone['dc.title'][1].value\")\n+                        .doesNotExist())\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[1]\"\n+                     + \".metadata['dc.source'][0].value\",\n+                         is(\"/local/path/pubmed-test.xml\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[1]\"\n+                     + \".metadata['dc.title'][0].value\",\n+                         is(\"pubmed-test.xml\")));\n+        bibtex.close();\n+        xmlIS.close();\n+    }\n+\n+    @Test\n+    /**\n+     * Test the creation of workspaceitems POSTing to the resource collection endpoint a bibtex file\n+     * contains more than one entry.\n+     * \n+     * @throws Exception\n+     */\n+    public void createSingleWorkspaceItemsFromSingleFileWithMultipleEntriesTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n \n+        //** GIVEN **\n+        //1. A community-collection structure with one parent community with sub-community and two collections.\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                                          .withName(\"Parent Community\")\n+                                          .build();\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                                           .withName(\"Sub Community\")\n+                                           .build();\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                                           .withName(\"Collection 1\")\n+                                           .withSubmitterGroup(eperson)\n+                                           .build();\n+        Collection col2 = CollectionBuilder.createCollection(context, child1)\n+                                           .withName(\"Collection 2\")\n+                                           .withSubmitterGroup(eperson)\n+                                           .build();\n+\n+        InputStream bibtex = getClass().getResourceAsStream(\"bibtex-test-3-entries.bib\");\n+        final MockMultipartFile bibtexFile = new MockMultipartFile(\"file\", \"bibtex-test-3-entries.bib\",\n+            \"application/x-bibtex\",\n+                bibtex);\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+        // bulk create workspaceitems in the default collection (col1)\n+        getClient(authToken).perform(fileUpload(\"/api/submission/workspaceitems\")\n+                    .file(bibtexFile))\n+                // bulk create should return 200, 201 (created) is better for single resource\n+                .andExpect(status().is(422));\n         bibtex.close();\n     }\n \n+    @Test\n+    /**\n+     * Test the creation of workspaceitems POSTing to the resource collection endpoint a pubmed XML\n+     * file.\n+     * \n+     * @throws Exception\n+     */\n+    public void createPubmedWorkspaceItemFromFileTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+\n+        //** GIVEN **\n+        //1. A community-collection structure with one parent community with sub-community and two collections.\n+        parentCommunity = CommunityBuilder.createCommunity(context)\n+                                          .withName(\"Parent Community\")\n+                                          .build();\n+        Community child1 = CommunityBuilder.createSubCommunity(context, parentCommunity)\n+                                           .withName(\"Sub Community\")\n+                                           .build();\n+        Collection col1 = CollectionBuilder.createCollection(context, child1)\n+                                           .withName(\"Collection 1\")\n+                                           .withSubmitterGroup(eperson)\n+                                           .build();\n+        Collection col2 = CollectionBuilder.createCollection(context, child1)\n+                                           .withName(\"Collection 2\")\n+                                           .withSubmitterGroup(eperson)\n+                                           .build();\n+        InputStream xmlIS = getClass().getResourceAsStream(\"pubmed-test.xml\");\n+        final MockMultipartFile pubmedFile = new MockMultipartFile(\"file\", \"/local/path/pubmed-test.xml\",\n+            \"application/xml\", xmlIS);\n+\n+        context.restoreAuthSystemState();\n+\n+        String authToken = getAuthToken(eperson.getEmail(), password);\n+        // bulk create workspaceitems in the default collection (col1)\n+        getClient(authToken).perform(fileUpload(\"/api/submission/workspaceitems\")\n+                    .file(pubmedFile))\n+                // bulk create should return 200, 201 (created) is better for single resource\n+                .andExpect(status().isOk())\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.traditionalpageone['dc.title'][0].value\",\n+                        is(\"Multistep microreactions with proteins using electrocapture technology.\")))\n+                .andExpect(\n+                        jsonPath(\n+                        \"$._embedded.workspaceitems[0].sections.traditionalpageone['dc.identifier.other'][0].value\",\n+                        is(\"15117179\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.traditionalpageone\"\n+                        + \"['dc.contributor.author'][0].value\",\n+                        is(\"Astorga-Wells, Juan\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[0]\"\n+                    + \".metadata['dc.source'][0].value\",\n+                        is(\"/local/path/pubmed-test.xml\")))\n+                .andExpect(jsonPath(\"$._embedded.workspaceitems[0].sections.upload.files[0]\"\n+                    + \".metadata['dc.title'][0].value\",\n+                        is(\"pubmed-test.xml\")));\n+\n+        // bulk create workspaceitems explicitly in the col2\n+        getClient(authToken).perform(fileUpload(\"/api/submission/workspaceitems\")\n+                    .file(pubmedFile)\n+                    .param(\"owningCollection\", col2.getID().toString()))\n+            .andExpect(status().isOk())", "originalCommit": "eb4abb7d515a825d744424dfc99d6606a2b0d756", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5cdc55163a00708c3c45924cf699c44fd188660d", "url": "https://github.com/DSpace/DSpace/commit/5cdc55163a00708c3c45924cf699c44fd188660d", "message": "Implement community feedbacks", "committedDate": "2020-07-20T11:06:46Z", "type": "commit"}, {"oid": "575ce02077ac7438e70e8508a25129ac365b2341", "url": "https://github.com/DSpace/DSpace/commit/575ce02077ac7438e70e8508a25129ac365b2341", "message": "update comments", "committedDate": "2020-07-20T13:32:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ3NDA5Nw==", "url": "https://github.com/DSpace/DSpace/pull/2791#discussion_r461474097", "bodyText": "This exception is thrown in the getRecord() method if the provided file doesn't match the format for that source. If you have for example 5 sources & the last source is a match than 4 exceptions will be thrown and caught here.\nThis would mean that the \"exception\" isn't really an exception but the most common output.\nI would remove this catch & either add a \"supports()\" or an \"isValidFileForSource()\" method (or something similar) to the FileSource class. This way you can validate a file before you attempt to parse it.", "author": "KevinVdV", "createdAt": "2020-07-28T10:16:31Z", "path": "dspace-api/src/main/java/org/dspace/importer/external/service/ImportService.java", "diffHunk": "@@ -272,6 +296,35 @@ public ImportRecord getRecord(String uri, Query query) throws MetadataSourceExce\n         return importSources.keySet();\n     }\n \n+    /*\n+     * Get a collection of record from File,\n+     * The first match will be return.\n+     * \n+     * @param file  The file from which will read records\n+     * @return a single record contains the metadatum\n+     * @throws FileMultipleOccurencesException if more than one entry is found\n+     */\n+    public ImportRecord getRecord(File file) throws FileMultipleOccurencesException, FileSourceException {\n+        ImportRecord importRecords = null;\n+        for (MetadataSource metadataSource : importSources.values()) {\n+            try (InputStream fileInputStream = new FileInputStream(file)) {\n+                if (metadataSource instanceof FileSource) {\n+                    FileSource fileSource = (FileSource)metadataSource;\n+                    importRecords = fileSource.getRecord(fileInputStream);\n+                    break;\n+                }\n+            } catch (FileSourceException e) {", "originalCommit": "575ce02077ac7438e70e8508a25129ac365b2341", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ3NDE5MQ==", "url": "https://github.com/DSpace/DSpace/pull/2791#discussion_r461474191", "bodyText": "Same as above.", "author": "KevinVdV", "createdAt": "2020-07-28T10:16:42Z", "path": "dspace-api/src/main/java/org/dspace/importer/external/service/ImportService.java", "diffHunk": "@@ -272,6 +296,35 @@ public ImportRecord getRecord(String uri, Query query) throws MetadataSourceExce\n         return importSources.keySet();\n     }\n \n+    /*\n+     * Get a collection of record from File,\n+     * The first match will be return.\n+     * \n+     * @param file  The file from which will read records\n+     * @return a single record contains the metadatum\n+     * @throws FileMultipleOccurencesException if more than one entry is found\n+     */\n+    public ImportRecord getRecord(File file) throws FileMultipleOccurencesException, FileSourceException {\n+        ImportRecord importRecords = null;\n+        for (MetadataSource metadataSource : importSources.values()) {\n+            try (InputStream fileInputStream = new FileInputStream(file)) {\n+                if (metadataSource instanceof FileSource) {\n+                    FileSource fileSource = (FileSource)metadataSource;\n+                    importRecords = fileSource.getRecord(fileInputStream);\n+                    break;\n+                }\n+            } catch (FileSourceException e) {\n+                log.debug(metadataSource.getImportSource() + \" isn't a valid parser for file\");\n+            } catch (FileMultipleOccurencesException e) {", "originalCommit": "575ce02077ac7438e70e8508a25129ac365b2341", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "107c70a6eed7e37c74da40c8c1981921d39918d6", "url": "https://github.com/DSpace/DSpace/commit/107c70a6eed7e37c74da40c8c1981921d39918d6", "message": "Add extensions supported by FileSource in Live Import", "committedDate": "2020-07-29T10:22:22Z", "type": "commit"}, {"oid": "d2e969ffeed527849ee084be6ad97cba62d5e747", "url": "https://github.com/DSpace/DSpace/commit/d2e969ffeed527849ee084be6ad97cba62d5e747", "message": "Merge remote-tracking branch 'refs/remotes/origin/main'", "committedDate": "2020-07-29T13:06:17Z", "type": "commit"}]}