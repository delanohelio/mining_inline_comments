{"pr_number": 2744, "pr_title": "[DS-4443] delete solr record on workspaceitem deletion", "pr_createdAt": "2020-04-10T14:39:32Z", "pr_url": "https://github.com/DSpace/DSpace/pull/2744", "timeline": [{"oid": "d5d1edffb476784399c85c481a7e874e2877ab58", "url": "https://github.com/DSpace/DSpace/commit/d5d1edffb476784399c85c481a7e874e2877ab58", "message": "[DS-4443] fixed the solr record deletion after workspaceitem removal and added a test for it", "committedDate": "2020-04-03T09:11:58Z", "type": "commit"}, {"oid": "935a2df27e0691825346f63b76d50f031b702b78", "url": "https://github.com/DSpace/DSpace/commit/935a2df27e0691825346f63b76d50f031b702b78", "message": "[DS-4443] moved test to dspace-api. Succeeds in a single run, fails in full test run", "committedDate": "2020-04-06T07:09:59Z", "type": "commit"}, {"oid": "5638c631d7143e88a68a3703c9ad80553f3fd936", "url": "https://github.com/DSpace/DSpace/commit/5638c631d7143e88a68a3703c9ad80553f3fd936", "message": "Undoing some changes that aren't needed", "committedDate": "2020-04-10T13:50:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzczNDU3MQ==", "url": "https://github.com/DSpace/DSpace/pull/2744#discussion_r407734571", "bodyText": "@KevinVdV : here's the main line where Travis CI is throwing the error.  Unfortunately, all we know is this ends up being \"false\".  Could we change this assert to provide us more information?  It probably should instead say something like:\nassertEquals(1, indexableObjects.size());\nThat would at least let us know if IndexableObjects is zero initially (in which case Solr isn't starting up correctly) or maybe it's some number >1 (in which case either your query is too broad, or Solr isn't cleaning up data between tests & we have data leakage across tests again).", "author": "tdonohue", "createdAt": "2020-04-13T21:33:32Z", "path": "dspace-api/src/test/java/org/dspace/discovery/DiscoveryTest.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.discovery;\n+\n+import static org.junit.Assert.assertTrue;\n+import static org.junit.Assert.fail;\n+\n+import java.sql.SQLException;\n+import java.util.List;\n+\n+import org.apache.logging.log4j.Logger;\n+import org.dspace.AbstractIntegrationTest;\n+import org.dspace.authorize.AuthorizeException;\n+import org.dspace.content.Collection;\n+import org.dspace.content.Community;\n+import org.dspace.content.WorkspaceItem;\n+import org.dspace.content.factory.ContentServiceFactory;\n+import org.dspace.content.service.CollectionService;\n+import org.dspace.content.service.CommunityService;\n+import org.dspace.content.service.InstallItemService;\n+import org.dspace.content.service.ItemService;\n+import org.dspace.content.service.WorkspaceItemService;\n+import org.dspace.services.factory.DSpaceServicesFactory;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+/**\n+ * This class will aim to test Discovery related use cases\n+ */\n+public class DiscoveryTest extends AbstractIntegrationTest {\n+\n+    private static final Logger log = org.apache.logging.log4j.LogManager.getLogger(DiscoveryTest.class);\n+\n+    protected CommunityService communityService = ContentServiceFactory.getInstance().getCommunityService();\n+    protected CollectionService collectionService = ContentServiceFactory.getInstance().getCollectionService();\n+    protected ItemService itemService = ContentServiceFactory.getInstance().getItemService();\n+    protected InstallItemService installItemService = ContentServiceFactory.getInstance().getInstallItemService();\n+    protected WorkspaceItemService workspaceItemService = ContentServiceFactory.getInstance().getWorkspaceItemService();\n+    protected IndexingService indexingService = DSpaceServicesFactory.getInstance().getServiceManager()\n+                                                                     .getServiceByName(IndexingService.class.getName(),\n+                                                                                       IndexingService.class);\n+    protected SearchService searchService = SearchUtils.getSearchService();\n+\n+\n+    WorkspaceItem leftIs;\n+    WorkspaceItem rightIs;\n+\n+    /**\n+     * This method will be run before every test as per @Before. It will\n+     * initialize resources required for the tests.\n+     *\n+     * Other methods can be annotated with @Before here or in subclasses\n+     * but no execution order is guaranteed\n+     */\n+    @Before\n+    @Override\n+    public void init() {\n+        super.init();\n+        try {\n+            context.turnOffAuthorisationSystem();\n+            Community community = communityService.create(null, context);\n+\n+            Collection col = collectionService.create(context, community);\n+            leftIs = workspaceItemService.create(context, col, false);\n+            rightIs = workspaceItemService.create(context, col, false);\n+\n+            itemService.addMetadata(context, leftIs.getItem(), \"dc\", \"description\", \"abstract\", null, \"headache\");\n+            itemService.addMetadata(context, rightIs.getItem(), \"dc\", \"description\", \"abstract\", null, \"headache\");\n+\n+            workspaceItemService.update(context, leftIs);\n+            workspaceItemService.update(context, rightIs);\n+\n+            indexingService.commit();\n+\n+            context.restoreAuthSystemState();\n+            context.dispatchEvents();\n+        } catch (AuthorizeException ex) {\n+            log.error(\"Authorization Error in init\", ex);\n+            fail(\"Authorization Error in init: \" + ex.getMessage());\n+        } catch (SQLException ex) {\n+            log.error(\"SQL Error in init\", ex);\n+            fail(\"SQL Error in init: \" + ex.getMessage());\n+        } catch (Exception ex) {\n+            log.error(\"Error in init\", ex);\n+            fail(\"Error in init: \" + ex.getMessage());\n+        }\n+    }\n+\n+    /**\n+     * This method will be run after every test as per @After. It will\n+     * clean resources initialized by the @Before methods.\n+     *\n+     * Other methods can be annotated with @After here or in subclasses\n+     * but no execution order is guaranteed\n+     */\n+    @After\n+    @Override\n+    public void destroy() {\n+        context.abort();\n+        super.destroy();\n+    }\n+\n+    @Test\n+    public void deleteWorkspaceItemSolrRecordAfterDeletionFromDbTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+        DiscoverQuery discoverQuery = new DiscoverQuery();\n+        discoverQuery.setQuery(\"*:*\");\n+        discoverQuery.addFilterQueries(\"search.resourceid:\" + leftIs.getID());\n+        DiscoverResult discoverResult = searchService.search(context, discoverQuery);\n+        List<IndexableObject> indexableObjects = discoverResult.getIndexableObjects();\n+        assertTrue(indexableObjects.size() == 1);", "originalCommit": "5638c631d7143e88a68a3703c9ad80553f3fd936", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzczNDk2MA==", "url": "https://github.com/DSpace/DSpace/pull/2744#discussion_r407734960", "bodyText": "I'd recommend also changing this to an assertEquals statement...as if it is ever not zero, we'd want information around what it's value actually is.", "author": "tdonohue", "createdAt": "2020-04-13T21:34:14Z", "path": "dspace-api/src/test/java/org/dspace/discovery/DiscoveryTest.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.discovery;\n+\n+import static org.junit.Assert.assertTrue;\n+import static org.junit.Assert.fail;\n+\n+import java.sql.SQLException;\n+import java.util.List;\n+\n+import org.apache.logging.log4j.Logger;\n+import org.dspace.AbstractIntegrationTest;\n+import org.dspace.authorize.AuthorizeException;\n+import org.dspace.content.Collection;\n+import org.dspace.content.Community;\n+import org.dspace.content.WorkspaceItem;\n+import org.dspace.content.factory.ContentServiceFactory;\n+import org.dspace.content.service.CollectionService;\n+import org.dspace.content.service.CommunityService;\n+import org.dspace.content.service.InstallItemService;\n+import org.dspace.content.service.ItemService;\n+import org.dspace.content.service.WorkspaceItemService;\n+import org.dspace.services.factory.DSpaceServicesFactory;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+/**\n+ * This class will aim to test Discovery related use cases\n+ */\n+public class DiscoveryTest extends AbstractIntegrationTest {\n+\n+    private static final Logger log = org.apache.logging.log4j.LogManager.getLogger(DiscoveryTest.class);\n+\n+    protected CommunityService communityService = ContentServiceFactory.getInstance().getCommunityService();\n+    protected CollectionService collectionService = ContentServiceFactory.getInstance().getCollectionService();\n+    protected ItemService itemService = ContentServiceFactory.getInstance().getItemService();\n+    protected InstallItemService installItemService = ContentServiceFactory.getInstance().getInstallItemService();\n+    protected WorkspaceItemService workspaceItemService = ContentServiceFactory.getInstance().getWorkspaceItemService();\n+    protected IndexingService indexingService = DSpaceServicesFactory.getInstance().getServiceManager()\n+                                                                     .getServiceByName(IndexingService.class.getName(),\n+                                                                                       IndexingService.class);\n+    protected SearchService searchService = SearchUtils.getSearchService();\n+\n+\n+    WorkspaceItem leftIs;\n+    WorkspaceItem rightIs;\n+\n+    /**\n+     * This method will be run before every test as per @Before. It will\n+     * initialize resources required for the tests.\n+     *\n+     * Other methods can be annotated with @Before here or in subclasses\n+     * but no execution order is guaranteed\n+     */\n+    @Before\n+    @Override\n+    public void init() {\n+        super.init();\n+        try {\n+            context.turnOffAuthorisationSystem();\n+            Community community = communityService.create(null, context);\n+\n+            Collection col = collectionService.create(context, community);\n+            leftIs = workspaceItemService.create(context, col, false);\n+            rightIs = workspaceItemService.create(context, col, false);\n+\n+            itemService.addMetadata(context, leftIs.getItem(), \"dc\", \"description\", \"abstract\", null, \"headache\");\n+            itemService.addMetadata(context, rightIs.getItem(), \"dc\", \"description\", \"abstract\", null, \"headache\");\n+\n+            workspaceItemService.update(context, leftIs);\n+            workspaceItemService.update(context, rightIs);\n+\n+            indexingService.commit();\n+\n+            context.restoreAuthSystemState();\n+            context.dispatchEvents();\n+        } catch (AuthorizeException ex) {\n+            log.error(\"Authorization Error in init\", ex);\n+            fail(\"Authorization Error in init: \" + ex.getMessage());\n+        } catch (SQLException ex) {\n+            log.error(\"SQL Error in init\", ex);\n+            fail(\"SQL Error in init: \" + ex.getMessage());\n+        } catch (Exception ex) {\n+            log.error(\"Error in init\", ex);\n+            fail(\"Error in init: \" + ex.getMessage());\n+        }\n+    }\n+\n+    /**\n+     * This method will be run after every test as per @After. It will\n+     * clean resources initialized by the @Before methods.\n+     *\n+     * Other methods can be annotated with @After here or in subclasses\n+     * but no execution order is guaranteed\n+     */\n+    @After\n+    @Override\n+    public void destroy() {\n+        context.abort();\n+        super.destroy();\n+    }\n+\n+    @Test\n+    public void deleteWorkspaceItemSolrRecordAfterDeletionFromDbTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+        DiscoverQuery discoverQuery = new DiscoverQuery();\n+        discoverQuery.setQuery(\"*:*\");\n+        discoverQuery.addFilterQueries(\"search.resourceid:\" + leftIs.getID());\n+        DiscoverResult discoverResult = searchService.search(context, discoverQuery);\n+        List<IndexableObject> indexableObjects = discoverResult.getIndexableObjects();\n+        assertTrue(indexableObjects.size() == 1);\n+        workspaceItemService.deleteAll(context, leftIs);\n+        discoverResult = searchService.search(context, discoverQuery);\n+        indexableObjects = discoverResult.getIndexableObjects();\n+        assertTrue(indexableObjects.size() == 0);", "originalCommit": "5638c631d7143e88a68a3703c9ad80553f3fd936", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc0MzgzMA==", "url": "https://github.com/DSpace/DSpace/pull/2744#discussion_r407743830", "bodyText": "One other thing I just realized.  As this is an IntegrationTest, it should have IT in the name...otherwise, it will be run alongside unit tests instead of Integration Tests.  So, this should be renamed something like DiscoveryIT or ITDiscovery.\nAlso, in the destroy() method you should be manually cleaning up any objects created in the init() method.\nFor examples, see other test classes that specify extends AbstractIntegrationTest", "author": "tdonohue", "createdAt": "2020-04-13T21:54:21Z", "path": "dspace-api/src/test/java/org/dspace/discovery/DiscoveryTest.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.discovery;\n+\n+import static org.junit.Assert.assertTrue;\n+import static org.junit.Assert.fail;\n+\n+import java.sql.SQLException;\n+import java.util.List;\n+\n+import org.apache.logging.log4j.Logger;\n+import org.dspace.AbstractIntegrationTest;\n+import org.dspace.authorize.AuthorizeException;\n+import org.dspace.content.Collection;\n+import org.dspace.content.Community;\n+import org.dspace.content.WorkspaceItem;\n+import org.dspace.content.factory.ContentServiceFactory;\n+import org.dspace.content.service.CollectionService;\n+import org.dspace.content.service.CommunityService;\n+import org.dspace.content.service.InstallItemService;\n+import org.dspace.content.service.ItemService;\n+import org.dspace.content.service.WorkspaceItemService;\n+import org.dspace.services.factory.DSpaceServicesFactory;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+/**\n+ * This class will aim to test Discovery related use cases\n+ */\n+public class DiscoveryTest extends AbstractIntegrationTest {", "originalCommit": "5638c631d7143e88a68a3703c9ad80553f3fd936", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4913c5a9e9379dde2473709389e6bfd3be05ae7d", "url": "https://github.com/DSpace/DSpace/commit/4913c5a9e9379dde2473709389e6bfd3be05ae7d", "message": "[DS-4443] changed asserts to equals and fixed test run", "committedDate": "2020-04-27T08:33:46Z", "type": "commit"}, {"oid": "247b965dd4fa0144fb8d9b78bc5871a788fed609", "url": "https://github.com/DSpace/DSpace/commit/247b965dd4fa0144fb8d9b78bc5871a788fed609", "message": "Reorder structure of DiscoveryIT#init method", "committedDate": "2020-04-29T12:46:59Z", "type": "commit"}, {"oid": "e2347e39712476f1bbb28272bf19684b550693b3", "url": "https://github.com/DSpace/DSpace/commit/e2347e39712476f1bbb28272bf19684b550693b3", "message": "Fixed the solr tests in dspace-api", "committedDate": "2020-05-07T10:03:34Z", "type": "commit"}, {"oid": "2ff63a9a59b9c1046d1d376eb47b0f656936c7ce", "url": "https://github.com/DSpace/DSpace/commit/2ff63a9a59b9c1046d1d376eb47b0f656936c7ce", "message": "Testing Travis execution to find errors", "committedDate": "2020-05-08T13:53:01Z", "type": "commit"}, {"oid": "2a8fe67858ed1d1bd7390912b5ee3fa925be8637", "url": "https://github.com/DSpace/DSpace/commit/2a8fe67858ed1d1bd7390912b5ee3fa925be8637", "message": "Trying Travis Tests", "committedDate": "2020-05-12T11:24:56Z", "type": "commit"}, {"oid": "ccca5ded9fc7500517d1bfec87d2628beba4a719", "url": "https://github.com/DSpace/DSpace/commit/ccca5ded9fc7500517d1bfec87d2628beba4a719", "message": "Merge remote-tracking branch 'upstream/main' into DS-4443_delete-solr-record-on-workspaceitem-deletion", "committedDate": "2020-08-14T14:14:26Z", "type": "commit"}, {"oid": "b3413b1e2bcefe97318d6ec448988a9fb32d9c26", "url": "https://github.com/DSpace/DSpace/commit/b3413b1e2bcefe97318d6ec448988a9fb32d9c26", "message": "Attempt to get the tests to work for the deletion of workspaceitems", "committedDate": "2020-08-14T14:45:47Z", "type": "commit"}, {"oid": "53685eb101cf9472d2d9e926e139d82bf3cdbf32", "url": "https://github.com/DSpace/DSpace/commit/53685eb101cf9472d2d9e926e139d82bf3cdbf32", "message": "Merge branch 'master' into DS-4443_delete-solr-record-on-workspaceitem-deletion", "committedDate": "2020-10-09T07:02:21Z", "type": "commit"}, {"oid": "a70e9ebf5b1b2ea621f1b75abee5f33f7fbc01f9", "url": "https://github.com/DSpace/DSpace/commit/a70e9ebf5b1b2ea621f1b75abee5f33f7fbc01f9", "message": "Enabling discovery consumer in the unit tests for the api", "committedDate": "2020-10-21T12:02:00Z", "type": "commit"}, {"oid": "cc644e7c3f137c73e450c18e0645bf7e89b59cb3", "url": "https://github.com/DSpace/DSpace/commit/cc644e7c3f137c73e450c18e0645bf7e89b59cb3", "message": "Removing unused imports", "committedDate": "2020-10-21T13:50:44Z", "type": "commit"}, {"oid": "2466731028f0f9e990ff1618c045a1d21e3da023", "url": "https://github.com/DSpace/DSpace/commit/2466731028f0f9e990ff1618c045a1d21e3da023", "message": "Rewrote the test class using builders", "committedDate": "2020-11-03T15:38:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU4MTU1Nw==", "url": "https://github.com/DSpace/DSpace/pull/2744#discussion_r517581557", "bodyText": "The parentheses around indexableFactoryType can be removed on this line.", "author": "tdonohue", "createdAt": "2020-11-04T19:29:48Z", "path": "dspace-api/src/main/java/org/dspace/discovery/indexobject/factory/IndexObjectFactoryFactory.java", "diffHunk": "@@ -68,7 +68,7 @@ public IndexFactory getIndexableObjectFactory(String indexableObjectUniqueString\n      */\n     public IndexFactory getIndexFactoryByType(String indexableFactoryType) {\n         for (IndexFactory indexableObjectFactory : getIndexFactories()) {\n-            if (indexableObjectFactory.getType().equals(indexableFactoryType)) {\n+            if (StringUtils.equalsIgnoreCase(indexableObjectFactory.getType(), (indexableFactoryType))) {", "originalCommit": "2466731028f0f9e990ff1618c045a1d21e3da023", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDk3MzczMQ==", "url": "https://github.com/DSpace/DSpace/pull/2744#discussion_r544973731", "bodyText": "Removed", "author": "KevinVdV", "createdAt": "2020-12-17T10:20:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU4MTU1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU4NjgyMA==", "url": "https://github.com/DSpace/DSpace/pull/2744#discussion_r517586820", "bodyText": "Tiny change.  We should only be turning off/on authorization around the deleteAll() call in this test.  Otherwise, the search() calls in this test are running with a Context that has authorization turned off...and that can impact the behavior of those searches.\nSo, please move this & the restoreAuthSystemState() call to be surrounding the deleteAll() call.", "author": "tdonohue", "createdAt": "2020-11-04T19:39:59Z", "path": "dspace-api/src/test/java/org/dspace/discovery/DiscoveryIT.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.discovery;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import java.util.List;\n+\n+import org.dspace.AbstractIntegrationTestWithDatabase;\n+import org.dspace.builder.CollectionBuilder;\n+import org.dspace.builder.CommunityBuilder;\n+import org.dspace.builder.WorkspaceItemBuilder;\n+import org.dspace.content.Collection;\n+import org.dspace.content.Community;\n+import org.dspace.content.WorkspaceItem;\n+import org.dspace.content.factory.ContentServiceFactory;\n+import org.dspace.content.service.WorkspaceItemService;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+/**\n+ * This class will aim to test Discovery related use cases\n+ */\n+public class DiscoveryIT extends AbstractIntegrationTestWithDatabase {\n+\n+    protected WorkspaceItemService workspaceItemService = ContentServiceFactory.getInstance().getWorkspaceItemService();\n+    protected SearchService searchService = SearchUtils.getSearchService();\n+\n+\n+    Community community;\n+    Collection col;\n+\n+    WorkspaceItem leftIs;\n+    WorkspaceItem rightIs;\n+\n+    /**\n+     * This method will be run before every test as per @Before. It will\n+     * initialize resources required for the tests.\n+     *\n+     * Other methods can be annotated with @Before here or in subclasses\n+     * but no execution order is guaranteed\n+     */\n+    @Before\n+    @Override\n+    public void setUp() throws Exception {\n+        super.setUp();\n+        context.turnOffAuthorisationSystem();\n+        community = CommunityBuilder.createCommunity(context).withName(\"Parent Community\").build();\n+\n+        col = CollectionBuilder.createCollection(context, community).build();\n+\n+        leftIs = WorkspaceItemBuilder.createWorkspaceItem(context, col).withAbstract(\"headache\").build();\n+        rightIs = WorkspaceItemBuilder.createWorkspaceItem(context, col).withAbstract(\"headache\").build();\n+\n+        context.restoreAuthSystemState();\n+    }\n+\n+    @Test\n+    public void deleteWorkspaceItemSolrRecordAfterDeletionFromDbTest() throws Exception {\n+        context.turnOffAuthorisationSystem();", "originalCommit": "2466731028f0f9e990ff1618c045a1d21e3da023", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDk3NDI5Mw==", "url": "https://github.com/DSpace/DSpace/pull/2744#discussion_r544974293", "bodyText": "Done.", "author": "KevinVdV", "createdAt": "2020-12-17T10:21:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU4NjgyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU5MTE3NA==", "url": "https://github.com/DSpace/DSpace/pull/2744#discussion_r517591174", "bodyText": "All the changes to AbstractUnitTest appear to not be necessary now that you switched DiscoveryIT to extend AbstractIntegrationTestWithDatabase (which has Solr enabled by default).  I tested locally reverting these changes to AbstractUnitTest and DiscoveryIT still succeeds.\nTherefore, I'd recommend we remove these changes, as technically Solr should be disabled for Unit Tests (which don't need it).  It's only supposed to be enabled for Integration Tests.", "author": "tdonohue", "createdAt": "2020-11-04T19:47:59Z", "path": "dspace-api/src/test/java/org/dspace/AbstractUnitTest.java", "diffHunk": "@@ -122,9 +119,6 @@ public void init() {\n \n             context.restoreAuthSystemState();\n \n-            // Ensure all tests run with Solr indexing disabled\n-            disableSolrIndexing();", "originalCommit": "2466731028f0f9e990ff1618c045a1d21e3da023", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTAwMDUxNQ==", "url": "https://github.com/DSpace/DSpace/pull/2744#discussion_r545000515", "bodyText": "We tried doing this, but when we run the following command locally:\n\nmvn install -B -V -P-assembly -Pcoverage-report -DskipIntegrationTests=false -Denforcer.skip=true -Dcheckstyle.skip=true -Dlicense.skip=true -Dxml.skip=true\n\nWe still get an exception:\n[ERROR] deleteWorkspaceItemSolrRecordAfterDeletionFromDbTest(org.dspace.discovery.DiscoveryIT)  Time elapsed: 0.307 s  <<< FAILURE! java.lang.AssertionError: expected:<1> but was:<0> at org.junit.Assert.fail(Assert.java:88) at org.junit.Assert.failNotEquals(Assert.java:834) at org.junit.Assert.assertEquals(Assert.java:645) at org.junit.Assert.assertEquals(Assert.java:631) at org.dspace.discovery.DiscoveryIT.deleteWorkspaceItemSolrRecordAfterDeletionFromDbTest(DiscoveryIT.java:52)\nThis is because there are integration tests that extend from the \"AbstractUnitTest\", if one of these is run before the DiscoveryIT tests than the discovery test will crash (so it can depend on the system if that happens).", "author": "KevinVdV", "createdAt": "2020-12-17T11:01:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU5MTE3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTEwMDU5MQ==", "url": "https://github.com/DSpace/DSpace/pull/2744#discussion_r545100591", "bodyText": "this is related to the issue #3055 I guess that there are some *IT that extends the wrong hierarchy leaving the test env dirty. We need to found them, it is not a solution to make more complex and wrong the current solution.\nI guess that a maximum of 8 hours should be sufficient to cleanup enough test to get this work properly and if you needed (@tdonohue ) my team can work on that.\nThat said, for this PR I suggest to revert the change as by Tim request and flag the test as Ignored opening a dedicated issue", "author": "abollini", "createdAt": "2020-12-17T13:45:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU5MTE3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTIzNjA1OQ==", "url": "https://github.com/DSpace/DSpace/pull/2744#discussion_r545236059", "bodyText": "@KevinVdV : I agree with @abollini 's suggestion here.  We must revert these changes to AbstractUnitTest, but if they cause issues with the tests added here, we can temporarily disable the new tests (we already know they work) until we can figure out which other UnitTests are improperly adding content into Solr.", "author": "tdonohue", "createdAt": "2020-12-17T16:42:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU5MTE3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYwNzAwMA==", "url": "https://github.com/DSpace/DSpace/pull/2744#discussion_r517607000", "bodyText": "this is not used in the test, the leftIs name should be replaced with a more meaningful item", "author": "abollini", "createdAt": "2020-11-04T20:18:25Z", "path": "dspace-api/src/test/java/org/dspace/discovery/DiscoveryIT.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.discovery;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import java.util.List;\n+\n+import org.dspace.AbstractIntegrationTestWithDatabase;\n+import org.dspace.builder.CollectionBuilder;\n+import org.dspace.builder.CommunityBuilder;\n+import org.dspace.builder.WorkspaceItemBuilder;\n+import org.dspace.content.Collection;\n+import org.dspace.content.Community;\n+import org.dspace.content.WorkspaceItem;\n+import org.dspace.content.factory.ContentServiceFactory;\n+import org.dspace.content.service.WorkspaceItemService;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+/**\n+ * This class will aim to test Discovery related use cases\n+ */\n+public class DiscoveryIT extends AbstractIntegrationTestWithDatabase {\n+\n+    protected WorkspaceItemService workspaceItemService = ContentServiceFactory.getInstance().getWorkspaceItemService();\n+    protected SearchService searchService = SearchUtils.getSearchService();\n+\n+\n+    Community community;\n+    Collection col;\n+\n+    WorkspaceItem leftIs;\n+    WorkspaceItem rightIs;", "originalCommit": "2466731028f0f9e990ff1618c045a1d21e3da023", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDk3NTE2NQ==", "url": "https://github.com/DSpace/DSpace/pull/2744#discussion_r544975165", "bodyText": "We fixed this.", "author": "KevinVdV", "createdAt": "2020-12-17T10:22:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYwNzAwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYwNzc0MA==", "url": "https://github.com/DSpace/DSpace/pull/2744#discussion_r517607740", "bodyText": "I suggest to remove the setup method here, it doesn't add any real value and make reading/understanding of the test a bit more complicated", "author": "abollini", "createdAt": "2020-11-04T20:19:54Z", "path": "dspace-api/src/test/java/org/dspace/discovery/DiscoveryIT.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.discovery;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import java.util.List;\n+\n+import org.dspace.AbstractIntegrationTestWithDatabase;\n+import org.dspace.builder.CollectionBuilder;\n+import org.dspace.builder.CommunityBuilder;\n+import org.dspace.builder.WorkspaceItemBuilder;\n+import org.dspace.content.Collection;\n+import org.dspace.content.Community;\n+import org.dspace.content.WorkspaceItem;\n+import org.dspace.content.factory.ContentServiceFactory;\n+import org.dspace.content.service.WorkspaceItemService;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+/**\n+ * This class will aim to test Discovery related use cases\n+ */\n+public class DiscoveryIT extends AbstractIntegrationTestWithDatabase {\n+\n+    protected WorkspaceItemService workspaceItemService = ContentServiceFactory.getInstance().getWorkspaceItemService();\n+    protected SearchService searchService = SearchUtils.getSearchService();\n+\n+\n+    Community community;\n+    Collection col;\n+\n+    WorkspaceItem leftIs;\n+    WorkspaceItem rightIs;\n+\n+    /**\n+     * This method will be run before every test as per @Before. It will\n+     * initialize resources required for the tests.\n+     *\n+     * Other methods can be annotated with @Before here or in subclasses\n+     * but no execution order is guaranteed\n+     */\n+    @Before\n+    @Override\n+    public void setUp() throws Exception {\n+        super.setUp();\n+        context.turnOffAuthorisationSystem();\n+        community = CommunityBuilder.createCommunity(context).withName(\"Parent Community\").build();\n+\n+        col = CollectionBuilder.createCollection(context, community).build();\n+\n+        leftIs = WorkspaceItemBuilder.createWorkspaceItem(context, col).withAbstract(\"headache\").build();\n+        rightIs = WorkspaceItemBuilder.createWorkspaceItem(context, col).withAbstract(\"headache\").build();\n+\n+        context.restoreAuthSystemState();\n+    }", "originalCommit": "2466731028f0f9e990ff1618c045a1d21e3da023", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDk3NTI5MQ==", "url": "https://github.com/DSpace/DSpace/pull/2744#discussion_r544975291", "bodyText": "Setup method removed.", "author": "KevinVdV", "createdAt": "2020-12-17T10:23:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYwNzc0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYwODcyMA==", "url": "https://github.com/DSpace/DSpace/pull/2744#discussion_r517608720", "bodyText": "please add assertEquals(1, discoverResult.getTotalSearchResults());", "author": "abollini", "createdAt": "2020-11-04T20:21:59Z", "path": "dspace-api/src/test/java/org/dspace/discovery/DiscoveryIT.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.discovery;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import java.util.List;\n+\n+import org.dspace.AbstractIntegrationTestWithDatabase;\n+import org.dspace.builder.CollectionBuilder;\n+import org.dspace.builder.CommunityBuilder;\n+import org.dspace.builder.WorkspaceItemBuilder;\n+import org.dspace.content.Collection;\n+import org.dspace.content.Community;\n+import org.dspace.content.WorkspaceItem;\n+import org.dspace.content.factory.ContentServiceFactory;\n+import org.dspace.content.service.WorkspaceItemService;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+/**\n+ * This class will aim to test Discovery related use cases\n+ */\n+public class DiscoveryIT extends AbstractIntegrationTestWithDatabase {\n+\n+    protected WorkspaceItemService workspaceItemService = ContentServiceFactory.getInstance().getWorkspaceItemService();\n+    protected SearchService searchService = SearchUtils.getSearchService();\n+\n+\n+    Community community;\n+    Collection col;\n+\n+    WorkspaceItem leftIs;\n+    WorkspaceItem rightIs;\n+\n+    /**\n+     * This method will be run before every test as per @Before. It will\n+     * initialize resources required for the tests.\n+     *\n+     * Other methods can be annotated with @Before here or in subclasses\n+     * but no execution order is guaranteed\n+     */\n+    @Before\n+    @Override\n+    public void setUp() throws Exception {\n+        super.setUp();\n+        context.turnOffAuthorisationSystem();\n+        community = CommunityBuilder.createCommunity(context).withName(\"Parent Community\").build();\n+\n+        col = CollectionBuilder.createCollection(context, community).build();\n+\n+        leftIs = WorkspaceItemBuilder.createWorkspaceItem(context, col).withAbstract(\"headache\").build();\n+        rightIs = WorkspaceItemBuilder.createWorkspaceItem(context, col).withAbstract(\"headache\").build();\n+\n+        context.restoreAuthSystemState();\n+    }\n+\n+    @Test\n+    public void deleteWorkspaceItemSolrRecordAfterDeletionFromDbTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+        DiscoverQuery discoverQuery = new DiscoverQuery();\n+        discoverQuery.setQuery(\"*:*\");\n+        discoverQuery.addFilterQueries(\"search.resourceid:\" + leftIs.getID());\n+        DiscoverResult discoverResult = searchService.search(context, discoverQuery);\n+        List<IndexableObject> indexableObjects = discoverResult.getIndexableObjects();", "originalCommit": "2466731028f0f9e990ff1618c045a1d21e3da023", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDk3NTQxNQ==", "url": "https://github.com/DSpace/DSpace/pull/2744#discussion_r544975415", "bodyText": "Added", "author": "KevinVdV", "createdAt": "2020-12-17T10:23:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYwODcyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYwODkxMw==", "url": "https://github.com/DSpace/DSpace/pull/2744#discussion_r517608913", "bodyText": "please add assertEquals(0, discoverResult.getTotalSearchResults()); as the indexable objects could be an empty list also in  the case that the workspaceitem is still present in the index but not founded in the database. Indeed, doing that will led the test to fails as you need to dispatch the events to get the search updated, add\ncontext.dispatchEvents();\njust after the workspaceItemService.deleteAll(context, leftIs);", "author": "abollini", "createdAt": "2020-11-04T20:22:17Z", "path": "dspace-api/src/test/java/org/dspace/discovery/DiscoveryIT.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.discovery;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import java.util.List;\n+\n+import org.dspace.AbstractIntegrationTestWithDatabase;\n+import org.dspace.builder.CollectionBuilder;\n+import org.dspace.builder.CommunityBuilder;\n+import org.dspace.builder.WorkspaceItemBuilder;\n+import org.dspace.content.Collection;\n+import org.dspace.content.Community;\n+import org.dspace.content.WorkspaceItem;\n+import org.dspace.content.factory.ContentServiceFactory;\n+import org.dspace.content.service.WorkspaceItemService;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+/**\n+ * This class will aim to test Discovery related use cases\n+ */\n+public class DiscoveryIT extends AbstractIntegrationTestWithDatabase {\n+\n+    protected WorkspaceItemService workspaceItemService = ContentServiceFactory.getInstance().getWorkspaceItemService();\n+    protected SearchService searchService = SearchUtils.getSearchService();\n+\n+\n+    Community community;\n+    Collection col;\n+\n+    WorkspaceItem leftIs;\n+    WorkspaceItem rightIs;\n+\n+    /**\n+     * This method will be run before every test as per @Before. It will\n+     * initialize resources required for the tests.\n+     *\n+     * Other methods can be annotated with @Before here or in subclasses\n+     * but no execution order is guaranteed\n+     */\n+    @Before\n+    @Override\n+    public void setUp() throws Exception {\n+        super.setUp();\n+        context.turnOffAuthorisationSystem();\n+        community = CommunityBuilder.createCommunity(context).withName(\"Parent Community\").build();\n+\n+        col = CollectionBuilder.createCollection(context, community).build();\n+\n+        leftIs = WorkspaceItemBuilder.createWorkspaceItem(context, col).withAbstract(\"headache\").build();\n+        rightIs = WorkspaceItemBuilder.createWorkspaceItem(context, col).withAbstract(\"headache\").build();\n+\n+        context.restoreAuthSystemState();\n+    }\n+\n+    @Test\n+    public void deleteWorkspaceItemSolrRecordAfterDeletionFromDbTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+        DiscoverQuery discoverQuery = new DiscoverQuery();\n+        discoverQuery.setQuery(\"*:*\");\n+        discoverQuery.addFilterQueries(\"search.resourceid:\" + leftIs.getID());\n+        DiscoverResult discoverResult = searchService.search(context, discoverQuery);\n+        List<IndexableObject> indexableObjects = discoverResult.getIndexableObjects();\n+        assertEquals(1, indexableObjects.size());\n+        workspaceItemService.deleteAll(context, leftIs);\n+        discoverResult = searchService.search(context, discoverQuery);\n+        indexableObjects = discoverResult.getIndexableObjects();", "originalCommit": "2466731028f0f9e990ff1618c045a1d21e3da023", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDk3NTk3OA==", "url": "https://github.com/DSpace/DSpace/pull/2744#discussion_r544975978", "bodyText": "Added", "author": "KevinVdV", "createdAt": "2020-12-17T10:24:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYwODkxMw=="}], "type": "inlineReview"}, {"oid": "8cd404b6a75a68c0aec2b4ef51654714f5757162", "url": "https://github.com/DSpace/DSpace/commit/8cd404b6a75a68c0aec2b4ef51654714f5757162", "message": "75323: Delete solr record on workspaceitem deletion: Test feedback", "committedDate": "2020-12-17T09:46:47Z", "type": "commit"}, {"oid": "9d487e36c17929d61aa9b403c31322ffafe623d7", "url": "https://github.com/DSpace/DSpace/commit/9d487e36c17929d61aa9b403c31322ffafe623d7", "message": "Merge remote-tracking branch 'upstream/main' into DS-4443_delete-solr-record-on-workspaceitem-deletion", "committedDate": "2020-12-21T09:46:10Z", "type": "commit"}, {"oid": "a9fe4ae1d1af94fe9ffdbd2a0511b93d042f8d8a", "url": "https://github.com/DSpace/DSpace/commit/a9fe4ae1d1af94fe9ffdbd2a0511b93d042f8d8a", "message": "75409: Delete solr record on workspaceitem deletion: Test feedback V2", "committedDate": "2021-01-13T14:24:32Z", "type": "commit"}, {"oid": "31fc4cb023250087df63d4434d680eb31b595018", "url": "https://github.com/DSpace/DSpace/commit/31fc4cb023250087df63d4434d680eb31b595018", "message": "Fixing the tests & the style issues", "committedDate": "2021-01-14T12:35:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTAyNzY1NA==", "url": "https://github.com/DSpace/DSpace/pull/2744#discussion_r561027654", "bodyText": "Could we rename this method to be more descriptive, instead of just adding an n to the end of the name?  This one seems to be more about deleting the WorkflowItem (not the WorkspaceItem), so it might be better named deleteWorkflowItemSolrRecordAFterDeletionfromDbTest()", "author": "tdonohue", "createdAt": "2021-01-20T14:59:53Z", "path": "dspace-api/src/test/java/org/dspace/discovery/DiscoveryIT.java", "diffHunk": "@@ -0,0 +1,191 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.discovery;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import java.util.List;\n+import javax.servlet.http.HttpServletRequest;\n+\n+import org.dspace.AbstractIntegrationTestWithDatabase;\n+import org.dspace.builder.CollectionBuilder;\n+import org.dspace.builder.CommunityBuilder;\n+import org.dspace.builder.ItemBuilder;\n+import org.dspace.builder.WorkspaceItemBuilder;\n+import org.dspace.content.Collection;\n+import org.dspace.content.Community;\n+import org.dspace.content.WorkspaceItem;\n+import org.dspace.content.factory.ContentServiceFactory;\n+import org.dspace.content.service.WorkspaceItemService;\n+import org.dspace.discovery.indexobject.IndexableClaimedTask;\n+import org.dspace.discovery.indexobject.IndexablePoolTask;\n+import org.dspace.eperson.EPerson;\n+import org.dspace.services.factory.DSpaceServicesFactory;\n+import org.dspace.xmlworkflow.factory.XmlWorkflowServiceFactory;\n+import org.dspace.xmlworkflow.service.WorkflowRequirementsService;\n+import org.dspace.xmlworkflow.service.XmlWorkflowService;\n+import org.dspace.xmlworkflow.state.Workflow;\n+import org.dspace.xmlworkflow.storedcomponents.ClaimedTask;\n+import org.dspace.xmlworkflow.storedcomponents.XmlWorkflowItem;\n+import org.dspace.xmlworkflow.storedcomponents.service.ClaimedTaskService;\n+import org.junit.Ignore;\n+import org.junit.Test;\n+import org.springframework.mock.web.MockHttpServletRequest;\n+\n+/**\n+ * This class will aim to test Discovery related use cases\n+ */\n+public class DiscoveryIT extends AbstractIntegrationTestWithDatabase {\n+\n+    protected WorkspaceItemService workspaceItemService = ContentServiceFactory.getInstance().getWorkspaceItemService();\n+    protected SearchService searchService = SearchUtils.getSearchService();\n+\n+    XmlWorkflowService workflowService = XmlWorkflowServiceFactory.getInstance().getXmlWorkflowService();\n+\n+    WorkflowRequirementsService workflowRequirementsService = XmlWorkflowServiceFactory.getInstance().\n+            getWorkflowRequirementsService();\n+\n+    ClaimedTaskService claimedTaskService = XmlWorkflowServiceFactory.getInstance().getClaimedTaskService();\n+\n+    IndexingService indexer = DSpaceServicesFactory.getInstance().getServiceManager()\n+                                                   .getServiceByName(IndexingService.class.getName(),\n+                                                                     IndexingService.class);\n+\n+\n+    @Ignore\n+    @Test\n+    public void deleteWorkspaceItemSolrRecordAfterDeletionFromDbTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+        Community community = CommunityBuilder.createCommunity(context)\n+                                              .withName(\"Parent Community\")\n+                                              .build();\n+        Collection col = CollectionBuilder.createCollection(context, community)\n+                                          .build();\n+        WorkspaceItem workspaceItem = WorkspaceItemBuilder.createWorkspaceItem(context, col)\n+                                                          .withAbstract(\"headache\")\n+                                                          .build();\n+        context.restoreAuthSystemState();\n+\n+        DiscoverQuery discoverQuery = new DiscoverQuery();\n+        discoverQuery.setQuery(\"*:*\");\n+        discoverQuery.addFilterQueries(\"search.resourceid:\" + workspaceItem.getID());\n+        DiscoverResult discoverResult = searchService.search(context, discoverQuery);\n+        List<IndexableObject> indexableObjects = discoverResult.getIndexableObjects();\n+        assertEquals(1, indexableObjects.size());\n+        assertEquals(1, discoverResult.getTotalSearchResults());\n+\n+        context.turnOffAuthorisationSystem();\n+        workspaceItemService.deleteAll(context, workspaceItem);\n+        context.dispatchEvents();\n+        context.restoreAuthSystemState();\n+\n+        discoverResult = searchService.search(context, discoverQuery);\n+        indexableObjects = discoverResult.getIndexableObjects();\n+        assertEquals(0, indexableObjects.size());\n+        assertEquals(0, discoverResult.getTotalSearchResults());\n+    }\n+\n+    @Ignore\n+    @Test\n+    public void deleteWorkspaceItemSolrRecordAfterDeletionFromDbTestn() throws Exception {", "originalCommit": "31fc4cb023250087df63d4434d680eb31b595018", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTAyOTk5Mg==", "url": "https://github.com/DSpace/DSpace/pull/2744#discussion_r561029992", "bodyText": "It doesn't appear that we are testing that everything is (in fact) deleted.  It looks like we are just testing that the deletion succeeds.  Am I misunderstanding the purpose of this test?  If so, perhaps we can add more inline comments here to describe what this test is proving.\nIt's also unclear (to me) why we keep creating new Items in this test via the ItemBuilder (see lines 152 and 141).... so, it may be good to add inline comments here in general, as it's unclear why adding additional Items is necessary to test the number of Pooled or Claimed Tasks in the Workflow.", "author": "tdonohue", "createdAt": "2021-01-20T15:01:29Z", "path": "dspace-api/src/test/java/org/dspace/discovery/DiscoveryIT.java", "diffHunk": "@@ -0,0 +1,191 @@\n+/**\n+ * The contents of this file are subject to the license and copyright\n+ * detailed in the LICENSE and NOTICE files at the root of the source\n+ * tree and available online at\n+ *\n+ * http://www.dspace.org/license/\n+ */\n+package org.dspace.discovery;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import java.util.List;\n+import javax.servlet.http.HttpServletRequest;\n+\n+import org.dspace.AbstractIntegrationTestWithDatabase;\n+import org.dspace.builder.CollectionBuilder;\n+import org.dspace.builder.CommunityBuilder;\n+import org.dspace.builder.ItemBuilder;\n+import org.dspace.builder.WorkspaceItemBuilder;\n+import org.dspace.content.Collection;\n+import org.dspace.content.Community;\n+import org.dspace.content.WorkspaceItem;\n+import org.dspace.content.factory.ContentServiceFactory;\n+import org.dspace.content.service.WorkspaceItemService;\n+import org.dspace.discovery.indexobject.IndexableClaimedTask;\n+import org.dspace.discovery.indexobject.IndexablePoolTask;\n+import org.dspace.eperson.EPerson;\n+import org.dspace.services.factory.DSpaceServicesFactory;\n+import org.dspace.xmlworkflow.factory.XmlWorkflowServiceFactory;\n+import org.dspace.xmlworkflow.service.WorkflowRequirementsService;\n+import org.dspace.xmlworkflow.service.XmlWorkflowService;\n+import org.dspace.xmlworkflow.state.Workflow;\n+import org.dspace.xmlworkflow.storedcomponents.ClaimedTask;\n+import org.dspace.xmlworkflow.storedcomponents.XmlWorkflowItem;\n+import org.dspace.xmlworkflow.storedcomponents.service.ClaimedTaskService;\n+import org.junit.Ignore;\n+import org.junit.Test;\n+import org.springframework.mock.web.MockHttpServletRequest;\n+\n+/**\n+ * This class will aim to test Discovery related use cases\n+ */\n+public class DiscoveryIT extends AbstractIntegrationTestWithDatabase {\n+\n+    protected WorkspaceItemService workspaceItemService = ContentServiceFactory.getInstance().getWorkspaceItemService();\n+    protected SearchService searchService = SearchUtils.getSearchService();\n+\n+    XmlWorkflowService workflowService = XmlWorkflowServiceFactory.getInstance().getXmlWorkflowService();\n+\n+    WorkflowRequirementsService workflowRequirementsService = XmlWorkflowServiceFactory.getInstance().\n+            getWorkflowRequirementsService();\n+\n+    ClaimedTaskService claimedTaskService = XmlWorkflowServiceFactory.getInstance().getClaimedTaskService();\n+\n+    IndexingService indexer = DSpaceServicesFactory.getInstance().getServiceManager()\n+                                                   .getServiceByName(IndexingService.class.getName(),\n+                                                                     IndexingService.class);\n+\n+\n+    @Ignore\n+    @Test\n+    public void deleteWorkspaceItemSolrRecordAfterDeletionFromDbTest() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+        Community community = CommunityBuilder.createCommunity(context)\n+                                              .withName(\"Parent Community\")\n+                                              .build();\n+        Collection col = CollectionBuilder.createCollection(context, community)\n+                                          .build();\n+        WorkspaceItem workspaceItem = WorkspaceItemBuilder.createWorkspaceItem(context, col)\n+                                                          .withAbstract(\"headache\")\n+                                                          .build();\n+        context.restoreAuthSystemState();\n+\n+        DiscoverQuery discoverQuery = new DiscoverQuery();\n+        discoverQuery.setQuery(\"*:*\");\n+        discoverQuery.addFilterQueries(\"search.resourceid:\" + workspaceItem.getID());\n+        DiscoverResult discoverResult = searchService.search(context, discoverQuery);\n+        List<IndexableObject> indexableObjects = discoverResult.getIndexableObjects();\n+        assertEquals(1, indexableObjects.size());\n+        assertEquals(1, discoverResult.getTotalSearchResults());\n+\n+        context.turnOffAuthorisationSystem();\n+        workspaceItemService.deleteAll(context, workspaceItem);\n+        context.dispatchEvents();\n+        context.restoreAuthSystemState();\n+\n+        discoverResult = searchService.search(context, discoverQuery);\n+        indexableObjects = discoverResult.getIndexableObjects();\n+        assertEquals(0, indexableObjects.size());\n+        assertEquals(0, discoverResult.getTotalSearchResults());\n+    }\n+\n+    @Ignore\n+    @Test\n+    public void deleteWorkspaceItemSolrRecordAfterDeletionFromDbTestn() throws Exception {\n+        context.turnOffAuthorisationSystem();\n+        Community community = CommunityBuilder.createCommunity(context)\n+                                              .withName(\"Parent Community\")\n+                                              .build();\n+        Collection collection = CollectionBuilder.createCollection(context, community)\n+                                                 .withWorkflowGroup(1, admin)\n+                                                 .build();\n+\n+        WorkspaceItem wsi = WorkspaceItemBuilder.createWorkspaceItem(context, collection)\n+                                                .withTitle(\"Test item\")\n+                                                .withIssueDate(\"2019-03-06\")\n+                                                .withSubject(\"ExtraEntry\")\n+                                                .build();\n+\n+        ItemBuilder.createItem(context, collection).build();\n+\n+\n+\n+        Workflow workflow = XmlWorkflowServiceFactory.getInstance().getWorkflowFactory().getWorkflow(collection);\n+\n+        ItemBuilder.createItem(context, collection).build();\n+\n+        context.restoreAuthSystemState();\n+\n+        MockHttpServletRequest httpServletRequest = new MockHttpServletRequest();\n+        httpServletRequest.setParameter(\"submit_approve\", \"submit_approve\");\n+\n+        XmlWorkflowItem workflowItem = workflowService.startWithoutNotify(context, wsi);\n+        context.dispatchEvents();\n+        indexer.commit();\n+\n+        assertSearchQuery(IndexablePoolTask.TYPE, 1);\n+\n+        context.turnOffAuthorisationSystem();\n+        ItemBuilder.createItem(context, collection).build();\n+        context.restoreAuthSystemState();\n+\n+        executeWorkflowAction(httpServletRequest, admin, workflow, workflowItem,\n+                \"reviewstep\", \"claimaction\");\n+\n+\n+        context.dispatchEvents();\n+        indexer.commit();\n+\n+        context.turnOffAuthorisationSystem();\n+        ItemBuilder.createItem(context, collection).build();\n+        context.restoreAuthSystemState();\n+\n+        assertSearchQuery(IndexablePoolTask.TYPE, 0);\n+        assertSearchQuery(IndexableClaimedTask.TYPE, 1);\n+\n+        returnToPool(admin, workflowItem);\n+        context.dispatchEvents();\n+        indexer.commit();\n+\n+        context.turnOffAuthorisationSystem();\n+        ItemBuilder.createItem(context, collection).build();\n+        context.restoreAuthSystemState();\n+\n+        assertSearchQuery(IndexablePoolTask.TYPE, 1);\n+        assertSearchQuery(IndexableClaimedTask.TYPE, 0);\n+\n+        workflowService.deleteWorkflowByWorkflowItem(context, workflowItem, admin);", "originalCommit": "31fc4cb023250087df63d4434d680eb31b595018", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}