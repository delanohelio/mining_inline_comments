{"pr_number": 2933, "pr_title": "Cookie preferences & End User Agreement per account - initial registries update", "pr_createdAt": "2020-08-19T13:26:55Z", "pr_url": "https://github.com/DSpace/DSpace/pull/2933", "timeline": [{"oid": "e1fb87773c4aac18072fb8eef37cf866945d95e4", "url": "https://github.com/DSpace/DSpace/commit/e1fb87773c4aac18072fb8eef37cf866945d95e4", "message": "taskid 72455 Cookie Preferences per account", "committedDate": "2020-08-13T18:11:32Z", "type": "commit"}, {"oid": "5eaee53c6b8f598e6c1392dc12660b7505646fcf", "url": "https://github.com/DSpace/DSpace/commit/5eaee53c6b8f598e6c1392dc12660b7505646fcf", "message": "taskid 72455 Cookie Preferences per account - feedback", "committedDate": "2020-08-19T13:16:59Z", "type": "commit"}, {"oid": "899f04c5ed1651ce04c3a51e1442c9d9cd4bac81", "url": "https://github.com/DSpace/DSpace/commit/899f04c5ed1651ce04c3a51e1442c9d9cd4bac81", "message": "Additional metadatafield related to the cookie preferences", "committedDate": "2020-08-20T11:06:02Z", "type": "commit"}, {"oid": "1773b40acb9fe65488abc59e8c101c66767650c8", "url": "https://github.com/DSpace/DSpace/commit/1773b40acb9fe65488abc59e8c101c66767650c8", "message": "Checkstyle fix", "committedDate": "2020-08-20T12:53:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAxNDU0Mw==", "url": "https://github.com/DSpace/DSpace/pull/2933#discussion_r474014543", "bodyText": "I would prefer to have dspace.agreements.acceptedDate storing the timestamp of the acceptance. Anyway it would be better to add some scope note about how it will be used", "author": "abollini", "createdAt": "2020-08-20T14:12:39Z", "path": "dspace/config/registries/dspace-types.xml", "diffHunk": "@@ -16,5 +16,18 @@\n         <scope_note></scope_note>\n     </dc-type>\n \n+    <dc-type>\n+        <schema>dspace</schema>\n+        <element>agreements</element>\n+        <qualifier>end-user</qualifier>", "originalCommit": "1773b40acb9fe65488abc59e8c101c66767650c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDEwODg5Mw==", "url": "https://github.com/DSpace/DSpace/pull/2933#discussion_r474108893", "bodyText": "@abollini : I think you might be misunderstanding the point of this metadata field.  There's not just a single user/usage agreement, so the field dspace.agreements.acceptedDate seems wrong, as it implies there's one agreement with one date of acceptance.\nInstead, there's (at least) two different agreements required by the GDPR Working Group:\n\nA cookie consent form, described in more detail here: DSpace/dspace-angular#735 (comment)\nAn End User Agreement, described in more detail here: #2808 (comment)\n\nSo, this PR is creating two new metadata fields for the EPerson object:\n\ndspace.agreements.cookies to store an EPerson's answer to the Cookie consent form. My assumption is this field will store the list of cookies that the EPerson has chosen to allow (opt-in approach).  It likely cannot be just a true/false field as we had talked previously about using something like https://klaro.kiprotect.com/#features\ndspace.agreements.end-user to store an EPerson's answer to the End User agreement.  My assumption is that this field may be simply true or false based on whether they agree with the End User agreement.  However, we could choose to have this field store the date/time of agreement.\n\nArguably, if this field is ever false or null then that EPerson account should be blocked until they agree.  It should not be possible to use DSpace if you don't agree to the End User Agreement.\n\n\n\nOverall, I agree that we need to add in <scope_note> descriptions to both of these fields in order to describe the usage and valid/accepted values.  Currently, while the fields look OK at a glance, I've had to make assumptions on how I expect them to be used (but I'm not sure whether my assumptions are correct).\n@pnbecker : You may also want to review the direction of this small PR to provide any feedback on behalf of the GDPR Working Group", "author": "tdonohue", "createdAt": "2020-08-20T16:21:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAxNDU0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ3NjczNw==", "url": "https://github.com/DSpace/DSpace/pull/2933#discussion_r474476737", "bodyText": "dspace.agreements.cookies to store an EPerson's answer to the Cookie consent form. My assumption is this field will store the list of cookies that the EPerson has chosen to allow (opt-in approach).  It likely cannot be just a true/false field as we had talked previously about using something like https://klaro.kiprotect.com/#features\n\n\nThat is correct, it will store a copy of the klaro cookie, which is an array of cookieName/boolean pairs. The contents of this metadata field wil be set as the klaro cookie for the session every time you log in, and kept up to date every time you change something in the klaro panel.\n\n\ndspace.agreements.end-user to store an EPerson's answer to the End User agreement.  My assumption is that this field may be simply true or false based on whether they agree with the End User agreement.  However, we could choose to have this field store the date/time of agreement.\ni. Arguably, if this field is ever false or null then that EPerson account should be blocked until they agree.  It should not be possible to use DSpace if you don't agree to the End User Agreement.\n\n\nCorrect. If this metadata field has any value other than true, the user will see the end-user agreement immediately after logging in, and can't do anything else until they agree. Disagreeing or canceling will log them out again. If there is an updated version of the user agreement the idea is that you delete this field for all EPersons, so they all have to agree again. We could store a timestamp here instead if that's preferred but I don't see a use case for it at the moment.", "author": "artlowel", "createdAt": "2020-08-21T07:38:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAxNDU0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc0NzkwMA==", "url": "https://github.com/DSpace/DSpace/pull/2933#discussion_r474747900", "bodyText": "I would like to see these tests have more accurate sample metadata.  So, based on the discussion in this ticket, the end-user field should likely be set to true, and the cookies field should store a sample Klaro cookie (if we know what that looks like...if we do not, some sort of sample array of values is good enough).  That would help us better document how these fields are expected to be used.", "author": "tdonohue", "createdAt": "2020-08-21T14:51:26Z", "path": "dspace-api/src/test/java/org/dspace/eperson/EPersonTest.java", "diffHunk": "@@ -78,6 +78,23 @@ public void destroy() {\n         super.destroy();\n     }\n \n+    @Test\n+    public void testPreferences() throws Exception {\n+\n+        ePersonService.addMetadata(context, eperson, \"dspace\", \"agreements\", \"end-user\", null, \"test\");\n+        ePersonService.addMetadata(context, eperson, \"dspace\", \"agreements\", \"cookies\", null,\n+                                   \"Dspace cookies agreement metadata\");", "originalCommit": "1773b40acb9fe65488abc59e8c101c66767650c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTMxNzE5NA==", "url": "https://github.com/DSpace/DSpace/pull/2933#discussion_r479317194", "bodyText": "I'd checked with the Angular team for an example of the klaro cookie, so we've used this in our test.\nI totally agree that actually having relevant information in the test would result in the actual test being more understood.", "author": "jonas-atmire", "createdAt": "2020-08-28T13:58:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc0NzkwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc0ODk2MA==", "url": "https://github.com/DSpace/DSpace/pull/2933#discussion_r474748960", "bodyText": "As noted elsewhere, we should add a scope note here.  It could say something like: \"Stores whether the End User Agreement has been accepted by an EPerson. Valid values; true, false\"", "author": "tdonohue", "createdAt": "2020-08-21T14:53:09Z", "path": "dspace/config/registries/dspace-types.xml", "diffHunk": "@@ -16,5 +16,18 @@\n         <scope_note></scope_note>\n     </dc-type>\n \n+    <dc-type>\n+        <schema>dspace</schema>\n+        <element>agreements</element>\n+        <qualifier>end-user</qualifier>\n+        <scope_note></scope_note>", "originalCommit": "1773b40acb9fe65488abc59e8c101c66767650c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTMwOTgwMg==", "url": "https://github.com/DSpace/DSpace/pull/2933#discussion_r479309802", "bodyText": "Agreed that the scope note needed to be added.\nI'd made a mental note to have that updated, but seems that my memory had failed me to actually go through on that as well.\nThanks for the feedback, we've updated the scopes notes for these new fields", "author": "jonas-atmire", "createdAt": "2020-08-28T13:50:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc0ODk2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc1MDM3MQ==", "url": "https://github.com/DSpace/DSpace/pull/2933#discussion_r474750371", "bodyText": "Same here, should have a scope note.  It could say something like: \"Stores the cookie preferences of an EPerson, as selected in last session. Value will be an array of cookieName/boolean pairs, specifying which cookies are allowed or not allowed.\"  (Please verify this for accuracy, but I think that's correct.)", "author": "tdonohue", "createdAt": "2020-08-21T14:55:20Z", "path": "dspace/config/registries/dspace-types.xml", "diffHunk": "@@ -16,5 +16,18 @@\n         <scope_note></scope_note>\n     </dc-type>\n \n+    <dc-type>\n+        <schema>dspace</schema>\n+        <element>agreements</element>\n+        <qualifier>end-user</qualifier>\n+        <scope_note></scope_note>\n+    </dc-type>\n+\n+    <dc-type>\n+        <schema>dspace</schema>\n+        <element>agreements</element>\n+        <qualifier>cookies</qualifier>\n+        <scope_note></scope_note>", "originalCommit": "1773b40acb9fe65488abc59e8c101c66767650c8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8adc7e5c318bd09dcf38133319da61d67b261328", "url": "https://github.com/DSpace/DSpace/commit/8adc7e5c318bd09dcf38133319da61d67b261328", "message": "taskid 72455 Cookie Preferences per account - add scope notes and more realistic test value", "committedDate": "2020-08-28T13:26:22Z", "type": "commit"}]}