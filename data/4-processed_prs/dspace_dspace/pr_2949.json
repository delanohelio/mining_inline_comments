{"pr_number": 2949, "pr_title": "Upgrade to Flyway v6.5.5. Update code based on Flyway API changes", "pr_createdAt": "2020-09-01T18:54:16Z", "pr_url": "https://github.com/DSpace/DSpace/pull/2949", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIxNzgzMw==", "url": "https://github.com/DSpace/DSpace/pull/2949#discussion_r492217833", "bodyText": "I'm puzzled as to why we use ClassPathResource instead of just passing a path to a method which reads from the path into a String.  I haven't found any other use of ClassPathResource in this patch than to hold a path.", "author": "mwoodiupui", "createdAt": "2020-09-21T17:10:45Z", "path": "dspace-api/src/main/java/org/dspace/storage/rdbms/migration/V5_7_2017_05_05__DS_3431_Add_Policies_for_BasicWorkflow.java", "diffHunk": "@@ -7,45 +7,42 @@\n  */\n package org.dspace.storage.rdbms.migration;\n \n-import java.sql.Connection;\n-\n-import org.dspace.core.Constants;\n import org.dspace.storage.rdbms.DatabaseUtils;\n-import org.flywaydb.core.api.migration.MigrationChecksumProvider;\n-import org.flywaydb.core.api.migration.jdbc.JdbcMigration;\n-import org.flywaydb.core.internal.util.scanner.classpath.ClassPathResource;\n+import org.flywaydb.core.api.migration.BaseJavaMigration;\n+import org.flywaydb.core.api.migration.Context;\n+import org.springframework.core.io.ClassPathResource;\n \n public class V5_7_2017_05_05__DS_3431_Add_Policies_for_BasicWorkflow\n-    implements JdbcMigration, MigrationChecksumProvider {\n+    extends BaseJavaMigration {\n \n     // Size of migration script run\n     Integer migration_file_size = -1;\n \n \n     @Override\n-    public void migrate(Connection connection) throws Exception {\n+    public void migrate(Context context) throws Exception {\n         // Based on type of DB, get path to SQL migration script\n-        String dbtype = DatabaseUtils.getDbType(connection);\n+        String dbtype = DatabaseUtils.getDbType(context.getConnection());\n \n         String dataMigrateSQL;\n         String sqlMigrationPath = \"org/dspace/storage/rdbms/sqlmigration/workflow/\" + dbtype + \"/\";\n         // Now, check if the XMLWorkflow table (cwf_workflowitem) already exists in this database\n         // If XMLWorkflow Table does NOT exist in this database, then lets do the migration!\n         // If XMLWorkflow Table ALREADY exists, then this migration is a noop, we assume you manually ran the sql\n         // scripts\n-        if (DatabaseUtils.tableExists(connection, \"cwf_workflowitem\")) {\n+        if (DatabaseUtils.tableExists(context.getConnection(), \"cwf_workflowitem\")) {\n             return;\n         } else {\n             //Migrate the basic workflow\n             // Get the contents of our data migration script, based on path & DB type\n-            dataMigrateSQL = new ClassPathResource(sqlMigrationPath + \"basicWorkflow\" + \"/V5.7_2017.05.05__DS-3431.sql\",\n-                                                   getClass().getClassLoader())\n-                .loadAsString(Constants.DEFAULT_ENCODING);\n+            dataMigrateSQL = MigrationUtils.resourceToString(\n+                new ClassPathResource(sqlMigrationPath + \"basicWorkflow\" + \"/V5.7_2017.05.05__DS-3431.sql\",", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI3Nzk5MA==", "url": "https://github.com/DSpace/DSpace/pull/2949#discussion_r492277990", "bodyText": "@mwoodiupui : I'm not sure if I understand your comment?  Are you saying that MigrationUtils.resourceToString() should be changed to just take in a resource path?  I guess that's reasonable... I had simply done it this way so that I could use Resource.getInputStream() to easily read the resource....though, I guess I could have refactored all this to use the ClassLoader instead...e.g. using something like ClassLoader.getResourceAsStream(String path).\nIt doesn't much change what the code does here, as it's essentially the same.  But, if I understand your comment, you are right that it might simplify things to refactor out the usage of ClassPathResource altogether.  Is that what you are referring to?", "author": "tdonohue", "createdAt": "2020-09-21T18:56:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIxNzgzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM0ODk5OA==", "url": "https://github.com/DSpace/DSpace/pull/2949#discussion_r492348998", "bodyText": "Yes.  ClassPathResource can do a number of things, but the only thing it is doing for us is holding a reference to a String.  We may as well pass the String reference to resourceToString directly, instead of wrapping it in another object.  I wouldn't refuse to approve this patch as-is just because of this, though.", "author": "mwoodiupui", "createdAt": "2020-09-21T21:12:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIxNzgzMw=="}], "type": "inlineReview"}, {"oid": "a2cfa09c01d839ad7a1f6920fe7a6ab6f86297f2", "url": "https://github.com/DSpace/DSpace/commit/a2cfa09c01d839ad7a1f6920fe7a6ab6f86297f2", "message": "Upgrade to Flyway v6.5.5. Update code based on Flyway API changes", "committedDate": "2020-09-24T17:23:53Z", "type": "commit"}, {"oid": "ae7ef8577bb49bcc1074a174fcd0c5c4ece4150f", "url": "https://github.com/DSpace/DSpace/commit/ae7ef8577bb49bcc1074a174fcd0c5c4ece4150f", "message": "Minor fixes. Flyway migration paths now prefer slashes to dots.  Add Flyway version to 'info' command.", "committedDate": "2020-09-24T17:23:53Z", "type": "commit"}, {"oid": "d137ce179f4f5d07e8ac014dab52f2f26473fd94", "url": "https://github.com/DSpace/DSpace/commit/d137ce179f4f5d07e8ac014dab52f2f26473fd94", "message": "Add support for upgrading database directly from DSpace 5.x to 7.x", "committedDate": "2020-09-24T17:23:53Z", "type": "commit"}, {"oid": "6379c0646141dc2909c19edc646c715ed2172693", "url": "https://github.com/DSpace/DSpace/commit/6379c0646141dc2909c19edc646c715ed2172693", "message": "Minor change to Context. Add synchronized to ensure database upgrade only triggered once", "committedDate": "2020-09-24T17:23:53Z", "type": "commit"}, {"oid": "b36849d110b1f048e71857dc9f3bf67105ff0f40", "url": "https://github.com/DSpace/DSpace/commit/b36849d110b1f048e71857dc9f3bf67105ff0f40", "message": "Ignore license header in new Flyway upgrade scripts", "committedDate": "2020-09-24T17:23:53Z", "type": "commit"}, {"oid": "71bdd8341b71c19d3a880934ba286adc420b339b", "url": "https://github.com/DSpace/DSpace/commit/71bdd8341b71c19d3a880934ba286adc420b339b", "message": "Ensure Flyway database table also checked by main() method.  Removed some invalid comments too", "committedDate": "2020-09-24T17:23:54Z", "type": "commit"}, {"oid": "569169a85219cbde9226827328609b3dc2ab0676", "url": "https://github.com/DSpace/DSpace/commit/569169a85219cbde9226827328609b3dc2ab0676", "message": "Per feedback, refactor MigrationUtils.resourceToString into getResourceAsString. Remove usage of ClassPathResource", "committedDate": "2020-09-24T18:31:33Z", "type": "commit"}, {"oid": "569169a85219cbde9226827328609b3dc2ab0676", "url": "https://github.com/DSpace/DSpace/commit/569169a85219cbde9226827328609b3dc2ab0676", "message": "Per feedback, refactor MigrationUtils.resourceToString into getResourceAsString. Remove usage of ClassPathResource", "committedDate": "2020-09-24T18:31:33Z", "type": "forcePushed"}]}