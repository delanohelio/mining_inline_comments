{"pr_number": 1937, "pr_title": "Fix File sink with lp>1 or shared dir", "pr_createdAt": "2020-02-06T16:39:40Z", "pr_url": "https://github.com/hazelcast/hazelcast-jet/pull/1937", "timeline": [{"oid": "2f2dba866f28ec42d548cf757a0aedbb946227fe", "url": "https://github.com/hazelcast/hazelcast-jet/commit/2f2dba866f28ec42d548cf757a0aedbb946227fe", "message": "Fix File sink with lp>1 or shared dir\n\nFixes #1935\n\nIn the original state all processors tried to delete all .tmp files in the\ndirectory. However when P1 got to do it, P2 might already started creating\nfiles which caused that P1 deleted working files of P2. On Windows, the delete\nfailed, on Linux the processor failed later when it was trying to commit the\nfile.", "committedDate": "2020-02-06T16:38:52Z", "type": "commit"}, {"oid": "da015b9f43d1a7c0f6f3c92a4d06a569ef2bc155", "url": "https://github.com/hazelcast/hazelcast-jet/commit/da015b9f43d1a7c0f6f3c92a4d06a569ef2bc155", "message": "Add @since tags", "committedDate": "2020-02-07T07:41:24Z", "type": "commit"}, {"oid": "48ae5c851ce909358ce228b74a2e2aea211cdc1d", "url": "https://github.com/hazelcast/hazelcast-jet/commit/48ae5c851ce909358ce228b74a2e2aea211cdc1d", "message": "Merge branch 'master' into file-sink-fix", "committedDate": "2020-02-07T07:41:51Z", "type": "commit"}, {"oid": "4bb7083dd61b232966753d8c566ed938cafb0b90", "url": "https://github.com/hazelcast/hazelcast-jet/commit/4bb7083dd61b232966753d8c566ed938cafb0b90", "message": "Fix checkstyle", "committedDate": "2020-02-07T08:26:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI3MTY1Mw==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/1937#discussion_r376271653", "bodyText": "why don't we always leave the cleanup to the processor, looks like this will simplify the logic ?", "author": "gurbuzali", "createdAt": "2020-02-07T08:42:09Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/connector/WriteFileP.java", "diffHunk": "@@ -236,6 +248,33 @@ private void abortUnfinishedTransactions() {\n         try (Stream<Path> fileStream = Files.list(directory)) {\n             fileStream\n                     .filter(file -> file.getFileName().toString().endsWith(TEMP_FILE_SUFFIX))\n+                    .filter(file -> {\n+                        assert utility.usesTransactionLifecycle();\n+                        Matcher m = FILE_INDEX_WITH_SEQ.matcher(file.getFileName().toString());\n+                        if (!m.find() || m.groupCount() < 1) {\n+                            context.logger().warning(\"file with unknown name structure found in the directory: \" + file);\n+                            return false;\n+                        }\n+                        int index;\n+                        try {\n+                            index = Integer.parseInt(m.group(1));\n+                        } catch (NumberFormatException e) {\n+                            context.logger().warning(\n+                                    \"file with unknown name structure found in the directory: \" + file, e);\n+                            return false;\n+                        }\n+                        int localIndexLow = context.memberIndex() * context.localParallelism();\n+                        int localIndexHigh = localIndexLow + context.localParallelism();\n+                        boolean isLocalIndex = index >= localIndexLow && index < localIndexHigh;\n+                        if (sharedFileSystem || isLocalIndex) {\n+                            // If the file index belongs to one of the local processors (when directory is not shred)\n+                            // or when the directory is shared, we must leave that processor to do the cleanup", "originalCommit": "4bb7083dd61b232966753d8c566ed938cafb0b90", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI3Njk4NA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/1937#discussion_r376276984", "bodyText": "Because there might be no local processor with that index. For example, if LP=1 and you have 2 members. Member 0 will fail and be restarted. After restart it will have index 1, no member on local machine will have index 0. Therefore the files with index 0 will not be handled.\nI agree it's quite complex and I was thinking about just ignoring it: the issue would be that some .tmp files will be left behind, but that's it.", "author": "viliam-durina", "createdAt": "2020-02-07T08:55:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI3MTY1Mw=="}], "type": "inlineReview"}, {"oid": "9a8fcc2a2dde039ca3ace5e62fc635ebad916c18", "url": "https://github.com/hazelcast/hazelcast-jet/commit/9a8fcc2a2dde039ca3ace5e62fc635ebad916c18", "message": "Fix compilation", "committedDate": "2020-02-07T09:11:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMwMTAxNA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/1937#discussion_r376301014", "bodyText": "typo, \"shared\"", "author": "cangencer", "createdAt": "2020-02-07T09:47:57Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/connector/WriteFileP.java", "diffHunk": "@@ -236,6 +248,33 @@ private void abortUnfinishedTransactions() {\n         try (Stream<Path> fileStream = Files.list(directory)) {\n             fileStream\n                     .filter(file -> file.getFileName().toString().endsWith(TEMP_FILE_SUFFIX))\n+                    .filter(file -> {\n+                        assert utility.usesTransactionLifecycle();\n+                        Matcher m = FILE_INDEX_WITH_SEQ.matcher(file.getFileName().toString());\n+                        if (!m.find() || m.groupCount() < 1) {\n+                            context.logger().warning(\"file with unknown name structure found in the directory: \" + file);\n+                            return false;\n+                        }\n+                        int index;\n+                        try {\n+                            index = Integer.parseInt(m.group(1));\n+                        } catch (NumberFormatException e) {\n+                            context.logger().warning(\n+                                    \"file with unknown name structure found in the directory: \" + file, e);\n+                            return false;\n+                        }\n+                        int localIndexLow = context.memberIndex() * context.localParallelism();\n+                        int localIndexHigh = localIndexLow + context.localParallelism();\n+                        boolean isLocalIndex = index >= localIndexLow && index < localIndexHigh;\n+                        if (sharedFileSystem || isLocalIndex) {\n+                            // If the file index belongs to one of the local processors (when directory is not shred)", "originalCommit": "9a8fcc2a2dde039ca3ace5e62fc635ebad916c18", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMwNDM3NQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/1937#discussion_r376304375", "bodyText": "can you add some comments here explaining what are these?", "author": "cangencer", "createdAt": "2020-02-07T09:54:53Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/connector/WriteFileP.java", "diffHunk": "@@ -236,6 +248,33 @@ private void abortUnfinishedTransactions() {\n         try (Stream<Path> fileStream = Files.list(directory)) {\n             fileStream\n                     .filter(file -> file.getFileName().toString().endsWith(TEMP_FILE_SUFFIX))\n+                    .filter(file -> {\n+                        assert utility.usesTransactionLifecycle();\n+                        Matcher m = FILE_INDEX_WITH_SEQ.matcher(file.getFileName().toString());\n+                        if (!m.find() || m.groupCount() < 1) {\n+                            context.logger().warning(\"file with unknown name structure found in the directory: \" + file);\n+                            return false;\n+                        }\n+                        int index;\n+                        try {\n+                            index = Integer.parseInt(m.group(1));\n+                        } catch (NumberFormatException e) {\n+                            context.logger().warning(\n+                                    \"file with unknown name structure found in the directory: \" + file, e);\n+                            return false;\n+                        }\n+                        int localIndexLow = context.memberIndex() * context.localParallelism();", "originalCommit": "9a8fcc2a2dde039ca3ace5e62fc635ebad916c18", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMwNTU3Mg==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/1937#discussion_r376305572", "bodyText": "missing nonnull annotation (also check the rest)", "author": "cangencer", "createdAt": "2020-02-07T09:57:24Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/pipeline/FileSinkBuilder.java", "diffHunk": "@@ -86,6 +87,8 @@\n      * The rolling is based on system time, not on event time. By default no\n      * rolling by date is done. If the system clock goes back, the outcome is\n      * unspecified and possibly corrupt.\n+     *\n+     * @since 4.0\n      */\n     public FileSinkBuilder<T> rollByDate(@Nullable String datePattern) {", "originalCommit": "9a8fcc2a2dde039ca3ace5e62fc635ebad916c18", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMwNjEwOA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/1937#discussion_r376306108", "bodyText": "wouldn't it be better to take primitive long? what good does it to do pass null? You could use Long.MAX_VALUE if you don't want rolling by size.", "author": "cangencer", "createdAt": "2020-02-07T09:58:32Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/pipeline/FileSinkBuilder.java", "diffHunk": "@@ -96,6 +99,8 @@\n      * Enables rolling by file size. If the size after writing a batch of items\n      * exceeds the limit, a new file will be started. From this follows that\n      * the file will typically be larger than the given maximum.\n+     *\n+     * @since 4.0\n      */\n     public FileSinkBuilder<T> rollByFileSize(@Nullable Long maxFileSize) {", "originalCommit": "9a8fcc2a2dde039ca3ace5e62fc635ebad916c18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMxNzIyNw==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/1937#discussion_r376317227", "bodyText": "You should then provide a constant for the user, the user has to know it or has to read the javadoc.\nAlso we add a suffix to the file name when we use rolling, Long.MAX_VALUE says \"roll when you reach this impossible to reach size\", and it's not the same as \"don't use rolline\".\nI'm not strictly against, but seems clearer to me in current shape.", "author": "viliam-durina", "createdAt": "2020-02-07T10:23:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMwNjEwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQxMTI4NQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/1937#discussion_r376411285", "bodyText": "I just find it a bit strange to pass null, since you're not required to call the method?", "author": "cangencer", "createdAt": "2020-02-07T14:16:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMwNjEwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMwNjQzNQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/1937#discussion_r376306435", "bodyText": "can't we always assume it's shared, why require the user to specify it or not? It makes sense for source, but not for sink. Even if it's not shared, you want distinct files you can merge later.", "author": "cangencer", "createdAt": "2020-02-07T09:59:18Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/pipeline/FileSinkBuilder.java", "diffHunk": "@@ -120,17 +125,41 @@\n      *      guarantee. If false, sink's guarantee will be at-least-once\n      *      even if job's is exactly-once\n      * @return this instance for fluent API\n+     *\n+     * @since 4.0\n      */\n     public FileSinkBuilder<T> exactlyOnce(boolean enable) {\n         exactlyOnce = enable;\n         return this;\n     }\n \n+    /**\n+     * Sets if files are in a shared storage visible to all members. Default\n+     * value is {@code false}.\n+     * <p>\n+     * If {@code sharedFileSystem} is {@code true}, Jet will assume all members\n+     * see the same files. Otherwise it will assume that only processors on the\n+     * local member them.\n+     * <p>\n+     * If you start all the members on a single machine (such as for\n+     * development), set this property to true. If you have multiple machines\n+     * with multiple members each and the directory is not a shared storage,\n+     * it's not possible to configure the file reader correctly - use only one\n+     * member per machine.\n+     *\n+     * @since 4.0\n+     */\n+    @Nonnull\n+    public FileSinkBuilder<T> sharedFileSystem(boolean sharedFileSystem) {", "originalCommit": "9a8fcc2a2dde039ca3ace5e62fc635ebad916c18", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0a14db04e48e58736c4ef31dd773809bc5abeb00", "url": "https://github.com/hazelcast/hazelcast-jet/commit/0a14db04e48e58736c4ef31dd773809bc5abeb00", "message": "Simplify aborting txns, assume folder is shared", "committedDate": "2020-02-07T10:41:16Z", "type": "commit"}, {"oid": "04022c594ca078b7547b7cd100ea5b2b15221767", "url": "https://github.com/hazelcast/hazelcast-jet/commit/04022c594ca078b7547b7cd100ea5b2b15221767", "message": "Merge branch 'master' into file-sink-fix", "committedDate": "2020-02-07T14:23:21Z", "type": "commit"}, {"oid": "b09c9ef009797c0e2ea930ebbaece5c29c30783c", "url": "https://github.com/hazelcast/hazelcast-jet/commit/b09c9ef009797c0e2ea930ebbaece5c29c30783c", "message": "Use constant to disable file rolling by size", "committedDate": "2020-02-07T14:31:52Z", "type": "commit"}, {"oid": "0c4c9c3743213885fb8e21a74012d3c9e5a20175", "url": "https://github.com/hazelcast/hazelcast-jet/commit/0c4c9c3743213885fb8e21a74012d3c9e5a20175", "message": "Fix checkstyle", "committedDate": "2020-02-07T14:39:54Z", "type": "commit"}, {"oid": "1dda7f254475de0d4d1e9901f625806678f22622", "url": "https://github.com/hazelcast/hazelcast-jet/commit/1dda7f254475de0d4d1e9901f625806678f22622", "message": "Fix compilation", "committedDate": "2020-02-07T16:23:45Z", "type": "commit"}]}