{"pr_number": 2737, "pr_title": "Use static loggers and log with prefix", "pr_createdAt": "2020-12-08T08:25:31Z", "pr_url": "https://github.com/hazelcast/hazelcast-jet/pull/2737", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE3MjU5OQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2737#discussion_r539172599", "bodyText": "This is a bit performance sensitive. Instead of a pattern we should append \" -> \" to the prefix in the constructor and here use this:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    wrapped.log(level, String.format(PATTERN, prefix, message));\n          \n          \n            \n                    wrapped.log(level, prefix + message);", "author": "viliam-durina", "createdAt": "2020-12-09T10:05:56Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/execution/PrefixedLogger.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.impl.execution;\n+\n+import com.hazelcast.logging.AbstractLogger;\n+import com.hazelcast.logging.ILogger;\n+import com.hazelcast.logging.LogEvent;\n+\n+import java.util.logging.Level;\n+import java.util.logging.LogRecord;\n+\n+public class PrefixedLogger extends AbstractLogger {\n+\n+    private static final String PATTERN = \"%s -> %s\";\n+\n+    private final ILogger wrapped;\n+    private final String prefix;\n+\n+    public PrefixedLogger(ILogger wrapped, String prefix) {\n+        this.wrapped = wrapped;\n+        this.prefix = prefix;\n+    }\n+\n+    @Override\n+    public void log(Level level, String message) {\n+        wrapped.log(level, String.format(PATTERN, prefix, message));", "originalCommit": "cf477d4d5f759832d730f52860329a245000e88e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE3MzEyMg==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2737#discussion_r539173122", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class PrefixedLogger extends AbstractLogger {\n          \n          \n            \n            /**\n          \n          \n            \n             * A Logger implementation that wraps another Logger and prefixes all the\n          \n          \n            \n             * logged messages with a given prefix.\n          \n          \n            \n             */\n          \n          \n            \n            public class PrefixedLogger extends AbstractLogger {", "author": "viliam-durina", "createdAt": "2020-12-09T10:06:42Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/execution/PrefixedLogger.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.impl.execution;\n+\n+import com.hazelcast.logging.AbstractLogger;\n+import com.hazelcast.logging.ILogger;\n+import com.hazelcast.logging.LogEvent;\n+\n+import java.util.logging.Level;\n+import java.util.logging.LogRecord;\n+\n+public class PrefixedLogger extends AbstractLogger {", "originalCommit": "cf477d4d5f759832d730f52860329a245000e88e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE3NjA4Nw==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2737#discussion_r539176087", "bodyText": "Maybe the -> part should not be hardcoded here but by the user of this class. This class would then have a very simple contract and be in some util package.", "author": "viliam-durina", "createdAt": "2020-12-09T10:11:02Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/execution/PrefixedLogger.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.impl.execution;\n+\n+import com.hazelcast.logging.AbstractLogger;\n+import com.hazelcast.logging.ILogger;\n+import com.hazelcast.logging.LogEvent;\n+\n+import java.util.logging.Level;\n+import java.util.logging.LogRecord;\n+\n+public class PrefixedLogger extends AbstractLogger {\n+\n+    private static final String PATTERN = \"%s -> %s\";", "originalCommit": "cf477d4d5f759832d730f52860329a245000e88e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE4NTE0OA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2737#discussion_r539185148", "bodyText": "Previous code used getLogger(getClass() + \".\" + toString()). Now we use context.logger() which already contains vertex information, so we'll log the vertex information twice.", "author": "viliam-durina", "createdAt": "2020-12-09T10:24:12Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/execution/ProcessorTasklet.java", "diffHunk": "@@ -172,7 +170,7 @@ public ProcessorTasklet(\n                                     .sorted(comparing(OutboundEdgeStream::ordinal))\n                                     .toArray(OutboundEdgeStream[]::new);\n         this.ssContext = ssContext;\n-        this.logger = getLogger(context);\n+        this.logger = new PrefixedLogger(context.logger(), toString());", "originalCommit": "cf477d4d5f759832d730f52860329a245000e88e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE4NjIxNg==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2737#discussion_r539186216", "bodyText": "We no longer need to sanitize the vertex name, now it's a part of the message, not of the logger name.\nSame on line 251, I can't comment there because it's not changed in this PR. We can also remove the sanitizeLoggerNamePart() method, we're no longer using any user input text in logger names anywhere.", "author": "viliam-durina", "createdAt": "2020-12-09T10:25:40Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/execution/init/ExecutionPlan.java", "diffHunk": "@@ -177,30 +178,31 @@ public void initialize(NodeEngine nodeEngine,\n             QueuedPipe<Object>[] snapshotQueues = new QueuedPipe[vertex.localParallelism()];\n             Arrays.setAll(snapshotQueues, i -> new OneToOneConcurrentArrayQueue<>(SNAPSHOT_QUEUE_SIZE));\n             ConcurrentConveyor<Object> ssConveyor = ConcurrentConveyor.concurrentConveyor(null, snapshotQueues);\n+            ILogger storeSnapShotLogger = new PrefixedLogger(\n+                    nodeEngine.getLogger(StoreSnapshotTasklet.class), sanitizeLoggerNamePart(vertex.name()));", "originalCommit": "cf477d4d5f759832d730f52860329a245000e88e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE4NjgwMw==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2737#discussion_r539186803", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        ILogger storeSnapShotLogger = new PrefixedLogger(\n          \n          \n            \n                        ILogger storeSnapshotLogger = new PrefixedLogger(", "author": "viliam-durina", "createdAt": "2020-12-09T10:26:34Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/execution/init/ExecutionPlan.java", "diffHunk": "@@ -177,30 +178,31 @@ public void initialize(NodeEngine nodeEngine,\n             QueuedPipe<Object>[] snapshotQueues = new QueuedPipe[vertex.localParallelism()];\n             Arrays.setAll(snapshotQueues, i -> new OneToOneConcurrentArrayQueue<>(SNAPSHOT_QUEUE_SIZE));\n             ConcurrentConveyor<Object> ssConveyor = ConcurrentConveyor.concurrentConveyor(null, snapshotQueues);\n+            ILogger storeSnapShotLogger = new PrefixedLogger(", "originalCommit": "cf477d4d5f759832d730f52860329a245000e88e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE4OTc0MA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2737#discussion_r539189740", "bodyText": "This would be easier to read:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        String prefix = String.format(\"%s#ProcessorMetaSupplier\", vertex.getName());\n          \n          \n            \n                        String prefix = vertex.getName() + \"#ProcessorMetaSupplier\";", "author": "viliam-durina", "createdAt": "2020-12-09T10:30:44Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/execution/init/ExecutionPlanBuilder.java", "diffHunk": "@@ -87,8 +88,8 @@ private ExecutionPlanBuilder() {\n                     e -> vertexIdMap.get(e.getSourceName()), isJobDistributed);\n             final List<EdgeDef> outbound = toEdgeDefs(dag.getOutboundEdges(vertex.getName()), defaultEdgeConfig,\n                     e -> vertexIdMap.get(e.getDestName()), isJobDistributed);\n-            final ILogger logger = nodeEngine.getLogger(String.format(\"%s.%s#ProcessorMetaSupplier\",\n-                    metaSupplier.getClass().getName(), vertex.getName()));\n+            String prefix = String.format(\"%s#ProcessorMetaSupplier\", vertex.getName());", "originalCommit": "cf477d4d5f759832d730f52860329a245000e88e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "534dc355783f2637a05e47caea2d057f107ef538", "url": "https://github.com/hazelcast/hazelcast-jet/commit/534dc355783f2637a05e47caea2d057f107ef538", "message": "use static loggers and log with prefixed", "committedDate": "2020-12-11T07:49:15Z", "type": "commit"}, {"oid": "ff5860a4f5179134f3d141b485c4e88e4a7fadf5", "url": "https://github.com/hazelcast/hazelcast-jet/commit/ff5860a4f5179134f3d141b485c4e88e4a7fadf5", "message": "unify logger prefixes", "committedDate": "2020-12-11T07:49:43Z", "type": "commit"}, {"oid": "ff5860a4f5179134f3d141b485c4e88e4a7fadf5", "url": "https://github.com/hazelcast/hazelcast-jet/commit/ff5860a4f5179134f3d141b485c4e88e4a7fadf5", "message": "unify logger prefixes", "committedDate": "2020-12-11T07:49:43Z", "type": "forcePushed"}, {"oid": "9798d35cf979ed4b8e4df5d7ee8b7b58c3c53d15", "url": "https://github.com/hazelcast/hazelcast-jet/commit/9798d35cf979ed4b8e4df5d7ee8b7b58c3c53d15", "message": "fix test", "committedDate": "2020-12-11T08:14:53Z", "type": "commit"}, {"oid": "4af19a74b108c0f7bc5794fd74cee68add91ce0f", "url": "https://github.com/hazelcast/hazelcast-jet/commit/4af19a74b108c0f7bc5794fd74cee68add91ce0f", "message": "checkstyle", "committedDate": "2020-12-11T08:35:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzIyMTUxMQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2737#discussion_r543221511", "bodyText": "The name is too generic for Util. Use loggerPrefix at least. Or maybe move them to the PrefixedLogger", "author": "viliam-durina", "createdAt": "2020-12-15T10:23:38Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/util/Util.java", "diffHunk": "@@ -442,8 +443,21 @@ public static String addOrIncrementIndexInName(String name) {\n         return name + '-' + index;\n     }\n \n-    public static String sanitizeLoggerNamePart(String name) {\n-        return name.replace('.', '_');\n+    public static ILogger prefixedLogger(ILogger logger, String prefix) {\n+        return new PrefixedLogger(logger, prefix);\n+    }\n+\n+    public static String prefix(String jobName, long jobId, String vertexName) {", "originalCommit": "4af19a74b108c0f7bc5794fd74cee68add91ce0f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzIyMzk2MA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2737#discussion_r543223960", "bodyText": "The jobName is an identifier, don't trim it. If you name your job myjob  (with the trailing space), you need that trailing space when you do JetInstance.getJob(\"myjob \"). Even an empty job name is a valid job name.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    String jobIdentification = StringUtil.isNullOrEmptyAfterTrim(jobName) ? idToString(jobId) : jobName.trim();\n          \n          \n            \n                    String jobIdentification = jobName != null ? jobName : idToString(jobId);", "author": "viliam-durina", "createdAt": "2020-12-15T10:26:49Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/util/Util.java", "diffHunk": "@@ -442,8 +443,21 @@ public static String addOrIncrementIndexInName(String name) {\n         return name + '-' + index;\n     }\n \n-    public static String sanitizeLoggerNamePart(String name) {\n-        return name.replace('.', '_');\n+    public static ILogger prefixedLogger(ILogger logger, String prefix) {\n+        return new PrefixedLogger(logger, prefix);\n+    }\n+\n+    public static String prefix(String jobName, long jobId, String vertexName) {\n+        return prefix(jobName, jobId, vertexName, null);\n+    }\n+\n+    public static String prefix(String jobName, long jobId, String vertexName, int processorIndex) {\n+        return prefix(jobName, jobId, vertexName, \"procIndex:\" + processorIndex);\n+    }\n+\n+    public static String prefix(String jobName, long jobId, String vertexName, String identity) {\n+        String jobIdentification = StringUtil.isNullOrEmptyAfterTrim(jobName) ? idToString(jobId) : jobName.trim();", "originalCommit": "4af19a74b108c0f7bc5794fd74cee68add91ce0f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzIyNTEzMA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2737#discussion_r543225130", "bodyText": "\"Identity\" means that it's a handle to something that's identified by it. This is more like \"discriminator\" or \"subclass\"", "author": "viliam-durina", "createdAt": "2020-12-15T10:28:30Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/util/Util.java", "diffHunk": "@@ -442,8 +443,21 @@ public static String addOrIncrementIndexInName(String name) {\n         return name + '-' + index;\n     }\n \n-    public static String sanitizeLoggerNamePart(String name) {\n-        return name.replace('.', '_');\n+    public static ILogger prefixedLogger(ILogger logger, String prefix) {\n+        return new PrefixedLogger(logger, prefix);\n+    }\n+\n+    public static String prefix(String jobName, long jobId, String vertexName) {\n+        return prefix(jobName, jobId, vertexName, null);\n+    }\n+\n+    public static String prefix(String jobName, long jobId, String vertexName, int processorIndex) {\n+        return prefix(jobName, jobId, vertexName, \"procIndex:\" + processorIndex);\n+    }\n+\n+    public static String prefix(String jobName, long jobId, String vertexName, String identity) {", "originalCommit": "4af19a74b108c0f7bc5794fd74cee68add91ce0f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzIzNzk2Nw==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2737#discussion_r543237967", "bodyText": "identity can be null", "author": "viliam-durina", "createdAt": "2020-12-15T10:47:18Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/util/Util.java", "diffHunk": "@@ -442,8 +443,21 @@ public static String addOrIncrementIndexInName(String name) {\n         return name + '-' + index;\n     }\n \n-    public static String sanitizeLoggerNamePart(String name) {\n-        return name.replace('.', '_');\n+    public static ILogger prefixedLogger(ILogger logger, String prefix) {\n+        return new PrefixedLogger(logger, prefix);\n+    }\n+\n+    public static String prefix(String jobName, long jobId, String vertexName) {\n+        return prefix(jobName, jobId, vertexName, null);\n+    }\n+\n+    public static String prefix(String jobName, long jobId, String vertexName, int processorIndex) {\n+        return prefix(jobName, jobId, vertexName, \"procIndex:\" + processorIndex);\n+    }\n+\n+    public static String prefix(String jobName, long jobId, String vertexName, String identity) {\n+        String jobIdentification = StringUtil.isNullOrEmptyAfterTrim(jobName) ? idToString(jobId) : jobName.trim();\n+        return jobIdentification + \"/\" + vertexName + (identity == null ? \"\" : '/' + identity);", "originalCommit": "4af19a74b108c0f7bc5794fd74cee68add91ce0f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDA3OTk0Mw==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2737#discussion_r544079943", "bodyText": "my mistake, it's ok", "author": "viliam-durina", "createdAt": "2020-12-16T07:46:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzIzNzk2Nw=="}], "type": "inlineReview"}, {"oid": "88172dc1d425fdb76526e9fb4ded1c32e7317f9a", "url": "https://github.com/hazelcast/hazelcast-jet/commit/88172dc1d425fdb76526e9fb4ded1c32e7317f9a", "message": "Javadoc", "committedDate": "2020-12-15T19:17:03Z", "type": "commit"}, {"oid": "92188acbcaefcec2c37659cd8ca77674c4643986", "url": "https://github.com/hazelcast/hazelcast-jet/commit/92188acbcaefcec2c37659cd8ca77674c4643986", "message": "address comments", "committedDate": "2020-12-16T08:03:00Z", "type": "commit"}, {"oid": "02c96a4c3ceab53bc47cec4dcf0b23af090847ae", "url": "https://github.com/hazelcast/hazelcast-jet/commit/02c96a4c3ceab53bc47cec4dcf0b23af090847ae", "message": "merge master", "committedDate": "2020-12-16T08:09:04Z", "type": "commit"}, {"oid": "c047db2cb9dfdea0d7857ddfcff0cdb1a1111a6d", "url": "https://github.com/hazelcast/hazelcast-jet/commit/c047db2cb9dfdea0d7857ddfcff0cdb1a1111a6d", "message": "Fix test failure", "committedDate": "2020-12-16T09:36:12Z", "type": "commit"}]}