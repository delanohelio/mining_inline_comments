{"pr_number": 8116, "pr_title": "System dump archive issue #8106", "pr_createdAt": "2020-05-26T11:11:58Z", "pr_url": "https://github.com/enonic/xp/pull/8116", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ4NzkwMA==", "url": "https://github.com/enonic/xp/pull/8116#discussion_r430487900", "bodyText": "You may simplify code a bit and return ZipDumpReader right here", "author": "rymsha", "createdAt": "2020-05-26T15:10:57Z", "path": "modules/core/core-repo/src/main/java/com/enonic/xp/repo/impl/dump/reader/ZipDumpReader.java", "diffHunk": "@@ -39,14 +46,56 @@ public static ZipDumpReader create( SystemLoadListener listener, final Path base\n             final SeekableByteChannel seekableByteChannel =\n                 Files.newByteChannel( basePath.resolve( dumpName + \".zip\" ), EnumSet.of( StandardOpenOption.READ ) );\n             final ZipFile zipFile = new ZipFile( seekableByteChannel );\n-            return new ZipDumpReader( listener, PathRef.of( dumpName ), zipFile );\n+\n+            return create( listener, dumpName, zipFile );\n         }\n         catch ( IOException e )\n         {\n             throw new UncheckedIOException( e );\n         }\n     }\n \n+    private static ZipDumpReader create( final SystemLoadListener listener, final String dumpName, final ZipFile zipFile )\n+    {\n+        if ( zipFile.getEntry( \"dump.json\" ) != null )\n+        {\n+            return new ZipDumpReader( listener, PathRef.of(), zipFile );\n+        }\n+        else if ( zipFile.getEntry( dumpName + \"/dump.json\" ) != null )\n+        {\n+            return new ZipDumpReader( listener, PathRef.of( dumpName ), zipFile );\n+        }\n+        else\n+        {\n+            String rootDumpDir = null;\n+\n+            final Enumeration<ZipArchiveEntry> entries = zipFile.getEntries();\n+\n+            while ( entries.hasMoreElements() )\n+            {\n+                final ZipArchiveEntry entry = entries.nextElement();\n+\n+                final Matcher matcher = ROOT_DUMP_DIR_PATTERN.matcher( entry.getName() );\n+\n+                if ( matcher.find() )\n+                {\n+                    rootDumpDir = matcher.group( 1 );", "originalCommit": "7242f06574984b1dbb2a572897a22a95074e961e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ5MzU1MQ==", "url": "https://github.com/enonic/xp/pull/8116#discussion_r430493551", "bodyText": "Missing $ at the and. Without it a/dump.jsons would match, for ex. (this is why it is also better to use matches\nAlso . must be escaped", "author": "rymsha", "createdAt": "2020-05-26T15:18:49Z", "path": "modules/core/core-repo/src/main/java/com/enonic/xp/repo/impl/dump/reader/ZipDumpReader.java", "diffHunk": "@@ -19,11 +22,15 @@\n import com.enonic.xp.dump.SystemLoadListener;\n import com.enonic.xp.repo.impl.dump.DefaultFilePaths;\n import com.enonic.xp.repo.impl.dump.PathRef;\n+import com.enonic.xp.repo.impl.dump.RepoLoadException;\n import com.enonic.xp.repo.impl.dump.blobstore.ZipDumpReadBlobStore;\n \n public class ZipDumpReader\n     extends AbstractDumpReader\n {\n+\n+    private static final Pattern ROOT_DUMP_DIR_PATTERN = Pattern.compile( \"^([^/]+)\\\\/dump.json\" );", "originalCommit": "7242f06574984b1dbb2a572897a22a95074e961e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYzMzk0OQ==", "url": "https://github.com/enonic/xp/pull/8116#discussion_r430633949", "bodyText": "The symbol $ was added. I did not catch about .. What you mean?", "author": "anatol-sialitski", "createdAt": "2020-05-26T18:52:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ5MzU1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY1MDc0NQ==", "url": "https://github.com/enonic/xp/pull/8116#discussion_r430650745", "bodyText": "dump.json matches dump?json because . is any symbol.", "author": "rymsha", "createdAt": "2020-05-26T19:22:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ5MzU1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY1NjA3Mw==", "url": "https://github.com/enonic/xp/pull/8116#discussion_r430656073", "bodyText": "Got it.", "author": "anatol-sialitski", "createdAt": "2020-05-26T19:32:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ5MzU1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ5NzAwOA==", "url": "https://github.com/enonic/xp/pull/8116#discussion_r430497008", "bodyText": "I would prefer matches() for clarity.", "author": "rymsha", "createdAt": "2020-05-26T15:22:43Z", "path": "modules/core/core-repo/src/main/java/com/enonic/xp/repo/impl/dump/reader/ZipDumpReader.java", "diffHunk": "@@ -39,14 +46,56 @@ public static ZipDumpReader create( SystemLoadListener listener, final Path base\n             final SeekableByteChannel seekableByteChannel =\n                 Files.newByteChannel( basePath.resolve( dumpName + \".zip\" ), EnumSet.of( StandardOpenOption.READ ) );\n             final ZipFile zipFile = new ZipFile( seekableByteChannel );\n-            return new ZipDumpReader( listener, PathRef.of( dumpName ), zipFile );\n+\n+            return create( listener, dumpName, zipFile );\n         }\n         catch ( IOException e )\n         {\n             throw new UncheckedIOException( e );\n         }\n     }\n \n+    private static ZipDumpReader create( final SystemLoadListener listener, final String dumpName, final ZipFile zipFile )\n+    {\n+        if ( zipFile.getEntry( \"dump.json\" ) != null )\n+        {\n+            return new ZipDumpReader( listener, PathRef.of(), zipFile );\n+        }\n+        else if ( zipFile.getEntry( dumpName + \"/dump.json\" ) != null )\n+        {\n+            return new ZipDumpReader( listener, PathRef.of( dumpName ), zipFile );\n+        }\n+        else\n+        {\n+            String rootDumpDir = null;\n+\n+            final Enumeration<ZipArchiveEntry> entries = zipFile.getEntries();\n+\n+            while ( entries.hasMoreElements() )\n+            {\n+                final ZipArchiveEntry entry = entries.nextElement();\n+\n+                final Matcher matcher = ROOT_DUMP_DIR_PATTERN.matcher( entry.getName() );\n+\n+                if ( matcher.find() )", "originalCommit": "7242f06574984b1dbb2a572897a22a95074e961e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYzMjg0OA==", "url": "https://github.com/enonic/xp/pull/8116#discussion_r430632848", "bodyText": "@rymsha In this case I prefer matcher, because pattern already compiled and in order to get a name of rootDir will be enough to call matcher.group( 1 )", "author": "anatol-sialitski", "createdAt": "2020-05-26T18:50:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ5NzAwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY0OTY1Mw==", "url": "https://github.com/enonic/xp/pull/8116#discussion_r430649653", "bodyText": "https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/regex/Matcher.html#matches()", "author": "rymsha", "createdAt": "2020-05-26T19:20:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ5NzAwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY1NzY3Nw==", "url": "https://github.com/enonic/xp/pull/8116#discussion_r430657677", "bodyText": "Ah, I thought you meant https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/String.html#matches(java.lang.String)", "author": "anatol-sialitski", "createdAt": "2020-05-26T19:34:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ5NzAwOA=="}], "type": "inlineReview"}, {"oid": "6a8daa90b26a6050cc3ae65ea5d63991c67dabd5", "url": "https://github.com/enonic/xp/commit/6a8daa90b26a6050cc3ae65ea5d63991c67dabd5", "message": "System dump archive NullPointerException when loading system dump from archive #8106", "committedDate": "2020-05-26T18:45:40Z", "type": "forcePushed"}, {"oid": "2c64c5ea81cb2797e6f07d930668f8219f47499f", "url": "https://github.com/enonic/xp/commit/2c64c5ea81cb2797e6f07d930668f8219f47499f", "message": "System dump archive NullPointerException when loading system dump from archive #8106", "committedDate": "2020-05-26T19:35:27Z", "type": "commit"}, {"oid": "2c64c5ea81cb2797e6f07d930668f8219f47499f", "url": "https://github.com/enonic/xp/commit/2c64c5ea81cb2797e6f07d930668f8219f47499f", "message": "System dump archive NullPointerException when loading system dump from archive #8106", "committedDate": "2020-05-26T19:35:27Z", "type": "forcePushed"}]}