{"pr_number": 8015, "pr_title": "GIF images should not be scaled #8004", "pr_createdAt": "2020-04-09T13:40:47Z", "pr_url": "https://github.com/enonic/xp/pull/8015", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc5MjgxMw==", "url": "https://github.com/enonic/xp/pull/8015#discussion_r406792813", "bodyText": "I am not sure that A needs here, I think renderAsSource will be better", "author": "anatol-sialitski", "createdAt": "2020-04-10T14:52:15Z", "path": "modules/core/core-image/src/main/java/com/enonic/xp/core/impl/image/ImageServiceImpl.java", "diffHunk": "@@ -53,67 +51,47 @@\n     public ByteSource readImage( final ReadImageParams readImageParams )\n         throws IOException\n     {\n-        final Path cachedImagePath = getCachedImagePath( readImageParams );\n-        ByteSource imageByteSource = ImmutableFilesHelper.computeIfAbsent( cachedImagePath, () -> createImage( readImageParams ) );\n-        return imageByteSource;\n+        final String format = doGetFormatByMimeType( readImageParams.getMimeType() );\n+\n+        if ( renderAsASource( format ) )", "originalCommit": "d364caa89c75d47f4239e3e54ecbbcdbd62e7159", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjgzOTIyNA==", "url": "https://github.com/enonic/xp/pull/8015#discussion_r406839224", "bodyText": "It seems unnecessary to extract format from MIME type here as we only ignore processing very well defined image/gif MIME. So we can remove renderAsASource altogether and replace it with plain \"image/gif\".equals(readImageParams.getMimeType())", "author": "rymsha", "createdAt": "2020-04-10T16:39:47Z", "path": "modules/core/core-image/src/main/java/com/enonic/xp/core/impl/image/ImageServiceImpl.java", "diffHunk": "@@ -53,67 +51,47 @@\n     public ByteSource readImage( final ReadImageParams readImageParams )\n         throws IOException\n     {\n-        final Path cachedImagePath = getCachedImagePath( readImageParams );\n-        ByteSource imageByteSource = ImmutableFilesHelper.computeIfAbsent( cachedImagePath, () -> createImage( readImageParams ) );\n-        return imageByteSource;\n+        final String format = doGetFormatByMimeType( readImageParams.getMimeType() );", "originalCommit": "d364caa89c75d47f4239e3e54ecbbcdbd62e7159", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg0MjA1Mg==", "url": "https://github.com/enonic/xp/pull/8015#discussion_r406842052", "bodyText": "Move calculation of \"format\" here, so it is also guarded by cache.", "author": "rymsha", "createdAt": "2020-04-10T16:46:25Z", "path": "modules/core/core-image/src/main/java/com/enonic/xp/core/impl/image/ImageServiceImpl.java", "diffHunk": "@@ -157,9 +135,6 @@ else if ( readImageParams.isScaleWidth() )\n         //Filter string value\n         final String filter = readImageParams.getFilterParam() != null ? readImageParams.getFilterParam() : \"no-filter\";\n \n-        //Format string value\n-        final String format = readImageParams.getFormat();", "originalCommit": "d364caa89c75d47f4239e3e54ecbbcdbd62e7159", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg0MjM3Ng==", "url": "https://github.com/enonic/xp/pull/8015#discussion_r406842376", "bodyText": "dead code. remove", "author": "rymsha", "createdAt": "2020-04-10T16:47:11Z", "path": "modules/core/core-image/src/test/java/com/enonic/xp/core/impl/image/ImageServiceImplTest.java", "diffHunk": "@@ -62,7 +60,7 @@ public void setUp()\n         imageService.setImageFilterBuilder( imageFilterBuilder );\n     }\n \n-    @Test\n+    /*@Test", "originalCommit": "d364caa89c75d47f4239e3e54ecbbcdbd62e7159", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "668a11c9a17006f1ec605c37ecc9459bd0ee26e1", "url": "https://github.com/enonic/xp/commit/668a11c9a17006f1ec605c37ecc9459bd0ee26e1", "message": "GIF images should not be scaled #8004", "committedDate": "2020-04-14T13:17:57Z", "type": "forcePushed"}, {"oid": "18ed6e2c6b65b68ba5ee9be7424a3f08785c0f12", "url": "https://github.com/enonic/xp/commit/18ed6e2c6b65b68ba5ee9be7424a3f08785c0f12", "message": "GIF images should not be scaled #8004", "committedDate": "2020-04-14T14:13:57Z", "type": "commit"}, {"oid": "18ed6e2c6b65b68ba5ee9be7424a3f08785c0f12", "url": "https://github.com/enonic/xp/commit/18ed6e2c6b65b68ba5ee9be7424a3f08785c0f12", "message": "GIF images should not be scaled #8004", "committedDate": "2020-04-14T14:13:57Z", "type": "forcePushed"}]}