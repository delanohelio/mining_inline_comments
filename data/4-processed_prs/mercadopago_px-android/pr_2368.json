{"pr_number": 2368, "pr_title": "[Feature] Using account money view from card drawer", "pr_createdAt": "2020-10-23T16:11:59Z", "pr_url": "https://github.com/mercadopago/px-android/pull/2368", "timeline": [{"oid": "63c918e5a620104a7d3a7a081956e4fd9583977a", "url": "https://github.com/mercadopago/px-android/commit/63c918e5a620104a7d3a7a081956e4fd9583977a", "message": "Using account money view from card drawer", "committedDate": "2020-11-10T20:45:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTMxMzA3Nw==", "url": "https://github.com/mercadopago/px-android/pull/2368#discussion_r521313077", "bodyText": "\ud83d\udc4d", "author": "jorGonzalez291292", "createdAt": "2020-11-11T12:07:49Z", "path": "px-checkout/src/main/res/layout/px_fragment_account_money.xml", "diffHunk": "@@ -9,52 +9,26 @@\n         android:layout_width=\"match_parent\"\n         android:layout_height=\"wrap_content\"\n         android:layout_marginBottom=\"@dimen/px_s_margin\"\n-        android:layout_marginLeft=\"@dimen/px_m_margin\"\n-        android:layout_marginRight=\"@dimen/px_m_margin\"\n+        android:layout_marginStart=\"@dimen/px_m_margin\"\n+        android:layout_marginEnd=\"@dimen/px_m_margin\"\n+        android:clipChildren=\"false\"\n         app:cardCornerRadius=\"@dimen/px_xs_margin\"\n         app:cardElevation=\"2dp\"\n         app:cardPreventCornerOverlap=\"false\">\n \n         <androidx.constraintlayout.widget.ConstraintLayout\n-            android:id=\"@+id/payment_method_account_money\"\n             android:layout_width=\"match_parent\"\n             android:layout_height=\"wrap_content\">\n \n-            <ImageView\n-                android:id=\"@+id/background\"\n+            <com.meli.android.carddrawer.model.CardDrawerView", "originalCommit": "63c918e5a620104a7d3a7a081956e4fd9583977a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c42c5324f0eab53a930cf527b14d6086e2d624f9", "url": "https://github.com/mercadopago/px-android/commit/c42c5324f0eab53a930cf527b14d6086e2d624f9", "message": "Using account money view from card drawer", "committedDate": "2020-11-12T14:04:58Z", "type": "forcePushed"}, {"oid": "e7048bf26eeb9b6f9a1f1f013b596e6bdeb68b42", "url": "https://github.com/mercadopago/px-android/commit/e7048bf26eeb9b6f9a1f1f013b596e6bdeb68b42", "message": "Using account money view from card drawer", "committedDate": "2020-11-12T18:43:07Z", "type": "forcePushed"}, {"oid": "1ecc4e9d2f139fe84b0dca2e3a52a09f712cc7c2", "url": "https://github.com/mercadopago/px-android/commit/1ecc4e9d2f139fe84b0dca2e3a52a09f712cc7c2", "message": "Using account money view from card drawer", "committedDate": "2020-11-17T18:16:41Z", "type": "forcePushed"}, {"oid": "81f9544e3f97475df56633f803c02fab8fe0a217", "url": "https://github.com/mercadopago/px-android/commit/81f9544e3f97475df56633f803c02fab8fe0a217", "message": "Using account money view from card drawer", "committedDate": "2020-11-25T22:15:36Z", "type": "forcePushed"}, {"oid": "a5bab21c1ba53350c0dfcb0d00d30bbc1502980c", "url": "https://github.com/mercadopago/px-android/commit/a5bab21c1ba53350c0dfcb0d00d30bbc1502980c", "message": "Using account money view from card drawer", "committedDate": "2020-11-27T16:59:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTcwMzI1Mw==", "url": "https://github.com/mercadopago/px-android/pull/2368#discussion_r531703253", "bodyText": "Este archivo hay que restaurarlo", "author": "guchito9", "createdAt": "2020-11-27T17:08:33Z", "path": "example/src/main/java/com/mercadopago/android/px/utils/OneTapSamples.java", "diffHunk": "@@ -188,7 +188,8 @@ public static void addAll(final Collection<Pair<String, MercadoPagoCheckout.Buil\n     private static MercadoPagoCheckout.Builder startOneTapWithAccountMoneyAndCardsDebitCredit() {\n \n         final IPaymentDescriptor payment = getGenericPaymentApproved();\n-        final SplitPaymentProcessor samplePaymentProcessor = new SamplePaymentProcessor(payment);\n+        final SplitPaymentProcessor samplePaymentProcessor = new SamplePaymentProcessor(", "originalCommit": "a5bab21c1ba53350c0dfcb0d00d30bbc1502980c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTcwMzM2OA==", "url": "https://github.com/mercadopago/px-android/pull/2368#discussion_r531703368", "bodyText": "Esto voy a restaurarlo", "author": "guchito9", "createdAt": "2020-11-27T17:08:51Z", "path": "gradle.properties", "diffHunk": "@@ -30,7 +30,7 @@ okhttp=3.12.10\n gson=2.8.5\n retrofit=2.6.4\n # Other PX libs\n-cardDrawer=2.+\n+cardDrawer=LOCAL-2.10.0-2", "originalCommit": "a5bab21c1ba53350c0dfcb0d00d30bbc1502980c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTcwMzU2Ng==", "url": "https://github.com/mercadopago/px-android/pull/2368#discussion_r531703566", "bodyText": "Esto voy a restaurarlo", "author": "guchito9", "createdAt": "2020-11-27T17:09:23Z", "path": "px-checkout/build.gradle", "diffHunk": "@@ -53,7 +53,9 @@ dependencies {\n \n     implementation \"com.google.code.gson:gson:$gson\"\n     implementation \"com.mercadolibre.android:ui:$ui\"\n-    implementation \"com.mercadolibre.android:carddrawer:$cardDrawer\"\n+    implementation(\"com.mercadolibre.android:carddrawer:$cardDrawer\") {", "originalCommit": "a5bab21c1ba53350c0dfcb0d00d30bbc1502980c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTcwMzY3MQ==", "url": "https://github.com/mercadopago/px-android/pull/2368#discussion_r531703671", "bodyText": "Esto voy a restaurarlo", "author": "guchito9", "createdAt": "2020-11-27T17:09:37Z", "path": "px-services/src/main/java/com/mercadopago/android/px/internal/services/CheckoutService.java", "diffHunk": "@@ -20,7 +20,7 @@\n     String CHECKOUT_VERSION = \"v2\";\n     String ENVIRONMENT = BuildConfig.API_ENVIRONMENT_NEW;\n \n-    @POST(ENVIRONMENT + \"/px_mobile/\" + CHECKOUT_VERSION + \"/checkout\")\n+    @POST(\"https://run.mocky.io/v3/7188ceee-ed84-49e9-b303-a65d58ec3acb/\" + ENVIRONMENT + \"/px_mobile/\" + CHECKOUT_VERSION + \"/checkout\")", "originalCommit": "a5bab21c1ba53350c0dfcb0d00d30bbc1502980c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTcwNDgzNg==", "url": "https://github.com/mercadopago/px-android/pull/2368#discussion_r531704836", "bodyText": "ac\u00e1 podemos usar el instance.also.{ }", "author": "jorGonzalez291292", "createdAt": "2020-11-27T17:13:09Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/express/slider/AccountMoneyFragment.kt", "diffHunk": "@@ -0,0 +1,44 @@\n+package com.mercadopago.android.px.internal.features.express.slider\n+\n+import android.os.Bundle\n+import android.view.LayoutInflater\n+import android.view.View\n+import android.view.ViewGroup\n+import androidx.fragment.app.Fragment\n+import com.meli.android.carddrawer.model.CardDrawerView\n+import com.mercadopago.android.px.R\n+import com.mercadopago.android.px.internal.viewmodel.drawables.AccountMoneyDrawableFragmentItem\n+\n+internal open class AccountMoneyFragment : PaymentMethodFragment<AccountMoneyDrawableFragmentItem>() {\n+\n+    private lateinit var cardView: CardDrawerView\n+\n+    override fun onCreateView(inflater: LayoutInflater, container: ViewGroup?,\n+        savedInstanceState: Bundle?): View? {\n+        val view = inflater.inflate(getLayout(), container, false)\n+        cardView = view.findViewById(R.id.card)\n+        cardView.show(model.card)\n+        return view\n+    }\n+\n+    protected open fun getLayout() = R.layout.px_fragment_account_money\n+\n+    override fun disable() {\n+        super.disable()\n+        model.card.disable()\n+        storeModel(model)\n+        cardView.show(model.card)\n+    }\n+\n+    override fun getAccessibilityContentDescription(): String {\n+        return model.description\n+    }\n+\n+    companion object {\n+        @JvmStatic fun getInstance(model: AccountMoneyDrawableFragmentItem): Fragment {\n+            val instance = AccountMoneyFragment()\n+            instance.storeModel(model)", "originalCommit": "a5bab21c1ba53350c0dfcb0d00d30bbc1502980c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTcwNTAwOA==", "url": "https://github.com/mercadopago/px-android/pull/2368#discussion_r531705008", "bodyText": "idem anterior", "author": "jorGonzalez291292", "createdAt": "2020-11-27T17:13:45Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/express/slider/AccountMoneyLowResFragment.kt", "diffHunk": "@@ -0,0 +1,18 @@\n+package com.mercadopago.android.px.internal.features.express.slider\n+\n+import androidx.fragment.app.Fragment\n+import com.mercadopago.android.px.R\n+import com.mercadopago.android.px.internal.viewmodel.drawables.AccountMoneyDrawableFragmentItem\n+\n+internal class AccountMoneyLowResFragment : AccountMoneyFragment() {\n+\n+    override fun getLayout() = R.layout.px_fragment_account_money_low_res\n+\n+    companion object {\n+        @JvmStatic fun getInstance(model: AccountMoneyDrawableFragmentItem): Fragment {\n+            val instance = AccountMoneyLowResFragment()\n+            instance.storeModel(model)", "originalCommit": "a5bab21c1ba53350c0dfcb0d00d30bbc1502980c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTcwODE3OA==", "url": "https://github.com/mercadopago/px-android/pull/2368#discussion_r531708178", "bodyText": "No lo podemos mover arriba en la clase?", "author": "jorGonzalez291292", "createdAt": "2020-11-27T17:23:47Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/viewmodel/drawables/AccountMoneyDrawableFragmentItem.kt", "diffHunk": "@@ -0,0 +1,33 @@\n+package com.mercadopago.android.px.internal.viewmodel.drawables\n+\n+import android.os.Parcel\n+import androidx.fragment.app.Fragment\n+import com.mercadopago.android.px.internal.util.KParcelable\n+import com.mercadopago.android.px.internal.util.parcelableCreator\n+import com.mercadopago.android.px.internal.viewmodel.CardUiConfiguration\n+\n+internal class AccountMoneyDrawableFragmentItem : DrawableFragmentItem, KParcelable {\n+\n+    val card: CardUiConfiguration\n+\n+    constructor(parameters: Parameters, card: CardUiConfiguration) : super(parameters) {", "originalCommit": "a5bab21c1ba53350c0dfcb0d00d30bbc1502980c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "424930440e159223bf448590b3a1b3a300bfb69d", "url": "https://github.com/mercadopago/px-android/commit/424930440e159223bf448590b3a1b3a300bfb69d", "message": "Using account money view from card drawer", "committedDate": "2020-12-18T15:01:26Z", "type": "forcePushed"}, {"oid": "a428719f6c6218df0583d04f3a4afac9cb32f057", "url": "https://github.com/mercadopago/px-android/commit/a428719f6c6218df0583d04f3a4afac9cb32f057", "message": "Using account money view from card drawer", "committedDate": "2020-12-18T15:25:29Z", "type": "forcePushed"}, {"oid": "cedd79eb4766bbb14b06e3432fa308dbe45facaf", "url": "https://github.com/mercadopago/px-android/commit/cedd79eb4766bbb14b06e3432fa308dbe45facaf", "message": "Using account money view from card drawer", "committedDate": "2020-12-18T16:11:21Z", "type": "forcePushed"}, {"oid": "e0db3ffd6924c8b18703fd30f8b54e85966f6a5a", "url": "https://github.com/mercadopago/px-android/commit/e0db3ffd6924c8b18703fd30f8b54e85966f6a5a", "message": "Using account money view from card drawer", "committedDate": "2020-12-29T18:06:13Z", "type": "forcePushed"}, {"oid": "77e311da3a4e74e6f1cef1402e4e80d0dd6df3a9", "url": "https://github.com/mercadopago/px-android/commit/77e311da3a4e74e6f1cef1402e4e80d0dd6df3a9", "message": "Added tap card behaviour for modals", "committedDate": "2021-01-04T20:58:24Z", "type": "forcePushed"}, {"oid": "44358576bae1293a8a6d966bccead8695021c345", "url": "https://github.com/mercadopago/px-android/commit/44358576bae1293a8a6d966bccead8695021c345", "message": "Added tap card behaviour for modals", "committedDate": "2021-01-05T14:51:01Z", "type": "forcePushed"}, {"oid": "2801edc816026f217446414d1818bc92747fb6a8", "url": "https://github.com/mercadopago/px-android/commit/2801edc816026f217446414d1818bc92747fb6a8", "message": "Added tap card behaviour for modals", "committedDate": "2021-01-05T15:11:31Z", "type": "forcePushed"}, {"oid": "6e5ca045ed1485e34158967f54d5b50bd619d28b", "url": "https://github.com/mercadopago/px-android/commit/6e5ca045ed1485e34158967f54d5b50bd619d28b", "message": "Added tap card behaviour for modals", "committedDate": "2021-01-05T19:25:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTg4Nzk1Ng==", "url": "https://github.com/mercadopago/px-android/pull/2368#discussion_r555887956", "bodyText": "Esto lo podemos cambiar por un check(){}?", "author": "jorGonzalez291292", "createdAt": "2021-01-12T16:04:25Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/generic_modal/Actionable.kt", "diffHunk": "@@ -1,34 +1,17 @@\n package com.mercadopago.android.px.internal.features.generic_modal\n \n-import android.os.Parcel\n-import com.mercadopago.android.px.internal.util.KParcelable\n-import com.mercadopago.android.px.internal.util.parcelableCreator\n-import java.lang.IllegalStateException\n+import android.os.Parcelable\n+import kotlinx.android.parcel.Parcelize\n \n+@Parcelize\n data class Actionable(\n     val label: String,\n     val deepLink: String?,\n-    @ActionType val action: String?) : KParcelable {\n+    @ActionType val action: String?) : Parcelable {\n \n     init {\n         if (deepLink.isNullOrEmpty() && action.isNullOrEmpty()) {", "originalCommit": "6e5ca045ed1485e34158967f54d5b50bd619d28b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTg5NjgzMg==", "url": "https://github.com/mercadopago/px-android/pull/2368#discussion_r555896832", "bodyText": "Hace falta hacer esto? CardUiMapper no es un object? En todo caso lo podemos inyectar.", "author": "jorGonzalez291292", "createdAt": "2021-01-12T16:16:44Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/viewmodel/drawables/PaymentMethodDrawableItemMapper.kt", "diffHunk": "@@ -1,53 +1,76 @@\n package com.mercadopago.android.px.internal.viewmodel.drawables\n \n-import android.content.Context\n+import com.meli.android.carddrawer.configuration.CardDrawerStyle\n+import com.mercadopago.android.px.internal.extensions.runIfNull\n+import com.mercadopago.android.px.internal.features.generic_modal.ActionType\n+import com.mercadopago.android.px.internal.features.generic_modal.FromModalToGenericDialogItem\n+import com.mercadopago.android.px.internal.features.generic_modal.GenericDialogItem\n import com.mercadopago.android.px.internal.repository.ChargeRepository\n import com.mercadopago.android.px.internal.repository.DisabledPaymentMethodRepository\n+import com.mercadopago.android.px.internal.repository.InitRepository\n import com.mercadopago.android.px.internal.util.TextUtil\n-import com.mercadopago.android.px.internal.viewmodel.DisableConfiguration\n import com.mercadopago.android.px.internal.viewmodel.mappers.CardUiMapper\n import com.mercadopago.android.px.internal.viewmodel.mappers.NonNullMapper\n import com.mercadopago.android.px.model.CustomSearchItem\n import com.mercadopago.android.px.model.ExpressMetadata\n-import java.util.*\n+import com.mercadopago.android.px.model.internal.InitResponse\n+import com.mercadopago.android.px.model.one_tap.CheckoutBehaviour\n+import kotlinx.coroutines.runBlocking\n \n internal class PaymentMethodDrawableItemMapper(\n     private val chargeRepository: ChargeRepository,\n-    private val disabledPaymentMethodRepository: DisabledPaymentMethodRepository? = null,\n-    context: Context? = null) : NonNullMapper<ExpressMetadata, DrawableFragmentItem?>() {\n+    private val initRepository: InitRepository,\n+    private val disabledPaymentMethodRepository: DisabledPaymentMethodRepository\n+) : NonNullMapper<ExpressMetadata, DrawableFragmentItem?>() {\n \n-    private val disableConfiguration = context?.let { DisableConfiguration(it) }\n-    private var customSearchItems: List<CustomSearchItem> = Collections.emptyList()\n+    private var initResponse: InitResponse? = null\n \n     override fun map(expressMetadata: ExpressMetadata): DrawableFragmentItem? {\n-        val parameters = getParameters(expressMetadata)\n-\n-        return when {\n-            expressMetadata.isCard -> SavedCardDrawableFragmentItem(parameters, expressMetadata.paymentMethodId,\n-                CardUiMapper(disableConfiguration).map(expressMetadata.card.displayInfo))\n-            expressMetadata.isAccountMoney -> AccountMoneyDrawableFragmentItem(parameters)\n-            expressMetadata.isConsumerCredits ->\n-                ConsumerCreditsDrawableFragmentItem(parameters, expressMetadata.consumerCredits)\n-            expressMetadata.isNewCard || expressMetadata.isOfflineMethods ->\n-                OtherPaymentMethodFragmentItem(parameters, expressMetadata.newCard, expressMetadata.offlineMethods)\n-            else -> null\n+        initResponse.runIfNull {\n+            //Ac\u00e1 asumimos que est\u00e1 cacheada la respuesta de init como en absolutamente todos lados salvo checkoutActivity\n+            runBlocking {\n+                initResponse = initRepository.loadInitResponse()\n+            }\n+        }\n+        return initResponse?.let { initResponse ->\n+            val genericDialogItem = expressMetadata.getBehaviour(CheckoutBehaviour.Type.TAP_CARD)?.modal?.let { modal ->\n+                initResponse.modals[modal]?.let {\n+                    FromModalToGenericDialogItem(ActionType.DISMISS, modal).map(it)\n+                }\n+            }\n+            val parameters = getParameters(expressMetadata, initResponse.customSearchItems, genericDialogItem)\n+            val cardUiMapper = CardUiMapper", "originalCommit": "6e5ca045ed1485e34158967f54d5b50bd619d28b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTg5ODE3Mw==", "url": "https://github.com/mercadopago/px-android/pull/2368#discussion_r555898173", "bodyText": "Esto lo vamos a sacar antes de mergearlo?", "author": "jorGonzalez291292", "createdAt": "2021-01-12T16:18:39Z", "path": "px-services/src/main/java/com/mercadopago/android/px/internal/services/CheckoutService.java", "diffHunk": "@@ -20,7 +20,7 @@\n     String CHECKOUT_VERSION = \"v2\";\n     String ENVIRONMENT = BuildConfig.API_ENVIRONMENT_NEW;\n \n-    @POST(ENVIRONMENT + \"/px_mobile/\" + CHECKOUT_VERSION + \"/checkout\")\n+    @POST(\"https://run.mocky.io/v3/f2f3e82a-d2d2-43b1-a767-24f8b9cbe935/\" + ENVIRONMENT + \"/px_mobile/\" + CHECKOUT_VERSION + \"/checkout\")", "originalCommit": "6e5ca045ed1485e34158967f54d5b50bd619d28b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTkwMDA5NQ==", "url": "https://github.com/mercadopago/px-android/pull/2368#discussion_r555900095", "bodyText": "Si :P", "author": "guchito9", "createdAt": "2021-01-12T16:21:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTg5ODE3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTkwMTc3OA==", "url": "https://github.com/mercadopago/px-android/pull/2368#discussion_r555901778", "bodyText": "creo que un takeif va a quedar mas cheto ac\u00e1", "author": "cgaggino", "createdAt": "2021-01-12T16:23:33Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/viewmodel/drawables/PaymentMethodDrawableItemMapper.kt", "diffHunk": "@@ -1,53 +1,76 @@\n package com.mercadopago.android.px.internal.viewmodel.drawables\n \n-import android.content.Context\n+import com.meli.android.carddrawer.configuration.CardDrawerStyle\n+import com.mercadopago.android.px.internal.extensions.runIfNull\n+import com.mercadopago.android.px.internal.features.generic_modal.ActionType\n+import com.mercadopago.android.px.internal.features.generic_modal.FromModalToGenericDialogItem\n+import com.mercadopago.android.px.internal.features.generic_modal.GenericDialogItem\n import com.mercadopago.android.px.internal.repository.ChargeRepository\n import com.mercadopago.android.px.internal.repository.DisabledPaymentMethodRepository\n+import com.mercadopago.android.px.internal.repository.InitRepository\n import com.mercadopago.android.px.internal.util.TextUtil\n-import com.mercadopago.android.px.internal.viewmodel.DisableConfiguration\n import com.mercadopago.android.px.internal.viewmodel.mappers.CardUiMapper\n import com.mercadopago.android.px.internal.viewmodel.mappers.NonNullMapper\n import com.mercadopago.android.px.model.CustomSearchItem\n import com.mercadopago.android.px.model.ExpressMetadata\n-import java.util.*\n+import com.mercadopago.android.px.model.internal.InitResponse\n+import com.mercadopago.android.px.model.one_tap.CheckoutBehaviour\n+import kotlinx.coroutines.runBlocking\n \n internal class PaymentMethodDrawableItemMapper(\n     private val chargeRepository: ChargeRepository,\n-    private val disabledPaymentMethodRepository: DisabledPaymentMethodRepository? = null,\n-    context: Context? = null) : NonNullMapper<ExpressMetadata, DrawableFragmentItem?>() {\n+    private val initRepository: InitRepository,\n+    private val disabledPaymentMethodRepository: DisabledPaymentMethodRepository\n+) : NonNullMapper<ExpressMetadata, DrawableFragmentItem?>() {\n \n-    private val disableConfiguration = context?.let { DisableConfiguration(it) }\n-    private var customSearchItems: List<CustomSearchItem> = Collections.emptyList()\n+    private var initResponse: InitResponse? = null\n \n     override fun map(expressMetadata: ExpressMetadata): DrawableFragmentItem? {\n-        val parameters = getParameters(expressMetadata)\n-\n-        return when {\n-            expressMetadata.isCard -> SavedCardDrawableFragmentItem(parameters, expressMetadata.paymentMethodId,\n-                CardUiMapper(disableConfiguration).map(expressMetadata.card.displayInfo))\n-            expressMetadata.isAccountMoney -> AccountMoneyDrawableFragmentItem(parameters)\n-            expressMetadata.isConsumerCredits ->\n-                ConsumerCreditsDrawableFragmentItem(parameters, expressMetadata.consumerCredits)\n-            expressMetadata.isNewCard || expressMetadata.isOfflineMethods ->\n-                OtherPaymentMethodFragmentItem(parameters, expressMetadata.newCard, expressMetadata.offlineMethods)\n-            else -> null\n+        initResponse.runIfNull {\n+            //Ac\u00e1 asumimos que est\u00e1 cacheada la respuesta de init como en absolutamente todos lados salvo checkoutActivity\n+            runBlocking {\n+                initResponse = initRepository.loadInitResponse()\n+            }\n+        }\n+        return initResponse?.let { initResponse ->\n+            val genericDialogItem = expressMetadata.getBehaviour(CheckoutBehaviour.Type.TAP_CARD)?.modal?.let { modal ->\n+                initResponse.modals[modal]?.let {\n+                    FromModalToGenericDialogItem(ActionType.DISMISS, modal).map(it)\n+                }\n+            }\n+            val parameters = getParameters(expressMetadata, initResponse.customSearchItems, genericDialogItem)\n+            val cardUiMapper = CardUiMapper\n+            return when {\n+                expressMetadata.isCard -> SavedCardDrawableFragmentItem(parameters, expressMetadata.paymentMethodId,\n+                    cardUiMapper.map(expressMetadata.card.displayInfo))\n+                expressMetadata.isAccountMoney -> expressMetadata.accountMoney.displayInfo.type?.let {", "originalCommit": "6e5ca045ed1485e34158967f54d5b50bd619d28b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4b5d0479f13eb9f3fb1b7b2a4460f0221d9098d5", "url": "https://github.com/mercadopago/px-android/commit/4b5d0479f13eb9f3fb1b7b2a4460f0221d9098d5", "message": "Hybrid card look and feel for AM\n\n* Using account money view from card drawer\n\n* Added tap card behaviour for modals", "committedDate": "2021-01-12T17:45:02Z", "type": "forcePushed"}, {"oid": "344777a8c3d9cc724cbf4233bec26a00dff14042", "url": "https://github.com/mercadopago/px-android/commit/344777a8c3d9cc724cbf4233bec26a00dff14042", "message": "Hybrid card look and feel for AM\n\n* Using account money view from card drawer\n\n* Added tap card behaviour for modals", "committedDate": "2021-01-12T18:09:05Z", "type": "forcePushed"}, {"oid": "87d010b7ca4e8cad1c875fa915c05875c142ca25", "url": "https://github.com/mercadopago/px-android/commit/87d010b7ca4e8cad1c875fa915c05875c142ca25", "message": "Hybrid card look and feel for AM\n\n* Using account money view from card drawer\n\n* Added tap card behaviour for modals", "committedDate": "2021-01-12T19:06:24Z", "type": "commit"}, {"oid": "87d010b7ca4e8cad1c875fa915c05875c142ca25", "url": "https://github.com/mercadopago/px-android/commit/87d010b7ca4e8cad1c875fa915c05875c142ca25", "message": "Hybrid card look and feel for AM\n\n* Using account money view from card drawer\n\n* Added tap card behaviour for modals", "committedDate": "2021-01-12T19:06:24Z", "type": "forcePushed"}]}