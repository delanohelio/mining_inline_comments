{"pr_number": 2402, "pr_title": "[Feature] card form web pay integration", "pr_createdAt": "2020-12-16T15:00:45Z", "pr_url": "https://github.com/mercadopago/px-android/pull/2402", "timeline": [{"oid": "0ca53bca0e9bc48c9efe8b4b2aeff937c2f9224a", "url": "https://github.com/mercadopago/px-android/commit/0ca53bca0e9bc48c9efe8b4b2aeff937c2f9224a", "message": "add sheet option model", "committedDate": "2020-10-28T13:26:28Z", "type": "commit"}, {"oid": "74c0c382be1a882b76e2507979d0d35d832655a7", "url": "https://github.com/mercadopago/px-android/commit/74c0c382be1a882b76e2507979d0d35d832655a7", "message": "card form bottom sheet", "committedDate": "2020-11-15T14:12:00Z", "type": "commit"}, {"oid": "545388463f6e7b40b5d9d0481a528754f916888e", "url": "https://github.com/mercadopago/px-android/commit/545388463f6e7b40b5d9d0481a528754f916888e", "message": "recycler view and adepter added", "committedDate": "2020-11-16T11:59:34Z", "type": "commit"}, {"oid": "dba72f5714e7805d1fde56d0ef4b53ac63b7b857", "url": "https://github.com/mercadopago/px-android/commit/dba72f5714e7805d1fde56d0ef4b53ac63b7b857", "message": "cardformoption click listener added", "committedDate": "2020-11-17T16:56:02Z", "type": "commit"}, {"oid": "9fec05f19d88d6d362ccc8abfb4b75f686db4a8e", "url": "https://github.com/mercadopago/px-android/commit/9fec05f19d88d6d362ccc8abfb4b75f686db4a8e", "message": "add init type to new card meta data", "committedDate": "2020-11-19T14:14:56Z", "type": "commit"}, {"oid": "b8f0fb56e1653d71fb83856c269b9696bcd10da6", "url": "https://github.com/mercadopago/px-android/commit/b8f0fb56e1653d71fb83856c269b9696bcd10da6", "message": "refactor recycler view adapter", "committedDate": "2020-11-19T19:43:23Z", "type": "commit"}, {"oid": "1fa30ae12ac7e5e5209211c8569875ab87fd1b44", "url": "https://github.com/mercadopago/px-android/commit/1fa30ae12ac7e5e5209211c8569875ab87fd1b44", "message": "revert changes", "committedDate": "2020-11-19T22:09:38Z", "type": "commit"}, {"oid": "7768e2e51d5d97f578631fb53b482ffbb59386ba", "url": "https://github.com/mercadopago/px-android/commit/7768e2e51d5d97f578631fb53b482ffbb59386ba", "message": "merge with master", "committedDate": "2020-11-19T22:24:07Z", "type": "commit"}, {"oid": "a0542678a163e15b66de67d9e66e3a88040c003f", "url": "https://github.com/mercadopago/px-android/commit/a0542678a163e15b66de67d9e66e3a88040c003f", "message": "refactor open card form", "committedDate": "2020-11-19T22:45:29Z", "type": "commit"}, {"oid": "23db14f0e593e3863163f103a6978fb770dde76f", "url": "https://github.com/mercadopago/px-android/commit/23db14f0e593e3863163f103a6978fb770dde76f", "message": "add code", "committedDate": "2020-11-19T22:51:53Z", "type": "commit"}, {"oid": "763cbeed2a912da8c65cf31fdaa3b39c70af3c02", "url": "https://github.com/mercadopago/px-android/commit/763cbeed2a912da8c65cf31fdaa3b39c70af3c02", "message": "rename file", "committedDate": "2020-11-20T19:37:46Z", "type": "commit"}, {"oid": "136dc6c637360c17631881c6cd0b0f8e68ede4ef", "url": "https://github.com/mercadopago/px-android/commit/136dc6c637360c17631881c6cd0b0f8e68ede4ef", "message": "update text sizes", "committedDate": "2020-11-24T19:15:10Z", "type": "commit"}, {"oid": "e0a9c19c74abb272bffa4d4a92ddc3c6d1533c14", "url": "https://github.com/mercadopago/px-android/commit/e0a9c19c74abb272bffa4d4a92ddc3c6d1533c14", "message": "rename package", "committedDate": "2020-11-24T20:06:58Z", "type": "commit"}, {"oid": "c4d36e27a59bf17960801b8a5544fa93ab4c4361", "url": "https://github.com/mercadopago/px-android/commit/c4d36e27a59bf17960801b8a5544fa93ab4c4361", "message": "rename package again", "committedDate": "2020-11-24T20:08:42Z", "type": "commit"}, {"oid": "ccf728d5c9337a13ef1c1438e3b4b0708f417788", "url": "https://github.com/mercadopago/px-android/commit/ccf728d5c9337a13ef1c1438e3b4b0708f417788", "message": "review changes", "committedDate": "2020-11-25T12:56:43Z", "type": "commit"}, {"oid": "9defeccbb2f06f76497dbd5bcf54f48c18986caa", "url": "https://github.com/mercadopago/px-android/commit/9defeccbb2f06f76497dbd5bcf54f48c18986caa", "message": "update layout sheet option", "committedDate": "2020-11-25T21:29:20Z", "type": "commit"}, {"oid": "2e207fa589582e2c2a357f68c9011083ec8cc6ce", "url": "https://github.com/mercadopago/px-android/commit/2e207fa589582e2c2a357f68c9011083ec8cc6ce", "message": "refactor header bottom sheet", "committedDate": "2020-11-27T19:45:31Z", "type": "commit"}, {"oid": "605e1dd29bc1b9b71a822108779e7f4b29d092ca", "url": "https://github.com/mercadopago/px-android/commit/605e1dd29bc1b9b71a822108779e7f4b29d092ca", "message": "change name method", "committedDate": "2020-11-27T19:56:46Z", "type": "commit"}, {"oid": "8661c2d005d1468a33fc0c709f24cabb17fcd79b", "url": "https://github.com/mercadopago/px-android/commit/8661c2d005d1468a33fc0c709f24cabb17fcd79b", "message": "change margins sheet options row", "committedDate": "2020-12-01T11:35:11Z", "type": "commit"}, {"oid": "b0455b93c64eef32e69d5a73938c34cd94faa2f1", "url": "https://github.com/mercadopago/px-android/commit/b0455b93c64eef32e69d5a73938c34cd94faa2f1", "message": "merge", "committedDate": "2020-12-01T11:38:10Z", "type": "commit"}, {"oid": "d252e1875b0c500ba775d9afc28b5a3653af994a", "url": "https://github.com/mercadopago/px-android/commit/d252e1875b0c500ba775d9afc28b5a3653af994a", "message": "card form web pay integration", "committedDate": "2020-12-01T22:09:42Z", "type": "commit"}, {"oid": "f50d311d3db15efe6c2fe9384e707322556e4dd4", "url": "https://github.com/mercadopago/px-android/commit/f50d311d3db15efe6c2fe9384e707322556e4dd4", "message": "process card form result", "committedDate": "2020-12-03T16:07:44Z", "type": "commit"}, {"oid": "ead95e6ff34811157b733b038181b5c2dca24e8b", "url": "https://github.com/mercadopago/px-android/commit/ead95e6ff34811157b733b038181b5c2dca24e8b", "message": "Update init cardform for webpay", "committedDate": "2020-12-11T14:07:54Z", "type": "commit"}, {"oid": "d0cd0091b3c4a1874f2692a5538b98fbdfea5c63", "url": "https://github.com/mercadopago/px-android/commit/d0cd0091b3c4a1874f2692a5538b98fbdfea5c63", "message": "merge with feature branch", "committedDate": "2020-12-11T15:18:46Z", "type": "commit"}, {"oid": "2bce91a33f85ad6c202216b81e39739727066391", "url": "https://github.com/mercadopago/px-android/commit/2bce91a33f85ad6c202216b81e39739727066391", "message": "card form webpay added", "committedDate": "2020-12-16T14:36:56Z", "type": "commit"}, {"oid": "62b7286eafb1deb63a3a78609c80b6139f4f5cb2", "url": "https://github.com/mercadopago/px-android/commit/62b7286eafb1deb63a3a78609c80b6139f4f5cb2", "message": "delete imports", "committedDate": "2020-12-16T14:41:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM2ODkyNA==", "url": "https://github.com/mercadopago/px-android/pull/2402#discussion_r544368924", "bodyText": "Cuando este el posta lo cambio.", "author": "jorGonzalez291292", "createdAt": "2020-12-16T15:01:17Z", "path": "gradle.properties", "diffHunk": "@@ -32,7 +32,7 @@ retrofit=2.6.4\n # Other PX libs\n cardDrawer=2.+\n businessComponents=1.+\n-cardForm=1.+\n+cardForm=EXPERIMENTAL-1.5.2-16122020015253852", "originalCommit": "62b7286eafb1deb63a3a78609c80b6139f4f5cb2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ3NDQ1Mw==", "url": "https://github.com/mercadopago/px-android/pull/2402#discussion_r544474453", "bodyText": "\ud83d\udc40", "author": "cgaggino", "createdAt": "2020-12-16T17:12:37Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/express/add_new_card/sheet_options/CardFormBottomSheetFragment.kt", "diffHunk": "@@ -67,18 +69,19 @@ internal class CardFormBottomSheetFragment : Fragment() {\n \n             cardFormOptionClick?.onOptionClick()\n \n-            when (cardFormInitType) {\n-                CardFormInitType.STANDARD -> {\n-                    cardFormWrapper.getCardFormWithFragment().start(\n-                        fragmentManager,\n-                        ExpressPaymentFragment.REQ_CODE_CARD_FORM,\n-                        R.id.one_tap_fragment\n-                    )\n-                }\n+            postDelayed(200) {", "originalCommit": "62b7286eafb1deb63a3a78609c80b6139f4f5cb2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ3OTg4Mg==", "url": "https://github.com/mercadopago/px-android/pull/2402#discussion_r544479882", "bodyText": "Me gustar\u00eda que lo handlee directamente one tap, no se puede hacer el start con el fragment?", "author": "cgaggino", "createdAt": "2020-12-16T17:19:42Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/checkout/CheckoutActivity.java", "diffHunk": "@@ -322,6 +327,28 @@ private void resolveCancelReviewAndConfirm(final Intent data) {\n         }\n     }\n \n+    private void resolveCardFormWebViewActivity(final int requestCode, final int resultCode, final Intent data) {\n+        if (resultCode == RESULT_OK) {\n+            final String cardId = data.getStringExtra(CardForm.RESULT_CARD_ID_KEY);\n+            showProgress();\n+            presenter.onCardAdded(cardId, new LifecycleListener.Callback() {\n+                @Override\n+                public void onSuccess() {\n+                    final Fragment fragment;\n+                    if ((fragment = getSupportFragmentManager().findFragmentByTag(TAG_ONETAP_FRAGMENT)) != null) {", "originalCommit": "62b7286eafb1deb63a3a78609c80b6139f4f5cb2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU0MzgwMQ==", "url": "https://github.com/mercadopago/px-android/pull/2402#discussion_r544543801", "bodyText": "No, no se puede.\n    override fun start(activity: AppCompatActivity, requestCode: Int) {\n        CardFormWebActivity.start(activity,requestCode, this)\n    }\n\ny adem\u00e1s si nosotros queremos solo usar el context no vamos a poder iniciar el activity de cardformwebview de forma que devuelva un resultado.\ncompanion object {\n        fun start(activity: AppCompatActivity, requestCode: Int, cardFormWeb: CardFormWeb) {\n            val intent = Intent(activity, CardFormWebActivity::class.java)\n            val bundle = Bundle().also { it.putParcelable(CARD_FORM_EXTRA, cardFormWeb) }\n            intent.putExtras(bundle)\n            activity.startActivityForResult(intent, requestCode)\n        }\n    }", "author": "jorGonzalez291292", "createdAt": "2020-12-16T18:55:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ3OTg4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ4MTIyNA==", "url": "https://github.com/mercadopago/px-android/pull/2402#discussion_r544481224", "bodyText": "Estar\u00eda bueno que el c\u00f3digo est\u00e9 en quien lo inicia, constants queremos matarlo, es el mismo concept\u00f3 que las EXTRA_KEY, el que inicia deber\u00eda definir el c\u00f3digo para que no haya chances de colisi\u00f3n", "author": "cgaggino", "createdAt": "2020-12-16T17:21:37Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/Constants.kt", "diffHunk": "@@ -11,4 +11,5 @@ object Constants {\n     const val RESULT_SILENT_ERROR = 8\n     const val EXTRA_BACK_URL = \"back_url\"\n     const val EXTRA_REDIRECT_URL = \"redirect_url\"\n+    const val REQ_CODE_CARD_FORM = 106", "originalCommit": "62b7286eafb1deb63a3a78609c80b6139f4f5cb2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ4Mjk0Ng==", "url": "https://github.com/mercadopago/px-android/pull/2402#discussion_r544482946", "bodyText": "por que necesita un post delay?", "author": "cgaggino", "createdAt": "2020-12-16T17:24:01Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/express/ExpressPaymentFragment.java", "diffHunk": "@@ -609,7 +611,7 @@ public void onLoadCardFormSheetOptions(final CardFormBottomSheetModel cardFormBo\n \n     @Override\n     public void onNewCardWithSheetOptions() {\n-        cardFormBottomSheet.expand();\n+        new Handler(Looper.getMainLooper()).postDelayed(() -> cardFormBottomSheet.expand(), 200);", "originalCommit": "62b7286eafb1deb63a3a78609c80b6139f4f5cb2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDUzMDIyOA==", "url": "https://github.com/mercadopago/px-android/pull/2402#discussion_r544530228", "bodyText": "Porque o sino se levanta muy de golpe, queda muy feo.", "author": "jorGonzalez291292", "createdAt": "2020-12-16T18:34:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ4Mjk0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ4NjExNA==", "url": "https://github.com/mercadopago/px-android/pull/2402#discussion_r544486114", "bodyText": "se que esto corresponde a card form pero viendolo ac\u00e1 me gustar\u00eda que se llame como en el otro builder, \"withAccessToken\", tecnicamente es un factory method del builder, por lo que no estas buildeando, estas creando el builder, si no estuviera el static import ser\u00eda Builder.withAccessToken", "author": "cgaggino", "createdAt": "2020-12-16T17:28:16Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/util/CardFormWrapper.kt", "diffHunk": "@@ -18,8 +19,7 @@ internal class CardFormWrapper(\n         .setSessionId(trackingRepository.sessionId)\n         .setExcludedTypes(excludedPaymentTypes).build()\n \n-    //TODO: Change by builder web pay\n-    fun getCardFormWithWebView() = withAccessToken(privateKey, siteId, trackingRepository.flowId)\n+    fun getCardFormWithWebView() = buildWithAccessToken(privateKey, siteId, trackingRepository.flowId)", "originalCommit": "62b7286eafb1deb63a3a78609c80b6139f4f5cb2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDUzMDMyNQ==", "url": "https://github.com/mercadopago/px-android/pull/2402#discussion_r544530325", "bodyText": "Dale", "author": "jorGonzalez291292", "createdAt": "2020-12-16T18:34:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ4NjExNA=="}], "type": "inlineReview"}, {"oid": "213aa6eb56907817f6c7e187c1e14ad939992271", "url": "https://github.com/mercadopago/px-android/commit/213aa6eb56907817f6c7e187c1e14ad939992271", "message": "logic step was to launch cardform to onetap fragment", "committedDate": "2020-12-17T00:06:41Z", "type": "commit"}, {"oid": "b3cc6a0cac385b5083a69e445fa73281dd3d9514", "url": "https://github.com/mercadopago/px-android/commit/b3cc6a0cac385b5083a69e445fa73281dd3d9514", "message": "card form option validation fixed", "committedDate": "2020-12-17T14:02:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTEzNTAwMg==", "url": "https://github.com/mercadopago/px-android/pull/2402#discussion_r545135002", "bodyText": "Pareciera que no se usa este import", "author": "guchito9", "createdAt": "2020-12-17T14:32:55Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/util/CardFormWrapper.kt", "diffHunk": "@@ -1,9 +1,10 @@\n package com.mercadopago.android.px.internal.util\n \n-import com.mercadolibre.android.cardform.internal.CardFormWithFragment.Builder.Companion.withAccessToken\n+import com.mercadolibre.android.cardform.internal.CardFormWeb\n+import com.mercadolibre.android.cardform.internal.CardFormWithFragment\n import com.mercadopago.android.px.internal.repository.PaymentSettingRepository\n import com.mercadopago.android.px.internal.tracking.TrackingRepository\n-import java.util.*\n+import java.util.Collections", "originalCommit": "b3cc6a0cac385b5083a69e445fa73281dd3d9514", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}