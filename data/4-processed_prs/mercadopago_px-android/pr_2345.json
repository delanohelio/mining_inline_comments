{"pr_number": 2345, "pr_title": "[Feature] Added security code fragment transition", "pr_createdAt": "2020-09-30T17:43:58Z", "pr_url": "https://github.com/mercadopago/px-android/pull/2345", "timeline": [{"oid": "df6575bc0a3d1a8516f37b33a33afad611250e16", "url": "https://github.com/mercadopago/px-android/commit/df6575bc0a3d1a8516f37b33a33afad611250e16", "message": "Added security code fragment transition", "committedDate": "2020-10-01T21:09:21Z", "type": "forcePushed"}, {"oid": "6f82deedbb2d691a703edf763c475f818a30b5c8", "url": "https://github.com/mercadopago/px-android/commit/6f82deedbb2d691a703edf763c475f818a30b5c8", "message": "Added security code fragment transition", "committedDate": "2020-10-01T21:11:58Z", "type": "commit"}, {"oid": "6f82deedbb2d691a703edf763c475f818a30b5c8", "url": "https://github.com/mercadopago/px-android/commit/6f82deedbb2d691a703edf763c475f818a30b5c8", "message": "Added security code fragment transition", "committedDate": "2020-10-01T21:11:58Z", "type": "forcePushed"}, {"oid": "101a2d290a9a782f09125cd2e0f97481f77c1c9d", "url": "https://github.com/mercadopago/px-android/commit/101a2d290a9a782f09125cd2e0f97481f77c1c9d", "message": "Added correct subtitle + groups support", "committedDate": "2020-10-05T20:42:26Z", "type": "commit"}, {"oid": "07ee7b1480ddcf0bc9070225af6a339843499790", "url": "https://github.com/mercadopago/px-android/commit/07ee7b1480ddcf0bc9070225af6a339843499790", "message": "Cleaned animation code", "committedDate": "2020-10-07T17:19:10Z", "type": "forcePushed"}, {"oid": "a3199024bdecee40560226e31af9dc3ac7f16246", "url": "https://github.com/mercadopago/px-android/commit/a3199024bdecee40560226e31af9dc3ac7f16246", "message": "Cleaned animation code", "committedDate": "2020-10-07T17:22:15Z", "type": "forcePushed"}, {"oid": "d1c7c701e60b18e508ada2c502adce82373898d4", "url": "https://github.com/mercadopago/px-android/commit/d1c7c701e60b18e508ada2c502adce82373898d4", "message": "Cleaned animation code", "committedDate": "2020-10-07T17:36:21Z", "type": "commit"}, {"oid": "d1c7c701e60b18e508ada2c502adce82373898d4", "url": "https://github.com/mercadopago/px-android/commit/d1c7c701e60b18e508ada2c502adce82373898d4", "message": "Cleaned animation code", "committedDate": "2020-10-07T17:36:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE5MjE5Nw==", "url": "https://github.com/mercadopago/px-android/pull/2345#discussion_r501192197", "bodyText": "Todav\u00eda no existe versi\u00f3n con el componente", "author": "guchito9", "createdAt": "2020-10-07T17:36:56Z", "path": "gradle.properties", "diffHunk": "@@ -35,7 +35,7 @@ businessComponents=1.+\n cardForm=1.+\n picassoDiskCache=1.+\n # ML libs\n-andesUi=2.+\n+andesUi=LOCAL-2.12.0-0", "originalCommit": "d1c7c701e60b18e508ada2c502adce82373898d4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE5Mjc2NQ==", "url": "https://github.com/mercadopago/px-android/pull/2345#discussion_r501192765", "bodyText": "Estoy mandando cero porque no deber\u00edamos caer ahi, pero me parece que tengo que tenerlo en cuenta", "author": "guchito9", "createdAt": "2020-10-07T17:37:54Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/payment_result/PaymentResultActivity.java", "diffHunk": "@@ -272,6 +273,12 @@ public void enqueueOnExploding(@NonNull final PayButton.OnEnqueueResolvedCallbac\n         remediesFragment.onPayButtonPressed(callback);\n     }\n \n+    @NonNull\n+    @Override\n+    public PayButton.CvvRequestedModel onCvvRequested() {\n+        return new PayButton.CvvRequestedModel(0, RenderMode.NO_CARD);", "originalCommit": "d1c7c701e60b18e508ada2c502adce82373898d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcwMjg3NA==", "url": "https://github.com/mercadopago/px-android/pull/2345#discussion_r501702874", "bodyText": "Si no deber\u00eda pasar por ac\u00e1, porque no lanzamos un Exception directamente?", "author": "jorGonzalez291292", "createdAt": "2020-10-08T13:04:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE5Mjc2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTgzMDQwOA==", "url": "https://github.com/mercadopago/px-android/pull/2345#discussion_r501830408", "bodyText": "Vamos a ir por wrappear en un activity el fragment. Lo hago en otro PR", "author": "guchito9", "createdAt": "2020-10-08T15:53:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE5Mjc2NQ=="}], "type": "inlineReview"}, {"oid": "225f50b6005b68aae2f079bf01a5093e4ac793ad", "url": "https://github.com/mercadopago/px-android/commit/225f50b6005b68aae2f079bf01a5093e4ac793ad", "message": "Fixed tests", "committedDate": "2020-10-07T19:42:01Z", "type": "commit"}, {"oid": "df081709c90ae451a1a6491ea78659ac0181b87c", "url": "https://github.com/mercadopago/px-android/commit/df081709c90ae451a1a6491ea78659ac0181b87c", "message": "Disable and enable button logic in cvv screen", "committedDate": "2020-10-07T22:18:55Z", "type": "commit"}, {"oid": "df081709c90ae451a1a6491ea78659ac0181b87c", "url": "https://github.com/mercadopago/px-android/commit/df081709c90ae451a1a6491ea78659ac0181b87c", "message": "Disable and enable button logic in cvv screen", "committedDate": "2020-10-07T22:18:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcxNDY5NA==", "url": "https://github.com/mercadopago/px-android/pull/2345#discussion_r501714694", "bodyText": "Esto lo podr\u00edamos transformar en un extension file. Como todos dependen de View, podr\u00edamos tener extensions de views que tengan la l\u00f3gica de animaci\u00f3n.\nEj:\nfun View.fadeIn(duration: Long? = null): Animator {\n        return alpha(1f).apply { duration?.let { this.duration = it } }\n}", "author": "jorGonzalez291292", "createdAt": "2020-10-08T13:20:49Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/view/animator/AnimatorFactory.kt", "diffHunk": "@@ -0,0 +1,58 @@\n+package com.mercadopago.android.px.internal.view.animator\n+\n+import android.animation.Animator\n+import android.animation.AnimatorSet\n+import android.animation.ObjectAnimator\n+import android.view.View\n+\n+object AnimatorFactory {", "originalCommit": "df081709c90ae451a1a6491ea78659ac0181b87c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "89ef75afcd111066f50fecb62e54a60a24dc8212", "url": "https://github.com/mercadopago/px-android/commit/89ef75afcd111066f50fecb62e54a60a24dc8212", "message": "Refactor animator factory into extensions", "committedDate": "2020-10-08T14:58:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg3NDM4MQ==", "url": "https://github.com/mercadopago/px-android/pull/2345#discussion_r501874381", "bodyText": "por que hace falta implementarlo ac\u00e1?", "author": "cgaggino", "createdAt": "2020-10-08T17:01:46Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/express/offline_methods/OfflineMethodsFragment.kt", "diffHunk": "@@ -206,6 +208,8 @@ class OfflineMethodsFragment : Fragment(), OfflineMethods.View, BackHandler {\n         viewModel.onPrePayment(callback)\n     }\n \n+    override fun onCvvRequested() = PayButton.CvvRequestedModel(R.id.one_tap_fragment, RenderMode.NO_CARD)", "originalCommit": "89ef75afcd111066f50fecb62e54a60a24dc8212", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg4Mzg4NQ==", "url": "https://github.com/mercadopago/px-android/pull/2345#discussion_r501883885", "bodyText": "Porque OfflineMethods.View implementa el handler del pay button", "author": "guchito9", "createdAt": "2020-10-08T17:17:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg3NDM4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTkxMTg3Mw==", "url": "https://github.com/mercadopago/px-android/pull/2345#discussion_r501911873", "bodyText": "ya s\u00e9, pero no deberia pedir cvv ac\u00e1, quizas el metodo tenga que tener un default o tirar una excepci\u00f3n aca o dejar la implementaci\u00f3n vacia, armar un objeto por armar  es medio raro", "author": "cgaggino", "createdAt": "2020-10-08T18:01:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg3NDM4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTkxMjA3NA==", "url": "https://github.com/mercadopago/px-android/pull/2345#discussion_r501912074", "bodyText": "incluso hasta loguear un friction es razonable", "author": "cgaggino", "createdAt": "2020-10-08T18:02:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg3NDM4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU4OTk3MA==", "url": "https://github.com/mercadopago/px-android/pull/2345#discussion_r502589970", "bodyText": "Ya no va a ser necesario en el pr\u00f3ximo cambio", "author": "guchito9", "createdAt": "2020-10-09T17:59:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg3NDM4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTkwMTQ4MA==", "url": "https://github.com/mercadopago/px-android/pull/2345#discussion_r501901480", "bodyText": "ojal\u00e1 nunca inventen un cvv de 5 o 2 :P", "author": "cgaggino", "createdAt": "2020-10-08T17:46:00Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/security_code/SecurityCodeFragment.kt", "diffHunk": "@@ -1,109 +1,214 @@\n package com.mercadopago.android.px.internal.features.security_code\n \n+import android.animation.Animator\n import android.os.Bundle\n-import android.text.InputFilter\n-import android.text.InputFilter.LengthFilter\n import android.view.LayoutInflater\n import android.view.View\n import android.view.View.GONE\n import android.view.View.VISIBLE\n import android.view.ViewGroup\n-import android.widget.EditText\n import android.widget.TextView\n import androidx.appcompat.app.AppCompatActivity\n import androidx.appcompat.widget.Toolbar\n+import androidx.constraintlayout.widget.ConstraintLayout\n+import androidx.constraintlayout.widget.ConstraintSet\n import androidx.fragment.app.Fragment\n import com.meli.android.carddrawer.model.CardDrawerView\n import com.mercadolibre.android.andesui.snackbar.action.AndesSnackbarAction\n+import com.mercadolibre.android.andesui.textfield.AndesTextfieldCode\n+import com.mercadolibre.android.andesui.textfield.style.AndesTextfieldCodeStyle\n import com.mercadopago.android.px.R\n import com.mercadopago.android.px.core.BackHandler\n import com.mercadopago.android.px.internal.di.viewModel\n+import com.mercadopago.android.px.internal.extensions.postDelayed\n+import com.mercadopago.android.px.internal.extensions.runWhenLaidOut\n import com.mercadopago.android.px.internal.extensions.showSnackBar\n+import com.mercadopago.android.px.internal.features.express.RenderMode\n import com.mercadopago.android.px.internal.features.pay_button.PayButton\n import com.mercadopago.android.px.internal.features.pay_button.PayButtonFragment\n+import com.mercadopago.android.px.internal.features.security_code.model.SecurityCodeParams\n import com.mercadopago.android.px.internal.util.ViewUtils\n import com.mercadopago.android.px.internal.util.nonNullObserve\n-import com.mercadopago.android.px.model.PaymentRecovery\n+import com.mercadopago.android.px.internal.view.animator.SecurityCodeTransition\n import com.mercadopago.android.px.model.exceptions.MercadoPagoError\n-import com.mercadopago.android.px.model.internal.PaymentConfiguration\n-import com.mercadopago.android.px.tracking.internal.model.Reason\n+\n+private const val ARG_PARAMS = \"security_code_params\"\n+private const val HIGH_RES_MIN_HEIGHT = 620\n+private const val LOW_RES_MIN_HEIGHT = 585\n \n internal class SecurityCodeFragment : Fragment(), PayButton.Handler, BackHandler {\n \n     private val securityCodeViewModel: SecurityCodeViewModel by viewModel()\n \n-    private lateinit var cardDrawer: CardDrawerView\n-    private lateinit var cvvEditText: EditText\n+    private lateinit var cvvEditText: AndesTextfieldCode\n     private lateinit var cvvTitle: TextView\n-    private lateinit var cvvSubtitle: TextView\n     private lateinit var payButtonFragment: PayButtonFragment\n+    private lateinit var cvvToolbar: Toolbar\n+    private lateinit var renderMode: RenderMode\n+    private lateinit var cardDrawer: CardDrawerView\n+    private lateinit var cvvSubtitle: TextView\n+    private lateinit var transition: SecurityCodeTransition\n+    private var fragmentContainer: Int = 0\n+    private var shouldAnimate = true\n+    private var backEnabled = false\n+\n+    override fun onCreateView(inflater: LayoutInflater, container: ViewGroup?, savedInstanceState: Bundle?): View? {\n+        arguments?.getParcelable<SecurityCodeParams>(ARG_PARAMS)?.let {\n+            fragmentContainer = it.fragmentContainer\n+            defineRenderMode(it.renderMode)\n+\n+            val view = inflater.inflate(\n+                if (renderMode == RenderMode.LOW_RES) {\n+                    R.layout.fragment_security_code_lowres\n+                } else {\n+                    R.layout.fragment_security_code\n+                },\n+                container, false\n+            ) as ConstraintLayout\n \n-    override fun onCreateView(inflater: LayoutInflater, container: ViewGroup?,\n-        savedInstanceState: Bundle?): View? {\n-        return inflater.inflate(R.layout.fragment_security_code, container, false)\n+            cvvToolbar = view.findViewById(R.id.cvv_toolbar)\n+            cardDrawer = view.findViewById(R.id.card_drawer)\n+            cvvEditText = view.findViewById(R.id.cvv_edit_text)\n+            cvvTitle = view.findViewById(R.id.cvv_title)\n+            cvvSubtitle = view.findViewById(R.id.cvv_subtitle)\n+\n+            transition = SecurityCodeTransition(view, cardDrawer, cvvToolbar, cvvTitle, cvvSubtitle, cvvEditText,\n+                view.findViewById(R.id.pay_button))\n+\n+            if (renderMode == RenderMode.NO_CARD) {\n+                cardDrawer.visibility = GONE\n+                cvvSubtitle.visibility = VISIBLE\n+            }\n+\n+            return view\n+        } ?: error(\"Arguments not be null\")\n     }\n \n-    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {\n-        super.onViewCreated(view, savedInstanceState)\n+    override fun onCreateAnimator(transit: Int, enter: Boolean, nextAnim: Int): Animator? {\n+        if (shouldAnimate) {\n+            if (enter) {\n+                transition.listener = object : SecurityCodeTransition.Listener {\n+                    override fun onTitleAnimationEnd() {\n+                        postAnimationConfig()\n+                    }\n \n-        (activity as? AppCompatActivity?)?.apply {\n-            view.findViewById<Toolbar>(R.id.cvv_toolbar)?.also { toolbar ->\n-                setSupportActionBar(toolbar)\n-                supportActionBar?.apply {\n-                    setDisplayShowTitleEnabled(false)\n-                    setDisplayHomeAsUpEnabled(true)\n-                    setDisplayShowHomeEnabled(true)\n-                    setHomeButtonEnabled(true)\n-                    toolbar.setNavigationOnClickListener { onBackPressed() }\n+                    override fun onAnimationEnd() {\n+                        backEnabled = true\n+                    }\n                 }\n+                transition.playEnter()\n+            } else {\n+                transition.playExit()\n+            }\n+        } else {\n+            shouldAnimate = true\n+            backEnabled = true\n+            cvvEditText.runWhenLaidOut {\n+                cardDrawer.pivotX = cardDrawer.measuredWidth * 0.5f\n+                cardDrawer.pivotY = 0f\n+                cardDrawer.scaleX = 0.5f\n+                cardDrawer.scaleY = 0.5f\n+                postAnimationConfig()\n             }\n         }\n+        return super.onCreateAnimator(transit, enter, nextAnim)\n+    }\n \n-        cardDrawer = view.findViewById(R.id.card_drawer)\n-        cvvEditText = view.findViewById(R.id.cvv_edit_text)\n-        cvvTitle = view.findViewById(R.id.cvv_title)\n-        cvvSubtitle = view.findViewById(R.id.cvv_subtitle)\n-        ViewUtils.openKeyboard(cvvEditText)\n+    private fun postAnimationConfig() {\n+        ConstraintSet().apply {\n+            val constraint = view as ConstraintLayout\n+            clone(constraint)\n+            connect(cardDrawer.id, ConstraintSet.TOP, cvvSubtitle.id, ConstraintSet.BOTTOM)\n+            applyTo(constraint)\n+            cardDrawer.showSecurityCode()\n+            ViewUtils.openKeyboard(cvvEditText)\n+        }\n+    }\n \n-        arguments?.apply {\n+    private fun defineRenderMode(parentRenderMode: RenderMode) {\n+        val availableHeight = resources.configuration.screenHeightDp\n+        renderMode = when(parentRenderMode) {\n+            RenderMode.HIGH_RES -> if (availableHeight >= HIGH_RES_MIN_HEIGHT) RenderMode.HIGH_RES else RenderMode.NO_CARD\n+            RenderMode.LOW_RES -> if (availableHeight >= LOW_RES_MIN_HEIGHT) RenderMode.LOW_RES else RenderMode.NO_CARD\n+            else -> RenderMode.NO_CARD\n+        }\n+    }\n \n-            check(\n-                containsKey(EXTRA_PAYMENT_RECOVERY)\n-                    || containsKey(EXTRA_PAYMENT_CONFIGURATION)\n-                    && containsKey(EXTRA_REASON)) {\n-                \"PaymentRecovery or PaymentConfiguration and Reason are needed\"\n-            }\n+    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {\n+        super.onViewCreated(view, savedInstanceState)\n \n-            val paymentRecovery = getParcelable<PaymentRecovery>(EXTRA_PAYMENT_RECOVERY)\n-            val reason = paymentRecovery?.let { Reason.from(it) } ?: getString(EXTRA_REASON)?.let { Reason.valueOf(it) }\n-            securityCodeViewModel.init(\n-                getParcelable(EXTRA_PAYMENT_CONFIGURATION)!!,\n-                paymentRecovery,\n-                reason!!)\n+        payButtonFragment = childFragmentManager.findFragmentById(R.id.pay_button) as PayButtonFragment\n+\n+        savedInstanceState?.let {\n+            transition.fromBundle(it)\n+            shouldAnimate = false\n+        } ?: payButtonFragment.disable()\n+\n+        (activity as? AppCompatActivity?)?.apply {\n+            setSupportActionBar(cvvToolbar)\n+            supportActionBar?.apply {\n+                setDisplayShowTitleEnabled(false)\n+                setDisplayHomeAsUpEnabled(true)\n+                setDisplayShowHomeEnabled(true)\n+                setHomeButtonEnabled(true)\n+                cvvToolbar.setNavigationOnClickListener {\n+                    if (backEnabled) {\n+                        transition.prepareForExit()\n+                        ViewUtils.hideKeyboard(activity)\n+                        postDelayed(100) {\n+                            onBackPressed()\n+                        }\n+                    }\n+                }\n+            }\n+        }\n \n+        arguments?.getParcelable<SecurityCodeParams>(ARG_PARAMS)?.let {\n+            securityCodeViewModel.init(it.paymentConfiguration, it.paymentRecovery, it.reason)\n         } ?: error(\"Arguments not be null\")\n \n-        payButtonFragment = childFragmentManager.findFragmentById(R.id.pay_button) as PayButtonFragment\n+        cvvEditText.setOnCompleteListener(object : AndesTextfieldCode.OnCompletionListener {\n+            override fun onComplete(isFull: Boolean) {\n+                if (isFull) payButtonFragment.enable() else payButtonFragment.disable()\n+            }\n+        })\n+        cvvEditText.setOnTextChangeListener(object : AndesTextfieldCode.OnTextChangeListener {\n+            override fun onChange(text: String) {\n+                cardDrawer.card.secCode = text\n+            }\n+        })\n         observeViewModel()\n     }\n \n+    override fun onSaveInstanceState(outState: Bundle) {\n+        super.onSaveInstanceState(outState)\n+        transition.toBundle(outState)\n+    }\n+\n     private fun observeViewModel() {\n         with(securityCodeViewModel) {\n-            cvvCardUiLiveData.nonNullObserve(viewLifecycleOwner) {\n+            displayModelLiveData.nonNullObserve(viewLifecycleOwner) { model ->\n                 with(cardDrawer) {\n-                    card.name = it.name\n-                    card.expiration = it.date\n-                    card.number = it.number\n-                    show(it)\n+                    model.cardUiConfiguration?.let {\n+                        card.name = it.name\n+                        card.expiration = it.date\n+                        card.number = it.number\n+                        show(it)\n+                    } ?: run {\n+                        cardDrawer.visibility = GONE\n+                        cvvSubtitle.visibility = VISIBLE\n+                    }\n                 }\n-            }\n \n-            virtualCardInfoLiveData.nonNullObserve(viewLifecycleOwner) {\n-                cardDrawer.visibility = GONE\n-                cvvTitle.text = it.title\n-                with(cvvSubtitle) {\n-                    text = it.message\n-                    visibility = VISIBLE\n+                context?.let {\n+                    cvvTitle.text = model.title.get(it)\n+                    cvvSubtitle.text = model.message.get(it)\n+                }\n+\n+                cvvEditText.style = if (model.securityCodeLength == 4) {", "originalCommit": "89ef75afcd111066f50fecb62e54a60a24dc8212", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}