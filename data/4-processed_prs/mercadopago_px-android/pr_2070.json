{"pr_number": 2070, "pr_title": "[Feature] Congrats service", "pr_createdAt": "2020-03-17T00:09:22Z", "pr_url": "https://github.com/mercadopago/px-android/pull/2070", "timeline": [{"oid": "4f66deea22df64fd56a1ba12de2fcde2099b3550", "url": "https://github.com/mercadopago/px-android/commit/4f66deea22df64fd56a1ba12de2fcde2099b3550", "message": "fixed nullpointer in cardform", "committedDate": "2020-03-14T17:38:36Z", "type": "commit"}, {"oid": "db06007f68140ae192a68678848b85217a8b7c3f", "url": "https://github.com/mercadopago/px-android/commit/db06007f68140ae192a68678848b85217a8b7c3f", "message": "Merge pull request #2068 from mercadopago/fix/fragments-onetap-cardform\n\nFixed nullpointer in cardform", "committedDate": "2020-03-15T18:01:52Z", "type": "commit"}, {"oid": "4936097ed33d6d39004137e4b304e6b8d811a7ce", "url": "https://github.com/mercadopago/px-android/commit/4936097ed33d6d39004137e4b304e6b8d811a7ce", "message": " * Refactored payment service", "committedDate": "2020-03-17T00:15:32Z", "type": "commit"}, {"oid": "33b579b3f7d125fff3a01cced6452155f6f18d4d", "url": "https://github.com/mercadopago/px-android/commit/33b579b3f7d125fff3a01cced6452155f6f18d4d", "message": "Added congrats service", "committedDate": "2020-03-17T00:18:01Z", "type": "forcePushed"}, {"oid": "b3278c6e26ee765f3d4ad81ad8cd11d506c4c109", "url": "https://github.com/mercadopago/px-android/commit/b3278c6e26ee765f3d4ad81ad8cd11d506c4c109", "message": "Added congrats service", "committedDate": "2020-03-17T06:43:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQ3MTQ0OQ==", "url": "https://github.com/mercadopago/px-android/pull/2070#discussion_r393471449", "bodyText": "el valor de paymentSettings.getCurrency va a ser resuelto al momento que se llame getPaymentRewardRepository, que va a ser al momento de realizar las inyecciones de dependencia, pasaria el repositorio de paymentSettings directamente a CongratsRepositoryImpl para que resuelva lo que necesite en su momento (y de paso es un parametro menos)", "author": "cgaggino", "createdAt": "2020-03-17T06:43:50Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/di/Session.java", "diffHunk": "@@ -447,17 +447,17 @@ public PaymentMethodsRepository getPaymentMethodsRepository() {\n         return paymentMethodsRepository;\n     }\n \n-    public PaymentRewardRepository getPaymentRewardRepository() {\n-        if (paymentRewardRepository == null) {\n+    public CongratsRepository getCongratsRepository() {\n+        if (congratsRepository == null) {\n             final Context applicationContext = getApplicationContext();\n-            final PaymentRewardService paymentRewardService =\n-                RetrofitUtil.getRetrofitClient(applicationContext).create(PaymentRewardService.class);\n+            final CongratsService congratsService =\n+                RetrofitUtil.getRetrofitClient(applicationContext).create(CongratsService.class);\n             final PaymentSettingRepository paymentSettings = getConfigurationModule().getPaymentSettings();\n-            paymentRewardRepository =\n-                new PaymentRewardRepositoryImpl(getPaymentRewardCache(), paymentRewardService,\n-                    paymentSettings.getPrivateKey(), getPlatform(applicationContext),\n+            congratsRepository =\n+                new CongratsRepositoryImpl(getPaymentRewardCache(), congratsService, paymentSettings.getPrivateKey(),\n+                    paymentSettings.getCurrency(), getPlatform(applicationContext),", "originalCommit": "33b579b3f7d125fff3a01cced6452155f6f18d4d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQ3NjkzOA==", "url": "https://github.com/mercadopago/px-android/pull/2070#discussion_r393476938", "bodyText": "Si, ya lo tuve que arreglar, me tir\u00f3 el famoso error de que no puede traer currency del storage", "author": "guchito9", "createdAt": "2020-03-17T07:01:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQ3MTQ0OQ=="}], "type": "inlineReview"}, {"oid": "b3278c6e26ee765f3d4ad81ad8cd11d506c4c109", "url": "https://github.com/mercadopago/px-android/commit/b3278c6e26ee765f3d4ad81ad8cd11d506c4c109", "message": "Added congrats service", "committedDate": "2020-03-17T06:43:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQ3OTIyOA==", "url": "https://github.com/mercadopago/px-android/pull/2070#discussion_r393479228", "bodyText": "No ofrecemos remedies si no tiene AT?", "author": "cgaggino", "createdAt": "2020-03-17T07:08:32Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/datasource/CongratsRepositoryImpl.kt", "diffHunk": "@@ -0,0 +1,91 @@\n+package com.mercadopago.android.px.internal.datasource\n+\n+import com.mercadopago.android.px.internal.repository.CongratsRepository\n+import com.mercadopago.android.px.internal.repository.CongratsRepository.PostPaymentCallback\n+import com.mercadopago.android.px.internal.repository.PaymentSettingRepository\n+import com.mercadopago.android.px.internal.services.CongratsService\n+import com.mercadopago.android.px.internal.util.StatusHelper\n+import com.mercadopago.android.px.internal.util.TextUtil\n+import com.mercadopago.android.px.internal.viewmodel.BusinessPaymentModel\n+import com.mercadopago.android.px.internal.viewmodel.PaymentModel\n+import com.mercadopago.android.px.model.*\n+import com.mercadopago.android.px.model.internal.PaymentReward\n+import com.mercadopago.android.px.model.internal.remedies.RemediesResponse\n+import com.mercadopago.android.px.services.BuildConfig\n+import kotlinx.coroutines.CoroutineScope\n+import kotlinx.coroutines.Dispatchers\n+import kotlinx.coroutines.launch\n+import kotlinx.coroutines.withContext\n+\n+class CongratsRepositoryImpl(private val congratsService: CongratsService,\n+        private val paymentSetting: PaymentSettingRepository, private val platform: String, private val locale: String,\n+        private val flow: String?) : CongratsRepository {\n+\n+    private val paymentRewardCache = HashMap<String, PaymentReward>()\n+    private val remediesCache = HashMap<String, RemediesResponse>()\n+    private val privateKey = paymentSetting.privateKey\n+\n+    override fun getPostPaymentData(payment: IPaymentDescriptor, paymentResult: PaymentResult,\n+                                    callback: PostPaymentCallback) {\n+        val hasAccessToken = TextUtil.isNotEmpty(privateKey)\n+        val hasToReturnEmptyResponse = !hasAccessToken\n+        val isSuccess = StatusHelper.isSuccess(payment)\n+        CoroutineScope(Dispatchers.IO).launch {\n+            val paymentId = payment.paymentIds?.get(0) ?: payment.id.toString()\n+            val paymentReward = when {\n+                hasToReturnEmptyResponse || !isSuccess -> PaymentReward.EMPTY\n+                paymentRewardCache.containsKey(paymentId) -> paymentRewardCache[paymentId]!!\n+                else -> getPaymentReward(payment, paymentResult).apply { paymentRewardCache[paymentId] = this }\n+            }\n+            val remediesResponse = when {\n+                hasToReturnEmptyResponse || isSuccess -> RemediesResponse.EMPTY", "originalCommit": "b3278c6e26ee765f3d4ad81ad8cd11d506c4c109", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQ4MjQzNQ==", "url": "https://github.com/mercadopago/px-android/pull/2070#discussion_r393482435", "bodyText": "No, es requerido por el endpoint, pero estoy dudando de que sea realmente asi", "author": "guchito9", "createdAt": "2020-03-17T07:18:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQ3OTIyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQ4NjAyOA==", "url": "https://github.com/mercadopago/px-android/pull/2070#discussion_r393486028", "bodyText": "Yo creo que a un whitelabel si le fallo por cvv se lo podriamos pedir en la congrat, un highrisk no porque no puede ir a kyc", "author": "cgaggino", "createdAt": "2020-03-17T07:28:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQ3OTIyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzY4NDc2OQ==", "url": "https://github.com/mercadopago/px-android/pull/2070#discussion_r393684769", "bodyText": "Claro, eso seguro, por ah\u00ed ahora sigo as\u00ed y despu\u00e9s lo unifico, pero quiero confirmar si puedo ir al endpoint o no", "author": "guchito9", "createdAt": "2020-03-17T13:38:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQ3OTIyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQ4MDU3OA==", "url": "https://github.com/mercadopago/px-android/pull/2070#discussion_r393480578", "bodyText": "Que significa este exception?", "author": "cgaggino", "createdAt": "2020-03-17T07:12:48Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/datasource/CongratsRepositoryImpl.kt", "diffHunk": "@@ -0,0 +1,91 @@\n+package com.mercadopago.android.px.internal.datasource\n+\n+import com.mercadopago.android.px.internal.repository.CongratsRepository\n+import com.mercadopago.android.px.internal.repository.CongratsRepository.PostPaymentCallback\n+import com.mercadopago.android.px.internal.repository.PaymentSettingRepository\n+import com.mercadopago.android.px.internal.services.CongratsService\n+import com.mercadopago.android.px.internal.util.StatusHelper\n+import com.mercadopago.android.px.internal.util.TextUtil\n+import com.mercadopago.android.px.internal.viewmodel.BusinessPaymentModel\n+import com.mercadopago.android.px.internal.viewmodel.PaymentModel\n+import com.mercadopago.android.px.model.*\n+import com.mercadopago.android.px.model.internal.PaymentReward\n+import com.mercadopago.android.px.model.internal.remedies.RemediesResponse\n+import com.mercadopago.android.px.services.BuildConfig\n+import kotlinx.coroutines.CoroutineScope\n+import kotlinx.coroutines.Dispatchers\n+import kotlinx.coroutines.launch\n+import kotlinx.coroutines.withContext\n+\n+class CongratsRepositoryImpl(private val congratsService: CongratsService,\n+        private val paymentSetting: PaymentSettingRepository, private val platform: String, private val locale: String,\n+        private val flow: String?) : CongratsRepository {\n+\n+    private val paymentRewardCache = HashMap<String, PaymentReward>()\n+    private val remediesCache = HashMap<String, RemediesResponse>()\n+    private val privateKey = paymentSetting.privateKey\n+\n+    override fun getPostPaymentData(payment: IPaymentDescriptor, paymentResult: PaymentResult,\n+                                    callback: PostPaymentCallback) {\n+        val hasAccessToken = TextUtil.isNotEmpty(privateKey)\n+        val hasToReturnEmptyResponse = !hasAccessToken\n+        val isSuccess = StatusHelper.isSuccess(payment)\n+        CoroutineScope(Dispatchers.IO).launch {\n+            val paymentId = payment.paymentIds?.get(0) ?: payment.id.toString()\n+            val paymentReward = when {\n+                hasToReturnEmptyResponse || !isSuccess -> PaymentReward.EMPTY\n+                paymentRewardCache.containsKey(paymentId) -> paymentRewardCache[paymentId]!!\n+                else -> getPaymentReward(payment, paymentResult).apply { paymentRewardCache[paymentId] = this }\n+            }\n+            val remediesResponse = when {\n+                hasToReturnEmptyResponse || isSuccess -> RemediesResponse.EMPTY\n+                remediesCache.containsKey(paymentId) -> remediesCache[paymentId]!!\n+                else -> getRemedies(payment).apply { remediesCache[paymentId] = this }\n+            }\n+            withContext(Dispatchers.Main) {\n+                handleResult(payment, paymentResult, paymentReward, remediesResponse, paymentSetting.currency, callback)\n+            }\n+        }\n+    }\n+\n+    private suspend fun getPaymentReward(payment: IPaymentDescriptor, paymentResult: PaymentResult) =\n+        try {\n+            val joinedPaymentIds = TextUtil.join(payment.paymentIds)\n+            val campaignId = paymentResult.paymentData.campaign?.run { id } ?: \"\"\n+            val response = congratsService.getPaymentReward(BuildConfig.API_ENVIRONMENT, locale, privateKey,\n+                    joinedPaymentIds, platform, campaignId, flow).await()\n+            if (response.isSuccessful) {\n+                response.body()!!\n+            } else {\n+                PaymentReward.EMPTY\n+            }\n+        } catch (e: Exception) {\n+            PaymentReward.EMPTY", "originalCommit": "b3278c6e26ee765f3d4ad81ad8cd11d506c4c109", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQ4MjU1Nw==", "url": "https://github.com/mercadopago/px-android/pull/2070#discussion_r393482557", "bodyText": "No hay conexi\u00f3n", "author": "guchito9", "createdAt": "2020-03-17T07:18:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQ4MDU3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQ4MTQ5NQ==", "url": "https://github.com/mercadopago/px-android/pull/2070#discussion_r393481495", "bodyText": "Quedo el archivo vacio?", "author": "cgaggino", "createdAt": "2020-03-17T07:15:36Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/payment_result/model/remedies/RemediesResponse.kt", "diffHunk": "@@ -1,3 +0,0 @@\n-package com.mercadopago.android.px.internal.features.payment_result.model.remedies\n-\n-data class RemediesResponse(val suggestionPaymentMethod: SuggestionPaymentMethod)", "originalCommit": "b3278c6e26ee765f3d4ad81ad8cd11d506c4c109", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQ4Mjc3Mg==", "url": "https://github.com/mercadopago/px-android/pull/2070#discussion_r393482772", "bodyText": "Todav\u00eda no termin\u00e9 las pegadas a remedies, dej\u00e9 el esqueleto hecho para el servicio", "author": "guchito9", "createdAt": "2020-03-17T07:19:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQ4MTQ5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQ4MzkwNA==", "url": "https://github.com/mercadopago/px-android/pull/2070#discussion_r393483904", "bodyText": "La logica de retries funciona igual?", "author": "cgaggino", "createdAt": "2020-03-17T07:22:48Z", "path": "px-services/src/main/java/com/mercadopago/android/px/internal/util/RetrofitUtil.java", "diffHunk": "@@ -32,6 +33,7 @@ private static Retrofit getRetrofit(final Context context,\n             .addConverterFactory(GsonConverterFactory.create(JsonUtil.getGson()))\n             .client(HttpClientUtil.getClient(context, connectTimeout, readTimeout, writeTimeout))\n             .addCallAdapterFactory(new ErrorHandlingCallAdapter.ErrorHandlingCallAdapterFactory())\n+            .addCallAdapterFactory(CoroutineCallAdapterFactory.create())", "originalCommit": "b3278c6e26ee765f3d4ad81ad8cd11d506c4c109", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzY4NTk0OA==", "url": "https://github.com/mercadopago/px-android/pull/2070#discussion_r393685948", "bodyText": "Lamentablemente no, cae por el adapter nuevo. Por ah\u00ed estar\u00eda bueno discutir si vale la pena llevarlo al mismo comportamiento, pero se puede hacer en el futuro.", "author": "guchito9", "createdAt": "2020-03-17T13:40:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQ4MzkwNA=="}], "type": "inlineReview"}, {"oid": "d617e596dd793980d235f59c204bc8f1d3c4db9b", "url": "https://github.com/mercadopago/px-android/commit/d617e596dd793980d235f59c204bc8f1d3c4db9b", "message": "custom cvv remedy layout added", "committedDate": "2020-03-17T21:49:41Z", "type": "commit"}, {"oid": "40039ed5d2b8691f0025b30256afad1c910ccdf5", "url": "https://github.com/mercadopago/px-android/commit/40039ed5d2b8691f0025b30256afad1c910ccdf5", "message": "change document fragment remedies", "committedDate": "2020-03-17T21:54:37Z", "type": "commit"}, {"oid": "7913585a4d8d56d66a8e5a819f7c0a5f0d818e69", "url": "https://github.com/mercadopago/px-android/commit/7913585a4d8d56d66a8e5a819f7c0a5f0d818e69", "message": "More work on the congrats service", "committedDate": "2020-03-18T03:02:26Z", "type": "commit"}, {"oid": "78a1c8a69b95f3a2e681439ed11407da79cf18a1", "url": "https://github.com/mercadopago/px-android/commit/78a1c8a69b95f3a2e681439ed11407da79cf18a1", "message": "Merge branch 'feature/congrats-service' of github.com:mercadopago/px-android into feature/congrats-service", "committedDate": "2020-03-18T03:22:51Z", "type": "commit"}, {"oid": "78a1c8a69b95f3a2e681439ed11407da79cf18a1", "url": "https://github.com/mercadopago/px-android/commit/78a1c8a69b95f3a2e681439ed11407da79cf18a1", "message": "Merge branch 'feature/congrats-service' of github.com:mercadopago/px-android into feature/congrats-service", "committedDate": "2020-03-18T03:22:51Z", "type": "forcePushed"}, {"oid": "daf56892d60d7b2302fa3b42a15ecd6e77c3eaad", "url": "https://github.com/mercadopago/px-android/commit/daf56892d60d7b2302fa3b42a15ecd6e77c3eaad", "message": "* Added PayButtonFragment", "committedDate": "2020-03-18T05:54:17Z", "type": "commit"}, {"oid": "34919ec0275220b66c190d58f866c7b066501ca9", "url": "https://github.com/mercadopago/px-android/commit/34919ec0275220b66c190d58f866c7b066501ca9", "message": "render remedy view, mapper remedy data", "committedDate": "2020-03-18T21:32:23Z", "type": "commit"}, {"oid": "484a1ff20f1039f129292e1f2e287e94b86122bc", "url": "https://github.com/mercadopago/px-android/commit/484a1ff20f1039f129292e1f2e287e94b86122bc", "message": "refactor", "committedDate": "2020-03-18T22:05:41Z", "type": "commit"}, {"oid": "a21cff2e48b9fa5ed14a7c3badb5cf911f280f2e", "url": "https://github.com/mercadopago/px-android/commit/a21cff2e48b9fa5ed14a7c3badb5cf911f280f2e", "message": "refactor", "committedDate": "2020-03-18T22:22:46Z", "type": "forcePushed"}, {"oid": "484a1ff20f1039f129292e1f2e287e94b86122bc", "url": "https://github.com/mercadopago/px-android/commit/484a1ff20f1039f129292e1f2e287e94b86122bc", "message": "refactor", "committedDate": "2020-03-18T22:05:41Z", "type": "forcePushed"}, {"oid": "0f85bf2e4285c2514c7792bb9d0fe2b047518806", "url": "https://github.com/mercadopago/px-android/commit/0f85bf2e4285c2514c7792bb9d0fe2b047518806", "message": "* Cleaned express payment view", "committedDate": "2020-03-18T23:07:19Z", "type": "commit"}, {"oid": "89ec097f66e40b12b4f1daa299c56068dfc0e4e3", "url": "https://github.com/mercadopago/px-android/commit/89ec097f66e40b12b4f1daa299c56068dfc0e4e3", "message": "Merge branch 'enhancement/generic-confirmation-button' into feature/congrats-service", "committedDate": "2020-03-18T23:16:13Z", "type": "commit"}, {"oid": "ea68b96b2ee3502a2707e55f452ebd8408459a54", "url": "https://github.com/mercadopago/px-android/commit/ea68b96b2ee3502a2707e55f452ebd8408459a54", "message": "* Fixed button adapter", "committedDate": "2020-03-18T23:28:19Z", "type": "commit"}, {"oid": "3dac3913a4a4b9ba0fd841eb0847d62865e95576", "url": "https://github.com/mercadopago/px-android/commit/3dac3913a4a4b9ba0fd841eb0847d62865e95576", "message": "* Update button status", "committedDate": "2020-03-19T00:20:23Z", "type": "commit"}, {"oid": "95dec7a40d33291ca029a0447d334ba83c1751f6", "url": "https://github.com/mercadopago/px-android/commit/95dec7a40d33291ca029a0447d334ba83c1751f6", "message": "* Changed post value by set value", "committedDate": "2020-03-19T00:23:37Z", "type": "commit"}, {"oid": "ba3dd69b97b89bb7326c5e793f78121b04256687", "url": "https://github.com/mercadopago/px-android/commit/ba3dd69b97b89bb7326c5e793f78121b04256687", "message": "* Fixed fragment replacement", "committedDate": "2020-03-19T01:57:18Z", "type": "commit"}, {"oid": "f807510c82e407edbc93dafe9b9858fb32a55e1c", "url": "https://github.com/mercadopago/px-android/commit/f807510c82e407edbc93dafe9b9858fb32a55e1c", "message": "* Reverted set value to post value for problems with fragments", "committedDate": "2020-03-19T02:10:54Z", "type": "commit"}, {"oid": "5f66a9c498cdf09be022062adc09961144c48a6c", "url": "https://github.com/mercadopago/px-android/commit/5f66a9c498cdf09be022062adc09961144c48a6c", "message": "Adding pay button to cvv remedy", "committedDate": "2020-03-19T05:15:22Z", "type": "commit"}, {"oid": "1740a8ed46b39470bc207dab1e874bc4e6891745", "url": "https://github.com/mercadopago/px-android/commit/1740a8ed46b39470bc207dab1e874bc4e6891745", "message": "Merge branch 'enhancement/generic-confirmation-button' into feature/congrats-service", "committedDate": "2020-03-19T05:16:37Z", "type": "commit"}, {"oid": "065697310f0f1a9877a29a302d3862737ba2b756", "url": "https://github.com/mercadopago/px-android/commit/065697310f0f1a9877a29a302d3862737ba2b756", "message": "More work on the cvv remedy", "committedDate": "2020-03-19T09:21:44Z", "type": "commit"}, {"oid": "065697310f0f1a9877a29a302d3862737ba2b756", "url": "https://github.com/mercadopago/px-android/commit/065697310f0f1a9877a29a302d3862737ba2b756", "message": "More work on the cvv remedy", "committedDate": "2020-03-19T09:21:44Z", "type": "forcePushed"}]}