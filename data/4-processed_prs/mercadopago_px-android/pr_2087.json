{"pr_number": 2087, "pr_title": "[Feature] High risk remedy", "pr_createdAt": "2020-03-28T00:10:20Z", "pr_url": "https://github.com/mercadopago/px-android/pull/2087", "timeline": [{"oid": "181df6ce05ed0a6e8bc2ccd1de71d90b3b7b619b", "url": "https://github.com/mercadopago/px-android/commit/181df6ce05ed0a6e8bc2ccd1de71d90b3b7b619b", "message": "Added high risk remedy", "committedDate": "2020-03-28T00:12:23Z", "type": "forcePushed"}, {"oid": "f20b2ed87d57d2b09b76440ac5382c9f82f4a7db", "url": "https://github.com/mercadopago/px-android/commit/f20b2ed87d57d2b09b76440ac5382c9f82f4a7db", "message": "Added high risk remedy", "committedDate": "2020-03-30T20:19:14Z", "type": "forcePushed"}, {"oid": "d68074cf67c73bae61065a806cbb2fb51ab627d5", "url": "https://github.com/mercadopago/px-android/commit/d68074cf67c73bae61065a806cbb2fb51ab627d5", "message": "Added high risk remedy", "committedDate": "2020-03-30T22:28:26Z", "type": "forcePushed"}, {"oid": "b07f772a0c6f617a32b0d13ba6cca0f1a4d22483", "url": "https://github.com/mercadopago/px-android/commit/b07f772a0c6f617a32b0d13ba6cca0f1a4d22483", "message": "Added high risk remedy", "committedDate": "2020-04-01T17:15:45Z", "type": "forcePushed"}, {"oid": "8a0dfc5d79559f189bfcdfccc82274291e3560f0", "url": "https://github.com/mercadopago/px-android/commit/8a0dfc5d79559f189bfcdfccc82274291e3560f0", "message": "Added high risk remedy", "committedDate": "2020-04-01T17:19:23Z", "type": "forcePushed"}, {"oid": "3b1b2d885d933813cbb5223ebf76c732575c9c91", "url": "https://github.com/mercadopago/px-android/commit/3b1b2d885d933813cbb5223ebf76c732575c9c91", "message": "Added high risk remedy", "committedDate": "2020-04-01T21:32:09Z", "type": "forcePushed"}, {"oid": "d30943bc3bf59d79f977d32d4979b1c59000e56c", "url": "https://github.com/mercadopago/px-android/commit/d30943bc3bf59d79f977d32d4979b1c59000e56c", "message": "Added high risk remedy", "committedDate": "2020-04-02T00:01:28Z", "type": "forcePushed"}, {"oid": "ffcc7f24ca3903c7fe204edbc2a887ddfd66889c", "url": "https://github.com/mercadopago/px-android/commit/ffcc7f24ca3903c7fe204edbc2a887ddfd66889c", "message": "Added high risk remedy", "committedDate": "2020-04-02T01:16:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjMxMzcxNQ==", "url": "https://github.com/mercadopago/px-android/pull/2087#discussion_r402313715", "bodyText": "Se van a terminar usando estos override?", "author": "jorGonzalez291292", "createdAt": "2020-04-02T13:30:42Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/checkout/CheckoutPresenter.java", "diffHunk": "@@ -439,6 +438,11 @@ public void driveToShowPaymentMethodSelection() {\n             });\n     }\n \n+    @Override\n+    public void onUserValidation() {", "originalCommit": "ffcc7f24ca3903c7fe204edbc2a887ddfd66889c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM3MjkxNw==", "url": "https://github.com/mercadopago/px-android/pull/2087#discussion_r402372917", "bodyText": "Es una interfaz que se implementa en todos los puntos donde se espera una respuesta de la congrats, yo solo lo necesito en el fragment del bot\u00f3n de pagar.", "author": "guchito9", "createdAt": "2020-04-02T14:48:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjMxMzcxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjMxNjEyOQ==", "url": "https://github.com/mercadopago/px-android/pull/2087#discussion_r402316129", "bodyText": "Ac\u00e1 tratar\u00eda de usar el with(data).", "author": "jorGonzalez291292", "createdAt": "2020-04-02T13:34:00Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/payment_result/remedies/RemediesBodyMapper.kt", "diffHunk": "@@ -1,18 +1,19 @@\n package com.mercadopago.android.px.internal.features.payment_result.remedies\n \n+import com.mercadopago.android.px.internal.repository.UserSelectionRepository\n import com.mercadopago.android.px.internal.viewmodel.mappers.Mapper\n-import com.mercadopago.android.px.model.Card\n-import com.mercadopago.android.px.model.PayerCost\n+import com.mercadopago.android.px.model.PaymentData\n import com.mercadopago.android.px.model.internal.remedies.PayerPaymentMethodRejected\n import com.mercadopago.android.px.model.internal.remedies.RemediesBody\n \n-internal class RemediesBodyMapper : Mapper<Pair<Card, PayerCost>, RemediesBody>() {\n+internal class RemediesBodyMapper(private val userSelectionRepository: UserSelectionRepository)\n+    : Mapper<PaymentData, RemediesBody>() {\n \n-    override fun map(cardAndPayerCost: Pair<Card, PayerCost>): RemediesBody {\n-        val (card, payerCost) = cardAndPayerCost\n-        val payerPaymentMethodRejected = PayerPaymentMethodRejected(payerCost.installments,\n-            card.issuer?.name ?: \"\", card.lastFourDigits.orEmpty(), card.paymentMethod.id, card.securityCodeLength,\n-            card.securityCodeLocation, payerCost.totalAmount)\n+    override fun map(data: PaymentData): RemediesBody {\n+        val securityCodeLocation = userSelectionRepository.card?.securityCodeLocation", "originalCommit": "ffcc7f24ca3903c7fe204edbc2a887ddfd66889c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjMyNDAzMw==", "url": "https://github.com/mercadopago/px-android/pull/2087#discussion_r402324033", "bodyText": "Por que usamos View.inflate()?", "author": "jorGonzalez291292", "createdAt": "2020-04-02T13:44:36Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/payment_result/remedies/view/PaymentResultFooter.kt", "diffHunk": "@@ -0,0 +1,78 @@\n+package com.mercadopago.android.px.internal.features.payment_result.remedies.view\n+\n+import android.content.Context\n+import android.os.Parcel\n+import android.os.Parcelable\n+import android.support.v4.content.ContextCompat\n+import android.util.AttributeSet\n+import android.view.View\n+import android.widget.LinearLayout\n+import com.mercadolibre.android.ui.widgets.MeliButton\n+import com.mercadopago.android.px.R\n+import com.mercadopago.android.px.internal.features.payment_result.remedies.RemedyButton\n+\n+internal class PaymentResultFooter(context: Context, attrs: AttributeSet?, defStyleAttr: Int) :\n+    LinearLayout(context, attrs, defStyleAttr) {\n+\n+    init {\n+        configureView(context)\n+    }\n+\n+    constructor(context: Context, attrs: AttributeSet?) : this(context, attrs, 0)\n+    constructor(context: Context) : this(context, null)\n+\n+    private lateinit var loudButton: MeliButton\n+    private lateinit var quietButton: MeliButton\n+    private lateinit var payButtonContainer: View\n+\n+    private fun configureView(context: Context) {\n+        orientation = VERTICAL\n+        View.inflate(context, R.layout.px_payment_result_footer, this)", "originalCommit": "ffcc7f24ca3903c7fe204edbc2a887ddfd66889c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjMyNTI0OA==", "url": "https://github.com/mercadopago/px-android/pull/2087#discussion_r402325248", "bodyText": "ac\u00e1 podes usar el with(button)", "author": "jorGonzalez291292", "createdAt": "2020-04-02T13:46:15Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/payment_result/remedies/view/PaymentResultFooter.kt", "diffHunk": "@@ -0,0 +1,78 @@\n+package com.mercadopago.android.px.internal.features.payment_result.remedies.view\n+\n+import android.content.Context\n+import android.os.Parcel\n+import android.os.Parcelable\n+import android.support.v4.content.ContextCompat\n+import android.util.AttributeSet\n+import android.view.View\n+import android.widget.LinearLayout\n+import com.mercadolibre.android.ui.widgets.MeliButton\n+import com.mercadopago.android.px.R\n+import com.mercadopago.android.px.internal.features.payment_result.remedies.RemedyButton\n+\n+internal class PaymentResultFooter(context: Context, attrs: AttributeSet?, defStyleAttr: Int) :\n+    LinearLayout(context, attrs, defStyleAttr) {\n+\n+    init {\n+        configureView(context)\n+    }\n+\n+    constructor(context: Context, attrs: AttributeSet?) : this(context, attrs, 0)\n+    constructor(context: Context) : this(context, null)\n+\n+    private lateinit var loudButton: MeliButton\n+    private lateinit var quietButton: MeliButton\n+    private lateinit var payButtonContainer: View\n+\n+    private fun configureView(context: Context) {\n+        orientation = VERTICAL\n+        View.inflate(context, R.layout.px_payment_result_footer, this)\n+        loudButton = findViewById(R.id.action_loud)\n+        quietButton = findViewById<MeliButton>(R.id.action_quiet).apply {\n+            background = ContextCompat.getDrawable(context, R.drawable.px_quiet_button_selector)\n+            text = resources.getString(R.string.px_change_payment)\n+        }\n+        payButtonContainer = findViewById(R.id.pay_button)\n+    }\n+\n+    fun init(model: Model, listener: Listener) {\n+        applyButtonConfig(loudButton, model.loudButton, listener::onLoudButtonClicked)\n+        applyButtonConfig(quietButton, model.quietButton, listener::onQuietButtonClicked)\n+        payButtonContainer.visibility = if (model.showPayButton) View.VISIBLE else View.GONE\n+    }\n+\n+    private fun applyButtonConfig(button: MeliButton, buttonModel: RemedyButton?,\n+        listener: (action: RemedyButton.Action) -> Unit) {\n+        buttonModel?.let {model ->\n+            button.visibility = View.VISIBLE", "originalCommit": "ffcc7f24ca3903c7fe204edbc2a887ddfd66889c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjMyNjAxMg==", "url": "https://github.com/mercadopago/px-android/pull/2087#discussion_r402326012", "bodyText": "Que es esto de TODO()?", "author": "jorGonzalez291292", "createdAt": "2020-04-02T13:47:17Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/payment_result/remedies/RemediesViewModel.kt", "diffHunk": "@@ -69,6 +73,16 @@ internal class RemediesViewModel(\n             })\n     }\n \n+    override fun onButtonPressed(action: RemedyButton.Action) {\n+        when(action) {\n+            RemedyButton.Action.CHANGE_PM -> remedyState.value = RemedyState.ChangePaymentMethod\n+            RemedyButton.Action.KYC -> remediesModel.highRiskRemedyModel?.let {\n+                remedyState.value = RemedyState.GoToKyc(it.deepLink)\n+            }\n+            else -> TODO()", "originalCommit": "ffcc7f24ca3903c7fe204edbc2a887ddfd66889c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM3Mzc0MQ==", "url": "https://github.com/mercadopago/px-android/pull/2087#discussion_r402373741", "bodyText": "Una funci\u00f3n falopa de Kotlin que descubr\u00ed el otro d\u00eda sin querer, que es como el comentario de TODO pero encima crashea (?)", "author": "guchito9", "createdAt": "2020-04-02T14:49:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjMyNjAxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjMyNzYxNg==", "url": "https://github.com/mercadopago/px-android/pull/2087#discussion_r402327616", "bodyText": "ac\u00e1 podemos usar el with(data)", "author": "jorGonzalez291292", "createdAt": "2020-04-02T13:49:23Z", "path": "px-checkout/src/main/java/com/mercadopago/android/px/internal/features/payment_result/remedies/RemediesBodyMapper.kt", "diffHunk": "@@ -1,18 +1,19 @@\n package com.mercadopago.android.px.internal.features.payment_result.remedies\n \n+import com.mercadopago.android.px.internal.repository.UserSelectionRepository\n import com.mercadopago.android.px.internal.viewmodel.mappers.Mapper\n-import com.mercadopago.android.px.model.Card\n-import com.mercadopago.android.px.model.PayerCost\n+import com.mercadopago.android.px.model.PaymentData\n import com.mercadopago.android.px.model.internal.remedies.PayerPaymentMethodRejected\n import com.mercadopago.android.px.model.internal.remedies.RemediesBody\n \n-internal class RemediesBodyMapper : Mapper<Pair<Card, PayerCost>, RemediesBody>() {\n+internal class RemediesBodyMapper(private val userSelectionRepository: UserSelectionRepository)\n+    : Mapper<PaymentData, RemediesBody>() {\n \n-    override fun map(cardAndPayerCost: Pair<Card, PayerCost>): RemediesBody {\n-        val (card, payerCost) = cardAndPayerCost\n-        val payerPaymentMethodRejected = PayerPaymentMethodRejected(payerCost.installments,\n-            card.issuer?.name ?: \"\", card.lastFourDigits.orEmpty(), card.paymentMethod.id, card.securityCodeLength,\n-            card.securityCodeLocation, payerCost.totalAmount)\n+    override fun map(data: PaymentData): RemediesBody {\n+        val securityCodeLocation = userSelectionRepository.card?.securityCodeLocation\n+        val payerPaymentMethodRejected = PayerPaymentMethodRejected(data.payerCost?.installments,\n+            data.issuer?.name, data.token?.lastFourDigits, data.paymentMethod.id, data.paymentMethod.paymentTypeId,", "originalCommit": "ffcc7f24ca3903c7fe204edbc2a887ddfd66889c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM3NDcxNg==", "url": "https://github.com/mercadopago/px-android/pull/2087#discussion_r402374716", "bodyText": "Ten\u00e9s raz\u00f3n, no lo tengo muy en cuenta el with", "author": "guchito9", "createdAt": "2020-04-02T14:50:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjMyNzYxNg=="}], "type": "inlineReview"}, {"oid": "de64bd3951bef5f16a085a67de97e78fe9048cd4", "url": "https://github.com/mercadopago/px-android/commit/de64bd3951bef5f16a085a67de97e78fe9048cd4", "message": "Added high risk remedy", "committedDate": "2020-04-02T15:38:23Z", "type": "commit"}, {"oid": "de64bd3951bef5f16a085a67de97e78fe9048cd4", "url": "https://github.com/mercadopago/px-android/commit/de64bd3951bef5f16a085a67de97e78fe9048cd4", "message": "Added high risk remedy", "committedDate": "2020-04-02T15:38:23Z", "type": "forcePushed"}]}