{"pr_number": 1876, "pr_title": "Task/new postgresql datamodels", "pr_createdAt": "2020-05-26T10:52:40Z", "pr_url": "https://github.com/telefonicaid/fiware-cygnus/pull/1876", "timeline": [{"oid": "a5ce5f7acb155dafdfd5eabfbab1ffe5f8bf3f81", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/a5ce5f7acb155dafdfd5eabfbab1ffe5f8bf3f81", "message": "add tests", "committedDate": "2020-05-26T09:33:14Z", "type": "commit"}, {"oid": "509fcc35b283e8d7567ab42218143472c4f5adc1", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/509fcc35b283e8d7567ab42218143472c4f5adc1", "message": "add new datamodels to postgresql sink", "committedDate": "2020-05-26T09:33:35Z", "type": "commit"}, {"oid": "dcab20d12127e6f11407364f2295f7de0f5f6df4", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/dcab20d12127e6f11407364f2295f7de0f5f6df4", "message": "code clean for postgis sink", "committedDate": "2020-05-26T09:34:00Z", "type": "commit"}, {"oid": "d65a9dde13ab9f9bcd8a8409e88c0480710fe7b1", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/d65a9dde13ab9f9bcd8a8409e88c0480710fe7b1", "message": "remove postgis documentation to refer to new postgresql docs", "committedDate": "2020-05-26T09:58:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY2MzEyNw==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1876#discussion_r431663127", "bodyText": "I guess the following entry in CNR\n\n[cygnus-ngsi][PostgisSQLSink] Add dm-by-entity-database and dm-by-entity-database-schema\n\nshould be modiffied to\n\n[cygnus-ngsi][PostgresqlSink][PostgisSQLSink] Add dm-by-entity-database and dm-by-entity-database-schema", "author": "fgalan", "createdAt": "2020-05-28T08:21:00Z", "path": "cygnus-ngsi/src/main/java/com/telefonica/iot/cygnus/sinks/NGSIPostgisSink.java", "diffHunk": "@@ -314,7 +314,6 @@ void persistBatch(NGSIBatch batch)\n             aggregator.setEntityForNaming(events.get(0).getEntityForNaming(enableGrouping, enableNameMappings, enableEncoding));", "originalCommit": "d65a9dde13ab9f9bcd8a8409e88c0480710fe7b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg4NDg5NQ==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1876#discussion_r431884895", "bodyText": "Fixed in d7cf20a", "author": "IvanHdzC", "createdAt": "2020-05-28T14:35:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY2MzEyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY3MDgxNg==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1876#discussion_r431670816", "bodyText": "Both bullets seems to be the same... is that correct?", "author": "fgalan", "createdAt": "2020-05-28T08:33:40Z", "path": "doc/cygnus-ngsi/flume_extensions_catalogue/ngsi_postgresql_sink.md", "diffHunk": "@@ -57,22 +57,37 @@ It must be said [PostgreSQL only accepts](https://www.postgresql.org/docs/curren\n \n PostgreSQL [databases name length](http://www.postgresql.org/docs/current/static/sql-syntax-lexical.html#SQL-SYNTAX-IDENTIFIERS) is limited to 63 characters.\n \n+Since version 2.2.0 It's added a new capability for Cygnus to create the schema name on runtime, this is possible trough enabling a specific Data Model on agent properties. That works the following way.\n+\n+* Data model by entity database (`data_model=dm-by-entity-database`). For this datamodel the name of the database will be auto generated by the sink, this name will be the `fiware-service` found on the headers of the first request incoming to the sink.\n+* Data model by entity database schema (`data_model=dm-by-entity-database-schema`). For this datamodel the name of the database will be auto generated by the sink, this name will be the `fiware-service` found on the headers of the first request incoming to the sink.", "originalCommit": "d65a9dde13ab9f9bcd8a8409e88c0480710fe7b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY3NDgyNQ==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1876#discussion_r431674825", "bodyText": "Moreover... currently there is a configuration parameter in postgis/postgresql sink to specify the database. What happens in this case? The configuration setting is ignored? The behaviour be specified in the documentation (both in this section and in the database parameter in the configuration table)", "author": "fgalan", "createdAt": "2020-05-28T08:40:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY3MDgxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg4NzU4Nw==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1876#discussion_r431887587", "bodyText": "It was on purpose that those bullets to be the same because for now they do the same.\nAbout the second comment.\nFixed in 9bcedc4", "author": "IvanHdzC", "createdAt": "2020-05-28T14:37:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY3MDgxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY3MTQ0Mg==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1876#discussion_r431671442", "bodyText": "It seems to be duplicated in lines L70-71. Maybe L70-71 should be removed?", "author": "fgalan", "createdAt": "2020-05-28T08:34:42Z", "path": "doc/cygnus-ngsi/flume_extensions_catalogue/ngsi_postgresql_sink.md", "diffHunk": "@@ -57,22 +57,37 @@ It must be said [PostgreSQL only accepts](https://www.postgresql.org/docs/curren\n \n PostgreSQL [databases name length](http://www.postgresql.org/docs/current/static/sql-syntax-lexical.html#SQL-SYNTAX-IDENTIFIERS) is limited to 63 characters.\n \n+Since version 2.2.0 It's added a new capability for Cygnus to create the schema name on runtime, this is possible trough enabling a specific Data Model on agent properties. That works the following way.\n+\n+* Data model by entity database (`data_model=dm-by-entity-database`). For this datamodel the name of the database will be auto generated by the sink, this name will be the `fiware-service` found on the headers of the first request incoming to the sink.\n+* Data model by entity database schema (`data_model=dm-by-entity-database-schema`). For this datamodel the name of the database will be auto generated by the sink, this name will be the `fiware-service` found on the headers of the first request incoming to the sink.\n+\n [Top](#top)\n \n #### <a name=\"section1.2.2\"></a>PostgreSQL schemas naming conventions\n A schema named as the notified `fiware-service` header value (or, in absence of such a header, the defaulted value for the FIWARE service) is created (if not existing yet).\n \n+* Data model by entity database schema (`data_model=dm-by-entity-database-schema`). For this datamodel the name of the schema will be auto generated by the sink, this name will be the `fiware-servicePath` found on the headers of the first request to store.\n+\n It must be said [PostgreSQL only accepts](https://www.postgresql.org/docs/current/static/sql-syntax-lexical.html#SQL-SYNTAX-IDENTIFIERS) alphanumeric characters and the underscore (`_`). This leads to  certain [encoding](#section2.3.4) is applied depending on the `enable_encoding` configuration parameter.\n \n PostgreSQL [schemas name length](http://www.postgresql.org/docs/current/static/sql-syntax-lexical.html#SQL-SYNTAX-IDENTIFIERS) is limited to 63 characters.\n \n+Since version 2.2.0 Cygnus creates the name of the schema name on runtime according to the selected DataModel for the sink.\n+\n+* Data model by entity database schema (`data_model=dm-by-entity-database-schema`). For this datamodel the name of the schema will be auto generated by the sink, this name will be the `fiware-servicePath` found on the headers of the first request to store.", "originalCommit": "d65a9dde13ab9f9bcd8a8409e88c0480710fe7b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg4ODA5NA==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1876#discussion_r431888094", "bodyText": "Fixed in 9bcedc4", "author": "IvanHdzC", "createdAt": "2020-05-28T14:38:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY3MTQ0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY3MjY0Ng==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1876#discussion_r431672646", "bodyText": "The data_model= maybe should be removed?", "author": "fgalan", "createdAt": "2020-05-28T08:36:42Z", "path": "doc/cygnus-ngsi/flume_extensions_catalogue/ngsi_postgresql_sink.md", "diffHunk": "@@ -81,14 +96,14 @@ PostgreSQL [tables name length](http://www.postgresql.org/docs/current/static/sq\n \n The following table summarizes the table name composition (old encoding):\n \n-| FIWARE service path | `dm-by-service-path` | `dm-by-entity` | `dm-by-entity-type` |\n+| FIWARE service path | `dm-by-service-path` | `dm-by-entity`, `data_model=dm-by-entity-database-schema`, `data_model=dm-by-entity-database` | `dm-by-entity-type` |\n |---|---|---|---|\n | `/` | N/A | `<entityId>_<entityType>` | `<entityType>` |\n | `/<svcPath>` | `<svcPath>` | `<svcPath>_<entityId>_<entityType>` | `<svcPath>_<entityType>` |\n \n Using the new encoding:\n \n-| FIWARE service path | `dm-by-service-path` | `dm-by-entity` | `dm-by-entity-type` |\n+| FIWARE service path | `dm-by-service-path` | `dm-by-entity`, `data_model=dm-by-entity-database-schema`, `data_model=dm-by-entity-database` | `dm-by-entity-type` |", "originalCommit": "d65a9dde13ab9f9bcd8a8409e88c0480710fe7b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg4ODE4Mg==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1876#discussion_r431888182", "bodyText": "Fixed in 9bcedc4", "author": "IvanHdzC", "createdAt": "2020-05-28T14:38:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY3MjY0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY3Mjg4MQ==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1876#discussion_r431672881", "bodyText": "The data_model= maybe should be removed?", "author": "fgalan", "createdAt": "2020-05-28T08:37:05Z", "path": "doc/cygnus-ngsi/flume_extensions_catalogue/ngsi_postgresql_sink.md", "diffHunk": "@@ -81,14 +96,14 @@ PostgreSQL [tables name length](http://www.postgresql.org/docs/current/static/sq\n \n The following table summarizes the table name composition (old encoding):\n \n-| FIWARE service path | `dm-by-service-path` | `dm-by-entity` | `dm-by-entity-type` |\n+| FIWARE service path | `dm-by-service-path` | `dm-by-entity`, `data_model=dm-by-entity-database-schema`, `data_model=dm-by-entity-database` | `dm-by-entity-type` |", "originalCommit": "d65a9dde13ab9f9bcd8a8409e88c0480710fe7b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg4ODI0MQ==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1876#discussion_r431888241", "bodyText": "Fixed in 9bcedc4 and 8b2cd22", "author": "IvanHdzC", "createdAt": "2020-05-28T14:38:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY3Mjg4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY4NDUzOQ==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1876#discussion_r431684539", "bodyText": "I would expect a else case with a warn log about dbname is null, make sense?", "author": "AlvaroVega", "createdAt": "2020-05-28T08:56:27Z", "path": "cygnus-ngsi/src/main/java/com/telefonica/iot/cygnus/sinks/NGSIPostgreSQLSink.java", "diffHunk": "@@ -254,7 +254,9 @@ public void configure(Context context) {\n     @Override\n     public void start() {\n         try {\n-            createPersistenceBackend(postgresqlHost, postgresqlPort, postgresqlUsername, postgresqlPassword, maxPoolSize, postgresqlDatabase, postgresqlOptions);\n+            if (buildDBName(null) != null) {", "originalCommit": "d65a9dde13ab9f9bcd8a8409e88c0480710fe7b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg5MDA5MA==", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1876#discussion_r431890090", "bodyText": "I agree that there must be some mention that the sql backend will not be generated on startup as usual, but I wasn't sure of how lo log it. Please checkout the text I used.\n\"The database name will be created on runtime, so if there is an specified database on the agent properties and you expect it to be read on startup, then you shoul look for the data model you are using. Maybe it's not the correct one\"", "author": "IvanHdzC", "createdAt": "2020-05-28T14:40:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY4NDUzOQ=="}], "type": "inlineReview"}, {"oid": "d7cf20a4544987e1d98ea28c2147c7c0630df9a7", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/d7cf20a4544987e1d98ea28c2147c7c0630df9a7", "message": "update CNR entry", "committedDate": "2020-05-28T14:26:43Z", "type": "commit"}, {"oid": "9bcedc4805e6b3e4e48b7e5a357e18931cd62a0a", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/9bcedc4805e6b3e4e48b7e5a357e18931cd62a0a", "message": "update docs", "committedDate": "2020-05-28T14:30:38Z", "type": "commit"}, {"oid": "84e286ec4d742ba729bf510e7711ecc58e8b2f24", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/84e286ec4d742ba729bf510e7711ecc58e8b2f24", "message": "add log in case the sql backend object is not created on startup", "committedDate": "2020-05-28T14:34:31Z", "type": "commit"}, {"oid": "bf2b4499ddeb68f94956e643ae097aaf293238f9", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/bf2b4499ddeb68f94956e643ae097aaf293238f9", "message": "Merge branch 'master' into task/new_postgresql_datamodels", "committedDate": "2020-05-28T14:41:52Z", "type": "commit"}, {"oid": "8be42b1177c57550a0650546035f4b28c0133974", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/8be42b1177c57550a0650546035f4b28c0133974", "message": "Merge branch 'master' into task/new_postgresql_datamodels", "committedDate": "2020-05-29T10:47:27Z", "type": "commit"}, {"oid": "8b2cd22b9b464b6997be34f028af7d7b832ba327", "url": "https://github.com/telefonicaid/fiware-cygnus/commit/8b2cd22b9b464b6997be34f028af7d7b832ba327", "message": "update docs", "committedDate": "2020-05-29T11:30:13Z", "type": "commit"}]}