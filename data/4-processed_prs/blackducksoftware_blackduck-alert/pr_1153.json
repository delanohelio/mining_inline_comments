{"pr_number": 1153, "pr_title": "Ps custom endpoint actions", "pr_createdAt": "2020-09-02T16:09:08Z", "pr_url": "https://github.com/blackducksoftware/blackduck-alert/pull/1153", "timeline": [{"oid": "814624bdea0ef4760408270189d3add5d552ce2b", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/814624bdea0ef4760408270189d3add5d552ce2b", "message": "feat: Implement action result with custom endpoints.", "committedDate": "2020-09-01T20:08:38Z", "type": "commit"}, {"oid": "3def3fc2b284b9dd7e24307533b8627338e606b2", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/3def3fc2b284b9dd7e24307533b8627338e606b2", "message": "refactor: Fix the endpoints to use ActionResult.", "committedDate": "2020-09-02T13:55:14Z", "type": "commit"}, {"oid": "507990affe2c28be1136ec9be54c5b4874fe11a8", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/507990affe2c28be1136ec9be54c5b4874fe11a8", "message": "refactor: Remove unused class.", "committedDate": "2020-09-02T15:04:27Z", "type": "commit"}, {"oid": "99cd70c8b26341b4fbe7d3be5b702df264cc109b", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/99cd70c8b26341b4fbe7d3be5b702df264cc109b", "message": "refactor: Clean up some code smells.", "committedDate": "2020-09-02T15:32:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjIxNjE4MA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1153#discussion_r482216180", "bodyText": "I think these methods could be shortened to a single return line", "author": "bamandel", "createdAt": "2020-09-02T16:49:00Z", "path": "alert-common/src/main/java/com/synopsys/integration/alert/common/action/ActionResult.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/**\n+ * alert-common\n+ *\n+ * Copyright (c) 2020 Synopsys, Inc.\n+ *\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.synopsys.integration.alert.common.action;\n+\n+import java.util.Optional;\n+\n+import javax.annotation.Nullable;\n+import javax.validation.constraints.NotNull;\n+\n+import org.springframework.http.HttpStatus;\n+\n+public class ActionResult<T> {\n+    private HttpStatus httpStatus;\n+    private String message;\n+    private T content;\n+\n+    public ActionResult(@NotNull HttpStatus httpStatus) {\n+        this(httpStatus, null, null);\n+    }\n+\n+    public ActionResult(@NotNull HttpStatus httpStatus, @Nullable String message) {\n+        this(httpStatus, message, null);\n+    }\n+\n+    public ActionResult(@NotNull HttpStatus httpStatus, @Nullable T content) {\n+        this(httpStatus, null, content);\n+    }\n+\n+    public ActionResult(@NotNull HttpStatus httpStatus, @Nullable String message, @Nullable T content) {\n+        this.httpStatus = httpStatus;\n+        this.content = content;\n+        this.message = message;\n+    }\n+\n+    public boolean isOk() {\n+        if (null == httpStatus) {\n+            return false;\n+        }\n+        return httpStatus.is2xxSuccessful();\n+    }\n+\n+    public boolean isError() {\n+        if (null == httpStatus) {\n+            return false;\n+        }\n+        return httpStatus.isError();\n+    }", "originalCommit": "99cd70c8b26341b4fbe7d3be5b702df264cc109b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjIyMTY4Nw==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1153#discussion_r482221687", "bodyText": "Ok implies 200 IMO, I would prefer we call this isSuccessful instead.", "author": "gkillough", "createdAt": "2020-09-02T16:57:25Z", "path": "alert-common/src/main/java/com/synopsys/integration/alert/common/action/ActionResult.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/**\n+ * alert-common\n+ *\n+ * Copyright (c) 2020 Synopsys, Inc.\n+ *\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.synopsys.integration.alert.common.action;\n+\n+import java.util.Optional;\n+\n+import javax.annotation.Nullable;\n+import javax.validation.constraints.NotNull;\n+\n+import org.springframework.http.HttpStatus;\n+\n+public class ActionResult<T> {\n+    private HttpStatus httpStatus;\n+    private String message;\n+    private T content;\n+\n+    public ActionResult(@NotNull HttpStatus httpStatus) {\n+        this(httpStatus, null, null);\n+    }\n+\n+    public ActionResult(@NotNull HttpStatus httpStatus, @Nullable String message) {\n+        this(httpStatus, message, null);\n+    }\n+\n+    public ActionResult(@NotNull HttpStatus httpStatus, @Nullable T content) {\n+        this(httpStatus, null, content);\n+    }\n+\n+    public ActionResult(@NotNull HttpStatus httpStatus, @Nullable String message, @Nullable T content) {\n+        this.httpStatus = httpStatus;\n+        this.content = content;\n+        this.message = message;\n+    }\n+\n+    public boolean isOk() {", "originalCommit": "99cd70c8b26341b4fbe7d3be5b702df264cc109b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjIyMjk2Mw==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1153#discussion_r482222963", "bodyText": "Would it be better to give ActionResult a method that would convert itself into a ResponseEntity? At least these basic conversions? Or is that making ActionResult do too much?", "author": "bamandel", "createdAt": "2020-09-02T16:59:25Z", "path": "alert-common/src/main/java/com/synopsys/integration/alert/common/rest/ResponseFactory.java", "diffHunk": "@@ -167,4 +168,13 @@ public static ResponseStatusException createNotImplementedException(@Nullable St\n         return new ResponseEntity<>(header, HttpStatus.FOUND);\n     }\n \n+    public <T> ResponseEntity<T> createResponseFromAction(ActionResult<T> actionResult) {", "originalCommit": "99cd70c8b26341b4fbe7d3be5b702df264cc109b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjIzNjUyOA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1153#discussion_r482236528", "bodyText": "I think that would be making ActionResult do too much.  We may want to convert it differently.", "author": "psantos1113", "createdAt": "2020-09-02T17:15:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjIyMjk2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjIyNTg5Nw==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1153#discussion_r482225897", "bodyText": "If we add the conversion to ActionResult, this could all be handled in a methodin ActionResult.", "author": "bamandel", "createdAt": "2020-09-02T17:04:03Z", "path": "src/main/java/com/synopsys/integration/alert/web/api/custom/CustomEndpointController.java", "diffHunk": "@@ -66,7 +70,18 @@ public CustomEndpointController(CustomEndpointManager customEndpointManager, Res\n         }\n \n         HttpServletContentWrapper servletContentWrapper = new HttpServletContentWrapper(httpRequest, httpResponse);\n-        return customEndpointManager.performFunction(key, restModel, servletContentWrapper);\n+        ActionResult<?> result = customEndpointManager.performFunction(key, restModel, servletContentWrapper);\n+        if (result.isOk()) {\n+            if (result.hasContent()) {\n+                String content = gson.toJson(result.getContent().get());\n+                return responseFactory.createOkContentResponse(content);\n+            } else {\n+                String message = result.getMessage().orElse(\"\");\n+                return responseFactory.createOkResponse(\"\", message);\n+            }\n+        } else {\n+            String message = result.getMessage().orElse(\"\");\n+            return responseFactory.createResponse(result.getHttpStatus(), null, message);\n+        }", "originalCommit": "99cd70c8b26341b4fbe7d3be5b702df264cc109b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjIyOTAzNQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1153#discussion_r482229035", "bodyText": "Why isn't this the content of ActionResult? It seems like it would probably be better to update ValidationResponseModel and make this ActionResult<ValidationResponseModel> instead.", "author": "gkillough", "createdAt": "2020-09-02T17:08:01Z", "path": "alert-common/src/main/java/com/synopsys/integration/alert/common/action/ValidationActionResult.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/**\n+ * alert-common\n+ *\n+ * Copyright (c) 2020 Synopsys, Inc.\n+ *\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.synopsys.integration.alert.common.action;\n+\n+import java.util.List;\n+\n+import org.springframework.http.HttpStatus;\n+\n+import com.synopsys.integration.alert.common.descriptor.config.field.errors.AlertFieldStatus;\n+\n+public class ValidationActionResult extends ActionResult<Void> {\n+    private List<AlertFieldStatus> fieldStatusList;", "originalCommit": "99cd70c8b26341b4fbe7d3be5b702df264cc109b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjIzNDM5Mg==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1153#discussion_r482234392", "bodyText": "This code makes me think we still have a long way to go on this problem. Perhaps this is out of scope for this PR, but I think we should get rid of this class entirely and CustomEndpointManager. Instead, we should find a way to have an abstract controller that handles the explicit typing of responses. Then all of the custom endpoints that exist would not have the extra registration step, and could just extend that controller and implement a single abstract method while strongly typing the controller.", "author": "gkillough", "createdAt": "2020-09-02T17:13:07Z", "path": "src/main/java/com/synopsys/integration/alert/web/api/custom/CustomEndpointController.java", "diffHunk": "@@ -66,7 +70,18 @@ public CustomEndpointController(CustomEndpointManager customEndpointManager, Res\n         }\n \n         HttpServletContentWrapper servletContentWrapper = new HttpServletContentWrapper(httpRequest, httpResponse);\n-        return customEndpointManager.performFunction(key, restModel, servletContentWrapper);\n+        ActionResult<?> result = customEndpointManager.performFunction(key, restModel, servletContentWrapper);\n+        if (result.isOk()) {\n+            if (result.hasContent()) {\n+                String content = gson.toJson(result.getContent().get());\n+                return responseFactory.createOkContentResponse(content);\n+            } else {\n+                String message = result.getMessage().orElse(\"\");\n+                return responseFactory.createOkResponse(\"\", message);\n+            }\n+        } else {\n+            String message = result.getMessage().orElse(\"\");\n+            return responseFactory.createResponse(result.getHttpStatus(), null, message);\n+        }", "originalCommit": "99cd70c8b26341b4fbe7d3be5b702df264cc109b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI0MDIyMg==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1153#discussion_r482240222", "bodyText": "This is just the first step and low hanging fruit to start implementing and changing the code.  Ultimately what I would like is similar to what you suggest.  I'm simply starting the process.  I actually need to change the branch to the feature branch because I have a feature branch where these changes will go.", "author": "psantos1113", "createdAt": "2020-09-02T17:22:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjIzNDM5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI0NDI2MA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1153#discussion_r482244260", "bodyText": "If the code is completely working, I would say skip the feature branch. I think we could all benefit from having the ActionResult object ASAP so that we don't need to add more tech-debt around this.\nThen I think a fast-follow MR fixing custom endpoints would be beneficial.", "author": "gkillough", "createdAt": "2020-09-02T17:29:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjIzNDM5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI0MDE4MQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1153#discussion_r482240181", "bodyText": "I think OAuthEndpointResponse also tracks a status code. We should either get rid of that, or pass it through to be converted to an HttpStatus.", "author": "gkillough", "createdAt": "2020-09-02T17:22:01Z", "path": "alert-common/src/main/java/com/synopsys/integration/alert/common/descriptor/config/field/endpoint/oauth/OAuthCustomEndpoint.java", "diffHunk": "@@ -22,31 +22,25 @@\n  */\n package com.synopsys.integration.alert.common.descriptor.config.field.endpoint.oauth;\n \n-import org.springframework.http.ResponseEntity;\n+import org.springframework.http.HttpStatus;\n \n-import com.google.gson.Gson;\n+import com.synopsys.integration.alert.common.action.ActionResult;\n import com.synopsys.integration.alert.common.action.CustomEndpointManager;\n import com.synopsys.integration.alert.common.descriptor.config.field.endpoint.CustomEndpoint;\n import com.synopsys.integration.alert.common.exception.AlertException;\n import com.synopsys.integration.alert.common.rest.HttpServletContentWrapper;\n-import com.synopsys.integration.alert.common.rest.ResponseFactory;\n import com.synopsys.integration.alert.common.rest.model.FieldModel;\n \n-public abstract class OAuthCustomEndpoint extends CustomEndpoint<String> {\n-    public ResponseFactory responseFactory;\n-    public Gson gson;\n-\n-    public OAuthCustomEndpoint(String fieldKey, CustomEndpointManager customEndpointManager, ResponseFactory responseFactory, Gson gson) throws AlertException {\n+public abstract class OAuthCustomEndpoint extends CustomEndpoint<OAuthEndpointResponse> {\n+    public OAuthCustomEndpoint(String fieldKey, CustomEndpointManager customEndpointManager) throws AlertException {\n         super(fieldKey, customEndpointManager);\n-        this.responseFactory = responseFactory;\n-        this.gson = gson;\n     }\n \n     protected abstract OAuthEndpointResponse createOAuthResponse(FieldModel fieldModel, HttpServletContentWrapper servletContentWrapper);\n \n     @Override\n-    public ResponseEntity<String> createResponse(FieldModel fieldModel, HttpServletContentWrapper servletContentWrapper) {\n+    public ActionResult<OAuthEndpointResponse> createResponse(FieldModel fieldModel, HttpServletContentWrapper servletContentWrapper) {", "originalCommit": "99cd70c8b26341b4fbe7d3be5b702df264cc109b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "42590c60b2986c7b2b27caae549671d2290b31e1", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/42590c60b2986c7b2b27caae549671d2290b31e1", "message": "refactor: Updates based on PR feedback.", "committedDate": "2020-09-02T17:52:00Z", "type": "commit"}, {"oid": "f83b1216193684482d7533508e8a409329c4fe10", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/f83b1216193684482d7533508e8a409329c4fe10", "message": "Merge remote-tracking branch 'origin/feat_action_response' into ps_custom_endpoint_actions", "committedDate": "2020-09-02T17:55:59Z", "type": "commit"}, {"oid": "5bdddb545c0b2e0f120f5dbd46990b2af9f215d3", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/5bdddb545c0b2e0f120f5dbd46990b2af9f215d3", "message": "refactor: Implement OAuth endpoint changes.", "committedDate": "2020-09-02T18:35:05Z", "type": "commit"}]}