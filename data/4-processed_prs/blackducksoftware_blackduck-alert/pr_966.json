{"pr_number": 966, "pr_title": "helm alertdb", "pr_createdAt": "2020-04-29T19:51:23Z", "pr_url": "https://github.com/blackducksoftware/blackduck-alert/pull/966", "timeline": [{"oid": "ca99576a57e7b8cc7b1224ae91c3fdb15d3c7442", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/ca99576a57e7b8cc7b1224ae91c3fdb15d3c7442", "message": "refactor: Allow a database connection through environment variables.", "committedDate": "2020-04-23T17:05:47Z", "type": "commit"}, {"oid": "9c75c5b8251d63ea4da2cad93d36ba5baecd4f03", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/9c75c5b8251d63ea4da2cad93d36ba5baecd4f03", "message": "refactor: Remove the environment variable for the database name.", "committedDate": "2020-04-23T17:09:54Z", "type": "commit"}, {"oid": "1027cb3448219e2a1d39b4c0c79109c1ddf89a63", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/1027cb3448219e2a1d39b4c0c79109c1ddf89a63", "message": "refactor: Create the database on startup of the alert container.", "committedDate": "2020-04-23T18:43:30Z", "type": "commit"}, {"oid": "96c3fe87be31d9ac8e59d4ca2e6e02eae1a38287", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/96c3fe87be31d9ac8e59d4ca2e6e02eae1a38287", "message": "refactor: Only create the database tables if the database has been created in postgres.", "committedDate": "2020-04-23T19:02:58Z", "type": "commit"}, {"oid": "cdefe953318844248d5e2bc859bd1fc0721024f8", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/cdefe953318844248d5e2bc859bd1fc0721024f8", "message": "refactor: Clean up the connection function.", "committedDate": "2020-04-23T19:36:11Z", "type": "commit"}, {"oid": "663d17d916cbed842040a8e4762e5accdd212a5f", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/663d17d916cbed842040a8e4762e5accdd212a5f", "message": "refactor: Fix why the container always exits.", "committedDate": "2020-04-23T20:11:28Z", "type": "commit"}, {"oid": "2f1f68d29c3e52e538fb45446c44e4f3a9f99f39", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/2f1f68d29c3e52e538fb45446c44e4f3a9f99f39", "message": "build: Update database image version.", "committedDate": "2020-04-24T10:37:45Z", "type": "commit"}, {"oid": "a6adefd0d72fab7ef8ecdc5aa6def31ee2d0ddc0", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/a6adefd0d72fab7ef8ecdc5aa6def31ee2d0ddc0", "message": "refactor: Use the correct variable for the database name.", "committedDate": "2020-04-24T11:27:19Z", "type": "commit"}, {"oid": "792e84c6a13c38dc1564ea38dc93912ab087ab0d", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/792e84c6a13c38dc1564ea38dc93912ab087ab0d", "message": "refactor: Add files to support external DB deployment.", "committedDate": "2020-04-24T13:45:04Z", "type": "commit"}, {"oid": "978d2947fb923ef32c72545f1012147dceed70f8", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/978d2947fb923ef32c72545f1012147dceed70f8", "message": "refactor: Remove default credentials from image.", "committedDate": "2020-04-24T14:03:45Z", "type": "commit"}, {"oid": "233389c0d6b1de149ca246b4b4f01e32bc718306", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/233389c0d6b1de149ca246b4b4f01e32bc718306", "message": "refactor: Resolve some issues with environment variables.", "committedDate": "2020-04-24T17:55:35Z", "type": "commit"}, {"oid": "0a4ece216889032cd7ba9249f691147c7a2196a6", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/0a4ece216889032cd7ba9249f691147c7a2196a6", "message": "Merge remote-tracking branch 'origin/master' into ps_helm_alertdb", "committedDate": "2020-04-24T17:57:09Z", "type": "commit"}, {"oid": "a4022e27d86df5be48fbe2daec084ae836948167", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/a4022e27d86df5be48fbe2daec084ae836948167", "message": "feat: Add the initial chart template for the database.", "committedDate": "2020-04-27T19:52:37Z", "type": "commit"}, {"oid": "ad15e96323b95deeeaa6774be5f164cc48671547", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/ad15e96323b95deeeaa6774be5f164cc48671547", "message": "refactor: Remove the envFrom causing duplicate keys.", "committedDate": "2020-04-28T14:05:19Z", "type": "commit"}, {"oid": "a1b62b0554c32b7a5834ce3bbc3ec596686d28a8", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/a1b62b0554c32b7a5834ce3bbc3ec596686d28a8", "message": "refactor: Add additional health check parameters.", "committedDate": "2020-04-28T14:08:58Z", "type": "commit"}, {"oid": "40ca68911b0b8d094ea7bb497a81abeafcc0dc61", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/40ca68911b0b8d094ea7bb497a81abeafcc0dc61", "message": "refactor: Fix spacing on port environment variable.", "committedDate": "2020-04-28T14:34:10Z", "type": "commit"}, {"oid": "9b6f656baadbac451fe4afed7e0ab87c2ef169f0", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/9b6f656baadbac451fe4afed7e0ab87c2ef169f0", "message": "refactor: Supply value to alertdb.host since it is required to pass the build.", "committedDate": "2020-04-28T14:44:29Z", "type": "commit"}, {"oid": "95b042e3600e3ade7f2ffc1bfd480974c7680bf2", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/95b042e3600e3ade7f2ffc1bfd480974c7680bf2", "message": "refactor: Fix the indent statements.", "committedDate": "2020-04-28T17:16:19Z", "type": "commit"}, {"oid": "3168591d0b455505785f2bc3bbd6ecfc63bededd", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/3168591d0b455505785f2bc3bbd6ecfc63bededd", "message": "feat: Changes to get the alert chart to start correctly.", "committedDate": "2020-04-28T19:43:48Z", "type": "commit"}, {"oid": "af075a8ec2ccf15b3295a84d7d6b1d1b9fbf5245", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/af075a8ec2ccf15b3295a84d7d6b1d1b9fbf5245", "message": "refactor: Fix the mount point for the database.", "committedDate": "2020-04-29T18:29:20Z", "type": "commit"}, {"oid": "4d79086ffa550b2ed4434e2ca1c3e2a7f8174b82", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/4d79086ffa550b2ed4434e2ca1c3e2a7f8174b82", "message": "Merge remote-tracking branch 'origin/master' into ps_helm_alertdb", "committedDate": "2020-04-29T19:08:20Z", "type": "commit"}, {"oid": "bb70c0e0b05757f5820424b61bc2133292758fee", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/bb70c0e0b05757f5820424b61bc2133292758fee", "message": "refactor: Make the last search migration more specific to a single config.", "committedDate": "2020-04-29T19:50:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzU4MzQzNQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/966#discussion_r417583435", "bodyText": "Perhaps a variable to store this value would be better since it's used in multiple locations and needs to be the same.", "author": "bamandel", "createdAt": "2020-04-29T20:14:13Z", "path": "build.gradle", "diffHunk": "@@ -216,8 +217,8 @@ task runServer(type: com.synopsys.integration.alert.build.RunServerTask, depends\n                                 '--spring.datasource.username=sa',\n                                 '--spring.datasource.password=blackduck',\n                                 '--spring.datasource.driver-class-name=org.testcontainers.jdbc.ContainerDatabaseDriver',\n-                                '--spring.datasource.url=jdbc:tc:postgresql:11.7:///alertdb?TC_INITSCRIPT=file:src/test/resources/testDatabase/init_test_db.sql&TC_TMPFS=/testtmpfs:rw',\n-                                '--spring.datasource.hikari.jdbc-url=jdbc:tc:postgresql:11.7:///alertdb?TC_INITSCRIPT=file:src/test/resources/testDatabase/init_test_db.sql&TC_TMPFS=/testtmpfs:rw',\n+                                '--spring.datasource.url=jdbc:tc:postgresql:12.2:///alertdb?TC_INITSCRIPT=file:src/test/resources/testDatabase/init_test_db.sql&TC_TMPFS=/testtmpfs:rw',\n+                                '--spring.datasource.hikari.jdbc-url=jdbc:tc:postgresql:12.2:///alertdb?TC_INITSCRIPT=file:src/test/resources/testDatabase/init_test_db.sql&TC_TMPFS=/testtmpfs:rw',", "originalCommit": "bb70c0e0b05757f5820424b61bc2133292758fee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzU4NjM5OA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/966#discussion_r417586398", "bodyText": "A brief comment about why this is relevant would help me here personally.", "author": "bamandel", "createdAt": "2020-04-29T20:19:39Z", "path": "docker-entrypoint.sh", "diffHunk": "@@ -329,12 +332,47 @@ liquibaseChangelockReset() {\n   echo \"End releasing liquibase changeloglock.\"\n }\n \n+validatePostgresConnection() {\n+  # https://stackoverflow.com/a/58784528/6921621", "originalCommit": "bb70c0e0b05757f5820424b61bc2133292758fee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk1NjY1Mw==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/966#discussion_r417956653", "bodyText": "The alert container can start up before the database container.  If we can't connect to the database don't start alert because the alert container needs to read and write data to/from the database.", "author": "psantos1113", "createdAt": "2020-04-30T11:58:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzU4NjM5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk3NDMwMQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/966#discussion_r417974301", "bodyText": "@psantos1113 I think he means a comment within the file.", "author": "gkillough", "createdAt": "2020-04-30T12:32:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzU4NjM5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzU4NjU5Mg==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/966#discussion_r417586592", "bodyText": "Same as above since it's the same link", "author": "bamandel", "createdAt": "2020-04-29T20:19:58Z", "path": "docker-entrypoint.sh", "diffHunk": "@@ -329,12 +332,47 @@ liquibaseChangelockReset() {\n   echo \"End releasing liquibase changeloglock.\"\n }\n \n+validatePostgresConnection() {\n+  # https://stackoverflow.com/a/58784528/6921621\n+    echo \"Checking for postgres connectivity: \"\n+    if psql \"${alertDatabaseConfig}\" -c '\\l';\n+    then\n+      echo \"Alert postgres database connection valid.\"\n+    else\n+      echo \"Alert postgres connection cannot be made.\"\n+      sleep 10\n+      exit 1\n+    fi\n+}\n+\n+createPostgresDatabase() {\n+  # https://stackoverflow.com/a/58784528/6921621", "originalCommit": "bb70c0e0b05757f5820424b61bc2133292758fee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk1NzU1Ng==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/966#discussion_r417957556", "bodyText": "If we have an external database we will check to see if the alert database tables have been created in that database.  If they haven't then create the initial table schema into postgres.", "author": "psantos1113", "createdAt": "2020-04-30T12:00:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzU4NjU5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc0ODQ4OA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/966#discussion_r417748488", "bodyText": "Instead of alertdb, can we have it as postgres?", "author": "msenmurugan", "createdAt": "2020-04-30T04:37:06Z", "path": "deployment/helm/synopsys-alert/values.yaml", "diffHunk": "@@ -41,6 +41,29 @@ cfssl:\n   securityContext: {}\n   podSecurityContext: {}\n \n+# alertdb - configurations for the alertdb Pod\n+alertdb:", "originalCommit": "bb70c0e0b05757f5820424b61bc2133292758fee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODAwNTc4OQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/966#discussion_r418005789", "bodyText": "Is there a problem with having this as alertdb? Is the name change just a preference?", "author": "jamesrichard91", "createdAt": "2020-04-30T13:23:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc0ODQ4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODAzOTk0NQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/966#discussion_r418039945", "bodyText": "@jamesrichard91 just to match with the container names, so that customers won't get confused.", "author": "msenmurugan", "createdAt": "2020-04-30T14:11:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc0ODQ4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc0OTUzNw==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/966#discussion_r417749537", "bodyText": "To all the names, can you please remove -alert? This is because already in synopsysctl we are taking care of adding -alert to the release name.\nAnd also the customer who uses Black Duck along with Alert, then need to mandatory add -alert to the release name in order to work. This is because you can't have 2 releases having same names for different apps in the same namespace.", "author": "msenmurugan", "createdAt": "2020-04-30T04:41:37Z", "path": "deployment/helm/synopsys-alert/templates/alertdb.yaml", "diffHunk": "@@ -0,0 +1,178 @@\n+{{- if not .Values.alertdb.isExternal }}\n+apiVersion: v1\n+kind: Service\n+metadata:\n+  labels:\n+    app: alert\n+    component: alertdb\n+  name: {{ .Release.Name }}-alert-postgres", "originalCommit": "bb70c0e0b05757f5820424b61bc2133292758fee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc0OTcxNw==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/966#discussion_r417749717", "bodyText": "To all the labels, can you please add name to the label?", "author": "msenmurugan", "createdAt": "2020-04-30T04:42:20Z", "path": "deployment/helm/synopsys-alert/templates/alertdb.yaml", "diffHunk": "@@ -0,0 +1,178 @@\n+{{- if not .Values.alertdb.isExternal }}\n+apiVersion: v1\n+kind: Service\n+metadata:\n+  labels:\n+    app: alert", "originalCommit": "bb70c0e0b05757f5820424b61bc2133292758fee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc1MDQ2MQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/966#discussion_r417750461", "bodyText": "can you please change the -D to point to /var/lib/postgresql/data", "author": "msenmurugan", "createdAt": "2020-04-30T04:45:20Z", "path": "deployment/helm/synopsys-alert/templates/alertdb.yaml", "diffHunk": "@@ -0,0 +1,178 @@\n+{{- if not .Values.alertdb.isExternal }}\n+apiVersion: v1\n+kind: Service\n+metadata:\n+  labels:\n+    app: alert\n+    component: alertdb\n+  name: {{ .Release.Name }}-alert-postgres\n+  namespace: {{ .Release.Namespace }}\n+spec:\n+  ports:\n+    - name: port-5432\n+      port: {{ .Values.alertdb.port }}\n+      protocol: TCP\n+      targetPort: {{ .Values.alertdb.port }}\n+  selector:\n+    app: alert\n+    component: alertdb\n+  type: ClusterIP\n+{{- if and .Values.enablePersistentStorage (not .Values.alertdb.persistentVolumeClaimName) }}\n+---\n+apiVersion: v1\n+kind: PersistentVolumeClaim\n+metadata:\n+  labels:\n+    app: alert\n+    component: alertdb\n+    name: {{ .Release.Name }}\n+  name: {{ .Release.Name }}-alert-postgres\n+  namespace: {{ .Release.Namespace }}\n+spec:\n+  {{- if .Values.alertdb.storageClass }}\n+  storageClassName: {{ .Values.alertdb.storageClass }}\n+  {{- else if .Values.storageClass }}\n+  storageClassName: {{ .Values.storageClass }}\n+  {{- end}}\n+  {{ if .Values.alert.volumeName -}}\n+  volumeName: {{ .Values.alertdb.volumeName }}\n+  {{ end -}}\n+  accessModes:\n+    - ReadWriteOnce\n+  resources:\n+    requests:\n+      storage: {{ .Values.alertdb.claimSize }}\n+{{- end }}\n+---\n+\n+apiVersion: apps/v1\n+kind: Deployment\n+metadata:\n+  labels:\n+    app: alert\n+    component: alertdb\n+  name: {{ .Release.Name }}-alert-postgres\n+  namespace: {{ .Release.Namespace }}\n+spec:\n+  {{- if eq .Values.status \"Running\" }}\n+  replicas: 1\n+  {{- else }}\n+  replicas: 0\n+  {{- end }}\n+  selector:\n+    matchLabels:\n+      app: alert\n+      component: alertdb\n+  strategy:\n+    type: Recreate\n+  template:\n+    metadata:\n+      labels:\n+        app: alert\n+        component: alertdb\n+      annotations:\n+        checksum/alertdb-config: {{ include (print $.Template.BasePath \"/alertdb-config.yaml\") . | sha256sum }}\n+      name: {{ .Release.Name }}-alert-postgres\n+    spec:\n+      containers:\n+      - env:\n+        - name: POSTGRESQL_MAX_CONNECTIONS\n+          value: \"300\"\n+        - name: POSTGRESQL_SHARED_BUFFERS\n+          value: 1024MB\n+        - name: POSTGRESQL_USER\n+          valueFrom:\n+            configMapKeyRef:\n+              key: ALERT_DB_USERNAME\n+              name: {{ .Release.Name }}-alert-db-config\n+        - name: POSTGRESQL_DATABASE\n+          valueFrom:\n+            configMapKeyRef:\n+              key: ALERT_DB_NAME\n+              name: {{ .Release.Name }}-alert-db-config\n+        - name: ALERT_DB_HOST\n+          valueFrom:\n+            configMapKeyRef:\n+              key: ALERT_DB_HOST\n+              name: {{ .Release.Name }}-alert-db-config\n+        - name: ALERT_DB_PORT\n+          valueFrom:\n+            configMapKeyRef:\n+              key: ALERT_DB_PORT\n+              name: {{ .Release.Name }}-alert-db-config\n+        - name: POSTGRESQL_PASSWORD\n+          valueFrom:\n+            secretKeyRef:\n+              key: ALERT_POSTGRES_USER_PASSWORD_FILE\n+              name: {{ .Release.Name }}-alert-db-creds\n+        {{- if .Values.alertdb.registry }}\n+        image: {{ .Values.alertdb.registry }}/postgresql-12-centos7:1\n+        {{- else }}\n+        image: {{ .Values.registry }}/postgresql-12-centos7:1\n+        {{- end}}\n+        imagePullPolicy: IfNotPresent\n+        lifecycle:\n+          preStop:\n+            exec:\n+              command:\n+                - sh\n+                - -c\n+                - LD_LIBRARY_PATH=/opt/rh/rh-postgresql12/root/usr/lib64 /opt/rh/rh-postgresql12/root/usr/bin/pg_ctl -D /var/lib/pgsql/data/userdata -l logfile stop", "originalCommit": "bb70c0e0b05757f5820424b61bc2133292758fee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc1MDg1Mw==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/966#discussion_r417750853", "bodyText": "pls change it to persistentVolumeClaimName: . Remove {}.", "author": "msenmurugan", "createdAt": "2020-04-30T04:46:51Z", "path": "deployment/helm/synopsys-alert/values.yaml", "diffHunk": "@@ -41,6 +41,29 @@ cfssl:\n   securityContext: {}\n   podSecurityContext: {}\n \n+# alertdb - configurations for the alertdb Pod\n+alertdb:\n+  registry: \"docker.io/centos\" # override the docker registry at container level\n+  isExternal: true # false for running Postgres as a container and true for using External Postgres database\n+  host: \"localhost\" # required only for external postgres, for postgres as a container, it will point to <name>-alert-postgres\n+  port: 5432\n+  # NOTE: do not change usernames when using postgres as a container; only configure if using external database\n+  userUserName: sa\n+  userPassword: blackduck\n+  databaseName: alertdb\n+  # pvc related parameters for postgres container\n+  persistentVolumeClaimName: {} # set if you want to create your own PVC (used for migration)", "originalCommit": "bb70c0e0b05757f5820424b61bc2133292758fee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc1MTQwOQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/966#discussion_r417751409", "bodyText": "you won't be having 2 users in an app? one is an admin who can have access at DDL level and another user is having DML level access. The code need to use the DML level access. This is to avoid any SQL injection and also the permissions restricting to the user.", "author": "msenmurugan", "createdAt": "2020-04-30T04:49:13Z", "path": "deployment/helm/synopsys-alert/values.yaml", "diffHunk": "@@ -41,6 +41,29 @@ cfssl:\n   securityContext: {}\n   podSecurityContext: {}\n \n+# alertdb - configurations for the alertdb Pod\n+alertdb:\n+  registry: \"docker.io/centos\" # override the docker registry at container level\n+  isExternal: true # false for running Postgres as a container and true for using External Postgres database\n+  host: \"localhost\" # required only for external postgres, for postgres as a container, it will point to <name>-alert-postgres\n+  port: 5432\n+  # NOTE: do not change usernames when using postgres as a container; only configure if using external database\n+  userUserName: sa", "originalCommit": "bb70c0e0b05757f5820424b61bc2133292758fee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODAwODY4Ng==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/966#discussion_r418008686", "bodyText": "At the moment no.  We would need to test using the liquibase user and password properties for DDL access and the spring datasource properties for the DML access.  I will file a ticket for this.", "author": "psantos1113", "createdAt": "2020-04-30T13:28:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc1MTQwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODAzNTE5Ng==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/966#discussion_r418035196", "bodyText": "Sounds good @psantos1113", "author": "msenmurugan", "createdAt": "2020-04-30T14:04:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc1MTQwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk3NTk1Mg==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/966#discussion_r417975952", "bodyText": "We can call this variable blackDuckProviderKey to make it more clear in the initialize() method that this is the only expected config in an upgrade.", "author": "gkillough", "createdAt": "2020-04-30T12:35:14Z", "path": "src/main/java/com/synopsys/integration/alert/workflow/startup/component/LastSearchDataMigration.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/**\n+ * blackduck-alert\n+ *\n+ * Copyright (c) 2020 Synopsys, Inc.\n+ *\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.synopsys.integration.alert.workflow.startup.component;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.core.annotation.Order;\n+import org.springframework.stereotype.Component;\n+\n+import com.synopsys.integration.alert.common.enumeration.ConfigContextEnum;\n+import com.synopsys.integration.alert.common.exception.AlertDatabaseConstraintException;\n+import com.synopsys.integration.alert.common.persistence.accessor.ConfigurationAccessor;\n+import com.synopsys.integration.alert.common.persistence.accessor.ProviderTaskPropertiesAccessor;\n+import com.synopsys.integration.alert.common.persistence.model.ConfigurationModel;\n+import com.synopsys.integration.alert.common.persistence.util.FilePersistenceUtil;\n+import com.synopsys.integration.alert.provider.blackduck.BlackDuckProviderKey;\n+import com.synopsys.integration.alert.provider.blackduck.tasks.BlackDuckAccumulator;\n+\n+@Component\n+@Order(55)\n+public class LastSearchDataMigration extends StartupComponent {\n+    private static final Logger logger = LoggerFactory.getLogger(LastSearchDataMigration.class);\n+    private static final String LAST_SEARCH_FILE = \"blackduck-accumulator-task-last-search.txt\";\n+\n+    // Because pg_stat_file requires admin privileges to run, we have to migrate the last search file data in code.\n+    // We don't have admin privileges to postgres when alert starts.\n+\n+    private BlackDuckProviderKey providerKey;", "originalCommit": "bb70c0e0b05757f5820424b61bc2133292758fee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk3NjQwOQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/966#discussion_r417976409", "bodyText": "Let's also deprecate this class for removal in 8.0.0.", "author": "gkillough", "createdAt": "2020-04-30T12:36:05Z", "path": "src/main/java/com/synopsys/integration/alert/workflow/startup/component/LastSearchDataMigration.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/**\n+ * blackduck-alert\n+ *\n+ * Copyright (c) 2020 Synopsys, Inc.\n+ *\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements. See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership. The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.synopsys.integration.alert.workflow.startup.component;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.core.annotation.Order;\n+import org.springframework.stereotype.Component;\n+\n+import com.synopsys.integration.alert.common.enumeration.ConfigContextEnum;\n+import com.synopsys.integration.alert.common.exception.AlertDatabaseConstraintException;\n+import com.synopsys.integration.alert.common.persistence.accessor.ConfigurationAccessor;\n+import com.synopsys.integration.alert.common.persistence.accessor.ProviderTaskPropertiesAccessor;\n+import com.synopsys.integration.alert.common.persistence.model.ConfigurationModel;\n+import com.synopsys.integration.alert.common.persistence.util.FilePersistenceUtil;\n+import com.synopsys.integration.alert.provider.blackduck.BlackDuckProviderKey;\n+import com.synopsys.integration.alert.provider.blackduck.tasks.BlackDuckAccumulator;\n+\n+@Component\n+@Order(55)\n+public class LastSearchDataMigration extends StartupComponent {", "originalCommit": "bb70c0e0b05757f5820424b61bc2133292758fee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f42aa0d4c1482066cd21999353c990e6ea5025d6", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/f42aa0d4c1482066cd21999353c990e6ea5025d6", "message": "refactor: Implement PR feedback.", "committedDate": "2020-04-30T13:53:03Z", "type": "commit"}, {"oid": "7f2862d4eb8db316fc1f6af039870cb340092aca", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/7f2862d4eb8db316fc1f6af039870cb340092aca", "message": "refactor: Rename alertdb charts to postgres.", "committedDate": "2020-04-30T13:59:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODAzNDE5NQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/966#discussion_r418034195", "bodyText": "Can you pls add a checksum for Alert DB creds secrets?", "author": "msenmurugan", "createdAt": "2020-04-30T14:03:01Z", "path": "deployment/helm/synopsys-alert/templates/alert.yaml", "diffHunk": "@@ -32,94 +32,101 @@ spec:\n       name: {{ .Release.Name }}", "originalCommit": "7f2862d4eb8db316fc1f6af039870cb340092aca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODAzNzQ4OA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/966#discussion_r418037488", "bodyText": "Whether it needs to be empty?", "author": "msenmurugan", "createdAt": "2020-04-30T14:07:37Z", "path": "deployment/helm/synopsys-alert/values.yaml", "diffHunk": "@@ -41,6 +41,29 @@ cfssl:\n   securityContext: {}\n   podSecurityContext: {}\n \n+# postgres - configurations for the postgres Pod\n+postgres:\n+  registry: \"docker.io/centos\" # override the docker registry at container level\n+  isExternal: true # false for running Postgres as a container and true for using External Postgres database\n+  host: \"localhost\" # required only for external postgres, for postgres as a container, it will point to <name>-postgres", "originalCommit": "7f2862d4eb8db316fc1f6af039870cb340092aca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA4ODgxNw==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/966#discussion_r418088817", "bodyText": "If you make it empty then you can use this to require users to set it if isExternal is true\n{{ required \"must provide --set postgres.host=\\\"\\\"\" .Values.postgres.host }}", "author": "mphammer", "createdAt": "2020-04-30T15:17:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODAzNzQ4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEzMzk4MQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/966#discussion_r418133981", "bodyText": "I will add this", "author": "psantos1113", "createdAt": "2020-04-30T16:24:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODAzNzQ4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEzOTQ1NQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/966#discussion_r418139455", "bodyText": "With the required there the postgres.isExternal must be false by default.  Which is to create a postgres container in the deployment.  That will be the default for alert.", "author": "psantos1113", "createdAt": "2020-04-30T16:32:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODAzNzQ4OA=="}], "type": "inlineReview"}, {"oid": "2fba83d0226f2a48da88a28995f9c498e129fd95", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/2fba83d0226f2a48da88a28995f9c498e129fd95", "message": "refactor: Fix the indentation in the files.", "committedDate": "2020-04-30T14:32:02Z", "type": "commit"}, {"oid": "caf4b24b1c428806ed3bd7dc1146b9544b84dd98", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/caf4b24b1c428806ed3bd7dc1146b9544b84dd98", "message": "refactor: Add the checksum for the database configuration.", "committedDate": "2020-04-30T14:41:41Z", "type": "commit"}, {"oid": "20df917ea7d06e45edfba37b71580027b3a81a12", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/20df917ea7d06e45edfba37b71580027b3a81a12", "message": "refactor: Fix remaining indentation issues.", "committedDate": "2020-04-30T15:04:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA5MTQxMQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/966#discussion_r418091411", "bodyText": "Is there a missing value here for the postgresql initialization script?", "author": "mphammer", "createdAt": "2020-04-30T15:21:29Z", "path": "deployment/helm/synopsys-alert/values.yaml", "diffHunk": "@@ -41,6 +41,29 @@ cfssl:\n   securityContext: {}\n   podSecurityContext: {}\n \n+# postgres - configurations for the postgres Pod\n+postgres:\n+  registry: \"docker.io/centos\" # override the docker registry at container level\n+  isExternal: true # false for running Postgres as a container and true for using External Postgres database\n+  host: \"localhost\" # required only for external postgres, for postgres as a container, it will point to <name>-postgres\n+  port: 5432\n+  # NOTE: do not change usernames when using postgres as a container; only configure if using external database\n+  userUserName: sa\n+  userPassword: blackduck\n+  databaseName: alertdb\n+  # pvc related parameters for postgres container\n+  persistentVolumeClaimName: \"\" # set if you want to create your own PVC (used for migration)\n+  claimSize: \"5Gi\" # PVC claim size\n+  storageClass: \"\" # PVC storage class name\n+  volumeName: \"\" # existing persistent volume name backing the PVC\n+  # path to postgresql initialization script", "originalCommit": "20df917ea7d06e45edfba37b71580027b3a81a12", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEzMzg4MQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/966#discussion_r418133881", "bodyText": "we don't have one.  I will remove the comment.  The alert container handles the initialization when it starts up.", "author": "psantos1113", "createdAt": "2020-04-30T16:24:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA5MTQxMQ=="}], "type": "inlineReview"}, {"oid": "30756f6c679c86c733e9316c9f33c435eda4beeb", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/30756f6c679c86c733e9316c9f33c435eda4beeb", "message": "refactor: Set postgres.host parameter to empty string.", "committedDate": "2020-04-30T16:17:14Z", "type": "commit"}, {"oid": "65c43b50c4072652ae269cf254223817f756db1b", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/65c43b50c4072652ae269cf254223817f756db1b", "message": "refactor: Update defaults in values file and require host if external", "committedDate": "2020-04-30T16:34:22Z", "type": "commit"}]}