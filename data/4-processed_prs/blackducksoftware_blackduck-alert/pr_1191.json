{"pr_number": 1191, "pr_title": "Update blackduck-common and check Jira permissions", "pr_createdAt": "2020-09-28T19:35:31Z", "pr_url": "https://github.com/blackducksoftware/blackduck-alert/pull/1191", "timeline": [{"oid": "c484ad77de386fcacaac04b6a28812151f96deb7", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/c484ad77de386fcacaac04b6a28812151f96deb7", "message": "Feat(Jira): Add admin permissions check for Jira global and update dependencies", "committedDate": "2020-09-25T18:36:06Z", "type": "commit"}, {"oid": "e4c057511663418d2ae6077f925283c99df3faee", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/e4c057511663418d2ae6077f925283c99df3faee", "message": "Fix(Dependency): Update blackduck-common dependency and resolve immediate issues", "committedDate": "2020-09-28T19:16:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE4Njg0OA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1191#discussion_r496186848", "bodyText": "This chunk is the actual feature. The rest is resolving the dependency hell from blackduck-common.", "author": "gkillough", "createdAt": "2020-09-28T19:37:10Z", "path": "src/main/java/com/synopsys/integration/alert/channel/jira/cloud/actions/JiraCloudGlobalTestAction.java", "diffHunk": "@@ -76,6 +79,16 @@ protected boolean isUserMissing(FieldAccessor fieldAccessor) throws IntegrationE\n                    .noneMatch(email -> email.equals(username));\n     }\n \n+    @Override\n+    protected boolean isUserAdmin(FieldAccessor fieldAccessor) throws IntegrationException {\n+        JiraCloudProperties jiraProperties = createJiraProperties(fieldAccessor);\n+        JiraCloudServiceFactory jiraCloudServiceFactory = jiraProperties.createJiraServicesCloudFactory(logger, gson);\n+        MyPermissionsService myPermissionsService = jiraCloudServiceFactory.createMyPermissionsService();\n+        MultiPermissionResponseModel myPermissions = myPermissionsService.getMyPermissions(JiraGlobalTestAction.JIRA_ADMIN_PERMISSION_NAME);\n+        PermissionModel adminPermission = myPermissions.extractPermission(JiraGlobalTestAction.JIRA_ADMIN_PERMISSION_NAME);\n+        return null != adminPermission && adminPermission.getHavePermission();\n+    }\n+", "originalCommit": "e4c057511663418d2ae6077f925283c99df3faee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE4ODA1Ng==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1191#discussion_r496188056", "bodyText": "I think this exception is misleading, I don't think using the channel display name is clear enough.\nWe probably want something like this Please configure the 'Alert Issue Property Indexer' app for you server. That way they know exactly the name of the app to look for in the marketplace.", "author": "jamesrichard91", "createdAt": "2020-09-28T19:39:25Z", "path": "src/main/java/com/synopsys/integration/alert/channel/jira/common/JiraGlobalTestAction.java", "diffHunk": "@@ -45,8 +49,14 @@ public MessageResult testConfig(String configId, FieldModel fieldModel, FieldAcc\n                 throw new AlertException(\"User did not match any known users.\");\n             }\n \n-            if (isAppCheckEnabled(registeredFieldValues) && isAppMissing(registeredFieldValues)) {\n-                throw new AlertException(String.format(\"Please configure the %s plugin for your server.\", getChannelDisplayName()));\n+            if (isAppCheckEnabled(registeredFieldValues)) {\n+                if (isUserAdmin(registeredFieldValues)) {\n+                    throw new AlertException(\"The configured user must be an admin if 'Plugin Check' is enabled\");\n+                }\n+\n+                if (isAppMissing(registeredFieldValues)) {\n+                    throw new AlertException(String.format(\"Please configure the %s plugin for your server.\", getChannelDisplayName()));", "originalCommit": "e4c057511663418d2ae6077f925283c99df3faee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE5MDQ3MQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1191#discussion_r496190471", "bodyText": "Good idea. This text predated the current PR. It was just moved to its own if.", "author": "gkillough", "createdAt": "2020-09-28T19:44:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE4ODA1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE4OTMyNw==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1191#discussion_r496189327", "bodyText": "Same issue as my previous comment. We probably want to update this message with the name of the App so they know what to look for in the installed apps, and if it isn't there then they know what to search for in the marketplace.", "author": "jamesrichard91", "createdAt": "2020-09-28T19:42:00Z", "path": "src/main/java/com/synopsys/integration/alert/channel/jira/server/web/JiraServerCustomFunctionAction.java", "diffHunk": "@@ -76,15 +76,15 @@ public JiraServerCustomFunctionAction(AuthorizationManager authorizationManager,\n             String username = jiraProperties.getUsername();\n             String password = jiraProperties.getPassword();\n             try {\n-                jiraAppService.installMarketplaceServerApp(JiraConstants.JIRA_APP_KEY, username, password);\n+                jiraAppService.installMarketplaceServerApp(JiraConstants.JIRA_APP_KEY);\n             } catch (IntegrationRestException e) {\n                 if (RestConstants.NOT_FOUND_404 == e.getHttpStatusCode()) {\n                     return new ActionResponse<>(HttpStatus.NOT_FOUND,\n                         \"The marketplace listing of the Alert Issue Property Indexer app may not support your version of Jira. Please install the app manually or request a compatibility update. Error: \" + e.getMessage());\n                 }\n                 createBadRequestIntegrationException(e);\n             }\n-            boolean jiraPluginInstalled = JiraPluginCheckUtil.checkIsAppInstalledAndRetryIfNecessary(jiraAppService, username, password);\n+            boolean jiraPluginInstalled = JiraPluginCheckUtil.checkIsAppInstalledAndRetryIfNecessary(jiraAppService);\n             if (!jiraPluginInstalled) {\n                 return new ActionResponse<>(HttpStatus.NOT_FOUND, \"Was not able to confirm Jira server successfully installed the Jira Server plugin. Please verify the installation on you Jira server.\");", "originalCommit": "e4c057511663418d2ae6077f925283c99df3faee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f60e77494139b389f453c0eb3ce4dff4dcad4253", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/f60e77494139b389f453c0eb3ce4dff4dcad4253", "message": "Fix(Jira): Include plugin name in jira UI error messages", "committedDate": "2020-09-28T20:04:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY0MzY1OQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/1191#discussion_r496643659", "bodyText": "Existing issue but \"Please verify the installation on you Jira Cloud server.\"  Should change to \"Please verify the installation on your Jira Cloud server.\"", "author": "psantos1113", "createdAt": "2020-09-29T11:31:30Z", "path": "src/main/java/com/synopsys/integration/alert/channel/jira/cloud/web/JiraCloudCustomEndpoint.java", "diffHunk": "@@ -73,25 +72,24 @@ public JiraCloudCustomEndpoint(AuthorizationManager authorizationManager, JiraCl\n         try {\n             JiraCloudServiceFactory jiraServicesCloudFactory = jiraProperties.createJiraServicesCloudFactory(logger, gson);\n             PluginManagerService jiraAppService = jiraServicesCloudFactory.createPluginManagerService();\n-            String username = jiraProperties.getUsername();\n-            String accessToken = jiraProperties.getAccessToken();\n-            Response response = jiraAppService.installMarketplaceCloudApp(JiraConstants.JIRA_APP_KEY, username, accessToken);\n-            if (BooleanUtils.isTrue(response.isStatusCodeError())) {\n-                return new ActionResponse<>(HttpStatus.BAD_REQUEST, \"The Jira Cloud server responded with error code: \" + response.getStatusCode());\n+            int statusCode = jiraAppService.installMarketplaceCloudApp(JiraConstants.JIRA_APP_KEY);\n+            if (!HttpStatusCodes.isSuccess(statusCode)) {\n+                return new ActionResponse<>(HttpStatus.BAD_REQUEST, \"The Jira Cloud server responded with error code: \" + statusCode);\n             }\n \n-            boolean jiraPluginInstalled = JiraPluginCheckUtil.checkIsAppInstalledAndRetryIfNecessary(jiraAppService, username, accessToken);\n+            boolean jiraPluginInstalled = JiraPluginCheckUtil.checkIsAppInstalledAndRetryIfNecessary(jiraAppService);\n             if (!jiraPluginInstalled) {\n-                return new ActionResponse<>(HttpStatus.NOT_FOUND, \"Unable to confirm Jira Cloud successfully installed the Jira Cloud plugin. Please verify the installation on you Jira Cloud server.\");\n+                return new ActionResponse<>(HttpStatus.NOT_FOUND, String.format(\n+                    \"Unable to confirm successful installation of the Jira Cloud '%s' plugin. Please verify the installation on you Jira Cloud server.\", JiraConstants.JIRA_ALERT_APP_NAME));", "originalCommit": "f60e77494139b389f453c0eb3ce4dff4dcad4253", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2b9dac174764be6c84f9daa65bfb21d190b77fbd", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/2b9dac174764be6c84f9daa65bfb21d190b77fbd", "message": "Fix(Jira): Clean up error message and negate admin check condition", "committedDate": "2020-09-29T15:26:17Z", "type": "commit"}]}