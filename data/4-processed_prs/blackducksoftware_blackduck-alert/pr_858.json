{"pr_number": 858, "pr_title": "Add provider config id to data tables", "pr_createdAt": "2020-02-14T17:03:42Z", "pr_url": "https://github.com/blackducksoftware/blackduck-alert/pull/858", "timeline": [{"oid": "3d8f6ece9055709889414444ccd51ef4cc07d0ea", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/3d8f6ece9055709889414444ccd51ef4cc07d0ea", "message": "Fix(Java): Begin updating the database API for ProviderData to handle multiple configs", "committedDate": "2020-02-14T16:33:34Z", "type": "commit"}, {"oid": "68ece05d7f9209fc093f254a062bfbbba8d2f33d", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/68ece05d7f9209fc093f254a062bfbbba8d2f33d", "message": "Feat(Liquibase): Add column to provider_projects and provider_users for config id", "committedDate": "2020-02-14T16:46:45Z", "type": "commit"}, {"oid": "6d85892ad101f9a3ebd43298ebed271254999f88", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/6d85892ad101f9a3ebd43298ebed271254999f88", "message": "Merge branch 'feat_provider_lifecycle_management' into gk_add_provider_config_id_to_data_tables", "committedDate": "2020-02-14T16:55:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYwNjYxNw==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/858#discussion_r379606617", "bodyText": "Why are we ignoring this exception?", "author": "jamesrichard91", "createdAt": "2020-02-14T19:30:41Z", "path": "alert-database/src/main/java/com/synopsys/integration/alert/database/api/DefaultProviderDataAccessor.java", "diffHunk": "@@ -58,56 +54,52 @@\n @Component\n @Transactional\n public class DefaultProviderDataAccessor implements ProviderDataAccessor {\n-    public static final Integer DEFAULT_OFFSET = 0;\n-    public static final Integer DEFAULT_LIMIT = 100;\n-\n     public static final int MAX_DESCRIPTION_LENGTH = 250;\n     public static final int MAX_PROJECT_NAME_LENGTH = 507;\n \n     private final Logger logger = LoggerFactory.getLogger(DefaultProviderDataAccessor.class);\n     private final ProviderProjectRepository providerProjectRepository;\n     private final ProviderUserProjectRelationRepository providerUserProjectRelationRepository;\n     private final ProviderUserRepository providerUserRepository;\n+    private final ConfigurationAccessor configurationAccessor;\n \n     @Autowired\n-    public DefaultProviderDataAccessor(ProviderProjectRepository providerProjectRepository, ProviderUserProjectRelationRepository providerUserProjectRelationRepository, ProviderUserRepository providerUserRepository) {\n+    public DefaultProviderDataAccessor(ProviderProjectRepository providerProjectRepository, ProviderUserProjectRelationRepository providerUserProjectRelationRepository, ProviderUserRepository providerUserRepository,\n+        ConfigurationAccessor configurationAccessor) {\n         this.providerProjectRepository = providerProjectRepository;\n         this.providerUserProjectRelationRepository = providerUserProjectRelationRepository;\n         this.providerUserRepository = providerUserRepository;\n+        this.configurationAccessor = configurationAccessor;\n     }\n \n     @Override\n     @Transactional(readOnly = true, isolation = Isolation.READ_COMMITTED)\n-    public Optional<ProviderProject> findFirstByHref(String href) {\n-        return providerProjectRepository.findFirstByHref(href).map(this::convertToProjectModel);\n-    }\n-\n-    @Override\n-    @Transactional(readOnly = true, isolation = Isolation.READ_COMMITTED)\n-    public Optional<ProviderProject> findFirstByName(String name) {\n-        return providerProjectRepository.findFirstByName(name).map(this::convertToProjectModel);\n-    }\n-\n-    @Override\n-    @Transactional(readOnly = true, isolation = Isolation.READ_COMMITTED)\n-    public List<ProviderProject> findByProviderName(String providerName) {\n-        return providerProjectRepository.findByProvider(providerName)\n-                   .stream()\n-                   .map(this::convertToProjectModel)\n-                   .collect(Collectors.toList());\n+    public List<ProviderProject> findByProviderConfigName(String providerConfigName) {\n+        try {\n+            Optional<Long> optionalConfigId = configurationAccessor.getProviderConfigurationByName(providerConfigName)\n+                                                  .map(ConfigurationModel::getConfigurationId);\n+            if (optionalConfigId.isPresent()) {\n+                return providerProjectRepository.findByProviderConfigId(optionalConfigId.get())\n+                           .stream()\n+                           .map(this::convertToProjectModel)\n+                           .collect(Collectors.toList());\n+            }\n+        } catch (AlertDatabaseConstraintException ignored) {", "originalCommit": "6d85892ad101f9a3ebd43298ebed271254999f88", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY4Mjk2Nw==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/858#discussion_r380682967", "bodyText": "If the configId is present, then the database constraint is fulfilled, meaning that specific exception will not be thrown.", "author": "gkillough", "createdAt": "2020-02-18T13:51:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYwNjYxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY4Nzk1OQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/858#discussion_r380687959", "bodyText": "Not to mention that because this is a search for projects, we don't necessarily want to throw an exception, but instead return an empty List.", "author": "gkillough", "createdAt": "2020-02-18T14:00:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYwNjYxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDcyOTIwNw==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/858#discussion_r380729207", "bodyText": "You may want to add a comment to avoid future confusion. But given your explanation this seems fine", "author": "jamesrichard91", "createdAt": "2020-02-18T15:04:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYwNjYxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY5MjU2NQ==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/858#discussion_r380692565", "bodyText": "This was never used in production.", "author": "gkillough", "createdAt": "2020-02-18T14:08:00Z", "path": "alert-database/src/main/java/com/synopsys/integration/alert/database/api/DefaultProviderDataAccessor.java", "diffHunk": "@@ -130,78 +122,51 @@ public void deleteProjects(ProviderKey providerKey, Collection<ProviderProject>\n \n     @Override\n     @Transactional(readOnly = true, isolation = Isolation.READ_COMMITTED)\n-    public List<ProviderUserModel> getAllUsers(String providerName) {\n-        return providerUserRepository.findByProvider(providerName)\n+    public List<ProviderUserModel> getAllUsers(Long providerConfigId) {\n+        return providerUserRepository.findByProviderConfigId(providerConfigId)\n                    .stream()\n                    .map(this::convertToUserModel)\n                    .collect(Collectors.toList());\n     }\n \n     @Override\n-    @Transactional(readOnly = true, isolation = Isolation.READ_COMMITTED)\n-    public AlertPagedModel<ProviderUserModel> getPageOfUsers(String providerName, Integer pageNumber, Integer pageSize, String q) throws AlertDatabaseConstraintException {", "originalCommit": "6d85892ad101f9a3ebd43298ebed271254999f88", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d7df40f2fd5aaa0a514e5e697f7a7fa7dbe896e9", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/d7df40f2fd5aaa0a514e5e697f7a7fa7dbe896e9", "message": "Fix(Liquibase): Drop provider column from provider data tables", "committedDate": "2020-02-18T14:14:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDcwNjUzMA==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/858#discussion_r380706530", "bodyText": "Are we missing @Transactional on this method?", "author": "psantos1113", "createdAt": "2020-02-18T14:30:21Z", "path": "alert-database/src/main/java/com/synopsys/integration/alert/database/api/DefaultProviderDataAccessor.java", "diffHunk": "@@ -58,56 +54,52 @@\n @Component\n @Transactional\n public class DefaultProviderDataAccessor implements ProviderDataAccessor {\n-    public static final Integer DEFAULT_OFFSET = 0;\n-    public static final Integer DEFAULT_LIMIT = 100;\n-\n     public static final int MAX_DESCRIPTION_LENGTH = 250;\n     public static final int MAX_PROJECT_NAME_LENGTH = 507;\n \n     private final Logger logger = LoggerFactory.getLogger(DefaultProviderDataAccessor.class);\n     private final ProviderProjectRepository providerProjectRepository;\n     private final ProviderUserProjectRelationRepository providerUserProjectRelationRepository;\n     private final ProviderUserRepository providerUserRepository;\n+    private final ConfigurationAccessor configurationAccessor;\n \n     @Autowired\n-    public DefaultProviderDataAccessor(ProviderProjectRepository providerProjectRepository, ProviderUserProjectRelationRepository providerUserProjectRelationRepository, ProviderUserRepository providerUserRepository) {\n+    public DefaultProviderDataAccessor(ProviderProjectRepository providerProjectRepository, ProviderUserProjectRelationRepository providerUserProjectRelationRepository, ProviderUserRepository providerUserRepository,\n+        ConfigurationAccessor configurationAccessor) {\n         this.providerProjectRepository = providerProjectRepository;\n         this.providerUserProjectRelationRepository = providerUserProjectRelationRepository;\n         this.providerUserRepository = providerUserRepository;\n+        this.configurationAccessor = configurationAccessor;\n     }\n \n     @Override\n     @Transactional(readOnly = true, isolation = Isolation.READ_COMMITTED)\n-    public Optional<ProviderProject> findFirstByHref(String href) {\n-        return providerProjectRepository.findFirstByHref(href).map(this::convertToProjectModel);\n-    }\n-\n-    @Override\n-    @Transactional(readOnly = true, isolation = Isolation.READ_COMMITTED)\n-    public Optional<ProviderProject> findFirstByName(String name) {\n-        return providerProjectRepository.findFirstByName(name).map(this::convertToProjectModel);\n-    }\n-\n-    @Override\n-    @Transactional(readOnly = true, isolation = Isolation.READ_COMMITTED)\n-    public List<ProviderProject> findByProviderName(String providerName) {\n-        return providerProjectRepository.findByProvider(providerName)\n-                   .stream()\n-                   .map(this::convertToProjectModel)\n-                   .collect(Collectors.toList());\n+    public List<ProviderProject> findByProviderConfigName(String providerConfigName) {\n+        try {\n+            Optional<Long> optionalConfigId = configurationAccessor.getProviderConfigurationByName(providerConfigName)\n+                                                  .map(ConfigurationModel::getConfigurationId);\n+            if (optionalConfigId.isPresent()) {\n+                return providerProjectRepository.findByProviderConfigId(optionalConfigId.get())\n+                           .stream()\n+                           .map(this::convertToProjectModel)\n+                           .collect(Collectors.toList());\n+            }\n+        } catch (AlertDatabaseConstraintException ignored) {\n+        }\n+        return List.of();\n     }\n \n     @Override\n     @Transactional(readOnly = true, isolation = Isolation.READ_COMMITTED)\n-    public List<ProviderProject> findByProviderKey(ProviderKey providerKey) {\n-        return providerProjectRepository.findByProvider(providerKey.getUniversalKey())\n+    public List<ProviderProject> findByProviderConfigId(Long providerConfigId) {\n+        return providerProjectRepository.findByProviderConfigId(providerConfigId)\n                    .stream()\n                    .map(this::convertToProjectModel)\n                    .collect(Collectors.toList());\n     }\n \n     @Override\n-    public void deleteProjects(ProviderKey providerKey, Collection<ProviderProject> providerProjects) {\n+    public void deleteProjects(Collection<ProviderProject> providerProjects) {", "originalCommit": "d7df40f2fd5aaa0a514e5e697f7a7fa7dbe896e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDcyOTI2Mw==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/858#discussion_r380729263", "bodyText": "The class is annotated with @Transactional, so this method will be. The read committed methods just override the class level annotation.", "author": "gkillough", "createdAt": "2020-02-18T15:04:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDcwNjUzMA=="}], "type": "inlineReview"}, {"oid": "f1db0ed330fb1c13f439c220ba6d51ee0322a7bc", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/f1db0ed330fb1c13f439c220ba6d51ee0322a7bc", "message": "Fix(Java): Resolve FIXMEs within the scope of this issue", "committedDate": "2020-02-18T15:05:51Z", "type": "commit"}, {"oid": "1ec88e3be46f95e03c5bba975b4893690cb5bf1b", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/1ec88e3be46f95e03c5bba975b4893690cb5bf1b", "message": "Fix(Liquibase): Add column type to new columns in provider data", "committedDate": "2020-02-18T17:05:17Z", "type": "commit"}]}