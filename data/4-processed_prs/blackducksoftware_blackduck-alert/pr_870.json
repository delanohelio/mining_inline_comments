{"pr_number": 870, "pr_title": "Ps provider init fix", "pr_createdAt": "2020-02-24T12:41:04Z", "pr_url": "https://github.com/blackducksoftware/blackduck-alert/pull/870", "timeline": [{"oid": "aefc900becf8a56c7fc52f1f771824e06fa8d984", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/aefc900becf8a56c7fc52f1f771824e06fa8d984", "message": "refactor: Initialize providers.", "committedDate": "2020-02-21T21:11:56Z", "type": "commit"}, {"oid": "1767fec0df8ec97a18a0068ea40c480a89984953", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/1767fec0df8ec97a18a0068ea40c480a89984953", "message": "refactor(provider): Get the tasks by their class then compare names.", "committedDate": "2020-02-24T12:14:14Z", "type": "commit"}, {"oid": "79ff2a790c93f72c8d5a1b9dc67859aba117aa20", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/79ff2a790c93f72c8d5a1b9dc67859aba117aa20", "message": "refactor: Remove check if task was running.", "committedDate": "2020-02-24T12:40:20Z", "type": "commit"}, {"oid": "6bab31cce7d8e06e1b3ac77d89903087e3430752", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/6bab31cce7d8e06e1b3ac77d89903087e3430752", "message": "Merge remote-tracking branch 'origin/feat_provider_lifecycle_management' into ps_provider_init_fix", "committedDate": "2020-02-24T12:47:01Z", "type": "commit"}, {"oid": "d686df7d7805cbf7c779acdd767b36cd581de25f", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/d686df7d7805cbf7c779acdd767b36cd581de25f", "message": "Merge remote-tracking branch 'origin/feat_provider_lifecycle_management' into ps_provider_init_fix", "committedDate": "2020-02-24T13:43:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI3MjQ1Ng==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/870#discussion_r383272456", "bodyText": "This should say \"tasks\".", "author": "gkillough", "createdAt": "2020-02-24T13:46:03Z", "path": "alert-common/src/main/java/com/synopsys/integration/alert/common/provider/lifecycle/ProviderLifecycleManager.java", "diffHunk": "@@ -81,29 +80,28 @@ public ProviderLifecycleManager(List<Provider> providers, TaskManager taskManage\n         }\n \n         List<ProviderTask> providerTasks = provider.createProviderTasks(providerProperties);\n+        unscheduleTasksForProviderConfig(provider, providerProperties.getConfigId());\n         for (ProviderTask task : providerTasks) {\n             if (taskManager.getNextRunTime(task.getTaskName()).isEmpty()) {\n                 scheduleTask(task);\n                 acceptedTasks.add(task);\n             }\n         }\n+        logger.debug(\"Finished scheduling task for config with id {} and descriptor id {}\", providerConfig.getConfigurationId(), providerConfig.getDescriptorId());", "originalCommit": "d686df7d7805cbf7c779acdd767b36cd581de25f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI3MjU1Mw==", "url": "https://github.com/blackducksoftware/blackduck-alert/pull/870#discussion_r383272553", "bodyText": "\"tasks\"", "author": "gkillough", "createdAt": "2020-02-24T13:46:15Z", "path": "alert-common/src/main/java/com/synopsys/integration/alert/common/provider/lifecycle/ProviderLifecycleManager.java", "diffHunk": "@@ -81,29 +80,28 @@ public ProviderLifecycleManager(List<Provider> providers, TaskManager taskManage\n         }\n \n         List<ProviderTask> providerTasks = provider.createProviderTasks(providerProperties);\n+        unscheduleTasksForProviderConfig(provider, providerProperties.getConfigId());\n         for (ProviderTask task : providerTasks) {\n             if (taskManager.getNextRunTime(task.getTaskName()).isEmpty()) {\n                 scheduleTask(task);\n                 acceptedTasks.add(task);\n             }\n         }\n+        logger.debug(\"Finished scheduling task for config with id {} and descriptor id {}\", providerConfig.getConfigurationId(), providerConfig.getDescriptorId());\n         return acceptedTasks;\n     }\n \n     public void unscheduleTasksForProviderConfig(Provider provider, Long providerConfigId) {\n         logger.debug(\"Performing unscheduling task for provider config: id={}\", providerConfigId);\n \n-        // TODO find a better way to get the task names\n-        Set<String> runningTasksForProviderConfig = taskManager.getRunningTaskNames()\n-                                                        .stream()\n-                                                        .filter(name -> name.contains(provider.getKey().getUniversalKey()))\n-                                                        .filter(name -> name.contains(\"id:\" + providerConfigId))\n-                                                        .collect(Collectors.toSet());\n-        for (String taskName : runningTasksForProviderConfig) {\n-            if (taskManager.getNextRunTime(taskName).isPresent()) {\n-                unscheduleTask(taskName);\n-            }\n+        List<ProviderTask> tasks = taskManager.getTasksByClass(ProviderTask.class).stream()\n+                                       .filter(task -> task.getProviderProperties().getConfigId().equals(providerConfigId))\n+                                       .collect(Collectors.toList());\n+\n+        for (ProviderTask task : tasks) {\n+            unscheduleTask(task.getTaskName());\n         }\n+        logger.debug(\"Finished unscheduling task for provider config: id={}\", providerConfigId);", "originalCommit": "d686df7d7805cbf7c779acdd767b36cd581de25f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "193a2f41354e76077a39b2ac724535f4ef6bc3d9", "url": "https://github.com/blackducksoftware/blackduck-alert/commit/193a2f41354e76077a39b2ac724535f4ef6bc3d9", "message": "refactor: Fix typo in log message.", "committedDate": "2020-02-24T13:50:02Z", "type": "commit"}]}