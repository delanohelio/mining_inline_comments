{"pr_number": 3509, "pr_title": "HHH-10282 Short-hand enum syntax support for HQL", "pr_createdAt": "2020-08-21T17:39:01Z", "pr_url": "https://github.com/hibernate/hibernate-orm/pull/3509", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg0ODcyOQ==", "url": "https://github.com/hibernate/hibernate-orm/pull/3509#discussion_r474848729", "bodyText": "We might use CollectionHelper.mapOfSize( enumConstants.length ) to avoid map resizing. new HashMap( n ) doesn't necessarily achieve the user's goal (if the hashing conflict doesn't exist, the hashMap would be expanded for sure, which defeats the purpose of the intention).", "author": "NathanQingyangXu", "createdAt": "2020-08-21T18:04:14Z", "path": "hibernate-core/src/main/java/org/hibernate/query/hql/internal/SemanticQueryBuilder.java", "diffHunk": "@@ -218,7 +228,26 @@ public static SqmStatement buildSemanticModel(\n \tpublic SemanticQueryBuilder(SqmCreationOptions creationOptions, SqmCreationContext creationContext) {\n \t\tthis.creationOptions = creationOptions;\n \t\tthis.creationContext = creationContext;\n-\n+\t\tthis.possibleEnumNames = new HashSet<>();\n+\t\tthis.enumCache = new HashMap<>();\n+\t\tcreationContext.getJpaMetamodel().visitManagedTypes( managedDomainType -> {\n+\t\t\tmanagedDomainType.visitAttributes( persistentAttribute -> {\n+\t\t\t\tif ( persistentAttribute.getJavaType().isEnum() ) {\n+\t\t\t\t\t@SuppressWarnings(\"unchecked\")\n+\t\t\t\t\tClass<Enum<?>> enumClass = (Class<Enum<?>>) persistentAttribute.getJavaType();\n+\t\t\t\t\tMap<String, Enum<?>> enumValues = enumCache.get( enumClass );\n+\t\t\t\t\tif ( enumValues == null ) {\n+\t\t\t\t\t\tEnum<?>[] enumConstants = enumClass.getEnumConstants();\n+\t\t\t\t\t\tenumValues = new HashMap<>( enumConstants.length );", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg0OTYzNg==", "url": "https://github.com/hibernate/hibernate-orm/pull/3509#discussion_r474849636", "bodyText": "This is just a PoC, I'd obviously do this only at startup.", "author": "beikov", "createdAt": "2020-08-21T18:06:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg0ODcyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg1NjEzOQ==", "url": "https://github.com/hibernate/hibernate-orm/pull/3509#discussion_r474856139", "bodyText": "okay, make sense.", "author": "NathanQingyangXu", "createdAt": "2020-08-21T18:21:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg0ODcyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk4MzM0OQ==", "url": "https://github.com/hibernate/hibernate-orm/pull/3509#discussion_r474983349", "bodyText": "Enum.valueOf(Class<?> enumType, String name) would simplify the lookup dramatically if the PoC is approved.", "author": "NathanQingyangXu", "createdAt": "2020-08-21T21:45:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg0ODcyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA5NDI0Ng==", "url": "https://github.com/hibernate/hibernate-orm/pull/3509#discussion_r475094246", "bodyText": "Enum.valueOf(Class<?> enumType, String name) throws an exception for unknown keys which I want to avoid here. The caching was done on purpose.", "author": "beikov", "createdAt": "2020-08-22T14:03:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg0ODcyOQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODA3MzUwNQ==", "url": "https://github.com/hibernate/hibernate-orm/pull/3509#discussion_r518073505", "bodyText": "I'm curious where null is being put into this queue?  That seems wrong", "author": "sebersole", "createdAt": "2020-11-05T14:03:13Z", "path": "hibernate-core/src/main/java/org/hibernate/boot/internal/InFlightMetadataCollectorImpl.java", "diffHunk": "@@ -1664,7 +1664,7 @@ private void processValueResolvers(MetadataBuildingContext buildingContext) {\n \n \t\twhile ( ! valueResolvers.isEmpty() ) {\n \t\t\tfinal boolean anyRemoved = valueResolvers.removeIf(\n-\t\t\t\t\tresolver -> resolver.apply( buildingContext )\n+\t\t\t\t\tresolver -> resolver == null || resolver.apply( buildingContext )", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY5NDc0Nw==", "url": "https://github.com/hibernate/hibernate-orm/pull/3509#discussion_r519694747", "bodyText": "You are right. Since the PR is quite old already, I still had that in as a workaround for a previously issue, but it's working fine now even without this. Thanks!", "author": "beikov", "createdAt": "2020-11-09T10:15:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODA3MzUwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODA3NjUzMA==", "url": "https://github.com/hibernate/hibernate-orm/pull/3509#discussion_r518076530", "bodyText": "Seems like this will break in cases of de-typed domain models (aka \"map mode\").  Depends how we end up deciding to handle that in building the JPA metamodel.  Regardless, its easy enough to handle here simply by checking for persistentAttribute.getJavaType() == null", "author": "sebersole", "createdAt": "2020-11-05T14:07:35Z", "path": "hibernate-core/src/main/java/org/hibernate/metamodel/model/domain/internal/JpaMetamodelImpl.java", "diffHunk": "@@ -493,6 +500,34 @@ public void processJpa(\n \t\t\tfor ( EmbeddableDomainType<?> embeddable : context.getEmbeddableTypeSet() ) {\n \t\t\t\tthis.jpaEmbeddableDescriptorMap.put( embeddable.getJavaType(), embeddable );\n \t\t\t}\n+\t\t\tStream.concat(\n+\t\t\t\t\tcontext.getEntityTypesByEntityName().values().stream(),\n+\t\t\t\t\tStream.concat(\n+\t\t\t\t\t\t\tcontext.getMappedSuperclassTypeMap().values().stream(),\n+\t\t\t\t\t\t\tcontext.getEmbeddableTypeSet().stream()\n+\t\t\t\t\t)\n+\t\t\t).forEach( managedDomainType -> {\n+\t\t\t\tmanagedDomainType.visitAttributes( persistentAttribute -> {\n+\t\t\t\t\tif ( persistentAttribute.getJavaType().isEnum() ) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY5NTE3NA==", "url": "https://github.com/hibernate/hibernate-orm/pull/3509#discussion_r519695174", "bodyText": "Nice catch, thanks. I adapted it.", "author": "beikov", "createdAt": "2020-11-09T10:15:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODA3NjUzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODA4NTQ1MA==", "url": "https://github.com/hibernate/hibernate-orm/pull/3509#discussion_r518085450", "bodyText": "Few things in this block to keep in mind...\n\nWe prefer to define final variables as final.  You have quite a few here.\nWe prefer code blocks use braces, including switch branches (i.e., case NOT_EQUAL: { ... })", "author": "sebersole", "createdAt": "2020-11-05T14:19:36Z", "path": "hibernate-core/src/main/java/org/hibernate/query/hql/internal/SemanticQueryBuilder.java", "diffHunk": "@@ -1283,28 +1283,89 @@ else if ( ctx.GREATER_EQUAL()!=null ) {\n \n \t@Override\n \tpublic SqmComparisonPredicate visitComparisonPredicate(HqlParser.ComparisonPredicateContext ctx) {\n+\t\tComparisonOperator comparisonOperator = (ComparisonOperator) ctx.comparisonOperator().accept( this );", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY5NTU1MA==", "url": "https://github.com/hibernate/hibernate-orm/pull/3509#discussion_r519695550", "bodyText": "Thanks I'll keep this in mind.", "author": "beikov", "createdAt": "2020-11-09T10:16:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODA4NTQ1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODA4ODg5OQ==", "url": "https://github.com/hibernate/hibernate-orm/pull/3509#discussion_r518088899", "bodyText": "Really, the mapping here is only need to get the converter (if one).  I wonder if we should instead simply pass in the converter?", "author": "sebersole", "createdAt": "2020-11-05T14:23:54Z", "path": "hibernate-core/src/main/java/org/hibernate/query/sql/internal/NativeSelectQueryPlanImpl.java", "diffHunk": "@@ -140,8 +144,12 @@ public NativeSelectQueryPlanImpl(\n \t\t\t\t\t\t\ttype = StandardBasicTypes.OBJECT_TYPE;\n \t\t\t\t\t\t}\n \n-\t\t\t\t\t\tfinal JdbcMapping jdbcMapping = ( (BasicValuedMapping) type ).getJdbcMapping();\n-\t\t\t\t\t\tfinal JdbcParameterImpl jdbcParameter = new JdbcParameterImpl( jdbcMapping );\n+\t\t\t\t\t\tBasicValuedMapping basicValuedMapping = (BasicValuedMapping) type;\n+\t\t\t\t\t\tfinal JdbcMapping jdbcMapping = basicValuedMapping.getJdbcMapping();\n+\t\t\t\t\t\tfinal JdbcParameterImpl jdbcParameter = new JdbcParameterImpl(", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY5NzE3Mw==", "url": "https://github.com/hibernate/hibernate-orm/pull/3509#discussion_r519697173", "bodyText": "I moved the MappingModelExpressable to the QueryParameterBinding now like we discussed to handle the conversion during binding of the parameter value", "author": "beikov", "createdAt": "2020-11-09T10:18:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODA4ODg5OQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "00d6a005b923c964875006fe6f705b128b0ea6e2", "url": "https://github.com/hibernate/hibernate-orm/commit/00d6a005b923c964875006fe6f705b128b0ea6e2", "message": "HHH-10282 Short-hand enum syntax support for HQL", "committedDate": "2020-11-09T14:29:28Z", "type": "commit"}, {"oid": "d5a35128ab99a05dddb8b925f49168e8b2a9725b", "url": "https://github.com/hibernate/hibernate-orm/commit/d5a35128ab99a05dddb8b925f49168e8b2a9725b", "message": "Fix issues with query splitting", "committedDate": "2020-11-09T14:29:28Z", "type": "commit"}, {"oid": "d5a35128ab99a05dddb8b925f49168e8b2a9725b", "url": "https://github.com/hibernate/hibernate-orm/commit/d5a35128ab99a05dddb8b925f49168e8b2a9725b", "message": "Fix issues with query splitting", "committedDate": "2020-11-09T14:29:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg2Mjk1OQ==", "url": "https://github.com/hibernate/hibernate-orm/pull/3509#discussion_r519862959", "bodyText": "We might consider the following pattern:\nStream.of( \n\t\t\t\t\tcontext.getEntityTypesByEntityName().values().stream(),\n\t\t\t\t\tcontext.getMappedSuperclassTypeMap().values().stream(),\n\t\t\t\t\tcontext.getEmbeddableTypeSet().stream()\n\t\t\t).flatMap( Function.identity() ).forEach( ... )\n\nAs per https://www.techempower.com/blog/2016/10/19/efficient-multiple-stream-concatenation-in-java/, the flatmap approach performs better when the stream sizes are not large.", "author": "NathanQingyangXu", "createdAt": "2020-11-09T14:40:54Z", "path": "hibernate-core/src/main/java/org/hibernate/metamodel/model/domain/internal/JpaMetamodelImpl.java", "diffHunk": "@@ -493,6 +500,34 @@ public void processJpa(\n \t\t\tfor ( EmbeddableDomainType<?> embeddable : context.getEmbeddableTypeSet() ) {\n \t\t\t\tthis.jpaEmbeddableDescriptorMap.put( embeddable.getJavaType(), embeddable );\n \t\t\t}\n+\t\t\tStream.concat(\n+\t\t\t\t\tcontext.getEntityTypesByEntityName().values().stream(),\n+\t\t\t\t\tStream.concat(\n+\t\t\t\t\t\t\tcontext.getMappedSuperclassTypeMap().values().stream(),\n+\t\t\t\t\t\t\tcontext.getEmbeddableTypeSet().stream()\n+\t\t\t\t\t)\n+\t\t\t).forEach( managedDomainType -> {", "originalCommit": "d5a35128ab99a05dddb8b925f49168e8b2a9725b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg3NTM5OA==", "url": "https://github.com/hibernate/hibernate-orm/pull/3509#discussion_r519875398", "bodyText": "According to the article the suggestion is to use flatMap(Stream::concat) so I'd rather stick to this pattern.", "author": "beikov", "createdAt": "2020-11-09T14:56:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg2Mjk1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg3NjIwNQ==", "url": "https://github.com/hibernate/hibernate-orm/pull/3509#discussion_r519876205", "bodyText": "I think we could eliminate two unnecessary generics warning by making use of <T> above.", "author": "NathanQingyangXu", "createdAt": "2020-11-09T14:58:06Z", "path": "hibernate-core/src/main/java/org/hibernate/query/internal/QueryParameterBindingImpl.java", "diffHunk": "@@ -227,6 +229,15 @@ public void setBindValues(\n \t\tthis.explicitTemporalPrecision = temporalTypePrecision;\n \t}\n \n+\t@Override\n+\tpublic MappingModelExpressable getType() {\n+\t\treturn type;\n+\t}\n+\n+\t@Override\n+\tpublic void setType(MappingModelExpressable type) {\n+\t\tthis.type = type;\n+\t}", "originalCommit": "d5a35128ab99a05dddb8b925f49168e8b2a9725b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg3OTk1Mw==", "url": "https://github.com/hibernate/hibernate-orm/pull/3509#discussion_r519879953", "bodyText": "I think it would be ideal to include negation counterparts for each of the new testing cases above.", "author": "NathanQingyangXu", "createdAt": "2020-11-09T15:03:02Z", "path": "hibernate-core/src/test/java/org/hibernate/test/enums/OrdinalEnumTypeTest.java", "diffHunk": "@@ -109,6 +109,46 @@ public void testEnumAsBindParameterAndExtract() {\n \t\t} );\n \t}\n \n+\t@Test\n+\t@TestForIssue(jiraKey = \"HHH-10282\")\n+\tpublic void hqlTestEnumShortHandSyntax() {\n+\t\tdoInHibernate( this::sessionFactory, session -> {\n+\t\t\tsession.createQuery(\n+\t\t\t\t\"select id from Person where originalHairColor = BLONDE\")\n+\t\t\t\t.getResultList();\n+\t\t} );\n+\t}\n+\n+\t@Test\n+\t@TestForIssue(jiraKey = \"HHH-10282\")\n+\tpublic void hqlTestEnumQualifiedShortHandSyntax() {\n+\t\tdoInHibernate( this::sessionFactory, session -> {\n+\t\t\tsession.createQuery(\n+\t\t\t\t\t\"select id from Person where originalHairColor = HairColor.BLONDE\")\n+\t\t\t\t\t.getResultList();\n+\t\t} );\n+\t}\n+\n+\t@Test\n+\t@TestForIssue(jiraKey = \"HHH-10282\")\n+\tpublic void hqlTestEnumShortHandSyntaxInPredicate() {\n+\t\tdoInHibernate( this::sessionFactory, session -> {\n+\t\t\tsession.createQuery(\n+\t\t\t\t\t\"select id from Person where originalHairColor in (BLONDE, BROWN)\")\n+\t\t\t\t\t.getResultList();\n+\t\t} );\n+\t}\n+\n+\t@Test\n+\t@TestForIssue(jiraKey = \"HHH-10282\")\n+\tpublic void hqlTestEnumQualifiedShortHandSyntaxInPredicate() {\n+\t\tdoInHibernate( this::sessionFactory, session -> {\n+\t\t\tsession.createQuery(\n+\t\t\t\t\t\"select id from Person where originalHairColor in (HairColor.BLONDE, HairColor.BROWN)\")\n+\t\t\t\t\t.getResultList();\n+\t\t} );\n+\t}\n+", "originalCommit": "d5a35128ab99a05dddb8b925f49168e8b2a9725b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg4MzU1NA==", "url": "https://github.com/hibernate/hibernate-orm/pull/3509#discussion_r519883554", "bodyText": "I think it is one of @sebersole 's personal styles to leave out the blank line before the first element statement in a class. I prefer the above change but it is not a big deal.\nAnother style of Steve is to leave out the space delimiter between generic types as following:\nMap<K,V> map; // I would prefer Map<K, V> map\n\nBut I don't think it is a big deal and they have become my style components as well, :).", "author": "NathanQingyangXu", "createdAt": "2020-11-09T15:07:58Z", "path": "hibernate-core/src/main/java/org/hibernate/sql/exec/internal/JdbcParameterImpl.java", "diffHunk": "@@ -13,6 +13,7 @@\n  * @author Steve Ebersole\n  */\n public class JdbcParameterImpl extends AbstractJdbcParameter {\n+\n \tpublic JdbcParameterImpl(JdbcMapping jdbcMapping) {", "originalCommit": "d5a35128ab99a05dddb8b925f49168e8b2a9725b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}