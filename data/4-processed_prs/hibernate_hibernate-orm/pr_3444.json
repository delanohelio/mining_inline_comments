{"pr_number": 3444, "pr_title": "HHH-14198 - Expose CompositeUserTypes through JPA Metamodel", "pr_createdAt": "2020-06-27T19:10:23Z", "pr_url": "https://github.com/hibernate/hibernate-orm/pull/3444", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU2MTE3Mw==", "url": "https://github.com/hibernate/hibernate-orm/pull/3444#discussion_r446561173", "bodyText": "It seems we might need to swap the two parameter orders for assertEquals(). The issue only manifests itself when testing is broken, however.", "author": "NathanQingyangXu", "createdAt": "2020-06-27T19:50:23Z", "path": "hibernate-core/src/test/java/org/hibernate/test/cut/CompositeUserTypeTest.java", "diffHunk": "@@ -67,6 +83,21 @@ public void testCompositeUserType() {\n \t\tt.commit();\n \t\ts.close();\n \t}\n+\n+\t@Test\n+\tpublic void testMetamodel() {\n+\t\tMetamodelImplementor metamodel = sessionFactory().getMetamodel();\n+\t\tPersistentAttributeDescriptor<? super Transaction, ?> value = metamodel.managedType(Transaction.class).getAttribute(\"value\");\n+\t\tassertEquals(value.getPersistentAttributeType(), Attribute.PersistentAttributeType.EMBEDDED);", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTk2NDI4NA==", "url": "https://github.com/hibernate/hibernate-orm/pull/3444#discussion_r479964284", "bodyText": "After fixing this, I see nothing else blocking this PR. Any concerns @Sanne ?", "author": "beikov", "createdAt": "2020-08-31T08:03:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU2MTE3Mw=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "6f91c1c4751ac711742663e18bf2481432c44d03", "url": "https://github.com/hibernate/hibernate-orm/commit/6f91c1c4751ac711742663e18bf2481432c44d03", "message": "HHH-14198 - Expose CompositeUserTypes through JPA Metamodel\n\nComposite User Types work like regular Composite Types (like Embeddable) in HQL. However, because they cannot be represented in the JPA metamodel, libraries like [GraphQL for JPA](https://github.com/jcrygier/graphql-jpa) or [Blaze-Persistence](https://persistence.blazebit.com/) cannot fully utilize them. In order to make the composite property names available to these libraries, it would be nice to optionally expose these attributes as embedded attributes. This pull request aims to make that change and makes it configurable through a custom setting.\n\nComposite User Types are a common solution for mapping composite interfaces. A common example is for example `Money` from the Java Money API (JSR-354), for which composite user types are implemented in [Jadira](http://jadira.sourceforge.net/usertype-userguide.html).\n\nI know Composite User Types are currently not consiered in Hibernate 6.x. See also [this](https://hibernate.zulipchat.com/#narrow/stream/132094-hibernate-orm-dev/topic/CompositeUserType) Zulip thread. I am not sure if Hibernate 6.x will even have multi column types, which I presume would be a requirement to even introduce Composite User types back at some point. Usually Embeddables are a much easier, suitable mechanism for composite user types. But Embeddables are not always a viable alternative, because Embeddables require the type to be subclassed (as an interface cannot be mapped, and the type may not solely comprise fields that can be mapped to a simple basic type). To deal with this exact problem, `MonetaryAmounts` are still mapped as composite user type. There also have been suggestions to the JPA Spec to consider `AttributeConverters` for Embeddables for pracitcally the same purpose (which I think is going to be a mess of an implementation). See: https://github.com/eclipse-ee4j/jpa-api/issues/105\n\nAnyways, regardless of whether this gets integrated in 5.x, I don't expect it to be integrated in 6.x unless we also reintroduce Composite User Types. I am willing to contribute Composite User Types for 6.x if people see benefit in it and think it can be done in the first place.", "committedDate": "2020-09-03T21:35:53Z", "type": "commit"}, {"oid": "6f91c1c4751ac711742663e18bf2481432c44d03", "url": "https://github.com/hibernate/hibernate-orm/commit/6f91c1c4751ac711742663e18bf2481432c44d03", "message": "HHH-14198 - Expose CompositeUserTypes through JPA Metamodel\n\nComposite User Types work like regular Composite Types (like Embeddable) in HQL. However, because they cannot be represented in the JPA metamodel, libraries like [GraphQL for JPA](https://github.com/jcrygier/graphql-jpa) or [Blaze-Persistence](https://persistence.blazebit.com/) cannot fully utilize them. In order to make the composite property names available to these libraries, it would be nice to optionally expose these attributes as embedded attributes. This pull request aims to make that change and makes it configurable through a custom setting.\n\nComposite User Types are a common solution for mapping composite interfaces. A common example is for example `Money` from the Java Money API (JSR-354), for which composite user types are implemented in [Jadira](http://jadira.sourceforge.net/usertype-userguide.html).\n\nI know Composite User Types are currently not consiered in Hibernate 6.x. See also [this](https://hibernate.zulipchat.com/#narrow/stream/132094-hibernate-orm-dev/topic/CompositeUserType) Zulip thread. I am not sure if Hibernate 6.x will even have multi column types, which I presume would be a requirement to even introduce Composite User types back at some point. Usually Embeddables are a much easier, suitable mechanism for composite user types. But Embeddables are not always a viable alternative, because Embeddables require the type to be subclassed (as an interface cannot be mapped, and the type may not solely comprise fields that can be mapped to a simple basic type). To deal with this exact problem, `MonetaryAmounts` are still mapped as composite user type. There also have been suggestions to the JPA Spec to consider `AttributeConverters` for Embeddables for pracitcally the same purpose (which I think is going to be a mess of an implementation). See: https://github.com/eclipse-ee4j/jpa-api/issues/105\n\nAnyways, regardless of whether this gets integrated in 5.x, I don't expect it to be integrated in 6.x unless we also reintroduce Composite User Types. I am willing to contribute Composite User Types for 6.x if people see benefit in it and think it can be done in the first place.", "committedDate": "2020-09-03T21:35:53Z", "type": "forcePushed"}]}