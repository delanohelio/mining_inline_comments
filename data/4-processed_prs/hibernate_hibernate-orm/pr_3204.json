{"pr_number": 3204, "pr_title": "Log usage of deprecated Dialect classes", "pr_createdAt": "2020-01-31T14:18:23Z", "pr_url": "https://github.com/hibernate/hibernate-orm/pull/3204", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU2MTA3Mg==", "url": "https://github.com/hibernate/hibernate-orm/pull/3204#discussion_r373561072", "bodyText": "This is against the Quarkus mandate that thou shall not read annotations at runtime.  Just saying", "author": "sebersole", "createdAt": "2020-01-31T16:14:41Z", "path": "hibernate-core/src/main/java/org/hibernate/dialect/Dialect.java", "diffHunk": "@@ -225,6 +225,22 @@ protected Dialect() {\n \t\tdefaultSizeStrategy = new DefaultSizeStrategyImpl();\n \t}\n \n+\tprivate void logDeprecation() {\n+\t\tLOG.usingDialect( this );\n+\n+\t\tClass<? extends Dialect> dialect = getClass();\n+\t\tif ( dialect.isAnnotationPresent(Deprecated.class) ) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU2NzgzNg==", "url": "https://github.com/hibernate/hibernate-orm/pull/3204#discussion_r373567836", "bodyText": "Yeah I wondered about that... but this warning isn't necessary in Quarkus, so perhaps it doesn't matter?", "author": "gavinking", "createdAt": "2020-01-31T16:27:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU2MTA3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU3MjAwMg==", "url": "https://github.com/hibernate/hibernate-orm/pull/3204#discussion_r373572002", "bodyText": "The warning is not, but the isAnnotationPresent would still happen.  I don't necessarily care, just pointing it out", "author": "sebersole", "createdAt": "2020-01-31T16:36:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU2MTA3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMwNjA1OQ==", "url": "https://github.com/hibernate/hibernate-orm/pull/3204#discussion_r381306059", "bodyText": "@Sanne what do you think here?", "author": "sebersole", "createdAt": "2020-02-19T13:58:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU2MTA3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMxNzQ5OQ==", "url": "https://github.com/hibernate/hibernate-orm/pull/3204#discussion_r381317499", "bodyText": "Currently the constructor of Dialect is somethign which is not invoked at runtime, so this shouldn't be a problem.\nI do wonder though if this method isn't better off to be invoked explicitly from the Dialect factory, rather than being a side effect of the constructor - I believe that would give us some more flexibility regarding wanting such a check to happen.", "author": "Sanne", "createdAt": "2020-02-19T14:17:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU2MTA3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMzNDY0NQ==", "url": "https://github.com/hibernate/hibernate-orm/pull/3204#discussion_r381334645", "bodyText": "Personally I like the \"do this in DialectFactory\" approach better, but if its not a problem for Quarkus then its not a big deal to me.", "author": "sebersole", "createdAt": "2020-02-19T14:42:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU2MTA3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQwOTk5NA==", "url": "https://github.com/hibernate/hibernate-orm/pull/3204#discussion_r381409994", "bodyText": "I'm perfectly happy to do it in DialectFactory, my only minor concern would be is that if some people have code where they instantiate their Dialect directly, outside of the DialectFactory infrastructure, then they might not get the warning. On the other hand, if they're doing that, then I guess they would get a compilation warning in their code. So that's probably good enough.", "author": "gavinking", "createdAt": "2020-02-19T16:58:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU2MTA3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQxMDY3Ng==", "url": "https://github.com/hibernate/hibernate-orm/pull/3204#discussion_r381410676", "bodyText": "(Let me know what you guys think and I'll make the change if that's what you prefer.)", "author": "gavinking", "createdAt": "2020-02-19T16:59:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU2MTA3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU2MTg2Mg==", "url": "https://github.com/hibernate/hibernate-orm/pull/3204#discussion_r373561862", "bodyText": "I don't think the separate method does anything here; just move that code inline.  Or at least name the method better - it does not just log deprecations", "author": "sebersole", "createdAt": "2020-01-31T16:16:15Z", "path": "hibernate-core/src/main/java/org/hibernate/dialect/Dialect.java", "diffHunk": "@@ -136,7 +136,7 @@\n \t// constructors and factory methods ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n \n \tprotected Dialect() {\n-\t\tLOG.usingDialect( this );\n+\t\tlogDeprecation();", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc3Mjg2MQ==", "url": "https://github.com/hibernate/hibernate-orm/pull/3204#discussion_r373772861", "bodyText": "I renamed it.", "author": "gavinking", "createdAt": "2020-02-01T10:37:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU2MTg2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU5NDE5OA==", "url": "https://github.com/hibernate/hibernate-orm/pull/3204#discussion_r373594198", "bodyText": "I'm surprised this even compiles for you. These ids need to be unique.  The JBoss Logging AP checks that during compile", "author": "sebersole", "createdAt": "2020-01-31T17:25:29Z", "path": "hibernate-core/src/main/java/org/hibernate/internal/log/DeprecationLogger.java", "diffHunk": "@@ -249,4 +249,15 @@ void connectionProviderClassDeprecated(\n \t\t\t\t\t\"5.3 in upgrading.  It will be removed in a later version.\"\n \t)\n \tvoid logUseOfDeprecatedZeroBasedJdbcStyleParams();\n+\n+\t@LogMessage(level = WARN)\n+\t@Message(value = \"%s has been deprecated\",\n+\t\t\tid = 90000025)\n+\tvoid deprecatedDialect(String dialect);\n+\n+\t@LogMessage(level = WARN)\n+\t@Message(value = \"%s has been deprecated; use %s instead\",\n+\t\t\tid = 90000025)", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzYwNzE3NA==", "url": "https://github.com/hibernate/hibernate-orm/pull/3204#discussion_r373607174", "bodyText": "Haha OK sorry I pushed super quickly as I was running out the door.", "author": "gavinking", "createdAt": "2020-01-31T17:56:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU5NDE5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzY3ODUxMw==", "url": "https://github.com/hibernate/hibernate-orm/pull/3204#discussion_r373678513", "bodyText": "Hrm, strange, for me it compiles and no tests fail.\nPerhaps the ids don't need to be unique when you have an overloaded method name like what I have here?\nOr perhaps I'm doing something wrong?\nInvestigating...", "author": "gavinking", "createdAt": "2020-01-31T20:47:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU5NDE5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzY3OTkzOQ==", "url": "https://github.com/hibernate/hibernate-orm/pull/3204#discussion_r373679939", "bodyText": "Seems to work perfectly:\nWARN: HHH90000025: MySQL8Dialect has been deprecated; use org.hibernate.dialect.MySQLDialect instead\n\nAnyway, @sebersole I'm perfectly happy to give them two different ids, I gave them the same id only because I figured that the represented the same problem (use of a deprecated Dialect).\nYour call.", "author": "gavinking", "createdAt": "2020-01-31T20:52:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU5NDE5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMwNTYwMA==", "url": "https://github.com/hibernate/hibernate-orm/pull/3204#discussion_r381305600", "bodyText": "Maybe it does account for overloaded names, not sure.  I agree it is the same underlying issue and would be nice to reuse the same message id.  Just thought that was not allowed (I know its not in other cases).\n@dmlloyd Any thoughts on this?  Thanks", "author": "sebersole", "createdAt": "2020-02-19T13:58:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU5NDE5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMxMDI0OQ==", "url": "https://github.com/hibernate/hibernate-orm/pull/3204#discussion_r381310249", "bodyText": "Overloading is OK if both messages pertain to the \"same\" thing.  The definition of \"same\" is a bit hazy but IMO this case would qualify.\nIIRC overloading the same ID is allowed by the tooling as long as the method name matches as well.", "author": "dmlloyd", "createdAt": "2020-02-19T14:05:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU5NDE5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMzMjIxOQ==", "url": "https://github.com/hibernate/hibernate-orm/pull/3204#discussion_r381332219", "bodyText": "Awesome to know.  Thanks @dmlloyd !", "author": "sebersole", "createdAt": "2020-02-19T14:39:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU5NDE5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMzNTE3MA==", "url": "https://github.com/hibernate/hibernate-orm/pull/3204#discussion_r381335170", "bodyText": "Awesome to know.  Thanks @dmlloyd", "author": "sebersole", "createdAt": "2020-02-19T14:43:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU5NDE5OA=="}], "type": "inlineReview"}, {"oid": "5ee450e9af5f5a1b4aa75736f84bd7a22cecb1ab", "url": "https://github.com/hibernate/hibernate-orm/commit/5ee450e9af5f5a1b4aa75736f84bd7a22cecb1ab", "message": "Log usage of deprecated Dialect classes using DeprecationLogger\n\nWe want people to stop using the ones annotated @Deprecated.", "committedDate": "2020-01-31T20:56:37Z", "type": "commit"}, {"oid": "5ee450e9af5f5a1b4aa75736f84bd7a22cecb1ab", "url": "https://github.com/hibernate/hibernate-orm/commit/5ee450e9af5f5a1b4aa75736f84bd7a22cecb1ab", "message": "Log usage of deprecated Dialect classes using DeprecationLogger\n\nWe want people to stop using the ones annotated @Deprecated.", "committedDate": "2020-01-31T20:56:37Z", "type": "forcePushed"}]}