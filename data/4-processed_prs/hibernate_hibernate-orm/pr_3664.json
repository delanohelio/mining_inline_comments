{"pr_number": 3664, "pr_title": "HHH-14348 Special handling in bytecode enhancement for lazy PersistentCollection fields", "pr_createdAt": "2020-11-25T14:06:37Z", "pr_url": "https://github.com/hibernate/hibernate-orm/pull/3664", "timeline": [{"oid": "b2f0a4f2bf482d0eb2833dc801d46e655ea45434", "url": "https://github.com/hibernate/hibernate-orm/commit/b2f0a4f2bf482d0eb2833dc801d46e655ea45434", "message": "HHH-14348 Special handling in bytecode enhancement for lazy PersistentCollection fields", "committedDate": "2020-11-25T14:06:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU3NzczMg==", "url": "https://github.com/hibernate/hibernate-orm/pull/3664#discussion_r530577732", "bodyText": "Just curious: what was the reason for this change?", "author": "gavinking", "createdAt": "2020-11-25T18:42:20Z", "path": "hibernate-core/src/main/java/org/hibernate/bytecode/enhance/spi/interceptor/LazyAttributesMetadata.java", "diffHunk": "@@ -49,7 +48,7 @@ public static LazyAttributesMetadata from(\n \t\t\t\t\tproperty,\n \t\t\t\t\tisEnhanced,\n \t\t\t\t\tallowEnhancementAsProxy,\n-\t\t\t\t\tcollectionsInDefaultFetchGroupEnabled\n+\t\t\t\t\tfalse", "originalCommit": "b2f0a4f2bf482d0eb2833dc801d46e655ea45434", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU5MjM4NQ==", "url": "https://github.com/hibernate/hibernate-orm/pull/3664#discussion_r530592385", "bodyText": "We have to consider attributes that are lazy from a persistence perspective, as lazy in bytecode enhancement. The flag would have caused the bytecode enhancement to see collections as part of the base fetch group which more or less means initialized. This is why the size code was triggered.\nThe whole bytecode enhancement logic is a bit of a mess in my opinion and I plan to improve this significantly in 6.0.", "author": "beikov", "createdAt": "2020-11-25T19:13:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU3NzczMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk0NzMwMA==", "url": "https://github.com/hibernate/hibernate-orm/pull/3664#discussion_r530947300", "bodyText": "@beikov well if that's the case then that sounds like we should be rolling back my patch which added collectionsInDefaultFetchGroupEnabled in the first place! Apparently it only worked by coincidence because there was another bug.\nThe semantics of collectionsInDefaultFetchGroupEnabled was supposed to be that:\n\nthe field would be initialized, but\nthe collection wrapper would remain uninitialized and unfetched.\n\nIt was definitely not supposed to mean that the collection would be eagerly fetched.\nBut please define what you mean by \"more or less\" here.", "author": "gavinking", "createdAt": "2020-11-26T11:01:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU3NzczMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk3MTE3Nw==", "url": "https://github.com/hibernate/hibernate-orm/pull/3664#discussion_r530971177", "bodyText": "By not considering this flag here, it gets your desired semantics.\nThis part of the code determines if an attribute is considered lazy, which bytecode enhancement uses for determining whether it needs to initialize the object on access. Any attributes that are not listed as lazy are considered to be initialized. So when we access the collection then through calling size() this causes lazy initialization.", "author": "beikov", "createdAt": "2020-11-26T11:43:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU3NzczMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTc4NjExOA==", "url": "https://github.com/hibernate/hibernate-orm/pull/3664#discussion_r531786118", "bodyText": "FTR: @beikov and I chatted on the phone, and the decided that the changes related to collectionsInDefaultFetchGroupEnabled were not necessary.", "author": "gavinking", "createdAt": "2020-11-27T21:08:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU3NzczMg=="}], "type": "inlineReview"}, {"oid": "4528ac43cbd3525aa92a6de6dbd628fecd4cf06e", "url": "https://github.com/hibernate/hibernate-orm/commit/4528ac43cbd3525aa92a6de6dbd628fecd4cf06e", "message": "Restore collectionsInDefaultFetchGroupEnabled usage in LazyAttributesMetadata", "committedDate": "2020-11-26T14:11:33Z", "type": "commit"}]}