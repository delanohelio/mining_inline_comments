{"pr_number": 3402, "pr_title": "wip/6.0 Fix some logging performance issues", "pr_createdAt": "2020-05-15T14:46:04Z", "pr_url": "https://github.com/hibernate/hibernate-orm/pull/3402", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTg1MjQ1OA==", "url": "https://github.com/hibernate/hibernate-orm/pull/3402#discussion_r425852458", "bodyText": "The above string concatenation will incur performance cost invariably even though trace logging level is disabled", "author": "NathanQingyangXu", "createdAt": "2020-05-15T14:47:04Z", "path": "hibernate-core/src/main/java/org/hibernate/boot/archive/internal/ArchiveHelper.java", "diffHunk": "@@ -93,7 +93,7 @@ else if ( \"zip\".equals( protocol )\n \t\t\t\t\t\"Unable to determine JAR Url from \" + url + \". Cause: \" + e.getMessage()\n \t\t\t);\n \t\t}\n-\t\tlog.trace( \"JAR URL from URL Entry: \" + url + \" >> \" + jarUrl );", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTg1NDAyOA==", "url": "https://github.com/hibernate/hibernate-orm/pull/3402#discussion_r425854028", "bodyText": "I added logging level checking whenever the method invoking is involved. We never know how much performance cost will be paid for future coding might provide an overridden heavy weight method implementation. Adding logging level checking is simple and future proof.", "author": "NathanQingyangXu", "createdAt": "2020-05-15T14:49:21Z", "path": "hibernate-core/src/main/java/org/hibernate/boot/archive/internal/StandardArchiveDescriptorFactory.java", "diffHunk": "@@ -130,12 +130,14 @@ public URL adjustJarFileEntryUrl(URL url, URL rootUrl) {\n \t\t\t}\n \t\t\tcatch (MalformedURLException e) {\n \t\t\t\t// allow to pass through to return the original URL\n-\t\t\t\tlog.debugf(\n-\t\t\t\t\t\te,\n-\t\t\t\t\t\t\"Unable to adjust relative <jar-file/> URL [%s] relative to root URL [%s]\",\n-\t\t\t\t\t\tfilePart,\n-\t\t\t\t\t\trootUrlFile.getAbsolutePath()\n-\t\t\t\t);\n+\t\t\t\tif ( log.isDebugEnabled() ) {\n+\t\t\t\t\tlog.debugf(\n+\t\t\t\t\t\t\te,\n+\t\t\t\t\t\t\t\"Unable to adjust relative <jar-file/> URL [%s] relative to root URL [%s]\",\n+\t\t\t\t\t\t\tfilePart,\n+\t\t\t\t\t\t\trootUrlFile.getAbsolutePath()", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTg5ODUwNA==", "url": "https://github.com/hibernate/hibernate-orm/pull/3402#discussion_r425898504", "bodyText": "Yes, it is future proof.  For whatever reason, and I may be in the minority which is fine, I prefer to not do the level check in trivial cases.  I don't think it is as easy as saying \"well anything that calls a method.  E.g. here calling #getAbsolutePath() does have an overhead, so this is fine.  The reason I prefer to avoid the check is ofc because the logging system does the same checks already.  I'm just talking in the general case as a reply to your comment.  Again, here it is fine", "author": "sebersole", "createdAt": "2020-05-15T16:00:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTg1NDAyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxMTAxMQ==", "url": "https://github.com/hibernate/hibernate-orm/pull/3402#discussion_r426011011", "bodyText": "Yeah, this is not clear-cut decision and it is hard to decide which scenario is trivial. Yeah, method invoking might not be a good criterion.", "author": "NathanQingyangXu", "createdAt": "2020-05-15T19:41:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTg1NDAyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTg1NTY3NA==", "url": "https://github.com/hibernate/hibernate-orm/pull/3402#discussion_r425855674", "bodyText": "The above pattern has two drawbacks:\n\nunnecessary string concatenation cost even the produced string is simply discarded later due to level disabling\nthe produced string might contain magic chars (i.e. %s) and will explode during runtime", "author": "NathanQingyangXu", "createdAt": "2020-05-15T14:51:57Z", "path": "hibernate-core/src/main/java/org/hibernate/boot/model/source/internal/hbm/ModelBinder.java", "diffHunk": "@@ -4221,7 +4227,7 @@ public void addAttributeBinding(Property attributeBinding) {\n \n \t\t@Override\n \t\tpublic void process() {\n-\t\t\tlog.debugf( \"Binding natural-id UniqueKey for entity : \" + entityBinding.getEntityName() );", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTg1ODA0NA==", "url": "https://github.com/hibernate/hibernate-orm/pull/3402#discussion_r425858044", "bodyText": "It is still a common bug to miss format parameter. I tried the Checker Framework (https://checkerframework.org/) but it crashed when I used it on hibernate-orm, :(.", "author": "NathanQingyangXu", "createdAt": "2020-05-15T14:55:24Z", "path": "hibernate-core/src/main/java/org/hibernate/resource/beans/container/internal/JpaCompliantLifecycleStrategy.java", "diffHunk": "@@ -125,7 +125,7 @@ public void initialize() {\n \t\t\t\tthrow e;\n \t\t\t}\n \t\t\tcatch (Exception e) {\n-\t\t\t\tlog.debugf( \"Error resolving CDI bean [%s] - using fallback\" );\n+\t\t\t\tlog.debugf( \"Error resolving CDI bean [%s] - using fallback\", beanType.getName() );", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "be85c2479a898f8ec09e9f64dcb385894ca7204a", "url": "https://github.com/hibernate/hibernate-orm/commit/be85c2479a898f8ec09e9f64dcb385894ca7204a", "message": "fix some logging performance issues", "committedDate": "2020-05-31T17:12:45Z", "type": "commit"}, {"oid": "be85c2479a898f8ec09e9f64dcb385894ca7204a", "url": "https://github.com/hibernate/hibernate-orm/commit/be85c2479a898f8ec09e9f64dcb385894ca7204a", "message": "fix some logging performance issues", "committedDate": "2020-05-31T17:12:45Z", "type": "forcePushed"}]}