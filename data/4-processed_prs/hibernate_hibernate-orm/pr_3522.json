{"pr_number": 3522, "pr_title": "HHH-11877 Wrap CompoundPredicate's expression list", "pr_createdAt": "2020-08-25T14:17:43Z", "pr_url": "https://github.com/hibernate/hibernate-orm/pull/3522", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDAwMDEwNQ==", "url": "https://github.com/hibernate/hibernate-orm/pull/3522#discussion_r480000105", "bodyText": "IMO we should instead call wrap in CompoundPredicate when adding elements.", "author": "beikov", "createdAt": "2020-08-31T09:13:45Z", "path": "hibernate-core/src/main/java/org/hibernate/query/criteria/internal/CriteriaBuilderImpl.java", "diffHunk": "@@ -255,6 +255,12 @@ public Order desc(Expression<?> x) {\n \n \tpublic Predicate wrap(Expression<Boolean> expression) {\n \t\tif ( Predicate.class.isInstance( expression ) ) {\n+\t\t\tif ( CompoundPredicate.class.isInstance( expression ) ) {", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA2OTI5NA==", "url": "https://github.com/hibernate/hibernate-orm/pull/3522#discussion_r480069294", "bodyText": "You mean adding a new wrap method to CompoundPredicate? I did consider that but the code logic needs invoking the CriteriaBuilderImpl#wrap() recursively which makes the code difficult to read and understand. The current approach centralizes everything related to wrapping in this single method.\nAnother alternative is to add new overloading methods in the same class as following:\npublic Predicate wrap(Predicate predicate) {\n        return predicate;\n}\n\npublic Predicate wrap(CompoundPredicate compoundPredicate) {\n        final List<Expression<Boolean>> expressions = compoundPredicate.getExpressions();\n        for ( int i = 0; i < expressions.size(); i++ ) {\n\t\texpressions.set( i, wrap( expressions.get( i ) ) );\n\t}\n        return compoundPredicate;\n}\n\nThis approach seems to succeed in avoiding Class#isInstance() usage and to be a little bit more elegant, but it has downside in that the wrap method user might misuse the API. There is a good example of such misuse I encountered: jboss-logging/jboss-logging#36.", "author": "NathanQingyangXu", "createdAt": "2020-08-31T11:30:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDAwMDEwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA4NTMyMw==", "url": "https://github.com/hibernate/hibernate-orm/pull/3522#discussion_r480085323", "bodyText": "I refactored as you suggested. There is both pros and cons, but if the new public method is useful in other scenarios than CriteriaBuilderImpl, it might be worthwhile.", "author": "NathanQingyangXu", "createdAt": "2020-08-31T12:06:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDAwMDEwNQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEwNTIzNQ==", "url": "https://github.com/hibernate/hibernate-orm/pull/3522#discussion_r480105235", "bodyText": "Maybe it's better to do the wrapping in applyExpressions as that is the only code where expressions are added to the list.", "author": "beikov", "createdAt": "2020-08-31T12:45:24Z", "path": "hibernate-core/src/main/java/org/hibernate/query/criteria/internal/predicate/CompoundPredicate.java", "diffHunk": "@@ -125,6 +125,13 @@ public Predicate not() {\n \t\treturn new NegatedPredicateWrapper( this );\n \t}\n \n+\tpublic void wrap() {\n+\t\tfinal CriteriaBuilderImpl criteriaBuilder = criteriaBuilder();\n+\t\tfor ( int i = 0, size = expressions.size(); i < size; i++ ) {\n+\t\t\texpressions.set( i, criteriaBuilder.wrap( expressions.get( i ) ) );", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEyNzY5NQ==", "url": "https://github.com/hibernate/hibernate-orm/pull/3522#discussion_r480127695", "bodyText": "done. thanks.", "author": "NathanQingyangXu", "createdAt": "2020-08-31T13:23:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDEwNTIzNQ=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "8aa5b6d6e58985bb6637aec2300c41b7d2c4e035", "url": "https://github.com/hibernate/hibernate-orm/commit/8aa5b6d6e58985bb6637aec2300c41b7d2c4e035", "message": "HHH-11877 wrap CompoundPredicate's expression list", "committedDate": "2020-08-31T13:21:26Z", "type": "commit"}, {"oid": "8aa5b6d6e58985bb6637aec2300c41b7d2c4e035", "url": "https://github.com/hibernate/hibernate-orm/commit/8aa5b6d6e58985bb6637aec2300c41b7d2c4e035", "message": "HHH-11877 wrap CompoundPredicate's expression list", "committedDate": "2020-08-31T13:21:26Z", "type": "forcePushed"}]}