{"pr_number": 3255, "pr_title": "Wip/6.0 Wrap up verification of 'sorted-map' and 'sorted-set'", "pr_createdAt": "2020-02-21T20:10:46Z", "pr_url": "https://github.com/hibernate/hibernate-orm/pull/3255", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjkyMjM0MA==", "url": "https://github.com/hibernate/hibernate-orm/pull/3255#discussion_r382922340", "bodyText": "An example error message I encountered went like this:\nExpected: iterable containing [\"aBC\", \"bcD\", \"cDe\", \"DeF\", \"Efg\"]\n     but: item 0: was \"abc\"", "author": "NathanQingyangXu", "createdAt": "2020-02-22T15:58:22Z", "path": "hibernate-core/src/test/java/org/hibernate/orm/test/metamodel/mapping/collections/SetOperationTests.java", "diffHunk": "@@ -164,14 +168,40 @@ public void testSortedSetAccess(SessionFactoryScope scope) {\n \t\t\t\t\t// trigger the init\n \t\t\t\t\tHibernate.initialize( entity.getSortedSetOfBasics() );\n \t\t\t\t\tassertThat( entity.getSortedSetOfBasics(), InitializationCheckMatcher.isInitialized() );\n-\t\t\t\t\tassertThat( entity.getSortedSetOfBasics().size(), is( 2 ) );\n+\t\t\t\t\tassertThat( entity.getSortedSetOfBasics(), IsCollectionWithSize.hasSize( 5 ) );\n+\t\t\t\t\tassertThat( entity.getSetOfEnums(), InitializationCheckMatcher.isNotInitialized() );\n+\n+\t\t\t\t\tassertThat( entity.getSortedSetOfBasics(), IsIterableContainingInOrder.contains(\n+\t\t\t\t\t\t\t\"abc\",\n+\t\t\t\t\t\t\t\"bcd\",\n+\t\t\t\t\t\t\t\"cde\",\n+\t\t\t\t\t\t\t\"def\",\n+\t\t\t\t\t\t\t\"efg\"\n+\t\t\t\t\t) );", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjkyMjcwMA==", "url": "https://github.com/hibernate/hibernate-orm/pull/3255#discussion_r382922700", "bodyText": "A common erroneous usage of assertEquals in our codebase.", "author": "NathanQingyangXu", "createdAt": "2020-02-22T16:03:20Z", "path": "hibernate-core/src/test/java/org/hibernate/orm/test/sql/exec/onetoone/OneToOneWithDerivedIdentityTest.java", "diffHunk": "@@ -52,7 +52,7 @@ public void testGet() {\n \t\tinTransaction(\n \t\t\t\tsession -> {\n \t\t\t\t\tPerson person = session.get( Person.class, PERSON_ID );\n-\t\t\t\t\tassertEquals( person.getName(), \"Alfio\" );\n+\t\t\t\t\tassertEquals( \"Alfio\", person.getName() );", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg4OTQ3OA==", "url": "https://github.com/hibernate/hibernate-orm/pull/3255#discussion_r389889478", "bodyText": "Yes, this is once of the great things about hamcrest which we use in newer tests", "author": "sebersole", "createdAt": "2020-03-09T18:44:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjkyMjcwMA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzA0MzgzMg==", "url": "https://github.com/hibernate/hibernate-orm/pull/3255#discussion_r383043832", "bodyText": "So the obvious bug here is we did build join but didn't add it to 'joins' field. Simple fixing.", "author": "NathanQingyangXu", "createdAt": "2020-02-23T22:16:32Z", "path": "hibernate-core/src/main/java/org/hibernate/query/sqm/tree/domain/AbstractSqmFrom.java", "diffHunk": "@@ -409,55 +409,55 @@ public SqmMapJoin joinMap(String attributeName, JoinType jt) {\n \t\t\tSqmPathSource<A> joinedPathSource,\n \t\t\tSqmJoinType joinType,\n \t\t\tboolean fetched) {\n+\t\tfinal SqmAttributeJoin sqmJoin;\n \t\tif ( joinedPathSource instanceof SingularPersistentAttribute ) {\n-\t\t\treturn buildSingularJoin(\n+\t\t\tsqmJoin = buildSingularJoin(\n \t\t\t\t\t(SingularPersistentAttribute<T,A>) joinedPathSource,\n \t\t\t\t\tjoinType,\n \t\t\t\t\tfetched\n \t\t\t);\n \t\t}\n-\n-\t\tif ( joinedPathSource instanceof BagPersistentAttribute ) {\n-\t\t\treturn buildBagJoin(\n+\t\telse if ( joinedPathSource instanceof BagPersistentAttribute ) {\n+\t\t\tsqmJoin = buildBagJoin(\n \t\t\t\t\t(BagPersistentAttribute) joinedPathSource,\n \t\t\t\t\tjoinType,\n \t\t\t\t\tfetched\n \t\t\t);\n \t\t}\n-\n-\t\tif ( joinedPathSource instanceof ListPersistentAttribute ) {\n-\t\t\treturn buildListJoin(\n+\t\telse if ( joinedPathSource instanceof ListPersistentAttribute ) {\n+\t\t\tsqmJoin = buildListJoin(\n \t\t\t\t\t(ListPersistentAttribute) joinedPathSource,\n \t\t\t\t\tjoinType,\n \t\t\t\t\tfetched\n \t\t\t);\n \t\t}\n-\n-\t\tif ( joinedPathSource instanceof MapPersistentAttribute ) {\n-\t\t\treturn buildMapJoin(\n+\t\telse if ( joinedPathSource instanceof MapPersistentAttribute ) {\n+\t\t\tsqmJoin = buildMapJoin(\n \t\t\t\t\t(MapPersistentAttribute) joinedPathSource,\n \t\t\t\t\tjoinType,\n \t\t\t\t\tfetched\n \t\t\t);\n \t\t}\n-\n-\t\tif ( joinedPathSource instanceof SetPersistentAttribute ) {\n-\t\t\treturn buildSetJoin(\n+\t\telse if ( joinedPathSource instanceof SetPersistentAttribute ) {\n+\t\t\tsqmJoin = buildSetJoin(\n \t\t\t\t\t(SetPersistentAttribute) joinedPathSource,\n \t\t\t\t\tjoinType,\n \t\t\t\t\tfetched\n \t\t\t);\n \t\t}\n-\n-\t\tthrow new IllegalArgumentException(\n-\t\t\t\tString.format(\n-\t\t\t\t\t\tLocale.ROOT,\n-\t\t\t\t\t\t\"Passed attribute [%s] did not correspond to a joinable reference [%s] relative to %s\",\n-\t\t\t\t\t\tjoinedPathSource.getPathName(),\n-\t\t\t\t\t\tjoinedPathSource,\n-\t\t\t\t\t\tgetNavigablePath().getFullPath()\n-\t\t\t\t)\n-\t\t);\n+\t\telse {\n+\t\t\tthrow new IllegalArgumentException(\n+\t\t\t\t\tString.format(\n+\t\t\t\t\t\t\tLocale.ROOT,\n+\t\t\t\t\t\t\t\"Passed attribute [%s] did not correspond to a joinable reference [%s] relative to %s\",\n+\t\t\t\t\t\t\tjoinedPathSource.getPathName(),\n+\t\t\t\t\t\t\tjoinedPathSource,\n+\t\t\t\t\t\t\tgetNavigablePath().getFullPath()\n+\t\t\t\t\t)\n+\t\t\t);\n+\t\t}\n+\t\taddSqmJoin( sqmJoin );", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "abceaf0cf7284331085ef55d32d5bdb6f9d8b1df", "url": "https://github.com/hibernate/hibernate-orm/commit/abceaf0cf7284331085ef55d32d5bdb6f9d8b1df", "message": "wrap up verification for both @SortedSet and @SortedMap", "committedDate": "2020-03-04T00:34:49Z", "type": "commit"}, {"oid": "abceaf0cf7284331085ef55d32d5bdb6f9d8b1df", "url": "https://github.com/hibernate/hibernate-orm/commit/abceaf0cf7284331085ef55d32d5bdb6f9d8b1df", "message": "wrap up verification for both @SortedSet and @SortedMap", "committedDate": "2020-03-04T00:34:49Z", "type": "forcePushed"}]}