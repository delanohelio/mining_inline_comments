{"pr_number": 3233, "pr_title": "Wip/6.0 HHH-13877 Make`@SortNatural` default for SortedSet and SortedMap", "pr_createdAt": "2020-02-12T03:47:45Z", "pr_url": "https://github.com/hibernate/hibernate-orm/pull/3233", "timeline": [{"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1NjIxMA==", "url": "https://github.com/hibernate/hibernate-orm/pull/3233#discussion_r379156210", "bodyText": "I manually compared to explicit @SortNatural case and found everything is the same(only hadExplicitSort values are different but it is used internally in this method and its main usage is the above code snippet), so removing the above code snippet seems enough to achieve the goal of this PR, unless I were wrong.", "author": "NathanQingyangXu", "createdAt": "2020-02-13T22:30:41Z", "path": "hibernate-core/src/main/java/org/hibernate/cfg/annotations/CollectionBinder.java", "diffHunk": "@@ -663,14 +663,6 @@ else if ( comparatorSort != null ) {\n \t\t\t}\n \t\t}\n \n-\t\tif ( isSortedCollection ) {\n-\t\t\tif ( ! hadExplicitSort && !hadOrderBy ) {\n-\t\t\t\tthrow new AnnotationException(\n-\t\t\t\t\t\t\"A sorted collection must define and ordering or sorting : \" + safeCollectionRole()\n-\t\t\t\t);\n-\t\t\t}\n-\t\t}\n-", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk4OTMzMA==", "url": "https://github.com/hibernate/hibernate-orm/pull/3233#discussion_r381989330", "bodyText": "We should also assert that the phones are in fact sorted in proper order.", "author": "sebersole", "createdAt": "2020-02-20T13:13:39Z", "path": "hibernate-core/src/test/java/org/hibernate/orm/test/metamodel/mapping/collections/SortNaturalByDefaultTests.java", "diffHunk": "@@ -0,0 +1,166 @@\n+package org.hibernate.orm.test.metamodel.mapping.collections;\n+\n+import java.util.Arrays;\n+import java.util.Objects;\n+import java.util.SortedSet;\n+import java.util.TreeSet;\n+import javax.persistence.CascadeType;\n+import javax.persistence.Entity;\n+import javax.persistence.GeneratedValue;\n+import javax.persistence.Id;\n+import javax.persistence.OneToMany;\n+\n+import org.hibernate.testing.orm.junit.DomainModel;\n+import org.hibernate.testing.orm.junit.ServiceRegistry;\n+import org.hibernate.testing.orm.junit.SessionFactory;\n+import org.hibernate.testing.orm.junit.SessionFactoryScope;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+\n+/**\n+ * Tests Hibernate specific feature that {@link org.hibernate.annotations.SortNatural @SortNatural} will take effect implicitly\n+ * when no <i>sort</i> or <i>order</i> related annotations exist, including:\n+ * <ul>\n+ *     <li>{@link org.hibernate.annotations.SortNatural @SortNatural}</li>\n+ *     <li>{@link org.hibernate.annotations.SortComparator @SortComparator}</li>\n+ *     <li>{@link org.hibernate.annotations.Sort @Sort}</li>\n+ *     <li>{@link org.hibernate.annotations.OrderBy @OrderBy(from hibernate)}</li>\n+ *     <li>{@link javax.persistence.OrderBy @OrderBy(from JPA)}</li>\n+ * </ul>\n+ * \n+ * @author Nathan Xu\n+ */\n+@ServiceRegistry\n+@DomainModel(\n+\tannotatedClasses = {\n+\t\tSortNaturalByDefaultTests.Person.class,\n+\t\tSortNaturalByDefaultTests.Phone.class\n+\t}\n+)\n+@SessionFactory\n+public class SortNaturalByDefaultTests {\n+\t\n+\t@Test\n+\tvoid test(SessionFactoryScope scope) {\n+\t\tscope.inTransaction(\n+\t\t\tsession -> {\n+\t\t\t\tfinal Person person = session.createQuery( \"select p from Person p\", Person.class ).getSingleResult();\n+\t\t\t\tfinal SortedSet<Phone> phones = person.getPhones();\n+\t\t\t\tassertThat( phones.size(), is( 3 ) );", "originalCommit": null, "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA4NjM5OA==", "url": "https://github.com/hibernate/hibernate-orm/pull/3233#discussion_r382086398", "bodyText": "Updated. Originally I had thought we might end up with testing SortedSet or SortedMap. Testing case enriched enormously.", "author": "NathanQingyangXu", "createdAt": "2020-02-20T15:48:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk4OTMzMA=="}], "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzAxODk5MA==", "url": "https://github.com/hibernate/hibernate-orm/pull/3233#discussion_r383018990", "bodyText": "It doesn't make sense to insert testing data with the natural order. Ideally we are supposed to populate big number of data to ensure the order is not maintained not by accident.", "author": "NathanQingyangXu", "createdAt": "2020-02-23T16:33:05Z", "path": "hibernate-core/src/test/java/org/hibernate/orm/test/metamodel/mapping/collections/MapOperationTests.java", "diffHunk": "@@ -47,8 +47,11 @@ public void createData(SessionFactoryScope scope) {\n \t\t\t\t\tentityContainingMaps.addBasicByBasic( \"someKey\", \"someValue\" );\n \t\t\t\t\tentityContainingMaps.addBasicByBasic( \"anotherKey\", \"anotherValue\" );\n \n-\t\t\t\t\tentityContainingMaps.addSortedBasicByBasic( \"key1\", \"value1\" );\n \t\t\t\t\tentityContainingMaps.addSortedBasicByBasic( \"key2\", \"value2\" );\n+\t\t\t\t\tentityContainingMaps.addSortedBasicByBasic( \"key1\", \"value1\" );", "originalCommit": null, "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": null, "url": null, "message": null, "committedDate": null, "type": "forcePushed"}, {"oid": "76482302b496251b350479bc05ca273a516da2f5", "url": "https://github.com/hibernate/hibernate-orm/commit/76482302b496251b350479bc05ca273a516da2f5", "message": "HHH-13877 - Make @SortNatural by default", "committedDate": "2020-03-19T19:03:28Z", "type": "commit"}, {"oid": "76482302b496251b350479bc05ca273a516da2f5", "url": "https://github.com/hibernate/hibernate-orm/commit/76482302b496251b350479bc05ca273a516da2f5", "message": "HHH-13877 - Make @SortNatural by default", "committedDate": "2020-03-19T19:03:28Z", "type": "forcePushed"}]}