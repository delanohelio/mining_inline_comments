{"pr_number": 18, "pr_title": "Api improvements", "pr_createdAt": "2020-02-05T11:34:10Z", "pr_url": "https://github.com/artipie/http/pull/18", "timeline": [{"oid": "34e51637bc06ca1b991e3e6abbe392c2c8bb8cfb", "url": "https://github.com/artipie/http/commit/34e51637bc06ca1b991e3e6abbe392c2c8bb8cfb", "message": "api improvements", "committedDate": "2020-02-05T11:32:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI5NjAwNA==", "url": "https://github.com/artipie/http/pull/18#discussion_r375296004", "bodyText": "@Sammers21 I'd keep it as Map<String, Iterable<String>> for two reasons:\n1 - list provides API to modify itself, it's not acceptable in case of response. Response headers should not be changed after construction\n2 - readability - it would be easier to understand that headers is a mapping with one-to-many relation when using Map", "author": "g4s8", "createdAt": "2020-02-05T14:43:03Z", "path": "src/main/java/com/artipie/http/Destination.java", "diffHunk": "@@ -21,48 +21,26 @@\n  * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n  * SOFTWARE.\n  */\n-\n package com.artipie.http;\n \n-import java.io.IOException;\n+import java.util.List;\n import java.util.Map;\n import java.util.concurrent.Flow;\n \n /**\n- * HTTP request.\n- * @see <a href=\"https://www.w3.org/Protocols/rfc2616/rfc2616-sec5.html\">RFC2616</a>\n+ * The destination to be rendered.\n  * @since 0.1\n  */\n-public interface Request {\n-\n-    /**\n-     * Request line.\n-     * <p>\n-     * See 5.1 section of rfc2616.\n-     * Request line is {@code Method SP Request-URI SP HTTP-Version CRLF}.\n-     * </p>\n-     * @return Line string\n-     * @throws IOException On IO failure\n-     */\n-    String line() throws IOException;\n+public interface Destination {\n \n     /**\n-     * General headers, request headers and entity headers.\n-     * <p>\n-     * See 4.5, 5.3 and 7.1 sections of rfc2616.\n-     * </p>\n-     * @return Map of header values by name\n-     * @throws IOException On IO failure\n+     * Render the destination.\n+     * @param code The http status code.\n+     * @param headers The http request headers.\n+     * @param body The http response body.\n      */\n-    Map<String, Iterable<String>> headers() throws IOException;\n+    void renderIt(int code,\n+        List<Map.Entry<String, String>> headers,", "originalCommit": "8b79138474b4b7058bdfd09a5c265a2fa4acca2f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTMyNDgyNg==", "url": "https://github.com/artipie/http/pull/18#discussion_r375324826", "bodyText": "1- list provides API to modify itself, it's not acceptable in case of response. Response headers should not be changed after construction\n\nWhy do you think that Map is acceptable then?\n\n2 - readability - it would be easier to understand that headers is a mapping with one-to-many relation when using Map\n\nIt is subjective. I would say List<Map.Entry<String, String>>  better coincide with the HTTP specification, hence more understandable and clear.", "author": "Sammers21", "createdAt": "2020-02-05T15:27:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI5NjAwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTMzNDEwMw==", "url": "https://github.com/artipie/http/pull/18#discussion_r375334103", "bodyText": "@Sammers21 it makes sense, let's use Iterable<Map.Entry<String, String>> then", "author": "g4s8", "createdAt": "2020-02-05T15:41:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI5NjAwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTM3ODk1Mg==", "url": "https://github.com/artipie/http/pull/18#discussion_r375378952", "bodyText": "@g4s8, Iterable also allow modifications", "author": "Sammers21", "createdAt": "2020-02-05T16:51:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI5NjAwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ0Mzc2Nw==", "url": "https://github.com/artipie/http/pull/18#discussion_r375443767", "bodyText": "@Sammers21 you can't: https://docs.oracle.com/javase/8/docs/api/java/lang/Iterable.html\nAll you can do with Iterable is iterating over its items", "author": "g4s8", "createdAt": "2020-02-05T18:54:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI5NjAwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ0NzI5NA==", "url": "https://github.com/artipie/http/pull/18#discussion_r375447294", "bodyText": "Iterators allow the caller to remove elements from the underlying collection during the iteration with well-defined semantics", "author": "Sammers21", "createdAt": "2020-02-05T19:01:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI5NjAwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ1MjMyNw==", "url": "https://github.com/artipie/http/pull/18#discussion_r375452327", "bodyText": "@Sammers21 but the default implementation of remove() throws UnsupportedOperationException: https://docs.oracle.com/javase/8/docs/api/java/util/Iterator.html#remove--", "author": "g4s8", "createdAt": "2020-02-05T19:11:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI5NjAwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY5ODEyOA==", "url": "https://github.com/artipie/http/pull/18#discussion_r375698128", "bodyText": "@g4s8, what is wrong with using List then?  We can use a List implementation which will throw an exception on modification attempt", "author": "Sammers21", "createdAt": "2020-02-06T08:34:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI5NjAwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTcxMDU3NQ==", "url": "https://github.com/artipie/http/pull/18#discussion_r375710575", "bodyText": "@Sammers21 List is too specific for this case. We don't need the majority of List methods in request headers parsing, e.g. we don't need add(), remove(), get(8), clear() and others. All we need here is iterating over headers. Maybe it would be better to create custom Headers type with methods like headers.values(\"header-name\")", "author": "g4s8", "createdAt": "2020-02-06T09:02:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI5NjAwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI5NjQ0Mg==", "url": "https://github.com/artipie/http/pull/18#discussion_r375296442", "bodyText": "@Sammers21 same here about headers. Also, it would be hard to find header by name using list of entries", "author": "g4s8", "createdAt": "2020-02-05T14:43:47Z", "path": "src/main/java/com/artipie/http/Slice.java", "diffHunk": "@@ -39,9 +40,13 @@\n public interface Slice {\n \n     /**\n-     * Try to respond for the request.\n-     * @param req Request\n-     * @return Future response\n+     * Respond to a http request.\n+     * @param line The request line\n+     * @param headers The request headers\n+     * @param body The request body\n+     * @return The response.\n      */\n-    CompletableFuture<Response> respond(Request req);\n+    Response response(String line,\n+        List<Map.Entry<String, String>> headers,", "originalCommit": "8b79138474b4b7058bdfd09a5c265a2fa4acca2f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI5Njk3OQ==", "url": "https://github.com/artipie/http/pull/18#discussion_r375296979", "bodyText": "@Sammers21 why did you remove javadoc links to HTTP spec from Response class?", "author": "g4s8", "createdAt": "2020-02-05T14:44:40Z", "path": "src/main/java/com/artipie/http/Response.java", "diffHunk": "@@ -35,30 +33,9 @@\n public interface Response {\n \n     /**\n-     * Status line.\n-     * <p>\n-     * Status line is {@code HTTP-Version SP Status-Code SP Reason-Phrase CRLF}.\n-     * See 6.1 section of rfc2616.\n-     * </p>\n-     * @return Status string\n-     */\n-    String status();\n-\n-    /**\n-     * General headers, response headers, entity headers.\n-     * <p>\n-     * See 4.5, 6.2 and 7.1 section of rfc2616.\n-     * </p>\n-     * @return Headers map of values by name\n-     */\n-    Map<String, Iterable<String>> headers();\n-\n-    /**\n-     * Response body flow.\n-     * <p>\n-     * See 7.2 section of rfc2616.\n-     * </p>\n-     * @return Bytes flow\n+     * Render response.", "originalCommit": "8b79138474b4b7058bdfd09a5c265a2fa4acca2f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "363a79981e3b6ee57add33021bce1c17669d111b", "url": "https://github.com/artipie/http/commit/363a79981e3b6ee57add33021bce1c17669d111b", "message": "api improvements", "committedDate": "2020-02-06T10:09:05Z", "type": "commit"}, {"oid": "363a79981e3b6ee57add33021bce1c17669d111b", "url": "https://github.com/artipie/http/commit/363a79981e3b6ee57add33021bce1c17669d111b", "message": "api improvements", "committedDate": "2020-02-06T10:09:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTc0MzgwNw==", "url": "https://github.com/artipie/http/pull/18#discussion_r375743807", "bodyText": "@Sammers21 I think it should be names accept(), see #18 (comment)\nAlso, I don't think we need CompletableFuture here, since when we're asking  connection to accept response data, we don't care how and when exactly connection will accept it", "author": "g4s8", "createdAt": "2020-02-06T10:08:28Z", "path": "src/main/java/com/artipie/http/Connection.java", "diffHunk": "@@ -21,48 +21,25 @@\n  * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n  * SOFTWARE.\n  */\n-\n package com.artipie.http;\n \n-import java.io.IOException;\n import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n import java.util.concurrent.Flow;\n \n /**\n- * HTTP request.\n- * @see <a href=\"https://www.w3.org/Protocols/rfc2616/rfc2616-sec5.html\">RFC2616</a>\n+ * The http connection.\n  * @since 0.1\n  */\n-public interface Request {\n-\n-    /**\n-     * Request line.\n-     * <p>\n-     * See 5.1 section of rfc2616.\n-     * Request line is {@code Method SP Request-URI SP HTTP-Version CRLF}.\n-     * </p>\n-     * @return Line string\n-     * @throws IOException On IO failure\n-     */\n-    String line() throws IOException;\n-\n-    /**\n-     * General headers, request headers and entity headers.\n-     * <p>\n-     * See 4.5, 5.3 and 7.1 sections of rfc2616.\n-     * </p>\n-     * @return Map of header values by name\n-     * @throws IOException On IO failure\n-     */\n-    Map<String, Iterable<String>> headers() throws IOException;\n+public interface Connection {\n \n     /**\n-     * Message body, represented as bytes flow.\n-     * <p>\n-     * See 4.3 section of rfc2616.\n-     * </p>\n-     * @return Bytes flow\n-     * @throws IOException On IO failure\n+     * Render the destination.\n+     * @param code The http status code.\n+     * @param headers The http request headers.\n+     * @param body The http response body.\n      */\n-    Flow.Publisher<Byte> body() throws IOException;\n+    CompletableFuture<Void> respond(int code,", "originalCommit": "251f10eeefaa315f3d600bede7a7cd7972809399", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTc0NjY0Mw==", "url": "https://github.com/artipie/http/pull/18#discussion_r375746643", "bodyText": "accept is too general", "author": "Sammers21", "createdAt": "2020-02-06T10:13:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTc0MzgwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTc0NDEyOA==", "url": "https://github.com/artipie/http/pull/18#discussion_r375744128", "bodyText": "@Sammers21 same here: when we send response via connection, we don't care when the connection will accept it. It's not async operation, because response should not perform blocking operations on send(), all body flow will be published via Publisher<> body interface.", "author": "g4s8", "createdAt": "2020-02-06T10:09:06Z", "path": "src/main/java/com/artipie/http/Response.java", "diffHunk": "@@ -35,30 +33,10 @@\n public interface Response {\n \n     /**\n-     * Status line.\n-     * <p>\n-     * Status line is {@code HTTP-Version SP Status-Code SP Reason-Phrase CRLF}.\n-     * See 6.1 section of rfc2616.\n-     * </p>\n-     * @return Status string\n-     */\n-    String status();\n-\n-    /**\n-     * General headers, response headers, entity headers.\n-     * <p>\n-     * See 4.5, 6.2 and 7.1 section of rfc2616.\n-     * </p>\n-     * @return Headers map of values by name\n-     */\n-    Map<String, Iterable<String>> headers();\n-\n-    /**\n-     * Response body flow.\n-     * <p>\n-     * See 7.2 section of rfc2616.\n-     * </p>\n-     * @return Bytes flow\n+     * Send the response.\n+     *\n+     * @param connection Connection to send the response to\n+     * @return Completion or error signal.\n      */\n-    Flow.Subscriber<Byte> body();\n+     CompletableFuture<Void> send(Connection connection);", "originalCommit": "251f10eeefaa315f3d600bede7a7cd7972809399", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d4bab76b57bb5728d216760a6f412cf9e698e557", "url": "https://github.com/artipie/http/commit/d4bab76b57bb5728d216760a6f412cf9e698e557", "message": "fix return types", "committedDate": "2020-02-06T10:15:42Z", "type": "commit"}, {"oid": "d841f748dd3434e24bff98c9e9d1588bf75213f0", "url": "https://github.com/artipie/http/commit/d841f748dd3434e24bff98c9e9d1588bf75213f0", "message": "respond -> accept", "committedDate": "2020-02-06T10:17:39Z", "type": "commit"}]}