{"pr_number": 4303, "pr_title": "[WFCORE-5088] Add validation for the credential-reference attribute", "pr_createdAt": "2020-08-13T19:18:12Z", "pr_url": "https://github.com/wildfly/wildfly-core/pull/4303", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA3NTQ2MQ==", "url": "https://github.com/wildfly/wildfly-core/pull/4303#discussion_r473075461", "bodyText": "Isn't the .get(RESULT) part redundant as we don't use that value anywhere anymore?", "author": "jstourac", "createdAt": "2020-08-19T14:31:51Z", "path": "elytron/src/test/java/org/wildfly/extension/elytron/CredentialStoreUpdatesTestCase.java", "diffHunk": "@@ -552,6 +616,54 @@ private String addKeyStoreWithCredentialReference(String keyStoreName, String st\n         }\n     }\n \n+    private void testAddKeyStoreWithInvalidCredentialReference(String keyStoreName, String store, String alias, String secret) throws Exception {\n+        Path resources = Paths.get(KeyStoresTestCase.class.getResource(\".\").toURI());\n+        ModelNode operation = new ModelNode();\n+        operation.get(ClientConstants.OPERATION_HEADERS).get(\"allow-resource-service-restart\").set(Boolean.TRUE);\n+        operation.get(ClientConstants.OP_ADDR).add(\"subsystem\",\"elytron\").add(\"key-store\", keyStoreName);\n+        operation.get(ClientConstants.OP).set(ClientConstants.ADD);\n+        operation.get(ElytronDescriptionConstants.PATH).set(resources + \"/test.keystore\");\n+        operation.get(ElytronDescriptionConstants.TYPE).set(\"JKS\");\n+        if (store != null) {\n+            operation.get(CredentialReference.CREDENTIAL_REFERENCE).get(STORE).set(store);\n+        }\n+        if (alias != null) {\n+            operation.get(CredentialReference.CREDENTIAL_REFERENCE).get(ALIAS).set(alias);\n+        }\n+        if (secret != null) {\n+            operation.get(CredentialReference.CREDENTIAL_REFERENCE).get(CLEAR_TEXT).set(secret);\n+        }\n+\n+        ModelNode response = services.executeOperation(operation);\n+        assertEquals(FAILED, response.get(OUTCOME).asString());\n+        assertTrue(response.get(FAILURE_DESCRIPTION).asString().contains(CREDENTIAL_REFERENCE));\n+    }\n+\n+    private void testWriteCredentialReferenceAttribute(String resource, String resourceName, String store, String alias, String secret, boolean assertFailed) {\n+        ModelNode operation = new ModelNode();\n+        operation.get(ClientConstants.OP_ADDR).add(\"subsystem\", \"elytron\").add(resource, resourceName);\n+        operation.get(ClientConstants.OP).set(ClientConstants.WRITE_ATTRIBUTE_OPERATION);\n+        operation.get(ClientConstants.NAME).set(CREDENTIAL_REFERENCE);\n+        ModelNode credentialReference = new ModelNode();\n+        if (store != null) {\n+            credentialReference.get(STORE).set(store);\n+        }\n+        if (alias != null) {\n+            credentialReference.get(ALIAS).set(alias);\n+        }\n+        if (secret != null) {\n+            credentialReference.get(CLEAR_TEXT).set(secret);\n+        }\n+        operation.get(ClientConstants.VALUE).set(credentialReference);\n+        ModelNode response = services.executeOperation(operation);\n+        if (assertFailed) {\n+            assertEquals(FAILED, response.get(OUTCOME).asString());\n+            assertTrue(response.get(FAILURE_DESCRIPTION).asString().contains(CREDENTIAL_REFERENCE));\n+        } else {\n+            assertSuccess(response).get(RESULT);", "originalCommit": "6e88b771d4b2ef132baf41f9001897cd014884b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzEyNTU3Ng==", "url": "https://github.com/wildfly/wildfly-core/pull/4303#discussion_r473125576", "bodyText": "Good catch, this was from copy/pasting from somewhere else. Fixed now.", "author": "fjuma", "createdAt": "2020-08-19T15:40:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA3NTQ2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA3NzE3OA==", "url": "https://github.com/wildfly/wildfly-core/pull/4303#discussion_r473077178", "bodyText": "Could be simplified to assertNull.", "author": "jstourac", "createdAt": "2020-08-19T14:34:03Z", "path": "elytron/src/test/java/org/wildfly/extension/elytron/CredentialStoreUpdatesTestCase.java", "diffHunk": "@@ -503,6 +496,77 @@ public void testFailedRuntimeOperationWithClearTextAttributeOnly() throws Except\n         }\n     }\n \n+    @Test\n+    public void testAddOperationWithCredentialReferenceWithStoreOnly() throws Exception {\n+        testAddKeyStoreWithInvalidCredentialReference(KS_NAME, NON_EMPTY_CS_NAME, null, null);\n+    }\n+\n+    @Test\n+    public void testAddOperationWithCredentialReferenceWithAliasOnly() throws Exception {\n+        testAddKeyStoreWithInvalidCredentialReference(KS_NAME, null, EXISTING_ALIAS, null);\n+    }\n+\n+    @Test\n+    public void testAddOperationWithCredentialReferenceWithClearTextOnly() throws Exception {\n+        try {\n+            String password = \"secret\";\n+            addKeyStoreWithCredentialReference(KS_NAME, null, null, \"secret\", false, false);\n+            assertEquals(password, readAttribute(KS_NAME, CLEAR_TEXT_ATTRIBUTE_NAME));\n+            assertEquals(null, readAttribute(KS_NAME, ALIAS_ATTRIBUTE_NAME));", "originalCommit": "6e88b771d4b2ef132baf41f9001897cd014884b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzEyNjA3OA==", "url": "https://github.com/wildfly/wildfly-core/pull/4303#discussion_r473126078", "bodyText": "Fixed all of these.", "author": "fjuma", "createdAt": "2020-08-19T15:41:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA3NzE3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA3OTczNg==", "url": "https://github.com/wildfly/wildfly-core/pull/4303#discussion_r473079736", "bodyText": "We could use password variable instead of \"secret\" string.", "author": "jstourac", "createdAt": "2020-08-19T14:37:14Z", "path": "elytron/src/test/java/org/wildfly/extension/elytron/CredentialStoreUpdatesTestCase.java", "diffHunk": "@@ -503,6 +496,77 @@ public void testFailedRuntimeOperationWithClearTextAttributeOnly() throws Except\n         }\n     }\n \n+    @Test\n+    public void testAddOperationWithCredentialReferenceWithStoreOnly() throws Exception {\n+        testAddKeyStoreWithInvalidCredentialReference(KS_NAME, NON_EMPTY_CS_NAME, null, null);\n+    }\n+\n+    @Test\n+    public void testAddOperationWithCredentialReferenceWithAliasOnly() throws Exception {\n+        testAddKeyStoreWithInvalidCredentialReference(KS_NAME, null, EXISTING_ALIAS, null);\n+    }\n+\n+    @Test\n+    public void testAddOperationWithCredentialReferenceWithClearTextOnly() throws Exception {\n+        try {\n+            String password = \"secret\";\n+            addKeyStoreWithCredentialReference(KS_NAME, null, null, \"secret\", false, false);", "originalCommit": "6e88b771d4b2ef132baf41f9001897cd014884b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzEyNjEzMw==", "url": "https://github.com/wildfly/wildfly-core/pull/4303#discussion_r473126133", "bodyText": "Fixed.", "author": "fjuma", "createdAt": "2020-08-19T15:41:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA3OTczNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA4MTMyNQ==", "url": "https://github.com/wildfly/wildfly-core/pull/4303#discussion_r473081325", "bodyText": "Could be simplified to assertNull.", "author": "jstourac", "createdAt": "2020-08-19T14:39:19Z", "path": "elytron/src/test/java/org/wildfly/extension/elytron/CredentialStoreUpdatesTestCase.java", "diffHunk": "@@ -503,6 +496,77 @@ public void testFailedRuntimeOperationWithClearTextAttributeOnly() throws Except\n         }\n     }\n \n+    @Test\n+    public void testAddOperationWithCredentialReferenceWithStoreOnly() throws Exception {\n+        testAddKeyStoreWithInvalidCredentialReference(KS_NAME, NON_EMPTY_CS_NAME, null, null);\n+    }\n+\n+    @Test\n+    public void testAddOperationWithCredentialReferenceWithAliasOnly() throws Exception {\n+        testAddKeyStoreWithInvalidCredentialReference(KS_NAME, null, EXISTING_ALIAS, null);\n+    }\n+\n+    @Test\n+    public void testAddOperationWithCredentialReferenceWithClearTextOnly() throws Exception {\n+        try {\n+            String password = \"secret\";\n+            addKeyStoreWithCredentialReference(KS_NAME, null, null, \"secret\", false, false);\n+            assertEquals(password, readAttribute(KS_NAME, CLEAR_TEXT_ATTRIBUTE_NAME));\n+            assertEquals(null, readAttribute(KS_NAME, ALIAS_ATTRIBUTE_NAME));\n+        } finally {\n+            removeKeyStore(KS_NAME);\n+        }\n+    }\n+\n+    @Test\n+    public void testWriteAttributeWithCredentialReferenceWithStoreOnly() throws Exception {\n+        try {\n+            getNonEmptyCredentialStore();\n+            addKeyStoreWithCredentialReference(KS_NAME, NON_EMPTY_CS_NAME, EXISTING_ALIAS, null, true);\n+            testWriteCredentialReferenceAttribute(\"key-store\", KS_NAME, NON_EMPTY_CS_NAME, null, null, true);\n+\n+            // no changes to credential-reference attribute\n+            assertEquals(null, readAttribute(KS_NAME, CLEAR_TEXT_ATTRIBUTE_NAME));", "originalCommit": "6e88b771d4b2ef132baf41f9001897cd014884b4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA4Mjc4Mw==", "url": "https://github.com/wildfly/wildfly-core/pull/4303#discussion_r473082783", "bodyText": "Could be simplified to assertNull.", "author": "jstourac", "createdAt": "2020-08-19T14:41:20Z", "path": "elytron/src/test/java/org/wildfly/extension/elytron/CredentialStoreUpdatesTestCase.java", "diffHunk": "@@ -503,6 +496,77 @@ public void testFailedRuntimeOperationWithClearTextAttributeOnly() throws Except\n         }\n     }\n \n+    @Test\n+    public void testAddOperationWithCredentialReferenceWithStoreOnly() throws Exception {\n+        testAddKeyStoreWithInvalidCredentialReference(KS_NAME, NON_EMPTY_CS_NAME, null, null);\n+    }\n+\n+    @Test\n+    public void testAddOperationWithCredentialReferenceWithAliasOnly() throws Exception {\n+        testAddKeyStoreWithInvalidCredentialReference(KS_NAME, null, EXISTING_ALIAS, null);\n+    }\n+\n+    @Test\n+    public void testAddOperationWithCredentialReferenceWithClearTextOnly() throws Exception {\n+        try {\n+            String password = \"secret\";\n+            addKeyStoreWithCredentialReference(KS_NAME, null, null, \"secret\", false, false);\n+            assertEquals(password, readAttribute(KS_NAME, CLEAR_TEXT_ATTRIBUTE_NAME));\n+            assertEquals(null, readAttribute(KS_NAME, ALIAS_ATTRIBUTE_NAME));\n+        } finally {\n+            removeKeyStore(KS_NAME);\n+        }\n+    }\n+\n+    @Test\n+    public void testWriteAttributeWithCredentialReferenceWithStoreOnly() throws Exception {\n+        try {\n+            getNonEmptyCredentialStore();\n+            addKeyStoreWithCredentialReference(KS_NAME, NON_EMPTY_CS_NAME, EXISTING_ALIAS, null, true);\n+            testWriteCredentialReferenceAttribute(\"key-store\", KS_NAME, NON_EMPTY_CS_NAME, null, null, true);\n+\n+            // no changes to credential-reference attribute\n+            assertEquals(null, readAttribute(KS_NAME, CLEAR_TEXT_ATTRIBUTE_NAME));\n+            assertEquals(EXISTING_ALIAS, readAttribute(KS_NAME, ALIAS_ATTRIBUTE_NAME));\n+            assertEquals(NON_EMPTY_CS_NAME, readAttribute(KS_NAME, STORE_ATTRIBUTE_NAME));\n+        } finally {\n+            removeKeyStore(KS_NAME);\n+        }\n+    }\n+\n+    @Test\n+    public void testWriteAttributeWithCredentialReferenceWithAliasOnly() throws Exception {\n+        try {\n+            getNonEmptyCredentialStore();\n+            addKeyStoreWithCredentialReference(KS_NAME, NON_EMPTY_CS_NAME, EXISTING_ALIAS, null, true);\n+            testWriteCredentialReferenceAttribute(\"key-store\", KS_NAME, null, NEW_ALIAS, null, true);\n+\n+            // no changes to credential-reference attribute\n+            assertEquals(null, readAttribute(KS_NAME, CLEAR_TEXT_ATTRIBUTE_NAME));", "originalCommit": "6e88b771d4b2ef132baf41f9001897cd014884b4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA4NDM1Nw==", "url": "https://github.com/wildfly/wildfly-core/pull/4303#discussion_r473084357", "bodyText": "These two could be simplified to assertNull.", "author": "jstourac", "createdAt": "2020-08-19T14:43:25Z", "path": "elytron/src/test/java/org/wildfly/extension/elytron/CredentialStoreUpdatesTestCase.java", "diffHunk": "@@ -503,6 +496,77 @@ public void testFailedRuntimeOperationWithClearTextAttributeOnly() throws Except\n         }\n     }\n \n+    @Test\n+    public void testAddOperationWithCredentialReferenceWithStoreOnly() throws Exception {\n+        testAddKeyStoreWithInvalidCredentialReference(KS_NAME, NON_EMPTY_CS_NAME, null, null);\n+    }\n+\n+    @Test\n+    public void testAddOperationWithCredentialReferenceWithAliasOnly() throws Exception {\n+        testAddKeyStoreWithInvalidCredentialReference(KS_NAME, null, EXISTING_ALIAS, null);\n+    }\n+\n+    @Test\n+    public void testAddOperationWithCredentialReferenceWithClearTextOnly() throws Exception {\n+        try {\n+            String password = \"secret\";\n+            addKeyStoreWithCredentialReference(KS_NAME, null, null, \"secret\", false, false);\n+            assertEquals(password, readAttribute(KS_NAME, CLEAR_TEXT_ATTRIBUTE_NAME));\n+            assertEquals(null, readAttribute(KS_NAME, ALIAS_ATTRIBUTE_NAME));\n+        } finally {\n+            removeKeyStore(KS_NAME);\n+        }\n+    }\n+\n+    @Test\n+    public void testWriteAttributeWithCredentialReferenceWithStoreOnly() throws Exception {\n+        try {\n+            getNonEmptyCredentialStore();\n+            addKeyStoreWithCredentialReference(KS_NAME, NON_EMPTY_CS_NAME, EXISTING_ALIAS, null, true);\n+            testWriteCredentialReferenceAttribute(\"key-store\", KS_NAME, NON_EMPTY_CS_NAME, null, null, true);\n+\n+            // no changes to credential-reference attribute\n+            assertEquals(null, readAttribute(KS_NAME, CLEAR_TEXT_ATTRIBUTE_NAME));\n+            assertEquals(EXISTING_ALIAS, readAttribute(KS_NAME, ALIAS_ATTRIBUTE_NAME));\n+            assertEquals(NON_EMPTY_CS_NAME, readAttribute(KS_NAME, STORE_ATTRIBUTE_NAME));\n+        } finally {\n+            removeKeyStore(KS_NAME);\n+        }\n+    }\n+\n+    @Test\n+    public void testWriteAttributeWithCredentialReferenceWithAliasOnly() throws Exception {\n+        try {\n+            getNonEmptyCredentialStore();\n+            addKeyStoreWithCredentialReference(KS_NAME, NON_EMPTY_CS_NAME, EXISTING_ALIAS, null, true);\n+            testWriteCredentialReferenceAttribute(\"key-store\", KS_NAME, null, NEW_ALIAS, null, true);\n+\n+            // no changes to credential-reference attribute\n+            assertEquals(null, readAttribute(KS_NAME, CLEAR_TEXT_ATTRIBUTE_NAME));\n+            assertEquals(EXISTING_ALIAS, readAttribute(KS_NAME, ALIAS_ATTRIBUTE_NAME));\n+            assertEquals(NON_EMPTY_CS_NAME, readAttribute(KS_NAME, STORE_ATTRIBUTE_NAME));\n+        } finally {\n+            removeKeyStore(KS_NAME);\n+        }\n+    }\n+\n+    @Test\n+    public void testWriteAttributeWithCredentialReferenceWithClearTextOnly() throws Exception {\n+        try {\n+            String newPassword = \"newPassword\";\n+            getNonEmptyCredentialStore();\n+            addKeyStoreWithCredentialReference(KS_NAME, NON_EMPTY_CS_NAME, EXISTING_ALIAS, null, true);\n+            testWriteCredentialReferenceAttribute(\"key-store\", KS_NAME, null, null, newPassword, false);\n+\n+            // changes to credential-reference attribute\n+            assertEquals(newPassword, readAttribute(KS_NAME, CLEAR_TEXT_ATTRIBUTE_NAME));\n+            assertEquals(null, readAttribute(KS_NAME, ALIAS_ATTRIBUTE_NAME));\n+            assertEquals(null, readAttribute(KS_NAME, STORE_ATTRIBUTE_NAME));", "originalCommit": "6e88b771d4b2ef132baf41f9001897cd014884b4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "789c5ef47af09ac5cc5cc97034f5781fd1722272", "url": "https://github.com/wildfly/wildfly-core/commit/789c5ef47af09ac5cc5cc97034f5781fd1722272", "message": "[WFCORE-5088] Add validation for the credential-reference attribute", "committedDate": "2020-08-19T15:39:24Z", "type": "commit"}, {"oid": "789c5ef47af09ac5cc5cc97034f5781fd1722272", "url": "https://github.com/wildfly/wildfly-core/commit/789c5ef47af09ac5cc5cc97034f5781fd1722272", "message": "[WFCORE-5088] Add validation for the credential-reference attribute", "committedDate": "2020-08-19T15:39:24Z", "type": "forcePushed"}]}