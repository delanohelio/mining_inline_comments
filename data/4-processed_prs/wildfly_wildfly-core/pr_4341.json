{"pr_number": 4341, "pr_title": "[WFCORE-5095] Add the ability to make use of an automatically generated self-signed certificate with Elytron", "pr_createdAt": "2020-09-22T20:03:56Z", "pr_url": "https://github.com/wildfly/wildfly-core/pull/4341", "timeline": [{"oid": "284d538ca5867efc9fe6927a2d24651d8eaeb3dd", "url": "https://github.com/wildfly/wildfly-core/commit/284d538ca5867efc9fe6927a2d24651d8eaeb3dd", "message": "[WFCORE-5095] Add server-ssl-context configuration to the default config", "committedDate": "2020-09-23T16:05:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQyNDEyMg==", "url": "https://github.com/wildfly/wildfly-core/pull/4341#discussion_r520424122", "bodyText": "Not a reason to delay the feature as this is private so exposure is limited but should a class such as this be a utility in the Elytron project?", "author": "darranl", "createdAt": "2020-11-10T09:44:22Z", "path": "elytron/src/main/java/org/wildfly/extension/elytron/SSLDefinitions.java", "diffHunk": "@@ -1017,6 +1027,110 @@ public String chooseEngineServerAlias(String keyType, Principal[] issuers, SSLEn\n         }\n     }\n \n+    private static class LazyDelegatingKeyManager extends DelegatingKeyManager {", "originalCommit": "061ec72025ed591821f82ee3c371c13ba590c365", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQyNDU3NA==", "url": "https://github.com/wildfly/wildfly-core/pull/4341#discussion_r520424574", "bodyText": "Ah I see it is MSC aware.", "author": "darranl", "createdAt": "2020-11-10T09:45:01Z", "path": "elytron/src/main/java/org/wildfly/extension/elytron/SSLDefinitions.java", "diffHunk": "@@ -1017,6 +1027,110 @@ public String chooseEngineServerAlias(String keyType, Principal[] issuers, SSLEn\n         }\n     }\n \n+    private static class LazyDelegatingKeyManager extends DelegatingKeyManager {\n+        private ModifiableKeyStoreService keyStoreService;\n+        private char[] password;\n+        private KeyManagerFactory keyManagerFactory;\n+        private String generateSelfSignedCertificateHostName;\n+        private String aliasFilter;\n+        private volatile boolean init = false;\n+\n+        private LazyDelegatingKeyManager(ModifiableKeyStoreService keyStoreService, char[] password, KeyManagerFactory keyManagerFactory,\n+                                         String generateSelfSignedCertificateHostName, String aliasFilter) {\n+            this.keyStoreService = keyStoreService;\n+            this.password = password;\n+            this.keyManagerFactory = keyManagerFactory;\n+            this.generateSelfSignedCertificateHostName = generateSelfSignedCertificateHostName;\n+            this.aliasFilter = aliasFilter;\n+        }\n+\n+        private void doInit() {\n+            if(! init) {\n+                synchronized (this) {\n+                    if(! init) {\n+                        try {\n+                            ((KeyStoreService) keyStoreService).generateAndSaveSelfSignedCertificate(generateSelfSignedCertificateHostName, password);", "originalCommit": "061ec72025ed591821f82ee3c371c13ba590c365", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQyNTU3NA==", "url": "https://github.com/wildfly/wildfly-core/pull/4341#discussion_r520425574", "bodyText": "How about if the file exists but is empty?", "author": "darranl", "createdAt": "2020-11-10T09:46:27Z", "path": "elytron/src/main/resources/org/wildfly/extension/elytron/LocalDescriptions.properties", "diffHunk": "@@ -1260,6 +1260,7 @@ elytron.key-manager.credential-reference.type=The type of credential this refere\n elytron.key-manager.credential-reference.clear-text=The secret specified using clear text. Check credential store way of supplying credential/secrets to services.\n elytron.key-manager.key-store=Reference to the KeyStore to use to initialise the underlying KeyManagerFactory.\n elytron.key-manager.alias-filter=A filter to apply to the aliases returned from the KeyStore, can either be a comma separated list of aliases to return or one of the following formats ALL:-alias1:-alias2, NONE:+alias1:+alias2\n+elytron.key-manager.generate-self-signed-certificate-host=If the file that backs the KeyStore does not exist and this attribute is set, then a self-signed certificate will be generated for the specified host name. This is not intended for production use.", "originalCommit": "061ec72025ed591821f82ee3c371c13ba590c365", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYyNDY4MQ==", "url": "https://github.com/wildfly/wildfly-core/pull/4341#discussion_r520624681", "bodyText": "The legacy equivalent only generates the self-signed certificate if the file that backs the keystore does not exist, i.e., if the file exists but is empty, legacy security doesn't generate the certificate. Currently, the behaviour with Elytron is the same as it was for legacy security. However, we could change the behaviour with Elytron so that we also generate the certificate for the case where the file exists but is empty.", "author": "fjuma", "createdAt": "2020-11-10T14:54:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQyNTU3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQyNjU3Mw==", "url": "https://github.com/wildfly/wildfly-core/pull/4341#discussion_r520426573", "bodyText": "Would now be the time to review the default KeyStore type we choose?", "author": "darranl", "createdAt": "2020-11-10T09:47:59Z", "path": "core-feature-pack/galleon-common/src/main/resources/feature_groups/core-domain-profile.xml", "diffHunk": "@@ -14,6 +14,13 @@\n                     <param name=\"relative-to\" value=\"jboss.domain.config.dir\"/>\n                 </feature>\n             </include>\n+            <include feature-id=\"subsystem.elytron.key-store:key-store=applicationKS\">\n+                <param name=\"key-store\" value=\"applicationKS\" />\n+                <param name=\"path\" value=\"application.keystore\" />\n+                <param name=\"relative-to\" value=\"jboss.domain.config.dir\" />\n+                <param name=\"type\" value=\"JKS\" />", "originalCommit": "284d538ca5867efc9fe6927a2d24651d8eaeb3dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYyOTk1OQ==", "url": "https://github.com/wildfly/wildfly-core/pull/4341#discussion_r520629959", "bodyText": "Good point, we should probably switch to PKCS12.", "author": "fjuma", "createdAt": "2020-11-10T15:01:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQyNjU3Mw=="}], "type": "inlineReview"}, {"oid": "0f103c4310ffbf2e737338a046f122207e1f810e", "url": "https://github.com/wildfly/wildfly-core/commit/0f103c4310ffbf2e737338a046f122207e1f810e", "message": "[WFCORE-5095] Add the ability to make use of an automatically generated self-signed certificate with Elytron", "committedDate": "2020-11-10T20:53:03Z", "type": "commit"}, {"oid": "20123ab2fe7d0c676f63cb4b8bf1c855817a1a55", "url": "https://github.com/wildfly/wildfly-core/commit/20123ab2fe7d0c676f63cb4b8bf1c855817a1a55", "message": "[WFCORE-5095] Add server-ssl-context configuration to the default config", "committedDate": "2020-11-10T20:53:08Z", "type": "commit"}, {"oid": "20123ab2fe7d0c676f63cb4b8bf1c855817a1a55", "url": "https://github.com/wildfly/wildfly-core/commit/20123ab2fe7d0c676f63cb4b8bf1c855817a1a55", "message": "[WFCORE-5095] Add server-ssl-context configuration to the default config", "committedDate": "2020-11-10T20:53:08Z", "type": "forcePushed"}]}