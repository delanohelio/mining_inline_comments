{"pr_number": 4167, "pr_title": "[WFCORE-4922] Fix possible hang starting the embedded host and server", "pr_createdAt": "2020-04-17T08:58:58Z", "pr_url": "https://github.com/wildfly/wildfly-core/pull/4167", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTc3NjA1Mw==", "url": "https://github.com/wildfly/wildfly-core/pull/4167#discussion_r411776053", "bodyText": "I believe status == null is a likely scenario while the host is starting. HostControllerImpl.currentProcessState starts as null and won't change to something else until it receives a notification of a change via ProcessStateNotifier.", "author": "bstansberry", "createdAt": "2020-04-21T00:10:14Z", "path": "cli/src/main/java/org/jboss/as/cli/embedded/EmbedHostControllerHandler.java", "diffHunk": "@@ -276,7 +276,7 @@ protected void doHandle(CommandContext ctx) throws CommandLineException {\n                 do {\n                     status = hostController.getProcessState();\n \n-                    if (status == null || \"starting\".equals(status)) {", "originalCommit": "c1c217a784283e1f9413bc08da5bce16dd5061f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjc3NjU4OQ==", "url": "https://github.com/wildfly/wildfly-core/pull/4167#discussion_r412776589", "bodyText": "Yes, I change it because I think we are never going to get a null as returned value here if \n  \n    \n      wildfly-core/cli/src/main/java/org/jboss/as/cli/embedded/EmbedHostControllerHandler.java\n    \n    \n         Line 266\n      in\n      c1c217a\n    \n    \n    \n    \n\n        \n          \n           hostController.start(); \n        \n    \n  \n\n is executed without throwing any exceptions.\nThe thread which updates the HostControllerImpl.currentProcessState via ProcessStateNotifier listener propertyChange() is the \"Controller Boot Thread\", which is the same thread that calls the done() for the future container. That means \n  \n    \n      wildfly-core/embedded/src/main/java/org/wildfly/core/embedded/EmbeddedHostControllerFactory.java\n    \n    \n         Line 279\n      in\n      c1c217a\n    \n    \n    \n    \n\n        \n          \n           serviceContainer = futureContainer.get(); \n        \n    \n  \n\n is always returned with the HostControllerImpl.currentProcessState as \"starting\" and never with null.\nThis is pretty hidden; it is better to keep the null check and avoid these subtleties to make the code easier to follow. I changed it. Thanks!", "author": "yersan", "createdAt": "2020-04-22T08:24:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTc3NjA1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI3NDc3NA==", "url": "https://github.com/wildfly/wildfly-core/pull/4167#discussion_r413274774", "bodyText": "Thanks; that makes sense. When I wrote that comment I thought it was odd no test hit the race I was concerned about. Now I know why. :)", "author": "bstansberry", "createdAt": "2020-04-22T19:48:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTc3NjA1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTc3NzMzNw==", "url": "https://github.com/wildfly/wildfly-core/pull/4167#discussion_r411777337", "bodyText": "If you put a message here it really should be internationalized.\nA plain no-message UOE with a code comment should be enough. I think it would be a developer messing around who would hit this, not a user. They can analyze the stack trace find the code and read the comment.", "author": "bstansberry", "createdAt": "2020-04-21T00:13:43Z", "path": "embedded/src/main/java/org/wildfly/core/embedded/EmbeddedStandaloneServerFactory.java", "diffHunk": "@@ -341,10 +341,7 @@ public void stop() {\n \n         @Override\n         public String getProcessState() {\n-            if (currentProcessState == null) {\n-                return null;\n-            }\n-            return currentProcessState.toString();\n+            throw new UnsupportedOperationException(\"The access to the internal process state is unsupported for this standalone embedded server\");", "originalCommit": "c1c217a784283e1f9413bc08da5bce16dd5061f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjc3OTc2Mw==", "url": "https://github.com/wildfly/wildfly-core/pull/4167#discussion_r412779763", "bodyText": "Understood, thanks!, yes that was the intention, I throw the UOE for a developer point of view only. Fixed.", "author": "yersan", "createdAt": "2020-04-22T08:28:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTc3NzMzNw=="}], "type": "inlineReview"}, {"oid": "f378bbdb365a102239325e8589e7842a98ab7c66", "url": "https://github.com/wildfly/wildfly-core/commit/f378bbdb365a102239325e8589e7842a98ab7c66", "message": "[WFCORE-4922] Fix possible hang starting the embedded host and server\n- Basically it rollbacks the changes done in https://issues.redhat.com/browse/WFCORE-4893 for the embedded server and fix the possible hang reading the process state for the embeddded host controller\n\njira issue: https://issues.redhat.com/browse/WFCORE-4922", "committedDate": "2020-04-22T08:37:50Z", "type": "commit"}, {"oid": "f378bbdb365a102239325e8589e7842a98ab7c66", "url": "https://github.com/wildfly/wildfly-core/commit/f378bbdb365a102239325e8589e7842a98ab7c66", "message": "[WFCORE-4922] Fix possible hang starting the embedded host and server\n- Basically it rollbacks the changes done in https://issues.redhat.com/browse/WFCORE-4893 for the embedded server and fix the possible hang reading the process state for the embeddded host controller\n\njira issue: https://issues.redhat.com/browse/WFCORE-4922", "committedDate": "2020-04-22T08:37:50Z", "type": "forcePushed"}]}