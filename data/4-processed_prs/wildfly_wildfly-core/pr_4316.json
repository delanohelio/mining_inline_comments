{"pr_number": 4316, "pr_title": "Bootable JAR Logging Updates", "pr_createdAt": "2020-09-03T17:13:35Z", "pr_url": "https://github.com/wildfly/wildfly-core/pull/4316", "timeline": [{"oid": "e906a2c4821cc670745047f8529a638518300789", "url": "https://github.com/wildfly/wildfly-core/commit/e906a2c4821cc670745047f8529a638518300789", "message": "[WFCORE-5115] Use a hard-coded boot-config.properties to load system properties in the bootable JAR entry point. This properties file is generated by the wildfly-jar-maven-plugin. It's used at boot to configure properties required by the log manager during initialization.\n\nhttps://issues.redhat.com/browse/WFCORE-5115", "committedDate": "2020-09-03T23:38:12Z", "type": "forcePushed"}, {"oid": "8fc7fb2ef87a21479993101d7b1435c47a791560", "url": "https://github.com/wildfly/wildfly-core/commit/8fc7fb2ef87a21479993101d7b1435c47a791560", "message": "[WFCORE-5115] Use a hard-coded boot-config.properties to load system properties in the bootable JAR entry point. This properties file is generated by the wildfly-jar-maven-plugin. It's used at boot to configure properties required by the log manager during initialization.\n\nhttps://issues.redhat.com/browse/WFCORE-5115", "committedDate": "2020-09-03T23:44:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzMxMDM5OQ==", "url": "https://github.com/wildfly/wildfly-core/pull/4316#discussion_r483310399", "bodyText": "Note this is just an idea. I'm happy to remove it, but felt it may be useful to see some information about the environment when it's booting.", "author": "jamezp", "createdAt": "2020-09-03T23:46:55Z", "path": "bootable-jar/runtime/src/main/java/org/wildfly/core/jar/runtime/BootableEnvironment.java", "diffHunk": "@@ -0,0 +1,226 @@\n+/*\n+ * JBoss, Home of Professional Open Source.\n+ *\n+ * Copyright 2020 Red Hat, Inc., and individual contributors\n+ * as indicated by the @author tags.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.wildfly.core.jar.runtime;\n+\n+import java.nio.file.Path;\n+import java.security.AccessController;\n+import java.security.PrivilegedAction;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+/**\n+ * Represents a bootable JAR environment.\n+ * <p>\n+ * The environment initializes required system properties. System properties should also be\n+ * {@linkplain #setSystemProperty(String, String) set} via the environment and not directly.\n+ * </p>\n+ *\n+ * @author <a href=\"mailto:jperkins@redhat.com\">James R. Perkins</a>\n+ */\n+class BootableEnvironment {\n+\n+    private static final AtomicBoolean DEBUG = new AtomicBoolean();\n+    private final Path jbossHome;\n+    private final Path serverDir;\n+    private final Collection<String> ignoredProperties;\n+    private final PropertyUpdater propertyUpdater;\n+\n+    private BootableEnvironment(final Path jbossHome, final Collection<String> ignoredProperties,\n+                                final PropertyUpdater propertyUpdater) {\n+        this.jbossHome = jbossHome;\n+        serverDir = jbossHome.resolve(\"standalone\");\n+        this.ignoredProperties = ignoredProperties;\n+        this.propertyUpdater = propertyUpdater;\n+    }\n+\n+    /**\n+     * Creates a new environment initializing required system properties based on the JBoss Home directory passed in.\n+     *\n+     * @param jbossHome the base JBoss Home directory\n+     *\n+     * @return the newly create environment\n+     */\n+    static BootableEnvironment of(final Path jbossHome) {\n+        final PropertyUpdater propertyUpdater;\n+        if (System.getSecurityManager() == null) {\n+            propertyUpdater = System::setProperty;\n+        } else {\n+            propertyUpdater = (name, value) ->\n+                    AccessController.doPrivileged((PrivilegedAction<String>) () -> System.setProperty(name, value));\n+        }\n+        return of(jbossHome, propertyUpdater);\n+    }\n+\n+    /**\n+     * Creates a new environment initializing required system properties based on the JBoss Home directory passed in.\n+     *\n+     * @param jbossHome       the base JBoss Home directory\n+     * @param propertyUpdater the updater used to set system properties\n+     *\n+     * @return the newly create environment\n+     */\n+    static BootableEnvironment of(final Path jbossHome, final PropertyUpdater propertyUpdater) {\n+        return new BootableEnvironment(jbossHome, init(jbossHome, propertyUpdater), propertyUpdater);\n+    }\n+\n+    /**\n+     * Returns the base JBoss Home directory.\n+     *\n+     * @return the JBoss Home directory\n+     */\n+    Path getJBossHome() {\n+        return jbossHome;\n+    }\n+\n+    /**\n+     * Results the servers configuration directory appending any optional paths.\n+     *\n+     * @param paths the optional paths to append to the configuration directory\n+     *\n+     * @return the resolved path\n+     */\n+    Path resolveConfigurationDir(final String... paths) {\n+        return resolvePath(serverDir, \"configuration\", paths);\n+    }\n+\n+    /**\n+     * Results the servers content directory appending any optional paths.\n+     *\n+     * @param paths the optional paths to append to the content directory\n+     *\n+     * @return the resolved path\n+     */\n+    Path resolveContentDir(final String... paths) {\n+        return resolvePath(resolveDataDir(), \"content\", paths);\n+    }\n+\n+    /**\n+     * Results the servers data directory appending any optional paths.\n+     *\n+     * @param paths the optional paths to append to the data directory\n+     *\n+     * @return the resolved path\n+     */\n+    Path resolveDataDir(final String... paths) {\n+        return resolvePath(serverDir, \"data\", paths);\n+    }\n+\n+    /**\n+     * Results the servers log directory appending any optional paths.\n+     *\n+     * @param paths the optional paths to append to the log directory\n+     *\n+     * @return the resolved path\n+     */\n+    Path resolveLogDir(final String... paths) {\n+        return resolvePath(serverDir, \"log\", paths);\n+    }\n+\n+    /**\n+     * Sets the system properties represented by the properties.\n+     * <p>\n+     * Note there are a set of system properties that will not be set and are determined based on the JBoss Home\n+     * directory.\n+     * </p>\n+     *\n+     * @param properties the properties to set\n+     */\n+    void setSystemProperties(final Map<String, String> properties) {\n+        final Map<String, String> local = new HashMap<>(properties);\n+        final String debugValue = local.remove(Constants.DEBUG_PROPERTY);\n+        if (debugValue != null) {\n+            DEBUG.set(debugValue.isEmpty() || \"true\".equalsIgnoreCase(debugValue));\n+        }\n+        for (Map.Entry<String, String> entry : local.entrySet()) {\n+            setSystemProperty(entry.getKey(), entry.getValue());\n+        }\n+    }\n+\n+    /**\n+     * Sets the system property.\n+     * <p>\n+     * Note there are a set of system properties that will not be set and are determined based on the JBoss Home\n+     * directory.\n+     * </p>\n+     *\n+     * @param key   the key for the property\n+     * @param value the property value\n+     */\n+    void setSystemProperty(final String key, final String value) {\n+        if (ignoredProperties.contains(key)) {\n+            logDebug(\"Ignoring system property %s.\", key);\n+        } else {\n+            propertyUpdater.setProperty(key, value);\n+        }\n+    }\n+\n+    private static Collection<String> init(final Path jbossHome, final PropertyUpdater propertyUpdater) {\n+        final Collection<String> propertyNames = new ArrayList<>();\n+        propertyNames.add(\"java.ext.dirs\");\n+        propertyNames.add(\"java.home\");\n+        propertyNames.add(\"java.io.tmpdir\");\n+        propertyNames.add(\"jboss.server.persist.config\");\n+        propertyNames.add(\"jboss.server.management.uuid\");\n+        propertyNames.add(\"modules.path\");\n+        propertyNames.add(\"user.dir\");\n+        propertyNames.add(\"user.home\");\n+\n+        // Configure known paths\n+        setSystemProperty(propertyUpdater, \"jboss.home.dir\", jbossHome, propertyNames);\n+        final Path serverBaseDir = resolvePath(jbossHome, \"standalone\");\n+        setSystemProperty(propertyUpdater, \"jboss.server.base.dir\", serverBaseDir, propertyNames);\n+        setSystemProperty(propertyUpdater, \"jboss.controller.temp.dir\", resolvePath(serverBaseDir, \"tmp\"), propertyNames);\n+        final Path dataDir = resolvePath(serverBaseDir, \"data\");\n+        setSystemProperty(propertyUpdater, \"jboss.server.data.dir\", dataDir, propertyNames);\n+        setSystemProperty(propertyUpdater, \"jboss.server.config.dir\", resolvePath(serverBaseDir, \"config\"), propertyNames);\n+        setSystemProperty(propertyUpdater, \"jboss.server.deploy.dir\", resolvePath(dataDir, \"content\"), propertyNames);\n+        setSystemProperty(propertyUpdater, \"jboss.server.log.dir\", resolvePath(serverBaseDir, \"log\"), propertyNames);\n+        setSystemProperty(propertyUpdater, \"jboss.server.temp.dir\", resolvePath(serverBaseDir, \"tmp\"), propertyNames);\n+        return propertyNames;\n+    }\n+\n+    private static Path resolvePath(final Path base, final String path1, final String... paths) {\n+        Path result = base.resolve(path1);\n+        for (String path : paths) {\n+            result = result.resolve(path);\n+        }\n+        return result.toAbsolutePath().normalize();\n+    }\n+\n+    private static void setSystemProperty(final PropertyUpdater propertyUpdater, final String key, final Path path, final Collection<String> names) {\n+        names.add(key);\n+        final String previousValue = propertyUpdater.setProperty(key, path.toString());\n+        if (previousValue == null) {\n+            logDebug(\"Setting system property %s to %s\", key, path);\n+        } else {\n+            logDebug(\"Replacing system property %s with a value of %s. The previous value was %s.\", key, path, previousValue);\n+        }\n+    }\n+\n+    @SuppressWarnings(\"UseOfSystemOutOrSystemErr\")\n+    static void logDebug(final String format, final Object... args) {\n+        if (DEBUG.get()) {\n+            System.out.printf(\"[DEBUG] \" + format, args);", "originalCommit": "8fc7fb2ef87a21479993101d7b1435c47a791560", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4b38e25e835de0b5a411db53f412475555d9d686", "url": "https://github.com/wildfly/wildfly-core/commit/4b38e25e835de0b5a411db53f412475555d9d686", "message": "[WFCORE-5115] Use a hard-coded boot-config.properties to load system properties in the bootable JAR entry point. This properties file is generated by the wildfly-jar-maven-plugin. It's used at boot to configure properties required by the log manager during initialization.\n\nhttps://issues.redhat.com/browse/WFCORE-5115", "committedDate": "2020-09-04T00:23:51Z", "type": "forcePushed"}, {"oid": "227b871d0689f7babe9d328db372f361d1671445", "url": "https://github.com/wildfly/wildfly-core/commit/227b871d0689f7babe9d328db372f361d1671445", "message": "[WFCORE-5115] Use a hard-coded boot-config.properties to load system properties in the bootable JAR entry point. This properties file is generated by the wildfly-jar-maven-plugin. It's used at boot to configure properties required by the log manager during initialization.\n\nhttps://issues.redhat.com/browse/WFCORE-5115", "committedDate": "2020-09-04T00:55:19Z", "type": "forcePushed"}, {"oid": "4c147e038986b5a9e063d4c218d6d5e298ea5da5", "url": "https://github.com/wildfly/wildfly-core/commit/4c147e038986b5a9e063d4c218d6d5e298ea5da5", "message": "[WFCORE-4895] Minor follow up to the bootable JAR module. Actually throw the exception when a shutdown failure occurs.\n\nhttps://issues.redhat.com/browse/WFCORE-4895", "committedDate": "2020-09-04T14:21:40Z", "type": "commit"}, {"oid": "7618565dc9e6a1881180ceb4814eaec52e4c6d65", "url": "https://github.com/wildfly/wildfly-core/commit/7618565dc9e6a1881180ceb4814eaec52e4c6d65", "message": "[WFCORE-5109] Ensure the configurator is attached to the root logger. This means the logging subsystem will not reconfigure resources that do not need to be reconfigured.\n\nhttps://issues.redhat.com/browse/WFCORE-5109", "committedDate": "2020-09-04T14:21:40Z", "type": "commit"}, {"oid": "bc89be4f1f9d1238b338a373ccdfb9c4620b6605", "url": "https://github.com/wildfly/wildfly-core/commit/bc89be4f1f9d1238b338a373ccdfb9c4620b6605", "message": "[WFCORE-5115] Use a hard-coded boot-config.properties to load system properties in the bootable JAR entry point. This properties file is generated by the wildfly-jar-maven-plugin. It's used at boot to configure properties required by the log manager during initialization.\n\nhttps://issues.redhat.com/browse/WFCORE-5115", "committedDate": "2020-09-04T14:30:45Z", "type": "commit"}, {"oid": "bc89be4f1f9d1238b338a373ccdfb9c4620b6605", "url": "https://github.com/wildfly/wildfly-core/commit/bc89be4f1f9d1238b338a373ccdfb9c4620b6605", "message": "[WFCORE-5115] Use a hard-coded boot-config.properties to load system properties in the bootable JAR entry point. This properties file is generated by the wildfly-jar-maven-plugin. It's used at boot to configure properties required by the log manager during initialization.\n\nhttps://issues.redhat.com/browse/WFCORE-5115", "committedDate": "2020-09-04T14:30:45Z", "type": "forcePushed"}]}