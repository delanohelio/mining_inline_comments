{"pr_number": 4250, "pr_title": "[WFCORE-5010] Startup error messages caused by expression where expressions are not allowed are confusing", "pr_createdAt": "2020-06-29T13:48:07Z", "pr_url": "https://github.com/wildfly/wildfly-core/pull/4250", "timeline": [{"oid": "d0f565947d0704feb53c0aedc993a5ec62a2fb20", "url": "https://github.com/wildfly/wildfly-core/commit/d0f565947d0704feb53c0aedc993a5ec62a2fb20", "message": "[WFCORE-5010] Handling expression text in the unresolvable capability name", "committedDate": "2020-06-29T11:54:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA3Nzc4Nw==", "url": "https://github.com/wildfly/wildfly-core/pull/4250#discussion_r447077787", "bodyText": "What kind of performance overhead will this cause?  This pattern is going to have to be recompiled for every ID encountered.", "author": "darranl", "createdAt": "2020-06-29T15:55:45Z", "path": "controller/src/main/java/org/jboss/as/controller/OperationContextImpl.java", "diffHunk": "@@ -347,32 +349,38 @@ private boolean validateCapabilities() {\n             for (Map.Entry<Step, Set<CapabilityId>> entry : missingForStep.entrySet()) {\n                 Step step = entry.getKey();\n                 ModelNode response = step.response;\n-                // only overwrite reponse failure-description if there isn't one\n-                StringBuilder msg = response.hasDefined(FAILURE_DESCRIPTION)\n-                        ? null\n-                        : new StringBuilder(ControllerLogger.ROOT_LOGGER.requiredCapabilityMissing());\n-                StringBuilder bootMsg = isBooting() || ignoreFailures\n-                        ? new StringBuilder(ControllerLogger.ROOT_LOGGER.requiredCapabilityMissing(step.address.toCLIStyleString()))\n-                        : null;\n+                StringBuilder unsupportedExpressionsMsg = new StringBuilder();\n+                StringBuilder capabilityMissingMsg = new StringBuilder();\n                 for (CapabilityId id : entry.getValue()) {\n-                    String formattedCapability = ignoreContext\n-                            ? ControllerLogger.ROOT_LOGGER.formattedCapabilityName(id.getName())\n-                            : ControllerLogger.ROOT_LOGGER.formattedCapabilityId(id.getName(), id.getScope().getName());\n-                    Set<PathAddress> possiblePoints = managementModel.getCapabilityRegistry().getPossibleProviderPoints(id);\n-                    if (msg != null) {\n-                        msg = appendPossibleProviderPoints(msg, formattedCapability, possiblePoints);\n-                    }\n-                    if (bootMsg != null) {\n-                        bootMsg = appendPossibleProviderPoints(bootMsg, formattedCapability, possiblePoints);\n+                    if (id.getName().matches(UNSUPPORTED_EXPRESSION_PATTERN)) {", "originalCommit": "d0f565947d0704feb53c0aedc993a5ec62a2fb20", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA3ODc2Mg==", "url": "https://github.com/wildfly/wildfly-core/pull/4250#discussion_r447078762", "bodyText": "For any regular expression IMO it is better to add a comment describing how it is structured so if anyone needs to work on it or debug it in the future they can understand the original intent of the regular expression.", "author": "darranl", "createdAt": "2020-06-29T15:57:10Z", "path": "controller/src/main/java/org/jboss/as/controller/OperationContextImpl.java", "diffHunk": "@@ -144,6 +144,8 @@\n     private static final Set<Action.ActionEffect> WRITE_RUNTIME = EnumSet.of(Action.ActionEffect.WRITE_RUNTIME);\n     private static final Set<Action.ActionEffect> ALL_READ_WRITE = EnumSet.of(Action.ActionEffect.READ_CONFIG, Action.ActionEffect.READ_RUNTIME, Action.ActionEffect.WRITE_CONFIG, Action.ActionEffect.WRITE_RUNTIME);\n \n+    private static final String UNSUPPORTED_EXPRESSION_PATTERN = \".+\\\\.\\\\$\\\\{.+\\\\}\";", "originalCommit": "d0f565947d0704feb53c0aedc993a5ec62a2fb20", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9eca9f1ad515da9ec15588d1648c4a96e386a359", "url": "https://github.com/wildfly/wildfly-core/commit/9eca9f1ad515da9ec15588d1648c4a96e386a359", "message": "[WFCORE-5010] Optimization of pattern compilation", "committedDate": "2020-06-30T09:31:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ2OTYyOQ==", "url": "https://github.com/wildfly/wildfly-core/pull/4250#discussion_r450469629", "bodyText": "ExpressionResolver.EXPRESSION_PATTERN exists and should be used.", "author": "bstansberry", "createdAt": "2020-07-06T20:44:09Z", "path": "controller/src/main/java/org/jboss/as/controller/OperationContextImpl.java", "diffHunk": "@@ -144,6 +145,10 @@\n     private static final Set<Action.ActionEffect> WRITE_RUNTIME = EnumSet.of(Action.ActionEffect.WRITE_RUNTIME);\n     private static final Set<Action.ActionEffect> ALL_READ_WRITE = EnumSet.of(Action.ActionEffect.READ_CONFIG, Action.ActionEffect.READ_RUNTIME, Action.ActionEffect.WRITE_CONFIG, Action.ActionEffect.WRITE_RUNTIME);\n \n+    /** Pattern that can be used to identify capabilities name strings that include expression syntax\n+     * started with one or more of any character, followed by '.${' sequence, then one or more of any character ended with '}' */\n+    private static final Pattern UNSUPPORTED_EXPRESSION_PATTERN = Pattern.compile(\".+\\\\.\\\\$\\\\{.+\\\\}\");", "originalCommit": "9eca9f1ad515da9ec15588d1648c4a96e386a359", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ4MTM4NA==", "url": "https://github.com/wildfly/wildfly-core/pull/4250#discussion_r450481384", "bodyText": "I think this needs a bit more info to explain things, as now it's going to output a capability name, which the user may not understand. The name will include an expression that perhaps they will recognize. But what the problem is isn't clear.\nPerhaps\n\"Required capabilities are not available. This likely is due to the use of an expression string in a configuration attribute that does not support expressions:\"\nHmm, but thinking further... AIUI with what is in the current code we have, for example:\nRequired capabilities are not available:\n     some.capability.name; Possible registration points for this capability:\n          blahblahblah\n     some.other.capability.name;  There are no known registration points which can provide this capability.\n\nSo shouldn't the result here be:\nRequired capabilities are not available:\n     some.capability.name; Possible registration points for this capability:\n          blahblahblah\n     some.other.capability.name; There are no known registration points which can provide this capability.\n     another.capability.${name}; This unresolvable capability likely is due to the use of an expression string in a configuration attribute that does not support expressions.\n\nThe appendPossibleProviderPoints method could handle that. If there are no possible provider points, report that, as it means something is odd beyond the use of the expression. Otherwise if there's an expression use the \"does not support expressions\" message. Otherwise report the provider points.", "author": "bstansberry", "createdAt": "2020-07-06T21:09:23Z", "path": "controller/src/main/java/org/jboss/as/controller/logging/ControllerLogger.java", "diffHunk": "@@ -3623,4 +3623,7 @@ OperationFailedRuntimeException capabilityAlreadyRegisteredInContext(String capa\n \n     @Message(id = 475, value = \"Value for attribute '%s' is invalid.\")\n     OperationFailedException invalidAttributeValue(String attributeName);\n+\n+    @Message(id = 476, value = \"Unsupported usage of expression:\")", "originalCommit": "9eca9f1ad515da9ec15588d1648c4a96e386a359", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8508046ff90371a01a9228b4f78c0f3c6c5fe23d", "url": "https://github.com/wildfly/wildfly-core/commit/8508046ff90371a01a9228b4f78c0f3c6c5fe23d", "message": "[WFCORE-5010] Move to appendPossibleProviderPoints method", "committedDate": "2020-07-13T13:30:45Z", "type": "commit"}]}