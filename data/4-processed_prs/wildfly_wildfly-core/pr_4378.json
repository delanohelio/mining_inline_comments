{"pr_number": 4378, "pr_title": "[WFCORE-3825] Unify -server option in windows scripts (ps1, bat) for domain mode (and its servers) on all JDKs", "pr_createdAt": "2020-10-26T11:08:11Z", "pr_url": "https://github.com/wildfly/wildfly-core/pull/4378", "timeline": [{"oid": "5f43769127187bd909891a2dae0d80e196ba7044", "url": "https://github.com/wildfly/wildfly-core/commit/5f43769127187bd909891a2dae0d80e196ba7044", "message": "[WFCORE-3825] Unify -server option in windows scripts (ps1, bat) for domain mode (and its servers) on all JDKs", "committedDate": "2020-10-29T11:54:10Z", "type": "forcePushed"}, {"oid": "94eddb3d041583f88b22f76191ce761df97bae0d", "url": "https://github.com/wildfly/wildfly-core/commit/94eddb3d041583f88b22f76191ce761df97bae0d", "message": "parent d4e0210796d3d3daaf1e649fc0fb6f4fde12ea54\nauthor lvydra <lvydra@redhat.com> 1603700707 +0100\ncommitter Lukas Vydra <lvydra@redhat.com> 1604056423 +0100\n\n[WFCORE-3825] Unify -server option in windows scripts (ps1, bat) for domain mode (and its servers) on all JDKs", "committedDate": "2020-10-30T11:22:49Z", "type": "forcePushed"}, {"oid": "3d6b804f4729f6c4d4384799493c713706af6342", "url": "https://github.com/wildfly/wildfly-core/commit/3d6b804f4729f6c4d4384799493c713706af6342", "message": "[WFCORE-3825] Unify -server option in windows scripts (ps1, bat) for domain mode (and its servers) on all JDKs", "committedDate": "2020-10-30T11:28:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjg3ODc1Mw==", "url": "https://github.com/wildfly/wildfly-core/pull/4378#discussion_r542878753", "bodyText": "It looks like we might want to test for IBM too.\n# Check for IBM JVM w/server support\nif [ \"x$HAS_IBM\" = \"x\" ]; then\n    HAS_IBM=`\"$JAVA\" $JVM_OPTVERSION 2>&1 | $GREP -i \"IBM J9\"`\nfi", "author": "jamezp", "createdAt": "2020-12-14T22:33:13Z", "path": "core-feature-pack/common/src/main/resources/content/bin/common.ps1", "diffHunk": "@@ -308,6 +308,41 @@ Function Start-WildFly-Process {\n \tEnv-Clean-Up\n }\n \n+# Returns java -version output for JDK defined by java opts\n+Function Get-Java-Version ($javaOpts) {\n+    if ($javaOpts -match '-d64') {\n+        $opt_version = '-d64'\n+    } elseif ($javaOpts -match '-d32') {\n+        $opt_version = '-d32'\n+    }\n+\n+    $result = & $JAVA $opt_version -version 2>&1\n+    if ($LASTEXITCODE -eq 1) {\n+        $result = & $JAVA -version 2>&1\n+    }\n+\n+    return $result\n+}\n+\n+# Check if can set option to use HotSpot VM\n+Function Set-Java-Server-Option ($javaOpts) {\n+    if ( -Not ($javaOpts -match '-server') ) {\n+        # Check user requested JDK 'data model'\n+        $version = Get-Java-Version ($javaOpts)\n+\n+        # Check if data model is supported by JDK\n+        # Check for SUN(tm) JVM w/ HotSpot support\n+        # Check for OpenJDK JVM w/server support\n+        if ($LASTEXITCODE -eq 1) {\n+            Write-Host $version\n+        } elseif ($version -match 'HotSpot' -or $version -match 'OpenJDK') {", "originalCommit": "3d6b804f4729f6c4d4384799493c713706af6342", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjg4MDMyMw==", "url": "https://github.com/wildfly/wildfly-core/pull/4378#discussion_r542880323", "bodyText": "This may also need to check for IBM J9.", "author": "jamezp", "createdAt": "2020-12-14T22:34:54Z", "path": "core-feature-pack/common/src/main/resources/content/bin/domain.bat", "diffHunk": "@@ -103,14 +103,38 @@ call \"!DIRNAME!common.bat\" :setDefaultModularJvmOptions \"!PROCESS_CONTROLLER_JAV\n set \"PROCESS_CONTROLLER_JAVA_OPTS=!PROCESS_CONTROLLER_JAVA_OPTS! !DEFAULT_MODULAR_JVM_OPTIONS!\"\n call \"!DIRNAME!common.bat\" :setDefaultModularJvmOptions \"!HOST_CONTROLLER_JAVA_OPTS!\"\n set \"HOST_CONTROLLER_JAVA_OPTS=!HOST_CONTROLLER_JAVA_OPTS! !DEFAULT_MODULAR_JVM_OPTIONS!\"\n-setlocal DisableDelayedExpansion\n \n-rem Add -server to the JVM options, if supported\n-\"%JAVA%\" -server -version 2>&1 | findstr /I hotspot > nul\n-if not errorlevel == 1 (\n-  set \"PROCESS_CONTROLLER_JAVA_OPTS=%PROCESS_CONTROLLER_JAVA_OPTS% -server\"\n-  set \"HOST_CONTROLLER_JAVA_OPTS=%HOST_CONTROLLER_JAVA_OPTS% -server\"\n+rem Add -server to the JVM options, if supported by JDK\n+echo \"%JAVA_OPTS%\" | findstr /I \\-server > nul\n+if errorlevel == 1 (\n+    set JVM_OPTVERSION=-version\n+    echo \"%JAVA_OPTS%\" | findstr /I \\-d64 > nul\n+    if not errorlevel == 1 (\n+        set \"JVM_OPTVERSION=-d64 !JVM_OPTVERSION!\"\n+        goto :CHECK_VERSION\n+    )\n+    echo \"%JAVA_OPTS%\" | findstr /I \\-d32 > nul\n+    if not errorlevel == 1 (\n+        set \"JVM_OPTVERSION=-d32 !JVM_OPTVERSION!\"\n+        goto :CHECK_VERSION\n+    )\n+    goto :CHECK_SUPPORTED\n+\n+    :CHECK_VERSION\n+    \"%JAVA%\" !JVM_OPTVERSION! 2>&1 | findstr /I /C:\"Unrecognized option\" > nul\n+    if not errorlevel == 1 (\n+        set JVM_OPTVERSION=-version\n+    )\n+\n+    rem Add -server to the JVM options, if supported\n+    :CHECK_SUPPORTED\n+    \"%JAVA%\" !JVM_OPTVERSION! 2>&1 | findstr /I \"hotspot openJDK\" > nul", "originalCommit": "3d6b804f4729f6c4d4384799493c713706af6342", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9344d60dda3d4c52a030b1758f12edc642086fe6", "url": "https://github.com/wildfly/wildfly-core/commit/9344d60dda3d4c52a030b1758f12edc642086fe6", "message": "[WFCORE-3825] Unify -server option in windows scripts (ps1, bat) for domain mode (and its servers) on all JDKs", "committedDate": "2020-12-16T08:41:28Z", "type": "commit"}, {"oid": "9344d60dda3d4c52a030b1758f12edc642086fe6", "url": "https://github.com/wildfly/wildfly-core/commit/9344d60dda3d4c52a030b1758f12edc642086fe6", "message": "[WFCORE-3825] Unify -server option in windows scripts (ps1, bat) for domain mode (and its servers) on all JDKs", "committedDate": "2020-12-16T08:41:28Z", "type": "forcePushed"}]}