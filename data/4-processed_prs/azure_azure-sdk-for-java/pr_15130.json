{"pr_number": 15130, "pr_title": "Feat(e2e): Digital twin tests", "pr_createdAt": "2020-09-12T00:44:00Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/15130", "timeline": [{"oid": "b5476cd7f89278e829fd75f2381e989a5cc9c181", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b5476cd7f89278e829fd75f2381e989a5cc9c181", "message": "adding digital twin tests", "committedDate": "2020-09-12T00:24:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQzNjQ3OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15130#discussion_r487436478", "bodyText": "In your assertNext you can actually assert whether or not the update made the correct operation", "author": "azabbasi", "createdAt": "2020-09-12T18:37:28Z", "path": "sdk/digitaltwins/azure-digitaltwins-core/src/test/java/com/azure/digitaltwins/core/TwinAsyncTests.java", "diffHunk": "@@ -0,0 +1,103 @@\n+package com.azure.digitaltwins.core;\n+\n+import com.azure.core.http.HttpClient;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.azure.digitaltwins.core.helpers.UniqueIdHelper;\n+import com.azure.digitaltwins.core.models.*;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.MethodSource;\n+import org.opentest4j.AssertionFailedError;\n+import reactor.test.StepVerifier;\n+\n+import java.net.HttpURLConnection;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+import static com.azure.digitaltwins.core.TestHelper.DISPLAY_NAME_WITH_ARGUMENTS;\n+import static com.azure.digitaltwins.core.TestHelper.assertRestException;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+public class TwinAsyncTests extends TwinTestBase\n+{\n+    private final ClientLogger logger = new ClientLogger(TwinAsyncTests.class);\n+\n+    @ParameterizedTest(name = DISPLAY_NAME_WITH_ARGUMENTS)\n+    @MethodSource(\"com.azure.digitaltwins.core.TestHelper#getTestParameters\")\n+    @Override\n+    public void DigitalTwins_Lifecycle(HttpClient httpClient, DigitalTwinsServiceVersion serviceVersion)\n+    {\n+        DigitalTwinsAsyncClient asyncClient = getAsyncClient(httpClient, serviceVersion);\n+\n+        String roomTwinId = UniqueIdHelper.getUniqueDigitalTwinId(TestAssetDefaults.ROOM_TWIN_ID_PREFIX, asyncClient, randomIntegerStringGenerator);\n+        String floorModelId = UniqueIdHelper.getUniqueModelId(TestAssetDefaults.FLOOR_MODEL_ID, asyncClient, randomIntegerStringGenerator);\n+        String roomModelId = UniqueIdHelper.getUniqueModelId(TestAssetDefaults.ROOM_MODEL_ID, asyncClient, randomIntegerStringGenerator);\n+\n+        String roomTwin = TestAssetsHelper.getRoomTwinPayload(roomModelId);\n+        String roomModel = TestAssetsHelper.getRoomModelPayload(roomModelId, floorModelId);\n+        List<String> modelsList = new ArrayList<>(Arrays.asList(roomModel));\n+\n+        try {\n+            // Create models to test the Twin lifecycle.\n+            StepVerifier\n+                .create(asyncClient.createModels(modelsList))\n+                .assertNext(createResponseList -> logger.info(\"Created {} models successfully\", createResponseList.size()))\n+                .verifyComplete();\n+\n+            // Create a Twin\n+            StepVerifier.create(asyncClient.createDigitalTwin(roomTwinId, roomTwin, BasicDigitalTwin.class))\n+                .assertNext(createdTwin -> {\n+                    assertEquals(createdTwin.getId(), roomTwinId);\n+                    logger.info(\"Created {} twin successfully\", createdTwin.getId());\n+                })\n+                .verifyComplete();\n+\n+            // Get a Twin\n+            StepVerifier.create(asyncClient.getDigitalTwinWithResponse(roomTwinId))\n+                .assertNext(getResponse -> {\n+                    assertEquals(getResponse.getStatusCode(), HttpURLConnection.HTTP_OK);\n+                    logger.info(\"Got Twin successfully\");\n+\n+                })\n+                .verifyComplete();\n+\n+            // Update Twin\n+            StepVerifier.create(asyncClient.updateDigitalTwinWithResponse(roomTwinId, TestAssetsHelper.getRoomTwinUpdatePayload(), new UpdateDigitalTwinRequestOptions()))", "originalCommit": "b5476cd7f89278e829fd75f2381e989a5cc9c181", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQzNjUwOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15130#discussion_r487436508", "bodyText": "you need to block these calls otherwise this will never execute", "author": "azabbasi", "createdAt": "2020-09-12T18:37:52Z", "path": "sdk/digitaltwins/azure-digitaltwins-core/src/test/java/com/azure/digitaltwins/core/TwinAsyncTests.java", "diffHunk": "@@ -0,0 +1,103 @@\n+package com.azure.digitaltwins.core;\n+\n+import com.azure.core.http.HttpClient;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.azure.digitaltwins.core.helpers.UniqueIdHelper;\n+import com.azure.digitaltwins.core.models.*;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.MethodSource;\n+import org.opentest4j.AssertionFailedError;\n+import reactor.test.StepVerifier;\n+\n+import java.net.HttpURLConnection;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+import static com.azure.digitaltwins.core.TestHelper.DISPLAY_NAME_WITH_ARGUMENTS;\n+import static com.azure.digitaltwins.core.TestHelper.assertRestException;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+public class TwinAsyncTests extends TwinTestBase\n+{\n+    private final ClientLogger logger = new ClientLogger(TwinAsyncTests.class);\n+\n+    @ParameterizedTest(name = DISPLAY_NAME_WITH_ARGUMENTS)\n+    @MethodSource(\"com.azure.digitaltwins.core.TestHelper#getTestParameters\")\n+    @Override\n+    public void DigitalTwins_Lifecycle(HttpClient httpClient, DigitalTwinsServiceVersion serviceVersion)\n+    {\n+        DigitalTwinsAsyncClient asyncClient = getAsyncClient(httpClient, serviceVersion);\n+\n+        String roomTwinId = UniqueIdHelper.getUniqueDigitalTwinId(TestAssetDefaults.ROOM_TWIN_ID_PREFIX, asyncClient, randomIntegerStringGenerator);\n+        String floorModelId = UniqueIdHelper.getUniqueModelId(TestAssetDefaults.FLOOR_MODEL_ID, asyncClient, randomIntegerStringGenerator);\n+        String roomModelId = UniqueIdHelper.getUniqueModelId(TestAssetDefaults.ROOM_MODEL_ID, asyncClient, randomIntegerStringGenerator);\n+\n+        String roomTwin = TestAssetsHelper.getRoomTwinPayload(roomModelId);\n+        String roomModel = TestAssetsHelper.getRoomModelPayload(roomModelId, floorModelId);\n+        List<String> modelsList = new ArrayList<>(Arrays.asList(roomModel));\n+\n+        try {\n+            // Create models to test the Twin lifecycle.\n+            StepVerifier\n+                .create(asyncClient.createModels(modelsList))\n+                .assertNext(createResponseList -> logger.info(\"Created {} models successfully\", createResponseList.size()))\n+                .verifyComplete();\n+\n+            // Create a Twin\n+            StepVerifier.create(asyncClient.createDigitalTwin(roomTwinId, roomTwin, BasicDigitalTwin.class))\n+                .assertNext(createdTwin -> {\n+                    assertEquals(createdTwin.getId(), roomTwinId);\n+                    logger.info(\"Created {} twin successfully\", createdTwin.getId());\n+                })\n+                .verifyComplete();\n+\n+            // Get a Twin\n+            StepVerifier.create(asyncClient.getDigitalTwinWithResponse(roomTwinId))\n+                .assertNext(getResponse -> {\n+                    assertEquals(getResponse.getStatusCode(), HttpURLConnection.HTTP_OK);\n+                    logger.info(\"Got Twin successfully\");\n+\n+                })\n+                .verifyComplete();\n+\n+            // Update Twin\n+            StepVerifier.create(asyncClient.updateDigitalTwinWithResponse(roomTwinId, TestAssetsHelper.getRoomTwinUpdatePayload(), new UpdateDigitalTwinRequestOptions()))\n+                .assertNext(updateResponse -> {\n+                    assertEquals(updateResponse.getStatusCode(), HttpURLConnection.HTTP_NO_CONTENT);\n+                    logger.info(\"Updated the twin successfully\");\n+                })\n+                .verifyComplete();\n+        }\n+        // clean up\n+        finally {\n+            try\n+            {\n+                if (roomTwinId != null)\n+                {\n+                    asyncClient.deleteDigitalTwin(roomTwinId);", "originalCommit": "b5476cd7f89278e829fd75f2381e989a5cc9c181", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQzNjczNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15130#discussion_r487436737", "bodyText": "Let's call these test files DigitalTwinAsyncTests and DigitalTwinTests", "author": "azabbasi", "createdAt": "2020-09-12T18:40:43Z", "path": "sdk/digitaltwins/azure-digitaltwins-core/src/test/java/com/azure/digitaltwins/core/TwinAsyncTests.java", "diffHunk": "@@ -0,0 +1,103 @@\n+package com.azure.digitaltwins.core;", "originalCommit": "b5476cd7f89278e829fd75f2381e989a5cc9c181", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODA3Mjg5Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15130#discussion_r488072893", "bodyText": "this call needs to be blocked, else the process will exit before the async call completes.", "author": "abhipsaMisra", "createdAt": "2020-09-14T16:41:13Z", "path": "sdk/digitaltwins/azure-digitaltwins-core/src/test/java/com/azure/digitaltwins/core/TwinAsyncTests.java", "diffHunk": "@@ -0,0 +1,103 @@\n+package com.azure.digitaltwins.core;\n+\n+import com.azure.core.http.HttpClient;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.azure.digitaltwins.core.helpers.UniqueIdHelper;\n+import com.azure.digitaltwins.core.models.*;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.MethodSource;\n+import org.opentest4j.AssertionFailedError;\n+import reactor.test.StepVerifier;\n+\n+import java.net.HttpURLConnection;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+import static com.azure.digitaltwins.core.TestHelper.DISPLAY_NAME_WITH_ARGUMENTS;\n+import static com.azure.digitaltwins.core.TestHelper.assertRestException;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+public class TwinAsyncTests extends TwinTestBase\n+{\n+    private final ClientLogger logger = new ClientLogger(TwinAsyncTests.class);\n+\n+    @ParameterizedTest(name = DISPLAY_NAME_WITH_ARGUMENTS)\n+    @MethodSource(\"com.azure.digitaltwins.core.TestHelper#getTestParameters\")\n+    @Override\n+    public void DigitalTwins_Lifecycle(HttpClient httpClient, DigitalTwinsServiceVersion serviceVersion)\n+    {\n+        DigitalTwinsAsyncClient asyncClient = getAsyncClient(httpClient, serviceVersion);\n+\n+        String roomTwinId = UniqueIdHelper.getUniqueDigitalTwinId(TestAssetDefaults.ROOM_TWIN_ID_PREFIX, asyncClient, randomIntegerStringGenerator);\n+        String floorModelId = UniqueIdHelper.getUniqueModelId(TestAssetDefaults.FLOOR_MODEL_ID, asyncClient, randomIntegerStringGenerator);\n+        String roomModelId = UniqueIdHelper.getUniqueModelId(TestAssetDefaults.ROOM_MODEL_ID, asyncClient, randomIntegerStringGenerator);\n+\n+        String roomTwin = TestAssetsHelper.getRoomTwinPayload(roomModelId);\n+        String roomModel = TestAssetsHelper.getRoomModelPayload(roomModelId, floorModelId);\n+        List<String> modelsList = new ArrayList<>(Arrays.asList(roomModel));\n+\n+        try {\n+            // Create models to test the Twin lifecycle.\n+            StepVerifier\n+                .create(asyncClient.createModels(modelsList))\n+                .assertNext(createResponseList -> logger.info(\"Created {} models successfully\", createResponseList.size()))\n+                .verifyComplete();\n+\n+            // Create a Twin\n+            StepVerifier.create(asyncClient.createDigitalTwin(roomTwinId, roomTwin, BasicDigitalTwin.class))\n+                .assertNext(createdTwin -> {\n+                    assertEquals(createdTwin.getId(), roomTwinId);\n+                    logger.info(\"Created {} twin successfully\", createdTwin.getId());\n+                })\n+                .verifyComplete();\n+\n+            // Get a Twin\n+            StepVerifier.create(asyncClient.getDigitalTwinWithResponse(roomTwinId))\n+                .assertNext(getResponse -> {\n+                    assertEquals(getResponse.getStatusCode(), HttpURLConnection.HTTP_OK);\n+                    logger.info(\"Got Twin successfully\");\n+\n+                })\n+                .verifyComplete();\n+\n+            // Update Twin\n+            StepVerifier.create(asyncClient.updateDigitalTwinWithResponse(roomTwinId, TestAssetsHelper.getRoomTwinUpdatePayload(), new UpdateDigitalTwinRequestOptions()))\n+                .assertNext(updateResponse -> {\n+                    assertEquals(updateResponse.getStatusCode(), HttpURLConnection.HTTP_NO_CONTENT);\n+                    logger.info(\"Updated the twin successfully\");\n+                })\n+                .verifyComplete();\n+        }\n+        // clean up\n+        finally {\n+            try\n+            {\n+                if (roomTwinId != null)\n+                {\n+                    asyncClient.deleteDigitalTwin(roomTwinId);", "originalCommit": "b5476cd7f89278e829fd75f2381e989a5cc9c181", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODA3NzQyNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15130#discussion_r488077424", "bodyText": "I had the same comment. I will fix this in another PR.", "author": "azabbasi", "createdAt": "2020-09-14T16:46:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODA3Mjg5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODA3MzM3Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15130#discussion_r488073376", "bodyText": "shouldn't there be a assert here on whatever was updated?", "author": "abhipsaMisra", "createdAt": "2020-09-14T16:42:01Z", "path": "sdk/digitaltwins/azure-digitaltwins-core/src/test/java/com/azure/digitaltwins/core/TwinAsyncTests.java", "diffHunk": "@@ -0,0 +1,103 @@\n+package com.azure.digitaltwins.core;\n+\n+import com.azure.core.http.HttpClient;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.azure.digitaltwins.core.helpers.UniqueIdHelper;\n+import com.azure.digitaltwins.core.models.*;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.MethodSource;\n+import org.opentest4j.AssertionFailedError;\n+import reactor.test.StepVerifier;\n+\n+import java.net.HttpURLConnection;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+import static com.azure.digitaltwins.core.TestHelper.DISPLAY_NAME_WITH_ARGUMENTS;\n+import static com.azure.digitaltwins.core.TestHelper.assertRestException;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+public class TwinAsyncTests extends TwinTestBase\n+{\n+    private final ClientLogger logger = new ClientLogger(TwinAsyncTests.class);\n+\n+    @ParameterizedTest(name = DISPLAY_NAME_WITH_ARGUMENTS)\n+    @MethodSource(\"com.azure.digitaltwins.core.TestHelper#getTestParameters\")\n+    @Override\n+    public void DigitalTwins_Lifecycle(HttpClient httpClient, DigitalTwinsServiceVersion serviceVersion)\n+    {\n+        DigitalTwinsAsyncClient asyncClient = getAsyncClient(httpClient, serviceVersion);\n+\n+        String roomTwinId = UniqueIdHelper.getUniqueDigitalTwinId(TestAssetDefaults.ROOM_TWIN_ID_PREFIX, asyncClient, randomIntegerStringGenerator);\n+        String floorModelId = UniqueIdHelper.getUniqueModelId(TestAssetDefaults.FLOOR_MODEL_ID, asyncClient, randomIntegerStringGenerator);\n+        String roomModelId = UniqueIdHelper.getUniqueModelId(TestAssetDefaults.ROOM_MODEL_ID, asyncClient, randomIntegerStringGenerator);\n+\n+        String roomTwin = TestAssetsHelper.getRoomTwinPayload(roomModelId);\n+        String roomModel = TestAssetsHelper.getRoomModelPayload(roomModelId, floorModelId);\n+        List<String> modelsList = new ArrayList<>(Arrays.asList(roomModel));\n+\n+        try {\n+            // Create models to test the Twin lifecycle.\n+            StepVerifier\n+                .create(asyncClient.createModels(modelsList))\n+                .assertNext(createResponseList -> logger.info(\"Created {} models successfully\", createResponseList.size()))\n+                .verifyComplete();\n+\n+            // Create a Twin\n+            StepVerifier.create(asyncClient.createDigitalTwin(roomTwinId, roomTwin, BasicDigitalTwin.class))\n+                .assertNext(createdTwin -> {\n+                    assertEquals(createdTwin.getId(), roomTwinId);\n+                    logger.info(\"Created {} twin successfully\", createdTwin.getId());\n+                })\n+                .verifyComplete();\n+\n+            // Get a Twin\n+            StepVerifier.create(asyncClient.getDigitalTwinWithResponse(roomTwinId))\n+                .assertNext(getResponse -> {\n+                    assertEquals(getResponse.getStatusCode(), HttpURLConnection.HTTP_OK);\n+                    logger.info(\"Got Twin successfully\");\n+\n+                })\n+                .verifyComplete();\n+\n+            // Update Twin\n+            StepVerifier.create(asyncClient.updateDigitalTwinWithResponse(roomTwinId, TestAssetsHelper.getRoomTwinUpdatePayload(), new UpdateDigitalTwinRequestOptions()))\n+                .assertNext(updateResponse -> {\n+                    assertEquals(updateResponse.getStatusCode(), HttpURLConnection.HTTP_NO_CONTENT);", "originalCommit": "b5476cd7f89278e829fd75f2381e989a5cc9c181", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODA3NzU0OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15130#discussion_r488077548", "bodyText": "Same question asked. I will fix this in a PR since she is OOF", "author": "azabbasi", "createdAt": "2020-09-14T16:46:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODA3MzM3Ng=="}], "type": "inlineReview"}]}