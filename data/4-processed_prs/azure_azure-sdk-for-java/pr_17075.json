{"pr_number": 17075, "pr_title": "Add tests to digital twins sdk for etag scenarios", "pr_createdAt": "2020-11-02T22:46:34Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/17075", "timeline": [{"oid": "4bdabc9657d314abd2ed141eb98ce5542b2aa742", "url": "https://github.com/Azure/azure-sdk-for-java/commit/4bdabc9657d314abd2ed141eb98ce5542b2aa742", "message": "Add tests to digital twins sdk for etag scenarios", "committedDate": "2020-11-02T22:45:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjMzNDU1MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17075#discussion_r516334550", "bodyText": "formatting differences between this and the previous call on line 189 in terms of line breaks and tabbing.", "author": "drwill-ms", "createdAt": "2020-11-02T23:37:30Z", "path": "sdk/digitaltwins/azure-digitaltwins-core/src/test/java/com/azure/digitaltwins/core/ComponentsAsyncTests.java", "diffHunk": "@@ -89,4 +92,153 @@ public void componentLifecycleTest(HttpClient httpClient, DigitalTwinsServiceVer\n             }\n         }\n     }\n+\n+\n+    @ParameterizedTest(name = DISPLAY_NAME_WITH_ARGUMENTS)\n+    @MethodSource(\"com.azure.digitaltwins.core.TestHelper#getTestParameters\")\n+    @Override\n+    public void patchComponentFailsIfETagDoesNotMatch(HttpClient httpClient, DigitalTwinsServiceVersion serviceVersion) throws JsonProcessingException {\n+        DigitalTwinsAsyncClient asyncClient = getAsyncClient(httpClient, serviceVersion);\n+\n+        String wifiComponentName = \"wifiAccessPoint\";\n+\n+        String roomWithWifiTwinId = UniqueIdHelper.getUniqueDigitalTwinId(TestAssetDefaults.ROOM_WITH_WIFI_TWIN_ID_PREFIX, asyncClient, randomIntegerStringGenerator);\n+        String roomWithWifiModelId = UniqueIdHelper.getUniqueModelId(TestAssetDefaults.ROOM_WITH_WIFI_MODEL_ID_PREFIX, asyncClient, randomIntegerStringGenerator);\n+        String wifiModelId = UniqueIdHelper.getUniqueModelId(TestAssetDefaults.WIFI_MODEL_ID_PREFIX, asyncClient, randomIntegerStringGenerator);\n+\n+        String modelWifi = TestAssetsHelper.getWifiModelPayload(wifiModelId);\n+        String modelRoomWithWifi = TestAssetsHelper.getRoomWithWifiModelPayload(roomWithWifiModelId, wifiModelId, wifiComponentName);\n+        String roomWithWifiTwin = TestAssetsHelper.getRoomWithWifiTwinPayload(roomWithWifiModelId, wifiComponentName);\n+        List<String> modelsList = new ArrayList<>(Arrays.asList(modelWifi, modelRoomWithWifi));\n+\n+        try {\n+            // Create models and components to test the lifecycle.\n+            StepVerifier\n+                .create(asyncClient.createModels(modelsList))\n+                .assertNext(createResponseList -> logger.info(\"Created models successfully\"))\n+                .verifyComplete();\n+\n+            AtomicReference<String> etagBeforeUpdate = new AtomicReference<>();\n+            StepVerifier.create(asyncClient.createOrReplaceDigitalTwinWithResponse(\n+                roomWithWifiTwinId,\n+                deserializeJsonString(roomWithWifiTwin, BasicDigitalTwin.class),\n+                BasicDigitalTwin.class,\n+                null))\n+                .assertNext(createdTwinResponse -> {\n+                    etagBeforeUpdate.set(createdTwinResponse.getDeserializedHeaders().getETag());\n+                })\n+                .verifyComplete();\n+\n+            StepVerifier.create(asyncClient.updateComponentWithResponse(roomWithWifiTwinId, wifiComponentName, TestAssetsHelper.getWifiComponentUpdatePayload(), null))\n+                .assertNext(updateResponse -> {\n+                    logger.info(\"Updated the component successfully\");\n+                })\n+                .verifyComplete();\n+\n+            // Update the component again, but with the out of date etag\n+            StepVerifier.create(\n+                asyncClient.updateComponentWithResponse(\n+                    roomWithWifiTwinId,\n+                    wifiComponentName,\n+                    TestAssetsHelper.getWifiComponentSecondUpdatePayload(),\n+                    new UpdateComponentOptions().setIfMatch(etagBeforeUpdate.get())))\n+                .verifyErrorSatisfies(ex -> assertRestException(ex, HttpURLConnection.HTTP_PRECON_FAILED));\n+        }\n+        finally {\n+            try\n+            {\n+                if (roomWithWifiTwinId != null)\n+                {\n+                    asyncClient.deleteDigitalTwin(roomWithWifiTwinId).block();\n+                }\n+                if (roomWithWifiModelId != null)\n+                {\n+                    asyncClient.deleteModel(roomWithWifiModelId).block();\n+                }\n+                if (wifiModelId != null)\n+                {\n+                    asyncClient.deleteModel(wifiModelId).block();\n+                }\n+            }\n+            catch (Exception ex)\n+            {\n+                fail(\"Test cleanup failed\", ex);\n+            }\n+        }\n+    }\n+\n+    @ParameterizedTest(name = DISPLAY_NAME_WITH_ARGUMENTS)\n+    @MethodSource(\"com.azure.digitaltwins.core.TestHelper#getTestParameters\")\n+    @Override\n+    public void patchComponentSucceedsIfETagMatches(HttpClient httpClient, DigitalTwinsServiceVersion serviceVersion) throws JsonProcessingException {\n+        DigitalTwinsAsyncClient asyncClient = getAsyncClient(httpClient, serviceVersion);\n+\n+        String wifiComponentName = \"wifiAccessPoint\";\n+\n+        String roomWithWifiTwinId = UniqueIdHelper.getUniqueDigitalTwinId(TestAssetDefaults.ROOM_WITH_WIFI_TWIN_ID_PREFIX, asyncClient, randomIntegerStringGenerator);\n+        String roomWithWifiModelId = UniqueIdHelper.getUniqueModelId(TestAssetDefaults.ROOM_WITH_WIFI_MODEL_ID_PREFIX, asyncClient, randomIntegerStringGenerator);\n+        String wifiModelId = UniqueIdHelper.getUniqueModelId(TestAssetDefaults.WIFI_MODEL_ID_PREFIX, asyncClient, randomIntegerStringGenerator);\n+\n+        String modelWifi = TestAssetsHelper.getWifiModelPayload(wifiModelId);\n+        String modelRoomWithWifi = TestAssetsHelper.getRoomWithWifiModelPayload(roomWithWifiModelId, wifiModelId, wifiComponentName);\n+        String roomWithWifiTwin = TestAssetsHelper.getRoomWithWifiTwinPayload(roomWithWifiModelId, wifiComponentName);\n+        List<String> modelsList = new ArrayList<>(Arrays.asList(modelWifi, modelRoomWithWifi));\n+\n+        try {\n+            // Create models and components to test the lifecycle.\n+            StepVerifier\n+                .create(asyncClient.createModels(modelsList))\n+                .assertNext(createResponseList -> logger.info(\"Created models successfully\"))\n+                .verifyComplete();\n+\n+            StepVerifier.create(asyncClient.createOrReplaceDigitalTwinWithResponse(", "originalCommit": "4bdabc9657d314abd2ed141eb98ce5542b2aa742", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjMzNDkxMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17075#discussion_r516334912", "bodyText": "in Java, shouldn't brace formatting be like } finally {, try {, and } catch {?", "author": "drwill-ms", "createdAt": "2020-11-02T23:38:12Z", "path": "sdk/digitaltwins/azure-digitaltwins-core/src/test/java/com/azure/digitaltwins/core/ComponentsAsyncTests.java", "diffHunk": "@@ -89,4 +92,153 @@ public void componentLifecycleTest(HttpClient httpClient, DigitalTwinsServiceVer\n             }\n         }\n     }\n+\n+\n+    @ParameterizedTest(name = DISPLAY_NAME_WITH_ARGUMENTS)\n+    @MethodSource(\"com.azure.digitaltwins.core.TestHelper#getTestParameters\")\n+    @Override\n+    public void patchComponentFailsIfETagDoesNotMatch(HttpClient httpClient, DigitalTwinsServiceVersion serviceVersion) throws JsonProcessingException {\n+        DigitalTwinsAsyncClient asyncClient = getAsyncClient(httpClient, serviceVersion);\n+\n+        String wifiComponentName = \"wifiAccessPoint\";\n+\n+        String roomWithWifiTwinId = UniqueIdHelper.getUniqueDigitalTwinId(TestAssetDefaults.ROOM_WITH_WIFI_TWIN_ID_PREFIX, asyncClient, randomIntegerStringGenerator);\n+        String roomWithWifiModelId = UniqueIdHelper.getUniqueModelId(TestAssetDefaults.ROOM_WITH_WIFI_MODEL_ID_PREFIX, asyncClient, randomIntegerStringGenerator);\n+        String wifiModelId = UniqueIdHelper.getUniqueModelId(TestAssetDefaults.WIFI_MODEL_ID_PREFIX, asyncClient, randomIntegerStringGenerator);\n+\n+        String modelWifi = TestAssetsHelper.getWifiModelPayload(wifiModelId);\n+        String modelRoomWithWifi = TestAssetsHelper.getRoomWithWifiModelPayload(roomWithWifiModelId, wifiModelId, wifiComponentName);\n+        String roomWithWifiTwin = TestAssetsHelper.getRoomWithWifiTwinPayload(roomWithWifiModelId, wifiComponentName);\n+        List<String> modelsList = new ArrayList<>(Arrays.asList(modelWifi, modelRoomWithWifi));\n+\n+        try {\n+            // Create models and components to test the lifecycle.\n+            StepVerifier\n+                .create(asyncClient.createModels(modelsList))\n+                .assertNext(createResponseList -> logger.info(\"Created models successfully\"))\n+                .verifyComplete();\n+\n+            AtomicReference<String> etagBeforeUpdate = new AtomicReference<>();\n+            StepVerifier.create(asyncClient.createOrReplaceDigitalTwinWithResponse(\n+                roomWithWifiTwinId,\n+                deserializeJsonString(roomWithWifiTwin, BasicDigitalTwin.class),\n+                BasicDigitalTwin.class,\n+                null))\n+                .assertNext(createdTwinResponse -> {\n+                    etagBeforeUpdate.set(createdTwinResponse.getDeserializedHeaders().getETag());\n+                })\n+                .verifyComplete();\n+\n+            StepVerifier.create(asyncClient.updateComponentWithResponse(roomWithWifiTwinId, wifiComponentName, TestAssetsHelper.getWifiComponentUpdatePayload(), null))\n+                .assertNext(updateResponse -> {\n+                    logger.info(\"Updated the component successfully\");\n+                })\n+                .verifyComplete();\n+\n+            // Update the component again, but with the out of date etag\n+            StepVerifier.create(\n+                asyncClient.updateComponentWithResponse(\n+                    roomWithWifiTwinId,\n+                    wifiComponentName,\n+                    TestAssetsHelper.getWifiComponentSecondUpdatePayload(),\n+                    new UpdateComponentOptions().setIfMatch(etagBeforeUpdate.get())))\n+                .verifyErrorSatisfies(ex -> assertRestException(ex, HttpURLConnection.HTTP_PRECON_FAILED));\n+        }\n+        finally {\n+            try\n+            {\n+                if (roomWithWifiTwinId != null)\n+                {\n+                    asyncClient.deleteDigitalTwin(roomWithWifiTwinId).block();\n+                }\n+                if (roomWithWifiModelId != null)\n+                {\n+                    asyncClient.deleteModel(roomWithWifiModelId).block();\n+                }\n+                if (wifiModelId != null)\n+                {\n+                    asyncClient.deleteModel(wifiModelId).block();\n+                }\n+            }\n+            catch (Exception ex)\n+            {\n+                fail(\"Test cleanup failed\", ex);\n+            }\n+        }\n+    }\n+\n+    @ParameterizedTest(name = DISPLAY_NAME_WITH_ARGUMENTS)\n+    @MethodSource(\"com.azure.digitaltwins.core.TestHelper#getTestParameters\")\n+    @Override\n+    public void patchComponentSucceedsIfETagMatches(HttpClient httpClient, DigitalTwinsServiceVersion serviceVersion) throws JsonProcessingException {\n+        DigitalTwinsAsyncClient asyncClient = getAsyncClient(httpClient, serviceVersion);\n+\n+        String wifiComponentName = \"wifiAccessPoint\";\n+\n+        String roomWithWifiTwinId = UniqueIdHelper.getUniqueDigitalTwinId(TestAssetDefaults.ROOM_WITH_WIFI_TWIN_ID_PREFIX, asyncClient, randomIntegerStringGenerator);\n+        String roomWithWifiModelId = UniqueIdHelper.getUniqueModelId(TestAssetDefaults.ROOM_WITH_WIFI_MODEL_ID_PREFIX, asyncClient, randomIntegerStringGenerator);\n+        String wifiModelId = UniqueIdHelper.getUniqueModelId(TestAssetDefaults.WIFI_MODEL_ID_PREFIX, asyncClient, randomIntegerStringGenerator);\n+\n+        String modelWifi = TestAssetsHelper.getWifiModelPayload(wifiModelId);\n+        String modelRoomWithWifi = TestAssetsHelper.getRoomWithWifiModelPayload(roomWithWifiModelId, wifiModelId, wifiComponentName);\n+        String roomWithWifiTwin = TestAssetsHelper.getRoomWithWifiTwinPayload(roomWithWifiModelId, wifiComponentName);\n+        List<String> modelsList = new ArrayList<>(Arrays.asList(modelWifi, modelRoomWithWifi));\n+\n+        try {\n+            // Create models and components to test the lifecycle.\n+            StepVerifier\n+                .create(asyncClient.createModels(modelsList))\n+                .assertNext(createResponseList -> logger.info(\"Created models successfully\"))\n+                .verifyComplete();\n+\n+            StepVerifier.create(asyncClient.createOrReplaceDigitalTwinWithResponse(\n+                roomWithWifiTwinId,\n+                deserializeJsonString(roomWithWifiTwin, BasicDigitalTwin.class),\n+                BasicDigitalTwin.class,\n+                null))\n+                .assertNext(createdTwinResponse -> {\n+                    logger.info(\"Updated the component successfully\");\n+                })\n+                .verifyComplete();\n+\n+            AtomicReference<String> upToDateETag = new AtomicReference<>();\n+            StepVerifier.create(asyncClient.updateComponentWithResponse(roomWithWifiTwinId, wifiComponentName, TestAssetsHelper.getWifiComponentUpdatePayload(), null))\n+                .assertNext(updateResponse -> {\n+                    upToDateETag.set(updateResponse.getDeserializedHeaders().getETag());\n+                    logger.info(\"Updated the component successfully\");\n+                })\n+                .verifyComplete();\n+\n+            // Update the component again, but with the out of date etag\n+            StepVerifier.create(\n+                asyncClient.updateComponentWithResponse(\n+                    roomWithWifiTwinId,\n+                    wifiComponentName,\n+                    TestAssetsHelper.getWifiComponentSecondUpdatePayload(),\n+                    new UpdateComponentOptions().setIfMatch(upToDateETag.get())))\n+                .assertNext(response -> { /* don't care as long as it is a success status code */ })\n+                .verifyComplete();\n+        }", "originalCommit": "4bdabc9657d314abd2ed141eb98ce5542b2aa742", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5787a50b286e3ed0cd79445473ad81318d324cd7", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5787a50b286e3ed0cd79445473ad81318d324cd7", "message": "fixup", "committedDate": "2020-11-03T17:16:22Z", "type": "commit"}, {"oid": "a23aab0bdbbc8194b362dac9bf95e0d1e543cc03", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a23aab0bdbbc8194b362dac9bf95e0d1e543cc03", "message": "fixup", "committedDate": "2020-11-03T17:18:48Z", "type": "commit"}]}