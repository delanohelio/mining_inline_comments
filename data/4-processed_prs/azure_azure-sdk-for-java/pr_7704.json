{"pr_number": 7704, "pr_title": "Fix send span to encapsulate multiple send attempts (retries)", "pr_createdAt": "2020-01-24T21:58:13Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/7704", "timeline": [{"oid": "01ee876f7c815b9a39ab2dbef337d416a2d0b5a6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/01ee876f7c815b9a39ab2dbef337d416a2d0b5a6", "message": "fix retry send span", "committedDate": "2020-01-24T22:08:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg5MjU1Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7704#discussion_r370892553", "bodyText": "does it mean we'll send one span for the first try only?\nIt should be one span per Send call. If there is more than one try - it should wrap all of them:\n\nduration should be duration of send() call\nresult is the result of all tries (i.e. eventually sent or failed)", "author": "lmolkova", "createdAt": "2020-01-25T00:06:48Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventHubProducerAsyncClient.java", "diffHunk": "@@ -416,10 +416,11 @@ public String getEventHubName() {\n         }\n \n         final Context finalSharedContext = sharedContext != null ? sharedContext : Context.NONE;\n-\n         return withRetry(\n             getSendLink(batch.getPartitionId()).flatMap(link -> {\n-                if (isTracingEnabled) {\n+                // if parent context already has send span context data (in case of retries),\n+                // don't start a new send span\n+                if (isTracingEnabled && !parentContext.get().getData(HOST_NAME_KEY).isPresent()) {", "originalCommit": "01ee876f7c815b9a39ab2dbef337d416a2d0b5a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg5MzA5MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7704#discussion_r370893091", "bodyText": "does it mean we'll send one span for the first try only?\nyes, it will only start the first send span.\n\n\nit should wrap all of them\n\ndoes this mean we want to add links between all the send spans but start only a single span?", "author": "samvaity", "createdAt": "2020-01-25T00:10:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg5MjU1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg5ODQ3MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7704#discussion_r370898471", "bodyText": "We still create span per message and link all of these spans to the single 'send' span", "author": "lmolkova", "createdAt": "2020-01-25T00:45:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg5MjU1Mw=="}], "type": "inlineReview"}, {"oid": "131f0baeb5f708d85213c6d3fe8f1b00f8cce519", "url": "https://github.com/Azure/azure-sdk-for-java/commit/131f0baeb5f708d85213c6d3fe8f1b00f8cce519", "message": "update send retry span", "committedDate": "2020-02-05T23:21:47Z", "type": "forcePushed"}, {"oid": "fcdcbbc9aedb011d53bead85057feb9f452c2d58", "url": "https://github.com/Azure/azure-sdk-for-java/commit/fcdcbbc9aedb011d53bead85057feb9f452c2d58", "message": "fix retry send span", "committedDate": "2020-02-05T23:24:26Z", "type": "commit"}, {"oid": "8561642eb3c0caaf8cfc78ba6b8620d1b0ef2dac", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8561642eb3c0caaf8cfc78ba6b8620d1b0ef2dac", "message": "update send retry span", "committedDate": "2020-02-05T23:24:26Z", "type": "commit"}, {"oid": "8561642eb3c0caaf8cfc78ba6b8620d1b0ef2dac", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8561642eb3c0caaf8cfc78ba6b8620d1b0ef2dac", "message": "update send retry span", "committedDate": "2020-02-05T23:24:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU3NzM3Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7704#discussion_r375577376", "bodyText": "is it called on each try? will it end the span after first retry?", "author": "lmolkova", "createdAt": "2020-02-06T00:06:00Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventHubProducerAsyncClient.java", "diffHunk": "@@ -415,31 +414,24 @@ public String getEventHubName() {\n             messages.add(message);\n         }\n \n-        final Context finalSharedContext = sharedContext != null ? sharedContext : Context.NONE;\n+        if (isTracingEnabled) {\n+            final Context finalSharedContext = sharedContext == null\n+                ? Context.NONE\n+                : sharedContext.addData(ENTITY_PATH_KEY, eventHubName).addData(HOST_NAME_KEY, fullyQualifiedNamespace);\n+            // Start send span and store updated context\n+            parentContext.set(tracerProvider.startSpan(finalSharedContext, ProcessKind.SEND));\n+        }\n \n-        return withRetry(\n-            getSendLink(batch.getPartitionId()).flatMap(link -> {\n-                if (isTracingEnabled) {\n-                    Context entityContext = finalSharedContext.addData(ENTITY_PATH_KEY, link.getEntityPath());\n-                    // Start send span and store updated context\n-                    parentContext.set(tracerProvider.startSpan(\n-                        entityContext.addData(HOST_NAME_KEY, link.getHostname()), ProcessKind.SEND));\n-                }\n-                return messages.size() == 1\n+        return withRetry(getSendLink(batch.getPartitionId())\n+            .flatMap(link ->\n+                messages.size() == 1\n                     ? link.send(messages.get(0))\n-                    : link.send(messages);\n-\n-            })\n+                    : link.send(messages)), retryOptions.getTryTimeout(), retryPolicy)\n             .doOnEach(signal -> {", "originalCommit": "8561642eb3c0caaf8cfc78ba6b8620d1b0ef2dac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjAwOTMzMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7704#discussion_r376009331", "bodyText": "No, so with the updated code, it nows does doOnEach after the withRetry has completed.\nSo, once withRetry completes either with error or success , it will send a signal and the endSpan uses the signal type to set error or success.", "author": "samvaity", "createdAt": "2020-02-06T18:34:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU3NzM3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU3NzQ4MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7704#discussion_r375577480", "bodyText": "does it mean we no longer set error if all retries has failed?", "author": "lmolkova", "createdAt": "2020-02-06T00:06:23Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventHubProducerAsyncClient.java", "diffHunk": "@@ -415,31 +414,24 @@ public String getEventHubName() {\n             messages.add(message);\n         }\n \n-        final Context finalSharedContext = sharedContext != null ? sharedContext : Context.NONE;\n+        if (isTracingEnabled) {\n+            final Context finalSharedContext = sharedContext == null\n+                ? Context.NONE\n+                : sharedContext.addData(ENTITY_PATH_KEY, eventHubName).addData(HOST_NAME_KEY, fullyQualifiedNamespace);\n+            // Start send span and store updated context\n+            parentContext.set(tracerProvider.startSpan(finalSharedContext, ProcessKind.SEND));\n+        }\n \n-        return withRetry(\n-            getSendLink(batch.getPartitionId()).flatMap(link -> {\n-                if (isTracingEnabled) {\n-                    Context entityContext = finalSharedContext.addData(ENTITY_PATH_KEY, link.getEntityPath());\n-                    // Start send span and store updated context\n-                    parentContext.set(tracerProvider.startSpan(\n-                        entityContext.addData(HOST_NAME_KEY, link.getHostname()), ProcessKind.SEND));\n-                }\n-                return messages.size() == 1\n+        return withRetry(getSendLink(batch.getPartitionId())\n+            .flatMap(link ->\n+                messages.size() == 1\n                     ? link.send(messages.get(0))\n-                    : link.send(messages);\n-\n-            })\n+                    : link.send(messages)), retryOptions.getTryTimeout(), retryPolicy)\n             .doOnEach(signal -> {\n                 if (isTracingEnabled) {\n                     tracerProvider.endSpan(parentContext.get(), signal);\n                 }\n-            })\n-            .doOnError(error -> {", "originalCommit": "8561642eb3c0caaf8cfc78ba6b8620d1b0ef2dac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjAwOTUwNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7704#discussion_r376009507", "bodyText": "same as above", "author": "samvaity", "createdAt": "2020-02-06T18:34:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU3NzQ4MA=="}], "type": "inlineReview"}]}