{"pr_number": 11101, "pr_title": "File share soft delete", "pr_createdAt": "2020-05-12T20:49:31Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/11101", "timeline": [{"oid": "59c78b217a5f3bcd188b051e0d8a3b54f5e6ba9b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/59c78b217a5f3bcd188b051e0d8a3b54f5e6ba9b", "message": "change versioned account for tests variable names", "committedDate": "2020-04-13T16:37:13Z", "type": "commit"}, {"oid": "cbfa86af23cf366fc9904fa86040a473c042ef75", "url": "https://github.com/Azure/azure-sdk-for-java/commit/cbfa86af23cf366fc9904fa86040a473c042ef75", "message": "Merge remote-tracking branch 'upstream/feature/storage/stg73' into feature/storage/stg73", "committedDate": "2020-04-20T15:00:42Z", "type": "commit"}, {"oid": "f5b8a406e6b14251e0e9d800c1ea7e08c251439e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f5b8a406e6b14251e0e9d800c1ea7e08c251439e", "message": "Merge remote-tracking branch 'upstream/feature/storage/stg73' into feature/storage/stg73", "committedDate": "2020-04-30T15:10:12Z", "type": "commit"}, {"oid": "0e6a057da79b32d1096f7acea08f9d35dc6d77e7", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0e6a057da79b32d1096f7acea08f9d35dc6d77e7", "message": "Merge remote-tracking branch 'upstream/feature/storage/stg73' into feature/storage/stg73", "committedDate": "2020-05-05T16:55:08Z", "type": "commit"}, {"oid": "dbe71dfe62c843fbdc4a710115bb36d05e432db0", "url": "https://github.com/Azure/azure-sdk-for-java/commit/dbe71dfe62c843fbdc4a710115bb36d05e432db0", "message": "Merge remote-tracking branch 'upstream/feature/storage/stg73' into feature/storage/stg73", "committedDate": "2020-05-06T01:01:40Z", "type": "commit"}, {"oid": "1d47d76c6c06f23cc4029e8be34c8f2a82006cfe", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1d47d76c6c06f23cc4029e8be34c8f2a82006cfe", "message": "regenerate client.", "committedDate": "2020-05-12T20:24:02Z", "type": "commit"}, {"oid": "74dfd07023de95b3f7fb36d9fd6c83abdda75360", "url": "https://github.com/Azure/azure-sdk-for-java/commit/74dfd07023de95b3f7fb36d9fd6c83abdda75360", "message": "fix restore generation.", "committedDate": "2020-05-12T20:33:12Z", "type": "commit"}, {"oid": "9ec5c673eccb766e8db6843e1146f2f87a225840", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9ec5c673eccb766e8db6843e1146f2f87a225840", "message": "bump service version", "committedDate": "2020-05-12T20:48:17Z", "type": "commit"}, {"oid": "cc1a3f026fd9eadb7dcb95728adec7ec5b96b3fd", "url": "https://github.com/Azure/azure-sdk-for-java/commit/cc1a3f026fd9eadb7dcb95728adec7ec5b96b3fd", "message": "list deleted shares.", "committedDate": "2020-05-12T22:45:45Z", "type": "commit"}, {"oid": "925235a1754687f3b6b3b5dc05e2e00b98d1d307", "url": "https://github.com/Azure/azure-sdk-for-java/commit/925235a1754687f3b6b3b5dc05e2e00b98d1d307", "message": "list undeleted - fix order", "committedDate": "2020-05-13T00:09:33Z", "type": "commit"}, {"oid": "03e64a65b977d2de23498755ae50938479a06772", "url": "https://github.com/Azure/azure-sdk-for-java/commit/03e64a65b977d2de23498755ae50938479a06772", "message": "impl.", "committedDate": "2020-05-13T21:19:25Z", "type": "commit"}, {"oid": "8e48eee9c081941e25048e02e7c5dac9edba283e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8e48eee9c081941e25048e02e7c5dac9edba283e", "message": "Javadoc", "committedDate": "2020-05-13T22:13:01Z", "type": "commit"}, {"oid": "b7572c2d043f9cf81d3dfc88beb5b605763ec91b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b7572c2d043f9cf81d3dfc88beb5b605763ec91b", "message": "code samples.", "committedDate": "2020-05-14T16:12:23Z", "type": "commit"}, {"oid": "c8d286b11c0087a79f744f936fbd9fb6e8cfa74a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c8d286b11c0087a79f744f936fbd9fb6e8cfa74a", "message": "Merge remote-tracking branch 'upstream/feature/storage/stg73' into feature/storage/stg73", "committedDate": "2020-05-14T17:02:45Z", "type": "commit"}, {"oid": "9a8c9f81d1161b095a352a874efcdc9299ec7561", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9a8c9f81d1161b095a352a874efcdc9299ec7561", "message": "Merge branch 'feature/storage/stg73' into feature/storage/share-soft-delete", "committedDate": "2020-05-14T17:06:54Z", "type": "commit"}, {"oid": "0addd7ef8211c6f29c120ab6cade2f51dee8f9bf", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0addd7ef8211c6f29c120ab6cade2f51dee8f9bf", "message": "fix build", "committedDate": "2020-05-14T17:19:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMzMTE5OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11101#discussion_r425331198", "bodyText": "Generally it is better to include TODOs outside of the comment for two reasons:\n\nIf we ship a beta or GA but forget to remove it we won't have silly documentation\nIntelliJ and other IDEs offer functionality to highlight TODO comment lines.", "author": "alzimmermsft", "createdAt": "2020-05-14T18:01:28Z", "path": "sdk/storage/azure-storage-file-share/src/main/java/com/azure/storage/file/share/ShareServiceAsyncClient.java", "diffHunk": "@@ -534,4 +538,64 @@ public String generateAccountSas(AccountSasSignatureValues accountSasSignatureVa\n         return new AccountSasImplUtil(accountSasSignatureValues)\n             .generateSas(SasImplUtils.extractSharedKeyCredential(getHttpPipeline()));\n     }\n+\n+    /**\n+     * Restores a previously deleted share.\n+     * If the share associated with provided <code>deletedShareName</code>\n+     * already exists, this call will result in a 409 (conflict).\n+     * This API is only functional if Share Soft Delete is enabled\n+     * for the storage account associated with the share.\n+     * For more information, see the\n+     * <a href=\"TBD\">Azure Docs</a>. TODO (kasobol-msft) add link to REST API docs", "originalCommit": "0addd7ef8211c6f29c120ab6cade2f51dee8f9bf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMzMTUwNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11101#discussion_r425331506", "bodyText": "Same as the other TODO comment", "author": "alzimmermsft", "createdAt": "2020-05-14T18:02:00Z", "path": "sdk/storage/azure-storage-file-share/src/main/java/com/azure/storage/file/share/ShareServiceAsyncClient.java", "diffHunk": "@@ -534,4 +538,64 @@ public String generateAccountSas(AccountSasSignatureValues accountSasSignatureVa\n         return new AccountSasImplUtil(accountSasSignatureValues)\n             .generateSas(SasImplUtils.extractSharedKeyCredential(getHttpPipeline()));\n     }\n+\n+    /**\n+     * Restores a previously deleted share.\n+     * If the share associated with provided <code>deletedShareName</code>\n+     * already exists, this call will result in a 409 (conflict).\n+     * This API is only functional if Share Soft Delete is enabled\n+     * for the storage account associated with the share.\n+     * For more information, see the\n+     * <a href=\"TBD\">Azure Docs</a>. TODO (kasobol-msft) add link to REST API docs\n+     *\n+     * <p><strong>Code Samples</strong></p>\n+     *\n+     * {@codesnippet com.azure.storage.file.share.ShareServiceAsyncClient.undeleteShare#String-String}\n+     *\n+     * @param deletedShareName The name of the previously deleted share.\n+     * @param deletedShareVersion The version of the previously deleted share.\n+     * @return A {@link Mono} containing a {@link ShareAsyncClient} used\n+     * to interact with the restored share.\n+     */\n+    public Mono<ShareAsyncClient> undeleteShare(\n+        String deletedShareName, String deletedShareVersion) {\n+        return this.undeleteShareWithResponse(deletedShareName, deletedShareVersion).flatMap(FluxUtil::toMono);\n+    }\n+\n+    /**\n+     * Restores a previously deleted share.\n+     * If the share associated with provided <code>deletedShareName</code>\n+     * already exists, this call will result in a 409 (conflict).\n+     * This API is only functional if Share Soft Delete is enabled\n+     * for the storage account associated with the share.\n+     * For more information, see the\n+     * <a href=\"TBD\">Azure Docs</a>. TODO (kasobol-msft) add link to REST API docs", "originalCommit": "0addd7ef8211c6f29c120ab6cade2f51dee8f9bf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMzMjAzNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11101#discussion_r425332035", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Restores a previously deleted share.\n          \n          \n            \n                 * If the share associated with provided <code>deletedShareName</code>\n          \n          \n            \n                 * already exists, this call will result in a 409 (conflict).\n          \n          \n            \n                 * This API is only functional if Share Soft Delete is enabled\n          \n          \n            \n                 * for the storage account associated with the share.\n          \n          \n            \n                 * For more information, see the\n          \n          \n            \n                 * <a href=\"TBD\">Azure Docs</a>. TODO (kasobol-msft) add link to REST API docs\n          \n          \n            \n                 * Restores a previously deleted share.\n          \n          \n            \n                 * <p>\n          \n          \n            \n                 * If the share associated with provided <code>deletedShareName</code>\n          \n          \n            \n                 * already exists, this call will result in a 409 (conflict).\n          \n          \n            \n                 * <p>\n          \n          \n            \n                 * This API is only functional if Share Soft Delete is enabled\n          \n          \n            \n                 * for the storage account associated with the share.\n          \n          \n            \n                 * For more information, see the\n          \n          \n            \n                 * <a href=\"TBD\">Azure Docs</a>. TODO (kasobol-msft) add link to REST API docs\n          \n      \n    \n    \n  \n\nJavadocs are HTML paragraphs so newlines aren't maintained.", "author": "alzimmermsft", "createdAt": "2020-05-14T18:02:54Z", "path": "sdk/storage/azure-storage-file-share/src/main/java/com/azure/storage/file/share/ShareServiceAsyncClient.java", "diffHunk": "@@ -534,4 +538,64 @@ public String generateAccountSas(AccountSasSignatureValues accountSasSignatureVa\n         return new AccountSasImplUtil(accountSasSignatureValues)\n             .generateSas(SasImplUtils.extractSharedKeyCredential(getHttpPipeline()));\n     }\n+\n+    /**\n+     * Restores a previously deleted share.\n+     * If the share associated with provided <code>deletedShareName</code>\n+     * already exists, this call will result in a 409 (conflict).\n+     * This API is only functional if Share Soft Delete is enabled\n+     * for the storage account associated with the share.\n+     * For more information, see the\n+     * <a href=\"TBD\">Azure Docs</a>. TODO (kasobol-msft) add link to REST API docs", "originalCommit": "0addd7ef8211c6f29c120ab6cade2f51dee8f9bf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMzMjk4Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11101#discussion_r425332986", "bodyText": "I'm a little confused here, will this undelete the specified share with the name of this share client? I'm guessing this will 409 if we already recreated a share with the delete name because you should rename the share instead?", "author": "alzimmermsft", "createdAt": "2020-05-14T18:04:31Z", "path": "sdk/storage/azure-storage-file-share/src/main/java/com/azure/storage/file/share/ShareServiceAsyncClient.java", "diffHunk": "@@ -534,4 +538,64 @@ public String generateAccountSas(AccountSasSignatureValues accountSasSignatureVa\n         return new AccountSasImplUtil(accountSasSignatureValues)\n             .generateSas(SasImplUtils.extractSharedKeyCredential(getHttpPipeline()));\n     }\n+\n+    /**\n+     * Restores a previously deleted share.\n+     * If the share associated with provided <code>deletedShareName</code>\n+     * already exists, this call will result in a 409 (conflict).", "originalCommit": "0addd7ef8211c6f29c120ab6cade2f51dee8f9bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM2NDI4Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11101#discussion_r425364282", "bodyText": "This API is on ShareServiceAsyncClient a level up from ShareAsyncClient (to have parity with outcome of this discussion #10900 (comment) for blobs). Therefore deletedShareName is the only source of name for restored share. So, if someone created new (or already undeleted) share with same name as deletedShareName then restore fails as name is already taken.\nThe option to rename share while undeleting is not part of this PR due to server side not being ready to release it.", "author": "kasobol-msft", "createdAt": "2020-05-14T18:59:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMzMjk4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMzNDU1Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11101#discussion_r425334552", "bodyText": "No need for .then().\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    ).then().block();\n          \n          \n            \n                    ).block();", "author": "alzimmermsft", "createdAt": "2020-05-14T18:07:10Z", "path": "sdk/storage/azure-storage-file-share/src/samples/java/com/azure/storage/file/share/ShareServiceAsyncJavaDocCodeSamples.java", "diffHunk": "@@ -286,4 +288,41 @@ public void generateAccountSas() {\n         String sas = fileServiceAsyncClient.generateAccountSas(sasValues);\n         // END: com.azure.storage.file.share.ShareServiceAsyncClient.generateAccountSas#AccountSasSignatureValues\n     }\n+\n+    /**\n+     * Code snippet for {@link ShareServiceAsyncClient#undeleteShare(String, String)}.\n+     */\n+    public void undeleteShare() {\n+        ShareServiceAsyncClient fileServiceAsyncClient = createAsyncClientWithSASToken();\n+        // BEGIN: com.azure.storage.file.share.ShareServiceAsyncClient.undeleteShare#String-String\n+        ListSharesOptions listSharesOptions = new ListSharesOptions();\n+        listSharesOptions.setIncludeDeleted(true);\n+        fileServiceAsyncClient.listShares(listSharesOptions).flatMap(\n+            deletedShare -> {\n+                Mono<ShareAsyncClient> shareAsyncClient = fileServiceAsyncClient.undeleteShare(\n+                    deletedShare.getName(), deletedShare.getVersion());\n+                return shareAsyncClient;\n+            }\n+        ).then().block();", "originalCommit": "0addd7ef8211c6f29c120ab6cade2f51dee8f9bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM2NzA5Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11101#discussion_r425367092", "bodyText": "it's a collection (aka Flux) . I can do blockFirst()", "author": "kasobol-msft", "createdAt": "2020-05-14T19:04:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMzNDU1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMzNTQ4Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11101#discussion_r425335487", "bodyText": "Are we guessing that the common pattern will be to list deleted shares to undelete them?", "author": "alzimmermsft", "createdAt": "2020-05-14T18:08:47Z", "path": "sdk/storage/azure-storage-file-share/src/samples/java/com/azure/storage/file/share/ShareServiceAsyncJavaDocCodeSamples.java", "diffHunk": "@@ -286,4 +288,41 @@ public void generateAccountSas() {\n         String sas = fileServiceAsyncClient.generateAccountSas(sasValues);\n         // END: com.azure.storage.file.share.ShareServiceAsyncClient.generateAccountSas#AccountSasSignatureValues\n     }\n+\n+    /**\n+     * Code snippet for {@link ShareServiceAsyncClient#undeleteShare(String, String)}.\n+     */\n+    public void undeleteShare() {\n+        ShareServiceAsyncClient fileServiceAsyncClient = createAsyncClientWithSASToken();\n+        // BEGIN: com.azure.storage.file.share.ShareServiceAsyncClient.undeleteShare#String-String\n+        ListSharesOptions listSharesOptions = new ListSharesOptions();\n+        listSharesOptions.setIncludeDeleted(true);\n+        fileServiceAsyncClient.listShares(listSharesOptions).flatMap(", "originalCommit": "0addd7ef8211c6f29c120ab6cade2f51dee8f9bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM1NzY3OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11101#discussion_r425357679", "bodyText": "Correct. We need two things to undelete a share - name and version. Listing API is the only way to obtain version.", "author": "kasobol-msft", "createdAt": "2020-05-14T18:48:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMzNTQ4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMzNzQ3Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11101#discussion_r425337477", "bodyText": "We should probably continue to maintain prefixes in cases where there is stale testing data. I know this has been an issue in the past which caused flakiness in tests.", "author": "alzimmermsft", "createdAt": "2020-05-14T18:12:21Z", "path": "sdk/storage/azure-storage-file-share/src/test/java/com/azure/storage/file/share/FileServiceAPITests.groovy", "diffHunk": "@@ -108,38 +112,46 @@ class FileServiceAPITests extends APISpec {\n     def \"List shares with filter\"() {\n         given:\n         LinkedList<ShareItem> testShares = new LinkedList<>()\n-        for (int i = 0; i < 3; i++) {\n+        options.setPrefix(shareName)\n+        for (int i = 0; i < 4; i++) {\n             ShareItem share = new ShareItem().setProperties(new ShareProperties().setQuota(i + 1)).setName(shareName + i)\n             if (i == 2) {\n                 share.setMetadata(testMetadata)\n             }\n \n             testShares.add(share)\n             primaryFileServiceClient.createShareWithResponse(share.getName(), share.getMetadata(), share.getProperties().getQuota(), null, null)\n+\n+            if (i == 3) {\n+                share.getProperties().setDeletedTime(OffsetDateTime.now())\n+                primaryFileServiceClient.deleteShare(share.getName())\n+            }\n         }\n \n         when:\n         def shares = primaryFileServiceClient.listShares(options, null, null).iterator()\n \n         then:\n         for (int i = 0; i < limits; i++) {\n-            FileTestHelper.assertSharesAreEqual(testShares.pop(), shares.next(), includeMetadata, includeSnapshot)\n+            FileTestHelper.assertSharesAreEqual(testShares.pop(), shares.next(), includeMetadata, includeSnapshot, includeDeleted)\n         }\n-        !shares.hasNext()\n+        includeDeleted || !shares.hasNext()\n \n         where:\n-        options                                                                                                | limits | includeMetadata | includeSnapshot\n-        new ListSharesOptions().setPrefix(\"fileserviceapitestslistshareswithfilter\")                           | 3      | false           | true\n-        new ListSharesOptions().setPrefix(\"fileserviceapitestslistshareswithfilter\").setIncludeMetadata(true)  | 3      | true            | true\n-        new ListSharesOptions().setPrefix(\"fileserviceapitestslistshareswithfilter\").setIncludeMetadata(false) | 3      | false           | true\n-        new ListSharesOptions().setPrefix(\"fileserviceapitestslistshareswithfilter\").setMaxResultsPerPage(2)   | 3      | false           | true\n+        options                                           | limits | includeMetadata | includeSnapshot | includeDeleted\n+        new ListSharesOptions()                           | 3      | false           | true            | false", "originalCommit": "0addd7ef8211c6f29c120ab6cade2f51dee8f9bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM2MDAzNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11101#discussion_r425360037", "bodyText": "The prefix is maintained. It just set in given clause instead of hardcoding.\nWe do this : options.setPrefix(shareName) where shareName is coming from shareName = testResourceName.randomName(methodName, 60) in the setup().\nThis had to be changed to include some randomness in search prefix because share with softdelete enabled actually accumulates stale data for some time (i.e. 1 day).", "author": "kasobol-msft", "createdAt": "2020-05-14T18:52:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMzNzQ3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMzNzkzMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11101#discussion_r425337932", "bodyText": "I believe there is a utility method in APISpec that does this.", "author": "alzimmermsft", "createdAt": "2020-05-14T18:13:07Z", "path": "sdk/storage/azure-storage-file-share/src/test/java/com/azure/storage/file/share/FileServiceAPITests.groovy", "diffHunk": "@@ -235,4 +252,60 @@ class FileServiceAPITests extends APISpec {\n         INVALID_ALLOWED_ORIGIN | 400        | ShareErrorCode.INVALID_XML_DOCUMENT\n         INVALID_ALLOWED_METHOD | 400        | ShareErrorCode.INVALID_XML_NODE_VALUE\n     }\n+\n+    def \"Restore share min\"() {\n+        given:\n+        def shareClient = primaryFileServiceClient.getShareClient(generateShareName())\n+        shareClient.create()\n+        def fileName = generatePathName()\n+        shareClient.getFileClient(fileName).create(2)\n+        shareClient.delete()\n+        if (TestMode.PLAYBACK != getTestMode()) {\n+            Thread.sleep(30000)\n+        }", "originalCommit": "0addd7ef8211c6f29c120ab6cade2f51dee8f9bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM2MDQ5MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11101#discussion_r425360491", "bodyText": "I've seen that in blobs but not in shares. I'll double check and add if missing.", "author": "kasobol-msft", "createdAt": "2020-05-14T18:53:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMzNzkzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMzODA2Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11101#discussion_r425338063", "bodyText": "Same comment.", "author": "alzimmermsft", "createdAt": "2020-05-14T18:13:21Z", "path": "sdk/storage/azure-storage-file-share/src/test/java/com/azure/storage/file/share/FileServiceAPITests.groovy", "diffHunk": "@@ -235,4 +252,60 @@ class FileServiceAPITests extends APISpec {\n         INVALID_ALLOWED_ORIGIN | 400        | ShareErrorCode.INVALID_XML_DOCUMENT\n         INVALID_ALLOWED_METHOD | 400        | ShareErrorCode.INVALID_XML_NODE_VALUE\n     }\n+\n+    def \"Restore share min\"() {\n+        given:\n+        def shareClient = primaryFileServiceClient.getShareClient(generateShareName())\n+        shareClient.create()\n+        def fileName = generatePathName()\n+        shareClient.getFileClient(fileName).create(2)\n+        shareClient.delete()\n+        if (TestMode.PLAYBACK != getTestMode()) {\n+            Thread.sleep(30000)\n+        }\n+        def shareItem = primaryFileServiceClient.listShares(\n+            new ListSharesOptions()\n+                .setPrefix(shareClient.getShareName())\n+                .setIncludeDeleted(true),\n+            null, Context.NONE).first()\n+\n+        when:\n+        def restoredShareClient = primaryFileServiceClient.undeleteShare(shareItem.getName(), shareItem.getVersion())\n+\n+        then:\n+        restoredShareClient.getFileClient(fileName).exists()\n+    }\n+\n+    def \"Restore share max\"() {\n+        given:\n+        def shareClient = primaryFileServiceClient.getShareClient(generateShareName())\n+        shareClient.create()\n+        def fileName = generatePathName()\n+        shareClient.getFileClient(fileName).create(2)\n+        shareClient.delete()\n+        if (TestMode.PLAYBACK != getTestMode()) {\n+            Thread.sleep(30000)\n+        }", "originalCommit": "0addd7ef8211c6f29c120ab6cade2f51dee8f9bf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMzOTU0MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11101#discussion_r425339540", "bodyText": "I would break this into two parts.\n\nCreate the resources need using a block (or StepVerifier, either works).\nThen use sleep if record before going into when.\n\nRight now this feels that setup contains setup and when logic.", "author": "alzimmermsft", "createdAt": "2020-05-14T18:15:58Z", "path": "sdk/storage/azure-storage-file-share/src/test/java/com/azure/storage/file/share/FileServiceAsyncAPITests.groovy", "diffHunk": "@@ -266,4 +272,69 @@ class FileServiceAsyncAPITests extends APISpec {\n         INVALID_ALLOWED_METHOD | 400        | ShareErrorCode.INVALID_XML_NODE_VALUE\n \n     }\n+\n+    def \"Restore share min\"() {\n+        given:\n+        def shareClient = primaryFileServiceAsyncClient.getShareAsyncClient(generateShareName())\n+        def fileName = generatePathName()\n+        def delay = TestMode.PLAYBACK == getTestMode() ? 0L : 30000L\n+        def shareItemMono = shareClient.create()\n+            .then(shareClient.getFileClient(fileName).create(2))\n+            .then(shareClient.delete())\n+            .then(Mono.delay(Duration.ofMillis(delay)))\n+            .then(primaryFileServiceAsyncClient.listShares(\n+                new ListSharesOptions()\n+                    .setPrefix(shareClient.getShareName())\n+                    .setIncludeDeleted(true)).next())", "originalCommit": "0addd7ef8211c6f29c120ab6cade2f51dee8f9bf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "05678851176f1ad102e3a82ad77e045675d882a2", "url": "https://github.com/Azure/azure-sdk-for-java/commit/05678851176f1ad102e3a82ad77e045675d882a2", "message": "pr feedback", "committedDate": "2020-05-14T19:14:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ5NDcxMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11101#discussion_r425494711", "bodyText": "The rest docs seem to suggest you can rename the share like you can for containers. Is that no longer true? Or is the swagger not accurate?", "author": "rickle-msft", "createdAt": "2020-05-15T00:03:59Z", "path": "sdk/storage/azure-storage-file-share/src/main/java/com/azure/storage/file/share/ShareServiceAsyncClient.java", "diffHunk": "@@ -534,4 +538,74 @@ public String generateAccountSas(AccountSasSignatureValues accountSasSignatureVa\n         return new AccountSasImplUtil(accountSasSignatureValues)\n             .generateSas(SasImplUtils.extractSharedKeyCredential(getHttpPipeline()));\n     }\n+\n+    /**\n+     * Restores a previously deleted share.\n+     * <p>\n+     * If the share associated with provided <code>deletedShareName</code>\n+     * already exists, this call will result in a 409 (conflict).\n+     * </p>\n+     * <p>\n+     * This API is only functional if Share Soft Delete is enabled\n+     * for the storage account associated with the share.\n+     * For more information, see the\n+     * <a href=\"TBD\">Azure Docs</a>.\n+     * </p>\n+     *\n+     * <p><strong>Code Samples</strong></p>\n+     *\n+     * {@codesnippet com.azure.storage.file.share.ShareServiceAsyncClient.undeleteShare#String-String}\n+     *\n+     * @param deletedShareName The name of the previously deleted share.\n+     * @param deletedShareVersion The version of the previously deleted share.\n+     * @return A {@link Mono} containing a {@link ShareAsyncClient} used\n+     * to interact with the restored share.\n+     */\n+    // TODO (kasobol-msft) add link to REST API docs\n+    public Mono<ShareAsyncClient> undeleteShare(\n+        String deletedShareName, String deletedShareVersion) {\n+        return this.undeleteShareWithResponse(deletedShareName, deletedShareVersion).flatMap(FluxUtil::toMono);\n+    }\n+\n+    /**\n+     * Restores a previously deleted share.\n+     * <p>\n+     * If the share associated with provided <code>deletedShareName</code>\n+     * already exists, this call will result in a 409 (conflict).\n+     * </p>\n+     * <p>\n+     * This API is only functional if Share Soft Delete is enabled\n+     * for the storage account associated with the share.\n+     * For more information, see the\n+     * <a href=\"TBD\">Azure Docs</a>.\n+     * </p>\n+     *\n+     * <p><strong>Code Samples</strong></p>\n+     *\n+     * {@codesnippet com.azure.storage.file.share.ShareServiceAsyncClient.undeleteShareWithResponse#String-String}\n+     *\n+     * @param deletedShareName The name of the previously deleted share.\n+     * @param deletedShareVersion The version of the previously deleted share.\n+     * @return A {@link Mono} containing a {@link Response} whose {@link Response#getValue() value} contains a {@link\n+     * ShareAsyncClient} used to interact with the restored share.\n+     */\n+    // TODO (kasobol-msft) add link to REST API docs\n+    public Mono<Response<ShareAsyncClient>> undeleteShareWithResponse(\n+        String deletedShareName, String deletedShareVersion) {\n+        try {\n+            return withContext(context ->\n+                undeleteShareWithResponse(\n+                    deletedShareName, deletedShareVersion, context));\n+        } catch (RuntimeException ex) {\n+            return monoError(logger, ex);\n+        }\n+    }\n+\n+    Mono<Response<ShareAsyncClient>> undeleteShareWithResponse(\n+        String deletedShareName, String deletedShareVersion, Context context) {", "originalCommit": "05678851176f1ad102e3a82ad77e045675d882a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU1MDI4Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11101#discussion_r425550287", "bodyText": "Yeah they do. However, for shares, that option won't be in stg73 but later.", "author": "kasobol-msft", "createdAt": "2020-05-15T03:46:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ5NDcxMQ=="}], "type": "inlineReview"}]}