{"pr_number": 14155, "pr_title": "Performance: Cache AccountConsitencylevel and maxReplicaSetSize", "pr_createdAt": "2020-08-15T06:35:34Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/14155", "timeline": [{"oid": "bbf5e858119edff5aacf4a186fd529252cf1d7b3", "url": "https://github.com/Azure/azure-sdk-for-java/commit/bbf5e858119edff5aacf4a186fd529252cf1d7b3", "message": "Performance: Cache AccountConsitencylevel and maxReplicaSetSize\n\nPer request access to ConsistencyLevel and MaxReplicasize matierized from JSON\n\nFrom CPU profiles shown below:\n\tConnectionPolicy.getDefaultConsistencyLevel(0.5%)\n\tgetMaxReplicaSetSize(0.13%)", "committedDate": "2020-08-15T06:34:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU5MzU2MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14155#discussion_r471593561", "bodyText": "in the other places we don't call this \"cached\" to be consistency please rename to consistencyLevel\nplease see DocumentCollection as example.", "author": "moderakh", "createdAt": "2020-08-17T16:23:39Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/ConsistencyPolicy.java", "diffHunk": "@@ -129,4 +135,10 @@ public ConsistencyPolicy setMaxStalenessInterval(Duration maxStalenessInterval)\n         super.set(Constants.Properties.MAX_STALENESS_INTERVAL_IN_SECONDS, maxStalenessInterval.getSeconds());\n         return this;\n     }\n+\n+    /**\n+     * Assumption: all consistency mutations are through setDefaultConsistencyLevel only.\n+     * NOTE: If the underlying ObjectNode is mutated cache might be stale\n+     */\n+    private ConsistencyLevel cachedConsistencyLevel = null;", "originalCommit": "bbf5e858119edff5aacf4a186fd529252cf1d7b3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU5NTA4NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14155#discussion_r471595085", "bodyText": "please use the following instead:\nConsistencyLevel.fromServiceSerializedFormat(.)\nif the method is not accessible from this package use:\nBridgeInternal.fromServiceSerializedFormat()", "author": "moderakh", "createdAt": "2020-08-17T16:26:09Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/ConsistencyPolicy.java", "diffHunk": "@@ -52,16 +52,21 @@ public ConsistencyPolicy(String jsonString) {\n      */\n     public ConsistencyLevel getDefaultConsistencyLevel() {\n \n-        ConsistencyLevel result = ConsistencyPolicy.DEFAULT_DEFAULT_CONSISTENCY_LEVEL;\n-        String consistencyLevelString = super.getString(Constants.Properties.DEFAULT_CONSISTENCY_LEVEL);\n-        try {\n-            result = ConsistencyLevel\n-                         .valueOf(CaseFormat.UPPER_CAMEL.to(CaseFormat.UPPER_UNDERSCORE, consistencyLevelString));\n-        } catch (IllegalArgumentException e) {\n-            // ignore the exception and return the default\n-            this.getLogger().warn(\"Unknown consistency level {}, value ignored.\", consistencyLevelString);\n+        if (this.cachedConsistencyLevel == null) {\n+            ConsistencyLevel result = ConsistencyPolicy.DEFAULT_DEFAULT_CONSISTENCY_LEVEL;\n+            String consistencyLevelString = super.getString(Constants.Properties.DEFAULT_CONSISTENCY_LEVEL);\n+            try {\n+                result = ConsistencyLevel\n+                    .valueOf(CaseFormat.UPPER_CAMEL.to(CaseFormat.UPPER_UNDERSCORE, consistencyLevelString));", "originalCommit": "bbf5e858119edff5aacf4a186fd529252cf1d7b3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f0adcc7235bcdad4ce23b1806f5d7d6bf437b6fc", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f0adcc7235bcdad4ce23b1806f5d7d6bf437b6fc", "message": "Merge branch 'master' into users/kirankk/few_misc_perf_fixes", "committedDate": "2020-08-17T18:52:56Z", "type": "commit"}, {"oid": "d742bf0231c616196b412d7b3cf954461637405b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d742bf0231c616196b412d7b3cf954461637405b", "message": "Incorporating the comments feedback", "committedDate": "2020-08-17T18:57:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcxMjk3NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14155#discussion_r471712975", "bodyText": "you don't need ConsistencyLeve.valueOf() here.", "author": "moderakh", "createdAt": "2020-08-17T18:58:12Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/ConsistencyPolicy.java", "diffHunk": "@@ -52,21 +53,21 @@ public ConsistencyPolicy(String jsonString) {\n      */\n     public ConsistencyLevel getDefaultConsistencyLevel() {\n \n-        if (this.cachedConsistencyLevel == null) {\n+        if (this.consistencyLevel == null) {\n             ConsistencyLevel result = ConsistencyPolicy.DEFAULT_DEFAULT_CONSISTENCY_LEVEL;\n             String consistencyLevelString = super.getString(Constants.Properties.DEFAULT_CONSISTENCY_LEVEL);\n             try {\n                 result = ConsistencyLevel\n-                    .valueOf(CaseFormat.UPPER_CAMEL.to(CaseFormat.UPPER_UNDERSCORE, consistencyLevelString));\n+                    .valueOf(BridgeInternal.fromServiceSerializedFormat(consistencyLevelString));", "originalCommit": "d742bf0231c616196b412d7b3cf954461637405b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcxMzI1Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14155#discussion_r471713257", "bodyText": "please change to\nresult = BridgeInternal.fromServiceSerializedFormat(consistencyLevelString)", "author": "moderakh", "createdAt": "2020-08-17T18:58:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcxMjk3NQ=="}], "type": "inlineReview"}, {"oid": "d65c07f191f2b293a5eb1f569fc289eb6e790c5c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d65c07f191f2b293a5eb1f569fc289eb6e790c5c", "message": "Fixing the bugs", "committedDate": "2020-08-17T21:17:22Z", "type": "commit"}]}