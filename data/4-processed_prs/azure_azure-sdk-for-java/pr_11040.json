{"pr_number": 11040, "pr_title": "Migrate Search Live Testing to Use a Single Service Instance", "pr_createdAt": "2020-05-11T21:33:40Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/11040", "timeline": [{"oid": "c3b0fe0afe3e91e75154cb3b55583f5f2969ea46", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c3b0fe0afe3e91e75154cb3b55583f5f2969ea46", "message": "Update Search tests to use single resource", "committedDate": "2020-05-07T19:40:36Z", "type": "commit"}, {"oid": "766e780a85b0854b559f8ca2ea8a2ca47a626a44", "url": "https://github.com/Azure/azure-sdk-for-java/commit/766e780a85b0854b559f8ca2ea8a2ca47a626a44", "message": "Update some test code, add container creation to template", "committedDate": "2020-05-07T21:40:53Z", "type": "commit"}, {"oid": "67e702cb1f3d249d380c02ce3c8cc889dd7dcb37", "url": "https://github.com/Azure/azure-sdk-for-java/commit/67e702cb1f3d249d380c02ce3c8cc889dd7dcb37", "message": "Merge branch 'master' into AzSearch_UseSingleSearchServiceInTests", "committedDate": "2020-05-07T21:47:53Z", "type": "commit"}, {"oid": "f53ede972c27e08be9051d4a299f3063d46da486", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f53ede972c27e08be9051d4a299f3063d46da486", "message": "Updated some tests to cleanup after their run", "committedDate": "2020-05-08T17:33:44Z", "type": "commit"}, {"oid": "076f028f578e1d1e4759c90747a6d40cf80ca44a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/076f028f578e1d1e4759c90747a6d40cf80ca44a", "message": "Update more tests to track and delete resources", "committedDate": "2020-05-08T20:14:38Z", "type": "commit"}, {"oid": "f5d84ca2bd3e7d498c04eefef9a18cd414b0a668", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f5d84ca2bd3e7d498c04eefef9a18cd414b0a668", "message": "More unit test updates", "committedDate": "2020-05-08T21:41:23Z", "type": "commit"}, {"oid": "702149bdfeba11ba40a4500f5ebc15cb8dc5e36c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/702149bdfeba11ba40a4500f5ebc15cb8dc5e36c", "message": "Moving some testing code, fixed deletion of wrong resource type", "committedDate": "2020-05-08T22:55:44Z", "type": "commit"}, {"oid": "559def2633486f13a732d5f41f4c199742ed1687", "url": "https://github.com/Azure/azure-sdk-for-java/commit/559def2633486f13a732d5f41f4c199742ed1687", "message": "Merge branch 'master' into AzSearch_UseSingleSearchServiceInTests", "committedDate": "2020-05-08T23:09:19Z", "type": "commit"}, {"oid": "62a917810b6a5995a4a66dac162841efd2c68dc5", "url": "https://github.com/Azure/azure-sdk-for-java/commit/62a917810b6a5995a4a66dac162841efd2c68dc5", "message": "Fixing failing tests", "committedDate": "2020-05-09T01:57:23Z", "type": "commit"}, {"oid": "17a1dc02edde4fad8982aa938f431d9ee37fb6d3", "url": "https://github.com/Azure/azure-sdk-for-java/commit/17a1dc02edde4fad8982aa938f431d9ee37fb6d3", "message": "Merge branch 'master' into AzSearch_UseSingleSearchServiceInTests", "committedDate": "2020-05-11T16:14:45Z", "type": "commit"}, {"oid": "fa0e637fe01c92b15e42334c8f0fd4b9d31b44fe", "url": "https://github.com/Azure/azure-sdk-for-java/commit/fa0e637fe01c92b15e42334c8f0fd4b9d31b44fe", "message": "Finish updating tests and re-recording playback records", "committedDate": "2020-05-11T19:03:13Z", "type": "commit"}, {"oid": "93099997cc02ac17155338f82fe761bfbc4768f6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/93099997cc02ac17155338f82fe761bfbc4768f6", "message": "Merge branch 'master' into AzSearch_UseSingleSearchServiceInTests", "committedDate": "2020-05-11T20:15:34Z", "type": "commit"}, {"oid": "2b3d058521612d7fe2b573b27bd0ea22b99e37c3", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2b3d058521612d7fe2b573b27bd0ea22b99e37c3", "message": "Fix linting issue, re-record a few failing tests", "committedDate": "2020-05-11T20:24:25Z", "type": "commit"}, {"oid": "4b261e6db3f78371be66495406cdf192b673a551", "url": "https://github.com/Azure/azure-sdk-for-java/commit/4b261e6db3f78371be66495406cdf192b673a551", "message": "Update a few tests", "committedDate": "2020-05-11T20:50:00Z", "type": "commit"}, {"oid": "4b498c01e1b5bfe615007f04d775929ddcda889e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/4b498c01e1b5bfe615007f04d775929ddcda889e", "message": "Merge branch 'master' into AzSearch_UsingSingleSearchServiceInTests", "committedDate": "2020-05-12T16:15:09Z", "type": "commit"}, {"oid": "1862fd0fec9d8c535f13feede3e65fad4506fa3c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1862fd0fec9d8c535f13feede3e65fad4506fa3c", "message": "Add missing ')'", "committedDate": "2020-05-12T16:27:20Z", "type": "commit"}, {"oid": "4896ea6ba69c7441a9c120fb2e50497cfd3241cd", "url": "https://github.com/Azure/azure-sdk-for-java/commit/4896ea6ba69c7441a9c120fb2e50497cfd3241cd", "message": "Fix variable name", "committedDate": "2020-05-12T16:34:45Z", "type": "commit"}, {"oid": "91110973e06fbab1996ac6d96e416cb9ff631544", "url": "https://github.com/Azure/azure-sdk-for-java/commit/91110973e06fbab1996ac6d96e416cb9ff631544", "message": "Fix deployment template", "committedDate": "2020-05-12T18:56:02Z", "type": "commit"}, {"oid": "21c892dac221dfbcec97c170c11bca344f516e65", "url": "https://github.com/Azure/azure-sdk-for-java/commit/21c892dac221dfbcec97c170c11bca344f516e65", "message": "Set parallel job limit to 2", "committedDate": "2020-05-12T19:11:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAwODA5Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11040#discussion_r424008092", "bodyText": "There is an ongoing effort to change these to NOT preface with \"AZURE_\", and just \"SEARCH_...\". If that is too big a change, though, probably don't worry about it here.", "author": "heaths", "createdAt": "2020-05-12T20:18:26Z", "path": "sdk/search/test-resources.json", "diffHunk": "@@ -1,8 +1,111 @@\n {\n-    \"$schema\": \"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#\",\n-    \"contentVersion\": \"1.0.0.0\",\n-    \"parameters\": {},\n-    \"variables\": {},\n-    \"resources\": [],\n-    \"outputs\": {}\n+  \"$schema\": \"https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#\",\n+  \"contentVersion\": \"1.0.0.0\",\n+  \"parameters\": {\n+      \"baseName\": {\n+          \"type\": \"string\",\n+          \"defaultValue\": \"[resourceGroup().name]\",\n+          \"metadata\": {\n+              \"description\": \"The base resource name.\"\n+          }\n+      },\n+      \"location\": {\n+          \"type\": \"string\",\n+          \"defaultValue\": \"[resourceGroup().location]\",\n+          \"metadata\": {\n+              \"description\": \"The location of the resource. By default, this is the same as the resource group.\"\n+          }\n+      },\n+      \"searchSku\": {\n+          \"type\": \"string\",\n+          \"defaultValue\": \"basic\",\n+          \"allowedValues\": [\n+              \"free\",\n+              \"basic\",\n+              \"standard\"\n+          ],\n+          \"metadata\": {\n+              \"description\": \"The Search service SKU to create.\"\n+          }\n+      }\n+  },\n+  \"variables\": {\n+      \"searchServiceName\": \"[concat('azs-java-', parameters('baseName'))]\",\n+      \"searchApiVersion\": \"2020-03-13\",\n+      \"storageAccountName\": \"[concat('azsstg', parameters('baseName'))]\",\n+      \"storageContainerName\": \"[concat('azscontainer', parameters('baseName'))]\",\n+      \"storageApiVersion\": \"2019-06-01\"\n+  },\n+  \"resources\": [\n+      {\n+          \"name\": \"[variables('searchServiceName')]\",\n+          \"type\": \"Microsoft.Search/searchServices\",\n+          \"apiVersion\": \"[variables('searchApiVersion')]\",\n+          \"location\": \"[parameters('location')]\",\n+          \"sku\": {\n+              \"name\": \"[parameters('searchSku')]\"\n+          },\n+          \"properties\": {\n+              \"replicaCount\": 1,\n+              \"partitionCount\": 1,\n+              \"hostingMode\": \"default\",\n+              \"publicNetworkAccess\": \"Enabled\",\n+              \"networkRuleSet\": {\n+                  \"ipRules\": []\n+              }\n+          }\n+      },\n+      {\n+          \"name\": \"[variables('storageAccountName')]\",\n+          \"type\": \"Microsoft.Storage/storageAccounts\",\n+          \"apiVersion\": \"[variables('storageApiVersion')]\",\n+          \"location\": \"[parameters('location')]\",\n+          \"properties\": {\n+              \"accessTier\": \"Hot\",\n+              \"supportsHttpsTrafficOnly\": true\n+          },\n+          \"sku\": {\n+              \"name\": \"Standard_LRS\",\n+              \"tier\": \"Standard\"\n+          },\n+          \"kind\": \"StorageV2\",\n+          \"resources\": [\n+            {\n+              \"type\": \"blobServices/containers\",\n+              \"name\": \"[concat('default/', variables('storageContainerName'))]\",\n+              \"apiVersion\": \"[variables('storageApiVersion')]\",\n+              \"properties\": {},\n+              \"dependsOn\": [\n+                \"[variables('storageAccountName')]\"\n+              ]\n+            }\n+          ]\n+      }\n+  ],\n+  \"outputs\": {\n+      \"AZURE_SEARCH_SERVICE_ENDPOINT\": {", "originalCommit": "21c892dac221dfbcec97c170c11bca344f516e65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA0NDA0MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11040#discussion_r424044041", "bodyText": "Easy change, will make it in the next commit.", "author": "alzimmermsft", "createdAt": "2020-05-12T21:27:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAwODA5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAxMjYyMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11040#discussion_r424012620", "bodyText": "Guidance from the Engineering team is not include hardcoded endpoint suffixes but keep them configurable esp for storage since they do not resolve correctly in Azure public clouds.\nMore info - #10380 (comment)", "author": "samvaity", "createdAt": "2020-05-12T20:27:00Z", "path": "sdk/search/test-resources.json", "diffHunk": "@@ -1,8 +1,111 @@\n {\n-    \"$schema\": \"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#\",\n-    \"contentVersion\": \"1.0.0.0\",\n-    \"parameters\": {},\n-    \"variables\": {},\n-    \"resources\": [],\n-    \"outputs\": {}\n+  \"$schema\": \"https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#\",\n+  \"contentVersion\": \"1.0.0.0\",\n+  \"parameters\": {\n+      \"baseName\": {\n+          \"type\": \"string\",\n+          \"defaultValue\": \"[resourceGroup().name]\",\n+          \"metadata\": {\n+              \"description\": \"The base resource name.\"\n+          }\n+      },\n+      \"location\": {\n+          \"type\": \"string\",\n+          \"defaultValue\": \"[resourceGroup().location]\",\n+          \"metadata\": {\n+              \"description\": \"The location of the resource. By default, this is the same as the resource group.\"\n+          }\n+      },\n+      \"searchSku\": {\n+          \"type\": \"string\",\n+          \"defaultValue\": \"basic\",\n+          \"allowedValues\": [\n+              \"free\",\n+              \"basic\",\n+              \"standard\"\n+          ],\n+          \"metadata\": {\n+              \"description\": \"The Search service SKU to create.\"\n+          }\n+      }\n+  },\n+  \"variables\": {\n+      \"searchServiceName\": \"[concat('azs-java-', parameters('baseName'))]\",\n+      \"searchApiVersion\": \"2020-03-13\",\n+      \"storageAccountName\": \"[concat('azsstg', parameters('baseName'))]\",\n+      \"storageContainerName\": \"[concat('azscontainer', parameters('baseName'))]\",\n+      \"storageApiVersion\": \"2019-06-01\"\n+  },\n+  \"resources\": [\n+      {\n+          \"name\": \"[variables('searchServiceName')]\",\n+          \"type\": \"Microsoft.Search/searchServices\",\n+          \"apiVersion\": \"[variables('searchApiVersion')]\",\n+          \"location\": \"[parameters('location')]\",\n+          \"sku\": {\n+              \"name\": \"[parameters('searchSku')]\"\n+          },\n+          \"properties\": {\n+              \"replicaCount\": 1,\n+              \"partitionCount\": 1,\n+              \"hostingMode\": \"default\",\n+              \"publicNetworkAccess\": \"Enabled\",\n+              \"networkRuleSet\": {\n+                  \"ipRules\": []\n+              }\n+          }\n+      },\n+      {\n+          \"name\": \"[variables('storageAccountName')]\",\n+          \"type\": \"Microsoft.Storage/storageAccounts\",\n+          \"apiVersion\": \"[variables('storageApiVersion')]\",\n+          \"location\": \"[parameters('location')]\",\n+          \"properties\": {\n+              \"accessTier\": \"Hot\",\n+              \"supportsHttpsTrafficOnly\": true\n+          },\n+          \"sku\": {\n+              \"name\": \"Standard_LRS\",\n+              \"tier\": \"Standard\"\n+          },\n+          \"kind\": \"StorageV2\",\n+          \"resources\": [\n+            {\n+              \"type\": \"blobServices/containers\",\n+              \"name\": \"[concat('default/', variables('storageContainerName'))]\",\n+              \"apiVersion\": \"[variables('storageApiVersion')]\",\n+              \"properties\": {},\n+              \"dependsOn\": [\n+                \"[variables('storageAccountName')]\"\n+              ]\n+            }\n+          ]\n+      }\n+  ],\n+  \"outputs\": {\n+      \"AZURE_SEARCH_SERVICE_ENDPOINT\": {\n+          \"type\": \"string\",\n+          \"value\": \"[concat('https://', variables('searchServiceName'), '.search.windows.net')]\"\n+      },\n+      \"AZURE_SEARCH_SERVICE_API_KEY\": {\n+          \"type\": \"string\",\n+          \"value\": \"[listAdminKeys(variables('searchServiceName'), variables('searchApiVersion')).primaryKey]\"\n+      },\n+      \"AZURE_SEARCH_QUERY_API_KEY\": {\n+          \"type\": \"string\",\n+          \"value\": \"[listQueryKeys(variables('searchServiceName'), variables('searchApiVersion')).value[0].key]\"\n+      },\n+      \"AZURE_SEARCH_STORAGE_NAME\": {\n+          \"type\": \"string\",\n+          \"value\": \"[variables('storageAccountName')]\"\n+      },\n+      \"AZURE_SEARCH_STORAGE_CONNECTION_STRING\": {\n+        \"type\": \"string\",\n+        \"value\": \"[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(variables('storageAccountName'), variables('storageApiVersion')).keys[0].value, ';EndpointSuffix=core.windows.net')]\"", "originalCommit": "21c892dac221dfbcec97c170c11bca344f516e65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA0NDE3MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11040#discussion_r424044171", "bodyText": "Will be added in the next commit.", "author": "alzimmermsft", "createdAt": "2020-05-12T21:28:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAxMjYyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAxMzAxMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11040#discussion_r424013013", "bodyText": "Can these variables be deleted now that we have the test-resources.json file?", "author": "samvaity", "createdAt": "2020-05-12T20:27:43Z", "path": "sdk/search/tests.yml", "diffHunk": "@@ -5,6 +5,7 @@ jobs:\n     parameters:\n       ServiceDirectory: search\n       Timeout: 120\n+      MaxParallel: 2\n       EnvVars:\n         AZURE_TEST_MODE: LIVE\n         AZURE_TENANT_ID: $(aad-azure-sdk-test-tenant-id)", "originalCommit": "21c892dac221dfbcec97c170c11bca344f516e65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA0NTM1OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11040#discussion_r424045358", "bodyText": "Deleted, Search doesn't use them in testing anyways.", "author": "alzimmermsft", "createdAt": "2020-05-12T21:30:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAxMzAxMw=="}], "type": "inlineReview"}, {"oid": "62e0385aaae72df57a4636e1a675e0e397bbb723", "url": "https://github.com/Azure/azure-sdk-for-java/commit/62e0385aaae72df57a4636e1a675e0e397bbb723", "message": "Merge branch 'master' into AzSearch_UsingSingleSearchServiceInTests", "committedDate": "2020-05-12T21:21:34Z", "type": "commit"}, {"oid": "db1b82af137cf126c17bb5f3c767c544cceb112e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/db1b82af137cf126c17bb5f3c767c544cceb112e", "message": "Updates based on reviews", "committedDate": "2020-05-12T21:30:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA0OTAyOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11040#discussion_r424049028", "bodyText": "storage end point \ud83e\udd14", "author": "samvaity", "createdAt": "2020-05-12T21:39:01Z", "path": "sdk/search/test-resources.json", "diffHunk": "@@ -1,8 +1,121 @@\n {\n-    \"$schema\": \"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#\",\n-    \"contentVersion\": \"1.0.0.0\",\n-    \"parameters\": {},\n-    \"variables\": {},\n-    \"resources\": [],\n-    \"outputs\": {}\n+  \"$schema\": \"https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#\",\n+  \"contentVersion\": \"1.0.0.0\",\n+  \"parameters\": {\n+    \"baseName\": {\n+      \"type\": \"string\",\n+      \"defaultValue\": \"[resourceGroup().name]\",\n+      \"metadata\": {\n+        \"description\": \"The base resource name.\"\n+      }\n+    },\n+    \"searchEndpointSuffix\": {\n+      \"type\": \"string\",\n+      \"defaultValue\": \"search.windows.net\",\n+      \"metadata\": {\n+        \"description\": \"The Search service endpoint suffix.\"\n+      }\n+    },\n+    \"storageEndpointSuffix\": {\n+      \"type\": \"string\",\n+      \"defaultValue\": \"search.windows.net\",", "originalCommit": "db1b82af137cf126c17bb5f3c767c544cceb112e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA1Mzg1OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11040#discussion_r424053858", "bodyText": "This still doesn't resolve the issue of making the storage endpoint value itself to changed/configurable when the tests are running in any other Azure cloud. But for now, we can add a separate issue to track this.\ncc: @danieljurek", "author": "samvaity", "createdAt": "2020-05-12T21:49:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA0OTAyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA1NTIyNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11040#discussion_r424055226", "bodyText": "This is what I get for copy and pasting.", "author": "alzimmermsft", "createdAt": "2020-05-12T21:52:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA0OTAyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA2NzcxMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11040#discussion_r424067711", "bodyText": "Let's file an issue for this as this affects more than just Search.", "author": "alzimmermsft", "createdAt": "2020-05-12T22:22:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA0OTAyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE3NDc1Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11040#discussion_r424174753", "bodyText": "This looks OK to me. A default value here is fine and I can pass overrides in at the matrix-level when we're testing against other clouds.", "author": "danieljurek", "createdAt": "2020-05-13T05:06:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA0OTAyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA0ODY3OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11040#discussion_r424048678", "bodyText": "Is it better to clean up the indexesToCleanup after test or re-initiate before run?", "author": "sima-zhu", "createdAt": "2020-05-12T21:38:16Z", "path": "sdk/search/azure-search-documents/src/test/java/com/azure/search/documents/CustomAnalyzerSyncTests.java", "diffHunk": "@@ -79,33 +82,32 @@\n import java.util.List;\n import java.util.concurrent.atomic.AtomicInteger;\n import java.util.stream.Collectors;\n-import org.junit.jupiter.api.Assertions;\n-import org.junit.jupiter.api.Test;\n \n+import static com.azure.search.documents.TestHelpers.assertHttpResponseException;\n import static com.azure.search.documents.TestHelpers.assertObjectEquals;\n+import static com.azure.search.documents.TestHelpers.generateRequestOptions;\n+import static com.azure.search.documents.TestHelpers.waitForIndexing;\n import static org.junit.jupiter.api.Assertions.assertEquals;\n import static org.junit.jupiter.api.Assertions.assertFalse;\n \n-public class CustomAnalyzerSyncTests extends SearchServiceTestBase {\n+public class CustomAnalyzerSyncTests extends SearchTestBase {\n     private static final String NAME_PREFIX = \"azsmnet\";\n+    private static final Collection<CharFilterName> CHAR_FILTER_NAMES = new ArrayList<>(CharFilterName.values());\n \n     private SearchServiceClient searchServiceClient;\n-    private static Collection<CharFilterName> charFilterNames;\n-\n-    static {\n-        getAllCharFilterName();\n-    }\n+    private final List<String> indexesToCleanup = new ArrayList<>();\n \n     @Override\n     protected void beforeTest() {\n         super.beforeTest();\n         searchServiceClient = getSearchServiceClientBuilder().buildClient();\n     }\n \n-    private static void getAllCharFilterName() {\n-        charFilterNames = new ArrayList<>();\n-        for (CharFilterName name : CharFilterName.values()) {\n-            charFilterNames.add(name);\n+    @Override\n+    protected void afterTest() {\n+        super.afterTest();\n+        for (String index : indexesToCleanup) {", "originalCommit": "db1b82af137cf126c17bb5f3c767c544cceb112e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA1Nzc2NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11040#discussion_r424057764", "bodyText": "I think it would be better to cleanup after the test, this makes it so the test itself maintains all the logic it uses.", "author": "alzimmermsft", "createdAt": "2020-05-12T21:57:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA0ODY3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA0OTU1Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11040#discussion_r424049552", "bodyText": "Same here.\nI have concern which the list has more sources than expected and throw no resource error.", "author": "sima-zhu", "createdAt": "2020-05-12T21:40:05Z", "path": "sdk/search/azure-search-documents/src/test/java/com/azure/search/documents/DataSourceSyncTests.java", "diffHunk": "@@ -6,65 +6,57 @@\n import com.azure.core.exception.HttpResponseException;\n import com.azure.core.http.rest.Response;\n import com.azure.core.util.Context;\n+import com.azure.core.util.CoreUtils;\n import com.azure.search.documents.models.DataContainer;\n import com.azure.search.documents.models.DataDeletionDetectionPolicy;\n import com.azure.search.documents.models.DataSource;\n import com.azure.search.documents.models.DataSourceCredentials;\n import com.azure.search.documents.models.DataSourceType;\n import com.azure.search.documents.models.HighWaterMarkChangeDetectionPolicy;\n import com.azure.search.documents.models.RequestOptions;\n+import com.azure.search.documents.models.SearchErrorException;\n import com.azure.search.documents.models.SoftDeleteColumnDeletionDetectionPolicy;\n import com.azure.search.documents.models.SqlIntegratedChangeTrackingPolicy;\n-import com.azure.search.documents.test.AccessConditionTests;\n-import com.azure.search.documents.test.AccessOptions;\n-import io.netty.handler.codec.http.HttpResponseStatus;\n import org.junit.jupiter.api.Test;\n \n import java.net.HttpURLConnection;\n+import java.util.ArrayList;\n import java.util.Iterator;\n-import java.util.function.BiConsumer;\n-import java.util.function.BiFunction;\n-import java.util.function.Function;\n-import java.util.function.Supplier;\n+import java.util.List;\n \n+import static com.azure.search.documents.TestHelpers.BLOB_DATASOURCE_TEST_NAME;\n+import static com.azure.search.documents.TestHelpers.assertHttpResponseException;\n+import static com.azure.search.documents.TestHelpers.generateRequestOptions;\n import static org.junit.jupiter.api.Assertions.assertEquals;\n import static org.junit.jupiter.api.Assertions.assertFalse;\n+import static org.junit.jupiter.api.Assertions.assertNotEquals;\n import static org.junit.jupiter.api.Assertions.assertNotNull;\n import static org.junit.jupiter.api.Assertions.assertThrows;\n+import static org.junit.jupiter.api.Assertions.fail;\n \n-public class DataSourceSyncTests extends SearchServiceTestBase {\n+public class DataSourceSyncTests extends SearchTestBase {\n     private static final String FAKE_DESCRIPTION = \"Some data source\";\n     private static final String FAKE_STORAGE_CONNECTION_STRING =\n         \"DefaultEndpointsProtocol=https;AccountName=NotaRealAccount;AccountKey=fake;\";\n     private static final String FAKE_COSMOS_CONNECTION_STRING =\n         \"AccountEndpoint=https://NotaRealAccount.documents.azure.com;AccountKey=fake;Database=someFakeDatabase\";\n \n+    private final List<String> dataSourcesToDelete = new ArrayList<>();\n     private SearchServiceClient client;\n \n-    // commonly used lambda definitions\n-    private BiFunction<DataSource, AccessOptions, DataSource> createOrUpdateDataSourceFunc =\n-        (DataSource ds, AccessOptions ac) ->\n-            createOrUpdateDataSource(ds, ac.getOnlyIfUnchanged(), ac.getRequestOptions());\n-\n-    private Supplier<DataSource> newDataSourceFunc = () -> createTestBlobDataSource(null);\n-\n-    private Function<DataSource, DataSource> mutateDataSourceFunc = (DataSource ds) -> \n-        ds.setDescription(\"somethingnew\");\n-\n-    private BiConsumer<DataSource, AccessOptions> deleteDataSourceFunc = (DataSource dataSource, AccessOptions ac) ->\n-        client.deleteDataSourceWithResponse(dataSource,\n-            ac.getOnlyIfUnchanged(), ac.getRequestOptions(), Context.NONE);\n-\n     @Override\n     protected void beforeTest() {\n         super.beforeTest();\n         client = getSearchServiceClientBuilder().buildClient();\n     }\n \n-    private DataSource createOrUpdateDataSource(DataSource datasource, Boolean onlyIfUnchanged,\n-        RequestOptions requestOptions) {\n-        return client.createOrUpdateDataSourceWithResponse(datasource, onlyIfUnchanged, requestOptions, Context.NONE)\n-            .getValue();\n+    @Override\n+    protected void afterTest() {\n+        super.afterTest();\n+        for (String dataSource : dataSourcesToDelete) {", "originalCommit": "db1b82af137cf126c17bb5f3c767c544cceb112e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA1ODYwOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11040#discussion_r424058609", "bodyText": "The concern is that this list would contain more data sources than still existing after the test? Luckily it appears 404 is a valid response type, so it won't throw an exception.", "author": "alzimmermsft", "createdAt": "2020-05-12T21:59:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA0OTU1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA0OTgxMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11040#discussion_r424049813", "bodyText": "Indentation.", "author": "sima-zhu", "createdAt": "2020-05-12T21:40:38Z", "path": "sdk/search/azure-search-documents/src/test/java/com/azure/search/documents/DataSourceSyncTests.java", "diffHunk": "@@ -112,7 +106,8 @@ public void deleteDataSourceIsIdempotent() {\n         DataSource dataSource = createTestBlobDataSource(null);\n \n         // Try to delete before the data source exists, expect a NOT FOUND return status code\n-        Response<Void> result = client.deleteDataSourceWithResponse(dataSource, false, generateRequestOptions(), Context.NONE);\n+        Response<Void> result = client.deleteDataSourceWithResponse(dataSource, false, generateRequestOptions(),\n+            Context.NONE);", "originalCommit": "db1b82af137cf126c17bb5f3c767c544cceb112e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA1NzY4MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11040#discussion_r424057681", "bodyText": "What's the reason of having maximum of 2?", "author": "sima-zhu", "createdAt": "2020-05-12T21:57:31Z", "path": "sdk/search/tests.yml", "diffHunk": "@@ -5,12 +5,9 @@ jobs:\n     parameters:\n       ServiceDirectory: search\n       Timeout: 120\n+      MaxParallel: 2", "originalCommit": "db1b82af137cf126c17bb5f3c767c544cceb112e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA1ODEwNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11040#discussion_r424058105", "bodyText": "Still have limitations on the total number of service we can be using concurrently.", "author": "alzimmermsft", "createdAt": "2020-05-12T21:58:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA1NzY4MQ=="}], "type": "inlineReview"}, {"oid": "dd63e804dd3e96e25b9c198a22207f1f4e13c633", "url": "https://github.com/Azure/azure-sdk-for-java/commit/dd63e804dd3e96e25b9c198a22207f1f4e13c633", "message": "Fix default Storage suffix, make azure-test-watcher a test dependency as it should be", "committedDate": "2020-05-12T22:17:23Z", "type": "commit"}, {"oid": "0d3ac3dd029d8e34d24f0b43de7a6bb63a901dd2", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0d3ac3dd029d8e34d24f0b43de7a6bb63a901dd2", "message": "Add missing '.' in Search service endpoint", "committedDate": "2020-05-12T22:19:20Z", "type": "commit"}, {"oid": "e8a3f9924c2c250328c1027696e5c00862524ce6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e8a3f9924c2c250328c1027696e5c00862524ce6", "message": "Use Free SKU instead of Basic", "committedDate": "2020-05-13T00:15:19Z", "type": "commit"}, {"oid": "5646988d397b17d4b14832d2c0826ec19967d613", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5646988d397b17d4b14832d2c0826ec19967d613", "message": "Update session record", "committedDate": "2020-05-13T00:16:07Z", "type": "commit"}]}