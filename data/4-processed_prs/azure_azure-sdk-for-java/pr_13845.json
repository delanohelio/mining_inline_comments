{"pr_number": 13845, "pr_title": "Granular Netty Write, Response, and Read Timeouts", "pr_createdAt": "2020-08-06T22:16:50Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/13845", "timeline": [{"oid": "873ad879f20dd883420fe73a4554571eecd1ea5d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/873ad879f20dd883420fe73a4554571eecd1ea5d", "message": "Granular write, response, and read timeouts using HttpClient's doOnRequest, doAfterRequest, and doOnResponse", "committedDate": "2020-08-06T22:07:43Z", "type": "commit"}, {"oid": "6863e34fbd4b953de0e045069c7feb32d95e8ddd", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6863e34fbd4b953de0e045069c7feb32d95e8ddd", "message": "Remove auto generated files", "committedDate": "2020-08-06T22:22:51Z", "type": "commit"}, {"oid": "a5567a6fef8315530c22f6779e755933a4b7ad61", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a5567a6fef8315530c22f6779e755933a4b7ad61", "message": "Merge branch 'master' into AzNetty_DoOnTimeouts", "committedDate": "2020-08-06T23:24:34Z", "type": "commit"}, {"oid": "a13bbd86da56e602abaa382a3000805b2c8a7f88", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a13bbd86da56e602abaa382a3000805b2c8a7f88", "message": "Update test timeouts and expectations to be more flexible", "committedDate": "2020-08-06T23:30:19Z", "type": "commit"}, {"oid": "8240c7b67bc0f0c8982bf3b3d19aa5a94281ba2c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8240c7b67bc0f0c8982bf3b3d19aa5a94281ba2c", "message": "Increase timeout tests sleep period to ensure event loop can trigger event", "committedDate": "2020-08-07T00:53:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODEwMjQ2MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13845#discussion_r468102461", "bodyText": "It might be good to set the defaults in the build() method of the builder as that's usually where we set all the defaults and when it's changed we'll remember to update the builder javadocs too.", "author": "srnagar", "createdAt": "2020-08-10T18:39:12Z", "path": "sdk/core/azure-core-http-netty/src/main/java/com/azure/core/http/netty/implementation/ImplUtils.java", "diffHunk": "@@ -0,0 +1,43 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.http.netty.implementation;\n+\n+import java.time.Duration;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Helper class containing utility methods for the implementation package.\n+ */\n+final class ImplUtils {\n+    private static final long MINIMUM_TIMEOUT = TimeUnit.MILLISECONDS.toMillis(1);\n+\n+    /*\n+     * Helper function to convert the timeout duration into MILLISECONDS. If the duration is null, 0, or negative there\n+     * is no timeout period, so return 0. Otherwise, return the maximum of the duration and the minimum timeout period.\n+     */\n+\n+    /**\n+     * Returns the timeout in milliseconds to use based on the passed {@link Duration}.\n+     * <p>\n+     * If the timeout is {@code null} a default of 60 seconds will be used. If the timeout is less than or equal to zero\n+     * no timeout will be used. If the timeout is less than one millisecond a timeout of one millisecond will be used.\n+     *\n+     * @param timeout The {@link Duration} to convert to timeout in milliseconds.\n+     * @return The timeout period in milliseconds, zero if no timeout.\n+     */\n+    static long getTimeoutMillis(Duration timeout) {\n+        // Timeout is null, use the 60 second default.\n+        if (timeout == null) {\n+            return TimeUnit.SECONDS.toMillis(60);\n+        }\n+\n+        // Timeout is less than or equal to zero, return no timeout.\n+        if (timeout.isZero() || timeout.isNegative()) {\n+            return 0;\n+        }\n+\n+        // Return the maximum of the timeout period and the minimum allowed timeout period.\n+        return Math.max(timeout.toMillis(), MINIMUM_TIMEOUT);", "originalCommit": "8240c7b67bc0f0c8982bf3b3d19aa5a94281ba2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODEwODk5MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13845#discussion_r468108990", "bodyText": "I can move this method into the builder and have it called during build.", "author": "alzimmermsft", "createdAt": "2020-08-10T18:51:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODEwMjQ2MQ=="}], "type": "inlineReview"}, {"oid": "336934947198d6cde945e29d495e78dba0a04635", "url": "https://github.com/Azure/azure-sdk-for-java/commit/336934947198d6cde945e29d495e78dba0a04635", "message": "Merge branch 'master' into AzNetty_DoOnTimeouts", "committedDate": "2020-08-10T19:09:37Z", "type": "commit"}, {"oid": "74d0e268299b0860e6cf0c0ca781262eceaa631b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/74d0e268299b0860e6cf0c0ca781262eceaa631b", "message": "Moved timeout conversion into builder, changed handlers to accept timeoutMillis instead of timeout Duration", "committedDate": "2020-08-10T19:16:02Z", "type": "commit"}, {"oid": "8c9943f16f850995f6535b61f168aa8f982c9587", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8c9943f16f850995f6535b61f168aa8f982c9587", "message": "Fixed tests after last changes", "committedDate": "2020-08-10T19:47:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI1MTA1MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13845#discussion_r468251051", "bodyText": "I think this is more flaky than you expected. We have two builds on one commit that failed this test:\nhttps://dev.azure.com/azure-sdk/public/_build/results?buildId=489952&view=logs&j=3d7a0212-45d0-5080-1981-6d6ef159b344&t=14d7dc25-187c-516a-cf22-fdfcecf8f884&l=580", "author": "jianghaolu", "createdAt": "2020-08-11T00:03:11Z", "path": "sdk/core/azure-core-http-netty/src/test/java/com/azure/core/http/netty/implementation/WriteTimeoutHandlerTests.java", "diffHunk": "@@ -0,0 +1,126 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.http.netty.implementation;\n+\n+import io.netty.channel.AbstractChannel;\n+import io.netty.channel.Channel;\n+import io.netty.channel.ChannelHandlerContext;\n+import io.netty.channel.ChannelPromise;\n+import io.netty.channel.DefaultChannelPromise;\n+import io.netty.util.concurrent.DefaultEventExecutor;\n+import io.netty.util.concurrent.EventExecutor;\n+import org.junit.jupiter.api.Test;\n+\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyLong;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.atLeast;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.never;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+import static org.mockito.internal.verification.VerificationModeFactory.times;\n+\n+/**\n+ * Tests {@link WriteTimeoutHandler}.\n+ */\n+public class WriteTimeoutHandlerTests {\n+    @Test\n+    public void noTimeoutDoesNotAddWatcher() {\n+        WriteTimeoutHandler writeTimeoutHandler = new WriteTimeoutHandler(0);\n+\n+        EventExecutor eventExecutor = mock(EventExecutor.class);\n+        when(eventExecutor.scheduleAtFixedRate(any(), anyLong(), anyLong(), any())).thenReturn(null);\n+\n+        ChannelHandlerContext ctx = mock(ChannelHandlerContext.class);\n+        when(ctx.executor()).thenReturn(eventExecutor);\n+\n+        writeTimeoutHandler.handlerAdded(ctx);\n+\n+        verify(eventExecutor, never()).scheduleAtFixedRate(any(), anyLong(), anyLong(), any());\n+    }\n+\n+    @Test\n+    public void timeoutAddsWatcher() {\n+        WriteTimeoutHandler writeTimeoutHandler = new WriteTimeoutHandler(1);\n+\n+        EventExecutor eventExecutor = mock(EventExecutor.class);\n+        when(eventExecutor.scheduleAtFixedRate(any(), eq(1L), eq(1L), any())).thenReturn(null);\n+\n+        ChannelHandlerContext ctx = mock(ChannelHandlerContext.class);\n+        when(ctx.executor()).thenReturn(eventExecutor);\n+\n+        writeTimeoutHandler.handlerAdded(ctx);\n+\n+        verify(eventExecutor, times(1)).scheduleAtFixedRate(any(), eq(1L), eq(1L), any());\n+    }\n+\n+    @Test\n+    public void removingHandlerCancelsTimeout() throws InterruptedException {\n+        WriteTimeoutHandler writeTimeoutHandler = new WriteTimeoutHandler(100);\n+\n+        ChannelHandlerContext ctx = mock(ChannelHandlerContext.class);\n+        when(ctx.executor()).thenReturn(new DefaultEventExecutor());\n+\n+        writeTimeoutHandler.handlerAdded(ctx);\n+        writeTimeoutHandler.handlerRemoved(ctx);\n+\n+        Thread.sleep(100);\n+\n+        verify(ctx, never()).fireExceptionCaught(any());\n+    }\n+\n+    @Test\n+    public void writeTimesOut() throws InterruptedException {", "originalCommit": "8c9943f16f850995f6535b61f168aa8f982c9587", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI1MTE3Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13845#discussion_r468251172", "bodyText": "Both are on Windows.", "author": "jianghaolu", "createdAt": "2020-08-11T00:03:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI1MTA1MQ=="}], "type": "inlineReview"}]}