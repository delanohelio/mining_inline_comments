{"pr_number": 15991, "pr_title": "ConnectionStateListener change", "pr_createdAt": "2020-10-06T16:29:47Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/15991", "timeline": [{"oid": "850e718a09967a02e7390688bcca08885c7a96c3", "url": "https://github.com/Azure/azure-sdk-for-java/commit/850e718a09967a02e7390688bcca08885c7a96c3", "message": "ConnectionStateListener change", "committedDate": "2020-10-06T15:30:43Z", "type": "commit"}, {"oid": "49b62d6ef3d36ed3b3e0a56d5366ef3ac7fe0a4a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/49b62d6ef3d36ed3b3e0a56d5366ef3ac7fe0a4a", "message": "clean", "committedDate": "2020-10-06T17:31:45Z", "type": "commit"}, {"oid": "c38d31c4ec7c5251cfabb9fb5f281c58b99baad8", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c38d31c4ec7c5251cfabb9fb5f281c58b99baad8", "message": "fix", "committedDate": "2020-10-06T18:27:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ4OTk0Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15991#discussion_r500489942", "bodyText": "We should mention this default value in the getter and setter", "author": "kushagraThapar", "createdAt": "2020-10-06T17:56:36Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/DirectConnectionConfig.java", "diffHunk": "@@ -32,6 +33,7 @@\n      * Constructor\n      */\n     public DirectConnectionConfig() {\n+        this.connectionEndpointRediscoveryEnabled = true;", "originalCommit": "49b62d6ef3d36ed3b3e0a56d5366ef3ac7fe0a4a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUzMDYzNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15991#discussion_r500530636", "bodyText": "added DEFAULT_CONNECTION_ENDPOINT_REDISCOVERY_ENABLED, and mentioned in the getter and setter method.", "author": "xinlian12", "createdAt": "2020-10-06T19:03:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ4OTk0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUxNzEyMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15991#discussion_r500517121", "bodyText": "Why are we removing this ?", "author": "kushagraThapar", "createdAt": "2020-10-06T18:39:57Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/RequestTimeline.java", "diffHunk": "@@ -157,13 +157,11 @@ public String toString() {\n         @JsonIgnore\n         private final Duration duration;\n \n-        @JsonSerialize(using = ToStringSerializer.class)\n-        private final long durationInMicroSec;", "originalCommit": "c38d31c4ec7c5251cfabb9fb5f281c58b99baad8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUyOTQzMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15991#discussion_r500529433", "bodyText": "\"It is reported, just not stored as a value\" (copied from the original PR).\nThis will not change the rntbd timeline diagnostics. After this change:\n\"serializationDiagnosticsContext\":{\"serializationDiagnosticsList\":[{\"serializationType\":\"ITEM_SERIALIZATION\",\"startTimeUTC\":\"22 Sep 2020 17:40:59.239\",\"endTimeUTC\":\"22 Sep 2020 17:40:59.239\",\"durationInMicroSec\":0},{\"serializationType\":\"PARTITION_KEY_FETCH_SERIALIZATION\",\"startTimeUTC\":\"22 Sep 2020 17:40:59.317\",\"endTimeUTC\":\"22 Sep 2020 17:40:59.323\",\"durationInMicroSec\":5998}]},\"gatewayStatistics\":null,\"systemInformation\":{\"usedMemory\":\"60586 KB\",\"availableMemory\":\"8309590 KB\",\"systemCpuLoad\":\"(2020-09-22T17:40:58.729927700Z 20.1%)\"}}", "author": "xinlian12", "createdAt": "2020-10-06T19:01:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUxNzEyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ2NzYzMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15991#discussion_r503467630", "bodyText": "This change has moved to PR #16197 to keep this PR clean.", "author": "xinlian12", "createdAt": "2020-10-12T18:33:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUxNzEyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUxOTkxOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15991#discussion_r500519919", "bodyText": "This header looks different from our other headers.", "author": "kushagraThapar", "createdAt": "2020-10-06T18:44:46Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdConnectionEvent.java", "diffHunk": "@@ -0,0 +1,10 @@\n+//------------------------------------------------------------", "originalCommit": "c38d31c4ec7c5251cfabb9fb5f281c58b99baad8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUzMDE5Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15991#discussion_r500530197", "bodyText": "Thanks, changed to be same as other files.", "author": "xinlian12", "createdAt": "2020-10-06T19:02:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUxOTkxOQ=="}], "type": "inlineReview"}, {"oid": "116d4c238dff9cdd6fb0456a4ad82fab5e5aa82a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/116d4c238dff9cdd6fb0456a4ad82fab5e5aa82a", "message": "resolve comments", "committedDate": "2020-10-06T19:02:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAyMzA1MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15991#discussion_r502023050", "bodyText": "rolling upgrade, replica, etc, are internal implementation details of the service.\nI wouldn't include the details in the public javadoc.\nhow about this:\nThe connection endpoint rediscovery feature is designed to reduce and spread-out latency spikes that may occur during maintenance operations.", "author": "moderakh", "createdAt": "2020-10-08T21:28:40Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/DirectConnectionConfig.java", "diffHunk": "@@ -40,6 +43,47 @@ public DirectConnectionConfig() {\n         this.requestTimeout = DEFAULT_REQUEST_TIMEOUT;\n     }\n \n+    /**\n+     * Gets a value indicating whether Direct TCP connection endpoint rediscovery is enabled.\n+     * <p>\n+     * The connection endpoint rediscovery feature is designed to reduce and spread-out latency spikes that are likely\n+     * to occur:\n+     * <ul>\n+     * <li>During rolling upgrades of a Cosmos instance or\n+     * <li>When a backend node is being decommissioned or restarted (e.g., to restart or remove an unhealthy replica.)", "originalCommit": "116d4c238dff9cdd6fb0456a4ad82fab5e5aa82a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ2NDM5OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15991#discussion_r503464399", "bodyText": "Thanks Mo, updated for both getter and setter method.", "author": "xinlian12", "createdAt": "2020-10-12T18:25:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAyMzA1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAyMzE2Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15991#discussion_r502023167", "bodyText": "ditto as above on the javadoc.", "author": "moderakh", "createdAt": "2020-10-08T21:28:55Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/DirectConnectionConfig.java", "diffHunk": "@@ -40,6 +43,47 @@ public DirectConnectionConfig() {\n         this.requestTimeout = DEFAULT_REQUEST_TIMEOUT;\n     }\n \n+    /**\n+     * Gets a value indicating whether Direct TCP connection endpoint rediscovery is enabled.\n+     * <p>\n+     * The connection endpoint rediscovery feature is designed to reduce and spread-out latency spikes that are likely\n+     * to occur:\n+     * <ul>\n+     * <li>During rolling upgrades of a Cosmos instance or\n+     * <li>When a backend node is being decommissioned or restarted (e.g., to restart or remove an unhealthy replica.)\n+     * </ul>\n+     *\n+     * By default, connection endpoint rediscovery is enabled.\n+     *\n+     * @return {@code true} if Direct TCP connection endpoint rediscovery is enabled; {@code false} otherwise.\n+     */\n+    public boolean isConnectionEndpointRediscoveryEnabled() {\n+        return this.connectionEndpointRediscoveryEnabled;\n+    }\n+\n+    /**\n+     * Sets a value indicating whether Direct TCP connection endpoint rediscovery should be enabled.\n+     * <p>\n+     * The connection endpoint rediscovery feature is designed to reduce and spread-out latency spikes that are likely\n+     * to occur:\n+     * <ul>\n+     * <li>During rolling upgrades of a Cosmos instance or\n+     * <li>When a backend node is being decommissioned or restarted (e.g., to restart or remove an unhealthy replica.)", "originalCommit": "116d4c238dff9cdd6fb0456a4ad82fab5e5aa82a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ2NDQ4Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15991#discussion_r503464482", "bodyText": "Updated.", "author": "xinlian12", "createdAt": "2020-10-12T18:26:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAyMzE2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAyOTYwMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15991#discussion_r502029601", "bodyText": "can we ever hit this?", "author": "moderakh", "createdAt": "2020-10-08T21:43:26Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/AddressResolver.java", "diffHunk": "@@ -62,6 +64,11 @@ public void initializeCaches(\n         this.collectionRoutingMapCache = collectionRoutingMapCache;\n     }\n \n+    @Override\n+    public void remove(RxDocumentServiceRequest request, Set<PartitionKeyRangeIdentity> partitionKeyRangeIdentitySet) {\n+        throw new NotImplementedException(\"remove() is not supported in AddressResolver\");", "originalCommit": "116d4c238dff9cdd6fb0456a4ad82fab5e5aa82a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ2NDkwMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15991#discussion_r503464903", "bodyText": "Rntbd use GlobalAddressResolver, so by theory, we should never hit it.\nBut since I add the remove() at the interface, so has to implement it.", "author": "xinlian12", "createdAt": "2020-10-12T18:27:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAyOTYwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzMTU4OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15991#discussion_r502031588", "bodyText": "please add this to diagnostics similar to this PR:\n#15738", "author": "moderakh", "createdAt": "2020-10-08T21:47:54Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RntbdTransportClient.java", "diffHunk": "@@ -300,6 +369,9 @@ private void throwIfClosed() {\n         @JsonProperty()\n         private final Duration connectionAcquisitionTimeout;\n \n+        @JsonProperty()\n+        private final boolean connectionEndpointRediscoveryEnabled;", "originalCommit": "116d4c238dff9cdd6fb0456a4ad82fab5e5aa82a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ2NDk0OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15991#discussion_r503464948", "bodyText": "Added.\nreturn Strings.lenientFormat(\"(cto:%s, rto:%s, icto:%s, ieto:%s, mcpe:%s, mrpc:%s, cere:%s)\",\nrntbdOptions.connectTimeout(),\nrntbdOptions.requestTimeout(),\nrntbdOptions.idleChannelTimeout(),\nrntbdOptions.idleEndpointTimeout(),\nrntbdOptions.maxChannelsPerEndpoint(),\nrntbdOptions.maxRequestsPerChannel(),\nrntbdOptions.isConnectionEndpointRediscoveryEnabled());", "author": "xinlian12", "createdAt": "2020-10-12T18:27:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzMTU4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ3MzgzNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15991#discussion_r503473834", "bodyText": "cere -> cer to be consistent with other true/false formatting names.", "author": "moderakh", "createdAt": "2020-10-12T18:48:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzMTU4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ5ODg3Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15991#discussion_r503498873", "bodyText": "updated.\n'e' is for enabled, so we should ignore it?", "author": "xinlian12", "createdAt": "2020-10-12T19:49:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzMTU4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzMTkyMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15991#discussion_r502031921", "bodyText": "why is this removed?", "author": "moderakh", "createdAt": "2020-10-08T21:48:48Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/RntbdTransportClient.java", "diffHunk": "@@ -525,7 +599,6 @@ public String toString() {\n          *   \"maxRequestsPerChannel\": 30,\n          *   \"maxConcurrentRequestsPerEndpointOverride\": 500,\n          *   \"receiveHangDetectionTime\": \"PT1M5S\",\n-         *   \"requestExpiryInterval\": \"PT5S\",", "originalCommit": "116d4c238dff9cdd6fb0456a4ad82fab5e5aa82a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ2NTcwOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15991#discussion_r503465709", "bodyText": "My understanding is that this config is not used anywhere.\nAlso moved this change to PR #16197 to keep this PR clean", "author": "xinlian12", "createdAt": "2020-10-12T18:29:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzMTkyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA2NzYxNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15991#discussion_r502067614", "bodyText": "do we translate ChannelAcquisitionException to GoneException?", "author": "moderakh", "createdAt": "2020-10-08T23:12:52Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdClientChannelPool.java", "diffHunk": "@@ -123,18 +121,18 @@\n         new ClosedChannelException(), RntbdClientChannelPool.class, \"acquire\");\n \n     private static final IllegalStateException POOL_CLOSED_ON_ACQUIRE = ThrowableUtil.unknownStackTrace(\n-        new StacklessIllegalStateException(\"service endpoint was closed while acquiring a channel\"),\n+        new ChannelAcquisitionException(\"service endpoint was closed while acquiring a channel\"),", "originalCommit": "116d4c238dff9cdd6fb0456a4ad82fab5e5aa82a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ2NTg5OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15991#discussion_r503465899", "bodyText": "Yes, it will be translated into GoneException.", "author": "xinlian12", "createdAt": "2020-10-12T18:29:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA2NzYxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA2ODkxMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15991#discussion_r502068911", "bodyText": "any reason this is preferred over cause instance of ClosedChannelException ?", "author": "moderakh", "createdAt": "2020-10-08T23:14:56Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdConnectionStateListener.java", "diffHunk": "@@ -0,0 +1,166 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos.implementation.directconnectivity.rntbd;\n+\n+import com.azure.cosmos.implementation.GoneException;\n+import com.azure.cosmos.implementation.RxDocumentServiceRequest;\n+import com.azure.cosmos.implementation.directconnectivity.IAddressResolver;\n+import com.azure.cosmos.implementation.routing.PartitionKeyRangeIdentity;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.IOException;\n+import java.nio.channels.ClosedChannelException;\n+import java.time.Instant;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import static com.azure.cosmos.implementation.guava25.base.Preconditions.checkNotNull;\n+\n+public class RntbdConnectionStateListener {\n+    // region Fields\n+\n+    private static final Logger logger = LoggerFactory.getLogger(RntbdConnectionStateListener.class);\n+\n+    private final IAddressResolver addressResolver;\n+    private final RntbdEndpoint endpoint;\n+    private final Set<PartitionKeyRangeIdentity> partitionAddressCache;\n+    private final AtomicBoolean updatingAddressCache = new AtomicBoolean(false);\n+\n+    // endregion\n+\n+    // region Constructors\n+\n+    public RntbdConnectionStateListener(final IAddressResolver addressResolver, final RntbdEndpoint endpoint) {\n+        this.addressResolver = checkNotNull(addressResolver, \"expected non-null addressResolver\");\n+        this.endpoint = checkNotNull(endpoint, \"expected non-null endpoint\");\n+        this.partitionAddressCache = ConcurrentHashMap.newKeySet();\n+    }\n+\n+    // endregion\n+\n+    // region Methods\n+\n+    public void onException(final RxDocumentServiceRequest request, Throwable exception) {\n+        checkNotNull(request, \"expect non-null request\");\n+        checkNotNull(exception, \"expect non-null exception\");\n+\n+        if (exception instanceof GoneException) {\n+            final Throwable cause = exception.getCause();\n+\n+            if (cause != null) {\n+\n+                // GoneException was produced by the client, not the server\n+                //\n+                // This could occur for example:\n+                //\n+                // * an operation fails due to an IOException which indicates a connection reset by the server,\n+                // * a channel closes unexpectedly because the server stopped taking requests, or\n+                // * an error was detected by the transport client (e.g., IllegalStateException)\n+                // * a request timed out in pending acquisition queue\n+                // * a request failed fast in admission control layer due to high load\n+                // * channel connect timed out\n+                //\n+                // Currently, only ClosedChannelException will raise onConnectionEvent since it is more sure of a signal the server is going down.\n+\n+                if (cause instanceof IOException) {\n+                    final Class<?> type = cause.getClass();\n+\n+                    if (type == ClosedChannelException.class) {", "originalCommit": "116d4c238dff9cdd6fb0456a4ad82fab5e5aa82a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzYwMDg1NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15991#discussion_r503600854", "bodyText": "changed to instance of ClosedChannelException", "author": "xinlian12", "createdAt": "2020-10-13T00:22:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA2ODkxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA2OTU2Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15991#discussion_r502069562", "bodyText": "why? is this related to this PR? or an unrelated bug?", "author": "moderakh", "createdAt": "2020-10-08T23:16:00Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdRequest.java", "diffHunk": "@@ -54,7 +55,7 @@ public static RntbdRequest decode(final ByteBuf in) {\n             throw new IllegalStateException(reason);\n         }\n \n-        final int start = in.readerIndex();\n+        final int start = in.writerIndex();", "originalCommit": "116d4c238dff9cdd6fb0456a4ad82fab5e5aa82a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ2Njk4NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15991#discussion_r503466985", "bodyText": "As mentioned in the original PR #14697, we have to use writerIndex.\nAlso moved this change to PR #16197", "author": "xinlian12", "createdAt": "2020-10-12T18:32:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA2OTU2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA3MDI3Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15991#discussion_r502070272", "bodyText": "why flush is required here? I don't think this is in the scope of the connection listener. am I right?\nplease undo this if unrelated to this PR.", "author": "moderakh", "createdAt": "2020-10-08T23:17:11Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdRequestManager.java", "diffHunk": "@@ -506,7 +506,7 @@ public void write(final ChannelHandlerContext context, final Object message, fin\n \n         if (message == RntbdHealthCheckRequest.MESSAGE) {\n \n-            context.write(RntbdHealthCheckRequest.MESSAGE, promise).addListener(completed -> {\n+            context.writeAndFlush(RntbdHealthCheckRequest.MESSAGE, promise).addListener(completed -> {", "originalCommit": "116d4c238dff9cdd6fb0456a4ad82fab5e5aa82a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEzMTc3OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15991#discussion_r504131778", "bodyText": "Has removed this change to PR #16197", "author": "xinlian12", "createdAt": "2020-10-13T17:25:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA3MDI3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA4MDYzMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15991#discussion_r502080631", "bodyText": "RntbdConnectionStateListener::partitionAddressCache  is a local cache and can be stale. as a result of that RntbdConnectionStateListener may remove addresses of unrelated pkranges causing unnecessary address refresh.\nConsider this scenario:\n\nPKR1, PKR2, PKR3 are hosted on the same physical node.\nrequest1 with PKR1, request2 with PKR2, and request3 with PKR3 are sent and as a result RntbdConnectionStateListener:partitionAddressCache is populated with PKR1, PKR2, and PKR3.\ndue to  partition movement PKR1 moves out of the physical node, but PKR2 and PKR3 stay on the node.\nnow the node hosting PKR2 and PKR3 shuts down.\nRntbdConnectionStateListener thinks PKR1 is still on this physical node, and hence will remove addresses of PKR1, PKR2, and PKR3. But PKR1 addresses shouldn't have been removed!!.\nthis will result in unnecessary address refresh for PKR1.", "author": "moderakh", "createdAt": "2020-10-08T23:40:20Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/rntbd/RntbdConnectionStateListener.java", "diffHunk": "@@ -0,0 +1,166 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos.implementation.directconnectivity.rntbd;\n+\n+import com.azure.cosmos.implementation.GoneException;\n+import com.azure.cosmos.implementation.RxDocumentServiceRequest;\n+import com.azure.cosmos.implementation.directconnectivity.IAddressResolver;\n+import com.azure.cosmos.implementation.routing.PartitionKeyRangeIdentity;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.IOException;\n+import java.nio.channels.ClosedChannelException;\n+import java.time.Instant;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import static com.azure.cosmos.implementation.guava25.base.Preconditions.checkNotNull;\n+\n+public class RntbdConnectionStateListener {\n+    // region Fields\n+\n+    private static final Logger logger = LoggerFactory.getLogger(RntbdConnectionStateListener.class);\n+\n+    private final IAddressResolver addressResolver;\n+    private final RntbdEndpoint endpoint;\n+    private final Set<PartitionKeyRangeIdentity> partitionAddressCache;", "originalCommit": "116d4c238dff9cdd6fb0456a4ad82fab5e5aa82a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ2NzQ1MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15991#discussion_r503467451", "bodyText": "Yea, based on the current implementation, it could happen.\nWill think more and check how .net implement and then update here.", "author": "xinlian12", "createdAt": "2020-10-12T18:33:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA4MDYzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA5NTEzNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15991#discussion_r504095135", "bodyText": "let's track this as an optimization for later. (out of the scope of this PR)", "author": "moderakh", "createdAt": "2020-10-13T16:31:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA4MDYzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE1NTI1Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15991#discussion_r504155256", "bodyText": "Created github working item to track this issue:\n\n#16245\n#16246", "author": "xinlian12", "createdAt": "2020-10-13T18:06:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA4MDYzMQ=="}], "type": "inlineReview"}, {"oid": "1a8bcccacfb0528d426ae1adc3c2557ee622c78b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1a8bcccacfb0528d426ae1adc3c2557ee622c78b", "message": "Merge branch 'master' into ConnectionStateListener", "committedDate": "2020-10-09T19:46:59Z", "type": "commit"}, {"oid": "fcc29d6d0d74e9c8ce4dcb974b4f83d5d26f6a62", "url": "https://github.com/Azure/azure-sdk-for-java/commit/fcc29d6d0d74e9c8ce4dcb974b4f83d5d26f6a62", "message": "revert back change not related to ConnectionStateListener", "committedDate": "2020-10-12T16:47:50Z", "type": "commit"}, {"oid": "718c7546afea371b44028b242af8e9906d4a76f8", "url": "https://github.com/Azure/azure-sdk-for-java/commit/718c7546afea371b44028b242af8e9906d4a76f8", "message": "Merge branch 'master' into ConnectionStateListener", "committedDate": "2020-10-12T16:48:38Z", "type": "commit"}, {"oid": "df9af7f18e93688c3f8263a5838fe183c0381b93", "url": "https://github.com/Azure/azure-sdk-for-java/commit/df9af7f18e93688c3f8263a5838fe183c0381b93", "message": "resolve comments", "committedDate": "2020-10-12T18:17:50Z", "type": "commit"}, {"oid": "d964363e5d221330f8c5d9fc1466739a8d9a0705", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d964363e5d221330f8c5d9fc1466739a8d9a0705", "message": "fix tests", "committedDate": "2020-10-12T18:34:51Z", "type": "commit"}, {"oid": "bb34f16b0ca1829caacb8dbef9c87d1bda9f76bf", "url": "https://github.com/Azure/azure-sdk-for-java/commit/bb34f16b0ca1829caacb8dbef9c87d1bda9f76bf", "message": "changeConnectionStateListener default to false and resolve comments", "committedDate": "2020-10-12T19:46:09Z", "type": "commit"}, {"oid": "2148f92be5ab600cf8769602495e0440cba72e9a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2148f92be5ab600cf8769602495e0440cba72e9a", "message": "fix tests", "committedDate": "2020-10-12T19:59:10Z", "type": "commit"}, {"oid": "bd12a8bc987de2ecbdfef20ff62c2327eb65844d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/bd12a8bc987de2ecbdfef20ff62c2327eb65844d", "message": "Merge branch 'master' into ConnectionStateListener", "committedDate": "2020-10-13T19:20:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4NDQ5MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15991#discussion_r505884490", "bodyText": "please add Beta annotation.", "author": "moderakh", "createdAt": "2020-10-15T21:50:18Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/DirectConnectionConfig.java", "diffHunk": "@@ -40,6 +43,37 @@ public DirectConnectionConfig() {\n         this.requestTimeout = DEFAULT_REQUEST_TIMEOUT;\n     }\n \n+    /**\n+     * Gets a value indicating whether Direct TCP connection endpoint rediscovery is enabled.\n+     * <p>\n+     * The connection endpoint rediscovery feature is designed to reduce and spread-out latency spikes that may occur during maintenance operations.\n+     *\n+     * By default, connection endpoint rediscovery is disabled.\n+     *\n+     * @return {@code true} if Direct TCP connection endpoint rediscovery is enabled; {@code false} otherwise.\n+     */\n+    public boolean isConnectionEndpointRediscoveryEnabled() {", "originalCommit": "2148f92be5ab600cf8769602495e0440cba72e9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQzMDM0MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15991#discussion_r509430341", "bodyText": "Added, thanks", "author": "xinlian12", "createdAt": "2020-10-21T16:28:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4NDQ5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4NDU5Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15991#discussion_r505884596", "bodyText": "please add Beta annotation.", "author": "moderakh", "createdAt": "2020-10-15T21:50:25Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/DirectConnectionConfig.java", "diffHunk": "@@ -40,6 +43,37 @@ public DirectConnectionConfig() {\n         this.requestTimeout = DEFAULT_REQUEST_TIMEOUT;\n     }\n \n+    /**\n+     * Gets a value indicating whether Direct TCP connection endpoint rediscovery is enabled.\n+     * <p>\n+     * The connection endpoint rediscovery feature is designed to reduce and spread-out latency spikes that may occur during maintenance operations.\n+     *\n+     * By default, connection endpoint rediscovery is disabled.\n+     *\n+     * @return {@code true} if Direct TCP connection endpoint rediscovery is enabled; {@code false} otherwise.\n+     */\n+    public boolean isConnectionEndpointRediscoveryEnabled() {\n+        return this.connectionEndpointRediscoveryEnabled;\n+    }\n+\n+    /**\n+     * Sets a value indicating whether Direct TCP connection endpoint rediscovery should be enabled.\n+     * <p>\n+     * The connection endpoint rediscovery feature is designed to reduce and spread-out latency spikes that may occur during maintenance operations.\n+     *\n+     * By default, connection endpoint rediscovery is disabled.\n+     *\n+     * @param connectionEndpointRediscoveryEnabled {@code true} if connection endpoint rediscovery is enabled; {@code\n+     *                                             false} otherwise.\n+     *\n+     * @return the {@linkplain DirectConnectionConfig}.\n+     */\n+    public DirectConnectionConfig setConnectionEndpointRediscoveryEnabled(boolean connectionEndpointRediscoveryEnabled) {", "originalCommit": "2148f92be5ab600cf8769602495e0440cba72e9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQzMDI0Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/15991#discussion_r509430247", "bodyText": "Added. Thanks", "author": "xinlian12", "createdAt": "2020-10-21T16:28:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg4NDU5Ng=="}], "type": "inlineReview"}, {"oid": "b7ea5806ce2af2f2ba41da6b4f0698bdc1c522b9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b7ea5806ce2af2f2ba41da6b4f0698bdc1c522b9", "message": "Merge branch 'master' into ConnectionStateListener", "committedDate": "2020-10-18T16:18:00Z", "type": "commit"}, {"oid": "166947a9e7cc99dc9a40811a3f7069742faea066", "url": "https://github.com/Azure/azure-sdk-for-java/commit/166947a9e7cc99dc9a40811a3f7069742faea066", "message": "add beta annotation", "committedDate": "2020-10-18T16:28:01Z", "type": "commit"}]}