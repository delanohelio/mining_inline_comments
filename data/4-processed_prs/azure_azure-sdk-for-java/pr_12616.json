{"pr_number": 12616, "pr_title": "Add token refresh options to simple token cache (azure-core) #12403", "pr_createdAt": "2020-06-29T19:14:29Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/12616", "timeline": [{"oid": "649593f8f3d2c9be4b2235805844f5fb220c275e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/649593f8f3d2c9be4b2235805844f5fb220c275e", "message": "Add token refresh options to simple token cache", "committedDate": "2020-06-22T23:02:17Z", "type": "commit"}, {"oid": "8fc55084414d29b6fcc79904990cc4f7e2c67b53", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8fc55084414d29b6fcc79904990cc4f7e2c67b53", "message": "Fix amqp test", "committedDate": "2020-06-22T23:18:59Z", "type": "commit"}, {"oid": "4eff3c1e0ae0768dcec305a2d521cfad5bb7b175", "url": "https://github.com/Azure/azure-sdk-for-java/commit/4eff3c1e0ae0768dcec305a2d521cfad5bb7b175", "message": "Address Alan & CI's feedback", "committedDate": "2020-06-24T21:23:16Z", "type": "commit"}, {"oid": "400396b13b3cabd07e793a8523ebd3948a09bedd", "url": "https://github.com/Azure/azure-sdk-for-java/commit/400396b13b3cabd07e793a8523ebd3948a09bedd", "message": "migrate more from identity", "committedDate": "2020-06-24T21:35:53Z", "type": "commit"}, {"oid": "75987f774628315038b7f9522830b0e966e4b4c4", "url": "https://github.com/Azure/azure-sdk-for-java/commit/75987f774628315038b7f9522830b0e966e4b4c4", "message": "Merge branch 'master' into simpletokencache", "committedDate": "2020-06-25T06:32:45Z", "type": "commit"}, {"oid": "886cac316a4e3bd40ded52e8a8857893c81ae658", "url": "https://github.com/Azure/azure-sdk-for-java/commit/886cac316a4e3bd40ded52e8a8857893c81ae658", "message": "Checkstyle", "committedDate": "2020-06-25T07:06:26Z", "type": "commit"}, {"oid": "f234570a7995112920a53decd0ca878ecd4f5d17", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f234570a7995112920a53decd0ca878ecd4f5d17", "message": "Merge branch 'simpletokencache' of github.com:jianghaolu/azure-sdk-for-java into simpletokencache", "committedDate": "2020-06-25T07:07:12Z", "type": "commit"}, {"oid": "4b6eec05de35a23e3ee91bfdecf569048045ea74", "url": "https://github.com/Azure/azure-sdk-for-java/commit/4b6eec05de35a23e3ee91bfdecf569048045ea74", "message": "Fit and finish", "committedDate": "2020-06-26T06:56:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE5NzA1NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12616#discussion_r447197055", "bodyText": "Since this is on the TokenRefreshOptions should we remove the \"TokenRefresh\" from these property accessors? In this case getRetryTimeout", "author": "schaabs", "createdAt": "2020-06-29T19:18:47Z", "path": "sdk/core/azure-core/src/main/java/com/azure/core/credential/TokenRefreshOptions.java", "diffHunk": "@@ -0,0 +1,63 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.credential;\n+\n+import java.time.Duration;\n+\n+/**\n+ * The options to configure the token refresh behavior.\n+ */\n+public class TokenRefreshOptions {\n+    private static final Duration DEFAULT_REFRESH_RETRY_TIMEOUT = Duration.ofSeconds(30);\n+    private static final Duration DEFAULT_REFRESH_OFFSET = Duration.ofMinutes(2);\n+\n+    private Duration tokenRefreshRetryTimeout = DEFAULT_REFRESH_RETRY_TIMEOUT;\n+    private Duration tokenRefreshOffset = DEFAULT_REFRESH_OFFSET;\n+\n+    /**\n+     * Returns a Duration value representing the amount of time to wait before retrying a token refresh. This is to\n+     * prevent sending too many requests to the authentication service.\n+     *\n+     * @return the duration value representing the amount of time to wait before retrying a token refresh\n+     */\n+    public Duration getTokenRefreshRetryTimeout() {", "originalCommit": "4b6eec05de35a23e3ee91bfdecf569048045ea74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI2NTc5MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12616#discussion_r447265791", "bodyText": "Simplified as suggested", "author": "jianghaolu", "createdAt": "2020-06-29T21:30:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE5NzA1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE5ODIyNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12616#discussion_r447198225", "bodyText": "same as above, could this be just setOffset?", "author": "schaabs", "createdAt": "2020-06-29T19:20:54Z", "path": "sdk/core/azure-core/src/main/java/com/azure/core/credential/TokenRefreshOptions.java", "diffHunk": "@@ -0,0 +1,63 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.credential;\n+\n+import java.time.Duration;\n+\n+/**\n+ * The options to configure the token refresh behavior.\n+ */\n+public class TokenRefreshOptions {\n+    private static final Duration DEFAULT_REFRESH_RETRY_TIMEOUT = Duration.ofSeconds(30);\n+    private static final Duration DEFAULT_REFRESH_OFFSET = Duration.ofMinutes(2);\n+\n+    private Duration tokenRefreshRetryTimeout = DEFAULT_REFRESH_RETRY_TIMEOUT;\n+    private Duration tokenRefreshOffset = DEFAULT_REFRESH_OFFSET;\n+\n+    /**\n+     * Returns a Duration value representing the amount of time to wait before retrying a token refresh. This is to\n+     * prevent sending too many requests to the authentication service.\n+     *\n+     * @return the duration value representing the amount of time to wait before retrying a token refresh\n+     */\n+    public Duration getTokenRefreshRetryTimeout() {\n+        return tokenRefreshRetryTimeout;\n+    }\n+\n+    /**\n+     * Specifies a Duration value representing the amount of time to wait before retrying a token refresh. This is to\n+     * prevent sending too many requests to the authentication service.\n+     *\n+     * @param tokenRefreshRetryTimeout the amount of time to wait before retrying a token refresh\n+     * @return the updated TokenRefreshOptions object\n+     */\n+    public TokenRefreshOptions setTokenRefreshRetryTimeout(Duration tokenRefreshRetryTimeout) {\n+        this.tokenRefreshRetryTimeout = tokenRefreshRetryTimeout;\n+        return this;\n+    }\n+\n+    /**\n+     * Returns a Duration value representing the amount of time to subtract from the token expiry time, whereupon\n+     * attempts will be made to refresh the token. By default this will occur two minutes prior to the expiry of the\n+     * token.\n+     *\n+     * @return the duration value representing the amount of time to subtract from the token expiry time\n+     */\n+    public Duration getTokenRefreshOffset() {\n+        return tokenRefreshOffset;\n+    }\n+\n+    /**\n+     * Specifies the Duration value representing the amount of time to subtract from the token expiry time, whereupon\n+     * attempts will be made to refresh the token. By default this will occur two minutes prior to the expiry of the\n+     * token.\n+     *\n+     * @param tokenRefreshOffset the duration representing the amount of time to subtract from the token expiry time\n+     * @return the updated TokenRefreshOptions object\n+     */\n+    public TokenRefreshOptions setTokenRefreshOffset(Duration tokenRefreshOffset) {", "originalCommit": "4b6eec05de35a23e3ee91bfdecf569048045ea74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI2NTc1MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12616#discussion_r447265750", "bodyText": "Simplified as suggested", "author": "jianghaolu", "createdAt": "2020-06-29T21:30:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE5ODIyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIwMjUyNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12616#discussion_r447202526", "bodyText": "I think it's could be problematic to have setters for these properties. If TokenRefreshOptions is mutable TokenCredential implementations will have to copy this object to avoid mutations in behavior.  Is it possible to only take these arguments on construction? or would we need to add a builder to make this class immutable?", "author": "schaabs", "createdAt": "2020-06-29T19:28:57Z", "path": "sdk/core/azure-core/src/main/java/com/azure/core/credential/TokenRefreshOptions.java", "diffHunk": "@@ -0,0 +1,63 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.credential;\n+\n+import java.time.Duration;\n+\n+/**\n+ * The options to configure the token refresh behavior.\n+ */\n+public class TokenRefreshOptions {\n+    private static final Duration DEFAULT_REFRESH_RETRY_TIMEOUT = Duration.ofSeconds(30);\n+    private static final Duration DEFAULT_REFRESH_OFFSET = Duration.ofMinutes(2);\n+\n+    private Duration tokenRefreshRetryTimeout = DEFAULT_REFRESH_RETRY_TIMEOUT;\n+    private Duration tokenRefreshOffset = DEFAULT_REFRESH_OFFSET;\n+\n+    /**\n+     * Returns a Duration value representing the amount of time to wait before retrying a token refresh. This is to\n+     * prevent sending too many requests to the authentication service.\n+     *\n+     * @return the duration value representing the amount of time to wait before retrying a token refresh\n+     */\n+    public Duration getTokenRefreshRetryTimeout() {\n+        return tokenRefreshRetryTimeout;\n+    }\n+\n+    /**\n+     * Specifies a Duration value representing the amount of time to wait before retrying a token refresh. This is to\n+     * prevent sending too many requests to the authentication service.\n+     *\n+     * @param tokenRefreshRetryTimeout the amount of time to wait before retrying a token refresh\n+     * @return the updated TokenRefreshOptions object\n+     */\n+    public TokenRefreshOptions setTokenRefreshRetryTimeout(Duration tokenRefreshRetryTimeout) {", "originalCommit": "4b6eec05de35a23e3ee91bfdecf569048045ea74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI1MTkyNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12616#discussion_r447251926", "bodyText": "I can move them to a constructor but then it will be difficult to add more options in the future. Most of the \"XXXOptions\" in the Java SDK today are mutable like AmqpRetryOptions, HttpLogOptions", "author": "jianghaolu", "createdAt": "2020-06-29T21:02:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIwMjUyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI3Mjk3NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12616#discussion_r447272975", "bodyText": "From the Java SDK authoring guidelines (https://azure.github.io/azure-sdk/java_design.html#model-classes):\n\n\u2705 DO provide public constructors for all model classes that a user is allowed to instantiate. Model classes that are not instantiable by the user, for example if they are model types returned from the service, should not have any publicly visible constructors.\nUse a no-args constructor and a fluent setter API to configure the model class. However, other designs may be used for the constructor when appropriate.\n\n\n\u26d4\ufe0f DO NOT offer a builder class for model classes.\n\n\n\u2705 DO ensure that setter methods within a fluent type return the same instance of the type.\nFluent types must not be immutable. Don\u2019t return a new instance on each setter call.", "author": "jianghaolu", "createdAt": "2020-06-29T21:46:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIwMjUyNg=="}], "type": "inlineReview"}, {"oid": "cbb443845186be2d969ddb2a0592a909066f453b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/cbb443845186be2d969ddb2a0592a909066f453b", "message": "Simply properties in TokenRefreshOptions", "committedDate": "2020-06-29T21:28:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI3MzgzOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12616#discussion_r447273839", "bodyText": "I worry that this property is very complex  to use. TokenCredentialOptions already have retry options, and this adds another level of complexity to that. If we make it configurable users might have to understand the interrelated nature of this and the retry options. Perhaps we could defer allowing this to be configurable? If not I don't think that RetryTimeout really describes what this property is used for.", "author": "schaabs", "createdAt": "2020-06-29T21:48:38Z", "path": "sdk/core/azure-core/src/main/java/com/azure/core/credential/TokenRefreshOptions.java", "diffHunk": "@@ -0,0 +1,63 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.credential;\n+\n+import java.time.Duration;\n+\n+/**\n+ * The options to configure the token refresh behavior.\n+ */\n+public class TokenRefreshOptions {\n+    private static final Duration DEFAULT_RETRY_TIMEOUT = Duration.ofSeconds(30);\n+    private static final Duration DEFAULT_OFFSET = Duration.ofMinutes(2);\n+\n+    private Duration retryTimeout = DEFAULT_RETRY_TIMEOUT;\n+    private Duration offset = DEFAULT_OFFSET;\n+\n+    /**\n+     * Returns a Duration value representing the amount of time to wait before retrying a token refresh. This is to\n+     * prevent sending too many requests to the authentication service.\n+     *\n+     * @return the duration value representing the amount of time to wait before retrying a token refresh\n+     */\n+    public Duration getRetryTimeout() {", "originalCommit": "cbb443845186be2d969ddb2a0592a909066f453b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU2NDY0Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12616#discussion_r448564643", "bodyText": "On IdentityClientOptions this is called tokenRefreshRetryTimeout(). The name is only simplified as you suggested in TokenRefreshOptions. I agreed to make the change considering this is in the context of the TokenRefreshOptions class.\nFor .NET if you already have a TokenCredentialsOptions it could make more sense to move this inside TokenCredentialOptions. It could live there as a RefreshOptions property bag, or flattened as RefreshTimeout and RefreshOffset properties.", "author": "jianghaolu", "createdAt": "2020-07-01T19:12:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI3MzgzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU2NjA1OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12616#discussion_r448566059", "bodyText": "On second thought, I'll make the case for this class to be immutable as an exception submitted to Java architects. That will make sure these are only modifiable from a subclass.", "author": "jianghaolu", "createdAt": "2020-07-01T19:15:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI3MzgzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTI4NzQ3Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12616#discussion_r449287472", "bodyText": "@schaabs Considering that in the current Java implementation, the timeout only applies to error retries, but also refreshes after a previous successful refresh, this may be better called \"getTimeout()\" in TokenRefreshOptions.java, or TokenRefreshTimeout in other places like TokenCredentialOptions.cs. The scenario happens if a user specifies a \"tokenRefreshOffset\" that's equal to or longer than the token valid time, it prevents the cache from proactive refreshing on every single request.", "author": "jianghaolu", "createdAt": "2020-07-02T22:09:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI3MzgzOQ=="}], "type": "inlineReview"}, {"oid": "8a8592d75e6375917f99a22eb04b59799f096812", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8a8592d75e6375917f99a22eb04b59799f096812", "message": "Merge branch 'release/azurecore-1.6.0-beta.1' of github.com:Azure/azure-sdk-for-java into simpletokencache", "committedDate": "2020-07-01T20:38:07Z", "type": "commit"}, {"oid": "8a8592d75e6375917f99a22eb04b59799f096812", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8a8592d75e6375917f99a22eb04b59799f096812", "message": "Merge branch 'release/azurecore-1.6.0-beta.1' of github.com:Azure/azure-sdk-for-java into simpletokencache", "committedDate": "2020-07-01T20:38:07Z", "type": "forcePushed"}, {"oid": "ee3b143212cccdf27aa83c43a715152e097c33db", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ee3b143212cccdf27aa83c43a715152e097c33db", "message": "Remove tokenRefreshTimeout and add more javadocs", "committedDate": "2020-07-02T22:49:08Z", "type": "commit"}, {"oid": "f6b688e16dc53827478abf5a373400c8dcbd4213", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f6b688e16dc53827478abf5a373400c8dcbd4213", "message": "Remove token refresh offset setter", "committedDate": "2020-07-02T23:17:13Z", "type": "commit"}, {"oid": "40354ae19567b38d24d48c5b664b4eee4e420474", "url": "https://github.com/Azure/azure-sdk-for-java/commit/40354ae19567b38d24d48c5b664b4eee4e420474", "message": "update tests with non-configurable token refresh timeout", "committedDate": "2020-07-02T23:36:45Z", "type": "commit"}, {"oid": "219e0c07bc3c716638475646fca372d5c6020a07", "url": "https://github.com/Azure/azure-sdk-for-java/commit/219e0c07bc3c716638475646fca372d5c6020a07", "message": "Fix javadocs", "committedDate": "2020-07-02T23:52:54Z", "type": "commit"}, {"oid": "c4267cc7c0ed64940fd2dc8bba74f263782e4f9b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c4267cc7c0ed64940fd2dc8bba74f263782e4f9b", "message": "improve token cache test", "committedDate": "2020-07-03T08:32:44Z", "type": "commit"}]}