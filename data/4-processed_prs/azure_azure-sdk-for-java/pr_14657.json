{"pr_number": 14657, "pr_title": "Update Identity Credentials Aug 2020", "pr_createdAt": "2020-08-31T16:32:44Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/14657", "timeline": [{"oid": "47150247b74c80f053eb96f2441930e5a3e63bd1", "url": "https://github.com/Azure/azure-sdk-for-java/commit/47150247b74c80f053eb96f2441930e5a3e63bd1", "message": "Add CredenUnavailableException on adfs tenants.", "committedDate": "2020-08-31T16:24:41Z", "type": "commit"}, {"oid": "51e3f8dcdcefe54585c2b5164e14a7d155666288", "url": "https://github.com/Azure/azure-sdk-for-java/commit/51e3f8dcdcefe54585c2b5164e14a7d155666288", "message": "Merge remote-tracking branch 'upstream/master' into update-identity-credentials-aug-2020", "committedDate": "2020-08-31T16:31:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ1MzM5OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14657#discussion_r480453399", "bodyText": "Should this error also apply to service principal authentication as well? I'm not familiar enough with the IntelliJ plug-in, but can you authenticate a service principal in an ADFS instance? Does it not try to actually authenticate the SP, but rather just store the credentials?", "author": "schaabs", "createdAt": "2020-08-31T22:56:15Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/IdentityClient.java", "diffHunk": "@@ -337,6 +338,10 @@ private PublicClientApplication getPublicClientApplication(boolean sharedTokenCa\n                 }\n             } else if (authType.equalsIgnoreCase(\"DC\")) {\n \n+                if (isADFSTenant()) {\n+                    return Mono.error(new CredentialUnavailableException(\"IntelliJCredential  \"\n+                                         + \"authentication unavailable. ADFS tenant/authorities are not supported.\"));", "originalCommit": "51e3f8dcdcefe54585c2b5164e14a7d155666288", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjIwMjAxMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14657#discussion_r482202010", "bodyText": "So, the IDE Azure Plugin auth with SP won't succeed as the IDE Plugin passes in invalid resources in the request for the Az Stack.  But, the service principal details will get stored in the filesystem and if used via the IntelliJCredential with correct scopes specified, it works fine against Az Stack.", "author": "g2vinay", "createdAt": "2020-09-02T16:26:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ1MzM5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjQ0MDA5NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14657#discussion_r482440094", "bodyText": "It's an interesting definition of \"Works Fine\", but I suppose we don't need to artificially guard against it.", "author": "schaabs", "createdAt": "2020-09-02T20:44:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ1MzM5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjU3MTU2MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14657#discussion_r482571561", "bodyText": "Yeah, since Service Principal auth is supported against Az Stack from the credential, we don't need to guard against it.\nIt'll be a rare scenario for the user to take this route.", "author": "g2vinay", "createdAt": "2020-09-02T22:53:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ1MzM5OQ=="}], "type": "inlineReview"}, {"oid": "9de8f97fe11a375443f98eb3984d7510a3ae9537", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9de8f97fe11a375443f98eb3984d7510a3ae9537", "message": "add redirect URI to IBC.", "committedDate": "2020-09-02T07:23:40Z", "type": "commit"}, {"oid": "5d7f79c1663b55c351f013b808e72b04873aed39", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5d7f79c1663b55c351f013b808e72b04873aed39", "message": "fix dead store", "committedDate": "2020-09-02T16:40:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjMyMzYzNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14657#discussion_r482323637", "bodyText": "Should either port or redirectUrl be required?", "author": "jianghaolu", "createdAt": "2020-09-02T19:13:24Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/InteractiveBrowserCredentialBuilder.java", "diffHunk": "@@ -89,9 +109,8 @@ InteractiveBrowserCredentialBuilder disableAutomaticAuthentication() {\n     public InteractiveBrowserCredential build() {\n         ValidationUtil.validate(getClass().getSimpleName(), new HashMap<String, Object>() {{\n                 put(\"clientId\", clientId);\n-                put(\"port\", port);", "originalCommit": "5d7f79c1663b55c351f013b808e72b04873aed39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjMyNTQ3NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14657#discussion_r482325475", "bodyText": "nope,\nif both are not specified, then we default to localhost and MSAL will find an open port to connect to.", "author": "g2vinay", "createdAt": "2020-09-02T19:15:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjMyMzYzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjMyOTc5Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14657#discussion_r482329796", "bodyText": "MSAL will find an open port to connect to\n\nMSAL doesn't connect to this redirectUrl. AAD will verify it matches the one in the app registration and only if it completely matches, will then login.microsoftonline.com send the user to this URL, in the browser.", "author": "jianghaolu", "createdAt": "2020-09-02T19:20:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjMyMzYzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM0MjM2Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14657#discussion_r482342363", "bodyText": "So, the redirect URL is only required, if user is trying to authenticate with their custom registered application.\nIf they are using a first party client id, then the redirectURL can be arbitrary in the sense that Localhost can be used with any port and user doesn't need to supply it.\nJavadocs provides this guidance too, only for custom client ids, redirect URL is required to be supplied.", "author": "g2vinay", "createdAt": "2020-09-02T19:31:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjMyMzYzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjMyNjkyMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14657#discussion_r482326920", "bodyText": "I wouldn't default to localhost here. We are secretly setting a default here and it will throw an error from AAD saying the redirect URL is not valid. The user will probably scratch the head wondering where he has set the redirect URL. A better error message would be \"Either a port or a redirect URl must be provided on InteractiveBrowserCredentialBuilder, which leads them to read the javadocs there and understand what they need to do.\nYou could also do this validation in the build() method on InteractiveBrowserCredential.", "author": "jianghaolu", "createdAt": "2020-09-02T19:17:02Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/implementation/IdentityClient.java", "diffHunk": "@@ -639,10 +648,21 @@ private HttpPipeline setupPipeline(HttpClient httpClient) {\n      * @param port the port on which the HTTP server is listening\n      * @return a Publisher that emits an AccessToken\n      */\n-    public Mono<MsalToken> authenticateWithBrowserInteraction(TokenRequestContext request, int port) {\n+    public Mono<MsalToken> authenticateWithBrowserInteraction(TokenRequestContext request, Integer port,\n+                                                              String redirectURL) {\n         URI redirectUri;\n+        String redirect;\n+\n+        if (port != null) {\n+            redirect = HTTP_LOCALHOST + \":\" + port;\n+        } else if (redirectURL != null) {\n+            redirect = redirectURL;\n+        } else {\n+            redirect = HTTP_LOCALHOST;", "originalCommit": "5d7f79c1663b55c351f013b808e72b04873aed39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjMyODI4Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14657#discussion_r482328282", "bodyText": "See https://github.com/Azure/azure-sdk-for-java/pull/14657/files#r482323637.\nThe bottom line is - there is no default value for redirectUrl or port - because it can be any arbitrary value the user specifies on the app registration.", "author": "jianghaolu", "createdAt": "2020-09-02T19:18:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjMyNjkyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM0NDI3NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14657#discussion_r482344275", "bodyText": "So, the redirect URL is only required, if user is trying to authenticate with their custom registered application.\nIf they are using a first party client id, then the redirectURL can be arbitrary in the sense that Localhost can be used with any port and user doesn't need to supply it.\nJavadocs provides this guidance too, only for custom client ids, redirect URL is required to be supplied.\nThis is also consistent in Python and .NET.", "author": "g2vinay", "createdAt": "2020-09-02T19:32:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjMyNjkyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM2MjM4OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14657#discussion_r482362389", "bodyText": "Why do we want to deprecate this? Redirect URL will force the user to include the host and the port when they just want to change the port.", "author": "srnagar", "createdAt": "2020-09-02T19:46:04Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/InteractiveBrowserCredentialBuilder.java", "diffHunk": "@@ -17,14 +17,19 @@\n public class InteractiveBrowserCredentialBuilder extends AadCredentialBuilderBase<InteractiveBrowserCredentialBuilder> {\n     private Integer port;\n     private boolean automaticAuthentication = true;\n+    private String redirectURL;\n \n     /**\n      * Sets the port for the local HTTP server, for which {@code http://localhost:{port}} must be\n      * registered as a valid reply URL on the application.\n      *\n+     * @deprecated Configure the redirectURL as {@code http://localhost:{port}} via\n+     * {@link InteractiveBrowserCredentialBuilder#redirectUrl(String)} instead.\n+     *\n      * @param port the port on which the credential will listen for the browser authentication result\n      * @return the InteractiveBrowserCredentialBuilder itself\n      */\n+    @Deprecated", "originalCommit": "5d7f79c1663b55c351f013b808e72b04873aed39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM4MTg2NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14657#discussion_r482381865", "bodyText": "because, port limits the scope for redirectURL to be only localhost:{port}.\nThe redirectURL needs to exactly match the URL user specified when registering their custom public client applications.\nSo, currently it doesn't work for scenarios where registered redirect URL is not localhost.", "author": "g2vinay", "createdAt": "2020-09-02T20:00:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM2MjM4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM2NDE5MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14657#discussion_r482364191", "bodyText": "nit: use camelcase redirectUrl", "author": "srnagar", "createdAt": "2020-09-02T19:47:22Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/InteractiveBrowserCredentialBuilder.java", "diffHunk": "@@ -66,6 +71,21 @@ InteractiveBrowserCredentialBuilder authenticationRecord(AuthenticationRecord au\n         return this;\n     }\n \n+\n+    /**\n+     * Sets the Redirect URL where STS will callback the application with the security code. It is required if a custom\n+     * client id is specified via {@link InteractiveBrowserCredentialBuilder#clientId(String)} and must match the\n+     * redirect URL specified during the application registration.\n+     *\n+     * @param redirectURL the redirect URL to listen on and receive security code.\n+     *\n+     * @return An updated instance of this builder with the configured redirect URL.\n+     */\n+    public InteractiveBrowserCredentialBuilder redirectUrl(String redirectURL) {", "originalCommit": "5d7f79c1663b55c351f013b808e72b04873aed39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjU1MDI0NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14657#discussion_r482550245", "bodyText": "updated", "author": "g2vinay", "createdAt": "2020-09-02T22:35:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM2NDE5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM2NzcwMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14657#discussion_r482367701", "bodyText": "Can redirectUrl be null? Should we have a null check here?", "author": "srnagar", "createdAt": "2020-09-02T19:50:01Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/InteractiveBrowserCredentialBuilder.java", "diffHunk": "@@ -66,6 +71,21 @@ InteractiveBrowserCredentialBuilder authenticationRecord(AuthenticationRecord au\n         return this;\n     }\n \n+\n+    /**\n+     * Sets the Redirect URL where STS will callback the application with the security code. It is required if a custom\n+     * client id is specified via {@link InteractiveBrowserCredentialBuilder#clientId(String)} and must match the\n+     * redirect URL specified during the application registration.\n+     *\n+     * @param redirectURL the redirect URL to listen on and receive security code.\n+     *\n+     * @return An updated instance of this builder with the configured redirect URL.\n+     */\n+    public InteractiveBrowserCredentialBuilder redirectUrl(String redirectURL) {\n+        this.redirectURL = redirectURL;", "originalCommit": "5d7f79c1663b55c351f013b808e72b04873aed39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM4MjUzNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14657#discussion_r482382537", "bodyText": "if its null, we use localhost with an arbitrary valid port as default.\nIt is not required for first party client ids, so can be null.", "author": "g2vinay", "createdAt": "2020-09-02T20:00:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM2NzcwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjQ0MzM4MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14657#discussion_r482443381", "bodyText": "What if the redirectUrl contains a port already? Should we throw here is both port and redirectUrl are specified?", "author": "schaabs", "createdAt": "2020-09-02T20:46:41Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/InteractiveBrowserCredentialBuilder.java", "diffHunk": "@@ -89,9 +109,8 @@ InteractiveBrowserCredentialBuilder disableAutomaticAuthentication() {\n     public InteractiveBrowserCredential build() {\n         ValidationUtil.validate(getClass().getSimpleName(), new HashMap<String, Object>() {{\n                 put(\"clientId\", clientId);\n-                put(\"port\", port);\n             }});\n-        return new InteractiveBrowserCredential(clientId, tenantId, port, automaticAuthentication,\n+        return new InteractiveBrowserCredential(clientId, tenantId, port, redirectURL, automaticAuthentication,", "originalCommit": "5d7f79c1663b55c351f013b808e72b04873aed39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjU1MjM0Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14657#discussion_r482552343", "bodyText": "As discussed, to fail early with a better error message, added the check here to throw if both port and redirectUrl are specified.", "author": "g2vinay", "createdAt": "2020-09-02T22:37:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjQ0MzM4MQ=="}], "type": "inlineReview"}, {"oid": "d7484c4465a63275106961500999b588fd5001db", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d7484c4465a63275106961500999b588fd5001db", "message": "address feedback.", "committedDate": "2020-09-02T22:30:31Z", "type": "commit"}, {"oid": "3d68f3d7a605503b41011aa33a697996a2657a3e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3d68f3d7a605503b41011aa33a697996a2657a3e", "message": "update changelog", "committedDate": "2020-09-11T16:20:53Z", "type": "commit"}, {"oid": "b8308d05cdb1d770a02ad9792e369676dc8e140e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b8308d05cdb1d770a02ad9792e369676dc8e140e", "message": "resolve conflict", "committedDate": "2020-09-11T16:32:46Z", "type": "commit"}]}