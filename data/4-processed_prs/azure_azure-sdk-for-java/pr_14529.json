{"pr_number": 14529, "pr_title": "Cosmos Encryption removed block() in implementation", "pr_createdAt": "2020-08-27T20:12:46Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/14529", "timeline": [{"oid": "c0a4447307212fc2e0297274cace69e861aae73c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c0a4447307212fc2e0297274cace69e861aae73c", "message": "removed blocking calls from cosmos encryption", "committedDate": "2020-08-27T20:09:59Z", "type": "commit"}, {"oid": "89e49447ab5f62d3c80180250aaf28509f793a51", "url": "https://github.com/Azure/azure-sdk-for-java/commit/89e49447ab5f62d3c80180250aaf28509f793a51", "message": "undo change", "committedDate": "2020-08-27T20:12:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcyMjkxNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14529#discussion_r478722917", "bodyText": "NIT: Remove TODO comment?", "author": "FabianMeiswinkel", "createdAt": "2020-08-27T22:08:08Z", "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/AzureKeyVaultKeyWrapProvider.java", "diffHunk": "@@ -50,7 +50,7 @@ public AzureKeyVaultKeyWrapProvider(KeyVaultTokenCredentialFactory keyVaultToken\n \n     // TODO make this async", "originalCommit": "89e49447ab5f62d3c80180250aaf28509f793a51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODczMDI2Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14529#discussion_r478730263", "bodyText": "thanks will do.", "author": "moderakh", "createdAt": "2020-08-27T22:28:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcyMjkxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODczOTQwNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14529#discussion_r478739405", "bodyText": "done.", "author": "moderakh", "createdAt": "2020-08-27T22:55:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcyMjkxNw=="}], "type": "inlineReview"}, {"oid": "079dc12e5baf57be3ef4468a3ed7537b76274c53", "url": "https://github.com/Azure/azure-sdk-for-java/commit/079dc12e5baf57be3ef4468a3ed7537b76274c53", "message": "cleanup", "committedDate": "2020-08-27T22:10:54Z", "type": "commit"}, {"oid": "a7c2ef92baa39c341b79fad6b511628e8f307336", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a7c2ef92baa39c341b79fad6b511628e8f307336", "message": "Merge branch 'master' into users/moderakh/20200826-encryption", "committedDate": "2020-08-27T22:11:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcyNDMzNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14529#discussion_r478724334", "bodyText": "NIT: wouldn't it make sense to do that in this PR vs. just adding TODO? Or is the work more involved than I naively assume?", "author": "FabianMeiswinkel", "createdAt": "2020-08-27T22:11:57Z", "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/implementation/encryption/CachedDekProperties.java", "diffHunk": "@@ -13,7 +13,7 @@ public CachedDekProperties(\n         DataEncryptionKeyProperties serverProperties,\n         Instant serverPropertiesExpiryUtc) {\n         assert(serverProperties != null);\n-\n+        // TODO: add NPE validation", "originalCommit": "89e49447ab5f62d3c80180250aaf28509f793a51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODczMDIyMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14529#discussion_r478730222", "bodyText": "TODO comment is not accurate. will update the TODO to capture the details.\non contentResponseOnWriteEnabled = false we get into NPE.\nI need to think on what to do on that case (for contentResponseOnWriteEnabled =false).\nJust NPE validation won't help here.", "author": "moderakh", "createdAt": "2020-08-27T22:28:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcyNDMzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODczMjM4Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14529#discussion_r478732387", "bodyText": "Makes sense", "author": "FabianMeiswinkel", "createdAt": "2020-08-27T22:34:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcyNDMzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcyNjM4OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14529#discussion_r478726389", "bodyText": "You are modifying the passed in request options here. Wouldn't it be better to create a deep copy instead?", "author": "FabianMeiswinkel", "createdAt": "2020-08-27T22:17:35Z", "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/implementation/encryption/DataEncryptionKeyContainerCore.java", "diffHunk": "@@ -96,39 +99,42 @@ public DataEncryptionKeyContainerCore(CosmosDataEncryptionKeyProvider dekProvide\n                 DataEncryptionKeyProperties dekProperties = result.getT1();\n                 InMemoryRawDek inMemoryRawDek = result.getT2();\n \n-                Tuple3<byte[], EncryptionKeyWrapMetadata, InMemoryRawDek> wrapResult =\n-                    this.wrapAsync(\n-                        id,\n-                        inMemoryRawDek.getDataEncryptionKey().getRawKey(),\n-                        dekProperties.encryptionAlgorithm,\n-                        newWrapMetadata);\n-\n-                byte[] wrappedDek = wrapResult.getLeft();\n-                EncryptionKeyWrapMetadata updatedMetadata = wrapResult.getMiddle();\n-                InMemoryRawDek updatedRawDek = wrapResult.getRight();\n-\n-                CosmosItemRequestOptions effectiveRequestOptions = requestOptions != null ? requestOptions : new CosmosItemRequestOptions();\n-\n-                effectiveRequestOptions.setIfMatchETag(dekProperties.eTag);\n-\n-                DataEncryptionKeyProperties newDekProperties = new DataEncryptionKeyProperties(dekProperties);\n-                newDekProperties.wrappedDataEncryptionKey = wrappedDek;\n-                newDekProperties.encryptionKeyWrapMetadata = updatedMetadata;\n-\n-                Mono<CosmosItemResponse<DataEncryptionKeyProperties>> responseMono = this.dekProvider.getContainer().replaceItem(\n-                    newDekProperties,\n-                    newDekProperties.id,\n-                    new PartitionKey(newDekProperties.id),\n-                    effectiveRequestOptions);\n-\n-                return responseMono.flatMap(\n-                    response -> {\n-                        DataEncryptionKeyProperties item = response.getItem();\n-\n-                        assert (item != null);\n-                        this.dekProvider.getDekCache().setDekProperties(id, item);\n-                        this.dekProvider.getDekCache().setRawDek(id, updatedRawDek);\n-                        return Mono.just(response);\n+                Mono<Tuple3<byte[], EncryptionKeyWrapMetadata, InMemoryRawDek>> wrapResultMono = this.wrapAsync(\n+                    id,\n+                    inMemoryRawDek.getDataEncryptionKey().getRawKey(),\n+                    dekProperties.encryptionAlgorithm,\n+                    newWrapMetadata);\n+\n+                return wrapResultMono.flatMap(\n+                    wrapResult -> {\n+                        byte[] wrappedDek = wrapResult.getLeft();\n+                        EncryptionKeyWrapMetadata updatedMetadata = wrapResult.getMiddle();\n+                        InMemoryRawDek updatedRawDek = wrapResult.getRight();\n+\n+                        CosmosItemRequestOptions effectiveRequestOptions = requestOptions != null ? requestOptions : new CosmosItemRequestOptions();\n+\n+                        effectiveRequestOptions.setIfMatchETag(dekProperties.eTag);", "originalCommit": "89e49447ab5f62d3c80180250aaf28509f793a51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM4MzE4MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14529#discussion_r481383181", "bodyText": "addressed. good point. thank you.", "author": "moderakh", "createdAt": "2020-09-01T19:32:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcyNjM4OQ=="}], "type": "inlineReview"}, {"oid": "bb53b282350c2c9a13a43895fb9dda002f5a04ff", "url": "https://github.com/Azure/azure-sdk-for-java/commit/bb53b282350c2c9a13a43895fb9dda002f5a04ff", "message": "minor cleanup", "committedDate": "2020-08-27T22:54:53Z", "type": "commit"}, {"oid": "a151c0e69d67016ba34c1cc3c6baf70d046b8616", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a151c0e69d67016ba34c1cc3c6baf70d046b8616", "message": "address code review comment", "committedDate": "2020-08-31T16:35:03Z", "type": "commit"}, {"oid": "34c9d73d635e75c75a22dd74561bf1188e1beb7b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/34c9d73d635e75c75a22dd74561bf1188e1beb7b", "message": "method renaming (dropped Async suffix from the methods)", "committedDate": "2020-08-31T16:58:05Z", "type": "commit"}, {"oid": "374104cb78b21f6c5d4772d5289197460e8f68d4", "url": "https://github.com/Azure/azure-sdk-for-java/commit/374104cb78b21f6c5d4772d5289197460e8f68d4", "message": "cleanup, move internal classes to implementation package", "committedDate": "2020-08-31T21:50:18Z", "type": "commit"}, {"oid": "79ef32707bfe44371965b3bc85e0b7742bf86a72", "url": "https://github.com/Azure/azure-sdk-for-java/commit/79ef32707bfe44371965b3bc85e0b7742bf86a72", "message": "move internal classes to implementation", "committedDate": "2020-08-31T23:38:34Z", "type": "commit"}, {"oid": "6ddb654bd60c548e62477bac452325bcf1244d11", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6ddb654bd60c548e62477bac452325bcf1244d11", "message": "internal APIs moved to package private", "committedDate": "2020-09-01T00:11:53Z", "type": "commit"}]}