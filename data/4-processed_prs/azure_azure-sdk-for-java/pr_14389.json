{"pr_number": 14389, "pr_title": "Event Hubs Idempotent Producer Java", "pr_createdAt": "2020-08-24T23:32:46Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/14389", "timeline": [{"oid": "9f28ae6af0aec48aac34bb1fc98b9742f3849606", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9f28ae6af0aec48aac34bb1fc98b9742f3849606", "message": "Initialize idempotent producer scaffolding", "committedDate": "2020-09-08T22:51:58Z", "type": "commit"}, {"oid": "20f700606a1f2d5ac1df709630c406bf737e99e2", "url": "https://github.com/Azure/azure-sdk-for-java/commit/20f700606a1f2d5ac1df709630c406bf737e99e2", "message": "Add isIdempotentPublishingEnabled", "committedDate": "2020-09-08T22:51:59Z", "type": "commit"}, {"oid": "c12485289d9a03ee1e33b1eae02ea3eb49843d52", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c12485289d9a03ee1e33b1eae02ea3eb49843d52", "message": "Add producer desired capabilities", "committedDate": "2020-09-08T22:52:00Z", "type": "commit"}, {"oid": "acb5b2a817552b09f673c6f25a4f632cef76079a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/acb5b2a817552b09f673c6f25a4f632cef76079a", "message": "Idempotent Producer Draft Implementation", "committedDate": "2020-09-08T22:52:00Z", "type": "commit"}, {"oid": "a1e3f7182fd57f5f8f1222dfa55166521cc22301", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a1e3f7182fd57f5f8f1222dfa55166521cc22301", "message": "Fix an import error", "committedDate": "2020-09-08T22:52:01Z", "type": "commit"}, {"oid": "1ff21b8f26563a0c56f2ffb5a7d19bc956c27f78", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1ff21b8f26563a0c56f2ffb5a7d19bc956c27f78", "message": "Fix checkstyle", "committedDate": "2020-09-08T22:52:01Z", "type": "commit"}, {"oid": "29caf1fbfa81d5fb705c040fea8170c6317cd025", "url": "https://github.com/Azure/azure-sdk-for-java/commit/29caf1fbfa81d5fb705c040fea8170c6317cd025", "message": "Fix unit test", "committedDate": "2020-09-08T22:52:01Z", "type": "commit"}, {"oid": "29caf1fbfa81d5fb705c040fea8170c6317cd025", "url": "https://github.com/Azure/azure-sdk-for-java/commit/29caf1fbfa81d5fb705c040fea8170c6317cd025", "message": "Fix unit test", "committedDate": "2020-09-08T22:52:01Z", "type": "forcePushed"}, {"oid": "2b71587d8b7d298e193ffd94db10e10953795214", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2b71587d8b7d298e193ffd94db10e10953795214", "message": "Update from API discussions", "committedDate": "2020-09-10T00:21:08Z", "type": "commit"}, {"oid": "aa0235c36e1600af6dca93a305927aa47df34ec8", "url": "https://github.com/Azure/azure-sdk-for-java/commit/aa0235c36e1600af6dca93a305927aa47df34ec8", "message": "Update EventData size estimation", "committedDate": "2020-09-10T00:23:58Z", "type": "commit"}, {"oid": "07347c3b815762de08ce35e8bf4b35eed85fb7c0", "url": "https://github.com/Azure/azure-sdk-for-java/commit/07347c3b815762de08ce35e8bf4b35eed85fb7c0", "message": "Bug fixing", "committedDate": "2020-09-10T06:17:45Z", "type": "commit"}, {"oid": "ea7c1a06ce192e88c9cce03fe80520449ad73fe3", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ea7c1a06ce192e88c9cce03fe80520449ad73fe3", "message": "bug fixing", "committedDate": "2020-09-10T06:27:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQxMDAzMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r486410032", "bodyText": "Not sure how I feel about having this as a system property.  On one hand, it does make some sense semantically, on the other those are typically \"broker owned\" properties that the service controls where sequence number is something the client controls.\nI'm open to suggestion here, though...", "author": "jsquire", "createdAt": "2020-09-10T14:55:07Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventData.java", "diffHunk": "@@ -213,6 +212,22 @@ public Long getSequenceNumber() {\n         return systemProperties.getSequenceNumber();\n     }\n \n+    /**\n+     * Gets the sequence number that was assigned during publishing, if the event was successfully\n+     * published by a sequence-aware producer.  If the producer was not configured to apply\n+     * sequence numbering or if the event has not yet been successfully published, this member\n+     * will be {@code null}.\n+     *\n+     * The published sequence number is only populated and relevant when certain features\n+     * of the producer are enabled. For example, it is used by idempotent publishing.\n+     *\n+     * @return The publishing sequence number assigned to the event at the time it was successfully published.\n+     * {@code null} if the {@link EventData} hasn't been sent or it's sent without idempotent publishing enabled.\n+     */\n+    public Integer getPublishedSequenceNumber() {\n+        return systemProperties.getPublishedSequenceNumber();", "originalCommit": "ea7c1a06ce192e88c9cce03fe80520449ad73fe3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY0MzkwMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r487643903", "bodyText": "As per our discussion with service team, we should put this in system properties.", "author": "YijunXieMS", "createdAt": "2020-09-14T04:23:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQxMDAzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQxMDgzMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r486410830", "bodyText": "Is this too specific?   Rather than tying it to the idempotent producer explicitly, maybe we should consider something like \"requires sequence number\" so that it can be used across features if needed?", "author": "jsquire", "createdAt": "2020-09-10T14:56:10Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventDataBatch.java", "diffHunk": "@@ -58,9 +58,11 @@\n     private final TracerProvider tracerProvider;\n     private final String entityPath;\n     private final String hostname;\n+    private final boolean isCreatedByIdempotentProducer;\n+    private Integer startingPublishedSequenceNumber;\n \n     EventDataBatch(int maxMessageSize, String partitionId, String partitionKey, ErrorContextProvider contextProvider,\n-        TracerProvider tracerProvider, String entityPath, String hostname) {\n+        TracerProvider tracerProvider, String entityPath, String hostname, boolean isCreatedByIdempotentProducer) {", "originalCommit": "ea7c1a06ce192e88c9cce03fe80520449ad73fe3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY0MDk3Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r487640976", "bodyText": "Changed to publishingSequenceNumberRequired. Plus, this constructor is internal.", "author": "YijunXieMS", "createdAt": "2020-09-14T04:09:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQxMDgzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQxNjMwNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r486416307", "bodyText": "Orthogonal to these changes, but this seems a bit different than how .NET does the estimation, which goes back to T1.    Not sure whether it's a concern, just mentioning for awareness:\nhttps://github.com/Azure/azure-sdk-for-net/blob/master/sdk/eventhub/Azure.Messaging.EventHubs/src/Amqp/AmqpEventBatch.cs#L137", "author": "jsquire", "createdAt": "2020-09-10T15:03:29Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventDataBatch.java", "diffHunk": "@@ -182,6 +208,18 @@ private int getSize(final EventData eventData, final boolean isFirst) {\n         Objects.requireNonNull(eventData, \"'eventData' cannot be null.\");\n \n         final Message amqpMessage = createAmqpMessage(eventData, partitionKey);\n+        if (isCreatedByIdempotentProducer) {\n+            // Pre-allocate size for system properties \"com.microsoft:producer-sequence-number\".\n+            // EventData doesn't have this system property until it's added just before an idempotent producer\n+            // sends the EventData out.\n+            final MessageAnnotations messageAnnotations = (amqpMessage.getMessageAnnotations() == null)\n+                ? new MessageAnnotations(new HashMap<>())\n+                : amqpMessage.getMessageAnnotations();\n+            amqpMessage.setMessageAnnotations(messageAnnotations);\n+            messageAnnotations.getValue().put(\n+                Symbol.getSymbol(\n+                    AmqpMessageConstant.PRODUCER_SEQUENCE_NUMBER_ANNOTATION_NAME.getValue()), Integer.MAX_VALUE);\n+        }\n         int eventSize = amqpMessage.encode(this.eventBytes, 0, maxMessageSize); // actual encoded bytes size\n         eventSize += 16; // data section overhead", "originalCommit": "ea7c1a06ce192e88c9cce03fe80520449ad73fe3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzYzNDkxMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r487634911", "bodyText": "Thanks for the feedback on this. I'll follow-up with fellow Java EH developers.", "author": "YijunXieMS", "createdAt": "2020-09-14T03:40:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQxNjMwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQxNzc5NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r486417795", "bodyText": "This is a nice touch.   I should probably think of adding something similar.", "author": "jsquire", "createdAt": "2020-09-10T15:05:25Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/PartitionPublishingState.java", "diffHunk": "@@ -0,0 +1,171 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.messaging.eventhubs;\n+\n+import com.azure.messaging.eventhubs.implementation.PartitionPublishingUtils;\n+\n+import java.util.concurrent.Semaphore;\n+\n+/**\n+ * Store the starting and running state of a partition, which an idempotent producer sends events to.\n+ */\n+public final class PartitionPublishingState {\n+    private Short ownerLevel;\n+    private Long producerGroupId;\n+    private Integer sequenceNumber;\n+\n+    /**\n+     * Indicate whether the state has ever been retrieved from the link, or it's just a pure client created object.\n+     * Once the state is retrieved from the link, this value is always true.\n+     */\n+    private boolean fromLink = false;\n+    // Idempotent producer requires all event data batches of a partition are sent out sequentially.\n+    private final Semaphore sendingSemaphore = new Semaphore(1);\n+\n+    /**\n+     * Create a PartitionPublishingState with producer group id, owner level and starting sequence number\n+     * being {@code null}.\n+     */\n+    PartitionPublishingState() {\n+    }\n+\n+    PartitionPublishingState(PartitionPublishingState that) {\n+        this(that.getProducerGroupId(), that.getOwnerLevel(), that.getSequenceNumber());\n+    }\n+\n+    /**\n+     * Create a PartitionPublishingState with the producer group id, owner level and starting sequence number.\n+     *\n+     * @param producerGroupId See {@link #getProducerGroupId()}}\n+     * @param ownerLevel See {@link #getOwnerLevel()}\n+     * @param sequenceNumber See {@link #getSequenceNumber()} ()}\n+     */\n+    public PartitionPublishingState(Long producerGroupId, Short ownerLevel, Integer sequenceNumber) {\n+        this.ownerLevel = ownerLevel;\n+        this.producerGroupId = producerGroupId;\n+        this.sequenceNumber = sequenceNumber;\n+    }\n+\n+    /**\n+     * Gets the owner level that indicates a publishing is intended to be performed exclusively for events in the\n+     * requested partition in the context of the associated producer group. To do so, publishing will attempt to assert\n+     * ownership over the partition; in the case where more than one publisher in the producer group attempts to assert\n+     * ownership for the same partition, the one having a larger owner level value will \"win\".\n+     *\n+     * When an owner level is specified, other exclusive publishers which have a lower owner level within the context of\n+     * the same producer group will either not be allowed to be created or, if they already exist, will encounter an\n+     * exception during the next attempted operation. Should there be multiple producers in the producer group with the\n+     * same owner level, each of them will be able to publish to the partition.\n+     *\n+     * Producers with no owner level or which belong to a different producer group are permitted to publish to the\n+     * associated partition without restriction or awareness of other exclusive producers.\n+     *\n+     * The owner level is only recognized and relevant when certain features of the producer are enabled. For example,\n+     * it is used by idempotent publishing.\n+     *\n+     * An {@link com.azure.core.amqp.exception.AmqpException} will occur if an {@link EventHubProducerAsyncClient} or\n+     * {@link EventHubProducerClient} is unable to publish events to the\n+     * Event Hub partition for the given producer group id. In this case, the errorCondition of\n+     * {@link com.azure.core.amqp.exception.AmqpException} will be set to\n+     * {@link com.azure.core.amqp.exception.AmqpErrorCondition#PRODUCER_DISCONNECTED}.\n+     *\n+     * @see EventHubClientBuilder#enableIdempotentPartitionPublishing()\n+     *\n+     * @return The relative priority to associate with an exclusive publisher; if {@code null},\n+     * the Event Hubs service will control the value.\n+     */\n+    public Short getOwnerLevel() {\n+        return ownerLevel;\n+    }\n+\n+    /**\n+     * Gets the identifier of the producer group that this producer is associated with when publishing to the\n+     * associated partition. Events will be published in the context of this group.\n+     *\n+     * The producer group is only recognized and relevant when certain features of the producer are enabled.\n+     * For example, it is used by idempotent publishing.\n+     *\n+     * @see EventHubClientBuilder#enableIdempotentPartitionPublishing()\n+     *\n+     * @return The identifier of the producer group to associate with the partition; if {@code null},\n+     * the Event Hubs service will control the value.\n+     */\n+    public Long getProducerGroupId() {\n+        return producerGroupId;\n+    }\n+\n+    /**\n+     * Get the starting number that should be used for the automatic sequencing of events for the associated partition,\n+     * when published by this producer.\n+     *\n+     * The starting sequence number is only recognized and relevant when certain features of the producer are enabled.\n+     * For example, it is used by idempotent publishing.\n+     *\n+     * @see EventHubClientBuilder#enableIdempotentPartitionPublishing()\n+     *\n+     * @return The starting sequence number to associate with the partition; if {@code null},\n+     * the Event Hubs service will control the value.\n+     */\n+    public Integer getSequenceNumber() {\n+        return sequenceNumber;\n+    }\n+\n+    /**\n+     * Set the owner level.\n+     * @param ownerLevel The owner level of the idempotent producer.\n+     */\n+    void setOwnerLevel(Short ownerLevel) {\n+        this.ownerLevel = ownerLevel;\n+    }\n+\n+    /**\n+     * Set the producer group id.\n+     * @param producerGroupId The producer group id of the idempotent producer.\n+     */\n+    void setProducerGroupId(Long producerGroupId) {\n+        this.producerGroupId = producerGroupId;\n+    }\n+\n+    /**\n+     * Set the sequence number.\n+     * @param sequenceNumber The next publishing sequence number of a partition when an idempotent producer send\n+     * an {@link EventData} to.\n+     */\n+    void setSequenceNumber(Integer sequenceNumber) {\n+        this.sequenceNumber = sequenceNumber;\n+    }\n+\n+    void increaseSequenceNumber(int delta) {\n+        this.setSequenceNumber(PartitionPublishingUtils.incrementSequenceNumber(this.sequenceNumber, delta));\n+    }\n+\n+    /**\n+     * An idempotent producer must sequentially send events to an EventHubs partition. This {@link Semaphore}\n+     * is used to send sequentially.\n+     * @return The {@link Semaphore} used to ensure the send to the partition sequentially.\n+     */\n+    Semaphore getSendingSemaphore() {\n+        return sendingSemaphore;\n+    }\n+\n+    /**\n+     * @return whether the state has ever been retrieved from the link, or it's just a pure client created object.\n+     */\n+    boolean isFromLink() {\n+        return fromLink;\n+    }\n+\n+    void setFromLink(boolean fromLink) {\n+        this.fromLink = fromLink;\n+    }\n+\n+    @Override\n+    public String toString() {", "originalCommit": "ea7c1a06ce192e88c9cce03fe80520449ad73fe3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQyMDA0Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r486420047", "bodyText": "Are you actually using this anywhere, or are you just adding some flexibility \"in case\"?", "author": "jsquire", "createdAt": "2020-09-10T15:08:26Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/implementation/PartitionPublishingUtils.java", "diffHunk": "@@ -0,0 +1,32 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.messaging.eventhubs.implementation;\n+\n+/**\n+ * A util class for idempotent producer partition publishing.\n+ */\n+public class PartitionPublishingUtils {\n+    /**\n+     * Increase an int value. If the increased value is over {@link Integer#MAX_VALUE}, restart from 0.\n+     * @param value The number to be incremented.\n+     * @param delta The number is to be incremented by delta.\n+     * @return The incremented value.\n+     */\n+    public static int incrementSequenceNumber(int value, int delta) {", "originalCommit": "ea7c1a06ce192e88c9cce03fe80520449ad73fe3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzYyMzU1MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r487623550", "bodyText": "Yes, when I increase the internal partition state, I use this method.", "author": "YijunXieMS", "createdAt": "2020-09-14T02:45:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQyMDA0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQyMzIwMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r486423201", "bodyText": "That's not part of the design.   This is intended to be exposed by the PartitionPublishingProperties", "author": "jsquire", "createdAt": "2020-09-10T15:12:40Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventHubProducerAsyncClient.java", "diffHunk": "@@ -187,6 +225,32 @@ public String getEventHubName() {\n             .flatMap(node -> node.getPartitionProperties(partitionId));\n     }\n \n+    /**\n+     * Indicate whether this client is an idempotent producer.\n+     * @return Whether this client is an idempotent producer.\n+     */\n+    public boolean isIdempotentProducer() {", "originalCommit": "ea7c1a06ce192e88c9cce03fe80520449ad73fe3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzYzMjk5MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r487632990", "bodyText": "Removed it from EventHubProducerClient. I'm also wondering whether we need this anywhere because a user knows whether a producer is an idempotent producer. And this is a client-side property.", "author": "YijunXieMS", "createdAt": "2020-09-14T03:31:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQyMzIwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQyOTk0Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r486429947", "bodyText": "Forgive my lack of Flux, but in the case where there's a failure state (all retries exhausted), you remove the batch sequence number, each of the event sequence numbers, and don't update state right?", "author": "jsquire", "createdAt": "2020-09-10T15:21:29Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventHubProducerAsyncClient.java", "diffHunk": "@@ -447,18 +516,56 @@ public String getEventHubName() {\n             // Start send span and store updated context\n             parentContext.set(tracerProvider.startSpan(finalSharedContext, ProcessKind.SEND));\n         }\n-\n-        return withRetry(getSendLink(batch.getPartitionId())\n-            .flatMap(link ->\n-                messages.size() == 1\n+        if (this.enableIdempotentPartitions) {\n+            PartitionPublishingState publishingState = this.getClientPartitionPublishingState(batch.getPartitionId());\n+            try {\n+                // Ensure only one EventDataBatch of a partition is being sent at a time.\n+                publishingState.getSendingSemaphore().acquire();\n+            } catch (InterruptedException e) {\n+                return monoError(logger, new RuntimeException(e));\n+            }\n+            return withRetry(\n+                getSendLink(batch.getPartitionId())\n+                .map(link -> {\n+                    int seqNumber = publishingState.getSequenceNumber();\n+                    batch.setStartingPublishedSequenceNumber(seqNumber);\n+                    for (EventData eventData : batch.getEvents()) {\n+                        eventData.getSystemProperties().put(\n+                            AmqpMessageConstant.PRODUCER_SEQUENCE_NUMBER_ANNOTATION_NAME.getValue(),\n+                            seqNumber);\n+                        seqNumber = PartitionPublishingUtils.incrementSequenceNumber(seqNumber);\n+                    }\n+                    return link;\n+                })\n+                .flatMap(link -> messages.size() == 1\n+                    ? link.send(messages.get(0))\n+                    : link.send(messages)),\n+                retryOptions.getTryTimeout(), retryPolicy\n+            ).publishOn(scheduler)\n+                .doOnEach(signal -> {\n+                    if (isTracingEnabled) {\n+                        tracerProvider.endSpan(parentContext.get(), signal);\n+                    }\n+                })\n+                .then(Mono.fromRunnable(() -> {", "originalCommit": "ea7c1a06ce192e88c9cce03fe80520449ad73fe3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzYzMzg1NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r487633854", "bodyText": "Good question. then won't be reached if the send has an error.", "author": "YijunXieMS", "createdAt": "2020-09-14T03:35:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQyOTk0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQzMTY3OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r486431679", "bodyText": "This isn't set until publishing is confirmed as successful, correct?   (we don't want to represent an interim state to callers when the publishing operation is active)", "author": "jsquire", "createdAt": "2020-09-10T15:23:54Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventDataBatch.java", "diffHunk": "@@ -100,6 +108,20 @@ public int getSizeInBytes() {\n         return this.sizeInBytes;\n     }\n \n+    /**\n+     * Gets the sequence number of the first event in the batch, if the batch was successfully\n+     * published by a sequence-aware producer.  If the producer was not configured to apply\n+     * sequence numbering or if the batch has not yet been successfully published, this member\n+     * will be {@code null}.\n+     *\n+     * @return the publishing sequence number assigned to the first event in the batch at the time\n+     * the batch was successfully published. {@code null} if the producer was not configured to apply\n+     * sequence numbering or if the batch has not yet been successfully published.\n+     */\n+    public Integer getStartingPublishedSequenceNumber() {", "originalCommit": "ea7c1a06ce192e88c9cce03fe80520449ad73fe3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzYzNDY1NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r487634655", "bodyText": "Yes, EventDataBatch's startingPublishedSequenceNumber is set only if a send is successful. I updated the code to also update EventData's related properties only when a send is successful.", "author": "YijunXieMS", "createdAt": "2020-09-14T03:39:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQzMTY3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQzMzczNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r486433735", "bodyText": "This isn't set until publishing is confirmed as successful, correct? (we don't want to represent an interim state to callers when the publishing operation is active)", "author": "jsquire", "createdAt": "2020-09-10T15:26:42Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventData.java", "diffHunk": "@@ -213,6 +212,22 @@ public Long getSequenceNumber() {\n         return systemProperties.getSequenceNumber();\n     }\n \n+    /**\n+     * Gets the sequence number that was assigned during publishing, if the event was successfully\n+     * published by a sequence-aware producer.  If the producer was not configured to apply\n+     * sequence numbering or if the event has not yet been successfully published, this member\n+     * will be {@code null}.\n+     *\n+     * The published sequence number is only populated and relevant when certain features\n+     * of the producer are enabled. For example, it is used by idempotent publishing.\n+     *\n+     * @return The publishing sequence number assigned to the event at the time it was successfully published.\n+     * {@code null} if the {@link EventData} hasn't been sent or it's sent without idempotent publishing enabled.\n+     */\n+    public Integer getPublishedSequenceNumber() {", "originalCommit": "ea7c1a06ce192e88c9cce03fe80520449ad73fe3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzYzNDg3OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r487634879", "bodyText": "As of your asking, it's set just before publishing. Changed to set it after publishing is successful.", "author": "YijunXieMS", "createdAt": "2020-09-14T03:40:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQzMzczNQ=="}], "type": "inlineReview"}, {"oid": "71b589a47fdb21ee3ffe29023be7febb0f47a0be", "url": "https://github.com/Azure/azure-sdk-for-java/commit/71b589a47fdb21ee3ffe29023be7febb0f47a0be", "message": "Add idempotent producer error conditions", "committedDate": "2020-09-12T05:40:31Z", "type": "commit"}, {"oid": "577d30e655c0b8631b280d04ee14457106c7dbc6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/577d30e655c0b8631b280d04ee14457106c7dbc6", "message": "Add idempotent producer tests", "committedDate": "2020-09-12T05:42:22Z", "type": "commit"}, {"oid": "9139484aa7f0e382192ea95bbc1e6bab94ec516e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9139484aa7f0e382192ea95bbc1e6bab94ec516e", "message": "bug fixing", "committedDate": "2020-09-12T05:43:19Z", "type": "commit"}, {"oid": "8fbf1056f6b267f0281e8497b2ae91343c50ec44", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8fbf1056f6b267f0281e8497b2ae91343c50ec44", "message": "producer related properties won't be available until events are successfully sent out", "committedDate": "2020-09-13T00:30:45Z", "type": "commit"}, {"oid": "cbdafcb07fcde0e9eb42997c27652b63f019624f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/cbdafcb07fcde0e9eb42997c27652b63f019624f", "message": "Merge branch 'master' into eh_idem_producer", "committedDate": "2020-09-13T00:41:43Z", "type": "commit"}, {"oid": "a0ddcd5b648c9678d4d7675ae3ced16457d453df", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a0ddcd5b648c9678d4d7675ae3ced16457d453df", "message": "Fix merge file error", "committedDate": "2020-09-14T00:58:01Z", "type": "commit"}, {"oid": "9637959251875e467a781277e299b4dbb94c4d71", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9637959251875e467a781277e299b4dbb94c4d71", "message": "Update from api view and PR comments", "committedDate": "2020-09-14T01:28:40Z", "type": "commit"}, {"oid": "c88e7acad1590a105727b189745e87acab48e49f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c88e7acad1590a105727b189745e87acab48e49f", "message": "Change EH version to 5.3.0-beta.1", "committedDate": "2020-09-14T01:39:32Z", "type": "commit"}, {"oid": "bf20f6bf99f4980a707ae806bc2b97b0402b42d5", "url": "https://github.com/Azure/azure-sdk-for-java/commit/bf20f6bf99f4980a707ae806bc2b97b0402b42d5", "message": "Small code refactor", "committedDate": "2020-09-14T04:23:56Z", "type": "commit"}, {"oid": "3db0b6dd662802c91f8149a4b50dcb625bf69ce9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3db0b6dd662802c91f8149a4b50dcb625bf69ce9", "message": "Add PartitionPublishingProperties", "committedDate": "2020-09-15T06:51:35Z", "type": "commit"}, {"oid": "e6c2a24a6723206870ce35844b21f5d47b64752d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e6c2a24a6723206870ce35844b21f5d47b64752d", "message": "Add PartitionPublishingProperties", "committedDate": "2020-09-15T07:26:00Z", "type": "commit"}, {"oid": "7fc2cc4a505cbbecceba7bd35a62e867fa623d74", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7fc2cc4a505cbbecceba7bd35a62e867fa623d74", "message": "Merge branch 'master' into eh_idem_producer", "committedDate": "2020-09-15T21:27:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTAyNjAwNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r489026007", "bodyText": "Can we avoid using synchronized here? See SimpleTokenCache in core for an example.", "author": "srnagar", "createdAt": "2020-09-15T22:22:44Z", "path": "sdk/core/azure-core-amqp/src/main/java/com/azure/core/amqp/implementation/ReactorSender.java", "diffHunk": "@@ -276,6 +278,26 @@ public String getHostname() {\n         }\n     }\n \n+    @Override\n+    public Mono<Map<Symbol, Object>> getRemoteProperties() {\n+        if (this.remoteProperties != null) {\n+            return Mono.just(this.remoteProperties);\n+        }\n+        synchronized (this) {", "originalCommit": "7fc2cc4a505cbbecceba7bd35a62e867fa623d74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgxOTgwOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r489819808", "bodyText": "Changed to use AtomicReference.", "author": "YijunXieMS", "createdAt": "2020-09-17T00:07:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTAyNjAwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTAyNzIzNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r489027237", "bodyText": "Update the tag to use the unreleased dependency.", "author": "srnagar", "createdAt": "2020-09-15T22:24:25Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/pom.xml", "diffHunk": "@@ -42,7 +42,7 @@\n     <dependency>\n       <groupId>com.azure</groupId>\n       <artifactId>azure-core-amqp</artifactId>\n-      <version>1.5.1</version> <!-- {x-version-update;com.azure:azure-core-amqp;dependency} -->\n+      <version>1.6.0-beta.1</version> <!-- {x-version-update;com.azure:azure-core-amqp;dependency} -->", "originalCommit": "7fc2cc4a505cbbecceba7bd35a62e867fa623d74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTYzMzY3Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r489633677", "bodyText": "Updated", "author": "YijunXieMS", "createdAt": "2020-09-16T18:22:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTAyNzIzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTAyODY5OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r489028699", "bodyText": "Will this group id be different for each event?", "author": "srnagar", "createdAt": "2020-09-15T22:26:24Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventData.java", "diffHunk": "@@ -213,6 +219,80 @@ public Long getSequenceNumber() {\n         return systemProperties.getSequenceNumber();\n     }\n \n+    /**\n+     * Gets the producer sequence number that was assigned during publishing, if the event was successfully\n+     * published by a sequence-aware producer.  If the producer was not configured to apply\n+     * sequence numbering or if the event has not yet been successfully published, this member\n+     * will be {@code null}.\n+     *\n+     * The published sequence number is only populated and relevant when certain features\n+     * of the producer are enabled. For example, it is used by idempotent publishing.\n+     *\n+     * @return The publishing sequence number assigned to the event at the time it was successfully published.\n+     * {@code null} if the {@link EventData} hasn't been sent or it's sent without idempotent publishing enabled.\n+     */\n+    public Integer getPublishedSequenceNumber() {\n+        return publishedSequenceNumber;\n+    }\n+\n+    /**\n+     * Gets the producer group id that was assigned during publishing, if the event was successfully\n+     * published by a sequence-aware producer.  If the producer was not configured to apply\n+     * sequence numbering or if the event has not yet been successfully published, this member\n+     * will be {@code null}.\n+     *\n+     * The producer group id is only populated and relevant when certain features\n+     * of the producer are enabled. For example, it is used by idempotent publishing.\n+     *\n+     * @return The producer group id assigned to the event at the time it was successfully published.\n+     * {@code null} if the {@link EventData} hasn't been sent or it's sent without idempotent publishing enabled.\n+     */\n+    public Long getPublishedGroupId() {", "originalCommit": "7fc2cc4a505cbbecceba7bd35a62e867fa623d74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTYzODMwOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r489638308", "bodyText": "group id and owner level are the same for all events sent from a client. But across clients, they can be different.", "author": "YijunXieMS", "createdAt": "2020-09-16T18:27:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTAyODY5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAwNzg3Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r493007872", "bodyText": "If it's a property of a client, then should it be on EventData?", "author": "srnagar", "createdAt": "2020-09-22T20:18:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTAyODY5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTAyOTMwOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r489029308", "bodyText": "I am not sure why event data should contain the owner level information.", "author": "srnagar", "createdAt": "2020-09-15T22:27:16Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventData.java", "diffHunk": "@@ -213,6 +219,80 @@ public Long getSequenceNumber() {\n         return systemProperties.getSequenceNumber();\n     }\n \n+    /**\n+     * Gets the producer sequence number that was assigned during publishing, if the event was successfully\n+     * published by a sequence-aware producer.  If the producer was not configured to apply\n+     * sequence numbering or if the event has not yet been successfully published, this member\n+     * will be {@code null}.\n+     *\n+     * The published sequence number is only populated and relevant when certain features\n+     * of the producer are enabled. For example, it is used by idempotent publishing.\n+     *\n+     * @return The publishing sequence number assigned to the event at the time it was successfully published.\n+     * {@code null} if the {@link EventData} hasn't been sent or it's sent without idempotent publishing enabled.\n+     */\n+    public Integer getPublishedSequenceNumber() {\n+        return publishedSequenceNumber;\n+    }\n+\n+    /**\n+     * Gets the producer group id that was assigned during publishing, if the event was successfully\n+     * published by a sequence-aware producer.  If the producer was not configured to apply\n+     * sequence numbering or if the event has not yet been successfully published, this member\n+     * will be {@code null}.\n+     *\n+     * The producer group id is only populated and relevant when certain features\n+     * of the producer are enabled. For example, it is used by idempotent publishing.\n+     *\n+     * @return The producer group id assigned to the event at the time it was successfully published.\n+     * {@code null} if the {@link EventData} hasn't been sent or it's sent without idempotent publishing enabled.\n+     */\n+    public Long getPublishedGroupId() {\n+        return publishedGroupId;\n+    }\n+\n+    /**\n+     * Gets the producer owner level that was assigned during publishing, if the event was successfully\n+     * published by a sequence-aware producer.  If the producer was not configured to apply\n+     * sequence numbering or if the event has not yet been successfully published, this member\n+     * will be {@code null}.\n+     *\n+     * The producer owner level is only populated and relevant when certain features\n+     * of the producer are enabled. For example, it is used by idempotent publishing.\n+     *\n+     * @return The producer owner level assigned to the event at the time it was successfully published.\n+     * {@code null} if the {@link EventData} hasn't been sent or it's sent without idempotent publishing enabled.\n+     */\n+    public Short getPublishedOwnerLevel() {", "originalCommit": "7fc2cc4a505cbbecceba7bd35a62e867fa623d74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTY1MDYwOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r489650608", "bodyText": "published group id and published owner level are required to be set in the system properties (message annotation) of an EventData to be sent to the event hub service. But before the send is successful, we don't expose them. After send, they're exposed. A received event data also has them in the system properties if the event data is sent by an idempotent producer. So they're exposed to the users for reference, at least good for debugging.", "author": "YijunXieMS", "createdAt": "2020-09-16T18:38:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTAyOTMwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAwODk2NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r493008965", "bodyText": "Can this be package-private for now to send the message and if customers need this information, make it public?", "author": "srnagar", "createdAt": "2020-09-22T20:20:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTAyOTMwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA0MDg2MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r489040861", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public EventHubClientBuilder idempotentPartitionPublishing() {\n          \n          \n            \n                public EventHubClientBuilder enableIdempotentPartitionPublishing() {", "author": "srnagar", "createdAt": "2020-09-15T22:42:25Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventHubClientBuilder.java", "diffHunk": "@@ -372,6 +378,51 @@ public EventHubClientBuilder prefetchCount(int prefetchCount) {\n         return this;\n     }\n \n+    /**\n+     * Enables idempotent publishing when an {@link EventHubProducerAsyncClient} or {@link EventHubProducerClient}\n+     * is built.\n+     *\n+     * If enabled, the producer will only be able to publish directly to partitions; it will not be able to publish to\n+     * the Event Hubs gateway for automatic partition routing nor using a partition key.\n+     *\n+     * @return The updated {@link EventHubClientBuilder} object.\n+     */\n+    public EventHubClientBuilder idempotentPartitionPublishing() {", "originalCommit": "7fc2cc4a505cbbecceba7bd35a62e867fa623d74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgyMDE5Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r489820193", "bodyText": "Changed to enableIdempotentPartitionPublishing for this preview. Let's discuss later what's the best way for boolean value in builders.", "author": "YijunXieMS", "createdAt": "2020-09-17T00:09:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA0MDg2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA0MjQ4OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r489042489", "bodyText": "If this method is called twice - first time with a non-null map and second time with null map, then the 2nd call is a no-op and the builder will still use the first map which is not what the user would have expected. If the map is null, this builder's map should also be set to null.", "author": "srnagar", "createdAt": "2020-09-15T22:44:39Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventHubClientBuilder.java", "diffHunk": "@@ -372,6 +378,51 @@ public EventHubClientBuilder prefetchCount(int prefetchCount) {\n         return this;\n     }\n \n+    /**\n+     * Enables idempotent publishing when an {@link EventHubProducerAsyncClient} or {@link EventHubProducerClient}\n+     * is built.\n+     *\n+     * If enabled, the producer will only be able to publish directly to partitions; it will not be able to publish to\n+     * the Event Hubs gateway for automatic partition routing nor using a partition key.\n+     *\n+     * @return The updated {@link EventHubClientBuilder} object.\n+     */\n+    public EventHubClientBuilder idempotentPartitionPublishing() {\n+        this.idempotentPartitionPublishing = true;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the idempotent publishing options to {@link EventHubProducerAsyncClient} or {@link EventHubProducerClient}\n+     * when you build them.\n+     *\n+     * The set of options that can be specified to influence publishing behavior specific to the configured Event Hub\n+     * partition.\n+     * These options are not necessary in the majority of scenarios and are intended for use with specialized scenarios,\n+     * such as when recovering the state used for idempotent publishing.\n+     *\n+     * It is highly recommended that these options only be specified if there is a proven need to do so; Incorrectly\n+     * configuring these values may result in the built {@link EventHubProducerAsyncClient} or\n+     * {@link EventHubProducerClient} instance unable to publish to the Event Hubs.\n+     *\n+     * These options are ignored when publishing to the Event Hubs gateway for automatic routing or when using a\n+     * partition key.\n+     *\n+     * @param states A {@link Map} of {@link PartitionPublishingState} for each partition. The keys of the map\n+     * are the partition ids.\n+     * @return The updated {@link EventHubClientBuilder} object.\n+     */\n+    public EventHubClientBuilder initialPartitionPublishingStates(Map<String,\n+        PartitionPublishingProperties> states) {\n+        if (states != null) {", "originalCommit": "7fc2cc4a505cbbecceba7bd35a62e867fa623d74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTY1Nzg3Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r489657872", "bodyText": "Good point. Added\nelse {\n   this.initialPartitionPublishingStates = null;\n}", "author": "YijunXieMS", "createdAt": "2020-09-16T18:45:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA0MjQ4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA0NTE2NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r489045165", "bodyText": "Use Mono.defer() instead to wait until the user subscribes to call publishingState.toPartitionPublishingProperties().", "author": "srnagar", "createdAt": "2020-09-15T22:48:09Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventHubProducerAsyncClient.java", "diffHunk": "@@ -187,6 +225,43 @@ public String getEventHubName() {\n             .flatMap(node -> node.getPartitionProperties(partitionId));\n     }\n \n+    /**\n+     * Get the idempotent producer's publishing state of a partition.\n+     * @param partitionId The partition id of the publishing state\n+     * @return A mono that has the {@link PartitionPublishingProperties}.\n+     * {@code null} if the partition doesn't have any state yet.\n+     * @throws UnsupportedOperationException if this producer isn't an idempotent producer.\n+     */\n+    Mono<PartitionPublishingProperties> getPartitionPublishingProperties(String partitionId) {\n+        PartitionPublishingState publishingState = getClientPartitionPublishingState(partitionId);\n+        if (publishingState.isFromLink()) {\n+            return Mono.just(publishingState.toPartitionPublishingProperties());", "originalCommit": "7fc2cc4a505cbbecceba7bd35a62e867fa623d74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgyMDg3Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r489820876", "bodyText": "Fixed", "author": "YijunXieMS", "createdAt": "2020-09-17T00:11:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA0NTE2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA0NjAzNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r489046035", "bodyText": "All of this should be wrapped in Mono.defer().", "author": "srnagar", "createdAt": "2020-09-15T22:49:17Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventHubProducerAsyncClient.java", "diffHunk": "@@ -187,6 +225,43 @@ public String getEventHubName() {\n             .flatMap(node -> node.getPartitionProperties(partitionId));\n     }\n \n+    /**\n+     * Get the idempotent producer's publishing state of a partition.\n+     * @param partitionId The partition id of the publishing state\n+     * @return A mono that has the {@link PartitionPublishingProperties}.\n+     * {@code null} if the partition doesn't have any state yet.\n+     * @throws UnsupportedOperationException if this producer isn't an idempotent producer.\n+     */\n+    Mono<PartitionPublishingProperties> getPartitionPublishingProperties(String partitionId) {\n+        PartitionPublishingState publishingState = getClientPartitionPublishingState(partitionId);\n+        if (publishingState.isFromLink()) {\n+            return Mono.just(publishingState.toPartitionPublishingProperties());\n+        } else {\n+            return withRetry(this.getSendLink(partitionId).flatMap(amqpSendLink ->\n+                    Mono.just(this.getClientPartitionPublishingState(partitionId))),\n+                retryOptions.getTryTimeout(), retryPolicy).map(\n+                    PartitionPublishingState::toPartitionPublishingProperties);\n+        }\n+    }\n+\n+    /**\n+     * Get the idempotent producer's publishing state of a partition.\n+     * @param partitionId The partition id of the publishing state\n+     * @return A mono that has the {@link PartitionPublishingState}.\n+     * {@code null} if the partition doesn't have any state yet.\n+     * @throws UnsupportedOperationException if this producer isn't an idempotent producer.\n+     */\n+    Mono<PartitionPublishingState> getPartitionPublishingState(String partitionId) {\n+        PartitionPublishingState publishingState = getClientPartitionPublishingState(partitionId);", "originalCommit": "7fc2cc4a505cbbecceba7bd35a62e867fa623d74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgyMDg4OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r489820889", "bodyText": "Fixed", "author": "YijunXieMS", "createdAt": "2020-09-17T00:11:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA0NjAzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkwMTYyOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r488901629", "bodyText": "I wonder if this will be easier to reason about if we use an AtomicReference rather than volatile.", "author": "conniey", "createdAt": "2020-09-15T19:05:25Z", "path": "sdk/core/azure-core-amqp/src/main/java/com/azure/core/amqp/implementation/ReactorSender.java", "diffHunk": "@@ -276,6 +278,26 @@ public String getHostname() {\n         }\n     }\n \n+    @Override\n+    public Mono<Map<Symbol, Object>> getRemoteProperties() {\n+        if (this.remoteProperties != null) {", "originalCommit": "e6c2a24a6723206870ce35844b21f5d47b64752d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgyMDk4OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r489820989", "bodyText": "Changed to AtomicReference", "author": "YijunXieMS", "createdAt": "2020-09-17T00:11:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkwMTYyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkwMzUzOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r488903538", "bodyText": "I have it not to align the parameter names.", "author": "conniey", "createdAt": "2020-09-15T19:08:56Z", "path": "sdk/core/azure-core-amqp/src/main/java/com/azure/core/amqp/implementation/ReactorSession.java", "diffHunk": "@@ -463,11 +464,16 @@ protected ReactorReceiver createConsumer(String entityPath, Receiver receiver,\n             }));\n     }\n \n+    protected Mono<AmqpLink> createProducer(String linkName, String entityPath, Duration timeout,\n+                                            AmqpRetryPolicy retry, Map<Symbol, Object> linkProperties) {", "originalCommit": "e6c2a24a6723206870ce35844b21f5d47b64752d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgyMTM5Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r489821392", "bodyText": "All these alignment things are related to too long lines and my IDE setting for multiple line alignment. Manually adjusted the indentation and correctly set my IDE. Thanks.", "author": "YijunXieMS", "createdAt": "2020-09-17T00:13:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkwMzUzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkwMzY4MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r488903680", "bodyText": "Is there a reason we realigned it this way?", "author": "conniey", "createdAt": "2020-09-15T19:09:13Z", "path": "sdk/core/azure-core-amqp/src/main/java/com/azure/core/amqp/implementation/ReactorSession.java", "diffHunk": "@@ -463,11 +464,16 @@ protected ReactorReceiver createConsumer(String entityPath, Receiver receiver,\n             }));\n     }\n \n+    protected Mono<AmqpLink> createProducer(String linkName, String entityPath, Duration timeout,\n+                                            AmqpRetryPolicy retry, Map<Symbol, Object> linkProperties) {\n+        return this.createProducer(linkName, entityPath, timeout, retry, linkProperties, null);\n+    }\n     /**\n      * NOTE: Ensure this is invoked using the reactor dispatcher because proton-j is not thread-safe.\n      */\n-    private LinkSubscription<AmqpSendLink> getSubscription(String linkName, String entityPath,\n-        Map<Symbol, Object> linkProperties, Duration timeout, AmqpRetryPolicy retry, TokenManager tokenManager) {\n+    private LinkSubscription<AmqpSendLink> getSubscription(\n+        String linkName, String entityPath, Map<Symbol, Object> linkProperties, Symbol[] senderDesiredCapabilities,", "originalCommit": "e6c2a24a6723206870ce35844b21f5d47b64752d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgyMTUxNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r489821516", "bodyText": "Updated", "author": "YijunXieMS", "createdAt": "2020-09-17T00:13:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkwMzY4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkzOTE0Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r488939142", "bodyText": "There was a reason for this. If you follow the logic, we do some conversions on it to make it the correct type then add it back.", "author": "conniey", "createdAt": "2020-09-15T20:00:44Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventData.java", "diffHunk": "@@ -307,6 +387,9 @@ public EventData addContext(String key, Object value) {\n             }\n             this.sequenceNumber = sequenceNumber;\n             put(SEQUENCE_NUMBER_ANNOTATION_NAME.getValue(), this.sequenceNumber);\n+\n+            // TODO: confirm with Connie why we remove a value from this SystemProperty and then add it back?", "originalCommit": "e6c2a24a6723206870ce35844b21f5d47b64752d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgyMjA1NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r489822055", "bodyText": "Thanks for the clarification. Deleted this TODO.", "author": "YijunXieMS", "createdAt": "2020-09-17T00:15:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkzOTE0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk0MDg1Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r488940857", "bodyText": "We don't need to specify this is internal, the method is package-private.", "author": "conniey", "createdAt": "2020-09-15T20:04:01Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventData.java", "diffHunk": "@@ -213,6 +219,80 @@ public Long getSequenceNumber() {\n         return systemProperties.getSequenceNumber();\n     }\n \n+    /**\n+     * Gets the producer sequence number that was assigned during publishing, if the event was successfully\n+     * published by a sequence-aware producer.  If the producer was not configured to apply\n+     * sequence numbering or if the event has not yet been successfully published, this member\n+     * will be {@code null}.\n+     *\n+     * The published sequence number is only populated and relevant when certain features\n+     * of the producer are enabled. For example, it is used by idempotent publishing.\n+     *\n+     * @return The publishing sequence number assigned to the event at the time it was successfully published.\n+     * {@code null} if the {@link EventData} hasn't been sent or it's sent without idempotent publishing enabled.\n+     */\n+    public Integer getPublishedSequenceNumber() {\n+        return publishedSequenceNumber;\n+    }\n+\n+    /**\n+     * Gets the producer group id that was assigned during publishing, if the event was successfully\n+     * published by a sequence-aware producer.  If the producer was not configured to apply\n+     * sequence numbering or if the event has not yet been successfully published, this member\n+     * will be {@code null}.\n+     *\n+     * The producer group id is only populated and relevant when certain features\n+     * of the producer are enabled. For example, it is used by idempotent publishing.\n+     *\n+     * @return The producer group id assigned to the event at the time it was successfully published.\n+     * {@code null} if the {@link EventData} hasn't been sent or it's sent without idempotent publishing enabled.\n+     */\n+    public Long getPublishedGroupId() {\n+        return publishedGroupId;\n+    }\n+\n+    /**\n+     * Gets the producer owner level that was assigned during publishing, if the event was successfully\n+     * published by a sequence-aware producer.  If the producer was not configured to apply\n+     * sequence numbering or if the event has not yet been successfully published, this member\n+     * will be {@code null}.\n+     *\n+     * The producer owner level is only populated and relevant when certain features\n+     * of the producer are enabled. For example, it is used by idempotent publishing.\n+     *\n+     * @return The producer owner level assigned to the event at the time it was successfully published.\n+     * {@code null} if the {@link EventData} hasn't been sent or it's sent without idempotent publishing enabled.\n+     */\n+    public Short getPublishedOwnerLevel() {\n+        return publishedOwnerLevel;\n+    }\n+\n+    void setInternalProducerGroupId(Long internalProducerGroupId) {", "originalCommit": "e6c2a24a6723206870ce35844b21f5d47b64752d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgyNTIzMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r489825231", "bodyText": "It actually means to set the producer group id in system properties but the user can't get it from anywhere. getProducerGroupId will return null.\nAfter this event data is sent, the internal data will be surfaced via  getProducerGroupId.\nSince this method name is confusing, I changed it to a more meaningful name setProducerGroupIdInSysProperties", "author": "YijunXieMS", "createdAt": "2020-09-17T00:28:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk0MDg1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTEwODc5Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r489108797", "bodyText": "isPublishingSequenceNumberRequired?", "author": "conniey", "createdAt": "2020-09-16T01:32:36Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventDataBatch.java", "diffHunk": "@@ -58,9 +58,11 @@\n     private final TracerProvider tracerProvider;\n     private final String entityPath;\n     private final String hostname;\n+    private final boolean publishingSequenceNumberRequired;\n+    private Integer startingPublishedSequenceNumber;\n \n     EventDataBatch(int maxMessageSize, String partitionId, String partitionKey, ErrorContextProvider contextProvider,\n-        TracerProvider tracerProvider, String entityPath, String hostname) {\n+        TracerProvider tracerProvider, String entityPath, String hostname, boolean publishingSequenceNumberRequired) {", "originalCommit": "7fc2cc4a505cbbecceba7bd35a62e867fa623d74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgyNTg1NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r489825854", "bodyText": "Changed to it.", "author": "YijunXieMS", "createdAt": "2020-09-17T00:30:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTEwODc5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTEwOTA5NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r489109095", "bodyText": "I'm not sure why the arguments are moved to the next line.", "author": "conniey", "createdAt": "2020-09-16T01:33:49Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventHubAsyncClient.java", "diffHunk": "@@ -32,9 +34,13 @@\n     private final boolean isSharedConnection;\n     private final Runnable onClientClose;\n     private final TracerProvider tracerProvider;\n+    private final boolean enableIdempotentPartitions;\n+    private final Map<String, PartitionPublishingState> initialPartitionPublishingStates;\n \n-    EventHubAsyncClient(EventHubConnectionProcessor connectionProcessor, TracerProvider tracerProvider,\n-        MessageSerializer messageSerializer, Scheduler scheduler, boolean isSharedConnection, Runnable onClientClose) {\n+    EventHubAsyncClient(\n+        EventHubConnectionProcessor connectionProcessor, TracerProvider tracerProvider,", "originalCommit": "7fc2cc4a505cbbecceba7bd35a62e867fa623d74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgyNTg5OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r489825899", "bodyText": "Updated.", "author": "YijunXieMS", "createdAt": "2020-09-17T00:30:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTEwOTA5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTEwOTIwMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r489109200", "bodyText": "Can we put the entire argument on the next line rather than splitting the map here?", "author": "conniey", "createdAt": "2020-09-16T01:34:18Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventHubClientBuilder.java", "diffHunk": "@@ -372,6 +378,51 @@ public EventHubClientBuilder prefetchCount(int prefetchCount) {\n         return this;\n     }\n \n+    /**\n+     * Enables idempotent publishing when an {@link EventHubProducerAsyncClient} or {@link EventHubProducerClient}\n+     * is built.\n+     *\n+     * If enabled, the producer will only be able to publish directly to partitions; it will not be able to publish to\n+     * the Event Hubs gateway for automatic partition routing nor using a partition key.\n+     *\n+     * @return The updated {@link EventHubClientBuilder} object.\n+     */\n+    public EventHubClientBuilder idempotentPartitionPublishing() {\n+        this.idempotentPartitionPublishing = true;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the idempotent publishing options to {@link EventHubProducerAsyncClient} or {@link EventHubProducerClient}\n+     * when you build them.\n+     *\n+     * The set of options that can be specified to influence publishing behavior specific to the configured Event Hub\n+     * partition.\n+     * These options are not necessary in the majority of scenarios and are intended for use with specialized scenarios,\n+     * such as when recovering the state used for idempotent publishing.\n+     *\n+     * It is highly recommended that these options only be specified if there is a proven need to do so; Incorrectly\n+     * configuring these values may result in the built {@link EventHubProducerAsyncClient} or\n+     * {@link EventHubProducerClient} instance unable to publish to the Event Hubs.\n+     *\n+     * These options are ignored when publishing to the Event Hubs gateway for automatic routing or when using a\n+     * partition key.\n+     *\n+     * @param states A {@link Map} of {@link PartitionPublishingState} for each partition. The keys of the map\n+     * are the partition ids.\n+     * @return The updated {@link EventHubClientBuilder} object.\n+     */\n+    public EventHubClientBuilder initialPartitionPublishingStates(Map<String,\n+        PartitionPublishingProperties> states) {", "originalCommit": "7fc2cc4a505cbbecceba7bd35a62e867fa623d74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgyNjA4OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r489826089", "bodyText": "Updated. I forget what happened on me to make it two lines ;-)", "author": "YijunXieMS", "createdAt": "2020-09-17T00:31:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTEwOTIwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTEwOTY0NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r489109644", "bodyText": "Is it possible to use Collections.unmodifiableMap to show that we don't want people adding random things to this?", "author": "conniey", "createdAt": "2020-09-16T01:35:47Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventHubClientBuilder.java", "diffHunk": "@@ -372,6 +378,51 @@ public EventHubClientBuilder prefetchCount(int prefetchCount) {\n         return this;\n     }\n \n+    /**\n+     * Enables idempotent publishing when an {@link EventHubProducerAsyncClient} or {@link EventHubProducerClient}\n+     * is built.\n+     *\n+     * If enabled, the producer will only be able to publish directly to partitions; it will not be able to publish to\n+     * the Event Hubs gateway for automatic partition routing nor using a partition key.\n+     *\n+     * @return The updated {@link EventHubClientBuilder} object.\n+     */\n+    public EventHubClientBuilder idempotentPartitionPublishing() {\n+        this.idempotentPartitionPublishing = true;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the idempotent publishing options to {@link EventHubProducerAsyncClient} or {@link EventHubProducerClient}\n+     * when you build them.\n+     *\n+     * The set of options that can be specified to influence publishing behavior specific to the configured Event Hub\n+     * partition.\n+     * These options are not necessary in the majority of scenarios and are intended for use with specialized scenarios,\n+     * such as when recovering the state used for idempotent publishing.\n+     *\n+     * It is highly recommended that these options only be specified if there is a proven need to do so; Incorrectly\n+     * configuring these values may result in the built {@link EventHubProducerAsyncClient} or\n+     * {@link EventHubProducerClient} instance unable to publish to the Event Hubs.\n+     *\n+     * These options are ignored when publishing to the Event Hubs gateway for automatic routing or when using a\n+     * partition key.\n+     *\n+     * @param states A {@link Map} of {@link PartitionPublishingState} for each partition. The keys of the map\n+     * are the partition ids.\n+     * @return The updated {@link EventHubClientBuilder} object.\n+     */\n+    public EventHubClientBuilder initialPartitionPublishingStates(Map<String,\n+        PartitionPublishingProperties> states) {\n+        if (states != null) {\n+            this.initialPartitionPublishingStates = new HashMap<>();", "originalCommit": "7fc2cc4a505cbbecceba7bd35a62e867fa623d74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgyNjMwOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r489826309", "bodyText": "Added it. This map isn't exposed to users though.", "author": "YijunXieMS", "createdAt": "2020-09-17T00:31:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTEwOTY0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTExMDIyMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r489110221", "bodyText": "I think this is used in multiple places, iirc we have a constants class we can put these in and make them package-private?", "author": "conniey", "createdAt": "2020-09-16T01:37:57Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/implementation/EventHubReactorSession.java", "diffHunk": "@@ -43,6 +45,15 @@\n     private static final Symbol ENABLE_RECEIVER_RUNTIME_METRIC_NAME =\n         Symbol.valueOf(VENDOR + \":enable-receiver-runtime-metric\");\n \n+    private static final Symbol PRODUCER_EPOCH = Symbol.valueOf(", "originalCommit": "7fc2cc4a505cbbecceba7bd35a62e867fa623d74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgyNjQ1MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r489826451", "bodyText": "Moved the constants to class SymbolConstants.", "author": "YijunXieMS", "createdAt": "2020-09-17T00:32:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTExMDIyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTExMDI5OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r489110298", "bodyText": "I think it's weird we have a new line before arguments. We should be consistent here.", "author": "conniey", "createdAt": "2020-09-16T01:38:15Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/implementation/EventHubReactorSession.java", "diffHunk": "@@ -68,6 +79,32 @@\n             messageSerializer, openTimeout, retryPolicy);\n     }\n \n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public Mono<AmqpSendLink> createProducer(\n+        String linkName, String entityPath, Duration timeout, AmqpRetryPolicy retry,", "originalCommit": "7fc2cc4a505cbbecceba7bd35a62e867fa623d74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgyNjQ5Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r489826496", "bodyText": "Updated.", "author": "YijunXieMS", "createdAt": "2020-09-17T00:32:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTExMDI5OA=="}], "type": "inlineReview"}, {"oid": "d5effee6faace0a55f5957e4c98139abbd2bb394", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d5effee6faace0a55f5957e4c98139abbd2bb394", "message": "Unreleased azure-core-amqp", "committedDate": "2020-09-16T03:48:14Z", "type": "commit"}, {"oid": "837ef255b4e8757ad33c3418dde6811d86743be0", "url": "https://github.com/Azure/azure-sdk-for-java/commit/837ef255b4e8757ad33c3418dde6811d86743be0", "message": "Unreleased azure-messaging-eventhubs", "committedDate": "2020-09-16T04:09:12Z", "type": "commit"}, {"oid": "761dba839eea71d6a41e15aa39910eed12f2fe8f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/761dba839eea71d6a41e15aa39910eed12f2fe8f", "message": "Use azure-core-amqp unreleased tag in pom.xml", "committedDate": "2020-09-16T17:25:12Z", "type": "commit"}, {"oid": "b596e144103b80cd65aa3ab7cc3139b019781b4f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b596e144103b80cd65aa3ab7cc3139b019781b4f", "message": "Update for review comments", "committedDate": "2020-09-16T23:59:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUwNDE1Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r490504152", "bodyText": "We don't need an atomic reference for this? The getEndpointStates() is a replayable Flux, and replays the last cached value... by then, the sender.getRemoteProperties() will be populated. Returning as-is is fine.", "author": "conniey", "createdAt": "2020-09-17T19:26:55Z", "path": "sdk/core/azure-core-amqp/src/main/java/com/azure/core/amqp/implementation/ReactorSender.java", "diffHunk": "@@ -276,6 +279,16 @@ public String getHostname() {\n         }\n     }\n \n+    @Override\n+    public Mono<Map<Symbol, Object>> getRemoteProperties() {\n+        this.remotePropertiesReference.compareAndSet(null, RetryUtil.withRetry(", "originalCommit": "b596e144103b80cd65aa3ab7cc3139b019781b4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYyODA4NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r490628084", "bodyText": "Removed AtomicReference", "author": "YijunXieMS", "createdAt": "2020-09-18T00:09:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUwNDE1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUwODE4NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r490508184", "bodyText": "I don't think we need \"internal\" as a parameter property name. Same with other ones above and below.", "author": "conniey", "createdAt": "2020-09-17T19:30:50Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventData.java", "diffHunk": "@@ -213,6 +219,80 @@ public Long getSequenceNumber() {\n         return systemProperties.getSequenceNumber();\n     }\n \n+    /**\n+     * Gets the producer sequence number that was assigned during publishing, if the event was successfully\n+     * published by a sequence-aware producer.  If the producer was not configured to apply\n+     * sequence numbering or if the event has not yet been successfully published, this member\n+     * will be {@code null}.\n+     *\n+     * The published sequence number is only populated and relevant when certain features\n+     * of the producer are enabled. For example, it is used by idempotent publishing.\n+     *\n+     * @return The publishing sequence number assigned to the event at the time it was successfully published.\n+     * {@code null} if the {@link EventData} hasn't been sent or it's sent without idempotent publishing enabled.\n+     */\n+    public Integer getPublishedSequenceNumber() {\n+        return publishedSequenceNumber;\n+    }\n+\n+    /**\n+     * Gets the producer group id that was assigned during publishing, if the event was successfully\n+     * published by a sequence-aware producer.  If the producer was not configured to apply\n+     * sequence numbering or if the event has not yet been successfully published, this member\n+     * will be {@code null}.\n+     *\n+     * The producer group id is only populated and relevant when certain features\n+     * of the producer are enabled. For example, it is used by idempotent publishing.\n+     *\n+     * @return The producer group id assigned to the event at the time it was successfully published.\n+     * {@code null} if the {@link EventData} hasn't been sent or it's sent without idempotent publishing enabled.\n+     */\n+    public Long getPublishedGroupId() {\n+        return publishedGroupId;\n+    }\n+\n+    /**\n+     * Gets the producer owner level that was assigned during publishing, if the event was successfully\n+     * published by a sequence-aware producer.  If the producer was not configured to apply\n+     * sequence numbering or if the event has not yet been successfully published, this member\n+     * will be {@code null}.\n+     *\n+     * The producer owner level is only populated and relevant when certain features\n+     * of the producer are enabled. For example, it is used by idempotent publishing.\n+     *\n+     * @return The producer owner level assigned to the event at the time it was successfully published.\n+     * {@code null} if the {@link EventData} hasn't been sent or it's sent without idempotent publishing enabled.\n+     */\n+    public Short getPublishedOwnerLevel() {\n+        return publishedOwnerLevel;\n+    }\n+\n+    void setProducerGroupIdInSysProperties(Long internalProducerGroupId) {\n+        this.getSystemProperties().put(\n+            AmqpMessageConstant.PRODUCER_ID_ANNOTATION_NAME.getValue(),\n+            internalProducerGroupId\n+        );\n+    }\n+\n+    void setProducerOwnerLevelInSysProperties(Short internalProducerOwnerLevel) {", "originalCommit": "b596e144103b80cd65aa3ab7cc3139b019781b4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYyODMyOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r490628328", "bodyText": "Yeah, I changed the method names but not the param names \ud83d\udc4e", "author": "YijunXieMS", "createdAt": "2020-09-18T00:10:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUwODE4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUwOTYzMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r490509633", "bodyText": "We should have created an internal options bag before.. but it might be worthwhile because as we add to the constructor, it'll break existing classes.\nEventHubAsyncClientOptions or something that has all these optional things (ie. isSharedConnection, isIdempotent, etc)", "author": "conniey", "createdAt": "2020-09-17T19:32:22Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventHubAsyncClient.java", "diffHunk": "@@ -32,9 +34,13 @@\n     private final boolean isSharedConnection;\n     private final Runnable onClientClose;\n     private final TracerProvider tracerProvider;\n+    private final boolean isIdempotentPartitionPublishing;\n+    private final Map<String, PartitionPublishingState> initialPartitionPublishingStates;\n \n     EventHubAsyncClient(EventHubConnectionProcessor connectionProcessor, TracerProvider tracerProvider,\n-        MessageSerializer messageSerializer, Scheduler scheduler, boolean isSharedConnection, Runnable onClientClose) {\n+        MessageSerializer messageSerializer, Scheduler scheduler, boolean isSharedConnection, Runnable onClientClose,", "originalCommit": "b596e144103b80cd65aa3ab7cc3139b019781b4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYyOTIzMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r490629230", "bodyText": "I'd like to create an issue to do this internal refactor separately but not in this PR.", "author": "YijunXieMS", "createdAt": "2020-09-18T00:13:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUwOTYzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUxMDU3NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r490510575", "bodyText": "Same with using options for the constructor.", "author": "conniey", "createdAt": "2020-09-17T19:33:16Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventHubProducerAsyncClient.java", "diffHunk": "@@ -132,6 +141,25 @@\n         this.retryPolicy = getRetryPolicy(retryOptions);\n         this.scheduler = scheduler;\n         this.isSharedConnection = isSharedConnection;\n+        this.isIdempotentPartitionPublishing = isIdempotentPartitionPublishing;\n+        if (isIdempotentPartitionPublishing) {\n+            if (initialPartitionPublishingStates == null) {\n+                this.partitionPublishingStates = new HashMap<>();\n+            } else {\n+                this.partitionPublishingStates = initialPartitionPublishingStates;\n+            }\n+        } else {\n+            this.partitionPublishingStates = null;\n+        }\n+    }\n+\n+    EventHubProducerAsyncClient(String fullyQualifiedNamespace, String eventHubName,\n+        EventHubConnectionProcessor connectionProcessor, AmqpRetryOptions retryOptions, TracerProvider tracerProvider,", "originalCommit": "b596e144103b80cd65aa3ab7cc3139b019781b4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYyOTI4NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r490629285", "bodyText": "Same as above", "author": "YijunXieMS", "createdAt": "2020-09-18T00:13:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUxMDU3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUxMjEzNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r490512137", "bodyText": "can we flatten this into an &&", "author": "conniey", "createdAt": "2020-09-17T19:34:44Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventHubProducerAsyncClient.java", "diffHunk": "@@ -207,6 +272,12 @@ public String getEventHubName() {\n         if (options == null) {\n             return monoError(logger, new NullPointerException(\"'options' cannot be null.\"));\n         }\n+        if (this.isIdempotentPartitionPublishing) {\n+            if (CoreUtils.isNullOrEmpty(options.getPartitionId())) {", "originalCommit": "b596e144103b80cd65aa3ab7cc3139b019781b4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYyOTMzNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r490629334", "bodyText": "Done", "author": "YijunXieMS", "createdAt": "2020-09-18T00:13:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUxMjEzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUxMzI4MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r490513280", "bodyText": "Consistent use of this.", "author": "conniey", "createdAt": "2020-09-17T19:35:51Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventHubProducerAsyncClient.java", "diffHunk": "@@ -376,6 +447,9 @@ public String getEventHubName() {\n             return monoError(logger, new NullPointerException(\"'events' cannot be null.\"));\n         } else if (options == null) {\n             return monoError(logger, new NullPointerException(\"'options' cannot be null.\"));\n+        } else if (options.getPartitionId() == null && this.isIdempotentPartitionPublishing) {", "originalCommit": "b596e144103b80cd65aa3ab7cc3139b019781b4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYyOTkzMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r490629930", "bodyText": "I actually prefer using this because it renders the information that the variable is a instance variable instead of a local.\nAnyway to sync with other code, I removed the this.", "author": "YijunXieMS", "createdAt": "2020-09-18T00:16:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUxMzI4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUxMzkyOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r490513928", "bodyText": "Does this part need to be in a mono? it seems ysnchronous to me.", "author": "conniey", "createdAt": "2020-09-17T19:36:33Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventHubProducerAsyncClient.java", "diffHunk": "@@ -447,18 +514,65 @@ public String getEventHubName() {\n             // Start send span and store updated context\n             parentContext.set(tracerProvider.startSpan(finalSharedContext, ProcessKind.SEND));\n         }\n-\n-        return withRetry(getSendLink(batch.getPartitionId())\n-            .flatMap(link ->\n-                messages.size() == 1\n+        if (isIdempotentPartitionPublishing) {\n+            PartitionPublishingState publishingState = this.getClientPartitionPublishingState(batch.getPartitionId());\n+            return Mono.fromRunnable(() -> {\n+                publishingState.getSemaphore().acquireUninterruptibly();", "originalCommit": "b596e144103b80cd65aa3ab7cc3139b019781b4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzMDE3OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r490630179", "bodyText": "Yes, without a Mono, it's too eager to have the Semaphore and may cause some problems.", "author": "YijunXieMS", "createdAt": "2020-09-18T00:16:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUxMzkyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUxNDYyNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r490514625", "bodyText": "Since we're synchronising on the entire class... is it possible to just synchronise on the parts that need to be?", "author": "conniey", "createdAt": "2020-09-17T19:37:18Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventHubProducerAsyncClient.java", "diffHunk": "@@ -502,12 +617,69 @@ private String getEntityPath(String partitionId) {\n             : String.format(Locale.US, SENDER_ENTITY_PATH_FORMAT, eventHubName, partitionId);\n     }\n \n+    private Mono<AmqpSendLink> updatePublishingState(String partitionId, AmqpSendLink amqpSendLink) {\n+        if (this.isIdempotentPartitionPublishing) {\n+            return amqpSendLink.getRemoteProperties().map(properties -> {\n+                this.setPartitionPublishingState(\n+                    partitionId, (Long) properties.get(SymbolConstants.PRODUCER_ID),\n+                    (Short) properties.get(SymbolConstants.PRODUCER_EPOCH),\n+                    (Integer) properties.get(SymbolConstants.PRODUCER_SEQUENCE_NUMBER)\n+                );\n+                return amqpSendLink;\n+            });\n+        } else {\n+            return Mono.just(amqpSendLink);\n+        }\n+    }\n+\n+    /**\n+     * Get the idempotent producer's publishing state of a partition from the client side maintained state.\n+     * It doesn't create a link to get state from the service.\n+     */\n+    private PartitionPublishingState getClientPartitionPublishingState(String partitionId) {\n+        if (!this.isIdempotentPartitionPublishing) {\n+            throw logger.logExceptionAsWarning(\n+                new IllegalStateException(\"getPartitionPublishingState() shouldn't be called if the producer\"\n+                    + \" is not an idempotent producer.\"));\n+        }\n+        if (this.partitionPublishingStates.containsKey(partitionId)) {\n+            return this.partitionPublishingStates.get(partitionId);\n+        } else {\n+            synchronized (this) {", "originalCommit": "b596e144103b80cd65aa3ab7cc3139b019781b4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzMTIxOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r490631218", "bodyText": "Changed to synchronize on partitionPublishingStates.", "author": "YijunXieMS", "createdAt": "2020-09-18T00:20:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUxNDYyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUxNTEwMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r490515102", "bodyText": "We don't need this. It's implied because there is no other variable with the same name in this scope.", "author": "conniey", "createdAt": "2020-09-17T19:37:54Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventHubProducerAsyncClient.java", "diffHunk": "@@ -502,12 +617,69 @@ private String getEntityPath(String partitionId) {\n             : String.format(Locale.US, SENDER_ENTITY_PATH_FORMAT, eventHubName, partitionId);\n     }\n \n+    private Mono<AmqpSendLink> updatePublishingState(String partitionId, AmqpSendLink amqpSendLink) {\n+        if (this.isIdempotentPartitionPublishing) {", "originalCommit": "b596e144103b80cd65aa3ab7cc3139b019781b4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUxNTE3NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r490515175", "bodyText": "Same with other usages of this", "author": "conniey", "createdAt": "2020-09-17T19:38:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUxNTEwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzMTYyMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r490631620", "bodyText": "Removed.", "author": "YijunXieMS", "createdAt": "2020-09-18T00:21:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUxNTEwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUxNTQyNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r490515426", "bodyText": "@srnagar I'm torn on using a semaphore for this. thoughts?", "author": "conniey", "createdAt": "2020-09-17T19:38:30Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventHubProducerAsyncClient.java", "diffHunk": "@@ -447,18 +514,65 @@ public String getEventHubName() {\n             // Start send span and store updated context\n             parentContext.set(tracerProvider.startSpan(finalSharedContext, ProcessKind.SEND));\n         }\n-\n-        return withRetry(getSendLink(batch.getPartitionId())\n-            .flatMap(link ->\n-                messages.size() == 1\n+        if (isIdempotentPartitionPublishing) {\n+            PartitionPublishingState publishingState = this.getClientPartitionPublishingState(batch.getPartitionId());\n+            return Mono.fromRunnable(() -> {\n+                publishingState.getSemaphore().acquireUninterruptibly();", "originalCommit": "b596e144103b80cd65aa3ab7cc3139b019781b4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYyMDM1Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r490620357", "bodyText": "The requirement is for a combination of a producer group and a partition, the send should be sequential. No concurrency is allowed because the service will check the producer sequence number assigned by the client.\nI spent long time in searching for a replacement of Semaphore for this use case. Any suggestions?", "author": "YijunXieMS", "createdAt": "2020-09-17T23:41:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUxNTQyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAxMzgzOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r493013838", "bodyText": "The other option was to consider Reentrant lock but since the thread that acquires the lock may not be the same as the one that releases it, semaphore is the only option here.", "author": "srnagar", "createdAt": "2020-09-22T20:29:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUxNTQyNg=="}], "type": "inlineReview"}, {"oid": "8e4f920e7527e9ea183ba597eaa77bc0b26bc19a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8e4f920e7527e9ea183ba597eaa77bc0b26bc19a", "message": "Fix review comments", "committedDate": "2020-09-18T00:01:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIwNjYyNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r492206626", "bodyText": "You're doing this assignment in each iteration of the for loop?", "author": "conniey", "createdAt": "2020-09-21T16:51:14Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventHubClientBuilder.java", "diffHunk": "@@ -372,6 +379,54 @@ public EventHubClientBuilder prefetchCount(int prefetchCount) {\n         return this;\n     }\n \n+    /**\n+     * Enables idempotent publishing when an {@link EventHubProducerAsyncClient} or {@link EventHubProducerClient}\n+     * is built.\n+     *\n+     * If enabled, the producer will only be able to publish directly to partitions; it will not be able to publish to\n+     * the Event Hubs gateway for automatic partition routing nor using a partition key.\n+     *\n+     * @return The updated {@link EventHubClientBuilder} object.\n+     */\n+    public EventHubClientBuilder enableIdempotentPartitionPublishing() {\n+        this.isIdempotentPartitionPublishing = true;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the idempotent publishing options to {@link EventHubProducerAsyncClient} or {@link EventHubProducerClient}\n+     * when you build them.\n+     *\n+     * The set of options that can be specified to influence publishing behavior specific to the configured Event Hub\n+     * partition.\n+     * These options are not necessary in the majority of scenarios and are intended for use with specialized scenarios,\n+     * such as when recovering the state used for idempotent publishing.\n+     *\n+     * It is highly recommended that these options only be specified if there is a proven need to do so; Incorrectly\n+     * configuring these values may result in the built {@link EventHubProducerAsyncClient} or\n+     * {@link EventHubProducerClient} instance unable to publish to the Event Hubs.\n+     *\n+     * These options are ignored when publishing to the Event Hubs gateway for automatic routing or when using a\n+     * partition key.\n+     *\n+     * @param states A {@link Map} of {@link PartitionPublishingProperties} for each partition. The keys of the map\n+     * are the partition ids.\n+     * @return The updated {@link EventHubClientBuilder} object.\n+     */\n+    public EventHubClientBuilder initialPartitionPublishingStates(Map<String, PartitionPublishingProperties> states) {\n+        if (states != null) {\n+            this.initialPartitionPublishingStates = new HashMap<>();\n+            states.forEach((partitionId, state) -> {\n+                this.initialPartitionPublishingStates.put(partitionId, new PartitionPublishingState(state));\n+                this.initialPartitionPublishingStates =", "originalCommit": "8e4f920e7527e9ea183ba597eaa77bc0b26bc19a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk5NDA0MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r492994041", "bodyText": "Oops! What a negligence. Updated.", "author": "YijunXieMS", "createdAt": "2020-09-22T19:51:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIwNjYyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIwODkzNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r492208936", "bodyText": "Do we need inSysProperties in these? It's an implementation detail. I just want to set the producer group, sequence number, etc on an Event Data, it doesn't matter to me where it is stored.", "author": "conniey", "createdAt": "2020-09-21T16:55:10Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventHubProducerAsyncClient.java", "diffHunk": "@@ -447,18 +512,65 @@ public String getEventHubName() {\n             // Start send span and store updated context\n             parentContext.set(tracerProvider.startSpan(finalSharedContext, ProcessKind.SEND));\n         }\n-\n-        return withRetry(getSendLink(batch.getPartitionId())\n-            .flatMap(link ->\n-                messages.size() == 1\n+        if (isIdempotentPartitionPublishing) {\n+            PartitionPublishingState publishingState = getClientPartitionPublishingState(batch.getPartitionId());\n+            return Mono.fromRunnable(() -> {\n+                publishingState.getSemaphore().acquireUninterruptibly();\n+                int seqNumber = publishingState.getSequenceNumber();\n+                for (EventData eventData : batch.getEvents()) {\n+                    eventData.setProducerGroupIdInSysProperties(publishingState.getProducerGroupId());", "originalCommit": "8e4f920e7527e9ea183ba597eaa77bc0b26bc19a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQxMjk4NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r492412985", "bodyText": "I give it this specific name because setProducerGroupIdInSysProperties is internal and it doesn't set the value of property producerGroupId. After setProducerGroupIdInSysProperties is called, getProducerGroupId still returns null. After the event data is successfully sent out, the commitProducerDataFromSysProperties is called to set the value of producerGroupId and two other properties. Then getProducerGroupId returns the producerGroupId with a value. So I think setProducerGroupIdInSysProperties would be more specific and meaningful than setProducerGroupId when somebody else reads the code.", "author": "YijunXieMS", "createdAt": "2020-09-22T00:08:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIwODkzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIxMTE5NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r492211195", "bodyText": "Do we need this class? I'm not fond of having utility classes unless it's constantly used by multiple classes. In this case, we are only incrementing by one.", "author": "conniey", "createdAt": "2020-09-21T16:59:10Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/implementation/PartitionPublishingUtils.java", "diffHunk": "@@ -0,0 +1,32 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.messaging.eventhubs.implementation;\n+\n+/**\n+ * A util class for idempotent producer partition publishing.\n+ */\n+public class PartitionPublishingUtils {", "originalCommit": "8e4f920e7527e9ea183ba597eaa77bc0b26bc19a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIxMTQwMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r492211401", "bodyText": "IIRC, we already have a constants class. Can we put them in there?", "author": "conniey", "createdAt": "2020-09-21T16:59:33Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/implementation/SymbolConstants.java", "diffHunk": "@@ -0,0 +1,22 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.messaging.eventhubs.implementation;\n+\n+import com.azure.core.amqp.AmqpMessageConstant;\n+import org.apache.qpid.proton.amqp.Symbol;\n+\n+import static com.azure.core.amqp.implementation.AmqpConstants.VENDOR;\n+\n+public final class SymbolConstants {", "originalCommit": "8e4f920e7527e9ea183ba597eaa77bc0b26bc19a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk5NDQ3MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r492994471", "bodyText": "Merged to ClientConstants and removed this one.", "author": "YijunXieMS", "createdAt": "2020-09-22T19:52:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIxMTQwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIxMTg4OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r492211888", "bodyText": "private?", "author": "conniey", "createdAt": "2020-09-21T17:00:14Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/test/java/com/azure/messaging/eventhubs/EventHubProducerAsyncClientIdempotentTest.java", "diffHunk": "@@ -0,0 +1,321 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.messaging.eventhubs;\n+\n+import com.azure.core.amqp.*;\n+import com.azure.core.amqp.implementation.*;\n+import com.azure.core.credential.TokenCredential;\n+import com.azure.messaging.eventhubs.implementation.ClientConstants;\n+import com.azure.messaging.eventhubs.implementation.EventHubAmqpConnection;\n+import com.azure.messaging.eventhubs.implementation.EventHubConnectionProcessor;\n+import com.azure.messaging.eventhubs.implementation.PartitionPublishingState;\n+import com.azure.messaging.eventhubs.models.CreateBatchOptions;\n+import com.azure.messaging.eventhubs.models.SendOptions;\n+import org.apache.qpid.proton.amqp.Symbol;\n+import org.apache.qpid.proton.message.Message;\n+import org.junit.jupiter.api.*;\n+import org.mockito.*;\n+import reactor.core.publisher.DirectProcessor;\n+import reactor.core.publisher.FluxSink;\n+import reactor.core.publisher.Mono;\n+import reactor.core.scheduler.Scheduler;\n+import reactor.core.scheduler.Schedulers;\n+import reactor.test.StepVerifier;\n+\n+import java.time.Duration;\n+import java.util.*;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+import static org.mockito.ArgumentMatchers.*;\n+import static org.mockito.Mockito.*;\n+\n+class EventHubProducerAsyncClientIdempotentTest {\n+    private static final String HOSTNAME = \"something.servicebus.windows.net\";\n+    private static final String EVENT_HUB_NAME = \"anEventHub\";\n+    private static final String PARTITION_0 = \"0\";\n+    private static final String PARTITION_1 = \"1\";\n+    private static final String ENTITY_PATH_0 = EVENT_HUB_NAME + \"/Partitions/\" + PARTITION_0;\n+    private static final String ENTITY_PATH_1 = EVENT_HUB_NAME + \"/Partitions/\" + PARTITION_1;\n+    private static final String TEST_CONNECTION_STRING = \"Endpoint=sb://something.servicebus.windows.net/;\"\n+        + \"SharedAccessKeyName=anAccessKeyName;\"\n+        + \"SharedAccessKey=anAccessKey;EntityPath=anEventHub\";\n+\n+    private static final Long PRODUCER_GROUP_ID = 1L;\n+    private static final Short PRODUCER_OWNER_LEVEL = (short) 10;\n+    private static final Integer PRODUCER_SEQ_NUMBER = 100;\n+\n+    @Mock\n+    private AmqpSendLink sendLink;\n+\n+    @Mock\n+    private AmqpSendLink sendLink2;\n+\n+    @Mock\n+    private EventHubAmqpConnection connection;\n+\n+    @Mock\n+    private TokenCredential tokenCredential;\n+    @Mock\n+    private Runnable onClientClosed;\n+\n+    private final MessageSerializer messageSerializer = new EventHubMessageSerializer();\n+    private final AmqpRetryOptions retryOptions = new AmqpRetryOptions()\n+        .setDelay(Duration.ofMillis(500))\n+        .setMode(AmqpRetryMode.FIXED)\n+        .setTryTimeout(Duration.ofSeconds(5))\n+        .setMaxRetries(2);\n+    private final DirectProcessor<AmqpEndpointState> endpointProcessor = DirectProcessor.create();\n+    private final FluxSink<AmqpEndpointState> endpointSink = endpointProcessor.sink(FluxSink.OverflowStrategy.BUFFER);\n+    private EventHubProducerAsyncClient producer;\n+    private EventHubConnectionProcessor connectionProcessor;\n+    private TracerProvider tracerProvider;\n+    private ConnectionOptions connectionOptions;\n+    private final Scheduler testScheduler = Schedulers.newElastic(\"test\");\n+\n+    PartitionPublishingProperties p0InitialState;", "originalCommit": "8e4f920e7527e9ea183ba597eaa77bc0b26bc19a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIxMTk1Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r492211956", "bodyText": "Why p0?", "author": "conniey", "createdAt": "2020-09-21T17:00:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIxMTg4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk5NDU3Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r492994573", "bodyText": "Yes, should be private. p0 means partition 0. It's specifically for the initial state of partition 0. Since it's confusing, I changed it to partition0InitialState", "author": "YijunXieMS", "createdAt": "2020-09-22T19:52:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIxMTg4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIxMjM1NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r492212355", "bodyText": "Is there a test where we try a failure and it increments the count?", "author": "conniey", "createdAt": "2020-09-21T17:00:59Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/test/java/com/azure/messaging/eventhubs/EventHubProducerAsyncClientIdempotentTest.java", "diffHunk": "@@ -0,0 +1,321 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.messaging.eventhubs;\n+\n+import com.azure.core.amqp.*;\n+import com.azure.core.amqp.implementation.*;\n+import com.azure.core.credential.TokenCredential;\n+import com.azure.messaging.eventhubs.implementation.ClientConstants;\n+import com.azure.messaging.eventhubs.implementation.EventHubAmqpConnection;\n+import com.azure.messaging.eventhubs.implementation.EventHubConnectionProcessor;\n+import com.azure.messaging.eventhubs.implementation.PartitionPublishingState;\n+import com.azure.messaging.eventhubs.models.CreateBatchOptions;\n+import com.azure.messaging.eventhubs.models.SendOptions;\n+import org.apache.qpid.proton.amqp.Symbol;\n+import org.apache.qpid.proton.message.Message;\n+import org.junit.jupiter.api.*;\n+import org.mockito.*;\n+import reactor.core.publisher.DirectProcessor;\n+import reactor.core.publisher.FluxSink;\n+import reactor.core.publisher.Mono;\n+import reactor.core.scheduler.Scheduler;\n+import reactor.core.scheduler.Schedulers;\n+import reactor.test.StepVerifier;\n+\n+import java.time.Duration;\n+import java.util.*;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+import static org.mockito.ArgumentMatchers.*;\n+import static org.mockito.Mockito.*;\n+\n+class EventHubProducerAsyncClientIdempotentTest {\n+    private static final String HOSTNAME = \"something.servicebus.windows.net\";\n+    private static final String EVENT_HUB_NAME = \"anEventHub\";\n+    private static final String PARTITION_0 = \"0\";\n+    private static final String PARTITION_1 = \"1\";\n+    private static final String ENTITY_PATH_0 = EVENT_HUB_NAME + \"/Partitions/\" + PARTITION_0;\n+    private static final String ENTITY_PATH_1 = EVENT_HUB_NAME + \"/Partitions/\" + PARTITION_1;\n+    private static final String TEST_CONNECTION_STRING = \"Endpoint=sb://something.servicebus.windows.net/;\"\n+        + \"SharedAccessKeyName=anAccessKeyName;\"\n+        + \"SharedAccessKey=anAccessKey;EntityPath=anEventHub\";\n+\n+    private static final Long PRODUCER_GROUP_ID = 1L;\n+    private static final Short PRODUCER_OWNER_LEVEL = (short) 10;\n+    private static final Integer PRODUCER_SEQ_NUMBER = 100;\n+\n+    @Mock\n+    private AmqpSendLink sendLink;\n+\n+    @Mock\n+    private AmqpSendLink sendLink2;\n+\n+    @Mock\n+    private EventHubAmqpConnection connection;\n+\n+    @Mock\n+    private TokenCredential tokenCredential;\n+    @Mock\n+    private Runnable onClientClosed;\n+\n+    private final MessageSerializer messageSerializer = new EventHubMessageSerializer();\n+    private final AmqpRetryOptions retryOptions = new AmqpRetryOptions()\n+        .setDelay(Duration.ofMillis(500))\n+        .setMode(AmqpRetryMode.FIXED)\n+        .setTryTimeout(Duration.ofSeconds(5))\n+        .setMaxRetries(2);\n+    private final DirectProcessor<AmqpEndpointState> endpointProcessor = DirectProcessor.create();\n+    private final FluxSink<AmqpEndpointState> endpointSink = endpointProcessor.sink(FluxSink.OverflowStrategy.BUFFER);\n+    private EventHubProducerAsyncClient producer;\n+    private EventHubConnectionProcessor connectionProcessor;\n+    private TracerProvider tracerProvider;\n+    private ConnectionOptions connectionOptions;\n+    private final Scheduler testScheduler = Schedulers.newElastic(\"test\");\n+\n+    PartitionPublishingProperties p0InitialState;\n+    Map<String, PartitionPublishingProperties> initialStates = new HashMap<>();\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        StepVerifier.setDefaultTimeout(Duration.ofSeconds(30));\n+    }\n+\n+    @AfterAll\n+    static void afterAll() {\n+        StepVerifier.resetDefaultTimeout();\n+    }\n+\n+    @BeforeEach\n+    void setup(TestInfo testInfo) {\n+        MockitoAnnotations.initMocks(this);\n+\n+        tracerProvider = new TracerProvider(Collections.emptyList());\n+        connectionOptions = new ConnectionOptions(HOSTNAME, tokenCredential,\n+            CbsAuthorizationType.SHARED_ACCESS_SIGNATURE, AmqpTransportType.AMQP_WEB_SOCKETS, retryOptions,\n+            ProxyOptions.SYSTEM_DEFAULTS, testScheduler);\n+\n+        when(connection.getEndpointStates()).thenReturn(endpointProcessor);\n+        endpointSink.next(AmqpEndpointState.ACTIVE);\n+\n+        connectionProcessor = Mono.fromCallable(() -> connection).repeat(10).subscribeWith(\n+            new EventHubConnectionProcessor(connectionOptions.getFullyQualifiedNamespace(),\n+                EVENT_HUB_NAME, connectionOptions.getRetry()));\n+\n+        p0InitialState = new PartitionPublishingProperties(PRODUCER_GROUP_ID, PRODUCER_OWNER_LEVEL, PRODUCER_SEQ_NUMBER);\n+        initialStates = new HashMap<>();\n+        initialStates.put(PARTITION_0, p0InitialState);\n+\n+        Map<String, PartitionPublishingState> internalStates = new HashMap<>();\n+        initialStates.forEach((k, v) -> internalStates.put(k, new PartitionPublishingState(v)));\n+        producer = new EventHubProducerAsyncClient(HOSTNAME, EVENT_HUB_NAME, connectionProcessor, retryOptions,\n+            tracerProvider, messageSerializer, testScheduler, false, onClientClosed,\n+            true, internalStates);\n+\n+        Map<Symbol, Object> remoteProperties = new HashMap<>();\n+        remoteProperties.put(\n+            Symbol.getSymbol(AmqpMessageConstant.PRODUCER_EPOCH_ANNOTATION_NAME.getValue()),\n+            p0InitialState.getOwnerLevel());\n+        remoteProperties.put(\n+            Symbol.getSymbol(AmqpMessageConstant.PRODUCER_SEQUENCE_NUMBER_ANNOTATION_NAME.getValue()),\n+            p0InitialState.getSequenceNumber());\n+        remoteProperties.put(\n+            Symbol.getSymbol(AmqpMessageConstant.PRODUCER_ID_ANNOTATION_NAME.getValue()),\n+            p0InitialState.getProducerGroupId());\n+\n+        when(connection.createSendLink(eq(ENTITY_PATH_0), eq(ENTITY_PATH_0),\n+            eq(retryOptions), eq(true), any(PartitionPublishingState.class))).thenReturn(Mono.just(sendLink));\n+        when(sendLink.getRemoteProperties()).thenReturn(\n+            Mono.just(remoteProperties));\n+        when(sendLink.getLinkSize()).thenReturn(Mono.just(ClientConstants.MAX_MESSAGE_LENGTH_BYTES));\n+        when(sendLink.send(any(Message.class))).thenReturn(Mono.empty());\n+        when(sendLink.send(anyList())).thenReturn(Mono.empty());\n+    }\n+\n+    @AfterEach\n+    void teardown(TestInfo testInfo) {\n+        testScheduler.dispose();\n+        Mockito.framework().clearInlineMocks();\n+        Mockito.reset(sendLink, connection);\n+    }\n+\n+    @Test\n+    void buildClientIllegalArgument() {\n+        assertThrows(IllegalArgumentException.class, () -> new EventHubClientBuilder()\n+            .connectionString(TEST_CONNECTION_STRING)\n+            .initialPartitionPublishingStates(initialStates)  // Not an idempotent producer. Shouldn't set.\n+            .buildAsyncProducerClient());\n+    }\n+\n+    @Test\n+    void getPartitionPublishingProperties() {\n+        StepVerifier.create(producer.getPartitionPublishingProperties(PARTITION_0))\n+            .assertNext(properties -> {\n+                assertEquals(properties.getOwnerLevel(), p0InitialState.getOwnerLevel());\n+                assertEquals(properties.getProducerGroupId(), p0InitialState.getProducerGroupId());\n+                assertEquals(properties.getSequenceNumber(), p0InitialState.getSequenceNumber());\n+            })\n+            .verifyComplete();\n+    }\n+\n+    @Test\n+    void createEventDataBatch() {\n+        CreateBatchOptions options = new CreateBatchOptions();\n+        options.setPartitionId(PARTITION_0);\n+        StepVerifier.create(producer.createBatch(options))\n+            .assertNext(eventDataBatch -> {\n+                assertNull(eventDataBatch.getStartingPublishedSequenceNumber());\n+            })\n+            .verifyComplete();\n+    }\n+\n+    @Test\n+    void createBatchWithoutPartitionId() {\n+        StepVerifier.create(producer.createBatch())\n+            .expectError(IllegalArgumentException.class)\n+            .verify();\n+    }\n+\n+    @Test\n+    void sendEventDataBatch() {\n+        CreateBatchOptions options = new CreateBatchOptions();\n+        options.setPartitionId(PARTITION_0);\n+        EventDataBatch batch = producer.createBatch(options).block();\n+        assertNotNull(batch);\n+        EventData eventData = new EventData(\"This is a test event\");\n+        batch.tryAdd(eventData);\n+        StepVerifier.create(producer.send(batch)).verifyComplete();\n+        assertEquals(eventData.getSystemProperties().get(AmqpMessageConstant.PRODUCER_ID_ANNOTATION_NAME.getValue()),\n+            PRODUCER_GROUP_ID);\n+        assertEquals(eventData.getSystemProperties().get(AmqpMessageConstant.PRODUCER_EPOCH_ANNOTATION_NAME.getValue()),\n+            PRODUCER_OWNER_LEVEL);\n+        assertEquals(eventData.getSystemProperties().get(\n+            AmqpMessageConstant.PRODUCER_SEQUENCE_NUMBER_ANNOTATION_NAME.getValue()),\n+            PRODUCER_SEQ_NUMBER);\n+        assertEquals(batch.getStartingPublishedSequenceNumber(), PRODUCER_SEQ_NUMBER);\n+\n+        StepVerifier.create(producer.getPartitionPublishingState(PARTITION_0))\n+            .assertNext(state -> {\n+                assertEquals(state.getSequenceNumber(), PRODUCER_SEQ_NUMBER + batch.getCount());\n+            }).verifyComplete();\n+    }\n+\n+    @Test\n+    void sendEventList() {\n+        EventData eventData = new EventData(\"This is a test event\");\n+        List<EventData> eventDataList = new ArrayList<>();\n+        eventDataList.add(eventData);\n+        StepVerifier.create(producer.send(eventDataList, new SendOptions().setPartitionId(PARTITION_0))).verifyComplete();\n+        assertEquals(eventData.getSystemProperties().get(AmqpMessageConstant.PRODUCER_ID_ANNOTATION_NAME.getValue()),\n+            PRODUCER_GROUP_ID);\n+        assertEquals(eventData.getSystemProperties().get(AmqpMessageConstant.PRODUCER_EPOCH_ANNOTATION_NAME.getValue()),\n+            PRODUCER_OWNER_LEVEL);\n+        assertEquals(eventData.getSystemProperties().get(\n+            AmqpMessageConstant.PRODUCER_SEQUENCE_NUMBER_ANNOTATION_NAME.getValue()),\n+            PRODUCER_SEQ_NUMBER);\n+\n+        StepVerifier.create(producer.getPartitionPublishingState(PARTITION_0))\n+            .assertNext(state -> {\n+                assertEquals(state.getSequenceNumber(), PRODUCER_SEQ_NUMBER + eventDataList.size());\n+            }).verifyComplete();\n+    }\n+\n+    @Test\n+    void sendEventDataListWithoutPartition() {\n+        EventData eventData = new EventData(\"This is a test event\");\n+        List<EventData> eventDataList = new ArrayList<>();\n+        eventDataList.add(eventData);\n+        StepVerifier.create(producer.send(eventDataList)).verifyError(IllegalArgumentException.class);\n+    }\n+\n+    @Test\n+    void sendEventBatchesToSamePartitionConcurrently() {", "originalCommit": "8e4f920e7527e9ea183ba597eaa77bc0b26bc19a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk5NTgzNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r492995836", "bodyText": "Good question. I added test method sendEventDataListFail", "author": "YijunXieMS", "createdAt": "2020-09-22T19:55:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIxMjM1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIxMzIxNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r492213216", "bodyText": "You need to update your intelliJ settings not to use star imports. This will fail checkstyles. I updated mine to 99.\n\n\n\nI am not a fan of this class... I don't see it providing enough value to warrant an entire utils class.", "author": "conniey", "createdAt": "2020-09-21T17:02:35Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/test/java/com/azure/messaging/eventhubs/implementation/PartitionPublishigUtilsTest.java", "diffHunk": "@@ -0,0 +1,43 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.messaging.eventhubs.implementation;\n+\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.Arguments;\n+import org.junit.jupiter.params.provider.MethodSource;\n+\n+import java.util.stream.Stream;\n+\n+import static org.junit.jupiter.api.Assertions.*;", "originalCommit": "8e4f920e7527e9ea183ba597eaa77bc0b26bc19a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk5Njc4MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r492996781", "bodyText": "Corrected the import * and configured my IDE. Thanks", "author": "YijunXieMS", "createdAt": "2020-09-22T19:56:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIxMzIxNg=="}], "type": "inlineReview"}, {"oid": "17a26dab053c154e13de99ed6c8c948a6f0ba7e8", "url": "https://github.com/Azure/azure-sdk-for-java/commit/17a26dab053c154e13de99ed6c8c948a6f0ba7e8", "message": "Update for code review", "committedDate": "2020-09-22T19:24:19Z", "type": "commit"}, {"oid": "1d2b29de221702e3d514969777ed6fd317db7b17", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1d2b29de221702e3d514969777ed6fd317db7b17", "message": "Update for code review", "committedDate": "2020-09-22T19:32:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAxNDg2Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r493014862", "bodyText": "Can we also include some integration tests for this - maybe as a separate PR?", "author": "srnagar", "createdAt": "2020-09-22T20:31:00Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/test/java/com/azure/messaging/eventhubs/EventHubProducerAsyncClientIdempotentTest.java", "diffHunk": "@@ -0,0 +1,383 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.messaging.eventhubs;\n+\n+import com.azure.core.amqp.AmqpEndpointState;\n+import com.azure.core.amqp.AmqpMessageConstant;\n+import com.azure.core.amqp.AmqpRetryMode;\n+import com.azure.core.amqp.AmqpRetryOptions;\n+import com.azure.core.amqp.AmqpTransportType;\n+import com.azure.core.amqp.ProxyOptions;\n+import com.azure.core.amqp.implementation.AmqpSendLink;\n+import com.azure.core.amqp.implementation.CbsAuthorizationType;\n+import com.azure.core.amqp.implementation.ConnectionOptions;\n+import com.azure.core.amqp.implementation.MessageSerializer;\n+import com.azure.core.amqp.implementation.TracerProvider;\n+import com.azure.core.credential.TokenCredential;\n+import com.azure.messaging.eventhubs.implementation.ClientConstants;\n+import com.azure.messaging.eventhubs.implementation.EventHubAmqpConnection;\n+import com.azure.messaging.eventhubs.implementation.EventHubConnectionProcessor;\n+import com.azure.messaging.eventhubs.implementation.PartitionPublishingState;\n+import com.azure.messaging.eventhubs.models.CreateBatchOptions;\n+import com.azure.messaging.eventhubs.models.SendOptions;\n+import org.apache.qpid.proton.amqp.Symbol;\n+import org.apache.qpid.proton.message.Message;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInfo;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.MockitoAnnotations;\n+import reactor.core.publisher.DirectProcessor;\n+import reactor.core.publisher.FluxSink;\n+import reactor.core.publisher.Mono;\n+import reactor.core.scheduler.Scheduler;\n+import reactor.core.scheduler.Schedulers;\n+import reactor.test.StepVerifier;\n+\n+import java.time.Duration;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertNull;\n+import static org.junit.jupiter.api.Assertions.assertThrows;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyList;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.when;\n+\n+class EventHubProducerAsyncClientIdempotentTest {", "originalCommit": "1d2b29de221702e3d514969777ed6fd317db7b17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzA0MjcyMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14389#discussion_r493042723", "bodyText": "Service team will deploy this feature to all service bus namespaces in 3 weeks. Before that we might not have integration tests runnable. I manually did some test with a test service resource. So yes, we need to create a separate PR some time later.", "author": "YijunXieMS", "createdAt": "2020-09-22T21:25:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAxNDg2Mg=="}], "type": "inlineReview"}, {"oid": "c9871a35a6b159d0b4305f7da7a7f3483a40b4df", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c9871a35a6b159d0b4305f7da7a7f3483a40b4df", "message": "Hide EventData getPublishedGroupId and getPublishedOwnerLevel at package level", "committedDate": "2020-09-22T22:15:25Z", "type": "commit"}]}