{"pr_number": 17200, "pr_title": "RntbdMockServer", "pr_createdAt": "2020-11-05T02:34:16Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/17200", "timeline": [{"oid": "80adaf494657873e0418b01006e661a85fb5c892", "url": "https://github.com/Azure/azure-sdk-for-java/commit/80adaf494657873e0418b01006e661a85fb5c892", "message": "Add connectionStateListener", "committedDate": "2020-11-05T02:12:42Z", "type": "commit"}, {"oid": "daf9a1499eb755098cf31bb5c3a25bdd82a992b6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/daf9a1499eb755098cf31bb5c3a25bdd82a992b6", "message": "Merge branch 'master' into RntbdMockServer", "committedDate": "2020-11-05T02:16:00Z", "type": "commit"}, {"oid": "4644e66aa052fdfbda116aafd0307ba216b7f9db", "url": "https://github.com/Azure/azure-sdk-for-java/commit/4644e66aa052fdfbda116aafd0307ba216b7f9db", "message": "revert and fix", "committedDate": "2020-11-05T02:19:07Z", "type": "commit"}, {"oid": "2450fbc415ec84f3a7449f81f07fe1a8132a26b8", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2450fbc415ec84f3a7449f81f07fe1a8132a26b8", "message": "change", "committedDate": "2020-11-05T02:33:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ1MTIzOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17200#discussion_r518451239", "bodyText": "please try to use logger here and everywhere else instead of e.printStackTrace()", "author": "moderakh", "createdAt": "2020-11-06T00:25:08Z", "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/implementation/directconnectivity/ConnectionStateListenerTest.java", "diffHunk": "@@ -0,0 +1,96 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos.implementation.directconnectivity;\n+\n+import com.azure.cosmos.DirectConnectionConfig;\n+import com.azure.cosmos.implementation.Configs;\n+import com.azure.cosmos.implementation.ConnectionPolicy;\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.implementation.OperationType;\n+import com.azure.cosmos.implementation.ResourceType;\n+import com.azure.cosmos.implementation.RxDocumentServiceRequest;\n+import com.azure.cosmos.implementation.UserAgentContainer;\n+import com.azure.cosmos.implementation.directconnectivity.TcpServerMock.TcpServerFactory;\n+import com.azure.cosmos.implementation.directconnectivity.TcpServerMock.TcpServer;\n+import com.azure.cosmos.implementation.directconnectivity.TcpServerMock.RequestResponseType;\n+import com.azure.cosmos.implementation.directconnectivity.TcpServerMock.SslContextUtils;\n+import com.azure.cosmos.implementation.routing.PartitionKeyRangeIdentity;\n+import io.netty.handler.ssl.SslContext;\n+import org.mockito.Mockito;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Test;\n+\n+import java.util.HashMap;\n+import java.util.UUID;\n+\n+import static com.azure.cosmos.implementation.TestUtils.mockDiagnosticsClientContext;\n+\n+public class ConnectionStateListenerTest {\n+\n+    private static int port = 8082;\n+    private static String serverUriString = \"rntbd://localhost:\" + port;\n+\n+    @DataProvider(name = \"connectionStateListenerConfigProvider\")\n+    public Object[][] connectionStateListenerConfigProvider() {\n+        return new Object[][]{\n+            // isTcpConnectionEndpointRediscoveryEnabled, serverResponseType, GlobalAddressResolver.updateAddresses() called times\n+            {true, RequestResponseType.CHANNEL_FIN, 1},\n+            {false, RequestResponseType.CHANNEL_FIN, 0},\n+            {true, RequestResponseType.CHANNEL_RST, 0},\n+            {false, RequestResponseType.CHANNEL_RST, 0},\n+        };\n+    }\n+\n+    @Test(dataProvider = \"connectionStateListenerConfigProvider\")\n+    public void connectionStateListener_OnConnectionEvent(boolean isTcpConnectionEndpointRediscoveryEnabled, RequestResponseType responseType, int times) {\n+        TcpServer server = TcpServerFactory.startNewRntbdServer(port);\n+        // Inject fake response\n+        server.injectServerResponse(responseType);\n+\n+        ConnectionPolicy connectionPolicy = new ConnectionPolicy(DirectConnectionConfig.getDefaultConfig());\n+        connectionPolicy.setTcpConnectionEndpointRediscoveryEnabled(isTcpConnectionEndpointRediscoveryEnabled);\n+\n+        GlobalAddressResolver addressResolver = Mockito.mock(GlobalAddressResolver.class);\n+\n+        SslContext sslContext = SslContextUtils.CreateSslContext(\"client.jks\", false);\n+\n+        Configs config = Mockito.mock(Configs.class);\n+        Mockito.doReturn(sslContext).when(config).getSslContext();\n+\n+        RntbdTransportClient client = new RntbdTransportClient(\n+            config,\n+            connectionPolicy,\n+            new UserAgentContainer(),\n+            addressResolver);\n+\n+        RxDocumentServiceRequest req =\n+            RxDocumentServiceRequest.create(mockDiagnosticsClientContext(), OperationType.Create, ResourceType.Document,\n+                \"dbs/fakedb/colls/fakeColls\",\n+                getDocumentDefinition(), new HashMap<>());\n+        req.setPartitionKeyRangeIdentity(new PartitionKeyRangeIdentity(\"fakeCollectionId\",\"fakePartitionKeyRangeId\"));\n+\n+        Uri targetUri = new Uri(serverUriString);\n+        try {\n+            client.invokeStoreAsync(targetUri, req).block();\n+        } catch (Exception e) {\n+            e.printStackTrace();", "originalCommit": "2450fbc415ec84f3a7449f81f07fe1a8132a26b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg5NjU3MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17200#discussion_r518896571", "bodyText": "Changed to use logger here and other places.", "author": "xinlian12", "createdAt": "2020-11-06T17:26:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ1MTIzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ2MTA4MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17200#discussion_r518461080", "bodyText": "please add groups =  { \"unit\" } similar to other tests.", "author": "moderakh", "createdAt": "2020-11-06T00:58:05Z", "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/implementation/directconnectivity/ConnectionStateListenerTest.java", "diffHunk": "@@ -0,0 +1,96 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos.implementation.directconnectivity;\n+\n+import com.azure.cosmos.DirectConnectionConfig;\n+import com.azure.cosmos.implementation.Configs;\n+import com.azure.cosmos.implementation.ConnectionPolicy;\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.implementation.OperationType;\n+import com.azure.cosmos.implementation.ResourceType;\n+import com.azure.cosmos.implementation.RxDocumentServiceRequest;\n+import com.azure.cosmos.implementation.UserAgentContainer;\n+import com.azure.cosmos.implementation.directconnectivity.TcpServerMock.TcpServerFactory;\n+import com.azure.cosmos.implementation.directconnectivity.TcpServerMock.TcpServer;\n+import com.azure.cosmos.implementation.directconnectivity.TcpServerMock.RequestResponseType;\n+import com.azure.cosmos.implementation.directconnectivity.TcpServerMock.SslContextUtils;\n+import com.azure.cosmos.implementation.routing.PartitionKeyRangeIdentity;\n+import io.netty.handler.ssl.SslContext;\n+import org.mockito.Mockito;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Test;\n+\n+import java.util.HashMap;\n+import java.util.UUID;\n+\n+import static com.azure.cosmos.implementation.TestUtils.mockDiagnosticsClientContext;\n+\n+public class ConnectionStateListenerTest {\n+\n+    private static int port = 8082;\n+    private static String serverUriString = \"rntbd://localhost:\" + port;\n+\n+    @DataProvider(name = \"connectionStateListenerConfigProvider\")\n+    public Object[][] connectionStateListenerConfigProvider() {\n+        return new Object[][]{\n+            // isTcpConnectionEndpointRediscoveryEnabled, serverResponseType, GlobalAddressResolver.updateAddresses() called times\n+            {true, RequestResponseType.CHANNEL_FIN, 1},\n+            {false, RequestResponseType.CHANNEL_FIN, 0},\n+            {true, RequestResponseType.CHANNEL_RST, 0},\n+            {false, RequestResponseType.CHANNEL_RST, 0},\n+        };\n+    }\n+\n+    @Test(dataProvider = \"connectionStateListenerConfigProvider\")", "originalCommit": "2450fbc415ec84f3a7449f81f07fe1a8132a26b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg5NjMxOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17200#discussion_r518896319", "bodyText": "Added.", "author": "xinlian12", "createdAt": "2020-11-06T17:25:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ2MTA4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ2MTEzMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17200#discussion_r518461132", "bodyText": "this is a great test thank you.", "author": "moderakh", "createdAt": "2020-11-06T00:58:16Z", "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/implementation/directconnectivity/ConnectionStateListenerTest.java", "diffHunk": "@@ -0,0 +1,96 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos.implementation.directconnectivity;\n+\n+import com.azure.cosmos.DirectConnectionConfig;\n+import com.azure.cosmos.implementation.Configs;\n+import com.azure.cosmos.implementation.ConnectionPolicy;\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.implementation.OperationType;\n+import com.azure.cosmos.implementation.ResourceType;\n+import com.azure.cosmos.implementation.RxDocumentServiceRequest;\n+import com.azure.cosmos.implementation.UserAgentContainer;\n+import com.azure.cosmos.implementation.directconnectivity.TcpServerMock.TcpServerFactory;\n+import com.azure.cosmos.implementation.directconnectivity.TcpServerMock.TcpServer;\n+import com.azure.cosmos.implementation.directconnectivity.TcpServerMock.RequestResponseType;\n+import com.azure.cosmos.implementation.directconnectivity.TcpServerMock.SslContextUtils;\n+import com.azure.cosmos.implementation.routing.PartitionKeyRangeIdentity;\n+import io.netty.handler.ssl.SslContext;\n+import org.mockito.Mockito;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Test;\n+\n+import java.util.HashMap;\n+import java.util.UUID;\n+\n+import static com.azure.cosmos.implementation.TestUtils.mockDiagnosticsClientContext;\n+\n+public class ConnectionStateListenerTest {", "originalCommit": "2450fbc415ec84f3a7449f81f07fe1a8132a26b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg5NjE2NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17200#discussion_r518896165", "bodyText": "thanks Mo~", "author": "xinlian12", "createdAt": "2020-11-06T17:25:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ2MTEzMg=="}], "type": "inlineReview"}, {"oid": "f3066d21f700e1d4dfa349786ed5ceca7433ecb5", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f3066d21f700e1d4dfa349786ed5ceca7433ecb5", "message": "resolve comments", "committedDate": "2020-11-06T16:42:44Z", "type": "commit"}, {"oid": "629fcd2e8ef969e9916f60842cb3efdbc9698651", "url": "https://github.com/Azure/azure-sdk-for-java/commit/629fcd2e8ef969e9916f60842cb3efdbc9698651", "message": "make the test more robust", "committedDate": "2020-11-06T17:24:50Z", "type": "commit"}, {"oid": "d7a21dc5715ab23c2e4ad817e2338fb80a526498", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d7a21dc5715ab23c2e4ad817e2338fb80a526498", "message": "solve compilation error", "committedDate": "2020-11-06T17:39:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODkyOTUwNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17200#discussion_r518929504", "bodyText": "also can we replace this with ObjectNode?\nSome of the existing tests use Document but for new tests it is better to move to the new model.", "author": "moderakh", "createdAt": "2020-11-06T18:28:21Z", "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/implementation/directconnectivity/ConnectionStateListenerTest.java", "diffHunk": "@@ -0,0 +1,104 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos.implementation.directconnectivity;\n+\n+import com.azure.cosmos.DirectConnectionConfig;\n+import com.azure.cosmos.implementation.Configs;\n+import com.azure.cosmos.implementation.ConnectionPolicy;\n+import com.azure.cosmos.implementation.Document;\n+import com.azure.cosmos.implementation.OperationType;\n+import com.azure.cosmos.implementation.ResourceType;\n+import com.azure.cosmos.implementation.RxDocumentServiceRequest;\n+import com.azure.cosmos.implementation.UserAgentContainer;\n+import com.azure.cosmos.implementation.directconnectivity.TcpServerMock.TcpServerFactory;\n+import com.azure.cosmos.implementation.directconnectivity.TcpServerMock.TcpServer;\n+import com.azure.cosmos.implementation.directconnectivity.TcpServerMock.RequestResponseType;\n+import com.azure.cosmos.implementation.directconnectivity.TcpServerMock.SslContextUtils;\n+import com.azure.cosmos.implementation.routing.PartitionKeyRangeIdentity;\n+import io.netty.handler.ssl.SslContext;\n+import org.mockito.Mockito;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Test;\n+\n+import java.util.HashMap;\n+import java.util.UUID;\n+import java.util.concurrent.ExecutionException;\n+\n+import static com.azure.cosmos.implementation.TestUtils.mockDiagnosticsClientContext;\n+\n+public class ConnectionStateListenerTest {\n+\n+    private static int port = 8082;\n+    private static String serverUriString = \"rntbd://localhost:\" + port;\n+    private static final Logger logger = LoggerFactory.getLogger(ConnectionStateListenerTest.class);\n+\n+    @DataProvider(name = \"connectionStateListenerConfigProvider\")\n+    public Object[][] connectionStateListenerConfigProvider() {\n+        return new Object[][]{\n+            // isTcpConnectionEndpointRediscoveryEnabled, serverResponseType, GlobalAddressResolver.updateAddresses() called times\n+            {true, RequestResponseType.CHANNEL_FIN, 1},\n+            {false, RequestResponseType.CHANNEL_FIN, 0},\n+            {true, RequestResponseType.CHANNEL_RST, 0},\n+            {false, RequestResponseType.CHANNEL_RST, 0},\n+        };\n+    }\n+\n+    @Test(groups = { \"unit\" }, dataProvider = \"connectionStateListenerConfigProvider\")\n+    public void connectionStateListener_OnConnectionEvent(\n+        boolean isTcpConnectionEndpointRediscoveryEnabled,\n+        RequestResponseType responseType,\n+        int times) throws ExecutionException, InterruptedException {\n+\n+        TcpServer server = TcpServerFactory.startNewRntbdServer(port);\n+        // Inject fake response\n+        server.injectServerResponse(responseType);\n+\n+        ConnectionPolicy connectionPolicy = new ConnectionPolicy(DirectConnectionConfig.getDefaultConfig());\n+        connectionPolicy.setTcpConnectionEndpointRediscoveryEnabled(isTcpConnectionEndpointRediscoveryEnabled);\n+\n+        GlobalAddressResolver addressResolver = Mockito.mock(GlobalAddressResolver.class);\n+\n+        SslContext sslContext = SslContextUtils.CreateSslContext(\"client.jks\", false);\n+\n+        Configs config = Mockito.mock(Configs.class);\n+        Mockito.doReturn(sslContext).when(config).getSslContext();\n+\n+        RntbdTransportClient client = new RntbdTransportClient(\n+            config,\n+            connectionPolicy,\n+            new UserAgentContainer(),\n+            addressResolver);\n+\n+        RxDocumentServiceRequest req =\n+            RxDocumentServiceRequest.create(mockDiagnosticsClientContext(), OperationType.Create, ResourceType.Document,\n+                \"dbs/fakedb/colls/fakeColls\",\n+                getDocumentDefinition(), new HashMap<>());\n+        req.setPartitionKeyRangeIdentity(new PartitionKeyRangeIdentity(\"fakeCollectionId\",\"fakePartitionKeyRangeId\"));\n+\n+        Uri targetUri = new Uri(serverUriString);\n+        try {\n+            client.invokeStoreAsync(targetUri, req).block();\n+        } catch (Exception e) {\n+            logger.info(\"expected failed request with reason {}\", e);\n+        }\n+        finally {\n+            Mockito.verify(addressResolver, Mockito.times(times)).updateAddresses(Mockito.any(), Mockito.any());\n+        }\n+\n+        TcpServerFactory.shutdownRntbdServer(server);\n+    }\n+\n+    private Document getDocumentDefinition() {\n+        String uuid = UUID.randomUUID().toString();\n+        Document doc = new Document(String.format(\"{ \"", "originalCommit": "d7a21dc5715ab23c2e4ad817e2338fb80a526498", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODkzMDQ2Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17200#discussion_r518930463", "bodyText": "@moderakh  sorry Mo I merged the PR, I will change this in a following PR, thanks~", "author": "xinlian12", "createdAt": "2020-11-06T18:30:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODkyOTUwNA=="}], "type": "inlineReview"}]}