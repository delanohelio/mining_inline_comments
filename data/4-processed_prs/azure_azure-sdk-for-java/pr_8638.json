{"pr_number": 8638, "pr_title": "Distributed tracing for EventHubs: add enqueueTime to Process span links ", "pr_createdAt": "2020-03-02T10:52:57Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/8638", "timeline": [{"oid": "a0f4c3af611772759d7c7829a0f9610e5f6b71c6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a0f4c3af611772759d7c7829a0f9610e5f6b71c6", "message": "udpate for eph enqueue time message", "committedDate": "2020-03-02T12:44:55Z", "type": "commit"}, {"oid": "a0f4c3af611772759d7c7829a0f9610e5f6b71c6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a0f4c3af611772759d7c7829a0f9610e5f6b71c6", "message": "udpate for eph enqueue time message", "committedDate": "2020-03-02T12:44:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzIzMzc4Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8638#discussion_r387233786", "bodyText": "Did you mean to change it from eventData2 -> eventData1? The same event data returns two different sequence values?", "author": "conniey", "createdAt": "2020-03-03T19:10:33Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/test/java/com/azure/messaging/eventhubs/EventProcessorClientTest.java", "diffHunk": "@@ -200,9 +202,10 @@ public void testProcessSpans() throws Exception {\n             .createConsumer(anyString(), anyInt()))\n             .thenReturn(consumer1);\n         when(eventData1.getSequenceNumber()).thenReturn(1L);\n-        when(eventData2.getSequenceNumber()).thenReturn(2L);\n+        when(eventData1.getSequenceNumber()).thenReturn(2L);", "originalCommit": "a0f4c3af611772759d7c7829a0f9610e5f6b71c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI3NDkxMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8638#discussion_r387274911", "bodyText": "Was meaning to remove eventData2 altogether.  Removed now.", "author": "samvaity", "createdAt": "2020-03-03T20:28:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzIzMzc4Ng=="}], "type": "inlineReview"}, {"oid": "7ecab65f0649b26332287a8e3c0b84bc2f117b61", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7ecab65f0649b26332287a8e3c0b84bc2f117b61", "message": "update tracing changelog and review comment", "committedDate": "2020-03-03T20:28:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg1MzIzMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8638#discussion_r387853233", "bodyText": "Same constant is declared in OpenTelemetryTracer too. Can this defined in just one place?", "author": "srnagar", "createdAt": "2020-03-04T18:30:13Z", "path": "sdk/core/azure-core/src/main/java/com/azure/core/util/tracing/Tracer.java", "diffHunk": "@@ -62,6 +62,11 @@\n      */\n     String SPAN_BUILDER_KEY = \"builder\";\n \n+    /**\n+     * Key for {@link Context} which indicates the the time of the last enqueued message in the partition's stream.\n+     */\n+    String MESSAGE_ENQUEUED_TIME = \"x-opt-enqueued-time\";", "originalCommit": "7ecab65f0649b26332287a8e3c0b84bc2f117b61", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg1NzU3Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8638#discussion_r387857576", "bodyText": "Should we convert time to Instant type? On the span, would a string formatted datetime make it easier than a long?", "author": "srnagar", "createdAt": "2020-03-04T18:38:14Z", "path": "sdk/core/azure-core-tracing-opentelemetry/src/main/java/com/azure/core/tracing/opentelemetry/OpenTelemetryTracer.java", "diffHunk": "@@ -256,28 +260,32 @@ private static Context setContextData(Span span) {\n      */\n     private void addSpanRequestAttributes(Span span, Context context, String spanName) {\n         Objects.requireNonNull(span, \"'span' cannot be null.\");\n-        span.setAttribute(\n-            MESSAGE_BUS_DESTINATION,\n-            AttributeValue.stringAttributeValue(getOrDefault(context, ENTITY_PATH_KEY, \"\", String.class)));\n-        span.setAttribute(\n-            PEER_ENDPOINT,\n-            AttributeValue.stringAttributeValue(getOrDefault(context, HOST_NAME_KEY, \"\", String.class)));\n-        span.setAttribute(\n-            AZ_NAMESPACE_KEY,\n-            AttributeValue.stringAttributeValue(getOrDefault(context, AZ_TRACING_NAMESPACE_KEY, \"\", String.class)));\n+        String entityPath = getOrDefault(context, ENTITY_PATH_KEY, null, String.class);\n+        if (entityPath != null) {\n+            span.setAttribute(MESSAGE_BUS_DESTINATION, AttributeValue.stringAttributeValue(entityPath));\n+        }\n+        String hostName = getOrDefault(context, HOST_NAME_KEY, null, String.class);\n+        if (hostName != null) {\n+            span.setAttribute(PEER_ENDPOINT, AttributeValue.stringAttributeValue(hostName));\n+        }\n+        Long messageEnqueuedTime = getOrDefault(context, MESSAGE_ENQUEUED_TIME, null, Long.class);", "originalCommit": "7ecab65f0649b26332287a8e3c0b84bc2f117b61", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg2MjUxMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/8638#discussion_r387862513", "bodyText": "There is a direct specification to have this as a long value. It could be directly be used as-is if kept long, maybe?\n\nPlease add enqueuedTime attribute on each link when processing messages: unix epoch time with milliseconds precision representing when message was enqueued (x-opt-enqueued-time system property). Attribute value should have long type.", "author": "samvaity", "createdAt": "2020-03-04T18:47:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg1NzU3Ng=="}], "type": "inlineReview"}, {"oid": "62dae385a4cc13bfa7f11c26a95815238f0042b2", "url": "https://github.com/Azure/azure-sdk-for-java/commit/62dae385a4cc13bfa7f11c26a95815238f0042b2", "message": "update review comment", "committedDate": "2020-03-04T20:22:52Z", "type": "commit"}]}