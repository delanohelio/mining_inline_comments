{"pr_number": 18332, "pr_title": "add scopes for graph and office client in test and sample", "pr_createdAt": "2020-12-23T09:24:00Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/18332", "timeline": [{"oid": "76723379578b21748c8f400d707712a495481a87", "url": "https://github.com/Azure/azure-sdk-for-java/commit/76723379578b21748c8f400d707712a495481a87", "message": "add unit test for AzureOauth2RefreshTokenGrantRequestEntityConverter", "committedDate": "2020-12-18T02:51:20Z", "type": "commit"}, {"oid": "7d11fd95bb88be1a4d50df3bc223e71c818bdea9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7d11fd95bb88be1a4d50df3bc223e71c818bdea9", "message": "add distinction to refreshtoken converter", "committedDate": "2020-12-18T02:53:12Z", "type": "commit"}, {"oid": "9a6738890e88d3441fffb7d432043d530ad42957", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9a6738890e88d3441fffb7d432043d530ad42957", "message": "Merge branch 'master' of https://github.com/Azure/azure-sdk-for-java into add-unit-test", "committedDate": "2020-12-18T02:53:42Z", "type": "commit"}, {"oid": "7f3cdc19e00328439d0868179ae6415a0ae813f8", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7f3cdc19e00328439d0868179ae6415a0ae813f8", "message": "add unit test for AzureOauth2RefreshTokenGrantRequestEntityConverterTest", "committedDate": "2020-12-18T08:43:49Z", "type": "commit"}, {"oid": "8af1ac15b4694a5d1a0f1b0e5d5a5c0c2ffd1de7", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8af1ac15b4694a5d1a0f1b0e5d5a5c0c2ffd1de7", "message": "add integration test for RefreshTokenConverter", "committedDate": "2020-12-18T08:44:50Z", "type": "commit"}, {"oid": "671b41302524b0586aed6ac384118372b9c48ffe", "url": "https://github.com/Azure/azure-sdk-for-java/commit/671b41302524b0586aed6ac384118372b9c48ffe", "message": "add ConditionalOnResource for AADWebAppConfiguration", "committedDate": "2020-12-18T08:49:47Z", "type": "commit"}, {"oid": "8b436508f5eed7adc1620752c147672e1130cab3", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8b436508f5eed7adc1620752c147672e1130cab3", "message": "use multi tenant", "committedDate": "2020-12-18T10:05:13Z", "type": "commit"}, {"oid": "e1cca0675b638d7b0c597dc1fb2b9eede735370d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e1cca0675b638d7b0c597dc1fb2b9eede735370d", "message": "format code", "committedDate": "2020-12-18T10:14:59Z", "type": "commit"}, {"oid": "f6bcb175a1690769fcf76bb8e5cfe83cde123b73", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f6bcb175a1690769fcf76bb8e5cfe83cde123b73", "message": "Merge branch 'master' of https://github.com/Azure/azure-sdk-for-java into add-unit-test", "committedDate": "2020-12-21T03:16:52Z", "type": "commit"}, {"oid": "74b7e212682a0dcde901c84e2e2045de44a7d31a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/74b7e212682a0dcde901c84e2e2045de44a7d31a", "message": "change function and properties", "committedDate": "2020-12-21T08:17:26Z", "type": "commit"}, {"oid": "5179ff03ae9088167a1c0b58544c1a526c62be39", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5179ff03ae9088167a1c0b58544c1a526c62be39", "message": "reuse codes", "committedDate": "2020-12-21T08:18:46Z", "type": "commit"}, {"oid": "08c59c2a0012be916cf82a20be61f4490dba04eb", "url": "https://github.com/Azure/azure-sdk-for-java/commit/08c59c2a0012be916cf82a20be61f4490dba04eb", "message": "edit test config to enable refreshTokenConverter", "committedDate": "2020-12-22T02:18:46Z", "type": "commit"}, {"oid": "20d5d033d6481f15618c1f237a285c2cf05044d0", "url": "https://github.com/Azure/azure-sdk-for-java/commit/20d5d033d6481f15618c1f237a285c2cf05044d0", "message": "Merge branch 'master' into add-unit-test", "committedDate": "2020-12-22T02:44:21Z", "type": "commit"}, {"oid": "efa9f795f8ae04395fa9882db6a99aeae5749f2d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/efa9f795f8ae04395fa9882db6a99aeae5749f2d", "message": "edit default configure", "committedDate": "2020-12-22T03:24:00Z", "type": "commit"}, {"oid": "3c765cc57b503b3922736425d7ceeab4ddd5cb82", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3c765cc57b503b3922736425d7ceeab4ddd5cb82", "message": "merge master", "committedDate": "2020-12-22T06:26:14Z", "type": "commit"}, {"oid": "bc73f259102564faccad5e9e2070f85cd4c88552", "url": "https://github.com/Azure/azure-sdk-for-java/commit/bc73f259102564faccad5e9e2070f85cd4c88552", "message": "remove refreshTokenConverter and test", "committedDate": "2020-12-22T07:03:26Z", "type": "commit"}, {"oid": "a44207e47c63534726a3536988cd3b0ec1787eab", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a44207e47c63534726a3536988cd3b0ec1787eab", "message": "Merge branch 'master' of https://github.com/Azure/azure-sdk-for-java into add-unit-test", "committedDate": "2020-12-22T09:30:55Z", "type": "commit"}, {"oid": "0c613ceff3de32f12fc0a882249c5afb49e98d56", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0c613ceff3de32f12fc0a882249c5afb49e98d56", "message": "Merge branch 'master' of https://github.com/Azure/azure-sdk-for-java into add-unit-test", "committedDate": "2020-12-23T01:29:42Z", "type": "commit"}, {"oid": "74a5aab36c6ce71b8176a484bf77c42d425f4cf8", "url": "https://github.com/Azure/azure-sdk-for-java/commit/74a5aab36c6ce71b8176a484bf77c42d425f4cf8", "message": "carry on pr #18269", "committedDate": "2020-12-23T02:39:17Z", "type": "commit"}, {"oid": "e381c3514a5e6d26bdf5c2a71a3ed517cc486c48", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e381c3514a5e6d26bdf5c2a71a3ed517cc486c48", "message": "Merge branch 'master' of https://github.com/Azure/azure-sdk-for-java into add-unit-test", "committedDate": "2020-12-23T08:12:26Z", "type": "commit"}, {"oid": "6745add87e6a33e49e0a846e80e80539827e35b4", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6745add87e6a33e49e0a846e80e80539827e35b4", "message": "add scopes for graph and office client in test and sample", "committedDate": "2020-12-23T09:17:40Z", "type": "commit"}, {"oid": "7f51d0c69491ca72833c7028eee9fd03dcb3b71d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7f51d0c69491ca72833c7028eee9fd03dcb3b71d", "message": "merge master", "committedDate": "2020-12-23T09:28:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODMyNTM1Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18332#discussion_r548325356", "bodyText": "Mistake here.", "author": "chenrujun", "createdAt": "2020-12-24T00:02:05Z", "path": "sdk/spring/azure-spring-boot-samples/azure-spring-boot-sample-active-directory-webapp/README.md", "diffHunk": "@@ -19,16 +19,16 @@ Follow the guide [here](https://docs.microsoft.com/azure/active-directory/develo\n - Ensure **Access tokens** and **ID tokens** are selected.\n - To use on-demand authorization of certain resource, you need to add redirect URIs of `http://localhost:8080/login/oauth2/code/{registration-id}`. In this sample, set redirect URIs with `http://localhost:8080/login/oauth2/code/arm`.\n ### Configure necessary API permissions\n-The sample retrieves user's group memberships using Microsoft graph API which requires the registered app to have `Directory.AccessAsUser.All` permission under `Delegated Permissions` of `Microsoft Graph`, which can allow an application to access the directory as the signed-in user. Also, to display the function of calling multiple resources, this sample will acquire `ActivityFeed.Read` permission under `Office 365 Management APIs` resource. You need AAD admin privilege to be able to grant the permission in API ACCESS -> Required permission. You can follow the below steps:\t\n+The sample retrieves user's group memberships using Microsoft graph API which requires the registered app to have `Directory.AccessAsUser.All`, `User.Read` permission under `Delegated Permissions` of `Microsoft Graph`, which can allow an application to access the directory as the signed-in user. Also, to display the function of calling multiple resources, this sample will acquire `ActivityFeed.Read`, `ActivityFeed.ReadDlp`, `ServiceHealth.Read` permission under `Office 365 Management APIs` resource. You need AAD admin privilege to be able to grant the permission in API ACCESS -> Required permission. You can follow the below steps:\t\n \n * In the list of pages for the app, select **API permissions**\t\n    - Click the **Add a permission** button\t\n    - Ensure that the **Microsoft APIs** tab is selected\t\n    - In the *Commonly used Microsoft APIs* section, click on **Microsoft Graph**\t\n-   - In the **Delegated permissions** section, ensure that the right permissions are checked: **Directory.AccessAsUser.All**\t\n+   - In the **Delegated permissions** section, ensure that the right permissions are checked: **Directory.AccessAsUser.All**, **ActivityFeed.ReadDlp**, **ServiceHealth.Read**", "originalCommit": "7f51d0c69491ca72833c7028eee9fd03dcb3b71d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODMyNTc0OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18332#discussion_r548325749", "bodyText": "Please set according to this image:", "author": "chenrujun", "createdAt": "2020-12-24T00:04:18Z", "path": "sdk/spring/azure-spring-boot-samples/azure-spring-boot-sample-active-directory-webapp/src/main/resources/application.yml", "diffHunk": "@@ -5,9 +5,14 @@ azure:\n         on-demand: true\n         scopes: https://management.core.windows.net/user_impersonation\n       graph:\n-        scopes: https://graph.microsoft.com/Calendars.Read\n+        scopes:\n+            - https://graph.microsoft.com/Calendars.Read", "originalCommit": "7f51d0c69491ca72833c7028eee9fd03dcb3b71d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODMyNjA4MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18332#discussion_r548326080", "bodyText": "So azure's scope is always same to graph's?", "author": "chenrujun", "createdAt": "2020-12-24T00:05:58Z", "path": "sdk/spring/azure-spring-boot-test-aad/src/test/java/com/azure/test/aad/converter/AccessTokenScopesIT.java", "diffHunk": "@@ -18,29 +18,33 @@\n \n import java.util.*;\n \n-public class RefreshTokenScopesIT {\n+public class AccessTokenScopesIT {\n \n     @Test\n     public void testRefreshTokenConverter() {\n         try (AppRunner app = new AppRunner(DumbApp.class)) {\n             SeleniumTestUtils.addProperty(app);\n-            app.property(\"azure.activedirectory.authorization.office.scopes\", \"https://manage.office.com/ActivityFeed.Read\");\n-            app.property(\"azure.activedirectory.authorization.graph.scopes\", \"https://graph.microsoft.com/User.Read\");\n+            app.property(\"azure.activedirectory.authorization.office.scopes\", \"https://manage.office.com/ActivityFeed.Read , https://manage.office.com/ActivityFeed.ReadDlp , https://manage.office.com/ServiceHealth.Read\");\n+            app.property(\"azure.activedirectory.authorization.graph.scopes\", \"https://graph.microsoft.com/User.Read , https://graph.microsoft.com/AccessReview.Read.All\");\n             List<String> endPoints = new ArrayList<>();\n-            endPoints.add(\"api/office\");\n-            endPoints.add(\"api/azure\");\n-            endPoints.add(\"api/graph\");\n-            endPoints.add(\"api/arm\");\n+            endPoints.add(\"accessTokenScopes/office\");\n+            endPoints.add(\"accessTokenScopes/azure\");\n+            endPoints.add(\"accessTokenScopes/graph\");\n+            endPoints.add(\"accessTokenScopes/arm\");\n             Map<String, String> result = SeleniumTestUtils.get(app, endPoints);\n \n-            Assert.assertFalse(result.get(\"api/office\").contains(\"profile\"));\n-            Assert.assertTrue(result.get(\"api/office\").contains(\"https://manage.office.com/ActivityFeed.Read\"));\n+            Assert.assertFalse(result.get(\"accessTokenScopes/office\").contains(\"profile\"));\n+            Assert.assertTrue(result.get(\"accessTokenScopes/office\").contains(\"https://manage.office.com/ActivityFeed.Read\"));\n+            Assert.assertTrue(result.get(\"accessTokenScopes/office\").contains(\"https://manage.office.com/ActivityFeed.ReadDlp\"));\n+            Assert.assertTrue(result.get(\"accessTokenScopes/office\").contains(\"https://manage.office.com/ServiceHealth.Read\"));\n \n-            Assert.assertTrue(result.get(\"api/azure\").contains(\"profile\"));\n-            Assert.assertTrue(result.get(\"api/azure\").contains(\"https://graph.microsoft.com/User.Read\"));\n+            Assert.assertTrue(result.get(\"accessTokenScopes/azure\").contains(\"profile\"));\n+            Assert.assertTrue(result.get(\"accessTokenScopes/azure\").contains(\"https://graph.microsoft.com/AccessReview.Read.All\"));\n+            Assert.assertTrue(result.get(\"accessTokenScopes/azure\").contains(\"https://graph.microsoft.com/User.Read\"));", "originalCommit": "7f51d0c69491ca72833c7028eee9fd03dcb3b71d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODMzOTgzMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18332#discussion_r548339830", "bodyText": "The scopes of each client of the same resource is the same", "author": "zhichengliu12581", "createdAt": "2020-12-24T01:17:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODMyNjA4MA=="}], "type": "inlineReview"}, {"oid": "36c1d9f03d5c5e4849c3e42c14f54220b190068b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/36c1d9f03d5c5e4849c3e42c14f54220b190068b", "message": "fix scopes error", "committedDate": "2020-12-24T01:25:08Z", "type": "commit"}, {"oid": "2ec6c4e2890e1c6d89b651bbb88716e81fa8ad78", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2ec6c4e2890e1c6d89b651bbb88716e81fa8ad78", "message": "Merge branch 'add-unit-test' of https://github.com/lzc-1997-abel/azure-sdk-for-java into add-unit-test", "committedDate": "2020-12-24T09:19:43Z", "type": "commit"}, {"oid": "767430e68f985be803518c946db5f9ae465dadc0", "url": "https://github.com/Azure/azure-sdk-for-java/commit/767430e68f985be803518c946db5f9ae465dadc0", "message": "Merge branch 'master' of https://github.com/Azure/azure-sdk-for-java into add-unit-test", "committedDate": "2020-12-24T09:29:20Z", "type": "commit"}, {"oid": "e5fbcc9a6244dbb48843625fa378896327a6e608", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e5fbcc9a6244dbb48843625fa378896327a6e608", "message": "change scopes", "committedDate": "2020-12-24T09:34:08Z", "type": "commit"}]}