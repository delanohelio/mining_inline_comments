{"pr_number": 12205, "pr_title": "PR for EH + serializer integration", "pr_createdAt": "2020-06-15T21:54:26Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/12205", "timeline": [{"oid": "6e895f2290c7b9791fc34d303676bd5a3bd07e04", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6e895f2290c7b9791fc34d303676bd5a3bd07e04", "message": "create draft PR", "committedDate": "2020-06-15T21:53:26Z", "type": "commit"}, {"oid": "544a6e77b9e7c8754801e645fa8924eed96f4c56", "url": "https://github.com/Azure/azure-sdk-for-java/commit/544a6e77b9e7c8754801e645fa8924eed96f4c56", "message": "fix object batch", "committedDate": "2020-06-16T23:27:07Z", "type": "commit"}, {"oid": "7e9ae15ea7c91c2aeb39ccab38021312240aebfe", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7e9ae15ea7c91c2aeb39ccab38021312240aebfe", "message": "temp object serializer", "committedDate": "2020-07-01T22:29:24Z", "type": "commit"}, {"oid": "b5a1decbc3f50b0bfc3b18e5c6f9775c1a7f9c15", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b5a1decbc3f50b0bfc3b18e5c6f9775c1a7f9c15", "message": "Merge branch 'master' into arerlend.schemaregistry.eh-integration", "committedDate": "2020-07-01T22:31:00Z", "type": "commit"}, {"oid": "82eb0ff7a1cdf791fd4fa447e85400c0557b167d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/82eb0ff7a1cdf791fd4fa447e85400c0557b167d", "message": "dep on core experimental", "committedDate": "2020-07-01T23:34:25Z", "type": "commit"}, {"oid": "eda212d0dda4351f68162b7eb70f984f945f3168", "url": "https://github.com/Azure/azure-sdk-for-java/commit/eda212d0dda4351f68162b7eb70f984f945f3168", "message": "temp", "committedDate": "2020-07-01T23:36:02Z", "type": "commit"}, {"oid": "6a1d7e7baf571d41a767c003a268bd4d65fc1640", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6a1d7e7baf571d41a767c003a268bd4d65fc1640", "message": "getDeserializedObject()", "committedDate": "2020-07-02T17:48:34Z", "type": "commit"}, {"oid": "3560da282ad74b25adccbc15ef768975cffa6935", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3560da282ad74b25adccbc15ef768975cffa6935", "message": "null object in object batch test", "committedDate": "2020-07-02T21:46:32Z", "type": "commit"}, {"oid": "7a7bce3ba6747454325b9acc56cf474a5f9cd635", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7a7bce3ba6747454325b9acc56cf474a5f9cd635", "message": "remove old SR dep", "committedDate": "2020-07-02T21:52:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTkxNzc0OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12205#discussion_r449917749", "bodyText": "I would have expected to call this serializer by default - keen to hear other peoples thoughts though.", "author": "JonathanGiles", "createdAt": "2020-07-05T20:54:37Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventHubClientBuilder.java", "diffHunk": "@@ -361,6 +363,16 @@ public EventHubClientBuilder prefetchCount(int prefetchCount) {\n         return this;\n     }\n \n+    /**\n+     * Set registry serializer\n+     * @param objectSerializer serializer\n+     * @return updated builder instance\n+     */\n+    public EventHubClientBuilder objectSerializer(ObjectSerializer objectSerializer) {", "originalCommit": "7a7bce3ba6747454325b9acc56cf474a5f9cd635", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMyNDc4NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12205#discussion_r450324785", "bodyText": "+1 to Jonathan's thoughts.", "author": "conniey", "createdAt": "2020-07-06T16:03:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTkxNzc0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM1NTQxNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12205#discussion_r450355415", "bodyText": "Not at all attached to this.  I'll update it to serializer.", "author": "arerlend", "createdAt": "2020-07-06T16:53:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTkxNzc0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTkxNzkwMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12205#discussion_r449917901", "bodyText": "Nit: Different indentation here (and also in previous files, there was needless changes to indentation)", "author": "JonathanGiles", "createdAt": "2020-07-05T20:56:12Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/ObjectBatch.java", "diffHunk": "@@ -0,0 +1,62 @@\n+package com.azure.messaging.eventhubs;\n+\n+import com.azure.core.amqp.exception.AmqpException;\n+import com.azure.core.amqp.implementation.ErrorContextProvider;\n+import com.azure.core.amqp.implementation.TracerProvider;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.azure.core.experimental.serializer.ObjectSerializer;\n+import reactor.core.publisher.Mono;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.OutputStream;\n+import java.util.Objects;\n+\n+public final class ObjectBatch<T> extends Batch {\n+    private final ClientLogger logger = new ClientLogger(ObjectBatch.class);\n+    private final Object lock = new Object();\n+    private final Class<T> batchType;\n+    private final ObjectSerializer objectSerializer;\n+\n+    /**\n+     *\n+     * @param maxMessageSize\n+     * @param partitionId\n+     * @param partitionKey\n+     * @param batchType\n+     * @param contextProvider\n+     * @param tracerProvider\n+     * @param objectSerializer\n+     * @param entityPath\n+     * @param hostname\n+     */\n+    ObjectBatch(int maxMessageSize, String partitionId, String partitionKey, Class<T> batchType,\n+                    ErrorContextProvider contextProvider, TracerProvider tracerProvider,\n+                ObjectSerializer objectSerializer, String entityPath, String hostname) {", "originalCommit": "7a7bce3ba6747454325b9acc56cf474a5f9cd635", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "89e6cca3ba0110beb5707ce6d69d55fb8dcf9fc3", "url": "https://github.com/Azure/azure-sdk-for-java/commit/89e6cca3ba0110beb5707ce6d69d55fb8dcf9fc3", "message": "remove temporary interfaces", "committedDate": "2020-07-06T16:55:59Z", "type": "commit"}, {"oid": "f3acc8c9f72a0becbede6bae614c11e926c67803", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f3acc8c9f72a0becbede6bae614c11e926c67803", "message": "rename objectSerializer builder method to serializer", "committedDate": "2020-07-06T17:12:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQwODU1Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12205#discussion_r450408552", "bodyText": "Expand all imports instead of using *.", "author": "srnagar", "createdAt": "2020-07-06T18:35:11Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/Batch.java", "diffHunk": "@@ -0,0 +1,266 @@\n+package com.azure.messaging.eventhubs;\n+\n+import com.azure.core.amqp.AmqpMessageConstant;\n+import com.azure.core.amqp.exception.AmqpErrorCondition;\n+import com.azure.core.amqp.exception.AmqpException;\n+import com.azure.core.amqp.implementation.AmqpConstants;\n+import com.azure.core.amqp.implementation.ErrorContextProvider;\n+import com.azure.core.amqp.implementation.TracerProvider;\n+import com.azure.core.util.Context;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.azure.core.util.tracing.ProcessKind;\n+import org.apache.qpid.proton.Proton;\n+import org.apache.qpid.proton.amqp.Binary;\n+import org.apache.qpid.proton.amqp.Symbol;\n+import org.apache.qpid.proton.amqp.messaging.ApplicationProperties;\n+import org.apache.qpid.proton.amqp.messaging.Data;\n+import org.apache.qpid.proton.amqp.messaging.MessageAnnotations;\n+import org.apache.qpid.proton.message.Message;\n+import reactor.core.publisher.Signal;\n+\n+import java.nio.BufferOverflowException;\n+import java.util.*;", "originalCommit": "f3acc8c9f72a0becbede6bae614c11e926c67803", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQwOTE0Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12205#discussion_r450409143", "bodyText": "Add javadoc.", "author": "srnagar", "createdAt": "2020-07-06T18:36:24Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/Batch.java", "diffHunk": "@@ -0,0 +1,266 @@\n+package com.azure.messaging.eventhubs;\n+\n+import com.azure.core.amqp.AmqpMessageConstant;\n+import com.azure.core.amqp.exception.AmqpErrorCondition;\n+import com.azure.core.amqp.exception.AmqpException;\n+import com.azure.core.amqp.implementation.AmqpConstants;\n+import com.azure.core.amqp.implementation.ErrorContextProvider;\n+import com.azure.core.amqp.implementation.TracerProvider;\n+import com.azure.core.util.Context;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.azure.core.util.tracing.ProcessKind;\n+import org.apache.qpid.proton.Proton;\n+import org.apache.qpid.proton.amqp.Binary;\n+import org.apache.qpid.proton.amqp.Symbol;\n+import org.apache.qpid.proton.amqp.messaging.ApplicationProperties;\n+import org.apache.qpid.proton.amqp.messaging.Data;\n+import org.apache.qpid.proton.amqp.messaging.MessageAnnotations;\n+import org.apache.qpid.proton.message.Message;\n+import reactor.core.publisher.Signal;\n+\n+import java.nio.BufferOverflowException;\n+import java.util.*;\n+\n+import static com.azure.core.util.tracing.Tracer.*;\n+import static com.azure.messaging.eventhubs.implementation.ClientConstants.AZ_NAMESPACE_VALUE;\n+", "originalCommit": "f3acc8c9f72a0becbede6bae614c11e926c67803", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQwOTY1Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12205#discussion_r450409653", "bodyText": "Why protected?", "author": "srnagar", "createdAt": "2020-07-06T18:37:33Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/Batch.java", "diffHunk": "@@ -0,0 +1,266 @@\n+package com.azure.messaging.eventhubs;\n+\n+import com.azure.core.amqp.AmqpMessageConstant;\n+import com.azure.core.amqp.exception.AmqpErrorCondition;\n+import com.azure.core.amqp.exception.AmqpException;\n+import com.azure.core.amqp.implementation.AmqpConstants;\n+import com.azure.core.amqp.implementation.ErrorContextProvider;\n+import com.azure.core.amqp.implementation.TracerProvider;\n+import com.azure.core.util.Context;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.azure.core.util.tracing.ProcessKind;\n+import org.apache.qpid.proton.Proton;\n+import org.apache.qpid.proton.amqp.Binary;\n+import org.apache.qpid.proton.amqp.Symbol;\n+import org.apache.qpid.proton.amqp.messaging.ApplicationProperties;\n+import org.apache.qpid.proton.amqp.messaging.Data;\n+import org.apache.qpid.proton.amqp.messaging.MessageAnnotations;\n+import org.apache.qpid.proton.message.Message;\n+import reactor.core.publisher.Signal;\n+\n+import java.nio.BufferOverflowException;\n+import java.util.*;\n+\n+import static com.azure.core.util.tracing.Tracer.*;\n+import static com.azure.messaging.eventhubs.implementation.ClientConstants.AZ_NAMESPACE_VALUE;\n+\n+public abstract class Batch {\n+    private final ClientLogger logger = new ClientLogger(this.getClass());\n+    private final Object lock = new Object();\n+    private final int maxMessageSize;\n+    private final String partitionKey;\n+    private final ErrorContextProvider contextProvider;\n+    private final List<EventData> events;\n+    private final byte[] eventBytes;\n+    private final String partitionId;\n+    private int sizeInBytes;\n+    protected final TracerProvider tracerProvider;", "originalCommit": "f3acc8c9f72a0becbede6bae614c11e926c67803", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQxNDk5MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12205#discussion_r450414991", "bodyText": "The name Batch seems too generic. Since EventDataBatch is already taken, can't think of too many better alternatives. EventDataBatchBase maybe?", "author": "srnagar", "createdAt": "2020-07-06T18:48:25Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/Batch.java", "diffHunk": "@@ -0,0 +1,266 @@\n+package com.azure.messaging.eventhubs;\n+\n+import com.azure.core.amqp.AmqpMessageConstant;\n+import com.azure.core.amqp.exception.AmqpErrorCondition;\n+import com.azure.core.amqp.exception.AmqpException;\n+import com.azure.core.amqp.implementation.AmqpConstants;\n+import com.azure.core.amqp.implementation.ErrorContextProvider;\n+import com.azure.core.amqp.implementation.TracerProvider;\n+import com.azure.core.util.Context;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.azure.core.util.tracing.ProcessKind;\n+import org.apache.qpid.proton.Proton;\n+import org.apache.qpid.proton.amqp.Binary;\n+import org.apache.qpid.proton.amqp.Symbol;\n+import org.apache.qpid.proton.amqp.messaging.ApplicationProperties;\n+import org.apache.qpid.proton.amqp.messaging.Data;\n+import org.apache.qpid.proton.amqp.messaging.MessageAnnotations;\n+import org.apache.qpid.proton.message.Message;\n+import reactor.core.publisher.Signal;\n+\n+import java.nio.BufferOverflowException;\n+import java.util.*;\n+\n+import static com.azure.core.util.tracing.Tracer.*;\n+import static com.azure.messaging.eventhubs.implementation.ClientConstants.AZ_NAMESPACE_VALUE;\n+\n+public abstract class Batch {", "originalCommit": "f3acc8c9f72a0becbede6bae614c11e926c67803", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ1ODY1NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12205#discussion_r450458654", "bodyText": "Sure.  I will also move it to the implementation directory since it shouldn't be directly instantiated by users.", "author": "arerlend", "createdAt": "2020-07-06T20:20:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQxNDk5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUwMTQwNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12205#discussion_r450501406", "bodyText": "Actually leaving it here, makes inheritance significantly messier.", "author": "arerlend", "createdAt": "2020-07-06T21:58:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQxNDk5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQxNTcyNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12205#discussion_r450415725", "bodyText": "This doesn't have to be registry serializer. Any implementation of ObjectSerializer should work here.", "author": "srnagar", "createdAt": "2020-07-06T18:49:43Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventHubClientBuilder.java", "diffHunk": "@@ -361,6 +363,16 @@ public EventHubClientBuilder prefetchCount(int prefetchCount) {\n         return this;\n     }\n \n+    /**\n+     * Set registry serializer", "originalCommit": "f3acc8c9f72a0becbede6bae614c11e926c67803", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQxODA4Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12205#discussion_r450418087", "bodyText": "Setting a serializer on the builder should not force the producer to send ObjectBatch only.", "author": "srnagar", "createdAt": "2020-07-06T18:54:02Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventHubProducerAsyncClient.java", "diffHunk": "@@ -510,6 +584,41 @@ private String getEntityPath(String partitionId) {\n             .flatMap(connection -> connection.createSendLink(linkName, entityPath, retryOptions));\n     }\n \n+    private <T> Mono<T> verifySendMode(SendMode mode) {\n+        switch (mode) {\n+            case EVENT_DATA:\n+                if (serializer != null) {\n+                    return monoError(logger, new IllegalStateException());\n+                }", "originalCommit": "f3acc8c9f72a0becbede6bae614c11e926c67803", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQyMDM3NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12205#discussion_r450420374", "bodyText": "This is also used in createBatch() method for EventDataBatch. Update that method as well to call this method.", "author": "srnagar", "createdAt": "2020-07-06T18:58:39Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventHubProducerAsyncClient.java", "diffHunk": "@@ -510,6 +584,41 @@ private String getEntityPath(String partitionId) {\n             .flatMap(connection -> connection.createSendLink(linkName, entityPath, retryOptions));\n     }\n \n+    private <T> Mono<T> verifySendMode(SendMode mode) {\n+        switch (mode) {\n+            case EVENT_DATA:\n+                if (serializer != null) {\n+                    return monoError(logger, new IllegalStateException());\n+                }\n+                break;\n+            case OBJECT:\n+                if (serializer == null) {\n+                    return monoError(logger, new IllegalStateException());\n+                }\n+                break;\n+            default:\n+                break;\n+        }\n+\n+        return null;\n+    }\n+\n+    private <T> Mono<T> validateBatchOptions(CreateBatchOptions options) {\n+        if (!CoreUtils.isNullOrEmpty(options.getPartitionKey())\n+            && !CoreUtils.isNullOrEmpty(options.getPartitionId())) {\n+            return monoError(logger, new IllegalArgumentException(String.format(Locale.US,\n+                \"CreateBatchOptions.getPartitionKey() and CreateBatchOptions.getPartitionId() are both set. \"\n+                    + \"Only one or the other can be used. partitionKey: '%s'. partitionId: '%s'\",\n+                options.getPartitionKey(), options.getPartitionId())));\n+        } else if (!CoreUtils.isNullOrEmpty(options.getPartitionKey())\n+            && options.getPartitionKey().length() > MAX_PARTITION_KEY_LENGTH) {\n+            return monoError(logger, new IllegalArgumentException(String.format(Locale.US,\n+                \"Partition key '%s' exceeds the maximum allowed length: '%s'.\", options.getPartitionKey(),\n+                MAX_PARTITION_KEY_LENGTH)));\n+        }\n+        return null;\n+    }", "originalCommit": "f3acc8c9f72a0becbede6bae614c11e926c67803", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQyMDUxMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12205#discussion_r450420513", "bodyText": "add javadoc", "author": "srnagar", "createdAt": "2020-07-06T18:58:57Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/ObjectBatch.java", "diffHunk": "@@ -0,0 +1,62 @@\n+package com.azure.messaging.eventhubs;\n+\n+import com.azure.core.amqp.exception.AmqpException;\n+import com.azure.core.amqp.implementation.ErrorContextProvider;\n+import com.azure.core.amqp.implementation.TracerProvider;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.azure.core.experimental.serializer.ObjectSerializer;\n+import reactor.core.publisher.Mono;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.OutputStream;\n+import java.util.Objects;\n+\n+public final class ObjectBatch<T> extends Batch {", "originalCommit": "f3acc8c9f72a0becbede6bae614c11e926c67803", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQyMTQ1NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12205#discussion_r450421454", "bodyText": "Should this method return Mono<Boolean> instead to avoid blocking?", "author": "srnagar", "createdAt": "2020-07-06T19:00:49Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/ObjectBatch.java", "diffHunk": "@@ -0,0 +1,62 @@\n+package com.azure.messaging.eventhubs;\n+\n+import com.azure.core.amqp.exception.AmqpException;\n+import com.azure.core.amqp.implementation.ErrorContextProvider;\n+import com.azure.core.amqp.implementation.TracerProvider;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.azure.core.experimental.serializer.ObjectSerializer;\n+import reactor.core.publisher.Mono;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.OutputStream;\n+import java.util.Objects;\n+\n+public final class ObjectBatch<T> extends Batch {\n+    private final ClientLogger logger = new ClientLogger(ObjectBatch.class);\n+    private final Object lock = new Object();\n+    private final Class<T> batchType;\n+    private final ObjectSerializer objectSerializer;\n+\n+    /**\n+     *\n+     * @param maxMessageSize\n+     * @param partitionId\n+     * @param partitionKey\n+     * @param batchType\n+     * @param contextProvider\n+     * @param tracerProvider\n+     * @param objectSerializer\n+     * @param entityPath\n+     * @param hostname\n+     */\n+    ObjectBatch(int maxMessageSize, String partitionId, String partitionKey, Class<T> batchType,\n+                    ErrorContextProvider contextProvider, TracerProvider tracerProvider,\n+                ObjectSerializer objectSerializer, String entityPath, String hostname) {\n+        super(maxMessageSize, partitionId, partitionKey, contextProvider, tracerProvider, entityPath, hostname);\n+        this.batchType = Objects.requireNonNull(batchType, \"'batchType' cannot be null.\");\n+        this.objectSerializer = Objects.requireNonNull(objectSerializer, \"'objectSerializer' cannot be null.\");\n+    }\n+\n+    /**\n+     * Tries to add an object to the batch.\n+     *\n+     * @param object The object to add to the batch.\n+     * @return {@code true} if the object could be added to the batch; {@code false} if the serialized object\n+     *      was too large to fit in the batch.\n+     * @throws IllegalArgumentException if object is {@code null}.\n+     * @throws AmqpException if serialized object as {@link EventData} is larger than the maximum size\n+     *      of the {@link EventDataBatch}.\n+     */\n+    public Boolean tryAdd(final T object) {\n+        if (object == null) {\n+            throw logger.logExceptionAsWarning(new IllegalArgumentException(\"object cannot be null\"));\n+        }\n+\n+        ByteArrayOutputStream outputStream = new ByteArrayOutputStream();\n+        return objectSerializer.serialize(outputStream, object).map(s -> {\n+            EventData eventData = new EventData(s.toByteArray());\n+            EventData event = tracerProvider.isEnabled() ? traceMessageSpan(eventData) : eventData;\n+            return tryAdd(event);\n+        }).block();", "originalCommit": "f3acc8c9f72a0becbede6bae614c11e926c67803", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQzMDM1MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12205#discussion_r450430351", "bodyText": "The concern here was that EventDataBatch's TryAdd method is sync whereas this would be async.\nIf it's fine for it to be asymmetric, then async is absolutely fine.", "author": "arerlend", "createdAt": "2020-07-06T19:19:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQyMTQ1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ2MjE5OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12205#discussion_r450462199", "bodyText": "EventDataBatch's tryAdd has no IO operation and can be done synchronously. Here, the serializer can potentially make a service call and blocking can cause other issues downstream. Another option is to have tryAdd() and tryAddAsync().", "author": "srnagar", "createdAt": "2020-07-06T20:28:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQyMTQ1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ4NjMyMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12205#discussion_r450486322", "bodyText": "Yeah I thought it might be a bit confusing to have one sync and one async, but I'll just make sure it is clear in the javadoc.", "author": "arerlend", "createdAt": "2020-07-06T21:21:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQyMTQ1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQyMjUxOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12205#discussion_r450422518", "bodyText": "Should check objectType for null too.", "author": "srnagar", "createdAt": "2020-07-06T19:02:58Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/models/PartitionEvent.java", "diffHunk": "@@ -59,4 +66,19 @@ public EventData getData() {\n     public LastEnqueuedEventProperties getLastEnqueuedEventProperties() {\n         return lastEnqueuedEventProperties;\n     }\n+\n+    public <T> T getDeserializedObject(Class<T> objectType) {\n+        Objects.requireNonNull(objectSerializer, \"No serializer set for deserializing event data payload.\");", "originalCommit": "f3acc8c9f72a0becbede6bae614c11e926c67803", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQyMjkwMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12205#discussion_r450422901", "bodyText": "Same here - should not block in this method.", "author": "srnagar", "createdAt": "2020-07-06T19:03:53Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/models/PartitionEvent.java", "diffHunk": "@@ -59,4 +66,19 @@ public EventData getData() {\n     public LastEnqueuedEventProperties getLastEnqueuedEventProperties() {\n         return lastEnqueuedEventProperties;\n     }\n+\n+    public <T> T getDeserializedObject(Class<T> objectType) {\n+        Objects.requireNonNull(objectSerializer, \"No serializer set for deserializing event data payload.\");\n+\n+        if (deserialized != null) {\n+            if (objectType.isInstance(deserialized)) {\n+                return objectType.cast(deserialized);\n+            };\n+        }\n+\n+        T typedDeserializedObject =\n+            objectSerializer.deserialize(new ByteArrayInputStream(eventData.getBody()), objectType).block();", "originalCommit": "f3acc8c9f72a0becbede6bae614c11e926c67803", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQyMzUxOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12205#discussion_r450423519", "bodyText": "Since com.azure.core is always going to be there, we should keep this uncommented even though it's redundant when experimental is added for beta releases.", "author": "srnagar", "createdAt": "2020-07-06T19:05:14Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/module-info.java", "diffHunk": "@@ -2,7 +2,8 @@\n // Licensed under the MIT License.\n \n module com.azure.messaging.eventhubs {\n-    requires transitive com.azure.core;\n+//    requires transitive com.azure.core;", "originalCommit": "f3acc8c9f72a0becbede6bae614c11e926c67803", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c95145c0b1ead9c81139164bb9d95ba673cc294d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c95145c0b1ead9c81139164bb9d95ba673cc294d", "message": "single class imports", "committedDate": "2020-07-06T20:19:53Z", "type": "commit"}, {"oid": "4eed6e03208926dd9a2b78502ccb5929f06399a6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/4eed6e03208926dd9a2b78502ccb5929f06399a6", "message": "fix serializer builder javadoc", "committedDate": "2020-07-06T20:20:17Z", "type": "commit"}, {"oid": "f78469a45f76e6d58afa3d3f18aadde64e6a6f25", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f78469a45f76e6d58afa3d3f18aadde64e6a6f25", "message": "rename abstract batch impl", "committedDate": "2020-07-06T20:23:06Z", "type": "commit"}, {"oid": "c5d39fd91518226d6a1c0b98233d9c3c515b8bdb", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c5d39fd91518226d6a1c0b98233d9c3c515b8bdb", "message": "add EventDataBatchBase javadoc", "committedDate": "2020-07-06T21:09:44Z", "type": "commit"}, {"oid": "7a0fc351d37e69958bd3f8dd032e24ea195a8ef2", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7a0fc351d37e69958bd3f8dd032e24ea195a8ef2", "message": "mono TryAdd", "committedDate": "2020-07-06T21:12:45Z", "type": "commit"}, {"oid": "c9c1f295e395d3bf48e77efdff214a5b948c2251", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c9c1f295e395d3bf48e77efdff214a5b948c2251", "message": "fix modifiers", "committedDate": "2020-07-06T22:18:30Z", "type": "commit"}, {"oid": "6ea6bb61871ed659a1b13e4067e9183fd8681b7c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6ea6bb61871ed659a1b13e4067e9183fd8681b7c", "message": "remove send mode", "committedDate": "2020-07-06T22:18:57Z", "type": "commit"}, {"oid": "4fdfa93da80d135d7667052a19f8f5dfa24a2c6c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/4fdfa93da80d135d7667052a19f8f5dfa24a2c6c", "message": "fix object batch javadoc", "committedDate": "2020-07-06T22:19:21Z", "type": "commit"}, {"oid": "b976d2de3e787609f4579529395ed3498a1246bc", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b976d2de3e787609f4579529395ed3498a1246bc", "message": "partition event deserialize to async", "committedDate": "2020-07-06T22:19:49Z", "type": "commit"}, {"oid": "114f68d5e512069c61c754c56810c88837aee4f6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/114f68d5e512069c61c754c56810c88837aee4f6", "message": "uncomment azure core", "committedDate": "2020-07-06T22:20:02Z", "type": "commit"}, {"oid": "45c819ae7eb838eead933cb8d9f1e230c57f6a39", "url": "https://github.com/Azure/azure-sdk-for-java/commit/45c819ae7eb838eead933cb8d9f1e230c57f6a39", "message": "javadoc syntax", "committedDate": "2020-07-06T22:38:45Z", "type": "commit"}, {"oid": "533df1eb1f98bbbfb95ba14788a84973b6bb50a9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/533df1eb1f98bbbfb95ba14788a84973b6bb50a9", "message": "remove temp interface", "committedDate": "2020-07-06T23:02:58Z", "type": "commit"}, {"oid": "570fbea85fcd84161de4a4f5ebefc2b9b22a19a1", "url": "https://github.com/Azure/azure-sdk-for-java/commit/570fbea85fcd84161de4a4f5ebefc2b9b22a19a1", "message": "Merge branch 'master' into arerlend.schemaregistry.eh-integration", "committedDate": "2020-07-07T01:52:40Z", "type": "commit"}, {"oid": "d295b83b0bb6ecff5c6372115c6931b56318cf9c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d295b83b0bb6ecff5c6372115c6931b56318cf9c", "message": "only core-experimental, not core", "committedDate": "2020-07-07T02:03:44Z", "type": "commit"}, {"oid": "28c5f63ea6f12674ad18b8635368df8fc6d8d669", "url": "https://github.com/Azure/azure-sdk-for-java/commit/28c5f63ea6f12674ad18b8635368df8fc6d8d669", "message": "checkstyle", "committedDate": "2020-07-07T07:23:20Z", "type": "commit"}, {"oid": "2e66eb11ab6b56896e089e6128800fd4b7328f8b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2e66eb11ab6b56896e089e6128800fd4b7328f8b", "message": "update partition event deserialize", "committedDate": "2020-07-07T22:07:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIwMTExMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12205#discussion_r451201112", "bodyText": "What happens when the value is null at construction time?", "author": "alzimmermsft", "createdAt": "2020-07-07T23:34:57Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventHubClientBuilder.java", "diffHunk": "@@ -361,6 +363,18 @@ public EventHubClientBuilder prefetchCount(int prefetchCount) {\n         return this;\n     }\n \n+    /**\n+     * Set ObjectSerializer implementation to be used for creating ObjectBatch.\n+     *\n+     * @param serializer ObjectSerializer implementation\n+     *\n+     * @return updated builder instance\n+     */\n+    public EventHubClientBuilder serializer(ObjectSerializer serializer) {\n+        this.serializer = serializer;", "originalCommit": "2e66eb11ab6b56896e089e6128800fd4b7328f8b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIyNTMyNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12205#discussion_r451225325", "bodyText": "Yeah this is a very reasonable question.  Right now the client allows serializer to be null, and will check when you go down a serialization code path that serializer is set.  Otherwise it doesn't care if serializer is set or not.  I don't think this is particularly future proof behavior but the alternative aren't much better:\n\nsetting a pass-through \"byte array serializer\" that serves no purpose except to keep serializer from being null\nfully typing clients such that serializers must always be set\nnot fully typing clients with the following options, e.g. in produce\n\nObject-type parameter methods that determine if you're should use a serializer or not, like tryAdd(Object o)\nmethod overloads for tryAdd(Object o) or tryAdd(T o) and also tryAdd(EventData e)... which forces you to:\n\nallow EventDataBatch to contain both SR objects and hand-crafted EventData... which is a bad idea\nrestrict send modes to either  EventData mode or Object mode, based on whether a serializer is set", "author": "arerlend", "createdAt": "2020-07-08T01:06:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIwMTExMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIyMTY4Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12205#discussion_r451221682", "bodyText": "Would it be better to check this is non-null when validating batch options or could this be created from other contexts?", "author": "alzimmermsft", "createdAt": "2020-07-08T00:51:25Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/ObjectBatch.java", "diffHunk": "@@ -0,0 +1,53 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.messaging.eventhubs;\n+\n+import com.azure.core.amqp.exception.AmqpException;\n+import com.azure.core.amqp.implementation.ErrorContextProvider;\n+import com.azure.core.amqp.implementation.TracerProvider;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.azure.core.experimental.serializer.ObjectSerializer;\n+import reactor.core.publisher.Mono;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.util.Objects;\n+\n+/**\n+ * A class for aggregating Java objects into a single, size-limited, batch. Objects are serialized into EventData\n+ * objects and are added to the batch.  It is treated as a single message when sent to the Azure Event Hubs service.\n+ *\n+ * @param <T> type of objects in the batch.  Multi-type batches are not permitted.\n+ */\n+public final class ObjectBatch<T> extends EventDataBatchBase {\n+    private final ClientLogger logger = new ClientLogger(ObjectBatch.class);\n+    private final Class<T> batchType;\n+    private final ObjectSerializer objectSerializer;\n+\n+    ObjectBatch(int maxMessageSize, String partitionId, String partitionKey, Class<T> batchType,\n+                    ErrorContextProvider contextProvider, TracerProvider tracerProvider,\n+                    ObjectSerializer objectSerializer, String entityPath, String hostname) {\n+        super(maxMessageSize, partitionId, partitionKey, contextProvider, tracerProvider, entityPath, hostname);\n+        this.batchType = Objects.requireNonNull(batchType, \"'batchType' cannot be null.\");\n+        this.objectSerializer = Objects.requireNonNull(objectSerializer, \"'objectSerializer' cannot be null.\");", "originalCommit": "2e66eb11ab6b56896e089e6128800fd4b7328f8b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyMzkwMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12205#discussion_r451823900", "bodyText": "Added a check in object batch creation.", "author": "arerlend", "createdAt": "2020-07-08T21:03:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIyMTY4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIyMTc4Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12205#discussion_r451221787", "bodyText": "Should this be using monoError?", "author": "alzimmermsft", "createdAt": "2020-07-08T00:51:54Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/ObjectBatch.java", "diffHunk": "@@ -0,0 +1,53 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.messaging.eventhubs;\n+\n+import com.azure.core.amqp.exception.AmqpException;\n+import com.azure.core.amqp.implementation.ErrorContextProvider;\n+import com.azure.core.amqp.implementation.TracerProvider;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.azure.core.experimental.serializer.ObjectSerializer;\n+import reactor.core.publisher.Mono;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.util.Objects;\n+\n+/**\n+ * A class for aggregating Java objects into a single, size-limited, batch. Objects are serialized into EventData\n+ * objects and are added to the batch.  It is treated as a single message when sent to the Azure Event Hubs service.\n+ *\n+ * @param <T> type of objects in the batch.  Multi-type batches are not permitted.\n+ */\n+public final class ObjectBatch<T> extends EventDataBatchBase {\n+    private final ClientLogger logger = new ClientLogger(ObjectBatch.class);\n+    private final Class<T> batchType;\n+    private final ObjectSerializer objectSerializer;\n+\n+    ObjectBatch(int maxMessageSize, String partitionId, String partitionKey, Class<T> batchType,\n+                    ErrorContextProvider contextProvider, TracerProvider tracerProvider,\n+                    ObjectSerializer objectSerializer, String entityPath, String hostname) {\n+        super(maxMessageSize, partitionId, partitionKey, contextProvider, tracerProvider, entityPath, hostname);\n+        this.batchType = Objects.requireNonNull(batchType, \"'batchType' cannot be null.\");\n+        this.objectSerializer = Objects.requireNonNull(objectSerializer, \"'objectSerializer' cannot be null.\");\n+    }\n+\n+    /**\n+     * Tries to asynchronously serialize an object into an EventData payload and add the EventData to the batch.\n+     *\n+     * @param object The object to add to the batch.\n+     * @return {@code true} if the object could be added to the batch; {@code false} if the serialized\n+     * object was too large to fit in the batch.\n+     * @throws IllegalArgumentException if object is {@code null}.\n+     * @throws AmqpException if serialized object as {@link EventData} is larger than the maximum size\n+     *      of the {@link EventDataBatch}.\n+     */\n+    public Mono<Boolean> tryAdd(final T object) {\n+        if (object == null) {\n+            throw logger.logExceptionAsWarning(new IllegalArgumentException(\"object cannot be null\"));", "originalCommit": "2e66eb11ab6b56896e089e6128800fd4b7328f8b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIyMjEzOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12205#discussion_r451222139", "bodyText": "Given that this is internal a cool optimization would be creating a private extension of ByteArrayOuputStream to access its backing byte[] directly. toByteArray will make a clone of the byte[].", "author": "alzimmermsft", "createdAt": "2020-07-08T00:53:16Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/ObjectBatch.java", "diffHunk": "@@ -0,0 +1,53 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.messaging.eventhubs;\n+\n+import com.azure.core.amqp.exception.AmqpException;\n+import com.azure.core.amqp.implementation.ErrorContextProvider;\n+import com.azure.core.amqp.implementation.TracerProvider;\n+import com.azure.core.util.logging.ClientLogger;\n+import com.azure.core.experimental.serializer.ObjectSerializer;\n+import reactor.core.publisher.Mono;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.util.Objects;\n+\n+/**\n+ * A class for aggregating Java objects into a single, size-limited, batch. Objects are serialized into EventData\n+ * objects and are added to the batch.  It is treated as a single message when sent to the Azure Event Hubs service.\n+ *\n+ * @param <T> type of objects in the batch.  Multi-type batches are not permitted.\n+ */\n+public final class ObjectBatch<T> extends EventDataBatchBase {\n+    private final ClientLogger logger = new ClientLogger(ObjectBatch.class);\n+    private final Class<T> batchType;\n+    private final ObjectSerializer objectSerializer;\n+\n+    ObjectBatch(int maxMessageSize, String partitionId, String partitionKey, Class<T> batchType,\n+                    ErrorContextProvider contextProvider, TracerProvider tracerProvider,\n+                    ObjectSerializer objectSerializer, String entityPath, String hostname) {\n+        super(maxMessageSize, partitionId, partitionKey, contextProvider, tracerProvider, entityPath, hostname);\n+        this.batchType = Objects.requireNonNull(batchType, \"'batchType' cannot be null.\");\n+        this.objectSerializer = Objects.requireNonNull(objectSerializer, \"'objectSerializer' cannot be null.\");\n+    }\n+\n+    /**\n+     * Tries to asynchronously serialize an object into an EventData payload and add the EventData to the batch.\n+     *\n+     * @param object The object to add to the batch.\n+     * @return {@code true} if the object could be added to the batch; {@code false} if the serialized\n+     * object was too large to fit in the batch.\n+     * @throws IllegalArgumentException if object is {@code null}.\n+     * @throws AmqpException if serialized object as {@link EventData} is larger than the maximum size\n+     *      of the {@link EventDataBatch}.\n+     */\n+    public Mono<Boolean> tryAdd(final T object) {\n+        if (object == null) {\n+            throw logger.logExceptionAsWarning(new IllegalArgumentException(\"object cannot be null\"));\n+        }\n+\n+        ByteArrayOutputStream outputStream = new ByteArrayOutputStream();\n+        return objectSerializer.serialize(outputStream, object).map(s -> tryAdd(new EventData(s.toByteArray())));", "originalCommit": "2e66eb11ab6b56896e089e6128800fd4b7328f8b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyMzQ5NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12205#discussion_r451823494", "bodyText": "Probably not going to have that for this PR, but we should consider this since the copy will be done for every message receive.", "author": "arerlend", "createdAt": "2020-07-08T21:02:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIyMjEzOQ=="}], "type": "inlineReview"}, {"oid": "8947c09fbb7f3cdc2efa18ca9d27da998e95b0b5", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8947c09fbb7f3cdc2efa18ca9d27da998e95b0b5", "message": "monoError for object batch", "committedDate": "2020-07-08T16:47:45Z", "type": "commit"}, {"oid": "7496de8745084b789a87b9289a3a41b4b7002df5", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7496de8745084b789a87b9289a3a41b4b7002df5", "message": "rename objectSerializer to serializer", "committedDate": "2020-07-08T20:56:06Z", "type": "commit"}, {"oid": "03693c9fe6470ef28aebc6c179cbb088d326a8d2", "url": "https://github.com/Azure/azure-sdk-for-java/commit/03693c9fe6470ef28aebc6c179cbb088d326a8d2", "message": "add serializer null check in object batch creation", "committedDate": "2020-07-08T20:59:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgwNDY3Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12205#discussion_r451804676", "bodyText": "This enum is not used anywhere. This can be removed.", "author": "srnagar", "createdAt": "2020-07-08T20:24:34Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventHubProducerAsyncClient.java", "diffHunk": "@@ -110,15 +111,23 @@\n     private final Scheduler scheduler;\n     private final boolean isSharedConnection;\n     private final Runnable onClientClose;\n+    private final ObjectSerializer serializer;\n+\n+    private enum SendMode {", "originalCommit": "2e66eb11ab6b56896e089e6128800fd4b7328f8b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgzODM1Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12205#discussion_r451838352", "bodyText": "Should this be in a single chain instead of nesting the flatMap operators?", "author": "srnagar", "createdAt": "2020-07-08T21:34:22Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/com/azure/messaging/eventhubs/EventHubProducerAsyncClient.java", "diffHunk": "@@ -248,6 +263,71 @@ public String getEventHubName() {\n                 }));\n     }\n \n+    /**\n+     * Creates an {@link ObjectBatch} that can fit as many serialized objects as events as the transport allows.\n+     * @param objectType type of object in the batch\n+     * @param <T> object type\n+     *\n+     * @return A new {@link ObjectBatch} that can fit as many serialized objects as events as the transport allows.\n+     */\n+    public <T> Mono<ObjectBatch<T>> createBatch(Class<T> objectType) {\n+        return createBatch(objectType, DEFAULT_BATCH_OPTIONS);\n+    }\n+\n+    /**\n+     * Creates an {@link ObjectBatch} configured with the options specified.\n+     *\n+     * @param objectType type of object in the batch\n+     * @param <T> object type\n+     * @param options A set of options used to configure the {@link ObjectBatch}.\n+     * @return A new {@link ObjectBatch} that can fit as many events as the transport allows.\n+     * @throws NullPointerException if {@code options} is null.\n+     */\n+    public <T> Mono<ObjectBatch<T>> createBatch(Class<T> objectType, CreateBatchOptions options) {\n+        if (objectType == null) {\n+            return monoError(logger, new IllegalArgumentException(\"'objectType' cannot be null.\"));\n+        }\n+        if (serializer == null) {\n+            return monoError(logger,\n+                new NullPointerException(\"No serializer set for performing object serialization for ObjectBatch.\"));\n+        }\n+        if (options == null) {\n+            return monoError(logger, new NullPointerException(\"'options' cannot be null.\"));\n+        }\n+\n+        Mono<ObjectBatch<T>> optionsError = validateBatchOptions(options);\n+        if (optionsError != null) {\n+            return optionsError;\n+        }\n+\n+        final String partitionKey = options.getPartitionKey();\n+        final String partitionId = options.getPartitionId();\n+        final int batchMaxSize = options.getMaximumSizeInBytes();\n+\n+        return getSendLink(partitionId)\n+            .flatMap(link -> link.getLinkSize()\n+                .flatMap(size -> {", "originalCommit": "03693c9fe6470ef28aebc6c179cbb088d326a8d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTg3OTY0MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12205#discussion_r451879641", "bodyText": "Yeah I grabbed this one from existing batch creation code, looks like link ref is used for some other args.", "author": "arerlend", "createdAt": "2020-07-08T23:28:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgzODM1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgzOTYyNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12205#discussion_r451839627", "bodyText": "This has to be transitive too.", "author": "srnagar", "createdAt": "2020-07-08T21:37:17Z", "path": "sdk/eventhubs/azure-messaging-eventhubs/src/main/java/module-info.java", "diffHunk": "@@ -3,6 +3,7 @@\n \n module com.azure.messaging.eventhubs {\n     requires transitive com.azure.core;\n+    requires com.azure.core.experimental;", "originalCommit": "03693c9fe6470ef28aebc6c179cbb088d326a8d2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "447522a5a9f105ed55bebb8ed1324a1942ef043d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/447522a5a9f105ed55bebb8ed1324a1942ef043d", "message": "cleanup", "committedDate": "2020-07-08T23:31:12Z", "type": "commit"}]}