{"pr_number": 10564, "pr_title": "Artifact grouping", "pr_createdAt": "2020-04-28T06:42:35Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/10564", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY1NjA4MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10564#discussion_r417656081", "bodyText": "comment on the end can be deleted as it no longer applies.", "author": "weshaggard", "createdAt": "2020-04-29T22:45:05Z", "path": "eng/pipelines/templates/jobs/archetype-sdk-client.yml", "diffHunk": "@@ -113,8 +113,8 @@ jobs:\n         displayName: 'Build and Package'\n         inputs:\n           mavenPomFile: pom.xml\n-          goals: 'package'\n-          options: '$(DefaultOptions) \"-DpackageOutputDirectory=$(Build.ArtifactStagingDirectory)\" -DskipTests -Dinject-codesnippets -Dgenerate-overview -pl $(ProjectList) -am' # We include template-module so we ensure it always builds in CI\n+          goals: 'deploy'\n+          options: '$(DefaultOptions) -DskipTests -Dinject-codesnippets -Dgenerate-overview -Dspotbugs.skip=true -Dcheckstyle.skip=true -Drevapi.skip=true -pl $(ProjectList) -am -DaltDeploymentRepository=id::default::file://$(Build.ArtifactStagingDirectory)' # We include template-module so we ensure it always builds in CI", "originalCommit": "17452b345aade7badef42193b7276b6bbaf5a6a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY1NzQ2OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10564#discussion_r417657468", "bodyText": "Can we run deploy on just the main project so we can do something\nlike file://$(Build.ArtifactStagingDirectory)/$(ServiceDirectory)? Wouldn't that give us the easy segregation of the artifacts so we don't have to do any crazy filename matching in our release templates? Nor do we need to do extra copying.", "author": "weshaggard", "createdAt": "2020-04-29T22:49:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY1NjA4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE4NDQ0Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10564#discussion_r419184442", "bodyText": "I don't think that would help unfortunately since all projects in scope of the reactor would get put into that directory anyway ... unless I am missing something. It is one of the downsides of the deploy goal approach which is that you need to cater for version numbers in the paths at some point down the line.\nI don't think we can avoid the crazy copying all together, its just a case of where we put it. If given a choice between laying out the artifacts to Maven standard repository layout or something we come up with ourselves, I'd prefer to go Maven standard...", "author": "mitchdenny", "createdAt": "2020-05-04T01:13:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY1NjA4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTU2MzcyNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10564#discussion_r419563727", "bodyText": "As long as the output deployment directory doesn't have any thing other then the assets that are going to be published (i.e. they don't contain dependencies and referenced stuff) then I don't think we have to worry about the version number in the directory. We can turn all the logic in our yml files to always take everything under the name of the artifact and eliminated the need for version wildcards and extra copying.", "author": "weshaggard", "createdAt": "2020-05-04T16:27:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY1NjA4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY2Mzk3OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10564#discussion_r457663978", "bodyText": "@mitchdenny did we give up on the idea of having each artifact set published to its own folder in the \"DevOps artifact\"?  We have been seeing too many issues with doing the copying in various release tasks and I'd much prefer we avoid those issues by having the exact set of artifacts for a given package under a folder with that package name. Even if we have to do this copying once in the build stage that will make our lives so much easier in the various release stages that need to be correctly configured to copy the correct files.", "author": "weshaggard", "createdAt": "2020-07-20T20:11:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY1NjA4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY1ODIwNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10564#discussion_r417658206", "bodyText": "We probably should also remove the packageOutputDirectory property and the ant copy step after we make this switch to deploy.", "author": "weshaggard", "createdAt": "2020-04-29T22:51:27Z", "path": "eng/pipelines/templates/jobs/archetype-sdk-client.yml", "diffHunk": "@@ -113,8 +113,8 @@ jobs:\n         displayName: 'Build and Package'\n         inputs:\n           mavenPomFile: pom.xml\n-          goals: 'package'\n-          options: '$(DefaultOptions) \"-DpackageOutputDirectory=$(Build.ArtifactStagingDirectory)\" -DskipTests -Dinject-codesnippets -Dgenerate-overview -pl $(ProjectList) -am' # We include template-module so we ensure it always builds in CI", "originalCommit": "17452b345aade7badef42193b7276b6bbaf5a6a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA1MzcxNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10564#discussion_r418053716", "bodyText": "@weshaggard do we really want to remove that? I know when I'm building locally I typically set the packageOutputDirectory on my command line, it's more of an ease of use thing.", "author": "JimSuplizio", "createdAt": "2020-04-30T14:29:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY1ODIwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODg3Mjc4Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10564#discussion_r418872787", "bodyText": "If we want deploy to the be the main goal for producing output then maybe we do want to remove it.", "author": "weshaggard", "createdAt": "2020-05-02T03:54:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY1ODIwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE4NDE0NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10564#discussion_r419184145", "bodyText": "I know for me it was one of those things that confused me when I first started working with Maven in depth on these team. I assumed that it was something that Maven did automatically until I realized we had this bit of Ant magic in our parent POM.\nI'm all for magic if it is truly useful, but given Maven provides an OOB solution for spitting packages into a repository I'm not sure its that useful, and is possibly confusing.", "author": "mitchdenny", "createdAt": "2020-05-04T01:10:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY1ODIwNg=="}], "type": "inlineReview"}, {"oid": "82efc4c2a3385d1a4d5847dcbece95300e6a8f82", "url": "https://github.com/Azure/azure-sdk-for-java/commit/82efc4c2a3385d1a4d5847dcbece95300e6a8f82", "message": "Tweak staging logic.", "committedDate": "2020-06-01T05:34:12Z", "type": "forcePushed"}, {"oid": "d0005c26781251195193a3f7fb2d87e32a89ca71", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d0005c26781251195193a3f7fb2d87e32a89ca71", "message": "Tweak staging logic.", "committedDate": "2020-07-13T00:18:08Z", "type": "forcePushed"}, {"oid": "40181aeab2f5af531650e4ff5215395e4114929a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/40181aeab2f5af531650e4ff5215395e4114929a", "message": "Artifact segregation (#10490)\n\n* Do a deployment into the staging directory to segregate artifacts.\n\n* Add skips for checkstyle, spotbugs and rev API since we now do deploy during build.\n\nTweak staging logic.\n\nTweak changelog.\n\nIncrement package version after release of com.azure azure-sdk-template (#13065)\n\nAdd recursive copy to stage artifacts.\n\nFix changelog\n\nIncrement package version after release of com.azure azure-sdk-template (#13066)\n\nAnother run through the pipeline.\n\nIncrement package version after release of com.azure azure-sdk-template (#13067)\n\nFlatten artifacts.\n\nIncrement package version after release of com.azure azure-sdk-template (#13068)\n\nMore debugging.\n\nTweak filtering.", "committedDate": "2020-07-13T06:09:58Z", "type": "commit"}, {"oid": "40181aeab2f5af531650e4ff5215395e4114929a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/40181aeab2f5af531650e4ff5215395e4114929a", "message": "Artifact segregation (#10490)\n\n* Do a deployment into the staging directory to segregate artifacts.\n\n* Add skips for checkstyle, spotbugs and rev API since we now do deploy during build.\n\nTweak staging logic.\n\nTweak changelog.\n\nIncrement package version after release of com.azure azure-sdk-template (#13065)\n\nAdd recursive copy to stage artifacts.\n\nFix changelog\n\nIncrement package version after release of com.azure azure-sdk-template (#13066)\n\nAnother run through the pipeline.\n\nIncrement package version after release of com.azure azure-sdk-template (#13067)\n\nFlatten artifacts.\n\nIncrement package version after release of com.azure azure-sdk-template (#13068)\n\nMore debugging.\n\nTweak filtering.", "committedDate": "2020-07-13T06:09:58Z", "type": "forcePushed"}, {"oid": "8eb3c4c2093e361f6615c22c7de7d51fff3308b6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8eb3c4c2093e361f6615c22c7de7d51fff3308b6", "message": "Increment version for template releases (#13072)\n\n* Artifact segregation (#10490)", "committedDate": "2020-07-13T06:17:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcxODM5MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10564#discussion_r454718390", "bodyText": "we've hardcoded template here.", "author": "scbedd", "createdAt": "2020-07-15T00:21:36Z", "path": "eng/pipelines/templates/steps/stage-artifacts.yml", "diffHunk": "@@ -6,5 +6,10 @@ parameters:\n steps:\n   - pwsh: |\n       New-Item -Force -Type Directory -Name ${{parameters.TargetFolder}} -Path $(Pipeline.Workspace)\n-      Copy-Item $(Pipeline.Workspace)/${{parameters.SourceFolder}}/${{parameters.PackageName}}-[0-9]*.[0-9]*.[0-9]* $(Pipeline.Workspace)/${{parameters.TargetFolder}}\n-    displayName: Stage artifacts\n\\ No newline at end of file\n+      $items = Get-ChildItem -Recurse -Path $(Pipeline.Workspace)/${{parameters.SourceFolder}} \n+      Write-Host \"Found $($items.Count) total items in source folder\"\n+      $filteredItems = $items | Where-Object -FilterScript { $_.Name -like \"azure-sdk-template-[0-9]*.[0-9]*.[0-9]*-*\" }      ", "originalCommit": "8eb3c4c2093e361f6615c22c7de7d51fff3308b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcxOTQxNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10564#discussion_r454719415", "bodyText": "Probably {{ params.PackageName }} instead of azure-template right?", "author": "scbedd", "createdAt": "2020-07-15T00:25:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcxODM5MA=="}], "type": "inlineReview"}, {"oid": "7d5128cdbf861dd02fe2526a51f1994d1267e475", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7d5128cdbf861dd02fe2526a51f1994d1267e475", "message": "Fixing the bug that Scott identified.", "committedDate": "2020-07-15T00:37:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcyMzA3NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10564#discussion_r454723075", "bodyText": "\ud83d\udc4d", "author": "scbedd", "createdAt": "2020-07-15T00:39:22Z", "path": "eng/pipelines/templates/steps/stage-artifacts.yml", "diffHunk": "@@ -6,5 +6,10 @@ parameters:\n steps:\n   - pwsh: |\n       New-Item -Force -Type Directory -Name ${{parameters.TargetFolder}} -Path $(Pipeline.Workspace)\n-      Copy-Item $(Pipeline.Workspace)/${{parameters.SourceFolder}}/${{parameters.PackageName}}-[0-9]*.[0-9]*.[0-9]* $(Pipeline.Workspace)/${{parameters.TargetFolder}}\n-    displayName: Stage artifacts\n\\ No newline at end of file\n+      $items = Get-ChildItem -Recurse -Path $(Pipeline.Workspace)/${{parameters.SourceFolder}} \n+      Write-Host \"Found $($items.Count) total items in source folder\"\n+      $filteredItems = $items | Where-Object -FilterScript { $_.Name -like \"${{parameters.PackageName}}-[0-9]*.[0-9]*.[0-9]*-*\" }      ", "originalCommit": "7d5128cdbf861dd02fe2526a51f1994d1267e475", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}