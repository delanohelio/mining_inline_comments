{"pr_number": 18392, "pr_title": "Dump Heap on OOM and Retain Heap Dump", "pr_createdAt": "2020-12-29T23:58:11Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/18392", "timeline": [{"oid": "b9b159d2e5e6e5d21b8e0f699704ff49632c1649", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b9b159d2e5e6e5d21b8e0f699704ff49632c1649", "message": "Attempt to add heap dump on OOM and retain it", "committedDate": "2020-12-29T23:57:12Z", "type": "commit"}, {"oid": "d496ca3fcf165b8461e1ed7749f48c690fc93513", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d496ca3fcf165b8461e1ed7749f48c690fc93513", "message": "Add validation that a heap dump was created before attempting to publish it", "committedDate": "2020-12-30T00:57:33Z", "type": "commit"}, {"oid": "3d1e0e1bd13dba605ef271d9a19c86bbe39eb102", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3d1e0e1bd13dba605ef271d9a19c86bbe39eb102", "message": "Fix task condition", "committedDate": "2020-12-30T01:05:13Z", "type": "commit"}, {"oid": "2798a27e7e1a422d14f77bef2650ca2958a469b2", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2798a27e7e1a422d14f77bef2650ca2958a469b2", "message": "Merge branch 'master' into AzEng_RetainHeapDumpOnOoM", "committedDate": "2021-01-08T23:51:05Z", "type": "commit"}, {"oid": "cc128174dff2820c7e0b5cab8abba57a99520b77", "url": "https://github.com/Azure/azure-sdk-for-java/commit/cc128174dff2820c7e0b5cab8abba57a99520b77", "message": "Prototype passing additional JVM arguments to the Surefire JVM", "committedDate": "2021-01-09T00:17:50Z", "type": "commit"}, {"oid": "9eef02f1f6d13a6967ff41a83124fd231576791a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9eef02f1f6d13a6967ff41a83124fd231576791a", "message": "Fix property name, add support for command-line settable Xmx value", "committedDate": "2021-01-09T00:30:42Z", "type": "commit"}, {"oid": "2dbe305eb8df62894b1dfc1fbb00a759ae061ffe", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2dbe305eb8df62894b1dfc1fbb00a759ae061ffe", "message": "Merge branch 'master' into AzEng_RetainHeapDumpOnOoM", "committedDate": "2021-01-11T19:31:20Z", "type": "commit"}, {"oid": "65ee8186548cc748e5da33b646d19b3a8c898e35", "url": "https://github.com/Azure/azure-sdk-for-java/commit/65ee8186548cc748e5da33b646d19b3a8c898e35", "message": "Update Surefire version", "committedDate": "2021-01-11T20:53:48Z", "type": "commit"}, {"oid": "489708e445585789b49589b88865659634b1c663", "url": "https://github.com/Azure/azure-sdk-for-java/commit/489708e445585789b49589b88865659634b1c663", "message": "Merge branch 'master' into AzEng_RetainHeapDumpOnOoM", "committedDate": "2021-01-12T19:31:31Z", "type": "commit"}, {"oid": "9fe18c917d223bc1397512ee2a0fbdd1267f3e7c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9fe18c917d223bc1397512ee2a0fbdd1267f3e7c", "message": "Update heap dump in pom configuration and yaml checks for it", "committedDate": "2021-01-12T19:50:59Z", "type": "commit"}, {"oid": "fbdd1330a45c4b5cffe63cd90d0cebf8bc633e78", "url": "https://github.com/Azure/azure-sdk-for-java/commit/fbdd1330a45c4b5cffe63cd90d0cebf8bc633e78", "message": "Support retaining multiple heap dumps, changed heap dump path to a directory to allow multiple heap dumps to happen", "committedDate": "2021-01-12T21:59:38Z", "type": "commit"}, {"oid": "bbc950e8a0cb68d005565e705a91336b71a0f4a0", "url": "https://github.com/Azure/azure-sdk-for-java/commit/bbc950e8a0cb68d005565e705a91336b71a0f4a0", "message": "Fix expression syntax", "committedDate": "2021-01-12T22:06:47Z", "type": "commit"}, {"oid": "f8278051f51f5d39fce82d87cf21313a7d12ad91", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f8278051f51f5d39fce82d87cf21313a7d12ad91", "message": "Test other ways to track heap dump files", "committedDate": "2021-01-12T22:18:14Z", "type": "commit"}, {"oid": "19944630ae4730acdcc76e8d93863ea11c341215", "url": "https://github.com/Azure/azure-sdk-for-java/commit/19944630ae4730acdcc76e8d93863ea11c341215", "message": "Add logging to troubleshoot", "committedDate": "2021-01-12T22:34:29Z", "type": "commit"}, {"oid": "c944800e05b4463834c7fb0f8317c511377f707f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c944800e05b4463834c7fb0f8317c511377f707f", "message": "Merge branch 'master' into AzEng_RetainHeapDumpOnOoM", "committedDate": "2021-01-12T22:59:51Z", "type": "commit"}, {"oid": "5ee5c90df49c98bf7adb708b558da8e16e263376", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5ee5c90df49c98bf7adb708b558da8e16e263376", "message": "Use Maven to generate directory for heap dumps", "committedDate": "2021-01-12T23:37:55Z", "type": "commit"}, {"oid": "06a2e90bf63a15cf7f600ed8b1ccd739e0665c73", "url": "https://github.com/Azure/azure-sdk-for-java/commit/06a2e90bf63a15cf7f600ed8b1ccd739e0665c73", "message": "Update heap dump path, remove CI attempt to retain heap dump for further investigation", "committedDate": "2021-03-29T17:56:59Z", "type": "commit"}, {"oid": "d4ac21685c99ff57a29e453cc28dff2aeda006ad", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d4ac21685c99ff57a29e453cc28dff2aeda006ad", "message": "Merge branch 'master' into AzEng_RetainHeapDumpOnOoM", "committedDate": "2021-04-05T16:29:43Z", "type": "commit"}, {"oid": "792747fd3fd3f94006394b60b29495cf68f0fab7", "url": "https://github.com/Azure/azure-sdk-for-java/commit/792747fd3fd3f94006394b60b29495cf68f0fab7", "message": "Merge in main", "committedDate": "2021-08-09T23:06:07Z", "type": "commit"}, {"oid": "f7abba402682b458596dbd1ff54aa59f936810c5", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f7abba402682b458596dbd1ff54aa59f936810c5", "message": "Attempt to publish OOM hprofs", "committedDate": "2021-08-09T23:48:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMTYxMjA1Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18392#discussion_r701612053", "bodyText": "This seems wrong. Artifacts is the list of things built that should be published, not a list of destinations to publish to.\nIf the goal is to publish the .hprof as a pipeline artifact, retained in Azure DevOps, you should replace inputs with something like:\n  condition: eq(variables.FILEEXISTS, 'true')\n  inputs:\n    targetPath: $(Pipeline.Workspace)/sdk/${{ parameters.ServiceDirectory }}/${{ artifact.name }}/target/oom.hprof\n    artifactType: pipeline   #this line isn't necessary as pipeline is the default\n    artifactName: '${{ artifact.name }}.oom.hprof'\nwhere FILEEXISTS is set to true if the .hprof exists:\n- pwsh: Write-Output \"##vso[task.setVariable variable=FILEEXISTS]$((Test-Path $pathToHprof) ? \"true\" : \"false\")\"    \nIf the oom.hprof is a memory dump and we have reason to believe it may contain sensitive information, e.g. credentials, we should consider more secure destinations for the files, like blob storage.\nfilepath base artifact publishing appears to be targeting DevOps users with private, network connected agents with fileshare access, i.e.   \\\\someserver\\share\\", "author": "hallipr", "createdAt": "2021-09-03T06:16:36Z", "path": "eng/pipelines/templates/jobs/ci.tests.yml", "diffHunk": "@@ -163,6 +163,13 @@ jobs:\n \n       - template: ../steps/upload-repository-on-failure.yml\n \n+      - ${{ each artifact in parameters.Artifacts }}:\n+        - task: PublishPipelineArtifact@1\n+          inputs:\n+            targetPath: '$(Pipeline.Workspace)/sdk/${{ parameters.ServiceDirectory }}/${{ artifact.name }}/target/oom.hprof'\n+            artifactType: 'filepath'", "originalCommit": "f7abba402682b458596dbd1ff54aa59f936810c5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "382eb6ad5e05f5b3214b0dabbca6433cbfebc148", "url": "https://github.com/Azure/azure-sdk-for-java/commit/382eb6ad5e05f5b3214b0dabbca6433cbfebc148", "message": "Merge branch 'main' into AzEng_RetainHeapDumpOnOoM", "committedDate": "2021-09-13T17:08:07Z", "type": "commit"}, {"oid": "5789adef92503d449b99719e30800ca1fb6c8754", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5789adef92503d449b99719e30800ca1fb6c8754", "message": "Change configuration structure to be centralized in parent POM", "committedDate": "2021-09-13T17:57:52Z", "type": "commit"}, {"oid": "7677aafdd27fbd7af1267fc392f9524c418ffac4", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7677aafdd27fbd7af1267fc392f9524c418ffac4", "message": "Update all Core libraries to use new pattern, changed how OOM hprof is copied", "committedDate": "2021-09-13T19:05:59Z", "type": "commit"}, {"oid": "73587312cc96b5f0d24974b7af488106fd6a61f7", "url": "https://github.com/Azure/azure-sdk-for-java/commit/73587312cc96b5f0d24974b7af488106fd6a61f7", "message": "Fix missing '-' in command name", "committedDate": "2021-09-13T19:51:55Z", "type": "commit"}, {"oid": "5734a26a188a77cf7bc180581e5b1a6b7ee6d62d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5734a26a188a77cf7bc180581e5b1a6b7ee6d62d", "message": "Add logging of file copying", "committedDate": "2021-09-13T21:10:01Z", "type": "commit"}, {"oid": "00aedb62a3877059899e9469b2d52ef46bba87e8", "url": "https://github.com/Azure/azure-sdk-for-java/commit/00aedb62a3877059899e9469b2d52ef46bba87e8", "message": "Change file copying logic", "committedDate": "2021-09-13T21:11:14Z", "type": "commit"}, {"oid": "55f08792690d7bb607ed3c0f35676ab307f46f06", "url": "https://github.com/Azure/azure-sdk-for-java/commit/55f08792690d7bb607ed3c0f35676ab307f46f06", "message": "Publish retain hrpofs", "committedDate": "2021-09-13T21:30:33Z", "type": "commit"}, {"oid": "0260a40c702fb9aeabc6d41d3ef13077ed7907d6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0260a40c702fb9aeabc6d41d3ef13077ed7907d6", "message": "Zip hprofs before publishing", "committedDate": "2021-09-13T21:51:01Z", "type": "commit"}, {"oid": "275075e373b26a6427112b7b749c1a96f1d0798d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/275075e373b26a6427112b7b749c1a96f1d0798d", "message": "Merge branch 'main' into AzEng_RetainHeapDumpOnOoM", "committedDate": "2021-09-13T22:10:54Z", "type": "commit"}, {"oid": "6f5cc8264755ec4796583df8bfd7b1b56617788a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6f5cc8264755ec4796583df8bfd7b1b56617788a", "message": "Turn retention into a standalone step for re-use", "committedDate": "2021-09-13T22:35:46Z", "type": "commit"}, {"oid": "5d4eaafe7ae06c5f89ffc35101971584824b9964", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5d4eaafe7ae06c5f89ffc35101971584824b9964", "message": "Remove OOM tests as changes have been validated", "committedDate": "2021-09-13T22:47:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNzc3NDM4NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18392#discussion_r707774385", "bodyText": "How large are these files? Should we move them instead of copy?", "author": "weshaggard", "createdAt": "2021-09-13T22:55:29Z", "path": "eng/pipelines/templates/steps/retain-heap-dump-hprofs.yml", "diffHunk": "@@ -0,0 +1,17 @@\n+steps:\n+  - pwsh: |\n+      New-Item $(Build.ArtifactStagingDirectory)/oom-hprofs -ItemType directory\n+      foreach($hprofFile in (Get-ChildItem -Path . -Recurse -Filter *.hprof -File))\n+      {\n+        $fileFullName = $hprofFile.FullName\n+        $fileName = $hprofFile.Name\n+        Copy-Item $fileFullName $(Build.ArtifactStagingDirectory)/oom-hprofs/$fileName -ErrorAction SilentlyContinue", "originalCommit": "5d4eaafe7ae06c5f89ffc35101971584824b9964", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNzc3OTY4MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18392#discussion_r707779681", "bodyText": "It'll be variable, and somewhat dependent on the max heap size, but I'd expect them to be in the high MBs, low GBs range. Moving them would likely be the better option in this case.", "author": "alzimmermsft", "createdAt": "2021-09-13T23:09:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNzc3NDM4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNzc3NDgxNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18392#discussion_r707774814", "bodyText": "In general creating a zip file make uploading less efficient as Devops already does compression on the server side and can optimize the chunks of these files better across all files uploaded instead of us.", "author": "weshaggard", "createdAt": "2021-09-13T22:56:28Z", "path": "eng/pipelines/templates/steps/retain-heap-dump-hprofs.yml", "diffHunk": "@@ -0,0 +1,17 @@\n+steps:\n+  - pwsh: |\n+      New-Item $(Build.ArtifactStagingDirectory)/oom-hprofs -ItemType directory\n+      foreach($hprofFile in (Get-ChildItem -Path . -Recurse -Filter *.hprof -File))\n+      {\n+        $fileFullName = $hprofFile.FullName\n+        $fileName = $hprofFile.Name\n+        Copy-Item $fileFullName $(Build.ArtifactStagingDirectory)/oom-hprofs/$fileName -ErrorAction SilentlyContinue\n+      }\n+      [System.IO.Compression.ZipFile]::CreateFromDirectory(\"$(Build.ArtifactStagingDirectory)/oom-hprofs\",\"$(Build.ArtifactStagingDirectory)/oom-hprofs.zip\")", "originalCommit": "5d4eaafe7ae06c5f89ffc35101971584824b9964", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNzc3NzgxMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18392#discussion_r707777810", "bodyText": "I'd like to see how that plays out for real OOM dumps.   The test dumps were highly compressible  2gb -> 8mb I think.  If they're not compressing on upload, then the build's waiting on a 2gb file transfer.", "author": "hallipr", "createdAt": "2021-09-13T23:04:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNzc3NDgxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNzc4MDMxOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18392#discussion_r707780319", "bodyText": "I'm less concerned on the DevOps slow down for uploading and more on the downloading when the dev loop includes troubleshooting an OOM. Overall, OOMs should rarely happen and I want to focus on the developer experience when they do.", "author": "alzimmermsft", "createdAt": "2021-09-13T23:10:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNzc3NDgxNA=="}, {"id": "PRRC_kwDOACyxNM4qOf6m", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18392#discussion_r708443814", "bodyText": "From a download prospective Devops always has the artifacts in a compressed download format so I'd expect them to be downloaded in a zip file regardless of how you upload them. In fact if you upload a zip you will likely end up with a zip inside of a zip.", "author": "weshaggard", "createdAt": "2021-09-14T16:30:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNzc3NDgxNA=="}, {"id": "PRRC_kwDOACyxNM4qOgJL", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18392#discussion_r708444747", "bodyText": "However with that said I'm fine testing out either approach and we can make adjustments as necessary.", "author": "weshaggard", "createdAt": "2021-09-14T16:32:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNzc3NDgxNA=="}], "type": "inlineReview"}, {"id": "PRRC_kwDOACyxNM4qMDSo", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18392#discussion_r707802280", "bodyText": "We should standardize using 11 and above for these profiles to be consistent with all modules.", "author": "srnagar", "createdAt": "2021-09-14T00:01:15Z", "path": "sdk/core/azure-core-tracing-opentelemetry/pom.xml", "diffHunk": "@@ -126,20 +126,11 @@\n       <activation>\n         <jdk>[9,)</jdk>", "originalCommit": "5d4eaafe7ae06c5f89ffc35101971584824b9964", "replyToReviewId": null, "replies": [{"id": "PRRC_kwDOACyxNM4qML60", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18392#discussion_r707837620", "bodyText": "I've actually wondered if this should be Java 9 or Java 11, I know our CI uses Java 11 but technically this is for Java 9+. Given that I've actually been thinking this should switch on in Java 9.", "author": "alzimmermsft", "createdAt": "2021-09-14T01:29:58Z", "replyToReviewId": "PRRC_kwDOACyxNM4qMDSo"}, {"id": "PRRC_kwDOACyxNM4qMMQ5", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18392#discussion_r707839033", "bodyText": "There is a pre-existing tracking item for this: #19273", "author": "alzimmermsft", "createdAt": "2021-09-14T01:34:18Z", "replyToReviewId": "PRRC_kwDOACyxNM4qMDSo"}], "type": "inlineReview"}, {"id": "PRRC_kwDOACyxNM4qMDmJ", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18392#discussion_r707803529", "bodyText": "Since this is not used anywhere, we can add this when required.", "author": "srnagar", "createdAt": "2021-09-14T00:02:41Z", "path": "sdk/parents/azure-client-sdk-parent/pom.xml", "diffHunk": "@@ -107,7 +106,35 @@\n     <jacoco.min.linecoverage>0.40</jacoco.min.linecoverage>\n     <jacoco.min.branchcoverage>0.30</jacoco.min.branchcoverage>\n     <jacoco.skip.coverage.check>false</jacoco.skip.coverage.check>\n+\n+    <!-- This property determines the relative path from a pom.xml to the eng/ folder. -->\n     <relative.path.to.eng.folder>../../..</relative.path.to.eng.folder>\n+\n+    <!-- This property determines the max heap size of the Surefire JVM. By default 3GB, or 3096MB, is used. -->\n+    <surefireXmx>3096m</surefireXmx>\n+\n+    <!-- This property configures the max heap size of the Surefire JVM. -->\n+    <surefireJvmXmx>-Xmx${surefireXmx}</surefireJvmXmx>\n+\n+    <!-- This property configures creating a heap dump if the Surefire JVM fails with an OutOfMemoryError. -->\n+    <heapDumpOnOom>\n+      -XX:+HeapDumpOnOutOfMemoryError\n+      -XX:HeapDumpPath=${packageOutputDirectory}${file.separator}${project.artifactId}-oom.hprof\n+    </heapDumpOnOom>\n+\n+    <!-- Reserved for general Surefire JVM arguments that affect all SDKs. -->\n+    <defaultSurefireArgLine>\n+      ${surefireJvmXmx}\n+      ${heapDumpOnOom}\n+    </defaultSurefireArgLine>\n+\n+    <!-- Reserved for SDK specific JVM arguments to export, open, or read modules in testing. -->\n+    <javaModulesSurefireArgLine>\n+    </javaModulesSurefireArgLine>\n+\n+    <!-- Reserved for either general or SDK specific JVM arguments that are optional. -->\n+    <additionalSurefireArgLine>\n+    </additionalSurefireArgLine>", "originalCommit": "5d4eaafe7ae06c5f89ffc35101971584824b9964", "replyToReviewId": null, "replies": [{"id": "PRRC_kwDOACyxNM4qML_H", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18392#discussion_r707837895", "bodyText": "I'd rather add it now as a path forward for SDK specific hooks that haven't been updated in the PR (if they exist).", "author": "alzimmermsft", "createdAt": "2021-09-14T01:30:54Z", "replyToReviewId": "PRRC_kwDOACyxNM4qMDmJ"}], "type": "inlineReview"}, {"oid": "749b4aa03280f9accbb0e810cc825e8d2c747ffc", "url": "https://github.com/Azure/azure-sdk-for-java/commit/749b4aa03280f9accbb0e810cc825e8d2c747ffc", "message": "Change Copy-Item to Move-Item", "committedDate": "2021-09-14T01:34:36Z", "type": "commit"}, {"oid": "6850e358d2fcfdc549484345e8a1cd0669f65388", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6850e358d2fcfdc549484345e8a1cd0669f65388", "message": "Fix merge conflict with upstream", "committedDate": "2021-09-14T01:37:15Z", "type": "commit"}, {"id": "PRRC_kwDOACyxNM4qOhpd", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18392#discussion_r708450909", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                condition: always()\n          \n          \n            \n                condition: succeededOrFailed()", "author": "weshaggard", "createdAt": "2021-09-14T16:40:14Z", "path": "eng/pipelines/templates/steps/retain-heap-dump-hprofs.yml", "diffHunk": "@@ -0,0 +1,17 @@\n+steps:\n+  - pwsh: |\n+      New-Item $(Build.ArtifactStagingDirectory)/oom-hprofs -ItemType directory\n+      foreach($hprofFile in (Get-ChildItem -Path . -Recurse -Filter *.hprof -File))\n+      {\n+        $fileFullName = $hprofFile.FullName\n+        $fileName = $hprofFile.Name\n+        Move-Item -Path $fileFullName -Destination $(Build.ArtifactStagingDirectory)/oom-hprofs/$fileName -ErrorAction SilentlyContinue\n+      }\n+      [System.IO.Compression.ZipFile]::CreateFromDirectory(\"$(Build.ArtifactStagingDirectory)/oom-hprofs\",\"$(Build.ArtifactStagingDirectory)/oom-hprofs.zip\")\n+    displayName: 'Copy OOM hprofs'\n+    condition: always()", "originalCommit": "6850e358d2fcfdc549484345e8a1cd0669f65388", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "PRRC_kwDOACyxNM4qOjie", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18392#discussion_r708458654", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                condition: always()\n          \n          \n            \n                condition: succeededOrFailed()", "author": "weshaggard", "createdAt": "2021-09-14T16:50:05Z", "path": "eng/pipelines/templates/steps/retain-heap-dump-hprofs.yml", "diffHunk": "@@ -0,0 +1,17 @@\n+steps:\n+  - pwsh: |\n+      New-Item $(Build.ArtifactStagingDirectory)/oom-hprofs -ItemType directory\n+      foreach($hprofFile in (Get-ChildItem -Path . -Recurse -Filter *.hprof -File))\n+      {\n+        $fileFullName = $hprofFile.FullName\n+        $fileName = $hprofFile.Name\n+        Move-Item -Path $fileFullName -Destination $(Build.ArtifactStagingDirectory)/oom-hprofs/$fileName -ErrorAction SilentlyContinue\n+      }\n+      [System.IO.Compression.ZipFile]::CreateFromDirectory(\"$(Build.ArtifactStagingDirectory)/oom-hprofs\",\"$(Build.ArtifactStagingDirectory)/oom-hprofs.zip\")\n+    displayName: 'Copy OOM hprofs'\n+    condition: always()\n+\n+  - publish: $(Build.ArtifactStagingDirectory)/oom-hprofs.zip\n+    displayName: 'Publish OOM hprofs'\n+    artifact: oom-hprofs-$(System.StageName)-$(System.JobName)-$(System.JobAttempt)\n+    condition: always()", "originalCommit": "6850e358d2fcfdc549484345e8a1cd0669f65388", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "415f3f70be8a0a961108209db195a01f13df8893", "url": "https://github.com/Azure/azure-sdk-for-java/commit/415f3f70be8a0a961108209db195a01f13df8893", "message": "Merge branch 'main' into AzEng_RetainHeapDumpOnOoM", "committedDate": "2021-09-14T16:58:01Z", "type": "commit"}, {"oid": "44689fbb9d09a2ce47d5eec3d14a932081122fd5", "url": "https://github.com/Azure/azure-sdk-for-java/commit/44689fbb9d09a2ce47d5eec3d14a932081122fd5", "message": "Tweak to when the task runs", "committedDate": "2021-09-14T16:59:24Z", "type": "commit"}, {"oid": "036002bb2b81a394b1af1205ba1120d908fc07cb", "url": "https://github.com/Azure/azure-sdk-for-java/commit/036002bb2b81a394b1af1205ba1120d908fc07cb", "message": "Match heap OOM retention with test publishing", "committedDate": "2021-09-14T17:29:21Z", "type": "commit"}, {"id": "PRRC_kwDOACyxNM4qOrIM", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18392#discussion_r708489740", "bodyText": "looks like this full name isn't used.", "author": "weshaggard", "createdAt": "2021-09-14T17:34:03Z", "path": "eng/pipelines/templates/steps/retain-heap-dump-hprofs.yml", "diffHunk": "@@ -0,0 +1,17 @@\n+steps:\n+  - pwsh: |\n+      New-Item $(Build.ArtifactStagingDirectory)/oom-hprofs -ItemType directory\n+      foreach($hprofFile in (Get-ChildItem -Path . -Recurse -Filter *.hprof -File))\n+      {\n+        $fileFullName = $hprofFile.FullName", "originalCommit": "036002bb2b81a394b1af1205ba1120d908fc07cb", "replyToReviewId": null, "replies": [{"id": "PRRC_kwDOACyxNM4qOvYC", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18392#discussion_r708507138", "bodyText": "It's used two lines below in the Move-Item command \ud83d\ude03", "author": "alzimmermsft", "createdAt": "2021-09-14T17:58:52Z", "replyToReviewId": "PRRC_kwDOACyxNM4qOrIM"}, {"id": "PRRC_kwDOACyxNM4qOvdJ", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18392#discussion_r708507465", "bodyText": "https://github.com/Azure/azure-sdk-for-java/pull/18392/files/036002bb2b81a394b1af1205ba1120d908fc07cb#diff-c0636fb18157703f77203332e4169a450ca3084e7a26a3285bceca46e3e19152R8", "author": "alzimmermsft", "createdAt": "2021-09-14T17:59:18Z", "replyToReviewId": "PRRC_kwDOACyxNM4qOrIM"}], "type": "inlineReview"}, {"id": "PRRC_kwDOACyxNM4qPHM3", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18392#discussion_r708604727", "bodyText": "can this collide with \n  \n    \n      azure-sdk-for-java/sdk/storage/azure-storage-blob/pom.xml\n    \n    \n        Lines 236 to 238\n      in\n      da6337e\n    \n    \n    \n    \n\n        \n          \n           <argLine> \n        \n\n        \n          \n             -Xmx6g \n        \n\n        \n          \n           </argLine> \n        \n    \n  \n\n\n?", "author": "kasobol-msft", "createdAt": "2021-09-14T20:23:01Z", "path": "sdk/parents/azure-client-sdk-parent/pom.xml", "diffHunk": "@@ -107,7 +106,35 @@\n     <jacoco.min.linecoverage>0.40</jacoco.min.linecoverage>\n     <jacoco.min.branchcoverage>0.30</jacoco.min.branchcoverage>\n     <jacoco.skip.coverage.check>false</jacoco.skip.coverage.check>\n+\n+    <!-- This property determines the relative path from a pom.xml to the eng/ folder. -->\n     <relative.path.to.eng.folder>../../..</relative.path.to.eng.folder>\n+\n+    <!-- This property determines the max heap size of the Surefire JVM. By default 3GB, or 3096MB, is used. -->\n+    <surefireXmx>3096m</surefireXmx>\n+\n+    <!-- This property configures the max heap size of the Surefire JVM. -->\n+    <surefireJvmXmx>-Xmx${surefireXmx}</surefireJvmXmx>", "originalCommit": "44689fbb9d09a2ce47d5eec3d14a932081122fd5", "replyToReviewId": null, "replies": [{"id": "PRRC_kwDOACyxNM4qPH61", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18392#discussion_r708607669", "bodyText": "Yes, this can collide with that. The thought behind the new pattern is to override <surefireXmx>3096m</surefireXmx> to a new value in the child POM, so in this case it would be <surefireXmx>6g</surefireXmx> in azure-storage-blob/pom.xml. This will then be rolled into the <surefireJvmXmx> value and passed into the maven-surefire-plugin argLine.\nOverall, the changes are to use more composition-esque styling by overriding property values instead of overriding plugin configurations (as these have shown to be much more brittle).", "author": "alzimmermsft", "createdAt": "2021-09-14T20:27:29Z", "replyToReviewId": "PRRC_kwDOACyxNM4qPHM3"}], "type": "inlineReview"}]}