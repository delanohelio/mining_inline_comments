{"pr_number": 17679, "pr_title": "Mgmt-Lite: add automation script", "pr_createdAt": "2020-11-19T07:11:29Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/17679", "timeline": [{"oid": "ad6436c5d178311d5b3fcd157ff326e46d4d1afa", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ad6436c5d178311d5b3fcd157ff326e46d4d1afa", "message": "add automation script", "committedDate": "2020-11-19T07:10:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI4OTAzMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17679#discussion_r527289030", "bodyText": "This looks a little off. Why would you need maven in the key twice?", "author": "weshaggard", "createdAt": "2020-11-20T00:14:09Z", "path": "eng/mgmt/automation/generation.yml", "diffHunk": "@@ -0,0 +1,61 @@\n+trigger: none\n+\n+pr: none\n+\n+pool:\n+  vmImage: 'ubuntu-18.04'\n+\n+variables:\n+  MAVEN_CACHE_FOLDER: $(Pipeline.Workspace)/.m2/repository\n+  MAVEN_OPTS: '-Dmaven.repo.local=$(MAVEN_CACHE_FOLDER)'\n+  NodeVersion: '14.x'\n+\n+steps:\n+- task: Cache@2\n+  inputs:\n+    key: 'maven | \"$(Agent.OS)\" | **/pom.xml'\n+    restoreKeys: |\n+      maven | \"$(Agent.OS)\"\n+      maven", "originalCommit": "ad6436c5d178311d5b3fcd157ff326e46d4d1afa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzM0Mzg0NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17679#discussion_r527343845", "bodyText": "This is just copied from azure devops docs https://docs.microsoft.com/en-us/azure/devops/pipelines/release/caching?view=azure-devops#maven", "author": "ChenTanyi", "createdAt": "2020-11-20T01:53:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI4OTAzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI4OTMzMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17679#discussion_r527289331", "bodyText": "Is the maven cache that interesting for this pipeline?", "author": "weshaggard", "createdAt": "2020-11-20T00:14:29Z", "path": "eng/mgmt/automation/generation.yml", "diffHunk": "@@ -0,0 +1,61 @@\n+trigger: none\n+\n+pr: none\n+\n+pool:\n+  vmImage: 'ubuntu-18.04'\n+\n+variables:\n+  MAVEN_CACHE_FOLDER: $(Pipeline.Workspace)/.m2/repository\n+  MAVEN_OPTS: '-Dmaven.repo.local=$(MAVEN_CACHE_FOLDER)'\n+  NodeVersion: '14.x'\n+\n+steps:\n+- task: Cache@2", "originalCommit": "ad6436c5d178311d5b3fcd157ff326e46d4d1afa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzM0NDEzNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17679#discussion_r527344135", "bodyText": "Maybe I think I could remove the cache, due to generation will usually result to different service with different pom.", "author": "ChenTanyi", "createdAt": "2020-11-20T01:54:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI4OTMzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUwMTUzMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17679#discussion_r527501533", "bodyText": "After testing, I think it still necessary for cache maven dependency for mvn verify package.\nActually all services need same cache, so I change this to using key \"maven | ${ OS }\" to do cache.", "author": "ChenTanyi", "createdAt": "2020-11-20T07:59:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI4OTMzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI5MDIyMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17679#discussion_r527290220", "bodyText": "I recommend not setting these globally and only doing it as part of the commit command. See https://github.com/Azure/azure-sdk-tools/blob/master/eng/common/scripts/git-branch-push.ps1#L79 as an example.", "author": "weshaggard", "createdAt": "2020-11-20T00:15:28Z", "path": "eng/mgmt/automation/generation.yml", "diffHunk": "@@ -0,0 +1,61 @@\n+trigger: none\n+\n+pr: none\n+\n+pool:\n+  vmImage: 'ubuntu-18.04'\n+\n+variables:\n+  MAVEN_CACHE_FOLDER: $(Pipeline.Workspace)/.m2/repository\n+  MAVEN_OPTS: '-Dmaven.repo.local=$(MAVEN_CACHE_FOLDER)'\n+  NodeVersion: '14.x'\n+\n+steps:\n+- task: Cache@2\n+  inputs:\n+    key: 'maven | \"$(Agent.OS)\" | **/pom.xml'\n+    restoreKeys: |\n+      maven | \"$(Agent.OS)\"\n+      maven\n+    path: $(MAVEN_CACHE_FOLDER)\n+  displayName: Cache Maven local repo\n+\n+- bash: |\n+    git config --global user.name \"Azure-Fluent\"", "originalCommit": "ad6436c5d178311d5b3fcd157ff326e46d4d1afa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUwMTk0Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17679#discussion_r527501943", "bodyText": "done", "author": "ChenTanyi", "createdAt": "2020-11-20T08:00:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI5MDIyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI5MDY4Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17679#discussion_r527290682", "bodyText": "When do you expect someone to call this pipeline over just using the sdk automation?", "author": "weshaggard", "createdAt": "2020-11-20T00:16:02Z", "path": "eng/mgmt/automation/generation.yml", "diffHunk": "@@ -0,0 +1,61 @@\n+trigger: none", "originalCommit": "ad6436c5d178311d5b3fcd157ff326e46d4d1afa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzM0NDQ3NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17679#discussion_r527344474", "bodyText": "This yml is mainly used for manually generation, which will be manually run in devops.", "author": "ChenTanyi", "createdAt": "2020-11-20T01:55:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI5MDY4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI5MTU3NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17679#discussion_r527291575", "bodyText": "I don't think this is necessary to set this in env var given you are passing it as part of the URL.", "author": "weshaggard", "createdAt": "2020-11-20T00:17:06Z", "path": "eng/mgmt/automation/generation.yml", "diffHunk": "@@ -0,0 +1,61 @@\n+trigger: none\n+\n+pr: none\n+\n+pool:\n+  vmImage: 'ubuntu-18.04'\n+\n+variables:\n+  MAVEN_CACHE_FOLDER: $(Pipeline.Workspace)/.m2/repository\n+  MAVEN_OPTS: '-Dmaven.repo.local=$(MAVEN_CACHE_FOLDER)'\n+  NodeVersion: '14.x'\n+\n+steps:\n+- task: Cache@2\n+  inputs:\n+    key: 'maven | \"$(Agent.OS)\" | **/pom.xml'\n+    restoreKeys: |\n+      maven | \"$(Agent.OS)\"\n+      maven\n+    path: $(MAVEN_CACHE_FOLDER)\n+  displayName: Cache Maven local repo\n+\n+- bash: |\n+    git config --global user.name \"Azure-Fluent\"\n+    git config --global user.email \"azfluent@microsoft.com\"\n+  displayName: Base Config\n+\n+- bash: |\n+    sudo apt-get install -y --upgrade python3-pip python3-setuptools\n+    pip3 install --upgrade wheel\n+    pip3 install --upgrade PyYAML\n+  displayName: Update python\n+\n+- task: NodeTool@0\n+  displayName: 'Install Node.js $(NodeVersion)'\n+  inputs:\n+    versionSpec: '$(NodeVersion)'\n+\n+- bash: |\n+    npm install -g autorest\n+    npm install\n+  displayName: 'Install autorest'\n+\n+- bash: |\n+    export PATH=$JAVA_HOME_11_X64/bin:$PATH\n+    java -version\n+    ./eng/mgmt/automation/generate.py --readme \"$(README)\" --tag \"$(TAG)\" --service \"$(SERVICE)\" --version \"$(VERSION)\" --auto-commit-generated-code\n+  displayName: Generation and Compile\n+\n+- bash: |\n+    export MESSAGE=\"[Automation] Generate Fluent Lite from $(README)#$(TAG)\"\n+    export BRANCH=\"Fluent-lite-generation-$(Build.BuildId)\"\n+    git add -A\n+    git commit -m \"[Automation] Update other files outside generation folder\"\n+    git log -2\n+    git push https://$(GITHUB_TOKEN)@github.com/azure-fluent/azure-sdk-for-java HEAD:refs/heads/$BRANCH -f\n+    python3 eng/mgmt/pull-request.py chentanyi azure-sdk-for-java \"$MESSAGE\" \"azure-fluent:$BRANCH\"\n+  displayName: Create pull request\n+  env:\n+    GITHUB_TOKEN: $(GITHUB_TOKEN)", "originalCommit": "ad6436c5d178311d5b3fcd157ff326e46d4d1afa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUwMjAzMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17679#discussion_r527502032", "bodyText": "done", "author": "ChenTanyi", "createdAt": "2020-11-20T08:00:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI5MTU3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI5NDY2Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17679#discussion_r527294666", "bodyText": "orthogonal but it would be good for use to use the shared code to submit pull requests, see https://github.com/Azure/azure-sdk-for-java/blob/master/eng/common/pipelines/templates/steps/create-pull-request.yml.", "author": "weshaggard", "createdAt": "2020-11-20T00:20:36Z", "path": "eng/mgmt/automation/generation.yml", "diffHunk": "@@ -0,0 +1,61 @@\n+trigger: none\n+\n+pr: none\n+\n+pool:\n+  vmImage: 'ubuntu-18.04'\n+\n+variables:\n+  MAVEN_CACHE_FOLDER: $(Pipeline.Workspace)/.m2/repository\n+  MAVEN_OPTS: '-Dmaven.repo.local=$(MAVEN_CACHE_FOLDER)'\n+  NodeVersion: '14.x'\n+\n+steps:\n+- task: Cache@2\n+  inputs:\n+    key: 'maven | \"$(Agent.OS)\" | **/pom.xml'\n+    restoreKeys: |\n+      maven | \"$(Agent.OS)\"\n+      maven\n+    path: $(MAVEN_CACHE_FOLDER)\n+  displayName: Cache Maven local repo\n+\n+- bash: |\n+    git config --global user.name \"Azure-Fluent\"\n+    git config --global user.email \"azfluent@microsoft.com\"\n+  displayName: Base Config\n+\n+- bash: |\n+    sudo apt-get install -y --upgrade python3-pip python3-setuptools\n+    pip3 install --upgrade wheel\n+    pip3 install --upgrade PyYAML\n+  displayName: Update python\n+\n+- task: NodeTool@0\n+  displayName: 'Install Node.js $(NodeVersion)'\n+  inputs:\n+    versionSpec: '$(NodeVersion)'\n+\n+- bash: |\n+    npm install -g autorest\n+    npm install\n+  displayName: 'Install autorest'\n+\n+- bash: |\n+    export PATH=$JAVA_HOME_11_X64/bin:$PATH\n+    java -version\n+    ./eng/mgmt/automation/generate.py --readme \"$(README)\" --tag \"$(TAG)\" --service \"$(SERVICE)\" --version \"$(VERSION)\" --auto-commit-generated-code\n+  displayName: Generation and Compile\n+\n+- bash: |\n+    export MESSAGE=\"[Automation] Generate Fluent Lite from $(README)#$(TAG)\"\n+    export BRANCH=\"Fluent-lite-generation-$(Build.BuildId)\"\n+    git add -A\n+    git commit -m \"[Automation] Update other files outside generation folder\"\n+    git log -2\n+    git push https://$(GITHUB_TOKEN)@github.com/azure-fluent/azure-sdk-for-java HEAD:refs/heads/$BRANCH -f\n+    python3 eng/mgmt/pull-request.py chentanyi azure-sdk-for-java \"$MESSAGE\" \"azure-fluent:$BRANCH\"", "originalCommit": "ad6436c5d178311d5b3fcd157ff326e46d4d1afa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzM1OTg1Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17679#discussion_r527359856", "bodyText": "As the yml show, it need the github-pat of azure-sdk, is the pat will auto-apply to all pipeline in azure-sdk devops? Or I would use Azure-Fluent account instead?", "author": "ChenTanyi", "createdAt": "2020-11-20T02:49:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI5NDY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzM2Mzg3NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17679#discussion_r527363874", "bodyText": "Unless there is a reason you need to use the azure-fluent account specifically I'd suggest just using the azure-sdk service account like a lot of our other automation does.", "author": "weshaggard", "createdAt": "2020-11-20T03:03:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI5NDY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzM5OTQwNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17679#discussion_r527399407", "bodyText": "Yes, I think we could use the azure-sdk account. So I would like to know do we need to set the azure-sdk github-pat manually in the pipeline?", "author": "ChenTanyi", "createdAt": "2020-11-20T05:04:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI5NDY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUwMjE0OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17679#discussion_r527502148", "bodyText": "change to azure-sdk done", "author": "ChenTanyi", "createdAt": "2020-11-20T08:00:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI5NDY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgzOTM5Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17679#discussion_r527839393", "bodyText": "You don't set it manually in the pipeline but instead hook up the correct variable group that has the secret which is pulled from keyvault. I", "author": "weshaggard", "createdAt": "2020-11-20T17:15:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI5NDY2Ng=="}], "type": "inlineReview"}, {"oid": "ccb6efcd2af88d6ad7f9aaa13b12ffd21ef9381a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ccb6efcd2af88d6ad7f9aaa13b12ffd21ef9381a", "message": "update script and yml", "committedDate": "2020-11-20T07:55:24Z", "type": "commit"}, {"oid": "fffc2052bd749f9bcc5e8bd38831234f2b3416a6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/fffc2052bd749f9bcc5e8bd38831234f2b3416a6", "message": "not compile and cache in generation", "committedDate": "2020-11-23T02:43:16Z", "type": "commit"}, {"oid": "92cc0306005d0db6a55a4e3343ecd39fe6c6adbe", "url": "https://github.com/Azure/azure-sdk-for-java/commit/92cc0306005d0db6a55a4e3343ecd39fe6c6adbe", "message": "auto commit external change", "committedDate": "2020-11-23T03:07:44Z", "type": "commit"}]}