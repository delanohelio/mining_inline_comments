{"pr_number": 14797, "pr_title": "[Tables] Fix tables livetest", "pr_createdAt": "2020-09-03T22:46:26Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/14797", "timeline": [{"oid": "ae88645cb0a4fbd9567ff9297cd23c8713aec7a7", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ae88645cb0a4fbd9567ff9297cd23c8713aec7a7", "message": "Fix tables livetest", "committedDate": "2020-09-03T23:11:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ1MDkxOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14797#discussion_r483450918", "bodyText": "We run them in LIVE mode so that the results aren't persisted, it'll just run against the live service.", "author": "conniey", "createdAt": "2020-09-04T07:53:58Z", "path": "sdk/tables/tests.yml", "diffHunk": "@@ -7,7 +7,7 @@ jobs:\n       Timeout: 60\n       MaxParallel: 12\n       EnvVars:\n-        AZURE_TEST_MODE: LIVE\n+        AZURE_TEST_MODE: RECORD", "originalCommit": "ae88645cb0a4fbd9567ff9297cd23c8713aec7a7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc3Njc4Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14797#discussion_r483776786", "bodyText": "I thought they would work mostly the same, but when I run in LIVE mode I get an error from azure core that recordFile is null (or something like that, I don't 100% precisely recall the error). I'm not sure why it works for RECORD but not for LIVE.", "author": "bsiegel", "createdAt": "2020-09-04T18:06:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ1MDkxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU3ODk5Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14797#discussion_r484578997", "bodyText": "Fixed", "author": "bsiegel", "createdAt": "2020-09-07T22:36:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ1MDkxOA=="}], "type": "inlineReview"}, {"oid": "7a9c189f3db2cec597f3002a079df06a810cd7b6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7a9c189f3db2cec597f3002a079df06a810cd7b6", "message": "Fix tests and re-enable disabled tests", "committedDate": "2020-09-07T22:36:08Z", "type": "forcePushed"}, {"oid": "19acd897f614fce1918d180c16ecbbb1e74a0277", "url": "https://github.com/Azure/azure-sdk-for-java/commit/19acd897f614fce1918d180c16ecbbb1e74a0277", "message": "Fix checkstyle", "committedDate": "2020-09-07T22:43:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNjY4Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14797#discussion_r485126687", "bodyText": "Does this work for async? The apply method would return a Mono but it would not actually be invoked until someone subscribed to it.\nI think a more reactive approach is required to keep retrying depending on the error. there is a retryWhen operator.", "author": "conniey", "createdAt": "2020-09-08T18:49:02Z", "path": "sdk/tables/azure-data-tables/src/test/java/com/azure/data/tables/CosmosThrottled.java", "diffHunk": "@@ -0,0 +1,110 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.data.tables;\n+\n+import com.azure.core.exception.AzureException;\n+import com.azure.data.tables.implementation.AzureTableImpl;\n+import com.azure.data.tables.implementation.models.TableServiceErrorException;\n+\n+import java.util.function.Consumer;\n+import java.util.function.Function;\n+\n+public abstract class CosmosThrottled<T> {\n+    protected final T client;\n+    protected final boolean isPlaybackMode;\n+\n+    protected CosmosThrottled(T client, boolean isPlaybackMode) {\n+        this.client = client;\n+        this.isPlaybackMode = isPlaybackMode;\n+    }\n+\n+    public abstract boolean isCosmos();\n+\n+    public void runVoid(Consumer<T> action) {\n+        run(c -> {\n+            action.accept(c);\n+            return null;\n+        });\n+    }\n+\n+    public T getClient() {\n+        return client;\n+    }\n+\n+    public <TResult> TResult run(Function<T, TResult> action) {\n+        if (!isCosmos()) {\n+            return action.apply(client);\n+        }\n+\n+        int retryCount = 0;\n+        int delay = 1500;\n+        while (true) {\n+            try {\n+                return action.apply(client);", "originalCommit": "718971bf20e783ca1333d4e25212d93e3f6c3e1b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI2NTYwNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14797#discussion_r485265604", "bodyText": "Turns out that this was actually unneeded, I just needed to configure the retrypolicy to allow more retries & backoff time.", "author": "bsiegel", "createdAt": "2020-09-09T00:22:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNjY4Nw=="}], "type": "inlineReview"}, {"oid": "d64917d510f80b43d10dd6bac7c7da1f6f5a4743", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d64917d510f80b43d10dd6bac7c7da1f6f5a4743", "message": "Remove CosmosThrottled", "committedDate": "2020-09-09T00:18:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI2NzIwMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14797#discussion_r485267203", "bodyText": "Can we split this into another test case and disable it? I feel it'll get lost as a comment since there is no issue or TODO tracking this.", "author": "conniey", "createdAt": "2020-09-09T00:28:28Z", "path": "sdk/tables/azure-data-tables/src/test/java/com/azure/data/tables/TablesAsyncClientTest.java", "diffHunk": "@@ -339,20 +361,27 @@ void updateEntityWithResponseAsync(UpdateMode mode) {\n         createdEntity.getProperties().remove(oldPropertyKey);\n         createdEntity.addProperty(newPropertyKey, \"valueB\");\n \n-        // Act\n-        StepVerifier.create(tableClient.updateEntityWithResponse(createdEntity, true, mode))\n-            .assertNext(response -> assertEquals(expectedStatusCode, response.getStatusCode()))\n-            .expectComplete()\n-            .verify();\n-\n-        // Assert and verify that the new properties are in there.\n-        StepVerifier.create(tableClient.getEntity(partitionKeyValue, rowKeyValue))\n-            .assertNext(entity -> {\n-                final Map<String, Object> properties = entity.getProperties();\n-                assertTrue(properties.containsKey(newPropertyKey));\n-                assertEquals(expectOldProperty, properties.containsKey(oldPropertyKey));\n-            })\n-            .verifyComplete();\n+        // Act & Assert\n+        if (mode == UpdateMode.MERGE && tableClient.getTableUrl().contains(\"cosmos.azure.com\")) {\n+            // This scenario is currently broken when using the CosmosDB Table API\n+            StepVerifier.create(tableClient.updateEntityWithResponse(createdEntity, true, mode))", "originalCommit": "d64917d510f80b43d10dd6bac7c7da1f6f5a4743", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI2ODI5OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14797#discussion_r485268299", "bodyText": "Yes, once support is merged for multiple tests with the same name (#14801) I will separate these into two test classes, one for Cosmos and one for Storage, each with their own recordings.", "author": "bsiegel", "createdAt": "2020-09-09T00:32:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI2NzIwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI2ODkxNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14797#discussion_r485268917", "bodyText": "Tracking this work in #14930", "author": "bsiegel", "createdAt": "2020-09-09T00:34:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI2NzIwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI2NzM5Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14797#discussion_r485267397", "bodyText": "Is there a reason for splitting this into three sequential blocks rather than running them concurrently?", "author": "conniey", "createdAt": "2020-09-09T00:29:16Z", "path": "sdk/tables/azure-data-tables/src/test/java/com/azure/data/tables/TableServiceAsyncClientTest.java", "diffHunk": "@@ -228,12 +227,10 @@ void serviceListTablesWithTopAsync() {\n         final String tableName2 = testResourceNamer.randomName(\"test\", 20);\n         final String tableName3 = testResourceNamer.randomName(\"test\", 20);\n         ListTablesOptions options = new ListTablesOptions().setTop(2);\n-        Mono.when(\n-            serviceClient.createTable(tableName),\n-            serviceClient.createTable(tableName2),\n-            serviceClient.createTable(tableName3)\n-        ).block(TIMEOUT);\n-        \n+        serviceClient.createTable(tableName).block(TIMEOUT);", "originalCommit": "d64917d510f80b43d10dd6bac7c7da1f6f5a4743", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI2Nzk4OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14797#discussion_r485267989", "bodyText": "I was having intermittent 429 issues with failures when using Mono.when with multiple streams against the CosmosDB API.", "author": "bsiegel", "createdAt": "2020-09-09T00:31:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI2NzM5Nw=="}], "type": "inlineReview"}, {"oid": "6853bab045dadfe1ec90e242060187ab848d5427", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6853bab045dadfe1ec90e242060187ab848d5427", "message": "Fix tables livetest", "committedDate": "2020-09-09T00:39:57Z", "type": "commit"}, {"oid": "2c2ba82a073bb2302a21385bef5bb7d854eab5ab", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2c2ba82a073bb2302a21385bef5bb7d854eab5ab", "message": "Fix LIVE mode", "committedDate": "2020-09-09T00:39:58Z", "type": "commit"}, {"oid": "701ffe60b97d0a32c76c65c7779a5f01788e189f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/701ffe60b97d0a32c76c65c7779a5f01788e189f", "message": "Work around unsupported operation in Cosmos API", "committedDate": "2020-09-09T00:39:58Z", "type": "commit"}, {"oid": "e8eeabeca907e280dfabb4f2f44463c6e56b3a28", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e8eeabeca907e280dfabb4f2f44463c6e56b3a28", "message": "Add CosmosThrottled wrapper", "committedDate": "2020-09-09T00:39:58Z", "type": "commit"}, {"oid": "b46416429c0dc87033d53246d68e91f4696370d5", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b46416429c0dc87033d53246d68e91f4696370d5", "message": "Fix merge test", "committedDate": "2020-09-09T00:39:59Z", "type": "commit"}, {"oid": "4969d95f09583416e56fce3220eb4a2c885e6a59", "url": "https://github.com/Azure/azure-sdk-for-java/commit/4969d95f09583416e56fce3220eb4a2c885e6a59", "message": "Fix cleanup in ImplTest", "committedDate": "2020-09-09T00:39:59Z", "type": "commit"}, {"oid": "c775e68a5d12777096440e0e30ea50c4b542ec47", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c775e68a5d12777096440e0e30ea50c4b542ec47", "message": "Mono.when doesn't play nice with CosmosThrottle", "committedDate": "2020-09-09T00:39:59Z", "type": "commit"}, {"oid": "39d23000bfc7b47f66fc48288a6b322841a204c9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/39d23000bfc7b47f66fc48288a6b322841a204c9", "message": "Permit more retries in tests", "committedDate": "2020-09-09T00:40:00Z", "type": "commit"}, {"oid": "d08fd4741f461db1eb8c92940066d3ad90d66dc9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d08fd4741f461db1eb8c92940066d3ad90d66dc9", "message": "Fix tests and re-enable disabled tests", "committedDate": "2020-09-09T00:40:00Z", "type": "commit"}, {"oid": "2366f82c22bd616c4dd993ea62cb0ca08442d38a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2366f82c22bd616c4dd993ea62cb0ca08442d38a", "message": "Fix checkstyle", "committedDate": "2020-09-09T00:40:00Z", "type": "commit"}, {"oid": "2bebd0fa8f9da706a83923c9bf3cf3fcfa46a60e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2bebd0fa8f9da706a83923c9bf3cf3fcfa46a60e", "message": "Update recordings", "committedDate": "2020-09-09T00:40:01Z", "type": "commit"}, {"oid": "582c6dbd88b857239e963d62babddbbb5e77db08", "url": "https://github.com/Azure/azure-sdk-for-java/commit/582c6dbd88b857239e963d62babddbbb5e77db08", "message": "Remove CosmosThrottled", "committedDate": "2020-09-09T00:40:01Z", "type": "commit"}, {"oid": "582c6dbd88b857239e963d62babddbbb5e77db08", "url": "https://github.com/Azure/azure-sdk-for-java/commit/582c6dbd88b857239e963d62babddbbb5e77db08", "message": "Remove CosmosThrottled", "committedDate": "2020-09-09T00:40:01Z", "type": "forcePushed"}]}