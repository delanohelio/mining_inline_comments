{"pr_number": 18174, "pr_title": "Update aad webapp sample", "pr_createdAt": "2020-12-16T07:58:16Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/18174", "timeline": [{"oid": "aa08c238a65233548d750f16993f25a8e29cc21a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/aa08c238a65233548d750f16993f25a8e29cc21a", "message": "delete backend v1 and v2 samples", "committedDate": "2020-12-14T03:00:49Z", "type": "commit"}, {"oid": "54cb6a4bbcaadf99067bf0887712e188523ef671", "url": "https://github.com/Azure/azure-sdk-for-java/commit/54cb6a4bbcaadf99067bf0887712e188523ef671", "message": "add webapp sample", "committedDate": "2020-12-14T06:39:13Z", "type": "commit"}, {"oid": "1135cd641da51390949c8fd14a55f62ac2a44a08", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1135cd641da51390949c8fd14a55f62ac2a44a08", "message": "fix pipeline errors", "committedDate": "2020-12-14T07:27:49Z", "type": "commit"}, {"oid": "4e6bf85ac52772fe2cb7bd8dc4f0d244fdcf54a8", "url": "https://github.com/Azure/azure-sdk-for-java/commit/4e6bf85ac52772fe2cb7bd8dc4f0d244fdcf54a8", "message": "update backend sample for new features", "committedDate": "2020-12-15T08:55:25Z", "type": "commit"}, {"oid": "e443c4bcd7d2916b1bfe33279661a44fa394e539", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e443c4bcd7d2916b1bfe33279661a44fa394e539", "message": "Merge branch 'master' of https://github.com/Azure/azure-sdk-for-java into update-aad-backend-sample", "committedDate": "2020-12-15T09:09:17Z", "type": "commit"}, {"oid": "d5a8fa9ad7f76b32fbae7d8dfe2d56a086a6a382", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d5a8fa9ad7f76b32fbae7d8dfe2d56a086a6a382", "message": "Merge branch 'master' of https://github.com/Azure/azure-sdk-for-java into update-aad-backend-sample", "committedDate": "2020-12-16T02:20:46Z", "type": "commit"}, {"oid": "107292de239844785efdaf1b6886281862b6c3b1", "url": "https://github.com/Azure/azure-sdk-for-java/commit/107292de239844785efdaf1b6886281862b6c3b1", "message": "fix scope bug of on-demand case", "committedDate": "2020-12-16T07:45:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEwNTU2Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18174#discussion_r544105567", "bodyText": "Unused import, I think.", "author": "chenrujun", "createdAt": "2020-12-16T08:32:03Z", "path": "sdk/spring/azure-spring-boot-samples/azure-spring-boot-sample-active-directory-webapp/src/main/java/com/azure/spring/sample/aad/security/AADOAuth2LoginSecurityConfig.java", "diffHunk": "@@ -4,14 +4,22 @@\n package com.azure.spring.sample.aad.security;\n \n import com.azure.spring.aad.webapp.AzureOAuth2Configuration;\n+import org.springframework.beans.factory.annotation.Autowired;", "originalCommit": "107292de239844785efdaf1b6886281862b6c3b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEwNTg1OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18174#discussion_r544105858", "bodyText": "value is not supported any more.", "author": "chenrujun", "createdAt": "2020-12-16T08:32:32Z", "path": "sdk/spring/azure-spring-boot-samples/azure-spring-boot-sample-active-directory-webapp/src/main/resources/application.yml", "diffHunk": "@@ -0,0 +1,23 @@\n+azure:\n+  activedirectory:\n+    authorization:\n+      arm:\n+        on-demand: true\n+        scopes: https://management.core.windows.net/user_impersonation\n+      graph:\n+        scopes: https://graph.microsoft.com/Calendars.Read\n+      office:\n+        scopes: https://manage.office.com/ActivityFeed.Read\n+    client-id: <client-id>\n+    client-secret: <client-secret>\n+    tenant-id: <tenant-id>\n+    user-group:\n+      allowed-groups: group1, group2\n+      value: '#microsoft.graph.group'", "originalCommit": "107292de239844785efdaf1b6886281862b6c3b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEwNzg2Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18174#discussion_r544107862", "bodyText": "We can return the json string of oAuth2AuthorizedClient, and output json string in logAuthorizedClient.", "author": "chenrujun", "createdAt": "2020-12-16T08:36:01Z", "path": "sdk/spring/azure-spring-boot-samples/azure-spring-boot-sample-active-directory-webapp/src/main/java/com/azure/spring/sample/aad/controller/ClientController.java", "diffHunk": "@@ -0,0 +1,65 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.spring.sample.aad.controller;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.security.oauth2.client.OAuth2AuthorizedClient;\n+import org.springframework.security.oauth2.client.annotation.RegisteredOAuth2AuthorizedClient;\n+import org.springframework.security.oauth2.client.registration.ClientRegistration;\n+import org.springframework.security.oauth2.core.OAuth2AccessToken;\n+import org.springframework.stereotype.Controller;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.ResponseBody;\n+\n+import java.util.Optional;\n+\n+@Controller\n+public class ClientController {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ClientController.class);\n+\n+    @GetMapping(\"/graph\")\n+    @ResponseBody\n+    public String graph(\n+        @RegisteredOAuth2AuthorizedClient(\"graph\") OAuth2AuthorizedClient oAuth2AuthorizedClient\n+    ) {\n+        logAuthorizedClient(oAuth2AuthorizedClient);\n+        return \"graph\";", "originalCommit": "107292de239844785efdaf1b6886281862b6c3b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEwODM0MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18174#discussion_r544108341", "bodyText": "Azure Active Directory for WebApi", "author": "chenrujun", "createdAt": "2020-12-16T08:36:44Z", "path": "sdk/spring/azure-spring-boot-starter-active-directory/README.md", "diffHunk": "@@ -290,8 +290,7 @@ For more information about setting logging in spring, please refer to the [offic\n The following section provides sample projects illustrating how to use the starter in different cases.\n ### More sample code\n - [Azure Active Directory for Frontend](https://github.com/Azure/azure-sdk-for-java/blob/master/sdk/spring/azure-spring-boot-samples/azure-spring-boot-sample-active-directory-resource-server)", "originalCommit": "107292de239844785efdaf1b6886281862b6c3b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEwODYxNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18174#discussion_r544108616", "bodyText": "These will be deleted in another PR, right?", "author": "chenrujun", "createdAt": "2020-12-16T08:37:11Z", "path": "sdk/spring/azure-spring-boot-starter-active-directory/README.md", "diffHunk": "@@ -219,7 +219,7 @@ If you're using [Azure China](https://docs.microsoft.com/azure/china/china-welco\n azure.activedirectory.environment=cn-v2-graph", "originalCommit": "107292de239844785efdaf1b6886281862b6c3b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc1MzM4Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18174#discussion_r544753387", "bodyText": "There will be a PR later to update readme and changelog, but in case I forget this point, let me fix it now.", "author": "yiliuTo", "createdAt": "2020-12-17T01:56:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEwODYxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEwODcxNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18174#discussion_r544108714", "bodyText": "Azure Active Directory for WebApi", "author": "chenrujun", "createdAt": "2020-12-16T08:37:20Z", "path": "sdk/spring/azure-spring-boot-starter/README.md", "diffHunk": "@@ -28,8 +28,7 @@ This starter brings auto configuration code for all Azure Spring modules, but to\n The following section provides sample projects illustrating how to use the Azure Spring Boot starters.\n ### More sample code\n - [Azure Active Directory for Frontend](https://github.com/Azure/azure-sdk-for-java/blob/master/sdk/spring/azure-spring-boot-samples/azure-spring-boot-sample-active-directory-resource-server)", "originalCommit": "107292de239844785efdaf1b6886281862b6c3b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEwODc4NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18174#discussion_r544108785", "bodyText": "Azure Active Directory for WebApi", "author": "chenrujun", "createdAt": "2020-12-16T08:37:28Z", "path": "sdk/spring/azure-spring-boot-starter/README.md", "diffHunk": "@@ -59,8 +58,7 @@ For more information about setting logging in spring, please refer to the [offic\n The following section provides sample projects illustrating how to use the Azure Spring Boot starters.\n ### More sample code\n - [Azure Active Directory for Frontend](https://github.com/Azure/azure-sdk-for-java/blob/master/sdk/spring/azure-spring-boot-samples/azure-spring-boot-sample-active-directory-resource-server)", "originalCommit": "107292de239844785efdaf1b6886281862b6c3b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEwODk0OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18174#discussion_r544108948", "bodyText": "Azure Active Directory for WebApi", "author": "chenrujun", "createdAt": "2020-12-16T08:37:43Z", "path": "sdk/spring/azure-spring-boot/README.md", "diffHunk": "@@ -59,8 +59,7 @@ For details, please see sample code in the [azure-spring-boot-sample-cloud-found\n The following section provides sample projects illustrating how to use the Azure Spring Boot starters.\n ### More sample code\n - [Azure Active Directory for Frontend](https://github.com/Azure/azure-sdk-for-java/blob/master/sdk/spring/azure-spring-boot-samples/azure-spring-boot-sample-active-directory-resource-server)", "originalCommit": "107292de239844785efdaf1b6886281862b6c3b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDEwOTQ3MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18174#discussion_r544109470", "bodyText": "Put ? and : at the beginning of a line.", "author": "chenrujun", "createdAt": "2020-12-16T08:38:37Z", "path": "sdk/spring/azure-spring-boot/src/main/java/com/azure/spring/aad/webapp/AuthzCodeGrantRequestEntityConverter.java", "diffHunk": "@@ -26,20 +26,17 @@ public AuthzCodeGrantRequestEntityConverter(AzureClientRegistration client) {\n     @SuppressWarnings(\"unchecked\")\n     public RequestEntity<?> convert(OAuth2AuthorizationCodeGrantRequest request) {\n         RequestEntity<?> result = super.convert(request);\n-        if (isRequestForDefaultClient(request)) {\n-            Optional.ofNullable(result)\n-                    .map(HttpEntity::getBody)\n-                    .map(b -> (MultiValueMap<String, String>) b)\n-                    .ifPresent(body -> body.add(\"scope\", scopeValue()));\n-        }\n+        String scopes = String.join(\" \", isRequestForDefaultClient(request) ?\n+            azureClient.getAccessTokenScopes() :\n+            request.getClientRegistration().getScopes());", "originalCommit": "107292de239844785efdaf1b6886281862b6c3b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "58cfdf7b3f0d2fc94c9d29bcc55f6e427c9d428a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/58cfdf7b3f0d2fc94c9d29bcc55f6e427c9d428a", "message": "update converter test for ondemand test", "committedDate": "2020-12-16T09:24:49Z", "type": "commit"}, {"oid": "fc5b4b8706a9e322e12f5649640dcba1bc36e2d8", "url": "https://github.com/Azure/azure-sdk-for-java/commit/fc5b4b8706a9e322e12f5649640dcba1bc36e2d8", "message": "print json string in client controller", "committedDate": "2020-12-17T01:57:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDgyMjAzMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18174#discussion_r544822032", "bodyText": "Can we set it as\nprivate static final ObjectMapper OBJECT_MAPPER= new ObjectMapper().enable(SerializationFeature.INDENT_OUTPUT);\n\nAnd it's used in many classes, so write a public static final toJsonString(Object) {...} a util class is a better way.", "author": "chenrujun", "createdAt": "2020-12-17T05:27:24Z", "path": "sdk/spring/azure-spring-boot-samples/azure-spring-boot-sample-active-directory-webapp/src/main/java/com/azure/spring/sample/aad/controller/ClientController.java", "diffHunk": "@@ -0,0 +1,53 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.spring.sample.aad.controller;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.SerializationFeature;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.security.oauth2.client.OAuth2AuthorizedClient;\n+import org.springframework.security.oauth2.client.annotation.RegisteredOAuth2AuthorizedClient;\n+import org.springframework.stereotype.Controller;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.ResponseBody;\n+\n+@Controller\n+public class ClientController {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ClientController.class);\n+\n+    @GetMapping(\"/graph\")\n+    @ResponseBody\n+    public String graph(\n+        @RegisteredOAuth2AuthorizedClient(\"graph\") OAuth2AuthorizedClient oAuth2AuthorizedClient\n+    ) throws JsonProcessingException {\n+        ObjectMapper mapper = new ObjectMapper().enable(SerializationFeature.INDENT_OUTPUT);", "originalCommit": "fc5b4b8706a9e322e12f5649640dcba1bc36e2d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDgyODEyNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18174#discussion_r544828127", "bodyText": "Thanks, a good idea!", "author": "yiliuTo", "createdAt": "2020-12-17T05:46:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDgyMjAzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDgyMzQyMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18174#discussion_r544823421", "bodyText": "The diff is caused by mistake?", "author": "chenrujun", "createdAt": "2020-12-17T05:31:49Z", "path": "sdk/spring/azure-spring-boot-starter-active-directory/README.md", "diffHunk": "@@ -88,11 +88,11 @@ Refer to different samples for different authentication ways.\n \n **Note**: `AADAppRoleStatelessAuthenticationFilter` and `AADAuthenticationFilter` will be deprecated. [Click here](https://github.com/Azure/azure-sdk-for-java/issues/17860) to replace it.\n \n-### Authenticate in backend\n+### Authenticate in webapp\n \n-Please refer to [azure-spring-boot-sample-active-directory-backend](https://github.com/Azure/azure-sdk-for-java/blob/master/sdk/spring/azure-spring-boot-samples/azure-spring-boot-sample-active-directory-backend/README.md) for authenticate in backend. Or [azure-spring-boot-sample-active-directory-backend-v2](https://github.com/Azure/azure-sdk-for-java/blob/master/sdk/spring/azure-spring-boot-samples/azure-spring-boot-sample-active-directory-backend-v2/README.md) to use Microsoft Graph API instead of Azure Active Directory Graph API.\n+Please refer to [azure-spring-boot-sample-active-directory-webapp](https://github.com/Azure/azure-sdk-for-java/blob/master/sdk/spring/azure-spring-boot-samples/azure-spring-boot-sample-active-directory-webapp/README.md) for authenticate in backend.\n \n-####  Configure application.properties:\n+####  Configure application.properties:`", "originalCommit": "fc5b4b8706a9e322e12f5649640dcba1bc36e2d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDgyMzgyOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18174#discussion_r544823829", "bodyText": "configuration items like spring.security.oauth2.client.registration.azure.xxx is not supported, it's OK to fix in another PR.", "author": "chenrujun", "createdAt": "2020-12-17T05:33:04Z", "path": "sdk/spring/azure-spring-boot-starter-active-directory/README.md", "diffHunk": "@@ -214,12 +214,7 @@ spring.security.oauth2.client.provider.azure.jwk-set-uri=https://login.microsoft\n spring.security.oauth2.client.registration.azure.scope=openid, https://graph.windows.net/user.read, {your-customized-scope}", "originalCommit": "fc5b4b8706a9e322e12f5649640dcba1bc36e2d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0a2ea6583c550e7b7b043490923bbefbe9338909", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0a2ea6583c550e7b7b043490923bbefbe9338909", "message": "remove json logic to a class", "committedDate": "2020-12-17T06:11:27Z", "type": "commit"}]}