{"pr_number": 18073, "pr_title": "Create auto apireview", "pr_createdAt": "2020-12-10T17:21:25Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/18073", "timeline": [{"oid": "198de2fb2afb16b225c7c92259fae5b9e501b390", "url": "https://github.com/Azure/azure-sdk-for-java/commit/198de2fb2afb16b225c7c92259fae5b9e501b390", "message": "Create API review automatically", "committedDate": "2020-12-09T21:21:03Z", "type": "commit"}, {"oid": "0ae1ab11a8036c236060c74c02f4df27086381df", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0ae1ab11a8036c236060c74c02f4df27086381df", "message": "Test with copied common files", "committedDate": "2020-12-10T17:10:17Z", "type": "commit"}, {"oid": "7dafac4a22c51d941b71fccfb24571b13769b67a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7dafac4a22c51d941b71fccfb24571b13769b67a", "message": "Update based on .Net testing", "committedDate": "2020-12-11T08:26:04Z", "type": "commit"}, {"oid": "0e04e4e6661628766d6854be1663a70dff1d62f3", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0e04e4e6661628766d6854be1663a70dff1d62f3", "message": "Update based on .Net testing", "committedDate": "2020-12-11T08:28:02Z", "type": "commit"}, {"oid": "a78108de1e2a60122156da68a757c7b490d760b5", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a78108de1e2a60122156da68a757c7b490d760b5", "message": "Fix package finding script", "committedDate": "2020-12-11T08:52:25Z", "type": "commit"}, {"oid": "69715e8dcf1aace055fce98d412419df01e809a3", "url": "https://github.com/Azure/azure-sdk-for-java/commit/69715e8dcf1aace055fce98d412419df01e809a3", "message": "Fix PS script error in API create", "committedDate": "2020-12-11T09:00:26Z", "type": "commit"}, {"oid": "24227b0f20f5e6949d010b0b655be3eb3bbee80e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/24227b0f20f5e6949d010b0b655be3eb3bbee80e", "message": "More debugging changes", "committedDate": "2020-12-11T09:16:23Z", "type": "commit"}, {"oid": "6821888e617b7f432d0b8be9ae6b9356a539c11b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6821888e617b7f432d0b8be9ae6b9356a539c11b", "message": "More debugging changes", "committedDate": "2020-12-11T09:38:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIzMzMzOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18073#discussion_r541233338", "bodyText": "It is generally bad form to force exit from a helper function. Instead you should return $null and handle at the calling site and exit if that is the entry point script.", "author": "weshaggard", "createdAt": "2020-12-11T20:08:16Z", "path": "eng/scripts/Language-Settings.ps1", "diffHunk": "@@ -216,3 +216,29 @@ function Update-java-CIConfig($pkgs, $ciRepo, $locationInDocRepo, $monikerId=$nu\n \n   Set-Content -Path $pkgJsonLoc -Value $jsonContent\n }\n+\n+\n+# function is used to filter packages to submit to API view tool\n+function Find-java-Artifacts-For-Apireview($artifactDir, $pkgName = \"\")\n+{\n+  Write-Host \"Checking for source jar in artifact path $($artifactDir)\"\n+  # Find all source jar files in given artifact directory\n+  $files = Get-ChildItem \"${artifactDir}\" | Where-Object -FilterScript {$_.Name.EndsWith(\"sources.jar\")}\n+  if (!$files)\n+  {\n+    Write-Host \"$($artifactDir) does not have any package\"\n+    exit(1)", "originalCommit": "6821888e617b7f432d0b8be9ae6b9356a539c11b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTI1Nzg2Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18073#discussion_r541257862", "bodyText": "Fixed", "author": "praveenkuttappan", "createdAt": "2020-12-11T20:31:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIzMzMzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIzNjY4OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18073#discussion_r541236688", "bodyText": "When you move this to common you should also move the name of this function to common.ps1, see https://github.com/Azure/azure-sdk-tools/blob/master/eng/common/scripts/common.ps1#L33.", "author": "weshaggard", "createdAt": "2020-12-11T20:11:46Z", "path": "eng/scripts/Create-APIReview.ps1", "diffHunk": "@@ -0,0 +1,103 @@\n+[CmdletBinding()]\n+Param (\n+  [Parameter(Mandatory=$True)]\n+  [string] $ArtifactPath,\n+  [Parameter(Mandatory=$True)]\n+  [string] $APIViewUri,\n+  [Parameter(Mandatory=$True)]\n+  [string] $APIKey,\n+  [Parameter(Mandatory=$True)]\n+  [string] $APILabel,\n+  [string] $PackageName = \"\"\n+)\n+\n+\n+# Submit API review request and return status whether current revision is approved or pending or failed to create review\n+function Submit-APIReview($packagename, $filePath, $uri, $apiKey, $apiLabel)\n+{\n+    $multipartContent = [System.Net.Http.MultipartFormDataContent]::new()\n+    $FileStream = [System.IO.FileStream]::new($filePath, [System.IO.FileMode]::Open)\n+    $fileHeader = [System.Net.Http.Headers.ContentDispositionHeaderValue]::new(\"form-data\")\n+    $fileHeader.Name = \"file\"\n+    $fileHeader.FileName = $packagename\n+    $fileContent = [System.Net.Http.StreamContent]::new($FileStream)\n+    $fileContent.Headers.ContentDisposition = $fileHeader\n+    $fileContent.Headers.ContentType = [System.Net.Http.Headers.MediaTypeHeaderValue]::Parse(\"application/octet-stream\")\n+    $multipartContent.Add($fileContent)\n+\n+\n+    $stringHeader = [System.Net.Http.Headers.ContentDispositionHeaderValue]::new(\"form-data\")\n+    $stringHeader.Name = \"label\"\n+    $StringContent = [System.Net.Http.StringContent]::new($apiLabel)\n+    $StringContent.Headers.ContentDisposition = $stringHeader\n+    $multipartContent.Add($stringContent)\n+\n+    $headers = @{\n+        \"ApiKey\" = $apiKey;\n+        \"content-type\" = \"multipart/form-data\"\n+    }\n+\n+    try\n+    {\n+        $Response = Invoke-WebRequest -Method 'POST' -Uri $uri -Body $multipartContent -Headers $headers\n+        $StatusCode = $Response.StatusCode\n+    }\n+    catch\n+    {\n+        $StatusCode = $_.Exception.Response.StatusCode\n+    }\n+\n+    return $StatusCode\n+}\n+\n+\n+. (Join-Path $PSScriptRoot Language-Settings.ps1)\n+$packages = @{}\n+if (Test-Path \"Function:Find-java-Artifacts-For-Apireview\")", "originalCommit": "6821888e617b7f432d0b8be9ae6b9356a539c11b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIzNzQ0MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18073#discussion_r541237441", "bodyText": "This will want to include common.ps1 once you move to eng/common.", "author": "weshaggard", "createdAt": "2020-12-11T20:12:30Z", "path": "eng/scripts/Create-APIReview.ps1", "diffHunk": "@@ -0,0 +1,103 @@\n+[CmdletBinding()]\n+Param (\n+  [Parameter(Mandatory=$True)]\n+  [string] $ArtifactPath,\n+  [Parameter(Mandatory=$True)]\n+  [string] $APIViewUri,\n+  [Parameter(Mandatory=$True)]\n+  [string] $APIKey,\n+  [Parameter(Mandatory=$True)]\n+  [string] $APILabel,\n+  [string] $PackageName = \"\"\n+)\n+\n+\n+# Submit API review request and return status whether current revision is approved or pending or failed to create review\n+function Submit-APIReview($packagename, $filePath, $uri, $apiKey, $apiLabel)\n+{\n+    $multipartContent = [System.Net.Http.MultipartFormDataContent]::new()\n+    $FileStream = [System.IO.FileStream]::new($filePath, [System.IO.FileMode]::Open)\n+    $fileHeader = [System.Net.Http.Headers.ContentDispositionHeaderValue]::new(\"form-data\")\n+    $fileHeader.Name = \"file\"\n+    $fileHeader.FileName = $packagename\n+    $fileContent = [System.Net.Http.StreamContent]::new($FileStream)\n+    $fileContent.Headers.ContentDisposition = $fileHeader\n+    $fileContent.Headers.ContentType = [System.Net.Http.Headers.MediaTypeHeaderValue]::Parse(\"application/octet-stream\")\n+    $multipartContent.Add($fileContent)\n+\n+\n+    $stringHeader = [System.Net.Http.Headers.ContentDispositionHeaderValue]::new(\"form-data\")\n+    $stringHeader.Name = \"label\"\n+    $StringContent = [System.Net.Http.StringContent]::new($apiLabel)\n+    $StringContent.Headers.ContentDisposition = $stringHeader\n+    $multipartContent.Add($stringContent)\n+\n+    $headers = @{\n+        \"ApiKey\" = $apiKey;\n+        \"content-type\" = \"multipart/form-data\"\n+    }\n+\n+    try\n+    {\n+        $Response = Invoke-WebRequest -Method 'POST' -Uri $uri -Body $multipartContent -Headers $headers\n+        $StatusCode = $Response.StatusCode\n+    }\n+    catch\n+    {\n+        $StatusCode = $_.Exception.Response.StatusCode\n+    }\n+\n+    return $StatusCode\n+}\n+\n+\n+. (Join-Path $PSScriptRoot Language-Settings.ps1)", "originalCommit": "6821888e617b7f432d0b8be9ae6b9356a539c11b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8ec735a511354c66a91778556121c9e531dfba7f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8ec735a511354c66a91778556121c9e531dfba7f", "message": "Additional fix as per review comments", "committedDate": "2020-12-11T20:31:01Z", "type": "commit"}]}