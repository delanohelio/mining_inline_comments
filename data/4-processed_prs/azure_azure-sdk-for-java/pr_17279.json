{"pr_number": 17279, "pr_title": "Fixed resource address in CosmosException. ", "pr_createdAt": "2020-11-06T21:34:12Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/17279", "timeline": [{"oid": "0d224117a49a9ff2d60b052f083d5dc17fbb2d7f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0d224117a49a9ff2d60b052f083d5dc17fbb2d7f", "message": "Fixed resource address in CosmosException. Added new API to expose regions contacted on CosmosDiagnostics", "committedDate": "2020-11-06T21:27:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE3MzkyNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17279#discussion_r520173924", "bodyText": "why we remove requestUri?\nAnd I think currently we are mixing using resourceAddress and requestUri:\nfor example in RxGatewayStoreModel, we are passing resourceId to resourceAddress of CosmosException\nBut in RntbdRequestManager, we are passing physical address to resourceAddress of CosmosException", "author": "xinlian12", "createdAt": "2020-11-09T22:55:44Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosException.java", "diffHunk": "@@ -284,7 +284,7 @@ CosmosException setDiagnostics(CosmosDiagnostics cosmosDiagnostics) {\n     @Override\n     public String toString() {\n         return getClass().getSimpleName() + \"{\" + \"userAgent=\" + USER_AGENT + \", error=\" + cosmosError + \", resourceAddress='\"\n-                   + resourceAddress  +  \"', requestUri='\" + (requestUri != null ? requestUri.getURIAsString() : null) +  \"', statusCode=\" + statusCode + \", message=\" + getMessage()\n+                   + resourceAddress  +  \", statusCode=\" + statusCode + \", message=\" + getMessage()\n                    + \", causeInfo=\" + causeInfo() + \", responseHeaders=\" + responseHeaders + \", requestHeaders=\"", "originalCommit": "0d224117a49a9ff2d60b052f083d5dc17fbb2d7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI0MDE3NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17279#discussion_r520240175", "bodyText": "Removed requestUri from CosmosException string representation, as it is never set.\nIn RxGatewayStoreModel, we are passing request.getResourceAddress()", "author": "kushagraThapar", "createdAt": "2020-11-10T02:10:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE3MzkyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI0NDg5OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17279#discussion_r520244899", "bodyText": "This is how it looks for gateway -> resourceAddress='dbs/RxJava.SDKTest.SharedDatabase_20201109T182237_GSh/colls/3d2be199-e23b-4af2-a755-510d7068ff97/docs/18b9d280-e899-4300-ae0c-5fe56411aa18,\nAnd for direct -> resourceAddress='rntbd://cdb-ms-prod-westus2-fd26.documents.azure.com:14376/apps/db2a149b-bdb4-4755-b26e-56d1a86cdd4e/services/8ce44d24-fe68-49ae-9784-94b322fa46a3/partitions/003a20cb-a187-4b3a-9bc9-306be0217c36/replicas/132494067072942319s/,\nwhich both are resource addresses.", "author": "kushagraThapar", "createdAt": "2020-11-10T02:26:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE3MzkyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI2NzE0Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17279#discussion_r520267147", "bodyText": "Thanks Kushagra~\nI just wonder should we also capture the server info for gateway mode: (like following)\nhttps://127.0.0.1:8081/dbs/RxJava.SDKTest.SharedDatabase_20201109T193921_erZ/colls/7d5337a3-30f7-46bb-b318-104a5dcfb721\nCurrently, the resourceAddress for gateway mode only contains the resourceId or full name, but not a complete uri. I think that probably why there is requestResource and requestUri there previously? (not sure though)", "author": "xinlian12", "createdAt": "2020-11-10T03:43:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE3MzkyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI3NDg4Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17279#discussion_r520274887", "bodyText": "Good point, not sure how we can capture that, any ideas ?", "author": "kushagraThapar", "createdAt": "2020-11-10T04:12:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE3MzkyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY4NTk2NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17279#discussion_r520685965", "bodyText": "Currently we calculate the uri at RxGatewayStoreModel.performRequest, maybe we can add it in the requestContext?", "author": "xinlian12", "createdAt": "2020-11-10T16:12:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE3MzkyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkyMDY2OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17279#discussion_r520920669", "bodyText": "Yes, I will try to do that, so we can re-use it, will update this thread once I have reached a conclusion :)", "author": "kushagraThapar", "createdAt": "2020-11-10T22:41:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE3MzkyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkyMTUyMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17279#discussion_r520921522", "bodyText": "what about the direct mode? isn't that set in the direct mode? @kushagraThapar  could you please check.", "author": "moderakh", "createdAt": "2020-11-10T22:43:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE3MzkyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkzMDkyNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17279#discussion_r520930925", "bodyText": "@moderakh  - It is not used anywhere, other than at this code piece - https://github.com/Azure/azure-sdk-for-java/blob/master/sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/StoreReader.java#L808\nWhich I am not even sure, if that is correct or not, but don't plan to touch it  :)", "author": "kushagraThapar", "createdAt": "2020-11-10T23:05:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE3MzkyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkzMTY4OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17279#discussion_r520931689", "bodyText": "@xinlian12 @FabianMeiswinkel  - I have added the full resource address in gateway mode too, please check.\nAlso updated the PR with sample.", "author": "kushagraThapar", "createdAt": "2020-11-10T23:07:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE3MzkyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkzOTU1Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17279#discussion_r520939556", "bodyText": "Thanks Kushagra, looks good to me~", "author": "xinlian12", "createdAt": "2020-11-10T23:28:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE3MzkyNA=="}], "type": "inlineReview"}, {"oid": "23ea640141e109e6b2430dfe154169c2aa453a9c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/23ea640141e109e6b2430dfe154169c2aa453a9c", "message": "Fixed resource address in GATEWAY mode to have full physical address", "committedDate": "2020-11-10T23:07:25Z", "type": "commit"}, {"oid": "caf53fb36894e41eaf4e2cf76b90b7185a834e60", "url": "https://github.com/Azure/azure-sdk-for-java/commit/caf53fb36894e41eaf4e2cf76b90b7185a834e60", "message": "Setting physical resource address in tests", "committedDate": "2020-11-11T00:23:56Z", "type": "commit"}, {"oid": "93810625267d4899e6ed6ee87d0e69a1ba274791", "url": "https://github.com/Azure/azure-sdk-for-java/commit/93810625267d4899e6ed6ee87d0e69a1ba274791", "message": "Merge branch 'master' into fix_resource_address_diagnostics_string", "committedDate": "2020-11-11T22:35:05Z", "type": "commit"}]}