{"pr_number": 10220, "pr_title": "Fixing aggregate reports", "pr_createdAt": "2020-04-15T12:14:29Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/10220", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTAxNDk4Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10220#discussion_r409014983", "bodyText": "We want to keep these exclusions.", "author": "srnagar", "createdAt": "2020-04-15T17:33:01Z", "path": "sdk/parents/azure-client-sdk-parent/pom.xml", "diffHunk": "@@ -316,73 +316,31 @@\n         </executions>\n       </plugin>\n \n-      <!-- Performs test coverage analysis -->\n       <plugin>\n         <groupId>org.jacoco</groupId>\n         <artifactId>jacoco-maven-plugin</artifactId>\n         <version>0.8.5</version> <!-- {x-version-update;org.jacoco:jacoco-maven-plugin;external_dependency} -->\n         <executions>\n           <execution>\n-            <id>default-instrument</id>\n+            <id>prepare-agent</id>\n             <goals>\n-              <goal>instrument</goal>\n+              <goal>prepare-agent</goal>\n             </goals>\n           </execution>\n           <execution>\n-            <id>default-restore-instrumented-classes</id>\n+            <id>default-instrument</id>\n             <goals>\n-              <goal>restore-instrumented-classes</goal>\n+              <goal>instrument</goal>\n             </goals>\n           </execution>\n           <execution>\n-            <!-- This generates the unit test reports for individual modules.\n-              jacoco-test-coverage generates aggregate reports for all modules -->\n-            <id>post-unit-test</id>\n-            <goals>\n-              <goal>report</goal>\n-            </goals>\n-            <configuration>\n-              <!-- Sets the output directory for the code coverage report. -->\n-              <outputDirectory>${project.reporting.outputDirectory}/test-coverage</outputDirectory>\n-              <excludes>\n-                <exclude>**/com/azure/cosmos/implementation/apachecommons/**/*</exclude>\n-                <exclude>**/com/azure/cosmos/implementation/guava25/**/*</exclude>\n-                <exclude>**/com/azure/cosmos/implementation/guava27/**/*</exclude>\n-              </excludes>", "originalCommit": "e9ec62c14e29d23fe9a2baa588ceda2a45e41856", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTAxNTUwNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10220#discussion_r409015504", "bodyText": "This is required to ensure we don't fall below coverage threshold. The PR should fail if the coverage is below this threshold.", "author": "srnagar", "createdAt": "2020-04-15T17:33:53Z", "path": "sdk/parents/azure-client-sdk-parent/pom.xml", "diffHunk": "@@ -316,73 +316,31 @@\n         </executions>\n       </plugin>\n \n-      <!-- Performs test coverage analysis -->\n       <plugin>\n         <groupId>org.jacoco</groupId>\n         <artifactId>jacoco-maven-plugin</artifactId>\n         <version>0.8.5</version> <!-- {x-version-update;org.jacoco:jacoco-maven-plugin;external_dependency} -->\n         <executions>\n           <execution>\n-            <id>default-instrument</id>\n+            <id>prepare-agent</id>\n             <goals>\n-              <goal>instrument</goal>\n+              <goal>prepare-agent</goal>\n             </goals>\n           </execution>\n           <execution>\n-            <id>default-restore-instrumented-classes</id>\n+            <id>default-instrument</id>\n             <goals>\n-              <goal>restore-instrumented-classes</goal>\n+              <goal>instrument</goal>\n             </goals>\n           </execution>\n           <execution>\n-            <!-- This generates the unit test reports for individual modules.\n-              jacoco-test-coverage generates aggregate reports for all modules -->\n-            <id>post-unit-test</id>\n-            <goals>\n-              <goal>report</goal>\n-            </goals>\n-            <configuration>\n-              <!-- Sets the output directory for the code coverage report. -->\n-              <outputDirectory>${project.reporting.outputDirectory}/test-coverage</outputDirectory>\n-              <excludes>\n-                <exclude>**/com/azure/cosmos/implementation/apachecommons/**/*</exclude>\n-                <exclude>**/com/azure/cosmos/implementation/guava25/**/*</exclude>\n-                <exclude>**/com/azure/cosmos/implementation/guava27/**/*</exclude>\n-              </excludes>\n-            </configuration>\n-          </execution>\n-          <execution>\n-            <id>check</id>\n+            <id>default-restore-instrumented-classes</id>\n             <goals>\n-              <goal>check</goal>\n+              <goal>restore-instrumented-classes</goal>\n             </goals>\n-            <configuration>\n-              <rules>\n-                <rule>\n-                  <element>BUNDLE</element>\n-                  <limits>\n-                    <limit>\n-                      <counter>LINE</counter>\n-                      <value>COVEREDRATIO</value>\n-                      <minimum>${jacoco.min.linecoverage}</minimum>\n-                    </limit>\n-                    <limit>\n-                      <counter>BRANCH</counter>\n-                      <value>COVEREDRATIO</value>\n-                      <minimum>${jacoco.min.branchcoverage}</minimum>\n-                    </limit>\n-                  </limits>\n-                </rule>\n-              </rules>", "originalCommit": "e9ec62c14e29d23fe9a2baa588ceda2a45e41856", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTAxNzU2NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10220#discussion_r409017565", "bodyText": "This will require a corresponding update to index.html", "author": "srnagar", "createdAt": "2020-04-15T17:37:17Z", "path": "eng/jacoco-test-coverage/pom.xml", "diffHunk": "@@ -188,14 +188,11 @@\n         <version>0.8.5</version> <!-- {x-version-update;org.jacoco:jacoco-maven-plugin;external_dependency} -->\n         <executions>\n           <execution>\n-            <phase>prepare-package</phase>\n+            <id>report-aggregate</id>\n+            <phase>verify</phase>\n             <goals>\n               <goal>report-aggregate</goal>\n             </goals>\n-            <configuration>\n-              <!-- Sets the output directory for the code coverage report. -->\n-              <outputDirectory>${project.reporting.outputDirectory}/test-coverage</outputDirectory>", "originalCommit": "e9ec62c14e29d23fe9a2baa588ceda2a45e41856", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ5ODI2OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10220#discussion_r411498268", "bodyText": "This is the dependency report that gets generated, but this won't generate using the new build structure.", "author": "alzimmermsft", "createdAt": "2020-04-20T16:01:21Z", "path": "eng/pipelines/aggregate-reports.yml", "diffHunk": "@@ -52,13 +50,16 @@ jobs:\n       displayName: Generate Interdependency Report Data\n \n     - pwsh: |\n-        copy -r target/staging $(Build.ArtifactStagingDirectory)\n-        copy target/dependency-whitelist.json (Join-Path $(Build.ArtifactStagingDirectory) \"staging\")\n-        copy eng/code-quality-reports/src/main/resources/index.html $(Build.ArtifactStagingDirectory)\n-        copy output/pom.client.html (Join-Path $(Build.ArtifactStagingDirectory) \"staging\")\n-        copy eng/common/InterdependencyGraph.html (Join-Path $(Build.ArtifactStagingDirectory) \"staging\")\n-        copy eng/common/dependency-whitelist.html (Join-Path $(Build.ArtifactStagingDirectory) \"staging\")\n-        copy data.js (Join-Path $(Build.ArtifactStagingDirectory) \"staging\")\n+        Copy-Item eng/jacoco-test-coverage/target/staging $(Build.ArtifactStagingDirectory) -Recurse\n+        Copy-Item eng/jacoco-test-coverage/target/dependency-whitelist.json $(Build.ArtifactStagingDirectory)\\staging\n+        Copy-Item eng/code-quality-reports/src/main/resources/index.html $(Build.ArtifactStagingDirectory)\n+        \n+        # What is this?\n+        # copy output/pom.client.html (Join-Path $(Build.ArtifactStagingDirectory) \"staging\")", "originalCommit": "4478b7d2baf0b60b3c52e0d13e68c0fea2603cf1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTg0MDgwMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10220#discussion_r411840802", "bodyText": "OK so how do we work around this one? Do we need to move the dependency checker logic into jacoco-test-coverage?", "author": "mitchdenny", "createdAt": "2020-04-21T03:26:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ5ODI2OA=="}], "type": "inlineReview"}, {"oid": "853b8572c501ee9078a28e2453b37eebe469f2e2", "url": "https://github.com/Azure/azure-sdk-for-java/commit/853b8572c501ee9078a28e2453b37eebe469f2e2", "message": "Fixing aggregate reports", "committedDate": "2020-04-22T03:44:25Z", "type": "commit"}, {"oid": "57d650d2f5a7ffbc65e7a44798a58749b1f32a10", "url": "https://github.com/Azure/azure-sdk-for-java/commit/57d650d2f5a7ffbc65e7a44798a58749b1f32a10", "message": "Added version tags.", "committedDate": "2020-04-22T03:44:25Z", "type": "commit"}, {"oid": "12854dce2044e32b4da98b0aa5471d9f397c22d9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/12854dce2044e32b4da98b0aa5471d9f397c22d9", "message": "Restore previous configuration entries & tidy-up.", "committedDate": "2020-04-22T03:46:17Z", "type": "commit"}, {"oid": "688013ca26b61d168e7d254dc39fa3c2f6760271", "url": "https://github.com/Azure/azure-sdk-for-java/commit/688013ca26b61d168e7d254dc39fa3c2f6760271", "message": "Pulling files together from various locations.", "committedDate": "2020-04-22T03:47:43Z", "type": "commit"}, {"oid": "4743134ca0b6be7ba6621432c71c1c723eb99a94", "url": "https://github.com/Azure/azure-sdk-for-java/commit/4743134ca0b6be7ba6621432c71c1c723eb99a94", "message": "Execute site and staging goals.", "committedDate": "2020-04-22T03:47:43Z", "type": "commit"}, {"oid": "941c69d77f4f9672992e8bf65ee82dc3ac1479ce", "url": "https://github.com/Azure/azure-sdk-for-java/commit/941c69d77f4f9672992e8bf65ee82dc3ac1479ce", "message": "Fix parameter name.", "committedDate": "2020-04-22T03:47:44Z", "type": "commit"}, {"oid": "ab71db7718a5ae0dca915e4c4f3e5bd33fd9a8bd", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ab71db7718a5ae0dca915e4c4f3e5bd33fd9a8bd", "message": "Missing period.", "committedDate": "2020-04-22T03:48:07Z", "type": "commit"}, {"oid": "dfd89c60a77455c0bd4cb27bd621431ca93c69dc", "url": "https://github.com/Azure/azure-sdk-for-java/commit/dfd89c60a77455c0bd4cb27bd621431ca93c69dc", "message": "Fix pathing issue.", "committedDate": "2020-04-22T03:48:07Z", "type": "commit"}, {"oid": "ce368c3e21be534cfa3729513179a07db4106e99", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ce368c3e21be534cfa3729513179a07db4106e99", "message": "Remove redundant HTML file.", "committedDate": "2020-04-22T03:48:57Z", "type": "commit"}, {"oid": "ce368c3e21be534cfa3729513179a07db4106e99", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ce368c3e21be534cfa3729513179a07db4106e99", "message": "Remove redundant HTML file.", "committedDate": "2020-04-22T03:48:57Z", "type": "forcePushed"}, {"oid": "aac32313d5865e2a3eb0a9415f1bc3d0734eb253", "url": "https://github.com/Azure/azure-sdk-for-java/commit/aac32313d5865e2a3eb0a9415f1bc3d0734eb253", "message": "/facepalm", "committedDate": "2020-04-22T04:33:32Z", "type": "commit"}]}