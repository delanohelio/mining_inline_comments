{"pr_number": 13599, "pr_title": "encryption minor refactoring and query decryption", "pr_createdAt": "2020-07-29T17:17:18Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/13599", "timeline": [{"oid": "691f8b162dde84440dafd7dd1c27eb397099c308", "url": "https://github.com/Azure/azure-sdk-for-java/commit/691f8b162dde84440dafd7dd1c27eb397099c308", "message": "minor cleanup", "committedDate": "2020-07-17T20:47:17Z", "type": "commit"}, {"oid": "8eda32c50f77257ea46091b21a02819f253e9faf", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8eda32c50f77257ea46091b21a02819f253e9faf", "message": "minor cleanup", "committedDate": "2020-07-17T22:12:12Z", "type": "commit"}, {"oid": "ff37289bdc52b165166b69d2ee91420294818f23", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ff37289bdc52b165166b69d2ee91420294818f23", "message": "encryptor", "committedDate": "2020-07-17T23:02:00Z", "type": "commit"}, {"oid": "77cf2ec44b4f5aa2c9f572af53485db248b22b71", "url": "https://github.com/Azure/azure-sdk-for-java/commit/77cf2ec44b4f5aa2c9f572af53485db248b22b71", "message": "static field name correction, fixed pre-condition check", "committedDate": "2020-07-17T23:05:10Z", "type": "commit"}, {"oid": "5d41cfff387576767afdf515af4587d323eca03e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5d41cfff387576767afdf515af4587d323eca03e", "message": "Merge branch 'master' into users/moderakh/encryption-minor-cleanup", "committedDate": "2020-07-20T16:38:44Z", "type": "commit"}, {"oid": "51f3cdd0fa68f3d7c072e82951be3014935601ba", "url": "https://github.com/Azure/azure-sdk-for-java/commit/51f3cdd0fa68f3d7c072e82951be3014935601ba", "message": "Merge branch 'users/moderakh/encryption-minor-cleanup' into users/moderakh/20200717-encryption", "committedDate": "2020-07-20T17:14:58Z", "type": "commit"}, {"oid": "cfc13d2ff2513f21fd461c3a23691de556945c7a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/cfc13d2ff2513f21fd461c3a23691de556945c7a", "message": "move encryption hooks out of sdk", "committedDate": "2020-07-23T17:42:40Z", "type": "commit"}, {"oid": "2caa15601ede91a5ad95708843eb96ecd48cb0eb", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2caa15601ede91a5ad95708843eb96ecd48cb0eb", "message": "Merge branch 'master' into users/moderakh/20200717-encryption", "committedDate": "2020-07-23T17:54:28Z", "type": "commit"}, {"oid": "7b4cd567147799e37418450ed00a2817ced1fdfe", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7b4cd567147799e37418450ed00a2817ced1fdfe", "message": "encryption", "committedDate": "2020-07-23T18:19:14Z", "type": "commit"}, {"oid": "e5e6f09d3634df5928ac322f9b6198cd73cbd7de", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e5e6f09d3634df5928ac322f9b6198cd73cbd7de", "message": "undid public api change to CosmosItemResponse", "committedDate": "2020-07-23T18:22:42Z", "type": "commit"}, {"oid": "5c17f86d6de14f46671de958b254b3b96d88272b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5c17f86d6de14f46671de958b254b3b96d88272b", "message": "cleanup", "committedDate": "2020-07-23T18:29:06Z", "type": "commit"}, {"oid": "6b2e69796dbf9107018009f57ad33e76def18397", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6b2e69796dbf9107018009f57ad33e76def18397", "message": "cleanup", "committedDate": "2020-07-23T18:39:03Z", "type": "commit"}, {"oid": "0a6458d95e077faae9e7398237c9461ae57c925d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0a6458d95e077faae9e7398237c9461ae57c925d", "message": "code review comments addressed", "committedDate": "2020-07-23T19:02:59Z", "type": "commit"}, {"oid": "9e9d20761317a111cb17ca10ffe1bba4b7c64b1e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9e9d20761317a111cb17ca10ffe1bba4b7c64b1e", "message": "fixed compilation error", "committedDate": "2020-07-23T19:16:12Z", "type": "commit"}, {"oid": "f262d5c0dc7059d832be76326dc91cd1ca7484f7", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f262d5c0dc7059d832be76326dc91cd1ca7484f7", "message": "minor code style cleanup", "committedDate": "2020-07-23T20:02:10Z", "type": "commit"}, {"oid": "a12d345d635a31d2e46c2e890257513ce4c1001f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a12d345d635a31d2e46c2e890257513ce4c1001f", "message": "check style fix", "committedDate": "2020-07-23T22:06:01Z", "type": "commit"}, {"oid": "7b79a5a8e6dc53abaed90535d10292cd9b99d3ac", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7b79a5a8e6dc53abaed90535d10292cd9b99d3ac", "message": "javadoc fix", "committedDate": "2020-07-23T22:30:53Z", "type": "commit"}, {"oid": "88e984e4e32d11b6560782be1d86bd130edf9245", "url": "https://github.com/Azure/azure-sdk-for-java/commit/88e984e4e32d11b6560782be1d86bd130edf9245", "message": "javadoc fix", "committedDate": "2020-07-23T22:35:26Z", "type": "commit"}, {"oid": "6f7d590dc679c865eb081cc7c8b5acea50b94fec", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6f7d590dc679c865eb081cc7c8b5acea50b94fec", "message": "check-style", "committedDate": "2020-07-23T22:49:18Z", "type": "commit"}, {"oid": "1b7ec08f10f7cd791234c8436a511d2d93bc3e21", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1b7ec08f10f7cd791234c8436a511d2d93bc3e21", "message": "query basic support", "committedDate": "2020-07-24T06:17:06Z", "type": "commit"}, {"oid": "c5e67e1e2f69bc71950645c6299342e5af83502f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c5e67e1e2f69bc71950645c6299342e5af83502f", "message": "Merge branch 'master' into users/moderakh/20200723-encryption", "committedDate": "2020-07-24T06:19:35Z", "type": "commit"}, {"oid": "290377d3f80c673d5a0719b526b20a936d770e8e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/290377d3f80c673d5a0719b526b20a936d770e8e", "message": "encryption for query", "committedDate": "2020-07-24T22:45:36Z", "type": "commit"}, {"oid": "ad1136cd0eebc082eef4ca453042e3e05d1d2b89", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ad1136cd0eebc082eef4ca453042e3e05d1d2b89", "message": "Merge branch 'master' into users/moderakh/20200723-encryption", "committedDate": "2020-07-24T22:46:18Z", "type": "commit"}, {"oid": "e171f089fc84bcf2b7294dc2c32a6225d7623360", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e171f089fc84bcf2b7294dc2c32a6225d7623360", "message": "minor package move, cleanup", "committedDate": "2020-07-29T17:09:34Z", "type": "commit"}, {"oid": "9822e2c34844894d500cbcc8232469842a83451f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9822e2c34844894d500cbcc8232469842a83451f", "message": "Merge branch 'master' into users/moderakh/20200723-encryption", "committedDate": "2020-07-29T17:14:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ2MzE1NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13599#discussion_r462463155", "bodyText": "This will probably fail the analyze build - because of multiple spaces between java docs. I can share my intellij code styling file - which you can import and when you refactor code through intellij, it should automatically solve these issues.", "author": "kushagraThapar", "createdAt": "2020-07-29T17:23:13Z", "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/EncryptionCosmosAsyncContainer.java", "diffHunk": "@@ -2,73 +2,80 @@\n // Licensed under the MIT License.\n \n \n-package com.azure.cosmos;\n+package com.azure.cosmos.encryption;\n \n+import com.azure.cosmos.BridgeInternal;\n+import com.azure.cosmos.CosmosAsyncContainer;\n+import com.azure.cosmos.CosmosAsyncDatabase;\n+import com.azure.cosmos.CosmosBridgeInternal;\n+import com.azure.cosmos.implementation.Document;\n import com.azure.cosmos.implementation.ItemDeserializer;\n import com.azure.cosmos.implementation.Utils;\n-import com.azure.cosmos.implementation.apachecommons.lang.NotImplementedException;\n import com.azure.cosmos.implementation.encryption.CosmosResponseFactory;\n import com.azure.cosmos.implementation.encryption.CosmosResponseFactoryCore;\n-import com.azure.cosmos.implementation.encryption.DecryptionResult;\n-import com.azure.cosmos.implementation.encryption.EncryptionItemRequestOptions;\n import com.azure.cosmos.implementation.encryption.EncryptionProcessor;\n+import com.azure.cosmos.implementation.encryption.EncryptionQueryRequestOption;\n import com.azure.cosmos.implementation.encryption.EncryptionUtils;\n import com.azure.cosmos.implementation.guava25.base.Preconditions;\n import com.azure.cosmos.models.CosmosItemRequestOptions;\n import com.azure.cosmos.models.CosmosItemResponse;\n-import com.azure.cosmos.models.EncryptionBridgeInternal;\n+import com.azure.cosmos.models.CosmosQueryRequestOptions;\n+import com.azure.cosmos.models.EncryptionModelBridgeInternal;\n import com.azure.cosmos.models.PartitionKey;\n+import com.azure.cosmos.models.SqlQuerySpec;\n+import com.azure.cosmos.util.CosmosPagedFlux;\n import reactor.core.publisher.Mono;\n import reactor.core.scheduler.Schedulers;\n \n import java.util.function.Consumer;\n+import java.util.function.Function;\n+\n \n // TODO: for now basic functionality is in. some APIs and some logic branch is not complete yet.\n-public class EncryptionCosmosAsyncContainer extends CosmosAsyncContainer {\n+public class EncryptionCosmosAsyncContainer {\n     private final Encryptor encryptor;\n     private final CosmosResponseFactory responseFactory = new CosmosResponseFactoryCore();\n+    private final CosmosAsyncContainer container;\n \n     EncryptionCosmosAsyncContainer(String id, CosmosAsyncDatabase database, Encryptor encryptor) {\n-        super(id, database);\n+        this.container = BridgeInternal.createCosmosAsyncContainer(id, database);\n         this.encryptor = encryptor;\n     }\n \n     private Mono<CosmosItemResponse<byte[]>> createItemStream(byte[] payload,\n                                                               PartitionKey partitionKey,\n-                                                              CosmosItemRequestOptions requestOptions) {\n+                                                              EncryptionItemRequestOptions encryptionItemRequestOptions) {\n         Preconditions.checkNotNull(payload, \"payload can't be null\");\n \n         // TODO: add diagnostics\n-        EncryptionItemRequestOptions encryptionItemRequestOptions = Utils.as(requestOptions, EncryptionItemRequestOptions.class);\n-        if (encryptionItemRequestOptions != null && encryptionItemRequestOptions.getEncryptionOptions() != null) {\n-\n-            payload = EncryptionProcessor.encryptAsync(payload, encryptor, encryptionItemRequestOptions.getEncryptionOptions());\n+        assert encryptionItemRequestOptions != null && encryptionItemRequestOptions.getEncryptionOptions() != null;\n+        payload = EncryptionProcessor.encryptAsync(payload, encryptor, encryptionItemRequestOptions.getEncryptionOptions());\n \n-            Mono<CosmosItemResponse<byte[]>> response = super.createItem(payload, partitionKey, requestOptions);\n+        Mono<CosmosItemResponse<byte[]>> response = container.createItem(payload, partitionKey, encryptionItemRequestOptions);\n \n-            return response\n-                .subscribeOn(Schedulers.elastic())\n-                .publishOn(Schedulers.elastic())\n-                .map(rsp -> {\n-                        EncryptionBridgeInternal.setByteArrayContent(rsp, decryptResponseAsync(EncryptionBridgeInternal.getByteArrayContent(rsp), encryptionItemRequestOptions.getDecryptionResultHandler()));\n-                        return rsp;\n-                    }\n-                );\n-\n-        } else {\n-            throw new NotImplementedException(\"TODO not implemented yet\");\n-            // TODO moderakh compelte the non encryption branch\n-            // return super.createItem()\n-        }\n+        return response\n+            .subscribeOn(Schedulers.elastic())\n+            .publishOn(Schedulers.elastic())\n+            .map(rsp -> {\n+                    EncryptionModelBridgeInternal.setByteArrayContent(\n+                        rsp,\n+                        decryptResponseAsync(\n+                            EncryptionModelBridgeInternal.getByteArrayContent(rsp),\n+                            encryptionItemRequestOptions.getDecryptionResultHandler()));\n+                    return rsp;\n+                }\n+            );\n     }\n \n     // TODO ensure all other apis call this guy\n+\n     /**\n      * create item and encrypts the requested fields\n-     * @param item the Cosmos item represented as a POJO or Cosmos item object.\n-     * @param partitionKey the partition key.\n+     *\n+     * @param item           the Cosmos item represented as a POJO or Cosmos item object.", "originalCommit": "9822e2c34844894d500cbcc8232469842a83451f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ2ODU3Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13599#discussion_r462468573", "bodyText": "thanks for pointing out. will fix and will ensure passes the analyzer.", "author": "moderakh", "createdAt": "2020-07-29T17:32:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ2MzE1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU1MDY3Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13599#discussion_r462550676", "bodyText": "javadoc analyze passed now. addressed. thanks.", "author": "moderakh", "createdAt": "2020-07-29T19:56:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ2MzE1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ2NjA2MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13599#discussion_r462466061", "bodyText": "You should probably start with all these classes as final", "author": "kushagraThapar", "createdAt": "2020-07-29T17:27:58Z", "path": "sdk/cosmos/azure-cosmos-encryption/src/main/java/com/azure/cosmos/encryption/DecryptionResult.java", "diffHunk": "@@ -0,0 +1,35 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+\n+package com.azure.cosmos.encryption;\n+\n+public class DecryptionResult {", "originalCommit": "9822e2c34844894d500cbcc8232469842a83451f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ2ODY0MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13599#discussion_r462468641", "bodyText": "will do. thanks.", "author": "moderakh", "createdAt": "2020-07-29T17:32:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ2NjA2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU1MDQxOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/13599#discussion_r462550419", "bodyText": "addressed.", "author": "moderakh", "createdAt": "2020-07-29T19:55:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ2NjA2MQ=="}], "type": "inlineReview"}, {"oid": "bdb6084b68ba37f607709a86a23375f7348f6ff5", "url": "https://github.com/Azure/azure-sdk-for-java/commit/bdb6084b68ba37f607709a86a23375f7348f6ff5", "message": "code style fix", "committedDate": "2020-07-29T18:49:20Z", "type": "commit"}, {"oid": "9c7dad4144b01582b7358cc3ae13cdf6ffc5dbfa", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9c7dad4144b01582b7358cc3ae13cdf6ffc5dbfa", "message": "fixed check style", "committedDate": "2020-07-29T19:55:07Z", "type": "commit"}, {"oid": "109468b1dace92b5c9772006cdbf118432dc376a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/109468b1dace92b5c9772006cdbf118432dc376a", "message": "Merge branch 'master' into users/moderakh/20200723-encryption", "committedDate": "2020-07-29T23:14:17Z", "type": "commit"}]}