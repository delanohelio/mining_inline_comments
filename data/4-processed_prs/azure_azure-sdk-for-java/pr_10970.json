{"pr_number": 10970, "pr_title": "Added Connection Config APIs for Cosmos Client Builder", "pr_createdAt": "2020-05-08T19:02:02Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/10970", "timeline": [{"oid": "68014968ee33e6482fc57aa5e93bec50eea94542", "url": "https://github.com/Azure/azure-sdk-for-java/commit/68014968ee33e6482fc57aa5e93bec50eea94542", "message": "Added Connection Config APIs for Cosmos Client Builder. Added new tests for connection config\nUpdated existing tests to use new connection configs", "committedDate": "2020-05-08T18:50:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjMyMzI1Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422323253", "bodyText": "we are not exposing public getters for other CosmosClientBuilder apis", "author": "moderakh", "createdAt": "2020-05-08T19:14:35Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosClientBuilder.java", "diffHunk": "@@ -327,6 +317,46 @@ public CosmosClientBuilder contentResponseOnWriteEnabled(boolean contentResponse\n         return this;\n     }\n \n+    /**\n+     * Sets the GATEWAY connection configuration to be used.\n+     *\n+     * @param gatewayConnectionConfig GATEWAY connection configuration\n+     * @return current CosmosClientBuilder\n+     */\n+    public CosmosClientBuilder connectionModeGateway(GatewayConnectionConfig gatewayConnectionConfig) {\n+        this.gatewayConnectionConfig = gatewayConnectionConfig;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the DIRECT connection configuration to be used.\n+     *\n+     * @param directConnectionConfig DIRECT connection configuration\n+     * @return current CosmosClientBuilder\n+     */\n+    public CosmosClientBuilder connectionModeDirect(DirectConnectionConfig directConnectionConfig) {\n+        this.directConnectionConfig = directConnectionConfig;\n+        return this;\n+    }\n+\n+    /**\n+     * Gets the GATEWAY connection configuration to be used.\n+     *\n+     * @return gateway connection config\n+     */\n+    public GatewayConnectionConfig getGatewayConnectionConfig() {\n+        return gatewayConnectionConfig;\n+    }", "originalCommit": "68014968ee33e6482fc57aa5e93bec50eea94542", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjMyNzE3OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422327178", "bodyText": "Good catch @moderakh  - will get rid of them.", "author": "kushagraThapar", "createdAt": "2020-05-08T19:22:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjMyMzI1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjMyMzMwOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422323309", "bodyText": "ditto", "author": "moderakh", "createdAt": "2020-05-08T19:14:42Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosClientBuilder.java", "diffHunk": "@@ -327,6 +317,46 @@ public CosmosClientBuilder contentResponseOnWriteEnabled(boolean contentResponse\n         return this;\n     }\n \n+    /**\n+     * Sets the GATEWAY connection configuration to be used.\n+     *\n+     * @param gatewayConnectionConfig GATEWAY connection configuration\n+     * @return current CosmosClientBuilder\n+     */\n+    public CosmosClientBuilder connectionModeGateway(GatewayConnectionConfig gatewayConnectionConfig) {\n+        this.gatewayConnectionConfig = gatewayConnectionConfig;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the DIRECT connection configuration to be used.\n+     *\n+     * @param directConnectionConfig DIRECT connection configuration\n+     * @return current CosmosClientBuilder\n+     */\n+    public CosmosClientBuilder connectionModeDirect(DirectConnectionConfig directConnectionConfig) {\n+        this.directConnectionConfig = directConnectionConfig;\n+        return this;\n+    }\n+\n+    /**\n+     * Gets the GATEWAY connection configuration to be used.\n+     *\n+     * @return gateway connection config\n+     */\n+    public GatewayConnectionConfig getGatewayConnectionConfig() {\n+        return gatewayConnectionConfig;\n+    }\n+\n+    /**\n+     * Gets the DIRECT connection configuration to be used.\n+     *\n+     * @return direct connection config\n+     */\n+    public DirectConnectionConfig getDirectConnectionConfig() {\n+        return directConnectionConfig;\n+    }", "originalCommit": "68014968ee33e6482fc57aa5e93bec50eea94542", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjMyNzIyNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422327225", "bodyText": "Good catch @moderakh - will get rid of them.", "author": "kushagraThapar", "createdAt": "2020-05-08T19:22:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjMyMzMwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjMyNDAxOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422324019", "bodyText": "why do we need to overwrite these ones? this is common for both gw and direct.", "author": "moderakh", "createdAt": "2020-05-08T19:16:17Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/DirectConnectionConfig.java", "diffHunk": "@@ -0,0 +1,269 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos;\n+\n+import java.time.Duration;\n+import java.util.List;\n+\n+/**\n+ * Represents the connection config with {@link ConnectionMode#DIRECT} associated with Cosmos Client in the Azure Cosmos DB database service.\n+ */\n+public final class DirectConnectionConfig extends ConnectionConfig {\n+    //  Constants\n+    private static final Duration DEFAULT_IDLE_CHANNEL_TIMEOUT = Duration.ZERO;\n+    private static final Duration DEFAULT_IDLE_ENDPOINT_TIMEOUT = Duration.ofSeconds(70L);\n+    private static final int DEFAULT_MAX_CHANNELS_PER_ENDPOINT = 30;\n+    private static final int DEFAULT_MAX_REQUESTS_PER_ENDPOINT = 10;\n+\n+    private static final DirectConnectionConfig defaultConfig = new DirectConnectionConfig();\n+\n+    private Duration connectionTimeout;\n+    private Duration idleChannelTimeout;\n+    private Duration idleEndpointTimeout;\n+    private int maxChannelsPerEndpoint;\n+    private int maxRequestsPerChannel;\n+\n+    /**\n+     * Constructor.\n+     */\n+    public DirectConnectionConfig() {\n+        super(ConnectionMode.DIRECT);\n+        this.connectionTimeout = null;\n+        this.idleChannelTimeout = DEFAULT_IDLE_CHANNEL_TIMEOUT;\n+        this.idleEndpointTimeout = DEFAULT_IDLE_ENDPOINT_TIMEOUT;\n+        this.maxChannelsPerEndpoint = DEFAULT_MAX_CHANNELS_PER_ENDPOINT;\n+        this.maxRequestsPerChannel = DEFAULT_MAX_REQUESTS_PER_ENDPOINT;\n+    }\n+\n+    /**\n+     * Gets the default DIRECT connection configuration.\n+     *\n+     * @return the default direct connection configuration.\n+     */\n+    public static DirectConnectionConfig getDefaultConfig() {\n+        return DirectConnectionConfig.defaultConfig;\n+    }\n+\n+    //  TODO: (DANOBLE) - To update these docs.\n+\n+    /**\n+     * Gets the direct connection timeout\n+     * @return direct connection timeout\n+     */\n+    public Duration getConnectionTimeout() {\n+        return connectionTimeout;\n+    }\n+\n+    /**\n+     *  Sets the direct connection timeout\n+     * @param connectionTimeout the connection timeout\n+     * @return the {@link DirectConnectionConfig}\n+     */\n+    public DirectConnectionConfig setConnectionTimeout(Duration connectionTimeout) {\n+        this.connectionTimeout = connectionTimeout;\n+        return this;\n+    }\n+\n+    /**\n+     * Gets the idle channel timeout\n+     * @return idle channel timeout\n+     */\n+    public Duration getIdleChannelTimeout() {\n+        return idleChannelTimeout;\n+    }\n+\n+    /**\n+     * Sets the idle channel timeout\n+     * @param idleChannelTimeout idle channel timeout\n+     * @return the {@link DirectConnectionConfig}\n+     */\n+    public DirectConnectionConfig setIdleChannelTimeout(Duration idleChannelTimeout) {\n+        this.idleChannelTimeout = idleChannelTimeout;\n+        return this;\n+    }\n+\n+    /**\n+     * Gets the idle endpoint timeout\n+     * @return the idle endpoint timeout\n+     */\n+    public Duration getIdleEndpointTimeout() {\n+        return idleEndpointTimeout;\n+    }\n+\n+    /**\n+     * Sets the idle endpoint timeout\n+     * @param idleEndpointTimeout the idle endpoint timeout\n+     * @return the {@link DirectConnectionConfig}\n+     */\n+    public DirectConnectionConfig setIdleEndpointTimeout(Duration idleEndpointTimeout) {\n+        this.idleEndpointTimeout = idleEndpointTimeout;\n+        return this;\n+    }\n+\n+    /**\n+     * Gets the max channels per endpoint\n+     * @return the max channels per endpoint\n+     */\n+    public int getMaxChannelsPerEndpoint() {\n+        return maxChannelsPerEndpoint;\n+    }\n+\n+    /**\n+     * Sets the max channels per endpoint\n+     * @param maxChannelsPerEndpoint the max channels per endpoint\n+     * @return the {@link DirectConnectionConfig}\n+     */\n+    public DirectConnectionConfig setMaxChannelsPerEndpoint(int maxChannelsPerEndpoint) {\n+        this.maxChannelsPerEndpoint = maxChannelsPerEndpoint;\n+        return this;\n+    }\n+\n+    /**\n+     * Gets the max requests per endpoint\n+     * @return the max requests per endpoint\n+     */\n+    public int getMaxRequestsPerChannel() {\n+        return maxRequestsPerChannel;\n+    }\n+\n+    /**\n+     * Sets the max requests per endpoint\n+     * @param maxRequestsPerChannel the max requests per endpoint\n+     * @return the {@link DirectConnectionConfig}\n+     */\n+    public DirectConnectionConfig setMaxRequestsPerChannel(int maxRequestsPerChannel) {\n+        this.maxRequestsPerChannel = maxRequestsPerChannel;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the retry policy options associated with the DocumentClient instance.\n+     * <p>\n+     * Properties in the RetryOptions class allow application to customize the built-in\n+     * retry policies. This property is optional. When it's not set, the SDK uses the\n+     * default values for configuring the retry policies.  See RetryOptions class for\n+     * more details.\n+     *\n+     * @param throttlingRetryOptions the RetryOptions instance.\n+     * @return the {@link DirectConnectionConfig}.\n+     * @throws IllegalArgumentException thrown if an error occurs\n+     */\n+    @Override\n+    public DirectConnectionConfig setThrottlingRetryOptions(ThrottlingRetryOptions throttlingRetryOptions) {\n+        super.setThrottlingRetryOptions(throttlingRetryOptions);", "originalCommit": "68014968ee33e6482fc57aa5e93bec50eea94542", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjMyNzg1NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422327855", "bodyText": "Yes, they are common, and they both call their parent's class APIs..\nThe reason for overriding these ones is because of the return type.\nSince our APIs are fluent type, if you directly use parent's API (which returns ConnectionConfig), end users will not be able to use any APIs of DirectConnectionConfig or GatewayConnectionConfig types..", "author": "kushagraThapar", "createdAt": "2020-05-08T19:23:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjMyNDAxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjMyNDQwNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422324404", "bodyText": "why do we need to override the common apis for both gw and direct?", "author": "moderakh", "createdAt": "2020-05-08T19:17:04Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/GatewayConnectionConfig.java", "diffHunk": "@@ -0,0 +1,259 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos;\n+\n+import java.net.InetSocketAddress;\n+import java.time.Duration;\n+import java.util.List;\n+\n+import static com.azure.cosmos.implementation.ConnectionPolicy.DEFAULT_IDLE_CONNECTION_TIMEOUT;\n+import static com.azure.cosmos.implementation.ConnectionPolicy.DEFAULT_MAX_POOL_SIZE;\n+import static com.azure.cosmos.implementation.ConnectionPolicy.DEFAULT_REQUEST_TIMEOUT;\n+\n+/**\n+ * Represents the connection config with {@link ConnectionMode#GATEWAY} associated with Cosmos Client in the Azure Cosmos DB database service.\n+ */\n+public final class GatewayConnectionConfig extends ConnectionConfig {\n+\n+    private static final GatewayConnectionConfig defaultConfig = new GatewayConnectionConfig();\n+\n+    private Duration requestTimeout;\n+    private int maxPoolSize;\n+    private Duration idleConnectionTimeout;\n+    private InetSocketAddress inetSocketProxyAddress;\n+\n+    /**\n+     * Constructor.\n+     */\n+    public GatewayConnectionConfig() {\n+        super(ConnectionMode.GATEWAY);\n+        this.idleConnectionTimeout = DEFAULT_IDLE_CONNECTION_TIMEOUT;\n+        this.maxPoolSize = DEFAULT_MAX_POOL_SIZE;\n+        this.requestTimeout = DEFAULT_REQUEST_TIMEOUT;\n+    }\n+\n+    /**\n+     * Gets the default Gateway connection configuration.\n+     *\n+     * @return the default gateway connection configuration.\n+     */\n+    public static GatewayConnectionConfig getDefaultConfig() {\n+        return GatewayConnectionConfig.defaultConfig;\n+    }\n+\n+    /**\n+     * Gets the request timeout (time to wait for response from network peer).\n+     *\n+     * @return the request timeout duration.\n+     */\n+    public Duration getRequestTimeout() {\n+        return this.requestTimeout;\n+    }\n+\n+    /**\n+     * Sets the request timeout (time to wait for response from network peer).\n+     * The default is 60 seconds.\n+     *\n+     * @param requestTimeout the request timeout duration.\n+     * @return the {@link GatewayConnectionConfig}.\n+     */\n+    public GatewayConnectionConfig setRequestTimeout(Duration requestTimeout) {\n+        this.requestTimeout = requestTimeout;\n+        return this;\n+    }\n+\n+    /**\n+     * Gets the value of the connection pool size the client is using.\n+     *\n+     * @return connection pool size.\n+     */\n+    public int getMaxPoolSize() {\n+        return this.maxPoolSize;\n+    }\n+\n+    /**\n+     * Sets the value of the connection pool size, the default\n+     * is 1000.\n+     *\n+     * @param maxPoolSize The value of the connection pool size.\n+     * @return the {@link GatewayConnectionConfig}.\n+     */\n+    public GatewayConnectionConfig setMaxPoolSize(int maxPoolSize) {\n+        this.maxPoolSize = maxPoolSize;\n+        return this;\n+    }\n+\n+    /**\n+     * Gets the value of the timeout for an idle connection, the default is 60\n+     * seconds.\n+     *\n+     * @return Idle connection timeout duration.\n+     */\n+    public Duration getIdleConnectionTimeout() {\n+        return this.idleConnectionTimeout;\n+    }\n+\n+    /**\n+     * sets the value of the timeout for an idle connection. After that time,\n+     * the connection will be automatically closed.\n+     *\n+     * @param idleConnectionTimeout the duration for an idle connection.\n+     * @return the {@link GatewayConnectionConfig}.\n+     */\n+    public GatewayConnectionConfig setIdleConnectionTimeout(Duration idleConnectionTimeout) {\n+        this.idleConnectionTimeout = idleConnectionTimeout;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the retry policy options associated with the DocumentClient instance.\n+     * <p>\n+     * Properties in the RetryOptions class allow application to customize the built-in\n+     * retry policies. This property is optional. When it's not set, the SDK uses the\n+     * default values for configuring the retry policies.  See RetryOptions class for\n+     * more details.\n+     *\n+     * @param throttlingRetryOptions the RetryOptions instance.\n+     * @return the {@link GatewayConnectionConfig}.\n+     * @throws IllegalArgumentException thrown if an error occurs\n+     */\n+    @Override\n+    public GatewayConnectionConfig setThrottlingRetryOptions(ThrottlingRetryOptions throttlingRetryOptions) {\n+        super.setThrottlingRetryOptions(throttlingRetryOptions);", "originalCommit": "68014968ee33e6482fc57aa5e93bec50eea94542", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjMyNzkwMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422327903", "bodyText": "Yes, they are common, and they both call their parent's class APIs..\nThe reason for overriding these ones is because of the return type.\nSince our APIs are fluent type, if you directly use parent's API (which returns ConnectionConfig), end users will not be able to use any APIs of DirectConnectionConfig or GatewayConnectionConfig types..", "author": "kushagraThapar", "createdAt": "2020-05-08T19:24:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjMyNDQwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQxOTQ0OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422419448", "bodyText": "This section is no longer valid.", "author": "kushagraThapar", "createdAt": "2020-05-08T23:34:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjMyNDQwNA=="}], "type": "inlineReview"}, {"oid": "1976262d0843c83b37ab3be96c0996520ee8606a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1976262d0843c83b37ab3be96c0996520ee8606a", "message": "Removed public getters of connection config APIs from CosmosClientBuilder", "committedDate": "2020-05-08T19:25:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjM1ODc3Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422358772", "bodyText": "One option is to inline these into the builder.", "author": "kirankumarkolli", "createdAt": "2020-05-08T20:31:26Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/ConnectionConfig.java", "diffHunk": "@@ -0,0 +1,223 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos;\n+\n+import java.util.Collections;\n+import java.util.List;\n+\n+/**\n+ * Represents the common connection configuration associated with a Cosmos Client in the Azure Cosmos DB database service.\n+ */\n+public abstract class ConnectionConfig {\n+\n+    protected final ConnectionMode connectionMode;\n+\n+    protected String userAgentSuffix;\n+    protected  ThrottlingRetryOptions throttlingRetryOptions;\n+    protected List<String> preferredRegions;\n+    protected boolean endpointDiscoveryEnabled = true;\n+    protected boolean usingMultipleWriteRegions = true;\n+    protected Boolean readRequestsFallbackEnabled;\n+\n+    /**\n+     * Constructor\n+     * @param connectionMode connection mode\n+     */\n+    protected ConnectionConfig(ConnectionMode connectionMode) {\n+        this.connectionMode = connectionMode;\n+        this.throttlingRetryOptions = new ThrottlingRetryOptions();\n+        this.readRequestsFallbackEnabled = null;\n+        this.userAgentSuffix = \"\";\n+    }\n+\n+    /**\n+     * Gets the connection mode used in the client.\n+     *\n+     * @return the connection mode.\n+     */\n+    public ConnectionMode getConnectionMode() {", "originalCommit": "1976262d0843c83b37ab3be96c0996520ee8606a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQxOTQ2Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422419463", "bodyText": "Done.", "author": "kushagraThapar", "createdAt": "2020-05-08T23:34:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjM1ODc3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjM2MDMxMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422360313", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public boolean isUsingMultipleWriteRegions() {\n          \n          \n            \n                public boolean isMultipleWriteRegionsEnabled() {", "author": "kirankumarkolli", "createdAt": "2020-05-08T20:34:58Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/ConnectionConfig.java", "diffHunk": "@@ -0,0 +1,223 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos;\n+\n+import java.util.Collections;\n+import java.util.List;\n+\n+/**\n+ * Represents the common connection configuration associated with a Cosmos Client in the Azure Cosmos DB database service.\n+ */\n+public abstract class ConnectionConfig {\n+\n+    protected final ConnectionMode connectionMode;\n+\n+    protected String userAgentSuffix;\n+    protected  ThrottlingRetryOptions throttlingRetryOptions;\n+    protected List<String> preferredRegions;\n+    protected boolean endpointDiscoveryEnabled = true;\n+    protected boolean usingMultipleWriteRegions = true;\n+    protected Boolean readRequestsFallbackEnabled;\n+\n+    /**\n+     * Constructor\n+     * @param connectionMode connection mode\n+     */\n+    protected ConnectionConfig(ConnectionMode connectionMode) {\n+        this.connectionMode = connectionMode;\n+        this.throttlingRetryOptions = new ThrottlingRetryOptions();\n+        this.readRequestsFallbackEnabled = null;\n+        this.userAgentSuffix = \"\";\n+    }\n+\n+    /**\n+     * Gets the connection mode used in the client.\n+     *\n+     * @return the connection mode.\n+     */\n+    public ConnectionMode getConnectionMode() {\n+        return this.connectionMode;\n+    }\n+\n+    /**\n+     * Gets the value of user-agent suffix.\n+     *\n+     * @return the value of user-agent suffix.\n+     */\n+    public String getUserAgentSuffix() {\n+        return this.userAgentSuffix;\n+    }\n+\n+    /**\n+     * Gets the retry policy options associated with the DocumentClient instance.\n+     *\n+     * @return the RetryOptions instance.\n+     */\n+    public ThrottlingRetryOptions getThrottlingRetryOptions() {\n+        return this.throttlingRetryOptions;\n+    }\n+\n+    /**\n+     * Gets the flag to enable endpoint discovery for geo-replicated database accounts.\n+     *\n+     * @return whether endpoint discovery is enabled.\n+     */\n+    public boolean isEndpointDiscoveryEnabled() {\n+        return this.endpointDiscoveryEnabled;\n+    }\n+\n+    /**\n+     * Gets the flag to enable writes on any regions for geo-replicated database accounts in the Azure\n+     * Cosmos DB service.\n+     * <p>\n+     * When the value of this property is true, the SDK will direct write operations to\n+     * available writable regions of geo-replicated database account. Writable regions\n+     * are ordered by PreferredRegions property. Setting the property value\n+     * to true has no effect until EnableMultipleWriteRegions in DatabaseAccount\n+     * is also set to true.\n+     * <p>\n+     * DEFAULT value is true indicating that writes are directed to\n+     * available writable regions of geo-replicated database account.\n+     *\n+     * @return flag to enable writes on any regions for geo-replicated database accounts.\n+     */\n+    public boolean isUsingMultipleWriteRegions() {", "originalCommit": "1976262d0843c83b37ab3be96c0996520ee8606a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQxOTQ3Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422419473", "bodyText": "Done.", "author": "kushagraThapar", "createdAt": "2020-05-08T23:34:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjM2MDMxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjM2MTU4Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422361587", "bodyText": "directMode & gatewayMode", "author": "kirankumarkolli", "createdAt": "2020-05-08T20:37:48Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosClientBuilder.java", "diffHunk": "@@ -77,20 +80,18 @@ boolean isSessionCapturingOverrideEnabled() {\n      *\n      * <pre>\n      * {@code\n-     * ConnectionPolicy connectionPolicy = new ConnectionPolicy();\n-     * getConnectionPolicy.getConnectionMode(ConnectionMode.DIRECT);\n      * CosmosAsyncClient client1 = new CosmosClientBuilder()\n      *         .endpoint(serviceEndpoint1)\n      *         .key(key1)\n-     *         .connectionPolicy(connectionPolicy)\n+     *         .connectionModeDirect(DirectConnectionConfig.getDefaultConfig())", "originalCommit": "1976262d0843c83b37ab3be96c0996520ee8606a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQxOTQ5NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422419494", "bodyText": "Done.", "author": "kushagraThapar", "createdAt": "2020-05-08T23:34:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjM2MTU4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjM2MjYzMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422362632", "bodyText": "connection vs channel vs Endpoint", "author": "kirankumarkolli", "createdAt": "2020-05-08T20:40:05Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/DirectConnectionConfig.java", "diffHunk": "@@ -0,0 +1,269 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos;\n+\n+import java.time.Duration;\n+import java.util.List;\n+\n+/**\n+ * Represents the connection config with {@link ConnectionMode#DIRECT} associated with Cosmos Client in the Azure Cosmos DB database service.\n+ */\n+public final class DirectConnectionConfig extends ConnectionConfig {\n+    //  Constants\n+    private static final Duration DEFAULT_IDLE_CHANNEL_TIMEOUT = Duration.ZERO;\n+    private static final Duration DEFAULT_IDLE_ENDPOINT_TIMEOUT = Duration.ofSeconds(70L);\n+    private static final int DEFAULT_MAX_CHANNELS_PER_ENDPOINT = 30;\n+    private static final int DEFAULT_MAX_REQUESTS_PER_ENDPOINT = 10;\n+\n+    private static final DirectConnectionConfig defaultConfig = new DirectConnectionConfig();\n+\n+    private Duration connectionTimeout;\n+    private Duration idleChannelTimeout;\n+    private Duration idleEndpointTimeout;\n+    private int maxChannelsPerEndpoint;\n+    private int maxRequestsPerChannel;\n+\n+    /**\n+     * Constructor.\n+     */\n+    public DirectConnectionConfig() {\n+        super(ConnectionMode.DIRECT);\n+        this.connectionTimeout = null;\n+        this.idleChannelTimeout = DEFAULT_IDLE_CHANNEL_TIMEOUT;\n+        this.idleEndpointTimeout = DEFAULT_IDLE_ENDPOINT_TIMEOUT;\n+        this.maxChannelsPerEndpoint = DEFAULT_MAX_CHANNELS_PER_ENDPOINT;\n+        this.maxRequestsPerChannel = DEFAULT_MAX_REQUESTS_PER_ENDPOINT;\n+    }\n+\n+    /**\n+     * Gets the default DIRECT connection configuration.\n+     *\n+     * @return the default direct connection configuration.\n+     */\n+    public static DirectConnectionConfig getDefaultConfig() {\n+        return DirectConnectionConfig.defaultConfig;\n+    }\n+\n+    //  TODO: (DANOBLE) - To update these docs.\n+\n+    /**\n+     * Gets the direct connection timeout\n+     * @return direct connection timeout\n+     */\n+    public Duration getConnectionTimeout() {\n+        return connectionTimeout;\n+    }\n+\n+    /**\n+     *  Sets the direct connection timeout\n+     * @param connectionTimeout the connection timeout\n+     * @return the {@link DirectConnectionConfig}\n+     */\n+    public DirectConnectionConfig setConnectionTimeout(Duration connectionTimeout) {\n+        this.connectionTimeout = connectionTimeout;\n+        return this;\n+    }\n+\n+    /**\n+     * Gets the idle channel timeout\n+     * @return idle channel timeout\n+     */\n+    public Duration getIdleChannelTimeout() {", "originalCommit": "1976262d0843c83b37ab3be96c0996520ee8606a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQyMDI4Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422420283", "bodyText": "#10983", "author": "kushagraThapar", "createdAt": "2020-05-08T23:38:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjM2MjYzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjM2MzcxMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422363713", "bodyText": "Will ZERO default to FX one. If so we might not have control on it. Why not be explicit?", "author": "kirankumarkolli", "createdAt": "2020-05-08T20:42:27Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/DirectConnectionConfig.java", "diffHunk": "@@ -0,0 +1,269 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos;\n+\n+import java.time.Duration;\n+import java.util.List;\n+\n+/**\n+ * Represents the connection config with {@link ConnectionMode#DIRECT} associated with Cosmos Client in the Azure Cosmos DB database service.\n+ */\n+public final class DirectConnectionConfig extends ConnectionConfig {\n+    //  Constants\n+    private static final Duration DEFAULT_IDLE_CHANNEL_TIMEOUT = Duration.ZERO;", "originalCommit": "1976262d0843c83b37ab3be96c0996520ee8606a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQyMDMxNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422420316", "bodyText": "#10983", "author": "kushagraThapar", "createdAt": "2020-05-08T23:38:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjM2MzcxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjM2NTYzNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422365637", "bodyText": "Enable suffix", "author": "kirankumarkolli", "createdAt": "2020-05-08T20:46:38Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/DirectConnectionConfig.java", "diffHunk": "@@ -0,0 +1,269 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos;\n+\n+import java.time.Duration;\n+import java.util.List;\n+\n+/**\n+ * Represents the connection config with {@link ConnectionMode#DIRECT} associated with Cosmos Client in the Azure Cosmos DB database service.\n+ */\n+public final class DirectConnectionConfig extends ConnectionConfig {\n+    //  Constants\n+    private static final Duration DEFAULT_IDLE_CHANNEL_TIMEOUT = Duration.ZERO;\n+    private static final Duration DEFAULT_IDLE_ENDPOINT_TIMEOUT = Duration.ofSeconds(70L);\n+    private static final int DEFAULT_MAX_CHANNELS_PER_ENDPOINT = 30;\n+    private static final int DEFAULT_MAX_REQUESTS_PER_ENDPOINT = 10;\n+\n+    private static final DirectConnectionConfig defaultConfig = new DirectConnectionConfig();\n+\n+    private Duration connectionTimeout;\n+    private Duration idleChannelTimeout;\n+    private Duration idleEndpointTimeout;\n+    private int maxChannelsPerEndpoint;\n+    private int maxRequestsPerChannel;\n+\n+    /**\n+     * Constructor.\n+     */\n+    public DirectConnectionConfig() {\n+        super(ConnectionMode.DIRECT);\n+        this.connectionTimeout = null;\n+        this.idleChannelTimeout = DEFAULT_IDLE_CHANNEL_TIMEOUT;\n+        this.idleEndpointTimeout = DEFAULT_IDLE_ENDPOINT_TIMEOUT;\n+        this.maxChannelsPerEndpoint = DEFAULT_MAX_CHANNELS_PER_ENDPOINT;\n+        this.maxRequestsPerChannel = DEFAULT_MAX_REQUESTS_PER_ENDPOINT;\n+    }\n+\n+    /**\n+     * Gets the default DIRECT connection configuration.\n+     *\n+     * @return the default direct connection configuration.\n+     */\n+    public static DirectConnectionConfig getDefaultConfig() {\n+        return DirectConnectionConfig.defaultConfig;\n+    }\n+\n+    //  TODO: (DANOBLE) - To update these docs.\n+\n+    /**\n+     * Gets the direct connection timeout\n+     * @return direct connection timeout\n+     */\n+    public Duration getConnectionTimeout() {\n+        return connectionTimeout;\n+    }\n+\n+    /**\n+     *  Sets the direct connection timeout\n+     * @param connectionTimeout the connection timeout\n+     * @return the {@link DirectConnectionConfig}\n+     */\n+    public DirectConnectionConfig setConnectionTimeout(Duration connectionTimeout) {\n+        this.connectionTimeout = connectionTimeout;\n+        return this;\n+    }\n+\n+    /**\n+     * Gets the idle channel timeout\n+     * @return idle channel timeout\n+     */\n+    public Duration getIdleChannelTimeout() {\n+        return idleChannelTimeout;\n+    }\n+\n+    /**\n+     * Sets the idle channel timeout\n+     * @param idleChannelTimeout idle channel timeout\n+     * @return the {@link DirectConnectionConfig}\n+     */\n+    public DirectConnectionConfig setIdleChannelTimeout(Duration idleChannelTimeout) {\n+        this.idleChannelTimeout = idleChannelTimeout;\n+        return this;\n+    }\n+\n+    /**\n+     * Gets the idle endpoint timeout\n+     * @return the idle endpoint timeout\n+     */\n+    public Duration getIdleEndpointTimeout() {\n+        return idleEndpointTimeout;\n+    }\n+\n+    /**\n+     * Sets the idle endpoint timeout\n+     * @param idleEndpointTimeout the idle endpoint timeout\n+     * @return the {@link DirectConnectionConfig}\n+     */\n+    public DirectConnectionConfig setIdleEndpointTimeout(Duration idleEndpointTimeout) {\n+        this.idleEndpointTimeout = idleEndpointTimeout;\n+        return this;\n+    }\n+\n+    /**\n+     * Gets the max channels per endpoint\n+     * @return the max channels per endpoint\n+     */\n+    public int getMaxChannelsPerEndpoint() {\n+        return maxChannelsPerEndpoint;\n+    }\n+\n+    /**\n+     * Sets the max channels per endpoint\n+     * @param maxChannelsPerEndpoint the max channels per endpoint\n+     * @return the {@link DirectConnectionConfig}\n+     */\n+    public DirectConnectionConfig setMaxChannelsPerEndpoint(int maxChannelsPerEndpoint) {\n+        this.maxChannelsPerEndpoint = maxChannelsPerEndpoint;\n+        return this;\n+    }\n+\n+    /**\n+     * Gets the max requests per endpoint\n+     * @return the max requests per endpoint\n+     */\n+    public int getMaxRequestsPerChannel() {\n+        return maxRequestsPerChannel;\n+    }\n+\n+    /**\n+     * Sets the max requests per endpoint\n+     * @param maxRequestsPerChannel the max requests per endpoint\n+     * @return the {@link DirectConnectionConfig}\n+     */\n+    public DirectConnectionConfig setMaxRequestsPerChannel(int maxRequestsPerChannel) {\n+        this.maxRequestsPerChannel = maxRequestsPerChannel;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the retry policy options associated with the DocumentClient instance.\n+     * <p>\n+     * Properties in the RetryOptions class allow application to customize the built-in\n+     * retry policies. This property is optional. When it's not set, the SDK uses the\n+     * default values for configuring the retry policies.  See RetryOptions class for\n+     * more details.\n+     *\n+     * @param throttlingRetryOptions the RetryOptions instance.\n+     * @return the {@link DirectConnectionConfig}.\n+     * @throws IllegalArgumentException thrown if an error occurs\n+     */\n+    @Override\n+    public DirectConnectionConfig setThrottlingRetryOptions(ThrottlingRetryOptions throttlingRetryOptions) {\n+        super.setThrottlingRetryOptions(throttlingRetryOptions);\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the flag to enable endpoint discovery for geo-replicated database accounts.\n+     * <p>\n+     * When EnableEndpointDiscovery is true, the SDK will automatically discover the\n+     * current write and read regions to ensure requests are sent to the correct region\n+     * based on the capability of the region and the user's preference.\n+     * <p>\n+     * The default value for this property is true indicating endpoint discovery is enabled.\n+     *\n+     * @param endpointDiscoveryEnabled true if EndpointDiscovery is enabled.\n+     * @return the {@link DirectConnectionConfig}.\n+     */\n+    @Override\n+    public DirectConnectionConfig setEndpointDiscoveryEnabled(boolean endpointDiscoveryEnabled) {\n+        super.setEndpointDiscoveryEnabled(endpointDiscoveryEnabled);\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the flag to enable writes on any regions for geo-replicated database accounts in the Azure\n+     * Cosmos DB service.\n+     * <p>\n+     * When the value of this property is true, the SDK will direct write operations to\n+     * available writable regions of geo-replicated database account. Writable regions\n+     * are ordered by PreferredRegions property. Setting the property value\n+     * to true has no effect until EnableMultipleWriteRegions in DatabaseAccount\n+     * is also set to true.\n+     * <p>\n+     * DEFAULT value is false indicating that writes are only directed to\n+     * first region in PreferredRegions property.\n+     *\n+     * @param usingMultipleWriteRegions flag to enable writes on any regions for geo-replicated\n+     * database accounts.\n+     * @return the {@link DirectConnectionConfig}.\n+     */\n+    @Override\n+    public DirectConnectionConfig setUsingMultipleWriteRegions(boolean usingMultipleWriteRegions) {", "originalCommit": "1976262d0843c83b37ab3be96c0996520ee8606a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQyMDA2NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422420065", "bodyText": "Done.", "author": "kushagraThapar", "createdAt": "2020-05-08T23:37:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjM2NTYzNw=="}], "type": "inlineReview"}, {"oid": "7b77d044d414bab65317e3fe600f30625acb942c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7b77d044d414bab65317e3fe600f30625acb942c", "message": "Implemented Code review comments", "committedDate": "2020-05-08T23:33:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQzMDQ4OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422430488", "bodyText": "Do these tests are always expected to run in Direct mode?", "author": "milismsft", "createdAt": "2020-05-09T00:31:43Z", "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/rx/UniqueIndexTest.java", "diffHunk": "@@ -222,7 +222,7 @@ public void before_UniqueIndexTest() {\n         client = new CosmosClientBuilder()\n             .endpoint(TestConfigurations.HOST)\n             .key(TestConfigurations.MASTER_KEY)\n-            .connectionPolicy(ConnectionPolicy.getDefaultPolicy())\n+            .directMode(DirectConnectionConfig.getDefaultConfig())", "originalCommit": "7b77d044d414bab65317e3fe600f30625acb942c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQzMjA0NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422432044", "bodyText": "Yes, I have not changed the connection mode of the tests - they will run as it is as they were running earlier.\nSince earlier also, default was DIRECT mode.", "author": "kushagraThapar", "createdAt": "2020-05-09T00:40:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQzMDQ4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQzNDA3MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422434071", "bodyText": "you're consuming implementation package here and the class is public facing...", "author": "milismsft", "createdAt": "2020-05-09T00:55:49Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/GatewayConnectionConfig.java", "diffHunk": "@@ -0,0 +1,138 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos;\n+\n+import java.net.InetSocketAddress;\n+import java.time.Duration;\n+\n+import static com.azure.cosmos.implementation.ConnectionPolicy.DEFAULT_IDLE_CONNECTION_TIMEOUT;", "originalCommit": "7b77d044d414bab65317e3fe600f30625acb942c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQzNTU3NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422435574", "bodyText": "just to be clear, this can be done after GA :-)", "author": "milismsft", "createdAt": "2020-05-09T01:09:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQzNDA3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjUxMjc5Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422512793", "bodyText": "why is this a problem?", "author": "moderakh", "createdAt": "2020-05-09T15:58:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQzNDA3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjUzNjc0Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422536742", "bodyText": "@milismsft 's point is - Since we are using default values from implementation details - changing these default values in implementation will have a direct impact on customer's app, which can be considered breaking change in some way.\nI think its a valid point, I will think what can be done for this.", "author": "kushagraThapar", "createdAt": "2020-05-09T19:33:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQzNDA3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQyMzI4Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r423423283", "bodyText": "The RntbdTransportClient will treat the DirectConnectionConfig as definitive. Regardless of where we put the default values, changes to them will affect behavior, and changes to behavior must be rationalized and documented. This sounds like a good reason to move the public-facing defaults to the ConnectionConfig classes. It will make it easier for us to understand the impact of a change. The transport clients could then pull defaults from their respective public config classes; not the other way around.", "author": "David-Noble-at-work", "createdAt": "2020-05-12T02:16:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQzNDA3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk3NDM3Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r423974372", "bodyText": "Done.", "author": "kushagraThapar", "createdAt": "2020-05-12T19:18:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQzNDA3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk3NDU0NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r423974545", "bodyText": "Updated constants to GatewayConnectionConfig.java", "author": "kushagraThapar", "createdAt": "2020-05-12T19:18:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQzNDA3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQzNTk4Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422435987", "bodyText": "endpointDiscoveryEnabled", "author": "milismsft", "createdAt": "2020-05-09T01:13:22Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosClientBuilder.java", "diffHunk": "@@ -327,6 +327,223 @@ public CosmosClientBuilder contentResponseOnWriteEnabled(boolean contentResponse\n         return this;\n     }\n \n+    /**\n+     * Sets the GATEWAY connection configuration to be used.\n+     *\n+     * @param gatewayConnectionConfig GATEWAY connection configuration\n+     * @return current CosmosClientBuilder\n+     */\n+    public CosmosClientBuilder gatewayMode(GatewayConnectionConfig gatewayConnectionConfig) {\n+        this.gatewayConnectionConfig = gatewayConnectionConfig;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the DIRECT connection configuration to be used.\n+     *\n+     * @param directConnectionConfig DIRECT connection configuration\n+     * @return current CosmosClientBuilder\n+     */\n+    public CosmosClientBuilder directMode(DirectConnectionConfig directConnectionConfig) {\n+        this.directConnectionConfig = directConnectionConfig;\n+        return this;\n+    }\n+\n+    /**\n+     * sets the value of the user-agent suffix.\n+     *\n+     * @param userAgentSuffix The value to be appended to the user-agent header, this is\n+     * used for monitoring purposes.\n+     *\n+     * @return current CosmosClientBuilder\n+     */\n+    public CosmosClientBuilder userAgentSuffix(String userAgentSuffix) {\n+        this.userAgentSuffix = userAgentSuffix;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the retry policy options associated with the DocumentClient instance.\n+     * <p>\n+     * Properties in the RetryOptions class allow application to customize the built-in\n+     * retry policies. This property is optional. When it's not set, the SDK uses the\n+     * default values for configuring the retry policies.  See RetryOptions class for\n+     * more details.\n+     *\n+     * @param throttlingRetryOptions the RetryOptions instance.\n+     * @return current CosmosClientBuilder\n+     * @throws IllegalArgumentException thrown if an error occurs\n+     */\n+    public CosmosClientBuilder throttlingRetryOptions(ThrottlingRetryOptions throttlingRetryOptions) {\n+        this.throttlingRetryOptions = throttlingRetryOptions;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the preferred regions for geo-replicated database accounts. For example,\n+     * \"East US\" as the preferred region.\n+     * <p>\n+     * When EnableEndpointDiscovery is true and PreferredRegions is non-empty,\n+     * the SDK will prefer to use the regions in the collection in the order\n+     * they are specified to perform operations.\n+     * <p>\n+     * If EnableEndpointDiscovery is set to false, this property is ignored.\n+     *\n+     * @param preferredRegions the list of preferred regions.\n+     * @return current CosmosClientBuilder\n+     */\n+    public CosmosClientBuilder preferredRegions(List<String> preferredRegions) {\n+        this.preferredRegions = preferredRegions;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the flag to enable endpoint discovery for geo-replicated database accounts.\n+     * <p>\n+     * When EnableEndpointDiscovery is true, the SDK will automatically discover the\n+     * current write and read regions to ensure requests are sent to the correct region\n+     * based on the capability of the region and the user's preference.\n+     * <p>\n+     * The default value for this property is true indicating endpoint discovery is enabled.\n+     *\n+     * @param endpointDiscoveryEnabled true if EndpointDiscovery is enabled.\n+     * @return current CosmosClientBuilder\n+     */\n+    public CosmosClientBuilder endpointDiscoverEnabled(boolean endpointDiscoveryEnabled) {", "originalCommit": "7b77d044d414bab65317e3fe600f30625acb942c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjUzNjUxOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422536519", "bodyText": "Good catch @milismsft - You saved us V5 \ud83e\udd23", "author": "kushagraThapar", "createdAt": "2020-05-09T19:31:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQzNTk4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ0NTY1MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422445651", "bodyText": "Boolean readRequestsFallbackEnabled any reason we can't go with primitive type? boolean?\ndoes null have a special meaning?\nreadRequestsFallbackEnabled(null)", "author": "moderakh", "createdAt": "2020-05-09T02:59:40Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosClientBuilder.java", "diffHunk": "@@ -327,6 +327,223 @@ public CosmosClientBuilder contentResponseOnWriteEnabled(boolean contentResponse\n         return this;\n     }\n \n+    /**\n+     * Sets the GATEWAY connection configuration to be used.\n+     *\n+     * @param gatewayConnectionConfig GATEWAY connection configuration\n+     * @return current CosmosClientBuilder\n+     */\n+    public CosmosClientBuilder gatewayMode(GatewayConnectionConfig gatewayConnectionConfig) {\n+        this.gatewayConnectionConfig = gatewayConnectionConfig;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the DIRECT connection configuration to be used.\n+     *\n+     * @param directConnectionConfig DIRECT connection configuration\n+     * @return current CosmosClientBuilder\n+     */\n+    public CosmosClientBuilder directMode(DirectConnectionConfig directConnectionConfig) {\n+        this.directConnectionConfig = directConnectionConfig;\n+        return this;\n+    }\n+\n+    /**\n+     * sets the value of the user-agent suffix.\n+     *\n+     * @param userAgentSuffix The value to be appended to the user-agent header, this is\n+     * used for monitoring purposes.\n+     *\n+     * @return current CosmosClientBuilder\n+     */\n+    public CosmosClientBuilder userAgentSuffix(String userAgentSuffix) {\n+        this.userAgentSuffix = userAgentSuffix;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the retry policy options associated with the DocumentClient instance.\n+     * <p>\n+     * Properties in the RetryOptions class allow application to customize the built-in\n+     * retry policies. This property is optional. When it's not set, the SDK uses the\n+     * default values for configuring the retry policies.  See RetryOptions class for\n+     * more details.\n+     *\n+     * @param throttlingRetryOptions the RetryOptions instance.\n+     * @return current CosmosClientBuilder\n+     * @throws IllegalArgumentException thrown if an error occurs\n+     */\n+    public CosmosClientBuilder throttlingRetryOptions(ThrottlingRetryOptions throttlingRetryOptions) {\n+        this.throttlingRetryOptions = throttlingRetryOptions;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the preferred regions for geo-replicated database accounts. For example,\n+     * \"East US\" as the preferred region.\n+     * <p>\n+     * When EnableEndpointDiscovery is true and PreferredRegions is non-empty,\n+     * the SDK will prefer to use the regions in the collection in the order\n+     * they are specified to perform operations.\n+     * <p>\n+     * If EnableEndpointDiscovery is set to false, this property is ignored.\n+     *\n+     * @param preferredRegions the list of preferred regions.\n+     * @return current CosmosClientBuilder\n+     */\n+    public CosmosClientBuilder preferredRegions(List<String> preferredRegions) {\n+        this.preferredRegions = preferredRegions;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the flag to enable endpoint discovery for geo-replicated database accounts.\n+     * <p>\n+     * When EnableEndpointDiscovery is true, the SDK will automatically discover the\n+     * current write and read regions to ensure requests are sent to the correct region\n+     * based on the capability of the region and the user's preference.\n+     * <p>\n+     * The default value for this property is true indicating endpoint discovery is enabled.\n+     *\n+     * @param endpointDiscoveryEnabled true if EndpointDiscovery is enabled.\n+     * @return current CosmosClientBuilder\n+     */\n+    public CosmosClientBuilder endpointDiscoverEnabled(boolean endpointDiscoveryEnabled) {\n+        this.endpointDiscoveryEnabled = endpointDiscoveryEnabled;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the flag to enable writes on any regions for geo-replicated database accounts in the Azure\n+     * Cosmos DB service.\n+     * <p>\n+     * When the value of this property is true, the SDK will direct write operations to\n+     * available writable regions of geo-replicated database account. Writable regions\n+     * are ordered by PreferredRegions property. Setting the property value\n+     * to true has no effect until EnableMultipleWriteRegions in DatabaseAccount\n+     * is also set to true.\n+     * <p>\n+     * DEFAULT value is false indicating that writes are only directed to\n+     * first region in PreferredRegions property.\n+     *\n+     * @param multipleWriteRegionsEnabled flag to enable writes on any regions for geo-replicated\n+     * database accounts.\n+     * @return current CosmosClientBuilder\n+     */\n+    public CosmosClientBuilder multipleWriteRegionsEnabled(boolean multipleWriteRegionsEnabled) {\n+        this.multipleWriteRegionsEnabled = multipleWriteRegionsEnabled;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets whether to allow for reads to go to multiple regions configured on an account of Azure Cosmos DB service.\n+     * <p>\n+     * DEFAULT value is null.\n+     * <p>\n+     * If this property is not set, the default is true for all Consistency Levels other than Bounded Staleness,\n+     * The default is false for Bounded Staleness.\n+     * 1. {@link #endpointDiscoveryEnabled} is true\n+     * 2. the Azure Cosmos DB account has more than one region\n+     *\n+     * @param readRequestsFallbackEnabled flag to enable reads to go to multiple regions configured on an account of\n+     * Azure Cosmos DB service.\n+     * @return current CosmosClientBuilder\n+     */\n+    public CosmosClientBuilder readRequestsFallbackEnabled(Boolean readRequestsFallbackEnabled) {", "originalCommit": "7b77d044d414bab65317e3fe600f30625acb942c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjUzNzA5OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422537098", "bodyText": "I checked, we can convert it to primitive boolean with default value = true, based on this below check that we have in GlobalAddressResolver\nint maxBackupReadEndpoints = (connectionPolicy.isReadRequestsFallbackEnabled() == null || connectionPolicy.isReadRequestsFallbackEnabled()) ? GlobalAddressResolver.MaxBackupReadRegions : 0;", "author": "kushagraThapar", "createdAt": "2020-05-09T19:37:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ0NTY1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ0ODUwNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422448505", "bodyText": "I think this should be Connection instead of Channel. Please verify.", "author": "moderakh", "createdAt": "2020-05-09T03:41:11Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/DirectConnectionConfig.java", "diffHunk": "@@ -0,0 +1,148 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos;\n+\n+import java.time.Duration;\n+\n+/**\n+ * Represents the connection config with {@link ConnectionMode#DIRECT} associated with Cosmos Client in the Azure Cosmos DB database service.\n+ */\n+public final class DirectConnectionConfig {\n+    //  Constants\n+    private static final Duration DEFAULT_IDLE_CHANNEL_TIMEOUT = Duration.ZERO;\n+    private static final Duration DEFAULT_IDLE_ENDPOINT_TIMEOUT = Duration.ofSeconds(70L);\n+    private static final int DEFAULT_MAX_CHANNELS_PER_ENDPOINT = 30;\n+    private static final int DEFAULT_MAX_REQUESTS_PER_ENDPOINT = 10;\n+\n+    private static final DirectConnectionConfig defaultConfig = new DirectConnectionConfig();\n+\n+    private Duration connectionTimeout;\n+    private Duration idleChannelTimeout;\n+    private Duration idleEndpointTimeout;\n+    private int maxChannelsPerEndpoint;\n+    private int maxRequestsPerChannel;\n+\n+    /**\n+     * Constructor.\n+     */\n+    public DirectConnectionConfig() {\n+        this.connectionTimeout = null;\n+        this.idleChannelTimeout = DEFAULT_IDLE_CHANNEL_TIMEOUT;\n+        this.idleEndpointTimeout = DEFAULT_IDLE_ENDPOINT_TIMEOUT;\n+        this.maxChannelsPerEndpoint = DEFAULT_MAX_CHANNELS_PER_ENDPOINT;\n+        this.maxRequestsPerChannel = DEFAULT_MAX_REQUESTS_PER_ENDPOINT;\n+    }\n+\n+    /**\n+     * Gets the default DIRECT connection configuration.\n+     *\n+     * @return the default direct connection configuration.\n+     */\n+    public static DirectConnectionConfig getDefaultConfig() {\n+        return DirectConnectionConfig.defaultConfig;\n+    }\n+\n+    //  TODO: (DANOBLE) - To update these docs.\n+\n+    /**\n+     * Gets the direct connection timeout\n+     * @return direct connection timeout\n+     */\n+    public Duration getConnectionTimeout() {\n+        return connectionTimeout;\n+    }\n+\n+    /**\n+     *  Sets the direct connection timeout\n+     * @param connectionTimeout the connection timeout\n+     * @return the {@link DirectConnectionConfig}\n+     */\n+    public DirectConnectionConfig setConnectionTimeout(Duration connectionTimeout) {\n+        this.connectionTimeout = connectionTimeout;\n+        return this;\n+    }\n+\n+    /**\n+     * Gets the idle channel timeout\n+     * @return idle channel timeout\n+     */\n+    public Duration getIdleChannelTimeout() {\n+        return idleChannelTimeout;\n+    }\n+\n+    /**\n+     * Sets the idle channel timeout\n+     * @param idleChannelTimeout idle channel timeout\n+     * @return the {@link DirectConnectionConfig}\n+     */\n+    public DirectConnectionConfig setIdleChannelTimeout(Duration idleChannelTimeout) {\n+        this.idleChannelTimeout = idleChannelTimeout;\n+        return this;\n+    }\n+\n+    /**\n+     * Gets the idle endpoint timeout\n+     * @return the idle endpoint timeout\n+     */\n+    public Duration getIdleEndpointTimeout() {\n+        return idleEndpointTimeout;\n+    }\n+\n+    /**\n+     * Sets the idle endpoint timeout\n+     * @param idleEndpointTimeout the idle endpoint timeout\n+     * @return the {@link DirectConnectionConfig}\n+     */\n+    public DirectConnectionConfig setIdleEndpointTimeout(Duration idleEndpointTimeout) {\n+        this.idleEndpointTimeout = idleEndpointTimeout;\n+        return this;\n+    }\n+\n+    /**\n+     * Gets the max channels per endpoint\n+     * @return the max channels per endpoint\n+     */\n+    public int getMaxChannelsPerEndpoint() {", "originalCommit": "7b77d044d414bab65317e3fe600f30625acb942c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjUzNzEzOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422537138", "bodyText": "@David-Noble-at-work plans to fix these.", "author": "kushagraThapar", "createdAt": "2020-05-09T19:37:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ0ODUwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ0ODYxNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422448614", "bodyText": "change to getMaxConnectionPoolSize and the setter respectivly", "author": "moderakh", "createdAt": "2020-05-09T03:42:44Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/GatewayConnectionConfig.java", "diffHunk": "@@ -0,0 +1,138 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos;\n+\n+import java.net.InetSocketAddress;\n+import java.time.Duration;\n+\n+import static com.azure.cosmos.implementation.ConnectionPolicy.DEFAULT_IDLE_CONNECTION_TIMEOUT;\n+import static com.azure.cosmos.implementation.ConnectionPolicy.DEFAULT_MAX_POOL_SIZE;\n+import static com.azure.cosmos.implementation.ConnectionPolicy.DEFAULT_REQUEST_TIMEOUT;\n+\n+/**\n+ * Represents the connection config with {@link ConnectionMode#GATEWAY} associated with Cosmos Client in the Azure Cosmos DB database service.\n+ */\n+public final class GatewayConnectionConfig {\n+\n+    private static final GatewayConnectionConfig defaultConfig = new GatewayConnectionConfig();\n+\n+    private Duration requestTimeout;\n+    private int maxPoolSize;\n+    private Duration idleConnectionTimeout;\n+    private InetSocketAddress inetSocketProxyAddress;\n+\n+    /**\n+     * Constructor.\n+     */\n+    public GatewayConnectionConfig() {\n+        this.idleConnectionTimeout = DEFAULT_IDLE_CONNECTION_TIMEOUT;\n+        this.maxPoolSize = DEFAULT_MAX_POOL_SIZE;\n+        this.requestTimeout = DEFAULT_REQUEST_TIMEOUT;\n+    }\n+\n+    /**\n+     * Gets the default Gateway connection configuration.\n+     *\n+     * @return the default gateway connection configuration.\n+     */\n+    public static GatewayConnectionConfig getDefaultConfig() {\n+        return GatewayConnectionConfig.defaultConfig;\n+    }\n+\n+    /**\n+     * Gets the request timeout (time to wait for response from network peer).\n+     *\n+     * @return the request timeout duration.\n+     */\n+    public Duration getRequestTimeout() {\n+        return this.requestTimeout;\n+    }\n+\n+    /**\n+     * Sets the request timeout (time to wait for response from network peer).\n+     * The default is 60 seconds.\n+     *\n+     * @param requestTimeout the request timeout duration.\n+     * @return the {@link GatewayConnectionConfig}.\n+     */\n+    public GatewayConnectionConfig setRequestTimeout(Duration requestTimeout) {\n+        this.requestTimeout = requestTimeout;\n+        return this;\n+    }\n+\n+    /**\n+     * Gets the value of the connection pool size the client is using.\n+     *\n+     * @return connection pool size.\n+     */\n+    public int getMaxPoolSize() {", "originalCommit": "7b77d044d414bab65317e3fe600f30625acb942c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjUzNzQ2Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422537462", "bodyText": "Sounds good, will do.", "author": "kushagraThapar", "createdAt": "2020-05-09T19:40:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ0ODYxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ0ODc3Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422448772", "bodyText": "don't return a singleton object otherwise, changing it once for one client may affect other clients too.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return GatewayConnectionConfig.defaultConfig;\n          \n          \n            \n                    return new GatewayConnectionConfig()", "author": "moderakh", "createdAt": "2020-05-09T03:44:48Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/GatewayConnectionConfig.java", "diffHunk": "@@ -0,0 +1,138 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos;\n+\n+import java.net.InetSocketAddress;\n+import java.time.Duration;\n+\n+import static com.azure.cosmos.implementation.ConnectionPolicy.DEFAULT_IDLE_CONNECTION_TIMEOUT;\n+import static com.azure.cosmos.implementation.ConnectionPolicy.DEFAULT_MAX_POOL_SIZE;\n+import static com.azure.cosmos.implementation.ConnectionPolicy.DEFAULT_REQUEST_TIMEOUT;\n+\n+/**\n+ * Represents the connection config with {@link ConnectionMode#GATEWAY} associated with Cosmos Client in the Azure Cosmos DB database service.\n+ */\n+public final class GatewayConnectionConfig {\n+\n+    private static final GatewayConnectionConfig defaultConfig = new GatewayConnectionConfig();\n+\n+    private Duration requestTimeout;\n+    private int maxPoolSize;\n+    private Duration idleConnectionTimeout;\n+    private InetSocketAddress inetSocketProxyAddress;\n+\n+    /**\n+     * Constructor.\n+     */\n+    public GatewayConnectionConfig() {\n+        this.idleConnectionTimeout = DEFAULT_IDLE_CONNECTION_TIMEOUT;\n+        this.maxPoolSize = DEFAULT_MAX_POOL_SIZE;\n+        this.requestTimeout = DEFAULT_REQUEST_TIMEOUT;\n+    }\n+\n+    /**\n+     * Gets the default Gateway connection configuration.\n+     *\n+     * @return the default gateway connection configuration.\n+     */\n+    public static GatewayConnectionConfig getDefaultConfig() {\n+        return GatewayConnectionConfig.defaultConfig;", "originalCommit": "7b77d044d414bab65317e3fe600f30625acb942c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjUzNzcwOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422537708", "bodyText": "Yes, makes sense.", "author": "kushagraThapar", "createdAt": "2020-05-09T19:42:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ0ODc3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ0ODkyNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422448927", "bodyText": "don't return a static singleton instance otherwise changing the default for one client may affect the other client defaults too.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return DirectConnectionConfig.defaultConfig;\n          \n          \n            \n                    return new DirectConnectoinConfig()", "author": "moderakh", "createdAt": "2020-05-09T03:46:50Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/DirectConnectionConfig.java", "diffHunk": "@@ -0,0 +1,148 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos;\n+\n+import java.time.Duration;\n+\n+/**\n+ * Represents the connection config with {@link ConnectionMode#DIRECT} associated with Cosmos Client in the Azure Cosmos DB database service.\n+ */\n+public final class DirectConnectionConfig {\n+    //  Constants\n+    private static final Duration DEFAULT_IDLE_CHANNEL_TIMEOUT = Duration.ZERO;\n+    private static final Duration DEFAULT_IDLE_ENDPOINT_TIMEOUT = Duration.ofSeconds(70L);\n+    private static final int DEFAULT_MAX_CHANNELS_PER_ENDPOINT = 30;\n+    private static final int DEFAULT_MAX_REQUESTS_PER_ENDPOINT = 10;\n+\n+    private static final DirectConnectionConfig defaultConfig = new DirectConnectionConfig();\n+\n+    private Duration connectionTimeout;\n+    private Duration idleChannelTimeout;\n+    private Duration idleEndpointTimeout;\n+    private int maxChannelsPerEndpoint;\n+    private int maxRequestsPerChannel;\n+\n+    /**\n+     * Constructor.\n+     */\n+    public DirectConnectionConfig() {\n+        this.connectionTimeout = null;\n+        this.idleChannelTimeout = DEFAULT_IDLE_CHANNEL_TIMEOUT;\n+        this.idleEndpointTimeout = DEFAULT_IDLE_ENDPOINT_TIMEOUT;\n+        this.maxChannelsPerEndpoint = DEFAULT_MAX_CHANNELS_PER_ENDPOINT;\n+        this.maxRequestsPerChannel = DEFAULT_MAX_REQUESTS_PER_ENDPOINT;\n+    }\n+\n+    /**\n+     * Gets the default DIRECT connection configuration.\n+     *\n+     * @return the default direct connection configuration.\n+     */\n+    public static DirectConnectionConfig getDefaultConfig() {\n+        return DirectConnectionConfig.defaultConfig;", "originalCommit": "7b77d044d414bab65317e3fe600f30625acb942c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjUzNzcxMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422537712", "bodyText": "Yes, makes sense.", "author": "kushagraThapar", "createdAt": "2020-05-09T19:42:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ0ODkyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjUxMjcyNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422512727", "bodyText": "in Direct mode we still establish some connections to GW (master resource operations and query plan retrieval, etc).\nHow are we controlling the GW Connection specifics in Direct mode?", "author": "moderakh", "createdAt": "2020-05-09T15:58:27Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/DirectConnectionConfig.java", "diffHunk": "@@ -0,0 +1,148 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.cosmos;\n+\n+import java.time.Duration;\n+\n+/**\n+ * Represents the connection config with {@link ConnectionMode#DIRECT} associated with Cosmos Client in the Azure Cosmos DB database service.\n+ */\n+public final class DirectConnectionConfig {", "originalCommit": "7b77d044d414bab65317e3fe600f30625acb942c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjUzODAyNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422538025", "bodyText": "Good point, we are only allowing for default values configurations for Gateway connection properties in case of Direct connection mode.\nSomething to think about, I will give it a thought.", "author": "kushagraThapar", "createdAt": "2020-05-09T19:45:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjUxMjcyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjcxNjAyNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422716024", "bodyText": "@moderakh - I have exposed these gateway client properties to CosmosClientBuilder\nSo that end users can also set these even in case of direct connection mode.\nprivate Duration requestTimeoutGateway = DEFAULT_REQUEST_TIMEOUT;\nprivate Duration idleConnectionTimeoutGateway = DEFAULT_IDLE_CONNECTION_TIMEOUT;\nprivate int maxConnectionPoolSizeGateway = DEFAULT_MAX_POOL_SIZE;", "author": "kushagraThapar", "createdAt": "2020-05-10T23:26:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjUxMjcyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjUxMzkzOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422513939", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        .endpointDiscoverEnabled(builder.isEndpointDiscoveryEnabled())\n          \n          \n            \n            endpointDiscoveryEnabled", "author": "moderakh", "createdAt": "2020-05-09T16:06:19Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosBridgeInternal.java", "diffHunk": "@@ -59,13 +60,20 @@ public static CosmosClientBuilder cloneCosmosClientBuilder(CosmosClientBuilder b\n \n         copy.endpoint(builder.getEndpoint())\n             .key(builder.getKey())\n-            .connectionPolicy(builder.getConnectionPolicy())\n+            .directMode(builder.getDirectConnectionConfig())\n+            .gatewayMode(builder.getGatewayConnectionConfig())\n             .consistencyLevel(builder.getConsistencyLevel())\n             .keyCredential(builder.getKeyCredential())\n             .permissions(builder.getPermissions())\n             .authorizationTokenResolver(builder.getAuthorizationTokenResolver())\n             .resourceToken(builder.getResourceToken())\n-            .contentResponseOnWriteEnabled(builder.isContentResponseOnWriteEnabled());\n+            .contentResponseOnWriteEnabled(builder.isContentResponseOnWriteEnabled())\n+            .userAgentSuffix(builder.getUserAgentSuffix())\n+            .throttlingRetryOptions(builder.getThrottlingRetryOptions())\n+            .preferredRegions(builder.getPreferredRegions())\n+            .endpointDiscoverEnabled(builder.isEndpointDiscoveryEnabled())", "originalCommit": "7b77d044d414bab65317e3fe600f30625acb942c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjUzNzc1NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r422537754", "bodyText": "Done.", "author": "kushagraThapar", "createdAt": "2020-05-09T19:43:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjUxMzkzOQ=="}], "type": "inlineReview"}, {"oid": "529e75df4d208f84c712e21834e3621e27bc1b8c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/529e75df4d208f84c712e21834e3621e27bc1b8c", "message": "Fixed some public surface names", "committedDate": "2020-05-09T20:06:47Z", "type": "commit"}, {"oid": "dde1d5b38690eea6e05a03dc915775c5a649786f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/dde1d5b38690eea6e05a03dc915775c5a649786f", "message": "Exposed additional gateway client properties in case of direct connection mode:", "committedDate": "2020-05-10T23:25:17Z", "type": "commit"}, {"oid": "1e3e8a9f716e81b68c93feaf34b9fd1e9ab8b53c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1e3e8a9f716e81b68c93feaf34b9fd1e9ab8b53c", "message": "Updated cosmos client builders with new default direct, default gateway and direct gateway configuration", "committedDate": "2020-05-11T22:38:33Z", "type": "commit"}, {"oid": "b1524e552aa256d44488fcd92944f36f34443d31", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b1524e552aa256d44488fcd92944f36f34443d31", "message": "Merged latest master and resolved conflicts", "committedDate": "2020-05-11T22:57:20Z", "type": "commit"}, {"oid": "70634a61eb183be2e5603660ed1b063035bcd7e3", "url": "https://github.com/Azure/azure-sdk-for-java/commit/70634a61eb183be2e5603660ed1b063035bcd7e3", "message": "Fixed cosmos client creation in diagnosis tests", "committedDate": "2020-05-12T02:06:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQzMjkwNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r423432905", "bodyText": "does this.gatewayConectionConfig get initialized somewhere else if only \"directMode() is called or is it null? also for direct mode we need a different set of default values for it, not the default ones, right?", "author": "milismsft", "createdAt": "2020-05-12T02:57:13Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosClientBuilder.java", "diffHunk": "@@ -327,6 +327,262 @@ public CosmosClientBuilder contentResponseOnWriteEnabled(boolean contentResponse\n         return this;\n     }\n \n+    /**\n+     * Sets the default GATEWAY connection configuration to be used.\n+     *\n+     * @return current CosmosClientBuilder\n+     */\n+    public CosmosClientBuilder gatewayMode() {\n+        this.gatewayConnectionConfig = GatewayConnectionConfig.getDefaultConfig();\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the GATEWAY connection configuration to be used.\n+     *\n+     * @param gatewayConnectionConfig gateway connection configuration\n+     * @return current CosmosClientBuilder\n+     */\n+    public CosmosClientBuilder gatewayMode(GatewayConnectionConfig gatewayConnectionConfig) {\n+        this.gatewayConnectionConfig = gatewayConnectionConfig;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the default DIRECT connection configuration to be used.\n+     *\n+     * @return current CosmosClientBuilder\n+     */\n+    public CosmosClientBuilder directMode() {\n+        this.directConnectionConfig = DirectConnectionConfig.getDefaultConfig();", "originalCommit": "70634a61eb183be2e5603660ed1b063035bcd7e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQzNzk0OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r423437949", "bodyText": "It will be null - And the connection policy gets built in buildConnectionPolicy method - with default values for gateway configuration - with the below defaults - in ConnectionPolicy\n//  Gateway connection config properties\n    private int maxConnectionPoolSize = DEFAULT_MAX_POOL_SIZE;\n    private Duration requestTimeout = DEFAULT_REQUEST_TIMEOUT;\n    private Duration idleConnectionTimeout = DEFAULT_IDLE_CONNECTION_TIMEOUT;", "author": "kushagraThapar", "createdAt": "2020-05-12T03:17:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQzMjkwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQzODU3MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10970#discussion_r423438570", "bodyText": "Yes, for DirectConnectionConfig - we have separate default values - which I got from RntbdTransportClient", "author": "kushagraThapar", "createdAt": "2020-05-12T03:20:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQzMjkwNQ=="}], "type": "inlineReview"}, {"oid": "88e6485ddfaa77ce57f781c87ea4014eb8f927b7", "url": "https://github.com/Azure/azure-sdk-for-java/commit/88e6485ddfaa77ce57f781c87ea4014eb8f927b7", "message": "Merged latest master and resolved conflicts", "committedDate": "2020-05-12T03:12:15Z", "type": "commit"}, {"oid": "14c59ed16956cc686a8a2d9e1ed2718b78da8325", "url": "https://github.com/Azure/azure-sdk-for-java/commit/14c59ed16956cc686a8a2d9e1ed2718b78da8325", "message": "Copied constants to GatewayConnectionConfig", "committedDate": "2020-05-12T03:18:58Z", "type": "commit"}]}