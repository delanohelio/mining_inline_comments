{"pr_number": 14341, "pr_title": "api(adt): Add API design doc for relationship APIs", "pr_createdAt": "2020-08-21T16:56:25Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/14341", "timeline": [{"oid": "1db610783613fcdb12dd2da98942e460bc3e4b25", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1db610783613fcdb12dd2da98942e460bc3e4b25", "message": "api(adt): Add API design doc for relationship APIs", "committedDate": "2020-08-21T16:40:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgxNjUwMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14341#discussion_r474816502", "bodyText": "The groupId is inherited from the parent, so we don't need to declare it here as well", "author": "abhipsaMisra", "createdAt": "2020-08-21T16:57:07Z", "path": "sdk/digitaltwins/azure-digitaltwins-core/pom.xml", "diffHunk": "@@ -11,7 +11,6 @@\n     <relativePath>../../parents/azure-client-sdk-parent</relativePath>\n   </parent>\n \n-    <groupId>com.azure</groupId>", "originalCommit": "1db610783613fcdb12dd2da98942e460bc3e4b25", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgxOTIxMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14341#discussion_r474819211", "bodyText": "Each?", "author": "drwill-ms", "createdAt": "2020-08-21T17:02:45Z", "path": "sdk/digitaltwins/azure-digitaltwins-core/API design.md", "diffHunk": "@@ -177,98 +177,95 @@ TODO:\n ## Relationships\n <details><summary><b>Terminology</b></summary>\n \n-Relationship: A named set of outgoing edges part of a Digital Twin persisted state.\n+Relationships: A named set of outgoing edges/relationships part of a Digital Twin persisted state.\n \n-Edge: (aka a \"Relationship Edge\") an individual edge in the Digital Twin relationship graph, ie. a tuple containing:\n+Each Relationship: (aka a \"Relationship Edge\") an individual edge in the Digital Twin relationship graph, ie. a tuple containing:", "originalCommit": "1db610783613fcdb12dd2da98942e460bc3e4b25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg4NDQ1Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14341#discussion_r474884453", "bodyText": "removed", "author": "abhipsaMisra", "createdAt": "2020-08-21T19:18:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgxOTIxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgxOTU2NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14341#discussion_r474819565", "bodyText": "Probably should just mention that in Graph these are called edges, and then don't use the word Edge again. Let's just call it what it is called in the API.", "author": "drwill-ms", "createdAt": "2020-08-21T17:03:33Z", "path": "sdk/digitaltwins/azure-digitaltwins-core/API design.md", "diffHunk": "@@ -177,98 +177,95 @@ TODO:\n ## Relationships\n <details><summary><b>Terminology</b></summary>\n \n-Relationship: A named set of outgoing edges part of a Digital Twin persisted state.\n+Relationships: A named set of outgoing edges/relationships part of a Digital Twin persisted state.", "originalCommit": "1db610783613fcdb12dd2da98942e460bc3e4b25", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgyMjM5NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14341#discussion_r474822394", "bodyText": "small S in relationship", "author": "drwill-ms", "createdAt": "2020-08-21T17:09:41Z", "path": "sdk/digitaltwins/azure-digitaltwins-core/API design.md", "diffHunk": "@@ -177,98 +177,95 @@ TODO:\n ## Relationships\n <details><summary><b>Terminology</b></summary>\n \n-Relationship: A named set of outgoing edges part of a Digital Twin persisted state.\n+Relationships: A named set of outgoing edges/relationships part of a Digital Twin persisted state.\n \n-Edge: (aka a \"Relationship Edge\") an individual edge in the Digital Twin relationship graph, ie. a tuple containing:\n+Each Relationship: (aka a \"Relationship Edge\") an individual edge in the Digital Twin relationship graph, ie. a tuple containing:\n     \n-\tEdgeId (Unique identifier of this edge within the context of the source Digital Twin)\n+\tRelationshipId (Unique identifier of this edge within the context of the source Digital Twin)\n \tSourceId (Id of the source Digital Twin) \n \tTargetId (Id of the target Digital Twin)\n-\trelationship name (User defined string such as \"contains\", \"hasDoorTo\", \"isNextTo\")\n+\tRelationshipName (User defined string such as \"contains\", \"hasDoorTo\", \"isNextTo\")\n \t0 to many user defined properties (ie: \"OccupancyLimit\", \"temperature\")\n \n-Each Edge is identified by its EdgeId. An EdgeId must be unique within the scope of the source Digital Twin.\n+Each relationship in a digital twin is identified by its RelationshipId. An RelationshipId must be unique within the scope of the source Digital Twin. The combination of SourceId and RelationshipId must be unique within the scope of the service.\n </details>\n \n <details><summary><b>Examples</b></summary>\n-An edge that signifies that room1 has a door to room2, and that it is open, would look like\n+A relationship that signifies that room1 has a door to room2, and that it is open, would look like\n \t\n-```csharp\n+```json\n {\n-    \"$edgeId\": \"Door1\",\n+    \"$relationshipId\": \"Door1\",\n     \"$sourceId\": \"Room1\",\n     \"$targetId\": \"Room2\",\n-    \"$relationship\": \"hasDoorTo\",\n+    \"$relationshipName\": \"hasDoorTo\",\n     \"doorStatus\": \"open\"\n }\n ```\n \t\n-An edge that signifies that Room 1 contains a thermostat would look like\n+A relationship that signifies that Room 1 contains a thermostat would look like\n \n-```csharp\n+```json\n {\n-\t\"$edgeId\" : \"ThermostatEdge1\",\n+\t\"$relationshipId\" : \"ThermostatEdge1\",\n \t\"$sourceId\" : \"Room1\",\n \t\"$targetId\" : \"Thermostat1\",\n-\t\"$relationship\" : \"contains\",\n+\t\"$relationshipName\" : \"contains\",\n \t\"installDate\" : \"2019-4-1\",\n \t\"replaceBatteryDate\" : \"2020-4-1\"\n }\n ```\n \n-When getting a list of edges (operations like \"get all edges for a Digital Twin\" or \"get all edges for a Digital Twin with a given relationshipName\"), the SDK will return a string in the below format:\n+When getting a list of relationships (operations like \"get all relationships for a Digital Twin\" or \"get all relationships for a Digital Twin with a given relationshipName\"), the client library will return a string in the below format:\n \n-```csharp\n+```json\n {\n   \"value\": [\n     {\n-      \"$edgeId\": \"Door1\",\n+      \"$relationshipId\": \"Door1\",\n       \"$sourceId\": \"Room1\",\n       \"$targetId\": \"Room2\",\n-      \"$relationship\": \"hasDoorTo\",\n+      \"$relationshipName\": \"hasDoorTo\",\n       \"doorStatus\": \"open\"\n     },\n     {\n-      \"$edgeId\": \"Door2\",\n+      \"$relationshipId\": \"Door2\",\n       \"$sourceId\": \"Room1\",\n       \"$targetId\": \"Room3\",\n-      \"$relationship\": \"hasDoorTo\",\n+      \"$relationshipName\": \"hasDoorTo\",\n       \"doorStatus\": \"closed\"\n     }\n   ],\n   \"nextLink\": \"url-to-next-page\"\n }\n ```\n \n-When creating a relationship edge, the edge string does not follow the above format. The rest endpoint to create a relationship edge contains the sourceId, relationshipName, and the edgeId, so the payload only needs to specify the targetId and any application properties, as seen below:\n-```csharp\n+When creating a relationship, the edge string does not follow the above format. The rest endpoint to create a relationship edge contains the sourceId, relationshipName, and the relationShipId, so the payload only needs to specify the targetId and any application properties, as seen below:", "originalCommit": "1db610783613fcdb12dd2da98942e460bc3e4b25", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgyMjY2MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14341#discussion_r474822660", "bodyText": "I thought the paths had to have a / prefix.\nAlso, ADT doesn't support nested properties yet, right?", "author": "drwill-ms", "createdAt": "2020-08-21T17:10:13Z", "path": "sdk/digitaltwins/azure-digitaltwins-core/API design.md", "diffHunk": "@@ -177,98 +177,95 @@ TODO:\n ## Relationships\n <details><summary><b>Terminology</b></summary>\n \n-Relationship: A named set of outgoing edges part of a Digital Twin persisted state.\n+Relationships: A named set of outgoing edges/relationships part of a Digital Twin persisted state.\n \n-Edge: (aka a \"Relationship Edge\") an individual edge in the Digital Twin relationship graph, ie. a tuple containing:\n+Each Relationship: (aka a \"Relationship Edge\") an individual edge in the Digital Twin relationship graph, ie. a tuple containing:\n     \n-\tEdgeId (Unique identifier of this edge within the context of the source Digital Twin)\n+\tRelationshipId (Unique identifier of this edge within the context of the source Digital Twin)\n \tSourceId (Id of the source Digital Twin) \n \tTargetId (Id of the target Digital Twin)\n-\trelationship name (User defined string such as \"contains\", \"hasDoorTo\", \"isNextTo\")\n+\tRelationshipName (User defined string such as \"contains\", \"hasDoorTo\", \"isNextTo\")\n \t0 to many user defined properties (ie: \"OccupancyLimit\", \"temperature\")\n \n-Each Edge is identified by its EdgeId. An EdgeId must be unique within the scope of the source Digital Twin.\n+Each relationship in a digital twin is identified by its RelationshipId. An RelationshipId must be unique within the scope of the source Digital Twin. The combination of SourceId and RelationshipId must be unique within the scope of the service.\n </details>\n \n <details><summary><b>Examples</b></summary>\n-An edge that signifies that room1 has a door to room2, and that it is open, would look like\n+A relationship that signifies that room1 has a door to room2, and that it is open, would look like\n \t\n-```csharp\n+```json\n {\n-    \"$edgeId\": \"Door1\",\n+    \"$relationshipId\": \"Door1\",\n     \"$sourceId\": \"Room1\",\n     \"$targetId\": \"Room2\",\n-    \"$relationship\": \"hasDoorTo\",\n+    \"$relationshipName\": \"hasDoorTo\",\n     \"doorStatus\": \"open\"\n }\n ```\n \t\n-An edge that signifies that Room 1 contains a thermostat would look like\n+A relationship that signifies that Room 1 contains a thermostat would look like\n \n-```csharp\n+```json\n {\n-\t\"$edgeId\" : \"ThermostatEdge1\",\n+\t\"$relationshipId\" : \"ThermostatEdge1\",\n \t\"$sourceId\" : \"Room1\",\n \t\"$targetId\" : \"Thermostat1\",\n-\t\"$relationship\" : \"contains\",\n+\t\"$relationshipName\" : \"contains\",\n \t\"installDate\" : \"2019-4-1\",\n \t\"replaceBatteryDate\" : \"2020-4-1\"\n }\n ```\n \n-When getting a list of edges (operations like \"get all edges for a Digital Twin\" or \"get all edges for a Digital Twin with a given relationshipName\"), the SDK will return a string in the below format:\n+When getting a list of relationships (operations like \"get all relationships for a Digital Twin\" or \"get all relationships for a Digital Twin with a given relationshipName\"), the client library will return a string in the below format:\n \n-```csharp\n+```json\n {\n   \"value\": [\n     {\n-      \"$edgeId\": \"Door1\",\n+      \"$relationshipId\": \"Door1\",\n       \"$sourceId\": \"Room1\",\n       \"$targetId\": \"Room2\",\n-      \"$relationship\": \"hasDoorTo\",\n+      \"$relationshipName\": \"hasDoorTo\",\n       \"doorStatus\": \"open\"\n     },\n     {\n-      \"$edgeId\": \"Door2\",\n+      \"$relationshipId\": \"Door2\",\n       \"$sourceId\": \"Room1\",\n       \"$targetId\": \"Room3\",\n-      \"$relationship\": \"hasDoorTo\",\n+      \"$relationshipName\": \"hasDoorTo\",\n       \"doorStatus\": \"closed\"\n     }\n   ],\n   \"nextLink\": \"url-to-next-page\"\n }\n ```\n \n-When creating a relationship edge, the edge string does not follow the above format. The rest endpoint to create a relationship edge contains the sourceId, relationshipName, and the edgeId, so the payload only needs to specify the targetId and any application properties, as seen below:\n-```csharp\n+When creating a relationship, the edge string does not follow the above format. The rest endpoint to create a relationship edge contains the sourceId, relationshipName, and the relationShipId, so the payload only needs to specify the targetId and any application properties, as seen below:\n+```json\n {\n-    \"edge\": \n-    {\n         \"$targetId\": \"myTargetTwin\",\n         \"myApplicationProperty1\": 1,\n         \"myApplicationProperty2\": \"some value\"\n-    }\n }\n ```\n \n When updating a relationship edge, the patch string follows the below format\n-```csharp\n+```json\n {\n-\t\"patchDocument\": \n-\t[\n-\t    {\n-\t        \"op\": \"replace\",\n-\t        \"path\": \"property1\",\n-\t        \"value\": 1\n-\t    },\n-\t\t{\n-\t        \"op\": \"add\",\n-\t        \"path\": \"property2/subProperty1\",\n-\t        \"value\": 1\n-\t    },\n-\t    {\n-\t        \"op\": \"remove\",\n+    \"patchDocument\": \n+    [\n+        {\n+            \"op\": \"replace\",\n+            \"path\": \"property1\",\n+            \"value\": 1\n+        },\n+        {\n+            \"op\": \"add\",\n+            \"path\": \"property2/subProperty1\",", "originalCommit": "1db610783613fcdb12dd2da98942e460bc3e4b25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg4NjE3Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14341#discussion_r474886173", "bodyText": "Correct, there is no support for nested properties right now. I copied this over from the .net repo, I'll update this.", "author": "abhipsaMisra", "createdAt": "2020-08-21T19:20:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgyMjY2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgzNzgyOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14341#discussion_r474837828", "bodyText": "What is the semaphore for?", "author": "drwill-ms", "createdAt": "2020-08-21T17:41:31Z", "path": "sdk/digitaltwins/azure-digitaltwins-core/src/samples/java/com/azure/digitaltwins/core/AsyncSample.java", "diffHunk": "@@ -27,16 +38,107 @@ public static void main(String[] args) throws InterruptedException\n         DigitalTwinsAsyncClient client = new DigitalTwinsClientBuilder()\n             .tokenCredential(tokenCredential)\n             .endpoint(endpoint)\n+            .httpLogOptions(\n+                new HttpLogOptions()\n+                    .setLogLevel(HttpLogDetailLevel.BODY_AND_HEADERS))\n             .buildAsyncClient();\n \n-        Mono<DigitalTwinsGetByIdResponse> asyncResponse = client.getDigitalTwin(digitalTwinId);\n+        // Create the source and target twins\n+        final Semaphore createTwinsSemaphore = new Semaphore(0);", "originalCommit": "1db610783613fcdb12dd2da98942e460bc3e4b25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgzOTMyNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14341#discussion_r474839324", "bodyText": "I gather that is how continuation is known when an \"async\" method is complete. That must be standard, eh?", "author": "drwill-ms", "createdAt": "2020-08-21T17:44:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgzNzgyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg4OTAzNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14341#discussion_r474889034", "bodyText": "yeah, since you subscribe to these async APIs, the calling thread will resume irrespective of the state of the async API call.\nSince our subsequent operations are dependent on the previous operations, we have to \"block\" the thread until the async call completes.", "author": "abhipsaMisra", "createdAt": "2020-08-21T19:24:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgzNzgyOA=="}], "type": "inlineReview"}, {"oid": "a0c6b7b1ad39b2c0536a7782d78113009fc7c532", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a0c6b7b1ad39b2c0536a7782d78113009fc7c532", "message": "cr comments", "committedDate": "2020-08-21T19:26:06Z", "type": "commit"}, {"oid": "943f920c5a0b33b3f35cd6ac3d47e643b25ed2c6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/943f920c5a0b33b3f35cd6ac3d47e643b25ed2c6", "message": "build failure fixed in sample", "committedDate": "2020-08-21T19:34:56Z", "type": "commit"}, {"oid": "05cc3c0f390cde4ead8acf744e79822c4b7d4938", "url": "https://github.com/Azure/azure-sdk-for-java/commit/05cc3c0f390cde4ead8acf744e79822c4b7d4938", "message": "adding group ID again", "committedDate": "2020-08-21T20:33:45Z", "type": "commit"}]}