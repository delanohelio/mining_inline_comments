{"pr_number": 17039, "pr_title": "[Service Bus] Calculate total timeout from AmqpRetryOptions", "pr_createdAt": "2020-10-30T23:02:28Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/17039", "timeline": [{"oid": "35b703889b974f622cbaf5af2a4590ab3eb1f449", "url": "https://github.com/Azure/azure-sdk-for-java/commit/35b703889b974f622cbaf5af2a4590ab3eb1f449", "message": "Calculate total timeout from AmqpRetryOptions", "committedDate": "2020-10-30T22:58:02Z", "type": "commit"}, {"oid": "483b4dbaf4736fc5af06f9dfac497cbaec6cfdeb", "url": "https://github.com/Azure/azure-sdk-for-java/commit/483b4dbaf4736fc5af06f9dfac497cbaec6cfdeb", "message": "Changed code for java8 compatible", "committedDate": "2020-10-30T23:24:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQyOTE2OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17039#discussion_r515429169", "bodyText": "getTotalTimeout makes more sense.", "author": "conniey", "createdAt": "2020-10-31T00:05:19Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusClientBuilder.java", "diffHunk": "@@ -610,7 +611,7 @@ public ServiceBusSenderAsyncClient buildAsyncClient() {\n          * @throws IllegalArgumentException if the entity type is not a queue or a topic.\n          */\n         public ServiceBusSenderClient buildClient() {\n-            return new ServiceBusSenderClient(buildAsyncClient(), retryOptions.getTryTimeout());\n+            return new ServiceBusSenderClient(buildAsyncClient(), MessageUtils.calcTotalTimeout(retryOptions));", "originalCommit": "483b4dbaf4736fc5af06f9dfac497cbaec6cfdeb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQzNTcyNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17039#discussion_r515435727", "bodyText": "Changed to get", "author": "YijunXieMS", "createdAt": "2020-10-31T00:52:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQyOTE2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQyOTI3NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17039#discussion_r515429275", "bodyText": "Can we spell out these abbreviations? calc -> calculate.", "author": "conniey", "createdAt": "2020-10-31T00:05:59Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/implementation/MessageUtilsTest.java", "diffHunk": "@@ -60,4 +68,33 @@ void convertUUIDToDotNetBytes() {\n         // Assert\n         assertArrayEquals(dotNetGuidBytes, convertedBytes, \"UUID conversion from Java to DotNet failed\");\n     }\n+\n+    @ParameterizedTest\n+    @MethodSource(\"calcTotalTimeoutTestData\")", "originalCommit": "483b4dbaf4736fc5af06f9dfac497cbaec6cfdeb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQzNTY5OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17039#discussion_r515435699", "bodyText": "Spelt out", "author": "YijunXieMS", "createdAt": "2020-10-31T00:52:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQyOTI3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQyOTM2Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17039#discussion_r515429367", "bodyText": "The order is assertEquals(expected, actual)", "author": "conniey", "createdAt": "2020-10-31T00:06:36Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/implementation/MessageUtilsTest.java", "diffHunk": "@@ -60,4 +68,33 @@ void convertUUIDToDotNetBytes() {\n         // Assert\n         assertArrayEquals(dotNetGuidBytes, convertedBytes, \"UUID conversion from Java to DotNet failed\");\n     }\n+\n+    @ParameterizedTest\n+    @MethodSource(\"calcTotalTimeoutTestData\")\n+    void calcTotalTimeout(List<Object> testData) {\n+        AmqpRetryOptions amqpRetryOptions = (AmqpRetryOptions) testData.get(0);\n+        long expectedResult = (long) testData.get(1);\n+        assertEquals(MessageUtils.calcTotalTimeout(amqpRetryOptions).toMillis(), expectedResult);", "originalCommit": "483b4dbaf4736fc5af06f9dfac497cbaec6cfdeb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQzNTc2MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17039#discussion_r515435760", "bodyText": "Updated", "author": "YijunXieMS", "createdAt": "2020-10-31T00:53:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQyOTM2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQyOTY3OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17039#discussion_r515429678", "bodyText": "This is hard to read. You can pass in a Stream and it'll try to deserialize it into the actual typees. Look for uses in our other tests.", "author": "conniey", "createdAt": "2020-10-31T00:08:43Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/implementation/MessageUtilsTest.java", "diffHunk": "@@ -60,4 +68,33 @@ void convertUUIDToDotNetBytes() {\n         // Assert\n         assertArrayEquals(dotNetGuidBytes, convertedBytes, \"UUID conversion from Java to DotNet failed\");\n     }\n+\n+    @ParameterizedTest\n+    @MethodSource(\"calcTotalTimeoutTestData\")\n+    void calcTotalTimeout(List<Object> testData) {", "originalCommit": "483b4dbaf4736fc5af06f9dfac497cbaec6cfdeb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQzNTgyNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17039#discussion_r515435824", "bodyText": "Changed to use Arguments.of and auto-deserialize. Thanks for the suggestion.", "author": "YijunXieMS", "createdAt": "2020-10-31T00:53:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQyOTY3OA=="}], "type": "inlineReview"}, {"oid": "17ed086e9979159cc1c41f054abd9f8512dfb325", "url": "https://github.com/Azure/azure-sdk-for-java/commit/17ed086e9979159cc1c41f054abd9f8512dfb325", "message": "Rename calcTotalTime to getTotalTime", "committedDate": "2020-10-31T00:32:25Z", "type": "commit"}, {"oid": "eb08b6bd29dc4006d054012cc4ad2c7334dc388a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/eb08b6bd29dc4006d054012cc4ad2c7334dc388a", "message": "Use Arguments in parameterized test", "committedDate": "2020-10-31T00:48:58Z", "type": "commit"}, {"oid": "ff955c4251da7a166af6d3d1c70110e9b6dd1bb0", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ff955c4251da7a166af6d3d1c70110e9b6dd1bb0", "message": "remove unused import", "committedDate": "2020-10-31T01:01:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ1MTkzNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17039#discussion_r515451935", "bodyText": "The default in AmqpRetryOption is  AmqpRetryMode.EXPONENTIAL  which is what we use in our builder. So by default most of our customer will use EXPONENTIAL and exponent of 2 based on this logic  and this is different from how we will do EXPONENTIAL retry for Connections\nhttps://github.com/Azure/azure-sdk-for-java/blob/master/sdk/core/azure-core-amqp/src/main/java/com/azure/core/amqp/implementation/RetryUtil.java#L86\nI am not saying it should be same but I am pointing that it is different.", "author": "hemanttanwar", "createdAt": "2020-10-31T03:58:59Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/MessageUtils.java", "diffHunk": "@@ -68,6 +70,30 @@ public static Duration adjustServerTimeout(Duration clientTimeout) {\n         return clientTimeout.minusMillis(1000);\n     }\n \n+    /**\n+     * Calculate the total time from the retry options assuming all retries are exhausted.\n+     */\n+    public static Duration getTotalTimeout(AmqpRetryOptions retryOptions) {\n+        long tryTimeout = retryOptions.getTryTimeout().toNanos();\n+        long maxDelay = retryOptions.getMaxDelay().toNanos();\n+        long totalTimeout = tryTimeout;  // The original attempt not counted as a retry\n+        if (retryOptions.getMode() == AmqpRetryMode.FIXED) {\n+            totalTimeout += (retryOptions.getDelay().toNanos() + tryTimeout) * retryOptions.getMaxRetries();\n+        } else {\n+            int multiplier = 1;\n+            for (int i = 0; i < retryOptions.getMaxRetries(); i++) {\n+                long retryDelay = retryOptions.getDelay().toNanos() * multiplier;\n+                if (retryDelay >= maxDelay) {\n+                    retryDelay = maxDelay;\n+                    totalTimeout += (tryTimeout + retryDelay) * (retryOptions.getMaxRetries() - i);\n+                    break;\n+                }\n+                multiplier *= 2;", "originalCommit": "ff955c4251da7a166af6d3d1c70110e9b6dd1bb0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI1OTQ2NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17039#discussion_r516259465", "bodyText": "RetryUtil calculates the delay (exponential or fixed). This is to calculates the total timeout including the delay.\nThe delay part is the same except that there is a very small random jitter in RetryUtil.", "author": "YijunXieMS", "createdAt": "2020-11-02T21:18:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ1MTkzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE1MDAyNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17039#discussion_r516150025", "bodyText": "Can we create an issue to move this logic into as a part of of AMQP Retry policy? It seems like a lot of special logic that could be aggregated into the different retry policies we have.", "author": "conniey", "createdAt": "2020-11-02T17:45:34Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/implementation/MessageUtils.java", "diffHunk": "@@ -68,6 +70,30 @@ public static Duration adjustServerTimeout(Duration clientTimeout) {\n         return clientTimeout.minusMillis(1000);\n     }\n \n+    /**\n+     * Calculate the total time from the retry options assuming all retries are exhausted.\n+     */\n+    public static Duration getTotalTimeout(AmqpRetryOptions retryOptions) {", "originalCommit": "ff955c4251da7a166af6d3d1c70110e9b6dd1bb0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE1MDcwNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17039#discussion_r516150707", "bodyText": "One of the things we consider is \"jitter\" to each retry... so this may not be exact. But it may be enough.", "author": "conniey", "createdAt": "2020-11-02T17:46:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE1MDAyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE1NjY1Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17039#discussion_r516156656", "bodyText": "Will create an issue to for AMQP retry policy and re-considering jitter. Good suggestion.", "author": "YijunXieMS", "createdAt": "2020-11-02T17:56:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE1MDAyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI1OTI5Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17039#discussion_r516259297", "bodyText": "#17072 created", "author": "YijunXieMS", "createdAt": "2020-11-02T21:18:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE1MDAyNQ=="}], "type": "inlineReview"}]}