{"pr_number": 7476, "pr_title": "Fix Upload From File Tests", "pr_createdAt": "2020-01-15T18:26:52Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/7476", "timeline": [{"oid": "6f7c6e1b29f2918c1d9bb4fc0c85b63f76ca77c6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6f7c6e1b29f2918c1d9bb4fc0c85b63f76ca77c6", "message": "Fixed upload from file using FluxUtil.write in a manner where the underlying ByteBuffer may be reclaimed before written", "committedDate": "2020-01-15T18:24:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA2MjIzMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7476#discussion_r367062232", "bodyText": "This can be simplified by using try-with-resources pattern:\nnew FileOutputStream(outFile).with { outStream ->\n      outStream.write(FluxUtil.collectBytesInByteBufferStream(blobAsyncClient.download()).block());\n}", "author": "srnagar", "createdAt": "2020-01-15T19:25:03Z", "path": "sdk/storage/azure-storage-blob/src/test/java/com/azure/storage/blob/specialized/BlockBlobAPITest.groovy", "diffHunk": "@@ -651,19 +648,20 @@ class BlockBlobAPITest extends APISpec {\n             .verifyComplete()\n \n         then:\n-        def outFile = file.getPath().toString() + \"result\"\n-        def outChannel = AsynchronousFileChannel.open(Paths.get(outFile), StandardOpenOption.CREATE,\n-            StandardOpenOption.WRITE)\n-        StepVerifier.create(FluxUtil.writeFile(blobAsyncClient.download(), outChannel)).verifyComplete()\n-        outChannel.close()\n+        def outFile = new File(file.getPath().toString() + \"result\")\n+        outFile.createNewFile()\n \n-        compareFiles(file, new File(outFile), 0, fileSize)\n+        def outStream = new FileOutputStream(outFile)\n+        outStream.write(FluxUtil.collectBytesInByteBufferStream(blobAsyncClient.download()).block())\n+        outStream.close()", "originalCommit": "6f7c6e1b29f2918c1d9bb4fc0c85b63f76ca77c6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}