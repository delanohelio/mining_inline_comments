{"pr_number": 12621, "pr_title": "Nio read attr", "pr_createdAt": "2020-06-29T20:04:31Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/12621", "timeline": [{"oid": "58767907987374dbb1b3380e90bfd0a22c235201", "url": "https://github.com/Azure/azure-sdk-for-java/commit/58767907987374dbb1b3380e90bfd0a22c235201", "message": "Started working on read attributes", "committedDate": "2020-05-13T17:02:38Z", "type": "commit"}, {"oid": "d23f3484496621f7d6c84f79acf1ce47baa63faa", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d23f3484496621f7d6c84f79acf1ce47baa63faa", "message": "Figuring it out", "committedDate": "2020-06-23T23:27:57Z", "type": "commit"}, {"oid": "6e5c44d8df874de8dafdff2091959fc9bb11c59e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6e5c44d8df874de8dafdff2091959fc9bb11c59e", "message": "Merge remote-tracking branch 'upstream/master' into nioReadAttr", "committedDate": "2020-06-23T23:32:50Z", "type": "commit"}, {"oid": "2de8168f7605eb8abb5d96ac6893836510c4b4f9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2de8168f7605eb8abb5d96ac6893836510c4b4f9", "message": "Progress", "committedDate": "2020-06-25T00:13:24Z", "type": "commit"}, {"oid": "e2c8ef4d0305f720eedb01f3b4ae3ffcac33ccc5", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e2c8ef4d0305f720eedb01f3b4ae3ffcac33ccc5", "message": "Some good progress on testing attributes", "committedDate": "2020-06-25T23:22:46Z", "type": "commit"}, {"oid": "3bb0ded60a120f518cc2757a0a37157aadd2ee94", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3bb0ded60a120f518cc2757a0a37157aadd2ee94", "message": "Finished tests. Added recordings", "committedDate": "2020-06-29T19:48:46Z", "type": "commit"}, {"oid": "3e5b74b7b3ae5a305e9cfaaa996e03621fe6c853", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3e5b74b7b3ae5a305e9cfaaa996e03621fe6c853", "message": "Minor cleanup", "committedDate": "2020-06-29T20:03:41Z", "type": "commit"}, {"oid": "c782de0e64ec2c2dd14e67055f519d6753985789", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c782de0e64ec2c2dd14e67055f519d6753985789", "message": "Fixed compiler warnings", "committedDate": "2020-06-29T22:24:19Z", "type": "commit"}, {"oid": "1abff9c4a645f549803ddfb869b3bdf4ae526d32", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1abff9c4a645f549803ddfb869b3bdf4ae526d32", "message": "Fixed test failure", "committedDate": "2020-06-29T23:00:09Z", "type": "commit"}, {"oid": "45d331e7e8bc2396952e89abdd74b4ef50f2f730", "url": "https://github.com/Azure/azure-sdk-for-java/commit/45d331e7e8bc2396952e89abdd74b4ef50f2f730", "message": "Checkstyle", "committedDate": "2020-06-30T16:45:30Z", "type": "commit"}, {"oid": "f24802627cbc3de033da2364320a04983883ccb9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f24802627cbc3de033da2364320a04983883ccb9", "message": "Spotbugs", "committedDate": "2020-06-30T17:57:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk5NzM3OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12621#discussion_r447997379", "bodyText": "nit: May want to remove the last line \ud83d\ude03", "author": "alzimmermsft", "createdAt": "2020-06-30T21:45:15Z", "path": "sdk/storage/azure-storage-blob-nio/src/main/java/com/azure/storage/blob/nio/AzureBasicFileAttributes.java", "diffHunk": "@@ -0,0 +1,142 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.storage.blob.nio;\n+\n+import com.azure.core.util.logging.ClientLogger;\n+import com.azure.storage.blob.models.BlobProperties;\n+import com.azure.storage.blob.models.BlobStorageException;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileAttribute;\n+import java.nio.file.attribute.FileTime;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+/**\n+ * Provides support for basic file attributes.\n+ * <p>\n+ * The properties available on this type are a strict subset of {@link AzureBlobFileAttributes}, and the two types have\n+ * the same network behavior. Therefore, while this type is offered for compliance with the NIO spec,\n+ * {@link AzureBlobFileAttributes} is generally preferred.\n+ * <p>\n+ * Some attributes are not supported. Refer to the javadocs on each method for more information.\n+ * {@inheritDoc}\n+ */\n+public class AzureBasicFileAttributes implements BasicFileAttributes {\n+    private final ClientLogger logger = new ClientLogger(AzureBasicFileAttributes.class);\n+\n+    // For verifying parameters on FileSystemProvider.readAttributes\n+    static final Set<String> ATTRIBUTE_STRINGS;\n+    static {\n+        Set<String> set = new HashSet<>();\n+        set.add(\"lastModifiedTime\");\n+        set.add(\"isRegularFile\");\n+        set.add(\"isDirectory\");\n+        set.add(\"isSymbolicLink\");\n+        set.add(\"isOther\");\n+        set.add(\"size\");\n+        set.add(\"creationTime\");\n+        ATTRIBUTE_STRINGS = Collections.unmodifiableSet(set);\n+    }\n+\n+    private final BlobProperties properties;\n+\n+    /*\n+    There are some work-arounds we could do to try to accommodate virtual directories such as making a checkDirStatus\n+    call before or after getProperties to throw an appropriate error or adding an isVirtualDirectory method. However,\n+    the former wastes network time only to throw a slightly more specific error when we will throw on 404 anyway. The\n+    latter introduces virtual directories into the actual code path/api surface. While we are clear in our docs about\n+    the possible pitfalls of virtual directories, and customers should be aware of it, they shouldn't have to code\n+    against it. Therefore, we fall back to documenting that reading attributes on a virtual directory will throw. And\n+    who reads attributes on a directory anyway?", "originalCommit": "f24802627cbc3de033da2364320a04983883ccb9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxMjQ2Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12621#discussion_r448012467", "bodyText": "Yeaa probably :(", "author": "rickle-msft", "createdAt": "2020-06-30T22:22:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk5NzM3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk5ODEyOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12621#discussion_r447998129", "bodyText": "Should this throw UnsupportedOperationException if it isn't supported?", "author": "alzimmermsft", "createdAt": "2020-06-30T21:47:01Z", "path": "sdk/storage/azure-storage-blob-nio/src/main/java/com/azure/storage/blob/nio/AzureBasicFileAttributes.java", "diffHunk": "@@ -0,0 +1,142 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.storage.blob.nio;\n+\n+import com.azure.core.util.logging.ClientLogger;\n+import com.azure.storage.blob.models.BlobProperties;\n+import com.azure.storage.blob.models.BlobStorageException;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileAttribute;\n+import java.nio.file.attribute.FileTime;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+/**\n+ * Provides support for basic file attributes.\n+ * <p>\n+ * The properties available on this type are a strict subset of {@link AzureBlobFileAttributes}, and the two types have\n+ * the same network behavior. Therefore, while this type is offered for compliance with the NIO spec,\n+ * {@link AzureBlobFileAttributes} is generally preferred.\n+ * <p>\n+ * Some attributes are not supported. Refer to the javadocs on each method for more information.\n+ * {@inheritDoc}\n+ */\n+public class AzureBasicFileAttributes implements BasicFileAttributes {\n+    private final ClientLogger logger = new ClientLogger(AzureBasicFileAttributes.class);\n+\n+    // For verifying parameters on FileSystemProvider.readAttributes\n+    static final Set<String> ATTRIBUTE_STRINGS;\n+    static {\n+        Set<String> set = new HashSet<>();\n+        set.add(\"lastModifiedTime\");\n+        set.add(\"isRegularFile\");\n+        set.add(\"isDirectory\");\n+        set.add(\"isSymbolicLink\");\n+        set.add(\"isOther\");\n+        set.add(\"size\");\n+        set.add(\"creationTime\");\n+        ATTRIBUTE_STRINGS = Collections.unmodifiableSet(set);\n+    }\n+\n+    private final BlobProperties properties;\n+\n+    /*\n+    There are some work-arounds we could do to try to accommodate virtual directories such as making a checkDirStatus\n+    call before or after getProperties to throw an appropriate error or adding an isVirtualDirectory method. However,\n+    the former wastes network time only to throw a slightly more specific error when we will throw on 404 anyway. The\n+    latter introduces virtual directories into the actual code path/api surface. While we are clear in our docs about\n+    the possible pitfalls of virtual directories, and customers should be aware of it, they shouldn't have to code\n+    against it. Therefore, we fall back to documenting that reading attributes on a virtual directory will throw. And\n+    who reads attributes on a directory anyway?\n+     */\n+    AzureBasicFileAttributes(Path path) throws IOException {\n+        try {\n+            this.properties = new AzureResource(path).getBlobClient().getProperties();\n+        } catch (BlobStorageException e) {\n+            throw LoggingUtility.logError(logger, new IOException(e));\n+        }\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public FileTime lastModifiedTime() {\n+        return FileTime.from(properties.getLastModified().toInstant());\n+    }\n+\n+    /**\n+     * Unsupported.\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public FileTime lastAccessTime() {\n+        throw new UnsupportedOperationException();\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public FileTime creationTime() {\n+        return FileTime.from(properties.getCreationTime().toInstant());\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public boolean isRegularFile() {\n+        return !this.properties.getMetadata().getOrDefault(AzureResource.DIR_METADATA_MARKER, \"false\").equals(\"true\");\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     * <p>\n+     * Will only return true if the directory is a concrete directory. See\n+     * {@link AzureFileSystemProvider#createDirectory(Path, FileAttribute[])} for more information on virtual and\n+     * concrete directories.\n+     */\n+    @Override\n+    public boolean isDirectory() {\n+        return !this.isRegularFile();\n+    }\n+\n+    /**\n+     * @return false. Symbolic links are not supported.\n+     */\n+    @Override\n+    public boolean isSymbolicLink() {\n+        return false;", "originalCommit": "f24802627cbc3de033da2364320a04983883ccb9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxMjc1MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12621#discussion_r448012751", "bodyText": "I'm not sure. In some sense it's just always false, right? But maybe it makes it more clear that sym links aren't supported if I throw?", "author": "rickle-msft", "createdAt": "2020-06-30T22:23:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk5ODEyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI3MTQ0Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12621#discussion_r450271443", "bodyText": "I think returning always false is correct. Throwing UnsupportedOperationException would mean \"I cannot check if file is symlink or not` in plain English. I believe our file system doesn't have symlinks so all files are real by definition, therefore we know how to check if they're symlinks or not.", "author": "kasobol-msft", "createdAt": "2020-07-06T14:44:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk5ODEyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk5ODYyOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12621#discussion_r447998629", "bodyText": "Should be able to pass m here.", "author": "alzimmermsft", "createdAt": "2020-06-30T21:47:56Z", "path": "sdk/storage/azure-storage-blob-nio/src/main/java/com/azure/storage/blob/nio/AzureBlobFileAttributeView.java", "diffHunk": "@@ -0,0 +1,146 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.storage.blob.nio;\n+\n+import com.azure.core.util.logging.ClientLogger;\n+import com.azure.storage.blob.models.AccessTier;\n+import com.azure.storage.blob.models.BlobHttpHeaders;\n+import com.azure.storage.blob.models.BlobStorageException;\n+import com.azure.storage.blob.specialized.BlobClientBase;\n+\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.nio.file.Path;\n+import java.nio.file.attribute.BasicFileAttributeView;\n+import java.nio.file.attribute.FileTime;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.function.Consumer;\n+\n+/**\n+ * A file attribute view that provides a view of attributes specific to files stored as blobs in Azure Storage.\n+ * <p>\n+ * All attributes are retrieved from the file system as a bulk operation.\n+ * <p>\n+ * {@link #setTimes(FileTime, FileTime, FileTime)} is not supported.\n+ */\n+public final class AzureBlobFileAttributeView implements BasicFileAttributeView {\n+    private final ClientLogger logger = new ClientLogger(AzureBlobFileAttributeView.class);\n+\n+    static final String ATTR_CONSUMER_ERROR = \"Exception thrown by attribute consumer\";\n+\n+    private final Path path;\n+\n+    AzureBlobFileAttributeView(Path path) {\n+        this.path = path;\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    static Map<String, Consumer<Object>> setAttributeConsumers(AzureBlobFileAttributeView view) {\n+        Map<String, Consumer<Object>> map = new HashMap<>();\n+        map.put(\"blobHttpHeaders\", obj -> {\n+            try {\n+                view.setBlobHttpHeaders((BlobHttpHeaders) obj);\n+            } catch (IOException e) {\n+                throw LoggingUtility.logError(view.logger, new UncheckedIOException(ATTR_CONSUMER_ERROR, e));\n+            }\n+        });\n+        map.put(\"metadata\", obj -> {\n+            try {\n+                Map<String, String> m = (Map<String, String>) obj;\n+                if (m == null) {\n+                    throw LoggingUtility.logError(view.logger, new ClassCastException());\n+                }\n+                view.setMetadata((Map<String, String>) obj);", "originalCommit": "f24802627cbc3de033da2364320a04983883ccb9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxMjg1MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12621#discussion_r448012850", "bodyText": "Good catch", "author": "rickle-msft", "createdAt": "2020-06-30T22:23:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk5ODYyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk5OTc2NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12621#discussion_r447999764", "bodyText": "Same question about throwing UnsupportedOperationException.", "author": "alzimmermsft", "createdAt": "2020-06-30T21:50:33Z", "path": "sdk/storage/azure-storage-blob-nio/src/main/java/com/azure/storage/blob/nio/AzureBlobFileAttributes.java", "diffHunk": "@@ -0,0 +1,290 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.storage.blob.nio;\n+\n+import com.azure.core.util.logging.ClientLogger;\n+import com.azure.storage.blob.models.AccessTier;\n+import com.azure.storage.blob.models.ArchiveStatus;\n+import com.azure.storage.blob.models.BlobHttpHeaders;\n+import com.azure.storage.blob.models.BlobProperties;\n+import com.azure.storage.blob.models.BlobStorageException;\n+import com.azure.storage.blob.models.BlobType;\n+import com.azure.storage.blob.models.CopyStatusType;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileAttribute;\n+import java.nio.file.attribute.FileTime;\n+import java.time.OffsetDateTime;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.function.Supplier;\n+\n+/**\n+ * File attributes associated with a file stored as a blob in Azure Storage.\n+ * <p>\n+ * Some of the attributes inherited from {@link BasicFileAttributes} are not supported. See the docs on each method for\n+ * more information.\n+ */\n+public final class AzureBlobFileAttributes implements BasicFileAttributes {\n+    /*\n+    Some blob properties do not have getters as they do not make sense in the context of nio. These properties are:\n+        - incremental snapshot related properties\n+        - lease related properties\n+        - sequence number\n+        - encryption key sha256\n+     */\n+\n+    private final ClientLogger logger = new ClientLogger(AzureBlobFileAttributes.class);\n+\n+    private final BlobProperties properties;\n+\n+    AzureBlobFileAttributes(Path path) throws IOException {\n+        try {\n+            this.properties = new AzureResource(path).getBlobClient().getProperties();\n+        } catch (BlobStorageException e) {\n+            throw LoggingUtility.logError(logger, new IOException(\"Path: \" + path.toString(), e));\n+        }\n+    }\n+\n+    static Map<String, Supplier<Object>> getAttributeSuppliers(AzureBlobFileAttributes attributes) {\n+        Map<String, Supplier<Object>> map = new HashMap<>();\n+        map.put(\"creationTime\", attributes::creationTime);\n+        map.put(\"lastModifiedTime\", attributes::lastModifiedTime);\n+        map.put(\"eTag\", attributes::eTag);\n+        map.put(\"blobHttpHeaders\", attributes::blobHttpHeaders);\n+        map.put(\"blobType\", attributes::blobType);\n+        map.put(\"copyId\", attributes::copyId);\n+        map.put(\"copyStatus\", attributes::copyStatus);\n+        map.put(\"copySource\", attributes::copySource);\n+        map.put(\"copyProgress\", attributes::copyProgress);\n+        map.put(\"copyCompletionTime\", attributes::copyCompletionTime);\n+        map.put(\"copyStatusDescription\", attributes::copyStatusDescription);\n+        map.put(\"isServerEncrypted\", attributes::isServerEncrypted);\n+        map.put(\"accessTier\", attributes::accessTier);\n+        map.put(\"isAccessTierInferred\", attributes::isAccessTierInferred);\n+        map.put(\"archiveStatus\", attributes::archiveStatus);\n+        map.put(\"accessTierChangeTime\", attributes::accessTierChangeTime);\n+        map.put(\"metadata\", attributes::metadata);\n+        map.put(\"committedBlockCount\", attributes::committedBlockCount);\n+        map.put(\"isRegularFile\", attributes::isRegularFile);\n+        map.put(\"isDirectory\", attributes::isDirectory);\n+        map.put(\"isSymbolicLink\", attributes::isSymbolicLink);\n+        map.put(\"isOther\", attributes::isOther);\n+        map.put(\"size\", attributes::size);\n+        return map;\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public FileTime creationTime() {\n+        return FileTime.from(this.properties.getCreationTime().toInstant());\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public FileTime lastModifiedTime() {\n+        return FileTime.from(this.properties.getLastModified().toInstant());\n+    }\n+\n+    /**\n+     * @return the eTag of the blob\n+     */\n+    public String eTag() {\n+        return this.properties.getETag();\n+    }\n+\n+    /**\n+     * @return {@link BlobHttpHeaders}\n+     */\n+    public BlobHttpHeaders blobHttpHeaders() {\n+        /*\n+        We return these all as one value so it's consistent with the way of setting, especially the setAttribute method\n+        that accepts a string argument for the name of the property. Returning them individually would mean we have to\n+        support setting them individually as well, which is not possible due to service constraints.\n+         */\n+        return new BlobHttpHeaders()\n+            .setContentType(this.properties.getContentType())\n+            .setContentLanguage(this.properties.getContentLanguage())\n+            .setContentMd5(this.properties.getContentMd5())\n+            .setContentDisposition(this.properties.getContentDisposition())\n+            .setContentEncoding(this.properties.getContentEncoding())\n+            .setCacheControl(this.properties.getCacheControl());\n+    }\n+\n+    /**\n+     * @return the type of the blob\n+     */\n+    public BlobType blobType() {\n+        return this.properties.getBlobType();\n+    }\n+\n+    /**\n+     * @return the identifier of the last copy operation. If this blob hasn't been the target of a copy operation or has\n+     * been modified since this won't be set.\n+     */\n+    public String copyId() {\n+        return this.properties.getCopyId();\n+    }\n+\n+    /**\n+     * @return the status of the last copy operation. If this blob hasn't been the target of a copy operation or has\n+     * been modified since this won't be set.\n+     */\n+    public CopyStatusType copyStatus() {\n+        return this.properties.getCopyStatus();\n+    }\n+\n+    /**\n+     * @return the source blob URL from the last copy operation. If this blob hasn't been the target of a copy operation\n+     * or has been modified since this won't be set.\n+     */\n+    public String copySource() {\n+        return this.properties.getCopySource();\n+    }\n+\n+    /**\n+     * @return the number of bytes copied and total bytes in the source from the last copy operation (bytes copied/total\n+     * bytes). If this blob hasn't been the target of a copy operation or has been modified since this won't be set.\n+     */\n+    public String copyProgress() {\n+        return this.properties.getCopyProgress();\n+    }\n+\n+    /**\n+     * @return the completion time of the last copy operation. If this blob hasn't been the target of a copy operation\n+     * or has been modified since this won't be set.\n+     */\n+    public OffsetDateTime copyCompletionTime() {\n+        return this.properties.getCopyCompletionTime();\n+    }\n+\n+    /**\n+     * @return the description of the last copy failure, this is set when the {@link #copyStatus() getCopyStatus} is\n+     * {@link CopyStatusType#FAILED failed} or {@link CopyStatusType#ABORTED aborted}. If this blob hasn't been the\n+     * target of a copy operation or has been modified since this won't be set.\n+     */\n+    public String copyStatusDescription() {\n+        return this.properties.getCopyStatusDescription();\n+    }\n+\n+    /**\n+     * @return the status of the blob being encrypted on the server\n+     */\n+    public Boolean isServerEncrypted() {\n+        return this.properties.isServerEncrypted();\n+    }\n+\n+    /**\n+     * @return the tier of the blob. This is only set for Page blobs on a premium storage account or for Block blobs on\n+     * blob storage or general purpose V2 account.\n+     */\n+    public AccessTier accessTier() {\n+        return this.properties.getAccessTier();\n+    }\n+\n+    /**\n+     * @return the status of the tier being inferred for the blob. This is only set for Page blobs on a premium storage\n+     * account or for Block blobs on blob storage or general purpose V2 account.\n+     */\n+    public Boolean isAccessTierInferred() {\n+        return this.properties.isAccessTierInferred();\n+    }\n+\n+    /**\n+     * @return the archive status of the blob. This is only for blobs on a blob storage and general purpose v2 account.\n+     */\n+    public ArchiveStatus archiveStatus() {\n+        return this.properties.getArchiveStatus();\n+    }\n+\n+    /**\n+     * @return the time when the access tier for the blob was last changed\n+     */\n+    public OffsetDateTime accessTierChangeTime() {\n+        return this.properties.getAccessTierChangeTime();\n+    }\n+\n+    /**\n+     * @return the metadata associated with this blob\n+     */\n+    public Map<String, String> metadata() {\n+        return Collections.unmodifiableMap(this.properties.getMetadata());\n+    }\n+\n+    /**\n+     * @return the number of committed blocks in the blob. This is only returned for Append blobs.\n+     */\n+    public Integer committedBlockCount() {\n+        return this.properties.getCommittedBlockCount();\n+    }\n+\n+    /**\n+     * Unsupported.\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public FileTime lastAccessTime() {\n+        throw new UnsupportedOperationException();\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public boolean isRegularFile() {\n+        return !this.properties.getMetadata().getOrDefault(AzureResource.DIR_METADATA_MARKER, \"false\").equals(\"true\");\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     * <p>\n+     * Will only return true if the directory is a concrete directory. See\n+     * {@link AzureFileSystemProvider#createDirectory(Path, FileAttribute[])} for more information on virtual and\n+     * concrete directories.\n+     */\n+    @Override\n+    public boolean isDirectory() {\n+        return !this.isRegularFile();\n+    }\n+\n+    /**\n+     * @return false. Symbolic links are not supported.", "originalCommit": "f24802627cbc3de033da2364320a04983883ccb9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI3NTY0Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12621#discussion_r450275642", "bodyText": "What if properties change while someone is holding reference to this object? I.e. lastModifiedTime shifts between calling this constructor and lastModifiedTime()?\nCould you check what happens if you use local file system?", "author": "kasobol-msft", "createdAt": "2020-07-06T14:50:09Z", "path": "sdk/storage/azure-storage-blob-nio/src/main/java/com/azure/storage/blob/nio/AzureBasicFileAttributes.java", "diffHunk": "@@ -0,0 +1,142 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.storage.blob.nio;\n+\n+import com.azure.core.util.logging.ClientLogger;\n+import com.azure.storage.blob.models.BlobProperties;\n+import com.azure.storage.blob.models.BlobStorageException;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileAttribute;\n+import java.nio.file.attribute.FileTime;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+/**\n+ * Provides support for basic file attributes.\n+ * <p>\n+ * The properties available on this type are a strict subset of {@link AzureBlobFileAttributes}, and the two types have\n+ * the same network behavior. Therefore, while this type is offered for compliance with the NIO spec,\n+ * {@link AzureBlobFileAttributes} is generally preferred.\n+ * <p>\n+ * Some attributes are not supported. Refer to the javadocs on each method for more information.\n+ * {@inheritDoc}\n+ */\n+public class AzureBasicFileAttributes implements BasicFileAttributes {\n+    private final ClientLogger logger = new ClientLogger(AzureBasicFileAttributes.class);\n+\n+    // For verifying parameters on FileSystemProvider.readAttributes\n+    static final Set<String> ATTRIBUTE_STRINGS;\n+    static {\n+        Set<String> set = new HashSet<>();\n+        set.add(\"lastModifiedTime\");\n+        set.add(\"isRegularFile\");\n+        set.add(\"isDirectory\");\n+        set.add(\"isSymbolicLink\");\n+        set.add(\"isOther\");\n+        set.add(\"size\");\n+        set.add(\"creationTime\");\n+        ATTRIBUTE_STRINGS = Collections.unmodifiableSet(set);\n+    }\n+\n+    private final BlobProperties properties;\n+\n+    /*\n+    There are some work-arounds we could do to try to accommodate virtual directories such as making a checkDirStatus\n+    call before or after getProperties to throw an appropriate error or adding an isVirtualDirectory method. However,\n+    the former wastes network time only to throw a slightly more specific error when we will throw on 404 anyway. The\n+    latter introduces virtual directories into the actual code path/api surface. While we are clear in our docs about\n+    the possible pitfalls of virtual directories, and customers should be aware of it, they shouldn't have to code\n+    against it. Therefore, we fall back to documenting that reading attributes on a virtual directory will throw. And\n+    who reads attributes on a directory anyway?\n+     */\n+    AzureBasicFileAttributes(Path path) throws IOException {\n+        try {\n+            this.properties = new AzureResource(path).getBlobClient().getProperties();", "originalCommit": "f24802627cbc3de033da2364320a04983883ccb9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAyNTMxNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12621#discussion_r451025315", "bodyText": "It looks like the attributes always return the same value once you've read them, and if you want an updated value, you need to make another call to read attributes, which is what we do here", "author": "rickle-msft", "createdAt": "2020-07-07T17:23:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI3NTY0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA4MDgxMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12621#discussion_r451080813", "bodyText": "cool, thanks for checking.", "author": "kasobol-msft", "createdAt": "2020-07-07T19:04:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI3NTY0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI3NjMxMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12621#discussion_r450276313", "bodyText": "Might want to add @throws to javadocs for unsupported apis.", "author": "kasobol-msft", "createdAt": "2020-07-06T14:51:06Z", "path": "sdk/storage/azure-storage-blob-nio/src/main/java/com/azure/storage/blob/nio/AzureBasicFileAttributes.java", "diffHunk": "@@ -0,0 +1,142 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.storage.blob.nio;\n+\n+import com.azure.core.util.logging.ClientLogger;\n+import com.azure.storage.blob.models.BlobProperties;\n+import com.azure.storage.blob.models.BlobStorageException;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileAttribute;\n+import java.nio.file.attribute.FileTime;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+/**\n+ * Provides support for basic file attributes.\n+ * <p>\n+ * The properties available on this type are a strict subset of {@link AzureBlobFileAttributes}, and the two types have\n+ * the same network behavior. Therefore, while this type is offered for compliance with the NIO spec,\n+ * {@link AzureBlobFileAttributes} is generally preferred.\n+ * <p>\n+ * Some attributes are not supported. Refer to the javadocs on each method for more information.\n+ * {@inheritDoc}\n+ */\n+public class AzureBasicFileAttributes implements BasicFileAttributes {\n+    private final ClientLogger logger = new ClientLogger(AzureBasicFileAttributes.class);\n+\n+    // For verifying parameters on FileSystemProvider.readAttributes\n+    static final Set<String> ATTRIBUTE_STRINGS;\n+    static {\n+        Set<String> set = new HashSet<>();\n+        set.add(\"lastModifiedTime\");\n+        set.add(\"isRegularFile\");\n+        set.add(\"isDirectory\");\n+        set.add(\"isSymbolicLink\");\n+        set.add(\"isOther\");\n+        set.add(\"size\");\n+        set.add(\"creationTime\");\n+        ATTRIBUTE_STRINGS = Collections.unmodifiableSet(set);\n+    }\n+\n+    private final BlobProperties properties;\n+\n+    /*\n+    There are some work-arounds we could do to try to accommodate virtual directories such as making a checkDirStatus\n+    call before or after getProperties to throw an appropriate error or adding an isVirtualDirectory method. However,\n+    the former wastes network time only to throw a slightly more specific error when we will throw on 404 anyway. The\n+    latter introduces virtual directories into the actual code path/api surface. While we are clear in our docs about\n+    the possible pitfalls of virtual directories, and customers should be aware of it, they shouldn't have to code\n+    against it. Therefore, we fall back to documenting that reading attributes on a virtual directory will throw. And\n+    who reads attributes on a directory anyway?\n+     */\n+    AzureBasicFileAttributes(Path path) throws IOException {\n+        try {\n+            this.properties = new AzureResource(path).getBlobClient().getProperties();\n+        } catch (BlobStorageException e) {\n+            throw LoggingUtility.logError(logger, new IOException(e));\n+        }\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public FileTime lastModifiedTime() {\n+        return FileTime.from(properties.getLastModified().toInstant());\n+    }\n+\n+    /**\n+     * Unsupported.\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public FileTime lastAccessTime() {\n+        throw new UnsupportedOperationException();", "originalCommit": "f24802627cbc3de033da2364320a04983883ccb9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI3ODIwMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12621#discussion_r450278203", "bodyText": "same question here about keeping state.", "author": "kasobol-msft", "createdAt": "2020-07-06T14:53:48Z", "path": "sdk/storage/azure-storage-blob-nio/src/main/java/com/azure/storage/blob/nio/AzureBlobFileAttributes.java", "diffHunk": "@@ -0,0 +1,290 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.storage.blob.nio;\n+\n+import com.azure.core.util.logging.ClientLogger;\n+import com.azure.storage.blob.models.AccessTier;\n+import com.azure.storage.blob.models.ArchiveStatus;\n+import com.azure.storage.blob.models.BlobHttpHeaders;\n+import com.azure.storage.blob.models.BlobProperties;\n+import com.azure.storage.blob.models.BlobStorageException;\n+import com.azure.storage.blob.models.BlobType;\n+import com.azure.storage.blob.models.CopyStatusType;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.attribute.BasicFileAttributes;\n+import java.nio.file.attribute.FileAttribute;\n+import java.nio.file.attribute.FileTime;\n+import java.time.OffsetDateTime;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.function.Supplier;\n+\n+/**\n+ * File attributes associated with a file stored as a blob in Azure Storage.\n+ * <p>\n+ * Some of the attributes inherited from {@link BasicFileAttributes} are not supported. See the docs on each method for\n+ * more information.\n+ */\n+public final class AzureBlobFileAttributes implements BasicFileAttributes {\n+    /*\n+    Some blob properties do not have getters as they do not make sense in the context of nio. These properties are:\n+        - incremental snapshot related properties\n+        - lease related properties\n+        - sequence number\n+        - encryption key sha256\n+     */\n+\n+    private final ClientLogger logger = new ClientLogger(AzureBlobFileAttributes.class);\n+\n+    private final BlobProperties properties;\n+\n+    AzureBlobFileAttributes(Path path) throws IOException {\n+        try {\n+            this.properties = new AzureResource(path).getBlobClient().getProperties();", "originalCommit": "f24802627cbc3de033da2364320a04983883ccb9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0903e534a4123fb5cdea89284dc13b60d6622b32", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0903e534a4123fb5cdea89284dc13b60d6622b32", "message": "PR feedback", "committedDate": "2020-07-07T18:51:18Z", "type": "commit"}]}