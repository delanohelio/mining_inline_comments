{"pr_number": 7337, "pr_title": "update EnvironmentCredential and azure.core.util.Configuration", "pr_createdAt": "2020-01-10T09:24:44Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/7337", "timeline": [{"oid": "c90e0cab7622ceb76e04d92e6942c24a52d0fa13", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c90e0cab7622ceb76e04d92e6942c24a52d0fa13", "message": "update EnvironmentCredentail, azure.core.utils.Configuration", "committedDate": "2020-01-10T09:24:10Z", "type": "commit"}, {"oid": "3649a83f9b9b37aa539e8f77dabd9a87e53eb4ef", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3649a83f9b9b37aa539e8f77dabd9a87e53eb4ef", "message": "added tests to EnvironmentCredentialTests", "committedDate": "2020-01-13T09:48:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzYzOTEzMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7337#discussion_r367639132", "bodyText": "Seems like we should introduce a method something like envContains(params string var) that returns true if the env contains all of the 'var's.", "author": "jongio", "createdAt": "2020-01-16T20:41:13Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/EnvironmentCredential.java", "diffHunk": "@@ -50,6 +50,22 @@\n                     configuration.get(Configuration.PROPERTY_AZURE_CLIENT_ID),\n                     configuration.get(Configuration.PROPERTY_AZURE_CLIENT_SECRET),\n                     identityClientOptions);\n+            } else if (configuration.contains(Configuration.PROPERTY_AZURE_CLIENT_ID)", "originalCommit": "3649a83f9b9b37aa539e8f77dabd9a87e53eb4ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "404d0f745c1c31508c0b0e6f9f912f123bda2ee2", "url": "https://github.com/Azure/azure-sdk-for-java/commit/404d0f745c1c31508c0b0e6f9f912f123bda2ee2", "message": "added a method to determine multiple configurations exist, updated EnvironmentCredential", "committedDate": "2020-01-17T03:05:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE0NjQ1Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7337#discussion_r368146452", "bodyText": "I'm not explicitly against this change but I do question how often it will be used outside of the context of EnvironmentCredential. Any chance this could be made into a local private method in the interim and if it is needed in additional locations in the future it gets added here.", "author": "alzimmermsft", "createdAt": "2020-01-17T21:36:41Z", "path": "sdk/core/azure-core/src/main/java/com/azure/core/util/Configuration.java", "diffHunk": "@@ -275,6 +280,21 @@ public boolean contains(String name) {\n         return configurations.containsKey(name);\n     }\n \n+    /**\n+     * Determines if multiple configurations all exist.\n+     *\n+     * @param names Names of the configuration.\n+     * @return True if configurations all exist, otherwise false.\n+     */\n+    public boolean containsAll(String... names){", "originalCommit": "404d0f745c1c31508c0b0e6f9f912f123bda2ee2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI3MTc4NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7337#discussion_r368271785", "bodyText": "Removed from Configuratoin, now a private method in EnvironmentCredential.", "author": "cxznmhdcxz", "createdAt": "2020-01-19T07:22:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE0NjQ1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE0Njk3NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7337#discussion_r368146974", "bodyText": "Is this not explicitly needed by UsernamePasswordCredential? Otherwise the validation check is missing this.", "author": "alzimmermsft", "createdAt": "2020-01-17T21:38:16Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/EnvironmentCredential.java", "diffHunk": "@@ -42,14 +42,30 @@\n     @Override\n     public Mono<AccessToken> getToken(TokenRequestContext request) {\n         return Mono.fromSupplier(() -> {\n-            if (configuration.contains(Configuration.PROPERTY_AZURE_CLIENT_ID)\n-                && configuration.contains(Configuration.PROPERTY_AZURE_CLIENT_SECRET)\n-                && configuration.contains(Configuration.PROPERTY_AZURE_TENANT_ID)) {\n+            if (configuration.containsAll(Configuration.PROPERTY_AZURE_TENANT_ID,\n+                    Configuration.PROPERTY_AZURE_CLIENT_ID,\n+                    Configuration.PROPERTY_AZURE_CLIENT_SECRET)) {\n                 // TODO: support other clouds\n                 return new ClientSecretCredential(configuration.get(Configuration.PROPERTY_AZURE_TENANT_ID),\n                     configuration.get(Configuration.PROPERTY_AZURE_CLIENT_ID),\n                     configuration.get(Configuration.PROPERTY_AZURE_CLIENT_SECRET),\n                     identityClientOptions);\n+            } else if (configuration.containsAll(Configuration.PROPERTY_AZURE_CLIENT_ID,\n+                    Configuration.PROPERTY_AZURE_TENANT_ID,\n+                    Configuration.PROPERTY_AZURE_CLIENT_CERTIFICATE_PATH)) {\n+                return new ClientCertificateCredential(configuration.get(Configuration.PROPERTY_AZURE_TENANT_ID),\n+                    configuration.get(Configuration.PROPERTY_AZURE_CLIENT_ID),\n+                    configuration.get(Configuration.PROPERTY_AZURE_CLIENT_CERTIFICATE_PATH),\n+                    null,\n+                    identityClientOptions);\n+            } else if (configuration.containsAll(Configuration.PROPERTY_AZURE_USERNAME,\n+                    Configuration.PROPERTY_AZURE_CLIENT_ID,\n+                    Configuration.PROPERTY_AZURE_PASSWORD)) {\n+                return new UsernamePasswordCredential(configuration.get(Configuration.PROPERTY_AZURE_CLIENT_ID),\n+                    configuration.get(Configuration.PROPERTY_AZURE_TENANT_ID),", "originalCommit": "404d0f745c1c31508c0b0e6f9f912f123bda2ee2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI2MTg5MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7337#discussion_r368261891", "bodyText": "No it's not, but supply it anyway (null if not set, or a tenant id if set).", "author": "cxznmhdcxz", "createdAt": "2020-01-19T03:03:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE0Njk3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE0NzQ5NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7337#discussion_r368147494", "bodyText": "Thoughts on changing the containsAll method to getAll? There are already some race condition chances going on with validating existence then retrieval, if we retrieval all into local instances we could reduce the number of timing issues happening.", "author": "alzimmermsft", "createdAt": "2020-01-17T21:39:55Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/EnvironmentCredential.java", "diffHunk": "@@ -42,14 +42,30 @@\n     @Override\n     public Mono<AccessToken> getToken(TokenRequestContext request) {\n         return Mono.fromSupplier(() -> {\n-            if (configuration.contains(Configuration.PROPERTY_AZURE_CLIENT_ID)\n-                && configuration.contains(Configuration.PROPERTY_AZURE_CLIENT_SECRET)\n-                && configuration.contains(Configuration.PROPERTY_AZURE_TENANT_ID)) {\n+            if (configuration.containsAll(Configuration.PROPERTY_AZURE_TENANT_ID,", "originalCommit": "404d0f745c1c31508c0b0e6f9f912f123bda2ee2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE0NzgxMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7337#discussion_r368147812", "bodyText": "Could we retrieve the commonly needed configuration and check those first? Seems like we could make an initial check that PROPERTY_AZURE_CLIENT_ID is set and if not just early out.", "author": "alzimmermsft", "createdAt": "2020-01-17T21:40:54Z", "path": "sdk/identity/azure-identity/src/main/java/com/azure/identity/EnvironmentCredential.java", "diffHunk": "@@ -42,14 +42,30 @@\n     @Override\n     public Mono<AccessToken> getToken(TokenRequestContext request) {\n         return Mono.fromSupplier(() -> {\n-            if (configuration.contains(Configuration.PROPERTY_AZURE_CLIENT_ID)\n-                && configuration.contains(Configuration.PROPERTY_AZURE_CLIENT_SECRET)\n-                && configuration.contains(Configuration.PROPERTY_AZURE_TENANT_ID)) {\n+            if (configuration.containsAll(Configuration.PROPERTY_AZURE_TENANT_ID,\n+                    Configuration.PROPERTY_AZURE_CLIENT_ID,\n+                    Configuration.PROPERTY_AZURE_CLIENT_SECRET)) {\n                 // TODO: support other clouds\n                 return new ClientSecretCredential(configuration.get(Configuration.PROPERTY_AZURE_TENANT_ID),\n                     configuration.get(Configuration.PROPERTY_AZURE_CLIENT_ID),\n                     configuration.get(Configuration.PROPERTY_AZURE_CLIENT_SECRET),\n                     identityClientOptions);\n+            } else if (configuration.containsAll(Configuration.PROPERTY_AZURE_CLIENT_ID,\n+                    Configuration.PROPERTY_AZURE_TENANT_ID,\n+                    Configuration.PROPERTY_AZURE_CLIENT_CERTIFICATE_PATH)) {\n+                return new ClientCertificateCredential(configuration.get(Configuration.PROPERTY_AZURE_TENANT_ID),\n+                    configuration.get(Configuration.PROPERTY_AZURE_CLIENT_ID),\n+                    configuration.get(Configuration.PROPERTY_AZURE_CLIENT_CERTIFICATE_PATH),\n+                    null,\n+                    identityClientOptions);\n+            } else if (configuration.containsAll(Configuration.PROPERTY_AZURE_USERNAME,\n+                    Configuration.PROPERTY_AZURE_CLIENT_ID,\n+                    Configuration.PROPERTY_AZURE_PASSWORD)) {\n+                return new UsernamePasswordCredential(configuration.get(Configuration.PROPERTY_AZURE_CLIENT_ID),", "originalCommit": "404d0f745c1c31508c0b0e6f9f912f123bda2ee2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE0ODQzMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7337#discussion_r368148433", "bodyText": "Could remove the local instance since Configuration uses the fluent pattern for put.", "author": "alzimmermsft", "createdAt": "2020-01-17T21:42:49Z", "path": "sdk/identity/azure-identity/src/test/java/com/azure/identity/EnvironmentCredentialTests.java", "diffHunk": "@@ -36,4 +36,46 @@ public void testCreateEnvironmentCredential() {\n             .expectNextMatches(token -> \"token\".equals(token.getToken()))\n             .verifyComplete();\n     }\n+\n+    @Test\n+    public void testCreateEnvironmentClientCertificateCredential() {\n+        Configuration configuration = Configuration.getGlobalConfiguration();", "originalCommit": "404d0f745c1c31508c0b0e6f9f912f123bda2ee2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE0ODQ4NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7337#discussion_r368148485", "bodyText": "Same as the previous comment", "author": "alzimmermsft", "createdAt": "2020-01-17T21:42:59Z", "path": "sdk/identity/azure-identity/src/test/java/com/azure/identity/EnvironmentCredentialTests.java", "diffHunk": "@@ -36,4 +36,46 @@ public void testCreateEnvironmentCredential() {\n             .expectNextMatches(token -> \"token\".equals(token.getToken()))\n             .verifyComplete();\n     }\n+\n+    @Test\n+    public void testCreateEnvironmentClientCertificateCredential() {\n+        Configuration configuration = Configuration.getGlobalConfiguration();\n+        configuration.put(Configuration.PROPERTY_AZURE_CLIENT_ID, \"foo\");\n+        configuration.put(Configuration.PROPERTY_AZURE_CLIENT_CERTIFICATE_PATH, \"bar\");\n+        configuration.put(Configuration.PROPERTY_AZURE_TENANT_ID, \"baz\");\n+\n+        EnvironmentCredential credential = new EnvironmentCredentialBuilder().build();\n+\n+        // authentication will fail client-id=foo, but should be able to create ClientSecretCredential\n+        StepVerifier.create(credential.getToken(new TokenRequestContext().addScopes(\"qux/.default\"))\n+            .doOnSuccess(s -> fail())\n+            .onErrorResume(t -> {\n+                String message = t.getMessage();\n+                Assert.assertFalse(message != null && message.contains(\"Cannot create any credentials with the current environment variables\"));\n+                return Mono.just(new AccessToken(\"token\", OffsetDateTime.MAX));\n+            }))\n+            .expectNextMatches(token -> \"token\".equals(token.getToken()))\n+            .verifyComplete();\n+    }\n+\n+    @Test\n+    public void testCreateEnvironmentUserPasswordCredential() {\n+        Configuration configuration = Configuration.getGlobalConfiguration();", "originalCommit": "404d0f745c1c31508c0b0e6f9f912f123bda2ee2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE5NTg2MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7337#discussion_r368195861", "bodyText": "NIT: I think this comment should say \"ClientCertificateCredential\" instead of \"ClientSecretCredential\"", "author": "ellismg", "createdAt": "2020-01-18T01:27:35Z", "path": "sdk/identity/azure-identity/src/test/java/com/azure/identity/EnvironmentCredentialTests.java", "diffHunk": "@@ -36,4 +36,46 @@ public void testCreateEnvironmentCredential() {\n             .expectNextMatches(token -> \"token\".equals(token.getToken()))\n             .verifyComplete();\n     }\n+\n+    @Test\n+    public void testCreateEnvironmentClientCertificateCredential() {\n+        Configuration configuration = Configuration.getGlobalConfiguration();\n+        configuration.put(Configuration.PROPERTY_AZURE_CLIENT_ID, \"foo\");\n+        configuration.put(Configuration.PROPERTY_AZURE_CLIENT_CERTIFICATE_PATH, \"bar\");\n+        configuration.put(Configuration.PROPERTY_AZURE_TENANT_ID, \"baz\");\n+\n+        EnvironmentCredential credential = new EnvironmentCredentialBuilder().build();\n+\n+        // authentication will fail client-id=foo, but should be able to create ClientSecretCredential", "originalCommit": "404d0f745c1c31508c0b0e6f9f912f123bda2ee2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE5NTkwNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7337#discussion_r368195904", "bodyText": "NIT: Similar feedback as above, I think this should be UsernamePasswordCredential in the comment.", "author": "ellismg", "createdAt": "2020-01-18T01:28:03Z", "path": "sdk/identity/azure-identity/src/test/java/com/azure/identity/EnvironmentCredentialTests.java", "diffHunk": "@@ -36,4 +36,46 @@ public void testCreateEnvironmentCredential() {\n             .expectNextMatches(token -> \"token\".equals(token.getToken()))\n             .verifyComplete();\n     }\n+\n+    @Test\n+    public void testCreateEnvironmentClientCertificateCredential() {\n+        Configuration configuration = Configuration.getGlobalConfiguration();\n+        configuration.put(Configuration.PROPERTY_AZURE_CLIENT_ID, \"foo\");\n+        configuration.put(Configuration.PROPERTY_AZURE_CLIENT_CERTIFICATE_PATH, \"bar\");\n+        configuration.put(Configuration.PROPERTY_AZURE_TENANT_ID, \"baz\");\n+\n+        EnvironmentCredential credential = new EnvironmentCredentialBuilder().build();\n+\n+        // authentication will fail client-id=foo, but should be able to create ClientSecretCredential\n+        StepVerifier.create(credential.getToken(new TokenRequestContext().addScopes(\"qux/.default\"))\n+            .doOnSuccess(s -> fail())\n+            .onErrorResume(t -> {\n+                String message = t.getMessage();\n+                Assert.assertFalse(message != null && message.contains(\"Cannot create any credentials with the current environment variables\"));\n+                return Mono.just(new AccessToken(\"token\", OffsetDateTime.MAX));\n+            }))\n+            .expectNextMatches(token -> \"token\".equals(token.getToken()))\n+            .verifyComplete();\n+    }\n+\n+    @Test\n+    public void testCreateEnvironmentUserPasswordCredential() {\n+        Configuration configuration = Configuration.getGlobalConfiguration();\n+        configuration.put(Configuration.PROPERTY_AZURE_CLIENT_ID, \"foo\");\n+        configuration.put(Configuration.PROPERTY_AZURE_USERNAME, \"bar\");\n+        configuration.put(Configuration.PROPERTY_AZURE_PASSWORD, \"baz\");\n+\n+        EnvironmentCredential credential = new EnvironmentCredentialBuilder().build();\n+\n+        // authentication will fail client-id=foo, but should be able to create ClientSecretCredential", "originalCommit": "404d0f745c1c31508c0b0e6f9f912f123bda2ee2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7faf16fec9db60ce861bd37c53841b5162a9463e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7faf16fec9db60ce861bd37c53841b5162a9463e", "message": "corrected some comments", "committedDate": "2020-01-19T06:43:39Z", "type": "commit"}, {"oid": "a3688c59d8a019a167db7b22997821a7fa408d3d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a3688c59d8a019a167db7b22997821a7fa408d3d", "message": "used fluent method calls for Configuration", "committedDate": "2020-01-19T07:13:35Z", "type": "commit"}, {"oid": "bda0741584111db11e3518bd50ef77c95f70d86c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/bda0741584111db11e3518bd50ef77c95f70d86c", "message": "now gets configuration values into local variables, and then verify", "committedDate": "2020-01-19T07:25:14Z", "type": "commit"}, {"oid": "01966edd77087a06989bc37290b77cdfd16dd6c8", "url": "https://github.com/Azure/azure-sdk-for-java/commit/01966edd77087a06989bc37290b77cdfd16dd6c8", "message": "remove unnnecessary import in test", "committedDate": "2020-01-19T07:28:46Z", "type": "commit"}, {"oid": "eb032afab61a7232533876f10b7a844adb09ae01", "url": "https://github.com/Azure/azure-sdk-for-java/commit/eb032afab61a7232533876f10b7a844adb09ae01", "message": "update javadoc comments for EnvironmentCredential", "committedDate": "2020-01-23T01:48:02Z", "type": "commit"}]}