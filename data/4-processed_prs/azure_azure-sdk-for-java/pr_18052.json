{"pr_number": 18052, "pr_title": "[Communication] - Common - Remove all Future and replace with Mono", "pr_createdAt": "2020-12-09T18:34:34Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/18052", "timeline": [{"oid": "9ced2638afcf549e8309d142c3d563b6ed274970", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9ced2638afcf549e8309d142c3d563b6ed274970", "message": "", "committedDate": "2020-12-09T03:59:23Z", "type": "commit"}, {"oid": "8ced247712ad5bee4b53025a1024a63e78366680", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8ced247712ad5bee4b53025a1024a63e78366680", "message": "Refacting Future to Mono", "committedDate": "2020-12-09T18:30:26Z", "type": "commit"}, {"oid": "6e0bcbc14cf94ca444cec4526c7e202b2ac43d17", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6e0bcbc14cf94ca444cec4526c7e202b2ac43d17", "message": "Updating BearerToken", "committedDate": "2020-12-09T18:48:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU1MTk1Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18052#discussion_r539551953", "bodyText": "This class name reads a bit funny to me. What about TokenAccessor? English is my second language though. :-)", "author": "JianpingChen", "createdAt": "2020-12-09T18:38:00Z", "path": "sdk/communication/azure-communication-common/src/main/java/com/azure/communication/common/CommunicationTokenCredential.java", "diffHunk": "@@ -92,52 +58,85 @@ public CommunicationTokenCredential(TokenRefresher tokenRefresher) {\n \n     /**\n      * Create with serialized JWT token and a token supplier to auto-refresh the\n-     * token before it expires. Callback function tokenRefresher will be called ahead\n-     * of the token expiry by the number of minutes specified by\n+     * token before it expires. Callback function tokenRefresher will be called\n+     * ahead of the token expiry by the number of minutes specified by\n      * CallbackOffsetMinutes defaulted to two minutes. To modify this default, call\n      * setCallbackOffsetMinutes after construction\n      * \n      * @param tokenRefresher implementation to supply fresh token when reqested\n      * @param initialToken serialized JWT token\n-     * @param refreshProactively when set to true, turn on proactive fetching to\n-     *                           call tokenRefresher before token expiry by minutes\n-     *                           set with setCallbackOffsetMinutes or default value\n-     *                           of two minutes\n+     * @param refreshProactively when set to true, turn on proactive fetching to call\n+     *                           tokenRefresher before token expiry by minutes set\n+     *                           with setCallbackOffsetMinutes or default value of\n+     *                           two minutes\n      */\n-    public CommunicationTokenCredential(\n-        TokenRefresher tokenRefresher, \n-        String initialToken,\n-        boolean refreshProactively) \n-    {\n+    public CommunicationTokenCredential(TokenRefresher tokenRefresher, String initialToken,\n+            boolean refreshProactively) {\n         this(tokenRefresher);\n         Objects.requireNonNull(initialToken, \"'initialToken' cannot be null.\");\n         setToken(initialToken);\n-        tokenFuture = new TokenImmediate(accessToken);\n         if (refreshProactively) {\n             OffsetDateTime nextFetchTime = accessToken.getExpiresAt().minusMinutes(DEFAULT_EXPIRING_OFFSET_MINUTES);\n             fetchingTask = new FetchingTask(this, nextFetchTime);\n         }\n     }\n \n+    private class TokenNext extends Mono<AccessToken> {", "originalCommit": "8ced247712ad5bee4b53025a1024a63e78366680", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY0OTA4Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18052#discussion_r539649082", "bodyText": "Updated to TokenRetriever, hope that makes sense too", "author": "minnieliu", "createdAt": "2020-12-09T21:09:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU1MTk1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU1NzM3Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18052#discussion_r539557372", "bodyText": "This is a public interface. IMHO, we'd need a better name. getTokenAsync?", "author": "JianpingChen", "createdAt": "2020-12-09T18:45:59Z", "path": "sdk/communication/azure-communication-common/src/main/java/com/azure/communication/common/TokenRefresher.java", "diffHunk": "@@ -12,5 +12,5 @@\n      * Asynchronous call to fetch a fresh token\n      * @return Wrapper for asynchronous call\n      */\n-    Future<String> getFetchTokenFuture();\n+    Mono<String> getFetchTokenNext();", "originalCommit": "8ced247712ad5bee4b53025a1024a63e78366680", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY0OTIwNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18052#discussion_r539649204", "bodyText": "Updated to getTokenAsync", "author": "minnieliu", "createdAt": "2020-12-09T21:09:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU1NzM3Mg=="}], "type": "inlineReview"}, {"oid": "0597a83d4af0423d9053d038c40c8a49affdc9f6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0597a83d4af0423d9053d038c40c8a49affdc9f6", "message": "Addressing Code Review comments", "committedDate": "2020-12-09T20:10:18Z", "type": "commit"}, {"oid": "8721da916072e3c5f4d7f8b24ec14d65cb41c924", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8721da916072e3c5f4d7f8b24ec14d65cb41c924", "message": "Fix naming", "committedDate": "2020-12-09T21:02:37Z", "type": "commit"}, {"oid": "0c9a900769c1befb4aa41ea4452700ed0f26d12c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0c9a900769c1befb4aa41ea4452700ed0f26d12c", "message": "Fix spotbug", "committedDate": "2020-12-09T21:23:35Z", "type": "commit"}, {"oid": "c375cfcce64448c97b6dc6e9b8d21e609b045819", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c375cfcce64448c97b6dc6e9b8d21e609b045819", "message": "Fix spotbug", "committedDate": "2020-12-09T22:00:58Z", "type": "commit"}, {"oid": "ca40ea269a9e02fffc9bfb11445a7b79d6430d1a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ca40ea269a9e02fffc9bfb11445a7b79d6430d1a", "message": "Fix spotbug", "committedDate": "2020-12-09T22:17:01Z", "type": "commit"}, {"oid": "3635735a19228466197b5339be738e1ec8747ae1", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3635735a19228466197b5339be738e1ec8747ae1", "message": "Fix spotbug", "committedDate": "2020-12-09T22:35:33Z", "type": "commit"}, {"oid": "63acc8dde62d5cbcae0a590e32de664beeaca28c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/63acc8dde62d5cbcae0a590e32de664beeaca28c", "message": "Updating changelog", "committedDate": "2020-12-09T23:13:15Z", "type": "commit"}, {"oid": "9cacbfa6e5f3c40ccd3c92cc42e07fd196686d96", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9cacbfa6e5f3c40ccd3c92cc42e07fd196686d96", "message": "Refactor PR", "committedDate": "2020-12-10T01:07:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM5Nzg3Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18052#discussion_r540397877", "bodyText": "We have a SimpleTokenCache that can be used here. It refreshes the token when it expires and also ensures that the refresh happens only once after each expiration period.", "author": "srnagar", "createdAt": "2020-12-10T18:24:45Z", "path": "sdk/communication/azure-communication-common/src/main/java/com/azure/communication/common/CommunicationTokenCredential.java", "diffHunk": "@@ -92,52 +55,54 @@ public CommunicationTokenCredential(TokenRefresher tokenRefresher) {\n \n     /**\n      * Create with serialized JWT token and a token supplier to auto-refresh the\n-     * token before it expires. Callback function tokenRefresher will be called ahead\n-     * of the token expiry by the number of minutes specified by\n+     * token before it expires. Callback function tokenRefresher will be called\n+     * ahead of the token expiry by the number of minutes specified by\n      * CallbackOffsetMinutes defaulted to two minutes. To modify this default, call\n      * setCallbackOffsetMinutes after construction\n      * \n      * @param tokenRefresher implementation to supply fresh token when reqested\n      * @param initialToken serialized JWT token\n-     * @param refreshProactively when set to true, turn on proactive fetching to\n-     *                           call tokenRefresher before token expiry by minutes\n-     *                           set with setCallbackOffsetMinutes or default value\n-     *                           of two minutes\n+     * @param refreshProactively when set to true, turn on proactive fetching to call\n+     *                           tokenRefresher before token expiry by minutes set\n+     *                           with setCallbackOffsetMinutes or default value of\n+     *                           two minutes\n      */\n-    public CommunicationTokenCredential(\n-        TokenRefresher tokenRefresher, \n-        String initialToken,\n-        boolean refreshProactively) \n-    {\n+    public CommunicationTokenCredential(TokenRefresher tokenRefresher, String initialToken,\n+            boolean refreshProactively) {\n         this(tokenRefresher);\n         Objects.requireNonNull(initialToken, \"'initialToken' cannot be null.\");\n         setToken(initialToken);\n-        tokenFuture = new TokenImmediate(accessToken);\n         if (refreshProactively) {\n             OffsetDateTime nextFetchTime = accessToken.getExpiresAt().minusMinutes(DEFAULT_EXPIRING_OFFSET_MINUTES);\n             fetchingTask = new FetchingTask(this, nextFetchTime);\n         }\n     }\n \n+\n     /**\n      * Get Azure core access token from credential\n      * \n      * @return Asynchronous call to fetch actual token\n      * @throws ExecutionException when supplier throws this exception\n      * @throws InterruptedException when supplier throws this exception\n      */\n-    public Future<AccessToken> getToken() throws InterruptedException, ExecutionException {\n+    public Mono<AccessToken> getToken() throws InterruptedException, ExecutionException {\n         if (isClosed) {\n             throw logger.logExceptionAsError(\n                 new RuntimeException(\"getToken called on closed CommunicationTokenCredential object\"));\n         }\n-        if ((accessToken == null || accessToken.isExpired()) // no valid token to return\n-            && refresher != null // can refresh\n-            && (tokenFuture == null || tokenFuture.isDone())) { // no fetching in progress, proactive or on-demand \n-            fetchFreshToken();\n+        synchronized (this) {\n+            // no valid token to return and can refresh\n+            if ((accessToken == null || accessToken.isExpired()) && refresher != null) {\n+                return fetchFreshToken()\n+                    .map(token -> {\n+                        accessToken = tokenParser.parseJWTToken(token);\n+                        return accessToken;\n+                    });\n+                \n+            }\n+            return Mono.just(accessToken);", "originalCommit": "9cacbfa6e5f3c40ccd3c92cc42e07fd196686d96", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bf63ccf4921469fae685c3ae579edf22feac73cb", "url": "https://github.com/Azure/azure-sdk-for-java/commit/bf63ccf4921469fae685c3ae579edf22feac73cb", "message": "Implementing double check locking", "committedDate": "2020-12-10T19:59:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU4ODkyNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/18052#discussion_r540588925", "bodyText": "As discussed, return a Mono.error() here instead of throwing an exception.", "author": "srnagar", "createdAt": "2020-12-10T23:57:50Z", "path": "sdk/communication/azure-communication-common/src/main/java/com/azure/communication/common/CommunicationTokenCredential.java", "diffHunk": "@@ -92,52 +55,55 @@ public CommunicationTokenCredential(TokenRefresher tokenRefresher) {\n \n     /**\n      * Create with serialized JWT token and a token supplier to auto-refresh the\n-     * token before it expires. Callback function tokenRefresher will be called ahead\n-     * of the token expiry by the number of minutes specified by\n+     * token before it expires. Callback function tokenRefresher will be called\n+     * ahead of the token expiry by the number of minutes specified by\n      * CallbackOffsetMinutes defaulted to two minutes. To modify this default, call\n      * setCallbackOffsetMinutes after construction\n      * \n      * @param tokenRefresher implementation to supply fresh token when reqested\n      * @param initialToken serialized JWT token\n-     * @param refreshProactively when set to true, turn on proactive fetching to\n-     *                           call tokenRefresher before token expiry by minutes\n-     *                           set with setCallbackOffsetMinutes or default value\n-     *                           of two minutes\n+     * @param refreshProactively when set to true, turn on proactive fetching to call\n+     *                           tokenRefresher before token expiry by minutes set\n+     *                           with setCallbackOffsetMinutes or default value of\n+     *                           two minutes\n      */\n-    public CommunicationTokenCredential(\n-        TokenRefresher tokenRefresher, \n-        String initialToken,\n-        boolean refreshProactively) \n-    {\n+    public CommunicationTokenCredential(TokenRefresher tokenRefresher, String initialToken,\n+            boolean refreshProactively) {\n         this(tokenRefresher);\n         Objects.requireNonNull(initialToken, \"'initialToken' cannot be null.\");\n         setToken(initialToken);\n-        tokenFuture = new TokenImmediate(accessToken);\n         if (refreshProactively) {\n             OffsetDateTime nextFetchTime = accessToken.getExpiresAt().minusMinutes(DEFAULT_EXPIRING_OFFSET_MINUTES);\n             fetchingTask = new FetchingTask(this, nextFetchTime);\n         }\n     }\n \n+\n     /**\n      * Get Azure core access token from credential\n      * \n      * @return Asynchronous call to fetch actual token\n      * @throws ExecutionException when supplier throws this exception\n      * @throws InterruptedException when supplier throws this exception\n      */\n-    public Future<AccessToken> getToken() throws InterruptedException, ExecutionException {\n+    public Mono<AccessToken> getToken() throws InterruptedException, ExecutionException {\n         if (isClosed) {\n             throw logger.logExceptionAsError(\n                 new RuntimeException(\"getToken called on closed CommunicationTokenCredential object\"));\n         }", "originalCommit": "bf63ccf4921469fae685c3ae579edf22feac73cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b32ceca1ec66575d44a8b3fabfebe932548058ed", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b32ceca1ec66575d44a8b3fabfebe932548058ed", "message": "Updating error handling", "committedDate": "2020-12-11T00:06:54Z", "type": "commit"}, {"oid": "deca040f8d6b33a1ee422942eae1e5d545431a74", "url": "https://github.com/Azure/azure-sdk-for-java/commit/deca040f8d6b33a1ee422942eae1e5d545431a74", "message": "Updating error handling", "committedDate": "2020-12-11T00:17:45Z", "type": "commit"}, {"oid": "c3df690de4e42a4e169f7b9cd0d29000edfc3e71", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c3df690de4e42a4e169f7b9cd0d29000edfc3e71", "message": "Update tests with StepVerifier", "committedDate": "2020-12-11T01:44:13Z", "type": "commit"}]}