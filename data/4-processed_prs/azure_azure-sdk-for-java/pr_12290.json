{"pr_number": 12290, "pr_title": "CI pipeline support for ctl image build ", "pr_createdAt": "2020-06-17T14:23:03Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/12290", "timeline": [{"oid": "52456302bcf814723bc2224f020b94abfac70200", "url": "https://github.com/Azure/azure-sdk-for-java/commit/52456302bcf814723bc2224f020b94abfac70200", "message": "Adding docker build image configuration for ctl run", "committedDate": "2020-06-15T16:22:47Z", "type": "commit"}, {"oid": "9d7c270b35bf5fbba237e7359c5b755cfe658dfc", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9d7c270b35bf5fbba237e7359c5b755cfe658dfc", "message": "moving jar to ctl folder", "committedDate": "2020-06-15T17:41:23Z", "type": "commit"}, {"oid": "ef556519bc653958f8bc487cadf2d8e0ef88d1e7", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ef556519bc653958f8bc487cadf2d8e0ef88d1e7", "message": "changing config", "committedDate": "2020-06-15T18:49:00Z", "type": "commit"}, {"oid": "c71695ef042519f68074b00e8d03d37b90d39b87", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c71695ef042519f68074b00e8d03d37b90d39b87", "message": "changing config", "committedDate": "2020-06-15T18:57:44Z", "type": "commit"}, {"oid": "9d4b84e7b2527c8adce15d3a9b64521465b99448", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9d4b84e7b2527c8adce15d3a9b64521465b99448", "message": "changing config", "committedDate": "2020-06-15T20:53:19Z", "type": "commit"}, {"oid": "951ac8f60a53389bb6718a1c88d621505cd5fefc", "url": "https://github.com/Azure/azure-sdk-for-java/commit/951ac8f60a53389bb6718a1c88d621505cd5fefc", "message": "changing config", "committedDate": "2020-06-15T21:00:45Z", "type": "commit"}, {"oid": "56332fa11e71b82b1364f6b83e5ae2f906d6eab6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/56332fa11e71b82b1364f6b83e5ae2f906d6eab6", "message": "testing for trigger and ci", "committedDate": "2020-06-16T21:30:25Z", "type": "commit"}, {"oid": "490b067f177d7e178ac2e5b84271077485640d55", "url": "https://github.com/Azure/azure-sdk-for-java/commit/490b067f177d7e178ac2e5b84271077485640d55", "message": "testing for trigger and ci", "committedDate": "2020-06-16T21:37:50Z", "type": "commit"}, {"oid": "e850cf88c237707dd3765b01ce3cd0b4cf900742", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e850cf88c237707dd3765b01ce3cd0b4cf900742", "message": "testing for trigger and ci", "committedDate": "2020-06-16T21:42:25Z", "type": "commit"}, {"oid": "4a6524d5acc35282e77bd6d359e097ea85c877a8", "url": "https://github.com/Azure/azure-sdk-for-java/commit/4a6524d5acc35282e77bd6d359e097ea85c877a8", "message": "formating change", "committedDate": "2020-06-17T14:10:56Z", "type": "commit"}, {"oid": "ccbb5dec09839538480c649a9354b8f1ec4e52b8", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ccbb5dec09839538480c649a9354b8f1ec4e52b8", "message": "formating change", "committedDate": "2020-06-17T14:19:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYxODc0Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12290#discussion_r441618743", "bodyText": "Docket image nees to be build from benchamrk target folder right?", "author": "kirankumarkolli", "createdAt": "2020-06-17T15:06:48Z", "path": "sdk/cosmos/azure-cosmos-benchmark/ctl/Dockerfile", "diffHunk": "@@ -0,0 +1,7 @@\n+FROM ubuntu:18.04\n+RUN apt-get update && apt-get install -y openjdk-8-jdk net-tools vim\n+COPY ./run_benchmark.sh /usr/app/\n+COPY ./azure-cosmos-benchmark-jar-with-dependencies.jar /usr/app/", "originalCommit": "ccbb5dec09839538480c649a9354b8f1ec4e52b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYyMTI3OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12290#discussion_r441621279", "bodyText": "Building code and build image are two separate task, so we have copy task which bring the jar and docker config files in one folder before we build docker . Please refer the CI sent offline", "author": "simplynaveen20", "createdAt": "2020-06-17T15:09:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYxODc0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYxOTc5NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12290#discussion_r441619794", "bodyText": "Can the docker publishing and consuming latest also be automated?", "author": "kirankumarkolli", "createdAt": "2020-06-17T15:08:03Z", "path": "sdk/cosmos/azure-cosmos-benchmark/ctl/Dockerfile", "diffHunk": "@@ -0,0 +1,7 @@\n+FROM ubuntu:18.04", "originalCommit": "ccbb5dec09839538480c649a9354b8f1ec4e52b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYyMDA5Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12290#discussion_r441620096", "bodyText": "Is that the test CI referred in IM?", "author": "kirankumarkolli", "createdAt": "2020-06-17T15:08:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYxOTc5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY0NDIyNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12290#discussion_r441644226", "bodyText": "We could use \"FROM ubuntu:latest\" which will bring ubuntu:18.04 which is current latest LTS version.\nI still prefer mentioning version , so when we change it manually and see some different result we can relate to the version change.", "author": "simplynaveen20", "createdAt": "2020-06-17T15:42:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYxOTc5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY2OTQwNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12290#discussion_r441669407", "bodyText": "Didn't we have an existing jar-with-dependencies plugin already ?\nWhy can't we use the existing one instead of creating another one here ?", "author": "kushagraThapar", "createdAt": "2020-06-17T16:21:41Z", "path": "sdk/cosmos/azure-cosmos-benchmark/pom.xml", "diffHunk": "@@ -477,6 +477,25 @@ Licensed under the MIT License.\n                   </archive>\n                 </configuration>\n               </execution>\n+              <execution>\n+                <id>make-assembly-ctl</id>\n+                <phase>package</phase>\n+                <goals>\n+                  <goal>single</goal>\n+                </goals>\n+                <configuration>\n+                  <descriptorRefs>\n+                    <descriptorRef>jar-with-dependencies</descriptorRef>\n+                  </descriptorRefs>\n+                  <outputDirectory>${project.build.directory}/ctl</outputDirectory>", "originalCommit": "ccbb5dec09839538480c649a9354b8f1ec4e52b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY3MjMwNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12290#discussion_r441672306", "bodyText": "Yes we could use that , but it has version in it . And docker script need exact file name to run. Either i change the existing name to static without version in it . But in doing so devs who compare benchmark across different version , it would be difficult for them to maintain or they have to rename the jar each time.", "author": "simplynaveen20", "createdAt": "2020-06-17T16:26:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY2OTQwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ0NDI0Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12290#discussion_r442444243", "bodyText": "Can wildcard copy followed by move leveraged?", "author": "kirankumarkolli", "createdAt": "2020-06-18T19:10:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY2OTQwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUwODE5MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12290#discussion_r442508190", "bodyText": "We can use wild card while copy , but script while running need exact name", "author": "simplynaveen20", "createdAt": "2020-06-18T21:18:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY2OTQwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUxMDA1OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12290#discussion_r442510058", "bodyText": "I also agree with Kushagra's point, if we can we should avoid duplicating the build config for the uber jar.\n@simplynaveen20 in your dockerfile,  you can have a command to discover the jar file name and then copy it to /usr/app/azure-cosmos-benchmark-jar-with-dependencies.jar\nisn't that possible?", "author": "moderakh", "createdAt": "2020-06-18T21:22:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY2OTQwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUyMjEyMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12290#discussion_r442522120", "bodyText": "Done", "author": "simplynaveen20", "createdAt": "2020-06-18T21:50:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY2OTQwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcwNTcxNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12290#discussion_r441705716", "bodyText": "please follow bash code style for naming variables\nhttps://google.github.io/styleguide/shellguide.html#s7-naming-conventions", "author": "moderakh", "createdAt": "2020-06-17T17:21:53Z", "path": "sdk/cosmos/azure-cosmos-benchmark/ctl/run_benchmark.sh", "diffHunk": "@@ -0,0 +1,74 @@\n+#!/bin/bash\n+\n+serviceEndpoint=$Endpoint", "originalCommit": "ccbb5dec09839538480c649a9354b8f1ec4e52b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc3MTE1Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12290#discussion_r441771153", "bodyText": "Yes left hand side we can do i.e. serviceEndpoint -> service_endpoint . However right hand side are docker env  variables which does not have as such naming convention mention on docker docs. Also we already have contract established with CTL on those. So If you have strong opinion on docker env  variables please let me know", "author": "simplynaveen20", "createdAt": "2020-06-17T19:05:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcwNTcxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgxMjY0MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12290#discussion_r441812641", "bodyText": "Naveen I am referring to all variable names in this file. we should follow the bash code style.", "author": "moderakh", "createdAt": "2020-06-17T20:26:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcwNTcxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg0MTY2OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12290#discussion_r441841668", "bodyText": "I know , i was trying to avoid those convention on env variable from docker, as it involve updating scripts on ctl . Anyway I did that now , will contact ctl team", "author": "simplynaveen20", "createdAt": "2020-06-17T21:21:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcwNTcxNg=="}], "type": "inlineReview"}, {"oid": "597cb2e03e15b494204919af94a2dd41419820fc", "url": "https://github.com/Azure/azure-sdk-for-java/commit/597cb2e03e15b494204919af94a2dd41419820fc", "message": "using sheel script naming convention for variables", "committedDate": "2020-06-17T21:02:38Z", "type": "commit"}, {"oid": "50c9d892bb84f622c0754770d951624157288527", "url": "https://github.com/Azure/azure-sdk-for-java/commit/50c9d892bb84f622c0754770d951624157288527", "message": "formatting names", "committedDate": "2020-06-17T21:20:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQzMzUyMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12290#discussion_r442433521", "bodyText": "any reason we are going with 2gb? the perf test I do are based on 8gb.", "author": "moderakh", "createdAt": "2020-06-18T18:50:44Z", "path": "sdk/cosmos/azure-cosmos-benchmark/ctl/run_benchmark.sh", "diffHunk": "@@ -0,0 +1,74 @@\n+#!/bin/bash\n+\n+service_endpoint=$ctl_endpoint\n+master_key=$ctl_key\n+\n+if [ -z \"$ctl_operation\" ]\n+then\n+operation=ReadLatency\n+else\n+operation=$ctl_operation\n+fi\n+\n+if [ -z \"$ctl_concurrency\" ]\n+then\n+concurrency=50\n+else\n+concurrency=$ctl_concurrency\n+fi\n+\n+if [ -z \"$ctl_consistency_level\" ]\n+then\n+consistency_level=Eventual\n+else\n+consistency_level=$ctl_consistency_level\n+fi\n+\n+if [ -z \"$ctl_number_of_operations\" ]\n+then\n+number_of_operations=-1\n+else\n+number_of_operations=$ctl_number_of_operations\n+fi\n+\n+if [ -z \"$ctl_max_running_time_duration\" ]\n+then\n+max_running_time_duration=PT10H\n+else\n+max_running_time_duration=$ctl_max_running_time_duration\n+fi\n+\n+connection_mode=Direct\n+number_of_precreated_documents=1000\n+gateway_connection_poolsize=5\n+\n+protocol=Tcp\n+\n+col_name=\"testCol\"\n+db_name=\"testdb\"\n+\n+log_filename=\"/tmp/javactl.log\"\n+\n+echo \"log file name is $log_filename\"\n+\n+echo \"serviceEndpoint $service_endpoint, colNmae $col_name operation: $operation, consistencyLevel: $consistency_level, connectionMode: $connection_mode, protocol: $protocol, concurrency: $concurrency\" > $log_filename\n+start=`test \"x$1\" == x && date +%s`\n+jar_file=./azure-cosmos-benchmark-jar-with-dependencies.jar\n+\n+jvm_opt=\"\"\n+#jvm_opt='-Dazure.cosmos.rntbd.threadcount=16 -Dazure.cosmos.directTcp.defaultOptions={\"maxRequestsPerChannel\":10}'\n+additional_benchmark_options=\"\" \n+additional_benchmark_options=\"-documentDataFieldSize 10 -documentDataFieldCount 10\" \n+additional_benchmark_options=\"$additional_benchmark_options -maxConnectionPoolSize $gateway_connection_poolsize\"\n+\n+if [ -z \"$ctl_graphite_endpoint\" ]\n+then\n+java -Xmx2g -Xms2g  $jvm_opt -Dcosmos.directModeProtocol=$protocol -Dazure.cosmos.directModeProtocol=$protocol -jar \"$jar_file\" -serviceEndpoint \"$service_endpoint\" -masterKey \"$master_key\" -databaseId \"$db_name\"  -collectionId \"$col_name\" -consistencyLevel $consistency_level -concurrency $concurrency -numberOfOperations $number_of_operations -operation $operation -connectionMode $connection_mode -maxRunningTimeDuration $max_running_time_duration -numberOfPreCreatedDocuments $number_of_precreated_documents $additional_benchmark_options 2>&1 | tee -a \"$log_filename\"", "originalCommit": "50c9d892bb84f622c0754770d951624157288527", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUyMjYzMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12290#discussion_r442522632", "bodyText": "It was simple work load as of now, and we don't have big cache . But no harm in making it at 8gb to have one standard number. Changed it", "author": "simplynaveen20", "createdAt": "2020-06-18T21:52:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQzMzUyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQzNDIwNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12290#discussion_r442434206", "bodyText": "any reason we are removing the log messages?", "author": "moderakh", "createdAt": "2020-06-18T18:52:02Z", "path": "sdk/cosmos/azure-cosmos-benchmark/src/main/java/com/azure/cosmos/benchmark/AsyncBenchmark.java", "diffHunk": "@@ -84,9 +84,7 @@\n \n         try {\n             cosmosAsyncDatabase = cosmosClient.getDatabase(this.configuration.getDatabaseId());\n-            cosmosAsyncDatabase.read().doOnError(error ->\n-                logger.error(\"Database {} creation failed due to \", this.configuration.getDatabaseId(), error)", "originalCommit": "50c9d892bb84f622c0754770d951624157288527", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUyMzg5NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12290#discussion_r442523895", "bodyText": "It was mistakenly added in David's PR. This is normal flow, no error log needed . If user didn't  have the db/container available benchmark will create it for them.", "author": "simplynaveen20", "createdAt": "2020-06-18T21:55:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQzNDIwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQzOTA5NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12290#discussion_r442439095", "bodyText": "general idea on setting number_of_precreated_documents is that we should ensure on each BE partition at least there is a few document to read from (this would be a factor of Collection Throughput, partition splitting etc).\nprobably 1000 is good enough but to be safe can we set this to something higher (10,000) maybe?", "author": "moderakh", "createdAt": "2020-06-18T19:00:41Z", "path": "sdk/cosmos/azure-cosmos-benchmark/ctl/run_benchmark.sh", "diffHunk": "@@ -0,0 +1,74 @@\n+#!/bin/bash\n+\n+service_endpoint=$ctl_endpoint\n+master_key=$ctl_key\n+\n+if [ -z \"$ctl_operation\" ]\n+then\n+operation=ReadLatency\n+else\n+operation=$ctl_operation\n+fi\n+\n+if [ -z \"$ctl_concurrency\" ]\n+then\n+concurrency=50\n+else\n+concurrency=$ctl_concurrency\n+fi\n+\n+if [ -z \"$ctl_consistency_level\" ]\n+then\n+consistency_level=Eventual\n+else\n+consistency_level=$ctl_consistency_level\n+fi\n+\n+if [ -z \"$ctl_number_of_operations\" ]\n+then\n+number_of_operations=-1\n+else\n+number_of_operations=$ctl_number_of_operations\n+fi\n+\n+if [ -z \"$ctl_max_running_time_duration\" ]\n+then\n+max_running_time_duration=PT10H\n+else\n+max_running_time_duration=$ctl_max_running_time_duration\n+fi\n+\n+connection_mode=Direct\n+number_of_precreated_documents=1000", "originalCommit": "50c9d892bb84f622c0754770d951624157288527", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUyMjY4NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12290#discussion_r442522685", "bodyText": "Done", "author": "simplynaveen20", "createdAt": "2020-06-18T21:52:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQzOTA5NQ=="}], "type": "inlineReview"}, {"oid": "554092cb6e6574a6464f007b0ee45ab8d8abc19f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/554092cb6e6574a6464f007b0ee45ab8d8abc19f", "message": "resolving comments", "committedDate": "2020-06-18T21:42:00Z", "type": "commit"}]}