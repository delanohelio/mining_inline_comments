{"pr_number": 14990, "pr_title": "Force closes links when connection is closed so it requests another link.", "pr_createdAt": "2020-09-09T19:39:04Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/14990", "timeline": [{"oid": "1b10fd55cf95456aa4410dee467b8e8cb78d402d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1b10fd55cf95456aa4410dee467b8e8cb78d402d", "message": "Locally closing on connection error.", "committedDate": "2020-09-09T21:34:28Z", "type": "forcePushed"}, {"oid": "3ecd4390eee221bbef3ce518fff198fffb57b4b3", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3ecd4390eee221bbef3ce518fff198fffb57b4b3", "message": "Remove unneeded retryuntils", "committedDate": "2020-09-10T05:43:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg3MDk0Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14990#discussion_r485870946", "bodyText": "Delete empty class.", "author": "srnagar", "createdAt": "2020-09-09T19:41:29Z", "path": "sdk/core/azure-core-amqp/src/test/java/com/azure/core/amqp/implementation/handler/ReceiveLinkHandlerTest.java", "diffHunk": "@@ -0,0 +1,10 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.amqp.implementation.handler;\n+\n+/**\n+ * Tests for {@link ReceiveLinkHandler}.\n+ */\n+class ReceiveLinkHandlerTest {", "originalCommit": "091b1f3eaa4b20238475c75aed79c5693c4b59b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjE5MDg0NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14990#discussion_r486190844", "bodyText": "Oh yes. This should have tests in it.", "author": "conniey", "createdAt": "2020-09-10T09:18:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg3MDk0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk3ODI5NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14990#discussion_r485978295", "bodyText": "Just curious if we need to cache the last event?", "author": "srnagar", "createdAt": "2020-09-09T23:35:22Z", "path": "sdk/core/azure-core-amqp/src/main/java/com/azure/core/amqp/implementation/ReactorConnection.java", "diffHunk": "@@ -106,23 +107,12 @@ public ReactorConnection(String connectionId, ConnectionOptions connectionOption\n         this.connectionMono = Mono.fromCallable(this::getOrCreateConnection)\n             .doOnSubscribe(c -> hasConnection.set(true));\n \n-        this.subscriptions = Disposables.composite(\n-            this.handler.getEndpointStates().subscribe(\n-                state -> {\n-                    logger.verbose(\"connectionId[{}]: Connection state: {}\", connectionId, state);\n-                    endpointStatesSink.next(AmqpEndpointStateUtil.getConnectionState(state));\n-                }, error -> {\n-                    logger.error(\"connectionId[{}] Error occurred in connection endpoint.\", connectionId, error);\n-                    endpointStatesSink.error(error);\n-                }, () -> {\n-                    endpointStatesSink.next(AmqpEndpointState.CLOSED);\n-                    endpointStatesSink.complete();\n-                }),\n-\n-            this.handler.getErrors().subscribe(error -> {\n-                logger.error(\"connectionId[{}] Error occurred in connection handler.\", connectionId, error);\n-                endpointStatesSink.error(error);\n-            }));\n+        this.endpointStates = this.handler.getEndpointStates()\n+            .takeUntilOther(shutdownSignals)\n+            .map(state -> {\n+                logger.verbose(\"connectionId[{}]: State {}\", connectionId, state);\n+                return AmqpEndpointStateUtil.getConnectionState(state);\n+            }).subscribeWith(ReplayProcessor.cacheLastOrDefault(AmqpEndpointState.UNINITIALIZED));", "originalCommit": "99b13b380fae5db73af433724a773d59c19418a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk3ODg4NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14990#discussion_r485978885", "bodyText": "Nice! Although, I haven't observed duplicates here generally but this is a nice improvement!", "author": "srnagar", "createdAt": "2020-09-09T23:37:35Z", "path": "sdk/core/azure-core-amqp/src/main/java/com/azure/core/amqp/implementation/ReactorReceiver.java", "diffHunk": "@@ -69,43 +67,28 @@ protected ReactorReceiver(String entityPath, Receiver receiver, ReceiveLinkHandl\n                 }\n             })\n             .subscribeWith(EmitterProcessor.create());\n-\n-        this.subscriptions = Disposables.composite(\n-            this.handler.getEndpointStates().subscribe(\n-                state -> {\n-                    logger.verbose(\"Connection state: {}\", state);\n-                    endpointStateSink.next(AmqpEndpointStateUtil.getConnectionState(state));\n-                }, error -> {\n-                    logger.error(\"connectionId[{}] linkName[{}] entityPath[{}] Error occurred in connection.\",\n-                        handler.getConnectionId(), receiver.getName(), entityPath, error);\n-                    endpointStateSink.error(error);\n-                    dispose();\n-                }, () -> {\n-                    endpointStateSink.next(AmqpEndpointState.CLOSED);\n-                    dispose();\n-                }),\n-\n-            this.handler.getErrors().subscribe(error -> {\n-                logger.error(\"connectionId[{}] linkName[{}] entityPath[{}] Error occurred in link.\",\n-                    handler.getConnectionId(), receiver.getName(), entityPath, error);\n-                endpointStateSink.error(error);\n-                dispose();\n-            }),\n-\n-            this.tokenManager.getAuthorizationResults().subscribe(\n-                response -> {\n-                    logger.verbose(\"Token refreshed: {}\", response);\n-                    hasAuthorized.set(true);\n-                }, error -> {\n-                    logger.info(\"connectionId[{}], path[{}], linkName[{}] - tokenRenewalFailure[{}]\",\n-                        handler.getConnectionId(), this.entityPath, getLinkName(), error.getMessage());\n-                    hasAuthorized.set(false);\n-                }, () -> hasAuthorized.set(false)));\n+        this.endpointStates = this.handler.getEndpointStates()\n+            .map(state -> {\n+                logger.verbose(\"connectionId[{}], path[{}], linkName[{}]: State {}\", handler.getConnectionId(),\n+                    entityPath, getLinkName(), state);\n+                return AmqpEndpointStateUtil.getConnectionState(state);\n+            })\n+            .subscribeWith(ReplayProcessor.cacheLastOrDefault(AmqpEndpointState.UNINITIALIZED));\n+\n+        this.subscriptions = this.tokenManager.getAuthorizationResults().subscribe(\n+            response -> {\n+                logger.verbose(\"Token refreshed: {}\", response);\n+                hasAuthorized.set(true);\n+            }, error -> {\n+                logger.info(\"connectionId[{}], path[{}], linkName[{}] - tokenRenewalFailure[{}]\",\n+                    handler.getConnectionId(), this.entityPath, getLinkName(), error.getMessage());\n+                hasAuthorized.set(false);\n+            }, () -> hasAuthorized.set(false));\n     }\n \n     @Override\n     public Flux<AmqpEndpointState> getEndpointStates() {\n-        return endpointStates;\n+        return endpointStates.distinct();", "originalCommit": "99b13b380fae5db73af433724a773d59c19418a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk3OTc2Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14990#discussion_r485979763", "bodyText": "should this be private or protected? We already have a dispose() that's public and implements the interface method.", "author": "srnagar", "createdAt": "2020-09-09T23:40:35Z", "path": "sdk/core/azure-core-amqp/src/main/java/com/azure/core/amqp/implementation/ReactorSender.java", "diffHunk": "@@ -293,13 +283,35 @@ public boolean isDisposed() {\n \n     @Override\n     public void dispose() {\n+        dispose(null);\n+    }\n+\n+    /**\n+     * Disposes of the sender when an exception is encountered.\n+     *\n+     * @param errorCondition Error condition associated with close operation.\n+     */\n+    public void dispose(ErrorCondition errorCondition) {", "originalCommit": "99b13b380fae5db73af433724a773d59c19418a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjE5MjczOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14990#discussion_r486192738", "bodyText": "This dispose was if we had to close the connection because of an error. :/ I expected the dispose() to be used when it is closed normally. Let me update this to package-private.", "author": "conniey", "createdAt": "2020-09-10T09:21:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk3OTc2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk4MDMzMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/14990#discussion_r485980333", "bodyText": "Empty test can be removed", "author": "srnagar", "createdAt": "2020-09-09T23:42:29Z", "path": "sdk/core/azure-core-amqp/src/test/java/com/azure/core/amqp/implementation/ReactorConnectionTest.java", "diffHunk": "@@ -364,7 +362,7 @@ void cannotCreateResourcesOnFailure() {\n     }\n \n     @Test\n-    void cannotCreateSessionWhenDisposed() {\n+    void closesDownstreamLinks() {", "originalCommit": "99b13b380fae5db73af433724a773d59c19418a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "018dee59feae4a0a5dcfac86939ee5b2b22a517a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/018dee59feae4a0a5dcfac86939ee5b2b22a517a", "message": "Fixing the string format for task.", "committedDate": "2020-09-10T06:32:36Z", "type": "commit"}, {"oid": "0f11498187747e57c71d4419ab26a0d584d7d0ed", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0f11498187747e57c71d4419ab26a0d584d7d0ed", "message": "Adding this. in front of AmqpRetryOptions.", "committedDate": "2020-09-10T06:32:36Z", "type": "commit"}, {"oid": "a6441c46524c157f092108cae34021e8ffef5359", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a6441c46524c157f092108cae34021e8ffef5359", "message": "Cleaning up print statements.", "committedDate": "2020-09-10T06:32:36Z", "type": "commit"}, {"oid": "edf4c4524097d4e16917fce133f10349a07dd910", "url": "https://github.com/Azure/azure-sdk-for-java/commit/edf4c4524097d4e16917fce133f10349a07dd910", "message": "Fixing issues.", "committedDate": "2020-09-10T06:32:36Z", "type": "commit"}, {"oid": "14afc3bf8b7a29cd0f58472a46c7fb1580bba0b6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/14afc3bf8b7a29cd0f58472a46c7fb1580bba0b6", "message": "Updating text in README.md", "committedDate": "2020-09-10T06:32:36Z", "type": "commit"}, {"oid": "7c7fef467d2caa3b6cf37f19a6acf496d5f0981a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7c7fef467d2caa3b6cf37f19a6acf496d5f0981a", "message": "Remove getErrors() which overlaps with getEndpointStates(). Only ouputting one terminal state.", "committedDate": "2020-09-10T06:32:37Z", "type": "commit"}, {"oid": "e74046c253aedb56c5ddffee99a88aa3d1fa981e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e74046c253aedb56c5ddffee99a88aa3d1fa981e", "message": "Fixing test breaks from removing getErrors.", "committedDate": "2020-09-10T06:32:37Z", "type": "commit"}, {"oid": "5cbb292d73b9d2c00d145370ba690af6cb7e9206", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5cbb292d73b9d2c00d145370ba690af6cb7e9206", "message": "Clean up tests and use subscribeWith.", "committedDate": "2020-09-10T06:32:37Z", "type": "commit"}, {"oid": "a73a67a18214f245dbb2b4edd9d9dd9e65cfee4b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a73a67a18214f245dbb2b4edd9d9dd9e65cfee4b", "message": "Adding test.", "committedDate": "2020-09-10T06:32:37Z", "type": "commit"}, {"oid": "95de918b9b36a7ce899b641712970ea404684a26", "url": "https://github.com/Azure/azure-sdk-for-java/commit/95de918b9b36a7ce899b641712970ea404684a26", "message": "Adding final.", "committedDate": "2020-09-10T06:32:38Z", "type": "commit"}, {"oid": "7a9883b5988a12cc9b595a08571f0443f47153b9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7a9883b5988a12cc9b595a08571f0443f47153b9", "message": "Adding test for session", "committedDate": "2020-09-10T06:32:38Z", "type": "commit"}, {"oid": "c940d34284b77d363b7f5d1debc4204f8c852bbf", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c940d34284b77d363b7f5d1debc4204f8c852bbf", "message": "Using close()", "committedDate": "2020-09-10T06:32:38Z", "type": "commit"}, {"oid": "ecd66e4ac9aee092aa2c444999cefb17462184a2", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ecd66e4ac9aee092aa2c444999cefb17462184a2", "message": "Updating log messages.", "committedDate": "2020-09-10T06:32:38Z", "type": "commit"}, {"oid": "773dde99aed02fd16738532b488a16dcff1c4987", "url": "https://github.com/Azure/azure-sdk-for-java/commit/773dde99aed02fd16738532b488a16dcff1c4987", "message": "Locally closing on connection error.", "committedDate": "2020-09-10T06:32:38Z", "type": "commit"}, {"oid": "d8aae082fb882d1e52ccbdfd5304ac3d26f9daf1", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d8aae082fb882d1e52ccbdfd5304ac3d26f9daf1", "message": "Fix build breaks in Service Bus.", "committedDate": "2020-09-10T06:32:39Z", "type": "commit"}, {"oid": "0aa1e2be0625c7b807fb51eb64f812d3fe871e64", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0aa1e2be0625c7b807fb51eb64f812d3fe871e64", "message": "Fix indentation.", "committedDate": "2020-09-10T06:32:39Z", "type": "commit"}, {"oid": "c6655e2dc2f0e72977cb170ab913644e0bd2b2fe", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c6655e2dc2f0e72977cb170ab913644e0bd2b2fe", "message": "Adding more logging.", "committedDate": "2020-09-10T06:32:39Z", "type": "commit"}, {"oid": "50523911364139a7320e0c440c90d3f3ac8c827d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/50523911364139a7320e0c440c90d3f3ac8c827d", "message": "Removing unneeded retries.", "committedDate": "2020-09-10T06:32:39Z", "type": "forcePushed"}, {"oid": "7c75c65f3c5cdc8b0364c701fbaac91b74647ca3", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7c75c65f3c5cdc8b0364c701fbaac91b74647ca3", "message": "Removing unneeded retries.", "committedDate": "2020-09-10T06:46:00Z", "type": "commit"}, {"oid": "7c75c65f3c5cdc8b0364c701fbaac91b74647ca3", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7c75c65f3c5cdc8b0364c701fbaac91b74647ca3", "message": "Removing unneeded retries.", "committedDate": "2020-09-10T06:46:00Z", "type": "forcePushed"}, {"oid": "df0c5e6824a69799531b357332bb41292669db1d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/df0c5e6824a69799531b357332bb41292669db1d", "message": "Remove empty tests.", "committedDate": "2020-09-10T18:30:53Z", "type": "commit"}, {"oid": "7d6215d129ed04e461ac19d94f3d9ac9ed1db778", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7d6215d129ed04e461ac19d94f3d9ac9ed1db778", "message": "Change methods to package-private.", "committedDate": "2020-09-10T18:32:23Z", "type": "commit"}, {"oid": "874edddbcc926cb89e51c2d6730c5e70f89ff8c8", "url": "https://github.com/Azure/azure-sdk-for-java/commit/874edddbcc926cb89e51c2d6730c5e70f89ff8c8", "message": "Add changelog entry", "committedDate": "2020-09-10T18:36:09Z", "type": "commit"}]}