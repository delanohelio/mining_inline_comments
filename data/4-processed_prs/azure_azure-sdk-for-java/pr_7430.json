{"pr_number": 7430, "pr_title": "Fix cancellation handling", "pr_createdAt": "2020-01-15T00:34:53Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/7430", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcwMTI3MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7430#discussion_r366701271", "bodyText": "I would prefer to keep PublishTestResults as always().  This task should only take a few seconds, and when cancelling a build (say due to a hung test) it's valuable to publish the test results we do have so far.", "author": "mikeharder", "createdAt": "2020-01-15T05:29:16Z", "path": "eng/pipelines/templates/jobs/archetype-sdk-client.yml", "diffHunk": "@@ -312,7 +312,7 @@ jobs:\n         condition: and(succeeded(), or(ne(variables['TestFromSource'],'true'), eq(variables['ShouldRunSourceTests'],'true')))\n \n       - task: PublishTestResults@2\n-        condition: and(always(), or(ne(variables['TestFromSource'],'true'), eq(variables['ShouldRunSourceTests'],'true')))\n+        condition: and(succeededOrFailed(), or(ne(variables['TestFromSource'],'true'), eq(variables['ShouldRunSourceTests'],'true')))", "originalCommit": "799963dbec7ef1e9ab6e6fd3e49433b9f1901099", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjgxNjg2NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7430#discussion_r366816865", "bodyText": "Using always() will result in the job ignoring cancellation requests. Perhaps succeededOrFailed() might be more appropriate?", "author": "mitchdenny", "createdAt": "2020-01-15T11:04:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcwMTI3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE1NTI0OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7430#discussion_r367155249", "bodyText": "I assume you mean the PublishTestResults task will ignore cancellation, not the whole Test job, right?", "author": "mikeharder", "createdAt": "2020-01-15T23:08:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcwMTI3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE2NDg0NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7430#discussion_r367164844", "bodyText": "If the job has started then it'll run PublishTestResults with always(). If the job hasn't started then the task won't run. Its probably not a big deal, if the job hasn't started then it won't run which will help with recovery, and provided we always put a succeeded() or succeededOrFailed() on preceding steps where a condition is used then it probably won't be a big issue.\nI think you've convinced me ;)", "author": "mitchdenny", "createdAt": "2020-01-15T23:42:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcwMTI3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE3NDA2Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7430#discussion_r367174063", "bodyText": "Sounds good.  If this does end up causing bigger problems with cancellation (beyond a 20-second delay), I agree it's not worth the benefit and should be changed to succeededOrFailed().", "author": "mikeharder", "createdAt": "2020-01-16T00:18:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcwMTI3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcwMTY1Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7430#discussion_r366701656", "bodyText": "Why skip ComponentGovernance if an earlier task failed (say Verify Readmes)?  Usually with analyze/test tasks, it's better to run as much as possible even if an earlier step failed.  I agree it should not be always() since we want to skip on cancel, but I think succeededOrFailed() is better than just succeeded().", "author": "mikeharder", "createdAt": "2020-01-15T05:31:33Z", "path": "eng/pipelines/templates/jobs/archetype-sdk-client.yml", "diffHunk": "@@ -146,7 +146,7 @@ jobs:\n       - task: ms.vss-governance-buildtask.governance-build-task-component-detection.ComponentGovernanceComponentDetection@0\n         # ComponentGovernance is currently unable to run on pull requests of public projects. Running on non-PR\n         # builds should be sufficient.\n-        condition: and(succeededOrFailed(), ne(variables['Build.Reason'], 'PullRequest'))\n+        condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))", "originalCommit": "799963dbec7ef1e9ab6e6fd3e49433b9f1901099", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE1NjI1Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7430#discussion_r367156252", "bodyText": "My thinking here was that if we've got a failed job, the validity of the component scan could be invalid anyway, so why bother doing it. But happy to do succeededOrFailed() in this case since it won't run if we cancel.", "author": "mitchdenny", "createdAt": "2020-01-15T23:12:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcwMTY1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcwMTk2OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7430#discussion_r366701969", "bodyText": "I believe all the jobs are run in parallel, so would there be any difference between succeeded() and succeededAndFailed() here?  If not then succeeded() is fine with me.", "author": "mikeharder", "createdAt": "2020-01-15T05:33:11Z", "path": "eng/pipelines/templates/jobs/archetype-sdk-client.yml", "diffHunk": "@@ -119,7 +119,7 @@ jobs:\n         artifact: repository\n \n   - job: 'Analyze'\n-    condition: ne(variables['Skip.Analyze'], 'true')\n+    condition: and(succeeded(), ne(variables['Skip.Analyze'], 'true'))", "originalCommit": "799963dbec7ef1e9ab6e6fd3e49433b9f1901099", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzEzMTQ1MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7430#discussion_r367131451", "bodyText": "I tried to apply a general rule as I was going through which was if a custom condition was defined make sure that a job state condition was also applied. I do actually plan on adding a prep job to all build stages in all pipelines which everything will depend on, so I kinda had that in the back of my head.", "author": "mitchdenny", "createdAt": "2020-01-15T22:04:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcwMTk2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcwMjE5OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7430#discussion_r366702199", "bodyText": "Same comment as above.  I would prefer to keep always() for PublishTestResults.", "author": "mikeharder", "createdAt": "2020-01-15T05:34:32Z", "path": "eng/pipelines/templates/jobs/archetype-sdk-tests.yml", "diffHunk": "@@ -107,13 +107,13 @@ jobs:\n             -ProvisionerApplicationSecret '$(provisioner-aad-secret)'\n             -Force\n             -Verbose\n-          condition: ne(variables['AZURE_RESOURCEGROUP_NAME'], '')\n+          condition: and(always(), ne(variables['AZURE_RESOURCEGROUP_NAME'], ''))\n           continueOnError: true\n           displayName: Remove Test Resources\n \n \n       - task: PublishTestResults@2\n-        condition: always()\n+        condition: succeededOrFailed()", "originalCommit": "799963dbec7ef1e9ab6e6fd3e49433b9f1901099", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzEzMTk4MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7430#discussion_r367131980", "bodyText": "succeededOrFailed() is the same as always() except that always() will keep the job running in the event of manual cancellation. When we manually cancel I am assuming we are expressly want the job cancelled now. I don't see the value of partial test results when we explicitly cancel.", "author": "mitchdenny", "createdAt": "2020-01-15T22:05:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcwMjE5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE1NDc4NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7430#discussion_r367154784", "bodyText": "The value is this scenario.  Someone notices a test is hung, and would like to manually cancel to stop wasting agent time.  However, they would still like to publish the test results they have so far.  I agree this is a relatively rare scenario, however the cost of delaying cancellation a few seconds (21 seconds for a recent run of java - storage - tests) is also low.", "author": "mikeharder", "createdAt": "2020-01-15T23:07:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcwMjE5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE1NTgxNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7430#discussion_r367155816", "bodyText": "That's fair enough. Given this is only for the - tests runs then I guess it won't be a big issue.", "author": "mitchdenny", "createdAt": "2020-01-15T23:10:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcwMjE5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE1NTkzOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7430#discussion_r367155939", "bodyText": "I'll update the PR, unless you see any other issues we should try to get this merged.", "author": "mitchdenny", "createdAt": "2020-01-15T23:11:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcwMjE5OQ=="}], "type": "inlineReview"}, {"oid": "6cd23cbc2647fc8dc6971e496103ad28584ed10e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6cd23cbc2647fc8dc6971e496103ad28584ed10e", "message": "Adjust conditions to better handle cancellations.", "committedDate": "2020-01-15T23:19:42Z", "type": "commit"}, {"oid": "03af12bbbfc95a4dee5d7b779272264a14993595", "url": "https://github.com/Azure/azure-sdk-for-java/commit/03af12bbbfc95a4dee5d7b779272264a14993595", "message": "Reacting to Mike's feedback.", "committedDate": "2020-01-15T23:46:42Z", "type": "commit"}, {"oid": "03af12bbbfc95a4dee5d7b779272264a14993595", "url": "https://github.com/Azure/azure-sdk-for-java/commit/03af12bbbfc95a4dee5d7b779272264a14993595", "message": "Reacting to Mike's feedback.", "committedDate": "2020-01-15T23:46:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzcwNjcwMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7430#discussion_r367706700", "bodyText": "@mitchdenny why was this changed from parameters back to variables? Variables is going to try and pull from the pipeline variable SDKType which isn't set for every pipeline. Using the parameters should, in theory, guarantee that this only runs for the correct track.", "author": "JimSuplizio", "createdAt": "2020-01-16T23:45:32Z", "path": "eng/pipelines/templates/jobs/archetype-sdk-client.yml", "diffHunk": "@@ -253,7 +253,7 @@ jobs:\n \n       - task: Maven@3\n         displayName: 'Start Jetty'\n-        condition: ne('${{ parameters.SDKType }}', 'client')\n+        condition: and(succeeded(), ne(variables['SdkType'], 'client'))", "originalCommit": "03af12bbbfc95a4dee5d7b779272264a14993595", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzcxNDAwMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/7430#discussion_r367714000", "bodyText": "My bad ... I'll fix it up now. I was getting shown some interesting conflict resolutions when I did my rebase.", "author": "mitchdenny", "createdAt": "2020-01-17T00:14:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzcwNjcwMA=="}], "type": "inlineReview"}]}