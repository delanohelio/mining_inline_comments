{"pr_number": 9413, "pr_title": "Add AzureKeyCredential to Azure Core", "pr_createdAt": "2020-03-24T01:07:51Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/9413", "timeline": [{"oid": "e9fbaacdf4ebf0b5dacba01f58e3d9c5838d4026", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e9fbaacdf4ebf0b5dacba01f58e3d9c5838d4026", "message": "Added AzureKeyCredential in Azure Core and updated Search and Text Analytics to use it", "committedDate": "2020-03-24T01:04:45Z", "type": "commit"}, {"oid": "2ea3d6920c12836f42f28f82992a359c23e43da9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2ea3d6920c12836f42f28f82992a359c23e43da9", "message": "Update builders", "committedDate": "2020-03-24T01:10:34Z", "type": "commit"}, {"oid": "b075127765a8ec35ac69f2b2f267bf6697b91da9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b075127765a8ec35ac69f2b2f267bf6697b91da9", "message": "Update other locations using module specific key credential", "committedDate": "2020-03-24T16:27:49Z", "type": "commit"}, {"oid": "60695b742747409c47f441e0fd06c67ca4582fe0", "url": "https://github.com/Azure/azure-sdk-for-java/commit/60695b742747409c47f441e0fd06c67ca4582fe0", "message": "Merge branch 'master' into AzCore_AddApiKeyCredential", "committedDate": "2020-03-24T16:52:25Z", "type": "commit"}, {"oid": "40a3217fbe87a1a031723b5547316004aea41990", "url": "https://github.com/Azure/azure-sdk-for-java/commit/40a3217fbe87a1a031723b5547316004aea41990", "message": "Fixed doc typos and grammar, updated Text Analytics policy to throw when using HTTP", "committedDate": "2020-03-24T16:57:58Z", "type": "commit"}, {"oid": "b121da47d09b25a8aaafb59094aed79c10b96cc9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b121da47d09b25a8aaafb59094aed79c10b96cc9", "message": "Update fallback endpoint for playback to use HTTPS", "committedDate": "2020-03-24T17:24:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQzODIzNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9413#discussion_r397438234", "bodyText": "Could we name this method update to be consistent across languages?", "author": "maririos", "createdAt": "2020-03-24T20:25:22Z", "path": "sdk/core/azure-core/src/main/java/com/azure/core/credential/AzureKeyCredential.java", "diffHunk": "@@ -0,0 +1,59 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.credential;\n+\n+import com.azure.core.util.logging.ClientLogger;\n+\n+import java.util.Objects;\n+\n+/**\n+ * Represents a credential that uses a key authenticate to an Azure Service.\n+ */\n+public class AzureKeyCredential {\n+    private final ClientLogger logger = new ClientLogger(AzureKeyCredential.class);\n+    private String key;\n+\n+    /**\n+     * Creates a credential that authorizes request with the given key.\n+     *\n+     * @param key The key used to authorize requests.\n+     * @throws NullPointerException If {@code key} is {@code null}.\n+     * @throws IllegalArgumentException If {@code key} is an empty string.\n+     */\n+    public AzureKeyCredential(String key) {\n+        Objects.requireNonNull(key);\n+        if (key.isEmpty()) {\n+            throw logger.logExceptionAsError(new IllegalArgumentException(\"'key' cannot be empty.\"));\n+        }\n+\n+        this.key = key;\n+    }\n+\n+    /**\n+     * Retrieves the key associated to this credential.\n+     *\n+     * @return The key being used to authorize requests.\n+     */\n+    public String getKey() {\n+        return key;\n+    }\n+\n+    /**\n+     * Rotates the key associated to this credential.\n+     *\n+     * @param key The new key to associated with this credential.\n+     * @return The updated {@code ApiKeyCredential} object.\n+     * @throws NullPointerException If {@code key} is {@code null}.\n+     * @throws IllegalArgumentException If {@code key} is an empty string.\n+     */\n+    public AzureKeyCredential updateKey(String key) {", "originalCommit": "b121da47d09b25a8aaafb59094aed79c10b96cc9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ0MTg1NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9413#discussion_r397441854", "bodyText": "Renamed to update.", "author": "alzimmermsft", "createdAt": "2020-03-24T20:31:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQzODIzNA=="}], "type": "inlineReview"}, {"oid": "85172d9c990c3c4f3158cbf8406d5d57aec36b81", "url": "https://github.com/Azure/azure-sdk-for-java/commit/85172d9c990c3c4f3158cbf8406d5d57aec36b81", "message": "Merge branch 'master' into AzCore_AddApiKeyCredential", "committedDate": "2020-03-24T20:27:38Z", "type": "commit"}, {"oid": "874666292403307f811e3a60ade7465b87b66ea7", "url": "https://github.com/Azure/azure-sdk-for-java/commit/874666292403307f811e3a60ade7465b87b66ea7", "message": "Renamed updateKey to update, added CHANGELOG notes for the change", "committedDate": "2020-03-24T20:31:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ0NzMwMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9413#discussion_r397447303", "bodyText": "Could the policies be private?", "author": "maririos", "createdAt": "2020-03-24T20:41:31Z", "path": "sdk/search/azure-search/src/main/java/com/azure/search/documents/SearchApiKeyPipelinePolicy.java", "diffHunk": "@@ -12,31 +13,37 @@\n import java.util.Objects;\n \n /**\n- * Policy that adds the Cognitive Search Service api-key into the request's Authorization header.\n+ * Pipeline policy that uses an {@link AzureKeyCredential} to set the {@code api-key} header which authorizes requests\n+ * sent to the Azure Search service.\n+ *\n+ * <p>\n+ * Requests sent with this pipeline policy are required to use {@code HTTPS}. If the request isn't using {@code HTTPS}\n+ * an exception will be thrown to prevent leaking the key.\n  */\n public final class SearchApiKeyPipelinePolicy implements HttpPipelinePolicy {", "originalCommit": "874666292403307f811e3a60ade7465b87b66ea7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ1NzExNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9413#discussion_r397457116", "bodyText": "Java has a guideline where we're expected to have our pipeline policies in the public API. We allow customers to roll their own pipeline if they wish, so making these inaccessible from the public API would make that more difficult.\n@JonathanGiles to point to the guideline since I'm having trouble finding it. (Or to add it if it is missing)", "author": "alzimmermsft", "createdAt": "2020-03-24T20:59:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ0NzMwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ4Njk0NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9413#discussion_r397486944", "bodyText": "Thanks for the clarification Alan!", "author": "maririos", "createdAt": "2020-03-24T21:58:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ0NzMwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODAyMDg0OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9413#discussion_r398020849", "bodyText": "The wording might be unclear but it's here - \"DO provide a suitable authentication policy that authenticates the HTTP request in the HTTP pipeline when using non-standard credentials. This includes custom connection strings, if supported.\"", "author": "JonathanGiles", "createdAt": "2020-03-25T17:04:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ0NzMwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODAyMzI0MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9413#discussion_r398023240", "bodyText": "In this case I would push to move up the shared Azure.Core implementation of a generic auth policy as in the discussion below, so we don't have these types left around as artifacts in libraries that GA before it's available", "author": "schaabs", "createdAt": "2020-03-25T17:08:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ0NzMwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE4Nzg0Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9413#discussion_r398187843", "bodyText": "If it is okay, I'm going to merge this PR as it keeps hitting merge conflicts due to its scope and file an issue to follow-up on a generic policy.", "author": "alzimmermsft", "createdAt": "2020-03-25T21:41:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ0NzMwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ0Nzc5Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9413#discussion_r397447793", "bodyText": "So this means that every client needs to implement it's own policy, is that correct?\nWondering if we could add a generic policy to Azure Core too", "author": "maririos", "createdAt": "2020-03-24T20:42:26Z", "path": "sdk/search/azure-search/src/main/java/com/azure/search/documents/SearchApiKeyPipelinePolicy.java", "diffHunk": "@@ -12,31 +13,37 @@\n import java.util.Objects;\n \n /**\n- * Policy that adds the Cognitive Search Service api-key into the request's Authorization header.\n+ * Pipeline policy that uses an {@link AzureKeyCredential} to set the {@code api-key} header which authorizes requests\n+ * sent to the Azure Search service.\n+ *\n+ * <p>\n+ * Requests sent with this pipeline policy are required to use {@code HTTPS}. If the request isn't using {@code HTTPS}\n+ * an exception will be thrown to prevent leaking the key.\n  */\n public final class SearchApiKeyPipelinePolicy implements HttpPipelinePolicy {", "originalCommit": "874666292403307f811e3a60ade7465b87b66ea7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ1MzQwOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9413#discussion_r397453408", "bodyText": "I was discussing this with @JonathanGiles and we didn't strongly lean on one design or the other. I left the library specific policies in place given they are in preview and adding this into Azure Core would likely require it being part of the public API which could GA it sooner (Java doesn't have a good friends assembly or internal that .NET leverages).\n@JonathanGiles any concern around making this a generic Azure Core policy that uses the credential and a header string? We do something conceptually similar with the RetryPolicy where we can pass a retry header to look for on the response.", "author": "alzimmermsft", "createdAt": "2020-03-24T20:52:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ0Nzc5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ4NzU5MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9413#discussion_r397487591", "bodyText": "I left the library specific policies in place given they are in preview\n\nNote that Text Analytics is going to GA in April, so if we could add the policy to Core now, that will be great for TA.", "author": "maririos", "createdAt": "2020-03-24T21:59:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ0Nzc5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ4OTY1MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9413#discussion_r397489650", "bodyText": "Couldn't the library specific policies be internal to the package, or added under implementation? Then you can always update them to use an implementation exposed by core at some point in the future.", "author": "schaabs", "createdAt": "2020-03-24T22:04:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ0Nzc5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUxNzM5Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9413#discussion_r397517396", "bodyText": "Yes, this could be done but goes a bit against the response above around why the policy is in the public API.", "author": "alzimmermsft", "createdAt": "2020-03-24T23:13:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ0Nzc5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODAwNzc1Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9413#discussion_r398007752", "bodyText": "Could you use one check of CoreUtil.isNullOrEmpty() here?", "author": "sima-zhu", "createdAt": "2020-03-25T16:47:07Z", "path": "sdk/core/azure-core/src/main/java/com/azure/core/credential/AzureKeyCredential.java", "diffHunk": "@@ -0,0 +1,59 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.credential;\n+\n+import com.azure.core.util.logging.ClientLogger;\n+\n+import java.util.Objects;\n+\n+/**\n+ * Represents a credential that uses a key authenticate to an Azure Service.\n+ */\n+public class AzureKeyCredential {\n+    private final ClientLogger logger = new ClientLogger(AzureKeyCredential.class);\n+    private String key;\n+\n+    /**\n+     * Creates a credential that authorizes request with the given key.\n+     *\n+     * @param key The key used to authorize requests.\n+     * @throws NullPointerException If {@code key} is {@code null}.\n+     * @throws IllegalArgumentException If {@code key} is an empty string.\n+     */\n+    public AzureKeyCredential(String key) {\n+        Objects.requireNonNull(key);\n+        if (key.isEmpty()) {\n+            throw logger.logExceptionAsError(new IllegalArgumentException(\"'key' cannot be empty.\"));\n+        }\n+\n+        this.key = key;\n+    }\n+\n+    /**\n+     * Retrieves the key associated to this credential.\n+     *\n+     * @return The key being used to authorize requests.\n+     */\n+    public String getKey() {\n+        return key;\n+    }\n+\n+    /**\n+     * Rotates the key associated to this credential.\n+     *\n+     * @param key The new key to associated with this credential.\n+     * @return The updated {@code ApiKeyCredential} object.\n+     * @throws NullPointerException If {@code key} is {@code null}.\n+     * @throws IllegalArgumentException If {@code key} is an empty string.\n+     */\n+    public AzureKeyCredential update(String key) {\n+        Objects.requireNonNull(key);\n+        if (key.isEmpty()) {", "originalCommit": "874666292403307f811e3a60ade7465b87b66ea7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODAyMjg4MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9413#discussion_r398022880", "bodyText": "Definitely could but our guidelines state if we expect a non-null parameter and we get null a NullPointerException should be thrown (the Objects.requireNonNull check) and then if we get a value that we don't expect that isn't null throw a IllegalArgumentException (the isEmpty check).", "author": "alzimmermsft", "createdAt": "2020-03-25T17:07:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODAwNzc1Mg=="}], "type": "inlineReview"}, {"oid": "a94714177b2f781b64d56afbc920a0bd9dcbbd36", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a94714177b2f781b64d56afbc920a0bd9dcbbd36", "message": "Merged in master and resolved merge conflicts", "committedDate": "2020-03-25T17:56:47Z", "type": "commit"}, {"oid": "083a98ded2779c22124a93c115a3eff717bc4791", "url": "https://github.com/Azure/azure-sdk-for-java/commit/083a98ded2779c22124a93c115a3eff717bc4791", "message": "Added exception message to key null checks", "committedDate": "2020-03-25T17:58:38Z", "type": "commit"}, {"oid": "553b537b3cda2592a80a2e8f59207c7c9ed80a53", "url": "https://github.com/Azure/azure-sdk-for-java/commit/553b537b3cda2592a80a2e8f59207c7c9ed80a53", "message": "Merge branch 'master' into AzCore_AddApiKeyCredential", "committedDate": "2020-03-25T18:09:15Z", "type": "commit"}, {"oid": "6fad1afadfe53b6aabc79cf6526fb9cc632564fa", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6fad1afadfe53b6aabc79cf6526fb9cc632564fa", "message": "Removed unused imports, update default endpoint to HTTPS", "committedDate": "2020-03-25T18:11:36Z", "type": "commit"}, {"oid": "7e3fa625f1ee9367ac36b8f3d853e24438321a97", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7e3fa625f1ee9367ac36b8f3d853e24438321a97", "message": "Merged in master", "committedDate": "2020-03-25T21:05:35Z", "type": "commit"}, {"oid": "422d0e386da293db94e1642fdacd1828a84d73cf", "url": "https://github.com/Azure/azure-sdk-for-java/commit/422d0e386da293db94e1642fdacd1828a84d73cf", "message": "Remove classes added back in merged from master", "committedDate": "2020-03-25T21:26:12Z", "type": "commit"}]}