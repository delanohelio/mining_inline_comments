{"pr_number": 17180, "pr_title": "Adds a Precommit Script to Eng that Builds, Tests, and Lints passed Artifacts and POMs", "pr_createdAt": "2020-11-04T22:17:51Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/17180", "timeline": [{"oid": "509cc97c5b0ff434b4e4a906e66174f2b836986b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/509cc97c5b0ff434b4e4a906e66174f2b836986b", "message": "Add precommit script that is able to run compile, test, and linting", "committedDate": "2020-11-04T22:11:21Z", "type": "commit"}, {"oid": "5086d44902d943f6b0cd6d06714ff0c9399eff7b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/5086d44902d943f6b0cd6d06714ff0c9399eff7b", "message": "Add examples to the script", "committedDate": "2020-11-04T22:35:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY2NjEyNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17180#discussion_r517666124", "bodyText": "nit: use snake_case for method names and var names to make it look more pythonic", "author": "srnagar", "createdAt": "2020-11-04T22:23:04Z", "path": "eng/precommit_local_build.py", "diffHunk": "@@ -0,0 +1,99 @@\n+# Copyright (c) Microsoft Corporation. All rights reserved.\n+# Licensed under the MIT License.\n+\n+# Python version 3.4 or higher is required to run this script.\n+\n+# Use case: Runs compilation, testing, and linting for the passed artifacts and POM artifacts.\n+#\n+# The artifacts must exist in the module list of pom.xml in the root of azure-sdk-for-java. Artifacts may be passed in two ways:\n+#\n+# 1. Comma separated list of relative POM paths.\n+# 2. Comma separated list of groupId:artifactId identifiers.\n+#\n+# The script must be run at the root of azure-sdk-for-java.\n+\n+import argparse\n+import os\n+import xml.etree.ElementTree as ET\n+\n+baseCommand = 'mvn clean install -f pom.xml -pl \"{}\" -am {}'\n+xmlNamespace = '{http://maven.apache.org/POM/4.0.0}'\n+\n+def getArtifactsFromPOM(pomPath: str, artifacts: list, debug: bool):", "originalCommit": "509cc97c5b0ff434b4e4a906e66174f2b836986b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY2NzQzMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17180#discussion_r517667432", "bodyText": "Does maven allow passing multiple pom files?", "author": "srnagar", "createdAt": "2020-11-04T22:26:07Z", "path": "eng/precommit_local_build.py", "diffHunk": "@@ -0,0 +1,99 @@\n+# Copyright (c) Microsoft Corporation. All rights reserved.\n+# Licensed under the MIT License.\n+\n+# Python version 3.4 or higher is required to run this script.\n+\n+# Use case: Runs compilation, testing, and linting for the passed artifacts and POM artifacts.\n+#\n+# The artifacts must exist in the module list of pom.xml in the root of azure-sdk-for-java. Artifacts may be passed in two ways:\n+#\n+# 1. Comma separated list of relative POM paths.\n+# 2. Comma separated list of groupId:artifactId identifiers.\n+#\n+# The script must be run at the root of azure-sdk-for-java.\n+\n+import argparse\n+import os\n+import xml.etree.ElementTree as ET\n+\n+baseCommand = 'mvn clean install -f pom.xml -pl \"{}\" -am {}'\n+xmlNamespace = '{http://maven.apache.org/POM/4.0.0}'\n+\n+def getArtifactsFromPOM(pomPath: str, artifacts: list, debug: bool):\n+    if not os.path.exists(pomPath):\n+        if debug:\n+            print(\"POM {} doesn't exist, skipping\".format(pomPath))\n+        return\n+\n+    tree = ET.parse(pomPath)\n+    modulesElement = tree.getroot().find(xmlNamespace + 'modules')\n+    if modulesElement != None:\n+        pomBasedir = os.path.dirname(pomPath)\n+        for modulePomElement in modulesElement.iterfind(xmlNamespace + 'module'):\n+            moduleName = modulePomElement.text\n+            modulePomPath = os.path.normpath(os.path.join(pomBasedir, moduleName, 'pom.xml'))\n+\n+            if debug:\n+                print('Getting module artifact for {} from aggregator POM {}'.format(moduleName.split('/')[-1], pomPath))\n+\n+            getArtifactsFromPOM(modulePomPath, artifacts, debug)\n+\n+    else:\n+        groupId = tree.getroot().findtext(xmlNamespace + \"groupId\")\n+        artifactId = tree.getroot().findtext(xmlNamespace + \"artifactId\")\n+        artifactIdentifier = '{}:{}'.format(groupId, artifactId)\n+\n+        if debug:\n+            print('Adding artifact {} for POM file {}'.format(artifactIdentifier, pomPath))\n+\n+        artifacts.append(artifactIdentifier)\n+\n+def main():\n+    parser = argparse.ArgumentParser(description='Runs compilation, testing, and linting for the passed artifacts.')\n+    parser.add_argument('--artifacts', '--a', type=str, default=None, help='Comma separated list of groupId:artifactId identifiers')\n+    parser.add_argument('--poms', '--p', type=str, default=None, help='Comma separated list of POM paths')", "originalCommit": "509cc97c5b0ff434b4e4a906e66174f2b836986b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY3ODc1OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17180#discussion_r517678759", "bodyText": "This script will \"crack\" the POM, so if you pass multiple it will grab the groupId:artifactId identifier and put it into the -pl property. It will also \"crack\" aggregate POMs into their sub-modules.", "author": "alzimmermsft", "createdAt": "2020-11-04T22:52:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY2NzQzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY2ODA3MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17180#discussion_r517668070", "bodyText": "I think we should just disable gpg by default. I don't think we need to run gpg check locally.", "author": "srnagar", "createdAt": "2020-11-04T22:27:40Z", "path": "eng/precommit_local_build.py", "diffHunk": "@@ -0,0 +1,99 @@\n+# Copyright (c) Microsoft Corporation. All rights reserved.\n+# Licensed under the MIT License.\n+\n+# Python version 3.4 or higher is required to run this script.\n+\n+# Use case: Runs compilation, testing, and linting for the passed artifacts and POM artifacts.\n+#\n+# The artifacts must exist in the module list of pom.xml in the root of azure-sdk-for-java. Artifacts may be passed in two ways:\n+#\n+# 1. Comma separated list of relative POM paths.\n+# 2. Comma separated list of groupId:artifactId identifiers.\n+#\n+# The script must be run at the root of azure-sdk-for-java.\n+\n+import argparse\n+import os\n+import xml.etree.ElementTree as ET\n+\n+baseCommand = 'mvn clean install -f pom.xml -pl \"{}\" -am {}'", "originalCommit": "509cc97c5b0ff434b4e4a906e66174f2b836986b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY3ODgxOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17180#discussion_r517678818", "bodyText": "Good catch", "author": "alzimmermsft", "createdAt": "2020-11-04T22:53:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY2ODA3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY3MTUwMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17180#discussion_r517671501", "bodyText": "We should also have an option to do a dry-run which just prints the maven command and not run it. Useful if I want to just copy the generated maven command and give it to someone else to run.", "author": "srnagar", "createdAt": "2020-11-04T22:35:40Z", "path": "eng/precommit_local_build.py", "diffHunk": "@@ -0,0 +1,99 @@\n+# Copyright (c) Microsoft Corporation. All rights reserved.\n+# Licensed under the MIT License.\n+\n+# Python version 3.4 or higher is required to run this script.\n+\n+# Use case: Runs compilation, testing, and linting for the passed artifacts and POM artifacts.\n+#\n+# The artifacts must exist in the module list of pom.xml in the root of azure-sdk-for-java. Artifacts may be passed in two ways:\n+#\n+# 1. Comma separated list of relative POM paths.\n+# 2. Comma separated list of groupId:artifactId identifiers.\n+#\n+# The script must be run at the root of azure-sdk-for-java.\n+\n+import argparse\n+import os\n+import xml.etree.ElementTree as ET\n+\n+baseCommand = 'mvn clean install -f pom.xml -pl \"{}\" -am {}'\n+xmlNamespace = '{http://maven.apache.org/POM/4.0.0}'\n+\n+def getArtifactsFromPOM(pomPath: str, artifacts: list, debug: bool):\n+    if not os.path.exists(pomPath):\n+        if debug:\n+            print(\"POM {} doesn't exist, skipping\".format(pomPath))\n+        return\n+\n+    tree = ET.parse(pomPath)\n+    modulesElement = tree.getroot().find(xmlNamespace + 'modules')\n+    if modulesElement != None:\n+        pomBasedir = os.path.dirname(pomPath)\n+        for modulePomElement in modulesElement.iterfind(xmlNamespace + 'module'):\n+            moduleName = modulePomElement.text\n+            modulePomPath = os.path.normpath(os.path.join(pomBasedir, moduleName, 'pom.xml'))\n+\n+            if debug:\n+                print('Getting module artifact for {} from aggregator POM {}'.format(moduleName.split('/')[-1], pomPath))\n+\n+            getArtifactsFromPOM(modulePomPath, artifacts, debug)\n+\n+    else:\n+        groupId = tree.getroot().findtext(xmlNamespace + \"groupId\")\n+        artifactId = tree.getroot().findtext(xmlNamespace + \"artifactId\")\n+        artifactIdentifier = '{}:{}'.format(groupId, artifactId)\n+\n+        if debug:\n+            print('Adding artifact {} for POM file {}'.format(artifactIdentifier, pomPath))\n+\n+        artifacts.append(artifactIdentifier)\n+\n+def main():\n+    parser = argparse.ArgumentParser(description='Runs compilation, testing, and linting for the passed artifacts.')\n+    parser.add_argument('--artifacts', '--a', type=str, default=None, help='Comma separated list of groupId:artifactId identifiers')\n+    parser.add_argument('--poms', '--p', type=str, default=None, help='Comma separated list of POM paths')\n+    parser.add_argument('--skip-tests', '--st', action='store_true', help='Skips running tests')\n+    parser.add_argument('--skip-javadocs', '--sj', action='store_true', help='Skips javadoc generation')\n+    parser.add_argument('--skip-checkstyle', '--sc', action='store_true', help='Skips checkstyle linting')\n+    parser.add_argument('--skip-spotbugs', '--ss', action='store_true', help='Skips spotbugs linting')\n+    parser.add_argument('--skip-revapi', '--sr', action='store_true', help='Skips revapi linting')\n+    parser.add_argument('--debug', '--d', action='store_true', help='Runs the script with debug logging')", "originalCommit": "509cc97c5b0ff434b4e4a906e66174f2b836986b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY3OTM0NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17180#discussion_r517679345", "bodyText": "Good idea", "author": "alzimmermsft", "createdAt": "2020-11-04T22:54:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY3MTUwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY3MjMyMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17180#discussion_r517672321", "bodyText": "Might be worth including the exact command to use to run this script and the options that can be passed to this script.", "author": "srnagar", "createdAt": "2020-11-04T22:37:32Z", "path": "eng/precommit_local_build.py", "diffHunk": "@@ -0,0 +1,99 @@\n+# Copyright (c) Microsoft Corporation. All rights reserved.\n+# Licensed under the MIT License.\n+\n+# Python version 3.4 or higher is required to run this script.\n+\n+# Use case: Runs compilation, testing, and linting for the passed artifacts and POM artifacts.\n+#\n+# The artifacts must exist in the module list of pom.xml in the root of azure-sdk-for-java. Artifacts may be passed in two ways:\n+#\n+# 1. Comma separated list of relative POM paths.\n+# 2. Comma separated list of groupId:artifactId identifiers.\n+#\n+# The script must be run at the root of azure-sdk-for-java.", "originalCommit": "509cc97c5b0ff434b4e4a906e66174f2b836986b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY3MjY5NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17180#discussion_r517672695", "bodyText": "Let's wrap this with double-quotes as well and explicitly set this to true to be consistent with other options below.", "author": "srnagar", "createdAt": "2020-11-04T22:38:38Z", "path": "eng/precommit_local_build.py", "diffHunk": "@@ -0,0 +1,99 @@\n+# Copyright (c) Microsoft Corporation. All rights reserved.\n+# Licensed under the MIT License.\n+\n+# Python version 3.4 or higher is required to run this script.\n+\n+# Use case: Runs compilation, testing, and linting for the passed artifacts and POM artifacts.\n+#\n+# The artifacts must exist in the module list of pom.xml in the root of azure-sdk-for-java. Artifacts may be passed in two ways:\n+#\n+# 1. Comma separated list of relative POM paths.\n+# 2. Comma separated list of groupId:artifactId identifiers.\n+#\n+# The script must be run at the root of azure-sdk-for-java.\n+\n+import argparse\n+import os\n+import xml.etree.ElementTree as ET\n+\n+baseCommand = 'mvn clean install -f pom.xml -pl \"{}\" -am {}'\n+xmlNamespace = '{http://maven.apache.org/POM/4.0.0}'\n+\n+def getArtifactsFromPOM(pomPath: str, artifacts: list, debug: bool):\n+    if not os.path.exists(pomPath):\n+        if debug:\n+            print(\"POM {} doesn't exist, skipping\".format(pomPath))\n+        return\n+\n+    tree = ET.parse(pomPath)\n+    modulesElement = tree.getroot().find(xmlNamespace + 'modules')\n+    if modulesElement != None:\n+        pomBasedir = os.path.dirname(pomPath)\n+        for modulePomElement in modulesElement.iterfind(xmlNamespace + 'module'):\n+            moduleName = modulePomElement.text\n+            modulePomPath = os.path.normpath(os.path.join(pomBasedir, moduleName, 'pom.xml'))\n+\n+            if debug:\n+                print('Getting module artifact for {} from aggregator POM {}'.format(moduleName.split('/')[-1], pomPath))\n+\n+            getArtifactsFromPOM(modulePomPath, artifacts, debug)\n+\n+    else:\n+        groupId = tree.getroot().findtext(xmlNamespace + \"groupId\")\n+        artifactId = tree.getroot().findtext(xmlNamespace + \"artifactId\")\n+        artifactIdentifier = '{}:{}'.format(groupId, artifactId)\n+\n+        if debug:\n+            print('Adding artifact {} for POM file {}'.format(artifactIdentifier, pomPath))\n+\n+        artifacts.append(artifactIdentifier)\n+\n+def main():\n+    parser = argparse.ArgumentParser(description='Runs compilation, testing, and linting for the passed artifacts.')\n+    parser.add_argument('--artifacts', '--a', type=str, default=None, help='Comma separated list of groupId:artifactId identifiers')\n+    parser.add_argument('--poms', '--p', type=str, default=None, help='Comma separated list of POM paths')\n+    parser.add_argument('--skip-tests', '--st', action='store_true', help='Skips running tests')\n+    parser.add_argument('--skip-javadocs', '--sj', action='store_true', help='Skips javadoc generation')\n+    parser.add_argument('--skip-checkstyle', '--sc', action='store_true', help='Skips checkstyle linting')\n+    parser.add_argument('--skip-spotbugs', '--ss', action='store_true', help='Skips spotbugs linting')\n+    parser.add_argument('--skip-revapi', '--sr', action='store_true', help='Skips revapi linting')\n+    parser.add_argument('--debug', '--d', action='store_true', help='Runs the script with debug logging')\n+    args = parser.parse_args()\n+\n+    if args.artifacts == None and args.poms == None:\n+        raise ValueError('--artifacts/--a or --poms/--p must be passed.')\n+\n+    debug = args.debug\n+\n+    buildArtifacts = []\n+    if args.poms != None:\n+        for pom in args.poms.split(','):\n+            getArtifactsFromPOM(os.path.abspath(pom), buildArtifacts, debug)\n+\n+    if args.artifacts != None:\n+        buildArtifacts.extend(args.artifacts.split(','))\n+\n+    skipArguments = []\n+    if args.skip_tests:\n+        skipArguments.append('-DskipTests')", "originalCommit": "509cc97c5b0ff434b4e4a906e66174f2b836986b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY3NTMwNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17180#discussion_r517675304", "bodyText": "Will this also close the file handle? Should this be wrapped in with block?", "author": "srnagar", "createdAt": "2020-11-04T22:44:40Z", "path": "eng/precommit_local_build.py", "diffHunk": "@@ -0,0 +1,99 @@\n+# Copyright (c) Microsoft Corporation. All rights reserved.\n+# Licensed under the MIT License.\n+\n+# Python version 3.4 or higher is required to run this script.\n+\n+# Use case: Runs compilation, testing, and linting for the passed artifacts and POM artifacts.\n+#\n+# The artifacts must exist in the module list of pom.xml in the root of azure-sdk-for-java. Artifacts may be passed in two ways:\n+#\n+# 1. Comma separated list of relative POM paths.\n+# 2. Comma separated list of groupId:artifactId identifiers.\n+#\n+# The script must be run at the root of azure-sdk-for-java.\n+\n+import argparse\n+import os\n+import xml.etree.ElementTree as ET\n+\n+baseCommand = 'mvn clean install -f pom.xml -pl \"{}\" -am {}'\n+xmlNamespace = '{http://maven.apache.org/POM/4.0.0}'\n+\n+def getArtifactsFromPOM(pomPath: str, artifacts: list, debug: bool):\n+    if not os.path.exists(pomPath):\n+        if debug:\n+            print(\"POM {} doesn't exist, skipping\".format(pomPath))\n+        return\n+\n+    tree = ET.parse(pomPath)", "originalCommit": "509cc97c5b0ff434b4e4a906e66174f2b836986b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY4MTk2OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17180#discussion_r517681969", "bodyText": "Tried using this with with and it raised a parsing error, I don't think it supports it.", "author": "alzimmermsft", "createdAt": "2020-11-04T23:01:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY3NTMwNA=="}], "type": "inlineReview"}, {"oid": "471cdf16942ac8b3e6b4d15909adb58fd4695aba", "url": "https://github.com/Azure/azure-sdk-for-java/commit/471cdf16942ac8b3e6b4d15909adb58fd4695aba", "message": "Make the script OS agnostic, add more documentation", "committedDate": "2020-11-04T22:49:59Z", "type": "commit"}, {"oid": "06d0f078bf847a06fe6b061afe1542f79c0d3468", "url": "https://github.com/Azure/azure-sdk-for-java/commit/06d0f078bf847a06fe6b061afe1542f79c0d3468", "message": "Make code more pythonic, add gpg.skip, standardized skip variables, document available parameters", "committedDate": "2020-11-04T23:10:03Z", "type": "commit"}]}