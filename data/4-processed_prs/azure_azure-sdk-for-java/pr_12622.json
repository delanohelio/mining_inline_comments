{"pr_number": 12622, "pr_title": "Cosmos: preview for AAD support", "pr_createdAt": "2020-06-29T20:08:14Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/12622", "timeline": [{"oid": "7a3e7aa6cd17b4acb54f0bd378fbbe6497ca42f0", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7a3e7aa6cd17b4acb54f0bd378fbbe6497ca42f0", "message": "Add initial implementation to pass an AAD token to the backend.", "committedDate": "2020-04-29T22:26:48Z", "type": "commit"}, {"oid": "551baf34ddf19e8dc1d7f9f94a18e8c34c7cf360", "url": "https://github.com/Azure/azure-sdk-for-java/commit/551baf34ddf19e8dc1d7f9f94a18e8c34c7cf360", "message": "Merge remote-tracking branch 'upstream/master' into milismsft-AAD\n\n# Conflicts:\n#\tsdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosAsyncClient.java\n#\tsdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosClientBuilder.java\n#\tsdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/AsyncDocumentClient.java\n#\tsdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/RxDocumentClientImpl.java\n#\tsdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/implementation/RxDocumentClientUnderTest.java\n#\tsdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/implementation/SpyClientUnderTestFactory.java", "committedDate": "2020-06-23T22:20:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIzNjQ5NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r447236495", "bodyText": "Is Direct dependency needed?", "author": "kirankumarkolli", "createdAt": "2020-06-29T20:33:06Z", "path": "sdk/cosmos/azure-cosmos/pom.xml", "diffHunk": "@@ -132,6 +132,20 @@ Licensed under the MIT License.\n       </exclusions>\n     </dependency>\n \n+    <dependency>\n+      <groupId>com.azure</groupId>\n+      <artifactId>azure-identity</artifactId>", "originalCommit": "551baf34ddf19e8dc1d7f9f94a18e8c34c7cf360", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIzNjY1NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r447236654", "bodyText": "Ohh its a test depdnency?", "author": "kirankumarkolli", "createdAt": "2020-06-29T20:33:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIzNjQ5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI4MzU2OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r447283569", "bodyText": "yes, this is a test dependency only; however the second dependency we need to talk about, if we want to take direct dependency on. SimpleTokenCache requires it... basically this creates a background thread via Reactor's ReplayProcessor which ensures that the AAD token is refreshed before it expires.", "author": "milismsft", "createdAt": "2020-06-29T22:11:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIzNjQ5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI4ODM1Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r447288353", "bodyText": "To be more exact, ReplayProcessor requires that an HttpClient implementation is available as part of the current app's package. This can be something that the client bring or our Cosmos library can and the customer can exclude it if they want to bring their own.", "author": "milismsft", "createdAt": "2020-06-29T22:17:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIzNjQ5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTMxOTkzMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r449319930", "bodyText": "I am guessing this will be optional dependency right? if AAD integration is needed this would be needed at runtime. no?\nshouldn't this be the following?\n    <dependency>\n      <groupId>com.azure</groupId>\n      <artifactId>azure-identity</artifactId>\n      <version>1.1.0-beta.3</version> <!-- {x-version-update;com.azure:azure-identity;dependency} -->\n      <optional>true</optional>\n    </dependency>", "author": "moderakh", "createdAt": "2020-07-03T00:20:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIzNjQ5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMxNjQ0Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r450316447", "bodyText": "It's the azure-core-http-netty that might be needed... azure-identity is only required for testing purposes.", "author": "milismsft", "createdAt": "2020-07-06T15:50:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIzNjQ5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMyNjU1NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r450326555", "bodyText": "Regarding the e2e testing, will add these once the AAD support is available in the Cosmos public emulator. Regular AAD requires creating a proper identity first which needs to be recognized by the Cosmos service (this is still worked on); to create this identity the tests need special permission to RBAC (subscription ownership, rights etc). Instead of this we are going to leverage the Cosmos emulator where we can create a TokenCredential like instance using emulator available secrets (key, emulator certificate) which Cosmos backend will properly recognize for this particular case (see ifLocalEmulator).", "author": "milismsft", "createdAt": "2020-07-06T16:06:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIzNjQ5NQ=="}], "type": "inlineReview"}, {"oid": "700b8b8667bddae5eb4a9aad424cba77fc4ff22e", "url": "https://github.com/Azure/azure-sdk-for-java/commit/700b8b8667bddae5eb4a9aad424cba77fc4ff22e", "message": "Merge branch 'master' into milismsft-AAD\n\n# Conflicts:\n#\tsdk/cosmos/azure-cosmos/pom.xml\n#\tsdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosAsyncClient.java\n#\tsdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosClientBuilder.java\n#\tsdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/AsyncDocumentClient.java\n#\tsdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/RxDocumentClientImpl.java\n#\tsdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/implementation/RxDocumentClientUnderTest.java\n#\tsdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/implementation/SpyClientUnderTestFactory.java", "committedDate": "2020-06-29T21:27:53Z", "type": "commit"}, {"oid": "ae636ddf4ef58562318383bc14c109055bbe7992", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ae636ddf4ef58562318383bc14c109055bbe7992", "message": "Merge branch 'master' into milismsft-AAD", "committedDate": "2020-06-29T21:31:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTMxNDQ4Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r449314483", "bodyText": "String.format() will do regex underneath which is CPU intensive. if possible please use String concat/StringBuilder on the hot path:\nhttps://stackoverflow.com/questions/513600/should-i-use-javas-string-format-if-performance-is-important?answertab=votes#tab-top", "author": "moderakh", "createdAt": "2020-07-02T23:55:57Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/AadTokenAuthorizationHelper.java", "diffHunk": "@@ -0,0 +1,61 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation;\n+\n+import com.azure.core.credential.SimpleTokenCache;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import reactor.core.publisher.Mono;\n+\n+import java.io.UnsupportedEncodingException;\n+import java.net.URLEncoder;\n+\n+/**\n+ * This class is used internally and act as a helper in authorization of\n+ * AAD tokens and its supporting method.\n+ *\n+ */\n+public class AadTokenAuthorizationHelper {\n+    public static final String AAD_AUTH_SCHEMA_TYPE_SEGMENT = \"type\";\n+    public static final String AAD_AUTH_VERSION_SEGMENT = \"ver\";\n+    public static final String AAD_AUTH_SIGNATURE_SEGMENT = \"sig\";\n+    public static final String AAD_AUTH_SCHEMA_TYPE_VALUE = \"aad\";\n+    public static final String AAD_AUTH_VERSION_VALUE = \"1.0\";\n+    public static final String AAD_AUTH_TOKEN_FORMAT = \"%s=%s&%s=%s&%s=%s\";\n+    public static final String AAD_AUTH_TOKEN_GENERAL_SCOPE = \"https://management.azure.com/.default\";\n+    private static final String AUTH_PREFIX = \"type=aad&ver=1.0&sig=\";\n+    private static final Logger logger = LoggerFactory.getLogger(AadTokenAuthorizationHelper.class);\n+\n+    /**\n+     * This method will try to fetch the AAD token to access the resource and add it to the rquest headers.\n+     *\n+     * @param request the request headers.\n+     * @param simpleTokenCache token cache that supports caching a token and refreshing it.\n+     * @return the request headers with authorization header updated.\n+     */\n+    public static Mono<RxDocumentServiceRequest> populateAuthorizationHeader(RxDocumentServiceRequest request, SimpleTokenCache simpleTokenCache) {\n+        if (request == null) {\n+            return Mono.error(new IllegalArgumentException(\"request\"));\n+        }\n+        if (simpleTokenCache == null) {\n+            return Mono.error(new IllegalArgumentException(\"simpleTokenCache\"));\n+        }\n+\n+        return simpleTokenCache.getToken()\n+            .map(accessToken -> {\n+                String authorization = String.format(AAD_AUTH_TOKEN_FORMAT,", "originalCommit": "ae636ddf4ef58562318383bc14c109055bbe7992", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMyMTM1NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r450321355", "bodyText": "fixed", "author": "milismsft", "createdAt": "2020-07-06T15:58:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTMxNDQ4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTMxNDc2Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r449314763", "bodyText": "throwing the exception here should work too. that simpler to read.", "author": "moderakh", "createdAt": "2020-07-02T23:56:56Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/AadTokenAuthorizationHelper.java", "diffHunk": "@@ -0,0 +1,61 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation;\n+\n+import com.azure.core.credential.SimpleTokenCache;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import reactor.core.publisher.Mono;\n+\n+import java.io.UnsupportedEncodingException;\n+import java.net.URLEncoder;\n+\n+/**\n+ * This class is used internally and act as a helper in authorization of\n+ * AAD tokens and its supporting method.\n+ *\n+ */\n+public class AadTokenAuthorizationHelper {\n+    public static final String AAD_AUTH_SCHEMA_TYPE_SEGMENT = \"type\";\n+    public static final String AAD_AUTH_VERSION_SEGMENT = \"ver\";\n+    public static final String AAD_AUTH_SIGNATURE_SEGMENT = \"sig\";\n+    public static final String AAD_AUTH_SCHEMA_TYPE_VALUE = \"aad\";\n+    public static final String AAD_AUTH_VERSION_VALUE = \"1.0\";\n+    public static final String AAD_AUTH_TOKEN_FORMAT = \"%s=%s&%s=%s&%s=%s\";\n+    public static final String AAD_AUTH_TOKEN_GENERAL_SCOPE = \"https://management.azure.com/.default\";\n+    private static final String AUTH_PREFIX = \"type=aad&ver=1.0&sig=\";\n+    private static final Logger logger = LoggerFactory.getLogger(AadTokenAuthorizationHelper.class);\n+\n+    /**\n+     * This method will try to fetch the AAD token to access the resource and add it to the rquest headers.\n+     *\n+     * @param request the request headers.\n+     * @param simpleTokenCache token cache that supports caching a token and refreshing it.\n+     * @return the request headers with authorization header updated.\n+     */\n+    public static Mono<RxDocumentServiceRequest> populateAuthorizationHeader(RxDocumentServiceRequest request, SimpleTokenCache simpleTokenCache) {\n+        if (request == null) {\n+            return Mono.error(new IllegalArgumentException(\"request\"));", "originalCommit": "ae636ddf4ef58562318383bc14c109055bbe7992", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMyMTQ0NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r450321445", "bodyText": "fixed", "author": "milismsft", "createdAt": "2020-07-06T15:58:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTMxNDc2Mw=="}], "type": "inlineReview"}, {"oid": "74f2d0c0a8e803fdaba57e390633b1a45570fbe7", "url": "https://github.com/Azure/azure-sdk-for-java/commit/74f2d0c0a8e803fdaba57e390633b1a45570fbe7", "message": "Address PR comments", "committedDate": "2020-07-06T17:10:45Z", "type": "commit"}, {"oid": "08267b2fbe83b67ca29835ebe49957db4264443b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/08267b2fbe83b67ca29835ebe49957db4264443b", "message": "Merge branch 'master' into milismsft-AAD\n\n# Conflicts:\n#\tsdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosAsyncClient.java", "committedDate": "2020-08-19T07:18:57Z", "type": "commit"}, {"oid": "9d6dfcdd71cadf2abca321ac885ba46dc241e1e1", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9d6dfcdd71cadf2abca321ac885ba46dc241e1e1", "message": "Add AAD authorization test against Cosmos public emulator.\nAdd implementation for missed cases where authorization token migt be computed.", "committedDate": "2020-08-19T08:46:47Z", "type": "commit"}, {"oid": "e2dace1819d32ef9b2a757048751bd8e3b6f40c6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e2dace1819d32ef9b2a757048751bd8e3b6f40c6", "message": "Merge branch 'master' into milismsft-AAD", "committedDate": "2020-08-20T16:24:10Z", "type": "commit"}, {"oid": "01efb74129c407128bde632dd161d15ff86032ec", "url": "https://github.com/Azure/azure-sdk-for-java/commit/01efb74129c407128bde632dd161d15ff86032ec", "message": "update pom related dependency", "committedDate": "2020-08-20T17:09:51Z", "type": "commit"}, {"oid": "54b34497c9382b61e03d233af3292e357d855e09", "url": "https://github.com/Azure/azure-sdk-for-java/commit/54b34497c9382b61e03d233af3292e357d855e09", "message": "update pom dependency", "committedDate": "2020-08-20T17:33:15Z", "type": "commit"}, {"oid": "0de74f887d5f38bde1e45c0f047753942c5fc6bb", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0de74f887d5f38bde1e45c0f047753942c5fc6bb", "message": "test updates", "committedDate": "2020-08-21T16:24:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgwNTMwMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r474805301", "bodyText": "wrong merge, undo please.", "author": "moderakh", "createdAt": "2020-08-21T16:34:29Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosAsyncClient.java", "diffHunk": "@@ -246,8 +250,19 @@ boolean isContentResponseOnWriteEnabled() {\n      * @return the mono.\n      */\n     public Mono<CosmosDatabaseResponse> createDatabaseIfNotExists(String id, ThroughputProperties throughputProperties) {\n-        return withContext(context -> createDatabaseIfNotExistsInternal(getDatabase(id),\n-            throughputProperties, context));\n+        return this.getDatabase(id).read().onErrorResume(exception -> {", "originalCommit": "0de74f887d5f38bde1e45c0f047753942c5fc6bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk0MTk3Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r474941973", "bodyText": "fixed", "author": "milismsft", "createdAt": "2020-08-21T20:29:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgwNTMwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgwNjE0OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r474806148", "bodyText": "we are doing validation in build() for other cases.\nI wonder if we should set the others to null or we should validation in build()", "author": "moderakh", "createdAt": "2020-08-21T16:36:10Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosClientBuilder.java", "diffHunk": "@@ -199,7 +202,12 @@ CosmosAuthorizationTokenResolver getAuthorizationTokenResolver() {\n      */\n     CosmosClientBuilder authorizationTokenResolver(\n         CosmosAuthorizationTokenResolver cosmosAuthorizationTokenResolver) {\n-        this.cosmosAuthorizationTokenResolver = cosmosAuthorizationTokenResolver;\n+        this.cosmosAuthorizationTokenResolver = Objects.requireNonNull(cosmosAuthorizationTokenResolver,\n+            \"'cosmosAuthorizationTokenResolver' cannot be null.\");\n+        this.keyOrResourceToken = null;\n+        this.credential = null;\n+        this.permissions = null;\n+        this.tokenCredential = null;", "originalCommit": "0de74f887d5f38bde1e45c0f047753942c5fc6bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk2MjQ0OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r474962449", "bodyText": "only one of these members should be valid at a given time and the last setting should \"persist\". It is confusing to have multiple auth settings valid at the same time; that is why the reset.", "author": "milismsft", "createdAt": "2020-08-21T20:54:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgwNjE0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgwODI1Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r474808257", "bodyText": "this seems to be all constants except the last token. it has additional overhead.\nyou could have another constant which holds\nprivate static final String AUTH_PREFIX = \n AAD_AUTH_SCHEMA_TYPE_SEGMENT +\"=\" + AAD_AUTH_SCHEMA_TYPE_VALUE + \n AAD_AUTH_VERSION_SEGMENT + \"=\" + AAD_AUTH_VERSION_VALUE\n + AAD_AUTH_SIGNATURE_SEGMENT+ \"=\";", "author": "moderakh", "createdAt": "2020-08-21T16:40:29Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/AadTokenAuthorizationHelper.java", "diffHunk": "@@ -0,0 +1,68 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.implementation;\n+\n+import com.azure.core.credential.SimpleTokenCache;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import reactor.core.publisher.Mono;\n+\n+import java.io.UnsupportedEncodingException;\n+import java.net.URLEncoder;\n+\n+/**\n+ * This class is used internally and act as a helper in authorization of\n+ * AAD tokens and its supporting method.\n+ *\n+ */\n+public class AadTokenAuthorizationHelper {\n+    public static final String AAD_AUTH_SCHEMA_TYPE_SEGMENT = \"type\";\n+    public static final String AAD_AUTH_VERSION_SEGMENT = \"ver\";\n+    public static final String AAD_AUTH_SIGNATURE_SEGMENT = \"sig\";\n+    public static final String AAD_AUTH_SCHEMA_TYPE_VALUE = \"aad\";\n+    public static final String AAD_AUTH_VERSION_VALUE = \"1.0\";\n+    public static final String AAD_AUTH_TOKEN_COSMOS_SCOPE = \"https://cosmos.azure.com/.default\";\n+    private static final String AUTH_PREFIX = \"type=aad&ver=1.0&sig=\";\n+    private static final Logger logger = LoggerFactory.getLogger(AadTokenAuthorizationHelper.class);\n+\n+    /**\n+     * This method will try to fetch the AAD token to access the resource and add it to the request headers.\u2028\n+     *\n+     * @param request the request headers.\n+     * @param simpleTokenCache token cache that supports caching a token and refreshing it.\n+     * @return the request headers with authorization header updated.\n+     */\n+    public static Mono<RxDocumentServiceRequest> populateAuthorizationHeader(RxDocumentServiceRequest request, SimpleTokenCache simpleTokenCache) {\n+        if (request == null || request.getHeaders() == null) {\n+            throw new IllegalArgumentException(\"request\");\n+        }\n+        if (simpleTokenCache == null) {\n+            throw new IllegalArgumentException(\"simpleTokenCache\");\n+        }\n+\n+        return getAuthorizationToken(simpleTokenCache)\n+            .map(authorization -> {\n+                request.getHeaders().put(HttpConstants.HttpHeaders.AUTHORIZATION, authorization);\n+                return request;\n+            });\n+    }\n+\n+    public static Mono<String> getAuthorizationToken(SimpleTokenCache simpleTokenCache) {\n+        return simpleTokenCache.getToken()\n+            .map(accessToken -> {\n+                String authorization;\n+                StringBuilder authorizationBuilder = new StringBuilder()\n+                    .append(AAD_AUTH_SCHEMA_TYPE_SEGMENT).append(\"=\").append(AAD_AUTH_SCHEMA_TYPE_VALUE)\n+                    .append(AAD_AUTH_VERSION_SEGMENT).append(\"=\").append(AAD_AUTH_VERSION_VALUE)\n+                    .append(AAD_AUTH_SIGNATURE_SEGMENT).append(\"=\").append(accessToken.getToken());", "originalCommit": "0de74f887d5f38bde1e45c0f047753942c5fc6bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk1Mzc4Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r474953782", "bodyText": "fixed", "author": "milismsft", "createdAt": "2020-08-21T20:44:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgwODI1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgwOTI1Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r474809252", "bodyText": "These are available in TestConfiguration please use those.", "author": "moderakh", "createdAt": "2020-08-21T16:42:40Z", "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/rx/AadAuthorizationTests.java", "diffHunk": "@@ -0,0 +1,218 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.rx;\n+\n+import com.azure.core.credential.AccessToken;\n+import com.azure.core.credential.TokenCredential;\n+import com.azure.core.credential.TokenRequestContext;\n+import com.azure.cosmos.CosmosAsyncClient;\n+import com.azure.cosmos.CosmosAsyncContainer;\n+import com.azure.cosmos.CosmosAsyncDatabase;\n+import com.azure.cosmos.CosmosClientBuilder;\n+import com.azure.cosmos.implementation.InternalObjectNode;\n+import com.azure.cosmos.implementation.Utils;\n+import com.azure.cosmos.implementation.apachecommons.lang.RandomStringUtils;\n+import com.azure.cosmos.models.CosmosContainerResponse;\n+import com.azure.cosmos.models.CosmosDatabaseResponse;\n+import com.azure.cosmos.models.CosmosItemRequestOptions;\n+import com.azure.cosmos.models.CosmosItemResponse;\n+import com.azure.cosmos.models.CosmosQueryRequestOptions;\n+import com.azure.cosmos.models.PartitionKey;\n+import com.azure.cosmos.util.CosmosPagedFlux;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.BeforeMethod;\n+import org.testng.annotations.Factory;\n+import org.testng.annotations.Test;\n+import reactor.core.publisher.Flux;\n+import reactor.core.publisher.Mono;\n+\n+import java.time.OffsetDateTime;\n+import java.time.ZonedDateTime;\n+import java.util.List;\n+import java.util.Properties;\n+import java.util.UUID;\n+\n+public class AadAuthorizationTests extends TestSuiteBase {\n+    private final static Logger log = LoggerFactory.getLogger(AadAuthorizationTests.class);\n+    private static final ObjectMapper OBJECT_MAPPER = Utils.getSimpleObjectMapper();\n+\n+    protected AadAuthorizationTests() {\n+        super();\n+    }\n+\n+    private static Properties properties = System.getProperties();\n+\n+    private final static String EMULATOR_KEY = \"C2y6yDjf5/R+ob0N8A7Cgv30VRDJIWEHLM+4QDU5DE2nQ9nDuVTqobD4b8mGGyPMbIZnqyMsEcaGQy67XIw/Jw==\";\n+    private final static String HOST = \"https://localhost:8081/\";", "originalCommit": "0de74f887d5f38bde1e45c0f047753942c5fc6bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDkyNTY0MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r474925641", "bodyText": "Not exactly; TestConfigurations sets ACCOUNT_HOST and ACCOUNT_KEY and depending on the environment or properties being set they might default to the public emulator settings.\nSince this test might also serve as sample I'll prefer to leave those constants in the test so anyone looking for an AAD using emulator sample has all the elements they need in the respective test file.", "author": "milismsft", "createdAt": "2020-08-21T20:09:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgwOTI1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTcxNzkxMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r475717912", "bodyText": "for both CI to pass and also local debugging for all tests we are relying on the TestConfiguration file.\nPlease change to follow the same pattern. If you need different pattern for sample, please create a sample file:\nhttps://github.com/Azure/azure-sdk-for-java/tree/master/sdk/cosmos/azure-cosmos/src/samples/java/com/azure/cosmos", "author": "moderakh", "createdAt": "2020-08-24T15:54:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgwOTI1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgxODU5OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r474818599", "bodyText": "we use a pattern for the database test-names. This will also ensure if there is a any db left over, gets cleanup by the next test run:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private final String databaseId = \"dbAad\" + RandomStringUtils.randomAlphabetic(6);;\n          \n          \n            \n                private final String databaseId = CosmosDatabaseForTest.generateId();\n          \n      \n    \n    \n  \n\nplease follow this pattern.", "author": "moderakh", "createdAt": "2020-08-21T17:01:24Z", "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/rx/AadAuthorizationTests.java", "diffHunk": "@@ -0,0 +1,218 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.rx;\n+\n+import com.azure.core.credential.AccessToken;\n+import com.azure.core.credential.TokenCredential;\n+import com.azure.core.credential.TokenRequestContext;\n+import com.azure.cosmos.CosmosAsyncClient;\n+import com.azure.cosmos.CosmosAsyncContainer;\n+import com.azure.cosmos.CosmosAsyncDatabase;\n+import com.azure.cosmos.CosmosClientBuilder;\n+import com.azure.cosmos.implementation.InternalObjectNode;\n+import com.azure.cosmos.implementation.Utils;\n+import com.azure.cosmos.implementation.apachecommons.lang.RandomStringUtils;\n+import com.azure.cosmos.models.CosmosContainerResponse;\n+import com.azure.cosmos.models.CosmosDatabaseResponse;\n+import com.azure.cosmos.models.CosmosItemRequestOptions;\n+import com.azure.cosmos.models.CosmosItemResponse;\n+import com.azure.cosmos.models.CosmosQueryRequestOptions;\n+import com.azure.cosmos.models.PartitionKey;\n+import com.azure.cosmos.util.CosmosPagedFlux;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.BeforeMethod;\n+import org.testng.annotations.Factory;\n+import org.testng.annotations.Test;\n+import reactor.core.publisher.Flux;\n+import reactor.core.publisher.Mono;\n+\n+import java.time.OffsetDateTime;\n+import java.time.ZonedDateTime;\n+import java.util.List;\n+import java.util.Properties;\n+import java.util.UUID;\n+\n+public class AadAuthorizationTests extends TestSuiteBase {\n+    private final static Logger log = LoggerFactory.getLogger(AadAuthorizationTests.class);\n+    private static final ObjectMapper OBJECT_MAPPER = Utils.getSimpleObjectMapper();\n+\n+    protected AadAuthorizationTests() {\n+        super();\n+    }\n+\n+    private static Properties properties = System.getProperties();\n+\n+    private final static String EMULATOR_KEY = \"C2y6yDjf5/R+ob0N8A7Cgv30VRDJIWEHLM+4QDU5DE2nQ9nDuVTqobD4b8mGGyPMbIZnqyMsEcaGQy67XIw/Jw==\";\n+    private final static String HOST = \"https://localhost:8081/\";\n+\n+    private final static String PARTITION_KEY_PATH = \"/mypk\";\n+    private final String databaseId = \"dbAad\" + RandomStringUtils.randomAlphabetic(6);;", "originalCommit": "0de74f887d5f38bde1e45c0f047753942c5fc6bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDkyNjYwMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r474926602", "bodyText": "fixed", "author": "milismsft", "createdAt": "2020-08-21T20:10:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgxODU5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgxOTk4NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r474819985", "bodyText": "you are creating the clients yourself, so please remove this constructor. This will confuse the test infra and will re-run this test multiple times unnecessarily.", "author": "moderakh", "createdAt": "2020-08-21T17:04:31Z", "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/rx/AadAuthorizationTests.java", "diffHunk": "@@ -0,0 +1,218 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.rx;\n+\n+import com.azure.core.credential.AccessToken;\n+import com.azure.core.credential.TokenCredential;\n+import com.azure.core.credential.TokenRequestContext;\n+import com.azure.cosmos.CosmosAsyncClient;\n+import com.azure.cosmos.CosmosAsyncContainer;\n+import com.azure.cosmos.CosmosAsyncDatabase;\n+import com.azure.cosmos.CosmosClientBuilder;\n+import com.azure.cosmos.implementation.InternalObjectNode;\n+import com.azure.cosmos.implementation.Utils;\n+import com.azure.cosmos.implementation.apachecommons.lang.RandomStringUtils;\n+import com.azure.cosmos.models.CosmosContainerResponse;\n+import com.azure.cosmos.models.CosmosDatabaseResponse;\n+import com.azure.cosmos.models.CosmosItemRequestOptions;\n+import com.azure.cosmos.models.CosmosItemResponse;\n+import com.azure.cosmos.models.CosmosQueryRequestOptions;\n+import com.azure.cosmos.models.PartitionKey;\n+import com.azure.cosmos.util.CosmosPagedFlux;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.BeforeMethod;\n+import org.testng.annotations.Factory;\n+import org.testng.annotations.Test;\n+import reactor.core.publisher.Flux;\n+import reactor.core.publisher.Mono;\n+\n+import java.time.OffsetDateTime;\n+import java.time.ZonedDateTime;\n+import java.util.List;\n+import java.util.Properties;\n+import java.util.UUID;\n+\n+public class AadAuthorizationTests extends TestSuiteBase {\n+    private final static Logger log = LoggerFactory.getLogger(AadAuthorizationTests.class);\n+    private static final ObjectMapper OBJECT_MAPPER = Utils.getSimpleObjectMapper();\n+\n+    protected AadAuthorizationTests() {\n+        super();\n+    }\n+\n+    private static Properties properties = System.getProperties();\n+\n+    private final static String EMULATOR_KEY = \"C2y6yDjf5/R+ob0N8A7Cgv30VRDJIWEHLM+4QDU5DE2nQ9nDuVTqobD4b8mGGyPMbIZnqyMsEcaGQy67XIw/Jw==\";\n+    private final static String HOST = \"https://localhost:8081/\";\n+\n+    private final static String PARTITION_KEY_PATH = \"/mypk\";\n+    private final String databaseId = \"dbAad\" + RandomStringUtils.randomAlphabetic(6);;\n+\n+\n+    @Test(groups = { \"emulator\" }, timeOut = 2 * TIMEOUT)\n+    public void createAadTokenCredential() throws InterruptedException {\n+        TokenCredential emulatorCredential = new AadSimpleEmulatorTokenCredential(EMULATOR_KEY);\n+\n+        CosmosAsyncDatabase db = null;\n+\n+        CosmosAsyncClient cosmosAsyncClient = new CosmosClientBuilder()\n+            .endpoint(HOST)\n+            .key(EMULATOR_KEY)\n+            .credential(emulatorCredential)\n+            .buildAsyncClient();\n+\n+        CosmosAsyncClient cosmosAadClient = new CosmosClientBuilder()\n+            .endpoint(HOST)\n+            .credential(emulatorCredential)\n+            .buildAsyncClient();\n+\n+        try {\n+            CosmosDatabaseResponse databaseResponse = cosmosAsyncClient.createDatabase(databaseId).block();\n+\n+            db = cosmosAadClient.getDatabase(databaseId).read()\n+                .map(dabaseResponse -> {\n+                    CosmosAsyncDatabase database = cosmosAadClient.getDatabase(dabaseResponse.getProperties().getId());\n+                    log.info(\"Found database {} with {}\", database.getId(), dabaseResponse.getProperties().getETag());\n+                    return database;\n+                }).block();\n+\n+            // CREATE collection\n+            assert db != null;\n+            String containerName = UUID.randomUUID().toString();\n+            CosmosContainerResponse containerResponse = cosmosAsyncClient.getDatabase(databaseId).createContainer(containerName, PARTITION_KEY_PATH).block();\n+\n+            CosmosAsyncContainer container = db.getContainer(containerName).read()\n+                .map(cosmosContainerResponse -> {\n+                    CosmosAsyncContainer container1 = cosmosAadClient.getDatabase(databaseId).getContainer(cosmosContainerResponse.getProperties().getId());\n+                    log.info(\"Found container {} with {}\", container1.getId(), cosmosContainerResponse.getProperties().getETag());\n+                    return container1;\n+                }).block();\n+\n+            // CREATE document\n+            assert container != null;\n+            String itemName = UUID.randomUUID().toString();\n+            String partitionKeyValue = UUID.randomUUID().toString();\n+            InternalObjectNode properties = getDocumentDefinition(itemName, partitionKeyValue);\n+\n+            CosmosItemResponse<InternalObjectNode> cosmosItemResponse = container.createItem(properties, new CosmosItemRequestOptions()).block();\n+\n+            CosmosItemRequestOptions options = new CosmosItemRequestOptions();\n+            InternalObjectNode item = container\n+                .readItem(itemName, new PartitionKey(partitionKeyValue), options, InternalObjectNode.class)\n+                .map(CosmosItemResponse::getItem)\n+                .map(jsonNode -> {\n+                    log.info(\"Found item with content: \" + jsonNode.toString());\n+                    return jsonNode;\n+                }).block();\n+            assert item != null;\n+\n+            // QUERY document\n+            CosmosQueryRequestOptions requestOptions = new CosmosQueryRequestOptions();\n+            CosmosPagedFlux<JsonNode> queryPagedFlux = container\n+                .queryItems(\"SELECT * FROM c\", requestOptions, JsonNode.class);\n+            List<JsonNode> feedResponse = queryPagedFlux.byPage()\n+                .flatMap(jsonNodeFeedResponse -> {\n+                    return Flux.fromIterable(jsonNodeFeedResponse.getResults());\n+                }).map(jsonNode -> {\n+                    log.info(\"Found item with content: \" + jsonNode.toString());\n+                    return jsonNode;\n+                })\n+                .collectList()\n+                .block();\n+\n+            // DELETE document\n+            container.deleteItem(item.getId(), new PartitionKey(partitionKeyValue));\n+\n+        } finally {\n+            if (db != null) {\n+                cosmosAsyncClient.getDatabase(databaseId).delete().block();\n+            }\n+\n+            if (cosmosAadClient != null) {\n+                safeClose(cosmosAadClient);\n+            }\n+\n+            if (cosmosAsyncClient != null) {\n+                safeClose(cosmosAsyncClient);\n+            }\n+        }\n+\n+        Thread.sleep(5000);\n+    }\n+\n+    private InternalObjectNode getDocumentDefinition(String itemId, String partitionKeyValue) {\n+        final InternalObjectNode properties = new InternalObjectNode(String.format(\"{ \"\n+                + \"\\\"id\\\": \\\"%s\\\", \"\n+                + \"\\\"mypk\\\": \\\"%s\\\", \"\n+                + \"\\\"sgmts\\\": [[6519456, 1471916863], [2498434, 1455671440]]\"\n+                + \"}\"\n+            , itemId, partitionKeyValue));\n+        return properties;\n+    }\n+\n+    @Factory(dataProvider = \"clientBuilders\")\n+    public AadAuthorizationTests(CosmosClientBuilder clientBuilder) {\n+        super(clientBuilder);\n+    }", "originalCommit": "0de74f887d5f38bde1e45c0f047753942c5fc6bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDkyODU4MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r474928581", "bodyText": "fixed", "author": "milismsft", "createdAt": "2020-08-21T20:13:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgxOTk4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTcxODkzNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r475718936", "bodyText": "seems this one is missed. Please remove.", "author": "moderakh", "createdAt": "2020-08-24T15:56:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgxOTk4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjE5NzgxOA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r476197818", "bodyText": "thank you.", "author": "moderakh", "createdAt": "2020-08-25T06:05:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgxOTk4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgyMDkzMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r474820930", "bodyText": "please don't rely on InternalObjectNode for the new tests. we want to move away the end users to use ObjectNode instead and these tests may get used as samples.\nPlease either use a pojo or use ObjectNode.", "author": "moderakh", "createdAt": "2020-08-21T17:06:29Z", "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/rx/AadAuthorizationTests.java", "diffHunk": "@@ -0,0 +1,218 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.rx;\n+\n+import com.azure.core.credential.AccessToken;\n+import com.azure.core.credential.TokenCredential;\n+import com.azure.core.credential.TokenRequestContext;\n+import com.azure.cosmos.CosmosAsyncClient;\n+import com.azure.cosmos.CosmosAsyncContainer;\n+import com.azure.cosmos.CosmosAsyncDatabase;\n+import com.azure.cosmos.CosmosClientBuilder;\n+import com.azure.cosmos.implementation.InternalObjectNode;\n+import com.azure.cosmos.implementation.Utils;\n+import com.azure.cosmos.implementation.apachecommons.lang.RandomStringUtils;\n+import com.azure.cosmos.models.CosmosContainerResponse;\n+import com.azure.cosmos.models.CosmosDatabaseResponse;\n+import com.azure.cosmos.models.CosmosItemRequestOptions;\n+import com.azure.cosmos.models.CosmosItemResponse;\n+import com.azure.cosmos.models.CosmosQueryRequestOptions;\n+import com.azure.cosmos.models.PartitionKey;\n+import com.azure.cosmos.util.CosmosPagedFlux;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.BeforeMethod;\n+import org.testng.annotations.Factory;\n+import org.testng.annotations.Test;\n+import reactor.core.publisher.Flux;\n+import reactor.core.publisher.Mono;\n+\n+import java.time.OffsetDateTime;\n+import java.time.ZonedDateTime;\n+import java.util.List;\n+import java.util.Properties;\n+import java.util.UUID;\n+\n+public class AadAuthorizationTests extends TestSuiteBase {\n+    private final static Logger log = LoggerFactory.getLogger(AadAuthorizationTests.class);\n+    private static final ObjectMapper OBJECT_MAPPER = Utils.getSimpleObjectMapper();\n+\n+    protected AadAuthorizationTests() {\n+        super();\n+    }\n+\n+    private static Properties properties = System.getProperties();\n+\n+    private final static String EMULATOR_KEY = \"C2y6yDjf5/R+ob0N8A7Cgv30VRDJIWEHLM+4QDU5DE2nQ9nDuVTqobD4b8mGGyPMbIZnqyMsEcaGQy67XIw/Jw==\";\n+    private final static String HOST = \"https://localhost:8081/\";\n+\n+    private final static String PARTITION_KEY_PATH = \"/mypk\";\n+    private final String databaseId = \"dbAad\" + RandomStringUtils.randomAlphabetic(6);;\n+\n+\n+    @Test(groups = { \"emulator\" }, timeOut = 2 * TIMEOUT)\n+    public void createAadTokenCredential() throws InterruptedException {\n+        TokenCredential emulatorCredential = new AadSimpleEmulatorTokenCredential(EMULATOR_KEY);\n+\n+        CosmosAsyncDatabase db = null;\n+\n+        CosmosAsyncClient cosmosAsyncClient = new CosmosClientBuilder()\n+            .endpoint(HOST)\n+            .key(EMULATOR_KEY)\n+            .credential(emulatorCredential)\n+            .buildAsyncClient();\n+\n+        CosmosAsyncClient cosmosAadClient = new CosmosClientBuilder()\n+            .endpoint(HOST)\n+            .credential(emulatorCredential)\n+            .buildAsyncClient();\n+\n+        try {\n+            CosmosDatabaseResponse databaseResponse = cosmosAsyncClient.createDatabase(databaseId).block();\n+\n+            db = cosmosAadClient.getDatabase(databaseId).read()\n+                .map(dabaseResponse -> {\n+                    CosmosAsyncDatabase database = cosmosAadClient.getDatabase(dabaseResponse.getProperties().getId());\n+                    log.info(\"Found database {} with {}\", database.getId(), dabaseResponse.getProperties().getETag());\n+                    return database;\n+                }).block();\n+\n+            // CREATE collection\n+            assert db != null;\n+            String containerName = UUID.randomUUID().toString();\n+            CosmosContainerResponse containerResponse = cosmosAsyncClient.getDatabase(databaseId).createContainer(containerName, PARTITION_KEY_PATH).block();\n+\n+            CosmosAsyncContainer container = db.getContainer(containerName).read()\n+                .map(cosmosContainerResponse -> {\n+                    CosmosAsyncContainer container1 = cosmosAadClient.getDatabase(databaseId).getContainer(cosmosContainerResponse.getProperties().getId());\n+                    log.info(\"Found container {} with {}\", container1.getId(), cosmosContainerResponse.getProperties().getETag());\n+                    return container1;\n+                }).block();\n+\n+            // CREATE document\n+            assert container != null;\n+            String itemName = UUID.randomUUID().toString();\n+            String partitionKeyValue = UUID.randomUUID().toString();\n+            InternalObjectNode properties = getDocumentDefinition(itemName, partitionKeyValue);\n+\n+            CosmosItemResponse<InternalObjectNode> cosmosItemResponse = container.createItem(properties, new CosmosItemRequestOptions()).block();\n+\n+            CosmosItemRequestOptions options = new CosmosItemRequestOptions();\n+            InternalObjectNode item = container\n+                .readItem(itemName, new PartitionKey(partitionKeyValue), options, InternalObjectNode.class)\n+                .map(CosmosItemResponse::getItem)\n+                .map(jsonNode -> {\n+                    log.info(\"Found item with content: \" + jsonNode.toString());\n+                    return jsonNode;\n+                }).block();\n+            assert item != null;\n+\n+            // QUERY document\n+            CosmosQueryRequestOptions requestOptions = new CosmosQueryRequestOptions();\n+            CosmosPagedFlux<JsonNode> queryPagedFlux = container\n+                .queryItems(\"SELECT * FROM c\", requestOptions, JsonNode.class);\n+            List<JsonNode> feedResponse = queryPagedFlux.byPage()\n+                .flatMap(jsonNodeFeedResponse -> {\n+                    return Flux.fromIterable(jsonNodeFeedResponse.getResults());\n+                }).map(jsonNode -> {\n+                    log.info(\"Found item with content: \" + jsonNode.toString());\n+                    return jsonNode;\n+                })\n+                .collectList()\n+                .block();\n+\n+            // DELETE document\n+            container.deleteItem(item.getId(), new PartitionKey(partitionKeyValue));\n+\n+        } finally {\n+            if (db != null) {\n+                cosmosAsyncClient.getDatabase(databaseId).delete().block();\n+            }\n+\n+            if (cosmosAadClient != null) {\n+                safeClose(cosmosAadClient);\n+            }\n+\n+            if (cosmosAsyncClient != null) {\n+                safeClose(cosmosAsyncClient);\n+            }\n+        }\n+\n+        Thread.sleep(5000);\n+    }\n+\n+    private InternalObjectNode getDocumentDefinition(String itemId, String partitionKeyValue) {", "originalCommit": "0de74f887d5f38bde1e45c0f047753942c5fc6bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDkzOTQ0OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r474939448", "bodyText": "fixed", "author": "milismsft", "createdAt": "2020-08-21T20:26:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgyMDkzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgyMTY0NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r474821645", "bodyText": "good change. thanks.", "author": "moderakh", "createdAt": "2020-08-21T17:08:01Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/GatewayAddressCache.java", "diffHunk": "@@ -267,42 +267,48 @@ public GatewayAddressCache(\n \n         addressQuery.put(HttpConstants.QueryStrings.PARTITION_KEY_RANGE_IDS, String.join(\",\", partitionKeyRangeIds));\n         headers.put(HttpConstants.HttpHeaders.X_DATE, Utils.nowAsRFC1123());\n-        String token;\n-\n-        token = this.tokenProvider.getUserAuthorizationToken(\n-                collectionRid,\n-                ResourceType.Document,\n-                RequestVerb.GET,\n-                headers,\n-                AuthorizationTokenType.PrimaryMasterKey,\n-                request.properties);\n-\n-        if (token == null && request.getIsNameBased()) {\n-            // User doesn't have rid based resource token. Maybe user has name based.\n-            String collectionAltLink = PathsHelper.getCollectionPath(request.getResourceAddress());\n-            token = this.tokenProvider.getUserAuthorizationToken(\n-                    collectionAltLink,\n+\n+        if (tokenProvider.getAuthorizationTokenType() != AuthorizationTokenType.AadToken) {\n+            String token = this.tokenProvider.getUserAuthorizationToken(\n+                    collectionRid,\n                     ResourceType.Document,\n                     RequestVerb.GET,\n                     headers,\n                     AuthorizationTokenType.PrimaryMasterKey,\n                     request.properties);\n+\n+            if (token == null && request.getIsNameBased()) {\n+                // User doesn't have rid based resource token. Maybe user has name based.\n+                String collectionAltLink = PathsHelper.getCollectionPath(request.getResourceAddress());\n+                token = this.tokenProvider.getUserAuthorizationToken(\n+                        collectionAltLink,\n+                        ResourceType.Document,\n+                        RequestVerb.GET,\n+                        headers,\n+                        AuthorizationTokenType.PrimaryMasterKey,\n+                        request.properties);\n+            }\n+\n+            token = HttpUtils.urlEncode(token);\n+            headers.put(HttpConstants.HttpHeaders.AUTHORIZATION, token);\n         }\n \n-        token = HttpUtils.urlEncode(token);\n-        headers.put(HttpConstants.HttpHeaders.AUTHORIZATION, token);\n         URI targetEndpoint = Utils.setQuery(this.addressEndpoint.toString(), Utils.createQuery(addressQuery));\n         String identifier = logAddressResolutionStart(request, targetEndpoint);\n \n-        HttpHeaders httpHeaders = new HttpHeaders(headers.size());\n-        for (Map.Entry<String, String> entry : headers.entrySet()) {\n-            httpHeaders.set(entry.getKey(), entry.getValue());\n-        }\n+        HttpHeaders httpHeaders = new HttpHeaders(headers);", "originalCommit": "0de74f887d5f38bde1e45c0f047753942c5fc6bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgyMjQ5OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r474822498", "bodyText": "good change. thanks.", "author": "moderakh", "createdAt": "2020-08-21T17:09:55Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/TestConfigurations.java", "diffHunk": "@@ -51,7 +51,7 @@\n         properties.getProperty(\"ACCOUNT_HOST\",\n                     StringUtils.defaultString(Strings.emptyToNull(\n                             System.getenv().get(\"ACCOUNT_HOST\")),\n-                            \"https://localhost:443/\"));\n+                            \"https://localhost:8081/\"));", "originalCommit": "0de74f887d5f38bde1e45c0f047753942c5fc6bb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgyMjk3MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r474822970", "bodyText": "why do we need this one?", "author": "moderakh", "createdAt": "2020-08-21T17:10:49Z", "path": "sdk/cosmos/azure-cosmos/pom.xml", "diffHunk": "@@ -128,6 +128,20 @@ Licensed under the MIT License.\n         </exclusion>\n       </exclusions>\n     </dependency>\n+    <dependency>\n+      <groupId>com.azure</groupId>\n+      <artifactId>azure-identity</artifactId>\n+      <version>1.1.0</version> <!-- {x-version-update;com.azure:azure-identity;dependency} -->\n+      <scope>test</scope>\n+    </dependency>\n+\n+    <dependency>\n+      <groupId>com.azure</groupId>\n+      <artifactId>azure-core-http-netty</artifactId>", "originalCommit": "0de74f887d5f38bde1e45c0f047753942c5fc6bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk0MzI4NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r474943284", "bodyText": "SimpleCacheToken requires an HTTP client implementation to be available (it looks for it via reflection).", "author": "milismsft", "createdAt": "2020-08-21T20:31:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgyMjk3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTcxMzk4NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r475713985", "bodyText": "Thanks for the explanation. In that case we need to ensure we are not bringing the netty-tcnative transitive dependency through azure-core-http-netty->azure-core->netty-tcnative* as due to a bug in RNTBD, netty-tcnative* will cause problem:\nsee this for more detail: #7829\nPlease exclude the conflicting transitive dependency.", "author": "moderakh", "createdAt": "2020-08-24T15:48:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgyMjk3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTgzNjY1Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r475836657", "bodyText": "We are not bringing that particular dependency:\n... [INFO] +- com.azure:azure-core-http-netty:jar:1.5.4:compile [INFO] |  \\- io.netty:netty-transport-native-kqueue:jar:osx-x86_64:4.1.51.Final:compile ...", "author": "milismsft", "createdAt": "2020-08-24T19:13:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgyMjk3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg2NTUyNw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r475865527", "bodyText": "hmm,\nplease check here:\nfrom here: azure-core-http-netty has dependency on azure-core\nhttps://mvnrepository.com/artifact/com.azure/azure-core-http-netty/1.5.4\nand azure-core has dependency on nett-tcnative-boringssl\nhttps://mvnrepository.com/artifact/com.azure/azure-core/1.7.0", "author": "moderakh", "createdAt": "2020-08-24T20:10:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgyMjk3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjA1OTI5Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r476059292", "bodyText": "added exclusion directives for \"azure-core\"", "author": "milismsft", "createdAt": "2020-08-25T01:59:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgyMjk3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgyNDMxMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r474824312", "bodyText": "once everything is ready on this PR we need to do a perf test to ensure we don't have perf degradation.\nIf you haven't done perf tests before, ping me offline I will show you how to run the perf tests.", "author": "moderakh", "createdAt": "2020-08-21T17:13:35Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/RxDocumentClientImpl.java", "diffHunk": "@@ -783,38 +820,42 @@ private String parentResourceLinkToQueryLink(String parentResouceLink, ResourceT\n     }\n \n     private Mono<RxDocumentServiceResponse> delete(RxDocumentServiceRequest request, DocumentClientRetryPolicy documentClientRetryPolicy) {\n-        populateHeaders(request, RequestVerb.DELETE);\n-        if(request.requestContext != null && documentClientRetryPolicy.getRetryCount() > 0) {\n-            documentClientRetryPolicy.updateEndTime();\n-            request.requestContext.updateRetryContext(documentClientRetryPolicy, true);\n-        }\n+        return populateHeaders(request, RequestVerb.DELETE)\n+            .flatMap(requestPopulated -> {\n+                if (requestPopulated.requestContext != null && documentClientRetryPolicy.getRetryCount() > 0) {\n+                    documentClientRetryPolicy.updateEndTime();\n+                    requestPopulated.requestContext.updateRetryContext(documentClientRetryPolicy, true);\n+                }\n \n-        return getStoreProxy(request).processMessage(request);\n+                return getStoreProxy(requestPopulated).processMessage(requestPopulated);\n+            });\n     }\n \n     private Mono<RxDocumentServiceResponse> read(RxDocumentServiceRequest request, DocumentClientRetryPolicy documentClientRetryPolicy) {\n-        populateHeaders(request, RequestVerb.GET);\n-        if(request.requestContext != null && documentClientRetryPolicy.getRetryCount() > 0) {\n-            documentClientRetryPolicy.updateEndTime();\n-            request.requestContext.updateRetryContext(documentClientRetryPolicy, true);\n-        }\n-\n-        return getStoreProxy(request).processMessage(request);\n+        return populateHeaders(request, RequestVerb.GET)\n+            .flatMap(requestPopulated -> {\n+                    if (requestPopulated.requestContext != null && documentClientRetryPolicy.getRetryCount() > 0) {\n+                        documentClientRetryPolicy.updateEndTime();\n+                        requestPopulated.requestContext.updateRetryContext(documentClientRetryPolicy, true);\n+                    }\n+                return getStoreProxy(requestPopulated).processMessage(requestPopulated);", "originalCommit": "0de74f887d5f38bde1e45c0f047753942c5fc6bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDkyMjAyMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r474922020", "bodyText": "I would not expect this change to add any perf impact since we basically move populating the auth header as part of the mono execution when subscribed to it.\nBut yes, to be sure, let's do a perf test.", "author": "milismsft", "createdAt": "2020-08-21T20:04:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgyNDMxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDkyOTY3Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r474929677", "bodyText": "map -> flatMap changes the async flow.", "author": "moderakh", "createdAt": "2020-08-21T20:14:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgyNDMxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgyNTg4Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r474825883", "bodyText": "I thought authorization token is always set on the RxDocumentServiceRequest directly.\ndo we need to set it on HttpHeaders too?", "author": "moderakh", "createdAt": "2020-08-21T17:16:45Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/IAuthorizationTokenProvider.java", "diffHunk": "@@ -11,4 +14,9 @@ String getUserAuthorizationToken(String resourceAddress,\n                                      Map<String, String> headers,\n                                      AuthorizationTokenType primarymasterkey,\n                                      Map<String, Object> properties);\n+\n+    Mono<RxDocumentServiceRequest> populateAuthorizationHeader(RxDocumentServiceRequest request);\n+    Mono<HttpHeaders> populateAuthorizationHeader(HttpHeaders httpHeaders);", "originalCommit": "0de74f887d5f38bde1e45c0f047753942c5fc6bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk1ODQ4OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r474958489", "bodyText": "Yes, there are couple calls to get the authorization token that operate on HttpHeaders (see GatewayAddressCache).", "author": "milismsft", "createdAt": "2020-08-21T20:49:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgyNTg4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTcxNTYxMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r475715613", "bodyText": "makes sense. thanks for the explanation.", "author": "moderakh", "createdAt": "2020-08-24T15:51:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDgyNTg4Mw=="}], "type": "inlineReview"}, {"oid": "71164d553f4d1adfd44aac3b38be0a3828283238", "url": "https://github.com/Azure/azure-sdk-for-java/commit/71164d553f4d1adfd44aac3b38be0a3828283238", "message": "address PR feedback", "committedDate": "2020-08-21T20:38:14Z", "type": "commit"}, {"oid": "d59df4db2a231bdac6d3a3a4a52062f926f4d106", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d59df4db2a231bdac6d3a3a4a52062f926f4d106", "message": "address PR feedback", "committedDate": "2020-08-21T20:43:46Z", "type": "commit"}, {"oid": "9850b6782c187562bca04768a6dfb54da39635f0", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9850b6782c187562bca04768a6dfb54da39635f0", "message": "Bug fixes.", "committedDate": "2020-08-22T06:07:36Z", "type": "commit"}, {"oid": "3a74f59f5fbcd548194e157f26418146f85b780a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3a74f59f5fbcd548194e157f26418146f85b780a", "message": "enable AAD auth in the Cosmos public emulator", "committedDate": "2020-08-22T19:15:10Z", "type": "commit"}, {"oid": "2308cab17633eda4450e9cba176f85cd371fe3a3", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2308cab17633eda4450e9cba176f85cd371fe3a3", "message": "update Cosmos emulator startup switch", "committedDate": "2020-08-23T18:18:08Z", "type": "commit"}, {"oid": "baf4dba090de7112d03bff3969a1af9599b0ad57", "url": "https://github.com/Azure/azure-sdk-for-java/commit/baf4dba090de7112d03bff3969a1af9599b0ad57", "message": "update test case to separate access via different clients", "committedDate": "2020-08-24T05:02:56Z", "type": "commit"}, {"oid": "45c777f4e16a5bb54917ded4e18b5bc5315fd76d", "url": "https://github.com/Azure/azure-sdk-for-java/commit/45c777f4e16a5bb54917ded4e18b5bc5315fd76d", "message": "Merge branch 'milismsft-AAD' of https://github.com/milismsft/azure-sdk-for-java into milismsft-AAD", "committedDate": "2020-08-24T05:05:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTcyNjg5Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r475726897", "bodyText": "thanks for fixing the javadoc.", "author": "moderakh", "createdAt": "2020-08-24T16:08:12Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosClientBuilder.java", "diffHunk": "@@ -241,12 +249,16 @@ String getKey() {\n      * @return current Builder.\n      */\n     public CosmosClientBuilder key(String key) {\n-        this.keyOrResourceToken = key;\n+        this.keyOrResourceToken = Objects.requireNonNull(key, \"'key' cannot be null.\");\n+        this.cosmosAuthorizationTokenResolver = null;\n+        this.credential = null;\n+        this.permissions = null;\n+        this.tokenCredential = null;\n         return this;\n     }\n \n     /**\n-     * Sets a resource token used to perform authentication\n+     * Gets a resource token used to perform authentication", "originalCommit": "45c777f4e16a5bb54917ded4e18b5bc5315fd76d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0d33634427268eed7ec7df9bc0656c452d45cb6c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0d33634427268eed7ec7df9bc0656c452d45cb6c", "message": "Address PR feedback.", "committedDate": "2020-08-25T00:38:32Z", "type": "commit"}, {"oid": "689cf963c0b3ed2bffd0d1d6d6399f975882e913", "url": "https://github.com/Azure/azure-sdk-for-java/commit/689cf963c0b3ed2bffd0d1d6d6399f975882e913", "message": "Remove constructor which creates unused Cosmos resources.", "committedDate": "2020-08-25T00:55:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjAyMTU2NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r476021564", "bodyText": "why are we defining new public property for something which is already available?\nI thought the plan was to reuse TestConfiguration.HOST\non the CI the value for TestConfiguration.HOST will be populated by the CI.\nin local debugging that can be populated from a properties file from user home.\nThis breaks that.", "author": "moderakh", "createdAt": "2020-08-25T01:02:16Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/TestConfigurations.java", "diffHunk": "@@ -32,26 +32,28 @@\n     private static Logger logger = LoggerFactory.getLogger(TestConfigurations.class);\n     private static Properties properties = loadProperties();\n \n+    public final static String COSMOS_EMULATOR_KEY = \"C2y6yDjf5/R+ob0N8A7Cgv30VRDJIWEHLM+4QDU5DE2nQ9nDuVTqobD4b8mGGyPMbIZnqyMsEcaGQy67XIw/Jw==\";\n+    public final static String COSMOS_EMULATOR_HOST = \"https://localhost:8081/\";", "originalCommit": "689cf963c0b3ed2bffd0d1d6d6399f975882e913", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjA1OTkzNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r476059935", "bodyText": "added comments for the test specific expectations and change to rely on MASTER_KEY and HOST", "author": "milismsft", "createdAt": "2020-08-25T02:00:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjAyMTU2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjAyMjE1NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r476022154", "bodyText": "why are we defining new public property for something which is already available?\nI thought the plan was to reuse TestConfiguration.HOST and not redefine a constant for the same thing.\n\non the CI the value for TestConfiguration.HOST will be populated by the CI.\nin local debugging that can be populated from a properties file from user home.\n\nThis breaks both 1) and 2).", "author": "moderakh", "createdAt": "2020-08-25T01:03:13Z", "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/rx/AadAuthorizationTests.java", "diffHunk": "@@ -0,0 +1,220 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.rx;\n+\n+import com.azure.core.credential.AccessToken;\n+import com.azure.core.credential.TokenCredential;\n+import com.azure.core.credential.TokenRequestContext;\n+import com.azure.cosmos.CosmosAsyncClient;\n+import com.azure.cosmos.CosmosAsyncContainer;\n+import com.azure.cosmos.CosmosAsyncDatabase;\n+import com.azure.cosmos.CosmosClientBuilder;\n+import com.azure.cosmos.CosmosDatabaseForTest;\n+import com.azure.cosmos.implementation.InternalObjectNode;\n+import com.azure.cosmos.implementation.TestConfigurations;\n+import com.azure.cosmos.implementation.Utils;\n+import com.azure.cosmos.models.CosmosContainerResponse;\n+import com.azure.cosmos.models.CosmosDatabaseResponse;\n+import com.azure.cosmos.models.CosmosItemRequestOptions;\n+import com.azure.cosmos.models.CosmosItemResponse;\n+import com.azure.cosmos.models.CosmosQueryRequestOptions;\n+import com.azure.cosmos.models.PartitionKey;\n+import com.azure.cosmos.util.CosmosPagedFlux;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.BeforeMethod;\n+import org.testng.annotations.Factory;\n+import org.testng.annotations.Test;\n+import reactor.core.publisher.Flux;\n+import reactor.core.publisher.Mono;\n+\n+import java.time.OffsetDateTime;\n+import java.time.ZonedDateTime;\n+import java.util.List;\n+import java.util.Properties;\n+import java.util.UUID;\n+\n+public class AadAuthorizationTests extends TestSuiteBase {\n+    private final static Logger log = LoggerFactory.getLogger(AadAuthorizationTests.class);\n+    private static final ObjectMapper OBJECT_MAPPER = Utils.getSimpleObjectMapper();\n+\n+    private final static String PARTITION_KEY_PATH = \"/mypk\";\n+    private final String databaseId = CosmosDatabaseForTest.generateId();\n+\n+    protected AadAuthorizationTests() {\n+    }\n+\n+    @Test(groups = { \"emulator\" }, timeOut = 10 * TIMEOUT)\n+    public void createAadTokenCredential() throws InterruptedException {\n+        CosmosAsyncDatabase db = null;\n+\n+        CosmosAsyncClient cosmosAsyncClient = new CosmosClientBuilder()\n+            .endpoint(TestConfigurations.COSMOS_EMULATOR_HOST)", "originalCommit": "689cf963c0b3ed2bffd0d1d6d6399f975882e913", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjAyODcxNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r476028715", "bodyText": "This is an emulator only test which it cannot be run against prod endpoint.", "author": "milismsft", "createdAt": "2020-08-25T01:13:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjAyMjE1NA=="}], "type": "inlineReview"}, {"oid": "f3a0bcd584b3cc43d4eb767b369277b987b59c3c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f3a0bcd584b3cc43d4eb767b369277b987b59c3c", "message": "use HOST and MASTER_KEY for Cosmos connections; these will default to Cosmos public emulator settings.", "committedDate": "2020-08-25T01:30:36Z", "type": "commit"}, {"oid": "026ae2a19195b7831fbce5ebaf0900b9bd80aad1", "url": "https://github.com/Azure/azure-sdk-for-java/commit/026ae2a19195b7831fbce5ebaf0900b9bd80aad1", "message": "Update test case expectations.", "committedDate": "2020-08-25T03:40:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjE1OTE1NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r476159154", "bodyText": "/cc: @j82w", "author": "kirankumarkolli", "createdAt": "2020-08-25T04:32:08Z", "path": "eng/pipelines/templates/stages/cosmos-sdk-client.yml", "diffHunk": "@@ -129,7 +129,7 @@ stages:\n         PreRunSteps:\n         - template: /eng/common/pipelines/templates/steps/cosmos-emulator.yml\n           parameters:\n-            StartParameters: '-PartitionCount 50 -Consistency Strong -Timeout 600'\n+            StartParameters: '-EnableAadAuthentication -PartitionCount 50 -Consistency Strong -Timeout 600'", "originalCommit": "026ae2a19195b7831fbce5ebaf0900b9bd80aad1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0f0ef85b32737ac069b1048e76a74d8bfd8f6873", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0f0ef85b32737ac069b1048e76a74d8bfd8f6873", "message": "update Sping related test expectations.", "committedDate": "2020-08-25T06:01:11Z", "type": "commit"}, {"oid": "7e76ae2715fd727018e6377b886dc48998abb008", "url": "https://github.com/Azure/azure-sdk-for-java/commit/7e76ae2715fd727018e6377b886dc48998abb008", "message": "Update Spring tests expectations and fix couple error cases when passing empty strings for endpoints and master keys.", "committedDate": "2020-08-25T18:47:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY3NjgyMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r476676823", "bodyText": "Any reason to not do null or whitespace?", "author": "j82w", "createdAt": "2020-08-25T19:10:37Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/CosmosClientBuilder.java", "diffHunk": "@@ -199,7 +202,12 @@ CosmosAuthorizationTokenResolver getAuthorizationTokenResolver() {\n      */\n     CosmosClientBuilder authorizationTokenResolver(\n         CosmosAuthorizationTokenResolver cosmosAuthorizationTokenResolver) {\n-        this.cosmosAuthorizationTokenResolver = cosmosAuthorizationTokenResolver;\n+        this.cosmosAuthorizationTokenResolver = Objects.requireNonNull(cosmosAuthorizationTokenResolver,", "originalCommit": "7e76ae2715fd727018e6377b886dc48998abb008", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "98b41c5a209c41f577b122f38ecf8f7ee1482001", "url": "https://github.com/Azure/azure-sdk-for-java/commit/98b41c5a209c41f577b122f38ecf8f7ee1482001", "message": "Fix for scope resolution", "committedDate": "2020-08-29T07:43:48Z", "type": "commit"}, {"oid": "1b17ba65cdd35ee7095ba4e172eb091c45f66e8a", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1b17ba65cdd35ee7095ba4e172eb091c45f66e8a", "message": "Merge branch 'master' into milismsft-AAD", "committedDate": "2020-08-29T07:56:06Z", "type": "commit"}, {"oid": "da704ddc52612669a81876e40470b49f3866833b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/da704ddc52612669a81876e40470b49f3866833b", "message": "Merge branch 'master' into milismsft-AAD\n\n# Conflicts:\n#\tsdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/RxDocumentClientImpl.java", "committedDate": "2020-09-08T23:44:11Z", "type": "commit"}, {"oid": "6fc6e9b41da5cc4150ec6a7fa37d2b3c43fa7f62", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6fc6e9b41da5cc4150ec6a7fa37d2b3c43fa7f62", "message": "Merge branch 'master' into milismsft-AAD", "committedDate": "2020-09-17T16:59:48Z", "type": "commit"}, {"oid": "2305c033326cd14068cb02eb04657408c00c3bde", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2305c033326cd14068cb02eb04657408c00c3bde", "message": "comment out the test until the CI only failure running public emulator is understood.", "committedDate": "2020-09-17T17:27:32Z", "type": "commit"}, {"oid": "8cc4c7cca056c65504a47f8eede97abac3b51db1", "url": "https://github.com/Azure/azure-sdk-for-java/commit/8cc4c7cca056c65504a47f8eede97abac3b51db1", "message": "update POM dependencies.", "committedDate": "2020-09-17T17:54:03Z", "type": "commit"}, {"oid": "d1c05e381fe6f03bba3f0367d3780c348f75ec62", "url": "https://github.com/Azure/azure-sdk-for-java/commit/d1c05e381fe6f03bba3f0367d3780c348f75ec62", "message": "Merge branch 'master' into milismsft-AAD", "committedDate": "2020-09-23T19:45:07Z", "type": "commit"}, {"oid": "9a05e4bce133db86eb0b5866c39d27b2c30b66e2", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9a05e4bce133db86eb0b5866c39d27b2c30b66e2", "message": "Fix merge related issue.", "committedDate": "2020-09-23T20:55:46Z", "type": "commit"}, {"oid": "eb80111cf2b4b8ed78d7f9cf236a2ba8279b5a27", "url": "https://github.com/Azure/azure-sdk-for-java/commit/eb80111cf2b4b8ed78d7f9cf236a2ba8279b5a27", "message": "various fixes related to copy/clone of an existing Cosmos client instance.", "committedDate": "2020-09-25T21:56:59Z", "type": "commit"}, {"oid": "c8c7df5367a94ec6b1913e1565ea3bb379f6c4d6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c8c7df5367a94ec6b1913e1565ea3bb379f6c4d6", "message": "update test to account for null values such as key, endpoint or credential properties.", "committedDate": "2020-09-26T03:43:37Z", "type": "commit"}, {"oid": "327cb6f04d51a9f0d4af206e94f1d119db81fa00", "url": "https://github.com/Azure/azure-sdk-for-java/commit/327cb6f04d51a9f0d4af206e94f1d119db81fa00", "message": "Merge branch 'master' into milismsft-AAD", "committedDate": "2020-09-26T03:46:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ5OTYwMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r495499601", "bodyText": "Is special handling for performance?\nIs there perf data to prove that it impacts performance?\nFor now NON-BLOCKER, but worth revisiting perf vs maintenance forward.", "author": "kirankumarkolli", "createdAt": "2020-09-26T21:57:48Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/caches/RxClientCollectionCache.java", "diffHunk": "@@ -80,27 +80,38 @@ public RxClientCollectionCache(ISessionContainer sessionContainer,\n \n         request.getHeaders().put(HttpConstants.HttpHeaders.X_DATE, Utils.nowAsRFC1123());\n \n-        String resourceName = request.getResourceAddress();\n-        String authorizationToken = tokenProvider.getUserAuthorizationToken(\n-                resourceName,\n-                request.getResourceType(),\n-                RequestVerb.GET,\n-                request.getHeaders(),\n-                AuthorizationTokenType.PrimaryMasterKey,\n-                properties);\n-\n-        try {\n-            authorizationToken = URLEncoder.encode(authorizationToken, \"UTF-8\");\n-        } catch (UnsupportedEncodingException e) {\n-            return Mono.error(new IllegalStateException(\"Failed to encode authtoken.\", e));\n+        if (tokenProvider.getAuthorizationTokenType() != AuthorizationTokenType.AadToken) {\n+            String resourceName = request.getResourceAddress();\n+            String authorizationToken = tokenProvider.getUserAuthorizationToken(\n+                    resourceName,\n+                    request.getResourceType(),\n+                    RequestVerb.GET,\n+                    request.getHeaders(),\n+                    AuthorizationTokenType.PrimaryMasterKey,\n+                    properties);\n+\n+            try {\n+                authorizationToken = URLEncoder.encode(authorizationToken, \"UTF-8\");\n+            } catch (UnsupportedEncodingException e) {\n+                return Mono.error(new IllegalStateException(\"Failed to encode authtoken.\", e));\n+            }\n+            request.getHeaders().put(HttpConstants.HttpHeaders.AUTHORIZATION, authorizationToken);\n         }\n-        request.getHeaders().put(HttpConstants.HttpHeaders.AUTHORIZATION, authorizationToken);\n \n         if (retryPolicyInstance != null){\n             retryPolicyInstance.onBeforeSendRequest(request);\n         }\n+\n         Instant addressCallStartTime = Instant.now();\n-        Mono<RxDocumentServiceResponse> responseObs = this.storeModel.processMessage(request);\n+        Mono<RxDocumentServiceResponse> responseObs;\n+        if (tokenProvider.getAuthorizationTokenType() != AuthorizationTokenType.AadToken) {\n+            responseObs = this.storeModel.processMessage(request);\n+        } else {\n+            responseObs = tokenProvider", "originalCommit": "327cb6f04d51a9f0d4af206e94f1d119db81fa00", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ5OTY3Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r495499676", "bodyText": "Base64 doesn't have new lines or line feed, isn't that a bug if it happens?", "author": "kirankumarkolli", "createdAt": "2020-09-26T21:59:12Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/Utils.java", "diffHunk": "@@ -116,6 +118,15 @@ public static String decodeAsUTF8String(String inputString) {\n         }\n     }\n \n+    public static String encodeUrlBase64String(byte[] binaryData) {\n+        String encodedString = Base64UrlEncoder.withoutPadding().encodeToString(binaryData);\n+\n+        if (encodedString.endsWith(\"\\r\\n\")) {", "originalCommit": "327cb6f04d51a9f0d4af206e94f1d119db81fa00", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ5OTg3OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r495499878", "bodyText": "Why is test configuration in source path?", "author": "kirankumarkolli", "createdAt": "2020-09-26T22:01:44Z", "path": "sdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/TestConfigurations.java", "diffHunk": "@@ -32,26 +32,29 @@\n     private static Logger logger = LoggerFactory.getLogger(TestConfigurations.class);\n     private static Properties properties = loadProperties();\n \n+    private final static String COSMOS_EMULATOR_KEY = \"C2y6yDjf5/R+ob0N8A7Cgv30VRDJIWEHLM+4QDU5DE2nQ9nDuVTqobD4b8mGGyPMbIZnqyMsEcaGQy67XIw/Jw==\";", "originalCommit": "327cb6f04d51a9f0d4af206e94f1d119db81fa00", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI0MjA1Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r496242052", "bodyText": "why are we disabling the emulator test?\ncould you enable it for the PR? if the emulator is readly?", "author": "moderakh", "createdAt": "2020-09-28T21:26:15Z", "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/rx/AadAuthorizationTests.java", "diffHunk": "@@ -0,0 +1,223 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+package com.azure.cosmos.rx;\n+\n+import com.azure.core.credential.AccessToken;\n+import com.azure.core.credential.TokenCredential;\n+import com.azure.core.credential.TokenRequestContext;\n+import com.azure.cosmos.CosmosAsyncClient;\n+import com.azure.cosmos.CosmosAsyncContainer;\n+import com.azure.cosmos.CosmosAsyncDatabase;\n+import com.azure.cosmos.CosmosClientBuilder;\n+import com.azure.cosmos.CosmosDatabaseForTest;\n+import com.azure.cosmos.implementation.InternalObjectNode;\n+import com.azure.cosmos.implementation.TestConfigurations;\n+import com.azure.cosmos.implementation.Utils;\n+import com.azure.cosmos.models.CosmosContainerResponse;\n+import com.azure.cosmos.models.CosmosDatabaseResponse;\n+import com.azure.cosmos.models.CosmosItemRequestOptions;\n+import com.azure.cosmos.models.CosmosItemResponse;\n+import com.azure.cosmos.models.CosmosQueryRequestOptions;\n+import com.azure.cosmos.models.PartitionKey;\n+import com.azure.cosmos.util.CosmosPagedFlux;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.AfterMethod;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.BeforeMethod;\n+import org.testng.annotations.Factory;\n+import org.testng.annotations.Test;\n+import reactor.core.publisher.Flux;\n+import reactor.core.publisher.Mono;\n+\n+import java.time.OffsetDateTime;\n+import java.time.ZonedDateTime;\n+import java.util.List;\n+import java.util.Properties;\n+import java.util.UUID;\n+\n+public class AadAuthorizationTests extends TestSuiteBase {\n+    private final static Logger log = LoggerFactory.getLogger(AadAuthorizationTests.class);\n+    private static final ObjectMapper OBJECT_MAPPER = Utils.getSimpleObjectMapper();\n+\n+    private final static String PARTITION_KEY_PATH = \"/mypk\";\n+    private final String databaseId = CosmosDatabaseForTest.generateId();\n+\n+    protected AadAuthorizationTests() {\n+    }\n+\n+    // Cosmos public emulator only test; this test will fail if run against Azure Cosmos endpoint at this time.\n+    //   We customize the Aad token to be specifically constructed for the Cosmos public emulator only; for Azure Cosmos\n+    //   the token will be requested and generated from an Azure Identity service.\n+    //@Test(groups = { \"emulator\" }, timeOut = 10 * TIMEOUT)", "originalCommit": "327cb6f04d51a9f0d4af206e94f1d119db81fa00", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzczNTI0OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/12622#discussion_r497735248", "bodyText": "There's an issue with the CI VM which prevents the AAD authenticator to initialize properly in the Gateway. I tried to reproduce this locally but unsuccessful so far (everything passes). We also validated AAD paths e2e against test federation so we should be good to go.\nI will re-enable the test once a new public emulator will ship which I will expect to work around the current authenticator initialization issue.", "author": "milismsft", "createdAt": "2020-09-30T19:02:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI0MjA1Mg=="}], "type": "inlineReview"}, {"oid": "72f0baa44f60ac686c3aea54aff33451a4c63ad7", "url": "https://github.com/Azure/azure-sdk-for-java/commit/72f0baa44f60ac686c3aea54aff33451a4c63ad7", "message": "Merge branch 'master' into milismsft-AAD\n\n# Conflicts:\n#\tsdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/RxDocumentClientImpl.java\n#\tsdk/cosmos/azure-cosmos/src/main/java/com/azure/cosmos/implementation/directconnectivity/GatewayAddressCache.java", "committedDate": "2020-09-30T17:35:49Z", "type": "commit"}]}