{"pr_number": 10626, "pr_title": "Fix Body Length Validation", "pr_createdAt": "2020-04-30T03:59:39Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/10626", "timeline": [{"oid": "f1d7e19398317f2f1016bc9788297e28e76e8b9c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/f1d7e19398317f2f1016bc9788297e28e76e8b9c", "message": "Fix error where body length validation wouldn't reset on retry", "committedDate": "2020-04-30T03:58:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc0MzU0Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10626#discussion_r417743542", "bodyText": "just curious, is this issue happens due to one of these operators eagerly subscribing? or something else?", "author": "anuchandy", "createdAt": "2020-04-30T04:15:11Z", "path": "sdk/core/azure-core/src/main/java/com/azure/core/http/rest/RestProxy.java", "diffHunk": "@@ -135,38 +135,40 @@ public Object invoke(Object proxy, final Method method, Object[] args) {\n         }\n     }\n \n-    private Flux<ByteBuffer> validateLength(final HttpRequest request) {\n+    static Flux<ByteBuffer> validateLength(final HttpRequest request) {\n         final Flux<ByteBuffer> bbFlux = request.getBody();\n         if (bbFlux == null) {\n             return Flux.empty();\n         }\n \n         long expectedLength = Long.parseLong(request.getHeaders().getValue(\"Content-Length\"));\n-        final long[] currentTotalLength = new long[1];\n \n-        return Flux.concat(bbFlux, Flux.just(VALIDATION_BUFFER)).handle((buffer, sink) -> {\n-            if (buffer == null) {\n-                return;\n-            }\n+        return Flux.defer(() -> {\n+            final long[] currentTotalLength = new long[1];\n+            return Flux.concat(bbFlux, Flux.just(VALIDATION_BUFFER)).handle((buffer, sink) -> {", "originalCommit": "f1d7e19398317f2f1016bc9788297e28e76e8b9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc0ODMxOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10626#discussion_r417748319", "bodyText": "I see the state variables were getting shared across subscriptions on request content.", "author": "anuchandy", "createdAt": "2020-04-30T04:36:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc0MzU0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzgyMzgwMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10626#discussion_r417823803", "bodyText": "Would be better to validate the error message as well as that is what we will use to debug issues.\n        StepVerifier.create(collectRequest(httpRequest.setHeader(\"Content-Length\", \"4\")))\n            .verifyErrorSatisfies(throwable -> {\n                    assertTrue(throwable instanceof UnexpectedLengthException);\n                    assertTrue(throwable.getMessage().equals(\"Request body emitted 4 bytes, less than the expected 5 bytes.\"\n            });\n\n        StepVerifier.create(collectRequest(httpRequest.setHeader(\"Content-Length\", \"6\")))\n            .verifyErrorSatisfies(throwable -> {\n                    assertTrue(throwable instanceof UnexpectedLengthException);\n                    assertTrue(throwable.getMessage().equals(\"Request body emitted 6 bytes, more than the expected 5 bytes.\"\n            });", "author": "srnagar", "createdAt": "2020-04-30T07:55:19Z", "path": "sdk/core/azure-core/src/test/java/com/azure/core/http/rest/RestProxyTests.java", "diffHunk": "@@ -0,0 +1,76 @@\n+// Copyright (c) Microsoft Corporation. All rights reserved.\n+// Licensed under the MIT License.\n+\n+package com.azure.core.http.rest;\n+\n+import com.azure.core.exception.UnexpectedLengthException;\n+import com.azure.core.http.HttpMethod;\n+import com.azure.core.http.HttpRequest;\n+import com.azure.core.util.FluxUtil;\n+import org.junit.jupiter.api.Test;\n+import reactor.core.publisher.Flux;\n+import reactor.core.publisher.Mono;\n+import reactor.test.StepVerifier;\n+\n+import java.nio.ByteBuffer;\n+\n+import static org.junit.jupiter.api.Assertions.assertArrayEquals;\n+\n+/**\n+ * Tests {@link RestProxy}.\n+ */\n+public class RestProxyTests {\n+    private static final byte[] EXPECTED = new byte[] { 0, 1, 2, 3, 4 };\n+\n+    @Test\n+    public void emptyRequestBody() {\n+        HttpRequest httpRequest = new HttpRequest(HttpMethod.GET, \"http://localhost\");\n+\n+        StepVerifier.create(RestProxy.validateLength(httpRequest))\n+            .verifyComplete();\n+    }\n+\n+    @Test\n+    public void expectedBodyLength() {\n+        HttpRequest httpRequest = new HttpRequest(HttpMethod.GET, \"http://localhost\")\n+            .setBody(EXPECTED)\n+            .setHeader(\"Content-Length\", \"5\");\n+\n+        StepVerifier.create(collectRequest(httpRequest))\n+            .assertNext(bytes -> assertArrayEquals(EXPECTED, bytes))\n+            .verifyComplete();\n+    }\n+\n+    @Test\n+    public void unexpectedBodyLength() {\n+        HttpRequest httpRequest = new HttpRequest(HttpMethod.GET, \"http://localhost\")\n+            .setBody(EXPECTED);\n+\n+        StepVerifier.create(collectRequest(httpRequest.setHeader(\"Content-Length\", \"4\")))\n+            .verifyError(UnexpectedLengthException.class);\n+\n+        StepVerifier.create(collectRequest(httpRequest.setHeader(\"Content-Length\", \"6\")))\n+            .verifyError(UnexpectedLengthException.class);", "originalCommit": "f1d7e19398317f2f1016bc9788297e28e76e8b9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEzNTY0MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/10626#discussion_r418135640", "bodyText": "Added", "author": "alzimmermsft", "createdAt": "2020-04-30T16:26:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzgyMzgwMw=="}], "type": "inlineReview"}, {"oid": "ec6e58223b1c0e41963c4760fa162e325bdcfda1", "url": "https://github.com/Azure/azure-sdk-for-java/commit/ec6e58223b1c0e41963c4760fa162e325bdcfda1", "message": "Make the tests more rigorous", "committedDate": "2020-04-30T16:12:57Z", "type": "commit"}]}