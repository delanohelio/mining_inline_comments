{"pr_number": 350, "pr_title": "Respect nodes' requirements", "pr_createdAt": "2020-08-05T10:16:23Z", "pr_url": "https://github.com/VelocityPowered/Velocity/pull/350", "timeline": [{"oid": "dfce2ea2d39d9eb6350db8705c07c705b22d4a52", "url": "https://github.com/VelocityPowered/Velocity/commit/dfce2ea2d39d9eb6350db8705c07c705b22d4a52", "message": "Respect nodes' requirements", "committedDate": "2020-08-05T10:12:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYyOTkwMw==", "url": "https://github.com/VelocityPowered/Velocity/pull/350#discussion_r465629903", "bodyText": "This only works for BrigadierCommands, I couldn't think of a way to implement it for simple and raw commands that expect a Context object (creating the context manually is hacky at best)", "author": "hugmanrique", "createdAt": "2020-08-05T10:31:48Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/connection/backend/BackendPlaySessionHandler.java", "diffHunk": "@@ -173,12 +179,72 @@ public boolean handle(AvailableCommands commands) {\n       }\n     }\n \n-    server.getEventManager().fire(\n-        new PlayerAvailableCommandsEvent(serverConn.getPlayer(), rootNode))\n-        .thenAcceptAsync(event -> playerConnection.write(commands), playerConnection.eventLoop());\n+    server\n+        .getEventManager()\n+        .fire(new PlayerAvailableCommandsEvent(serverConn.getPlayer(), rootNode))\n+        .thenAcceptAsync(\n+            event -> {\n+              commands.setRootNode(\n+                  (RootCommandNode<CommandSource>) filterNode(rootNode, new IdentityHashMap<>()));\n+              playerConnection.write(commands);\n+            },\n+            playerConnection.eventLoop());\n     return true;\n   }\n \n+  /**\n+   * Creates a deep copy of the provided command node, but removes any node that are not accessible\n+   * by the player (respecting the requirement of the node).\n+   *\n+   * @param source source node\n+   * @param nodeMapping mapped nodes\n+   * @return filtered node\n+   */\n+  private CommandNode<CommandSource> filterNode(", "originalCommit": "dfce2ea2d39d9eb6350db8705c07c705b22d4a52", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYzMjc5MA==", "url": "https://github.com/VelocityPowered/Velocity/pull/350#discussion_r465632790", "bodyText": "Sorry if I'm missing something, but why do we need to treat redirects as a special case? See BrigadierUtils for a deep clone method example.", "author": "hugmanrique", "createdAt": "2020-08-05T10:37:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYyOTkwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYzNzgzMQ==", "url": "https://github.com/VelocityPowered/Velocity/pull/350#discussion_r465637831", "bodyText": "I can also implement it on the simple/raw commands, it is just command completion, but this method is only for BrigadierCommands", "author": "MrIvanPlays", "createdAt": "2020-08-05T10:48:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYyOTkwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY0MTI5MQ==", "url": "https://github.com/VelocityPowered/Velocity/pull/350#discussion_r465641291", "bodyText": "why do we need to treat redirects as a special case\n\nWe need to filter the redirects too", "author": "MrIvanPlays", "createdAt": "2020-08-05T10:55:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYyOTkwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY0Mjg1OA==", "url": "https://github.com/VelocityPowered/Velocity/pull/350#discussion_r465642858", "bodyText": "The problem is simple and raw commands don't use the requires predicate since it doesn't pass the used command and thus the context object cannot be created.", "author": "hugmanrique", "createdAt": "2020-08-05T10:58:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYyOTkwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY0NDYyMQ==", "url": "https://github.com/VelocityPowered/Velocity/pull/350#discussion_r465644621", "bodyText": "since it doesn't pass the used command\n\nwdym", "author": "MrIvanPlays", "createdAt": "2020-08-05T11:01:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYyOTkwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY0NTY4MA==", "url": "https://github.com/VelocityPowered/Velocity/pull/350#discussion_r465645680", "bodyText": "See \n  \n    \n      Velocity/proxy/src/main/java/com/velocitypowered/proxy/command/CommandNodeFactory.java\n    \n    \n         Line 36\n      in\n      76173e4\n    \n    \n    \n    \n\n        \n          \n           BrigadierUtils.buildRawArgumentsLiteral(alias, \n        \n    \n  \n\n and \n  \n    \n      Velocity/proxy/src/main/java/com/velocitypowered/proxy/command/CommandNodeFactory.java\n    \n    \n         Line 73\n      in\n      76173e4\n    \n    \n    \n    \n\n        \n          \n           return BrigadierUtils.buildRawArgumentsLiteral(alias,", "author": "hugmanrique", "createdAt": "2020-08-05T11:04:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYyOTkwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY1NDk4Mw==", "url": "https://github.com/VelocityPowered/Velocity/pull/350#discussion_r465654983", "bodyText": "Can't we make the command to forward only on failure? So that we can utilise .requires for better experience?\n(asking u before touching anything of that code, I'm scared \ud83d\udc40)", "author": "MrIvanPlays", "createdAt": "2020-08-05T11:18:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYyOTkwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYzNTg2MQ==", "url": "https://github.com/VelocityPowered/Velocity/pull/350#discussion_r465635861", "bodyText": "To avoid unnecessarily processing the backend server commands (which don't have a requires  predicate), I would move this filtering to https://github.com/MrIvanPlays/Velocity/blob/dfce2ea2d39d9eb6350db8705c07c705b22d4a52/proxy/src/main/java/com/velocitypowered/proxy/connection/backend/BackendPlaySessionHandler.java#L175 (just above this, where the proxy commands are injected). This also avoids the cloning if the announceProxyCommands config is set to false", "author": "hugmanrique", "createdAt": "2020-08-05T10:43:50Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/connection/backend/BackendPlaySessionHandler.java", "diffHunk": "@@ -173,12 +179,72 @@ public boolean handle(AvailableCommands commands) {\n       }\n     }\n \n-    server.getEventManager().fire(\n-        new PlayerAvailableCommandsEvent(serverConn.getPlayer(), rootNode))\n-        .thenAcceptAsync(event -> playerConnection.write(commands), playerConnection.eventLoop());\n+    server\n+        .getEventManager()\n+        .fire(new PlayerAvailableCommandsEvent(serverConn.getPlayer(), rootNode))\n+        .thenAcceptAsync(\n+            event -> {\n+              commands.setRootNode(", "originalCommit": "dfce2ea2d39d9eb6350db8705c07c705b22d4a52", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYzOTUxNg==", "url": "https://github.com/VelocityPowered/Velocity/pull/350#discussion_r465639516", "bodyText": "If I move it there, the nodes that the event adds wouldn't be captured and the method wouldn't work as intended.\nAdditionally, we can remove this event and enforce BrigadierCommand if someone wants to modify the root node.", "author": "MrIvanPlays", "createdAt": "2020-08-05T10:51:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYzNTg2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY0MDQ5NA==", "url": "https://github.com/VelocityPowered/Velocity/pull/350#discussion_r465640494", "bodyText": "Imo, nodes added via PlayerAvailableCommandsEvent should always be sent, even if the source doesn't pass the predicate.", "author": "hugmanrique", "createdAt": "2020-08-05T10:53:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYzNTg2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY0MTk3OA==", "url": "https://github.com/VelocityPowered/Velocity/pull/350#discussion_r465641978", "bodyText": "Imo, nodes added via PlayerAvailableCommandsEvent should always be sent, even if the source doesn't pass the predicate.\n\nhow come", "author": "MrIvanPlays", "createdAt": "2020-08-05T10:56:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYzNTg2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY0MzgxMA==", "url": "https://github.com/VelocityPowered/Velocity/pull/350#discussion_r465643810", "bodyText": "If a plugin forcefully adds a command node to the tree, it should be sent to the client regardless of the requires return. The plugin can register a command to use this mechanic. The event is mostly intended to remove or edit nodes.", "author": "hugmanrique", "createdAt": "2020-08-05T11:00:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYzNTg2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY0NDk0Mw==", "url": "https://github.com/VelocityPowered/Velocity/pull/350#discussion_r465644943", "bodyText": "If a plugin forcefully adds a command node to the tree, it should be sent to the client regardless of the requires return. The plugin can register a command to use this mechanic. The event is mostly intended to remove or edit nodes.\n\nSure, I will move the filtering then", "author": "MrIvanPlays", "createdAt": "2020-08-05T11:02:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYzNTg2MQ=="}], "type": "inlineReview"}, {"oid": "6828420517326518663d963504f363e39a69b280", "url": "https://github.com/VelocityPowered/Velocity/commit/6828420517326518663d963504f363e39a69b280", "message": "Move filtering", "committedDate": "2020-08-05T11:13:51Z", "type": "commit"}, {"oid": "fb03ba21c73b04695e492c92f896fd0846e2e37f", "url": "https://github.com/VelocityPowered/Velocity/commit/fb03ba21c73b04695e492c92f896fd0846e2e37f", "message": "Remove map", "committedDate": "2020-08-05T12:04:42Z", "type": "commit"}, {"oid": "e96199e09eb964bcd8f112b2180c076b25084095", "url": "https://github.com/VelocityPowered/Velocity/commit/e96199e09eb964bcd8f112b2180c076b25084095", "message": "Always set the node", "committedDate": "2020-08-05T12:15:23Z", "type": "commit"}]}