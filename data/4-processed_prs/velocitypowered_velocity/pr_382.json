{"pr_number": 382, "pr_title": "[Future] 1.17 Update", "pr_createdAt": "2020-11-05T10:13:50Z", "pr_url": "https://github.com/VelocityPowered/Velocity/pull/382", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQyNzE5MQ==", "url": "https://github.com/VelocityPowered/Velocity/pull/382#discussion_r518427191", "bodyText": "Can convert this into a default method, calling the new one with required as false.", "author": "kashike", "createdAt": "2020-11-05T23:14:07Z", "path": "api/src/main/java/com/velocitypowered/api/proxy/Player.java", "diffHunk": "@@ -205,4 +205,18 @@ default void sendMessage(net.kyori.text.Component component) {\n    * @param hash the SHA-1 hash value for the resource pack\n    */\n   void sendResourcePack(String url, byte[] hash);", "originalCommit": "300adb58897014faf44ef82aa6b91fb13760f424", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTc2MTA5Mg==", "url": "https://github.com/VelocityPowered/Velocity/pull/382#discussion_r519761092", "bodyText": "Will do that when I roll 20w46a", "author": "Xernium", "createdAt": "2020-11-09T12:10:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQyNzE5MQ=="}], "type": "inlineReview"}, {"oid": "9ed4ee74b75b6c476a77d099e89fcafde6aef17b", "url": "https://github.com/VelocityPowered/Velocity/commit/9ed4ee74b75b6c476a77d099e89fcafde6aef17b", "message": "Adjust snapshot -> final version", "committedDate": "2020-11-07T20:32:19Z", "type": "forcePushed"}, {"oid": "b6442f672ff7f0ff4572d58ad7979286781d7ade", "url": "https://github.com/VelocityPowered/Velocity/commit/b6442f672ff7f0ff4572d58ad7979286781d7ade", "message": "Adjust snapshot -> final version", "committedDate": "2020-11-11T16:52:56Z", "type": "forcePushed"}, {"oid": "328fe6733e120b9c8da29c2509674d5fbd10e94b", "url": "https://github.com/VelocityPowered/Velocity/commit/328fe6733e120b9c8da29c2509674d5fbd10e94b", "message": "Snapshot 20w48a", "committedDate": "2020-11-25T17:34:45Z", "type": "forcePushed"}, {"oid": "2d2606fb2a9b1a40033c4b2d870a0c4995ab6af0", "url": "https://github.com/VelocityPowered/Velocity/commit/2d2606fb2a9b1a40033c4b2d870a0c4995ab6af0", "message": "Snapshot 20w49a", "committedDate": "2020-12-02T19:39:34Z", "type": "forcePushed"}, {"oid": "169784ffa8ba2e26298a5f0fe5b195bd081966cd", "url": "https://github.com/VelocityPowered/Velocity/commit/169784ffa8ba2e26298a5f0fe5b195bd081966cd", "message": "Snapshot 20w51a", "committedDate": "2021-01-09T12:58:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODQ0NTQ1NA==", "url": "https://github.com/VelocityPowered/Velocity/pull/382#discussion_r558445454", "bodyText": "Could you specify in the JD what is meant by 'isRequired'? It's unclear at first glance; I had to check wiki.vg\nForced | Boolean | The notchian client will be forced to use the resource pack from the server. If they decline they will be kicked from the server\nsource https://wiki.vg/Pre-release_protocol#Resource_Pack_Send", "author": "Mystiflow", "createdAt": "2021-01-15T17:10:10Z", "path": "api/src/main/java/com/velocitypowered/api/proxy/Player.java", "diffHunk": "@@ -218,5 +218,21 @@ default void sendMessage(net.kyori.text.Component component) {\n    * @param url the URL for the resource pack\n    * @param hash the SHA-1 hash value for the resource pack\n    */\n-  void sendResourcePack(String url, byte[] hash);\n+  default void sendResourcePack(String url, byte[] hash) {\n+    sendResourcePack(url, hash, false);\n+  }\n+\n+  /**\n+   * Sends the specified resource pack from {@code url} to the user, using the specified 20-byte\n+   * SHA-1 hash. To monitor the status of the sent resource pack, subscribe to\n+   * {@link PlayerResourcePackStatusEvent}.\n+   * In 1.17 and newer you can additionally specify\n+   * whether the resource pack is required or not. Setting this for an older client will have\n+   * no effect.\n+   *\n+   * @param url the URL for the resource pack\n+   * @param hash the SHA-1 hash value for the resource pack\n+   * @param isRequired flag to set the resource pack as required in 1.17+", "originalCommit": "169784ffa8ba2e26298a5f0fe5b195bd081966cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODU5OTI3Mg==", "url": "https://github.com/VelocityPowered/Velocity/pull/382#discussion_r558599272", "bodyText": "Point taken. The final description will be shorter to the sum of: isRequired refusing this pack on 1.17 or newer disconnects the user.", "author": "Xernium", "createdAt": "2021-01-15T21:22:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODQ0NTQ1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODQ0NzIwNQ==", "url": "https://github.com/VelocityPowered/Velocity/pull/382#discussion_r558447205", "bodyText": "Maybe also keep the previous method for compat?", "author": "Mystiflow", "createdAt": "2021-01-15T17:13:11Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/connection/client/ConnectedPlayer.java", "diffHunk": "@@ -838,18 +838,20 @@ public void sendResourcePack(String url) {\n     ResourcePackRequest request = new ResourcePackRequest();\n     request.setUrl(url);\n     request.setHash(\"\");\n+    request.setRequired(false);\n     connection.write(request);\n   }\n \n   @Override\n-  public void sendResourcePack(String url, byte[] hash) {\n+  public void sendResourcePack(String url, byte[] hash, boolean isRequired) {", "originalCommit": "169784ffa8ba2e26298a5f0fe5b195bd081966cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODQ2MjQ1Mw==", "url": "https://github.com/VelocityPowered/Velocity/pull/382#discussion_r558462453", "bodyText": "See https://github.com/VelocityPowered/Velocity/pull/382/files#diff-433700b629ed381aec737f3b64379fa3aa63f8b7d93191e73d3a79329ae8b9ebR221", "author": "hugmanrique", "createdAt": "2021-01-15T17:39:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODQ0NzIwNQ=="}], "type": "inlineReview"}, {"oid": "058447f3bf3b007e996023d94d6a1415b97e5ec2", "url": "https://github.com/VelocityPowered/Velocity/commit/058447f3bf3b007e996023d94d6a1415b97e5ec2", "message": "Snapshot 21w03a", "committedDate": "2021-01-20T19:14:11Z", "type": "forcePushed"}, {"oid": "d7d77908e44642479e4a8a3254d3aec9a064af65", "url": "https://github.com/VelocityPowered/Velocity/commit/d7d77908e44642479e4a8a3254d3aec9a064af65", "message": "Snapshot 21w05b", "committedDate": "2021-02-05T07:05:46Z", "type": "forcePushed"}, {"oid": "8f722a5e4f44f0d97e57dd0d53052ce5da581b09", "url": "https://github.com/VelocityPowered/Velocity/commit/8f722a5e4f44f0d97e57dd0d53052ce5da581b09", "message": "Snapshot 21w06a", "committedDate": "2021-02-10T18:58:46Z", "type": "forcePushed"}, {"oid": "e8dbd5766c7d8beb74f8f90b940fc9b3e3e5eecd", "url": "https://github.com/VelocityPowered/Velocity/commit/e8dbd5766c7d8beb74f8f90b940fc9b3e3e5eecd", "message": "Snapshot 21w07a", "committedDate": "2021-02-18T21:02:26Z", "type": "forcePushed"}, {"oid": "54d406146f7bed8f01eb72b6209533608324221c", "url": "https://github.com/VelocityPowered/Velocity/commit/54d406146f7bed8f01eb72b6209533608324221c", "message": "Snapshot 21w08a", "committedDate": "2021-02-25T13:42:23Z", "type": "forcePushed"}, {"oid": "45e03b27bc519571d8d408722de2a2283ef01b59", "url": "https://github.com/VelocityPowered/Velocity/commit/45e03b27bc519571d8d408722de2a2283ef01b59", "message": "Snaphot 21w10a", "committedDate": "2021-03-11T08:53:55Z", "type": "forcePushed"}, {"oid": "4fcdd92c3c8e8722648fdaf6fb1f463bc6c6784c", "url": "https://github.com/VelocityPowered/Velocity/commit/4fcdd92c3c8e8722648fdaf6fb1f463bc6c6784c", "message": "Snaphot 21w10a", "committedDate": "2021-03-12T10:36:20Z", "type": "forcePushed"}, {"oid": "1cdff1b4f7c19a72a3680e06ca478e7c4af73a6a", "url": "https://github.com/VelocityPowered/Velocity/commit/1cdff1b4f7c19a72a3680e06ca478e7c4af73a6a", "message": "Snapshot 21w13a", "committedDate": "2021-03-31T18:22:46Z", "type": "forcePushed"}, {"oid": "c5dd24c49f85475b656711c62f914c0526f9e64c", "url": "https://github.com/VelocityPowered/Velocity/commit/c5dd24c49f85475b656711c62f914c0526f9e64c", "message": "Snapshot 21w14a", "committedDate": "2021-04-14T17:45:34Z", "type": "forcePushed"}, {"oid": "7f0964155c6f8f186dc7ae368e567ed42e5ff40d", "url": "https://github.com/VelocityPowered/Velocity/commit/7f0964155c6f8f186dc7ae368e567ed42e5ff40d", "message": "Snapshot 20w45a", "committedDate": "2021-05-12T19:42:27Z", "type": "commit"}, {"oid": "d444bed96b7ddae64b00dccb8b3a8fc4c7e4a226", "url": "https://github.com/VelocityPowered/Velocity/commit/d444bed96b7ddae64b00dccb8b3a8fc4c7e4a226", "message": "Adjust snapshot -> final version", "committedDate": "2021-05-12T19:42:27Z", "type": "commit"}, {"oid": "d8a39fc43897aefe488afa2ed83170f45505819f", "url": "https://github.com/VelocityPowered/Velocity/commit/d8a39fc43897aefe488afa2ed83170f45505819f", "message": "Snapshot 20w46a", "committedDate": "2021-05-12T19:42:27Z", "type": "commit"}, {"oid": "b588bfe448fdd635b21881b34cd6bf419bcb5e8d", "url": "https://github.com/VelocityPowered/Velocity/commit/b588bfe448fdd635b21881b34cd6bf419bcb5e8d", "message": "Snapshot 20w48a", "committedDate": "2021-05-12T19:42:27Z", "type": "commit"}, {"oid": "040cc29c34adf5bbb19ceb6cb5f70d94d8847f8e", "url": "https://github.com/VelocityPowered/Velocity/commit/040cc29c34adf5bbb19ceb6cb5f70d94d8847f8e", "message": "Snapshot 20w49a", "committedDate": "2021-05-12T19:42:27Z", "type": "commit"}, {"oid": "76493549bf6ba8faf33bfa4bd72003075c089054", "url": "https://github.com/VelocityPowered/Velocity/commit/76493549bf6ba8faf33bfa4bd72003075c089054", "message": "Snapshot 20w51a", "committedDate": "2021-05-12T19:42:27Z", "type": "commit"}, {"oid": "f0d9a445ed1421d9d38ef5bb6785c6b60a5252af", "url": "https://github.com/VelocityPowered/Velocity/commit/f0d9a445ed1421d9d38ef5bb6785c6b60a5252af", "message": "Snapshot 21w03a", "committedDate": "2021-05-12T19:42:27Z", "type": "commit"}, {"oid": "7ea7e775647992215fe8db8b5f99227327d5b6fe", "url": "https://github.com/VelocityPowered/Velocity/commit/7ea7e775647992215fe8db8b5f99227327d5b6fe", "message": "Snapshot 21w05a", "committedDate": "2021-05-12T19:42:27Z", "type": "commit"}, {"oid": "03327c2677be75fb0a0970f9ee8cad24c34e6292", "url": "https://github.com/VelocityPowered/Velocity/commit/03327c2677be75fb0a0970f9ee8cad24c34e6292", "message": "Snapshot 21w05b", "committedDate": "2021-05-12T19:42:27Z", "type": "commit"}, {"oid": "c9e92bcc53a239c5ec9061c0209f6f1e072ac5f4", "url": "https://github.com/VelocityPowered/Velocity/commit/c9e92bcc53a239c5ec9061c0209f6f1e072ac5f4", "message": "Snapshot 21w06a", "committedDate": "2021-05-12T19:42:27Z", "type": "commit"}, {"oid": "b19cf16345c30d03aeed4f96fe3cd249566486e3", "url": "https://github.com/VelocityPowered/Velocity/commit/b19cf16345c30d03aeed4f96fe3cd249566486e3", "message": "Snapshot 21w07a", "committedDate": "2021-05-12T19:42:27Z", "type": "commit"}, {"oid": "22bc7590446d292800b7012c1592008cd42774bc", "url": "https://github.com/VelocityPowered/Velocity/commit/22bc7590446d292800b7012c1592008cd42774bc", "message": "Snapshot 21w08a", "committedDate": "2021-05-12T19:42:27Z", "type": "commit"}, {"oid": "6207647aae96021a113e30c2b0acef83c3d0b728", "url": "https://github.com/VelocityPowered/Velocity/commit/6207647aae96021a113e30c2b0acef83c3d0b728", "message": "Remove leftovers", "committedDate": "2021-05-12T19:42:27Z", "type": "commit"}, {"oid": "581303a54c9263b05191f629f9c9c574bb873443", "url": "https://github.com/VelocityPowered/Velocity/commit/581303a54c9263b05191f629f9c9c574bb873443", "message": "Snaphot 21w10a", "committedDate": "2021-05-12T19:42:27Z", "type": "commit"}, {"oid": "f6e023bf60b6f119c4b380c214121cf884035645", "url": "https://github.com/VelocityPowered/Velocity/commit/f6e023bf60b6f119c4b380c214121cf884035645", "message": "Snapshot 21w11a", "committedDate": "2021-05-12T19:42:27Z", "type": "commit"}, {"oid": "625fa9b0ada6b656d713e828619ac083099b1d87", "url": "https://github.com/VelocityPowered/Velocity/commit/625fa9b0ada6b656d713e828619ac083099b1d87", "message": "Snapshot 21w13a", "committedDate": "2021-05-12T19:42:28Z", "type": "commit"}, {"oid": "22202094958dc3a5a807f1e17b13ebc01a39f72b", "url": "https://github.com/VelocityPowered/Velocity/commit/22202094958dc3a5a807f1e17b13ebc01a39f72b", "message": "Snapshot 21w14a", "committedDate": "2021-05-12T19:42:28Z", "type": "commit"}, {"oid": "8def411b2b99bf952d7f857196a4095c409ec9fd", "url": "https://github.com/VelocityPowered/Velocity/commit/8def411b2b99bf952d7f857196a4095c409ec9fd", "message": "Snapshot 21w15a", "committedDate": "2021-05-13T21:49:55Z", "type": "commit"}, {"oid": "be1848f8e72962b53af6b1cfc83c1b0ccf795f6c", "url": "https://github.com/VelocityPowered/Velocity/commit/be1848f8e72962b53af6b1cfc83c1b0ccf795f6c", "message": "Snapshot 21w16a", "committedDate": "2021-05-13T21:50:00Z", "type": "commit"}, {"oid": "00f81a3fd70842b2285327abbf640e7e17c7b083", "url": "https://github.com/VelocityPowered/Velocity/commit/00f81a3fd70842b2285327abbf640e7e17c7b083", "message": "Snapshot 21w17a", "committedDate": "2021-05-13T21:50:00Z", "type": "commit"}, {"oid": "6eb2432e8865618642f980109621d2ee6507f3cf", "url": "https://github.com/VelocityPowered/Velocity/commit/6eb2432e8865618642f980109621d2ee6507f3cf", "message": "Snapshot 21w18a", "committedDate": "2021-05-13T21:50:00Z", "type": "commit"}, {"oid": "18466bb59586bc37598a60f9a10b8e659010777f", "url": "https://github.com/VelocityPowered/Velocity/commit/18466bb59586bc37598a60f9a10b8e659010777f", "message": "Snapshot 21w19a", "committedDate": "2021-05-13T21:50:00Z", "type": "commit"}, {"oid": "18466bb59586bc37598a60f9a10b8e659010777f", "url": "https://github.com/VelocityPowered/Velocity/commit/18466bb59586bc37598a60f9a10b8e659010777f", "message": "Snapshot 21w19a", "committedDate": "2021-05-13T21:50:00Z", "type": "forcePushed"}, {"oid": "10bfd8685e2d242006f45558139ddeb0b353d259", "url": "https://github.com/VelocityPowered/Velocity/commit/10bfd8685e2d242006f45558139ddeb0b353d259", "message": "Minecraft 1.17-pre1", "committedDate": "2021-05-27T15:02:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDcyMTU4OQ==", "url": "https://github.com/VelocityPowered/Velocity/pull/382#discussion_r640721589", "bodyText": "Shouldn't we run this on the event loop instead?", "author": "astei", "createdAt": "2021-05-27T15:13:38Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/connection/client/ConnectedPlayer.java", "diffHunk": "@@ -864,29 +880,133 @@ public void spoofChatInput(String input) {\n   }\n \n   @Override\n+  @Deprecated\n   public void sendResourcePack(String url) {\n-    Preconditions.checkNotNull(url, \"url\");\n+    sendResourcePackOffer(new VelocityResourcePackInfo.BuilderImpl(url).build());\n+  }\n+\n+  @Override\n+  @Deprecated\n+  public void sendResourcePack(String url, byte[] hash) {\n+    sendResourcePackOffer(new VelocityResourcePackInfo.BuilderImpl(url).setHash(hash).build());\n+  }\n \n+  @Override\n+  public void sendResourcePackOffer(ResourcePackInfo packInfo) {\n     if (this.getProtocolVersion().compareTo(ProtocolVersion.MINECRAFT_1_8) >= 0) {\n+      Preconditions.checkNotNull(packInfo, \"packInfo\");\n+      queueResourcePack(packInfo);\n+    }\n+  }\n+\n+  /**\n+   * Queues a resource-pack for sending to the player and sends it\n+   * immediately if the queue is empty.\n+   */\n+  public void queueResourcePack(ResourcePackInfo info) {\n+    outstandingResourcePacks.add(info);\n+    if (outstandingResourcePacks.size() == 1) {\n+      tickResourcePackQueue();\n+    }\n+  }\n+\n+  private void tickResourcePackQueue() {\n+    ResourcePackInfo queued = outstandingResourcePacks.peek();\n+\n+    if (queued != null) {\n+      // Check if the player declined a resource pack once already\n+      if (previousResourceResponse != null && !previousResourceResponse) {\n+        // If that happened we can flush the queue right away.\n+        // Unless its 1.17+ and forced it will come back denied anyway\n+        while (!outstandingResourcePacks.isEmpty()) {\n+          queued = outstandingResourcePacks.peek();\n+          if (queued.getShouldForce() && getProtocolVersion()\n+                  .compareTo(ProtocolVersion.MINECRAFT_1_17) >= 0) {\n+            break;\n+          }\n+          onResourcePackResponse(PlayerResourcePackStatusEvent.Status.DECLINED, new byte[0]);\n+          queued = null;\n+        }\n+        if (queued == null) {\n+          // Exit as the queue was cleared\n+          return;\n+        }\n+      }\n+\n       ResourcePackRequest request = new ResourcePackRequest();\n-      request.setUrl(url);\n-      request.setHash(\"\");\n+      request.setUrl(queued.getUrl());\n+      if (queued.getHash() != null) {\n+        request.setHash(ByteBufUtil.hexDump(queued.getHash()));\n+      } else {\n+        request.setHash(\"\");\n+      }\n+      request.setRequired(queued.getShouldForce());\n+      request.setPrompt(queued.getPrompt());\n+\n       connection.write(request);\n     }\n   }\n \n   @Override\n-  public void sendResourcePack(String url, byte[] hash) {\n-    Preconditions.checkNotNull(url, \"url\");\n-    Preconditions.checkNotNull(hash, \"hash\");\n-    Preconditions.checkArgument(hash.length == 20, \"Hash length is not 20\");\n+  public @Nullable ResourcePackInfo getAppliedResourcePack() {\n+    return appliedResourcePack;\n+  }\n \n-    if (this.getProtocolVersion().compareTo(ProtocolVersion.MINECRAFT_1_8) >= 0) {\n-      ResourcePackRequest request = new ResourcePackRequest();\n-      request.setUrl(url);\n-      request.setHash(ByteBufUtil.hexDump(hash));\n-      connection.write(request);\n+  @Override\n+  public @Nullable ResourcePackInfo getPendingResourcePack() {\n+    return pendingResourcePack;\n+  }\n+\n+  /**\n+   * Processes a client response to a sent resource-pack.\n+   */\n+  public boolean onResourcePackResponse(PlayerResourcePackStatusEvent.Status status,\n+                                        @Nullable byte[] hash) {\n+\n+    final boolean peek = status == PlayerResourcePackStatusEvent.Status.ACCEPTED;\n+    final ResourcePackInfo queued = peek\n+            ? outstandingResourcePacks.peek() : outstandingResourcePacks.poll();\n+\n+    server.getEventManager().fire(new PlayerResourcePackStatusEvent(this, status, queued))\n+            .thenAcceptAsync(event -> {\n+              if (event.getStatus() == PlayerResourcePackStatusEvent.Status.DECLINED\n+                      && event.getPackInfo() != null && event.getPackInfo().getShouldForce()\n+                      && (!event.isOverwriteKick() || event.getPlayer()\n+                              .getProtocolVersion().compareTo(ProtocolVersion.MINECRAFT_1_17) >= 0)\n+              ) {\n+                event.getPlayer().disconnect(Component\n+                        .translatable(\"multiplayer.requiredTexturePrompt.disconnect\"));\n+              }\n+            });\n+\n+\n+    switch (status) {\n+      case ACCEPTED:\n+        previousResourceResponse = true;\n+        pendingResourcePack = queued;\n+        break;\n+      case DECLINED:\n+        previousResourceResponse = false;\n+        break;\n+      case SUCCESSFUL:\n+        appliedResourcePack = queued;\n+        pendingResourcePack = null;\n+        break;\n+      case FAILED_DOWNLOAD:\n+        pendingResourcePack = null;\n+        break;\n+      default:\n+        break;\n+    }\n+\n+    if (!peek) {\n+      CompletableFuture.supplyAsync(() -> {", "originalCommit": "10bfd8685e2d242006f45558139ddeb0b353d259", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c161a3859c52f65f21852f029ef940c6aaccc34c", "url": "https://github.com/VelocityPowered/Velocity/commit/c161a3859c52f65f21852f029ef940c6aaccc34c", "message": "1.17-pre2", "committedDate": "2021-05-31T16:47:13Z", "type": "commit"}, {"oid": "f67dc3ffc8c4fe0f59d1e46b8842982af833000c", "url": "https://github.com/VelocityPowered/Velocity/commit/f67dc3ffc8c4fe0f59d1e46b8842982af833000c", "message": "Minecraft 1.17-pre3", "committedDate": "2021-06-01T17:36:28Z", "type": "commit"}, {"oid": "3eb64855d3164c313c19e3b91ddb221d19882a23", "url": "https://github.com/VelocityPowered/Velocity/commit/3eb64855d3164c313c19e3b91ddb221d19882a23", "message": "Minecraft 1.17-pre4", "committedDate": "2021-06-03T06:50:16Z", "type": "commit"}, {"oid": "100eedf1023f742b9d73c5c00cb1489e7401713f", "url": "https://github.com/VelocityPowered/Velocity/commit/100eedf1023f742b9d73c5c00cb1489e7401713f", "message": "Minecraft 1.17-pre5", "committedDate": "2021-06-03T18:40:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NTUwMzExMg==", "url": "https://github.com/VelocityPowered/Velocity/pull/382#discussion_r645503112", "bodyText": "Looks like that comment is wrong", "author": "Vankka", "createdAt": "2021-06-04T11:38:00Z", "path": "api/src/main/java/com/velocitypowered/api/proxy/player/ResourcePackInfo.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*\n+ * Copyright (C) 2018 Velocity Contributors\n+ *\n+ * The Velocity API is licensed under the terms of the MIT License. For more details,\n+ * reference the LICENSE file in the api top-level directory.\n+ */\n+\n+package com.velocitypowered.api.proxy.player;\n+\n+import net.kyori.adventure.text.Component;\n+import org.checkerframework.checker.nullness.qual.Nullable;\n+\n+public interface ResourcePackInfo {\n+\n+  /**\n+   * Gets the link the resource-pack can be found at.\n+   *\n+   * @return the location of the resource-pack\n+   */\n+  String getUrl();\n+\n+  /**\n+   * Gets the {@link Component} that is displayed on the resource-pack prompt.\n+   * This is only displayed if the client version is 1.17 or newer.\n+   *\n+   * @return the prompt if present or null otherwise\n+   */\n+  @Nullable\n+  Component getPrompt();\n+\n+  /**\n+   * Gets whether or not the acceptance of the resource-pack is enforced.\n+   * See {@link Builder#setShouldForce(boolean)} for more information.\n+   *\n+   * @return whether or not to force usage of this resource-pack\n+   */\n+  boolean getShouldForce();\n+\n+  /**\n+   * Gets the SHA-1 hash of the resource-pack\n+   * See {@link Builder#setHash(byte[])} for more information.\n+   *\n+   * @return the hash if present or null otherwise\n+   */\n+  @Nullable\n+  byte[] getHash();\n+\n+  /**\n+   * Gets the {@link Origin} of the resource-pack.\n+   *\n+   * @return the origin of the resource pack\n+   */\n+  Origin getOrigin();\n+\n+  interface Builder {\n+\n+    /**\n+     * Sets the resource-pack as required to play on the network.\n+     * This feature was introduced in 1.17.\n+     * Setting this to true has one of two effects:\n+     * If the client is on 1.17 or newer:\n+     *  - The resource-pack prompt will display without a decline button\n+     *  - Accept or disconnect are the only available options but players may still press escape.\n+     *  - Forces the resource-pack offer prompt to display even if the player has\n+     *    previously declined or disabled resource packs\n+     *  - The player will be disconnected from the network if they close/skip the prompt.\n+     * If the client is on a version older than 1.17:\n+     *  - If the player accepts the resource pack or has previously accepted a resource-pack\n+     *    then nothing else will happen.\n+     *  - If the player declines the resource pack or has previously declined a resource-pack\n+     *    the player will be disconnected from the network\n+     *\n+     * @param shouldForce whether or not to force the client to accept the resource pack\n+     */\n+    Builder setShouldForce(boolean shouldForce);\n+\n+    /**\n+     * Sets the SHA-1 hash of the provided resource pack.\n+     * Note: It is recommended to always set this hash.\n+     * If this hash is not set/ not present then the client will always download\n+     * the resource pack even if it may still be cached. By having this hash present,\n+     * the client will check first whether or not a resource pack by this hash is cached\n+     * before downloading.\n+     *\n+     * @param hash the SHA-1 hash of the resource-pack\n+     */\n+    Builder setHash(@Nullable byte[] hash);\n+\n+    /**\n+     * Sets a {@link Component} to display on the download prompt.\n+     * This will only display if the client version is 1.17 or newer.\n+     *\n+     * @param prompt the component to display\n+     */\n+    Builder setPrompt(@Nullable Component prompt);\n+\n+    /**\n+     * Builds the {@link ResourcePackInfo} from the provided info for use with\n+     * {@link com.velocitypowered.api.proxy.Player#sendResourcePackOffer(ResourcePackInfo)}.\n+     * Note: Some features may be version-dependent. Check before use.\n+     *\n+     * @return a ResourcePackInfo instance from the provided information\n+     */\n+    ResourcePackInfo build();\n+  }\n+\n+  /**\n+   * Represents the origin of the resource-pack.\n+   */\n+  enum Origin {\n+    /**\n+     * Resource-pack originated from the downstream server.\n+     */\n+    DOWNSTREAM_SERVER,\n+    /**\n+     * The player declined to download the resource pack.\n+     */\n+    PLUGIN_ON_PROXY", "originalCommit": "100eedf1023f742b9d73c5c00cb1489e7401713f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NTUwNDI0NA==", "url": "https://github.com/VelocityPowered/Velocity/pull/382#discussion_r645504244", "bodyText": "I know and its fixed, but till https://github.com/VelocityPowered/Velocity/pull/382/files#r640721589 is resolved I wont push a commit to fix it", "author": "Xernium", "createdAt": "2021-06-04T11:40:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NTUwMzExMg=="}], "type": "inlineReview"}, {"oid": "df21105701c4fb7f8f55ab8a50aad08c1f321d41", "url": "https://github.com/VelocityPowered/Velocity/commit/df21105701c4fb7f8f55ab8a50aad08c1f321d41", "message": "Minecraft 1.17-rc1", "committedDate": "2021-06-04T21:48:45Z", "type": "commit"}, {"oid": "59b29a075e0abe4e9aeca393975a1cfbead35ee9", "url": "https://github.com/VelocityPowered/Velocity/commit/59b29a075e0abe4e9aeca393975a1cfbead35ee9", "message": "Improve new Resource-pack API", "committedDate": "2021-06-05T14:07:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NTk5OTU0MA==", "url": "https://github.com/VelocityPowered/Velocity/pull/382#discussion_r645999540", "bodyText": "Nit: use the @see javadoc tag.", "author": "hugmanrique", "createdAt": "2021-06-05T14:49:51Z", "path": "api/src/main/java/com/velocitypowered/api/proxy/Player.java", "diffHunk": "@@ -238,6 +238,8 @@ default void sendMessage(net.kyori.text.Component component) {\n    * Queues and sends a new Resource-pack offer to the player.\n    * To monitor the status of the sent resource pack, subscribe to\n    * {@link PlayerResourcePackStatusEvent}.\n+   * To create a {@link ResourcePackInfo} use the", "originalCommit": "59b29a075e0abe4e9aeca393975a1cfbead35ee9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NTk5OTYyMg==", "url": "https://github.com/VelocityPowered/Velocity/pull/382#discussion_r645999622", "bodyText": "Nit: use the <ul> and <li> elements.", "author": "hugmanrique", "createdAt": "2021-06-05T14:50:30Z", "path": "api/src/main/java/com/velocitypowered/api/proxy/ProxyServer.java", "diffHunk": "@@ -225,14 +225,16 @@ BossBar createBossBar(net.kyori.text.Component title, @NonNull BossBarColor colo\n    *\n    * <p>Note: The resource-pack location should always:\n    * - Use HTTPS with a valid certificate.", "originalCommit": "59b29a075e0abe4e9aeca393975a1cfbead35ee9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NTk5OTY3NQ==", "url": "https://github.com/VelocityPowered/Velocity/pull/382#discussion_r645999675", "bodyText": "Nit: remove the dash between \"resource\" and \"pack\"", "author": "hugmanrique", "createdAt": "2021-06-05T14:50:50Z", "path": "api/src/main/java/com/velocitypowered/api/proxy/player/ResourcePackInfo.java", "diffHunk": "@@ -113,7 +113,7 @@\n      */\n     DOWNSTREAM_SERVER,\n     /**\n-     * The player declined to download the resource pack.\n+     * The resource-pack originated from a plugin on this proxy.", "originalCommit": "59b29a075e0abe4e9aeca393975a1cfbead35ee9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NTk5OTc3Nw==", "url": "https://github.com/VelocityPowered/Velocity/pull/382#discussion_r645999777", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Instates this event.\n          \n          \n            \n               * Instantiates this event.", "author": "hugmanrique", "createdAt": "2021-06-05T14:51:44Z", "path": "api/src/main/java/com/velocitypowered/api/event/player/PlayerResourcePackStatusEvent.java", "diffHunk": "@@ -18,10 +22,29 @@\n \n   private final Player player;\n   private final Status status;\n+  private final @MonotonicNonNull ResourcePackInfo packInfo;\n+  private boolean overwriteKick;\n \n+\n+  /**\n+   * Instates this event.", "originalCommit": "59b29a075e0abe4e9aeca393975a1cfbead35ee9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NTk5OTgxNQ==", "url": "https://github.com/VelocityPowered/Velocity/pull/382#discussion_r645999815", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Instates this event.\n          \n          \n            \n               * Instantiates this event.", "author": "hugmanrique", "createdAt": "2021-06-05T14:52:01Z", "path": "api/src/main/java/com/velocitypowered/api/event/player/PlayerResourcePackStatusEvent.java", "diffHunk": "@@ -18,10 +22,29 @@\n \n   private final Player player;\n   private final Status status;\n+  private final @MonotonicNonNull ResourcePackInfo packInfo;\n+  private boolean overwriteKick;\n \n+\n+  /**\n+   * Instates this event.\n+   * @deprecated Use {@link PlayerResourcePackStatusEvent#PlayerResourcePackStatusEvent\n+   *             (Player, Status, ResourcePackInfo)} instead.\n+   */\n+  @Deprecated\n   public PlayerResourcePackStatusEvent(Player player, Status status) {\n     this.player = Preconditions.checkNotNull(player, \"player\");\n     this.status = Preconditions.checkNotNull(status, \"status\");\n+    this.packInfo = null;\n+  }\n+\n+  /**\n+   * Instates this event.", "originalCommit": "59b29a075e0abe4e9aeca393975a1cfbead35ee9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NTk5OTk1MQ==", "url": "https://github.com/VelocityPowered/Velocity/pull/382#discussion_r645999951", "bodyText": "Nit: use <ul> and <li>.", "author": "hugmanrique", "createdAt": "2021-06-05T14:53:33Z", "path": "api/src/main/java/com/velocitypowered/api/proxy/player/ResourcePackInfo.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*\n+ * Copyright (C) 2018 Velocity Contributors\n+ *\n+ * The Velocity API is licensed under the terms of the MIT License. For more details,\n+ * reference the LICENSE file in the api top-level directory.\n+ */\n+\n+package com.velocitypowered.api.proxy.player;\n+\n+import net.kyori.adventure.text.Component;\n+import org.checkerframework.checker.nullness.qual.Nullable;\n+\n+public interface ResourcePackInfo {\n+\n+  /**\n+   * Gets the link the resource-pack can be found at.\n+   *\n+   * @return the location of the resource-pack\n+   */\n+  String getUrl();\n+\n+  /**\n+   * Gets the {@link Component} that is displayed on the resource-pack prompt.\n+   * This is only displayed if the client version is 1.17 or newer.\n+   *\n+   * @return the prompt if present or null otherwise\n+   */\n+  @Nullable\n+  Component getPrompt();\n+\n+  /**\n+   * Gets whether or not the acceptance of the resource-pack is enforced.\n+   * See {@link Builder#setShouldForce(boolean)} for more information.\n+   *\n+   * @return whether or not to force usage of this resource-pack\n+   */\n+  boolean getShouldForce();\n+\n+  /**\n+   * Gets the SHA-1 hash of the resource-pack\n+   * See {@link Builder#setHash(byte[])} for more information.\n+   *\n+   * @return the hash if present or null otherwise\n+   */\n+  @Nullable\n+  byte[] getHash();\n+\n+  /**\n+   * Gets the {@link Origin} of the resource-pack.\n+   *\n+   * @return the origin of the resource pack\n+   */\n+  Origin getOrigin();\n+\n+  interface Builder {\n+\n+    /**\n+     * Sets the resource-pack as required to play on the network.\n+     * This feature was introduced in 1.17.\n+     * Setting this to true has one of two effects:\n+     * If the client is on 1.17 or newer:\n+     *  - The resource-pack prompt will display without a decline button", "originalCommit": "59b29a075e0abe4e9aeca393975a1cfbead35ee9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NjAwMDc0OQ==", "url": "https://github.com/VelocityPowered/Velocity/pull/382#discussion_r646000749", "bodyText": "This logic is prone to bugs, I would store two different fields for pre-1.11 and post-1.11.", "author": "hugmanrique", "createdAt": "2021-06-05T15:00:59Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/protocol/packet/title/GenericTitlePacket.java", "diffHunk": "@@ -0,0 +1,136 @@\n+/*\n+ * Copyright (C) 2018 Velocity Contributors\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with this program.  If not, see <https://www.gnu.org/licenses/>.\n+ */\n+\n+package com.velocitypowered.proxy.protocol.packet.title;\n+\n+import com.velocitypowered.api.network.ProtocolVersion;\n+import com.velocitypowered.proxy.protocol.MinecraftPacket;\n+import com.velocitypowered.proxy.protocol.ProtocolUtils;\n+import io.netty.buffer.ByteBuf;\n+import org.checkerframework.checker.nullness.qual.Nullable;\n+\n+public abstract class GenericTitlePacket implements MinecraftPacket {\n+\n+  public enum ActionType {\n+    SET_TITLE(0),\n+    SET_SUBTITLE(1),\n+    SET_ACTION_BAR(2),\n+    SET_TIMES(3),\n+    HIDE(4),\n+    RESET(5);\n+\n+    private final int action;\n+\n+    ActionType(int action) {\n+      this.action = action;\n+    }\n+\n+    public int getAction(ProtocolVersion version) {\n+      return version.compareTo(ProtocolVersion.MINECRAFT_1_11) < 0\n+              ? action > 2 ? action - 1 : action : action;", "originalCommit": "59b29a075e0abe4e9aeca393975a1cfbead35ee9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NjAwNTg3OA==", "url": "https://github.com/VelocityPowered/Velocity/pull/382#discussion_r646005878", "bodyText": "This is a clientbount packet and we don't expect the server to send wrong data. I'm not keen on duplicate code so this is here to stay.", "author": "Xernium", "createdAt": "2021-06-05T15:52:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NjAwMDc0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NjAwNjM5OA==", "url": "https://github.com/VelocityPowered/Velocity/pull/382#discussion_r646006398", "bodyText": "On second thought, adding an extra field isn't necessary, but I would at least add parentheses to make the intention of the nested ternaries clear.", "author": "hugmanrique", "createdAt": "2021-06-05T15:57:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NjAwMDc0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NjAwMDc5MA==", "url": "https://github.com/VelocityPowered/Velocity/pull/382#discussion_r646000790", "bodyText": "I'm on GH so don't have an IDE, is this override needed?", "author": "hugmanrique", "createdAt": "2021-06-05T15:01:29Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/protocol/packet/title/LegacyTitlePacket.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/*\n+ * Copyright (C) 2018 Velocity Contributors\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with this program.  If not, see <https://www.gnu.org/licenses/>.\n+ */\n+\n+package com.velocitypowered.proxy.protocol.packet.title;\n+\n+import com.velocitypowered.api.network.ProtocolVersion;\n+import com.velocitypowered.proxy.connection.MinecraftSessionHandler;\n+import com.velocitypowered.proxy.protocol.ProtocolUtils;\n+import io.netty.buffer.ByteBuf;\n+import org.checkerframework.checker.nullness.qual.Nullable;\n+\n+public class LegacyTitlePacket extends GenericTitlePacket {\n+\n+  private @Nullable String component;\n+  private int fadeIn;\n+  private int stay;\n+  private int fadeOut;\n+\n+  @Override\n+  public void encode(ByteBuf buf, ProtocolUtils.Direction direction, ProtocolVersion version) {\n+    if (version.compareTo(ProtocolVersion.MINECRAFT_1_11) < 0\n+            && getAction() == ActionType.SET_ACTION_BAR) {\n+      throw new IllegalStateException(\"Action bars are only supported on 1.11 and newer\");\n+    }\n+    ProtocolUtils.writeVarInt(buf, getAction().getAction(version));\n+\n+    switch (getAction()) {\n+      case SET_TITLE:\n+      case SET_SUBTITLE:\n+      case SET_ACTION_BAR:\n+        if (component == null) {\n+          throw new IllegalStateException(\"No component found for \" + getAction());\n+        }\n+        ProtocolUtils.writeString(buf, component);\n+        break;\n+      case SET_TIMES:\n+        buf.writeInt(fadeIn);\n+        buf.writeInt(stay);\n+        buf.writeInt(fadeOut);\n+        break;\n+      case HIDE:\n+      case RESET:\n+        break;\n+      default:\n+        throw new UnsupportedOperationException(\"Unknown action \" + getAction());\n+    }\n+\n+  }\n+\n+  @Override\n+  public void setAction(ActionType action) {\n+    super.setAction(action);", "originalCommit": "59b29a075e0abe4e9aeca393975a1cfbead35ee9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NjA1MjI5Mw==", "url": "https://github.com/VelocityPowered/Velocity/pull/382#discussion_r646052293", "bodyText": "It doesn't appear to be (it extends GenericTitlePacket and this could be implicitly implemented as an override by deleting this method.)", "author": "astei", "createdAt": "2021-06-06T00:20:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NjAwMDc5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NjAwMTAxNA==", "url": "https://github.com/VelocityPowered/Velocity/pull/382#discussion_r646001014", "bodyText": "Since some GenericTitlePacket subclasses force an specific action type, I wouldn't expose the setAction method (e.g. used by constructTitlePacket). Instead, I think this is only needed for LegacyTitlePacket? I'm probably wrong though.", "author": "hugmanrique", "createdAt": "2021-06-05T15:03:45Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/protocol/packet/title/TitleTextPacket.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright (C) 2018 Velocity Contributors\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with this program.  If not, see <https://www.gnu.org/licenses/>.\n+ */\n+\n+package com.velocitypowered.proxy.protocol.packet.title;\n+\n+import com.velocitypowered.api.network.ProtocolVersion;\n+import com.velocitypowered.proxy.connection.MinecraftSessionHandler;\n+import com.velocitypowered.proxy.protocol.ProtocolUtils;\n+import io.netty.buffer.ByteBuf;\n+\n+public class TitleTextPacket extends GenericTitlePacket {\n+\n+  private String component;\n+\n+  public TitleTextPacket() {\n+    setAction(ActionType.SET_TITLE);", "originalCommit": "59b29a075e0abe4e9aeca393975a1cfbead35ee9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "43b72ff8260b23b3e3f6c01036ab11c717da14ab", "url": "https://github.com/VelocityPowered/Velocity/commit/43b72ff8260b23b3e3f6c01036ab11c717da14ab", "message": "Apply some spelling fixes from code review\n\nCo-authored-by: Hugo Manrique <hugmanrique@users.noreply.github.com>", "committedDate": "2021-06-06T00:20:47Z", "type": "commit"}]}