{"pr_number": 272, "pr_title": "Make PluginContainer injectable", "pr_createdAt": "2020-02-05T21:20:33Z", "pr_url": "https://github.com/VelocityPowered/Velocity/pull/272", "timeline": [{"oid": "abcbbbd8c80bb3ddefd5dfd9e97980953973628c", "url": "https://github.com/VelocityPowered/Velocity/commit/abcbbbd8c80bb3ddefd5dfd9e97980953973628c", "message": "Make PluginContainer injectable", "committedDate": "2020-02-05T21:17:10Z", "type": "commit"}, {"oid": "81748b4e04a0337efa68b568f2e301177e855c98", "url": "https://github.com/VelocityPowered/Velocity/commit/81748b4e04a0337efa68b568f2e301177e855c98", "message": "Fixed whitespace", "committedDate": "2020-02-05T23:32:52Z", "type": "commit"}, {"oid": "b74504f78f1efc6808d160e5c05c71b17d230d0e", "url": "https://github.com/VelocityPowered/Velocity/commit/b74504f78f1efc6808d160e5c05c71b17d230d0e", "message": "Fixed whitespace (pt. 2)", "committedDate": "2020-02-05T23:41:14Z", "type": "commit"}, {"oid": "0637f6229dbed0332d8bfe49afa48c4a8d856c95", "url": "https://github.com/VelocityPowered/Velocity/commit/0637f6229dbed0332d8bfe49afa48c4a8d856c95", "message": "Can now inject PluginContainer from other plugins", "committedDate": "2020-02-07T10:42:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU4OTQ2OQ==", "url": "https://github.com/VelocityPowered/Velocity/pull/272#discussion_r376589469", "bodyText": "Can we be more specific here? This bit of JavaDoc adds no information.", "author": "astei", "createdAt": "2020-02-07T20:21:54Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/plugin/loader/PluginLoader.java", "diffHunk": "@@ -11,5 +13,30 @@\n \n   PluginDescription loadPlugin(Path source) throws Exception;\n \n-  PluginContainer createPlugin(PluginDescription plugin) throws Exception;\n+  /**\n+   * Creates a {@link Module} for the provided {@link PluginContainer}\n+   * and verifies that the container's {@link PluginDescription} is correct.\n+   *\n+   * <p>Does not create an instance of the plugin.</p>\n+   *\n+   * @param container the plugin container\n+   * @return the module containing bindings specific to this plugin\n+   * @throws Exception If anything went wrong", "originalCommit": "0637f6229dbed0332d8bfe49afa48c4a8d856c95", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU5MDcyNg==", "url": "https://github.com/VelocityPowered/Velocity/pull/272#discussion_r376590726", "bodyText": "If you try to inject a PluginContainer for some other plugin but that plugin doesn't exist, Guice will refuse to initialize the object for the plugin. Given that Velocity also supports optional dependencies, this isn't some strange thing that will never happen - it is a possibility.", "author": "astei", "createdAt": "2020-02-07T20:25:13Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/plugin/VelocityPluginManager.java", "diffHunk": "@@ -92,19 +100,44 @@ public void loadPlugins(Path directory) throws IOException {\n         }\n       }\n \n-      // Actually create the plugin\n-      PluginContainer pluginObject;\n+      try {\n+        VelocityPluginContainer container = new VelocityPluginContainer(plugin);\n+        pluginContainers.put(container, loader.createModule(container));\n+      } catch (Exception e) {\n+        logger.error(\"Can't create module for plugin {}\", plugin.getId(), e);\n+      }\n+    }\n+\n+    // Make a global Guice module that with common bindings for every plugin\n+    AbstractModule commonModule = new AbstractModule() {\n+      @Override\n+      protected void configure() {\n+        bind(ProxyServer.class).toInstance(server);\n+        bind(PluginManager.class).toInstance(server.getPluginManager());\n+        bind(EventManager.class).toInstance(server.getEventManager());\n+        bind(CommandManager.class).toInstance(server.getCommandManager());\n+        for (PluginContainer container : pluginContainers.keySet()) {\n+          bind(PluginContainer.class)", "originalCommit": "0637f6229dbed0332d8bfe49afa48c4a8d856c95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU5NDE5OA==", "url": "https://github.com/VelocityPowered/Velocity/pull/272#discussion_r376594198", "bodyText": "Guice supports optional dependencies with\n@Inject(optional = true)", "author": "alexstaeding", "createdAt": "2020-02-07T20:34:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU5MDcyNg=="}], "type": "inlineReview"}, {"oid": "def2c08ad67cb263ca6a988e889b138f3d88aafd", "url": "https://github.com/VelocityPowered/Velocity/commit/def2c08ad67cb263ca6a988e889b138f3d88aafd", "message": "Updated javadoc in PluginLoader", "committedDate": "2020-02-07T20:51:44Z", "type": "commit"}]}