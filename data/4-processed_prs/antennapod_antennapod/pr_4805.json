{"pr_number": 4805, "pr_title": "Run DateUtilsTest as Unit Test", "pr_createdAt": "2020-12-29T13:45:29Z", "pr_url": "https://github.com/AntennaPod/AntennaPod/pull/4805", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDIxNTQ1Ng==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4805#discussion_r550215456", "bodyText": "Why is this needed? Isn't this done in the static block automatically?", "author": "ByteHamster", "createdAt": "2020-12-30T14:36:09Z", "path": "core/src/test/java/de/danoeh/antennapod/core/util/DateUtilsTest.java", "diffHunk": "@@ -12,16 +12,17 @@\n \n /**\n  * Unit test for {@link DateUtils}.\n- *\n- * Note: It NEEDS to be run in android devices, i.e., it cannot be run in standard JDK, because\n- * the test invokes some android platform-specific behavior in the underlying\n- * {@link java.text.SimpleDateFormat} used by {@link DateUtils}.\n- *\n  */\n-@SmallTest\n+@SuppressWarnings(\"ConstantConditions\")\n public class DateUtilsTest {\n+\n+    @Before\n+    public void setUp() {\n+        DateUtils.dateFormatParser.setTimeZone(DateUtils.defaultTimezone);", "originalCommit": "cdcff30d853b4a01ecf075e3b9c6d4d585d82cf0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI2MTk1Mw==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4805#discussion_r550261953", "bodyText": "Sorry, I forgot to comment on this. SimpleDateFormat.parse() modifies the configured timezone if the date string contains a timezone, e.g. \"Sat, 28 Mar 2015 01:31 EST\". As we reuse a global SimpleDateFormat instance this leads to side effects and breaks some unit tests. So I had to add the setUp() method.\nWhy wasn't that a problem before?\nAndroid has a modified version of SimpleDateFormat that avoids that side effect. See the comment in the Android source code snipped below:\npublic Date parse(String text, ParsePosition pos) {\n    // BEGIN Android-changed: extract parseInternal() and avoid modifying timezone during parse.\n    // Make sure the timezone associated with this dateformat instance (set via\n    // {@code setTimeZone} isn't change as a side-effect of parsing a date.\n    final TimeZone tz = getTimeZone();\n    try {\n        return parseInternal(text, pos);\n    } finally {\n        setTimeZone(tz);\n    }\n}\n\nBTW: The usage of a global SimpleDateFormat instance isn't thread-safe and thus error-prone. I'm aware that the current implementation intends to speed up date parsing but on the other side it parses a single date string with up to 29 patterns. Maybe we could speed up date parsing even more by an own date parser implementation or find an appropriate open source implementation.", "author": "damoasda", "createdAt": "2020-12-30T17:00:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDIxNTQ1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDc5MzQwOA==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4805#discussion_r550793408", "bodyText": "Oh, right. This was reverted in a bug fix release for 2.1.x (#4703 and the error in #4648) but I did not merge master into develop yet. Will do that today.", "author": "ByteHamster", "createdAt": "2021-01-01T18:30:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDIxNTQ1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDgwNjA5Nw==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4805#discussion_r550806097", "bodyText": "Great to hear. So I will wait for the merge, remove the setTimeZone() call and test again.", "author": "damoasda", "createdAt": "2021-01-01T20:58:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDIxNTQ1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDgxNzc2NQ==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4805#discussion_r550817765", "bodyText": "It's already merged :)", "author": "ByteHamster", "createdAt": "2021-01-01T23:07:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDIxNTQ1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDg3MDE2OQ==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4805#discussion_r550870169", "bodyText": "Perfect, I updated the code. (This time it looks like I didn't mess up the commit history \ud83d\ude01)", "author": "damoasda", "createdAt": "2021-01-02T10:59:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDIxNTQ1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDg3MDkxNw==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4805#discussion_r550870917", "bodyText": "I just fixed the Illegal connection pointer thing in #4828. Could you rebase again to make the tests pass, please? \ud83d\ude48", "author": "ByteHamster", "createdAt": "2021-01-02T11:09:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDIxNTQ1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDg3MTU0OA==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4805#discussion_r550871548", "bodyText": "Done. The tests finished successfully. \ud83d\ude00", "author": "damoasda", "createdAt": "2021-01-02T11:17:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDIxNTQ1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDIxNTY5OQ==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4805#discussion_r550215699", "bodyText": "I hope that this does not break anything... Probably needs detailed beta tests.", "author": "ByteHamster", "createdAt": "2020-12-30T14:36:47Z", "path": "core/src/main/java/de/danoeh/antennapod/core/util/DateUtils.java", "diffHunk": "@@ -37,9 +37,12 @@ public static Date parse(final String input) {\n         }\n         String date = input.trim().replace('/', '-').replaceAll(\"( ){2,}+\", \" \");\n \n+        // remove colon from timezone to avoid differences between Android and Java SimpleDateFormat\n+        date = date.replaceAll(\"([+-]\\\\d\\\\d):(\\\\d\\\\d)$\", \"$1$2\");", "originalCommit": "cdcff30d853b4a01ecf075e3b9c6d4d585d82cf0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDI2MjQxMA==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4805#discussion_r550262410", "bodyText": "Yes, that has to be tested very well.", "author": "damoasda", "createdAt": "2020-12-30T17:01:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDIxNTY5OQ=="}], "type": "inlineReview"}, {"oid": "4384d1bdff48de7b11a7872c7ea4716652999471", "url": "https://github.com/AntennaPod/AntennaPod/commit/4384d1bdff48de7b11a7872c7ea4716652999471", "message": "Adopt changes after develop branch updates", "committedDate": "2021-01-02T10:27:08Z", "type": "forcePushed"}, {"oid": "d5ba17feaf26d0fe10588087244024b96f960d62", "url": "https://github.com/AntennaPod/AntennaPod/commit/d5ba17feaf26d0fe10588087244024b96f960d62", "message": "Run DateUtilsTest with Robolectric", "committedDate": "2021-01-02T11:11:24Z", "type": "commit"}, {"oid": "91868897ecf0c0ce4899b277305de2f2c75a9c7d", "url": "https://github.com/AntennaPod/AntennaPod/commit/91868897ecf0c0ce4899b277305de2f2c75a9c7d", "message": "Adopt changes after develop branch updates", "committedDate": "2021-01-02T11:11:24Z", "type": "commit"}, {"oid": "91868897ecf0c0ce4899b277305de2f2c75a9c7d", "url": "https://github.com/AntennaPod/AntennaPod/commit/91868897ecf0c0ce4899b277305de2f2c75a9c7d", "message": "Adopt changes after develop branch updates", "committedDate": "2021-01-02T11:11:24Z", "type": "forcePushed"}]}