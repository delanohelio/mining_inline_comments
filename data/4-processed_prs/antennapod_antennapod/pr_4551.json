{"pr_number": 4551, "pr_title": "Local feeds: Unit tests for LocalFeedUpdater", "pr_createdAt": "2020-10-18T08:35:44Z", "pr_url": "https://github.com/AntennaPod/AntennaPod/pull/4551", "timeline": [{"oid": "71de40ebb10d1ed749007b7f9b64dfa9d834f4bd", "url": "https://github.com/AntennaPod/AntennaPod/commit/71de40ebb10d1ed749007b7f9b64dfa9d834f4bd", "message": "Unit tests for LocalFeedUpdater", "committedDate": "2020-10-18T08:17:12Z", "type": "commit"}, {"oid": "40641bf55568f599cc19d6e7506fc46c4ffee764", "url": "https://github.com/AntennaPod/AntennaPod/commit/40641bf55568f599cc19d6e7506fc46c4ffee764", "message": "Changes due to Mockito version upgrade", "committedDate": "2020-10-18T08:18:02Z", "type": "commit"}, {"oid": "214543f905879825dbf7f354b55224bb072b94a3", "url": "https://github.com/AntennaPod/AntennaPod/commit/214543f905879825dbf7f354b55224bb072b94a3", "message": "Make checkstyle happy", "committedDate": "2020-10-18T09:24:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc4NTkxNg==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4551#discussion_r508785916", "bodyText": "Would it be possible to use a test flavour of the assets folder? From my understanding, sampledata is used for layout rendering in Android Studio, not for unit tests.", "author": "ByteHamster", "createdAt": "2020-10-20T19:31:14Z", "path": "core/src/test/java/de/danoeh/antennapod/core/feed/LocalFeedUpdaterTest.java", "diffHunk": "@@ -0,0 +1,258 @@\n+package de.danoeh.antennapod.core.feed;\n+\n+import android.app.Application;\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.database.sqlite.SQLiteOpenHelper;\n+import android.media.MediaMetadataRetriever;\n+import android.net.Uri;\n+import android.webkit.MimeTypeMap;\n+\n+import androidx.documentfile.provider.DocumentFile;\n+import androidx.test.platform.app.InstrumentationRegistry;\n+\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.MockedStatic;\n+import org.mockito.Mockito;\n+import org.robolectric.RobolectricTestRunner;\n+import org.robolectric.shadows.ShadowMediaMetadataRetriever;\n+import org.robolectric.shadows.util.DataSource;\n+\n+import java.io.File;\n+import java.lang.reflect.Field;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import de.danoeh.antennapod.core.ApplicationCallbacks;\n+import de.danoeh.antennapod.core.ClientConfig;\n+import de.danoeh.antennapod.core.R;\n+import de.danoeh.antennapod.core.preferences.UserPreferences;\n+import de.danoeh.antennapod.core.storage.DBReader;\n+import de.danoeh.antennapod.core.storage.PodDBAdapter;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.Mockito.any;\n+import static org.mockito.Mockito.anyInt;\n+import static org.mockito.Mockito.anyString;\n+import static org.mockito.Mockito.eq;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+import static org.robolectric.Shadows.shadowOf;\n+\n+/**\n+ * Test local feeds handling in class LocalFeedUpdater.\n+ */\n+@RunWith(RobolectricTestRunner.class)\n+public class LocalFeedUpdaterTest {\n+\n+    /**\n+     * URL to locate the local feed media files on the external storage (SD card).\n+     * The exact URL doesn't matter here as access to external storage is mocked\n+     * (seems not to be supported by Robolectric).\n+     */\n+    private static final String FEED_URL =\n+            \"content://com.android.externalstorage.documents/tree/primary%3ADownload%2Flocal-feed\";\n+\n+    private Context context;\n+    private File localFeedDir1;\n+    private File localFeedDir2;\n+\n+    @Before\n+    public void setUp() {\n+\n+        // Initialize environment\n+        context = InstrumentationRegistry.getInstrumentation().getContext();\n+        UserPreferences.init(context);\n+\n+        // Initialize database\n+        PodDBAdapter.init(context);\n+        PodDBAdapter.deleteDatabase();\n+        PodDBAdapter adapter = PodDBAdapter.getInstance();\n+        adapter.open();\n+        adapter.close();\n+\n+        // Emulate turned off gpodder.net support in SyncService\n+        SharedPreferences spref = mock(SharedPreferences.class);\n+        when(spref.getString(eq(\"prefGpodnetHostname\"), anyString())).thenReturn(\"gpodder.net\");\n+        Application app = mock(Application.class);\n+        when(app.getSharedPreferences(anyString(), anyInt())).thenReturn(spref);\n+        ClientConfig.applicationCallbacks = mock(ApplicationCallbacks.class);\n+        when(ClientConfig.applicationCallbacks.getApplicationInstance()).thenReturn(app);\n+\n+        localFeedDir1 = new File(\"sampledata/local-feed1\");", "originalCommit": "214543f905879825dbf7f354b55224bb072b94a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE1Nzc1OQ==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4551#discussion_r511157759", "bodyText": "Thank you for the hint regarding sampledata, I wasn't aware of that. I will look for an alternative solution in the next days.", "author": "damoasda", "createdAt": "2020-10-23T21:12:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc4NTkxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ4Mzg4Mg==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4551#discussion_r511483882", "bodyText": "I moved the local feed media files from the sampledata folder to the test/assets folder. For file access context.getAssets() is used. Anything else I can improve?", "author": "damoasda", "createdAt": "2020-10-24T15:29:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc4NTkxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc4NzM2OA==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4551#discussion_r508787368", "bodyText": "Does this need to be emulated manually? I think the default value of gpodder should already be set to \"off\".", "author": "ByteHamster", "createdAt": "2020-10-20T19:33:56Z", "path": "core/src/test/java/de/danoeh/antennapod/core/feed/LocalFeedUpdaterTest.java", "diffHunk": "@@ -0,0 +1,258 @@\n+package de.danoeh.antennapod.core.feed;\n+\n+import android.app.Application;\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.database.sqlite.SQLiteOpenHelper;\n+import android.media.MediaMetadataRetriever;\n+import android.net.Uri;\n+import android.webkit.MimeTypeMap;\n+\n+import androidx.documentfile.provider.DocumentFile;\n+import androidx.test.platform.app.InstrumentationRegistry;\n+\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.MockedStatic;\n+import org.mockito.Mockito;\n+import org.robolectric.RobolectricTestRunner;\n+import org.robolectric.shadows.ShadowMediaMetadataRetriever;\n+import org.robolectric.shadows.util.DataSource;\n+\n+import java.io.File;\n+import java.lang.reflect.Field;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import de.danoeh.antennapod.core.ApplicationCallbacks;\n+import de.danoeh.antennapod.core.ClientConfig;\n+import de.danoeh.antennapod.core.R;\n+import de.danoeh.antennapod.core.preferences.UserPreferences;\n+import de.danoeh.antennapod.core.storage.DBReader;\n+import de.danoeh.antennapod.core.storage.PodDBAdapter;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.Mockito.any;\n+import static org.mockito.Mockito.anyInt;\n+import static org.mockito.Mockito.anyString;\n+import static org.mockito.Mockito.eq;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+import static org.robolectric.Shadows.shadowOf;\n+\n+/**\n+ * Test local feeds handling in class LocalFeedUpdater.\n+ */\n+@RunWith(RobolectricTestRunner.class)\n+public class LocalFeedUpdaterTest {\n+\n+    /**\n+     * URL to locate the local feed media files on the external storage (SD card).\n+     * The exact URL doesn't matter here as access to external storage is mocked\n+     * (seems not to be supported by Robolectric).\n+     */\n+    private static final String FEED_URL =\n+            \"content://com.android.externalstorage.documents/tree/primary%3ADownload%2Flocal-feed\";\n+\n+    private Context context;\n+    private File localFeedDir1;\n+    private File localFeedDir2;\n+\n+    @Before\n+    public void setUp() {\n+\n+        // Initialize environment\n+        context = InstrumentationRegistry.getInstrumentation().getContext();\n+        UserPreferences.init(context);\n+\n+        // Initialize database\n+        PodDBAdapter.init(context);\n+        PodDBAdapter.deleteDatabase();\n+        PodDBAdapter adapter = PodDBAdapter.getInstance();\n+        adapter.open();\n+        adapter.close();\n+\n+        // Emulate turned off gpodder.net support in SyncService", "originalCommit": "214543f905879825dbf7f354b55224bb072b94a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTEzODgzMA==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4551#discussion_r511138830", "bodyText": "The comment is misleading somehow. The core point is that ClientConfig.applicationCallbacks has to be initialized manually to make GpodnetPreferences.loggedIn() return false, otherwise I get a NullPointerException in GpodnetPreferences.", "author": "damoasda", "createdAt": "2020-10-23T20:24:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc4NzM2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE1OTQ3MA==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4551#discussion_r511159470", "bodyText": "Ah okay. How about calling ClientConfig.initialize? That should deal with initializing PodDbAdapter, user preferences, etc.", "author": "ByteHamster", "createdAt": "2020-10-23T21:17:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc4NzM2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ4NTc5OQ==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4551#discussion_r511485799", "bodyText": "Hmm, ClientConfig.initialize() doesn't set ClientConfig.applicationCallbacks, so I get a NullPointerException in GpodnetPreferences. The only code that currently sets ClientConfig.applicationCallbacks is in the class ClientConfigurator that belongs to the app module. Did I miss something?", "author": "damoasda", "createdAt": "2020-10-24T15:49:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc4NzM2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTUwMDE2NQ==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4551#discussion_r511500165", "bodyText": "Oh my, those callback methods regularly annoy me :D They are a leftover from the time when AntennaPod could be easily white-labelled.\nWould it be possible to only mock applicationCallbacks but not shared preferences?", "author": "ByteHamster", "createdAt": "2020-10-24T18:26:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc4NzM2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTUxMzQ3MA==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4551#discussion_r511513470", "bodyText": "Yes, I could simplify the test code. Now it only mocks the class ApplicationCallbacks but not the classes Application and SharedPreferences.", "author": "damoasda", "createdAt": "2020-10-24T20:55:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc4NzM2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc4ODE2NA==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4551#discussion_r508788164", "bodyText": "This looks pretty hacky. What about adding a method directly to PodDbAdapter? Something like PodDbAdapter.tearDownTests()?", "author": "ByteHamster", "createdAt": "2020-10-20T19:35:27Z", "path": "core/src/test/java/de/danoeh/antennapod/core/feed/LocalFeedUpdaterTest.java", "diffHunk": "@@ -0,0 +1,258 @@\n+package de.danoeh.antennapod.core.feed;\n+\n+import android.app.Application;\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.database.sqlite.SQLiteOpenHelper;\n+import android.media.MediaMetadataRetriever;\n+import android.net.Uri;\n+import android.webkit.MimeTypeMap;\n+\n+import androidx.documentfile.provider.DocumentFile;\n+import androidx.test.platform.app.InstrumentationRegistry;\n+\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.MockedStatic;\n+import org.mockito.Mockito;\n+import org.robolectric.RobolectricTestRunner;\n+import org.robolectric.shadows.ShadowMediaMetadataRetriever;\n+import org.robolectric.shadows.util.DataSource;\n+\n+import java.io.File;\n+import java.lang.reflect.Field;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import de.danoeh.antennapod.core.ApplicationCallbacks;\n+import de.danoeh.antennapod.core.ClientConfig;\n+import de.danoeh.antennapod.core.R;\n+import de.danoeh.antennapod.core.preferences.UserPreferences;\n+import de.danoeh.antennapod.core.storage.DBReader;\n+import de.danoeh.antennapod.core.storage.PodDBAdapter;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.Mockito.any;\n+import static org.mockito.Mockito.anyInt;\n+import static org.mockito.Mockito.anyString;\n+import static org.mockito.Mockito.eq;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+import static org.robolectric.Shadows.shadowOf;\n+\n+/**\n+ * Test local feeds handling in class LocalFeedUpdater.\n+ */\n+@RunWith(RobolectricTestRunner.class)\n+public class LocalFeedUpdaterTest {\n+\n+    /**\n+     * URL to locate the local feed media files on the external storage (SD card).\n+     * The exact URL doesn't matter here as access to external storage is mocked\n+     * (seems not to be supported by Robolectric).\n+     */\n+    private static final String FEED_URL =\n+            \"content://com.android.externalstorage.documents/tree/primary%3ADownload%2Flocal-feed\";\n+\n+    private Context context;\n+    private File localFeedDir1;\n+    private File localFeedDir2;\n+\n+    @Before\n+    public void setUp() {\n+\n+        // Initialize environment\n+        context = InstrumentationRegistry.getInstrumentation().getContext();\n+        UserPreferences.init(context);\n+\n+        // Initialize database\n+        PodDBAdapter.init(context);\n+        PodDBAdapter.deleteDatabase();\n+        PodDBAdapter adapter = PodDBAdapter.getInstance();\n+        adapter.open();\n+        adapter.close();\n+\n+        // Emulate turned off gpodder.net support in SyncService\n+        SharedPreferences spref = mock(SharedPreferences.class);\n+        when(spref.getString(eq(\"prefGpodnetHostname\"), anyString())).thenReturn(\"gpodder.net\");\n+        Application app = mock(Application.class);\n+        when(app.getSharedPreferences(anyString(), anyInt())).thenReturn(spref);\n+        ClientConfig.applicationCallbacks = mock(ApplicationCallbacks.class);\n+        when(ClientConfig.applicationCallbacks.getApplicationInstance()).thenReturn(app);\n+\n+        localFeedDir1 = new File(\"sampledata/local-feed1\");\n+        localFeedDir2 = new File(\"sampledata/local-feed2\");\n+        List<File> files = new ArrayList<>();\n+        Collections.addAll(files, localFeedDir1.listFiles());\n+        Collections.addAll(files, localFeedDir2.listFiles());\n+        for (File file : files) {\n+            DataSource ds = DataSource.toDataSource(context, Uri.fromFile(file));\n+            ShadowMediaMetadataRetriever.addMetadata(ds, MediaMetadataRetriever.METADATA_KEY_DURATION, \"10\");\n+            ShadowMediaMetadataRetriever.addMetadata(ds, MediaMetadataRetriever.METADATA_KEY_TITLE, file.getName());\n+        }\n+        shadowOf(MimeTypeMap.getSingleton()).addExtensionMimeTypMapping(\"mp3\", \"audio/mp3\");\n+    }\n+\n+    @SuppressWarnings(\"JavaReflectionMemberAccess\")\n+    @After\n+    public void tearDown() throws Exception {\n+        // Workaround for Robolectric issue in ShadowSQLiteConnection: IllegalStateException: Illegal connection pointer", "originalCommit": "214543f905879825dbf7f354b55224bb072b94a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE0ODY0Mw==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4551#discussion_r511148643", "bodyText": "You're right, it's ugly code. \ud83d\ude2d\nAn approach like PodDbAdapter.tearDownTests() couldn't cover all needs without the help of Mockito as the field SQLiteOpenHelper.mContext is declared as final, but it has to be set to null after each test to avoid the \"Illegal connection pointer\" error when using Robolectric. For more information see the discussion in robolectric/robolectric#1890.", "author": "damoasda", "createdAt": "2020-10-23T20:48:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc4ODE2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE2MTA2Ng==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4551#discussion_r511161066", "bodyText": "Hmm, okay then I would suggest to at least hide the ugliness somewhere in another class (basically like EspressoTestUtils, just for RobolectricTestUtils)", "author": "ByteHamster", "createdAt": "2020-10-23T21:21:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc4ODE2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTM2OTk1Ng==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4551#discussion_r511369956", "bodyText": "Sorry, my answer is wrong. The field SQLiteOpenHelper.mContext is not touched, instead the field SQLiteOpenHelper.mDatabase has to be reset which is not final. Finally, I could introduce the method PodDbAdapter.tearDownTests() as suggested and replace the hacky reflection code. \ud83d\ude01", "author": "damoasda", "createdAt": "2020-10-24T09:50:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc4ODE2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc4ODg5NA==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4551#discussion_r508788894", "bodyText": "Adding items seems to be pretty repetitive code. How about creating a function for that?", "author": "ByteHamster", "createdAt": "2020-10-20T19:36:42Z", "path": "core/src/test/java/de/danoeh/antennapod/core/feed/LocalFeedUpdaterTest.java", "diffHunk": "@@ -0,0 +1,258 @@\n+package de.danoeh.antennapod.core.feed;\n+\n+import android.app.Application;\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.database.sqlite.SQLiteOpenHelper;\n+import android.media.MediaMetadataRetriever;\n+import android.net.Uri;\n+import android.webkit.MimeTypeMap;\n+\n+import androidx.documentfile.provider.DocumentFile;\n+import androidx.test.platform.app.InstrumentationRegistry;\n+\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.MockedStatic;\n+import org.mockito.Mockito;\n+import org.robolectric.RobolectricTestRunner;\n+import org.robolectric.shadows.ShadowMediaMetadataRetriever;\n+import org.robolectric.shadows.util.DataSource;\n+\n+import java.io.File;\n+import java.lang.reflect.Field;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import de.danoeh.antennapod.core.ApplicationCallbacks;\n+import de.danoeh.antennapod.core.ClientConfig;\n+import de.danoeh.antennapod.core.R;\n+import de.danoeh.antennapod.core.preferences.UserPreferences;\n+import de.danoeh.antennapod.core.storage.DBReader;\n+import de.danoeh.antennapod.core.storage.PodDBAdapter;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.Mockito.any;\n+import static org.mockito.Mockito.anyInt;\n+import static org.mockito.Mockito.anyString;\n+import static org.mockito.Mockito.eq;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+import static org.robolectric.Shadows.shadowOf;\n+\n+/**\n+ * Test local feeds handling in class LocalFeedUpdater.\n+ */\n+@RunWith(RobolectricTestRunner.class)\n+public class LocalFeedUpdaterTest {\n+\n+    /**\n+     * URL to locate the local feed media files on the external storage (SD card).\n+     * The exact URL doesn't matter here as access to external storage is mocked\n+     * (seems not to be supported by Robolectric).\n+     */\n+    private static final String FEED_URL =\n+            \"content://com.android.externalstorage.documents/tree/primary%3ADownload%2Flocal-feed\";\n+\n+    private Context context;\n+    private File localFeedDir1;\n+    private File localFeedDir2;\n+\n+    @Before\n+    public void setUp() {\n+\n+        // Initialize environment\n+        context = InstrumentationRegistry.getInstrumentation().getContext();\n+        UserPreferences.init(context);\n+\n+        // Initialize database\n+        PodDBAdapter.init(context);\n+        PodDBAdapter.deleteDatabase();\n+        PodDBAdapter adapter = PodDBAdapter.getInstance();\n+        adapter.open();\n+        adapter.close();\n+\n+        // Emulate turned off gpodder.net support in SyncService\n+        SharedPreferences spref = mock(SharedPreferences.class);\n+        when(spref.getString(eq(\"prefGpodnetHostname\"), anyString())).thenReturn(\"gpodder.net\");\n+        Application app = mock(Application.class);\n+        when(app.getSharedPreferences(anyString(), anyInt())).thenReturn(spref);\n+        ClientConfig.applicationCallbacks = mock(ApplicationCallbacks.class);\n+        when(ClientConfig.applicationCallbacks.getApplicationInstance()).thenReturn(app);\n+\n+        localFeedDir1 = new File(\"sampledata/local-feed1\");\n+        localFeedDir2 = new File(\"sampledata/local-feed2\");\n+        List<File> files = new ArrayList<>();\n+        Collections.addAll(files, localFeedDir1.listFiles());\n+        Collections.addAll(files, localFeedDir2.listFiles());\n+        for (File file : files) {\n+            DataSource ds = DataSource.toDataSource(context, Uri.fromFile(file));\n+            ShadowMediaMetadataRetriever.addMetadata(ds, MediaMetadataRetriever.METADATA_KEY_DURATION, \"10\");\n+            ShadowMediaMetadataRetriever.addMetadata(ds, MediaMetadataRetriever.METADATA_KEY_TITLE, file.getName());\n+        }\n+        shadowOf(MimeTypeMap.getSingleton()).addExtensionMimeTypMapping(\"mp3\", \"audio/mp3\");\n+    }\n+\n+    @SuppressWarnings(\"JavaReflectionMemberAccess\")\n+    @After\n+    public void tearDown() throws Exception {\n+        // Workaround for Robolectric issue in ShadowSQLiteConnection: IllegalStateException: Illegal connection pointer\n+        Field field = PodDBAdapter.class.getDeclaredField(\"db\");\n+        field.setAccessible(true);\n+        field.set(null, null);\n+\n+        for (Class<?> innerClass : PodDBAdapter.class.getDeclaredClasses()) {\n+            if (innerClass.getSimpleName().equals(\"SingletonHolder\")) {\n+                Field dbHelperField = innerClass.getDeclaredField(\"dbHelper\");\n+                dbHelperField.setAccessible(true);\n+                SQLiteOpenHelper dbHelper = (SQLiteOpenHelper) dbHelperField.get(null);\n+                Field databaseField = SQLiteOpenHelper.class.getDeclaredField(\"mDatabase\");\n+                databaseField.setAccessible(true);\n+                databaseField.set(dbHelper, null);\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Test adding a new local feed.\n+     */\n+    @Test\n+    public void testUpdateFeed_AddNewFeed() {\n+        // verify empty database\n+        List<Feed> feedListBefore = DBReader.getFeedList();\n+        assertTrue(feedListBefore.isEmpty());\n+\n+        DocumentFile documentFile = DocumentFile.fromFile(localFeedDir2);\n+        try (MockedStatic<DocumentFile> dfMock = Mockito.mockStatic(DocumentFile.class)) {\n+            // mock external storage\n+            dfMock.when(() -> DocumentFile.fromTreeUri(any(), any())).thenReturn(documentFile);\n+\n+            // call method to test\n+            Feed feed = new Feed(FEED_URL, null);\n+            LocalFeedUpdater.updateFeed(feed, context);\n+        }\n+\n+        // verify new feed in database\n+        List<Feed> feedListAfter = DBReader.getFeedList();\n+        assertEquals(1, feedListAfter.size());\n+        Feed feedAfter = feedListAfter.get(0);\n+        assertEquals(FEED_URL, feedAfter.getDownload_url());\n+        List<FeedItem> feedItems = DBReader.getFeedItemList(feedAfter);\n+        assertEquals(2, feedItems.size());\n+    }\n+\n+    /**\n+     * Test adding further items to an existing local feed.\n+     */\n+    @Test\n+    public void testUpdateFeed_AddMoreItems() {\n+        // add local feed with 1 item (localFeedDir1)\n+        DocumentFile documentFile1 = DocumentFile.fromFile(localFeedDir1);\n+        try (MockedStatic<DocumentFile> dfMock = Mockito.mockStatic(DocumentFile.class)) {\n+            // mock external storage\n+            dfMock.when(() -> DocumentFile.fromTreeUri(any(), any())).thenReturn(documentFile1);\n+            Feed feed = new Feed(FEED_URL, null);\n+            LocalFeedUpdater.updateFeed(feed, context);\n+        }", "originalCommit": "214543f905879825dbf7f354b55224bb072b94a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE1MjI2NA==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4551#discussion_r511152264", "bodyText": "Do you mean to extract a helper method with just the following two lines?\nFeed feed = new Feed(FEED_URL, null);\nLocalFeedUpdater.updateFeed(feed, context);", "author": "damoasda", "createdAt": "2020-10-23T20:58:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc4ODg5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE2MTczMw==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4551#discussion_r511161733", "bodyText": "I meant the whole thing about mocking external storage and updating the feed. That looks pretty similar for all tests (I have only skimmed the code, though. Maybe I have overlooked something).\n\tDocumentFile documentFile = DocumentFile.fromFile(localFeedDir2);\n        try (MockedStatic<DocumentFile> dfMock = Mockito.mockStatic(DocumentFile.class)) {\n            // mock external storage\n            dfMock.when(() -> DocumentFile.fromTreeUri(any(), any())).thenReturn(documentFile);\n\n            // call method to test\n            Feed feed = new Feed(FEED_URL, null);\n            LocalFeedUpdater.updateFeed(feed, context);\n        }", "author": "ByteHamster", "createdAt": "2020-10-23T21:23:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc4ODg5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTM4MTgxMg==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4551#discussion_r511381812", "bodyText": "Ok, I see what you mean. I extracted repetitive code into helper methods, for mocking external storage as mentioned above, and also the checks for the number of feeds and the number of items in the feed. The test methods look very simple now.", "author": "damoasda", "createdAt": "2020-10-24T10:22:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc4ODg5NA=="}], "type": "inlineReview"}, {"oid": "c88f84ab77837cd592d40f103ba982e438c6da97", "url": "https://github.com/AntennaPod/AntennaPod/commit/c88f84ab77837cd592d40f103ba982e438c6da97", "message": "Add javax.inject dependency for unit tests", "committedDate": "2020-10-23T20:03:27Z", "type": "commit"}, {"oid": "c7dd98339d77a8ab3be76be3294f001a69b8b7a8", "url": "https://github.com/AntennaPod/AntennaPod/commit/c7dd98339d77a8ab3be76be3294f001a69b8b7a8", "message": "Add method PodDbAdapter.tearDownTests() to avoid hacky reflection code", "committedDate": "2020-10-24T09:44:32Z", "type": "commit"}, {"oid": "9e6049cfca0d2b1aefe2de280b035f9a44ba8640", "url": "https://github.com/AntennaPod/AntennaPod/commit/9e6049cfca0d2b1aefe2de280b035f9a44ba8640", "message": "Reduce repetitive code by helper methods", "committedDate": "2020-10-24T10:17:54Z", "type": "commit"}, {"oid": "5355fd55802ecea17b94ad8191c1b1cb84a7f60e", "url": "https://github.com/AntennaPod/AntennaPod/commit/5355fd55802ecea17b94ad8191c1b1cb84a7f60e", "message": "Move local feed media files from sampledata folder to test/assets folder", "committedDate": "2020-10-24T15:05:15Z", "type": "commit"}, {"oid": "bcbd54b73b64fc639dce6628c30041465267aec2", "url": "https://github.com/AntennaPod/AntennaPod/commit/bcbd54b73b64fc639dce6628c30041465267aec2", "message": "Move local feed media files from sampledata folder to test/assets folder", "committedDate": "2020-10-24T15:27:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ5OTc3Nw==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4551#discussion_r511499777", "bodyText": "Could you please move this to our own namespace, eg. de.danoeh.antennapod.core.storage? The only reason why we have some classes in foreign packages is that we implemented workarounds that require access to package-private members.", "author": "ByteHamster", "createdAt": "2020-10-24T18:21:25Z", "path": "core/src/test/java/androidx/documentfile/provider/AssetsDocumentFile.java", "diffHunk": "@@ -0,0 +1,142 @@\n+package androidx.documentfile.provider;", "originalCommit": "bcbd54b73b64fc639dce6628c30041465267aec2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTUwNzU4MQ==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4551#discussion_r511507581", "bodyText": "That's exactly the reason why I had to use that package: The constructor of the super class DocumentFile is package-accessible only. If you prefer, I can change back that part of the test code and use Mockito instead.", "author": "damoasda", "createdAt": "2020-10-24T19:45:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ5OTc3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTUxMjczOQ==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4551#discussion_r511512739", "bodyText": "\ud83d\udc4d I did not notice that the constructor is protected when having a quick look at the code. So let's keep it like it is :)", "author": "ByteHamster", "createdAt": "2020-10-24T20:47:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ5OTc3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ5OTg4OA==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4551#discussion_r511499888", "bodyText": "How about using MimeTypeMap.getMimeTypeFromExtension? That would work for more file types, just in case we used the class for more things later.", "author": "ByteHamster", "createdAt": "2020-10-24T18:22:52Z", "path": "core/src/test/java/androidx/documentfile/provider/AssetsDocumentFile.java", "diffHunk": "@@ -0,0 +1,142 @@\n+package androidx.documentfile.provider;\n+\n+import android.content.res.AssetManager;\n+import android.net.Uri;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+\n+import java.io.IOException;\n+\n+/**\n+ * <p>Wraps an Android assets file or folder as a DocumentFile object.</p>\n+ *\n+ * <p>This is used to emulate access to the external storage.</p>\n+ */\n+public class AssetsDocumentFile extends DocumentFile {\n+\n+    /**\n+     * Absolute file path in the assets folder.\n+     */\n+    @NonNull\n+    private final String fileName;\n+\n+    @NonNull\n+    private final AssetManager assetManager;\n+\n+    public AssetsDocumentFile(@NonNull String fileName, @NonNull AssetManager assetManager) {\n+        super(null);\n+        this.fileName = fileName;\n+        this.assetManager = assetManager;\n+    }\n+\n+    @Nullable\n+    @Override\n+    public DocumentFile createFile(@NonNull String mimeType, @NonNull String displayName) {\n+        return null;\n+    }\n+\n+    @Nullable\n+    @Override\n+    public DocumentFile createDirectory(@NonNull String displayName) {\n+        return null;\n+    }\n+\n+    @NonNull\n+    @Override\n+    public Uri getUri() {\n+        return Uri.parse(fileName);\n+    }\n+\n+    @Nullable\n+    @Override\n+    public String getName() {\n+        int pos = fileName.indexOf('/');\n+        if (pos >= 0) {\n+            return fileName.substring(pos + 1);\n+        } else {\n+            return fileName;\n+        }\n+    }\n+\n+    @Nullable\n+    @Override\n+    public String getType() {\n+        if (fileName.endsWith(\".mp3\")) {\n+            return \"audio/mp3\";\n+        } else if (fileName.endsWith(\".png\")) {\n+            return \"image/png\";", "originalCommit": "bcbd54b73b64fc639dce6628c30041465267aec2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTUxMDIyNA==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4551#discussion_r511510224", "bodyText": "Good point. I made the code more generic by using the suggested method.\nNote: When using Robolectric the class MimeTypeMap is replaced by the class ShadowMimeTypeMap that is empty by default. So I had to call the method addExtensionMimeTypMapping() to register the mp3 file extension. I already had that line of code, removed it, and now it is back again. \ud83d\ude01", "author": "damoasda", "createdAt": "2020-10-24T20:16:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ5OTg4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTUxMjk0NQ==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4551#discussion_r511512945", "bodyText": "Oh okay. As you can probably already tell, I have never worked with roboelectric before :) Your change looks good.", "author": "ByteHamster", "createdAt": "2020-10-24T20:49:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ5OTg4OA=="}], "type": "inlineReview"}, {"oid": "4b050b2429039aef5d756390f2e4a113023fa1df", "url": "https://github.com/AntennaPod/AntennaPod/commit/4b050b2429039aef5d756390f2e4a113023fa1df", "message": "Use MimeTypeMap.getMimeTypeFromExtension() to determine mime type", "committedDate": "2020-10-24T20:16:03Z", "type": "commit"}, {"oid": "7f38f9ba6111540eebc6643654ebc4c6aa9610a7", "url": "https://github.com/AntennaPod/AntennaPod/commit/7f38f9ba6111540eebc6643654ebc4c6aa9610a7", "message": "Do not mock SharedPreferences", "committedDate": "2020-10-24T20:52:09Z", "type": "commit"}]}