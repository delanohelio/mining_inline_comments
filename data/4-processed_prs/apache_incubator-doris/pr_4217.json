{"pr_number": 4217, "pr_title": "[Bug][Load][Json] #4124 Load json format with stream load failed", "pr_createdAt": "2020-07-30T09:47:58Z", "pr_url": "https://github.com/apache/incubator-doris/pull/4217", "timeline": [{"oid": "e2fcd027d43a006193fa0e3af023ca7c71fc7644", "url": "https://github.com/apache/incubator-doris/commit/e2fcd027d43a006193fa0e3af023ca7c71fc7644", "message": "first\n\nremove unused code\n\nsecond\n\nfix", "committedDate": "2020-07-30T02:49:16Z", "type": "commit"}, {"oid": "42caa860b63c4abb999a448d43c577176cf19ac5", "url": "https://github.com/apache/incubator-doris/commit/42caa860b63c4abb999a448d43c577176cf19ac5", "message": "remove fill tuple param", "committedDate": "2020-07-30T06:25:33Z", "type": "commit"}, {"oid": "74d170985d55940cfdd32fb3a68727993406bf4e", "url": "https://github.com/apache/incubator-doris/commit/74d170985d55940cfdd32fb3a68727993406bf4e", "message": "add doc", "committedDate": "2020-07-30T09:45:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM4OTk1NA==", "url": "https://github.com/apache/incubator-doris/pull/4217#discussion_r463389954", "bodyText": "a stream load can process 10G by default?", "author": "wuyunfeng", "createdAt": "2020-07-31T03:45:05Z", "path": "be/src/common/config.h", "diffHunk": "@@ -303,11 +303,14 @@ namespace config {\n     CONF_Int64(load_data_reserve_hours, \"4\");\n     // log error log will be removed after this time\n     CONF_mInt64(load_error_log_reserve_hours, \"48\");\n-    // Deprecated, use streaming_load_max_mb instead\n-    // CONF_Int64(mini_load_max_mb, \"2048\");\n     CONF_Int32(number_tablet_writer_threads, \"16\");\n \n+    // The maximum amount of data that can be processed by a stream load", "originalCommit": "74d170985d55940cfdd32fb3a68727993406bf4e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk0NzM4MQ==", "url": "https://github.com/apache/incubator-doris/pull/4217#discussion_r463947381", "bodyText": "Actually, this default value is too big for a stream load.\nBut I am not going to modify this to avoid some user troubles.", "author": "morningman", "createdAt": "2020-08-01T10:14:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM4OTk1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM5MDk4Mg==", "url": "https://github.com/apache/incubator-doris/pull/4217#discussion_r463390982", "bodyText": "the size of this batch exceed the max size of json type data\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            ss << \"body exceed max size of json format: \" << ctx->body_bytes << \", limit: \" << max_body_bytes;\n          \n          \n            \n                            ss << \"the size of this batch exceed the max size [\" << max_body_bytes << \"]  of json type data \" << \" data [ \" << ctx->body_bytes << \" ] \"\n          \n      \n    \n    \n  \n\nAnd I suggest you should truncate the logged body_bytes such as just show 1024 byte", "author": "wuyunfeng", "createdAt": "2020-07-31T03:50:06Z", "path": "be/src/http/action/stream_load.cpp", "diffHunk": "@@ -234,11 +234,19 @@ Status StreamLoadAction::_on_header(HttpRequest* http_req, StreamLoadContext* ct\n     } else {\n         ctx->format = parse_format(http_req->header(HTTP_FORMAT_KEY));\n         if (ctx->format == TFileFormatType::FORMAT_UNKNOWN) {\n-            LOG(WARNING) << \"unknown data format.\" << ctx->brief();\n             std::stringstream ss;\n             ss << \"unknown data format, format=\" << http_req->header(HTTP_FORMAT_KEY);\n             return Status::InternalError(ss.str());\n         }\n+\n+        size_t max_body_bytes = config::streaming_load_max_batch_size_mb * 1024 * 1024;\n+        if (ctx->format == TFileFormatType::FORMAT_JSON) {\n+            if (ctx->body_bytes > max_body_bytes) {\n+                std::stringstream ss;\n+                ss << \"body exceed max size of json format: \" << ctx->body_bytes << \", limit: \" << max_body_bytes;", "originalCommit": "74d170985d55940cfdd32fb3a68727993406bf4e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDA0MzM3Mg==", "url": "https://github.com/apache/incubator-doris/pull/4217#discussion_r464043372", "bodyText": "OK", "author": "morningman", "createdAt": "2020-08-02T07:24:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM5MDk4Mg=="}], "type": "inlineReview"}, {"oid": "d2d6cdfe36d4b0a7616b14a56d99f721c2b82eb0", "url": "https://github.com/apache/incubator-doris/commit/d2d6cdfe36d4b0a7616b14a56d99f721c2b82eb0", "message": "fix bug review", "committedDate": "2020-08-02T07:35:49Z", "type": "commit"}]}