{"pr_number": 3340, "pr_title": "[SegmentV2] Optimize the upgrade logic of SegmentV2", "pr_createdAt": "2020-04-17T03:43:56Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3340", "timeline": [{"oid": "52cfac8d74b5ab56ecef75c7b7ff3795d9158564", "url": "https://github.com/apache/incubator-doris/commit/52cfac8d74b5ab56ecef75c7b7ff3795d9158564", "message": "commit 1", "committedDate": "2020-04-17T03:25:00Z", "type": "commit"}, {"oid": "a6e041bb844589fe7abff040866ab5905034614d", "url": "https://github.com/apache/incubator-doris/commit/a6e041bb844589fe7abff040866ab5905034614d", "message": "3", "committedDate": "2020-04-17T03:25:49Z", "type": "commit"}, {"oid": "f84c52467bead0119e771fd91baa0c15911ab0b7", "url": "https://github.com/apache/incubator-doris/commit/f84c52467bead0119e771fd91baa0c15911ab0b7", "message": "4", "committedDate": "2020-04-17T03:25:49Z", "type": "commit"}, {"oid": "052e6d9ff3159295a87f1a39a6f376f6c1ab93a7", "url": "https://github.com/apache/incubator-doris/commit/052e6d9ff3159295a87f1a39a6f376f6c1ab93a7", "message": "fix ut", "committedDate": "2020-04-17T03:25:49Z", "type": "commit"}, {"oid": "f1771c46eed5bbd5ec3b79b29e018ea89b710cfd", "url": "https://github.com/apache/incubator-doris/commit/f1771c46eed5bbd5ec3b79b29e018ea89b710cfd", "message": "meta to 84", "committedDate": "2020-04-17T03:59:52Z", "type": "commit"}, {"oid": "f1771c46eed5bbd5ec3b79b29e018ea89b710cfd", "url": "https://github.com/apache/incubator-doris/commit/f1771c46eed5bbd5ec3b79b29e018ea89b710cfd", "message": "meta to 84", "committedDate": "2020-04-17T03:59:52Z", "type": "forcePushed"}, {"oid": "5c9414141c4fa289c5ba820bab49a4b27385946a", "url": "https://github.com/apache/incubator-doris/commit/5c9414141c4fa289c5ba820bab49a4b27385946a", "message": "remove info log", "committedDate": "2020-04-17T09:36:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDgwNTI3MQ==", "url": "https://github.com/apache/incubator-doris/pull/3340#discussion_r410805271", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \u672c\u6587\u6863\u4e3b\u8981\u4ecb\u7ecd\u4ece 0.11 \u7248\u672c\u5347\u7ea7\u81f3 0.12 \u7248\u672c\u540e\uff0c\u5982\u679c\u8f6c\u6362\u548c\u4f7f\u7528 V2 \u683c\u5f0f\u3002\n          \n          \n            \n            \u672c\u6587\u6863\u4e3b\u8981\u4ecb\u7ecd\u4ece 0.11 \u7248\u672c\u5347\u7ea7\u81f3 0.12 \u7248\u672c\u540e\uff0c\u5982\u4f55\u8f6c\u6362\u548c\u4f7f\u7528 V2 \u683c\u5f0f\u3002", "author": "morningman", "createdAt": "2020-04-19T03:40:02Z", "path": "docs/documentation/cn/administrator-guide/segment-v2-usage.md", "diffHunk": "@@ -1,118 +1,128 @@\n-# Doris Segment V2\u4e0a\u7ebf\u548c\u8bd5\u7528\u624b\u518c\n+# Segment V2 \u5347\u7ea7\u624b\u518c\n \n ## \u80cc\u666f\n \n-Doris 0.12\u7248\u672c\u4e2d\u5b9e\u73b0\u4e86segment v2\uff08\u65b0\u7684\u5b58\u50a8\u683c\u5f0f\uff09\uff0c\u5f15\u5165\u8bcd\u5178\u538b\u7f29\u3001bitmap\u7d22\u5f15\u3001page cache\u7b49\u4f18\u5316\uff0c\u80fd\u591f\u63d0\u5347\u7cfb\u7edf\u6027\u80fd\u3002\u76ee\u524d0.12\u7248\u672c\u5df2\u7ecf\u53d1\u5e03alpha\u7248\u672c\uff0c\u6b63\u5728\u5185\u90e8\u4e0a\u7ebf\u8fc7\u7a0b\u4e2d\uff0c\u4e0a\u7ebf\u7684\u65b9\u6848\u548c\u8bd5\u7528\u65b9\u6cd5\u8bb0\u5f55\u5982\u4e0b\n+Doris 0.12 \u7248\u672c\u4e2d\u5b9e\u73b0\u4e86\u65b0\u7684\u5b58\u50a8\u683c\u5f0f\uff1aSegment v2\uff0c\u5f15\u5165\u8bcd\u5178\u538b\u7f29\u3001bitmap\u7d22\u5f15\u3001page cache\u7b49\u4f18\u5316\uff0c\u80fd\u591f\u63d0\u5347\u7cfb\u7edf\u6027\u80fd\u3002\n+\n+0.12 \u7248\u672c\u4f1a\u540c\u65f6\u652f\u6301\u8bfb\u5199\u539f\u6709\u7684 Segment V1\uff08\u4ee5\u4e0b\u7b80\u79f0V1\uff09 \u548c\u65b0\u7684 Segment V2\uff08\u4ee5\u4e0b\u7b80\u79f0V2\uff09 \u4e24\u79cd\u683c\u5f0f\u3002\u5982\u679c\u539f\u6709\u6570\u636e\u60f3\u4f7f\u7528 V2 \u76f8\u5173\u7279\u6027\uff0c\u9700\u901a\u8fc7\u547d\u4ee4\u5c06 V1 \u8f6c\u6362\u6210 V2 \u683c\u5f0f\u3002\n+\n+\u672c\u6587\u6863\u4e3b\u8981\u4ecb\u7ecd\u4ece 0.11 \u7248\u672c\u5347\u7ea7\u81f3 0.12 \u7248\u672c\u540e\uff0c\u5982\u679c\u8f6c\u6362\u548c\u4f7f\u7528 V2 \u683c\u5f0f\u3002", "originalCommit": "5c9414141c4fa289c5ba820bab49a4b27385946a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c9db08a93b1c1917c12af743a1dd75068669d89a", "url": "https://github.com/apache/incubator-doris/commit/c9db08a93b1c1917c12af743a1dd75068669d89a", "message": "Update docs/documentation/cn/administrator-guide/segment-v2-usage.md", "committedDate": "2020-04-19T03:41:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI5NzI5MQ==", "url": "https://github.com/apache/incubator-doris/pull/3340#discussion_r411297291", "bodyText": "Please add the license firstly", "author": "EmmyMiao87", "createdAt": "2020-04-20T11:19:52Z", "path": "docs/documentation/cn/administrator-guide/segment-v2-usage.md", "diffHunk": "@@ -1,118 +1,128 @@\n-# Doris Segment V2\u4e0a\u7ebf\u548c\u8bd5\u7528\u624b\u518c", "originalCommit": "c9db08a93b1c1917c12af743a1dd75068669d89a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM4Njg3Mg==", "url": "https://github.com/apache/incubator-doris/pull/3340#discussion_r411386872", "bodyText": "ok", "author": "morningman", "createdAt": "2020-04-20T13:42:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI5NzI5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI5NzY2OQ==", "url": "https://github.com/apache/incubator-doris/pull/3340#discussion_r411297669", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Doris 0.12 \u7248\u672c\u4e2d\u5b9e\u73b0\u4e86\u65b0\u7684\u5b58\u50a8\u683c\u5f0f\uff1aSegment v2\uff0c\u5f15\u5165\u8bcd\u5178\u538b\u7f29\u3001bitmap\u7d22\u5f15\u3001page cache\u7b49\u4f18\u5316\uff0c\u80fd\u591f\u63d0\u5347\u7cfb\u7edf\u6027\u80fd\u3002\n          \n          \n            \n            Doris 0.12 \u7248\u672c\u4e2d\u5b9e\u73b0\u4e86\u65b0\u7684\u5b58\u50a8\u683c\u5f0f\uff1aSegment V2\uff0c\u5f15\u5165\u8bcd\u5178\u538b\u7f29\u3001bitmap\u7d22\u5f15\u3001page cache\u7b49\u4f18\u5316\uff0c\u80fd\u591f\u63d0\u5347\u7cfb\u7edf\u6027\u80fd\u3002", "author": "EmmyMiao87", "createdAt": "2020-04-20T11:20:29Z", "path": "docs/documentation/cn/administrator-guide/segment-v2-usage.md", "diffHunk": "@@ -1,118 +1,128 @@\n-# Doris Segment V2\u4e0a\u7ebf\u548c\u8bd5\u7528\u624b\u518c\n+# Segment V2 \u5347\u7ea7\u624b\u518c\n \n ## \u80cc\u666f\n \n-Doris 0.12\u7248\u672c\u4e2d\u5b9e\u73b0\u4e86segment v2\uff08\u65b0\u7684\u5b58\u50a8\u683c\u5f0f\uff09\uff0c\u5f15\u5165\u8bcd\u5178\u538b\u7f29\u3001bitmap\u7d22\u5f15\u3001page cache\u7b49\u4f18\u5316\uff0c\u80fd\u591f\u63d0\u5347\u7cfb\u7edf\u6027\u80fd\u3002\u76ee\u524d0.12\u7248\u672c\u5df2\u7ecf\u53d1\u5e03alpha\u7248\u672c\uff0c\u6b63\u5728\u5185\u90e8\u4e0a\u7ebf\u8fc7\u7a0b\u4e2d\uff0c\u4e0a\u7ebf\u7684\u65b9\u6848\u548c\u8bd5\u7528\u65b9\u6cd5\u8bb0\u5f55\u5982\u4e0b\n+Doris 0.12 \u7248\u672c\u4e2d\u5b9e\u73b0\u4e86\u65b0\u7684\u5b58\u50a8\u683c\u5f0f\uff1aSegment v2\uff0c\u5f15\u5165\u8bcd\u5178\u538b\u7f29\u3001bitmap\u7d22\u5f15\u3001page cache\u7b49\u4f18\u5316\uff0c\u80fd\u591f\u63d0\u5347\u7cfb\u7edf\u6027\u80fd\u3002", "originalCommit": "c9db08a93b1c1917c12af743a1dd75068669d89a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI5OTIxNA==", "url": "https://github.com/apache/incubator-doris/pull/3340#discussion_r411299214", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                `use_v2_rollup` \u8fd9\u4e2a\u53d8\u91cf\u4f1a\u5f3a\u5236\u67e5\u8be2\u540d\u4e3a `__v2_table_name` \u7684 Rollup\uff0c\u5e76\u4e14\u4e0d\u4f1a\u8003\u8651\u5176\u4ed6 rollup \u7684\u547d\u4e2d\u6761\u4ef6\u3002\u6240\u4ee5\u8be5\u53c2\u6570\u4ec5\u7528\u4e8e\u5bf9 V2 \u683c\u5f0f\u6570\u636e\u8fdb\u884c\u9a8c\u8bc1\u3002\n          \n          \n            \n                `use_v2_rollup` \u8fd9\u4e2a\u53d8\u91cf\u4f1a\u5f3a\u5236\u67e5\u8be2\u540d\u4e3a `__v2_table_name` \u7684 Rollup\uff0c\u5e76\u4e14\u4e0d\u4f1a\u8003\u8651\u5176\u4ed6 Rollup \u7684\u547d\u4e2d\u6761\u4ef6\u3002\u6240\u4ee5\u8be5\u53c2\u6570\u4ec5\u7528\u4e8e\u5bf9 V2 \u683c\u5f0f\u6570\u636e\u8fdb\u884c\u9a8c\u8bc1\u3002", "author": "EmmyMiao87", "createdAt": "2020-04-20T11:23:17Z", "path": "docs/documentation/cn/administrator-guide/segment-v2-usage.md", "diffHunk": "@@ -1,118 +1,128 @@\n-# Doris Segment V2\u4e0a\u7ebf\u548c\u8bd5\u7528\u624b\u518c\n+# Segment V2 \u5347\u7ea7\u624b\u518c\n \n ## \u80cc\u666f\n \n-Doris 0.12\u7248\u672c\u4e2d\u5b9e\u73b0\u4e86segment v2\uff08\u65b0\u7684\u5b58\u50a8\u683c\u5f0f\uff09\uff0c\u5f15\u5165\u8bcd\u5178\u538b\u7f29\u3001bitmap\u7d22\u5f15\u3001page cache\u7b49\u4f18\u5316\uff0c\u80fd\u591f\u63d0\u5347\u7cfb\u7edf\u6027\u80fd\u3002\u76ee\u524d0.12\u7248\u672c\u5df2\u7ecf\u53d1\u5e03alpha\u7248\u672c\uff0c\u6b63\u5728\u5185\u90e8\u4e0a\u7ebf\u8fc7\u7a0b\u4e2d\uff0c\u4e0a\u7ebf\u7684\u65b9\u6848\u548c\u8bd5\u7528\u65b9\u6cd5\u8bb0\u5f55\u5982\u4e0b\n+Doris 0.12 \u7248\u672c\u4e2d\u5b9e\u73b0\u4e86\u65b0\u7684\u5b58\u50a8\u683c\u5f0f\uff1aSegment v2\uff0c\u5f15\u5165\u8bcd\u5178\u538b\u7f29\u3001bitmap\u7d22\u5f15\u3001page cache\u7b49\u4f18\u5316\uff0c\u80fd\u591f\u63d0\u5347\u7cfb\u7edf\u6027\u80fd\u3002\n+\n+0.12 \u7248\u672c\u4f1a\u540c\u65f6\u652f\u6301\u8bfb\u5199\u539f\u6709\u7684 Segment V1\uff08\u4ee5\u4e0b\u7b80\u79f0V1\uff09 \u548c\u65b0\u7684 Segment V2\uff08\u4ee5\u4e0b\u7b80\u79f0V2\uff09 \u4e24\u79cd\u683c\u5f0f\u3002\u5982\u679c\u539f\u6709\u6570\u636e\u60f3\u4f7f\u7528 V2 \u76f8\u5173\u7279\u6027\uff0c\u9700\u901a\u8fc7\u547d\u4ee4\u5c06 V1 \u8f6c\u6362\u6210 V2 \u683c\u5f0f\u3002\n+\n+\u672c\u6587\u6863\u4e3b\u8981\u4ecb\u7ecd\u4ece 0.11 \u7248\u672c\u5347\u7ea7\u81f3 0.12 \u7248\u672c\u540e\uff0c\u5982\u4f55\u8f6c\u6362\u548c\u4f7f\u7528 V2 \u683c\u5f0f\u3002\n \n-## \u4e0a\u7ebf\n+V2 \u683c\u5f0f\u7684\u8868\u53ef\u4ee5\u652f\u6301\u4ee5\u4e0b\u65b0\u7684\u7279\u6027\uff1a\n \n-\u4e3a\u4e86\u4fdd\u8bc1\u4e0a\u7ebf\u7684\u7a33\u5b9a\u6027\uff0c\u4e0a\u7ebf\u5206\u4e3a\u4e09\u4e2a\u9636\u6bb5\uff1a\n-\u7b2c\u4e00\u4e2a\u9636\u6bb5\u662f\u4e0a\u7ebf0.12\u7248\u672c\uff0c\u4f46\u662f\u4e0d\u5168\u91cf\u5f00\u542fsegment v2\u7684\u529f\u80fd\uff0c\u53ea\u5728\u9a8c\u8bc1\u7684\u65f6\u5019\uff0c\u521b\u5efasegment v2\u7684\u8868\uff08\u6216\u8005\u7d22\u5f15\uff09\n-\u7b2c\u4e8c\u4e2a\u9636\u6bb5\u662f\u5168\u91cf\u5f00\u542fsegment v2\u7684\u529f\u80fd\uff0c\u66ff\u6362\u73b0\u6709\u7684segment\u5b58\u50a8\u683c\u5f0f\uff0c\u8fd9\u6837\u5bf9\u65b0\u8868\u4f1a\u521b\u5efasegment v2\u7684\u683c\u5f0f\u7684\u5b58\u50a8\u6587\u4ef6\uff0c\u4f46\u662f\u5bf9\u4e8e\u65e7\u8868\uff0c\u9700\u8981\u4f9d\u8d56\u4e8ecompaction\u548cschema change\u7b49\u8fc7\u7a0b\uff0c\u5b9e\u73b0\u683c\u5f0f\u7684\u8f6c\u5316\n-\u7b2c\u4e09\u4e2a\u9636\u6bb5\u5c31\u662f\u8f6c\u5316\u65e7\u7684segment\u683c\u5f0f\u5230\u65b0\u7684segment v2\u7684\u683c\u5f0f\uff0c\u8fd9\u4e2a\u9700\u8981\u5728\u9a8c\u8bc1segment v2\u7684\u6b63\u786e\u6027\u548c\u6027\u80fd\u6ca1\u6709\u95ee\u9898\u4e4b\u540e\uff0c\u53ef\u4ee5\u6309\u7167\u7528\u6237\u610f\u613f\u9010\u6b65\u5b8c\u6210\u3002\n+1. bitmap \u7d22\u5f15\n+2. \u5185\u5b58\u8868\n+3. page cache\n+4. \u5b57\u5178\u538b\u7f29\n+5. \u5ef6\u8fdf\u7269\u5316\uff08Lazy materialization\uff09\n \n-### \u4e0a\u7ebf\u9a8c\u8bc1\n+## \u96c6\u7fa4\u5347\u7ea7\n \n-- \u6b63\u786e\u6027\n+0.12 \u7248\u672c\u4ec5\u652f\u6301\u4ece 0.11 \u7248\u672c\u5347\u7ea7\uff0c\u4e0d\u652f\u6301\u4ece 0.11 \u4e4b\u524d\u7684\u7248\u672c\u5347\u7ea7\u3002\u8bf7\u5148\u786e\u4fdd\u5347\u7ea7\u7684\u524d\u7684 Doris \u96c6\u7fa4\u7248\u672c\u4e3a 0.11\u3002\n \n-\u6b63\u786e\u6027\u662fsegment v2\u4e0a\u7ebf\u6700\u9700\u8981\u4fdd\u8bc1\u7684\u6307\u6807\u3002 \u5728\u7b2c\u4e00\u9636\u6bb5\uff0c\u4e3a\u4e86\u4fdd\u8bc1\u7ebf\u4e0a\u73af\u5883\u7684\u7a33\u5b9a\u6027\uff0c\u5e76\u4e14\u9a8c\u8bc1segment v2\u7684\u6b63\u786e\u6027\uff0c\u91c7\u7528\u5982\u4e0b\u7684\u65b9\u6848\uff1a\n-1. \u9009\u62e9\u51e0\u4e2a\u9700\u8981\u9a8c\u8bc1\u7684\u8868\uff0c\u4f7f\u7528\u4ee5\u4e0b\u8bed\u53e5\uff0c\u521b\u5efasegment v2\u683c\u5f0f\u7684rollup\u8868\uff0c\u8be5rollup\u8868\u4e0ebase\u8868\u7684schema\u76f8\u540c\n+0.12 \u7248\u672c\u6709\u4e24\u4e2a V2 \u76f8\u5173\u7684\u91cd\u8981\u53c2\u6570\uff1a\n \n-\talter table table_name add rollup table_name (columns) properties (\"storage_format\" = \"v2\");\n+* `default_rowset_type`\uff1aFE \u4e00\u4e2a\u5168\u5c40\u53d8\u91cf\uff08Global Variable\uff09\u8bbe\u7f6e\uff0c\u9ed8\u8ba4\u4e3a \"alpha\"\uff0c\u5373 V1 \u7248\u672c\u3002\n+* `default_rowset_type`\uff1aBE \u7684\u4e00\u4e2a\u914d\u7f6e\u9879\uff0c\u9ed8\u8ba4\u4e3a \"ALPHA\"\uff0c\u5373 V1 \u7248\u672c\u3002\n \n-\t\u5176\u4e2d\uff0c\n-\trollup\u540e\u9762\u7684index\u540d\u5b57\u76f4\u63a5\u6307\u5b9a\u4e3abase table\u7684table name\uff0c\u8be5\u8bed\u53e5\u4f1a\u81ea\u52a8\u751f\u6210\u4e00\u4e2a__v2_table_name\u3002\n+\u4fdd\u6301\u4e0a\u8ff0\u914d\u7f6e\u9ed8\u8ba4\u7684\u8bdd\uff0c\u6309\u5e38\u89c4\u6b65\u9aa4\u5bf9\u96c6\u7fa4\u5347\u7ea7\u540e\uff0c\u539f\u6709\u96c6\u7fa4\u6570\u636e\u7684\u5b58\u50a8\u683c\u5f0f\u4e0d\u4f1a\u53d8\u66f4\uff0c\u5373\u4f9d\u7136\u4e3a V1 \u683c\u5f0f\u3002\u5982\u679c\u5bf9 V2 \u683c\u5f0f\u6ca1\u6709\u9700\u6c42\uff0c\u5219\u7ee7\u7eed\u6b63\u5e38\u4f7f\u7528\u96c6\u7fa4\u5373\u53ef\uff0c\u65e0\u9700\u505a\u4efb\u4f55\u989d\u5916\u64cd\u4f5c\u3002\u6240\u6709\u539f\u6709\u6570\u636e\u3001\u4ee5\u53ca\u65b0\u5bfc\u5165\u7684\u6570\u636e\uff0c\u90fd\u4f9d\u7136\u662f V1 \u7248\u672c\u3002\n \n-\tcolumns\u53ef\u4ee5\u968f\u4fbf\u6307\u5b9a\u4e00\u4e2a\u5217\u540d\u5373\u53ef\uff0c\u8fd9\u91cc\u4e00\u65b9\u9762\u662f\u4e3a\u4e86\u517c\u5bb9\u73b0\u6709\u7684\u8bed\u6cd5\uff0c\u4e00\u65b9\u9762\u662f\u4e3a\u4e86\u65b9\u4fbf\u3002\n+## V2 \u683c\u5f0f\u8f6c\u6362\n \n-2. \u4e0a\u9762\u7684\u521b\u5efa\u51fa\u6765\u7684rollup index\u540d\u5b57\u683c\u5f0f\u7c7b\u4f3c\uff1a__v2_table_name\n+### \u5df2\u6709\u8868\u6570\u636e\u8f6c\u6362\u6210 V2\n \n-\t\u901a\u8fc7\u547d\u4ee4 :\n+\u5bf9\u4e8e\u5df2\u6709\u8868\u6570\u636e\u7684\u683c\u5f0f\u8f6c\u6362\uff0cDoris \u63d0\u4f9b\u4e24\u79cd\u65b9\u5f0f\uff1a\n \n-\t`desc table_name all;`\n+1. \u521b\u5efa\u4e00\u4e2a V2 \u683c\u5f0f\u7684\u7279\u6b8a Rollup\n \n-\t\u67e5\u770btable\u4e2d\u662f\u5426\u5b58\u5728\u540d\u5b57\uff1a__v2_table_name\u7684rollup\u3002\u7531\u4e8e\u521b\u5efasegment v2\u7684rollup\u8868\u662f\u4e00\u4e2a\u5f02\u6b65\u64cd\u4f5c\uff0c\u6240\u4ee5\u5e76\u4e0d\u4f1a\u7acb\u5373\u6210\u529f\u3002\u5982\u679c\u4e0a\u9762\u547d\u4ee4\u4e2d\u5e76\u6ca1\u6709\u663e\u793a\u65b0\u521b\u5efa\u7684 rollup\uff0c\u53ef\u80fd\u662f\u8fd8\u5728\u521b\u5efa\u8fc7\u7a0b\u4e2d\u3002\n+    \u8be5\u65b9\u5f0f\u4f1a\u9488\u5bf9\u6307\u5b9a\u8868\uff0c\u521b\u5efa\u4e00\u4e2a V2 \u683c\u5f0f\u7684\u7279\u6b8a Rollup\u3002\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u65b0\u7684 V2 \u683c\u5f0f\u7684 Rollup \u4f1a\u548c\u539f\u6709\u8868\u683c\u5f0f\u6570\u636e\u5e76\u5b58\u3002\u7528\u6237\u53ef\u4ee5\u6307\u5b9a\u5bf9 V2 \u683c\u5f0f\u7684 Rollup \u8fdb\u884c\u67e5\u8be2\u9a8c\u8bc1\u3002\n+    \n+    \u8be5\u65b9\u5f0f\u4e3b\u8981\u7528\u4e8e\u5bf9 V2 \u683c\u5f0f\u7684\u9a8c\u8bc1\uff0c\u56e0\u4e3a\u4e0d\u4f1a\u4fee\u6539\u539f\u6709\u8868\u6570\u636e\uff0c\u56e0\u6b64\u53ef\u4ee5\u5b89\u5168\u7684\u8fdb\u884c V2 \u683c\u5f0f\u7684\u6570\u636e\u9a8c\u8bc1\uff0c\u800c\u4e0d\u7528\u62c5\u5fc3\u8868\u6570\u636e\u56e0\u683c\u5f0f\u8f6c\u6362\u800c\u635f\u574f\u3002\u901a\u5e38\u5148\u4f7f\u7528\u8fd9\u4e2a\u65b9\u5f0f\u5bf9\u6570\u636e\u8fdb\u884c\u6821\u9a8c\uff0c\u4e4b\u540e\u518d\u4f7f\u7528\u65b9\u6cd52\u5bf9\u6574\u4e2a\u8868\u8fdb\u884c\u6570\u636e\u683c\u5f0f\u8f6c\u6362\u3002\n+    \n+    \u64cd\u4f5c\u6b65\u9aa4\u5982\u4e0b\uff1a\n+    \n+    ```\n+    ## \u521b\u5efa V2 \u683c\u5f0f\u7684 ROLLUP\n+    \n+    ALTER TABLE table_name ADD ROLLUP table_name (columns) PROPERTIES (\"storage_format\" = \"v2\");\n+    ```\n \n-    \u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u547d\u4ee4\u67e5\u770b\u6b63\u5728\u8fdb\u884c\u7684 rollup \u8868\u3002\n+    \u5176\u4e2d\uff0c Rollup \u7684\u540d\u79f0\u5fc5\u987b\u4e3a\u8868\u540d\u3002columns \u5b57\u6bb5\u53ef\u4ee5\u4efb\u610f\u586b\u5199\uff0c\u7cfb\u7edf\u4e0d\u4f1a\u68c0\u67e5\u8be5\u5b57\u6bb5\u7684\u5408\u6cd5\u6027\u3002\u8be5\u8bed\u53e5\u4f1a\u81ea\u52a8\u751f\u6210\u4e00\u4e2a\u540d\u4e3a `__v2_table_name` \u7684 Rollup\uff0c\u5e76\u4e14\u8be5 Rollup \u5217\u5305\u542b\u8868\u7684\u5168\u90e8\u5217\u3002\n+    \n+    \u901a\u8fc7\u4ee5\u4e0b\u8bed\u53e5\u67e5\u770b\u521b\u5efa\u8fdb\u5ea6\uff1a\n+    \n+    ```\n+    SHOW ALTER TABLE ROLLUP;\n+    ```\n+    \n+    \u521b\u5efa\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u901a\u8fc7 `DESC table_name ALL;` \u67e5\u770b\u5230\u540d\u4e3a `__v2_table_name` \u7684 Rollup\u3002\n+    \n+    \u4e4b\u540e\uff0c\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\uff0c\u5207\u6362\u5230 V2 \u683c\u5f0f\u67e5\u8be2\uff1a\n \n-\t`show alter table rollup;`\n+    ```\n+    set use_v2_rollup = true;\n+    select * from table_name limit 10;\n+    ```\n+    \n+    `use_v2_rollup` \u8fd9\u4e2a\u53d8\u91cf\u4f1a\u5f3a\u5236\u67e5\u8be2\u540d\u4e3a `__v2_table_name` \u7684 Rollup\uff0c\u5e76\u4e14\u4e0d\u4f1a\u8003\u8651\u5176\u4ed6 rollup \u7684\u547d\u4e2d\u6761\u4ef6\u3002\u6240\u4ee5\u8be5\u53c2\u6570\u4ec5\u7528\u4e8e\u5bf9 V2 \u683c\u5f0f\u6570\u636e\u8fdb\u884c\u9a8c\u8bc1\u3002", "originalCommit": "c9db08a93b1c1917c12af743a1dd75068669d89a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMwMDYxNQ==", "url": "https://github.com/apache/incubator-doris/pull/3340#discussion_r411300615", "bodyText": "If the storage format is already V2,  will Doris forbidden the schema change job", "author": "EmmyMiao87", "createdAt": "2020-04-20T11:25:50Z", "path": "fe/src/main/java/org/apache/doris/alter/SchemaChangeHandler.java", "diffHunk": "@@ -944,7 +945,9 @@ private void createJob(long dbId, OlapTable olapTable, Map<Long, LinkedList<Colu\n             } else if (hasIndexChange) {\n                 needAlter = true;\n             } else if (storageFormat == TStorageFormat.V2) {\n-                needAlter = true;\n+                if (olapTable.getTableProperty().getStorageFormat() != TStorageFormat.V2) {", "originalCommit": "c9db08a93b1c1917c12af743a1dd75068669d89a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM4NzU1NQ==", "url": "https://github.com/apache/incubator-doris/pull/3340#discussion_r411387555", "bodyText": "Yes, if storage format is already V2, needAlter will remain false, and nothing will be done.", "author": "morningman", "createdAt": "2020-04-20T13:43:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMwMDYxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMzMjYyMg==", "url": "https://github.com/apache/incubator-doris/pull/3340#discussion_r411332622", "bodyText": "If user set 'use v2 rollup', the best rollup will not be selected?", "author": "EmmyMiao87", "createdAt": "2020-04-20T12:21:49Z", "path": "fe/src/main/java/org/apache/doris/planner/MaterializedViewSelector.java", "diffHunk": "@@ -109,9 +109,22 @@ public BestIndexInfo selectBestMV(ScanNode scanNode) throws UserException {\n         long start = System.currentTimeMillis();\n         Preconditions.checkState(scanNode instanceof OlapScanNode);\n         OlapScanNode olapScanNode = (OlapScanNode) scanNode;\n+\n+        ConnectContext connectContext = ConnectContext.get();\n+        if (connectContext != null && connectContext.getSessionVariable().isUseV2Rollup()) {", "originalCommit": "c9db08a93b1c1917c12af743a1dd75068669d89a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM4Nzg2NA==", "url": "https://github.com/apache/incubator-doris/pull/3340#discussion_r411387864", "bodyText": "Yes, if 'use v2 rollup' is true, only base index will be selected", "author": "morningman", "createdAt": "2020-04-20T13:43:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMzMjYyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMzNTAyOA==", "url": "https://github.com/apache/incubator-doris/pull/3340#discussion_r411335028", "bodyText": "Maybe We should check the candidate index firstly and choose the best rollup in priorities.", "author": "EmmyMiao87", "createdAt": "2020-04-20T12:25:50Z", "path": "fe/src/main/java/org/apache/doris/planner/MaterializedViewSelector.java", "diffHunk": "@@ -109,9 +109,22 @@ public BestIndexInfo selectBestMV(ScanNode scanNode) throws UserException {\n         long start = System.currentTimeMillis();\n         Preconditions.checkState(scanNode instanceof OlapScanNode);\n         OlapScanNode olapScanNode = (OlapScanNode) scanNode;\n+\n+        ConnectContext connectContext = ConnectContext.get();\n+        if (connectContext != null && connectContext.getSessionVariable().isUseV2Rollup()) {\n+            // if user set `use_v2_rollup` variable to true, and there is a segment v2 rollup,\n+            // just return the segment v2 rollup, because user want to check the v2 format data.\n+            OlapTable tbl = olapScanNode.getOlapTable();\n+            String v2RollupIndexName = MaterializedViewHandler.NEW_STORAGE_FORMAT_INDEX_NAME_PREFIX + tbl.getName();\n+            Long v2RollupIndexId = tbl.getIndexIdByName(v2RollupIndexName);\n+            if (v2RollupIndexId != null) {\n+                return new BestIndexInfo(v2RollupIndexId, false, \"use_v2_rollup is true\");\n+            }\n+        }\n+\n         Map<Long, List<Column>> candidateIndexIdToSchema = predicates(olapScanNode);\n         long bestIndexId = priorities(olapScanNode, candidateIndexIdToSchema);", "originalCommit": "c9db08a93b1c1917c12af743a1dd75068669d89a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2e578da1ba619fbb1faec78d0f70505a9bdcb497", "url": "https://github.com/apache/incubator-doris/commit/2e578da1ba619fbb1faec78d0f70505a9bdcb497", "message": "fix review", "committedDate": "2020-04-20T13:46:55Z", "type": "commit"}, {"oid": "c80bb4499bbfdbd9ef961a29e54875443cd00ddc", "url": "https://github.com/apache/incubator-doris/commit/c80bb4499bbfdbd9ef961a29e54875443cd00ddc", "message": "fix code style", "committedDate": "2020-04-20T13:47:42Z", "type": "commit"}, {"oid": "42f2fc3d57a98fc27e4ae35cd6d5b879c6c806fc", "url": "https://github.com/apache/incubator-doris/commit/42f2fc3d57a98fc27e4ae35cd6d5b879c6c806fc", "message": "fix by review2", "committedDate": "2020-04-21T02:24:09Z", "type": "commit"}, {"oid": "1110f64a8ca0f3fb5ad00778e4b5289a9238e2d5", "url": "https://github.com/apache/incubator-doris/commit/1110f64a8ca0f3fb5ad00778e4b5289a9238e2d5", "message": "fix by review 3", "committedDate": "2020-04-21T02:39:33Z", "type": "commit"}]}