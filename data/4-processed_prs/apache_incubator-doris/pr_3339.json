{"pr_number": 3339, "pr_title": "[tablet] A small refactor on class Tablet", "pr_createdAt": "2020-04-17T03:04:53Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3339", "timeline": [{"oid": "12df4c17f427efe51517a7a65c58c0c0a75dc5c7", "url": "https://github.com/apache/incubator-doris/commit/12df4c17f427efe51517a7a65c58c0c0a75dc5c7", "message": "[tablet] A small refactor on class Tablet\n\nThere is no functional changes in this patch.\nKey refactor points are:\n- Remove meaningless return value of functions in class Tablet, and\n  also some related functions in other classes\n- Allow RowsetGraph::capture_consistent_versions to pass a nullptr\n  to the output parameter\n- Use CHECK instead of LOG(FATAL) to simplify code", "committedDate": "2020-04-17T02:55:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4MTk2MA==", "url": "https://github.com/apache/incubator-doris/pull/3339#discussion_r409981960", "bodyText": "CHECK_EQ takes no effect on release version.", "author": "chaoyli", "createdAt": "2020-04-17T04:10:58Z", "path": "be/src/olap/tablet.cpp", "diffHunk": "@@ -135,16 +130,12 @@ OLAPStatus Tablet::set_tablet_state(TabletState state) {\n \n // should save tablet meta to remote meta store\n // if it's a primary replica\n-OLAPStatus Tablet::save_meta() {\n-    OLAPStatus res = _tablet_meta->save_meta(_data_dir);\n-    if (res != OLAP_SUCCESS) {\n-       LOG(FATAL) << \"fail to save tablet_meta. res=\" << res << \", root=\" << _data_dir->path();\n-    }\n+void Tablet::save_meta() {\n+    auto res = _tablet_meta->save_meta(_data_dir);\n+    CHECK_EQ(res, OLAP_SUCCESS) << \"fail to save tablet_meta. res=\" << res << \", root=\" << _data_dir->path();", "originalCommit": "12df4c17f427efe51517a7a65c58c0c0a75dc5c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk5MzAxNA==", "url": "https://github.com/apache/incubator-doris/pull/3339#discussion_r409993014", "bodyText": "CHECK_EQ takes no effect on release version.\n\nDo you mean DCHECK_EQ takes no effect on release version?", "author": "acelyc111", "createdAt": "2020-04-17T04:58:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4MTk2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYxODMyMg==", "url": "https://github.com/apache/incubator-doris/pull/3339#discussion_r412618322", "bodyText": "Yes, It has no effect.", "author": "chaoyli", "createdAt": "2020-04-22T02:15:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4MTk2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjY3MDgzNw==", "url": "https://github.com/apache/incubator-doris/pull/3339#discussion_r412670837", "bodyText": "DCHECK_EQ has no effect, but here is CHECK_EQ  which has effect in release mode.", "author": "acelyc111", "createdAt": "2020-04-22T05:00:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4MTk2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4NTU1NA==", "url": "https://github.com/apache/incubator-doris/pull/3339#discussion_r409985554", "bodyText": "I think should not coupling outside VersionPath empty logic in this function.", "author": "chaoyli", "createdAt": "2020-04-17T04:26:35Z", "path": "be/src/olap/rowset_graph.cpp", "diffHunk": "@@ -237,25 +232,26 @@ OLAPStatus RowsetGraph::capture_consistent_versions(const Version& spec_version,\n         reversed_path.push_back(tmp_vertex_index);\n     }\n \n-    // Make version_path from reversed_path.\n-    std::stringstream shortest_path_for_debug;\n-    for (size_t path_id = reversed_path.size() - 1; path_id > 0; --path_id) {\n-        int64_t tmp_start_vertex_value = _version_graph[reversed_path[path_id]].value;\n-        int64_t tmp_end_vertex_value = _version_graph[reversed_path[path_id - 1]].value;\n-\n-        // tmp_start_vertex_value mustn't be equal to tmp_end_vertex_value\n-        if (tmp_start_vertex_value <= tmp_end_vertex_value) {\n-            version_path->emplace_back(tmp_start_vertex_value, tmp_end_vertex_value - 1);\n-        } else {\n-            version_path->emplace_back(tmp_end_vertex_value, tmp_start_vertex_value - 1);\n-        }\n+    if (version_path != nullptr) {", "originalCommit": "12df4c17f427efe51517a7a65c58c0c0a75dc5c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk5NzUzMA==", "url": "https://github.com/apache/incubator-doris/pull/3339#discussion_r409997530", "bodyText": "I found RowsetGraph::capture_consistent_versions is now only called by Tablet::capture_consistent_versions, the latter is now called by two purposes. First, check version integrity, second, check version integrity and then capture versions when check success. For the first purpose, it's not needed to construct and fill a output parameter. Of course the function name capture_consistent_versions  maybe not accuracy in this case.", "author": "acelyc111", "createdAt": "2020-04-17T05:18:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4NTU1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYyMjA1NQ==", "url": "https://github.com/apache/incubator-doris/pull/3339#discussion_r412622055", "bodyText": "I think there is no necessity for capture_consistent_versions() judge version_path is nullptr or not.\nSo you can DCHECK(version_path != nullptr) instead.\nOf course, you should guarantee that the caller should the version_path is not nullptr.", "author": "chaoyli", "createdAt": "2020-04-22T02:26:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4NTU1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzg0NDYxNA==", "url": "https://github.com/apache/incubator-doris/pull/3339#discussion_r413844614", "bodyText": "Either version_path  is nullptr or is valid for this function. If it's nullptr, just validate rowset graph; if it's not nullptr, validate rowset graph and return current versions.", "author": "acelyc111", "createdAt": "2020-04-23T14:28:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4NTU1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4NTU5Mg==", "url": "https://github.com/apache/incubator-doris/pull/3339#discussion_r409985592", "bodyText": "You can CHECK(VERSION_PATH != nullptr) to replace above logic.", "author": "chaoyli", "createdAt": "2020-04-17T04:26:43Z", "path": "be/src/olap/rowset_graph.cpp", "diffHunk": "@@ -159,11 +159,6 @@ OLAPStatus RowsetGraph::capture_consistent_versions(const Version& spec_version,\n         return OLAP_ERR_INPUT_PARAMETER_ERROR;\n     }\n ", "originalCommit": "12df4c17f427efe51517a7a65c58c0c0a75dc5c7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0854d7a896cb989c2a889f10b3670ca3de1f59c2", "url": "https://github.com/apache/incubator-doris/commit/0854d7a896cb989c2a889f10b3670ca3de1f59c2", "message": "fix compile error", "committedDate": "2020-04-19T06:01:59Z", "type": "commit"}]}