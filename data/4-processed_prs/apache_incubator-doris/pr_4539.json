{"pr_number": 4539, "pr_title": "[storage][compatibility]  Add meta format detection to prevent data loss.", "pr_createdAt": "2020-09-05T05:49:49Z", "pr_url": "https://github.com/apache/incubator-doris/pull/4539", "timeline": [{"oid": "f3f468f6c4fccd7ce1334a788d144fb36a39daa8", "url": "https://github.com/apache/incubator-doris/commit/f3f468f6c4fccd7ce1334a788d144fb36a39daa8", "message": "check_incompatible_old_format", "committedDate": "2020-09-05T06:06:42Z", "type": "commit"}, {"oid": "f2722f75d419193a5555d52342c83cbb8514806c", "url": "https://github.com/apache/incubator-doris/commit/f2722f75d419193a5555d52342c83cbb8514806c", "message": "fix", "committedDate": "2020-09-05T06:06:42Z", "type": "commit"}, {"oid": "f2722f75d419193a5555d52342c83cbb8514806c", "url": "https://github.com/apache/incubator-doris/commit/f2722f75d419193a5555d52342c83cbb8514806c", "message": "fix", "committedDate": "2020-09-05T06:06:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzkyOTE5OQ==", "url": "https://github.com/apache/incubator-doris/pull/4539#discussion_r483929199", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    LOG(WARNING) << \"check incompatible old format meta fails, it may lead to data missing!!!\" << _path;\n          \n          \n            \n                    LOG(WARNING) << \"check incompatible old format meta fails, it may lead to data missing!!! \" << _path;", "author": "morningman", "createdAt": "2020-09-05T08:52:38Z", "path": "be/src/olap/data_dir.cpp", "diffHunk": "@@ -602,13 +602,47 @@ OLAPStatus DataDir::set_convert_finished() {\n     return OLAP_SUCCESS;\n }\n \n+OLAPStatus DataDir::_check_incompatible_old_format_tablet() {\n+\n+    auto check_incompatible_old_func = [this](int64_t tablet_id, int32_t schema_hash,\n+                                              const std::string& value) -> bool {\n+                                                  \n+        // if strict check incompatible old format, then log fatal\n+        if (config::storage_strict_check_incompatible_old_format) {\n+            LOG(FATAL) << \"There are incompatible old format metas, current version does not support \"\n+                       << \"and it may lead to data missing!!! \"\n+                       << \"talbet_id = \" << tablet_id << \" schema_hash = \" << schema_hash;\n+        } else {\n+            LOG(WARNING)\n+                    << \"There are incompatible old format metas, current version does not support \"\n+                    << \"and it may lead to data missing!!! \"\n+                    << \"talbet_id = \" << tablet_id << \" schema_hash = \" << schema_hash;\n+        }\n+        return false;\n+    };\n+\n+    // seek old header prefix. when check_incompatible_old_func is called, it has old format in olap_meta\n+    OLAPStatus check_incompatible_old_status = TabletMetaManager::traverse_headers(\n+            _meta, check_incompatible_old_func, OLD_HEADER_PREFIX);\n+    if (check_incompatible_old_status != OLAP_SUCCESS) {\n+        LOG(WARNING) << \"check incompatible old format meta fails, it may lead to data missing!!!\" << _path;", "originalCommit": "f2722f75d419193a5555d52342c83cbb8514806c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e37c3acd928d0bb0c29cb1383da2d66f308f1e2c", "url": "https://github.com/apache/incubator-doris/commit/e37c3acd928d0bb0c29cb1383da2d66f308f1e2c", "message": "Update be/src/olap/data_dir.cpp\n\nCo-authored-by: Mingyu Chen <morningman.cmy@gmail.com>", "committedDate": "2020-09-05T09:34:11Z", "type": "commit"}]}