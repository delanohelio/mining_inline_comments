{"pr_number": 3286, "pr_title": "unregister fragment mem tracker in close()", "pr_createdAt": "2020-04-09T05:31:36Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3286", "timeline": [{"oid": "5208751e4730209ee1affe3b5f2993cfbd1f1db4", "url": "https://github.com/apache/incubator-doris/commit/5208751e4730209ee1affe3b5f2993cfbd1f1db4", "message": "unregister fragment mem tracker in close()", "committedDate": "2020-04-09T05:12:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk4NDA3Ng==", "url": "https://github.com/apache/incubator-doris/pull/3286#discussion_r405984076", "bodyText": "Why not keep origin code and just add unregister_from_parent.\nIf you reset this mem_tracker here, I'm not sure if it will work in some situation, some runtime holder may access this tracker.\nSo, just to keep things simple, better not change origin code.\nBy the way, this tracker can be substituted by other tracker. Maybe it can be done in another issue.", "author": "imay", "createdAt": "2020-04-09T06:33:37Z", "path": "be/src/runtime/plan_fragment_executor.cpp", "diffHunk": "@@ -556,10 +556,12 @@ void PlanFragmentExecutor::close() {\n         }\n     }\n      \n-    // _mem_tracker init failed\n+    // fragment mem tracker needs unregister\n     if (_mem_tracker.get() != nullptr) {\n-        _mem_tracker->release(_mem_tracker->consumption());\n+        _mem_tracker->unregister_from_parent();\n+        _mem_tracker->close();", "originalCommit": "5208751e4730209ee1affe3b5f2993cfbd1f1db4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjU4MTYzMA==", "url": "https://github.com/apache/incubator-doris/pull/3286#discussion_r406581630", "bodyText": "I searched all usages of _runtime_state->fragment_mem_tracker(). Where else?\nHow about move this piece to PlanFragmentExecutor dtor? I think it's a better place.\n\nBy the way, this tracker can be substituted by other tracker. Maybe it can be done in another issue.\n\nCan't agree more. fragment mem tracker's label is \"fragment mem-limit\", it's not very useful. And one plan has two level1 nodes, I think it's not a good design.\nLet's create a new issue to discuss it.", "author": "vagetablechicken", "createdAt": "2020-04-10T03:03:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk4NDA3Ng=="}], "type": "inlineReview"}, {"oid": "23f9c1f812b4fbf06b1446f4a41bb35d0ff08cb9", "url": "https://github.com/apache/incubator-doris/commit/23f9c1f812b4fbf06b1446f4a41bb35d0ff08cb9", "message": "fix", "committedDate": "2020-04-13T09:27:07Z", "type": "commit"}, {"oid": "5fc7803b28c76c6415edf2f58354f38f971d009d", "url": "https://github.com/apache/incubator-doris/commit/5fc7803b28c76c6415edf2f58354f38f971d009d", "message": "fix", "committedDate": "2020-04-13T09:31:19Z", "type": "commit"}]}