{"pr_number": 4771, "pr_title": "[LoadBalance] make BeLoadRebalancer extends from base class Rebalancer", "pr_createdAt": "2020-10-20T09:03:10Z", "pr_url": "https://github.com/apache/incubator-doris/pull/4771", "timeline": [{"oid": "dd1d78b1b18f8ee21b176d6e3c775c76cea5756d", "url": "https://github.com/apache/incubator-doris/commit/dd1d78b1b18f8ee21b176d6e3c775c76cea5756d", "message": "[] base rebalancer", "committedDate": "2020-10-20T08:49:12Z", "type": "commit"}, {"oid": "a91d931f6eae1873ed148c53411f6b867ae3421c", "url": "https://github.com/apache/incubator-doris/commit/a91d931f6eae1873ed148c53411f6b867ae3421c", "message": "[] fix", "committedDate": "2020-10-20T09:05:06Z", "type": "commit"}, {"oid": "8fe4ec93ace75e9b76fc9cdca9ddea2c95a4ec54", "url": "https://github.com/apache/incubator-doris/commit/8fe4ec93ace75e9b76fc9cdca9ddea2c95a4ec54", "message": "[] fix", "committedDate": "2020-10-20T09:46:45Z", "type": "commit"}, {"oid": "8c543d2d34f6ec07640114f3ada72d284e1e4f0c", "url": "https://github.com/apache/incubator-doris/commit/8c543d2d34f6ec07640114f3ada72d284e1e4f0c", "message": "[] fix", "committedDate": "2020-10-20T09:54:17Z", "type": "commit"}, {"oid": "49b06d572541359eb667dfb6e8eb4a116fa02075", "url": "https://github.com/apache/incubator-doris/commit/49b06d572541359eb667dfb6e8eb4a116fa02075", "message": "[] fix", "committedDate": "2020-10-20T10:43:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEzODg0OA==", "url": "https://github.com/apache/incubator-doris/pull/4771#discussion_r510138848", "bodyText": "For current scheduler principal, a tablet can only have one task running or pending at most. So we should delete the cache as soon as possible. It is better to change this function to getAndDeleteCachedSrcBackendId. And call it after scheduler cancelled, task running cancelled, and deleteSrcReplicaOfLB.", "author": "gengjun-git", "createdAt": "2020-10-22T12:57:35Z", "path": "fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java", "diffHunk": "@@ -0,0 +1,80 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.apache.doris.clone;\n+\n+import org.apache.doris.catalog.TabletInvertedIndex;\n+import org.apache.doris.clone.TabletScheduler.PathSlot;\n+import org.apache.doris.system.SystemInfoService;\n+import org.apache.doris.task.AgentBatchTask;\n+import org.apache.doris.thrift.TStorageMedium;\n+\n+import com.google.common.collect.Lists;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+\n+/*\n+ * Rebalancer is responsible for\n+ * 1. selectAlternativeTablets: selecting alternative tablets by one rebalance strategy,\n+ * and return them to tablet scheduler(maybe contains the concrete moves, or maybe not).\n+ * 2. createBalanceTask: given a tablet, try to create a clone task for this tablet.\n+ * 3. getCachedSrcBackendId: if the rebalance strategy wants to delete the replica of a specified be,\n+ * override this func.\n+ * NOTICE:\n+ * It may have a long interval between selectAlternativeTablets() & createBalanceTask(). So the concrete moves may be\n+ * invalid when we createBalanceTask(), you should check the moves' validation.\n+ */\n+public abstract class Rebalancer {\n+    // When Rebalancer init, the statisticMap is usually empty. So it's no need to be an arg.\n+    // Only use updateLoadStatistic() to load stats.\n+    protected Map<String, ClusterLoadStatistic> statisticMap = new HashMap<>();\n+    protected TabletInvertedIndex invertedIndex;\n+    protected SystemInfoService infoService;\n+\n+    public Rebalancer(SystemInfoService infoService, TabletInvertedIndex invertedIndex) {\n+        this.infoService = infoService;\n+        this.invertedIndex = invertedIndex;\n+    }\n+\n+    public List<TabletSchedCtx> selectAlternativeTablets() {\n+        List<TabletSchedCtx> alternativeTablets = Lists.newArrayList();\n+        for (Map.Entry<String, ClusterLoadStatistic> entry : statisticMap.entrySet()) {\n+            for (TStorageMedium medium : TStorageMedium.values()) {\n+                alternativeTablets.addAll(selectAlternativeTabletsForCluster(entry.getKey(),\n+                        entry.getValue(), medium));\n+            }\n+        }\n+        return alternativeTablets;\n+    }\n+\n+    protected abstract List<TabletSchedCtx> selectAlternativeTabletsForCluster(\n+            String clusterName, ClusterLoadStatistic clusterStat, TStorageMedium medium);\n+\n+    public abstract void createBalanceTask(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots,\n+                                           AgentBatchTask batchTask) throws SchedException;\n+\n+    public Long getCachedSrcBackendId(Long tabletId) {", "originalCommit": "49b06d572541359eb667dfb6e8eb4a116fa02075", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI1NDAyMA==", "url": "https://github.com/apache/incubator-doris/pull/4771#discussion_r510254020", "bodyText": "I prefer that cache should be managed by Rebalancer, no need to make getCachedSrcBackendId to delete. You can do whatever you want, e.g. only clear cache when stats update.\nAbout cancellations(scheduler canceled, task running cancelled, etc.):\nBefore these cancellations, adding tablet to the scheduler may get failed. And after the clone task completed, the rest of a rebalance move may get failed too. So there're so many places that need to delete cache. I think we shouldn't 'delete the cache asap'. Maybe clearing cache when stats update is better.", "author": "vagetablechicken", "createdAt": "2020-10-22T15:27:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEzODg0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA3NDgwMw==", "url": "https://github.com/apache/incubator-doris/pull/4771#discussion_r514074803", "bodyText": "For a  general balance interface.  method name getCachedSrcBackendId is not very clear.   delete the replica of a specified be in  getCachedSrcBackendId is also strange.", "author": "kangkaisen", "createdAt": "2020-10-29T08:17:44Z", "path": "fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java", "diffHunk": "@@ -0,0 +1,80 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.apache.doris.clone;\n+\n+import org.apache.doris.catalog.TabletInvertedIndex;\n+import org.apache.doris.clone.TabletScheduler.PathSlot;\n+import org.apache.doris.system.SystemInfoService;\n+import org.apache.doris.task.AgentBatchTask;\n+import org.apache.doris.thrift.TStorageMedium;\n+\n+import com.google.common.collect.Lists;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+\n+/*\n+ * Rebalancer is responsible for\n+ * 1. selectAlternativeTablets: selecting alternative tablets by one rebalance strategy,\n+ * and return them to tablet scheduler(maybe contains the concrete moves, or maybe not).\n+ * 2. createBalanceTask: given a tablet, try to create a clone task for this tablet.\n+ * 3. getCachedSrcBackendId: if the rebalance strategy wants to delete the replica of a specified be,\n+ * override this func.\n+ * NOTICE:\n+ * It may have a long interval between selectAlternativeTablets() & createBalanceTask(). So the concrete moves may be\n+ * invalid when we createBalanceTask(), you should check the moves' validation.\n+ */\n+public abstract class Rebalancer {\n+    // When Rebalancer init, the statisticMap is usually empty. So it's no need to be an arg.\n+    // Only use updateLoadStatistic() to load stats.\n+    protected Map<String, ClusterLoadStatistic> statisticMap = new HashMap<>();\n+    protected TabletInvertedIndex invertedIndex;\n+    protected SystemInfoService infoService;\n+\n+    public Rebalancer(SystemInfoService infoService, TabletInvertedIndex invertedIndex) {\n+        this.infoService = infoService;\n+        this.invertedIndex = invertedIndex;\n+    }\n+\n+    public List<TabletSchedCtx> selectAlternativeTablets() {\n+        List<TabletSchedCtx> alternativeTablets = Lists.newArrayList();\n+        for (Map.Entry<String, ClusterLoadStatistic> entry : statisticMap.entrySet()) {\n+            for (TStorageMedium medium : TStorageMedium.values()) {\n+                alternativeTablets.addAll(selectAlternativeTabletsForCluster(entry.getKey(),\n+                        entry.getValue(), medium));\n+            }\n+        }\n+        return alternativeTablets;\n+    }\n+\n+    protected abstract List<TabletSchedCtx> selectAlternativeTabletsForCluster(\n+            String clusterName, ClusterLoadStatistic clusterStat, TStorageMedium medium);\n+\n+    public abstract void createBalanceTask(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots,\n+                                           AgentBatchTask batchTask) throws SchedException;\n+\n+    public Long getCachedSrcBackendId(Long tabletId) {", "originalCommit": "49b06d572541359eb667dfb6e8eb4a116fa02075", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE0ODgzNA==", "url": "https://github.com/apache/incubator-doris/pull/4771#discussion_r514148834", "bodyText": "It does seem odd, I'll reconsider the naming.\nAnd it's better to use replicaId than use backendId. That'll be clear.", "author": "vagetablechicken", "createdAt": "2020-10-29T10:19:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA3NDgwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkyNzgyOQ==", "url": "https://github.com/apache/incubator-doris/pull/4771#discussion_r514927829", "bodyText": "* 3. getSrcReplicaId: if the rebalance strategy wants to delete the src replica,\n * override this func.\n\nDo a delete operation in a get method, I still think which is confusing.", "author": "kangkaisen", "createdAt": "2020-10-30T08:06:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA3NDgwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA3NzQyMg==", "url": "https://github.com/apache/incubator-doris/pull/4771#discussion_r514077422", "bodyText": "For a balance, the core strategy is how to choose which tablet, choose src backend, choose dest backend. But I don't see the interface about how to choose dest backend.", "author": "kangkaisen", "createdAt": "2020-10-29T08:22:11Z", "path": "fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java", "diffHunk": "@@ -0,0 +1,80 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.apache.doris.clone;\n+\n+import org.apache.doris.catalog.TabletInvertedIndex;\n+import org.apache.doris.clone.TabletScheduler.PathSlot;\n+import org.apache.doris.system.SystemInfoService;\n+import org.apache.doris.task.AgentBatchTask;\n+import org.apache.doris.thrift.TStorageMedium;\n+\n+import com.google.common.collect.Lists;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+\n+/*\n+ * Rebalancer is responsible for\n+ * 1. selectAlternativeTablets: selecting alternative tablets by one rebalance strategy,\n+ * and return them to tablet scheduler(maybe contains the concrete moves, or maybe not).\n+ * 2. createBalanceTask: given a tablet, try to create a clone task for this tablet.\n+ * 3. getCachedSrcBackendId: if the rebalance strategy wants to delete the replica of a specified be,\n+ * override this func.\n+ * NOTICE:\n+ * It may have a long interval between selectAlternativeTablets() & createBalanceTask(). So the concrete moves may be\n+ * invalid when we createBalanceTask(), you should check the moves' validation.\n+ */\n+public abstract class Rebalancer {", "originalCommit": "49b06d572541359eb667dfb6e8eb4a116fa02075", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE1MzM0Mw==", "url": "https://github.com/apache/incubator-doris/pull/4771#discussion_r514153343", "bodyText": "Choosing dest be can be done before generating a clone task in createBalanceTask. The base class doesn't limit it.\nFor example:\nThe origin rebalance algo: selectAlternativeTablets just select a tablet, choose dest be in createBalanceTask\nThe algo which has a concrete move: selectAlternativeTablets will select a tablet and src be, dest be. In createBalanceTask, we should check the validation.", "author": "vagetablechicken", "createdAt": "2020-10-29T10:26:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA3NzQyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkyMjM2MQ==", "url": "https://github.com/apache/incubator-doris/pull/4771#discussion_r514922361", "bodyText": "Choosing dest be can be done before generating a clone task in createBalanceTask. The base class doesn't limit it.\n\nHow to choose the dest be is core for balance strategy, if the base class doesn't limit it, what's the meaning of balance base class.", "author": "kangkaisen", "createdAt": "2020-10-30T07:53:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA3NzQyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTUwOTA5NA==", "url": "https://github.com/apache/incubator-doris/pull/4771#discussion_r515509094", "bodyText": "In origin LoadBalancer class, both \"Choose Source\" and \"Choose Destination\" are done in createBalanceTask.\n@kangkaisen  may think that as a base class, these two interfaces need to be explicitly provided. But I think this is just a design pattern consideration, for the actual code implementation, there is little difference between the two. One is to implement the interfaces separately, and the other is to implement them in one interface.\nThe former has a clearer interface meaning, while the latter currently has relatively fewer code changes.", "author": "morningman", "createdAt": "2020-10-31T15:40:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA3NzQyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA3ODgwNA==", "url": "https://github.com/apache/incubator-doris/pull/4771#discussion_r514078804", "bodyText": "What's the meaning of LB \uff1f", "author": "kangkaisen", "createdAt": "2020-10-29T08:24:37Z", "path": "fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java", "diffHunk": "@@ -826,12 +831,25 @@ private boolean deleteReplicaNotInCluster(TabletSchedCtx tabletCtx, boolean forc\n         return false;\n     }\n \n+    private boolean deleteSrcReplicaOfLB(TabletSchedCtx tabletCtx, boolean force) throws SchedException {", "originalCommit": "49b06d572541359eb667dfb6e8eb4a116fa02075", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE1Mzg0NA==", "url": "https://github.com/apache/incubator-doris/pull/4771#discussion_r514153844", "bodyText": "LoadBalance\uff0cI think the naming should be changed too.", "author": "vagetablechicken", "createdAt": "2020-10-29T10:27:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA3ODgwNA=="}], "type": "inlineReview"}, {"oid": "4e16fbcf49cb24fcdc7d70f2f6d3e7e75b6a5abe", "url": "https://github.com/apache/incubator-doris/commit/4e16fbcf49cb24fcdc7d70f2f6d3e7e75b6a5abe", "message": "[] fix naming", "committedDate": "2020-10-29T10:35:33Z", "type": "commit"}, {"oid": "3731d4a2f80f6e67fcf1d97d7dc73488cff4fb6b", "url": "https://github.com/apache/incubator-doris/commit/3731d4a2f80f6e67fcf1d97d7dc73488cff4fb6b", "message": "[] fix", "committedDate": "2020-10-30T02:41:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkyMjg3MA==", "url": "https://github.com/apache/incubator-doris/pull/4771#discussion_r514922870", "bodyText": "I don't understand why we need to delete the src replica of rebalance?", "author": "kangkaisen", "createdAt": "2020-10-30T07:54:43Z", "path": "fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java", "diffHunk": "@@ -826,12 +832,25 @@ private boolean deleteReplicaNotInCluster(TabletSchedCtx tabletCtx, boolean forc\n         return false;\n     }\n \n+    private boolean deleteReplicaChosenByRebalancer(TabletSchedCtx tabletCtx, boolean force) throws SchedException {\n+        Long id = rebalancer.getSrcReplicaId(tabletCtx.getTabletId());\n+        if (id == -1L) {\n+            return false;\n+        }\n+        Replica chosenReplica = tabletCtx.getTablet().getReplicaById(id);\n+        if (chosenReplica != null) {\n+            deleteReplicaInternal(tabletCtx, chosenReplica, \"src replica of rebalance\", force);", "originalCommit": "3731d4a2f80f6e67fcf1d97d7dc73488cff4fb6b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4ee5cd1d3f855707967a4dad5da544df0e133577", "url": "https://github.com/apache/incubator-doris/commit/4ee5cd1d3f855707967a4dad5da544df0e133577", "message": "[] add completePlan & comments", "committedDate": "2020-11-02T03:50:45Z", "type": "commit"}, {"oid": "311204ccbfb6989c8626729d1ef157e5a6ddea94", "url": "https://github.com/apache/incubator-doris/commit/311204ccbfb6989c8626729d1ef157e5a6ddea94", "message": "[] comments", "committedDate": "2020-11-02T03:57:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc1NDIxMg==", "url": "https://github.com/apache/incubator-doris/pull/4771#discussion_r515754212", "bodyText": "In the whole FE balance module, we don't use Plan. So I think we could rename it to completeSchedCtx?", "author": "kangkaisen", "createdAt": "2020-11-02T05:59:58Z", "path": "fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java", "diffHunk": "@@ -0,0 +1,96 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.apache.doris.clone;\n+\n+import org.apache.doris.catalog.TabletInvertedIndex;\n+import org.apache.doris.clone.TabletScheduler.PathSlot;\n+import org.apache.doris.system.SystemInfoService;\n+import org.apache.doris.task.AgentBatchTask;\n+import org.apache.doris.thrift.TStorageMedium;\n+\n+import com.google.common.collect.Lists;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+\n+/*\n+ * Rebalancer is responsible for\n+ * 1. selectAlternativeTablets: selecting alternative tablets by one rebalance strategy,\n+ * and return them to tablet scheduler(maybe contains the concrete moves, or maybe not).\n+ * 2. createBalanceTask: given a tablet, try to create a clone task for this tablet.\n+ * 3. getToDeleteReplicaId: if the rebalance strategy wants to delete the specified replica,\n+ * override this func to let TabletScheduler know in handling redundant replica.\n+ * NOTICE:\n+ * 1. Adding the selected tablets by TabletScheduler may not succeed at all. And the move may be failed in some other places.\n+ * So the thing you need to know is, Rebalancer cannot know when the move is failed.\n+ * 2. If you want to make sure the move is succeed, you can assume that it's succeed when getToDeleteReplicaId called.\n+ */\n+public abstract class Rebalancer {\n+    // When Rebalancer init, the statisticMap is usually empty. So it's no need to be an arg.\n+    // Only use updateLoadStatistic() to load stats.\n+    protected Map<String, ClusterLoadStatistic> statisticMap = new HashMap<>();\n+    protected TabletInvertedIndex invertedIndex;\n+    protected SystemInfoService infoService;\n+\n+    public Rebalancer(SystemInfoService infoService, TabletInvertedIndex invertedIndex) {\n+        this.infoService = infoService;\n+        this.invertedIndex = invertedIndex;\n+    }\n+\n+    public List<TabletSchedCtx> selectAlternativeTablets() {\n+        List<TabletSchedCtx> alternativeTablets = Lists.newArrayList();\n+        for (Map.Entry<String, ClusterLoadStatistic> entry : statisticMap.entrySet()) {\n+            for (TStorageMedium medium : TStorageMedium.values()) {\n+                alternativeTablets.addAll(selectAlternativeTabletsForCluster(entry.getKey(),\n+                        entry.getValue(), medium));\n+            }\n+        }\n+        return alternativeTablets;\n+    }\n+\n+    // The return TabletSchedCtx should have the tablet id at least. {srcReplica, destBe} can be complete here or\n+    // later(when createBalanceTask called).\n+    protected abstract List<TabletSchedCtx> selectAlternativeTabletsForCluster(\n+            String clusterName, ClusterLoadStatistic clusterStat, TStorageMedium medium);\n+\n+\n+    public void createBalanceTask(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots,\n+                                  AgentBatchTask batchTask) throws SchedException {\n+        completePlan(tabletCtx, backendsWorkingSlots);\n+        batchTask.addTask(tabletCtx.createCloneReplicaAndTask());\n+    }\n+\n+    // Before createCloneReplicaAndTask, we need to complete the TabletSchedCtx.\n+    // 1. If you generate {tabletId, srcReplica, destBe} in selectAlternativeTablets(), it may be invalid at\n+    // this point(it may have a long interval between selectAlternativeTablets & createBalanceTask).\n+    // You should check the moves' validation.\n+    // 2. If you want to generate {srcReplica, destBe} here, just do it.\n+    // 3. You should check the path slots of src & dest.\n+    protected abstract void completePlan(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots)", "originalCommit": "311204ccbfb6989c8626729d1ef157e5a6ddea94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc2NjEwMQ==", "url": "https://github.com/apache/incubator-doris/pull/4771#discussion_r515766101", "bodyText": "\ud83d\udc4c", "author": "vagetablechicken", "createdAt": "2020-11-02T06:43:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc1NDIxMg=="}], "type": "inlineReview"}, {"oid": "8bb3ce37b814a5f80141b4f5ab76127971cae20e", "url": "https://github.com/apache/incubator-doris/commit/8bb3ce37b814a5f80141b4f5ab76127971cae20e", "message": "[] fix naming", "committedDate": "2020-11-02T06:44:10Z", "type": "commit"}, {"oid": "7e3c9641954a26747d6140614f026dc808812dc6", "url": "https://github.com/apache/incubator-doris/commit/7e3c9641954a26747d6140614f026dc808812dc6", "message": "[] fix imports", "committedDate": "2020-11-02T08:52:08Z", "type": "commit"}]}