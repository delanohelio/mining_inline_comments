{"pr_number": 3991, "pr_title": "Fix the problem of mem exec, when analytic eval node need to spill to disk with a low mem limit", "pr_createdAt": "2020-07-01T04:46:54Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3991", "timeline": [{"oid": "955b3499d01ea7176efcedab9c1262f983511c97", "url": "https://github.com/apache/incubator-doris/commit/955b3499d01ea7176efcedab9c1262f983511c97", "message": "[Bug] Fix the problem of mem exec, when analytic eval node need to spill to disk with a low mem limit. And clear_reservations\nof Analytic node reservation of block manager.\n[Running Profile] Add Spilled flag in Running Profile, when Analytic eval node and sort node spill to Disk.", "committedDate": "2020-07-01T04:13:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIzOTcxNg==", "url": "https://github.com/apache/incubator-doris/pull/3991#discussion_r448239716", "bodyText": "Align spaces", "author": "wutiangan", "createdAt": "2020-07-01T09:32:59Z", "path": "be/src/runtime/spill_sorter.cc", "diffHunk": "@@ -1109,6 +1110,7 @@ Status SpillSorter::add_batch(RowBatch* batch) {\n             // The current run is full. Sort it and begin the next one.\n             RETURN_IF_ERROR(sort_run());\n             RETURN_IF_ERROR(_sorted_runs.back()->unpin_all_blocks());\n+\t    _spilled = true;", "originalCommit": "955b3499d01ea7176efcedab9c1262f983511c97", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODI0MDgwMg==", "url": "https://github.com/apache/incubator-doris/pull/3991#discussion_r448240802", "bodyText": "there is no MAX_TUPLE_POOL_SIZE\uff0c you deleted it before", "author": "wutiangan", "createdAt": "2020-07-01T09:35:02Z", "path": "be/src/exec/analytic_eval_node.cpp", "diffHunk": "@@ -710,7 +709,13 @@ Status AnalyticEvalNode::process_child_batch(RuntimeState* state) {\n \n     // Transfer resources to _prev_tuple_pool when enough resources have accumulated\n     // and the _prev_tuple_pool has already been transfered to an output batch.\n-    if (_curr_tuple_pool->total_allocated_bytes() > MAX_TUPLE_POOL_SIZE &&\n+\n+    // The memory limit of _curr_tuple_pool is set by the fixed value MAX_TUPLE_POOL_SIZE", "originalCommit": "955b3499d01ea7176efcedab9c1262f983511c97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc0MDI4NA==", "url": "https://github.com/apache/incubator-doris/pull/3991#discussion_r448740284", "bodyText": "ok\uff0ci will change the comment", "author": "HappenLee", "createdAt": "2020-07-02T04:21:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODI0MDgwMg=="}], "type": "inlineReview"}, {"oid": "0462d15df436803096db9d1a078701f2dbe649bf", "url": "https://github.com/apache/incubator-doris/commit/0462d15df436803096db9d1a078701f2dbe649bf", "message": "change some code", "committedDate": "2020-07-02T05:10:57Z", "type": "commit"}, {"oid": "422f86994b07167278bc66b038d8b44684cbb603", "url": "https://github.com/apache/incubator-doris/commit/422f86994b07167278bc66b038d8b44684cbb603", "message": "check _client nullptr before clear reservation", "committedDate": "2020-07-03T02:44:49Z", "type": "commit"}, {"oid": "81b1d1b86454ee1b7ec6cc3fb4f0040f5d84a34c", "url": "https://github.com/apache/incubator-doris/commit/81b1d1b86454ee1b7ec6cc3fb4f0040f5d84a34c", "message": "change name client_ to _block_mgr_client", "committedDate": "2020-07-08T07:45:17Z", "type": "commit"}, {"oid": "81b1d1b86454ee1b7ec6cc3fb4f0040f5d84a34c", "url": "https://github.com/apache/incubator-doris/commit/81b1d1b86454ee1b7ec6cc3fb4f0040f5d84a34c", "message": "change name client_ to _block_mgr_client", "committedDate": "2020-07-08T07:45:17Z", "type": "forcePushed"}]}