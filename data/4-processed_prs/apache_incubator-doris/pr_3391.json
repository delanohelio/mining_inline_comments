{"pr_number": 3391, "pr_title": "[Load] Add more info in SHOW LOAD result", "pr_createdAt": "2020-04-24T13:26:03Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3391", "timeline": [{"oid": "ea7681fd088b5fb4019ace2acedddc4fd1724883", "url": "https://github.com/apache/incubator-doris/commit/ea7681fd088b5fb4019ace2acedddc4fd1724883", "message": "commit", "committedDate": "2020-04-24T13:16:30Z", "type": "commit"}, {"oid": "9325446458e3116ab358a3902c8d6b1474efaad5", "url": "https://github.com/apache/incubator-doris/commit/9325446458e3116ab358a3902c8d6b1474efaad5", "message": "fix bug", "committedDate": "2020-04-24T14:00:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTAxNzE4NQ==", "url": "https://github.com/apache/incubator-doris/pull/3391#discussion_r415017185", "bodyText": "Maybe change \u201cbeId\u201d to \u201dbackendId\u201c is better\uff0cat before you use unfinished\u201cBackendIds\u201d  and all\u201dBackendIds\u201c", "author": "wutiangan", "createdAt": "2020-04-25T08:49:50Z", "path": "fe/src/main/java/org/apache/doris/load/loadv2/LoadJob.java", "diffHunk": "@@ -138,30 +139,41 @@\n         // load task id -> fragment id -> rows count\n         private Table<TUniqueId, TUniqueId, Long> counterTbl = HashBasedTable.create();\n \n+        // load task id -> unfinished backend id list\n+        private Map<TUniqueId, List<Long>> unfinishedBackendIds = Maps.newHashMap();\n+        // load task id -> all backend id list\n+        private Map<TUniqueId, List<Long>> allBackendIds = Maps.newHashMap();\n+\n         // number of file to be loaded\n         public int fileNum = 0;\n         public long totalFileSizeB = 0;\n \n         // init the statistic of specified load task\n-        public synchronized void initLoad(TUniqueId loadId, Set<TUniqueId> fragmentIds) {\n+        public synchronized void initLoad(TUniqueId loadId, Set<TUniqueId> fragmentIds, List<Long> relatedBackendIds) {\n             counterTbl.rowMap().remove(loadId);\n             for (TUniqueId fragId : fragmentIds) {\n                 counterTbl.put(loadId, fragId, 0L);\n             }\n+            allBackendIds.put(loadId, relatedBackendIds);\n+            // need to get a copy of relatedBackendIds, so that when we modify the \"relatedBackendIds\" in\n+            // allBackendIds, the list in unfinishedBackendIds will not be changed.\n+            unfinishedBackendIds.put(loadId, Lists.newArrayList(relatedBackendIds));\n         }\n \n         public synchronized void removeLoad(TUniqueId loadId) {\n             counterTbl.rowMap().remove(loadId);\n+            unfinishedBackendIds.remove(loadId);\n+            allBackendIds.remove(loadId);\n         }\n \n-        public synchronized void updateLoad(TUniqueId loadId, TUniqueId fragmentId, long rows) {\n+        public synchronized void updateLoadProgress(long beId, TUniqueId loadId, TUniqueId fragmentId, long rows,", "originalCommit": "9325446458e3116ab358a3902c8d6b1474efaad5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTA2NjE5MQ==", "url": "https://github.com/apache/incubator-doris/pull/3391#discussion_r415066191", "bodyText": "changed", "author": "morningman", "createdAt": "2020-04-25T13:46:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTAxNzE4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTAxNzIwMg==", "url": "https://github.com/apache/incubator-doris/pull/3391#discussion_r415017202", "bodyText": "can unfinishedBackendIds.get(loadId) be empty\uff1f", "author": "wutiangan", "createdAt": "2020-04-25T08:49:54Z", "path": "fe/src/main/java/org/apache/doris/load/loadv2/LoadJob.java", "diffHunk": "@@ -138,30 +139,41 @@\n         // load task id -> fragment id -> rows count\n         private Table<TUniqueId, TUniqueId, Long> counterTbl = HashBasedTable.create();\n \n+        // load task id -> unfinished backend id list\n+        private Map<TUniqueId, List<Long>> unfinishedBackendIds = Maps.newHashMap();\n+        // load task id -> all backend id list\n+        private Map<TUniqueId, List<Long>> allBackendIds = Maps.newHashMap();\n+\n         // number of file to be loaded\n         public int fileNum = 0;\n         public long totalFileSizeB = 0;\n \n         // init the statistic of specified load task\n-        public synchronized void initLoad(TUniqueId loadId, Set<TUniqueId> fragmentIds) {\n+        public synchronized void initLoad(TUniqueId loadId, Set<TUniqueId> fragmentIds, List<Long> relatedBackendIds) {\n             counterTbl.rowMap().remove(loadId);\n             for (TUniqueId fragId : fragmentIds) {\n                 counterTbl.put(loadId, fragId, 0L);\n             }\n+            allBackendIds.put(loadId, relatedBackendIds);\n+            // need to get a copy of relatedBackendIds, so that when we modify the \"relatedBackendIds\" in\n+            // allBackendIds, the list in unfinishedBackendIds will not be changed.\n+            unfinishedBackendIds.put(loadId, Lists.newArrayList(relatedBackendIds));\n         }\n \n         public synchronized void removeLoad(TUniqueId loadId) {\n             counterTbl.rowMap().remove(loadId);\n+            unfinishedBackendIds.remove(loadId);\n+            allBackendIds.remove(loadId);\n         }\n \n-        public synchronized void updateLoad(TUniqueId loadId, TUniqueId fragmentId, long rows) {\n+        public synchronized void updateLoadProgress(long beId, TUniqueId loadId, TUniqueId fragmentId, long rows,\n+                boolean isDone) {\n             if (counterTbl.contains(loadId, fragmentId)) {\n                 counterTbl.put(loadId, fragmentId, rows);\n             }\n-        }\n-\n-        public synchronized void clearAllLoads() {\n-            counterTbl.clear();\n+            if (isDone && unfinishedBackendIds.containsKey(loadId)) {\n+                unfinishedBackendIds.get(loadId).remove(beId);", "originalCommit": "9325446458e3116ab358a3902c8d6b1474efaad5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTA2NTgxMA==", "url": "https://github.com/apache/incubator-doris/pull/3391#discussion_r415065810", "bodyText": "It won't, there is at least one BE for a load job", "author": "morningman", "createdAt": "2020-04-25T13:43:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTAxNzIwMg=="}], "type": "inlineReview"}, {"oid": "3b441fa7cfe84cc2448616ed52dca6888044898a", "url": "https://github.com/apache/incubator-doris/commit/3b441fa7cfe84cc2448616ed52dca6888044898a", "message": "fix by review", "committedDate": "2020-04-25T13:45:52Z", "type": "commit"}]}