{"pr_number": 4597, "pr_title": "[Bug] Tablet and Disk report thread not work", "pr_createdAt": "2020-09-14T05:23:58Z", "pr_url": "https://github.com/apache/incubator-doris/pull/4597", "timeline": [{"oid": "0e1b997200a35acd28bb50956e3a221acafb5044", "url": "https://github.com/apache/incubator-doris/commit/0e1b997200a35acd28bb50956e3a221acafb5044", "message": "[Bug] Tablet and Disk report thread not work\n\nThe tablet and disk information reporting threads need to report to the FE periodically.\nAt the same time these two reporting threads will also be triggered by certain events.\n\nThe modification in PR #4440 caused these two threads to be triggered only by events,\nand could not report regularly.", "committedDate": "2020-09-14T05:20:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY2MTg0MA==", "url": "https://github.com/apache/incubator-doris/pull/4597#discussion_r487661840", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        LOG(WARNING) << \"report task failed. status:\" << status << \", master host:\"\n          \n          \n            \n                        LOG(WARNING) << \"report task failed. status: \" << status << \", master host: \"", "author": "acelyc111", "createdAt": "2020-09-14T05:37:59Z", "path": "be/src/agent/task_worker_pool.cpp", "diffHunk": "@@ -1007,13 +1038,18 @@ void TaskWorkerPool::_report_task_worker_thread_callback() {\n \n         if (status != DORIS_SUCCESS) {\n             DorisMetrics::instance()->report_task_requests_failed->increment(1);\n-            LOG(WARNING) << \"finish report task failed. status:\" << status << \", master host:\"\n+            LOG(WARNING) << \"report task failed. status:\" << status << \", master host:\"", "originalCommit": "0e1b997200a35acd28bb50956e3a221acafb5044", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY2NDE0OQ==", "url": "https://github.com/apache/incubator-doris/pull/4597#discussion_r487664149", "bodyText": "The same to other places.", "author": "acelyc111", "createdAt": "2020-09-14T05:46:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY2MTg0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY2NzYyOQ==", "url": "https://github.com/apache/incubator-doris/pull/4597#discussion_r487667629", "bodyText": "Seems all callers pass a 'false' parameter, how about remove these code?", "author": "acelyc111", "createdAt": "2020-09-14T05:58:31Z", "path": "be/src/olap/storage_engine.cpp", "diffHunk": "@@ -975,11 +975,17 @@ void StorageEngine::deregister_report_listener(TaskWorkerPool* listener) {\n     _report_listeners.erase(listener);\n }\n \n-void StorageEngine::notify_listeners() {\n+/// if submit_task is true, it will notify the listeners by submmiting a task.\n+/// otherwise, it just notify the thread\n+void StorageEngine::notify_listeners(bool submit_task) {\n     std::lock_guard<std::mutex> l(_report_mtx);\n     for (auto& listener : _report_listeners) {\n-        TAgentTaskRequest task;\n-        listener->submit_task(task);\n+        if (submit_task) {\n+            TAgentTaskRequest task;\n+            listener->submit_task(task);", "originalCommit": "0e1b997200a35acd28bb50956e3a221acafb5044", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY3OTA5MQ==", "url": "https://github.com/apache/incubator-doris/pull/4597#discussion_r487679091", "bodyText": "OK", "author": "morningman", "createdAt": "2020-09-14T06:31:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY2NzYyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY3MDAzOA==", "url": "https://github.com/apache/incubator-doris/pull/4597#discussion_r487670038", "bodyText": "Maybe it's not easy to keep order consistency some days later, how about use a function to get name of type?", "author": "acelyc111", "createdAt": "2020-09-14T06:05:57Z", "path": "be/src/agent/task_worker_pool.h", "diffHunk": "@@ -43,6 +43,8 @@ class ThreadPool;\n \n class TaskWorkerPool {\n public:\n+    // You need to modify the content in TYPE_STRING at the same time,", "originalCommit": "0e1b997200a35acd28bb50956e3a221acafb5044", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY3ODYxMA==", "url": "https://github.com/apache/incubator-doris/pull/4597#discussion_r487678610", "bodyText": "OK", "author": "morningman", "createdAt": "2020-09-14T06:30:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY3MDAzOA=="}], "type": "inlineReview"}, {"oid": "e28c782079fecbde8746955d25712450ffff2523", "url": "https://github.com/apache/incubator-doris/commit/e28c782079fecbde8746955d25712450ffff2523", "message": "fix by review", "committedDate": "2020-09-14T06:53:03Z", "type": "commit"}]}