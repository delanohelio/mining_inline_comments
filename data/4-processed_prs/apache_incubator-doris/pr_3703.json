{"pr_number": 3703, "pr_title": "[Load] Add more metric to trace the time cost in stream load and make brpc_num_threads configurable", "pr_createdAt": "2020-05-27T08:33:00Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3703", "timeline": [{"oid": "deb705ec99473108c62c0ba1e7021bae5b3b90fd", "url": "https://github.com/apache/incubator-doris/commit/deb705ec99473108c62c0ba1e7021bae5b3b90fd", "message": "Add more metric to trace the time cost in stream load and add doc content for brpc_num_threads", "committedDate": "2020-05-27T08:49:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk3NDk1MQ==", "url": "https://github.com/apache/incubator-doris/pull/3703#discussion_r430974951", "bodyText": "modify the document of stream load to explain this new fields", "author": "morningman", "createdAt": "2020-05-27T09:16:12Z", "path": "be/src/runtime/stream_load/stream_load_context.cpp", "diffHunk": "@@ -70,6 +70,17 @@ std::string StreamLoadContext::to_json() const {\n     writer.Int64(receive_bytes);\n     writer.Key(\"LoadTimeMs\");\n     writer.Int64(load_cost_nanos / 1000000);\n+    writer.Key(\"BeginTxnTimeMs\");\n+    writer.Int64(begin_txn_cost_nanos / 1000000);\n+    writer.Key(\"StreamLoadPutTimeMs\");\n+    writer.Int64(stream_load_put_cost_nanos / 1000000);\n+    writer.Key(\"ReadDataTimeMs\");\n+    writer.Int64(read_data_cost_nanos / 1000000);\n+    writer.Key(\"WriteDataTimeMs\");\n+    writer.Int(write_data_cost_nanos / 1000000);\n+    writer.Key(\"CommitAndPublishTimeMs\");\n+    writer.Int64(commit_and_publish_txn_cost_nanos / 1000000);", "originalCommit": "4243f671f4c4ef6c3303fe5f57e8c49f4ee758d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTAzNDE2OQ==", "url": "https://github.com/apache/incubator-doris/pull/3703#discussion_r431034169", "bodyText": "done", "author": "caiconghui", "createdAt": "2020-05-27T11:02:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk3NDk1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk3NTYwNw==", "url": "https://github.com/apache/incubator-doris/pull/3703#discussion_r430975607", "bodyText": "Better give an suggestion value or an example. eg: \"In our env, we have xx BE with xx core, set this to xx, it can reach xx QPS\"", "author": "morningman", "createdAt": "2020-05-27T09:17:16Z", "path": "docs/en/administrator-guide/config/be_config.md", "diffHunk": "@@ -77,6 +77,12 @@ Sometimes the query fails and an error message of `The server is overcrowded` wi\n \n Since this is a brpc configuration, users can also modify this parameter directly during operation. Modify by visiting `http://be_host:brpc_port/flags`.\n \n+### brpc_num_threads\n+\n+This configuration is mainly used to modify the num of bthreads for brpc. The default value is set to -1, which means the num of bthreads is #cpu-cores.\n+\n+User can set this configuration to a larger value to get better QPS performance.", "originalCommit": "4243f671f4c4ef6c3303fe5f57e8c49f4ee758d5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTAzNjgzNg==", "url": "https://github.com/apache/incubator-doris/pull/3703#discussion_r431036836", "bodyText": "Actually, I don't get the real QPS for brpc, I only test stream load operation in our enviroment with  brpc_num_threads set to be 500,  and the relationship between QPS and num of bthreads, I think https://github.com/apache/incubator-brpc/blob/master/docs/cn/benchmark.md is more convincing", "author": "caiconghui", "createdAt": "2020-05-27T11:08:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk3NTYwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA0MzI5MQ==", "url": "https://github.com/apache/incubator-doris/pull/3703#discussion_r431043291", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                //the num of bthreads for brpc, the default value is set to -1, which means the num of bthreads is #cpu-cores\n          \n          \n            \n                //the number of bthreads for brpc, the default value is set to -1, which means the number of bthreads is #cpu-cores\n          \n      \n    \n    \n  \n\nfor Keep consistent with other variables", "author": "wutiangan", "createdAt": "2020-05-27T11:21:08Z", "path": "be/src/common/config.h", "diffHunk": "@@ -30,6 +30,9 @@ namespace config {\n     // port for brpc\n     CONF_Int32(brpc_port, \"8060\");\n \n+    //the num of bthreads for brpc, the default value is set to -1, which means the num of bthreads is #cpu-cores", "originalCommit": "66df4e9bfa1146024b3f5f0530bb8f0382f6333c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA0ODAyNA==", "url": "https://github.com/apache/incubator-doris/pull/3703#discussion_r431048024", "bodyText": "fix", "author": "caiconghui", "createdAt": "2020-05-27T11:30:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA0MzI5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUzMjIxNw==", "url": "https://github.com/apache/incubator-doris/pull/3703#discussion_r431532217", "bodyText": "I think 512 is some big, why not keep it 64?\nFor most scenario, 64 is enough.", "author": "imay", "createdAt": "2020-05-28T01:27:44Z", "path": "be/src/common/config.h", "diffHunk": "@@ -137,7 +140,7 @@ namespace config {\n     // the maximum number of bytes to display on the debug webserver's log page\n     CONF_Int64(web_log_bytes, \"1048576\");\n     // number of threads available to serve backend execution requests\n-    CONF_Int32(be_service_threads, \"64\");\n+    CONF_Int32(be_service_threads, \"512\");", "originalCommit": "a07c6e63686ac3a4a9c244dd9997dc3d6a67e5fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU1MTg1NA==", "url": "https://github.com/apache/incubator-doris/pull/3703#discussion_r431551854", "bodyText": "actually for 64, the query and stream load performance is poor, as mentioned in issue #3696, query(exec_plan_fragment) and submit agent task share the same thread pool in thrift server. I have done some test, 512 can apparently improve the performance both for stream load and query(can not be rpc timeout), query(exec_plan_fragment) would not by blocked by stream load(such as submit publish txn task).in this setting, the publish timeout almost disapper.", "author": "caiconghui", "createdAt": "2020-05-28T02:46:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUzMjIxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYzMzI1NQ==", "url": "https://github.com/apache/incubator-doris/pull/3703#discussion_r431633255", "bodyText": "sorry, I find this config make no sense when thrift server use threaded type , so I revert the modification", "author": "caiconghui", "createdAt": "2020-05-28T07:25:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUzMjIxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUzMjUzNA==", "url": "https://github.com/apache/incubator-doris/pull/3703#discussion_r431532534", "bodyText": "48 is some big, how about 12?", "author": "imay", "createdAt": "2020-05-28T01:29:01Z", "path": "be/src/common/config.h", "diffHunk": "@@ -271,7 +274,7 @@ namespace config {\n     // Port to start debug webserver on\n     CONF_Int32(webserver_port, \"8040\");\n     // Number of webserver workers\n-    CONF_Int32(webserver_num_workers, \"5\");\n+    CONF_Int32(webserver_num_workers, \"48\");", "originalCommit": "a07c6e63686ac3a4a9c244dd9997dc3d6a67e5fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU1NTQyMA==", "url": "https://github.com/apache/incubator-doris/pull/3703#discussion_r431555420", "bodyText": "if http server only for normal  light http request, I think 12, or even 5 is ok. but stream load is a heavy http request\uff0c once user use stream load to insert data, more threads can reduce the risk of no reponse from http server. the time cost for switch between threads i think we can ignore when compared to time cost in stream load.   48 threads don't cost too much memory resources. Above all. The advantages outweigh the disadvantages.", "author": "caiconghui", "createdAt": "2020-05-28T03:01:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUzMjUzNA=="}], "type": "inlineReview"}, {"oid": "23c089773d4953e31738e5b222e31166a896a158", "url": "https://github.com/apache/incubator-doris/commit/23c089773d4953e31738e5b222e31166a896a158", "message": "Make brpc_num_threads configurable to get better performance for qps", "committedDate": "2020-06-04T02:38:17Z", "type": "commit"}, {"oid": "0458d3dbfb0610e38a7c7899e5c7ea26bf5b1441", "url": "https://github.com/apache/incubator-doris/commit/0458d3dbfb0610e38a7c7899e5c7ea26bf5b1441", "message": "Change some default config in be to make doris get better performance in stream load and query", "committedDate": "2020-06-04T02:38:17Z", "type": "commit"}, {"oid": "ef84eb2f6cbbb1520af6a9480d4afa2396cb4f7d", "url": "https://github.com/apache/incubator-doris/commit/ef84eb2f6cbbb1520af6a9480d4afa2396cb4f7d", "message": "Add more metric to trace the time cost in stream load and add doc content for brpc_num_threads", "committedDate": "2020-06-04T02:43:06Z", "type": "commit"}, {"oid": "1fb722dfcec5f55fe5759ae201dbd04016a537c2", "url": "https://github.com/apache/incubator-doris/commit/1fb722dfcec5f55fe5759ae201dbd04016a537c2", "message": "use StreamLoadPutTimeMs instead of StreamLoadPutMs", "committedDate": "2020-06-04T02:43:06Z", "type": "commit"}, {"oid": "b1ea5154b6f3f0de08a11dff84f8f4926a2b17dd", "url": "https://github.com/apache/incubator-doris/commit/b1ea5154b6f3f0de08a11dff84f8f4926a2b17dd", "message": "Add more doc contents about stream load result parameter and brpc_num_threads", "committedDate": "2020-06-04T02:43:06Z", "type": "commit"}, {"oid": "c500936216c966698336c84f66a61043485192f5", "url": "https://github.com/apache/incubator-doris/commit/c500936216c966698336c84f66a61043485192f5", "message": "fix comment content for brpc_num_threads", "committedDate": "2020-06-04T02:43:06Z", "type": "commit"}, {"oid": "f3ea99ccde4c270db575f63fcd15a7d1d6c04c61", "url": "https://github.com/apache/incubator-doris/commit/f3ea99ccde4c270db575f63fcd15a7d1d6c04c61", "message": "Revert be_service_threads config modification", "committedDate": "2020-06-04T02:43:06Z", "type": "commit"}, {"oid": "f849a223ce4fea417ce036b6f3d0677c034791df", "url": "https://github.com/apache/incubator-doris/commit/f849a223ce4fea417ce036b6f3d0677c034791df", "message": "Make metric for write data more accurate", "committedDate": "2020-06-04T02:43:06Z", "type": "commit"}, {"oid": "6918caf64b0397792a616f46e4dccbf5f077e30d", "url": "https://github.com/apache/incubator-doris/commit/6918caf64b0397792a616f46e4dccbf5f077e30d", "message": "fix conflict in be_config.md", "committedDate": "2020-06-04T02:45:35Z", "type": "commit"}, {"oid": "6918caf64b0397792a616f46e4dccbf5f077e30d", "url": "https://github.com/apache/incubator-doris/commit/6918caf64b0397792a616f46e4dccbf5f077e30d", "message": "fix conflict in be_config.md", "committedDate": "2020-06-04T02:45:35Z", "type": "forcePushed"}]}