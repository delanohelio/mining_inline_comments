{"pr_number": 3985, "pr_title": "[Doris On ES] [Bug-Fix][Refactor] Fix potential null pointer exception and refactor function process logic", "pr_createdAt": "2020-06-30T05:47:01Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3985", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQyOTcxOQ==", "url": "https://github.com/apache/incubator-doris/pull/3985#discussion_r447429719", "bodyText": "\u5224\u65ad\u4e0b conjunt->children_size()?\n\u6211\u770b\u540e\u9762\u5f88\u591a\u76f4\u63a5\u53d6index\u7684\u3002", "author": "blackfox1983", "createdAt": "2020-06-30T06:03:16Z", "path": "be/src/exec/es/es_predicate.cpp", "diffHunk": "@@ -283,93 +283,91 @@ Status EsPredicate::build_disjuncts_list(const Expr* conjunct) {\n         _disjuncts.push_back(predicate);\n         return Status::OK();\n     }\n-    \n-    if (is_match_func(conjunct)) {\n-        Expr* expr = conjunct->get_child(1);\n-        ExtLiteral literal(expr->type().type, _context->get_value(expr, NULL));\n-        vector<ExtLiteral> query_conditions;\n-        query_conditions.emplace_back(literal);\n-        vector<ExtColumnDesc> cols; //TODO\n-        ExtPredicate* predicate = new ExtFunction(\n-                        TExprNodeType::FUNCTION_CALL,\n-                        conjunct->fn().name.function_name,\n-                        cols,\n-                        query_conditions);\n-        if (_es_query_status.ok()) {\n-            _es_query_status \n-                = BooleanQueryBuilder::check_es_query(*(ExtFunction *)predicate); \n-            if (!_es_query_status.ok()) {\n-                delete predicate;\n-                return _es_query_status;\n-            }\n-        }\n-        _disjuncts.push_back(predicate);\n-\n-        return Status::OK();\n-    }\n-\n-    if (TExprNodeType::FUNCTION_CALL == conjunct->node_type()\n-        && (conjunct->fn().name.function_name == \"is_null_pred\" || conjunct->fn().name.function_name == \"is_not_null_pred\")) {\n-        // such as sub-query: select * from (select split_part(k, \"_\", 1) as new_field from case_replay_for_milimin) t where t.new_field > 1;\n-        // conjunct->get_child(0)->node_type() == TExprNodeType::FUNCTION_CALL, at present doris on es can not support push down function \n-        RETURN_ERROR_IF_EXPR_IS_NOT_SLOTREF(conjunct->get_child(0));\n-        SlotRef* slot_ref = (SlotRef*)(conjunct->get_child(0));\n-        const SlotDescriptor* slot_desc = get_slot_desc(slot_ref);\n-        bool is_not_null;\n-        if (conjunct->fn().name.function_name == \"is_null_pred\") {\n-            is_not_null = false;\n-        } else {\n-            is_not_null = true;\n-        }\n-        std::string col = slot_desc->col_name();\n-        if (_field_context.find(col) != _field_context.end()) {\n-            col = _field_context[col];\n-        }\n-        // use TExprNodeType::IS_NULL_PRED for BooleanQueryBuilder translate\n-        ExtIsNullPredicate* predicate = new ExtIsNullPredicate(TExprNodeType::IS_NULL_PRED, col, slot_desc->type(), is_not_null);\n-        _disjuncts.push_back(predicate);\n-        return Status::OK();\n-    }\n-\n+    // process function call predicate: esquery, is_null_pred, is_not_null_pred\n     if (TExprNodeType::FUNCTION_CALL == conjunct->node_type()) {\n         std::string fname = conjunct->fn().name.function_name;\n-        if (fname != \"like\") {\n-            return Status::InternalError(\"build disjuncts failed: function name is not like\");\n-        }\n+        if (fname == \"esquery\") {\n+            Expr* expr = conjunct->get_child(1);", "originalCommit": "e54f060cfbb609f251ddb21fcf8cffeb5672bef0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a94c1a9173827926c6e9a357754eaf72d589249a", "url": "https://github.com/apache/incubator-doris/commit/a94c1a9173827926c6e9a357754eaf72d589249a", "message": "[Doris On ES] fix potential null pointer exception and refactor some code", "committedDate": "2020-07-02T08:16:43Z", "type": "commit"}, {"oid": "033e3c8bc829157463f63b5a1593591956e13c5a", "url": "https://github.com/apache/incubator-doris/commit/033e3c8bc829157463f63b5a1593591956e13c5a", "message": "[Doris On ES] fix potential null pointer exception and refactor some code", "committedDate": "2020-07-02T08:16:43Z", "type": "commit"}, {"oid": "033e3c8bc829157463f63b5a1593591956e13c5a", "url": "https://github.com/apache/incubator-doris/commit/033e3c8bc829157463f63b5a1593591956e13c5a", "message": "[Doris On ES] fix potential null pointer exception and refactor some code", "committedDate": "2020-07-02T08:16:43Z", "type": "forcePushed"}]}