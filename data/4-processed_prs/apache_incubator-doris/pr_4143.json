{"pr_number": 4143, "pr_title": "Fix alter schema add key column bug in agg model", "pr_createdAt": "2020-07-22T10:36:58Z", "pr_url": "https://github.com/apache/incubator-doris/pull/4143", "timeline": [{"oid": "c0b1f87e752b41ef7be203e4a2e3c0f662105eeb", "url": "https://github.com/apache/incubator-doris/commit/c0b1f87e752b41ef7be203e4a2e3c0f662105eeb", "message": "Fix alter schema add key column bug in agg module", "committedDate": "2020-07-22T09:42:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE3ODUwOQ==", "url": "https://github.com/apache/incubator-doris/pull/4143#discussion_r459178509", "bodyText": "this will disable all linked schema in when add key column in agg table, try some better way", "author": "yangzhg", "createdAt": "2020-07-23T02:02:01Z", "path": "be/src/olap/schema_change.cpp", "diffHunk": "@@ -2111,6 +2111,11 @@ OLAPStatus SchemaChangeHandler::_parse_request(TabletSharedPtr base_tablet,\n     for (size_t i = 0; i < new_tablet->num_columns(); ++i) {\n         ColumnMapping* column_mapping = rb_changer->get_mutable_column_mapping(i);\n         if (column_mapping->ref_column < 0) {\n+            // check agg model, add key-column operation use sc_directly to build index\n+            if (new_tablet_schema.keys_type() == AGG_KEYS && new_tablet_schema.column(i).is_key()) {\n+                *sc_directly = true;\n+                return OLAP_SUCCESS;\n+            }", "originalCommit": "c0b1f87e752b41ef7be203e4a2e3c0f662105eeb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f741397d85903adedf8c2ed10054325abf0a02a0", "url": "https://github.com/apache/incubator-doris/commit/f741397d85903adedf8c2ed10054325abf0a02a0", "message": "Fix alter schema add key column bug in agg model", "committedDate": "2020-07-24T02:51:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgzMTM2NA==", "url": "https://github.com/apache/incubator-doris/pull/4143#discussion_r459831364", "bodyText": "better to make this comment more readable", "author": "yangzhg", "createdAt": "2020-07-24T03:04:37Z", "path": "be/src/olap/rowset/segment_group.cpp", "diffHunk": "@@ -268,11 +265,14 @@ OLAPStatus SegmentGroup::add_zone_maps_for_linked_schema_change(\n         WrapperField* second = WrapperField::create(column);\n         DCHECK(second != NULL) << \"failed to allocate memory for field: \" << i;\n \n-        if (schema_mapping[i].ref_column == -1) {\n+        // add column also can add zone map index", "originalCommit": "f741397d85903adedf8c2ed10054325abf0a02a0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgzMjQyOA==", "url": "https://github.com/apache/incubator-doris/pull/4143#discussion_r459832428", "bodyText": "if you set it to default value\uff0c in duplicated table update from 0.11 to 0.12 may cause value clumn filtered unexpected", "author": "yangzhg", "createdAt": "2020-07-24T03:10:04Z", "path": "be/src/olap/rowset/segment_group.cpp", "diffHunk": "@@ -268,11 +265,14 @@ OLAPStatus SegmentGroup::add_zone_maps_for_linked_schema_change(\n         WrapperField* second = WrapperField::create(column);\n         DCHECK(second != NULL) << \"failed to allocate memory for field: \" << i;\n \n-        if (schema_mapping[i].ref_column == -1) {\n+        // add column also can add zone map index\n+        if (schema_mapping[i].ref_column == -1 || i >= zone_map_fields.size()) {\n             // ref_column == -1 means this is a new column.\n             // for new column, use default value to fill into column_statistics\n-            first->copy(schema_mapping[i].default_value);\n-            second->copy(schema_mapping[i].default_value);\n+            if (schema_mapping[i].default_value != nullptr) {", "originalCommit": "f741397d85903adedf8c2ed10054325abf0a02a0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "21670207f3c86dfe592f48bf5ab630bb6d6080ba", "url": "https://github.com/apache/incubator-doris/commit/21670207f3c86dfe592f48bf5ab630bb6d6080ba", "message": "Fix alter schema add key column bug in agg model", "committedDate": "2020-07-24T04:30:55Z", "type": "commit"}]}