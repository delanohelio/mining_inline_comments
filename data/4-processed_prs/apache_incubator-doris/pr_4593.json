{"pr_number": 4593, "pr_title": "[Bug] Fix bug of cumulative compaction and deletion of stale version", "pr_createdAt": "2020-09-12T14:21:45Z", "pr_url": "https://github.com/apache/incubator-doris/pull/4593", "timeline": [{"oid": "1f02d1b4c840074389e0766f7af231c662fd2d16", "url": "https://github.com/apache/incubator-doris/commit/1f02d1b4c840074389e0766f7af231c662fd2d16", "message": "[Bug] Fix bug of cumulative compaction and deletion of stale version\n\nWhen selecting candicate rowsets to do the cumulative compaction,\nsome rowsets may not be selected because the protection time has not expired.\nTherefore, we need to find the current longest continuous version path in the candicate rowsets.", "committedDate": "2020-09-12T14:17:01Z", "type": "commit"}, {"oid": "9b66841b330a03a7053e8e90f08d96487773bb8a", "url": "https://github.com/apache/incubator-doris/commit/9b66841b330a03a7053e8e90f08d96487773bb8a", "message": "add ut", "committedDate": "2020-09-12T15:00:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM1Mjg4Mw==", "url": "https://github.com/apache/incubator-doris/pull/4593#discussion_r504352883", "bodyText": "Is it appropriate to print the warning log here?\nI think this function only deals with specific logic, and the caller can decide whether to print the log. This allows this function to be used in more scenarios.", "author": "imay", "createdAt": "2020-10-14T01:48:57Z", "path": "be/src/olap/compaction.cpp", "diffHunk": "@@ -181,6 +181,30 @@ OLAPStatus Compaction::gc_unused_rowsets() {\n     return OLAP_SUCCESS;\n }\n \n+// find the longest consecutive version path in \"rowset\", from begining.\n+OLAPStatus Compaction::find_longest_consecutive_version(vector<RowsetSharedPtr>* rowsets) {\n+    if (rowsets->empty()) {\n+        return OLAP_SUCCESS;\n+    }\n+    RowsetSharedPtr prev_rowset = rowsets->front();\n+    size_t i = 1;\n+    for (; i < rowsets->size(); ++i) {\n+        RowsetSharedPtr rowset = (*rowsets)[i];\n+        if (rowset->start_version() != prev_rowset->end_version() + 1) {\n+            LOG(WARNING) << \"There are missed versions among rowsets. \"", "originalCommit": "9b66841b330a03a7053e8e90f08d96487773bb8a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQ4NDY4Nw==", "url": "https://github.com/apache/incubator-doris/pull/4593#discussion_r506484687", "bodyText": "Done", "author": "morningman", "createdAt": "2020-10-16T14:28:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDM1Mjg4Mw=="}], "type": "inlineReview"}, {"oid": "5470d315a0b73f92b14eaa4942cd931f604e8b8a", "url": "https://github.com/apache/incubator-doris/commit/5470d315a0b73f92b14eaa4942cd931f604e8b8a", "message": "modify log", "committedDate": "2020-10-16T14:27:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc4Nzg2Nw==", "url": "https://github.com/apache/incubator-doris/pull/4593#discussion_r506787867", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (missing_versions.empty()) {\n          \n          \n            \n                if (!missing_versions.empty()) {", "author": "imay", "createdAt": "2020-10-17T03:25:15Z", "path": "be/src/olap/cumulative_compaction.cpp", "diffHunk": "@@ -83,7 +83,18 @@ OLAPStatus CumulativeCompaction::pick_rowsets_to_compact() {\n         return OLAP_ERR_CUMULATIVE_NO_SUITABLE_VERSIONS;\n     }\n \n-    RETURN_NOT_OK(check_version_continuity(candidate_rowsets));\n+    // candidate_rowsets may not be continuous. Because some rowset may not be selected\n+    // because the protection time has not expired(config::cumulative_compaction_skip_window_seconds).\n+    // So we need to choose the longest continuous path from it.\n+    std::vector<Version> missing_versions;\n+    RETURN_NOT_OK(find_longest_consecutive_version(&candidate_rowsets, &missing_versions));\n+    if (missing_versions.empty()) {", "originalCommit": "5470d315a0b73f92b14eaa4942cd931f604e8b8a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "019f047709f8cf8f584ef2bea2df08179d16bbc1", "url": "https://github.com/apache/incubator-doris/commit/019f047709f8cf8f584ef2bea2df08179d16bbc1", "message": "Update be/src/olap/cumulative_compaction.cpp\n\nCo-authored-by: Zhao Chun <buaa.zhaoc@gmail.com>", "committedDate": "2020-10-20T01:42:51Z", "type": "commit"}]}