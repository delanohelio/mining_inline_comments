{"pr_number": 3260, "pr_title": "[Storage] open data dirs parallelly", "pr_createdAt": "2020-04-03T09:07:28Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3260", "timeline": [{"oid": "43399e996dacbaa153cf79301265c2e35b177d57", "url": "https://github.com/apache/incubator-doris/commit/43399e996dacbaa153cf79301265c2e35b177d57", "message": "parallel open data dir", "committedDate": "2020-04-03T08:31:27Z", "type": "commit"}, {"oid": "6118dbfbe80e7f4883b6c93070f1ee7130fb19fa", "url": "https://github.com/apache/incubator-doris/commit/6118dbfbe80e7f4883b6c93070f1ee7130fb19fa", "message": "fix", "committedDate": "2020-04-03T08:56:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk2MjY5MQ==", "url": "https://github.com/apache/incubator-doris/pull/3260#discussion_r402962691", "bodyText": "Try to avoid using exceptions\nShould join all other threads before delete store, otherwise exceptions are prone to occur", "author": "imay", "createdAt": "2020-04-03T12:15:58Z", "path": "be/src/olap/storage_engine.cpp", "diffHunk": "@@ -148,16 +148,33 @@ void StorageEngine::load_data_dirs(const std::vector<DataDir*>& data_dirs) {\n \n OLAPStatus StorageEngine::_open() {\n     // init store_map\n+    std::vector<std::pair<DataDir*,std::future<Status>>> tmp_vec;\n     for (auto& path : _options.store_paths) {\n+        LOG(INFO) << \"store_path \" << path.path;\n         DataDir* store = new DataDir(path.path, path.capacity_bytes, path.storage_medium,\n                                      _tablet_manager.get(), _txn_manager.get());\n-        auto st = store->init();\n-        if (!st.ok()) {\n-            LOG(WARNING) << \"Store load failed, path=\" << path.path;\n-            return OLAP_ERR_INVALID_ROOT_PATH;\n+        tmp_vec.emplace_back(std::make_pair(store,std::async([store](){ return store->init();})));\n+    }\n+\n+    try {\n+        for (auto& pair : tmp_vec) {\n+            DataDir* store = pair.first;\n+            auto st = pair.second.get();\n+            if (!st.ok()) {\n+                throw std::runtime_error(\"Store load failed, path=\" + store->path());", "originalCommit": "6118dbfbe80e7f4883b6c93070f1ee7130fb19fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQwNzM0MA==", "url": "https://github.com/apache/incubator-doris/pull/3260#discussion_r403407340", "bodyText": "Yes, I forgot it's not safe to delete stores in catch block.\nI think using exception in the phase of storage initialization should be no problem. But we should wait all threads finished, so catching exceptions can't make the code clean.\nSo I will modify the code like\nstd::vector<status> sts;\nstd::vector<std::thread> threads;\nfor dir in data dirs:\n    threads.emplace_back([&sts[i],dir](){ sts[i}=dir->init() });\nfor_each(threads, [](t){ t.join();})\nfor st in sts:\n    if(st.ok()) { ... }\n    else { init_error=true; break; }\nif(init_error) { \n    // clean up\n    return error;\n}", "author": "vagetablechicken", "createdAt": "2020-04-04T01:47:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk2MjY5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQwNzk5Nw==", "url": "https://github.com/apache/incubator-doris/pull/3260#discussion_r403407997", "bodyText": "Looks good for me. Should log detail error message in lambda.", "author": "imay", "createdAt": "2020-04-04T01:52:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk2MjY5MQ=="}], "type": "inlineReview"}, {"oid": "2b49c9cda542f8b4a0e1ac988340412b386dd468", "url": "https://github.com/apache/incubator-doris/commit/2b49c9cda542f8b4a0e1ac988340412b386dd468", "message": "use threads", "committedDate": "2020-04-07T04:05:39Z", "type": "commit"}, {"oid": "5eb1a6cf23a7e47815fdfc8fc501fa24e525a16b", "url": "https://github.com/apache/incubator-doris/commit/5eb1a6cf23a7e47815fdfc8fc501fa24e525a16b", "message": "fix", "committedDate": "2020-04-07T04:09:17Z", "type": "commit"}, {"oid": "3f87375c95c8418d01d215fda59ad23e1c53c296", "url": "https://github.com/apache/incubator-doris/commit/3f87375c95c8418d01d215fda59ad23e1c53c296", "message": "fix name", "committedDate": "2020-04-07T05:23:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYwNDg2OQ==", "url": "https://github.com/apache/incubator-doris/pull/3260#discussion_r404604869", "bodyText": "should print st.to_string() too.", "author": "imay", "createdAt": "2020-04-07T07:47:52Z", "path": "be/src/olap/storage_engine.cpp", "diffHunk": "@@ -185,6 +177,39 @@ OLAPStatus StorageEngine::_open() {\n     return OLAP_SUCCESS;\n }\n \n+OLAPStatus StorageEngine::_init_store_map() {\n+    std::vector < std::pair<DataDir*> tmp_stores;\n+    std::vector<std::thread> threads;\n+    std::atomic<bool> init_error{false};\n+    for (auto& path : _options.store_paths) {\n+        DataDir* store = new DataDir(path.path, path.capacity_bytes, path.storage_medium,\n+                                     _tablet_manager.get(), _txn_manager.get());\n+        tmp_stores.emplace_back(store);\n+        threads.emplace_back([store, &init_error]() {\n+            auto st = store->init();\n+            if (!st.ok()) {\n+                init_error = true;\n+                LOG(WARNING) << \"Store load failed, path=\" << store->path();", "originalCommit": "3f87375c95c8418d01d215fda59ad23e1c53c296", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYwNTQ1Mw==", "url": "https://github.com/apache/incubator-doris/pull/3260#discussion_r404605453", "bodyText": "???\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                std::vector < std::pair<DataDir*> tmp_stores;\n          \n          \n            \n                std::vector<DataDir*> tmp_stores;", "author": "imay", "createdAt": "2020-04-07T07:48:51Z", "path": "be/src/olap/storage_engine.cpp", "diffHunk": "@@ -185,6 +177,39 @@ OLAPStatus StorageEngine::_open() {\n     return OLAP_SUCCESS;\n }\n \n+OLAPStatus StorageEngine::_init_store_map() {\n+    std::vector < std::pair<DataDir*> tmp_stores;", "originalCommit": "3f87375c95c8418d01d215fda59ad23e1c53c296", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYxODUwOA==", "url": "https://github.com/apache/incubator-doris/pull/3260#discussion_r404618508", "bodyText": "cherry-pick mistake \ud83d\ude13\nWhen can we have a look at CI output? It will be enormously helpful.", "author": "vagetablechicken", "createdAt": "2020-04-07T08:10:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYwNTQ1Mw=="}], "type": "inlineReview"}, {"oid": "08788c3a1d0f84847bdb38c2a28975781f5cb80b", "url": "https://github.com/apache/incubator-doris/commit/08788c3a1d0f84847bdb38c2a28975781f5cb80b", "message": "fix", "committedDate": "2020-04-07T08:12:42Z", "type": "commit"}]}