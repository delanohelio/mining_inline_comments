{"pr_number": 4964, "pr_title": "[Bug][Compaction] Fix bug that output rowset is not deleted after compaction failure.", "pr_createdAt": "2020-11-26T08:54:28Z", "pr_url": "https://github.com/apache/incubator-doris/pull/4964", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAzNjY0OQ==", "url": "https://github.com/apache/incubator-doris/pull/4964#discussion_r531036649", "bodyText": "Hi, is it compatible with segment v1?\nIn alpha_rowset_reader.h, filtered_rows() only calculates rows_del_filtered.", "author": "xy720", "createdAt": "2020-11-26T13:41:05Z", "path": "be/src/olap/reader.h", "diffHunk": "@@ -128,7 +128,7 @@ class Reader {\n     }\n \n     uint64_t filtered_rows() const {\n-        return _stats.rows_del_filtered;", "originalCommit": "ec5186be8fb6ed789dce4c1a27923efe7da108c3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM1MjM1Mw==", "url": "https://github.com/apache/incubator-doris/pull/4964#discussion_r531352353", "bodyText": "Yes, it is compatible. Because rows_conditions_filtered is only used for SegmentV2, so it should always to 0 in Segment V1.", "author": "morningman", "createdAt": "2020-11-27T02:31:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAzNjY0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQ5NDUzOQ==", "url": "https://github.com/apache/incubator-doris/pull/4964#discussion_r531494539", "bodyText": "why not call gc_output_rowset in every succeed? It seems a new imported bug ?", "author": "chaoyli", "createdAt": "2020-11-27T09:54:36Z", "path": "be/src/olap/compaction.cpp", "diffHunk": "@@ -164,17 +173,11 @@ void Compaction::modify_rowsets() {\n     _tablet->save_meta();\n }\n \n-OLAPStatus Compaction::gc_unused_rowsets() {\n+void Compaction::gc_output_rowset() {", "originalCommit": "ec5186be8fb6ed789dce4c1a27923efe7da108c3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTgyNzE5NA==", "url": "https://github.com/apache/incubator-doris/pull/4964#discussion_r531827194", "bodyText": "gc_output_rowset() should only be called when compaction succeed.\nIn #4212, we have implemented a new compaction logic, so that the input rowset will be deleted later. And we only need to delete the output rowset when failed.", "author": "morningman", "createdAt": "2020-11-28T03:10:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQ5NDUzOQ=="}], "type": "inlineReview"}, {"oid": "8ea8fa53017e5e8cf447dc87a17fe6fd3a9a1a3f", "url": "https://github.com/apache/incubator-doris/commit/8ea8fa53017e5e8cf447dc87a17fe6fd3a9a1a3f", "message": "rebase", "committedDate": "2020-11-30T06:18:37Z", "type": "commit"}, {"oid": "8ea8fa53017e5e8cf447dc87a17fe6fd3a9a1a3f", "url": "https://github.com/apache/incubator-doris/commit/8ea8fa53017e5e8cf447dc87a17fe6fd3a9a1a3f", "message": "rebase", "committedDate": "2020-11-30T06:18:37Z", "type": "forcePushed"}]}