{"pr_number": 5104, "pr_title": "[Enhancement]Make Cholocate table join more load balance", "pr_createdAt": "2020-12-17T08:08:36Z", "pr_url": "https://github.com/apache/incubator-doris/pull/5104", "timeline": [{"oid": "1a15f533098eec6708121004ef835d111dc374f3", "url": "https://github.com/apache/incubator-doris/commit/1a15f533098eec6708121004ef835d111dc374f3", "message": "udf: replace function", "committedDate": "2020-08-13T14:09:31Z", "type": "commit"}, {"oid": "7d072b9a65d555e7e710cb5140435e00a8ff7bdc", "url": "https://github.com/apache/incubator-doris/commit/7d072b9a65d555e7e710cb5140435e00a8ff7bdc", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-08-14T01:37:05Z", "type": "commit"}, {"oid": "391158f52190755b5fc621c31bf703835c0a7b3b", "url": "https://github.com/apache/incubator-doris/commit/391158f52190755b5fc621c31bf703835c0a7b3b", "message": "udf: replace function", "committedDate": "2020-08-14T02:11:25Z", "type": "commit"}, {"oid": "5eb52e1e5742d2e9f7aae5ac8da81545ae5f3df2", "url": "https://github.com/apache/incubator-doris/commit/5eb52e1e5742d2e9f7aae5ac8da81545ae5f3df2", "message": "udf: replace function", "committedDate": "2020-08-14T03:58:30Z", "type": "commit"}, {"oid": "a79ea91cf36eec54a4ca54018b92a6fa4baa98cc", "url": "https://github.com/apache/incubator-doris/commit/a79ea91cf36eec54a4ca54018b92a6fa4baa98cc", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-08-18T02:31:52Z", "type": "commit"}, {"oid": "86f841f29fa4ee19773d6c5922465194a2887cf6", "url": "https://github.com/apache/incubator-doris/commit/86f841f29fa4ee19773d6c5922465194a2887cf6", "message": "udf: replace function", "committedDate": "2020-08-18T03:56:14Z", "type": "commit"}, {"oid": "ade1afa75c94a178a6801ba1324acf25ad8b16fe", "url": "https://github.com/apache/incubator-doris/commit/ade1afa75c94a178a6801ba1324acf25ad8b16fe", "message": "udf: replace function", "committedDate": "2020-08-18T03:59:59Z", "type": "commit"}, {"oid": "1d95a491115064c9753694ad4d45c2f72b8d2645", "url": "https://github.com/apache/incubator-doris/commit/1d95a491115064c9753694ad4d45c2f72b8d2645", "message": "udf: replace function", "committedDate": "2020-08-18T08:01:45Z", "type": "commit"}, {"oid": "433eb87f02cfa6740e80b0e4157d916ab5aca400", "url": "https://github.com/apache/incubator-doris/commit/433eb87f02cfa6740e80b0e4157d916ab5aca400", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-08-24T02:03:34Z", "type": "commit"}, {"oid": "c62d239792b174fbc56ab311f0bc5337de971d96", "url": "https://github.com/apache/incubator-doris/commit/c62d239792b174fbc56ab311f0bc5337de971d96", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-08-25T03:17:32Z", "type": "commit"}, {"oid": "0a8db8cc4e7e72ebad4491a2cd48c758a435ba5c", "url": "https://github.com/apache/incubator-doris/commit/0a8db8cc4e7e72ebad4491a2cd48c758a435ba5c", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-08-25T08:21:34Z", "type": "commit"}, {"oid": "02d3f863c8556463c8dea903abdc4d21bf1eb19b", "url": "https://github.com/apache/incubator-doris/commit/02d3f863c8556463c8dea903abdc4d21bf1eb19b", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-09-01T01:25:42Z", "type": "commit"}, {"oid": "41da0ba0109414c47239f3fb926da48540059018", "url": "https://github.com/apache/incubator-doris/commit/41da0ba0109414c47239f3fb926da48540059018", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-09-08T08:25:12Z", "type": "commit"}, {"oid": "de4e523b505f0d628a16199b88d4bb5a0419fef6", "url": "https://github.com/apache/incubator-doris/commit/de4e523b505f0d628a16199b88d4bb5a0419fef6", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-09-11T02:42:20Z", "type": "commit"}, {"oid": "a863b0dfc7f909bf1ca8ad176ef8f82b1346924f", "url": "https://github.com/apache/incubator-doris/commit/a863b0dfc7f909bf1ca8ad176ef8f82b1346924f", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-09-17T09:37:21Z", "type": "commit"}, {"oid": "024c422b74829efe4c4b715a014517c7eee1a80a", "url": "https://github.com/apache/incubator-doris/commit/024c422b74829efe4c4b715a014517c7eee1a80a", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-09-22T09:15:31Z", "type": "commit"}, {"oid": "e1656c7a8bdc137261505d8b384dddb1c9bf5a72", "url": "https://github.com/apache/incubator-doris/commit/e1656c7a8bdc137261505d8b384dddb1c9bf5a72", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-09-23T11:48:49Z", "type": "commit"}, {"oid": "837e037057936e933fd79cbbdb432047be2bba5e", "url": "https://github.com/apache/incubator-doris/commit/837e037057936e933fd79cbbdb432047be2bba5e", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-09-27T06:37:32Z", "type": "commit"}, {"oid": "a36d3e78136a3fefb62f2513d20773479904cb6b", "url": "https://github.com/apache/incubator-doris/commit/a36d3e78136a3fefb62f2513d20773479904cb6b", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-10-17T10:32:25Z", "type": "commit"}, {"oid": "43cfa2b2ca752118c43a0212cf074f09cb311a7a", "url": "https://github.com/apache/incubator-doris/commit/43cfa2b2ca752118c43a0212cf074f09cb311a7a", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-10-23T14:34:47Z", "type": "commit"}, {"oid": "641efb587d2e9ac9a9e9771e7648a299a66f3992", "url": "https://github.com/apache/incubator-doris/commit/641efb587d2e9ac9a9e9771e7648a299a66f3992", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-10-24T12:49:28Z", "type": "commit"}, {"oid": "5066131b9017910473554dfa298b16224c1977da", "url": "https://github.com/apache/incubator-doris/commit/5066131b9017910473554dfa298b16224c1977da", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-10-26T11:49:19Z", "type": "commit"}, {"oid": "dde044ba251c85b7f0a8a388af71331553208a05", "url": "https://github.com/apache/incubator-doris/commit/dde044ba251c85b7f0a8a388af71331553208a05", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-10-27T08:38:35Z", "type": "commit"}, {"oid": "8f8c8234c052720bc65e316a305a3297318bd481", "url": "https://github.com/apache/incubator-doris/commit/8f8c8234c052720bc65e316a305a3297318bd481", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-10-28T07:25:25Z", "type": "commit"}, {"oid": "f7704ba989ab5b903e407f7b02c5a9b6c03b4588", "url": "https://github.com/apache/incubator-doris/commit/f7704ba989ab5b903e407f7b02c5a9b6c03b4588", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-11-01T13:04:30Z", "type": "commit"}, {"oid": "8726e7aefed64e62b1bbf6f56278274f11c8b0fa", "url": "https://github.com/apache/incubator-doris/commit/8726e7aefed64e62b1bbf6f56278274f11c8b0fa", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-11-04T09:31:42Z", "type": "commit"}, {"oid": "4dfc785c8a97549fb9c38b6dd8ea938d1bb50db4", "url": "https://github.com/apache/incubator-doris/commit/4dfc785c8a97549fb9c38b6dd8ea938d1bb50db4", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-11-06T07:45:49Z", "type": "commit"}, {"oid": "d4bd91c17af4b4954b2715c5fd93cf86b7351085", "url": "https://github.com/apache/incubator-doris/commit/d4bd91c17af4b4954b2715c5fd93cf86b7351085", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-11-11T02:13:02Z", "type": "commit"}, {"oid": "2eb8ddf66fb0ffbeaab0e882a5d33483180da351", "url": "https://github.com/apache/incubator-doris/commit/2eb8ddf66fb0ffbeaab0e882a5d33483180da351", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-11-12T02:49:53Z", "type": "commit"}, {"oid": "5aa7afc57d6cbeb2013a6e8957f214f7abc93e7f", "url": "https://github.com/apache/incubator-doris/commit/5aa7afc57d6cbeb2013a6e8957f214f7abc93e7f", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-11-14T11:19:03Z", "type": "commit"}, {"oid": "ce251b26af3feb6aa49e5e31bee887b0441e8584", "url": "https://github.com/apache/incubator-doris/commit/ce251b26af3feb6aa49e5e31bee887b0441e8584", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-11-17T03:43:59Z", "type": "commit"}, {"oid": "04c58994a066d51dcaf84657d04a2d6281bf8371", "url": "https://github.com/apache/incubator-doris/commit/04c58994a066d51dcaf84657d04a2d6281bf8371", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-11-18T10:41:11Z", "type": "commit"}, {"oid": "2e614cf89862a62ccadf96bcc9f94034ebc3a214", "url": "https://github.com/apache/incubator-doris/commit/2e614cf89862a62ccadf96bcc9f94034ebc3a214", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-11-24T08:52:28Z", "type": "commit"}, {"oid": "ede2e000c0fe30022d1dd417f08deb2a4e1c95da", "url": "https://github.com/apache/incubator-doris/commit/ede2e000c0fe30022d1dd417f08deb2a4e1c95da", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-11-25T03:23:03Z", "type": "commit"}, {"oid": "0aed91fed8b786d2e9860fc5ca0fad95b6810d75", "url": "https://github.com/apache/incubator-doris/commit/0aed91fed8b786d2e9860fc5ca0fad95b6810d75", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-11-26T09:50:24Z", "type": "commit"}, {"oid": "bd28b736375ece74d76527fa8319c4264356427c", "url": "https://github.com/apache/incubator-doris/commit/bd28b736375ece74d76527fa8319c4264356427c", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-11-30T02:30:06Z", "type": "commit"}, {"oid": "e56e17d3bdd29fdb4018444609740efd2d01e6bc", "url": "https://github.com/apache/incubator-doris/commit/e56e17d3bdd29fdb4018444609740efd2d01e6bc", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-12-10T02:00:09Z", "type": "commit"}, {"oid": "7d5d011ec036f63ba570e4645176820ca36e6fa8", "url": "https://github.com/apache/incubator-doris/commit/7d5d011ec036f63ba570e4645176820ca36e6fa8", "message": "Merge remote-tracking branch 'upstream/master' into str_replace", "committedDate": "2020-12-17T02:30:07Z", "type": "commit"}, {"oid": "57d8b4e9e40164b5048b27a95a04c26ac82958f9", "url": "https://github.com/apache/incubator-doris/commit/57d8b4e9e40164b5048b27a95a04c26ac82958f9", "message": "make buket join balance", "committedDate": "2020-12-17T03:53:39Z", "type": "commit"}, {"oid": "aa6aba9853ee555a70ba6cd78754de43f742d802", "url": "https://github.com/apache/incubator-doris/commit/aa6aba9853ee555a70ba6cd78754de43f742d802", "message": "make buket join balance", "committedDate": "2020-12-17T03:56:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU0OTcxMA==", "url": "https://github.com/apache/incubator-doris/pull/5104#discussion_r549549710", "bodyText": "Please update the old comment", "author": "kangkaisen", "createdAt": "2020-12-29T02:54:49Z", "path": "fe/fe-core/src/main/java/org/apache/doris/qe/Coordinator.java", "diffHunk": "@@ -1276,10 +1276,22 @@ private void computeScanRangeAssignmentByColocate(\n     }\n \n     // randomly choose a backend from the TScanRangeLocations for a certain bucket sequence.", "originalCommit": "aa6aba9853ee555a70ba6cd78754de43f742d802", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU1MDA4Mw==", "url": "https://github.com/apache/incubator-doris/pull/5104#discussion_r549550083", "bodyText": "These codes are also used in computeScanRangeAssignmentByScheduler, would better abstract these codes to a method\n            Long minAssignedBytes = Long.MAX_VALUE;\n            TScanRangeLocation minLocation = null;\n            for (final TScanRangeLocation location : scanRangeLocations.getLocations()) {\n                Long assignedBytes = findOrInsert(assignedBytesPerHost, location.server, 0L);\n                if (assignedBytes < minAssignedBytes) {\n                    minAssignedBytes = assignedBytes;\n                    minLocation = location;\n                }\n            }", "author": "kangkaisen", "createdAt": "2020-12-29T02:56:47Z", "path": "fe/fe-core/src/main/java/org/apache/doris/qe/Coordinator.java", "diffHunk": "@@ -1276,10 +1276,22 @@ private void computeScanRangeAssignmentByColocate(\n     }\n \n     // randomly choose a backend from the TScanRangeLocations for a certain bucket sequence.\n-    private void getExecHostPortForFragmentIDAndBucketSeq(TScanRangeLocations seqLocation, PlanFragmentId fragmentId, Integer bucketSeq) throws Exception {\n-        int randomLocation = new Random().nextInt(seqLocation.locations.size());\n+    private void getExecHostPortForFragmentIDAndBucketSeq(TScanRangeLocations seqLocation, PlanFragmentId fragmentId, Integer bucketSeq,\n+                                                          HashMap<TNetworkAddress, Long> assignedBytesPerHost) throws Exception {\n+        Long minAssignedBytes = Long.MAX_VALUE;", "originalCommit": "aa6aba9853ee555a70ba6cd78754de43f742d802", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTYyOTM1NQ==", "url": "https://github.com/apache/incubator-doris/pull/5104#discussion_r549629355", "bodyText": "Thanks for your code review. The code has been improved.", "author": "xinghuayu007", "createdAt": "2020-12-29T09:15:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU1MDA4Mw=="}], "type": "inlineReview"}, {"oid": "b3819fb6639599cdef5258c4c8ddd58ab23cc634", "url": "https://github.com/apache/incubator-doris/commit/b3819fb6639599cdef5258c4c8ddd58ab23cc634", "message": "abstract get host function", "committedDate": "2020-12-29T09:11:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY0NTczNw==", "url": "https://github.com/apache/incubator-doris/pull/5104#discussion_r549645737", "bodyText": "Why add this method?  The diff between getLocation and getHost is first arg, but we could get long backendId from TScanRangeLocation minLocation?", "author": "kangkaisen", "createdAt": "2020-12-29T10:06:46Z", "path": "fe/fe-core/src/main/java/org/apache/doris/qe/SimpleScheduler.java", "diffHunk": "@@ -92,6 +92,38 @@ public static TNetworkAddress getHost(long backendId,\n                         backends, locations.size()));\n     }\n \n+    public static TScanRangeLocation getLocation(TScanRangeLocation minLocation,", "originalCommit": "b3819fb6639599cdef5258c4c8ddd58ab23cc634", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY1MTU0NA==", "url": "https://github.com/apache/incubator-doris/pull/5104#discussion_r549651544", "bodyText": "Because function computeScanRangeAssignmentByScheduler need minLocation to set volume_id. Therefore it must return param minLocation\n// Volume is optional, so we need to set the value and the is-set bit\nscanRangeParams.setVolumeId(minLocation.volume_id);", "author": "xinghuayu007", "createdAt": "2020-12-29T10:25:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY0NTczNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY0NjY1NQ==", "url": "https://github.com/apache/incubator-doris/pull/5104#discussion_r549646655", "bodyText": "I think we need a more concrete name. Such as selectBackendsByRoundRobin", "author": "kangkaisen", "createdAt": "2020-12-29T10:09:18Z", "path": "fe/fe-core/src/main/java/org/apache/doris/qe/Coordinator.java", "diffHunk": "@@ -1275,15 +1275,40 @@ private void computeScanRangeAssignmentByColocate(\n         }\n     }\n \n-    // randomly choose a backend from the TScanRangeLocations for a certain bucket sequence.\n-    private void getExecHostPortForFragmentIDAndBucketSeq(TScanRangeLocations seqLocation, PlanFragmentId fragmentId, Integer bucketSeq) throws Exception {\n-        int randomLocation = new Random().nextInt(seqLocation.locations.size());\n+    //ensure bucket sequence distribued to every host evenly\n+    private void getExecHostPortForFragmentIDAndBucketSeq(TScanRangeLocations seqLocation, PlanFragmentId fragmentId, Integer bucketSeq,\n+                                                          HashMap<TNetworkAddress, Long> assignedBytesPerHost) throws Exception {\n         Reference<Long> backendIdRef = new Reference<Long>();\n-        TNetworkAddress execHostPort = SimpleScheduler.getHost(seqLocation.locations.get(randomLocation).backend_id, seqLocation.locations, this.idToBackend, backendIdRef);\n+        distributeHost(seqLocation, assignedBytesPerHost, backendIdRef);\n+        Backend backend = this.idToBackend.get(backendIdRef.getRef());\n+        TNetworkAddress execHostPort = new TNetworkAddress(backend.getHost(), backend.getBePort());\n         this.addressToBackendID.put(execHostPort, backendIdRef.getRef());\n         this.fragmentIdToSeqToAddressMap.get(fragmentId).put(bucketSeq, execHostPort);\n     }\n \n+    public TScanRangeLocation distributeHost(TScanRangeLocations seqLocation,", "originalCommit": "b3819fb6639599cdef5258c4c8ddd58ab23cc634", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY1MTYxNQ==", "url": "https://github.com/apache/incubator-doris/pull/5104#discussion_r549651615", "bodyText": "ok. I will modify it.", "author": "xinghuayu007", "createdAt": "2020-12-29T10:25:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTY0NjY1NQ=="}], "type": "inlineReview"}, {"oid": "67e1c4fbc3b264809daf6676a53de783b048dc6e", "url": "https://github.com/apache/incubator-doris/commit/67e1c4fbc3b264809daf6676a53de783b048dc6e", "message": "rename function", "committedDate": "2020-12-29T10:29:10Z", "type": "commit"}]}