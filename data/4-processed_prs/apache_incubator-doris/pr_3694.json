{"pr_number": 3694, "pr_title": "[Enhancement] Improve the performance of query with IN predicate ", "pr_createdAt": "2020-05-26T15:19:57Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3694", "timeline": [{"oid": "a915c56081bf094a11285b78ac25556e1f719093", "url": "https://github.com/apache/incubator-doris/commit/a915c56081bf094a11285b78ac25556e1f719093", "message": "fix comment", "committedDate": "2020-05-26T15:34:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDgzMjI5Mg==", "url": "https://github.com/apache/incubator-doris/pull/3694#discussion_r430832292", "bodyText": "I think we should do this work directly in FE, Not add a todo here. In FE we could directly get a empty set for this query.", "author": "kangkaisen", "createdAt": "2020-05-27T03:06:32Z", "path": "be/src/exec/olap_scan_node.cpp", "diffHunk": "@@ -884,25 +910,54 @@ Status OlapScanNode::normalize_in_predicate(SlotDescriptor* slot, ColumnValueRan\n                     case TYPE_INT:\n                     case TYPE_BIGINT:\n                     case TYPE_LARGEINT: {\n+                        range->clear();\n                         range->add_fixed_value(*reinterpret_cast<T*>(value));\n                         break;\n                     }\n                     case TYPE_BOOLEAN: {\n                         bool v = *reinterpret_cast<bool*>(value);\n+                        range->clear();\n                         range->add_fixed_value(*reinterpret_cast<T*>(&v));\n                         break;\n                     }\n                     default: {\n                         LOG(WARNING) << \"Normalize filter fail, Unsupport Primitive type. [type=\"\n-                                     << expr->type() << \"]\";\n+                            << expr->type() << \"]\";\n                         return Status::InternalError(\"Normalize filter fail, Unsupport Primitive type\");\n                     }\n-                    }\n                 }\n+\n+                meet_eq_binary = true;\n+            } // end for each binary predicate child\n+        } // end of handling eq binary predicate\n+\n+        if (range->get_fixed_value_size() > 0) {\n+            // this columns already meet some eq predicates(IN or Binary),\n+            // There is no need to continue to iterate.\n+            // TODO(cmy): In fact, this part of the judgment should be completed in\n+            // the FE query planning stage. For the following predicate conditions,\n+            // it should be possible to eliminate at the FE side.\n+            //      WHERE A = 1 and A in (2,3,4)", "originalCommit": "a915c56081bf094a11285b78ac25556e1f719093", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg0MjU3Mg==", "url": "https://github.com/apache/incubator-doris/pull/3694#discussion_r430842572", "bodyText": "I will try to solve this in next PR.", "author": "morningman", "createdAt": "2020-05-27T03:52:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDgzMjI5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg4NzMxMg==", "url": "https://github.com/apache/incubator-doris/pull/3694#discussion_r430887312", "bodyText": "OK", "author": "kangkaisen", "createdAt": "2020-05-27T06:35:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDgzMjI5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDgzMjYwNw==", "url": "https://github.com/apache/incubator-doris/pull/3694#discussion_r430832607", "bodyText": "eq binary is also binary. So I think we would better also change the normalize_binary_predicate name.", "author": "kangkaisen", "createdAt": "2020-05-27T03:07:52Z", "path": "be/src/exec/olap_scan_node.cpp", "diffHunk": "@@ -715,7 +714,7 @@ Status OlapScanNode::start_scan_thread(RuntimeState* state) {\n template<class T>\n Status OlapScanNode::normalize_predicate(ColumnValueRange<T>& range, SlotDescriptor* slot) {\n     // 1. Normalize InPredicate, add to ColumnValueRange\n-    RETURN_IF_ERROR(normalize_in_predicate(slot, &range));\n+    RETURN_IF_ERROR(normalize_in_and_eq_predicate(slot, &range));\n \n     // 2. Normalize BinaryPredicate , add to ColumnValueRange\n     RETURN_IF_ERROR(normalize_binary_predicate(slot, &range));", "originalCommit": "a915c56081bf094a11285b78ac25556e1f719093", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg0MjY5Mg==", "url": "https://github.com/apache/incubator-doris/pull/3694#discussion_r430842692", "bodyText": "OK", "author": "morningman", "createdAt": "2020-05-27T03:53:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDgzMjYwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg0NDg3OA==", "url": "https://github.com/apache/incubator-doris/pull/3694#discussion_r430844878", "bodyText": "754 line can guarantee it's a single coulumn predicate?", "author": "wutiangan", "createdAt": "2020-05-27T04:03:20Z", "path": "be/src/exec/olap_scan_node.cpp", "diffHunk": "@@ -736,100 +735,114 @@ static bool ignore_cast(SlotDescriptor* slot, Expr* expr) {\n     return false;\n }\n \n+// Construct the ColumnValueRange for one specified column\n+// It will only handle the InPredicate and eq BinaryPredicate in _conjunct_ctxs.\n+// It will try to push down conditions of that column as much as possible,\n+// But if the number of conditions exceeds the limit, none of conditions will be pushed down.\n template<class T>\n-Status OlapScanNode::normalize_in_predicate(SlotDescriptor* slot, ColumnValueRange<T>* range) {\n+Status OlapScanNode::normalize_in_and_eq_predicate(SlotDescriptor* slot, ColumnValueRange<T>* range) {\n+    bool meet_eq_binary = false;\n     for (int conj_idx = 0; conj_idx < _conjunct_ctxs.size(); ++conj_idx) {\n         // 1. Normalize in conjuncts like 'where col in (v1, v2, v3)'\n         if (TExprOpcode::FILTER_IN == _conjunct_ctxs[conj_idx]->root()->op()) {\n             InPredicate* pred = dynamic_cast<InPredicate*>(_conjunct_ctxs[conj_idx]->root());\n             if (pred->is_not_in()) {\n+                // can not push down NOT IN predicate to storage engine\n                 continue;\n             }\n \n             if (Expr::type_without_cast(pred->get_child(0)) != TExprNodeType::SLOT_REF) {\n+                // not a slot ref(column)\n+                continue;\n+            }\n+\n+            std::vector<SlotId> slot_ids;\n+            if (pred->get_child(0)->get_slot_ids(&slot_ids) != 1) {\n+                // not a single column predicate\n+                continue;\n+            }", "originalCommit": "ddabaaaad252513aa5f449f4779e6c976fd168cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk2OTE5OQ==", "url": "https://github.com/apache/incubator-doris/pull/3694#discussion_r430969199", "bodyText": "I am not sure about that, looks like line 754 can guarantee.\nBut just leave this judgement, because no matter what, we still have to call get_slot_ids() to get the slot id and check if it equals to the slot->id() later.", "author": "morningman", "createdAt": "2020-05-27T09:07:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg0NDg3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg0NTUwMg==", "url": "https://github.com/apache/incubator-doris/pull/3694#discussion_r430845502", "bodyText": "Whether \u201drange->clear()\u201c can be preceded by the switch statement", "author": "wutiangan", "createdAt": "2020-05-27T04:06:17Z", "path": "be/src/exec/olap_scan_node.cpp", "diffHunk": "@@ -838,39 +851,52 @@ Status OlapScanNode::normalize_in_predicate(SlotDescriptor* slot, ColumnValueRan\n                         != TExprNodeType::SLOT_REF) {\n                     continue;\n                 }\n+\n+                std::vector<SlotId> slot_ids;\n+                if (pred->get_child(child_idx)->get_slot_ids(&slot_ids) != 1) {\n+                    // not a single column predicate\n+                    continue;\n+                }\n+\n+                if (slot_ids[0] != slot->id()) {\n+                    // predicate not related to current column\n+                    continue;\n+                }\n+\n                 if (pred->get_child(child_idx)->type().type != slot->type().type) {\n                     if (!ignore_cast(slot, pred->get_child(child_idx))) {\n+                        // the type of predicate not match the slot's type\n                         continue;\n                     }\n                 }\n \n-                std::vector<SlotId> slot_ids;\n-                if (1 == pred->get_child(child_idx)->get_slot_ids(&slot_ids)) {\n-                    if (slot_ids[0] != slot->id()) {\n-                        continue;\n-                    }\n-\n-                    Expr* expr = pred->get_child(1 - child_idx);\n-                    if (!expr->is_constant()) {\n-                        continue;\n-                    }\n+                Expr* expr = pred->get_child(1 - child_idx);\n+                if (!expr->is_constant()) {\n+                    // only handle constant value\n+                    continue;\n+                }\n \n-                    void* value = _conjunct_ctxs[conj_idx]->get_value(expr, NULL);\n-                    // for case: where col = null\n-                    if (value == NULL) {\n-                        continue;\n-                    }\n+                void* value = _conjunct_ctxs[conj_idx]->get_value(expr, NULL);\n+                // for case: where col = null\n+                if (value == NULL) {\n+                    continue;\n+                }\n \n-                    switch (slot->type().type) {\n+                // begin to push condition value into ColumnValueRange\n+                // clear the ColumnValueRange before adding new fixed values.\n+                // because for AND compound predicates, it can overwrite previous conditions\n+                switch (slot->type().type) {\n                     case TYPE_TINYINT: {\n                         int32_t v = *reinterpret_cast<int8_t*>(value);\n+                        range->clear();", "originalCommit": "ddabaaaad252513aa5f449f4779e6c976fd168cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk2NzU5Mg==", "url": "https://github.com/apache/incubator-doris/pull/3694#discussion_r430967592", "bodyText": "OK", "author": "morningman", "createdAt": "2020-05-27T09:04:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg0NTUwMg=="}], "type": "inlineReview"}, {"oid": "f37b29e8e694a1b27891873d43c1756fa408b967", "url": "https://github.com/apache/incubator-doris/commit/f37b29e8e694a1b27891873d43c1756fa408b967", "message": "first", "committedDate": "2020-06-04T01:57:05Z", "type": "commit"}, {"oid": "e7363433a4a813186742a3fc739f62f0c56aa8ca", "url": "https://github.com/apache/incubator-doris/commit/e7363433a4a813186742a3fc739f62f0c56aa8ca", "message": "test", "committedDate": "2020-06-04T01:57:05Z", "type": "commit"}, {"oid": "981e37eb39a9a24752c81b6f7e346d83b91ebf98", "url": "https://github.com/apache/incubator-doris/commit/981e37eb39a9a24752c81b6f7e346d83b91ebf98", "message": "change config name", "committedDate": "2020-06-04T01:57:05Z", "type": "commit"}, {"oid": "bc0667055da769162c544f0f1a9c9cf6a4c2dc63", "url": "https://github.com/apache/incubator-doris/commit/bc0667055da769162c544f0f1a9c9cf6a4c2dc63", "message": "add session variables", "committedDate": "2020-06-04T01:57:06Z", "type": "commit"}, {"oid": "f49b46964865efee92af2b86ea13dcba31fd1563", "url": "https://github.com/apache/incubator-doris/commit/f49b46964865efee92af2b86ea13dcba31fd1563", "message": "add doc", "committedDate": "2020-06-04T02:06:01Z", "type": "commit"}, {"oid": "89e2fa7bf8713066048a3d9705362914c7065623", "url": "https://github.com/apache/incubator-doris/commit/89e2fa7bf8713066048a3d9705362914c7065623", "message": "fix comment", "committedDate": "2020-06-04T02:06:01Z", "type": "commit"}, {"oid": "d6872a9b12c6d5e1e36a7b439763d0701ca2262b", "url": "https://github.com/apache/incubator-doris/commit/d6872a9b12c6d5e1e36a7b439763d0701ca2262b", "message": "fix bug", "committedDate": "2020-06-04T02:06:01Z", "type": "commit"}, {"oid": "e6e3e9d8176b02bda3843164b6f4c87073250ed3", "url": "https://github.com/apache/incubator-doris/commit/e6e3e9d8176b02bda3843164b6f4c87073250ed3", "message": "change name", "committedDate": "2020-06-04T02:06:01Z", "type": "commit"}, {"oid": "6466650bc8b3c6142fe957d20891ab217004ad86", "url": "https://github.com/apache/incubator-doris/commit/6466650bc8b3c6142fe957d20891ab217004ad86", "message": "fix bug", "committedDate": "2020-06-04T02:06:01Z", "type": "commit"}, {"oid": "6466650bc8b3c6142fe957d20891ab217004ad86", "url": "https://github.com/apache/incubator-doris/commit/6466650bc8b3c6142fe957d20891ab217004ad86", "message": "fix bug", "committedDate": "2020-06-04T02:06:01Z", "type": "forcePushed"}]}