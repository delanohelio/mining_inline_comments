{"pr_number": 3211, "pr_title": "use SleepFor() instead of usleep()", "pr_createdAt": "2020-03-27T03:08:58Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3211", "timeline": [{"oid": "dc2e7c3a0fc58431b77e62342a4b4e22c2d07e77", "url": "https://github.com/apache/incubator-doris/commit/dc2e7c3a0fc58431b77e62342a4b4e22c2d07e77", "message": "use SleepFor instead of usleep", "committedDate": "2020-03-27T02:59:44Z", "type": "commit"}, {"oid": "788cc8ce9278cfaffd2cdb6ea15577ab6c788472", "url": "https://github.com/apache/incubator-doris/commit/788cc8ce9278cfaffd2cdb6ea15577ab6c788472", "message": "format code", "committedDate": "2020-03-27T02:59:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAxNjcxMg==", "url": "https://github.com/apache/incubator-doris/pull/3211#discussion_r399016712", "bodyText": "why not change this?", "author": "imay", "createdAt": "2020-03-27T03:33:42Z", "path": "be/src/exprs/utility_functions.cpp", "diffHunk": "@@ -17,27 +17,25 @@\n \n #include \"exprs/utility_functions.h\"\n \n-#include \"exprs/expr.h\"\n #include \"exprs/anyval_util.h\"\n-#include \"util/debug_util.h\"\n+#include \"exprs/expr.h\"\n #include \"runtime/tuple_row.h\"\n+#include \"util/debug_util.h\"\n \n namespace doris {\n \n-void UtilityFunctions::init() {\n-}\n+void UtilityFunctions::init() {}\n \n StringVal UtilityFunctions::version(FunctionContext* ctx) {\n     return AnyValUtil::from_string_temp(ctx, \"5.1.0\");\n }\n \n-BooleanVal UtilityFunctions::sleep(\n-        FunctionContext* ctx, const IntVal& milliseconds) {\n+BooleanVal UtilityFunctions::sleep(FunctionContext* ctx, const IntVal& milliseconds) {\n     if (milliseconds.is_null) {\n         return BooleanVal::null();\n     }\n-    usleep(milliseconds.val * 1000 * 1000);\n+    usleep(milliseconds.val * 1000 * 1000); // TODO(hw): ms * 1000 * 1000 = ns", "originalCommit": "788cc8ce9278cfaffd2cdb6ea15577ab6c788472", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAzMzYzMQ==", "url": "https://github.com/apache/incubator-doris/pull/3211#discussion_r399033631", "bodyText": "I'm confused about this. This usleep() use ns as its argument. Is it a mistake?\nI should change it to\nSleepFor(MonoDelta::FromMilliseconds(milliseconds.val) ?", "author": "vagetablechicken", "createdAt": "2020-03-27T04:48:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAxNjcxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTA0OTA1Mw==", "url": "https://github.com/apache/incubator-doris/pull/3211#discussion_r399049053", "bodyText": "this function is used to support SQL select sleep(N); N is for N second. so you just change it to sleepFor(Second)", "author": "imay", "createdAt": "2020-03-27T05:53:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTAxNjcxMg=="}], "type": "inlineReview"}, {"oid": "789510b9469e8cf7c228853e160514ca162aa354", "url": "https://github.com/apache/incubator-doris/commit/789510b9469e8cf7c228853e160514ca162aa354", "message": "fix utilityfunction", "committedDate": "2020-03-27T06:18:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTA1NzE3MQ==", "url": "https://github.com/apache/incubator-doris/pull/3211#discussion_r399057171", "bodyText": "use LOG(WARNING) instead", "author": "chaoyli", "createdAt": "2020-03-27T06:24:03Z", "path": "be/src/agent/task_worker_pool.cpp", "diffHunk": "@@ -668,8 +658,8 @@ void* TaskWorkerPool::_push_worker_thread_callback(void* arg_this) {\n             error_msgs.push_back(\"push request push_type invalid.\");\n             task_status.__set_status_code(TStatusCode::ANALYSIS_ERROR);\n         } else {\n-            OLAP_LOG_WARNING(\"push failed, error_code: %d, signature: %ld\",\n-                             status, agent_task_req.signature);\n+            OLAP_LOG_WARNING(\"push failed, error_code: %d, signature: %ld\", status,", "originalCommit": "789510b9469e8cf7c228853e160514ca162aa354", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTA1NzI0NQ==", "url": "https://github.com/apache/incubator-doris/pull/3211#discussion_r399057245", "bodyText": "use LOG(WARNING) instead", "author": "chaoyli", "createdAt": "2020-03-27T06:24:16Z", "path": "be/src/agent/task_worker_pool.cpp", "diffHunk": "@@ -718,11 +708,12 @@ void* TaskWorkerPool::_publish_version_worker_thread_callback(void* arg_this) {\n             if (res == OLAP_SUCCESS) {\n                 break;\n             } else {\n-                OLAP_LOG_WARNING(\"publish version error, retry. \"\n-                                 \"[transaction_id=%ld, error_tablets_size=%d]\",\n-                                 publish_version_req.transaction_id, error_tablet_ids.size());\n+                OLAP_LOG_WARNING(", "originalCommit": "789510b9469e8cf7c228853e160514ca162aa354", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTA1NzM0Mw==", "url": "https://github.com/apache/incubator-doris/pull/3211#discussion_r399057343", "bodyText": "use LOG(WARNING) instead", "author": "chaoyli", "createdAt": "2020-03-27T06:24:35Z", "path": "be/src/agent/task_worker_pool.cpp", "diffHunk": "@@ -967,8 +956,8 @@ void* TaskWorkerPool::_storage_medium_migrate_worker_thread_callback(void* arg_t\n         EngineStorageMigrationTask engine_task(storage_medium_migrate_req);\n         OLAPStatus res = worker_pool_this->_env->storage_engine()->execute_task(&engine_task);\n         if (res != OLAP_SUCCESS) {\n-            OLAP_LOG_WARNING(\"storage media migrate failed. status: %d, signature: %ld\",\n-                             res, agent_task_req.signature);\n+            OLAP_LOG_WARNING(\"storage media migrate failed. status: %d, signature: %ld\", res,", "originalCommit": "789510b9469e8cf7c228853e160514ca162aa354", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTA1NzQyNQ==", "url": "https://github.com/apache/incubator-doris/pull/3211#discussion_r399057425", "bodyText": "use LOG(WARNING) instead", "author": "chaoyli", "createdAt": "2020-03-27T06:24:53Z", "path": "be/src/agent/task_worker_pool.cpp", "diffHunk": "@@ -1016,20 +1005,17 @@ void* TaskWorkerPool::_check_consistency_worker_thread_callback(void* arg_this)\n         TStatus task_status;\n \n         uint32_t checksum = 0;\n-        EngineChecksumTask engine_task(check_consistency_req.tablet_id,\n-                check_consistency_req.schema_hash,\n-                check_consistency_req.version,\n-                check_consistency_req.version_hash,\n-                &checksum);\n+        EngineChecksumTask engine_task(\n+                check_consistency_req.tablet_id, check_consistency_req.schema_hash,\n+                check_consistency_req.version, check_consistency_req.version_hash, &checksum);\n         OLAPStatus res = worker_pool_this->_env->storage_engine()->execute_task(&engine_task);\n         if (res != OLAP_SUCCESS) {\n-            OLAP_LOG_WARNING(\"check consistency failed. status: %d, signature: %ld\",\n-                             res, agent_task_req.signature);\n+            OLAP_LOG_WARNING(\"check consistency failed. status: %d, signature: %ld\", res,", "originalCommit": "789510b9469e8cf7c228853e160514ca162aa354", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTA1NzQ5MQ==", "url": "https://github.com/apache/incubator-doris/pull/3211#discussion_r399057491", "bodyText": "use LOG(WARNING) instead", "author": "chaoyli", "createdAt": "2020-03-27T06:25:09Z", "path": "be/src/agent/task_worker_pool.cpp", "diffHunk": "@@ -1169,7 +1160,8 @@ void* TaskWorkerPool::_report_tablet_worker_thread_callback(void* arg_this) {\n \n         request.__set_report_version(_s_report_version);\n         OLAPStatus report_all_tablets_info_status =\n-                StorageEngine::instance()->tablet_manager()->report_all_tablets_info(&request.tablets);\n+                StorageEngine::instance()->tablet_manager()->report_all_tablets_info(\n+                        &request.tablets);\n         if (report_all_tablets_info_status != OLAP_SUCCESS) {\n             OLAP_LOG_WARNING(\"report get all tablets info failed. status: %d\",", "originalCommit": "789510b9469e8cf7c228853e160514ca162aa354", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3d2b7491f24fd13370d6c23caee9a0ac3fc6aa46", "url": "https://github.com/apache/incubator-doris/commit/3d2b7491f24fd13370d6c23caee9a0ac3fc6aa46", "message": "fix warning log", "committedDate": "2020-03-27T07:11:01Z", "type": "commit"}]}