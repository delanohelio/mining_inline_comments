{"pr_number": 5111, "pr_title": "[Bug] Fix scanner threads heap-use-after-free", "pr_createdAt": "2020-12-22T03:30:44Z", "pr_url": "https://github.com/apache/incubator-doris/pull/5111", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODg1MDk3Ng==", "url": "https://github.com/apache/incubator-doris/pull/5111#discussion_r548850976", "bodyText": "Is it better to use C++11 promise and future to instead of checking _running_thread == 0? every scanner_thread just need to set its promise value when finish task with lock free, and close OlapScanNode close just need to wait all scanner_thread return future result ?", "author": "caiconghui", "createdAt": "2020-12-25T10:21:59Z", "path": "be/src/exec/olap_scan_node.cpp", "diffHunk": "@@ -1250,12 +1250,25 @@ void OlapScanNode::transfer_thread(RuntimeState* state) {\n \n     state->resource_pool()->release_thread_token(true);\n     VLOG(1) << \"TransferThread finish.\";\n-    std::unique_lock<std::mutex> l(_row_batches_lock);\n-    _transfer_done = true;\n+    {\n+        std::unique_lock<std::mutex> l(_row_batches_lock);\n+        _transfer_done = true;\n+    }\n     _row_batch_added_cv.notify_all();\n+\n+    std::unique_lock<std::mutex> l(_scan_batches_lock);\n+    while (_running_thread != 0) {", "originalCommit": "f7f052d460a6519278af1d876c46382a46a78ea8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODk0NDg3OQ==", "url": "https://github.com/apache/incubator-doris/pull/5111#discussion_r548944879", "bodyText": "Is it elegant to use sleep to do multithread sync? why not use a cv to wait here, and nofity after _running_thread--?", "author": "acelyc111", "createdAt": "2020-12-26T05:15:19Z", "path": "be/src/exec/olap_scan_node.cpp", "diffHunk": "@@ -1250,12 +1250,25 @@ void OlapScanNode::transfer_thread(RuntimeState* state) {\n \n     state->resource_pool()->release_thread_token(true);\n     VLOG(1) << \"TransferThread finish.\";\n-    std::unique_lock<std::mutex> l(_row_batches_lock);\n-    _transfer_done = true;\n+    {\n+        std::unique_lock<std::mutex> l(_row_batches_lock);\n+        _transfer_done = true;\n+    }\n     _row_batch_added_cv.notify_all();\n+\n+    std::unique_lock<std::mutex> l(_scan_batches_lock);\n+    while (_running_thread != 0) {\n+        l.unlock();\n+        SleepFor(MonoDelta::FromMilliseconds(5));\n+        l.lock();", "originalCommit": "f7f052d460a6519278af1d876c46382a46a78ea8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODk0ODgwMA==", "url": "https://github.com/apache/incubator-doris/pull/5111#discussion_r548948800", "bodyText": "I don't want use _scan_batch_added_cv, it's hard to understand the relationship between _scan_batch_added_cv & _running_thread . I'll add a new condition variable.", "author": "vagetablechicken", "createdAt": "2020-12-26T06:09:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODk0NDg3OQ=="}], "type": "inlineReview"}, {"oid": "31e84eb8e4c520f5ad9969b461623c065fdebd4a", "url": "https://github.com/apache/incubator-doris/commit/31e84eb8e4c520f5ad9969b461623c065fdebd4a", "message": "[] use while-sleep to check flag", "committedDate": "2020-12-28T03:17:26Z", "type": "commit"}, {"oid": "fbed19de1efb7a48d80b3a10d826fd585ae4ddb3", "url": "https://github.com/apache/incubator-doris/commit/fbed19de1efb7a48d80b3a10d826fd585ae4ddb3", "message": "[] fix", "committedDate": "2020-12-28T03:17:26Z", "type": "commit"}, {"oid": "7128ccd6120e896f197f4b71ab0d478f5cad7db4", "url": "https://github.com/apache/incubator-doris/commit/7128ccd6120e896f197f4b71ab0d478f5cad7db4", "message": "[] fix code", "committedDate": "2020-12-28T03:17:26Z", "type": "commit"}, {"oid": "8beb22628689916f4bdd4c2617636bdf8caa336a", "url": "https://github.com/apache/incubator-doris/commit/8beb22628689916f4bdd4c2617636bdf8caa336a", "message": "[] restart test", "committedDate": "2020-12-28T03:17:26Z", "type": "commit"}, {"oid": "8beb22628689916f4bdd4c2617636bdf8caa336a", "url": "https://github.com/apache/incubator-doris/commit/8beb22628689916f4bdd4c2617636bdf8caa336a", "message": "[] restart test", "committedDate": "2020-12-28T03:17:26Z", "type": "forcePushed"}, {"oid": "a00d97f9731374d02a47caca5cb0d9ffbee875fb", "url": "https://github.com/apache/incubator-doris/commit/a00d97f9731374d02a47caca5cb0d9ffbee875fb", "message": "Update olap_scan_node.cpp", "committedDate": "2020-12-29T07:26:04Z", "type": "commit"}, {"oid": "a936a357ff5b564f78a902d25a6fee5a27137b1f", "url": "https://github.com/apache/incubator-doris/commit/a936a357ff5b564f78a902d25a6fee5a27137b1f", "message": "[] fix", "committedDate": "2020-12-31T06:38:02Z", "type": "commit"}, {"oid": "bd0e44d4b9f35ea52ebce7e2db24ddaa6afc5f8e", "url": "https://github.com/apache/incubator-doris/commit/bd0e44d4b9f35ea52ebce7e2db24ddaa6afc5f8e", "message": "Merge branch '5102' of github.com:vagetablechicken/incubator-doris into 5102", "committedDate": "2020-12-31T06:38:18Z", "type": "commit"}]}