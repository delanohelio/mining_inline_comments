{"pr_number": 3955, "pr_title": "Support checking database used data quota when data load job begin a new txn", "pr_createdAt": "2020-06-27T07:55:29Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3955", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTcyNTA5Ng==", "url": "https://github.com/apache/incubator-doris/pull/3955#discussion_r449725096", "bodyText": "I think this can be set to true by default.", "author": "morningman", "createdAt": "2020-07-04T00:53:58Z", "path": "fe/src/main/java/org/apache/doris/common/Config.java", "diffHunk": "@@ -873,6 +873,18 @@\n      */\n     @ConfField(mutable = true, masterOnly = true)\n     public static boolean disable_load_job = false;\n+\n+    /*\n+     * if this is set to true, all load job will check db data quota when call begin txn api\n+     */\n+    @ConfField(mutable = true, masterOnly = true)\n+    public static boolean enable_check_data_quota_on_load = false;", "originalCommit": "21a49bb293503a3aeb83b0f6597ce9b5abccb766", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc1NTY2OA==", "url": "https://github.com/apache/incubator-doris/pull/3955#discussion_r449755668", "bodyText": "done", "author": "caiconghui", "createdAt": "2020-07-04T09:13:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTcyNTA5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTcyNTIwOQ==", "url": "https://github.com/apache/incubator-doris/pull/3955#discussion_r449725209", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                       checkDatabaseDataQuota();\n          \n          \n            \n                        checkDatabaseDataQuota();", "author": "morningman", "createdAt": "2020-07-04T00:55:37Z", "path": "fe/src/main/java/org/apache/doris/transaction/DatabaseTransactionMgr.java", "diffHunk": "@@ -246,6 +249,10 @@ private void getTxnStateInfo(TransactionState txnState, List<String> info) {\n     public long beginTransaction(List<Long> tableIdList, String label, TUniqueId requestId,\n                                  TransactionState.TxnCoordinator coordinator, TransactionState.LoadJobSourceType sourceType, long listenerId, long timeoutSecond)\n             throws DuplicatedRequestException, LabelAlreadyUsedException, BeginTransactionException, AnalysisException {\n+        if (Config.enable_check_data_quota_on_load) {\n+           checkDatabaseDataQuota();", "originalCommit": "21a49bb293503a3aeb83b0f6597ce9b5abccb766", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc1NTY3Ng==", "url": "https://github.com/apache/incubator-doris/pull/3955#discussion_r449755676", "bodyText": "fix", "author": "caiconghui", "createdAt": "2020-07-04T09:14:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTcyNTIwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjkwMzcxOA==", "url": "https://github.com/apache/incubator-doris/pull/3955#discussion_r456903718", "bodyText": "I think check database quota can be checked upon every load. So we can check every time without this config.\nHow about data quota update frequency previously?  It's used by table report, It seems that we can continue to use it or not ?", "author": "chaoyli", "createdAt": "2020-07-19T12:37:18Z", "path": "docs/en/administrator-guide/config/fe_config.md", "diffHunk": "@@ -261,6 +267,12 @@ This configuration can play a role in certain scenarios. Assume that the initial\n \n ### `enable_auth_check`\n \n+### `enable_check_data_quota_on_load`", "originalCommit": "b34093a701533ead0b554e8ba5c36cb94693fa81", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjkyNjk5OA==", "url": "https://github.com/apache/incubator-doris/pull/3955#discussion_r456926998", "bodyText": "@chaoyli\n\nThe main consideration is to make the user's load task not fail if they don't want use this load quota limit, but now it seems a bug?\nTabletStatMgr will update replica rowcount and datasize every 5min now, but not compute data quota, data quota will be computed only when show data operation is executed or create table or alter table schema.", "author": "caiconghui", "createdAt": "2020-07-19T16:17:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjkwMzcxOA=="}], "type": "inlineReview"}, {"oid": "923b16566ea129734e44219f6ba3d78a53746987", "url": "https://github.com/apache/incubator-doris/commit/923b16566ea129734e44219f6ba3d78a53746987", "message": "Support checking database used data quota when begin a new txn", "committedDate": "2020-07-23T03:04:15Z", "type": "commit"}, {"oid": "fbb80222c437de337e5a16370d16987e11497b7c", "url": "https://github.com/apache/incubator-doris/commit/fbb80222c437de337e5a16370d16987e11497b7c", "message": "Update doc content for enable_check_data_quota_on_load and db_used_data_quota_update_interval_secs config", "committedDate": "2020-07-23T03:04:15Z", "type": "commit"}, {"oid": "e25de031552089bd1d6b8f4b7fa700147469d03b", "url": "https://github.com/apache/incubator-doris/commit/e25de031552089bd1d6b8f4b7fa700147469d03b", "message": "Add debug log for UpdateDbUsedDataQuotaDaemon", "committedDate": "2020-07-23T03:04:15Z", "type": "commit"}, {"oid": "ac2383f6828f479ccbf0944f54b78e150db7177f", "url": "https://github.com/apache/incubator-doris/commit/ac2383f6828f479ccbf0944f54b78e150db7177f", "message": "fix by review", "committedDate": "2020-07-23T03:04:15Z", "type": "commit"}, {"oid": "9af3c7fde26caa75dfdc005ae0dfdbc0e020a4cc", "url": "https://github.com/apache/incubator-doris/commit/9af3c7fde26caa75dfdc005ae0dfdbc0e020a4cc", "message": "remove enable_check_data_quota_on_load config", "committedDate": "2020-07-23T03:04:15Z", "type": "commit"}, {"oid": "9af3c7fde26caa75dfdc005ae0dfdbc0e020a4cc", "url": "https://github.com/apache/incubator-doris/commit/9af3c7fde26caa75dfdc005ae0dfdbc0e020a4cc", "message": "remove enable_check_data_quota_on_load config", "committedDate": "2020-07-23T03:04:15Z", "type": "forcePushed"}, {"oid": "2d6e17e3a9df680e71cbb1508eda75e416b4b1db", "url": "https://github.com/apache/incubator-doris/commit/2d6e17e3a9df680e71cbb1508eda75e416b4b1db", "message": "fix compile failed", "committedDate": "2020-07-23T03:25:19Z", "type": "commit"}]}