{"pr_number": 2957, "pr_title": "implement the planner for set operation", "pr_createdAt": "2020-02-20T10:31:50Z", "pr_url": "https://github.com/apache/incubator-doris/pull/2957", "timeline": [{"oid": "6c9ffeff3a06c69ac5aa4fcb768176c62e295884", "url": "https://github.com/apache/incubator-doris/commit/6c9ffeff3a06c69ac5aa4fcb768176c62e295884", "message": "implement the planner for set operation", "committedDate": "2020-02-21T02:27:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg5MjIxMA==", "url": "https://github.com/apache/incubator-doris/pull/2957#discussion_r382892210", "bodyText": "Looks like these 3 containsXXXNode does not use?", "author": "morningman", "createdAt": "2020-02-22T06:52:56Z", "path": "fe/src/main/java/org/apache/doris/qe/Coordinator.java", "diffHunk": "@@ -809,6 +812,63 @@ private boolean containsUnionNode(PlanNode node) {\n         return false;\n     }\n \n+    // estimate if this fragment contains IntersectNode\n+    private boolean containsIntersectNode(PlanNode node) {", "originalCommit": "6c9ffeff3a06c69ac5aa4fcb768176c62e295884", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg5MzA5NQ==", "url": "https://github.com/apache/incubator-doris/pull/2957#discussion_r382893095", "bodyText": "Add comments for this method.", "author": "morningman", "createdAt": "2020-02-22T07:12:06Z", "path": "fe/src/main/java/org/apache/doris/planner/SingleNodePlanner.java", "diffHunk": "@@ -1609,6 +1668,40 @@ private PlanNode createSetOperationPlan(SetOperationStmt setOperationStmt, Analy\n         return result;\n     }\n \n+    private PlanNode createPartialSetOperationPlan(Analyzer analyzer, SetOperationStmt setOperationStmt,", "originalCommit": "6c9ffeff3a06c69ac5aa4fcb768176c62e295884", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg5MzE5OQ==", "url": "https://github.com/apache/incubator-doris/pull/2957#discussion_r382893199", "bodyText": "Could you add more comment to explain the logic here?\nAnd better to add Unit test to test it. You can reference to bitmap function test.", "author": "morningman", "createdAt": "2020-02-22T07:13:55Z", "path": "fe/src/main/java/org/apache/doris/planner/SingleNodePlanner.java", "diffHunk": "@@ -1590,16 +1619,46 @@ private PlanNode createSetOperationPlan(SetOperationStmt setOperationStmt, Analy\n         setOperationStmt.materializeRequiredSlots(analyzer);\n \n         PlanNode result = null;\n-        // create DISTINCT tree\n-        if (setOperationStmt.hasDistinctOps()) {\n-            result = createUnionPlan(\n-                    analyzer, setOperationStmt, setOperationStmt.getDistinctOperands(), null, defaultOrderByLimit);\n-            result = new AggregationNode(ctx_.getNextNodeId(), result, setOperationStmt.getDistinctAggInfo());\n-            result.init(analyzer);\n+        SetOperationStmt.Operation operation = null;\n+        SetOperationStmt.Qualifier exceptQualifier = null;\n+        List<SetOperationStmt.SetOperand> partialOperands = new ArrayList<>();\n+        // create plan for a union b intersect c except b to three fragments\n+        // 3:[2:[1:[a union b] intersect c] except c]\n+        // EXCEPT operator is NOT commutative, it IS important which query is first,\n+        // which second using EXCEPT operator, so EXCEPT operator cannot merge all distinct op to one node all all\n+        // op to another node", "originalCommit": "6c9ffeff3a06c69ac5aa4fcb768176c62e295884", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg5MzI2Mw==", "url": "https://github.com/apache/incubator-doris/pull/2957#discussion_r382893263", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            // Node that alulate the interscet results of its children by either materializing their\n          \n          \n            \n            // Node that calculate the intersect results of its children by either materializing their", "author": "morningman", "createdAt": "2020-02-22T07:15:15Z", "path": "be/src/exec/intersect_node.h", "diffHunk": "@@ -0,0 +1,100 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+\n+#ifndef  DORIS_BE_SRC_QUERY_EXEC_INTERSECT_NODE_H\n+#define  DORIS_BE_SRC_QUERY_EXEC_INTERSECT_NODE_H\n+\n+#include \"exec/exec_node.h\"\n+#include \"runtime/row_batch.h\"\n+#include \"runtime/runtime_state.h\"\n+\n+namespace doris {\n+\n+// Node that alulate the interscet results of its children by either materializing their", "originalCommit": "6c9ffeff3a06c69ac5aa4fcb768176c62e295884", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "26f9ec8d2f858718e7a6f6a37bbc6eda5eb21d5b", "url": "https://github.com/apache/incubator-doris/commit/26f9ec8d2f858718e7a6f6a37bbc6eda5eb21d5b", "message": "implement the planner for set operation", "committedDate": "2020-02-24T02:43:26Z", "type": "forcePushed"}, {"oid": "062e85e358a66bbc33c7930ca670d41fe5652c94", "url": "https://github.com/apache/incubator-doris/commit/062e85e358a66bbc33c7930ca670d41fe5652c94", "message": "implement the planner for set operation", "committedDate": "2020-02-24T09:31:10Z", "type": "forcePushed"}, {"oid": "cb60bc0eb9a6deefd2975b27552d6c2a3d839353", "url": "https://github.com/apache/incubator-doris/commit/cb60bc0eb9a6deefd2975b27552d6c2a3d839353", "message": "implement the planner for set operation", "committedDate": "2020-02-24T10:43:54Z", "type": "forcePushed"}, {"oid": "b2d4b81bae76b1c1318ae0ddb40c10133528bf4a", "url": "https://github.com/apache/incubator-doris/commit/b2d4b81bae76b1c1318ae0ddb40c10133528bf4a", "message": "implement the planner for set operation", "committedDate": "2020-02-24T10:47:21Z", "type": "forcePushed"}, {"oid": "292797bd2fe1c9b98a66a48e2d666a4d5a80001f", "url": "https://github.com/apache/incubator-doris/commit/292797bd2fe1c9b98a66a48e2d666a4d5a80001f", "message": "implement the planner for set operation", "committedDate": "2020-02-24T11:16:08Z", "type": "forcePushed"}, {"oid": "c9f8bce115a142c27c9b5bdacedd54f62191e2f8", "url": "https://github.com/apache/incubator-doris/commit/c9f8bce115a142c27c9b5bdacedd54f62191e2f8", "message": "implement the planner for set operation", "committedDate": "2020-02-24T11:22:42Z", "type": "forcePushed"}, {"oid": "02b962a84eafc61e2a988e006de9a1b51e4c358c", "url": "https://github.com/apache/incubator-doris/commit/02b962a84eafc61e2a988e006de9a1b51e4c358c", "message": "implement the planner for set operation", "committedDate": "2020-02-24T11:32:02Z", "type": "forcePushed"}, {"oid": "addbb7e3e9cd3247150cf5c6d481c708aeebe72a", "url": "https://github.com/apache/incubator-doris/commit/addbb7e3e9cd3247150cf5c6d481c708aeebe72a", "message": "implement the planner for set operation", "committedDate": "2020-02-24T11:36:39Z", "type": "forcePushed"}, {"oid": "d89ba9da9065cec6958f67e2c54138e308cbc012", "url": "https://github.com/apache/incubator-doris/commit/d89ba9da9065cec6958f67e2c54138e308cbc012", "message": "implement the planner for set operation", "committedDate": "2020-02-24T11:37:27Z", "type": "forcePushed"}, {"oid": "b76216e4ebdf0e9a200ff0a17dcb3270204d55d5", "url": "https://github.com/apache/incubator-doris/commit/b76216e4ebdf0e9a200ff0a17dcb3270204d55d5", "message": "implement the planner for set operation", "committedDate": "2020-02-25T02:12:14Z", "type": "forcePushed"}, {"oid": "9ea5c7e40a9fc798d1ce0d1d384e16d58ac1a58a", "url": "https://github.com/apache/incubator-doris/commit/9ea5c7e40a9fc798d1ce0d1d384e16d58ac1a58a", "message": "implement the planner for set operation", "committedDate": "2020-02-25T05:59:56Z", "type": "forcePushed"}, {"oid": "1628fe2026abe96062b849a2fee00ec27bef8b68", "url": "https://github.com/apache/incubator-doris/commit/1628fe2026abe96062b849a2fee00ec27bef8b68", "message": "implement the planner for set operation", "committedDate": "2020-02-26T03:41:12Z", "type": "forcePushed"}, {"oid": "d2935d8b3f009b34ab11a07d1001dd27b14391c6", "url": "https://github.com/apache/incubator-doris/commit/d2935d8b3f009b34ab11a07d1001dd27b14391c6", "message": "implement the planner for set operation", "committedDate": "2020-02-26T12:23:15Z", "type": "forcePushed"}, {"oid": "db0f2a98dce20cb99c4fc3bb179fbffb6ec0061d", "url": "https://github.com/apache/incubator-doris/commit/db0f2a98dce20cb99c4fc3bb179fbffb6ec0061d", "message": "implement the planner for set operation", "committedDate": "2020-02-27T02:34:31Z", "type": "forcePushed"}, {"oid": "6d18626f45e146641a21038a8aee7910e7d5bd0d", "url": "https://github.com/apache/incubator-doris/commit/6d18626f45e146641a21038a8aee7910e7d5bd0d", "message": "implement the planner for set operation", "committedDate": "2020-02-27T04:23:41Z", "type": "commit"}, {"oid": "6d18626f45e146641a21038a8aee7910e7d5bd0d", "url": "https://github.com/apache/incubator-doris/commit/6d18626f45e146641a21038a8aee7910e7d5bd0d", "message": "implement the planner for set operation", "committedDate": "2020-02-27T04:23:41Z", "type": "forcePushed"}]}