{"pr_number": 3054, "pr_title": "[Bug]Fix invalid rollback for stream load txn", "pr_createdAt": "2020-03-07T16:58:45Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3054", "timeline": [{"oid": "90d6877fafbd2cbc319c646dd27426da8eabdd54", "url": "https://github.com/apache/incubator-doris/commit/90d6877fafbd2cbc319c646dd27426da8eabdd54", "message": "Fix invalid rollback for stream load txn", "committedDate": "2020-03-07T16:57:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQzMDM0MQ==", "url": "https://github.com/apache/incubator-doris/pull/3054#discussion_r389430341", "bodyText": "If you change this code, when FE return PUBLISH_TIMEOUT, here it will just return Status:OK() to the upper caller?\nI think we should return PUBLISH_TIMEOUT directly, but set ctx->need_rollback = false to false", "author": "morningman", "createdAt": "2020-03-09T01:33:21Z", "path": "be/src/runtime/stream_load/stream_load_executor.cpp", "diffHunk": "@@ -188,7 +188,7 @@ Status StreamLoadExecutor::commit_txn(StreamLoadContext* ctx) {\n     // Return if this transaction is committed successful; otherwise, we need try to\n     // rollback this transaction\n     Status status(result.status);\n-    if (!status.ok()) {\n+    if (!status.ok() && status.code() != TStatusCode::PUBLISH_TIMEOUT) {", "originalCommit": "90d6877fafbd2cbc319c646dd27426da8eabdd54", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5ca0de98ade49f9d91123aa9efd75cbc102dfb40", "url": "https://github.com/apache/incubator-doris/commit/5ca0de98ade49f9d91123aa9efd75cbc102dfb40", "message": "fix", "committedDate": "2020-03-09T02:00:13Z", "type": "commit"}, {"oid": "d0928505757f7e0714f232517973e2237a7a07e3", "url": "https://github.com/apache/incubator-doris/commit/d0928505757f7e0714f232517973e2237a7a07e3", "message": "fix", "committedDate": "2020-03-09T03:31:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQ1MTAzNA==", "url": "https://github.com/apache/incubator-doris/pull/3054#discussion_r389451034", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (status.code() != TStatusCode::PUBLISH_TIMEOUT) {\n          \n          \n            \n                    if (status.code() == TStatusCode::PUBLISH_TIMEOUT) {", "author": "morningman", "createdAt": "2020-03-09T03:38:55Z", "path": "be/src/runtime/stream_load/stream_load_executor.cpp", "diffHunk": "@@ -178,19 +180,24 @@ Status StreamLoadExecutor::commit_txn(StreamLoadContext* ctx) {\n     TLoadTxnCommitResult result;\n #ifndef BE_TEST\n     RETURN_IF_ERROR(ThriftRpcHelper::rpc<FrontendServiceClient>(\n-        master_addr.hostname, master_addr.port,\n-        [&request, &result] (FrontendServiceConnection& client) {\n-            client->loadTxnCommit(result, request);\n-        }, config::txn_commit_rpc_timeout_ms));\n+            master_addr.hostname, master_addr.port,\n+            [&request, &result](FrontendServiceConnection& client) {\n+                client->loadTxnCommit(result, request);\n+            },\n+            config::txn_commit_rpc_timeout_ms));\n #else\n     result = k_stream_load_commit_result;\n #endif\n-    // Return if this transaction is committed successful; otherwise, we need try to\n+    // Return if this transaction is committed successful; otherwise, we need try\n+    // to\n     // rollback this transaction\n     Status status(result.status);\n-    if (!status.ok() && status.code() != TStatusCode::PUBLISH_TIMEOUT) {\n+    if (!status.ok()) {\n         LOG(WARNING) << \"commit transaction failed, errmsg=\" << status.get_error_msg()\n-            << ctx->brief();\n+                     << ctx->brief();\n+        if (status.code() != TStatusCode::PUBLISH_TIMEOUT) {", "originalCommit": "5ca0de98ade49f9d91123aa9efd75cbc102dfb40", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQ5NzM4NQ==", "url": "https://github.com/apache/incubator-doris/pull/3054#discussion_r389497385", "bodyText": "done", "author": "WingsGo", "createdAt": "2020-03-09T07:33:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQ1MTAzNA=="}], "type": "inlineReview"}]}