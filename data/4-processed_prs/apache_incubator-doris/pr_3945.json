{"pr_number": 3945, "pr_title": "[BUG]Make segment V1 and V2 share same file cache", "pr_createdAt": "2020-06-25T01:18:18Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3945", "timeline": [{"oid": "71e537d8a3979022dbd2f614becd37f00eddac8f", "url": "https://github.com/apache/incubator-doris/commit/71e537d8a3979022dbd2f614becd37f00eddac8f", "message": "save code", "committedDate": "2020-06-24T20:49:20Z", "type": "commit"}, {"oid": "0128055c5e74d9ee860071e4ea4d1e76d8e214f4", "url": "https://github.com/apache/incubator-doris/commit/0128055c5e74d9ee860071e4ea4d1e76d8e214f4", "message": "place cache in storage_engine", "committedDate": "2020-06-24T20:49:20Z", "type": "commit"}, {"oid": "bb055b207d584e6a8be55fd4c30f2ba52b200c3a", "url": "https://github.com/apache/incubator-doris/commit/bb055b207d584e6a8be55fd4c30f2ba52b200c3a", "message": "rebase", "committedDate": "2020-06-24T20:49:20Z", "type": "commit"}, {"oid": "25157bcb5e2baa4cd9a60670bec660f5fe0c7f93", "url": "https://github.com/apache/incubator-doris/commit/25157bcb5e2baa4cd9a60670bec660f5fe0c7f93", "message": "fix segment fault", "committedDate": "2020-06-25T00:24:26Z", "type": "commit"}, {"oid": "904ce76772a72f07027b406c3f7fd452c3968e6e", "url": "https://github.com/apache/incubator-doris/commit/904ce76772a72f07027b406c3f7fd452c3968e6e", "message": "remove comment", "committedDate": "2020-06-25T01:21:44Z", "type": "commit"}, {"oid": "3b3fdeb71dac4b048fc447083ca97a4a1c78aedd", "url": "https://github.com/apache/incubator-doris/commit/3b3fdeb71dac4b048fc447083ca97a4a1c78aedd", "message": "remove unuse", "committedDate": "2020-06-25T01:24:42Z", "type": "commit"}, {"oid": "e768052ebcfa9287cc78c28c91f40aca22e8a1dd", "url": "https://github.com/apache/incubator-doris/commit/e768052ebcfa9287cc78c28c91f40aca22e8a1dd", "message": "fix memory leak", "committedDate": "2020-06-25T02:52:43Z", "type": "commit"}, {"oid": "6d3f884e28af0773893a8822f830c989b0a6ac85", "url": "https://github.com/apache/incubator-doris/commit/6d3f884e28af0773893a8822f830c989b0a6ac85", "message": "fix ut", "committedDate": "2020-06-25T08:46:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE2MDQ0OQ==", "url": "https://github.com/apache/incubator-doris/pull/3945#discussion_r446160449", "bodyText": "Here are 2 constructors of FileCache, and the difference is the first own the cache, the second does not own the cache.\nSo you should first add new field _is_cache_owned to indicate whether it owns the cache.\nSecondly, to modify the deconstructor of FileCache, only reset the cache if _is_cache_owned is true.", "author": "morningman", "createdAt": "2020-06-26T12:43:56Z", "path": "be/src/util/file_cache.h", "diffHunk": "@@ -104,8 +104,16 @@ class FileCache {\n     // the number of files open at any given time.\n     FileCache(const std::string& cache_name, int max_open_files);\n \n+    // Creates a new file cache with given cache.\n+    //\n+    // The 'cache_name' is used to disambiguate amongst other file cache\n+    // instances.\n+    FileCache(const std::string& cache_name, std::shared_ptr<Cache> cache);", "originalCommit": "6d3f884e28af0773893a8822f830c989b0a6ac85", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYzNjU1OA==", "url": "https://github.com/apache/incubator-doris/pull/3945#discussion_r446636558", "bodyText": "done", "author": "xy720", "createdAt": "2020-06-28T11:08:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE2MDQ0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE2MTYzOQ==", "url": "https://github.com/apache/incubator-doris/pull/3945#discussion_r446161639", "bodyText": "remove the unused code.", "author": "morningman", "createdAt": "2020-06-26T12:46:11Z", "path": "be/src/olap/storage_engine.cpp", "diffHunk": "@@ -503,7 +507,8 @@ void StorageEngine::clear_transaction_task(const TTransactionId transaction_id,\n \n void StorageEngine::_start_clean_fd_cache() {\n     VLOG(10) << \"start clean file descritpor cache\";\n-    FileHandler::get_fd_cache()->prune();\n+    // FileHandler::get_fd_cache()->prune();", "originalCommit": "6d3f884e28af0773893a8822f830c989b0a6ac85", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYzNjUzOA==", "url": "https://github.com/apache/incubator-doris/pull/3945#discussion_r446636538", "bodyText": "ok", "author": "xy720", "createdAt": "2020-06-28T11:08:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE2MTYzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE2MTkyMg==", "url": "https://github.com/apache/incubator-doris/pull/3945#discussion_r446161922", "bodyText": "and comment for this field", "author": "morningman", "createdAt": "2020-06-26T12:46:48Z", "path": "be/src/olap/storage_engine.h", "diffHunk": "@@ -297,6 +301,8 @@ class StorageEngine {\n     Cache* _file_descriptor_lru_cache;\n     Cache* _index_stream_lru_cache;\n \n+    std::shared_ptr<Cache> _file_cache;", "originalCommit": "6d3f884e28af0773893a8822f830c989b0a6ac85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE2MzE2MA==", "url": "https://github.com/apache/incubator-doris/pull/3945#discussion_r446163160", "bodyText": "Add comment to emphasize that the _file_cache must be created before FileBlockManager.", "author": "morningman", "createdAt": "2020-06-26T12:49:18Z", "path": "be/src/olap/storage_engine.cpp", "diffHunk": "@@ -157,6 +158,8 @@ Status StorageEngine::_open() {\n \n     _index_stream_lru_cache = new_lru_cache(config::index_stream_cache_capacity);\n \n+    _file_cache.reset(new_lru_cache(config::file_descriptor_cache_capacity));", "originalCommit": "6d3f884e28af0773893a8822f830c989b0a6ac85", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYzNjc2NQ==", "url": "https://github.com/apache/incubator-doris/pull/3945#discussion_r446636765", "bodyText": "Add it above the _file_cache field.", "author": "xy720", "createdAt": "2020-06-28T11:10:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE2MzE2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE2NTE2Mg==", "url": "https://github.com/apache/incubator-doris/pull/3945#discussion_r446165162", "bodyText": "2 problems:\n\nYou should check that the storage engine is truly \"opened\", not just created, or the _file_cache in storage engine is sill null.\nIf StorageEngine::instance() == nullptr, the _s_fd_cache is null either. This could cause problems.\n\nFor problem 2, I suggest that you can modify the open_with_cache() method as below:\nOLAPStatus FileHandler::open_with_cache(const string& file_name, int flag) {\n    if (_cache == nullptr) {\n        return open(file_name, flag);\n    }\n\n    ....\n}", "author": "morningman", "createdAt": "2020-06-26T12:53:27Z", "path": "be/src/olap/file_helper.cpp", "diffHunk": "@@ -44,9 +45,19 @@ FileHandler::FileHandler() :\n         _is_using_cache(false),\n         _cache_handle(NULL) {\n     static std::once_flag once_flag;\n-    std::call_once(once_flag, [] {\n-        _s_fd_cache = new_lru_cache(config::file_descriptor_cache_capacity);\n-    });\n+    #ifdef BE_TEST\n+        std::call_once(once_flag, [] {\n+            _s_fd_cache = new_lru_cache(config::file_descriptor_cache_capacity);\n+        });\n+    #else\n+        // storage engine may not be opened when doris try to read and write \n+        // temp file under the storage root path. So we need to check it.\n+        if (StorageEngine::instance() != nullptr) {", "originalCommit": "6d3f884e28af0773893a8822f830c989b0a6ac85", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE4NjA5Mg==", "url": "https://github.com/apache/incubator-doris/pull/3945#discussion_r446186092", "bodyText": "And also, other place where _s_fd_cache is used should also be taken care of. The release method can be private, so it will only be called by close()", "author": "morningman", "createdAt": "2020-06-26T13:32:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE2NTE2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYzNzMzNg==", "url": "https://github.com/apache/incubator-doris/pull/3945#discussion_r446637336", "bodyText": "Thanks for advices! For problem 1, we can further check weather StorageEngine::instance()->file_cache() == nullptr.", "author": "xy720", "createdAt": "2020-06-28T11:16:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE2NTE2Mg=="}], "type": "inlineReview"}, {"oid": "73fa1b026ebf66b1eae6ef29e775d9dd36b6a409", "url": "https://github.com/apache/incubator-doris/commit/73fa1b026ebf66b1eae6ef29e775d9dd36b6a409", "message": "fix", "committedDate": "2020-06-28T11:07:31Z", "type": "commit"}]}