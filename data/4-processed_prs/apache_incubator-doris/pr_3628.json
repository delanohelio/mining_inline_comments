{"pr_number": 3628, "pr_title": "Fix first start error after upgrade doris to support delete dulplicate table value columns", "pr_createdAt": "2020-05-18T13:15:47Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3628", "timeline": [{"oid": "3031748d5a165d120eb37db6d36f280587ea6bfd", "url": "https://github.com/apache/incubator-doris/commit/3031748d5a165d120eb37db6d36f280587ea6bfd", "message": "fix first start error after upgrade doris to support delete dulplicat table value columns", "committedDate": "2020-05-18T13:06:32Z", "type": "commit"}, {"oid": "52dfc9300f2b966d4f3d5246a42200215cf828cf", "url": "https://github.com/apache/incubator-doris/commit/52dfc9300f2b966d4f3d5246a42200215cf828cf", "message": "fix first start error after upgrade doris to support delete dulplicat table value columns", "committedDate": "2020-05-18T13:21:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjYyMTA1OQ==", "url": "https://github.com/apache/incubator-doris/pull/3628#discussion_r426621059", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            LOG(WARNING) << \"expect zone map size is \" << expect_zone_maps_num << \", actrual num is \" << zone_maps_size\n          \n          \n            \n                            LOG(WARNING) << \"expect zone map size is \" << expect_zone_maps_num << \", actual num is \" << zone_maps_size", "author": "morningman", "createdAt": "2020-05-18T13:21:34Z", "path": "be/src/olap/rowset/alpha_rowset.cpp", "diffHunk": "@@ -300,16 +300,23 @@ OLAPStatus AlphaRowset::init() {\n \n         if (segment_group_meta.zone_maps_size() != 0) {\n             size_t zone_maps_size = segment_group_meta.zone_maps_size();\n-            size_t num_key_columns = _schema->keys_type() == KeysType::DUP_KEYS ? _schema->num_columns() : _schema->num_key_columns();\n-            if (num_key_columns != zone_maps_size) {\n+            size_t expect_zone_maps_num = _schema->keys_type() == KeysType::DUP_KEYS ? _schema->num_columns() : _schema->num_key_columns();\n+            if ((_schema->keys_type() != KeysType::DUP_KEYS && expect_zone_maps_num != zone_maps_size) \n+            || (_schema->keys_type() == KeysType::DUP_KEYS && expect_zone_maps_num < zone_maps_size)) {\n                 LOG(ERROR) << \"column pruning size is error.\"\n+                        << \"KeysType=\" << KeysType_Name(_schema->keys_type()) << \", \"\n                         << \"zone_maps_size=\" << zone_maps_size << \", \"\n-                        << \"num_key_columns=\" << _schema->num_key_columns();\n+                        << \"num_key_columns=\" << _schema->num_key_columns() << \", \"\n+                        << \"num_columns=\" << _schema->num_columns();\n                 return OLAP_ERR_TABLE_INDEX_VALIDATE_ERROR;\n             }\n-            std::vector<std::pair<std::string, std::string>> zone_map_strings(num_key_columns);\n-            std::vector<bool> null_vec(num_key_columns);\n-            for (size_t j = 0; j < num_key_columns; ++j) {\n+            if (expect_zone_maps_num > zone_maps_size) {\n+                LOG(WARNING) << \"expect zone map size is \" << expect_zone_maps_num << \", actrual num is \" << zone_maps_size", "originalCommit": "3031748d5a165d120eb37db6d36f280587ea6bfd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjYyMTY5OQ==", "url": "https://github.com/apache/incubator-doris/pull/3628#discussion_r426621699", "bodyText": "Better add comment to explain the logic here.", "author": "morningman", "createdAt": "2020-05-18T13:22:34Z", "path": "be/src/olap/rowset/alpha_rowset.cpp", "diffHunk": "@@ -300,16 +300,23 @@ OLAPStatus AlphaRowset::init() {\n \n         if (segment_group_meta.zone_maps_size() != 0) {\n             size_t zone_maps_size = segment_group_meta.zone_maps_size();\n-            size_t num_key_columns = _schema->keys_type() == KeysType::DUP_KEYS ? _schema->num_columns() : _schema->num_key_columns();\n-            if (num_key_columns != zone_maps_size) {\n+            size_t expect_zone_maps_num = _schema->keys_type() == KeysType::DUP_KEYS ? _schema->num_columns() : _schema->num_key_columns();", "originalCommit": "3031748d5a165d120eb37db6d36f280587ea6bfd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAyODkwMA==", "url": "https://github.com/apache/incubator-doris/pull/3628#discussion_r427028900", "bodyText": "done", "author": "yangzhg", "createdAt": "2020-05-19T04:52:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjYyMTY5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjYyMjc3Mw==", "url": "https://github.com/apache/incubator-doris/pull/3628#discussion_r426622773", "bodyText": "Better to add tablet id in log, or we can not know what tablet is wrong", "author": "morningman", "createdAt": "2020-05-18T13:24:12Z", "path": "be/src/olap/rowset/alpha_rowset.cpp", "diffHunk": "@@ -300,16 +300,23 @@ OLAPStatus AlphaRowset::init() {\n \n         if (segment_group_meta.zone_maps_size() != 0) {\n             size_t zone_maps_size = segment_group_meta.zone_maps_size();\n-            size_t num_key_columns = _schema->keys_type() == KeysType::DUP_KEYS ? _schema->num_columns() : _schema->num_key_columns();\n-            if (num_key_columns != zone_maps_size) {\n+            size_t expect_zone_maps_num = _schema->keys_type() == KeysType::DUP_KEYS ? _schema->num_columns() : _schema->num_key_columns();\n+            if ((_schema->keys_type() != KeysType::DUP_KEYS && expect_zone_maps_num != zone_maps_size) \n+            || (_schema->keys_type() == KeysType::DUP_KEYS && expect_zone_maps_num < zone_maps_size)) {\n                 LOG(ERROR) << \"column pruning size is error.\"\n+                        << \"KeysType=\" << KeysType_Name(_schema->keys_type()) << \", \"\n                         << \"zone_maps_size=\" << zone_maps_size << \", \"\n-                        << \"num_key_columns=\" << _schema->num_key_columns();\n+                        << \"num_key_columns=\" << _schema->num_key_columns() << \", \"\n+                        << \"num_columns=\" << _schema->num_columns();\n                 return OLAP_ERR_TABLE_INDEX_VALIDATE_ERROR;\n             }\n-            std::vector<std::pair<std::string, std::string>> zone_map_strings(num_key_columns);\n-            std::vector<bool> null_vec(num_key_columns);\n-            for (size_t j = 0; j < num_key_columns; ++j) {\n+            if (expect_zone_maps_num > zone_maps_size) {\n+                LOG(WARNING) << \"expect zone map size is \" << expect_zone_maps_num << \", actrual num is \" << zone_maps_size", "originalCommit": "3031748d5a165d120eb37db6d36f280587ea6bfd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d60b0f8309c009a5f318f444da9392b75615d1dc", "url": "https://github.com/apache/incubator-doris/commit/d60b0f8309c009a5f318f444da9392b75615d1dc", "message": "add comment", "committedDate": "2020-05-19T04:51:34Z", "type": "commit"}]}