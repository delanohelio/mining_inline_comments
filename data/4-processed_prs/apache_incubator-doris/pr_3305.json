{"pr_number": 3305, "pr_title": "[Doris On ES] Add field context for string field keyword type", "pr_createdAt": "2020-04-11T10:25:34Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3305", "timeline": [{"oid": "12eedfbce9419c1e02e3b1e4f6d6d1c9b8f67946", "url": "https://github.com/apache/incubator-doris/commit/12eedfbce9419c1e02e3b1e4f6d6d1c9b8f67946", "message": "Add field context for string field keyword type", "committedDate": "2020-04-11T10:25:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA0ODA1MA==", "url": "https://github.com/apache/incubator-doris/pull/3305#discussion_r407048050", "bodyText": "!table.fieldsContext().isEmpty()\u662f\u4e0d\u662f\u66f4\u597d\u4e00\u70b9", "author": "stalary", "createdAt": "2020-04-11T10:42:01Z", "path": "fe/src/main/java/org/apache/doris/planner/EsScanNode.java", "diffHunk": "@@ -123,6 +123,9 @@ protected void toThrift(TPlanNode msg) {\n         if (table.isDocValueScanEnable()) {\n             esScanNode.setDocvalue_context(table.docValueContext());\n         }\n+        if (table.isKeywordSniffEnable() && table.fieldsContext().size() > 0) {", "originalCommit": "12eedfbce9419c1e02e3b1e4f6d6d1c9b8f67946", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA0ODc0Nw==", "url": "https://github.com/apache/incubator-doris/pull/3305#discussion_r407048747", "bodyText": "\u8fd9\u4e24\u4e2a\u662f\u4e00\u6837\u7684\uff0c\u7b2c\u4e00\u4e2a\u6761\u4ef6\u662f\u7528\u6237\u4e3b\u52a8\u914d\u7f6e\u7684\uff0c\u7b2c\u4e8c\u4e2a\u76ee\u524d\u4ee3\u7801\u90fd\u662f\u8fd9\u4e48\u5199\u7684^o^", "author": "wuyunfeng", "createdAt": "2020-04-11T10:49:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA0ODA1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA2MjExMw==", "url": "https://github.com/apache/incubator-doris/pull/3305#discussion_r407062113", "bodyText": "better to call set_ field_context", "author": "morningman", "createdAt": "2020-04-11T13:08:54Z", "path": "be/src/exec/es/es_predicate.h", "diffHunk": "@@ -198,6 +198,10 @@ class EsPredicate {\n         return _es_query_status;\n     }\n \n+    void field_context(const std::map<std::string, std::string>& field_context) {", "originalCommit": "12eedfbce9419c1e02e3b1e4f6d6d1c9b8f67946", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA2MjU5OQ==", "url": "https://github.com/apache/incubator-doris/pull/3305#discussion_r407062599", "bodyText": "And your UT failed.", "author": "morningman", "createdAt": "2020-04-11T13:13:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA2MjExMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA2NjY0OQ==", "url": "https://github.com/apache/incubator-doris/pull/3305#discussion_r407066649", "bodyText": "Repeat four times.\n        std::string col = slot_desc->col_name();\n        if (_field_context.find(col) != _field_context.end()) {\n            col = _field_context[col];\n        }", "author": "kangkaisen", "createdAt": "2020-04-11T13:53:24Z", "path": "be/src/exec/es/es_predicate.cpp", "diffHunk": "@@ -298,8 +302,12 @@ Status EsPredicate::build_disjuncts_list(const Expr* conjunct) {\n         } else {\n             is_not_null = true;\n         }\n+        std::string col = slot_desc->col_name();", "originalCommit": "12eedfbce9419c1e02e3b1e4f6d6d1c9b8f67946", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE3NjA2Nw==", "url": "https://github.com/apache/incubator-doris/pull/3305#discussion_r407176067", "bodyText": "maybe introduce a common function would increase the complexity", "author": "wuyunfeng", "createdAt": "2020-04-12T10:05:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA2NjY0OQ=="}], "type": "inlineReview"}, {"oid": "e5fcb59fd873790382af6006bab880a0126e6947", "url": "https://github.com/apache/incubator-doris/commit/e5fcb59fd873790382af6006bab880a0126e6947", "message": "modify some code", "committedDate": "2020-04-11T15:51:46Z", "type": "commit"}, {"oid": "2fc9980c7bdd27252de962ae39ce8218dd9d3386", "url": "https://github.com/apache/incubator-doris/commit/2fc9980c7bdd27252de962ae39ce8218dd9d3386", "message": "Change default value", "committedDate": "2020-04-12T12:02:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ3NTM3NA==", "url": "https://github.com/apache/incubator-doris/pull/3305#discussion_r407475374", "bodyText": "If this is only used for keyword path, fields_context seems no relation with keyword", "author": "imay", "createdAt": "2020-04-13T13:22:55Z", "path": "gensrc/thrift/PlanNodes.thrift", "diffHunk": "@@ -222,6 +222,18 @@ struct TEsScanNode {\n     // {\"city\": \"city.raw\"}\n     // use select city from table, if enable the docvalue, we will fetch the `city` field value from `city.raw`\n     3: optional map<string, string> docvalue_context\n+    // used to indicate which string-type field predicate should used xxx.keyword etc.\n+    // \"k1\": {\n+    //    \"type\": \"text\",\n+    //    \"fields\": {\n+    //        \"keyword\": {\n+    //            \"type\": \"keyword\",\n+    //            \"ignore_above\": 256\n+    //           }\n+    //    }\n+    // }\n+    // k1 > 'abc' -> k1.keyword > 'abc'\n+    4: optional map<string, string> fields_context", "originalCommit": "2fc9980c7bdd27252de962ae39ce8218dd9d3386", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUxMDI4OA==", "url": "https://github.com/apache/incubator-doris/pull/3305#discussion_r407510288", "bodyText": "https://www.elastic.co/guide/en/elasticsearch/reference/current/multi-fields.html\nfields is what it means to be, maybe enable_keyword_sniff is no t suitable?", "author": "wuyunfeng", "createdAt": "2020-04-13T14:35:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ3NTM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUyNjc0NQ==", "url": "https://github.com/apache/incubator-doris/pull/3305#discussion_r407526745", "bodyText": "You're right", "author": "imay", "createdAt": "2020-04-13T15:06:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ3NTM3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ4MjQzMw==", "url": "https://github.com/apache/incubator-doris/pull/3305#discussion_r407482433", "bodyText": "ignorecase compare?", "author": "imay", "createdAt": "2020-04-13T13:39:05Z", "path": "fe/src/main/java/org/apache/doris/external/EsStateStore.java", "diffHunk": "@@ -209,36 +206,54 @@ public EsTableState parseClusterState55(String responseStr, EsTable esTable)\n                 }\n                 JSONObject fieldObject = schema.optJSONObject(colName);\n                 String fieldType = fieldObject.optString(\"type\");\n-                if (EsTable.DEFAULT_DOCVALUE_DISABLED_FIELDS.contains(fieldType)) {\n-                    JSONObject fieldsObject = fieldObject.optJSONObject(\"fields\");\n-                    if (fieldsObject != null) {\n-                        for (String key : fieldsObject.keySet()) {\n-                            JSONObject innerTypeObject = fieldsObject.optJSONObject(key);\n-                            if (EsTable.DEFAULT_DOCVALUE_DISABLED_FIELDS.contains(innerTypeObject.optString(\"type\"))) {\n-                                continue;\n-                            }\n-                            if (innerTypeObject.has(\"doc_values\")) {\n-                                boolean docValue = innerTypeObject.getBoolean(\"doc_values\");\n-                                if (docValue) {\n-                                    esTable.addDocValueField(colName, colName);\n+                // string-type field used keyword type to generate predicate\n+                if (esTable.isKeywordSniffEnable()) {\n+                    // if text field type seen, we should use the `field` keyword type?\n+                    if (\"text\".equals(fieldType)) {", "originalCommit": "2fc9980c7bdd27252de962ae39ce8218dd9d3386", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ5OTA4OQ==", "url": "https://github.com/apache/incubator-doris/pull/3305#discussion_r407499089", "bodyText": "Elasticsearch's type must be lowercase...", "author": "wuyunfeng", "createdAt": "2020-04-13T14:13:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ4MjQzMw=="}], "type": "inlineReview"}]}