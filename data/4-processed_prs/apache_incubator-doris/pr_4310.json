{"pr_number": 4310, "pr_title": "Support batch delete [part 1]", "pr_createdAt": "2020-08-10T04:42:17Z", "pr_url": "https://github.com/apache/incubator-doris/pull/4310", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc4ODIyMg==", "url": "https://github.com/apache/incubator-doris/pull/4310#discussion_r467788222", "bodyText": "Place _name under _key_coder could make a lesser size of Field.", "author": "sduzh", "createdAt": "2020-08-10T09:32:44Z", "path": "be/src/olap/field.h", "diffHunk": "@@ -261,6 +262,7 @@ class Field {\n     const KeyCoder* _key_coder;\n     uint16_t _index_size;\n     bool _is_nullable;\n+    std::string _name;", "originalCommit": "984dddff1743e8754cc53dc6be7c86f98cc45629", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc4OTQ5OQ==", "url": "https://github.com/apache/incubator-doris/pull/4310#discussion_r467789499", "bodyText": "const std::string& name() const { return _name; }", "author": "sduzh", "createdAt": "2020-08-10T09:35:09Z", "path": "be/src/olap/field.h", "diffHunk": "@@ -55,6 +55,7 @@ class Field {\n     inline int32_t length() const { return _length; }\n     inline size_t field_size() const { return size() + 1; }\n     inline size_t index_size() const { return _index_size; }\n+    inline std::string name() const { return _name; }", "originalCommit": "984dddff1743e8754cc53dc6be7c86f98cc45629", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc5MTIxMg==", "url": "https://github.com/apache/incubator-doris/pull/4310#discussion_r467791212", "bodyText": "std::vector::at has extra runtime overhead, compared with operator[].", "author": "sduzh", "createdAt": "2020-08-10T09:38:47Z", "path": "be/src/olap/schema.h", "diffHunk": "@@ -53,19 +53,21 @@ class Schema {\n             }\n             columns.push_back(column);\n         }\n-\n+        _delete_sign_idx = tablet_schema.delete_sign_idx();\n         _init(columns, col_ids, num_key_columns);\n     }\n \n     // All the columns of one table may exist in the columns param, but col_ids is only a subset.\n     Schema(const std::vector<TabletColumn>& columns, const std::vector<ColumnId>& col_ids) {\n         size_t num_key_columns = 0;\n-        for (const auto& c: columns) {\n-            if (c.is_key()) {\n+        for (size_t i = 0; i < columns.size(); ++i) {\n+            if (columns.at(i).is_key()) {", "originalCommit": "984dddff1743e8754cc53dc6be7c86f98cc45629", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3c6aac83543e0c4a64a248f111b6304b7417843c", "url": "https://github.com/apache/incubator-doris/commit/3c6aac83543e0c4a64a248f111b6304b7417843c", "message": "support batch delete", "committedDate": "2020-08-10T11:52:42Z", "type": "forcePushed"}, {"oid": "c5387d586c1ebaf9f895456383360bbb789fbe99", "url": "https://github.com/apache/incubator-doris/commit/c5387d586c1ebaf9f895456383360bbb789fbe99", "message": "support batch delete", "committedDate": "2020-08-11T01:48:09Z", "type": "commit"}, {"oid": "c5387d586c1ebaf9f895456383360bbb789fbe99", "url": "https://github.com/apache/incubator-doris/commit/c5387d586c1ebaf9f895456383360bbb789fbe99", "message": "support batch delete", "committedDate": "2020-08-11T01:48:09Z", "type": "forcePushed"}, {"oid": "924eb33f997bdb30bbc7ac319b4e76b45da4bd3b", "url": "https://github.com/apache/incubator-doris/commit/924eb33f997bdb30bbc7ac319b4e76b45da4bd3b", "message": "fix hadoop load", "committedDate": "2020-08-13T07:54:16Z", "type": "commit"}, {"oid": "924eb33f997bdb30bbc7ac319b4e76b45da4bd3b", "url": "https://github.com/apache/incubator-doris/commit/924eb33f997bdb30bbc7ac319b4e76b45da4bd3b", "message": "fix hadoop load", "committedDate": "2020-08-13T07:54:16Z", "type": "forcePushed"}, {"oid": "9273d17d9440dbf9de3aa28168cf1753921eba15", "url": "https://github.com/apache/incubator-doris/commit/9273d17d9440dbf9de3aa28168cf1753921eba15", "message": "fix hadoop load", "committedDate": "2020-08-13T08:04:40Z", "type": "commit"}, {"oid": "d1291cb359dfc667c79dd650cc962928acf78597", "url": "https://github.com/apache/incubator-doris/commit/d1291cb359dfc667c79dd650cc962928acf78597", "message": "fix hadoop load", "committedDate": "2020-08-13T08:12:20Z", "type": "commit"}, {"oid": "f8ca2330a94587a3b4d5ea8acc552310f2417b99", "url": "https://github.com/apache/incubator-doris/commit/f8ca2330a94587a3b4d5ea8acc552310f2417b99", "message": "fix hadoop load", "committedDate": "2020-08-13T08:17:52Z", "type": "commit"}, {"oid": "913c628e5bf4c1da2a34b5541fa7c58d31cb2fa5", "url": "https://github.com/apache/incubator-doris/commit/913c628e5bf4c1da2a34b5541fa7c58d31cb2fa5", "message": "fix hadoop load", "committedDate": "2020-08-13T09:15:20Z", "type": "commit"}, {"oid": "4d657ab4df9867431790a6cba7cbb21984fa5b11", "url": "https://github.com/apache/incubator-doris/commit/4d657ab4df9867431790a6cba7cbb21984fa5b11", "message": "fix hadoop load", "committedDate": "2020-08-13T09:21:14Z", "type": "commit"}, {"oid": "ae8bd68e29547a13d0bf537e8004989aa96be6d3", "url": "https://github.com/apache/incubator-doris/commit/ae8bd68e29547a13d0bf537e8004989aa96be6d3", "message": "fix hadoop load", "committedDate": "2020-08-13T09:27:00Z", "type": "commit"}, {"oid": "72be46170b0533fd091328102ae096c8222c5065", "url": "https://github.com/apache/incubator-doris/commit/72be46170b0533fd091328102ae096c8222c5065", "message": "fix hadoop load", "committedDate": "2020-08-13T09:44:07Z", "type": "commit"}, {"oid": "acf5d0143fd2191d9309582c03fab3d327e42212", "url": "https://github.com/apache/incubator-doris/commit/acf5d0143fd2191d9309582c03fab3d327e42212", "message": "fix hadoop load", "committedDate": "2020-08-13T10:09:20Z", "type": "commit"}, {"oid": "c2b084ad89cde603bcf85a7de3840c12e503705c", "url": "https://github.com/apache/incubator-doris/commit/c2b084ad89cde603bcf85a7de3840c12e503705c", "message": "fix hadoop load", "committedDate": "2020-08-14T02:58:35Z", "type": "commit"}, {"oid": "7e1e58bfd55ae4eefcd298c13aa4b696b2224e75", "url": "https://github.com/apache/incubator-doris/commit/7e1e58bfd55ae4eefcd298c13aa4b696b2224e75", "message": "fix hadoop load", "committedDate": "2020-08-14T03:00:22Z", "type": "commit"}, {"oid": "4a6dfd47ebf5c4503955106235f7c3bafed408aa", "url": "https://github.com/apache/incubator-doris/commit/4a6dfd47ebf5c4503955106235f7c3bafed408aa", "message": "fix hadoop load", "committedDate": "2020-08-14T03:09:12Z", "type": "commit"}, {"oid": "d541ed70e9837136888aac186afb0b0c8183aa97", "url": "https://github.com/apache/incubator-doris/commit/d541ed70e9837136888aac186afb0b0c8183aa97", "message": "fix hadoop load", "committedDate": "2020-08-14T03:38:26Z", "type": "commit"}, {"oid": "c50151776adf685a9d6e7bffefe575572bd2fee9", "url": "https://github.com/apache/incubator-doris/commit/c50151776adf685a9d6e7bffefe575572bd2fee9", "message": "fix hadoop load", "committedDate": "2020-08-14T09:13:10Z", "type": "commit"}, {"oid": "a82e183ffaa4a5dcb3326c7f46c60bf3fc07384b", "url": "https://github.com/apache/incubator-doris/commit/a82e183ffaa4a5dcb3326c7f46c60bf3fc07384b", "message": "Merge branch 'master' into support_batch_delete", "committedDate": "2020-08-17T03:13:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU1MDE5Mw==", "url": "https://github.com/apache/incubator-doris/pull/4310#discussion_r471550193", "bodyText": "Why?", "author": "morningman", "createdAt": "2020-08-17T15:16:48Z", "path": "fe/fe-core/pom.xml", "diffHunk": "@@ -36,7 +36,7 @@ under the License.\n \n     <properties>\n         <doris.home>${basedir}/../../</doris.home>\n-        <fe_ut_parallel>${env.FE_UT_PARALLEL}</fe_ut_parallel>\n+        <fe_ut_parallel>1</fe_ut_parallel>", "originalCommit": "a82e183ffaa4a5dcb3326c7f46c60bf3fc07384b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg3OTI0MQ==", "url": "https://github.com/apache/incubator-doris/pull/4310#discussion_r471879241", "bodyText": "This can avoid the problem that intilj will prompt a pom syntax error when the environment variable is not set", "author": "yangzhg", "createdAt": "2020-08-18T02:37:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU1MDE5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU1Mzg3MQ==", "url": "https://github.com/apache/incubator-doris/pull/4310#discussion_r471553871", "bodyText": "miss to modify the base index?", "author": "morningman", "createdAt": "2020-08-17T15:22:02Z", "path": "fe/fe-core/src/main/java/org/apache/doris/analysis/AlterTableStmt.java", "diffHunk": "@@ -70,6 +76,50 @@ public void analyze(Analyzer analyzer) throws UserException {\n         }\n     }\n \n+    public void rewriteAlterClause(OlapTable table) throws UserException {\n+        List<AlterClause> clauses = new ArrayList<>();\n+        for (AlterClause alterClause : ops) {\n+            if (alterClause instanceof EnableFeatureClause\n+                    && ((EnableFeatureClause) alterClause).getFeature() == EnableFeatureClause.Features.BATCH_DELETE) {\n+                if (table.getKeysType() != KeysType.UNIQUE_KEYS) {\n+                    throw new AnalysisException(\"Batch delete only support in unique tables.\");\n+                }\n+                // has rollup table\n+                if (table.getVisibleIndex().size() > 1) {\n+                    for (MaterializedIndex idx : table.getVisibleIndex()) {\n+                        if (idx.getId() == table.getBaseIndexId()) {", "originalCommit": "a82e183ffaa4a5dcb3326c7f46c60bf3fc07384b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg3ODU1MQ==", "url": "https://github.com/apache/incubator-doris/pull/4310#discussion_r471878551", "bodyText": "add  a column to rollup index it will add to base table automaticlly, if add a column here it will duplicated", "author": "yangzhg", "createdAt": "2020-08-18T02:34:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU1Mzg3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzc2MjA4OQ==", "url": "https://github.com/apache/incubator-doris/pull/4310#discussion_r473762089", "bodyText": "Ok, better to add a comment here", "author": "morningman", "createdAt": "2020-08-20T08:31:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU1Mzg3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU1OTk1OA==", "url": "https://github.com/apache/incubator-doris/pull/4310#discussion_r471559958", "bodyText": "code style", "author": "morningman", "createdAt": "2020-08-17T15:31:08Z", "path": "fe/fe-core/src/main/java/org/apache/doris/analysis/DataDescription.java", "diffHunk": "@@ -172,6 +183,9 @@ public DataDescription(String tableName,\n         this.columnMappingList = columnMappingList;\n         this.whereExpr = whereExpr;\n         this.srcTableName = srcTableName;\n+        this.mergeType = mergeType;\n+        this.deleteCondition = deleteCondition\n+        ;", "originalCommit": "a82e183ffaa4a5dcb3326c7f46c60bf3fc07384b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cf0907e534feccbab449fa379d421f4228eac25d", "url": "https://github.com/apache/incubator-doris/commit/cf0907e534feccbab449fa379d421f4228eac25d", "message": "fix comment", "committedDate": "2020-08-18T02:38:39Z", "type": "commit"}, {"oid": "90863c47b17425988fc1bfee565c8a49b956ef07", "url": "https://github.com/apache/incubator-doris/commit/90863c47b17425988fc1bfee565c8a49b956ef07", "message": "add comment", "committedDate": "2020-08-20T09:49:11Z", "type": "commit"}, {"oid": "5b0d76513f1e365fc9e7689c0686fd9df274ed45", "url": "https://github.com/apache/incubator-doris/commit/5b0d76513f1e365fc9e7689c0686fd9df274ed45", "message": "Merge branch 'master' into support_batch_delete", "committedDate": "2020-08-21T14:42:40Z", "type": "commit"}]}