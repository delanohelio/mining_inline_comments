{"pr_number": 3878, "pr_title": "[optimize] Optimize spark load/broker load reading parquet format file", "pr_createdAt": "2020-06-16T02:19:21Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3878", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU3MDk5OA==", "url": "https://github.com/apache/incubator-doris/pull/3878#discussion_r440570998", "bodyText": "Please add the comment to describe why do we need this class, and when should we use it.", "author": "kangkaisen", "createdAt": "2020-06-16T03:52:37Z", "path": "be/src/exec/buffered_reader.h", "diffHunk": "@@ -0,0 +1,61 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+#pragma once\n+\n+#include <stdint.h>\n+\n+#include \"common/status.h\"\n+#include \"olap/olap_define.h\"\n+#include \"exec/file_reader.h\"\n+\n+namespace doris {\n+\n+// Buffered Reader of broker", "originalCommit": "da0ee0059fbeab1271750b12ac9db5c9d5e874bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU5OTQyNA==", "url": "https://github.com/apache/incubator-doris/pull/3878#discussion_r442599424", "bodyText": "ok", "author": "xy720", "createdAt": "2020-06-19T02:34:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU3MDk5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk1MjI0NA==", "url": "https://github.com/apache/incubator-doris/pull/3878#discussion_r440952244", "bodyText": "Let the caller print the log, not here.", "author": "morningman", "createdAt": "2020-06-16T15:41:44Z", "path": "be/src/exec/buffered_reader.cpp", "diffHunk": "@@ -0,0 +1,162 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+#include \"exec/buffered_reader.h\"\n+\n+#include <sstream>\n+#include <algorithm>\n+\n+#include \"common/logging.h\"\n+\n+namespace doris {\n+\n+// buffered reader\n+\n+BufferedReader::BufferedReader(FileReader* reader)\n+        : _reader(reader),\n+          _buffer_size(1024 * 1024),\n+          _buffer_offset(0),\n+          _buffer_limit(0),\n+          _cur_offset(0) {\n+    _buffer = new char[_buffer_size];\n+}\n+\n+BufferedReader::BufferedReader(FileReader* reader, int64_t buffer_size)\n+        : _reader(reader),\n+          _buffer_size(buffer_size),\n+          _buffer_offset(0),\n+          _buffer_limit(0),\n+          _cur_offset(0) {\n+    _buffer = new char[_buffer_size];\n+}\n+\n+BufferedReader::~BufferedReader() {\n+    close();\n+}\n+\n+Status BufferedReader::open() {\n+    if (!_reader) {\n+        std::stringstream ss;\n+        ss << \"Open buffered reader failed, reader is null\";\n+        LOG(WARNING) << ss.str();", "originalCommit": "da0ee0059fbeab1271750b12ac9db5c9d5e874bf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk1MzY1NA==", "url": "https://github.com/apache/incubator-doris/pull/3878#discussion_r440953654", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // If the reader need the file size, set it when construct BrokerReader.\n          \n          \n            \n                // If the reader need the file size, set it when construct FileReader.", "author": "morningman", "createdAt": "2020-06-16T15:43:37Z", "path": "be/src/exec/buffered_reader.h", "diffHunk": "@@ -0,0 +1,61 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+#pragma once\n+\n+#include <stdint.h>\n+\n+#include \"common/status.h\"\n+#include \"olap/olap_define.h\"\n+#include \"exec/file_reader.h\"\n+\n+namespace doris {\n+\n+// Buffered Reader of broker\n+class BufferedReader : public FileReader {\n+public:\n+    // If the reader need the file size, set it when construct BrokerReader.", "originalCommit": "da0ee0059fbeab1271750b12ac9db5c9d5e874bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMyNzkyMw==", "url": "https://github.com/apache/incubator-doris/pull/3878#discussion_r442327923", "bodyText": "done", "author": "xy720", "createdAt": "2020-06-18T15:49:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk1MzY1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk1Mzg1NA==", "url": "https://github.com/apache/incubator-doris/pull/3878#discussion_r440953854", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                Status fill();\n          \n          \n            \n                Status _fill();", "author": "morningman", "createdAt": "2020-06-16T15:43:53Z", "path": "be/src/exec/buffered_reader.h", "diffHunk": "@@ -0,0 +1,61 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+#pragma once\n+\n+#include <stdint.h>\n+\n+#include \"common/status.h\"\n+#include \"olap/olap_define.h\"\n+#include \"exec/file_reader.h\"\n+\n+namespace doris {\n+\n+// Buffered Reader of broker\n+class BufferedReader : public FileReader {\n+public:\n+    // If the reader need the file size, set it when construct BrokerReader.\n+    // There is no other way to set the file size.\n+    BufferedReader(FileReader* reader);\n+    BufferedReader(FileReader* reader, int64_t buffer_size);\n+    virtual ~BufferedReader();\n+\n+    virtual Status open() override;\n+\n+    // Read \n+    virtual Status read(uint8_t* buf, size_t* buf_len, bool* eof) override;\n+    virtual Status readat(int64_t position, int64_t nbytes, int64_t* bytes_read, void* out) override;\n+    virtual Status read_one_message(uint8_t** buf, size_t* length) override;\n+    virtual int64_t size() override;\n+    virtual Status seek(int64_t position) override;\n+    virtual Status tell(int64_t* position) override;\n+    virtual void close() override;\n+    virtual bool closed() override;\n+\n+private:\n+    Status fill();", "originalCommit": "da0ee0059fbeab1271750b12ac9db5c9d5e874bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMyNzc4MQ==", "url": "https://github.com/apache/incubator-doris/pull/3878#discussion_r442327781", "bodyText": "done", "author": "xy720", "createdAt": "2020-06-18T15:49:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk1Mzg1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk1MzkwOA==", "url": "https://github.com/apache/incubator-doris/pull/3878#discussion_r440953908", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                Status read_once(int64_t position, int64_t nbytes, int64_t* bytes_read, void* out);\n          \n          \n            \n                Status _read_once(int64_t position, int64_t nbytes, int64_t* bytes_read, void* out);", "author": "morningman", "createdAt": "2020-06-16T15:43:59Z", "path": "be/src/exec/buffered_reader.h", "diffHunk": "@@ -0,0 +1,61 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+#pragma once\n+\n+#include <stdint.h>\n+\n+#include \"common/status.h\"\n+#include \"olap/olap_define.h\"\n+#include \"exec/file_reader.h\"\n+\n+namespace doris {\n+\n+// Buffered Reader of broker\n+class BufferedReader : public FileReader {\n+public:\n+    // If the reader need the file size, set it when construct BrokerReader.\n+    // There is no other way to set the file size.\n+    BufferedReader(FileReader* reader);\n+    BufferedReader(FileReader* reader, int64_t buffer_size);\n+    virtual ~BufferedReader();\n+\n+    virtual Status open() override;\n+\n+    // Read \n+    virtual Status read(uint8_t* buf, size_t* buf_len, bool* eof) override;\n+    virtual Status readat(int64_t position, int64_t nbytes, int64_t* bytes_read, void* out) override;\n+    virtual Status read_one_message(uint8_t** buf, size_t* length) override;\n+    virtual int64_t size() override;\n+    virtual Status seek(int64_t position) override;\n+    virtual Status tell(int64_t* position) override;\n+    virtual void close() override;\n+    virtual bool closed() override;\n+\n+private:\n+    Status fill();\n+    Status read_once(int64_t position, int64_t nbytes, int64_t* bytes_read, void* out);", "originalCommit": "da0ee0059fbeab1271750b12ac9db5c9d5e874bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMyNzcwNQ==", "url": "https://github.com/apache/incubator-doris/pull/3878#discussion_r442327705", "bodyText": "done", "author": "xy720", "createdAt": "2020-06-18T15:49:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk1MzkwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk1NDkwNg==", "url": "https://github.com/apache/incubator-doris/pull/3878#discussion_r440954906", "bodyText": "Is it necessary to fill() when open()?", "author": "morningman", "createdAt": "2020-06-16T15:45:24Z", "path": "be/src/exec/buffered_reader.cpp", "diffHunk": "@@ -0,0 +1,162 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+#include \"exec/buffered_reader.h\"\n+\n+#include <sstream>\n+#include <algorithm>\n+\n+#include \"common/logging.h\"\n+\n+namespace doris {\n+\n+// buffered reader\n+\n+BufferedReader::BufferedReader(FileReader* reader)\n+        : _reader(reader),\n+          _buffer_size(1024 * 1024),\n+          _buffer_offset(0),\n+          _buffer_limit(0),\n+          _cur_offset(0) {\n+    _buffer = new char[_buffer_size];\n+}\n+\n+BufferedReader::BufferedReader(FileReader* reader, int64_t buffer_size)\n+        : _reader(reader),\n+          _buffer_size(buffer_size),\n+          _buffer_offset(0),\n+          _buffer_limit(0),\n+          _cur_offset(0) {\n+    _buffer = new char[_buffer_size];\n+}\n+\n+BufferedReader::~BufferedReader() {\n+    close();\n+}\n+\n+Status BufferedReader::open() {\n+    if (!_reader) {\n+        std::stringstream ss;\n+        ss << \"Open buffered reader failed, reader is null\";\n+        LOG(WARNING) << ss.str();\n+        return Status::InternalError(ss.str());\n+    }\n+    RETURN_IF_ERROR(_reader->open());\n+    RETURN_IF_ERROR(fill());", "originalCommit": "da0ee0059fbeab1271750b12ac9db5c9d5e874bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMyNzIzOA==", "url": "https://github.com/apache/incubator-doris/pull/3878#discussion_r442327238", "bodyText": "Yes. If not call fill() in open(), the actual length of the buffer will be 0 when user call read().", "author": "xy720", "createdAt": "2020-06-18T15:48:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk1NDkwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk1NzIwOQ==", "url": "https://github.com/apache/incubator-doris/pull/3878#discussion_r440957209", "bodyText": "What is this retry for? add comment for it.", "author": "morningman", "createdAt": "2020-06-16T15:48:32Z", "path": "be/src/exec/buffered_reader.cpp", "diffHunk": "@@ -0,0 +1,162 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+#include \"exec/buffered_reader.h\"\n+\n+#include <sstream>\n+#include <algorithm>\n+\n+#include \"common/logging.h\"\n+\n+namespace doris {\n+\n+// buffered reader\n+\n+BufferedReader::BufferedReader(FileReader* reader)\n+        : _reader(reader),\n+          _buffer_size(1024 * 1024),\n+          _buffer_offset(0),\n+          _buffer_limit(0),\n+          _cur_offset(0) {\n+    _buffer = new char[_buffer_size];\n+}\n+\n+BufferedReader::BufferedReader(FileReader* reader, int64_t buffer_size)\n+        : _reader(reader),\n+          _buffer_size(buffer_size),\n+          _buffer_offset(0),\n+          _buffer_limit(0),\n+          _cur_offset(0) {\n+    _buffer = new char[_buffer_size];\n+}\n+\n+BufferedReader::~BufferedReader() {\n+    close();\n+}\n+\n+Status BufferedReader::open() {\n+    if (!_reader) {\n+        std::stringstream ss;\n+        ss << \"Open buffered reader failed, reader is null\";\n+        LOG(WARNING) << ss.str();\n+        return Status::InternalError(ss.str());\n+    }\n+    RETURN_IF_ERROR(_reader->open());\n+    RETURN_IF_ERROR(fill());\n+    return Status::OK();\n+}\n+\n+//not support\n+Status BufferedReader::read_one_message(uint8_t** buf, size_t* length) {\n+    return Status::NotSupported(\"Not support\");\n+}\n+\n+Status BufferedReader::read(uint8_t* buf, size_t* buf_len, bool* eof) {\n+    DCHECK_NE(*buf_len, 0);\n+    int64_t bytes_read;\n+    RETURN_IF_ERROR(readat(_cur_offset, (int64_t)*buf_len, &bytes_read, buf));\n+    if (bytes_read == 0) {\n+        *eof = true;\n+    } else {\n+        *eof = false;\n+    }\n+    return Status::OK();\n+}\n+\n+Status BufferedReader::readat(int64_t position, int64_t nbytes, int64_t* bytes_read, void* out) {\n+    if (nbytes <= 0) {\n+        *bytes_read = 0;\n+        return Status::OK();\n+    }\n+    RETURN_IF_ERROR(read_once(position, nbytes, bytes_read, out));\n+    //EOF\n+    if (*bytes_read <= 0) {\n+        return Status::OK();\n+    }\n+    while (*bytes_read < nbytes) {\n+        int64_t len;\n+        RETURN_IF_ERROR(read_once(position + *bytes_read, nbytes - *bytes_read, &len, reinterpret_cast<char*>(out) + *bytes_read));\n+        // EOF\n+        if (len <= 0) {\n+            break;\n+        }\n+        *bytes_read += len;\n+    }\n+    return Status::OK();\n+}\n+\n+Status BufferedReader::read_once(int64_t position, int64_t nbytes, int64_t* bytes_read, void* out) {\n+    // requested bytes missed the local buffer\n+    if (position >= _buffer_limit || position < _buffer_offset) {\n+        // if requested length is larger than the capacity of buffer, do not\n+        // need to copy the character into local buffer.\n+        if (nbytes > _buffer_limit - _buffer_offset) {\n+            return _reader->readat(position, nbytes, bytes_read, out);\n+        }\n+        _buffer_offset = position;\n+        RETURN_IF_ERROR(fill());\n+        if (position >= _buffer_limit) {\n+            *bytes_read = 0;\n+            return Status::OK();\n+        }\n+    } \n+    int64_t len = std::min(_buffer_limit - position, nbytes);\n+    int64_t off = position - _buffer_offset;\n+    memcpy(out, _buffer + off, len);\n+    *bytes_read = len;\n+    _cur_offset = position + *bytes_read;\n+    return Status::OK();\n+}\n+\n+Status BufferedReader::fill() {\n+    if (_buffer_offset >= 0) {\n+        int64_t bytes_read;\n+        int retry_times = 1;", "originalCommit": "da0ee0059fbeab1271750b12ac9db5c9d5e874bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMyNzU5OQ==", "url": "https://github.com/apache/incubator-doris/pull/3878#discussion_r442327599", "bodyText": "ok", "author": "xy720", "createdAt": "2020-06-18T15:49:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk1NzIwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk1OTgyMw==", "url": "https://github.com/apache/incubator-doris/pull/3878#discussion_r440959823", "bodyText": "when will position > _buffer_limit?", "author": "morningman", "createdAt": "2020-06-16T15:52:04Z", "path": "be/src/exec/buffered_reader.cpp", "diffHunk": "@@ -0,0 +1,162 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+#include \"exec/buffered_reader.h\"\n+\n+#include <sstream>\n+#include <algorithm>\n+\n+#include \"common/logging.h\"\n+\n+namespace doris {\n+\n+// buffered reader\n+\n+BufferedReader::BufferedReader(FileReader* reader)\n+        : _reader(reader),\n+          _buffer_size(1024 * 1024),\n+          _buffer_offset(0),\n+          _buffer_limit(0),\n+          _cur_offset(0) {\n+    _buffer = new char[_buffer_size];\n+}\n+\n+BufferedReader::BufferedReader(FileReader* reader, int64_t buffer_size)\n+        : _reader(reader),\n+          _buffer_size(buffer_size),\n+          _buffer_offset(0),\n+          _buffer_limit(0),\n+          _cur_offset(0) {\n+    _buffer = new char[_buffer_size];\n+}\n+\n+BufferedReader::~BufferedReader() {\n+    close();\n+}\n+\n+Status BufferedReader::open() {\n+    if (!_reader) {\n+        std::stringstream ss;\n+        ss << \"Open buffered reader failed, reader is null\";\n+        LOG(WARNING) << ss.str();\n+        return Status::InternalError(ss.str());\n+    }\n+    RETURN_IF_ERROR(_reader->open());\n+    RETURN_IF_ERROR(fill());\n+    return Status::OK();\n+}\n+\n+//not support\n+Status BufferedReader::read_one_message(uint8_t** buf, size_t* length) {\n+    return Status::NotSupported(\"Not support\");\n+}\n+\n+Status BufferedReader::read(uint8_t* buf, size_t* buf_len, bool* eof) {\n+    DCHECK_NE(*buf_len, 0);\n+    int64_t bytes_read;\n+    RETURN_IF_ERROR(readat(_cur_offset, (int64_t)*buf_len, &bytes_read, buf));\n+    if (bytes_read == 0) {\n+        *eof = true;\n+    } else {\n+        *eof = false;\n+    }\n+    return Status::OK();\n+}\n+\n+Status BufferedReader::readat(int64_t position, int64_t nbytes, int64_t* bytes_read, void* out) {\n+    if (nbytes <= 0) {\n+        *bytes_read = 0;\n+        return Status::OK();\n+    }\n+    RETURN_IF_ERROR(read_once(position, nbytes, bytes_read, out));\n+    //EOF\n+    if (*bytes_read <= 0) {\n+        return Status::OK();\n+    }\n+    while (*bytes_read < nbytes) {\n+        int64_t len;\n+        RETURN_IF_ERROR(read_once(position + *bytes_read, nbytes - *bytes_read, &len, reinterpret_cast<char*>(out) + *bytes_read));\n+        // EOF\n+        if (len <= 0) {\n+            break;\n+        }\n+        *bytes_read += len;\n+    }\n+    return Status::OK();\n+}\n+\n+Status BufferedReader::read_once(int64_t position, int64_t nbytes, int64_t* bytes_read, void* out) {\n+    // requested bytes missed the local buffer\n+    if (position >= _buffer_limit || position < _buffer_offset) {\n+        // if requested length is larger than the capacity of buffer, do not\n+        // need to copy the character into local buffer.\n+        if (nbytes > _buffer_limit - _buffer_offset) {\n+            return _reader->readat(position, nbytes, bytes_read, out);\n+        }\n+        _buffer_offset = position;\n+        RETURN_IF_ERROR(fill());\n+        if (position >= _buffer_limit) {", "originalCommit": "da0ee0059fbeab1271750b12ac9db5c9d5e874bf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bec31a76f4ca8ab337415633e4925aa671569261", "url": "https://github.com/apache/incubator-doris/commit/bec31a76f4ca8ab337415633e4925aa671569261", "message": "add cache buffer reader", "committedDate": "2020-06-19T02:37:46Z", "type": "commit"}, {"oid": "dfc7453b6fc663f5ef2a780aa171851c11db9a85", "url": "https://github.com/apache/incubator-doris/commit/dfc7453b6fc663f5ef2a780aa171851c11db9a85", "message": "add ut", "committedDate": "2020-06-19T02:37:46Z", "type": "commit"}, {"oid": "3dcd6a8bd4bcff3b3c47a0a27e00d77130dc3396", "url": "https://github.com/apache/incubator-doris/commit/3dcd6a8bd4bcff3b3c47a0a27e00d77130dc3396", "message": "be/src/exec/buffered_reader.h", "committedDate": "2020-06-19T02:37:46Z", "type": "commit"}, {"oid": "91651659e0a6c250c586abeb170e5cfbaad7bf5b", "url": "https://github.com/apache/incubator-doris/commit/91651659e0a6c250c586abeb170e5cfbaad7bf5b", "message": "fix run-ut.sh", "committedDate": "2020-06-19T02:42:18Z", "type": "commit"}, {"oid": "91651659e0a6c250c586abeb170e5cfbaad7bf5b", "url": "https://github.com/apache/incubator-doris/commit/91651659e0a6c250c586abeb170e5cfbaad7bf5b", "message": "fix run-ut.sh", "committedDate": "2020-06-19T02:42:18Z", "type": "forcePushed"}, {"oid": "6b62621b4beb539eafefdd2bcc6a91596b9bfd1a", "url": "https://github.com/apache/incubator-doris/commit/6b62621b4beb539eafefdd2bcc6a91596b9bfd1a", "message": "fix run-ut.sh", "committedDate": "2020-06-19T02:44:33Z", "type": "commit"}, {"oid": "50f6ea119373612919a02b8cb5df5aa53e5f8569", "url": "https://github.com/apache/incubator-doris/commit/50f6ea119373612919a02b8cb5df5aa53e5f8569", "message": "fix run-ut.sh", "committedDate": "2020-06-19T02:45:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEyNTg4Nw==", "url": "https://github.com/apache/incubator-doris/pull/3878#discussion_r443125887", "bodyText": "You need to check the result, or the unit test is meaningless", "author": "morningman", "createdAt": "2020-06-20T12:04:49Z", "path": "be/test/exec/buffered_reader_test.cpp", "diffHunk": "@@ -0,0 +1,102 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+#include <gtest/gtest.h>\n+\n+#include \"exec/local_file_reader.h\"\n+#include \"exec/buffered_reader.h\"\n+#include \"util/stopwatch.hpp\"\n+\n+namespace doris {\n+class BufferedReaderTest : public testing::Test {\n+public:\n+    BufferedReaderTest() {}\n+\n+protected:\n+    virtual void SetUp() {\n+    }\n+    virtual void TearDown() {\n+    }\n+};\n+\n+TEST_F(BufferedReaderTest, normal_use) {\n+    LocalFileReader file_reader(\n+            \"./be/test/exec/test_data/buffered_reader/buffered_reader_test_file\", 0);\n+    BufferedReader reader(&file_reader);\n+    auto st = reader.open();\n+    ASSERT_TRUE(st.ok());\n+    uint8_t buf[32 * 1024];\n+    MonotonicStopWatch watch;\n+    watch.start();\n+    bool eof = false;\n+    size_t read_length = 0;\n+    while (!eof) {\n+        size_t buf_len = 32 * 1024;\n+        st = reader.read(buf, &buf_len, &eof);\n+        ASSERT_TRUE(st.ok());\n+        read_length += buf_len;\n+    }", "originalCommit": "50f6ea119373612919a02b8cb5df5aa53e5f8569", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEyNTk3Mg==", "url": "https://github.com/apache/incubator-doris/pull/3878#discussion_r443125972", "bodyText": "check the buf_len after read()", "author": "morningman", "createdAt": "2020-06-20T12:06:05Z", "path": "be/test/exec/buffered_reader_test.cpp", "diffHunk": "@@ -0,0 +1,102 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+#include <gtest/gtest.h>\n+\n+#include \"exec/local_file_reader.h\"\n+#include \"exec/buffered_reader.h\"\n+#include \"util/stopwatch.hpp\"\n+\n+namespace doris {\n+class BufferedReaderTest : public testing::Test {\n+public:\n+    BufferedReaderTest() {}\n+\n+protected:\n+    virtual void SetUp() {\n+    }\n+    virtual void TearDown() {\n+    }\n+};\n+\n+TEST_F(BufferedReaderTest, normal_use) {\n+    LocalFileReader file_reader(\n+            \"./be/test/exec/test_data/buffered_reader/buffered_reader_test_file\", 0);\n+    BufferedReader reader(&file_reader);\n+    auto st = reader.open();\n+    ASSERT_TRUE(st.ok());\n+    uint8_t buf[32 * 1024];\n+    MonotonicStopWatch watch;\n+    watch.start();\n+    bool eof = false;\n+    size_t read_length = 0;\n+    while (!eof) {\n+        size_t buf_len = 32 * 1024;\n+        st = reader.read(buf, &buf_len, &eof);\n+        ASSERT_TRUE(st.ok());\n+        read_length += buf_len;\n+    }\n+\n+    LOG(INFO) << \"read bytes \" << read_length << \" using time \" << watch.elapsed_time();\n+}\n+\n+TEST_F(BufferedReaderTest, test_validity) {\n+    LocalFileReader file_reader(\n+            \"./be/test/exec/test_data/buffered_reader/buffered_reader_test_file.txt\", 0);\n+    BufferedReader reader(&file_reader, 128 * 1024);\n+    auto st = reader.open();\n+    ASSERT_TRUE(st.ok());\n+    uint8_t buf[10];\n+    bool eof = false;\n+    size_t buf_len = 10;\n+\n+    st = reader.read(buf, &buf_len, &eof);\n+    ASSERT_TRUE(st.ok());\n+    ASSERT_STREQ(\"bdfhjlnprt\", std::string((char*)buf, buf_len).c_str());", "originalCommit": "50f6ea119373612919a02b8cb5df5aa53e5f8569", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEyNjM5OA==", "url": "https://github.com/apache/incubator-doris/pull/3878#discussion_r443126398", "bodyText": "should it be nbytes > _buffer_size  ?", "author": "morningman", "createdAt": "2020-06-20T12:12:41Z", "path": "be/src/exec/buffered_reader.cpp", "diffHunk": "@@ -0,0 +1,162 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+#include \"exec/buffered_reader.h\"\n+\n+#include <sstream>\n+#include <algorithm>\n+\n+#include \"common/logging.h\"\n+\n+namespace doris {\n+\n+// buffered reader\n+\n+BufferedReader::BufferedReader(FileReader* reader)\n+        : _reader(reader),\n+          _buffer_size(1024 * 1024),\n+          _buffer_offset(0),\n+          _buffer_limit(0),\n+          _cur_offset(0) {\n+    _buffer = new char[_buffer_size];\n+}\n+\n+BufferedReader::BufferedReader(FileReader* reader, int64_t buffer_size)\n+        : _reader(reader),\n+          _buffer_size(buffer_size),\n+          _buffer_offset(0),\n+          _buffer_limit(0),\n+          _cur_offset(0) {\n+    _buffer = new char[_buffer_size];\n+}\n+\n+BufferedReader::~BufferedReader() {\n+    close();\n+}\n+\n+Status BufferedReader::open() {\n+    if (!_reader) {\n+        std::stringstream ss;\n+        ss << \"Open buffered reader failed, reader is null\";\n+        return Status::InternalError(ss.str());\n+    }\n+    RETURN_IF_ERROR(_reader->open());\n+    RETURN_IF_ERROR(_fill());\n+    return Status::OK();\n+}\n+\n+//not support\n+Status BufferedReader::read_one_message(uint8_t** buf, size_t* length) {\n+    return Status::NotSupported(\"Not support\");\n+}\n+\n+Status BufferedReader::read(uint8_t* buf, size_t* buf_len, bool* eof) {\n+    DCHECK_NE(*buf_len, 0);\n+    int64_t bytes_read;\n+    RETURN_IF_ERROR(readat(_cur_offset, (int64_t)*buf_len, &bytes_read, buf));\n+    if (bytes_read == 0) {\n+        *eof = true;\n+    } else {\n+        *eof = false;\n+    }\n+    return Status::OK();\n+}\n+\n+Status BufferedReader::readat(int64_t position, int64_t nbytes, int64_t* bytes_read, void* out) {\n+    if (nbytes <= 0) {\n+        *bytes_read = 0;\n+        return Status::OK();\n+    }\n+    RETURN_IF_ERROR(_read_once(position, nbytes, bytes_read, out));\n+    //EOF\n+    if (*bytes_read <= 0) {\n+        return Status::OK();\n+    }\n+    while (*bytes_read < nbytes) {\n+        int64_t len;\n+        RETURN_IF_ERROR(_read_once(position + *bytes_read, nbytes - *bytes_read, &len, reinterpret_cast<char*>(out) + *bytes_read));\n+        // EOF\n+        if (len <= 0) {\n+            break;\n+        }\n+        *bytes_read += len;\n+    }\n+    return Status::OK();\n+}\n+\n+Status BufferedReader::_read_once(int64_t position, int64_t nbytes, int64_t* bytes_read, void* out) {\n+    // requested bytes missed the local buffer\n+    if (position >= _buffer_limit || position < _buffer_offset) {\n+        // if requested length is larger than the capacity of buffer, do not\n+        // need to copy the character into local buffer.\n+        if (nbytes > _buffer_limit - _buffer_offset) {", "originalCommit": "50f6ea119373612919a02b8cb5df5aa53e5f8569", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI5MDExOQ==", "url": "https://github.com/apache/incubator-doris/pull/3878#discussion_r443290119", "bodyText": "You are right.", "author": "xy720", "createdAt": "2020-06-22T02:29:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEyNjM5OA=="}], "type": "inlineReview"}, {"oid": "dc80a3713258feb7c25336add4280f56efbccba0", "url": "https://github.com/apache/incubator-doris/commit/dc80a3713258feb7c25336add4280f56efbccba0", "message": "add some ut", "committedDate": "2020-06-22T04:25:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMxMzgwNQ==", "url": "https://github.com/apache/incubator-doris/pull/3878#discussion_r443313805", "bodyText": "what is \"readat ?\"", "author": "wutiangan", "createdAt": "2020-06-22T04:40:55Z", "path": "be/src/exec/broker_reader.cpp", "diffHunk": "@@ -155,6 +155,8 @@ Status BrokerReader::readat(int64_t position, int64_t nbytes, int64_t* bytes_rea\n             return status;\n         }\n \n+        LOG(DEBUG) << \"send readat request to broker:\" << broker_addr << \" position:\" << position << \", read bytes length:\" << nbytes;", "originalCommit": "dc80a3713258feb7c25336add4280f56efbccba0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMxNDE3Ng==", "url": "https://github.com/apache/incubator-doris/pull/3878#discussion_r443314176", "bodyText": "what is \"readat ?\"\n\nLike pread", "author": "morningman", "createdAt": "2020-06-22T04:42:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMxMzgwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMxNDI2Mw==", "url": "https://github.com/apache/incubator-doris/pull/3878#discussion_r443314263", "bodyText": "Yes, it's confusing.  Better named it as pread request.", "author": "xy720", "createdAt": "2020-06-22T04:43:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMxMzgwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMxNTgyNw==", "url": "https://github.com/apache/incubator-doris/pull/3878#discussion_r443315827", "bodyText": "maybe this construct funciton can be remove, for this is duplicated code.\nyou can add default paremerts to constructor function bellow.", "author": "wutiangan", "createdAt": "2020-06-22T04:51:28Z", "path": "be/src/exec/buffered_reader.cpp", "diffHunk": "@@ -0,0 +1,162 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+#include \"exec/buffered_reader.h\"\n+\n+#include <sstream>\n+#include <algorithm>\n+\n+#include \"common/logging.h\"\n+\n+namespace doris {\n+\n+// buffered reader\n+\n+BufferedReader::BufferedReader(FileReader* reader)\n+        : _reader(reader),\n+          _buffer_size(1024 * 1024),\n+          _buffer_offset(0),\n+          _buffer_limit(0),\n+          _cur_offset(0) {\n+    _buffer = new char[_buffer_size];\n+}", "originalCommit": "dc80a3713258feb7c25336add4280f56efbccba0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMxNjYwMQ==", "url": "https://github.com/apache/incubator-doris/pull/3878#discussion_r443316601", "bodyText": "good", "author": "xy720", "createdAt": "2020-06-22T04:55:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMxNTgyNw=="}], "type": "inlineReview"}, {"oid": "adecd22e15c9949cab191c693db74541fdd58624", "url": "https://github.com/apache/incubator-doris/commit/adecd22e15c9949cab191c693db74541fdd58624", "message": "fix vlog", "committedDate": "2020-06-22T08:20:18Z", "type": "commit"}]}