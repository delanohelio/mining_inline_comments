{"pr_number": 3283, "pr_title": "Support setting replica quota in db level", "pr_createdAt": "2020-04-09T04:47:17Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3283", "timeline": [{"oid": "1428ee6b565697b734d436bb8c4ad2821aa0f115", "url": "https://github.com/apache/incubator-doris/commit/1428ee6b565697b734d436bb8c4ad2821aa0f115", "message": "Support setting replica quota in db level", "committedDate": "2020-04-09T03:46:32Z", "type": "commit"}, {"oid": "572e104f5694252ffc7afdaa1ef4d61bab32c4ad", "url": "https://github.com/apache/incubator-doris/commit/572e104f5694252ffc7afdaa1ef4d61bab32c4ad", "message": "change replicaSize to replicaCount", "committedDate": "2020-04-09T10:02:58Z", "type": "commit"}, {"oid": "c6bbc5ddfd11dab91c8e731a71346413942fc20a", "url": "https://github.com/apache/incubator-doris/commit/c6bbc5ddfd11dab91c8e731a71346413942fc20a", "message": "fix", "committedDate": "2020-04-09T10:39:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIyODQ3MA==", "url": "https://github.com/apache/incubator-doris/pull/3283#discussion_r406228470", "bodyText": "Plz indicate the default value of replica quota and data quota in the following \u8bf4\u660e section.", "author": "morningman", "createdAt": "2020-04-09T14:04:41Z", "path": "docs/documentation/cn/sql-reference/sql-statements/Data Definition/ALTER DATABASE.md", "diffHunk": "@@ -27,6 +27,9 @@ under the License.\n         2) \u91cd\u547d\u540d\u6570\u636e\u5e93\n             ALTER DATABASE db_name RENAME new_db_name;\n             \n+        3) \u8bbe\u7f6e\u6570\u636e\u5e93\u7684\u526f\u672c\u6570\u91cf\u914d\u989d", "originalCommit": "c6bbc5ddfd11dab91c8e731a71346413942fc20a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIzMTY5OQ==", "url": "https://github.com/apache/incubator-doris/pull/3283#discussion_r406231699", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                | KW_ALTER KW_DATABASE ident:dbName KW_SET KW_REPLICA KW_QUOTA quantity:quota_quantity\n          \n          \n            \n                | KW_ALTER KW_DATABASE ident:dbName KW_SET KW_REPLICA KW_QUOTA INTEGER_LITERAL: number\n          \n      \n    \n    \n  \n\nquantity is for quota like 1KB, 1MB, 1GB", "author": "morningman", "createdAt": "2020-04-09T14:09:03Z", "path": "fe/src/main/cup/sql_parser.cup", "diffHunk": "@@ -711,8 +712,13 @@ alter_stmt ::=\n     :}\n     | KW_ALTER KW_DATABASE ident:dbName KW_SET KW_DATA KW_QUOTA quantity:quota_quantity\n     {:\n-        RESULT = new AlterDatabaseQuotaStmt(dbName, quota_quantity);\n+        RESULT = new AlterDatabaseQuotaStmt(dbName, QuotaType.DATA, quota_quantity);\n     :}\n+    | KW_ALTER KW_DATABASE ident:dbName KW_SET KW_REPLICA KW_QUOTA quantity:quota_quantity", "originalCommit": "c6bbc5ddfd11dab91c8e731a71346413942fc20a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIzMjYxNQ==", "url": "https://github.com/apache/incubator-doris/pull/3283#discussion_r406232615", "bodyText": "Plz do not modify the origin column name \"Size\", it may cause some compatibility problem.", "author": "morningman", "createdAt": "2020-04-09T14:10:22Z", "path": "fe/src/main/java/org/apache/doris/analysis/ShowDataStmt.java", "diffHunk": "@@ -52,14 +52,16 @@\n     private static final ShowResultSetMetaData SHOW_TABLE_DATA_META_DATA =\n             ShowResultSetMetaData.builder()\n                     .addColumn(new Column(\"TableName\", ScalarType.createVarchar(20)))\n-                    .addColumn(new Column(\"Size\", ScalarType.createVarchar(30)))\n+                    .addColumn(new Column(\"DataSize\", ScalarType.createVarchar(30)))", "originalCommit": "c6bbc5ddfd11dab91c8e731a71346413942fc20a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIzNjE5MA==", "url": "https://github.com/apache/incubator-doris/pull/3283#discussion_r406236190", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    long quota = (quotaType == QuotaType.DATA ? db.getDataQuota() : db.getReplicaQuota());\n          \n          \n            \n                    long quota = stmt.getQuota();", "author": "morningman", "createdAt": "2020-04-09T14:15:29Z", "path": "fe/src/main/java/org/apache/doris/catalog/Catalog.java", "diffHunk": "@@ -2781,16 +2782,25 @@ public void alterDatabaseQuota(AlterDatabaseQuotaStmt stmt) throws DdlException\n             ErrorReport.reportDdlException(ErrorCode.ERR_BAD_DB_ERROR, dbName);\n         }\n \n-        db.setDataQuotaWithLock(stmt.getQuota());\n-\n-        DatabaseInfo dbInfo = new DatabaseInfo(dbName, \"\", db.getDataQuota());\n+        QuotaType quotaType = stmt.getQuotaType();\n+        if (quotaType == QuotaType.DATA) {\n+            db.setDataQuotaWithLock(stmt.getQuota());\n+        } else if (quotaType == QuotaType.REPLICA) {\n+            db.setReplicaQuotaWithLock(stmt.getQuota());\n+        }\n+        long quota = (quotaType == QuotaType.DATA ? db.getDataQuota() : db.getReplicaQuota());", "originalCommit": "c6bbc5ddfd11dab91c8e731a71346413942fc20a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIzNzAzMQ==", "url": "https://github.com/apache/incubator-doris/pull/3283#discussion_r406237031", "bodyText": "How about change QuotaType.DATA to null? For better understanding?", "author": "morningman", "createdAt": "2020-04-09T14:16:33Z", "path": "fe/src/main/java/org/apache/doris/catalog/Catalog.java", "diffHunk": "@@ -2835,7 +2845,7 @@ public void renameDatabase(AlterDatabaseRename stmt) throws DdlException {\n             fullNameToDb.remove(fullDbName);\n             fullNameToDb.put(newFullDbName, db);\n \n-            DatabaseInfo dbInfo = new DatabaseInfo(fullDbName, newFullDbName, -1L);\n+            DatabaseInfo dbInfo = new DatabaseInfo(fullDbName, newFullDbName, -1L, QuotaType.DATA);", "originalCommit": "c6bbc5ddfd11dab91c8e731a71346413942fc20a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjU5NzgyNA==", "url": "https://github.com/apache/incubator-doris/pull/3283#discussion_r406597824", "bodyText": "@morningman null may cause NullPointerException, so I use QuotaType.NONE instead of null", "author": "caiconghui", "createdAt": "2020-04-10T04:32:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIzNzAzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIzODAyMA==", "url": "https://github.com/apache/incubator-doris/pull/3283#discussion_r406238020", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (replicaVolumn < 0L) {\n          \n          \n            \n                    if (replicaVolumn <= 0L) {", "author": "morningman", "createdAt": "2020-04-09T14:17:55Z", "path": "fe/src/main/java/org/apache/doris/common/util/ParseUtil.java", "diffHunk": "@@ -71,4 +71,17 @@ public static long analyzeDataVolumn(String dataVolumnStr) throws UserException\n         return dataVolumn;\n     }\n \n+    public static long analyzeReplicaVolumn(String replicaVolumnStr) throws AnalysisException {\n+        long replicaVolumn = 0;\n+        try {\n+            replicaVolumn = Long.parseLong(replicaVolumnStr);\n+        } catch (NumberFormatException nfe) {\n+            throw new AnalysisException(\"invalid data volumn:\" + replicaVolumnStr);\n+        }\n+        if (replicaVolumn < 0L) {", "originalCommit": "c6bbc5ddfd11dab91c8e731a71346413942fc20a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIzODczNA==", "url": "https://github.com/apache/incubator-doris/pull/3283#discussion_r406238734", "bodyText": "Why not just using table.getReplicaCount()?", "author": "morningman", "createdAt": "2020-04-09T14:18:56Z", "path": "fe/src/main/java/org/apache/doris/catalog/Database.java", "diffHunk": "@@ -232,7 +250,34 @@ public long getDataQuotaLeftWithLock() {\n         }\n     }\n \n-    public void checkQuota() throws DdlException {\n+\n+    public long getReplicaQuotaLeftWithLock() {\n+        long usedReplicaQuota = 0;\n+        readLock();\n+        try {\n+            for (Table table : this.idToTable.values()) {\n+                if (table.getType() != TableType.OLAP) {\n+                    continue;\n+                }\n+\n+                OlapTable olapTable = (OlapTable) table;", "originalCommit": "c6bbc5ddfd11dab91c8e731a71346413942fc20a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI0MDI4Nw==", "url": "https://github.com/apache/incubator-doris/pull/3283#discussion_r406240287", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    }\n          \n          \n            \n                    } else {\n          \n          \n            \n                        this.replicaQuotaSize = FeConstants.default_db_replica_quota_size;\n          \n          \n            \n                    }", "author": "morningman", "createdAt": "2020-04-09T14:21:15Z", "path": "fe/src/main/java/org/apache/doris/catalog/Database.java", "diffHunk": "@@ -450,6 +513,10 @@ public void readFields(DataInput in) throws IOException {\n                 name2Function.put(name, builder.build());\n             }\n         }\n+\n+        if (Catalog.getCurrentCatalogJournalVersion() >= FeMetaVersion.VERSION_80) {\n+            replicaQuotaSize = in.readLong();\n+        }", "originalCommit": "c6bbc5ddfd11dab91c8e731a71346413942fc20a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI0MTIzMQ==", "url": "https://github.com/apache/incubator-doris/pull/3283#discussion_r406241231", "bodyText": "Plz not modify the origin column name Quota, for compatibility.", "author": "morningman", "createdAt": "2020-04-09T14:22:43Z", "path": "fe/src/main/java/org/apache/doris/common/proc/DbsProcDir.java", "diffHunk": "@@ -39,7 +39,7 @@\n  */\n public class DbsProcDir implements ProcDirInterface {\n     public static final ImmutableList<String> TITLE_NAMES = new ImmutableList.Builder<String>()\n-            .add(\"DbId\").add(\"DbName\").add(\"TableNum\").add(\"Quota\")\n+            .add(\"DbId\").add(\"DbName\").add(\"TableNum\").add(\"DataQuota\").add(\"ReplicaQuota\")", "originalCommit": "c6bbc5ddfd11dab91c8e731a71346413942fc20a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI0MTg2OA==", "url": "https://github.com/apache/incubator-doris/pull/3283#discussion_r406241868", "bodyText": "Add the new column at the end of columns, for compatibility", "author": "morningman", "createdAt": "2020-04-09T14:23:36Z", "path": "fe/src/main/java/org/apache/doris/common/proc/TablesProcDir.java", "diffHunk": "@@ -43,7 +43,7 @@\n public class TablesProcDir implements ProcDirInterface {\n     public static final ImmutableList<String> TITLE_NAMES = new ImmutableList.Builder<String>()\n             .add(\"TableId\").add(\"TableName\").add(\"IndexNum\").add(\"PartitionColumnName\")\n-            .add(\"PartitionNum\").add(\"State\").add(\"Type\").add(\"LastConsistencyCheckTime\")\n+            .add(\"PartitionNum\").add(\"ReplicaCount\").add(\"State\").add(\"Type\").add(\"LastConsistencyCheckTime\")", "originalCommit": "c6bbc5ddfd11dab91c8e731a71346413942fc20a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI0MjY3NA==", "url": "https://github.com/apache/incubator-doris/pull/3283#discussion_r406242674", "bodyText": "remove the unused set method.", "author": "morningman", "createdAt": "2020-04-09T14:24:42Z", "path": "fe/src/main/java/org/apache/doris/persist/DatabaseInfo.java", "diffHunk": "@@ -107,4 +115,12 @@ public void setDbState(DbState dbState) {\n         this.dbState = dbState;\n     }\n \n+    public QuotaType getQuotaType() {\n+        return quotaType;\n+    }\n+\n+    public void setQuotaType(QuotaType quotaType) {", "originalCommit": "c6bbc5ddfd11dab91c8e731a71346413942fc20a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b8337ee3d0ebb16c89e7c5524f641ef9b66a7110", "url": "https://github.com/apache/incubator-doris/commit/b8337ee3d0ebb16c89e7c5524f641ef9b66a7110", "message": "fix", "committedDate": "2020-04-10T05:19:46Z", "type": "commit"}, {"oid": "f211d2a2ea0e6b939ff044f76e25c11e3ab4aa6d", "url": "https://github.com/apache/incubator-doris/commit/f211d2a2ea0e6b939ff044f76e25c11e3ab4aa6d", "message": "fix doc", "committedDate": "2020-04-10T05:49:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY2MDY0MA==", "url": "https://github.com/apache/incubator-doris/pull/3283#discussion_r406660640", "bodyText": "The 1000000 is too small.  In meituan.com, the replica number for one database has exceeded 1000000. I think your initial value 1024 * 1024 * 1024 is OK.", "author": "kangkaisen", "createdAt": "2020-04-10T08:30:15Z", "path": "fe/src/main/java/org/apache/doris/common/FeConstants.java", "diffHunk": "@@ -31,6 +31,7 @@\n     public static int shortkey_max_column_count = 3;\n     public static int shortkey_maxsize_bytes = 36;\n     public static long default_db_data_quota_bytes = 1024 * 1024 * 1024 * 1024L; // 1TB\n+    public static long default_db_replica_quota_size = 1000000;", "originalCommit": "f211d2a2ea0e6b939ff044f76e25c11e3ab4aa6d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY2MTkyNA==", "url": "https://github.com/apache/incubator-doris/pull/3283#discussion_r406661924", "bodyText": "Why not set -1 as default value, which means no limit?\nOtherwise I'm afraid some cluster can't create table after cluster upgrade.", "author": "imay", "createdAt": "2020-04-10T08:34:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY2MDY0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY2NjM4Ng==", "url": "https://github.com/apache/incubator-doris/pull/3283#discussion_r406666386", "bodyText": "OK. I will change it to original default value", "author": "caiconghui", "createdAt": "2020-04-10T08:46:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY2MDY0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY3MDYxMA==", "url": "https://github.com/apache/incubator-doris/pull/3283#discussion_r406670610", "bodyText": "@imay 1024 * 1024 * 1024 is a large value and enough, if one table has 100000 tablets , about 10000 tables can exits in on db?", "author": "caiconghui", "createdAt": "2020-04-10T08:58:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY2MDY0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY3NTQ5OA==", "url": "https://github.com/apache/incubator-doris/pull/3283#discussion_r406675498", "bodyText": "in my point of view, quota is a necessary limit for resource usage, the resource is limited, replica quota should like data quota, not set to be -1 @imay", "author": "caiconghui", "createdAt": "2020-04-10T09:11:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY2MDY0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY2NDMyMA==", "url": "https://github.com/apache/incubator-doris/pull/3283#discussion_r406664320", "bodyText": "Why not enlarge the meta version?", "author": "kangkaisen", "createdAt": "2020-04-10T08:40:53Z", "path": "fe/src/main/java/org/apache/doris/catalog/Database.java", "diffHunk": "@@ -450,6 +488,12 @@ public void readFields(DataInput in) throws IOException {\n                 name2Function.put(name, builder.build());\n             }\n         }\n+\n+        if (Catalog.getCurrentCatalogJournalVersion() >= FeMetaVersion.VERSION_80) {", "originalCommit": "f211d2a2ea0e6b939ff044f76e25c11e3ab4aa6d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY2NjI1NA==", "url": "https://github.com/apache/incubator-doris/pull/3283#discussion_r406666254", "bodyText": "ok, it is a bug", "author": "caiconghui", "createdAt": "2020-04-10T08:46:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY2NDMyMA=="}], "type": "inlineReview"}, {"oid": "b753195cf468e7b41636cd1ec50b0be50fa21e7f", "url": "https://github.com/apache/incubator-doris/commit/b753195cf468e7b41636cd1ec50b0be50fa21e7f", "message": "modify default_db_replica_quota_size to 1073741824", "committedDate": "2020-04-10T08:44:05Z", "type": "commit"}, {"oid": "2ffc7663a665f2fadebddb481055aaba978413f5", "url": "https://github.com/apache/incubator-doris/commit/2ffc7663a665f2fadebddb481055aaba978413f5", "message": "fix meta version error", "committedDate": "2020-04-10T08:49:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA2MzA1Ng==", "url": "https://github.com/apache/incubator-doris/pull/3283#discussion_r407063056", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                | KW_ALTER KW_DATABASE ident:dbName KW_SET KW_REPLICA KW_QUOTA INTEGER_LITERAL: number\n          \n          \n            \n                | KW_ALTER KW_DATABASE ident:dbName KW_SET KW_REPLICA KW_QUOTA INTEGER_LITERAL:number", "author": "morningman", "createdAt": "2020-04-11T13:18:03Z", "path": "fe/src/main/cup/sql_parser.cup", "diffHunk": "@@ -714,9 +714,9 @@ alter_stmt ::=\n     {:\n         RESULT = new AlterDatabaseQuotaStmt(dbName, QuotaType.DATA, quota_quantity);\n     :}\n-    | KW_ALTER KW_DATABASE ident:dbName KW_SET KW_REPLICA KW_QUOTA quantity:quota_quantity\n+    | KW_ALTER KW_DATABASE ident:dbName KW_SET KW_REPLICA KW_QUOTA INTEGER_LITERAL: number", "originalCommit": "b8337ee3d0ebb16c89e7c5524f641ef9b66a7110", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3947f51781767a7cf799ca491775f92e78eac08a", "url": "https://github.com/apache/incubator-doris/commit/3947f51781767a7cf799ca491775f92e78eac08a", "message": "fix sql syntax style", "committedDate": "2020-04-12T03:41:55Z", "type": "commit"}, {"oid": "36b5a7758d9190c32cac9f0ebc1c4ee191e4ecf1", "url": "https://github.com/apache/incubator-doris/commit/36b5a7758d9190c32cac9f0ebc1c4ee191e4ecf1", "message": "make replica count only for visible materialized index", "committedDate": "2020-04-12T14:18:15Z", "type": "commit"}]}