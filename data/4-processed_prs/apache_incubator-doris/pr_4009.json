{"pr_number": 4009, "pr_title": "[Bug]Fix some schema change not work right", "pr_createdAt": "2020-07-02T14:12:17Z", "pr_url": "https://github.com/apache/incubator-doris/pull/4009", "timeline": [{"oid": "5a257d19a7199f070469c4914c5ffeebd9f1222b", "url": "https://github.com/apache/incubator-doris/commit/5a257d19a7199f070469c4914c5ffeebd9f1222b", "message": "[Bug]Fix some schema change not work right\n\nThis CL mainly fix some schema change to varchar type not work right\nbecause forget to logic check && Add ConvertTypeResolver to add\nsupported convert type in order to avoid forget logic check", "committedDate": "2020-07-02T13:56:32Z", "type": "commit"}, {"oid": "3c921673302388e3d109c076a5be16e2f9d7c8cd", "url": "https://github.com/apache/incubator-doris/commit/3c921673302388e3d109c076a5be16e2f9d7c8cd", "message": "fix", "committedDate": "2020-07-02T14:17:14Z", "type": "commit"}, {"oid": "7576dbc03027d64308194cf65089ae8ece835528", "url": "https://github.com/apache/incubator-doris/commit/7576dbc03027d64308194cf65089ae8ece835528", "message": "fix", "committedDate": "2020-07-02T15:51:56Z", "type": "commit"}, {"oid": "470247d957a302dbe18238e43f52f445935bb584", "url": "https://github.com/apache/incubator-doris/commit/470247d957a302dbe18238e43f52f445935bb584", "message": "fix", "committedDate": "2020-07-02T16:04:12Z", "type": "commit"}, {"oid": "7d73a5895539b41b960745568d4595c1700012b8", "url": "https://github.com/apache/incubator-doris/commit/7d73a5895539b41b960745568d4595c1700012b8", "message": "fix", "committedDate": "2020-07-03T02:07:38Z", "type": "commit"}, {"oid": "883bf90f88a5698091ea5d29f94bddbe6abd1050", "url": "https://github.com/apache/incubator-doris/commit/883bf90f88a5698091ea5d29f94bddbe6abd1050", "message": "fix", "committedDate": "2020-07-03T03:28:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTcyNjYyNA==", "url": "https://github.com/apache/incubator-doris/pull/4009#discussion_r449726624", "bodyText": "is VARCHAR to DOUBLE and DATETIME support?", "author": "morningman", "createdAt": "2020-07-04T01:18:37Z", "path": "be/src/olap/schema_change.cpp", "diffHunk": "@@ -194,6 +194,64 @@ ColumnMapping* RowBlockChanger::get_mutable_column_mapping(size_t column_index)\n         break; \\\n     }\n \n+struct ConvertTypeMapHash {\n+    size_t operator()(const std::pair<FieldType, FieldType>& pair) const {\n+        return (pair.first + 31) ^ pair.second;\n+    }\n+};\n+\n+class ConvertTypeResolver {\n+DECLARE_SINGLETON(ConvertTypeResolver);\n+public:\n+    bool get_convert_type_info(const FieldType from_type, const FieldType to_type) const {\n+        return _convert_type_set.find(std::make_pair(from_type, to_type)) != _convert_type_set.end();\n+    }\n+\n+    template<FieldType from_type, FieldType to_type>\n+    void add_convert_type_mapping() {\n+        _convert_type_set.emplace(std::make_pair(from_type, to_type));\n+    }\n+\n+private:\n+    typedef std::pair<FieldType, FieldType> convert_type_pair;\n+    std::unordered_set<convert_type_pair, ConvertTypeMapHash> _convert_type_set;\n+\n+    DISALLOW_COPY_AND_ASSIGN(ConvertTypeResolver);\n+};\n+\n+ConvertTypeResolver::ConvertTypeResolver() {\n+    // supported type convert should annotate in doc:\n+    // http://doris.incubator.apache.org/master/zh-CN/sql-reference/sql-statements/Data%20Definition/ALTER%20TABLE.html#description\n+    // from varchar type\n+    add_convert_type_mapping<OLAP_FIELD_TYPE_VARCHAR, OLAP_FIELD_TYPE_TINYINT>();\n+    add_convert_type_mapping<OLAP_FIELD_TYPE_VARCHAR, OLAP_FIELD_TYPE_SMALLINT>();\n+    add_convert_type_mapping<OLAP_FIELD_TYPE_VARCHAR, OLAP_FIELD_TYPE_INT>();\n+    add_convert_type_mapping<OLAP_FIELD_TYPE_VARCHAR, OLAP_FIELD_TYPE_BIGINT>();\n+    add_convert_type_mapping<OLAP_FIELD_TYPE_VARCHAR, OLAP_FIELD_TYPE_LARGEINT>();\n+    add_convert_type_mapping<OLAP_FIELD_TYPE_VARCHAR, OLAP_FIELD_TYPE_FLOAT>();", "originalCommit": "883bf90f88a5698091ea5d29f94bddbe6abd1050", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTcyODA4OA==", "url": "https://github.com/apache/incubator-doris/pull/4009#discussion_r449728088", "bodyText": "VAHRCHAR->DOUBLE is supported add I added it. VARCHAR->DATETIME maybe supported in next PR.", "author": "WingsGo", "createdAt": "2020-07-04T01:42:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTcyNjYyNA=="}], "type": "inlineReview"}, {"oid": "bc00a54fd86906d864d609b00d7c5a09737de928", "url": "https://github.com/apache/incubator-doris/commit/bc00a54fd86906d864d609b00d7c5a09737de928", "message": "fix", "committedDate": "2020-07-04T01:41:00Z", "type": "commit"}, {"oid": "e509906b9aa1d9f1d277e9da0a86016f50bed02b", "url": "https://github.com/apache/incubator-doris/commit/e509906b9aa1d9f1d277e9da0a86016f50bed02b", "message": "format relate code", "committedDate": "2020-07-06T12:37:29Z", "type": "commit"}, {"oid": "a32e237447b85b573ff343bff265595304507fcb", "url": "https://github.com/apache/incubator-doris/commit/a32e237447b85b573ff343bff265595304507fcb", "message": "Merge branch 'master' into fix_schema_change", "committedDate": "2020-07-08T09:57:58Z", "type": "commit"}]}