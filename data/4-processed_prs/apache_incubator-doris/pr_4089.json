{"pr_number": 4089, "pr_title": "Fix some problem related with publish version task", "pr_createdAt": "2020-07-13T14:47:17Z", "pr_url": "https://github.com/apache/incubator-doris/pull/4089", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc1NTY4OA==", "url": "https://github.com/apache/incubator-doris/pull/4089#discussion_r454755688", "bodyText": "why the replica meta version been updated by ReportHandler before?\nthis is abnormal, I think using warning is better", "author": "yangzhg", "createdAt": "2020-07-15T02:39:26Z", "path": "fe/src/main/java/org/apache/doris/catalog/Replica.java", "diffHunk": "@@ -318,12 +318,17 @@ private void updateReplicaInfo(long newVersion, long newVersionHash,\n             long lastFailedVersion, long lastFailedVersionHash, \n             long lastSuccessVersion, long lastSuccessVersionHash, \n             long newDataSize, long newRowCount) {\n-        LOG.debug(\"before update: {}\", this.toString());\n+        if (LOG.isDebugEnabled()) {\n+            LOG.debug(\"before update: {}\", this.toString());\n+        }\n \n         if (newVersion < this.version) {\n-            // yiguolei: could not find any reason why new version less than this.version should run???\n-            LOG.warn(\"replica {} on backend {}'s new version {} is lower than meta version {}\",\n-                    id, backendId, newVersion, this.version);\n+            // This case means that replica meta version has been updated by ReportHandler before", "originalCommit": "202b2615113a907c95bf53a28af164b621b1402d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc2Njc4Ng==", "url": "https://github.com/apache/incubator-doris/pull/4089#discussion_r454766786", "bodyText": "@yangzhg\nfor example, now, the publish version daemon send publish verison task(2 3 4 5 6) to one be, and the be finish all publish version task, its replica version is 6 now, but publish version daemon need wait other be finish all publish version to update version in fe, now the replica version in fe may be 4, I think it is the common case that be replica version higher than fe replica version, when ReportHandler sync tablet. And now publish version daemon finish txn and replica version 4 + 1 = 5, it find the newer version(5) is lower than replica version(6) in fe.\n\n  \n    \n      incubator-doris/fe/src/main/java/org/apache/doris/master/ReportHandler.java\n    \n    \n        Lines 473 to 477\n      in\n      14ac49d\n    \n    \n    \n    \n\n        \n          \n           // 1. PUSH finished in BE but failed or not yet report to FE \n        \n\n        \n          \n           // 2. repair for VERSION_INCOMPLETE finished in BE, but failed or not yet report to FE \n        \n\n        \n          \n           replica.updateVersionInfo(backendVersion, backendVersionHash, dataSize, rowCount); \n        \n\n        \n          \n           replica.setBad(false);", "author": "caiconghui", "createdAt": "2020-07-15T03:21:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc1NTY4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTExNzYwNg==", "url": "https://github.com/apache/incubator-doris/pull/4089#discussion_r455117606", "bodyText": "Good explaination. I suggest to add this directly to the comment.", "author": "morningman", "createdAt": "2020-07-15T14:55:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc1NTY4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTEwODQxMw==", "url": "https://github.com/apache/incubator-doris/pull/4089#discussion_r455108413", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \u5f53\u4ee3\u7406\u4efb\u52a1\u7684\u521b\u5efa\u65f6\u95f4\u88ab\u8bbe\u7f6e\u7684\u65f6\u5019\uff0c\u6b64\u914d\u7f6e\u5c06\u51b3\u5b9a\u662f\u5426\u91cd\u65b0\u53d1\u9001\u4ee3\u7406\u4efb\u52a1\uff0c \u5f53\u4e14\u4ec5\u5f53\u5f53\u524d\u65f6\u95f4\u51cf\u53bb\u521b\u5efa\u65f6\u95f4\u5927\u4e8eagent_task_task_resend_wait_time_ms\u65f6\uff0cReportHandler\u53ef\u4ee5\u91cd\u65b0\u53d1\u9001\u4ee3\u7406\u4efb\u52a1\u3002    \n          \n          \n            \n            \u5f53\u4ee3\u7406\u4efb\u52a1\u7684\u521b\u5efa\u65f6\u95f4\u88ab\u8bbe\u7f6e\u7684\u65f6\u5019\uff0c\u6b64\u914d\u7f6e\u5c06\u51b3\u5b9a\u662f\u5426\u91cd\u65b0\u53d1\u9001\u4ee3\u7406\u4efb\u52a1\uff0c \u5f53\u4e14\u4ec5\u5f53\u5f53\u524d\u65f6\u95f4\u51cf\u53bb\u521b\u5efa\u65f6\u95f4\u5927\u4e8e `agent_task_task_resend_wait_time_ms` \u65f6\uff0cReportHandler\u53ef\u4ee5\u91cd\u65b0\u53d1\u9001\u4ee3\u7406\u4efb\u52a1\u3002    \n          \n      \n    \n    \n  \n\n\u5efa\u8bae\u589e\u52a0\u8bf4\u660e\u8be5\u8bbe\u7f6e\u89e3\u51b3\u7684\u95ee\u9898\u548c\u6700\u4f73\u5b9e\u8df5", "author": "morningman", "createdAt": "2020-07-15T14:45:44Z", "path": "docs/en/administrator-guide/config/fe_config.md", "diffHunk": "@@ -110,6 +110,10 @@ There are two ways to configure FE configuration items:\n \n ## Configurations\n \n+### `agent_task_resend_wait_time_ms`\n+\n+\u5f53\u4ee3\u7406\u4efb\u52a1\u7684\u521b\u5efa\u65f6\u95f4\u88ab\u8bbe\u7f6e\u7684\u65f6\u5019\uff0c\u6b64\u914d\u7f6e\u5c06\u51b3\u5b9a\u662f\u5426\u91cd\u65b0\u53d1\u9001\u4ee3\u7406\u4efb\u52a1\uff0c \u5f53\u4e14\u4ec5\u5f53\u5f53\u524d\u65f6\u95f4\u51cf\u53bb\u521b\u5efa\u65f6\u95f4\u5927\u4e8eagent_task_task_resend_wait_time_ms\u65f6\uff0cReportHandler\u53ef\u4ee5\u91cd\u65b0\u53d1\u9001\u4ee3\u7406\u4efb\u52a1\u3002    ", "originalCommit": "202b2615113a907c95bf53a28af164b621b1402d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTExMDgyMA==", "url": "https://github.com/apache/incubator-doris/pull/4089#discussion_r455110820", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @ConfField\n          \n          \n            \n                @ConfField (mutable = true, masterOnly = true)", "author": "morningman", "createdAt": "2020-07-15T14:48:56Z", "path": "fe/src/main/java/org/apache/doris/common/Config.java", "diffHunk": "@@ -1117,5 +1117,13 @@\n      */\n     @ConfField\n     public static String thrift_server_type = ThriftServer.THREAD_POOL;\n+\n+    /**\n+     * This config will decide whether to resend agent task when create_time for agent_task is set,\n+     * only when current_time - create_time > agent_task_resend_wait_time_ms can ReportHandler do resend agent task\n+     */\n+    @ConfField", "originalCommit": "202b2615113a907c95bf53a28af164b621b1402d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7d0eead23a8c8c5582616b7510e69d152fba47ff", "url": "https://github.com/apache/incubator-doris/commit/7d0eead23a8c8c5582616b7510e69d152fba47ff", "message": "fix comment", "committedDate": "2020-07-22T17:05:17Z", "type": "forcePushed"}, {"oid": "866ca70935aa53f3aeac2a64c01aa0d763a050c6", "url": "https://github.com/apache/incubator-doris/commit/866ca70935aa53f3aeac2a64c01aa0d763a050c6", "message": "Add thread name in fe log to make trace problem more easy", "committedDate": "2020-07-22T17:10:00Z", "type": "commit"}, {"oid": "ce1fccce624cd049989e2e8401a71e58f8d415ee", "url": "https://github.com/apache/incubator-doris/commit/ce1fccce624cd049989e2e8401a71e58f8d415ee", "message": "Skip to update replica version when new version is lower than replica's version", "committedDate": "2020-07-22T17:10:00Z", "type": "commit"}, {"oid": "371739988af7611986b419a06c4c80fefdb3d109", "url": "https://github.com/apache/incubator-doris/commit/371739988af7611986b419a06c4c80fefdb3d109", "message": "Add resend time interval check to escape duplicate agent task send", "committedDate": "2020-07-22T17:10:00Z", "type": "commit"}, {"oid": "34bbf99774a889fef267789df5eba338fe0d2734", "url": "https://github.com/apache/incubator-doris/commit/34bbf99774a889fef267789df5eba338fe0d2734", "message": "Add doc content for config agent_task_resend_wait_time_ms", "committedDate": "2020-07-22T17:10:00Z", "type": "commit"}, {"oid": "23f0f1e2b9338b732ec5dfa2cf2111ad71463f89", "url": "https://github.com/apache/incubator-doris/commit/23f0f1e2b9338b732ec5dfa2cf2111ad71463f89", "message": "fix typo", "committedDate": "2020-07-22T17:10:00Z", "type": "commit"}, {"oid": "4e734cc2982cdae4c0b0b71701957a347bd9d910", "url": "https://github.com/apache/incubator-doris/commit/4e734cc2982cdae4c0b0b71701957a347bd9d910", "message": "fix comment", "committedDate": "2020-07-22T17:10:00Z", "type": "commit"}, {"oid": "aef9ac152d3b88502eff36e47ad6b97c21266a1b", "url": "https://github.com/apache/incubator-doris/commit/aef9ac152d3b88502eff36e47ad6b97c21266a1b", "message": "fix by review", "committedDate": "2020-07-22T17:10:01Z", "type": "commit"}, {"oid": "2c16498ecac08936141d1635b44991db548e88fd", "url": "https://github.com/apache/incubator-doris/commit/2c16498ecac08936141d1635b44991db548e88fd", "message": "small fix in finishTransaction method of DatabaseTransactionMgr", "committedDate": "2020-07-22T17:10:01Z", "type": "commit"}, {"oid": "aedbeb9af7c856f1a5fb88588c2cd998036c82f1", "url": "https://github.com/apache/incubator-doris/commit/aedbeb9af7c856f1a5fb88588c2cd998036c82f1", "message": "fix comment", "committedDate": "2020-07-22T17:10:01Z", "type": "commit"}, {"oid": "aedbeb9af7c856f1a5fb88588c2cd998036c82f1", "url": "https://github.com/apache/incubator-doris/commit/aedbeb9af7c856f1a5fb88588c2cd998036c82f1", "message": "fix comment", "committedDate": "2020-07-22T17:10:01Z", "type": "forcePushed"}]}