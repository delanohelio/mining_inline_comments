{"pr_number": 3571, "pr_title": "Support bitmap_intersect", "pr_createdAt": "2020-05-12T13:31:19Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3571", "timeline": [{"oid": "7df59a69e1ec509192d0b4a7b7018bdc4fa0b62f", "url": "https://github.com/apache/incubator-doris/commit/7df59a69e1ec509192d0b4a7b7018bdc4fa0b62f", "message": "Support bitmap_intersect\n\nSupport aggregate function Bitmap Intersect, it is mainly used to take intersection of grouped data.\nThe function 'bitmap_intersect(expr)' calculates the intersection of bitmap columns and returns a bitmap object.\nThe defination is following:\nFunctionName: bitmap_intersect,\nInputType: bitmap,\nOutputType: bitmap\n\nThe scenario is as follows:\nQuery which users satisfy the three tags a, b, and c at the same time.\n\n```\nselect bitmap_to_string(bitmap_intersect(user_id)) from\n(\n    select bitmap_union(user_id) user_id from bitmap_intersect_test\n    where tag in ('a', 'b', 'c')\n    group by tag\n) a\n```\nClosed #3552.\n\nChange-Id: I0d50c9bb6827f7319c4d854f621412343a3ece24", "committedDate": "2020-05-12T13:26:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI2NzY1NA==", "url": "https://github.com/apache/incubator-doris/pull/3571#discussion_r424267654", "bodyText": "I think is_null is diffrent from empty bitmap.\nwhy here return an empty bitmap?", "author": "kangpinghuang", "createdAt": "2020-05-13T08:36:06Z", "path": "be/src/exprs/bitmap_function.cpp", "diffHunk": "@@ -343,14 +367,19 @@ StringVal BitmapFunctions::bitmap_hash(doris_udf::FunctionContext* ctx, const do\n }\n \n StringVal BitmapFunctions::bitmap_serialize(FunctionContext* ctx, const StringVal& src) {\n-    auto src_bitmap = reinterpret_cast<BitmapValue*>(src.ptr);\n-    StringVal result = serialize(ctx, src_bitmap);\n-    delete src_bitmap;\n-    return result;\n+    if (src.is_null) {\n+        BitmapValue src_bitmap;\n+        return serialize(ctx, &src_bitmap);", "originalCommit": "7df59a69e1ec509192d0b4a7b7018bdc4fa0b62f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQzNDcxNw==", "url": "https://github.com/apache/incubator-doris/pull/3571#discussion_r424434717", "bodyText": "I think null means \"no data\". And for \"no data\", return an empty set is reasonable.", "author": "morningman", "createdAt": "2020-05-13T13:25:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI2NzY1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ2MzUxMA==", "url": "https://github.com/apache/incubator-doris/pull/3571#discussion_r424463510", "bodyText": "I also think there is no need to serialize null bitmap.\nSet StringVal.is_null = true is better.\nfor in later merge function, we at first check if the StringVal is null.", "author": "wutiangan", "createdAt": "2020-05-13T14:03:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI2NzY1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg1OTYyNA==", "url": "https://github.com/apache/incubator-doris/pull/3571#discussion_r424859624", "bodyText": "This serialize function is  multiplexed by finalize function in other bitmap function such as bitmap_union.", "author": "EmmyMiao87", "createdAt": "2020-05-14T04:08:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI2NzY1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI2ODY5Ng==", "url": "https://github.com/apache/incubator-doris/pull/3571#discussion_r424268696", "bodyText": "why delete the src_bitmap here? who will manage the bitmap lifetime?", "author": "kangpinghuang", "createdAt": "2020-05-13T08:37:42Z", "path": "be/src/exprs/bitmap_function.cpp", "diffHunk": "@@ -343,14 +367,19 @@ StringVal BitmapFunctions::bitmap_hash(doris_udf::FunctionContext* ctx, const do\n }\n \n StringVal BitmapFunctions::bitmap_serialize(FunctionContext* ctx, const StringVal& src) {\n-    auto src_bitmap = reinterpret_cast<BitmapValue*>(src.ptr);\n-    StringVal result = serialize(ctx, src_bitmap);\n-    delete src_bitmap;\n-    return result;\n+    if (src.is_null) {\n+        BitmapValue src_bitmap;\n+        return serialize(ctx, &src_bitmap);\n+    } else {\n+        auto src_bitmap = reinterpret_cast<BitmapValue*>(src.ptr);\n+        StringVal result = serialize(ctx, src_bitmap);\n+        delete src_bitmap;", "originalCommit": "7df59a69e1ec509192d0b4a7b7018bdc4fa0b62f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg1OTc5Ng==", "url": "https://github.com/apache/incubator-doris/pull/3571#discussion_r424859796", "bodyText": "The src_bitmap was initialized in merge function. So it need to delete src_bitmap when UDA has been finished.", "author": "EmmyMiao87", "createdAt": "2020-05-14T04:09:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI2ODY5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI3MjI4Mw==", "url": "https://github.com/apache/incubator-doris/pull/3571#discussion_r424272283", "bodyText": "It seems that when src.len == 0, the src.ptr point to the bitmap value pointer, but when src.len != 0, the ptr points to the serialized bitmap contents, why?", "author": "kangpinghuang", "createdAt": "2020-05-13T08:43:10Z", "path": "be/src/exprs/bitmap_function.cpp", "diffHunk": "@@ -302,6 +302,30 @@ void BitmapFunctions::bitmap_union(FunctionContext* ctx, const StringVal& src, S\n     }\n }\n \n+void BitmapFunctions::bitmap_intersect_init(FunctionContext* ctx, StringVal* dst) {\n+    dst->is_null = true;\n+}\n+\n+void BitmapFunctions::bitmap_intersect(FunctionContext* ctx, const StringVal& src, StringVal* dst) {\n+    if (src.is_null) {\n+        return;\n+    }\n+    // if dst is null, the src input is the first value\n+    if (dst->is_null) {\n+        dst->is_null = false;\n+        dst->len = sizeof(BitmapValue);\n+        dst->ptr = (uint8_t*)new BitmapValue((char*) src.ptr);\n+        return;\n+    }\n+    auto dst_bitmap = reinterpret_cast<BitmapValue*>(dst->ptr);\n+    // zero size means the src input is a agg object\n+    if (src.len == 0) {", "originalCommit": "7df59a69e1ec509192d0b4a7b7018bdc4fa0b62f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQzNTQ4MA==", "url": "https://github.com/apache/incubator-doris/pull/3571#discussion_r424435480", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    BITMAP = 2// more than one elements\n          \n          \n            \n                    BITMAP = 2 // more than one elements", "author": "morningman", "createdAt": "2020-05-13T13:26:22Z", "path": "be/src/util/bitmap_value.h", "diffHunk": "@@ -1235,7 +1235,7 @@ class BitmapValue {\n     enum BitmapDataType {\n         EMPTY = 0,\n         SINGLE = 1, // single element\n-        BITMAP = 2 // more than one elements\n+        BITMAP = 2// more than one elements", "originalCommit": "7df59a69e1ec509192d0b4a7b7018bdc4fa0b62f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d2bdd1db8eb22f8b245030c34fed911f92653440", "url": "https://github.com/apache/incubator-doris/commit/d2bdd1db8eb22f8b245030c34fed911f92653440", "message": "Update be/src/util/bitmap_value.h\n\nCo-authored-by: Mingyu Chen <morningman.cmy@gmail.com>", "committedDate": "2020-05-14T04:10:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkzODQyOQ==", "url": "https://github.com/apache/incubator-doris/pull/3571#discussion_r424938429", "bodyText": "You can't change this name directly.\nBecause it will cause query fail when grayscale upgrade", "author": "imay", "createdAt": "2020-05-14T07:52:29Z", "path": "fe/src/main/java/org/apache/doris/catalog/FunctionSet.java", "diffHunk": "@@ -554,29 +555,29 @@ public boolean isNonNullResultWithNullParamFunctions(String funcName) {\n     private static final Map<Type, String> BITMAP_INTERSECT_INIT_SYMBOL =\n             ImmutableMap.<Type, String>builder()\n                     .put(Type.TINYINT,\n-                            \"_ZN5doris15BitmapFunctions21bitmap_intersect_initIaN9doris_udf10TinyIntValEEEvPNS2_15FunctionContextEPNS2_9StringValE\")\n+                            \"_ZN5doris15BitmapFunctions20intersect_count_initIaN9doris_udf10TinyIntValEEEvPNS2_15FunctionContextEPNS2_9StringValE\")", "originalCommit": "d2bdd1db8eb22f8b245030c34fed911f92653440", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA2OTE0NA==", "url": "https://github.com/apache/incubator-doris/pull/3571#discussion_r427069144", "bodyText": "The grayscale upgrade itself will also cause the query to fail\uff0cso I think the impact is not significant.", "author": "EmmyMiao87", "createdAt": "2020-05-19T06:53:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkzODQyOQ=="}], "type": "inlineReview"}, {"oid": "45ee670dd2152a62b4180331f551150e7af041b8", "url": "https://github.com/apache/incubator-doris/commit/45ee670dd2152a62b4180331f551150e7af041b8", "message": "Add docs of bitmap_union and bitmap_intersect\n\nChange-Id: I4a815eaa5aac07ab75bb07e13f518da59cbef952", "committedDate": "2020-05-19T07:25:44Z", "type": "commit"}, {"oid": "1981a2631217412fa3fdec638eb5e20281cbcb6c", "url": "https://github.com/apache/incubator-doris/commit/1981a2631217412fa3fdec638eb5e20281cbcb6c", "message": "Merge branch 'bitmap_intersect' of https://github.com/EmmyMiao87/incubator-doris into bitmap_intersect\n\nChange-Id: I2f5bee7dd9a14f687881af8038dbbff17b6b6590", "committedDate": "2020-05-19T07:28:26Z", "type": "commit"}, {"oid": "c150919a31c1c333fa5ddfd6f1253e130337a5fc", "url": "https://github.com/apache/incubator-doris/commit/c150919a31c1c333fa5ddfd6f1253e130337a5fc", "message": "Change the init function name of bitmap_intersect\n\nChange-Id: Ibb9bdb236d4d850e3d732bb55c441b7f8b80abba", "committedDate": "2020-05-19T12:33:20Z", "type": "commit"}, {"oid": "9e0bf1a775111f825476f08f076282abed158da6", "url": "https://github.com/apache/incubator-doris/commit/9e0bf1a775111f825476f08f076282abed158da6", "message": "Change unit test\n\nChange-Id: I8bd03f5344eafc89a7d617d10399c848006bf590", "committedDate": "2020-05-19T12:43:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQwMzA5Mg==", "url": "https://github.com/apache/incubator-doris/pull/3571#discussion_r427403092", "bodyText": "Would better add a UNLIKELY macros.", "author": "kangkaisen", "createdAt": "2020-05-19T15:41:06Z", "path": "be/src/exprs/bitmap_function.cpp", "diffHunk": "@@ -302,6 +302,31 @@ void BitmapFunctions::bitmap_union(FunctionContext* ctx, const StringVal& src, S\n     }\n }\n \n+// this is the read init function for bitmap_intersect\n+void BitmapFunctions::bitmap_intersect_init_real(FunctionContext* ctx, StringVal* dst) {\n+    dst->is_null = true;\n+}\n+\n+void BitmapFunctions::bitmap_intersect(FunctionContext* ctx, const StringVal& src, StringVal* dst) {\n+    if (src.is_null) {\n+        return;\n+    }\n+    // if dst is null, the src input is the first value\n+    if (dst->is_null) {", "originalCommit": "9e0bf1a775111f825476f08f076282abed158da6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQxMzkxNg==", "url": "https://github.com/apache/incubator-doris/pull/3571#discussion_r427413916", "bodyText": "should add this file to sidebar to make it visible.", "author": "imay", "createdAt": "2020-05-19T15:56:09Z", "path": "docs/en/sql-reference/sql-functions/bitmap-functions/bitmap_intersect.md", "diffHunk": "@@ -0,0 +1,54 @@\n+---\n+{\n+    \"title\": \"bitmap_intersect\",\n+    \"language\": \"en\"", "originalCommit": "9e0bf1a775111f825476f08f076282abed158da6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk0NTE3MA==", "url": "https://github.com/apache/incubator-doris/pull/3571#discussion_r427945170", "bodyText": "Added", "author": "EmmyMiao87", "createdAt": "2020-05-20T11:46:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQxMzkxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQxNzQ0MQ==", "url": "https://github.com/apache/incubator-doris/pull/3571#discussion_r427417441", "bodyText": "why initial result bitmap as null? it seems that it will return empty bitmap when result bitmap is null", "author": "imay", "createdAt": "2020-05-19T16:01:07Z", "path": "be/src/exprs/bitmap_function.cpp", "diffHunk": "@@ -302,6 +302,31 @@ void BitmapFunctions::bitmap_union(FunctionContext* ctx, const StringVal& src, S\n     }\n }\n \n+// this is the read init function for bitmap_intersect\n+void BitmapFunctions::bitmap_intersect_init_real(FunctionContext* ctx, StringVal* dst) {\n+    dst->is_null = true;", "originalCommit": "9e0bf1a775111f825476f08f076282abed158da6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk0NDg1OA==", "url": "https://github.com/apache/incubator-doris/pull/3571#discussion_r427944858", "bodyText": "The initial result bitmap must be null. Otherwise, the intersection between dst and src will be empty.", "author": "EmmyMiao87", "createdAt": "2020-05-20T11:46:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQxNzQ0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzcxNDMyOA==", "url": "https://github.com/apache/incubator-doris/pull/3571#discussion_r427714328", "bodyText": "\u8fd9\u4e2ainit\u51fd\u6570\u662f\u901a\u7528\u7684\uff0c\u5c06\u6765\u4e0d\u6b62bitmap_intersect \u4f1a\u7528\u5230\u3002\n\u5f53\u524d bitmap_init \u7684\u5b9e\u73b0\u662fnot nullable\u7684\uff0c\u6240\u4ee5\u4f60\u8fd9\u4e2a\u51fd\u6570\u5408\u7406\u7684\u547d\u540d\u5e94\u8be5\u662fnullable_bitmap_init\uff0c \u6216\u8005bitmap_nullable_init.", "author": "kangkaisen", "createdAt": "2020-05-20T02:59:06Z", "path": "be/src/exprs/bitmap_function.cpp", "diffHunk": "@@ -302,6 +302,31 @@ void BitmapFunctions::bitmap_union(FunctionContext* ctx, const StringVal& src, S\n     }\n }\n \n+// this is the read init function for bitmap_intersect\n+void BitmapFunctions::bitmap_intersect_init_real(FunctionContext* ctx, StringVal* dst) {", "originalCommit": "9e0bf1a775111f825476f08f076282abed158da6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "48fddb6011b1c92538dd9a398be2f2ab4d964f15", "url": "https://github.com/apache/incubator-doris/commit/48fddb6011b1c92538dd9a398be2f2ab4d964f15", "message": "Support null of bitmap_intersect\n\nChange-Id: I2d86d48dd5f5e836696b3d44620de41943052ee6", "committedDate": "2020-05-20T08:47:28Z", "type": "commit"}, {"oid": "e828ea1e6c1b1b9de91c66216b6842429f17710b", "url": "https://github.com/apache/incubator-doris/commit/e828ea1e6c1b1b9de91c66216b6842429f17710b", "message": "Add doc in sidebar\n\nChange-Id: Ic21f0d500f464cee5d51e54858a18c89d080631b", "committedDate": "2020-05-20T11:31:10Z", "type": "commit"}]}