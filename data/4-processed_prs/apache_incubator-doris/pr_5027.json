{"pr_number": 5027, "pr_title": " Support fe heartbeat use thrift protocol to get stable response", "pr_createdAt": "2020-12-04T13:08:12Z", "pr_url": "https://github.com/apache/incubator-doris/pull/5027", "timeline": [{"oid": "e9a96b7f72aee7f3ede0b1c28624f8cb94826802", "url": "https://github.com/apache/incubator-doris/commit/e9a96b7f72aee7f3ede0b1c28624f8cb94826802", "message": "init heart beat", "committedDate": "2020-12-04T05:28:19Z", "type": "commit"}, {"oid": "3159c417a56f4a011aca426f1110512ec4b7c21d", "url": "https://github.com/apache/incubator-doris/commit/3159c417a56f4a011aca426f1110512ec4b7c21d", "message": "Support fe heartbeat use thrift protocol", "committedDate": "2020-12-04T10:36:26Z", "type": "commit"}, {"oid": "b93ef4eeeeb913ce157fa8c6db13df594e3648e3", "url": "https://github.com/apache/incubator-doris/commit/b93ef4eeeeb913ce157fa8c6db13df594e3648e3", "message": "fix", "committedDate": "2020-12-04T12:40:36Z", "type": "commit"}, {"oid": "d38d9b2c831a5c85510c4ba8ebcc0b67c3c76611", "url": "https://github.com/apache/incubator-doris/commit/d38d9b2c831a5c85510c4ba8ebcc0b67c3c76611", "message": "fix", "committedDate": "2020-12-04T13:31:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjUzMDM0Mg==", "url": "https://github.com/apache/incubator-doris/pull/5027#discussion_r536530342", "bodyText": "Thrift protocol doesn't have the timeout issue?", "author": "kangkaisen", "createdAt": "2020-12-05T06:52:35Z", "path": "fe/fe-core/src/main/java/org/apache/doris/common/Config.java", "diffHunk": "@@ -1301,4 +1301,13 @@\n      */\n     @ConfField\n     public static boolean enable_alpha_rowset = false;\n+\n+    /**\n+     * This config is used to solve fe heartbeat response read_timeout problem,", "originalCommit": "d38d9b2c831a5c85510c4ba8ebcc0b67c3c76611", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjYyMTUwNQ==", "url": "https://github.com/apache/incubator-doris/pull/5027#discussion_r536621505", "bodyText": "@kangkaisen for non master fe, the thread for processing request in fe thrift server is usually idle, and thrift protocol is more lightweight when we keep a long connection opened. But I am still confused that why heartbeat by http is easy to readtimout(timeout is 2 s), we just made period http request to fe server, such metric collect,  count running transaction in every db.", "author": "caiconghui", "createdAt": "2020-12-05T09:45:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjUzMDM0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzE3MTI2Mg==", "url": "https://github.com/apache/incubator-doris/pull/5027#discussion_r537171262", "bodyText": "When HTTP heartbeat read timeout, the FE server has a GC issue?\nI think HTTP and thrift protocol are both lightweight, and the heartbeat logic is very simple. So, If the http heartbeat has a timeout issue, there is no reason thrift heartbeat won't have the timeout issue.", "author": "kangkaisen", "createdAt": "2020-12-07T01:18:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjUzMDM0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI1OTExNA==", "url": "https://github.com/apache/incubator-doris/pull/5027#discussion_r537259114", "bodyText": "There is no GC issue in fe server. All seems normal, but when non master fe run after sometimes, the read timeout problem occur, and when we restart non master fe, the read timeout issue disappear, and we are not sure that when to meet the read timeout problem again.", "author": "caiconghui", "createdAt": "2020-12-07T06:24:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjUzMDM0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI2NDM4OQ==", "url": "https://github.com/apache/incubator-doris/pull/5027#discussion_r537264389", "bodyText": "2020-12-07 14:30:59,424 INFO 115 [RestBaseAction.handleRequest():52] receive http request. url=/api/bootstrap?\n2020-12-07 14:31:04,431 INFO 128 [RestBaseAction.handleRequest():52] receive http request. url=/api/bootstrap?\n2020-12-07 14:31:09,436 INFO 141 [RestBaseAction.handleRequest():52] receive http request. url=/api/bootstrap\n2020-12-07 14:31:14,442 INFO 148 [RestBaseAction.handleRequest():52] receive http request. url=/api/bootstrap\n2020-12-07 14:31:19,449 INFO 77 [RestBaseAction.handleRequest():52] receive http request. url=/api/bootstrap?\n2020-12-07 14:31:24,455 INFO 87 [RestBaseAction.handleRequest():52] receive http request. url=/api/bootstrap\n2020-12-07 14:31:29,461 INFO 94 [RestBaseAction.handleRequest():52] receive http request. url=/api/bootstrap?\n2020-12-07 14:31:34,466 INFO 104 [RestBaseAction.handleRequest():52] receive http request. url=/api/bootstrap?\n2020-12-07 14:31:39,472 INFO 119 [RestBaseAction.handleRequest():52] receive http request. url=/api/bootstrap?\n2020-12-07 14:31:44,477 INFO 129 [RestBaseAction.handleRequest():52] receive http request. url=/api/bootstrap?\n2020-12-07 14:31:53,897 INFO 137 [RestBaseAction.handleRequest():52] receive http request. url=/api/bootstrap?\n2020-12-07 14:31:56,540 INFO 150 [RestBaseAction.handleRequest():52] receive http request. url=/api/bootstrap?\n2020-12-07 14:32:01,545 INFO 79 [RestBaseAction.handleRequest():52] receive http request. url=/api/bootstrap?\n2020-12-07 14:32:06,550 INFO 89 [RestBaseAction.handleRequest():52] receive http request. url=/api/bootstrap?\n2020-12-07 14:32:11,556 INFO 96 [RestBaseAction.handleRequest():52] receive http request. url=/api/bootstrap\nThe heartbeat logic is so simple and no blocked logic to process,  but we find receive request has delayed somtimes  according to the log info(every 5 seconds should receive the heartbeat request)", "author": "caiconghui", "createdAt": "2020-12-07T06:39:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjUzMDM0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ5NTc0OQ==", "url": "https://github.com/apache/incubator-doris/pull/5027#discussion_r537495749", "bodyText": "I see. Thanks you.", "author": "kangkaisen", "createdAt": "2020-12-07T13:13:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjUzMDM0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUwMzcyNQ==", "url": "https://github.com/apache/incubator-doris/pull/5027#discussion_r537503725", "bodyText": "required field should be used very carefully,  reference here", "author": "sduzh", "createdAt": "2020-12-07T13:25:47Z", "path": "gensrc/thrift/FrontendService.thrift", "diffHunk": "@@ -654,6 +654,25 @@ struct TSnapshotLoaderReportRequest {\n     5: optional i32 total_num\n }\n \n+enum TFrontendPingFrontendStatusCode {\n+   OK = 0,\n+   FAILED = 1\n+}\n+\n+struct TFrontendPingFrontendRequest {\n+   1: required i32 clusterId", "originalCommit": "d38d9b2c831a5c85510c4ba8ebcc0b67c3c76611", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU5NDk5OQ==", "url": "https://github.com/apache/incubator-doris/pull/5027#discussion_r537594999", "bodyText": "I think if the filed is really required and the TFrontendPingFrontendRequest is firstly constructed to use, the field used requried is ok", "author": "caiconghui", "createdAt": "2020-12-07T15:26:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUwMzcyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxMjQyNQ==", "url": "https://github.com/apache/incubator-doris/pull/5027#discussion_r537512425", "bodyText": "The request and response names are unmatched with the service name.", "author": "sduzh", "createdAt": "2020-12-07T13:39:07Z", "path": "gensrc/thrift/FrontendService.thrift", "diffHunk": "@@ -689,4 +708,6 @@ service FrontendService {\n     TStreamLoadPutResult streamLoadPut(1: TStreamLoadPutRequest request)\n \n     Status.TStatus snapshotLoaderReport(1: TSnapshotLoaderReportRequest request)\n-}\n+\n+    TBootstrapResult ping(1: TFrontendPingFrontendRequest request)", "originalCommit": "d38d9b2c831a5c85510c4ba8ebcc0b67c3c76611", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU5NjU3Nw==", "url": "https://github.com/apache/incubator-doris/pull/5027#discussion_r537596577", "bodyText": "thank you for your advice, I will change it.", "author": "caiconghui", "createdAt": "2020-12-07T15:28:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxMjQyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODEyNjg1NQ==", "url": "https://github.com/apache/incubator-doris/pull/5027#discussion_r538126855", "bodyText": "If service is named as ping, why not just name the request/response as TPingRequest/TPingResponse.  I'm just curious about the naming rule of Doris, it's kind of weird for me.", "author": "sduzh", "createdAt": "2020-12-08T08:18:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxMjQyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODEzMTU5Ng==", "url": "https://github.com/apache/incubator-doris/pull/5027#discussion_r538131596", "bodyText": "Sorry to intervene, It's just my personal options, you can just ignore them all ^_^", "author": "sduzh", "createdAt": "2020-12-08T08:25:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxMjQyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE0MTY1Mw==", "url": "https://github.com/apache/incubator-doris/pull/5027#discussion_r538141653", "bodyText": "In my option, by TFrontendPingFrontendRequest, we can know the request is sent by fe to fe, by TPingRequest is less information?", "author": "caiconghui", "createdAt": "2020-12-08T08:40:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxMjQyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE1MzE2MQ==", "url": "https://github.com/apache/incubator-doris/pull/5027#discussion_r538153161", "bodyText": "I get what you mean, actually,   TFrontendPingFrontendRequest is like the name in\n TBrokerOperationStatus ping(1: TBrokerPingBrokerRequest request);", "author": "caiconghui", "createdAt": "2020-12-08T08:57:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxMjQyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxNTM4OA==", "url": "https://github.com/apache/incubator-doris/pull/5027#discussion_r537515388", "bodyText": "Is it ok to use TStatus here?", "author": "sduzh", "createdAt": "2020-12-07T13:43:32Z", "path": "gensrc/thrift/FrontendService.thrift", "diffHunk": "@@ -654,6 +654,25 @@ struct TSnapshotLoaderReportRequest {\n     5: optional i32 total_num\n }\n \n+enum TFrontendPingFrontendStatusCode {\n+   OK = 0,\n+   FAILED = 1\n+}\n+\n+struct TFrontendPingFrontendRequest {\n+   1: required i32 clusterId\n+   2: required string token\n+}\n+\n+struct TBootstrapResult {\n+    1: required TFrontendPingFrontendStatusCode status", "originalCommit": "d38d9b2c831a5c85510c4ba8ebcc0b67c3c76611", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU5NjI2Mw==", "url": "https://github.com/apache/incubator-doris/pull/5027#discussion_r537596263", "bodyText": "TStatus is used for be, just like TBrokerOperationStatus is used for broker, so I think use new status for fe would be better", "author": "caiconghui", "createdAt": "2020-12-07T15:28:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxNTM4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODEyNDU1NQ==", "url": "https://github.com/apache/incubator-doris/pull/5027#discussion_r538124555", "bodyText": "Didn't find any specification that TStatus can only be used between BE and FE.\n\n  \n    \n      incubator-doris/gensrc/thrift/Status.thrift\n    \n    \n         Line 22\n      in\n      49f7eb6\n    \n    \n    \n    \n\n        \n          \n           // The TStatusCode struct is used in all FEs and BEs. In order to be able to", "author": "sduzh", "createdAt": "2020-12-08T08:14:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxNTM4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE1MTIwNA==", "url": "https://github.com/apache/incubator-doris/pull/5027#discussion_r538151204", "bodyText": "Yes, I am also not sure to reuse the TStatus or just like\n\nenum TBrokerOperationStatusCode {\n    OK = 0;\n    END_OF_FILE = 301;\n    \n    // user input error\n    NOT_AUTHORIZED = 401;\n    DUPLICATE_REQUEST = 402;\n    INVALID_INPUT_OFFSET = 403; // user input offset is invalid, is large than file length\n    INVALID_INPUT_FILE_PATH = 404;\n    INVALID_ARGUMENT = 405;\n    \n    // internal server error\n    FILE_NOT_FOUND = 501;\n    TARGET_STORAGE_SERVICE_ERROR = 502; // the target storage service error\n    OPERATION_NOT_SUPPORTED = 503; // the api is not implemented\n}\n\ndefine new status struct", "author": "caiconghui", "createdAt": "2020-12-08T08:55:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxNTM4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUyMjkxMQ==", "url": "https://github.com/apache/incubator-doris/pull/5027#discussion_r537522911", "bodyText": "Is it really necessary to keep the HTTP based codes?\ncc @kangkaisen", "author": "sduzh", "createdAt": "2020-12-07T13:54:30Z", "path": "fe/fe-core/src/main/java/org/apache/doris/system/HeartbeatMgr.java", "diffHunk": "@@ -282,13 +276,20 @@ public HeartbeatResponse call() {\n                 // heartbeat to self\n                 if (Catalog.getCurrentCatalog().isReady()) {\n                     return new FrontendHbResponse(fe.getNodeName(), Config.query_port, Config.rpc_port,\n-                            Catalog.getCurrentCatalog().getReplayedJournalId(), System.currentTimeMillis(),\n+                            Catalog.getCurrentCatalog().getMaxJournalId(), System.currentTimeMillis(),\n                             Version.DORIS_BUILD_VERSION + \"-\" + Version.DORIS_BUILD_SHORT_HASH);\n                 } else {\n                     return new FrontendHbResponse(fe.getNodeName(), \"not ready\");\n                 }\n             }\n+            if (Config.enable_fe_heartbeat_by_thrift) {\n+                return getHeartbeatResponseByThrift();\n+            } else {\n+                return getHeartbeatResponseByHttp();", "originalCommit": "d38d9b2c831a5c85510c4ba8ebcc0b67c3c76611", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU5Mzg1NQ==", "url": "https://github.com/apache/incubator-doris/pull/5027#discussion_r537593855", "bodyText": "@sduzh be compatible with older versions(0.13), and should be moved next version(0.15). if you ugrade non master fe first, the heartbeat will fail.", "author": "caiconghui", "createdAt": "2020-12-07T15:25:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUyMjkxMQ=="}], "type": "inlineReview"}, {"oid": "edfe6ca21be0145fe9d929be09e0a9fed7ff6d6e", "url": "https://github.com/apache/incubator-doris/commit/edfe6ca21be0145fe9d929be09e0a9fed7ff6d6e", "message": "fix by review", "committedDate": "2020-12-07T15:42:41Z", "type": "commit"}]}