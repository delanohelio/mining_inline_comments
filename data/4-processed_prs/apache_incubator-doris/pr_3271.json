{"pr_number": 3271, "pr_title": "[Bug] Avoid compacting recently added rowset", "pr_createdAt": "2020-04-07T08:14:17Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3271", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYyOTIyNQ==", "url": "https://github.com/apache/incubator-doris/pull/3271#discussion_r404629225", "bodyText": "Better to use function in util/time.h.", "author": "imay", "createdAt": "2020-04-07T08:27:25Z", "path": "be/src/olap/rowset/rowset.cpp", "diffHunk": "@@ -65,6 +67,9 @@ void Rowset::make_visible(Version version, VersionHash version_hash) {\n     _rowset_meta->set_version(version);\n     _rowset_meta->set_version_hash(version_hash);\n     _rowset_meta->set_rowset_state(VISIBLE);\n+    // update create time to the visible time,\n+    // it's used to skip recently published version during compaction\n+    _rowset_meta->set_creation_time(time(nullptr));", "originalCommit": "64e1cb062bf9126a4988d9556038199ae88b2d4d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc3ODQ0Mw==", "url": "https://github.com/apache/incubator-doris/pull/3271#discussion_r404778443", "bodyText": "You mean UnixMillis() / 1000? Any reason for that, it seems more verbose than time(nullptr).", "author": "gaodayue", "createdAt": "2020-04-07T12:44:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYyOTIyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc4NTk5NA==", "url": "https://github.com/apache/incubator-doris/pull/3271#discussion_r404785994", "bodyText": "Just to unify. I think it will be better to use functions in this file to get all kinds of current time.\nActually, it is OK for this case to get a monotonic time other than wall time, which will still work when system time rollback.", "author": "imay", "createdAt": "2020-04-07T12:56:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYyOTIyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI0MTA3MA==", "url": "https://github.com/apache/incubator-doris/pull/3271#discussion_r405241070", "bodyText": "OK, I'll use functions in util/time.h instead. However I don't think monotonic time is appropriate here for two reasons\n\nPrevious rowsets use unix timestamp as creation_time, switch to monotonic time will break other parts of code that uses that field\nMonotonic time may go backward after system reboot, which is not suitable for persistence", "author": "gaodayue", "createdAt": "2020-04-08T03:43:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYyOTIyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI0MjQ2NQ==", "url": "https://github.com/apache/incubator-doris/pull/3271#discussion_r405242465", "bodyText": "Yes, you're right. Last night when I remembered that create time will be saved, then I realize that the monotonic time is not suitable.", "author": "imay", "createdAt": "2020-04-08T03:49:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYyOTIyNQ=="}], "type": "inlineReview"}, {"oid": "57befd2702af593423c1685095d3a646840c21ee", "url": "https://github.com/apache/incubator-doris/commit/57befd2702af593423c1685095d3a646840c21ee", "message": "[Bug] Avoid compacting recengly added rowset", "committedDate": "2020-04-08T04:07:35Z", "type": "commit"}, {"oid": "57befd2702af593423c1685095d3a646840c21ee", "url": "https://github.com/apache/incubator-doris/commit/57befd2702af593423c1685095d3a646840c21ee", "message": "[Bug] Avoid compacting recengly added rowset", "committedDate": "2020-04-08T04:07:35Z", "type": "forcePushed"}]}