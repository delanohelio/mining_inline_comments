{"pr_number": 3044, "pr_title": "Write delete predicate into RowsetMeta upon upgrade from Doris-0.10 to Doris-0.11", "pr_createdAt": "2020-03-06T02:14:52Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3044", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODY4ODM0MA==", "url": "https://github.com/apache/incubator-doris/pull/3044#discussion_r388688340", "bodyText": "This function name indicates filling content from olap_header. It is not a good idea to change olap_header's content.\nAnd comment about what will be done in this function is needed.", "author": "imay", "createdAt": "2020-03-06T02:50:33Z", "path": "be/src/olap/olap_snapshot_converter.cpp", "diffHunk": "@@ -89,27 +93,27 @@ OLAPStatus OlapSnapshotConverter::to_olap_header(const TabletMetaPB& tablet_meta\n     return OLAP_SUCCESS;\n }\n \n-OLAPStatus OlapSnapshotConverter::to_tablet_meta_pb(const OLAPHeaderMessage& olap_header,\n+OLAPStatus OlapSnapshotConverter::to_tablet_meta_pb(OLAPHeaderMessage* olap_header,", "originalCommit": "6699221c9bf8f9166a338c8dd6fe628e276830ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcwMDY5NA==", "url": "https://github.com/apache/incubator-doris/pull/3044#discussion_r388700694", "bodyText": "Because PDelta can not corresponds with RowsetMeta.\nSo before calling convert_to_rowset_meta, I add delete predicate to PDelta to store delete predicate.\nOK, I use a PDelta temp variable to get rid of OLAPHeaderMessage.", "author": "chaoyli", "createdAt": "2020-03-06T03:49:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODY4ODM0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODY4ODg0MQ==", "url": "https://github.com/apache/incubator-doris/pull/3044#discussion_r388688841", "bodyText": "Originally, this function only converts the header to meta.\nCan you implement another function to finish new added operation to make it less complicate?", "author": "imay", "createdAt": "2020-03-06T02:52:43Z", "path": "be/src/olap/olap_snapshot_converter.h", "diffHunk": "@@ -47,7 +47,7 @@ class OlapSnapshotConverter {\n     // convert olap header to tablet meta pb, convert delta to rowsetmetapb\n     // pending delta is not in tablet meta any more, so that convert pending delta to rowset and add it to pending rowsets\n     // as a return value\n-    OLAPStatus to_tablet_meta_pb(const OLAPHeaderMessage& olap_header, TabletMetaPB* tablet_meta_pb, \n+    OLAPStatus to_tablet_meta_pb(OLAPHeaderMessage* olap_header, TabletMetaPB* tablet_meta_pb,", "originalCommit": "6699221c9bf8f9166a338c8dd6fe628e276830ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "da90067cedce8eaf6a3c0e7f419ce2d3d4e94b3a", "url": "https://github.com/apache/incubator-doris/commit/da90067cedce8eaf6a3c0e7f419ce2d3d4e94b3a", "message": "Write delete predicate into RowsetMeta upon upgrade from Doris-0.10 to Doris-0.11\n\nIf delete predicate exists in meta in Doris-0.10, all of this predicates should\nbe remained. There is an confused place in Doris-0.10. The delete predicate\nonly exists in OLAPHeaderMessage and PPendingDelta, not in PDelta.\nThis trick results this bug.", "committedDate": "2020-03-06T04:06:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODczMDU1MQ==", "url": "https://github.com/apache/incubator-doris/pull/3044#discussion_r388730551", "bodyText": "align", "author": "imay", "createdAt": "2020-03-06T06:21:08Z", "path": "be/src/olap/olap_snapshot_converter.cpp", "diffHunk": "@@ -131,11 +136,23 @@ OLAPStatus OlapSnapshotConverter::to_tablet_meta_pb(const OLAPHeaderMessage& ola\n     }\n \n     std::unordered_map<Version, RowsetMetaPB*, HashOfVersion> _rs_version_map;\n+    const DelPredicateArray& delete_conditions = olap_header.delete_data_conditions();\n     for (auto& delta : olap_header.delta()) {\n         RowsetId next_id = StorageEngine::instance()->next_rowset_id();\n         RowsetMetaPB* rowset_meta = tablet_meta_pb->add_rs_metas();\n-        convert_to_rowset_meta(delta, next_id, olap_header.tablet_id(), olap_header.schema_hash(), rowset_meta);\n-        Version rowset_version = { delta.start_version(), delta.end_version() };\n+        PDelta temp_delta = delta;\n+        // PDelta is not corresponding with RowsetMeta in DeletePredicate\n+        // Add delete predicate to PDelta from OLAPHeaderMessage.\n+        // Only after this, convert from PDelta to RowsetMeta is valid.\n+        for (auto& del_pred : delete_conditions) {\n+            if (temp_delta.start_version() == temp_delta.end_version()\n+                && temp_delta.start_version() == del_pred.version()) {\n+                    DeletePredicatePB* delete_condition = temp_delta.mutable_delete_condition();\n+                    *delete_condition = del_pred;\n+                }", "originalCommit": "da90067cedce8eaf6a3c0e7f419ce2d3d4e94b3a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODczMTIyOQ==", "url": "https://github.com/apache/incubator-doris/pull/3044#discussion_r388731229", "bodyText": "align", "author": "imay", "createdAt": "2020-03-06T06:23:49Z", "path": "be/src/olap/olap_snapshot_converter.cpp", "diffHunk": "@@ -150,7 +167,15 @@ OLAPStatus OlapSnapshotConverter::to_tablet_meta_pb(const OLAPHeaderMessage& ola\n         }\n         RowsetId next_id = StorageEngine::instance()->next_rowset_id();\n         RowsetMetaPB* rowset_meta = tablet_meta_pb->add_inc_rs_metas();\n-        convert_to_rowset_meta(inc_delta, next_id, olap_header.tablet_id(), olap_header.schema_hash(), rowset_meta);\n+        PDelta temp_inc_delta = inc_delta;\n+        for (auto& del_pred : delete_conditions) {\n+            if (temp_inc_delta.start_version() == temp_inc_delta.end_version()\n+                && temp_inc_delta.start_version() == del_pred.version()) {\n+                    DeletePredicatePB* delete_condition = temp_inc_delta.mutable_delete_condition();\n+                    *delete_condition = del_pred;\n+                }", "originalCommit": "da90067cedce8eaf6a3c0e7f419ce2d3d4e94b3a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODczMTc2OQ==", "url": "https://github.com/apache/incubator-doris/pull/3044#discussion_r388731769", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    for (auto& del_pred : delete_conditions) {\n          \n          \n            \n                        if (temp_delta.start_version() == temp_delta.end_version()\n          \n          \n            \n                            && temp_delta.start_version() == del_pred.version()) {\n          \n          \n            \n                                DeletePredicatePB* delete_condition = temp_delta.mutable_delete_condition();\n          \n          \n            \n                                *delete_condition = del_pred;\n          \n          \n            \n                            }\n          \n          \n            \n                    if (temp_delta.start_version() == temp_delta.end_version()) {\n          \n          \n            \n                        for (auto& del_pred : delete_conditions) {\n          \n          \n            \n                            if (temp_delta.start_version() == del_pred.version()) {\n          \n          \n            \n                                DeletePredicatePB* delete_condition = temp_delta.mutable_delete_condition();\n          \n          \n            \n                                *delete_condition = del_pred;\n          \n          \n            \n                            }", "author": "imay", "createdAt": "2020-03-06T06:26:01Z", "path": "be/src/olap/olap_snapshot_converter.cpp", "diffHunk": "@@ -131,11 +136,23 @@ OLAPStatus OlapSnapshotConverter::to_tablet_meta_pb(const OLAPHeaderMessage& ola\n     }\n \n     std::unordered_map<Version, RowsetMetaPB*, HashOfVersion> _rs_version_map;\n+    const DelPredicateArray& delete_conditions = olap_header.delete_data_conditions();\n     for (auto& delta : olap_header.delta()) {\n         RowsetId next_id = StorageEngine::instance()->next_rowset_id();\n         RowsetMetaPB* rowset_meta = tablet_meta_pb->add_rs_metas();\n-        convert_to_rowset_meta(delta, next_id, olap_header.tablet_id(), olap_header.schema_hash(), rowset_meta);\n-        Version rowset_version = { delta.start_version(), delta.end_version() };\n+        PDelta temp_delta = delta;\n+        // PDelta is not corresponding with RowsetMeta in DeletePredicate\n+        // Add delete predicate to PDelta from OLAPHeaderMessage.\n+        // Only after this, convert from PDelta to RowsetMeta is valid.\n+        for (auto& del_pred : delete_conditions) {\n+            if (temp_delta.start_version() == temp_delta.end_version()\n+                && temp_delta.start_version() == del_pred.version()) {\n+                    DeletePredicatePB* delete_condition = temp_delta.mutable_delete_condition();\n+                    *delete_condition = del_pred;\n+                }", "originalCommit": "da90067cedce8eaf6a3c0e7f419ce2d3d4e94b3a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "89eaef84c1ddf114ee4c723bdf0d97ddf9f1b648", "url": "https://github.com/apache/incubator-doris/commit/89eaef84c1ddf114ee4c723bdf0d97ddf9f1b648", "message": "Write delete predicate into RowsetMeta upon upgrade from Doris-0.10 to Doris-0.11\n\nIf delete predicate exists in meta in Doris-0.10, all of this predicates should\nbe remained. There is an confused place in Doris-0.10. The delete predicate\nonly exists in OLAPHeaderMessage and PPendingDelta, not in PDelta.\nThis trick results this bug.", "committedDate": "2020-03-06T06:51:50Z", "type": "commit"}]}