{"pr_number": 3228, "pr_title": "Fix output results may  incorrect  when using intersect and except statements", "pr_createdAt": "2020-03-30T08:02:44Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3228", "timeline": [{"oid": "e529249af6f0d929344bb887b2d127fab3a0c521", "url": "https://github.com/apache/incubator-doris/commit/e529249af6f0d929344bb887b2d127fab3a0c521", "message": "output results may  incorrect  when using intersect and except statements", "committedDate": "2020-03-30T08:03:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDEyODg2Mg==", "url": "https://github.com/apache/incubator-doris/pull/3228#discussion_r400128862", "bodyText": "why does hashtable has the same value\uff1fWhen you create a hash table, will duplicate values are inserted into the hash table\uff1f", "author": "wutiangan", "createdAt": "2020-03-30T11:47:53Z", "path": "be/src/exec/except_node.cpp", "diffHunk": "@@ -179,17 +137,21 @@ Status ExceptNode::get_next(RuntimeState* state, RowBatch* out_batch, bool* eos)\n     if (reached_limit()) {\n         return Status::OK();\n     }\n+    int64_t tuple_buf_size;\n+    uint8_t* tuple_buf;\n+    RETURN_IF_ERROR(\n+            out_batch->resize_and_allocate_tuple_buffer(state, &tuple_buf_size, &tuple_buf));\n     uint32_t previous_hash = -1;\n     TupleRow* previous_row = nullptr;\n     while (_hash_tbl_iterator.has_next()) {\n+        VLOG_ROW << \"find row: \"\n+                 << get_row_output_string(_hash_tbl_iterator.get_row(), child(0)->row_desc())\n+                 << \" matched: \" << _hash_tbl_iterator.matched();\n         if (!_hash_tbl_iterator.matched()) {\n             if (previous_hash != _hash_tbl_iterator.get_hash() ||\n                 !equals(previous_row, _hash_tbl_iterator.get_row())) {", "originalCommit": "e529249af6f0d929344bb887b2d127fab3a0c521", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI2MDg4Mg==", "url": "https://github.com/apache/incubator-doris/pull/3228#discussion_r400260882", "bodyText": "As I know, this hash table will store all rows with same hash key.", "author": "morningman", "createdAt": "2020-03-30T14:59:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDEyODg2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYwNzg2MA==", "url": "https://github.com/apache/incubator-doris/pull/3228#discussion_r400607860", "bodyText": "But this is a set operation\uff08It is different from join\uff09. The set operation has de duplication. so the elements of the hash table do not need to have deduplicatedvalue\u3002", "author": "wutiangan", "createdAt": "2020-03-31T02:36:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDEyODg2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYzMjUxOA==", "url": "https://github.com/apache/incubator-doris/pull/3228#discussion_r400632518", "bodyText": "duplicated values will be iterate when get next,and deduplicate can reduce the cost of probe,you can find detail in hash_table.h,hash table in doris is not same with the common sense hashtable", "author": "yangzhg", "createdAt": "2020-03-31T04:13:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDEyODg2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI1OTcyOA==", "url": "https://github.com/apache/incubator-doris/pull/3228#discussion_r400259728", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // build hash table and remvoe duplicate items\n          \n          \n            \n                    // build hash table and remove duplicate items", "author": "morningman", "createdAt": "2020-03-30T14:58:08Z", "path": "be/src/exec/except_node.cpp", "diffHunk": "@@ -112,6 +63,8 @@ Status ExceptNode::open(RuntimeState* state) {\n         RETURN_IF_LIMIT_EXCEEDED(state, \" Except, while constructing the hash table.\");\n         // build hash table and remvoe duplicate items", "originalCommit": "e529249af6f0d929344bb887b2d127fab3a0c521", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "aa4a51d1005e9291805fcb06eacb6a605906575e", "url": "https://github.com/apache/incubator-doris/commit/aa4a51d1005e9291805fcb06eacb6a605906575e", "message": "output results may  incorrect  when using intersect and except statements", "committedDate": "2020-04-01T01:40:00Z", "type": "commit"}, {"oid": "aa4a51d1005e9291805fcb06eacb6a605906575e", "url": "https://github.com/apache/incubator-doris/commit/aa4a51d1005e9291805fcb06eacb6a605906575e", "message": "output results may  incorrect  when using intersect and except statements", "committedDate": "2020-04-01T01:40:00Z", "type": "forcePushed"}, {"oid": "b0b5571c6fb90f8de2449ac74a55fd5b4e0d25fb", "url": "https://github.com/apache/incubator-doris/commit/b0b5571c6fb90f8de2449ac74a55fd5b4e0d25fb", "message": "remove deduplicted code from get next", "committedDate": "2020-04-01T02:45:43Z", "type": "commit"}]}