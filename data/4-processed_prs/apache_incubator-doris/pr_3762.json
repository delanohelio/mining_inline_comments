{"pr_number": 3762, "pr_title": "[Memory Engine] MemTablet creation and compatibility handling in BE", "pr_createdAt": "2020-06-03T11:48:50Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3762", "timeline": [{"oid": "21c18bfad9e3ab59cb6db0483b989d78f138abe8", "url": "https://github.com/apache/incubator-doris/commit/21c18bfad9e3ab59cb6db0483b989d78f138abe8", "message": "[Memory Engine] MemTablet creation and compatibility handling in BE", "committedDate": "2020-06-03T11:36:00Z", "type": "commit"}, {"oid": "1543b26bac47991a677eacc0a56f0d293b874389", "url": "https://github.com/apache/incubator-doris/commit/1543b26bac47991a677eacc0a56f0d293b874389", "message": "Merge branch 'master' into tablet-manager2", "committedDate": "2020-06-04T03:20:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk4NjA1MA==", "url": "https://github.com/apache/incubator-doris/pull/3762#discussion_r435986050", "bodyText": "Is this a incomplete implementation? If yes, better add a TODO", "author": "morningman", "createdAt": "2020-06-05T15:10:35Z", "path": "be/src/olap/memory/mem_tablet.h", "diffHunk": "@@ -27,6 +27,15 @@ class MemSubTablet;\n class ScanSpec;\n class MemTabletScan;\n class WriteTxn;\n+class MemTablet;\n+using MemTabletSharedPtr = std::shared_ptr<MemTablet>;\n+\n+inline MemTabletSharedPtr to_mem_tablet(const BaseTabletSharedPtr& base) {\n+    if (base->is_memory()) {\n+        return std::static_pointer_cast<MemTablet>(base);\n+    }\n+    return MemTabletSharedPtr();", "originalCommit": "1543b26bac47991a677eacc0a56f0d293b874389", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk4Njc1MA==", "url": "https://github.com/apache/incubator-doris/pull/3762#discussion_r435986750", "bodyText": "incomplete?", "author": "morningman", "createdAt": "2020-06-05T15:11:50Z", "path": "be/src/olap/tablet.h", "diffHunk": "@@ -46,47 +46,27 @@ class TabletMeta;\n \n using TabletSharedPtr = std::shared_ptr<Tablet>;\n \n+inline TabletSharedPtr to_tablet(const BaseTabletSharedPtr& base) {\n+    if (base->is_memory()) {\n+        return TabletSharedPtr();", "originalCommit": "1543b26bac47991a677eacc0a56f0d293b874389", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ0MTk4OA==", "url": "https://github.com/apache/incubator-doris/pull/3762#discussion_r436441988", "bodyText": "Why is this incomplete? This utility function for pointer conversion is only used in some internal code, another option is inline them, because, after inlining, some logic is redundant.", "author": "decster", "createdAt": "2020-06-08T03:33:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk4Njc1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc4ODc0MA==", "url": "https://github.com/apache/incubator-doris/pull/3762#discussion_r436788740", "bodyText": "Change the comment", "author": "morningman", "createdAt": "2020-06-08T15:18:24Z", "path": "be/src/olap/tablet_manager.cpp", "diffHunk": "@@ -98,26 +99,34 @@ OLAPStatus TabletManager::_add_tablet_unlocked(TTabletId tablet_id, SchemaHash s\n \n     if (existed_tablet == nullptr) {\n         return _add_tablet_to_map_unlocked(tablet_id, schema_hash,\n-                                           tablet, update_meta,\n+                                           base_tablet, update_meta,\n                                            false /*keep_files*/, false /*drop_old*/);\n     }\n \n     if (!force) {\n-        if (existed_tablet->tablet_path() == tablet->tablet_path()) {\n+        if (existed_tablet->tablet_path() == base_tablet->tablet_path()) {\n             LOG(WARNING) << \"add the same tablet twice! tablet_id=\" << tablet_id\n                          << \", schema_hash=\" << schema_hash\n-                         << \", tablet_path=\" << tablet->tablet_path();\n+                         << \", tablet_path=\" << base_tablet->tablet_path();\n             return OLAP_ERR_ENGINE_INSERT_EXISTS_TABLE;\n         }\n-        if (existed_tablet->data_dir() == tablet->data_dir()) {\n+        if (existed_tablet->data_dir() == base_tablet->data_dir()) {\n             LOG(WARNING) << \"add tablet with same data dir twice! tablet_id=\" << tablet_id\n                          << \", schema_hash=\" << schema_hash;\n             return OLAP_ERR_ENGINE_INSERT_EXISTS_TABLE;\n         }\n     }\n \n+    if (base_tablet->is_memory() || existed_tablet->is_memory()) {\n+        LOG(WARNING) << \"add the same tablet twice! tablet_id=\" << tablet_id", "originalCommit": "1543b26bac47991a677eacc0a56f0d293b874389", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ab7da59bd93517bf0bf50e21234bd0dc0d4c4750", "url": "https://github.com/apache/incubator-doris/commit/ab7da59bd93517bf0bf50e21234bd0dc0d4c4750", "message": "[Memory Engine] MemTablet creation and compatibility handling in BE: address review comments", "committedDate": "2020-06-09T07:11:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA5MzQyNg==", "url": "https://github.com/apache/incubator-doris/pull/3762#discussion_r437093426", "bodyText": "You can return nullptr directly.", "author": "chaoyli", "createdAt": "2020-06-09T01:53:12Z", "path": "be/src/olap/tablet_manager.cpp", "diffHunk": "@@ -1374,16 +1482,29 @@ TabletSharedPtr TabletManager::_get_tablet_unlocked(TTabletId tablet_id, SchemaH\n \n     VLOG(3) << \"fail to get tablet. tablet_id=\" << tablet_id << \", schema_hash=\" << schema_hash;\n     // Return nullptr tablet if fail\n-    TabletSharedPtr tablet;\n+    BaseTabletSharedPtr tablet;", "originalCommit": "1543b26bac47991a677eacc0a56f0d293b874389", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d7697bf465fe9274e05ac4ec1317d5da2f1bfff7", "url": "https://github.com/apache/incubator-doris/commit/d7697bf465fe9274e05ac4ec1317d5da2f1bfff7", "message": "[Memory Engine] MemTablet creation and compatibility handling in BE: address review comments", "committedDate": "2020-06-16T02:43:09Z", "type": "commit"}]}