{"pr_number": 4237, "pr_title": "[BUG] Using attachement strategy of brpc to send packet with big size.", "pr_createdAt": "2020-08-03T11:22:16Z", "pr_url": "https://github.com/apache/incubator-doris/pull/4237", "timeline": [{"oid": "00f4d35f14bd6d8ff37258bddf0c2970c7a7ce7e", "url": "https://github.com/apache/incubator-doris/commit/00f4d35f14bd6d8ff37258bddf0c2970c7a7ce7e", "message": "[BUG] Using attachement strategy of brpc to send packet with big size.\nBRPC send packet should serialize it first and then send it.\nIf we send one batch with big size, it will encounter a connection failed.\nSo we can use attachment strategy to bypass the problem and eliminate\nthe serialization cost.", "committedDate": "2020-08-03T11:47:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDM5MTEzOA==", "url": "https://github.com/apache/incubator-doris/pull/4237#discussion_r464391138", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // If batch size large than brpc_attachment_threashold, use attachment instead\n          \n          \n            \n                // If batch size is larger than brpc_attachment_threshold, use attachment instead\n          \n      \n    \n    \n  \n\nI have a question, why not use threshold directly for all the packets?", "author": "imay", "createdAt": "2020-08-03T12:48:48Z", "path": "be/src/common/config.h", "diffHunk": "@@ -519,6 +519,8 @@ namespace config {\n     CONF_Int64(brpc_max_body_size, \"209715200\");\n     // Max unwritten bytes in each socket, if the limit is reached, Socket.Write fails with EOVERCROWDED\n     CONF_Int64(brpc_socket_max_unwritten_bytes, \"67108864\");\n+    // If batch size large than brpc_attachment_threashold, use attachment instead", "originalCommit": "00f4d35f14bd6d8ff37258bddf0c2970c7a7ce7e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDM5MjMxOA==", "url": "https://github.com/apache/incubator-doris/pull/4237#discussion_r464392318", "bodyText": "why delete origin timer and counter?", "author": "imay", "createdAt": "2020-08-03T12:51:10Z", "path": "be/src/runtime/data_stream_sender.cpp", "diffHunk": "@@ -270,12 +277,7 @@ Status DataStreamSender::Channel::add_row(TupleRow* row) {\n }\n \n Status DataStreamSender::Channel::send_current_batch(bool eos) {\n-    {\n-        SCOPED_TIMER(_parent->_serialize_batch_timer);\n-        int uncompressed_bytes = _batch->serialize(&_pb_batch);\n-        COUNTER_UPDATE(_parent->_bytes_sent_counter, RowBatch::get_batch_size(_pb_batch));\n-        COUNTER_UPDATE(_parent->_uncompressed_bytes_counter, uncompressed_bytes);\n-    }\n+    _parent->serialize_batch(_batch.get(), &_pb_batch, 1);", "originalCommit": "00f4d35f14bd6d8ff37258bddf0c2970c7a7ce7e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDM5MzE3OA==", "url": "https://github.com/apache/incubator-doris/pull/4237#discussion_r464393178", "bodyText": "Will this variable will cause memory leak?", "author": "imay", "createdAt": "2020-08-03T12:52:53Z", "path": "be/src/runtime/data_stream_sender.cpp", "diffHunk": "@@ -227,7 +227,14 @@ Status DataStreamSender::Channel::send_batch(PRowBatch* batch, bool eos) {\n     }\n \n     _brpc_request.set_eos(eos);\n-    if (batch != nullptr) {\n+    if (batch != nullptr && RowBatch::get_batch_size(*batch) > config::brpc_socket_max_unwritten_bytes) {\n+        std::string* tuple_data_to_attachment = batch->release_tuple_data();", "originalCommit": "00f4d35f14bd6d8ff37258bddf0c2970c7a7ce7e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "432aa46b8e22bfd9c9acfb5d79fff19be17a4e8d", "url": "https://github.com/apache/incubator-doris/commit/432aa46b8e22bfd9c9acfb5d79fff19be17a4e8d", "message": "Fix memory leak", "committedDate": "2020-08-04T06:08:21Z", "type": "commit"}, {"oid": "f7d0a27a108a7573c2b3ed09b3113bfccd9bb98d", "url": "https://github.com/apache/incubator-doris/commit/f7d0a27a108a7573c2b3ed09b3113bfccd9bb98d", "message": "Add clear tuple_data", "committedDate": "2020-08-04T06:27:51Z", "type": "commit"}]}