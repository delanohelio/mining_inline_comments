{"pr_number": 3814, "pr_title": "[trace] Adapt trace util to compaction module", "pr_createdAt": "2020-06-10T03:47:28Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3814", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE4NjU5Ng==", "url": "https://github.com/apache/incubator-doris/pull/3814#discussion_r438186596", "bodyText": "Please update the be-config.md document, to explain these 2 configs, add how to use the trace.", "author": "morningman", "createdAt": "2020-06-10T14:53:34Z", "path": "be/src/common/config.h", "diffHunk": "@@ -281,6 +281,10 @@ namespace config {\n     // This config can be set to 0, which means to forbid any compaction, for some special cases.\n     CONF_Int32(max_compaction_concurrency, \"-1\");\n \n+    // Threshold to logging compaction trace, in seconds.\n+    CONF_mInt32(base_compaction_trace_threshold, \"10\");\n+    CONF_mInt32(cumulative_compaction_trace_threshold, \"2\");", "originalCommit": "4998d6067b450e4bd3f92328c3a4a1f57a7e32b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a51684d14baf0fa23f1f89d8617006172fd7f6ed", "url": "https://github.com/apache/incubator-doris/commit/a51684d14baf0fa23f1f89d8617006172fd7f6ed", "message": "init", "committedDate": "2020-06-11T07:45:35Z", "type": "forcePushed"}, {"oid": "07c939fed9101a3ff6397c6cacb62e7bfa6f32f1", "url": "https://github.com/apache/incubator-doris/commit/07c939fed9101a3ff6397c6cacb62e7bfa6f32f1", "message": "[trace] Adapt trace util to compaction module\n\nTrace util is helpful for diagnosing compaction performance problems,\nwe can get trace log for base compaction like:\n```\nW0610 11:26:33.804431 56452 storage_engine.cpp:552] Trace:\n0610 11:23:03.727535 (+     0us) storage_engine.cpp:554] start to perform base compaction\n0610 11:23:03.728961 (+  1426us) storage_engine.cpp:560] found best tablet 546859\n0610 11:23:03.728963 (+     2us) base_compaction.cpp:40] got base compaction lock\n0610 11:23:03.729029 (+    66us) base_compaction.cpp:44] rowsets picked\n0610 11:24:51.784439 (+108055410us) compaction.cpp:46] got concurrency lock and start to do compaction\n0610 11:24:51.784818 (+   379us) compaction.cpp:74] prepare finished\n0610 11:26:33.359265 (+101574447us) compaction.cpp:87] merge rowsets finished\n0610 11:26:33.484481 (+125216us) compaction.cpp:102] output rowset built\n0610 11:26:33.484482 (+     1us) compaction.cpp:106] check correctness finished\n0610 11:26:33.513197 (+ 28715us) compaction.cpp:110] modify rowsets finished\n0610 11:26:33.513300 (+   103us) base_compaction.cpp:49] compaction finished\n0610 11:26:33.513441 (+   141us) base_compaction.cpp:56] unused rowsets have been moved to GC queue\nMetrics: {\"filtered_rows\":0,\"input_row_num\":3346807,\"input_rowsets_count\":42,\"input_rowsets_data_size\":1256413170,\"input_segments_num\":44,\"merge_rowsets_latency_us\":101574444,\"merged_rows\":0,\"output_row_num\":3346807,\"output_rowset_data_size\":1228439659,\"output_segments_num\":6}\n```\nfor cumulative compaction like:\n```\nW0610 11:14:18.714366 56468 storage_engine.cpp:518] Trace:\n0610 11:14:08.068484 (+     0us) storage_engine.cpp:520] start to perform cumulative compaction\n0610 11:14:08.069844 (+  1360us) storage_engine.cpp:526] found best tablet 547083\n0610 11:14:08.069846 (+     2us) cumulative_compaction.cpp:42] got cumulative compaction lock\n0610 11:14:08.069947 (+   101us) cumulative_compaction.cpp:46] calculated cumulative point\n0610 11:14:08.070141 (+   194us) cumulative_compaction.cpp:50] rowsets picked\n0610 11:14:08.070143 (+     2us) compaction.cpp:46] got concurrency lock and start to do compaction\n0610 11:14:08.070518 (+   375us) compaction.cpp:74] prepare finished\n0610 11:14:15.389893 (+7319375us) compaction.cpp:87] merge rowsets finished\n0610 11:14:15.390916 (+  1023us) compaction.cpp:102] output rowset built\n0610 11:14:15.390917 (+     1us) compaction.cpp:106] check correctness finished\n0610 11:14:15.409460 (+ 18543us) compaction.cpp:110] modify rowsets finished\n0610 11:14:15.409496 (+    36us) cumulative_compaction.cpp:55] compaction finished\n0610 11:14:15.410138 (+   642us) cumulative_compaction.cpp:65] unused rowsets have been moved to GC queue\nMetrics: {\"filtered_rows\":0,\"input_row_num\":136707,\"input_rowsets_count\":302,\"input_rowsets_data_size\":76617836,\"input_segments_num\":302,\"merge_rowsets_latency_us\":7319372,\"merged_rows\":0,\"output_row_num\":136707,\"output_rowset_data_size\":53893280,\"output_segments_num\":1}\n```", "committedDate": "2020-06-11T07:49:49Z", "type": "commit"}, {"oid": "07c939fed9101a3ff6397c6cacb62e7bfa6f32f1", "url": "https://github.com/apache/incubator-doris/commit/07c939fed9101a3ff6397c6cacb62e7bfa6f32f1", "message": "[trace] Adapt trace util to compaction module\n\nTrace util is helpful for diagnosing compaction performance problems,\nwe can get trace log for base compaction like:\n```\nW0610 11:26:33.804431 56452 storage_engine.cpp:552] Trace:\n0610 11:23:03.727535 (+     0us) storage_engine.cpp:554] start to perform base compaction\n0610 11:23:03.728961 (+  1426us) storage_engine.cpp:560] found best tablet 546859\n0610 11:23:03.728963 (+     2us) base_compaction.cpp:40] got base compaction lock\n0610 11:23:03.729029 (+    66us) base_compaction.cpp:44] rowsets picked\n0610 11:24:51.784439 (+108055410us) compaction.cpp:46] got concurrency lock and start to do compaction\n0610 11:24:51.784818 (+   379us) compaction.cpp:74] prepare finished\n0610 11:26:33.359265 (+101574447us) compaction.cpp:87] merge rowsets finished\n0610 11:26:33.484481 (+125216us) compaction.cpp:102] output rowset built\n0610 11:26:33.484482 (+     1us) compaction.cpp:106] check correctness finished\n0610 11:26:33.513197 (+ 28715us) compaction.cpp:110] modify rowsets finished\n0610 11:26:33.513300 (+   103us) base_compaction.cpp:49] compaction finished\n0610 11:26:33.513441 (+   141us) base_compaction.cpp:56] unused rowsets have been moved to GC queue\nMetrics: {\"filtered_rows\":0,\"input_row_num\":3346807,\"input_rowsets_count\":42,\"input_rowsets_data_size\":1256413170,\"input_segments_num\":44,\"merge_rowsets_latency_us\":101574444,\"merged_rows\":0,\"output_row_num\":3346807,\"output_rowset_data_size\":1228439659,\"output_segments_num\":6}\n```\nfor cumulative compaction like:\n```\nW0610 11:14:18.714366 56468 storage_engine.cpp:518] Trace:\n0610 11:14:08.068484 (+     0us) storage_engine.cpp:520] start to perform cumulative compaction\n0610 11:14:08.069844 (+  1360us) storage_engine.cpp:526] found best tablet 547083\n0610 11:14:08.069846 (+     2us) cumulative_compaction.cpp:42] got cumulative compaction lock\n0610 11:14:08.069947 (+   101us) cumulative_compaction.cpp:46] calculated cumulative point\n0610 11:14:08.070141 (+   194us) cumulative_compaction.cpp:50] rowsets picked\n0610 11:14:08.070143 (+     2us) compaction.cpp:46] got concurrency lock and start to do compaction\n0610 11:14:08.070518 (+   375us) compaction.cpp:74] prepare finished\n0610 11:14:15.389893 (+7319375us) compaction.cpp:87] merge rowsets finished\n0610 11:14:15.390916 (+  1023us) compaction.cpp:102] output rowset built\n0610 11:14:15.390917 (+     1us) compaction.cpp:106] check correctness finished\n0610 11:14:15.409460 (+ 18543us) compaction.cpp:110] modify rowsets finished\n0610 11:14:15.409496 (+    36us) cumulative_compaction.cpp:55] compaction finished\n0610 11:14:15.410138 (+   642us) cumulative_compaction.cpp:65] unused rowsets have been moved to GC queue\nMetrics: {\"filtered_rows\":0,\"input_row_num\":136707,\"input_rowsets_count\":302,\"input_rowsets_data_size\":76617836,\"input_segments_num\":302,\"merge_rowsets_latency_us\":7319372,\"merged_rows\":0,\"output_row_num\":136707,\"output_rowset_data_size\":53893280,\"output_segments_num\":1}\n```", "committedDate": "2020-06-11T07:49:49Z", "type": "forcePushed"}, {"oid": "601fe2e6b8234a8445b87777b46dfd7fd75c68a7", "url": "https://github.com/apache/incubator-doris/commit/601fe2e6b8234a8445b87777b46dfd7fd75c68a7", "message": "docs", "committedDate": "2020-06-11T16:27:24Z", "type": "commit"}, {"oid": "ffd7690b5701bea4a9ff57f040181719440e826f", "url": "https://github.com/apache/incubator-doris/commit/ffd7690b5701bea4a9ff57f040181719440e826f", "message": "fix", "committedDate": "2020-06-11T16:35:12Z", "type": "commit"}]}