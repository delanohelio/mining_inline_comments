{"pr_number": 3690, "pr_title": "[compaction] Update cumulative point calculate algorithm", "pr_createdAt": "2020-05-26T09:38:37Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3690", "timeline": [{"oid": "0046b4ad8cef9e26810ef15f9a9e574864f9141d", "url": "https://github.com/apache/incubator-doris/commit/0046b4ad8cef9e26810ef15f9a9e574864f9141d", "message": "[compaction] Update cumulative point calculate algorithm\n\nCurrent cumulative point calculate algorithm may skip sigleton version\nrowset when the rowset has only one segment and with NONOVERLAPPING flag.\nWhen a tablet is new created and cumulate many singleton version rowsets,\ncumulative point will be calculated as the max version + 1, and then\ncumulative compaction couldn't pick any rowsets and compaction failed, and\nwill lead the next base compaction on this tablet with all rowsets, which\ncan also cause memory consume problem, suppose there are thousands of rowsets.\n\nAll sigleton version rowsets must be newly wrote by delta writer and hasn't\ndo any compaction, we should place cumulative point before any of these rowsets.\nAnd also we should store cumulative point into tablet meta.", "committedDate": "2020-05-26T09:36:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU0Mzc3MQ==", "url": "https://github.com/apache/incubator-doris/pull/3690#discussion_r431543771", "bodyText": "cumulative point in tablet meta has non-sense.\nIf will cause another persistence for clone/compaction.\nSo it's removed from tablet meta when refactoring BE.\nYou can see it because of compatibility for the old code path.", "author": "chaoyli", "createdAt": "2020-05-28T02:13:12Z", "path": "be/src/olap/tablet.cpp", "diffHunk": "@@ -68,7 +68,7 @@ Tablet::Tablet(TabletMetaSharedPtr tablet_meta, DataDir* data_dir) :\n         _last_base_compaction_failure_millis(0),\n         _last_cumu_compaction_success_millis(0),\n         _last_base_compaction_success_millis(0),\n-        _cumulative_point(kInvalidCumulativePoint) {\n+        _cumulative_point(tablet_meta->cumulative_layer_point()) {", "originalCommit": "0046b4ad8cef9e26810ef15f9a9e574864f9141d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY1NDIwMg==", "url": "https://github.com/apache/incubator-doris/pull/3690#discussion_r431654202", "bodyText": "Reverted these changes.", "author": "acelyc111", "createdAt": "2020-05-28T08:05:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU0Mzc3MQ=="}], "type": "inlineReview"}, {"oid": "5957f36f953912bc04c855feb517ed0d037b70e2", "url": "https://github.com/apache/incubator-doris/commit/5957f36f953912bc04c855feb517ed0d037b70e2", "message": "not persistent cumulative point", "committedDate": "2020-05-28T08:04:00Z", "type": "commit"}]}