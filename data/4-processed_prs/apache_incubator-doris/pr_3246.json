{"pr_number": 3246, "pr_title": "[metrics] Add some metrics for container size in BE", "pr_createdAt": "2020-04-02T04:31:52Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3246", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjExNjE0Nw==", "url": "https://github.com/apache/incubator-doris/pull/3246#discussion_r402116147", "bodyText": "EtlJobMgr is deprecated, it will be removed in next version.\nSo you don't need to add metrics for it.", "author": "morningman", "createdAt": "2020-04-02T07:49:18Z", "path": "be/src/runtime/etl_job_mgr.cpp", "diffHunk": "@@ -62,6 +63,21 @@ const std::string ERROR_FILE_PREFIX = \"error_log\";\n \n EtlJobMgr::EtlJobMgr(ExecEnv* exec_env) :\n         _exec_env(exec_env), _success_jobs(5000), _failed_jobs(5000) {\n+    REGISTER_PRIVATE_VARIABLE_METRIC(running_etl_job_count);", "originalCommit": "7265e5187b40ad754e2e5017da192ec1c56d554c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjExNzU3Mg==", "url": "https://github.com/apache/incubator-doris/pull/3246#discussion_r402117572", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    boost::lock_guard<boost::mutex> l(_lock);\n          \n          \n            \n                    std::lock_guard<boost::mutex> l(_lock);", "author": "morningman", "createdAt": "2020-04-02T07:51:34Z", "path": "be/src/runtime/result_buffer_mgr.cpp", "diffHunk": "@@ -33,6 +34,11 @@ namespace doris {\n \n ResultBufferMgr::ResultBufferMgr()\n     : _is_stop(false) {\n+    REGISTER_PRIVATE_VARIABLE_METRIC(result_buffer_block_count);\n+    DorisMetrics::metrics()->register_hook(\"result_buffer_block_count\", [&]() {\n+        boost::lock_guard<boost::mutex> l(_lock);", "originalCommit": "7265e5187b40ad754e2e5017da192ec1c56d554c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c69697cb393c18dad0e721d5d6505035573eea8b", "url": "https://github.com/apache/incubator-doris/commit/c69697cb393c18dad0e721d5d6505035573eea8b", "message": "[metrics] Add some metrics for container size in BE\n\nWe can observe the workload of BE, and also it's a way to check\nwhether there is any problem in BE, like some container increase\nto large and lead to OOM.", "committedDate": "2020-04-03T09:03:45Z", "type": "forcePushed"}, {"oid": "33a199d4dab1abfaf8e0726d16f4055bfab03a90", "url": "https://github.com/apache/incubator-doris/commit/33a199d4dab1abfaf8e0726d16f4055bfab03a90", "message": "fix", "committedDate": "2020-04-05T02:37:01Z", "type": "forcePushed"}, {"oid": "6baf8039473f8e8f473b98c0b049a2d5e3bc4d7a", "url": "https://github.com/apache/incubator-doris/commit/6baf8039473f8e8f473b98c0b049a2d5e3bc4d7a", "message": "fix", "committedDate": "2020-04-09T15:03:43Z", "type": "forcePushed"}, {"oid": "15c03e188b5fdbad74ab52ba3d51e716c0810653", "url": "https://github.com/apache/incubator-doris/commit/15c03e188b5fdbad74ab52ba3d51e716c0810653", "message": "fix", "committedDate": "2020-04-10T07:22:41Z", "type": "forcePushed"}, {"oid": "46ef7ff3d8ff215399b81e7f1bf3ec8b05e9c445", "url": "https://github.com/apache/incubator-doris/commit/46ef7ff3d8ff215399b81e7f1bf3ec8b05e9c445", "message": "include", "committedDate": "2020-04-16T06:44:08Z", "type": "forcePushed"}, {"oid": "feef980bd14da163e47cf2088873d42ffac6dbe5", "url": "https://github.com/apache/incubator-doris/commit/feef980bd14da163e47cf2088873d42ffac6dbe5", "message": "[metrics] Add some metrics for container size in BE\n\nWe can observe the workload of BE, and also it's a way to check\nwhether there is any problem in BE, like some container increase\nto large and lead to OOM.", "committedDate": "2020-04-16T06:44:47Z", "type": "forcePushed"}, {"oid": "7b1dbf4cd62032d999c6c49fea3b1220f47be090", "url": "https://github.com/apache/incubator-doris/commit/7b1dbf4cd62032d999c6c49fea3b1220f47be090", "message": "[metrics] Add some metrics for container size in BE\n\nWe can observe the workload of BE, and also it's a way to check\nwhether there is any problem in BE, like some container increase\ntoo large and lead to OOM.\n\nThis patch add the following metrics:\nName                                   Description\nrowset_count_generated_and_in_use      The total count of rowset id generated and in use since BE last start\nunused_rowsets_count                   The total count of unused rowset waiting to be GC\nbroker_count                           The total count of brockers in management\ndata_stream_receiver_count             The total count of data stream receivers in management\nfragment_endpoint_count                The total count of fragment endpoints of data stream in management, should always equal to data_stream_receiver_count\nactive_scan_context_count              The total count of active scan contexts\nplan_fragment_count                    The total count of plan fragments in executing\nload_channel_count                     The total count of load channles in management\nresult_buffer_block_count              The total count of result buffer blocks for queries, each block has a limited queue size (default 1024)\nresult_block_queue_count               The total count of queues for fragments, each queue has a limited size (default 20, by config::max_memory_sink_batch_count)\nroutine_load_task_count                The total count of routine load tasks in executing\nsmall_file_cache_count                 The total count of cached small files' digest info\nstream_load_pipe_count                 The total count of stream load pipes, each pipe has a limited buffer size (default 1M)\ntablet_writer_count                    The total count of tablet writers\nbrpc_endpoint_stub_count               The total count of brpc endpoints", "committedDate": "2020-04-16T06:51:59Z", "type": "forcePushed"}, {"oid": "de836b6db87c79ab98a45a9cdce0d5beffb40cc3", "url": "https://github.com/apache/incubator-doris/commit/de836b6db87c79ab98a45a9cdce0d5beffb40cc3", "message": "[metrics] Add some metrics for container size in BE\n\nWe can observe the workload of BE, and also it's a way to check\nwhether there is any problem in BE, like some container increase\ntoo large and lead to OOM.\n\nThis patch add the following metrics:\nName                                   Description\nrowset_count_generated_and_in_use      The total count of rowset id generated and in use since BE last start\nunused_rowsets_count                   The total count of unused rowset waiting to be GC\nbroker_count                           The total count of brockers in management\ndata_stream_receiver_count             The total count of data stream receivers in management\nfragment_endpoint_count                The total count of fragment endpoints of data stream in management, should always equal to data_stream_receiver_count\nactive_scan_context_count              The total count of active scan contexts\nplan_fragment_count                    The total count of plan fragments in executing\nload_channel_count                     The total count of load channles in management\nresult_buffer_block_count              The total count of result buffer blocks for queries, each block has a limited queue size (default 1024)\nresult_block_queue_count               The total count of queues for fragments, each queue has a limited size (default 20, by config::max_memory_sink_batch_count)\nroutine_load_task_count                The total count of routine load tasks in executing\nsmall_file_cache_count                 The total count of cached small files' digest info\nstream_load_pipe_count                 The total count of stream load pipes, each pipe has a limited buffer size (default 1M)\ntablet_writer_count                    The total count of tablet writers\nbrpc_endpoint_stub_count               The total count of brpc endpoints", "committedDate": "2020-04-22T15:18:00Z", "type": "commit"}, {"oid": "15fde8067cd299834ac5203ccc61c2709376170b", "url": "https://github.com/apache/incubator-doris/commit/15fde8067cd299834ac5203ccc61c2709376170b", "message": "fix", "committedDate": "2020-04-22T15:18:00Z", "type": "commit"}, {"oid": "6ea79f27de92afab6f79bb863b11c5b85bf1d030", "url": "https://github.com/apache/incubator-doris/commit/6ea79f27de92afab6f79bb863b11c5b85bf1d030", "message": "fix", "committedDate": "2020-04-22T15:31:54Z", "type": "forcePushed"}, {"oid": "66343051e6bd958609703f765b1804aefb14f809", "url": "https://github.com/apache/incubator-doris/commit/66343051e6bd958609703f765b1804aefb14f809", "message": "fix", "committedDate": "2020-04-22T15:53:48Z", "type": "commit"}, {"oid": "66343051e6bd958609703f765b1804aefb14f809", "url": "https://github.com/apache/incubator-doris/commit/66343051e6bd958609703f765b1804aefb14f809", "message": "fix", "committedDate": "2020-04-22T15:53:48Z", "type": "forcePushed"}]}