{"pr_number": 4925, "pr_title": "[Refactor] Refactor DeleteHandler and Cond module", "pr_createdAt": "2020-11-19T06:17:33Z", "pr_url": "https://github.com/apache/incubator-doris/pull/4925", "timeline": [{"oid": "edd1ef52a4f312193c1007ed35944d908e73c71c", "url": "https://github.com/apache/incubator-doris/commit/edd1ef52a4f312193c1007ed35944d908e73c71c", "message": "[Refactor] Refactor DeleteHandler and Cond module", "committedDate": "2020-11-19T06:19:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODE5OTUyNA==", "url": "https://github.com/apache/incubator-doris/pull/4925#discussion_r528199524", "bodyText": "I think we can translate it to English this time", "author": "morningman", "createdAt": "2020-11-21T13:58:52Z", "path": "be/src/olap/delete_handler.cpp", "diffHunk": "@@ -162,27 +165,23 @@ OLAPStatus DeleteConditionHandler::check_condition_valid(\n \n     // \u68c0\u67e5\u6307\u5b9a\u7684\u5217\u662f\u4e0d\u662fkey\uff0c\u662f\u4e0d\u662ffloat\u6216double\u7c7b\u578b\n     const TabletColumn& column = schema.column(field_index);\n-\n     if ((!column.is_key() && schema.keys_type() != KeysType::DUP_KEYS)\n             || column.type() == OLAP_FIELD_TYPE_DOUBLE\n             || column.type() == OLAP_FIELD_TYPE_FLOAT) {\n         LOG(WARNING) << \"field is not key column, or storage model is not duplicate, or data type is float or double.\";\n         return OLAP_ERR_DELETE_INVALID_CONDITION;\n     }\n \n-    // \u68c0\u67e5\u5220\u9664\u6761\u4ef6\u4e2d\u6307\u5b9a\u7684\u8fc7\u6ee4\u503c\u662f\u5426\u7b26\u5408\u6bcf\u4e2a\u7c7b\u578b\u81ea\u8eab\u7684\u8981\u6c42\n-    // 1. \u5bf9\u4e8e\u6574\u6570\u7c7b\u578b(int8,int16,in32,int64,uint8,uint16,uint32,uint64)\uff0c\u68c0\u67e5\u662f\u5426\u6ea2\u51fa\n-    // 2. \u5bf9\u4e8edecimal\u7c7b\u578b\uff0c\u68c0\u67e5\u662f\u5426\u8d85\u8fc7\u5efa\u8868\u65f6\u6307\u5b9a\u7684\u7cbe\u5ea6\u548c\u6807\u5ea6\n-    // 3. \u5bf9\u4e8edate\u548cdatetime\u7c7b\u578b\uff0c\u68c0\u67e5\u6307\u5b9a\u7684\u8fc7\u6ee4\u503c\u662f\u5426\u7b26\u5408\u65e5\u671f\u683c\u5f0f\u4ee5\u53ca\u662f\u5426\u6307\u5b9a\u9519\u8bef\u7684\u503c\n-    // 4. \u5bf9\u4e8estring\u548cvarchar\u7c7b\u578b\uff0c\u68c0\u67e5\u6307\u5b9a\u7684\u8fc7\u6ee4\u503c\u662f\u5426\u8d85\u8fc7\u5efa\u8868\u65f6\u6307\u5b9a\u7684\u957f\u5ea6\n+    // \u68c0\u67e5'op'\u4e0e'operands'\u6570\u662f\u5426\u5408\u6cd5", "originalCommit": "edd1ef52a4f312193c1007ed35944d908e73c71c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODIwMTUwMg==", "url": "https://github.com/apache/incubator-doris/pull/4925#discussion_r528201502", "bodyText": "I think DEL_NOT_SATISFIED is more safe. Or you'd better change DCHECK to CHECK", "author": "morningman", "createdAt": "2020-11-21T14:20:32Z", "path": "be/src/olap/olap_cond.cpp", "diffHunk": "@@ -382,28 +386,30 @@ int Cond::del_eval(const std::pair<WrapperField*, WrapperField*>& stat) const {\n             } else if (stat.first->is_null() && !stat.second->is_null()) {\n                 ret = DEL_PARTIAL_SATISFIED;\n             } else {\n+                DCHECK(false);\n                 //\u4e0d\u4f1a\u51fa\u73b0min\u4e0d\u4e3aNULL\uff0cmax\u4e3aNULL\n-                ret = DEL_NOT_SATISFIED;\n+                ret = DEL_SATISFIED;", "originalCommit": "edd1ef52a4f312193c1007ed35944d908e73c71c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODIwMTU3MA==", "url": "https://github.com/apache/incubator-doris/pull/4925#discussion_r528201570", "bodyText": "Change to CHECK, or ret = DEL_NOT_SATISFIED", "author": "morningman", "createdAt": "2020-11-21T14:20:59Z", "path": "be/src/olap/olap_cond.cpp", "diffHunk": "@@ -382,28 +386,30 @@ int Cond::del_eval(const std::pair<WrapperField*, WrapperField*>& stat) const {\n             } else if (stat.first->is_null() && !stat.second->is_null()) {\n                 ret = DEL_PARTIAL_SATISFIED;\n             } else {\n+                DCHECK(false);\n                 //\u4e0d\u4f1a\u51fa\u73b0min\u4e0d\u4e3aNULL\uff0cmax\u4e3aNULL\n-                ret = DEL_NOT_SATISFIED;\n+                ret = DEL_SATISFIED;\n             }\n         } else {\n             if (stat.first->is_null() && stat.second->is_null()) {\n                 ret = DEL_NOT_SATISFIED;\n             } else if (stat.first->is_null() && !stat.second->is_null()) {\n                 ret = DEL_PARTIAL_SATISFIED;\n             } else {\n+                DCHECK(false);", "originalCommit": "edd1ef52a4f312193c1007ed35944d908e73c71c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODIwMjAwNQ==", "url": "https://github.com/apache/incubator-doris/pull/4925#discussion_r528202005", "bodyText": "Why using DCHECK here?", "author": "morningman", "createdAt": "2020-11-21T14:25:42Z", "path": "be/src/olap/reader.cpp", "diffHunk": "@@ -599,13 +599,12 @@ OLAPStatus Reader::_init_params(const ReaderParams& read_params) {\n \n     if (_tablet->tablet_schema().has_sequence_col()) {\n         _sequence_col_idx = _tablet->tablet_schema().sequence_col_idx();\n-        if (_sequence_col_idx != -1) {\n-            for (auto col : _return_columns) {\n-                // query has sequence col\n-                if (col == _sequence_col_idx) {\n-                    _has_sequence_col = true;\n-                    break;\n-                }\n+        DCHECK_NE(_sequence_col_idx, -1);", "originalCommit": "edd1ef52a4f312193c1007ed35944d908e73c71c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI5MDk3NQ==", "url": "https://github.com/apache/incubator-doris/pull/4925#discussion_r528290975", "bodyText": "@morningman Because has_sequence_col()  in line 600 is inline bool has_sequence_col() const { return  _sequence_col_idx != -1; }, so _sequence_col_idx shoule always be -1 here.", "author": "acelyc111", "createdAt": "2020-11-22T06:41:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODIwMjAwNQ=="}], "type": "inlineReview"}, {"oid": "40cf1bde3c057ca185a4b97d3298d31453d40e52", "url": "https://github.com/apache/incubator-doris/commit/40cf1bde3c057ca185a4b97d3298d31453d40e52", "message": "translate comments and use CHECK", "committedDate": "2020-11-27T05:16:58Z", "type": "forcePushed"}, {"oid": "92d9d636d54ddcf7b470931ce12006d7cc1d87dd", "url": "https://github.com/apache/incubator-doris/commit/92d9d636d54ddcf7b470931ce12006d7cc1d87dd", "message": "[Refactor] Refactor DeleteHandler and Cond module", "committedDate": "2020-11-30T02:37:04Z", "type": "forcePushed"}, {"oid": "963f6ca0bb6d5b2384d9ba88230304254ecd99d2", "url": "https://github.com/apache/incubator-doris/commit/963f6ca0bb6d5b2384d9ba88230304254ecd99d2", "message": "[Refactor] Refactor DeleteHandler and Cond module", "committedDate": "2020-11-30T02:56:29Z", "type": "forcePushed"}, {"oid": "780999ed2a6c6d1c82582a2791b5f8b8f282af0d", "url": "https://github.com/apache/incubator-doris/commit/780999ed2a6c6d1c82582a2791b5f8b8f282af0d", "message": "[Refactor] Refactor DeleteHandler and Cond module", "committedDate": "2020-11-30T03:52:33Z", "type": "forcePushed"}, {"oid": "e6547a1ce85e34ce9f46ad456f055a9f7be79b68", "url": "https://github.com/apache/incubator-doris/commit/e6547a1ce85e34ce9f46ad456f055a9f7be79b68", "message": "[Refactor] Refactor DeleteHandler and Cond module", "committedDate": "2020-12-01T15:48:10Z", "type": "forcePushed"}, {"oid": "352b777e7fa1c3949bf2f736547bb8e0312105f3", "url": "https://github.com/apache/incubator-doris/commit/352b777e7fa1c3949bf2f736547bb8e0312105f3", "message": "[Refactor] Refactor DeleteHandler and Cond module", "committedDate": "2020-12-01T15:59:51Z", "type": "forcePushed"}, {"oid": "8e9656a002446f3ab93ba7e8821ca0c581bc13e9", "url": "https://github.com/apache/incubator-doris/commit/8e9656a002446f3ab93ba7e8821ca0c581bc13e9", "message": "[Refactor] Refactor DeleteHandler and Cond module", "committedDate": "2020-12-01T16:08:38Z", "type": "forcePushed"}, {"oid": "5f48dba873f5c27d3c5880971394b44c7ff0aa05", "url": "https://github.com/apache/incubator-doris/commit/5f48dba873f5c27d3c5880971394b44c7ff0aa05", "message": "[Refactor] Refactor DeleteHandler and Cond module", "committedDate": "2020-12-04T04:07:27Z", "type": "commit"}, {"oid": "5f48dba873f5c27d3c5880971394b44c7ff0aa05", "url": "https://github.com/apache/incubator-doris/commit/5f48dba873f5c27d3c5880971394b44c7ff0aa05", "message": "[Refactor] Refactor DeleteHandler and Cond module", "committedDate": "2020-12-04T04:07:27Z", "type": "forcePushed"}]}