{"pr_number": 3436, "pr_title": "Fix the error result when assert num rows node is used", "pr_createdAt": "2020-04-29T12:54:12Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3436", "timeline": [{"oid": "b4ee27d308c75e0297022ed84a78f28818461dce", "url": "https://github.com/apache/incubator-doris/commit/b4ee27d308c75e0297022ed84a78f28818461dce", "message": "Fix the error result when assert num rows node is used\n\nThe child.open() function is not called before this commit.\nIf the assert num rows node has child which process data in open function, the assert num rows node will fetch no data from child.\nSo the result will be empty(incorrect).\n\nThis error only appear in inner subquery which has a aggregation function.\nFor example, select * from table where k1=(select k1 from (select avg(k1) from table) a);\nThe first level of subquery returns a non-scalar value, so the assert num rows node is needed.\nThe second level of subquery has a aggregation function, so the child of assert node is aggregate node.\nHowever, if the open stage of the aggregate node is not called, the get next state of aggregate node will return empty set.\nSo the result is wrong.\nFixed #3435.\n\nFix the error of tpcds 14.\n\nChange-Id: I3cc9eff3eb925404102cfe78ed73b7ea97cfae63", "committedDate": "2020-04-29T12:55:35Z", "type": "commit"}, {"oid": "b4ee27d308c75e0297022ed84a78f28818461dce", "url": "https://github.com/apache/incubator-doris/commit/b4ee27d308c75e0297022ed84a78f28818461dce", "message": "Fix the error result when assert num rows node is used\n\nThe child.open() function is not called before this commit.\nIf the assert num rows node has child which process data in open function, the assert num rows node will fetch no data from child.\nSo the result will be empty(incorrect).\n\nThis error only appear in inner subquery which has a aggregation function.\nFor example, select * from table where k1=(select k1 from (select avg(k1) from table) a);\nThe first level of subquery returns a non-scalar value, so the assert num rows node is needed.\nThe second level of subquery has a aggregation function, so the child of assert node is aggregate node.\nHowever, if the open stage of the aggregate node is not called, the get next state of aggregate node will return empty set.\nSo the result is wrong.\nFixed #3435.\n\nFix the error of tpcds 14.\n\nChange-Id: I3cc9eff3eb925404102cfe78ed73b7ea97cfae63", "committedDate": "2020-04-29T12:55:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM3NzI4NQ==", "url": "https://github.com/apache/incubator-doris/pull/3436#discussion_r417377285", "bodyText": "Would better add a comment or this issue link to let other people know why and when to call child(0)->open method. Thanks.", "author": "kangkaisen", "createdAt": "2020-04-29T14:50:49Z", "path": "be/src/exec/assert_num_rows_node.cpp", "diffHunk": "@@ -45,6 +45,7 @@ Status AssertNumRowsNode::prepare(RuntimeState* state) {\n Status AssertNumRowsNode::open(RuntimeState* state) {\n     SCOPED_TIMER(_runtime_profile->total_time_counter());\n     RETURN_IF_ERROR(ExecNode::open(state));\n+    RETURN_IF_ERROR(child(0)->open(state));", "originalCommit": "b4ee27d308c75e0297022ed84a78f28818461dce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzczMTUwOA==", "url": "https://github.com/apache/incubator-doris/pull/3436#discussion_r417731508", "bodyText": "Added. Actually, I think most of expr node should call the child.open in open function. This is my mistake.", "author": "EmmyMiao87", "createdAt": "2020-04-30T03:20:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM3NzI4NQ=="}], "type": "inlineReview"}, {"oid": "667c71a40ee06834e2e3c8435690dda67d141dad", "url": "https://github.com/apache/incubator-doris/commit/667c71a40ee06834e2e3c8435690dda67d141dad", "message": "Add issue link in comment\n\nChange-Id: Id5665d1e92243bf92467890274f786016cdfbdb8", "committedDate": "2020-04-30T03:17:46Z", "type": "commit"}]}