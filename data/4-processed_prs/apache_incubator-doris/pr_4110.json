{"pr_number": 4110, "pr_title": "[Feature][ThreadPool]Add Web Page to display thread's stats", "pr_createdAt": "2020-07-17T03:33:52Z", "pr_url": "https://github.com/apache/incubator-doris/pull/4110", "timeline": [{"oid": "dd950c3f2abfaf83461f0fc235cb9c386c256a76", "url": "https://github.com/apache/incubator-doris/commit/dd950c3f2abfaf83461f0fc235cb9c386c256a76", "message": "[Feature][ThreadPool]Add Web Page to display thread's stats\n\nThis CL mainly includes:\n- add some methods to get thread's stats from Linux's system file in\nenv.\n- support get thread's stats by http method.\n- register page handle in BE to show thread's stats to help developer\nposition some thread relate problem.", "committedDate": "2020-07-17T03:07:15Z", "type": "commit"}, {"oid": "46b415c02284d134683c17c34dc7aca8d4efab99", "url": "https://github.com/apache/incubator-doris/commit/46b415c02284d134683c17c34dc7aca8d4efab99", "message": "format relate code", "committedDate": "2020-07-17T03:54:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzAxNzA5NQ==", "url": "https://github.com/apache/incubator-doris/pull/4110#discussion_r457017095", "bodyText": "I didn't see you use it, is it needed?", "author": "acelyc111", "createdAt": "2020-07-20T03:36:00Z", "path": "be/src/http/default_path_handlers.h", "diffHunk": "@@ -20,6 +20,8 @@\n \n #include <stdio.h>\n \n+#include \"util/thread.h\"", "originalCommit": "46b415c02284d134683c17c34dc7aca8d4efab99", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIyMDA2NA==", "url": "https://github.com/apache/incubator-doris/pull/4110#discussion_r457220064", "bodyText": "I remove it to .cpp file", "author": "WingsGo", "createdAt": "2020-07-20T09:31:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzAxNzA5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzAxODc2Mw==", "url": "https://github.com/apache/incubator-doris/pull/4110#discussion_r457018763", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        \"/threadz\", \"Threadz\",\n          \n          \n            \n                        \"/threadz\", \"Threads\",", "author": "acelyc111", "createdAt": "2020-07-20T03:40:40Z", "path": "be/src/util/thread.cpp", "diffHunk": "@@ -397,8 +477,15 @@ Status ThreadJoiner::join() {\n         }\n         waited_ms += wait_for;\n     }\n-    return Status::Aborted(strings::Substitute(\"Timed out after $0ms joining on $1\",\n-                                               waited_ms, _thread->_name));\n+    return Status::Aborted(\n+            strings::Substitute(\"Timed out after $0ms joining on $1\", waited_ms, _thread->_name));\n }\n \n+void start_thread_instrumentation(WebPageHandler* web_page_handler) {\n+    web_page_handler->register_template_page(\n+            \"/threadz\", \"Threadz\",", "originalCommit": "46b415c02284d134683c17c34dc7aca8d4efab99", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzAyMDkwMA==", "url": "https://github.com/apache/incubator-doris/pull/4110#discussion_r457020900", "bodyText": "I think we'd better call this function a xxx_handler, it's a callback of a http request.", "author": "acelyc111", "createdAt": "2020-07-20T03:46:34Z", "path": "be/src/util/thread.cpp", "diffHunk": "@@ -74,18 +78,17 @@ class ThreadMgr {\n     // already been removed, this is a no-op.\n     void remove_thread(const pthread_t& pthread_id, const std::string& category);\n \n-private:\n+    void start_instrumentation(const WebPageHandler::ArgumentMap& args, EasyJson* ej) const;", "originalCommit": "46b415c02284d134683c17c34dc7aca8d4efab99", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIxOTY4MQ==", "url": "https://github.com/apache/incubator-doris/pull/4110#discussion_r457219681", "bodyText": "done", "author": "WingsGo", "createdAt": "2020-07-20T09:30:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzAyMDkwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzAyMjUwMQ==", "url": "https://github.com/apache/incubator-doris/pull/4110#discussion_r457022501", "bodyText": "If category is not found, we will also output normally?", "author": "acelyc111", "createdAt": "2020-07-20T03:50:32Z", "path": "be/src/util/thread.cpp", "diffHunk": "@@ -169,6 +174,81 @@ void ThreadMgr::remove_thread(const pthread_t& pthread_id, const std::string& ca\n     ANNOTATE_IGNORE_READS_AND_WRITES_END();\n }\n \n+void ThreadMgr::start_instrumentation(const WebPageHandler::ArgumentMap& args, EasyJson* ej) const {\n+    const auto* category_name = FindOrNull(args, \"group\");\n+    if (category_name) {\n+        bool requested_all = (*category_name == \"all\");\n+        ej->Set(\"requested_thread_group\", EasyJson::kObject);\n+        (*ej)[\"group_name\"] = escape_for_html_to_string(*category_name);\n+        (*ej)[\"requested_all\"] = requested_all;\n+\n+        // The critical section is as short as possible so as to minimize the delay\n+        // imposed on new threads that acquire the lock in write mode.\n+        vector<ThreadDescriptor> descriptors_to_print;\n+        if (!requested_all) {\n+            MutexLock l(&_lock);\n+            const auto* category = FindOrNull(_thread_categories, *category_name);\n+            if (category) {\n+                for (const auto& elem : *category) {\n+                    descriptors_to_print.emplace_back(elem.second);\n+                }\n+            }\n+        } else {\n+            MutexLock l(&_lock);\n+            for (const auto& category : _thread_categories) {\n+                for (const auto& elem : category.second) {\n+                    descriptors_to_print.emplace_back(elem.second);\n+                }\n+            }\n+        }\n+\n+        EasyJson found = (*ej).Set(\"found\", EasyJson::kObject);", "originalCommit": "46b415c02284d134683c17c34dc7aca8d4efab99", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIyMzU1Nw==", "url": "https://github.com/apache/incubator-doris/pull/4110#discussion_r457223557", "bodyText": "I changed it, if category is not found, we will not show it", "author": "WingsGo", "createdAt": "2020-07-20T09:35:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzAyMjUwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzAyMjkwMg==", "url": "https://github.com/apache/incubator-doris/pull/4110#discussion_r457022902", "bodyText": "This may cause too many useless logs.", "author": "acelyc111", "createdAt": "2020-07-20T03:51:33Z", "path": "be/src/util/thread.cpp", "diffHunk": "@@ -169,6 +174,81 @@ void ThreadMgr::remove_thread(const pthread_t& pthread_id, const std::string& ca\n     ANNOTATE_IGNORE_READS_AND_WRITES_END();\n }\n \n+void ThreadMgr::start_instrumentation(const WebPageHandler::ArgumentMap& args, EasyJson* ej) const {\n+    const auto* category_name = FindOrNull(args, \"group\");\n+    if (category_name) {\n+        bool requested_all = (*category_name == \"all\");\n+        ej->Set(\"requested_thread_group\", EasyJson::kObject);\n+        (*ej)[\"group_name\"] = escape_for_html_to_string(*category_name);\n+        (*ej)[\"requested_all\"] = requested_all;\n+\n+        // The critical section is as short as possible so as to minimize the delay\n+        // imposed on new threads that acquire the lock in write mode.\n+        vector<ThreadDescriptor> descriptors_to_print;\n+        if (!requested_all) {\n+            MutexLock l(&_lock);\n+            const auto* category = FindOrNull(_thread_categories, *category_name);\n+            if (category) {\n+                for (const auto& elem : *category) {\n+                    descriptors_to_print.emplace_back(elem.second);\n+                }\n+            }\n+        } else {\n+            MutexLock l(&_lock);\n+            for (const auto& category : _thread_categories) {\n+                for (const auto& elem : category.second) {\n+                    descriptors_to_print.emplace_back(elem.second);\n+                }\n+            }\n+        }\n+\n+        EasyJson found = (*ej).Set(\"found\", EasyJson::kObject);\n+        EasyJson threads = found.Set(\"threads\", EasyJson::kArray);\n+        for (const auto& desc : descriptors_to_print) {\n+            summarize_thread_descriptor(desc, &threads);\n+        }\n+    } else {\n+        // List all thread groups and the number of threads running in each.\n+        vector<pair<string, uint64_t>> thread_categories_info;\n+        uint64_t running;\n+        {\n+            MutexLock l(&_lock);\n+            running = _threads_running_metric;\n+            thread_categories_info.reserve(_thread_categories.size());\n+            for (const auto& category : _thread_categories) {\n+                thread_categories_info.emplace_back(category.first, category.second.size());\n+            }\n+\n+            (*ej)[\"total_threads_running\"] = running;\n+            EasyJson groups = ej->Set(\"groups\", EasyJson::kArray);\n+            for (const auto& elem : thread_categories_info) {\n+                string category_arg;\n+                url_encode(elem.first, &category_arg);\n+                LOG(INFO) << \"encode url path: \" << category_arg;", "originalCommit": "46b415c02284d134683c17c34dc7aca8d4efab99", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIyMTMwNA==", "url": "https://github.com/apache/incubator-doris/pull/4110#discussion_r457221304", "bodyText": "ok, I removed it.", "author": "WingsGo", "createdAt": "2020-07-20T09:32:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzAyMjkwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzAyNTkxMQ==", "url": "https://github.com/apache/incubator-doris/pull/4110#discussion_r457025911", "bodyText": "IMO, format files which are copied from other projects is not a good idea, because when we want to sync code from source project which have fixed some bugs or add some new features, there will be much diff and conflicts to resolve.", "author": "acelyc111", "createdAt": "2020-07-20T03:58:53Z", "path": "be/src/util/url_coding.cpp", "diffHunk": "@@ -122,59 +122,47 @@ static void encode_base64_internal(const std::string& in, std::string* out,\n     out->assign((char*)buf.get(), d - buf.get());\n }\n \n-void base64url_encode(const std::string& in, std::string *out) {\n+void base64url_encode(const std::string& in, std::string* out) {\n     static unsigned char basis64[] =\n             \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_\";\n     encode_base64_internal(in, out, basis64, false);\n }\n \n void base64_encode(const std::string& in, std::string* out) {\n     static unsigned char basis64[] =\n-        \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/\";\n+            \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/\";\n     encode_base64_internal(in, out, basis64, true);\n }\n \n-static char encoding_table[] = {\n-    'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H',\n-    'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P',\n-    'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X',\n-    'Y', 'Z', 'a', 'b', 'c', 'd', 'e', 'f',\n-    'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n',\n-    'o', 'p', 'q', 'r', 's', 't', 'u', 'v',\n-    'w', 'x', 'y', 'z', '0', '1', '2', '3',\n-    '4', '5', '6', '7', '8', '9', '+', '/'\n-};\n+static char encoding_table[] = {'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M',", "originalCommit": "46b415c02284d134683c17c34dc7aca8d4efab99", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIyNTI4Ng==", "url": "https://github.com/apache/incubator-doris/pull/4110#discussion_r457225286", "bodyText": "If there is some diff, maybe it is the resposibility for author who copied the file to fix it, Even if the code is formated, we can found the code that should modified.I think unify the codestyle in one project maybe more important.", "author": "WingsGo", "createdAt": "2020-07-20T09:37:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzAyNTkxMQ=="}], "type": "inlineReview"}, {"oid": "0690918c7edc3d04c6d60acec5ec60db9f6b99e1", "url": "https://github.com/apache/incubator-doris/commit/0690918c7edc3d04c6d60acec5ec60db9f6b99e1", "message": "fix by review", "committedDate": "2020-07-20T12:52:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgwMzc0OA==", "url": "https://github.com/apache/incubator-doris/pull/4110#discussion_r457803748", "bodyText": "I think every line for every enum type is better to read.", "author": "chaoyli", "createdAt": "2020-07-21T02:46:40Z", "path": "be/src/env/env.h", "diffHunk": "@@ -35,15 +35,10 @@ class Env {\n     // CREATE_OR_OPEN               | opens             | creates\n     // MUST_CREATE                  | fails             | creates\n     // MUST_EXIST                   | opens             | fails\n-    enum OpenMode {\n-        CREATE_OR_OPEN_WITH_TRUNCATE,\n-        CREATE_OR_OPEN,\n-        MUST_CREATE,\n-        MUST_EXIST\n-    };\n+    enum OpenMode { CREATE_OR_OPEN_WITH_TRUNCATE, CREATE_OR_OPEN, MUST_CREATE, MUST_EXIST };", "originalCommit": "0690918c7edc3d04c6d60acec5ec60db9f6b99e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgyMTk5MQ==", "url": "https://github.com/apache/incubator-doris/pull/4110#discussion_r457821991", "bodyText": "done", "author": "WingsGo", "createdAt": "2020-07-21T03:59:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgwMzc0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgwMzkwNg==", "url": "https://github.com/apache/incubator-doris/pull/4110#discussion_r457803906", "bodyText": "I think every line for every enum type is better to read.", "author": "chaoyli", "createdAt": "2020-07-21T02:47:11Z", "path": "be/src/env/env.h", "diffHunk": "@@ -271,13 +260,10 @@ class RandomAccessFile {\n // one of Append or PositionedAppend. We support only Append here.\n class WritableFile {\n public:\n-    enum FlushMode {\n-        FLUSH_SYNC,\n-        FLUSH_ASYNC\n-    };\n+    enum FlushMode { FLUSH_SYNC, FLUSH_ASYNC };", "originalCommit": "0690918c7edc3d04c6d60acec5ec60db9f6b99e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgwNzQ0NQ==", "url": "https://github.com/apache/incubator-doris/pull/4110#discussion_r457807445", "bodyText": "extern here seems useless can can be removed.", "author": "chaoyli", "createdAt": "2020-07-21T03:01:36Z", "path": "be/src/env/env_util.h", "diffHunk": "@@ -30,14 +31,21 @@ struct WritableFileOptions;\n \n namespace env_util {\n \n-Status open_file_for_write(Env *env, const std::string& path, std::shared_ptr<WritableFile> *file);\n+Status open_file_for_write(Env* env, const std::string& path, std::shared_ptr<WritableFile>* file);\n \n-Status open_file_for_write(const WritableFileOptions& opts, Env *env,\n-                           const std::string& path, std::shared_ptr<WritableFile> *file);\n+Status open_file_for_write(const WritableFileOptions& opts, Env* env, const std::string& path,\n+                           std::shared_ptr<WritableFile>* file);\n \n-Status open_file_for_random(Env *env, const std::string& path,\n-                            std::shared_ptr<RandomAccessFile> *file);\n+Status open_file_for_random(Env* env, const std::string& path,\n+                            std::shared_ptr<RandomAccessFile>* file);\n+\n+// A utility routine: write \"data\" to the named file.\n+extern Status write_string_to_file(Env* env, const Slice& data, const std::string& fname);\n+// Like above but also fsyncs the new file.\n+extern Status write_string_to_file_sync(Env* env, const Slice& data, const std::string& fname);", "originalCommit": "0690918c7edc3d04c6d60acec5ec60db9f6b99e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgyMTk0MQ==", "url": "https://github.com/apache/incubator-doris/pull/4110#discussion_r457821941", "bodyText": "done", "author": "WingsGo", "createdAt": "2020-07-21T03:59:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgwNzQ0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgwOTM3OQ==", "url": "https://github.com/apache/incubator-doris/pull/4110#discussion_r457809379", "bodyText": "EasyJson is not imported ?", "author": "chaoyli", "createdAt": "2020-07-21T03:09:32Z", "path": "be/src/util/thread.cpp", "diffHunk": "@@ -74,18 +78,17 @@ class ThreadMgr {\n     // already been removed, this is a no-op.\n     void remove_thread(const pthread_t& pthread_id, const std::string& category);\n \n-private:\n+    void display_thread_callback(const WebPageHandler::ArgumentMap& args, EasyJson* ej) const;", "originalCommit": "0690918c7edc3d04c6d60acec5ec60db9f6b99e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgyMTkyMg==", "url": "https://github.com/apache/incubator-doris/pull/4110#discussion_r457821922", "bodyText": "easy_json is imported in line 38.", "author": "WingsGo", "createdAt": "2020-07-21T03:59:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgwOTM3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgwOTgxOA==", "url": "https://github.com/apache/incubator-doris/pull/4110#discussion_r457809818", "bodyText": "If we can use std::bind for the same purpose, It's better to replace it using C++ standard library.", "author": "chaoyli", "createdAt": "2020-07-21T03:11:02Z", "path": "be/src/util/thread.cpp", "diffHunk": "@@ -397,8 +477,15 @@ Status ThreadJoiner::join() {\n         }\n         waited_ms += wait_for;\n     }\n-    return Status::Aborted(strings::Substitute(\"Timed out after $0ms joining on $1\",\n-                                               waited_ms, _thread->_name));\n+    return Status::Aborted(\n+            strings::Substitute(\"Timed out after $0ms joining on $1\", waited_ms, _thread->_name));\n }\n \n+void register_thread_display_page(WebPageHandler* web_page_handler) {\n+    web_page_handler->register_template_page(\n+            \"/threadz\", \"Threads\",\n+            boost::bind(&ThreadMgr::display_thread_callback, thread_manager.get(),", "originalCommit": "0690918c7edc3d04c6d60acec5ec60db9f6b99e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgyOTk1Ng==", "url": "https://github.com/apache/incubator-doris/pull/4110#discussion_r457829956", "bodyText": "ok", "author": "WingsGo", "createdAt": "2020-07-21T04:32:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgwOTgxOA=="}], "type": "inlineReview"}, {"oid": "3b58aa0308c328242ddf9b0c3dc8aa77b041ecba", "url": "https://github.com/apache/incubator-doris/commit/3b58aa0308c328242ddf9b0c3dc8aa77b041ecba", "message": "fix by review", "committedDate": "2020-07-21T04:11:13Z", "type": "commit"}, {"oid": "bb6373c4a51676775dd6050205bf554deb71b097", "url": "https://github.com/apache/incubator-doris/commit/bb6373c4a51676775dd6050205bf554deb71b097", "message": "fix compile", "committedDate": "2020-07-21T04:31:42Z", "type": "commit"}]}