{"pr_number": 4515, "pr_title": "[Feature] Support cancel load jobs in batch", "pr_createdAt": "2020-09-02T07:03:41Z", "pr_url": "https://github.com/apache/incubator-doris/pull/4515", "timeline": [{"oid": "2967f5b1d791ce381ba8ad8473ca4d7d9862b9d5", "url": "https://github.com/apache/incubator-doris/commit/2967f5b1d791ce381ba8ad8473ca4d7d9862b9d5", "message": "save code", "committedDate": "2020-09-02T03:36:00Z", "type": "commit"}, {"oid": "1f9ac135e67826ea324aa1acbb390f6b637ceaa5", "url": "https://github.com/apache/incubator-doris/commit/1f9ac135e67826ea324aa1acbb390f6b637ceaa5", "message": "save code", "committedDate": "2020-09-02T06:05:14Z", "type": "commit"}, {"oid": "fd1e6a2809423ed0e372d862790786e76091aebf", "url": "https://github.com/apache/incubator-doris/commit/fd1e6a2809423ed0e372d862790786e76091aebf", "message": "add ut", "committedDate": "2020-09-02T07:00:38Z", "type": "commit"}, {"oid": "655c006cf32541fbc8bc4d22cbcd8ab43d0e0d6f", "url": "https://github.com/apache/incubator-doris/commit/655c006cf32541fbc8bc4d22cbcd8ab43d0e0d6f", "message": "fix", "committedDate": "2020-09-02T07:15:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzUyNDYzNg==", "url": "https://github.com/apache/incubator-doris/pull/4515#discussion_r487524636", "bodyText": "We should not rely on \"the last one is running\", better filter it by state.\nSo that we can unify the logic just same as batch cancel.", "author": "morningman", "createdAt": "2020-09-13T12:38:36Z", "path": "fe/fe-core/src/main/java/org/apache/doris/load/Load.java", "diffHunk": "@@ -1570,6 +1581,105 @@ public boolean isLabelExist(String dbName, String label) throws DdlException {\n         }\n     }\n \n+    public boolean cancelLoadJob(CancelLoadStmt stmt, boolean isAccurateMatch) throws DdlException {\n+        // get params\n+        String dbName = stmt.getDbName();\n+        String label = stmt.getLabel();\n+\n+        // get load job and check state\n+        Database db = Catalog.getCurrentCatalog().getDb(dbName);\n+        if (db == null) {\n+            throw new DdlException(\"Db does not exist. name: \" + dbName);\n+        }\n+        // List of load jobs waiting to be cancelled\n+        List<LoadJob> loadJobs = Lists.newArrayList();\n+        readLock();\n+        try {\n+            Map<String, List<LoadJob>> labelToLoadJobs = dbLabelToLoadJobs.get(db.getId());\n+            if (labelToLoadJobs == null) {\n+                throw new DdlException(\"Load job does not exist\");\n+            }\n+\n+            // get jobs by label\n+            List<LoadJob> matchLoadJobs = Lists.newArrayList();\n+            if (isAccurateMatch) {\n+                if (labelToLoadJobs.containsKey(label)) {\n+                    matchLoadJobs.addAll(labelToLoadJobs.get(label));\n+                }\n+            } else {\n+                for (Map.Entry<String, List<LoadJob>> entry : labelToLoadJobs.entrySet()) {\n+                    if (entry.getKey().contains(label)) {\n+                        matchLoadJobs.addAll(entry.getValue());\n+                    }\n+                }\n+            }\n+\n+            if (matchLoadJobs.isEmpty()) {\n+                throw new DdlException(\"Load job does not exist\");\n+            }\n+\n+            // check state here\n+            if (isAccurateMatch) {\n+                // only the last one should be running", "originalCommit": "655c006cf32541fbc8bc4d22cbcd8ab43d0e0d6f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjkwNTg0NQ==", "url": "https://github.com/apache/incubator-doris/pull/4515#discussion_r496905845", "bodyText": "ok. I just unify the logic.", "author": "xy720", "createdAt": "2020-09-29T17:13:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzUyNDYzNg=="}], "type": "inlineReview"}, {"oid": "0f9b9cf94e49ff0646fc0cb66943bf8fd254d1c4", "url": "https://github.com/apache/incubator-doris/commit/0f9b9cf94e49ff0646fc0cb66943bf8fd254d1c4", "message": "unify logic", "committedDate": "2020-09-29T17:12:09Z", "type": "commit"}]}