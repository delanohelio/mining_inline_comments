{"pr_number": 4891, "pr_title": "[Refactor] Execute 'pick rowsets' before applying for permits for a compaction task", "pr_createdAt": "2020-11-12T13:46:34Z", "pr_url": "https://github.com/apache/incubator-doris/pull/4891", "timeline": [{"oid": "8937a3b2d0448da4e9c1df857b0a978dedc33246", "url": "https://github.com/apache/incubator-doris/commit/8937a3b2d0448da4e9c1df857b0a978dedc33246", "message": "optimize and refactor compaction model", "committedDate": "2020-11-23T05:26:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTYwNzU0MA==", "url": "https://github.com/apache/incubator-doris/pull/4891#discussion_r529607540", "bodyText": "Add comment to explain why setting clone occurred here.", "author": "morningman", "createdAt": "2020-11-24T14:56:00Z", "path": "be/src/olap/base_compaction.cpp", "diffHunk": "@@ -43,9 +50,26 @@ OLAPStatus BaseCompaction::compact() {\n     RETURN_NOT_OK(pick_rowsets_to_compact());\n     TRACE(\"rowsets picked\");\n     TRACE_COUNTER_INCREMENT(\"input_rowsets_count\", _input_rowsets.size());\n+    _tablet->set_clone_occurred(false);\n+\n+    return OLAP_SUCCESS;\n+}\n+\n+OLAPStatus BaseCompaction::execute_compact() {\n+    MutexLock lock(_tablet->get_base_lock(), TRY_LOCK);\n+    if (!lock.own_lock()) {\n+        LOG(WARNING) << \"another base compaction is running. tablet=\" << _tablet->full_name();\n+        return OLAP_ERR_BE_TRY_BE_LOCK_ERROR;\n+    }\n+    TRACE(\"got base compaction lock\");\n+\n+    if (_tablet->get_clone_occurred()) {\n+        _tablet->set_clone_occurred(false);", "originalCommit": "8937a3b2d0448da4e9c1df857b0a978dedc33246", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA2ODY3Nw==", "url": "https://github.com/apache/incubator-doris/pull/4891#discussion_r530068677", "bodyText": "OK.", "author": "weizuo93", "createdAt": "2020-11-25T02:31:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTYwNzU0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTYwODgyMA==", "url": "https://github.com/apache/incubator-doris/pull/4891#discussion_r529608820", "bodyText": "Who will call BaseCompaction::compact() now?", "author": "morningman", "createdAt": "2020-11-24T14:57:36Z", "path": "be/src/olap/base_compaction.cpp", "diffHunk": "@@ -28,6 +28,13 @@ BaseCompaction::BaseCompaction(TabletSharedPtr tablet, const std::string& label,\n BaseCompaction::~BaseCompaction() { }\n \n OLAPStatus BaseCompaction::compact() {\n+    RETURN_NOT_OK(prepare_compact());", "originalCommit": "8937a3b2d0448da4e9c1df857b0a978dedc33246", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA2Mzc3OQ==", "url": "https://github.com/apache/incubator-doris/pull/4891#discussion_r530063779", "bodyText": "Who will call BaseCompaction::compact() now?\n\nBaseCompaction::compact() will still be called in \"be/src/http/action/compaction_action.cpp\" for /api/compaction/run.", "author": "weizuo93", "createdAt": "2020-11-25T02:16:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTYwODgyMA=="}], "type": "inlineReview"}, {"oid": "91b09c5b506bee6894c7e06555de9db311cc1656", "url": "https://github.com/apache/incubator-doris/commit/91b09c5b506bee6894c7e06555de9db311cc1656", "message": "optimize and refactor compaction model", "committedDate": "2020-11-25T03:03:55Z", "type": "forcePushed"}, {"oid": "4f942cd40c9ef3bfd47d10a34deb1e5df09581ad", "url": "https://github.com/apache/incubator-doris/commit/4f942cd40c9ef3bfd47d10a34deb1e5df09581ad", "message": "optimize and refactor compaction model", "committedDate": "2020-11-26T13:22:53Z", "type": "forcePushed"}, {"oid": "c251ed0fb75fcc7de30474ff8a1c1ea218f86f48", "url": "https://github.com/apache/incubator-doris/commit/c251ed0fb75fcc7de30474ff8a1c1ea218f86f48", "message": "optimize and refactor compaction model", "committedDate": "2020-11-28T11:52:17Z", "type": "commit"}, {"oid": "c251ed0fb75fcc7de30474ff8a1c1ea218f86f48", "url": "https://github.com/apache/incubator-doris/commit/c251ed0fb75fcc7de30474ff8a1c1ea218f86f48", "message": "optimize and refactor compaction model", "committedDate": "2020-11-28T11:52:17Z", "type": "forcePushed"}]}