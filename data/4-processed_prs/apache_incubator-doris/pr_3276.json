{"pr_number": 3276, "pr_title": "[refactor] A small refactor on class DataDir", "pr_createdAt": "2020-04-08T02:45:00Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3276", "timeline": [{"oid": "867b7a5fcba5e4ca8f3ab27ffeeb3aa065d54fb8", "url": "https://github.com/apache/incubator-doris/commit/867b7a5fcba5e4ca8f3ab27ffeeb3aa065d54fb8", "message": "[refactor] A small refactor on class DataDir\n\nmain refactor points are:\n- Use a single get_absolute_tablet_path function instead of 3\n  independent functions\n- Remove meaningless return value of register_tablet and deregister_tablet\n- Some typo and format", "committedDate": "2020-04-08T02:31:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM2Mzg0MA==", "url": "https://github.com/apache/incubator-doris/pull/3276#discussion_r405363840", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                _tablet_set.emplace(tablet_info);\n          \n          \n            \n                _tablet_set.emplace(std::move(tablet_info));", "author": "imay", "createdAt": "2020-04-08T08:53:47Z", "path": "be/src/olap/data_dir.cpp", "diffHunk": "@@ -395,69 +395,47 @@ OLAPStatus DataDir::get_shard(uint64_t* shard) {\n     return OLAP_SUCCESS;\n }\n \n-OLAPStatus DataDir::register_tablet(Tablet* tablet) {\n-    std::lock_guard<std::mutex> l(_mutex);\n-\n+void DataDir::register_tablet(Tablet* tablet) {\n     TabletInfo tablet_info(tablet->tablet_id(), tablet->schema_hash(), tablet->tablet_uid());\n-    _tablet_set.insert(tablet_info);\n-    return OLAP_SUCCESS;\n-}\n \n-OLAPStatus DataDir::deregister_tablet(Tablet* tablet) {\n     std::lock_guard<std::mutex> l(_mutex);\n+    _tablet_set.emplace(tablet_info);", "originalCommit": "867b7a5fcba5e4ca8f3ab27ffeeb3aa065d54fb8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM3MDkzNw==", "url": "https://github.com/apache/incubator-doris/pull/3276#discussion_r405370937", "bodyText": "I think it will be better to have a function with argument shard_id, tablet_id and schema_hash. Then there won't be the following functions which do the same thing.\nAnd the string operator + performance is bad, prefer strings::Substitute.", "author": "imay", "createdAt": "2020-04-08T09:04:28Z", "path": "be/src/olap/data_dir.cpp", "diffHunk": "@@ -395,69 +395,47 @@ OLAPStatus DataDir::get_shard(uint64_t* shard) {\n     return OLAP_SUCCESS;\n }\n \n-OLAPStatus DataDir::register_tablet(Tablet* tablet) {\n-    std::lock_guard<std::mutex> l(_mutex);\n-\n+void DataDir::register_tablet(Tablet* tablet) {\n     TabletInfo tablet_info(tablet->tablet_id(), tablet->schema_hash(), tablet->tablet_uid());\n-    _tablet_set.insert(tablet_info);\n-    return OLAP_SUCCESS;\n-}\n \n-OLAPStatus DataDir::deregister_tablet(Tablet* tablet) {\n     std::lock_guard<std::mutex> l(_mutex);\n+    _tablet_set.emplace(tablet_info);\n+}\n \n+void DataDir::deregister_tablet(Tablet* tablet) {\n     TabletInfo tablet_info(tablet->tablet_id(), tablet->schema_hash(), tablet->tablet_uid());\n+\n+    std::lock_guard<std::mutex> l(_mutex);\n     _tablet_set.erase(tablet_info);\n-    return OLAP_SUCCESS;\n }\n \n void DataDir::clear_tablets(std::vector<TabletInfo>* tablet_infos) {\n-    for (auto& tablet : _tablet_set) {\n-        tablet_infos->push_back(tablet);\n-    }\n+    std::lock_guard<std::mutex> l(_mutex);\n+\n+    tablet_infos->insert(tablet_infos->end(), _tablet_set.begin(), _tablet_set.end());\n     _tablet_set.clear();\n }\n \n std::string DataDir::get_absolute_shard_path(const std::string& shard_string) {\n     return _path + DATA_PREFIX + \"/\" + shard_string;\n }\n \n-std::string DataDir::get_absolute_tablet_path(TabletMeta* tablet_meta, bool with_schema_hash) {\n+template <typename T>\n+std::string DataDir::get_absolute_tablet_path(const T& tablet_meta, bool with_schema_hash) {", "originalCommit": "867b7a5fcba5e4ca8f3ab27ffeeb3aa065d54fb8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c6ff6b8d58591df812fa799707577c71947147f3", "url": "https://github.com/apache/incubator-doris/commit/c6ff6b8d58591df812fa799707577c71947147f3", "message": "Update be/src/olap/data_dir.cpp\n\nCo-Authored-By: ZHAO Chun <buaa.zhaoc@gmail.com>", "committedDate": "2020-04-08T16:25:56Z", "type": "commit"}, {"oid": "60e0b44458448a803a28a729a6ef99ddb9452f52", "url": "https://github.com/apache/incubator-doris/commit/60e0b44458448a803a28a729a6ef99ddb9452f52", "message": "fix", "committedDate": "2020-04-09T07:07:50Z", "type": "commit"}, {"oid": "1765699f47a1493755256a9cec7849db0d424c7f", "url": "https://github.com/apache/incubator-doris/commit/1765699f47a1493755256a9cec7849db0d424c7f", "message": "fix", "committedDate": "2020-04-09T07:35:50Z", "type": "commit"}, {"oid": "828690d415e58b196947b6be1803d61ec6a9ae53", "url": "https://github.com/apache/incubator-doris/commit/828690d415e58b196947b6be1803d61ec6a9ae53", "message": "style", "committedDate": "2020-04-09T08:14:39Z", "type": "commit"}, {"oid": "2670639b2e358068a928b82c428141427cd7450e", "url": "https://github.com/apache/incubator-doris/commit/2670639b2e358068a928b82c428141427cd7450e", "message": "style", "committedDate": "2020-04-09T08:24:39Z", "type": "commit"}]}