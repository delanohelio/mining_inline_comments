{"pr_number": 4670, "pr_title": "[Optimize] Optimize the execution model of compaction to limit memory consumption", "pr_createdAt": "2020-09-25T04:18:56Z", "pr_url": "https://github.com/apache/incubator-doris/pull/4670", "timeline": [{"oid": "1089cda6fd8a399abf744052344e11ff7a139528", "url": "https://github.com/apache/incubator-doris/commit/1089cda6fd8a399abf744052344e11ff7a139528", "message": "compaction memory optimize and code refactor", "committedDate": "2020-09-18T14:18:35Z", "type": "commit"}, {"oid": "d96e0ee99022f00e595aef460f7a87b780b71675", "url": "https://github.com/apache/incubator-doris/commit/d96e0ee99022f00e595aef460f7a87b780b71675", "message": "compaction memory optimize and code refactor", "committedDate": "2020-09-20T12:53:58Z", "type": "commit"}, {"oid": "908788aab68dbdfd4f98698bfcef1b633207c40d", "url": "https://github.com/apache/incubator-doris/commit/908788aab68dbdfd4f98698bfcef1b633207c40d", "message": "compaction memory optimize and code refactor", "committedDate": "2020-09-20T13:03:16Z", "type": "commit"}, {"oid": "4bea5d544020c7121be2e8523393714e204623a7", "url": "https://github.com/apache/incubator-doris/commit/4bea5d544020c7121be2e8523393714e204623a7", "message": "compaction memory optimize and code refactor", "committedDate": "2020-09-20T13:04:36Z", "type": "commit"}, {"oid": "72e4e7973aee215fcca0b223305e335d3e4ec83f", "url": "https://github.com/apache/incubator-doris/commit/72e4e7973aee215fcca0b223305e335d3e4ec83f", "message": "compaction memory optimize and code refactor", "committedDate": "2020-09-20T13:11:48Z", "type": "commit"}, {"oid": "506afdb34de9ba61a1422ca0f52c7ae9681ff259", "url": "https://github.com/apache/incubator-doris/commit/506afdb34de9ba61a1422ca0f52c7ae9681ff259", "message": "add compaction status for tablet", "committedDate": "2020-09-21T06:45:41Z", "type": "commit"}, {"oid": "dce66cde3ab3a22640c5f2464164b88705482ea7", "url": "https://github.com/apache/incubator-doris/commit/dce66cde3ab3a22640c5f2464164b88705482ea7", "message": "add lambda function for submit callback", "committedDate": "2020-09-21T08:00:25Z", "type": "commit"}, {"oid": "ab4722a952caadcd3293ad7ddd6506b5fde2a897", "url": "https://github.com/apache/incubator-doris/commit/ab4722a952caadcd3293ad7ddd6506b5fde2a897", "message": "code refactor", "committedDate": "2020-09-21T08:48:12Z", "type": "commit"}, {"oid": "71cffec1357f889df89743cad93de256f2aa7ca4", "url": "https://github.com/apache/incubator-doris/commit/71cffec1357f889df89743cad93de256f2aa7ca4", "message": "code refactor", "committedDate": "2020-09-21T09:17:59Z", "type": "commit"}, {"oid": "64681973707871fa500f1dd889f800094f1f9e78", "url": "https://github.com/apache/incubator-doris/commit/64681973707871fa500f1dd889f800094f1f9e78", "message": "code refactor", "committedDate": "2020-09-21T11:32:25Z", "type": "commit"}, {"oid": "5f784bf9bef1f36cfdc3c531f2a5646461b6f219", "url": "https://github.com/apache/incubator-doris/commit/5f784bf9bef1f36cfdc3c531f2a5646461b6f219", "message": "code refactor", "committedDate": "2020-09-21T11:48:14Z", "type": "commit"}, {"oid": "e9406e7d1da7ac0b9448df54d4297878b5a7bd3b", "url": "https://github.com/apache/incubator-doris/commit/e9406e7d1da7ac0b9448df54d4297878b5a7bd3b", "message": "add metrics and comment for compaction limiter", "committedDate": "2020-09-22T07:42:45Z", "type": "commit"}, {"oid": "f7b614c3f7932d90edd6c5457533c544fe0c1c29", "url": "https://github.com/apache/incubator-doris/commit/f7b614c3f7932d90edd6c5457533c544fe0c1c29", "message": "modify metrics", "committedDate": "2020-09-22T10:38:22Z", "type": "commit"}, {"oid": "fbe9b575485686d351e394c85760df0df4c9541e", "url": "https://github.com/apache/incubator-doris/commit/fbe9b575485686d351e394c85760df0df4c9541e", "message": "modify metrics", "committedDate": "2020-09-22T13:26:16Z", "type": "commit"}, {"oid": "7200398e5ea4c427b42afc9afde90481e62f173f", "url": "https://github.com/apache/incubator-doris/commit/7200398e5ea4c427b42afc9afde90481e62f173f", "message": "modify metrics", "committedDate": "2020-09-23T01:59:51Z", "type": "commit"}, {"oid": "8652b55ee3148a83c2f27ed78941f2a20b455743", "url": "https://github.com/apache/incubator-doris/commit/8652b55ee3148a83c2f27ed78941f2a20b455743", "message": "modify metrics", "committedDate": "2020-09-23T03:15:47Z", "type": "commit"}, {"oid": "644b12606dbe27dacceb2f5b2aae35ce0aeb2449", "url": "https://github.com/apache/incubator-doris/commit/644b12606dbe27dacceb2f5b2aae35ce0aeb2449", "message": "modify config", "committedDate": "2020-09-23T07:06:00Z", "type": "commit"}, {"oid": "6ce8595e0b183ed9a1ebaa8b52c66db2dd42ffcc", "url": "https://github.com/apache/incubator-doris/commit/6ce8595e0b183ed9a1ebaa8b52c66db2dd42ffcc", "message": "modify config", "committedDate": "2020-09-23T12:08:57Z", "type": "commit"}, {"oid": "b7dd382de92f2f6c411eb7208f46644927122770", "url": "https://github.com/apache/incubator-doris/commit/b7dd382de92f2f6c411eb7208f46644927122770", "message": "modify metrics", "committedDate": "2020-09-24T12:33:11Z", "type": "commit"}, {"oid": "256d25851ca69bc0d7f5ec38f37ce6861f7df94e", "url": "https://github.com/apache/incubator-doris/commit/256d25851ca69bc0d7f5ec38f37ce6861f7df94e", "message": "modify metrics", "committedDate": "2020-09-24T13:47:48Z", "type": "commit"}, {"oid": "9484f52d6ade61188f34aeee8717d236de467350", "url": "https://github.com/apache/incubator-doris/commit/9484f52d6ade61188f34aeee8717d236de467350", "message": "modify metrics", "committedDate": "2020-09-24T14:10:54Z", "type": "commit"}, {"oid": "18c2933b654f25a878d5ad75e172289bf82b3689", "url": "https://github.com/apache/incubator-doris/commit/18c2933b654f25a878d5ad75e172289bf82b3689", "message": "modify metrics", "committedDate": "2020-09-25T03:24:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQwODcyMw==", "url": "https://github.com/apache/incubator-doris/pull/4670#discussion_r495408723", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                CONF_mBool(enable_over_sold, \"true\");\n          \n          \n            \n                CONF_mBool(enable_compaction_permit_over_sold, \"true\");", "author": "morningman", "createdAt": "2020-09-26T03:28:39Z", "path": "be/src/common/config.h", "diffHunk": "@@ -310,13 +306,25 @@ namespace config {\n     // if compaction of a tablet failed, this tablet should not be chosen to\n     // compaction until this interval passes.\n     CONF_mInt64(min_compaction_failure_interval_sec, \"600\"); // 10 min\n-    // Too many compaction tasks may run out of memory.\n-    // This config is to limit the max concurrency of running compaction tasks.\n-    // -1 means no limit, and the max concurrency will be:\n-    //      C = (cumulative_compaction_num_threads_per_disk + base_compaction_num_threads_per_disk) * dir_num\n-    // set it to larger than C will be set to equal to C.\n-    // This config can be set to 0, which means to forbid any compaction, for some special cases.\n-    CONF_Int32(max_compaction_concurrency, \"-1\");\n+\n+    // This config can be set to limit thread number in compaction thread pool.\n+    CONF_mInt32(min_compaction_threads, \"10\");\n+    CONF_mInt32(max_compaction_threads, \"10\");\n+\n+    // The upper limit of \"permits\" held by all compaction tasks. This config can be set to limit memory consumption for compaction.\n+    CONF_mInt64(total_permits_for_compaction_score, \"10000\")\n+\n+    // Whether compaction task is allowed to start when compaction score of current tablet is out of upper limit.\n+    CONF_mBool(enable_over_sold, \"true\");", "originalCommit": "18c2933b654f25a878d5ad75e172289bf82b3689", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTY1ODMyMg==", "url": "https://github.com/apache/incubator-doris/pull/4670#discussion_r495658322", "bodyText": "OK !", "author": "weizuo93", "createdAt": "2020-09-28T02:20:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQwODcyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQyNzQyMA==", "url": "https://github.com/apache/incubator-doris/pull/4670#discussion_r495427420", "bodyText": "The default cumulative_compaction_rounds_for_each_base_compaction_round is 9, and default generate_compaction_tasks_interval_seconds is 2. So generally, it will create a base compaction task for every 18 seconds?", "author": "morningman", "createdAt": "2020-09-26T07:30:56Z", "path": "be/src/olap/olap_server.cpp", "diffHunk": "@@ -391,4 +313,70 @@ void StorageEngine::_tablet_checkpoint_callback(DataDir* data_dir) {\n     } while (!_stop_background_threads_latch.wait_for(MonoDelta::FromSeconds(interval)));\n }\n \n-}  // namespace doris\n+void StorageEngine::_compaction_tasks_producer_callback() {\n+#ifdef GOOGLE_PROFILER\n+    ProfilerRegisterThread();\n+#endif\n+    LOG(INFO) << \"try to start compaction producer process!\";\n+\n+    std::vector<DataDir*> data_dirs;\n+    for (auto& tmp_store : _store_map) {\n+        data_dirs.push_back(tmp_store.second);\n+    }\n+\n+    int round = 0;\n+    CompactionType compaction_type;\n+    do {\n+        if (!config::disable_auto_compaction) {\n+            if (round < config::cumulative_compaction_rounds_for_each_base_compaction_round) {", "originalCommit": "18c2933b654f25a878d5ad75e172289bf82b3689", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ2MzI0NQ==", "url": "https://github.com/apache/incubator-doris/pull/4670#discussion_r495463245", "bodyText": "And I also test this with following case:\n\nOnly 1 BE with 1 data dir.\nCreate one table with 100 buckets.\ninsert data into this table for every 5 seconds.\n\nThe compaction is triggered every 2 seconds. And each compaction task cost just 0.x seconds. But the average version count of tablets is about 50, and can not be lower.\nSo I think the way to generate compaction tasks through polling may not be appropriate. One possible way is to generate compaction tasks through triggering.\nBased on polling, currently only one task can be done in 2 seconds, and based on triggering, in my case, it can be done 500 times per second (because the amount of data in each batch is very small in the case of high-frequency load)", "author": "morningman", "createdAt": "2020-09-26T14:42:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQyNzQyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTY2MDEwNQ==", "url": "https://github.com/apache/incubator-doris/pull/4670#discussion_r495660105", "bodyText": "Thanks for your suggestions! I optimized the implementation logic of my producer.  If all the compaction tasks produced can hold permits, the producer will continue to produce compaction tasks without sleep. In this way, the production speed can far meet consumer demand.", "author": "weizuo93", "createdAt": "2020-09-28T02:30:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQyNzQyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQyODgwMQ==", "url": "https://github.com/apache/incubator-doris/pull/4670#discussion_r495428801", "bodyText": "I think we can find more than one tablet for each data dir at this time.\nthe number of tablet found here can be compaction_task_num_per_disk", "author": "morningman", "createdAt": "2020-09-26T07:48:10Z", "path": "be/src/olap/olap_server.cpp", "diffHunk": "@@ -391,4 +313,70 @@ void StorageEngine::_tablet_checkpoint_callback(DataDir* data_dir) {\n     } while (!_stop_background_threads_latch.wait_for(MonoDelta::FromSeconds(interval)));\n }\n \n-}  // namespace doris\n+void StorageEngine::_compaction_tasks_producer_callback() {\n+#ifdef GOOGLE_PROFILER\n+    ProfilerRegisterThread();\n+#endif\n+    LOG(INFO) << \"try to start compaction producer process!\";\n+\n+    std::vector<DataDir*> data_dirs;\n+    for (auto& tmp_store : _store_map) {\n+        data_dirs.push_back(tmp_store.second);\n+    }\n+\n+    int round = 0;\n+    CompactionType compaction_type;\n+    do {\n+        if (!config::disable_auto_compaction) {\n+            if (round < config::cumulative_compaction_rounds_for_each_base_compaction_round) {\n+                compaction_type = CompactionType::CUMULATIVE_COMPACTION;\n+                round++;\n+            } else {\n+                compaction_type = CompactionType::BASE_COMPACTION;\n+                round = 0;\n+            }\n+            LOG(INFO) << \"try to generate a batch of compaction tasks!\";\n+            vector<TabletSharedPtr> tablets_compaction =\n+                    _compaction_tasks_generator(compaction_type, data_dirs);\n+            for (const auto& tablet : tablets_compaction) {\n+                if (tablet->data_dir()->get_disks_compaction_num() <\n+                    config::compaction_task_num_per_disk) {\n+                    int64_t permits = tablet->calc_compaction_score(compaction_type);\n+                    if (_permit_limiter.request(permits)) {\n+                        if (compaction_type == CompactionType::CUMULATIVE_COMPACTION) {\n+                            _compaction_thread_pool->submit_func([this, tablet, permits]() {\n+                                CgroupsMgr::apply_system_cgroup();\n+                                this->_perform_cumulative_compaction(tablet);\n+                                this->_permit_limiter.release(permits);\n+                            });\n+                        } else {\n+                            _compaction_thread_pool->submit_func([this, tablet, permits]() {\n+                                CgroupsMgr::apply_system_cgroup();\n+                                this->_perform_base_compaction(tablet);\n+                                this->_permit_limiter.release(permits);\n+                            });\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+    } while (!_stop_background_threads_latch.wait_for(\n+            MonoDelta::FromSeconds(config::generate_compaction_tasks_interval_seconds)));\n+}\n+\n+vector<TabletSharedPtr> StorageEngine::_compaction_tasks_generator(\n+        CompactionType compaction_type, std::vector<DataDir*> data_dirs) {\n+    vector<TabletSharedPtr> tablets_compaction;\n+    std::random_shuffle(data_dirs.begin(), data_dirs.end());\n+    for (auto data_dir : data_dirs) {", "originalCommit": "18c2933b654f25a878d5ad75e172289bf82b3689", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5c6879b0d7723e7b0daf2dbd45bffa1e2009b323", "url": "https://github.com/apache/incubator-doris/commit/5c6879b0d7723e7b0daf2dbd45bffa1e2009b323", "message": "optimize compaction tasks producer", "committedDate": "2020-09-27T14:16:19Z", "type": "commit"}, {"oid": "7c343f47cff3267eb364be9bf6bb72f53ccdb63d", "url": "https://github.com/apache/incubator-doris/commit/7c343f47cff3267eb364be9bf6bb72f53ccdb63d", "message": "modify compaction tasks producer", "committedDate": "2020-09-28T02:19:22Z", "type": "commit"}, {"oid": "3e49f5339bac6b0203dda9c14a0c02adb2e6ff04", "url": "https://github.com/apache/incubator-doris/commit/3e49f5339bac6b0203dda9c14a0c02adb2e6ff04", "message": "modify compaction tasks producer", "committedDate": "2020-09-28T03:13:18Z", "type": "commit"}, {"oid": "ab5f6b30aa44e39c5b91104b4b63403ffd278637", "url": "https://github.com/apache/incubator-doris/commit/ab5f6b30aa44e39c5b91104b4b63403ffd278637", "message": "optimize compaction memory and code refactor", "committedDate": "2020-09-28T11:21:36Z", "type": "commit"}, {"oid": "a0206b3586aa17d86a2e12e445fcf94b5f32c74c", "url": "https://github.com/apache/incubator-doris/commit/a0206b3586aa17d86a2e12e445fcf94b5f32c74c", "message": "compaction log modification", "committedDate": "2020-09-30T02:26:11Z", "type": "commit"}]}