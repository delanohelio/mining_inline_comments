{"pr_number": 10531, "pr_title": "Fix LambdaNestedInnerTest", "pr_createdAt": "2020-09-08T15:11:33Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10531", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyMDgzNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r485120835", "bodyText": "Use the common helper to clear the exception\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\tvmThread->currentException = NULL;\n          \n          \n            \n            \t\t\tvmThread->privateFlags &= ~(UDATA)J9_PRIVATE_FLAGS_REPORT_EXCEPTION_THROW;\n          \n          \n            \n            \t\t\tVM_VMHelpers::clearException(vmThread);", "author": "DanHeidinga", "createdAt": "2020-09-08T18:38:08Z", "path": "runtime/vm/visible.c", "diffHunk": "@@ -343,6 +355,15 @@ loadAndVerifyNestHost(J9VMThread *vmThread, J9Class *clazz, UDATA options)\n \t\t/* If a problem occurred in nest host verification then the nest host value is invalid */\n \t\tif (J9_VISIBILITY_ALLOWED == result) {\n \t\t\tclazz->nestHost = nestHost;\n+\t\t} else if (hiddenNestMate) {\n+\t\t\t/* \n+\t\t\t * For hidden class that is added into the nest of its host class, i.e. defined with Option.NESTMATE,\n+\t\t\t * if we cannot get its nest host, its hostclass (curClazz) shuold be used as nest host instead. \n+\t\t\t */\n+\t\t\tclazz->nestHost = curClazz;\n+\t\t\tvmThread->currentException = NULL;\n+\t\t\tvmThread->privateFlags &= ~(UDATA)J9_PRIVATE_FLAGS_REPORT_EXCEPTION_THROW;", "originalCommit": "f4ff501d9be74dd0c54e86247d495bde961f016a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEzOTUwNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r485139504", "bodyText": "I get a compilation error if I change to use VM_VMHelpers\nvisible.c:358:38: error: expected expression before ':' token\n                         VM_VMHelpers::clearException(vmThread);\n                                      ^\nvisible.c:358:25: error: label 'VM_VMHelpers' defined but not used [-Werror=unused-label", "author": "hangshao0", "createdAt": "2020-09-08T19:13:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyMDgzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE0MTM5OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r485141399", "bodyText": "I told you to use a C++ helper in a c file.  Probably more work than it's worth to convert the file now so leave the code as it is", "author": "DanHeidinga", "createdAt": "2020-09-08T19:16:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyMDgzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyMzg1MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r485123850", "bodyText": "It might be clearer to directly assign clazz->nestHost = clazz->hostClass; here as curClazz is updated in the while loop above", "author": "DanHeidinga", "createdAt": "2020-09-08T18:43:54Z", "path": "runtime/vm/visible.c", "diffHunk": "@@ -343,6 +355,15 @@ loadAndVerifyNestHost(J9VMThread *vmThread, J9Class *clazz, UDATA options)\n \t\t/* If a problem occurred in nest host verification then the nest host value is invalid */\n \t\tif (J9_VISIBILITY_ALLOWED == result) {\n \t\t\tclazz->nestHost = nestHost;\n+\t\t} else if (hiddenNestMate) {\n+\t\t\t/* \n+\t\t\t * For hidden class that is added into the nest of its host class, i.e. defined with Option.NESTMATE,\n+\t\t\t * if we cannot get its nest host, its hostclass (curClazz) shuold be used as nest host instead. \n+\t\t\t */\n+\t\t\tclazz->nestHost = curClazz;", "originalCommit": "f4ff501d9be74dd0c54e86247d495bde961f016a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE0MDg1NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r485140855", "bodyText": "clazz->hostClass could be another hidden class defined with Option.NESTMATE, so we need to walk to the end of the chain to use the class that is not hidden NestMate class, which is curClazz.", "author": "hangshao0", "createdAt": "2020-09-08T19:15:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyMzg1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE0MjIyMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r485142223", "bodyText": "I thought we discussed in another PR that a hidden class couldn't be the host of another hidden class... or am I remembering that wrong?", "author": "DanHeidinga", "createdAt": "2020-09-08T19:18:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyMzg1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE0Mzg2NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r485143865", "bodyText": "That discussion was a hidden class cannot be super class of another hidden class.", "author": "hangshao0", "createdAt": "2020-09-08T19:21:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyMzg1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNTE5Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r485125192", "bodyText": "Can this be moved into loadAndVerifyNestHost?  It's cleaner if that's the only code that sets nestHost.  A special case here makes it easy to overlook and harder to reason about nestmate code in general", "author": "DanHeidinga", "createdAt": "2020-09-08T18:46:15Z", "path": "runtime/jcl/common/java_lang_Class.cpp", "diffHunk": "@@ -1821,6 +1821,7 @@ Java_java_lang_Class_getNestHostImpl(JNIEnv *env, jobject recv)\n \t\t\t * not specify a nest, then it is considered to belong to its own nest and this is returned as\n \t\t\t * the host */\n \t\t\tnestHost = clazzToUse;\n+\t\t\tclazzToUse->nestHost = nestHost;", "originalCommit": "f4ff501d9be74dd0c54e86247d495bde961f016a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE1MDQ0MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r485150440", "bodyText": "So the existing code in loadAndVerifyNestHost() is already setting clazz->nestHost whenever J9_VISIBILITY_ALLOWED is returned. I cached nestHost to clazzToUse->nestHost here because I noticed one issue with existing nest mate implementation in LambdaNestedInnerTest.\nIf a class (could be a normal class, not necessarily a hidden class) has problem finding its nest host, i.e. loadAndVerifyNestHost() failed, this class is in its own nest. The test is doing something like assert(Clazz.getNestHost() ==  Clazz.getNestMembers()). Our existing code before this change has Clazz.getNestHost() == Clazz and Clazz.getNestMembers() == null, which makes the test fail.", "author": "hangshao0", "createdAt": "2020-09-08T19:34:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNTE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE2MTYzMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r485161632", "bodyText": "That seems like a bug in our implementation of Java_java_lang_Class_getNestMembersImpl in that it returns null if the host isn't visible", "author": "DanHeidinga", "createdAt": "2020-09-08T19:56:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNTE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE2MzgyNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r485163827", "bodyText": "That seems like a bug in our implementation of Java_java_lang_Class_getNestMembersImpl in that it returns null if the host isn't visible\n\nYes, I agree.", "author": "hangshao0", "createdAt": "2020-09-08T20:00:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNTE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI4ODY1NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r485288655", "bodyText": "Are you removing this and making the change to Java_java_lang_Class_getNestMembersImpl?", "author": "DanHeidinga", "createdAt": "2020-09-09T01:45:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNTE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU4MDIxMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r485580210", "bodyText": "Would adding this case to Class#getNestMembers remove the need for this line?  It keeps the same behaviour in the natives and adds a small change in the java method\ndiff --git a/jcl/src/java.base/share/classes/java/lang/Class.java b/jcl/src/java.base/share/classes/java/lang/Class.java\nindex b13dfac0d6..0ad27fca06 100644\n--- a/jcl/src/java.base/share/classes/java/lang/Class.java\n+++ b/jcl/src/java.base/share/classes/java/lang/Class.java\n@@ -4758,6 +4758,10 @@ public Class<?>[] getNestMembers() throws LinkageError, SecurityException {\n        }\n \n        Class<?>[] members = getNestMembersImpl();\n+       if (members == null) {\n+               /* NestHost wasn't accessible - class is in a nest with itself */\n+               return new Class<?>[] { this };\n+       }\n        /* Skip security check for the Class object that belongs to the nest consisting only of itself */\n        if (members.length > 1) {\n                SecurityManager securityManager = System.getSecurityManager();", "author": "DanHeidinga", "createdAt": "2020-09-09T12:43:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNTE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTY4ODQ3OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r485688479", "bodyText": "May need to put the getNestMembersImpl() into a try catch block, I am getting NoClassDefFoundError if I made this change in Class.java when we cannot find the nesthost.", "author": "hangshao0", "createdAt": "2020-09-09T15:08:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNTE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcwMTk4OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r485701988", "bodyText": "As long as we match the RI and the specification, I'm OK with this approach", "author": "DanHeidinga", "createdAt": "2020-09-09T15:26:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNTE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcwMjQxNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r485702414", "bodyText": "We'll need to validate the behaviour on both JDK11 & JDK15 to ensure we're consistent with both releases", "author": "DanHeidinga", "createdAt": "2020-09-09T15:27:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNTE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcxNDMzNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r485714334", "bodyText": "Looking at the javadoc of Class.getNestMembers(), it says LinkageError (NoClassDefFoundError is a subclass of LinkageError) will be thrown if it has problem loading or validating a nest member or the nest host. So I think the try catch block is not the way to go.", "author": "hangshao0", "createdAt": "2020-09-09T15:43:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNTE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTczNTMwMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r485735303", "bodyText": "OK, tried removing the the code to cache nesthost to clazzToUse->nestHost, making change in the native Java_java_lang_Class_getNestMembersImpl. I still cannot get this test passed, it failed at a later place (on NoClassDefFoundError). So here is the thing:\nA hidden class is added to the nest of its host class, the host class cannot find its nest host.\nBoth hostClass.getNestHost() and hiddenClass().getNestHost() are called in the test, but the test does not expect the second call hiddenClass().getNestHost() to throw NoClassDefFoundError. I guess RI must cached the result of first call, so hiddenClass().getNestHost() directly return hostClass, it is like what I am doing in Java_java_lang_Class_getNestHostImpl() here.", "author": "hangshao0", "createdAt": "2020-09-09T16:10:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNTE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc4MDk1Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r485780956", "bodyText": "What happens if the test calls hostClass.getNestHost() a second time?  By caching the result, I think you avoid the exception on the second call which isn't expected.", "author": "DanHeidinga", "createdAt": "2020-09-09T17:05:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNTE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc4MTk3Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r485781972", "bodyText": "It also changes the behaviour of loadAndVerifyNestHost as it won't throw exceptions on subsequent calls.", "author": "DanHeidinga", "createdAt": "2020-09-09T17:07:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNTE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTgwNDMxNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r485804317", "bodyText": "What happens if the test calls hostClass.getNestHost() a second time? By caching the result, I think you avoid the exception on the second call which isn't expected.\n\nIn Class.java, there is a field nestHost, so getNestHost() will call into getNestHostImpl only once for the same class. The second call will return the cached nestHost and won't throw exception.\nhttps://github.com/eclipse/openj9/blob/master/jcl/src/java.base/share/classes/java/lang/Class.java#L4696\n\nIt also changes the behaviour of loadAndVerifyNestHost as it won't throw exceptions on subsequent calls.\n\nYes, for the same class, it won't throw exception on subsequent calls, like Class.getNestHost(). I haven't find a way to not cache the nesthost and make the test pass.", "author": "hangshao0", "createdAt": "2020-09-09T17:46:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNTE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTgxODU1Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r485818553", "bodyText": "What does the RI do for the second call to hostClass.getNestHost() with the invalid nestHost?", "author": "DanHeidinga", "createdAt": "2020-09-09T18:11:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNTE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg0NDU4Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r485844583", "bodyText": "Interesting, I made 2 calls of hostClass.getNestHost(). I don't even see RI throw an exception on the first call, it directly returns hostclass itself. The second call has no exception either.", "author": "hangshao0", "createdAt": "2020-09-09T19:00:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNTE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg1MDEyOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r485850129", "bodyText": "OK, I've checked the javadoc of Class.getNestHost(), it only says SecurityException can be thrown, not matter it is first or second call.", "author": "hangshao0", "createdAt": "2020-09-09T19:10:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNTE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg1NTA0Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r485855046", "bodyText": "I wrote the following test case and I've tested it on both the RI and OpenJ9 using JDK14 (don't have a 15 build of the RI handy):\npublic class Out {\n\npublic static class In {\npublic static void main(String[] args) {\n\ttry {\n\t\tSystem.out.println(In.class.getNestHost());\n\t\tSystem.out.println(java.util.Arrays.toString(In.class.getNestMembers()));\n\t} catch (Throwable t) {\n\t\tt.printStackTrace();\n\t}\n\ttry {\n\t\tSystem.out.println(In.class.getNestHost());\n\t\tSystem.out.println(java.util.Arrays.toString(In.class.getNestMembers()));\n\t} catch (Throwable t) {\n\t\tt.printStackTrace();\n\t}\n}\n}\n}\nCompile it with: javac Out.java\nDelete Out.class: rm Out.class\nRun with java Out\\$In\nWith both VMs I get similar output:\n# java Out\\$In\nclass Out$In\njava.lang.NoClassDefFoundError: Unable to load nest-host class (Out) of Out$In\n\tat java.base/java.lang.Class.getNestMembers0(Native Method)\n\tat java.base/java.lang.Class.getNestMembers(Class.java:4146)\n\tat Out$In.main(Out.java:7)\nCaused by: java.lang.NoClassDefFoundError: Out\n\t... 3 more\nclass Out$In\njava.lang.NoClassDefFoundError: Unable to load nest-host class (Out) of Out$In\n\tat java.base/java.lang.Class.getNestMembers0(Native Method)\n\tat java.base/java.lang.Class.getNestMembers(Class.java:4146)\n\tat Out$In.main(Out.java:13)\nCaused by: java.lang.NoClassDefFoundError: Out\n\t... 3 more\n\nSo getNestHost() never throws for an invalid host but getNestMembers() does.  Is there behaviour different for the RI on JDK15?", "author": "DanHeidinga", "createdAt": "2020-09-09T19:19:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNTE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg2NzYyMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r485867622", "bodyText": "Yes, behaviour changed in JDK15. I run your test and get the same result on RI and openJ9 (with the change in this PR):\njava Out\\$In\nclass Out$In\n[class Out$In]\nclass Out$In\n[class Out$In]", "author": "hangshao0", "createdAt": "2020-09-09T19:37:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNTE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg3MTEyNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r485871127", "bodyText": "I guess I need to put this line clazzToUse->nestHost = nestHost; inside #if JAVA_SPEC_VERSION >= 15, so that all the change in the PR has effect only on JDK15 and up.", "author": "hangshao0", "createdAt": "2020-09-09T19:41:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNTE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg3NjIzOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r485876238", "bodyText": "Updated to put this line inside #if JAVA_SPEC_VERSION >= 15", "author": "hangshao0", "createdAt": "2020-09-09T19:47:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNTE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg5MjM3OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r485892378", "bodyText": "The behaviour is at least consistent for reflection if neither getNestHost or getNestMembers throws.  I would still prefer to see the write to clazz->nestHost happen in loadAndVerifyNestHost so that it's consistently handled in that code.  That's the single point that should be writing nestHost for runtime resolves (ie: apart from classes that start in their own nests)", "author": "DanHeidinga", "createdAt": "2020-09-09T20:08:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNTE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkwNjcyNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r485906726", "bodyText": "I checked the latest version of javadoc on Class.getNestMembers() in Java 15 from RI, they removed throwing LinkageError there. (Seems our javadoc needs to updated as well, I was checking our javadoc, which still says Class.getNestMembers() throws Linkage error). For java 15 and up, I changed the code to set clazz->nestHost to itself (host class for hidden class)  inside loadAndVerifyNestHost() if there is problem finding the nest host.", "author": "hangshao0", "createdAt": "2020-09-09T20:36:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNTE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkyNjg1Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r485926856", "bodyText": "PR to update Javadoc: #10554", "author": "hangshao0", "createdAt": "2020-09-09T21:16:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNTE5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE2OTUxNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r485169517", "bodyText": "Can you move this if earlier to before the while loop?  It makes it clearer this code only applies to hidden classes.", "author": "DanHeidinga", "createdAt": "2020-09-08T20:11:55Z", "path": "runtime/vm/visible.c", "diffHunk": "@@ -296,6 +296,18 @@ loadAndVerifyNestHost(J9VMThread *vmThread, J9Class *clazz, UDATA options)\n \t\t\tnestHostName = J9ROMCLASS_NESTHOSTNAME(curClazz->romClass);\n \t\t}\n \n+\t\tif (hiddenNestMate) {", "originalCommit": "f4ff501d9be74dd0c54e86247d495bde961f016a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE3OTUzNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r485179535", "bodyText": "Done.", "author": "hangshao0", "createdAt": "2020-09-08T20:32:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE2OTUxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE4Mjc5MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r485182790", "bodyText": "Also moved variable isCurClassHiddenNestMate inside to the if block.", "author": "hangshao0", "createdAt": "2020-09-08T20:38:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE2OTUxNw=="}], "type": "inlineReview"}, {"oid": "8d0d95f714671f44b6bd41690ac6526470e6d6e3", "url": "https://github.com/eclipse-openj9/openj9/commit/8d0d95f714671f44b6bd41690ac6526470e6d6e3", "message": "Fix LambdaNestedInnerTest\n\nReturn the host class as nesthost if a hidden class cannot find its \nnest host.\n\nissue #10345\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>", "committedDate": "2020-09-08T20:23:13Z", "type": "forcePushed"}, {"oid": "d9192b5c9d62165d63d58933ced55ea9ddcf9b53", "url": "https://github.com/eclipse-openj9/openj9/commit/d9192b5c9d62165d63d58933ced55ea9ddcf9b53", "message": "Fix LambdaNestedInnerTest\n\nReturn the host class as nesthost if a hidden class cannot find its \nnest host.\n\nissue #10345\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>", "committedDate": "2020-09-08T20:24:57Z", "type": "forcePushed"}, {"oid": "e5879568547174e3fdd4076b09034ee9b6220f85", "url": "https://github.com/eclipse-openj9/openj9/commit/e5879568547174e3fdd4076b09034ee9b6220f85", "message": "Fix LambdaNestedInnerTest\n\nReturn the host class as nesthost if a hidden class cannot find its \nnest host.\n\nissue #10345\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>", "committedDate": "2020-09-08T20:37:41Z", "type": "forcePushed"}, {"oid": "fb2a3339dc36a236953efe013f20e4e66e6f721a", "url": "https://github.com/eclipse-openj9/openj9/commit/fb2a3339dc36a236953efe013f20e4e66e6f721a", "message": "Fix LambdaNestedInnerTest\n\nReturn the host class as nesthost if a hidden class cannot find its \nnest host.\n\nissue #10345\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>", "committedDate": "2020-09-08T20:59:20Z", "type": "forcePushed"}, {"oid": "3e3c96608b3673ebb685e3282c2fab4da4e425f7", "url": "https://github.com/eclipse-openj9/openj9/commit/3e3c96608b3673ebb685e3282c2fab4da4e425f7", "message": "Fix LambdaNestedInnerTest\n\nReturn the host class as nesthost if a hidden class cannot find its \nnest host.\n\nissue #10345\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>", "committedDate": "2020-09-09T19:46:58Z", "type": "forcePushed"}, {"oid": "afd9b663745c11f0a719d9abfaa99494276a578a", "url": "https://github.com/eclipse-openj9/openj9/commit/afd9b663745c11f0a719d9abfaa99494276a578a", "message": "Fix LambdaNestedInnerTest\n\nReturn the host class as nesthost if a hidden class cannot find its \nnest host.\n\nissue #10345\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>", "committedDate": "2020-09-09T20:23:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkwNTIyNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r485905224", "bodyText": "Please add a comment here to reference the JVMS change that OKs this behaviour.  We want to explain that the exception is not rethrown if the nestHost is not accessible, it just means the class becomes it's own host.\nSee the Access Control section of the JDK15 JVMS:\n\nOtherwise,MhasaNestHostattribute,anditshost_class_indexitemisused as an index into the run-time constant pool of M. The symbolic reference at that index is resolved (\u00a75.4.3.1).\nIf resolution of the symbolic reference fails, then M is its own nest host. Any exception thrown as a result of failure of class or interface resolution is not rethrown.\n\nhttp://cr.openjdk.java.net/~iris/se/15/latestSpec/java-se-15-jvms-fr-diffs.pdf", "author": "DanHeidinga", "createdAt": "2020-09-09T20:33:20Z", "path": "runtime/vm/visible.c", "diffHunk": "@@ -343,6 +355,11 @@ loadAndVerifyNestHost(J9VMThread *vmThread, J9Class *clazz, UDATA options)\n \t\t/* If a problem occurred in nest host verification then the nest host value is invalid */\n \t\tif (J9_VISIBILITY_ALLOWED == result) {\n \t\t\tclazz->nestHost = nestHost;\n+\t\t} else if (J2SE_VERSION(vmThread->javaVM) >= J2SE_V15) {\n+\t\t\tclazz->nestHost = curClazz;", "originalCommit": "afd9b663745c11f0a719d9abfaa99494276a578a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkxMTg3MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r485911870", "bodyText": "Comment added.", "author": "hangshao0", "createdAt": "2020-09-09T20:46:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkwNTIyNA=="}], "type": "inlineReview"}, {"oid": "196608257e7e830cc42c9a535aac0cbe91036603", "url": "https://github.com/eclipse-openj9/openj9/commit/196608257e7e830cc42c9a535aac0cbe91036603", "message": "Fix LambdaNestedInnerTest\n\nReturn the host class as nesthost if a hidden class cannot find its \nnest host.\n\nissue #10345\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>", "committedDate": "2020-09-09T20:44:01Z", "type": "forcePushed"}, {"oid": "8a4468ad2513c7e3e1d7b8910483f34bc0a15a8f", "url": "https://github.com/eclipse-openj9/openj9/commit/8a4468ad2513c7e3e1d7b8910483f34bc0a15a8f", "message": "Fix LambdaNestedInnerTest\n\nReturn the host class as nesthost if a hidden class cannot find its \nnest host.\n\nDo not rethrown any exception if a class cannot find its nesthost \nin java 15 and up.\n\nissue #10345\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>", "committedDate": "2020-09-09T20:46:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAzOTIyMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r486039222", "bodyText": "Can you paraphrase this rather than directly including the JVMS quote here?", "author": "DanHeidinga", "createdAt": "2020-09-10T03:21:37Z", "path": "runtime/vm/visible.c", "diffHunk": "@@ -343,6 +355,17 @@ loadAndVerifyNestHost(J9VMThread *vmThread, J9Class *clazz, UDATA options)\n \t\t/* If a problem occurred in nest host verification then the nest host value is invalid */\n \t\tif (J9_VISIBILITY_ALLOWED == result) {\n \t\t\tclazz->nestHost = nestHost;\n+\t\t} else if (J2SE_VERSION(vmThread->javaVM) >= J2SE_V15) {\n+\t\t\t/** \n+\t\t\t * JVM spec updated in Java 15:\n+\t\t\t * M has a NestHost attribute, and its host_class_index item is used as an index into the run-time constant pool of M. The symbolic reference at that \n+\t\t\t * index is resolved (\ufffd5.4.3.1). If resolution of the symbolic reference fails, then M is its own nest host. Any exception thrown as a result of failure \n+\t\t\t * of class or interface resolution is not rethrown.", "originalCommit": "8a4468ad2513c7e3e1d7b8910483f34bc0a15a8f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQwNjU2OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10531#discussion_r486406569", "bodyText": "Fixed.", "author": "hangshao0", "createdAt": "2020-09-10T14:50:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAzOTIyMg=="}], "type": "inlineReview"}, {"oid": "faca3b49ac9875544a8a3a34a804975058ccb06e", "url": "https://github.com/eclipse-openj9/openj9/commit/faca3b49ac9875544a8a3a34a804975058ccb06e", "message": "Fix LambdaNestedInnerTest\n\nReturn the host class as nesthost if a hidden class cannot find its \nnest host.\n\nDo not rethrown any exception if a class cannot find its nesthost \nin java 15 and up.\n\nissue #10345\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>", "committedDate": "2020-09-10T14:49:45Z", "type": "forcePushed"}, {"oid": "1bc94be9ea4d6fbbb18776ba9ac7d04f7e31f6a0", "url": "https://github.com/eclipse-openj9/openj9/commit/1bc94be9ea4d6fbbb18776ba9ac7d04f7e31f6a0", "message": "Fix LambdaNestedInnerTest\n\nReturn the host class as nesthost if a hidden class cannot find its \nnest host.\n\nDo not rethrown any exception if a class cannot find its nesthost \nin java 15 and up.\n\nissue #10345\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>", "committedDate": "2020-09-10T18:16:26Z", "type": "forcePushed"}, {"oid": "4695e08e92a1d4250f44dd5fc374cb372dc1e946", "url": "https://github.com/eclipse-openj9/openj9/commit/4695e08e92a1d4250f44dd5fc374cb372dc1e946", "message": "Fix LambdaNestedInnerTest\n\nReturn the host class as nesthost if a hidden class cannot find its \nnest host.\n\nDo not rethrown any exception if a class cannot find its nesthost \nin java 15 and up.\n\nissue #10345\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>", "committedDate": "2020-09-10T20:44:35Z", "type": "forcePushed"}, {"oid": "4695e08e92a1d4250f44dd5fc374cb372dc1e946", "url": "https://github.com/eclipse-openj9/openj9/commit/4695e08e92a1d4250f44dd5fc374cb372dc1e946", "message": "Fix LambdaNestedInnerTest\n\nReturn the host class as nesthost if a hidden class cannot find its \nnest host.\n\nDo not rethrown any exception if a class cannot find its nesthost \nin java 15 and up.\n\nissue #10345\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>", "committedDate": "2020-09-10T20:44:35Z", "type": "commit"}]}