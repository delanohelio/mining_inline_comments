{"pr_number": 10742, "pr_title": "Add DupClassNameTest", "pr_createdAt": "2020-09-29T18:05:13Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10742", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA3NTI2MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10742#discussion_r497075261", "bodyText": "Do we need ADD_JVM_LIB_DIR_TO_LIBPATH ?", "author": "llxia", "createdAt": "2020-09-29T21:37:50Z", "path": "test/functional/Java8andUp/playlist.xml", "diffHunk": "@@ -2672,5 +2672,27 @@\n \t\t\t<impl>ibm</impl>\n \t\t</impls>\n \t</test>\n+\t\n+\t<test>\n+\t\t<testCaseName>DupClassNameTest</testCaseName>\n+\t\t<command>$(ADD_JVM_LIB_DIR_TO_LIBPATH) $(JAVA_COMMAND) $(JVM_OPTIONS) -Xshareclasses:name=DupClassNameTest,reset \\", "originalCommit": "4ca32a841f0e2bbc8f06168d46081e27b1903850", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzYwNzA0Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/10742#discussion_r497607046", "bodyText": "I removed ADD_JVM_LIB_DIR_TO_LIBPATH .", "author": "hangshao0", "createdAt": "2020-09-30T15:35:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA3NTI2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA3NTc2Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10742#discussion_r497075762", "bodyText": "Do we need asm-all.jar for this test?", "author": "llxia", "createdAt": "2020-09-29T21:38:58Z", "path": "test/functional/Java8andUp/playlist.xml", "diffHunk": "@@ -2672,5 +2672,27 @@\n \t\t\t<impl>ibm</impl>\n \t\t</impls>\n \t</test>\n+\t\n+\t<test>\n+\t\t<testCaseName>DupClassNameTest</testCaseName>\n+\t\t<command>$(ADD_JVM_LIB_DIR_TO_LIBPATH) $(JAVA_COMMAND) $(JVM_OPTIONS) -Xshareclasses:name=DupClassNameTest,reset \\\n+\t\t\t-cp $(Q)$(LIB_DIR)$(D)asm-all.jar$(P)$(RESOURCES_DIR)$(P)$(TESTNG)$(P)$(TEST_RESROOT)$(D)DupClassNameTest$(D)version1$(Q) \\", "originalCommit": "4ca32a841f0e2bbc8f06168d46081e27b1903850", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzYxMzU4Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10742#discussion_r497613582", "bodyText": "No. Removed. Also removed RESOURCES_DIR.\nSeems that TESTNG include testng.jar and jcommander.jar, but in build.xml the class DupClassNameTest is compiled with only testng.jar. It is working now. Not sure if it will cause any issue in the future.\n<pathelement location=\"${LIB_DIR}/testng.jar\" />", "author": "hangshao0", "createdAt": "2020-09-30T15:43:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA3NTc2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA3OTc2Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10742#discussion_r497079762", "bodyText": "Could we use Logger instead? It will help us to control the amount of msg in the console.\nExample: https://github.com/eclipse/openj9/blob/2f295ea91cdd97ff37eb5d164fc63014ea718bc7/test/functional/Jsr335/src/org/openj9/test/jsr335/defineAnonClass/BasicClass.java#L37", "author": "llxia", "createdAt": "2020-09-29T21:46:55Z", "path": "test/functional/Java8andUp/scr_DupClassNameTest/version2/DupClassNameTest.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020, 2020 IBM Corp. and others\n+ *\n+ * This program and the accompanying materials are made available under\n+ * the terms of the Eclipse Public License 2.0 which accompanies this\n+ * distribution and is available at https://www.eclipse.org/legal/epl-2.0/\n+ * or the Apache License, Version 2.0 which accompanies this distribution and\n+ * is available at https://www.apache.org/licenses/LICENSE-2.0.\n+ *\n+ * This Source Code may also be made available under the following\n+ * Secondary Licenses when the conditions for such availability set\n+ * forth in the Eclipse Public License, v. 2.0 are satisfied: GNU\n+ * General Public License, version 2 with the GNU Classpath\n+ * Exception [1] and GNU General Public License, version 2 with the\n+ * OpenJDK Assembly Exception [2].\n+ *\n+ * [1] https://www.gnu.org/software/classpath/license.html\n+ * [2] http://openjdk.java.net/legal/assembly-exception.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-exception-2.0 OR LicenseRef-GPL-2.0 WITH Assembly-exception\n+ *******************************************************************************/\n+public class DupClassNameTest {\n+\tpublic static void printStackTrace() {\n+\t\tSystem.out.println(\"running method printStackTrace of DupClassNameTest version2:\");\n+\t\tStackTraceElement[] st = Thread.currentThread().getStackTrace();\n+\t\tfor (StackTraceElement element : st) {\n+\t\t\tSystem.out.println(element);", "originalCommit": "4ca32a841f0e2bbc8f06168d46081e27b1903850", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzYxNDA0Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10742#discussion_r497614043", "bodyText": "Removed.", "author": "hangshao0", "createdAt": "2020-09-30T15:44:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA3OTc2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA4MDg3OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10742#discussion_r497080878", "bodyText": "We have msg for start and finish. Additional msg for start and finish may not be needed.\nDupClassNameTest_0 Start Time: Tue Sep 29 08:21:07 2020 Epoch Time (ms): 1601392867209\n\nDupClassNameTest_0 Finish Time: Tue Sep 29 08:21:09 2020 Epoch Time (ms): 1601392869218", "author": "llxia", "createdAt": "2020-09-29T21:49:27Z", "path": "test/functional/Java8andUp/scr_DupClassNameTest/version1/DupClassNameTest.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020, 2020 IBM Corp. and others\n+ *\n+ * This program and the accompanying materials are made available under\n+ * the terms of the Eclipse Public License 2.0 which accompanies this\n+ * distribution and is available at https://www.eclipse.org/legal/epl-2.0/\n+ * or the Apache License, Version 2.0 which accompanies this distribution and\n+ * is available at https://www.apache.org/licenses/LICENSE-2.0.\n+ *\n+ * This Source Code may also be made available under the following\n+ * Secondary Licenses when the conditions for such availability set\n+ * forth in the Eclipse Public License, v. 2.0 are satisfied: GNU\n+ * General Public License, version 2 with the GNU Classpath\n+ * Exception [1] and GNU General Public License, version 2 with the\n+ * OpenJDK Assembly Exception [2].\n+ *\n+ * [1] https://www.gnu.org/software/classpath/license.html\n+ * [2] http://openjdk.java.net/legal/assembly-exception.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-exception-2.0 OR LicenseRef-GPL-2.0 WITH Assembly-exception\n+ *******************************************************************************/\n+\n+import java.io.File;\n+import java.lang.reflect.Method;\n+import java.net.URL;\n+import java.net.URLClassLoader;\n+import org.testng.annotations.Test;\n+import org.testng.Assert;\n+\n+/*\n+ * Test for this change: https://github.com/eclipse/openj9/pull/10687\n+ * There are 2 classes with the same name (DupClassNameTest), which are loaded by 2 different class loaders.\n+ * This file is under directory version1, the other version of DupClassNameTest is under directory version2.\n+ */\n+@Test(groups = { \"level.sanity\" })\n+public class DupClassNameTest {\n+\tstatic Class<?> loadClassOfAnotherVersion(String resourceLocation) throws Throwable {\n+\t\tFile dir = new File(resourceLocation);\n+\t\tClass<?> clazz = null;\n+\t\tif (!dir.exists()) {\n+\t\t\tAssert.fail(resourceLocation + \" does not exist !\");\n+\t\t}\n+\t\tURL[] url = new URL[] {dir.toURI().toURL()};\n+\t\tURLClassLoader loader = new URLClassLoader(url, null);\n+\t\tclazz = loader.loadClass(\"DupClassNameTest\");\n+\t\treturn clazz;\n+\t\t\n+\t}\n+\t/**\n+\t * Load another version of class DupClassNameTest under version2 directory \n+\t * and run its printStackTrace() method.\n+\t *\n+\t * @throws Throwable\n+\t */\n+\t@Test\n+\tpublic static void runTest() throws Throwable {\n+\t\tSystem.out.println(\"DupClassNameTest Test Started\");\n+\t\tString resourceLocation = DupClassNameTest.class.getProtectionDomain().getCodeSource().getLocation().getPath();\n+\t\tint index = resourceLocation.lastIndexOf(\"version1\");\n+\t\tStringBuilder sb = new StringBuilder();\n+\t\tsb.append(resourceLocation.substring(0, index));\n+\t\tsb.append(\"version2\");\n+\t\tresourceLocation = sb.toString();\n+\t\tClass<?> clazz = loadClassOfAnotherVersion(resourceLocation);\n+\t\tMethod m = clazz.getMethod(\"printStackTrace\", (Class[])null);\n+\t\tm.invoke(null, (Object[])null);\n+\t\tSystem.out.println(\"DupClassNameTest Test Finished\");", "originalCommit": "4ca32a841f0e2bbc8f06168d46081e27b1903850", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzYxNDQwOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10742#discussion_r497614408", "bodyText": "The println are removed.", "author": "hangshao0", "createdAt": "2020-09-30T15:45:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA4MDg3OA=="}], "type": "inlineReview"}, {"oid": "f239d1f172df62f8633a623bc01766f60dd047aa", "url": "https://github.com/eclipse-openj9/openj9/commit/f239d1f172df62f8633a623bc01766f60dd047aa", "message": "Add DupClassNameTest\n\nAdd a test that there are 2 different classes with the \nsame name loaded by 2 different class loaders.\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>", "committedDate": "2020-09-30T15:25:12Z", "type": "commit"}, {"oid": "f239d1f172df62f8633a623bc01766f60dd047aa", "url": "https://github.com/eclipse-openj9/openj9/commit/f239d1f172df62f8633a623bc01766f60dd047aa", "message": "Add DupClassNameTest\n\nAdd a test that there are 2 different classes with the \nsame name loaded by 2 different class loaders.\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>", "committedDate": "2020-09-30T15:25:12Z", "type": "forcePushed"}]}