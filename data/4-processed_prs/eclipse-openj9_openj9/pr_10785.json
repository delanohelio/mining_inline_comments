{"pr_number": 10785, "pr_title": "Only read J9Method.extra once", "pr_createdAt": "2020-10-05T18:25:35Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10785", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc5MjY5Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10785#discussion_r499792692", "bodyText": "Note, this method is called while holding exclusiveVMAccess so it shouldn't matter whether the extra field is reread or not.", "author": "DanHeidinga", "createdAt": "2020-10-05T18:32:06Z", "path": "runtime/codert_vm/decomp.cpp", "diffHunk": "@@ -259,10 +259,11 @@ jitResetAllMethods(J9VMThread *currentThread)\n \t\tU_32 methodCount = clazz->romClass->romMethodCount;\n \n \t\twhile (methodCount != 0) {\n-\t\t\tif (0 == ((UDATA)method->extra & J9_STARTPC_NOT_TRANSLATED)) {\n+\t\t\tUDATA extra = (UDATA)method->extra;", "originalCommit": "19f1f6790fdffb45980e7c5c48532c7722260019", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTgwOTk4MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10785#discussion_r499809981", "bodyText": "I don't believe the comp thread holds exclusive vm access when it updates the start PC, so even if this thread holds exclusive VM Access, the compilation thread could still update the start PC when it calls jitMethodTranslated.", "author": "dsouzai", "createdAt": "2020-10-05T19:04:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc5MjY5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTgyMDcwNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10785#discussion_r499820705", "bodyText": "I've been looking through the JIT code and I don't see it acquire / release vm access which is surprising to me.  I wouldn't expect the JIT to get exclusive, but I would have expected \"regular\" shared vmaccess", "author": "DanHeidinga", "createdAt": "2020-10-05T19:25:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc5MjY5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTgyMjg0NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10785#discussion_r499822844", "bodyText": "@gacholio do you know what the contract for jitMethodTranslated is - whether it needs to hold vmaccess or not?", "author": "DanHeidinga", "createdAt": "2020-10-05T19:29:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc5MjY5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTgyNDQ5NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10785#discussion_r499824495", "bodyText": "Found it:\nhttps://github.com/eclipse/openj9/blob/05119f696f85cc2137d451e4b6001b94c929b29a/runtime/compiler/control/CompilationThread.cpp#L10052-L10056\nI haven't dug back far enough to see the acquire vm access call but the comment indicates this should only occur under vmaccess", "author": "DanHeidinga", "createdAt": "2020-10-05T19:32:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc5MjY5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTgyOTQ1Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/10785#discussion_r499829456", "bodyText": "Yes, that's right.", "author": "gacholio", "createdAt": "2020-10-05T19:42:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc5MjY5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg0MDkyMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10785#discussion_r499840923", "bodyText": "Looks like there's a comment at the top of compilationEnd that states that vmaccess must be acquired. It looks like this happens quite high up, so I guess at this point in the code, we must have vmaccess in hand.\nEDIT: Didn't see that Dan linked the code above.", "author": "dsouzai", "createdAt": "2020-10-05T20:04:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc5MjY5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg0ODAzOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10785#discussion_r499848039", "bodyText": "Want to put these changes back in?  My comment at the top of the review was:\n\nNote, that most of these changes aren't required as the access occur under exclusive but they help set the principle in the code base that we privatize extra before using it.\n\nI like the principle being set that we always privatize use of extra so I'd prefer to keep these changes.", "author": "DanHeidinga", "createdAt": "2020-10-05T20:18:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc5MjY5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg3NjYxNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10785#discussion_r499876616", "bodyText": "Ah I see; got confused because the fact about exclusive vmaccess was explicitly noted.", "author": "dsouzai", "createdAt": "2020-10-05T21:15:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc5MjY5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc5NDU0MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10785#discussion_r499794540", "bodyText": "Similarly, this method is also called under exclusive", "author": "DanHeidinga", "createdAt": "2020-10-05T18:35:39Z", "path": "runtime/codert_vm/decomp.cpp", "diffHunk": "@@ -1575,11 +1576,12 @@ static void\n markMethodBreakpointed(J9VMThread * currentThread, J9JITBreakpointedMethod * breakpointedMethod)\n {\n \tJ9Method * method = breakpointedMethod->method;\n+\tvoid * extra = method->extra;", "originalCommit": "19f1f6790fdffb45980e7c5c48532c7722260019", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc5NzIxMQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10785#discussion_r499797211", "bodyText": "We don't need to introduce a new local for extra here.  Better to reuse frameBuilder:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \tUDATA extra = (UDATA)currentMethod->extra;\n          \n          \n            \n            \tif ((extra & J9_STARTPC_NOT_TRANSLATED) != J9_STARTPC_NOT_TRANSLATED) {\n          \n          \n            \n            \t\tframeBuilder = extra;\n          \n          \n            \n            \tUDATA frameBuilder = (UDATA)currentMethod->extra;\n          \n          \n            \n            \tif ((frameBuilder & J9_STARTPC_NOT_TRANSLATED) != J9_STARTPC_NOT_TRANSLATED) {\n          \n      \n    \n    \n  \n\nNote also that this is during class creation so the ramClass hasn't \"escaped\" to anyone else who can modify it yet", "author": "DanHeidinga", "createdAt": "2020-10-05T18:40:48Z", "path": "runtime/vm/createramclass.cpp", "diffHunk": "@@ -1127,8 +1127,9 @@ fillJITVTableSlot(J9VMThread *vmStruct, UDATA *currentSlot, J9Method *currentMet\n {\n \tJ9JITConfig *jitConfig = vmStruct->javaVM->jitConfig;\n \tUDATA frameBuilder;\n-\tif (((UDATA)currentMethod->extra & J9_STARTPC_NOT_TRANSLATED) != J9_STARTPC_NOT_TRANSLATED) {\n-\t\tframeBuilder = (UDATA)currentMethod->extra;\n+\tUDATA extra = (UDATA)currentMethod->extra;\n+\tif ((extra & J9_STARTPC_NOT_TRANSLATED) != J9_STARTPC_NOT_TRANSLATED) {\n+\t\tframeBuilder = extra;", "originalCommit": "19f1f6790fdffb45980e7c5c48532c7722260019", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "444db2b24da3e67967da09f1502b0d5e46d69455", "url": "https://github.com/eclipse-openj9/openj9/commit/444db2b24da3e67967da09f1502b0d5e46d69455", "message": "Only read J9Method.extra once\n\nSigned-off-by: Irwin D'Souza <dsouzai.gh@gmail.com>", "committedDate": "2020-10-05T20:08:36Z", "type": "forcePushed"}, {"oid": "0b98c0cdfe4e125ac85320f50e391c33dde096da", "url": "https://github.com/eclipse-openj9/openj9/commit/0b98c0cdfe4e125ac85320f50e391c33dde096da", "message": "Only read J9Method.extra once\n\nSigned-off-by: Irwin D'Souza <dsouzai.gh@gmail.com>", "committedDate": "2020-10-05T21:16:14Z", "type": "commit"}, {"oid": "0b98c0cdfe4e125ac85320f50e391c33dde096da", "url": "https://github.com/eclipse-openj9/openj9/commit/0b98c0cdfe4e125ac85320f50e391c33dde096da", "message": "Only read J9Method.extra once\n\nSigned-off-by: Irwin D'Souza <dsouzai.gh@gmail.com>", "committedDate": "2020-10-05T21:16:14Z", "type": "forcePushed"}]}