{"pr_number": 11323, "pr_title": "Use fewer compilation threads at client when JITServer is low on memory", "pr_createdAt": "2020-12-01T19:26:51Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/11323", "timeline": [{"oid": "02384daf5119b242a252705725f0cc0f0b636bdf", "url": "https://github.com/eclipse-openj9/openj9/commit/02384daf5119b242a252705725f0cc0f0b636bdf", "message": "Use fewer compilation threads at client when JITServer is low on memory\n\nWhen the JITServer starts running low on physical memory, it is\ndetrimental for clients to have all compilation threads active and\nsending requests because it makes JITServer use too many compilation\nthreads which consume a lot of memory.\n\nAt the end of each compilation, server tells the client if it's low\non physical memory. As long as that's the case, client will not\nactivate a new compilation thread and will keep suspending the existing\nones until only one thread is active.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-12-01T19:31:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc5OTExNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/11323#discussion_r533799117", "bodyText": "We could mark this one as const", "author": "mpirvu", "createdAt": "2020-12-01T23:49:15Z", "path": "runtime/compiler/control/CompilationRuntime.hpp", "diffHunk": "@@ -1048,6 +1048,9 @@ class CompilationInfo\n    void  addJITServerSslCert(const std::string &cert) { _sslCerts.push_back(cert); }\n    const std::string &getJITServerSslRootCerts() const { return _sslRootCerts; }\n    void  setJITServerSslRootCerts(const std::string &cert) { _sslRootCerts = cert; }\n+\n+   bool serverHasLowPhysicalMemory() { return _serverHasLowPhysicalMemory; }", "originalCommit": "02384daf5119b242a252705725f0cc0f0b636bdf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzgwMzUwMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/11323#discussion_r533803500", "bodyText": "I would move this piece of code up where the 'NO' decisions are taken. As it is now, we may take the path that leads to TR_yes above.", "author": "mpirvu", "createdAt": "2020-12-02T00:00:45Z", "path": "runtime/compiler/control/CompilationThread.cpp", "diffHunk": "@@ -549,6 +549,10 @@ TR_YesNoMaybe TR::CompilationInfo::shouldActivateNewCompThread()\n #if defined(J9VM_OPT_JITSERVER)\n       else if (getPersistentInfo()->getRemoteCompilationMode() == JITServer::CLIENT && JITServerHelpers::isServerAvailable())\n          {\n+         // If the available memory on the server is low, do not activate more threads", "originalCommit": "02384daf5119b242a252705725f0cc0f0b636bdf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzgwNzI5NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/11323#discussion_r533807294", "bodyText": "TR_VerboseLog::writeLineLocked needs another %s for the new string. It gets tricky though due to the ifdef. I am ok with being a little imprecise and say just \"LowPhysicalMem\", but the decision should come from either the local JVM and or the remote server:\nbool lowPhysicalMem = compInfo->getSuspendThreadDueToLowPhysicalMemory();\n#if defined(J9VM_OPT_JITSERVER)\nlowPhysicalMem = lowPhysicalMem || compInfo->serverHasLowPhysicalMemory();\n#endif", "author": "mpirvu", "createdAt": "2020-12-02T00:11:26Z", "path": "runtime/compiler/control/CompilationThread.cpp", "diffHunk": "@@ -4406,7 +4415,11 @@ TR::CompilationInfoPerThread::processEntry(TR_MethodToBeCompiled &entry, J9::J9S\n             compInfo->getQueueWeight(),\n             compInfo->getNumCompThreadsActive(),\n             compInfo->getRampDownMCT() ? \"RampDownMCT\" : \"\",\n-            compInfo->getSuspendThreadDueToLowPhysicalMemory() ? \"LowPhysicalMem\" : \"\");\n+            compInfo->getSuspendThreadDueToLowPhysicalMemory() ? \"LowPhysicalMem\" : \"\",\n+#if defined(J9VM_OPT_JITSERVER)\n+            compInfo->serverHasLowPhysicalMemory() ? \"ServerLowPhysicalMem\" : \"\"", "originalCommit": "02384daf5119b242a252705725f0cc0f0b636bdf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzgyMDU2NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11323#discussion_r533820565", "bodyText": "Yeah, or we could print an empty string if JITServer is not enabled:\n   compInfo->getRampDownMCT() ? \"RampDownMCT\" : \"\",\n   compInfo->getSuspendThreadDueToLowPhysicalMemory() ? \"LowPhysicalMem\" : \"\",\n#if defined(J9VM_OPT_JITSERVER)\n   compInfo->serverHasLowPhysicalMemory() ? \"ServerLowPhysicalMem\" :\n#endif\n    \"\"", "author": "dmitry-ten", "createdAt": "2020-12-02T00:49:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzgwNzI5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDE1ODc2Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/11323#discussion_r534158762", "bodyText": "I am fine either way", "author": "mpirvu", "createdAt": "2020-12-02T13:17:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzgwNzI5NA=="}], "type": "inlineReview"}, {"oid": "1013f40485982dbb2b521370cc0fef389b23136f", "url": "https://github.com/eclipse-openj9/openj9/commit/1013f40485982dbb2b521370cc0fef389b23136f", "message": "Use fewer compilation threads at client when JITServer is low on memory\n\nWhen the JITServer starts running low on physical memory, it is\ndetrimental for clients to have all compilation threads active and\nsending requests because it makes JITServer use too many compilation\nthreads which consume a lot of memory.\n\nAt the end of each compilation, server tells the client if it's low\non physical memory. As long as that's the case, client will not\nactivate a new compilation thread and will keep suspending the existing\nones until only one thread is active.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-12-02T15:48:24Z", "type": "commit"}, {"oid": "1013f40485982dbb2b521370cc0fef389b23136f", "url": "https://github.com/eclipse-openj9/openj9/commit/1013f40485982dbb2b521370cc0fef389b23136f", "message": "Use fewer compilation threads at client when JITServer is low on memory\n\nWhen the JITServer starts running low on physical memory, it is\ndetrimental for clients to have all compilation threads active and\nsending requests because it makes JITServer use too many compilation\nthreads which consume a lot of memory.\n\nAt the end of each compilation, server tells the client if it's low\non physical memory. As long as that's the case, client will not\nactivate a new compilation thread and will keep suspending the existing\nones until only one thread is active.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-12-02T15:48:24Z", "type": "forcePushed"}]}