{"pr_number": 8646, "pr_title": "Fix bug in resolution of VT arrays and fields", "pr_createdAt": "2020-02-24T23:05:28Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/8646", "timeline": [{"oid": "cecc362b551a1d7255adbc7e3d818d097818c58f", "url": "https://github.com/eclipse-openj9/openj9/commit/cecc362b551a1d7255adbc7e3d818d097818c58f", "message": "Fix bug in resolution of VT arrays and fields\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>", "committedDate": "2020-02-24T23:05:39Z", "type": "forcePushed"}, {"oid": "2565fc95cff6d02c2c2c2840f220051d789ae8d6", "url": "https://github.com/eclipse-openj9/openj9/commit/2565fc95cff6d02c2c2c2840f220051d789ae8d6", "message": "Fix bug in resolution of VT arrays and fields\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>", "committedDate": "2020-02-24T23:06:24Z", "type": "forcePushed"}, {"oid": "c58626c60e5d72419fa368ad8d39d3f22b66470b", "url": "https://github.com/eclipse-openj9/openj9/commit/c58626c60e5d72419fa368ad8d39d3f22b66470b", "message": "Fix bug in resolution of VT arrays and fields\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>", "committedDate": "2020-02-24T23:09:42Z", "type": "forcePushed"}, {"oid": "7612a2547b239aa248dd2b5638e5463147c06d1b", "url": "https://github.com/eclipse-openj9/openj9/commit/7612a2547b239aa248dd2b5638e5463147c06d1b", "message": "Fix bug in resolution of VT arrays and fields\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>", "committedDate": "2020-02-24T23:12:53Z", "type": "forcePushed"}, {"oid": "23aaf534f7d52b5c185e2e13f7f5226886632858", "url": "https://github.com/eclipse-openj9/openj9/commit/23aaf534f7d52b5c185e2e13f7f5226886632858", "message": "Fix bug in resolution of VT arrays and fields\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>", "committedDate": "2020-02-24T23:14:30Z", "type": "forcePushed"}, {"oid": "1206e1d5a1695a23094120481387a933dd18d8be", "url": "https://github.com/eclipse-openj9/openj9/commit/1206e1d5a1695a23094120481387a933dd18d8be", "message": "Fix bug in resolution of VT arrays and fields\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>", "committedDate": "2020-02-25T14:47:56Z", "type": "forcePushed"}, {"oid": "ebc83d16a7c278d9d3413d1108d9b44893e5d7c8", "url": "https://github.com/eclipse-openj9/openj9/commit/ebc83d16a7c278d9d3413d1108d9b44893e5d7c8", "message": "Fix bug in resolution of VT arrays and fields\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>", "committedDate": "2020-02-25T14:49:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzk3MDE2OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8646#discussion_r383970168", "bodyText": "You probably want to pass in J9_RESOLVE_FLAG_INIT_CLASS as well here to avoid going around the loop again.", "author": "gacholio", "createdAt": "2020-02-25T15:55:36Z", "path": "runtime/vm/BytecodeInterpreter.hpp", "diffHunk": "@@ -7591,10 +7595,18 @@ done:;\n \t\t\t}\n \t\t\tgoto retry;\n \t\t}\n-\t\t/* Unresolved */\n+\t\t/* Unresolved or requires initialization in the VT case */\n \t\tbuildGenericSpecialStackFrame(REGISTER_ARGS, 0);\n \t\tupdateVMStruct(REGISTER_ARGS);\n-\t\tresolveClassRef(_currentThread, ramConstantPool, index, J9_RESOLVE_FLAG_RUNTIME_RESOLVE);\n+#if defined(J9VM_OPT_VALHALLA_VALUE_TYPES)\n+\t\tif (NULL == resolvedClass) {\n+#endif /* defined(J9VM_OPT_VALHALLA_VALUE_TYPES) */\n+\t\t\tresolveClassRef(_currentThread, ramConstantPool, index, J9_RESOLVE_FLAG_RUNTIME_RESOLVE);", "originalCommit": "ebc83d16a7c278d9d3413d1108d9b44893e5d7c8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "588ae4a4027a84ccaee99a3569196f3ef317e2f5", "url": "https://github.com/eclipse-openj9/openj9/commit/588ae4a4027a84ccaee99a3569196f3ef317e2f5", "message": "Fix bug in resolution of VT arrays and fields\n\nWhen creating an array the elements of the array are set to the default\nvalue. For arrays of regular identity types this is NULL. For arrays of\nvalueTypes this is the defaultValue of the valueType. As a result, if\nthe element type of the array is a valueType, the element type must be\nfully initialized before the array can be created. This PR addresses\nthis problem.\n\nAlso, in the resolveSupport code, it is incorrectly fetching the\nflattened field cache from the class where the fieldref is stored\ninstead of the class that defined the field. We havent noticed this\nbecause the existing tests only fetches fields using getter methods.\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>", "committedDate": "2020-02-25T16:57:53Z", "type": "forcePushed"}, {"oid": "51f24d07dc54f3d44e2b499b4a67ca48c7348718", "url": "https://github.com/eclipse-openj9/openj9/commit/51f24d07dc54f3d44e2b499b4a67ca48c7348718", "message": "Fix bug in resolution of VT arrays and fields\n\nWhen creating an array the elements of the array are set to the default\nvalue. For arrays of regular identity types this is NULL. For arrays of\nvalueTypes this is the defaultValue of the valueType. As a result, if\nthe element type of the array is a valueType, the element type must be\nfully initialized before the array can be created. This PR addresses\nthis problem.\n\nAlso, in the resolveSupport code, it is incorrectly fetching the\nflattened field cache from the class where the fieldref is stored\ninstead of the class that defined the field. We havent noticed this\nbecause the existing tests only fetches fields using getter methods.\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>", "committedDate": "2020-02-25T16:59:41Z", "type": "forcePushed"}, {"oid": "3bf2a0a15f253ce27bb2e2cfb2b4fbc959cc4d18", "url": "https://github.com/eclipse-openj9/openj9/commit/3bf2a0a15f253ce27bb2e2cfb2b4fbc959cc4d18", "message": "Fix bug in resolution of VT arrays and fields\n\nWhen creating an array the elements of the array are set to the default\nvalue. For arrays of regular identity types this is NULL. For arrays of\nvalueTypes this is the defaultValue of the valueType. As a result, if\nthe element type of the array is a valueType, the element type must be\nfully initialized before the array can be created. This PR addresses\nthis problem.\n\nAlso, in the resolveSupport code, it is incorrectly fetching the\nflattened field cache from the class where the fieldref is stored\ninstead of the class that defined the field. We havent noticed this\nbecause the existing tests only fetches fields using getter methods.\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>", "committedDate": "2020-02-25T17:07:24Z", "type": "forcePushed"}, {"oid": "8c51d99e064ae7024c0524f6548d00dd2fb4d2c4", "url": "https://github.com/eclipse-openj9/openj9/commit/8c51d99e064ae7024c0524f6548d00dd2fb4d2c4", "message": "Fix bug in resolution of VT arrays and fields\n\nWhen creating an array the elements of the array are set to the default\nvalue. For arrays of regular identity types this is NULL. For arrays of\nvalueTypes this is the defaultValue of the valueType. As a result, if\nthe element type of the array is a valueType, the element type must be\nfully initialized before the array can be created. This PR addresses\nthis problem.\n\nAlso, in the resolveSupport code, it is incorrectly fetching the\nflattened field cache from the class where the fieldref is stored\ninstead of the class that defined the field. We havent noticed this\nbecause the existing tests only fetches fields using getter methods.\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>", "committedDate": "2020-02-25T17:08:30Z", "type": "forcePushed"}, {"oid": "4a78a69c32b26d88fe47245d703f32021c5d11d2", "url": "https://github.com/eclipse-openj9/openj9/commit/4a78a69c32b26d88fe47245d703f32021c5d11d2", "message": "Fix bug in resolution of VT arrays and fields\n\nWhen creating an array the elements of the array are set to the default\nvalue. For arrays of regular identity types this is NULL. For arrays of\nvalueTypes this is the defaultValue of the valueType. As a result, if\nthe element type of the array is a valueType, the element type must be\nfully initialized before the array can be created. This PR addresses\nthis problem.\n\nAlso, in the resolve field code, it is incorrectly fetching the\nflattened field cache from the class where the fieldref is stored\ninstead of the class that defined the field. We havent noticed this\nbecause the existing tests only fetches fields using getter methods.\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>", "committedDate": "2020-02-25T17:12:14Z", "type": "forcePushed"}, {"oid": "2e82d3575afbace84eca34942453eca4b8c7485d", "url": "https://github.com/eclipse-openj9/openj9/commit/2e82d3575afbace84eca34942453eca4b8c7485d", "message": "Fix bug in resolution of VT arrays and fields\n\nWhen creating an array the elements of the array are set to the default\nvalue. For arrays of regular identity types this is NULL. For arrays of\nvalueTypes this is the defaultValue of the valueType. As a result, if\nthe element type of the array is a valueType, the element type must be\nfully initialized before the array can be created. This PR addresses\nthis problem.\n\nAlso, in the resolveSupport code, it is incorrectly fetching the\nflattened field cache from the class where the fieldref is stored\ninstead of the class that defined the field. We havent noticed this\nbecause the existing tests only fetches fields using getter methods.\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>", "committedDate": "2020-02-25T17:10:21Z", "type": "forcePushed"}, {"oid": "10353047a203c1a4725bfaa5b7afbd013bf690f0", "url": "https://github.com/eclipse-openj9/openj9/commit/10353047a203c1a4725bfaa5b7afbd013bf690f0", "message": "Fix bug in resolution of VT arrays and fields\n\nWhen creating an array the elements of the array are set to the default\nvalue. For arrays of regular identity types this is NULL. For arrays of\nvalueTypes this is the defaultValue of the valueType. As a result, if\nthe element type of the array is a valueType, the element type must be\nfully initialized before the array can be created. This PR addresses\nthis problem.\n\nAlso, in the resolve field code, it is incorrectly fetching the\nflattened field cache from the class where the fieldref is stored\ninstead of the class that defined the field. We havent noticed this\nbecause the existing tests only fetches fields using getter methods.\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>", "committedDate": "2020-02-25T17:20:43Z", "type": "forcePushed"}, {"oid": "a3cf7770cbd2292e6a9416aefc81e7c76b1416dc", "url": "https://github.com/eclipse-openj9/openj9/commit/a3cf7770cbd2292e6a9416aefc81e7c76b1416dc", "message": "Fix bug in resolution of VT arrays and fields\n\nWhen creating an array the elements of the array are set to the default\nvalue. For arrays of regular identity types this is NULL. For arrays of\nvalueTypes this is the defaultValue of the valueType. As a result, if\nthe element type of the array is a valueType, the element type must be\nfully initialized before the array can be created. This PR addresses\nthis problem.\n\nAlso, in the resolve field code, it is incorrectly fetching the\nflattened field cache from the class where the fieldref is stored\ninstead of the class that defined the field. We havent noticed this\nbecause the existing tests only fetches fields using getter methods.\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>", "committedDate": "2020-02-25T17:31:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDEyOTE0OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8646#discussion_r384129148", "bodyText": "If this fails, you should probably return NULL (presumably the caller already has to handle any pending exceptions). Check pending exception here and set result to NULL (and re-NULL the arrayClass field).\n@DanHeidinga Any issue you can see here? We won't allow another attempt to initialize the VT class, so the failure should be persistent.", "author": "gacholio", "createdAt": "2020-02-25T21:13:20Z", "path": "runtime/vm/classsupport.c", "diffHunk": "@@ -226,6 +226,20 @@ internalCreateArrayClass(J9VMThread* vmThread, J9ROMArrayClass* romClass, J9Clas\n \t\tLOAD_LOCATION_UNKNOWN,\n \t\tNULL,\n \t\tNULL);\n+\n+#if defined(J9VM_OPT_VALHALLA_VALUE_TYPES)\n+\t/* When creating an array of valuetype elements, the array elements are initialized to the defaultValue of the\n+\t * element type. As a result the element type must be fully initialized (if its a valuetype) before creating an\n+\t * instance of the array.\n+\t */\n+\tif ((NULL != result) && J9_IS_J9CLASS_VALUETYPE(elementClass)) {\n+\t\tUDATA initStatus = elementClass->initializeStatus;\n+\t\tif ((J9ClassInitSucceeded != initStatus) && ((UDATA)vmThread != initStatus)) {\n+\t\t\tinitializeClass(vmThread, elementClass);", "originalCommit": "a3cf7770cbd2292e6a9416aefc81e7c76b1416dc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f00dfdf19041f13125608681f75ede8c97455164", "url": "https://github.com/eclipse-openj9/openj9/commit/f00dfdf19041f13125608681f75ede8c97455164", "message": "Fix bug in resolution of VT arrays and fields\n\nWhen creating an array the elements of the array are set to the default\nvalue. For arrays of regular identity types this is NULL. For arrays of\nvalueTypes this is the defaultValue of the valueType. As a result, if\nthe element type of the array is a valueType, the element type must be\nfully initialized before the array can be created. This PR addresses\nthis problem.\n\nAlso, in the resolve field code, it is incorrectly fetching the\nflattened field cache from the class where the fieldref is stored\ninstead of the class that defined the field. We havent noticed this\nbecause the existing tests only fetches fields using getter methods.\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>", "committedDate": "2020-02-25T22:58:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDI1NjIxNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/8646#discussion_r384256216", "bodyText": "This is problematic - there's a timing hole where the array class would be visible to another thread before being NULLed.\nProbably the answer is to initialize the VT class before starting to create the array class.", "author": "gacholio", "createdAt": "2020-02-26T03:23:27Z", "path": "runtime/vm/classsupport.c", "diffHunk": "@@ -226,6 +226,24 @@ internalCreateArrayClass(J9VMThread* vmThread, J9ROMArrayClass* romClass, J9Clas\n \t\tLOAD_LOCATION_UNKNOWN,\n \t\tNULL,\n \t\tNULL);\n+\n+#if defined(J9VM_OPT_VALHALLA_VALUE_TYPES)\n+\t/* When creating an array of valuetype elements, the array elements are initialized to the defaultValue of the\n+\t * element type. As a result the element type must be fully initialized (if its a valuetype) before creating an\n+\t * instance of the array.\n+\t */\n+\tif ((NULL != result) && J9_IS_J9CLASS_VALUETYPE(elementClass)) {\n+\t\tUDATA initStatus = elementClass->initializeStatus;\n+\t\tif ((J9ClassInitSucceeded != initStatus) && ((UDATA)vmThread != initStatus)) {\n+\t\t\tinitializeClass(vmThread, elementClass);\n+\t\t\tif (NULL != vmThread->currentException) {\n+\t\t\t\tresult = NULL;\n+\t\t\t\telementClass->arrayClass = NULL;", "originalCommit": "f00dfdf19041f13125608681f75ede8c97455164", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "24ea9c92f7a947a59d66d6a04fab70deca695684", "url": "https://github.com/eclipse-openj9/openj9/commit/24ea9c92f7a947a59d66d6a04fab70deca695684", "message": "Fix bug in resolution of VT arrays and fields\n\nWhen creating an array the elements of the array are set to the default\nvalue. For arrays of regular identity types this is NULL. For arrays of\nvalueTypes this is the defaultValue of the valueType. As a result, if\nthe element type of the array is a valueType, the element type must be\nfully initialized before the array can be created. This PR addresses\nthis problem.\n\nAlso, in the resolve field code, it is incorrectly fetching the\nflattened field cache from the class where the fieldref is stored\ninstead of the class that defined the field. We havent noticed this\nbecause the existing tests only fetches fields using getter methods.\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>", "committedDate": "2020-02-26T14:31:48Z", "type": "commit"}, {"oid": "24ea9c92f7a947a59d66d6a04fab70deca695684", "url": "https://github.com/eclipse-openj9/openj9/commit/24ea9c92f7a947a59d66d6a04fab70deca695684", "message": "Fix bug in resolution of VT arrays and fields\n\nWhen creating an array the elements of the array are set to the default\nvalue. For arrays of regular identity types this is NULL. For arrays of\nvalueTypes this is the defaultValue of the valueType. As a result, if\nthe element type of the array is a valueType, the element type must be\nfully initialized before the array can be created. This PR addresses\nthis problem.\n\nAlso, in the resolve field code, it is incorrectly fetching the\nflattened field cache from the class where the fieldref is stored\ninstead of the class that defined the field. We havent noticed this\nbecause the existing tests only fetches fields using getter methods.\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>", "committedDate": "2020-02-26T14:31:48Z", "type": "forcePushed"}]}