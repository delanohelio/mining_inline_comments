{"pr_number": 8912, "pr_title": "JVM_LoadLibrary releases VM Access before invoking registerBootstrapLibrary()", "pr_createdAt": "2020-03-19T00:37:59Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/8912", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTA0NzcxNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/8912#discussion_r395047716", "bodyText": "After entering the VM, you will certainly have VM access, so there's no need to test here.", "author": "gacholio", "createdAt": "2020-03-19T14:02:15Z", "path": "runtime/j9vm/jvm.c", "diffHunk": "@@ -3589,13 +3589,24 @@ JVM_LoadLibrary(const char* libName)\n \tJ9JavaVM* javaVM = (J9JavaVM*)BFUjavaVM;\n \tJ9InternalVMFunctions* vmFuncs = javaVM->internalVMFunctions;\n \tJ9VMThread* currentThread = vmFuncs->currentVMThread(javaVM);\n+\tUDATA flagVMAccess = 0;\n \n-\tTrc_SC_LoadLibrary_Entry(libName);\n+\tTrc_SC_LoadLibrary_Entry(currentThread, libName);\n+\tvmFuncs->internalEnterVMFromJNI(currentThread);\n+\tflagVMAccess = currentThread->publicFlags & J9_PUBLIC_FLAGS_VM_ACCESS;\n+\tTrc_SC_LoadLibrary_FlagVMAccess(currentThread, flagVMAccess);\n+\tif (0 != flagVMAccess) {", "originalCommit": "ee489697ccb944cc9d9a18800c2e27eb633dd7c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTA3OTc1MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8912#discussion_r395079751", "bodyText": "Removed the flag and check.", "author": "JasonFengJ9", "createdAt": "2020-03-19T14:43:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTA0NzcxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTA0ODM5Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/8912#discussion_r395048396", "bodyText": "I thought we weren't supposed to change tracepoint parameters. Given how infrequently this code will be used, I suggest leaving them as noEnv.", "author": "gacholio", "createdAt": "2020-03-19T14:03:07Z", "path": "runtime/j9vm/jvm.c", "diffHunk": "@@ -3589,13 +3589,24 @@ JVM_LoadLibrary(const char* libName)\n \tJ9JavaVM* javaVM = (J9JavaVM*)BFUjavaVM;\n \tJ9InternalVMFunctions* vmFuncs = javaVM->internalVMFunctions;\n \tJ9VMThread* currentThread = vmFuncs->currentVMThread(javaVM);\n+\tUDATA flagVMAccess = 0;\n \n-\tTrc_SC_LoadLibrary_Entry(libName);\n+\tTrc_SC_LoadLibrary_Entry(currentThread, libName);", "originalCommit": "ee489697ccb944cc9d9a18800c2e27eb633dd7c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTA4MTQ3Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/8912#discussion_r395081472", "bodyText": "A new tracepoint is required if there is a signature change such as the types, order and total number of format specifiers in the Template.\nChanges to the Tracepoint Type, Overhead, Level and NoEnv parameters, and cosmetic changes to the text in the Template can be made without adding a new tracepoint.\nAgreed that this is not a hot path, leaving them as noEnv.", "author": "JasonFengJ9", "createdAt": "2020-03-19T14:46:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTA0ODM5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTA0ODcyMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/8912#discussion_r395048722", "bodyText": "No need to acquire here - exit will work regardless.", "author": "gacholio", "createdAt": "2020-03-19T14:03:37Z", "path": "runtime/j9vm/jvm.c", "diffHunk": "@@ -3589,13 +3589,24 @@ JVM_LoadLibrary(const char* libName)\n \tJ9JavaVM* javaVM = (J9JavaVM*)BFUjavaVM;\n \tJ9InternalVMFunctions* vmFuncs = javaVM->internalVMFunctions;\n \tJ9VMThread* currentThread = vmFuncs->currentVMThread(javaVM);\n+\tUDATA flagVMAccess = 0;\n \n-\tTrc_SC_LoadLibrary_Entry(libName);\n+\tTrc_SC_LoadLibrary_Entry(currentThread, libName);\n+\tvmFuncs->internalEnterVMFromJNI(currentThread);\n+\tflagVMAccess = currentThread->publicFlags & J9_PUBLIC_FLAGS_VM_ACCESS;\n+\tTrc_SC_LoadLibrary_FlagVMAccess(currentThread, flagVMAccess);\n+\tif (0 != flagVMAccess) {\n+\t\tvmFuncs->internalReleaseVMAccess(currentThread);\n+\t}\n \tif (vmFuncs->registerBootstrapLibrary(currentThread, libName, &nativeLibrary, FALSE) == J9NATIVELIB_LOAD_OK) {\n \t\tresult = (void*)nativeLibrary->handle;\n \t}\n+\tif (0 != flagVMAccess) {", "originalCommit": "ee489697ccb944cc9d9a18800c2e27eb633dd7c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTA4MTk4NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8912#discussion_r395081985", "bodyText": "Removed the VM access acquiring.\nPlease have another look.", "author": "JasonFengJ9", "createdAt": "2020-03-19T14:47:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTA0ODcyMg=="}], "type": "inlineReview"}, {"oid": "21c0cdf21bc5a12a2b89db1db1341c6268e3ca35", "url": "https://github.com/eclipse-openj9/openj9/commit/21c0cdf21bc5a12a2b89db1db1341c6268e3ca35", "message": "JVM_LoadLibrary release VM Access\n\nInvoking internalReleaseVMAccess() before registerBootstrapLibrary().\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>", "committedDate": "2020-03-19T14:42:20Z", "type": "commit"}, {"oid": "21c0cdf21bc5a12a2b89db1db1341c6268e3ca35", "url": "https://github.com/eclipse-openj9/openj9/commit/21c0cdf21bc5a12a2b89db1db1341c6268e3ca35", "message": "JVM_LoadLibrary release VM Access\n\nInvoking internalReleaseVMAccess() before registerBootstrapLibrary().\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>", "committedDate": "2020-03-19T14:42:20Z", "type": "forcePushed"}]}