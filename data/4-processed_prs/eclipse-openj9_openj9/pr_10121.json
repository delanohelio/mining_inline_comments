{"pr_number": 10121, "pr_title": "Support JDK15 new field java.lang.reflect.Field.trustedFinal", "pr_createdAt": "2020-07-08T18:38:19Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10121", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTkzOTY4Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10121#discussion_r451939682", "bodyText": "The ANY bit test macro is defined as:\n#define OMR_ARE_ANY_BITS_SET(value, bits) (0 != ((value) & (bits)))\n\nwhich means this can be a single test.  Though, I think it should be ALL_BITS, not ANY:\n#define OMR_ARE_ALL_BITS_SET(value, bits) ((bits) == ((value) & (bits)))\n\nAs we want to test for both FINAL and STATIC:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \tif (J9_ARE_ANY_BITS_SET(j9FieldID->field->modifiers, J9AccFinal)\n          \n          \n            \n            \t\t&& J9_ARE_ANY_BITS_SET(j9FieldID->field->modifiers, J9AccStatic)\n          \n          \n            \n            \tif (J9_ARE_ALL_BITS_SET(j9FieldID->field->modifiers, J9AccFinal | J9AccStatic)", "author": "DanHeidinga", "createdAt": "2020-07-09T03:13:47Z", "path": "runtime/jcl/common/reflecthelp.c", "diffHunk": "@@ -829,6 +829,13 @@ createField(struct J9VMThread *vmThread, jfieldID fieldID)\n \tJ9VMJAVALANGREFLECTFIELD_SET_DECLARINGCLASS(vmThread, fieldObject, J9VM_J9CLASS_TO_HEAPCLASS(j9FieldID->declaringClass));\n #if defined(USE_SUN_REFLECT)\n \tJ9VMJAVALANGREFLECTFIELD_SET_MODIFIERS(vmThread, fieldObject, j9FieldID->field->modifiers & CFR_FIELD_ACCESS_MASK);\n+#if JAVA_SPEC_VERSION >= 15\n+\tif (J9_ARE_ANY_BITS_SET(j9FieldID->field->modifiers, J9AccFinal)\n+\t\t&& J9_ARE_ANY_BITS_SET(j9FieldID->field->modifiers, J9AccStatic)", "originalCommit": "7938b1112fc50c032c73ddd103d77e30447c1fca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjEzMzc2NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10121#discussion_r452133765", "bodyText": "Nice! fixed accordingly.\nAlso verified that this works for FINAL & STATIC along with combination of other modifiers such as public/private.", "author": "JasonFengJ9", "createdAt": "2020-07-09T10:55:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTkzOTY4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk0MTM5NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10121#discussion_r451941395", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tJ9VMJAVALANGREFLECTFIELD_SET_TRUSTEDFINAL(vmThread, fieldObject, TRUE);\n          \n          \n            \n            \t\tJ9VMJAVALANGREFLECTFIELD_SET_TRUSTEDFINAL(vmThread, fieldObject, JNI_TRUE);", "author": "DanHeidinga", "createdAt": "2020-07-09T03:20:39Z", "path": "runtime/jcl/common/reflecthelp.c", "diffHunk": "@@ -829,6 +829,13 @@ createField(struct J9VMThread *vmThread, jfieldID fieldID)\n \tJ9VMJAVALANGREFLECTFIELD_SET_DECLARINGCLASS(vmThread, fieldObject, J9VM_J9CLASS_TO_HEAPCLASS(j9FieldID->declaringClass));\n #if defined(USE_SUN_REFLECT)\n \tJ9VMJAVALANGREFLECTFIELD_SET_MODIFIERS(vmThread, fieldObject, j9FieldID->field->modifiers & CFR_FIELD_ACCESS_MASK);\n+#if JAVA_SPEC_VERSION >= 15\n+\tif (J9_ARE_ANY_BITS_SET(j9FieldID->field->modifiers, J9AccFinal)\n+\t\t&& J9_ARE_ANY_BITS_SET(j9FieldID->field->modifiers, J9AccStatic)\n+\t) {\n+\t\tJ9VMJAVALANGREFLECTFIELD_SET_TRUSTEDFINAL(vmThread, fieldObject, TRUE);", "originalCommit": "7938b1112fc50c032c73ddd103d77e30447c1fca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjEzNDI1OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10121#discussion_r452134258", "bodyText": "Updated.\n@DanHeidinga please have another look.", "author": "JasonFengJ9", "createdAt": "2020-07-09T10:56:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk0MTM5NQ=="}], "type": "inlineReview"}, {"oid": "13fdbc88846a26d80406152785b92bdaa5e63b61", "url": "https://github.com/eclipse-openj9/openj9/commit/13fdbc88846a26d80406152785b92bdaa5e63b61", "message": "Support JDK15 new field java.lang.reflect.Field.trustedFinal\n\nSet it to TRUE if the field is static & final.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>", "committedDate": "2020-07-09T10:51:20Z", "type": "commit"}, {"oid": "13fdbc88846a26d80406152785b92bdaa5e63b61", "url": "https://github.com/eclipse-openj9/openj9/commit/13fdbc88846a26d80406152785b92bdaa5e63b61", "message": "Support JDK15 new field java.lang.reflect.Field.trustedFinal\n\nSet it to TRUE if the field is static & final.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>", "committedDate": "2020-07-09T10:51:20Z", "type": "forcePushed"}]}