{"pr_number": 8780, "pr_title": "Transform indexOf call node when receiver is known string", "pr_createdAt": "2020-03-06T20:25:46Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/8780", "timeline": [{"oid": "8b8aab7f5aaeaedeab5aa959f4420c150043bcdc", "url": "https://github.com/eclipse-openj9/openj9/commit/8b8aab7f5aaeaedeab5aa959f4420c150043bcdc", "message": "Transform indexOf call node when receiver is known string\n\n- Add new method `J9::ValuePropagation::transformIndexOfKnownString` which\n  checks if the receiver has a KnownObject or ConstString constraint.\n  If so, the call node is replaced by an equivalent constant, icmpeq, or iselect\n  node or tree of nodes.\n\n- Add indexOf(I)I as a recognized method so that the above transformations can\n  be applied to it.\n\nThese changes were originally authored by Andrew Craik who is listed as a\nco-author below.\n\nCo-authored-by: Andrew Craik <ajcraik@ca.ibm.com>\n\nSigned-off-by: Ryan Shukla <ryans@ibm.com>", "committedDate": "2020-03-16T13:42:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU0MTQ0NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8780#discussion_r412541444", "bodyText": "Can we get here since we are presumably dealing with a char ? If so, maybe targetChar should be declared as 32-bit ?", "author": "vijaysun-omr", "createdAt": "2020-04-21T22:43:16Z", "path": "runtime/compiler/optimizer/J9ValuePropagation.cpp", "diffHunk": "@@ -250,6 +261,228 @@ J9::ValuePropagation::isKnownStringObject(TR::VPConstraint *constraint)\n           && (constraint->isConstString() || constraint->getKnownObject());\n    }\n \n+bool J9::ValuePropagation::transformIndexOfKnownString(\n+   TR::Node *indexOfNode,\n+   TR::Node *sourceStringNode,\n+   TR::Node *targetCharNode,\n+   TR::Node *startNode,\n+   TR::Node *lengthNode,\n+   bool is16Bit)\n+   {\n+   // Keep track of whether or not all constraints are global.\n+   bool isGlobal = true;\n+   bool isGlobalQuery;\n+\n+   TR::VPConstraint *sourceConstraint = getConstraint(sourceStringNode, isGlobalQuery);\n+   isGlobal &= isGlobalQuery;\n+   if (!sourceConstraint)\n+      return false;\n+   TR::VPKnownObject *knownObject = sourceConstraint->getKnownObject();\n+   // The source string must either be a KnownObject or a ConstString.\n+   // Otherwise, do not attempt transformations.\n+   if (!knownObject && !sourceConstraint->isConstString())\n+      return false;\n+   TR::KnownObjectTable *knot;\n+   if (knownObject)\n+      {\n+      knot = comp()->getOrCreateKnownObjectTable();\n+      if (!knot)\n+         return false;\n+      TR_OpaqueClassBlock *klazz = knownObject->getClass();\n+      if (!comp()->fej9()->isPrimitiveArray(klazz))\n+         return false;\n+      }\n+\n+   TR::VPConstraint *targetConstraint = getConstraint(targetCharNode, isGlobal) ;\n+   bool targetIsConstChar = false;\n+   uint16_t targetChar = -1;\n+   if (!targetConstraint)\n+      {\n+      targetIsConstChar = false;\n+      }\n+   else if (targetConstraint->asIntConst())\n+      {\n+      targetIsConstChar = true;\n+      targetChar = targetConstraint->asIntConst()->getInt();", "originalCommit": "8b8aab7f5aaeaedeab5aa959f4420c150043bcdc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzA0NzczMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8780#discussion_r413047730", "bodyText": "I tried adding some logging and it looks like we are getting there.\nFor a call like \"abcde\".indexOf('a'), the trees look like this:\nn5n         icall  java/lang/String.indexOf(I)I[#361  final virtual Method -200] [flags 0x20500 0x0 ]  [0x7f0d05419490] bci=[-1,4,92] rc=2 vc=9 vn=- li=- udi=- nc=2\nn3n           aload  <string \"abcde\">[#358  Static] (obj1) [flags 0x80000307 0x0 ]            [0x7f0d054193f0] bci=[-1,0,92] rc=1 vc=8 vn=- li=- udi=- nc=0\nn4n           iconst 97                                                                       [0x7f0d05419440] bci=[-1,2,92] rc=1 vc=8 vn=- li=- udi=- nc=0\n\nI think because the 'a' becomes an iconst, the constraint is an integer type.\nI will change targetChar to 32-bit.", "author": "rpshukla", "createdAt": "2020-04-22T14:46:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU0MTQ0NA=="}], "type": "inlineReview"}, {"oid": "6589fcd2b8a576d48b602961b0ce7f3b4b13f2a6", "url": "https://github.com/eclipse-openj9/openj9/commit/6589fcd2b8a576d48b602961b0ce7f3b4b13f2a6", "message": "Transform indexOf call node when receiver is known string\n\n- Add new method `J9::ValuePropagation::transformIndexOfKnownString` which\n  checks if the receiver has a KnownObject or ConstString constraint.\n  If so, the call node is replaced by an equivalent constant, icmpeq, or iselect\n  node or tree of nodes.\n\n- Add indexOf(I)I as a recognized method so that the above transformations can\n  be applied to it.\n\nThese changes were originally authored by Andrew Craik who is listed as a\nco-author below.\n\nCo-authored-by: Andrew Craik <ajcraik@ca.ibm.com>\n\nSigned-off-by: Ryan Shukla <ryans@ibm.com>", "committedDate": "2020-04-23T14:01:34Z", "type": "commit"}, {"oid": "6589fcd2b8a576d48b602961b0ce7f3b4b13f2a6", "url": "https://github.com/eclipse-openj9/openj9/commit/6589fcd2b8a576d48b602961b0ce7f3b4b13f2a6", "message": "Transform indexOf call node when receiver is known string\n\n- Add new method `J9::ValuePropagation::transformIndexOfKnownString` which\n  checks if the receiver has a KnownObject or ConstString constraint.\n  If so, the call node is replaced by an equivalent constant, icmpeq, or iselect\n  node or tree of nodes.\n\n- Add indexOf(I)I as a recognized method so that the above transformations can\n  be applied to it.\n\nThese changes were originally authored by Andrew Craik who is listed as a\nco-author below.\n\nCo-authored-by: Andrew Craik <ajcraik@ca.ibm.com>\n\nSigned-off-by: Ryan Shukla <ryans@ibm.com>", "committedDate": "2020-04-23T14:01:34Z", "type": "forcePushed"}]}