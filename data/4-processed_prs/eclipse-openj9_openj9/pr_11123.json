{"pr_number": 11123, "pr_title": "Implement java.lang.ref.Reference.refersTo() for Java 16", "pr_createdAt": "2020-11-06T16:44:26Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/11123", "timeline": [{"oid": "23571a702fab412bd0e68d623da86a9858162d3d", "url": "https://github.com/eclipse-openj9/openj9/commit/23571a702fab412bd0e68d623da86a9858162d3d", "message": "Implement java.lang.ref.Reference.refersTo() for Java 16\n\nSigned-off-by: Keith W. Campbell <keithc@ca.ibm.com>", "committedDate": "2020-11-06T18:21:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAxNjMyNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11123#discussion_r520016325", "bodyText": "@RSalman This pattern repeats a few more times in the code.\n\nThis needs to be more generic and refer to SATB barrier, rather than Metronome GC policy\nWe should hide this SATB specialization under the hood of J9VMJAVALANGREFREFERENCE_REFERENT_VM macro", "author": "amicic", "createdAt": "2020-11-09T18:10:33Z", "path": "runtime/jcl/common/java_lang_ref_Reference.cpp", "diffHunk": "@@ -63,4 +63,39 @@ Java_java_lang_ref_Reference_waitForReferenceProcessingImpl(JNIEnv *env, jclass\n \treturn result;\n }\n \n+#if JAVA_SPEC_VERSION >= 16\n+JNIEXPORT jboolean JNICALL\n+java_lang_ref_Reference_refersTo(JNIEnv *env, jobject reference, jobject target)\n+{\n+\tJ9VMThread * const currentThread = (J9VMThread *)env;\n+\tJ9JavaVM * const vm = currentThread->javaVM;\n+\tJ9InternalVMFunctions * const vmFuncs = vm->internalVMFunctions;\n+\tjboolean result = JNI_FALSE;\n+\n+\tvmFuncs->internalEnterVMFromJNI(currentThread);\n+\n+\tif (NULL == reference) {\n+\t\tvmFuncs->setCurrentException(currentThread, J9VMCONSTANTPOOL_JAVALANGNULLPOINTEREXCEPTION, NULL);\n+\t} else {\n+\t\tj9object_t j9reference = J9_JNI_UNWRAP_REFERENCE(reference);\n+\t\tj9object_t j9target = (NULL != target) ? J9_JNI_UNWRAP_REFERENCE(target) : NULL;\n+\t\tj9object_t referent = NULL;\n+\n+\t\tif (J9_GC_POLICY_METRONOME == ((OMR_VM *)vm->omrVM)->gcPolicy) {\n+\t\t\treferent = vm->memoryManagerFunctions->j9gc_objaccess_referenceGet(currentThread, j9reference);\n+\t\t} else {\n+\t\t\treferent = J9VMJAVALANGREFREFERENCE_REFERENT_VM(vm, j9reference);\n+\t\t}", "originalCommit": "23571a702fab412bd0e68d623da86a9858162d3d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA1NjcxOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11123#discussion_r520056719", "bodyText": "Those macros are currently autogenerated, so we should add a new pair of macros to get the referent (leaving the autogenerated ones as they are).", "author": "gacholio", "createdAt": "2020-11-09T19:12:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAxNjMyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA1NzQxNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11123#discussion_r520057415", "bodyText": "I would suggest doing this in a separate PR.", "author": "gacholio", "createdAt": "2020-11-09T19:13:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAxNjMyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA1Nzk4Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/11123#discussion_r520057983", "bodyText": "yeah, I did not mean doing anything now", "author": "amicic", "createdAt": "2020-11-09T19:14:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAxNjMyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY1NzM5NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11123#discussion_r520657395", "bodyText": "Noted this: eclipse/omr#5494 (comment)", "author": "RSalman", "createdAt": "2020-11-10T15:36:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAxNjMyNQ=="}], "type": "inlineReview"}, {"oid": "ff4b96a34548b6a45a9fca5fe407efbb8b781e7f", "url": "https://github.com/eclipse-openj9/openj9/commit/ff4b96a34548b6a45a9fca5fe407efbb8b781e7f", "message": "Implement java.lang.ref.Reference.refersTo() for Java 16\n\nSigned-off-by: Keith W. Campbell <keithc@ca.ibm.com>", "committedDate": "2020-11-09T18:54:51Z", "type": "commit"}, {"oid": "ff4b96a34548b6a45a9fca5fe407efbb8b781e7f", "url": "https://github.com/eclipse-openj9/openj9/commit/ff4b96a34548b6a45a9fca5fe407efbb8b781e7f", "message": "Implement java.lang.ref.Reference.refersTo() for Java 16\n\nSigned-off-by: Keith W. Campbell <keithc@ca.ibm.com>", "committedDate": "2020-11-09T18:54:51Z", "type": "forcePushed"}]}