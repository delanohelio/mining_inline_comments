{"pr_number": 9898, "pr_title": "[Test] Adjust the setting of GC specific tests on RISC-V", "pr_createdAt": "2020-06-16T14:51:59Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/9898", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU5NDU5OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9898#discussion_r441594598", "bodyText": "I believe you can just replace \"60\" to \"200\" regardless of platform. This extends valid range for parameter only.", "author": "dmitripivkine", "createdAt": "2020-06-17T14:35:51Z", "path": "test/functional/cmdLineTests/gcRegressionTests/src/com/ibm/tests/garbagecollector/SpinAllocate.java", "diffHunk": "@@ -29,18 +29,25 @@\n public class SpinAllocate\n {\n \tpublic static Object _objectHolder;\n+\t\n+\t/* Given that the jdk runs very slow on RISC-V, we have to increase \n+\t * the threshold value to ensure the test is completed.\n+\t */\n+\tprivate static String archName = System.getProperty(\"os.arch\");\n+\tprivate static boolean isRiscv = archName.toLowerCase().contains(\"riscv\");\n+\tprivate static int threshold = (isRiscv) ? 200 : 60;\n \n \t/**\n \t * @param args Takes one argument:  number of seconds to spin for before terminating with a message that the test ran to completion.\n-\t * This argument is required.  It must be in the range [1-60]\n+\t * This argument is required.  It must be in the range [1-200]\n \t */\n \tpublic static void main(String[] args)\n \t{\n \t\tif (1 == args.length)\n \t\t{\n \t\t\tint secondsToSpin = Integer.parseInt(args[0]);\n \n-\t\t\tif ((secondsToSpin >= 1) && (secondsToSpin <= 60))\n+\t\t\tif ((secondsToSpin >= 1) && (secondsToSpin <= threshold))", "originalCommit": "184e782aa8f8b7cca16e256ae2540fce24851f39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYwODA3OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9898#discussion_r441608079", "bodyText": "It makes more sense to me this way in terms of RISC-V.  Will update as long as it works for other platforms,  in which case the timeout setting on platforms might be adjusted accordingly.", "author": "ChengJin01", "createdAt": "2020-06-17T14:53:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU5NDU5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYwNzg4MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9898#discussion_r441607880", "bodyText": "From test correctness point of view we can replace \"5\" to \"200\" regardless of platform. The only issue with this it might increase hang detection time from 10 to 400 seconds. @llxia is it acceptable?", "author": "dmitripivkine", "createdAt": "2020-06-17T14:53:19Z", "path": "test/functional/Java8andUp/src/org/openj9/test/nogc/TestGCPolicyNogc.java", "diffHunk": "@@ -118,7 +125,7 @@ public void testGCPolicyNogc() {\n \t\twhile (allocator.isAlive()) {\n \t\t\ttry {\n \t\t\t\tcount++;\n-\t\t\t\tif (count > 5) {\n+\t\t\t\tif (count > threshold) {", "originalCommit": "184e782aa8f8b7cca16e256ae2540fce24851f39", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYyMTEzMQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9898#discussion_r441621131", "bodyText": "I am not sure we need special version for RISC-V but just replace -Xms8m -Xmx8m to -Xms2m -Xmx2m for general. @amicic Any complains about this?", "author": "dmitripivkine", "createdAt": "2020-06-17T15:09:44Z", "path": "test/functional/cmdLineTests/gcRegressionTests/gcRegressionTests.xml", "diffHunk": "@@ -227,6 +227,13 @@\n  \t<output regex=\"no\" type=\"failure\">Test ran to completion</output>\n  \t<output regex=\"no\" type=\"success\">java.lang.OutOfMemoryError</output>\n  </test>\n+ <test id=\"Excessive GC throws OOM on RISC-V\">\n+ \t<echo value=\"CMVC 148977:  Excessive GC throws OOM may fail if there is other activity on the machine - at least 5 GCs are required, in the 20 second test\" />\n+ \t<!-- does the test fail to run (thus implying that we encountered excessive GC)? -->\n+ \t<command>$EXE$ $XINT$ $ARGS_FOR_ALL_TESTS$ -Xdump:none -Xms2m -Xmx2m -Xgc:fvtest=forceExcessiveAllocFailureAfter=5 -verbose:gc -Xverbosegclog:foo.log $CP$ com.ibm.tests.garbagecollector.SpinAllocate 20</command>\n+ \t<output regex=\"no\" type=\"failure\">Test ran to completion</output>\n+ \t<output regex=\"no\" type=\"success\">java.lang.OutOfMemoryError</output>\n+ </test>", "originalCommit": "184e782aa8f8b7cca16e256ae2540fce24851f39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY2NjQyNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/9898#discussion_r441666426", "bodyText": "Don't know. Perhaps there is a danger to hit genuine  OOM before excessive OOM with 2M, although I don't have a valid theory that it could  occur on other platforms and not on RISC.", "author": "amicic", "createdAt": "2020-06-17T16:16:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYyMTEzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTczMzA4NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9898#discussion_r441733084", "bodyText": "ok, thank you. @ChengJin01 Would you please double check that -Xms2m -Xmx2m works with this test on all platforms?", "author": "dmitripivkine", "createdAt": "2020-06-17T18:07:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYyMTEzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTczOTM0OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9898#discussion_r441739348", "bodyText": "Will launch personal builds to verify after updating all settings.", "author": "ChengJin01", "createdAt": "2020-06-17T18:18:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYyMTEzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzU4MDUxNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9898#discussion_r443580514", "bodyText": "ok, thank you. If we can not apply new settings for all platforms so you can limit it to RISC-V only as proposed", "author": "dmitripivkine", "createdAt": "2020-06-22T14:02:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYyMTEzMQ=="}], "type": "inlineReview"}, {"oid": "4a3cf770e7d03e53742c90c18e600597eba11891", "url": "https://github.com/eclipse-openj9/openj9/commit/4a3cf770e7d03e53742c90c18e600597eba11891", "message": "[Test] Adjust the setting of GC specific tests on RISC-V\n\nThe test change is to update the initial memory setting &\nthe threshold values in GC specific tests to ensure the\nJVM works appropriately as expected in tests due to the\nlack of JIT on RISC-V.\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-06-17T20:20:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI4ODIwNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/9898#discussion_r450288206", "bodyText": "Do you need this change? I thought we agreed to keep -Xms8m -Xmx8m for all non-RISC-V cases", "author": "dmitripivkine", "createdAt": "2020-07-06T15:08:09Z", "path": "test/functional/cmdLineTests/gcRegressionTests/gcRegressionTests.xml", "diffHunk": "@@ -223,7 +223,14 @@\n  <test id=\"Excessive GC throws OOM\">\n  \t<echo value=\"CMVC 148977:  Excessive GC throws OOM may fail if there is other activity on the machine - at least 5 GCs are required, in the 20 second test\" />\n  \t<!-- does the test fail to run (thus implying that we encountered excessive GC)? -->\n- \t<command>$EXE$ $XINT$ $ARGS_FOR_ALL_TESTS$ -Xdump:none -Xms8m -Xmx8m -Xgc:fvtest=forceExcessiveAllocFailureAfter=5 -verbose:gc -Xverbosegclog:foo.log $CP$ com.ibm.tests.garbagecollector.SpinAllocate 20</command>\n+ \t<command>$EXE$ $XINT$ $ARGS_FOR_ALL_TESTS$ -Xdump:none -Xms2m -Xmx2m -Xgc:fvtest=forceExcessiveAllocFailureAfter=5 -verbose:gc -Xverbosegclog:foo.log $CP$ com.ibm.tests.garbagecollector.SpinAllocate 20</command>", "originalCommit": "4a3cf770e7d03e53742c90c18e600597eba11891", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI5MjYxMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9898#discussion_r450292610", "bodyText": "Just restored it back to -Xms8m -Xmx8m as confirmed previously for all non-RISC-V cases.", "author": "ChengJin01", "createdAt": "2020-07-06T15:14:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI4ODIwNg=="}], "type": "inlineReview"}, {"oid": "151838253c128f56c6a3aa8811467464594aca74", "url": "https://github.com/eclipse-openj9/openj9/commit/151838253c128f56c6a3aa8811467464594aca74", "message": "[Test] Adjust the setting of GC specific tests on RISC-V\n\nThe test change is to update the initial memory setting &\nthe threshold values in GC specific tests to ensure the\nJVM works appropriately as expected in tests due to the\nlack of JIT on RISC-V.\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-07-06T15:13:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI5NjIwMQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9898#discussion_r450296201", "bodyText": "You did increase parameter range from [1-60] to [1-200] for SpinAllocate. Is there an intention to increase it here?", "author": "dmitripivkine", "createdAt": "2020-07-06T15:20:02Z", "path": "test/functional/cmdLineTests/gcRegressionTests/gcRegressionTests.xml", "diffHunk": "@@ -227,6 +227,13 @@\n  \t<output regex=\"no\" type=\"failure\">Test ran to completion</output>\n  \t<output regex=\"no\" type=\"success\">java.lang.OutOfMemoryError</output>\n  </test>\n+ <test id=\"Excessive GC throws OOM on RISC-V\">\n+ \t<echo value=\"CMVC 148977:  Excessive GC throws OOM may fail if there is other activity on the machine - at least 5 GCs are required, in the 20 second test\" />\n+ \t<!-- does the test fail to run (thus implying that we encountered excessive GC)? -->\n+ \t<command>$EXE$ $XINT$ $ARGS_FOR_ALL_TESTS$ -Xdump:none -Xms2m -Xmx2m -Xgc:fvtest=forceExcessiveAllocFailureAfter=5 -verbose:gc -Xverbosegclog:foo.log $CP$ com.ibm.tests.garbagecollector.SpinAllocate 20</command>", "originalCommit": "151838253c128f56c6a3aa8811467464594aca74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMwMzI2NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9898#discussion_r450303265", "bodyText": "Yes, we have to increase the value there to ensure it passes the test case correctly as this is pretty much the same timeout issue with TestGCPolicyNogc.", "author": "ChengJin01", "createdAt": "2020-07-06T15:30:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI5NjIwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMyOTI1OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9898#discussion_r450329259", "bodyText": "Are you going to change timeout parameter in this commit?", "author": "dmitripivkine", "createdAt": "2020-07-06T16:10:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI5NjIwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM0MDgwMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9898#discussion_r450340800", "bodyText": "There is no need to do so based on the test results as we already increase the threshold", "author": "ChengJin01", "createdAt": "2020-07-06T16:29:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI5NjIwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM1NDM4NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9898#discussion_r450354385", "bodyText": "Removed the change on threshold as unnecessary given the initial memory setting is modified to fit the case on RISC-V.", "author": "ChengJin01", "createdAt": "2020-07-06T16:51:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI5NjIwMQ=="}], "type": "inlineReview"}, {"oid": "5f3a1f6f69b045aecc0b52b0d4419cb8d27abb47", "url": "https://github.com/eclipse-openj9/openj9/commit/5f3a1f6f69b045aecc0b52b0d4419cb8d27abb47", "message": "[Test] Adjust the setting of GC specific tests on RISC-V\n\nThe test change is to update the initial memory setting &\nthe threshold values in GC specific tests to ensure the\nJVM works appropriately as expected in tests due to the\nlack of JIT on RISC-V.\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-07-06T16:50:12Z", "type": "commit"}, {"oid": "5f3a1f6f69b045aecc0b52b0d4419cb8d27abb47", "url": "https://github.com/eclipse-openj9/openj9/commit/5f3a1f6f69b045aecc0b52b0d4419cb8d27abb47", "message": "[Test] Adjust the setting of GC specific tests on RISC-V\n\nThe test change is to update the initial memory setting &\nthe threshold values in GC specific tests to ensure the\nJVM works appropriately as expected in tests due to the\nlack of JIT on RISC-V.\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-07-06T16:50:12Z", "type": "forcePushed"}]}