{"pr_number": 8804, "pr_title": "Pruning the cards from InterRegionRememberedsets after GMP", "pr_createdAt": "2020-03-09T16:17:11Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/8804", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE0MDcxOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r391140718", "bodyText": "this needs to go to MarkMap class, a helper like:\nbool anyLiveObjectInCard(void *heapAddress);", "author": "amicic", "createdAt": "2020-03-11T17:28:24Z", "path": "runtime/gc_vlhgc/CardListFlushTask.cpp", "diffHunk": "@@ -119,8 +122,16 @@ MM_CardListFlushTask::run(MM_EnvironmentBase *envBase)\n \t\t\t\t\t\t/* For Marking purposes we do not need to track references within Collection Set */\n \t\t\t\t\t\tMM_HeapRegionDescriptorVLHGC *referencingRegion = interRegionRememberedSet->tableDescriptorForRememberedSetCard(card);\n \t\t\t\t\t\tif (referencingRegion->containsObjects() && !referencingRegion->_markData._shouldMark) {\n-\t\t\t\t\t\t\tCard *cardAddress = interRegionRememberedSet->rememberedSetCardToCardAddr(env, card);\n-\t\t\t\t\t\t\twriteFlushToCardState(cardAddress, gmpIsActive);\n+\t\t\t\t\t\t\tbool needToFlush = true;\n+\t\t\t\t\t\t\tif (needToCheckMarkMap) {\n+\t\t\t\t\t\t\t\tvoid* heapAddress = convertHeapAddressFromRememberedSetCard(envBase, card);\n+\t\t\t\t\t\t\t\tuint64_t* map4Card = (uint64_t*) &((uintptr_t *)(markMap->getMarkBits()))[markMap->getSlotIndex((omrobjectptr_t) heapAddress)];", "originalCommit": "7b3c5eb457bbc56786403f5703c09d1d863ad9de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE0MzE2OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r391143169", "bodyText": "and state in a comment that implementation assumes that card covers exactly 512 bytes, 1 mark bit is 8 bytes of heap and heap address is card size aligned.", "author": "amicic", "createdAt": "2020-03-11T17:31:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE0MDcxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE1MDM2OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r391150369", "bodyText": "you can add compile time assert that BITS_PER_BYTE is 8 and CARD_SIZE_SHIFT is 9", "author": "amicic", "createdAt": "2020-03-11T17:42:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE0MDcxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE0NzM0OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r391147349", "bodyText": "interRegionRememberedSet is available. you can use its  convertHeapAddressFromRememberedSetCard(), and no need to clone it in this class", "author": "amicic", "createdAt": "2020-03-11T17:37:54Z", "path": "runtime/gc_vlhgc/CardListFlushTask.cpp", "diffHunk": "@@ -119,8 +122,16 @@ MM_CardListFlushTask::run(MM_EnvironmentBase *envBase)\n \t\t\t\t\t\t/* For Marking purposes we do not need to track references within Collection Set */\n \t\t\t\t\t\tMM_HeapRegionDescriptorVLHGC *referencingRegion = interRegionRememberedSet->tableDescriptorForRememberedSetCard(card);\n \t\t\t\t\t\tif (referencingRegion->containsObjects() && !referencingRegion->_markData._shouldMark) {\n-\t\t\t\t\t\t\tCard *cardAddress = interRegionRememberedSet->rememberedSetCardToCardAddr(env, card);\n-\t\t\t\t\t\t\twriteFlushToCardState(cardAddress, gmpIsActive);\n+\t\t\t\t\t\t\tbool needToFlush = true;\n+\t\t\t\t\t\t\tif (needToCheckMarkMap) {\n+\t\t\t\t\t\t\t\tvoid* heapAddress = convertHeapAddressFromRememberedSetCard(envBase, card);", "originalCommit": "7b3c5eb457bbc56786403f5703c09d1d863ad9de", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIyODk3NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r391228975", "bodyText": "The new check is just more generic variant of fromRegion->containsObjects().\nSo I recommend you introduce a helper that will replace that containsObjects() check:\ninline bool IRRS::cardContainsObjects(card, fromRegion,  needToCheckMarkMap) {\nif needToCheckMarkMap\nreturn markMap->anyLiveObjectInCard(card)\nelse\nreturn !fromRegion->containsObjects()\n}", "author": "amicic", "createdAt": "2020-03-11T19:59:26Z", "path": "runtime/gc_vlhgc/InterRegionRememberedSet.cpp", "diffHunk": "@@ -935,6 +941,17 @@ MM_InterRegionRememberedSet::clearFromRegionReferencesForMarkDirect(MM_Environme\n \t\t\t\t\tCard * cardAddress = rememberedSetCardToCardAddr(env, card);\n \t\t\t\t\t/* Regions that are completely swept after a GMP, might still have outgoing references (thus we consider empty regions too) */\n \t\t\t\t\tif (fromRegion->_markData._shouldMark  || !fromRegion->containsObjects() || isDirtyCardForPartialCollect(env, cardTable, cardAddress)) {\n+\t\t\t\t\t\tneedToRemove = true;\n+\t\t\t\t\t}\n+\n+\t\t\t\t\tif (!needToRemove && needToCheckMarkMap) {", "originalCommit": "7b3c5eb457bbc56786403f5703c09d1d863ad9de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIzMTIyNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r391231225", "bodyText": "We can later consider checking against MarkMap all the time (not just after GMP), if it's not much slower. But that might be tricky since for evacuated regions clearing of mark map might be done late(r).", "author": "amicic", "createdAt": "2020-03-11T20:02:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIyODk3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcyNDE4Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r391724182", "bodyText": "The new check is just more generic variant of fromRegion->containsObjects().\nSo I recommend you introduce a helper that will replace that containsObjects() check:\ninline bool IRRS::cardContainsObjects(card, fromRegion, needToCheckMarkMap) {\nif needToCheckMarkMap\nreturn markMap->anyLiveObjectInCard(card)\nelse\nreturn !fromRegion->containsObjects()\n}\n\ngood idea! it is good for clearFromRegionReferencesForMarkDirect(), but for clearFromRegionReferencesForMarkOptimized() (it is default, using compressed card table ), it is little bit tricky, partial logic for checking empty region is in rebuildCompressedCardTableForMark(), we can add CheckMarkMap in rebuildCompressedCardTableForMark, but it need to check every card in the regions, it might be expensive?", "author": "LinHu2016", "createdAt": "2020-03-12T16:02:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIyODk3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc2MDQwMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r398760400", "bodyText": "I see. Actually, I think it is CompressedCardTable::rebuildCompressedCardTableForPartialCollect that would be more impacted. We could try that later and see if it will slow it down.\nStill I think you can introduce the helper and use it here, and in 'else' clause of 'if (compressedCardTable->isReady()) {', while the existing areAnyLiveObjectsInCard() check you can move up in 'then' clause of 'if (compressedCardTable->isReady()) {'", "author": "amicic", "createdAt": "2020-03-26T17:32:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIyODk3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc3Nzc1MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r398777750", "bodyText": "if we use the helper in  \"else\" clause, so we have to add the logic in rebuildCompressedCardTableForPartialCollect(), otherwise if compressedCardTable->isReady() case, we would miss to check markMap.\nif (compressedCardTable->isReady()) {\n   ....\n} else {\n\n}", "author": "LinHu2016", "createdAt": "2020-03-26T17:57:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIyODk3NQ=="}], "type": "inlineReview"}, {"oid": "9469d5ace747b85a9b370457e66208053f3a1d59", "url": "https://github.com/eclipse-openj9/openj9/commit/9469d5ace747b85a9b370457e66208053f3a1d59", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>", "committedDate": "2020-03-12T15:04:20Z", "type": "forcePushed"}, {"oid": "adc5735e4622035b7bd5ecdd25e3392e3066b1c2", "url": "https://github.com/eclipse-openj9/openj9/commit/adc5735e4622035b7bd5ecdd25e3392e3066b1c2", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>", "committedDate": "2020-03-12T17:03:13Z", "type": "forcePushed"}, {"oid": "e1a4cd9d5a5b4cf3f2687c3764d6d65d57697ab0", "url": "https://github.com/eclipse-openj9/openj9/commit/e1a4cd9d5a5b4cf3f2687c3764d6d65d57697ab0", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>", "committedDate": "2020-03-12T23:23:16Z", "type": "forcePushed"}, {"oid": "32d98bce62a73df49b0ae191247d1ea1c942aebe", "url": "https://github.com/eclipse-openj9/openj9/commit/32d98bce62a73df49b0ae191247d1ea1c942aebe", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>", "committedDate": "2020-03-13T13:29:33Z", "type": "forcePushed"}, {"oid": "84d4894bbcf4dded4bde226586d08c3ab67b3bae", "url": "https://github.com/eclipse-openj9/openj9/commit/84d4894bbcf4dded4bde226586d08c3ab67b3bae", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>", "committedDate": "2020-03-18T12:18:24Z", "type": "forcePushed"}, {"oid": "d1c00abcde57994b48c9266bd003d0f1a7ab19e4", "url": "https://github.com/eclipse-openj9/openj9/commit/d1c00abcde57994b48c9266bd003d0f1a7ab19e4", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>", "committedDate": "2020-03-25T12:46:11Z", "type": "forcePushed"}, {"oid": "b9207f58d20851c4e10b4ba0bb894e1772ddbe5e", "url": "https://github.com/eclipse-openj9/openj9/commit/b9207f58d20851c4e10b4ba0bb894e1772ddbe5e", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>", "committedDate": "2020-03-27T14:30:45Z", "type": "forcePushed"}, {"oid": "467ebbca36de9484b336aa88f9e8cf2fb6c570d8", "url": "https://github.com/eclipse-openj9/openj9/commit/467ebbca36de9484b336aa88f9e8cf2fb6c570d8", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>", "committedDate": "2020-03-27T15:34:30Z", "type": "forcePushed"}, {"oid": "da7c78fa0ed0abd9e4ee9dad1a74cd227e07513e", "url": "https://github.com/eclipse-openj9/openj9/commit/da7c78fa0ed0abd9e4ee9dad1a74cd227e07513e", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>", "committedDate": "2020-03-27T15:50:19Z", "type": "forcePushed"}, {"oid": "ef2f3c38e06cf5a8a1e1d768eb7e8454d23d69ed", "url": "https://github.com/eclipse-openj9/openj9/commit/ef2f3c38e06cf5a8a1e1d768eb7e8454d23d69ed", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>", "committedDate": "2020-03-27T16:23:11Z", "type": "forcePushed"}, {"oid": "499e655d2ea8d8628d9358736e6acf9c02a226a8", "url": "https://github.com/eclipse-openj9/openj9/commit/499e655d2ea8d8628d9358736e6acf9c02a226a8", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>", "committedDate": "2020-03-27T16:49:11Z", "type": "forcePushed"}, {"oid": "47aa9c2b8206c236bc0ae6a33163304151c38295", "url": "https://github.com/eclipse-openj9/openj9/commit/47aa9c2b8206c236bc0ae6a33163304151c38295", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>", "committedDate": "2020-03-27T19:13:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ5MDkwNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r399490907", "bodyText": "no need for needToFlush flag, any more. here, and at a couple of other similar spots.", "author": "amicic", "createdAt": "2020-03-27T19:23:20Z", "path": "runtime/gc_vlhgc/CardListFlushTask.cpp", "diffHunk": "@@ -118,9 +121,12 @@ MM_CardListFlushTask::run(MM_EnvironmentBase *envBase)\n \t\t\t\t\twhile(0 != (card = rsclCardIterator.nextReferencingCard(env))) {\n \t\t\t\t\t\t/* For Marking purposes we do not need to track references within Collection Set */\n \t\t\t\t\t\tMM_HeapRegionDescriptorVLHGC *referencingRegion = interRegionRememberedSet->tableDescriptorForRememberedSetCard(card);\n-\t\t\t\t\t\tif (referencingRegion->containsObjects() && !referencingRegion->_markData._shouldMark) {\n-\t\t\t\t\t\t\tCard *cardAddress = interRegionRememberedSet->rememberedSetCardToCardAddr(env, card);\n-\t\t\t\t\t\t\twriteFlushToCardState(cardAddress, gmpIsActive);\n+\t\t\t\t\t\tif (interRegionRememberedSet->cardMayContainObjects(card, referencingRegion, needToCheckMarkMap, markMap) && !referencingRegion->_markData._shouldMark) {\n+\t\t\t\t\t\t\tbool needToFlush = true;", "originalCommit": "47aa9c2b8206c236bc0ae6a33163304151c38295", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ5MTE3NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r399491175", "bodyText": "no need for needToRemove", "author": "amicic", "createdAt": "2020-03-27T19:23:50Z", "path": "runtime/gc_vlhgc/InterRegionRememberedSet.cpp", "diffHunk": "@@ -933,8 +936,13 @@ MM_InterRegionRememberedSet::clearFromRegionReferencesForMarkDirect(MM_Environme\n \t\t\t\twhile(0 != (card = rsclCardIterator.nextReferencingCard(env))) {\n \t\t\t\t\tMM_HeapRegionDescriptorVLHGC *fromRegion = tableDescriptorForRememberedSetCard(card);\n \t\t\t\t\tCard * cardAddress = rememberedSetCardToCardAddr(env, card);\n-\t\t\t\t\t/* Regions that are completely swept after a GMP, might still have outgoing references (thus we consider empty regions too) */\n-\t\t\t\t\tif (fromRegion->_markData._shouldMark  || !fromRegion->containsObjects() || isDirtyCardForPartialCollect(env, cardTable, cardAddress)) {\n+\t\t\t\t\t/* Regions that are completely swept after a GMP, might still have outgoing references (thus we consider cardContainsNoObjects) */\n+\t\t\t\t\tif (fromRegion->_markData._shouldMark  || !cardMayContainObjects(card, fromRegion, needToCheckMarkMap, markMap) || isDirtyCardForPartialCollect(env, cardTable, cardAddress)) {\n+\t\t\t\t\t\tneedToRemove = true;", "originalCommit": "47aa9c2b8206c236bc0ae6a33163304151c38295", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ5MjQ3Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r399492473", "bodyText": "pass compressedCardTable and mark map", "author": "amicic", "createdAt": "2020-03-27T19:26:20Z", "path": "runtime/gc_vlhgc/InterRegionRememberedSet.hpp", "diffHunk": "@@ -185,8 +189,39 @@ class MM_InterRegionRememberedSet : public MM_BaseVirtual\n \tvoid clearFromRegionReferencesForCompactOptimized(MM_EnvironmentVLHGC* env);\n \tMM_InterRegionRememberedSet(MM_HeapRegionManager *heapRegionManager);\n \t\n+\n+\t/**\n+\t * Helper function isCompressedCardDirtyForPartialCollect\n+\t * extended from compressedCardTable->isCompressedCardDirtyForPartialCollect(), only in case first PGC after GMP, also dirty card if card Contains No Object.\n+\t */\n+\tMMINLINE bool isCompressedCardDirtyForPartialCollect(MM_EnvironmentVLHGC* env, UDATA card, bool needToCheckMarkMap)", "originalCommit": "47aa9c2b8206c236bc0ae6a33163304151c38295", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b850c12f0da0158fae7ee8d3272a435c8aef27e9", "url": "https://github.com/eclipse-openj9/openj9/commit/b850c12f0da0158fae7ee8d3272a435c8aef27e9", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>", "committedDate": "2020-03-27T19:29:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ5NjkyNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r399496924", "bodyText": "This whole comment should be updated:\nRegions that are completely swept or parts of regions that are partially swept after a GMP might still have outgoing references. If they are (if they may not contain objects), cards should be removed.", "author": "amicic", "createdAt": "2020-03-27T19:35:03Z", "path": "runtime/gc_vlhgc/InterRegionRememberedSet.cpp", "diffHunk": "@@ -933,11 +935,12 @@ MM_InterRegionRememberedSet::clearFromRegionReferencesForMarkDirect(MM_Environme\n \t\t\t\twhile(0 != (card = rsclCardIterator.nextReferencingCard(env))) {\n \t\t\t\t\tMM_HeapRegionDescriptorVLHGC *fromRegion = tableDescriptorForRememberedSetCard(card);\n \t\t\t\t\tCard * cardAddress = rememberedSetCardToCardAddr(env, card);\n-\t\t\t\t\t/* Regions that are completely swept after a GMP, might still have outgoing references (thus we consider empty regions too) */\n-\t\t\t\t\tif (fromRegion->_markData._shouldMark  || !fromRegion->containsObjects() || isDirtyCardForPartialCollect(env, cardTable, cardAddress)) {\n+\t\t\t\t\t/* Regions that are completely swept after a GMP, might still have outgoing references (thus we consider cardContainsNoObjects) */", "originalCommit": "b850c12f0da0158fae7ee8d3272a435c8aef27e9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fe52ec3f97dd2f0da58b89537bfe4cd697266653", "url": "https://github.com/eclipse-openj9/openj9/commit/fe52ec3f97dd2f0da58b89537bfe4cd697266653", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>", "committedDate": "2020-03-27T20:01:27Z", "type": "forcePushed"}, {"oid": "3d321a7c16be5275a8f745a6f623d8febcfa4ea8", "url": "https://github.com/eclipse-openj9/openj9/commit/3d321a7c16be5275a8f745a6f623d8febcfa4ea8", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>", "committedDate": "2020-03-27T20:11:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUyNjgwOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r399526809", "bodyText": "both helpers could be static (hence saving by not passing implicit 'this' pointer)", "author": "amicic", "createdAt": "2020-03-27T20:40:56Z", "path": "runtime/gc_vlhgc/InterRegionRememberedSet.hpp", "diffHunk": "@@ -185,8 +189,39 @@ class MM_InterRegionRememberedSet : public MM_BaseVirtual\n \tvoid clearFromRegionReferencesForCompactOptimized(MM_EnvironmentVLHGC* env);\n \tMM_InterRegionRememberedSet(MM_HeapRegionManager *heapRegionManager);\n \t\n+\n+\t/**\n+\t * Helper function isCompressedCardDirtyForPartialCollect\n+\t * extended from compressedCardTable->isCompressedCardDirtyForPartialCollect(), only in case first PGC after GMP, also dirty card if card Contains No Object.\n+\t */\n+\tMMINLINE bool isCompressedCardDirtyForPartialCollect(MM_EnvironmentVLHGC* env, UDATA card, MM_CompressedCardTable *compressedCardTable, bool needToCheckMarkMap, MM_MarkMap *markMap)\n+\t{\n+\t\tvoid* heapAddress = convertHeapAddressFromRememberedSetCard(card);\n+\t\tbool ret = compressedCardTable->isCompressedCardDirtyForPartialCollect(env, heapAddress);\n+\t\tif (!ret && needToCheckMarkMap) {\n+\t\t\tret = markMap->areAnyLiveObjectsInCard(heapAddress);\n+\t\t}\n+\t\treturn ret;\n+\n+\t}\n protected:\n public:\n+\t/**\n+\t * Helper function cardMayContainObjects\n+\t * if this is first PGC after GMP, check if markMap->areAnyLiveObjectsInCard()\n+\t * otherwise check if region->containsObjects()\n+\t */\n+\tMMINLINE bool cardMayContainObjects(UDATA card, MM_HeapRegionDescriptorVLHGC *fromRegion, bool needToCheckMarkMap, MM_MarkMap *markMap)", "originalCommit": "3d321a7c16be5275a8f745a6f623d8febcfa4ea8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e27f867158b68f49d761a544c6ec71897193faa8", "url": "https://github.com/eclipse-openj9/openj9/commit/e27f867158b68f49d761a544c6ec71897193faa8", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>", "committedDate": "2020-03-27T20:46:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUzMDg0MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r399530841", "bodyText": "move open bracket to previous line", "author": "amicic", "createdAt": "2020-03-27T20:49:53Z", "path": "runtime/gc_vlhgc/CardListFlushTask.cpp", "diffHunk": "@@ -96,6 +97,11 @@ MM_CardListFlushTask::run(MM_EnvironmentBase *envBase)\n {\n \tMM_EnvironmentVLHGC *env = MM_EnvironmentVLHGC::getEnvironment(envBase);\n \tMM_GCExtensions *extensions = MM_GCExtensions::getExtensions(env);\n+\tMM_MarkMap *markMap = NULL;\n+\tif (static_cast<MM_CycleStateVLHGC*>(envBase->_cycleState)->_schedulingDelegate->isFirstPGCAfterGMP())\n+\t{", "originalCommit": "e27f867158b68f49d761a544c6ec71897193faa8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU1MDkwMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r399550902", "bodyText": "your fixed the other two, but not this one :)", "author": "amicic", "createdAt": "2020-03-27T21:40:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUzMDg0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUzMTA0MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r399531040", "bodyText": "move bracket", "author": "amicic", "createdAt": "2020-03-27T20:50:21Z", "path": "runtime/gc_vlhgc/InterRegionRememberedSet.cpp", "diffHunk": "@@ -914,7 +913,13 @@ void\n MM_InterRegionRememberedSet::clearFromRegionReferencesForMarkDirect(MM_EnvironmentVLHGC* env)\n {\n \tPORT_ACCESS_FROM_ENVIRONMENT(env);\n-\tMM_CardTable *cardTable = MM_GCExtensions::getExtensions(env)->cardTable;\n+\tMM_GCExtensions *extensions = MM_GCExtensions::getExtensions(env);\n+\tMM_CardTable *cardTable = extensions->cardTable;\n+\tMM_MarkMap *markMap = NULL;\n+\tif (static_cast<MM_CycleStateVLHGC*>(env->_cycleState)->_schedulingDelegate->isFirstPGCAfterGMP())\n+\t{", "originalCommit": "e27f867158b68f49d761a544c6ec71897193faa8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUzMTE2Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r399531166", "bodyText": "bracket", "author": "amicic", "createdAt": "2020-03-27T20:50:38Z", "path": "runtime/gc_vlhgc/InterRegionRememberedSet.cpp", "diffHunk": "@@ -969,8 +975,14 @@ void\n MM_InterRegionRememberedSet::clearFromRegionReferencesForMarkOptimized(MM_EnvironmentVLHGC* env)\n {\n \tPORT_ACCESS_FROM_ENVIRONMENT(env);\n-\tMM_CardTable *cardTable = MM_GCExtensions::getExtensions(env)->cardTable;\n-\tMM_CompressedCardTable *compressedCardTable = MM_GCExtensions::getExtensions(env)->compressedCardTable;\n+\tMM_GCExtensions *extensions = MM_GCExtensions::getExtensions(env);\n+\tMM_CardTable *cardTable = extensions->cardTable;\n+\tMM_CompressedCardTable *compressedCardTable = extensions->compressedCardTable;\n+\tMM_MarkMap *markMap = NULL;\n+\tif (static_cast<MM_CycleStateVLHGC*>(env->_cycleState)->_schedulingDelegate->isFirstPGCAfterGMP())\n+\t{", "originalCommit": "e27f867158b68f49d761a544c6ec71897193faa8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUzNDI1NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r399534255", "bodyText": "comment says 'also dirty card'\ndid you mean 'also remove card'?", "author": "amicic", "createdAt": "2020-03-27T20:57:59Z", "path": "runtime/gc_vlhgc/InterRegionRememberedSet.hpp", "diffHunk": "@@ -185,8 +189,39 @@ class MM_InterRegionRememberedSet : public MM_BaseVirtual\n \tvoid clearFromRegionReferencesForCompactOptimized(MM_EnvironmentVLHGC* env);\n \tMM_InterRegionRememberedSet(MM_HeapRegionManager *heapRegionManager);\n \t\n+\n+\t/**\n+\t * Helper function isCompressedCardDirtyForPartialCollect\n+\t * extended from compressedCardTable->isCompressedCardDirtyForPartialCollect(), only in case first PGC after GMP, also dirty card if card Contains No Object.", "originalCommit": "e27f867158b68f49d761a544c6ec71897193faa8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU0MzczMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r399543733", "bodyText": "compressedCardTable->isCompressedCardDirtyForPartialCollect() return true if the card is dirty, extra condition if the card Contains No Object return true (the card is dirty)", "author": "LinHu2016", "createdAt": "2020-03-27T21:21:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUzNDI1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU0OTcxNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r399549715", "bodyText": "Ah, then it should say 'also return as dirty'. As-is I understood you imply an action of dirtying the card.", "author": "amicic", "createdAt": "2020-03-27T21:37:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUzNDI1NQ=="}], "type": "inlineReview"}, {"oid": "1f047a6939cee98a11905417ca1d4912632995c8", "url": "https://github.com/eclipse-openj9/openj9/commit/1f047a6939cee98a11905417ca1d4912632995c8", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>", "committedDate": "2020-03-27T21:21:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU1MDQ4NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r399550484", "bodyText": "add comment:\nTODO: consider incorporating areAnyLiveObjectsInCard info when building Compressed Card Table", "author": "amicic", "createdAt": "2020-03-27T21:39:14Z", "path": "runtime/gc_vlhgc/InterRegionRememberedSet.hpp", "diffHunk": "@@ -185,8 +189,39 @@ class MM_InterRegionRememberedSet : public MM_BaseVirtual\n \tvoid clearFromRegionReferencesForCompactOptimized(MM_EnvironmentVLHGC* env);\n \tMM_InterRegionRememberedSet(MM_HeapRegionManager *heapRegionManager);\n \t\n+\n+\t/**\n+\t * Helper function isCompressedCardDirtyForPartialCollect\n+\t * extended from compressedCardTable->isCompressedCardDirtyForPartialCollect(), only in case first PGC after GMP, also dirty card if card Contains No Object.\n+\t */\n+\tMMINLINE static bool isCompressedCardDirtyForPartialCollect(MM_EnvironmentVLHGC* env, UDATA card, MM_CompressedCardTable *compressedCardTable, MM_MarkMap *markMap)\n+\t{\n+\t\tvoid* heapAddress = convertHeapAddressFromRememberedSetCard(card);\n+\t\tbool ret = compressedCardTable->isCompressedCardDirtyForPartialCollect(env, heapAddress);\n+\t\tif (!ret && (NULL != markMap)) {", "originalCommit": "1f047a6939cee98a11905417ca1d4912632995c8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "08dd3beeea8fe6ab08abaee6af60ddbd84b3c659", "url": "https://github.com/eclipse-openj9/openj9/commit/08dd3beeea8fe6ab08abaee6af60ddbd84b3c659", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>", "committedDate": "2020-03-27T21:51:51Z", "type": "forcePushed"}, {"oid": "81ae862e37e11c6385e18f4fa0c4b65a0186d3f6", "url": "https://github.com/eclipse-openj9/openj9/commit/81ae862e37e11c6385e18f4fa0c4b65a0186d3f6", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>", "committedDate": "2020-03-27T21:58:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTU2NDQwOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8804#discussion_r399564409", "bodyText": "These helpers won't be able to be static, afterall :( . It may work now, but once OMR_GC_FULL_POINTERS is enabled, they will indirectly rely on class member _compressObjectReferences", "author": "amicic", "createdAt": "2020-03-27T22:21:38Z", "path": "runtime/gc_vlhgc/InterRegionRememberedSet.hpp", "diffHunk": "@@ -185,14 +189,46 @@ class MM_InterRegionRememberedSet : public MM_BaseVirtual\n \tvoid clearFromRegionReferencesForCompactOptimized(MM_EnvironmentVLHGC* env);\n \tMM_InterRegionRememberedSet(MM_HeapRegionManager *heapRegionManager);\n \t\n+\n+\t/**\n+\t * Helper function isCompressedCardDirtyForPartialCollect\n+\t * extended from compressedCardTable->isCompressedCardDirtyForPartialCollect(), only in case first PGC after GMP, also return as dirty if card Contains No Object.\n+\t */\n+\tMMINLINE static bool isCompressedCardDirtyForPartialCollect(MM_EnvironmentVLHGC* env, UDATA card, MM_CompressedCardTable *compressedCardTable, MM_MarkMap *markMap)\n+\t{\n+\t\tvoid* heapAddress = convertHeapAddressFromRememberedSetCard(card);\n+\t\tbool ret = compressedCardTable->isCompressedCardDirtyForPartialCollect(env, heapAddress);\n+\t\tif (!ret && (NULL != markMap)) {\n+\t\t\t/* TODO: consider incorporating areAnyLiveObjectsInCard info when building CompressedCard */\n+\t\t\tret = !markMap->areAnyLiveObjectsInCard(heapAddress);\n+\t\t}\n+\t\treturn ret;\n+\n+\t}\n protected:\n public:\n+\t/**\n+\t * Helper function cardMayContainObjects\n+\t * if this is first PGC after GMP, check if markMap->areAnyLiveObjectsInCard()\n+\t * otherwise check if region->containsObjects()\n+\t */\n+\tMMINLINE static bool cardMayContainObjects(UDATA card, MM_HeapRegionDescriptorVLHGC *fromRegion, MM_MarkMap *markMap)", "originalCommit": "81ae862e37e11c6385e18f4fa0c4b65a0186d3f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c9711af8c1b81fe3972ab2b18d527003a9ec45ce", "url": "https://github.com/eclipse-openj9/openj9/commit/c9711af8c1b81fe3972ab2b18d527003a9ec45ce", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>", "committedDate": "2020-03-27T22:31:02Z", "type": "commit"}, {"oid": "c9711af8c1b81fe3972ab2b18d527003a9ec45ce", "url": "https://github.com/eclipse-openj9/openj9/commit/c9711af8c1b81fe3972ab2b18d527003a9ec45ce", "message": "Pruning the cards from InterRegionRememberedsets after GMP\n\n\tAfter Global Marking Phase, the cards reference from \"free memory\"\n\tshould be pruned from InterRegionRememberedsets, in order to\n\treuse the free memory in future, currently we have card refresh\n\tand card pruning in beginning PGC, so piggyback existing logic\n\tadd extra condition for pruning cards related with \"free memory\"\n\tin first PGC after GMP.\n\n\t- During Rememberedsets flush in the beginning PGC(for\n\tcollection set), extra condition check for dirty card (do not\n\tdirty card if corresponding MarkMap is 0)\n\t- During global Rememberedsets prune, extra condition check\n\tfor pruning the card (do remove the card if corresponding\n\tMarkMap is 0).\n\nSigned-off-by: Lin Hu <linhu@ca.ibm.com>", "committedDate": "2020-03-27T22:31:02Z", "type": "forcePushed"}]}