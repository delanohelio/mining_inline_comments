{"pr_number": 9737, "pr_title": "Add trace points for JITServer", "pr_createdAt": "2020-05-28T20:11:37Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/9737", "timeline": [{"oid": "0eb2e6c55f50632ff0a121b1f51e57ededda5a9d", "url": "https://github.com/eclipse-openj9/openj9/commit/0eb2e6c55f50632ff0a121b1f51e57ededda5a9d", "message": "Add trace points for JITServer\n\nAdd the second set of trace points for JITServer.\n\nImplements #9482\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>", "committedDate": "2020-05-29T16:32:13Z", "type": "forcePushed"}, {"oid": "d2c1421cc8c61346727bb5ea229a5523bc7b898a", "url": "https://github.com/eclipse-openj9/openj9/commit/d2c1421cc8c61346727bb5ea229a5523bc7b898a", "message": "Add trace points for JITServer\n\nAdd the second set of trace points for JITServer.\n\nImplements #9482\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>", "committedDate": "2020-05-29T17:53:40Z", "type": "forcePushed"}, {"oid": "c47f881706f7d99a148da6ece0e0768abec245f5", "url": "https://github.com/eclipse-openj9/openj9/commit/c47f881706f7d99a148da6ece0e0768abec245f5", "message": "Add trace points for JITServer\n\nAdd the second set of trace points for JITServer.\n\nImplements #9482\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>", "committedDate": "2020-05-29T22:01:56Z", "type": "forcePushed"}, {"oid": "6c55296f2429d805af4a044a6ca5a7e295bf3296", "url": "https://github.com/eclipse-openj9/openj9/commit/6c55296f2429d805af4a044a6ca5a7e295bf3296", "message": "Add trace points for JITServer\n\nAdd the second set of trace points for JITServer.\n\nImplements #9482\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>", "committedDate": "2020-05-29T22:24:57Z", "type": "forcePushed"}, {"oid": "c2b91e35360c26859ff0ad3280ad3e3e84dfb2ad", "url": "https://github.com/eclipse-openj9/openj9/commit/c2b91e35360c26859ff0ad3280ad3e3e84dfb2ad", "message": "Add trace points for JITServer\n\nAdd the second set of trace points for JITServer.\n\nImplements #9482\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>", "committedDate": "2020-06-01T18:55:27Z", "type": "forcePushed"}, {"oid": "83effb119a2ec18621070b2cee95470cb6959096", "url": "https://github.com/eclipse-openj9/openj9/commit/83effb119a2ec18621070b2cee95470cb6959096", "message": "Add trace points for JITServer\n\nAdd the second set of trace points for JITServer.\n\nImplements #9482\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>", "committedDate": "2020-06-01T18:59:05Z", "type": "forcePushed"}, {"oid": "94b2ad25ef582095cb09af5b1790725da863f379", "url": "https://github.com/eclipse-openj9/openj9/commit/94b2ad25ef582095cb09af5b1790725da863f379", "message": "Add trace points for JITServer\n\nAdd the second set of trace points for JITServer.\n\nImplements #9482\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>", "committedDate": "2020-06-01T19:07:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ3MTI2NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9737#discussion_r433471265", "bodyText": "Not sure if this is true any longer, or that we care about this for JITServer but I believe the trace point IDs of existing tracepoints will change if you add new tracepoints in the middle of one of these .tdf files. Probably doesn't matter here as I doubt anything is consuming these.", "author": "fjeremic", "createdAt": "2020-06-01T20:28:19Z", "path": "runtime/compiler/env/j9jit.tdf", "diffHunk": "@@ -90,26 +90,41 @@ TraceEvent=Trc_JITServerMethodSuccessfullyLoaded Overhead=1 Level=2 Test Templat\n TraceEvent=Trc_JITServerMethodFailedToLoad       Overhead=1 Level=2 Test Template=\"JITClient: Client failed to load method %s @ %s following compilation request\"\n TraceEvent=Trc_JITServerServerCompilationFailure Overhead=1 Level=2 Test Template=\"JITClient: ServerCompilationFailure: errCode %u for %s @ %s\"\n TraceEvent=Trc_JITServerRetryLocalCompile        Overhead=1 Level=2 Test Template=\"JITClient: Server is not available. Retry with local compilation for %s @ %s\"\n+TraceEvent=Trc_JITServerRelocationFailure        Overhead=1 Level=2 Test Template=\"JITClient: Relocation failure: %d\"\n+TraceEvent=Trc_JITServerRelocationAOTFailure     Overhead=1 Level=2 Test Template=\"JITClient: AOT Relocation failure: %d\"\n+TraceEvent=Trc_JITServerApplyRemoteAOTRelocation Overhead=1 Level=2 Test Template=\"JITClient: Applying remote AOT relocations to newly AOT compiled body for %s @ %s\"\n+TraceEvent=Trc_JITServerCommitCHTableFailed      Overhead=1 Level=2 Test Template=\"JITClient: Failure while committing chtable for %s\"\n \n-TraceEvent=Trc_JITServerClientSessionData    Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d set clientSessionData=%p for clientUID=%llu seqNo=%u\"\n-TraceEvent=Trc_JITServerUnloadClasses        Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d will process a list of %llu unloaded classes for clientUID %llu\"\n+TraceEvent=Trc_JITServerClientSessionData    Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d %s clientSessionData=%p for clientUID=%llu seqNo=%u\"\n TraceEvent=Trc_JITServerEarlyAbort           Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d did an early abort\"\n TraceEvent=Trc_JITServerEarlyAbortClientData Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d did an early abort for clientUID=%llu seqNo=%u\"\n-TraceEvent=Trc_JITServerCompileEnd           Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d has successfully compiled %s\"\n-TraceEvent=Trc_JITServerFailedToCompile      Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d has failed to compile: compErrCode %u %s\"\n-TraceEvent=Trc_JITServerFailedToRecompile    Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d has failed to recompile: compErrCode %u %s\"\n-\n-TraceEvent=Trc_JITServerTimedWait            Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d (entry=%p) doing a timed wait for %d ms\"\n-TraceEvent=Trc_JITServerParkThread           Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d (entry=%p) is parked. seqNo=%u was notified\"\n-TraceEvent=Trc_JITServerTimedOut             Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d (entry=%p) timed-out while waiting for seqNo=%d \"\n-TraceEvent=Trc_JITServerClearedSessionCaches Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d has cleared the session caches for clientUID=%llu expectedSeqNo=%u detachedEntry=%p\"\n-TraceEvent=Trc_JITServerThreadGoSleep        Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d which previously timed-out will go to sleep again. Possible reasons numActiveThreads=%d waitToBeNotified=%d\"\n-TraceEvent=Trc_JITServerOutOfSequenceMessage Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d out-of-sequence msg detected for clientUID=%llu seqNo=%u > expectedSeqNo=%u. Parking this thread (entry=%p)\"\n-TraceEvent=Trc_JITServerDiscardMessage       Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d discarding older msg for clientUID=%llu seqNo=%u < expectedSeqNo=%u\"\n+TraceEvent=Trc_JITServerCompileEnd           Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d has successfully compiled %s @ %s\"\n+TraceEvent=Trc_JITServerFailedToCompile      Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d has failed to compile: compErrCode %u %s @ %s\"\n+TraceEvent=Trc_JITServerFailedToRecompile    Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d has failed to recompile: compErrCode %u %s @ %s\"\n+TraceEvent=Trc_JITServerFailedToCompileNewInstanceThunk  Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d has failed to compile a new instance thunk\"\n+TraceEvent=Trc_JITServerFailedToCompileDLT               Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d has failed to compile a DLT method\"\n+TraceEvent=Trc_JITServerFailedToCompileMethodHandleThunk Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d has failed to compile a methodHandleThunk method\"\n+\n+TraceEvent=Trc_JITServerTimedWait            Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d clientSessionData=%p clientUID=%llu (entry=%p) (seqNo=%u, expectedSeqNo=%u, numActiveThreads=%d) doing a timed wait for %d ms\"\n+TraceEvent=Trc_JITServerParkThread           Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d clientSessionData=%p clientUID=%llu (entry=%p) (seqNo=%u, expectedSeqNo=%u, numActiveThreads=%d) is parked. seqNo=%u was notified\"\n+TraceEvent=Trc_JITServerTimedOut             Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d clientSessionData=%p clientUID=%llu (entry=%p) (seqNo=%u, expectedSeqNo=%u, numActiveThreads=%d) timed-out while waiting for seqNo=%u\"\n+TraceEvent=Trc_JITServerClearedSessionCaches Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d clientSessionData=%p clientUID=%llu (seqNo=%u, expectedSeqNo=%u, numActiveThreads=%d) has cleared the session cache detachedEntry=%p. Setting expectedSeqNo from %u to %u\"\n+TraceEvent=Trc_JITServerThreadGoSleep        Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d clientSessionData=%p clientUID=%llu (seqNo=%u, expectedSeqNo=%u, numActiveThreads=%d) which previously timed-out will go to sleep again. Possible reasons waitToBeNotified=%d\"\n+TraceEvent=Trc_JITServerUpdateSeqNo          Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d clientSessionData=%p clientUID=%llu (seqNo=%u, expectedSeqNo=%u, numActiveThreads=%d) updating expectedSeqNo from %u to %u\"\n+TraceEvent=Trc_JITServerOutOfSequenceMessage Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d clientSessionData=%p clientUID=%llu (entry=%p) (seqNo=%u, expectedSeqNo=%u, numActiveThreads=%d) out-of-sequence msg detected. Parking this thread\"\n+TraceEvent=Trc_JITServerDiscardMessage       Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d clientSessionData=%p clientUID=%llu (seqNo=%u, expectedSeqNo=%u, numActiveThreads=%d) discarding the older msg\"\n+TraceEvent=Trc_JITServerUnexpectedSeqNo      Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d clientSessionData=%p clientUID=%llu (seqNo=%u, expectedSeqNo=%u, numActiveThreads=%d) unexpected seqNo\"\n+\n+TraceEvent=Trc_JITServerInitCHTable          Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d clientSessionData=%p clientUID=%llu initialize CHTable size %llu\"\n+TraceEvent=Trc_JITServerAbortInitCHTable     Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d clientSessionData=%p clientUID=%llu CHTable is not empty size %llu. Abort the update size %llu\"\n+TraceEvent=Trc_JITServerDoCHTableUpdate      Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d clientSessionData=%p clientUID=%llu do CHTable update modified %llu and removed %llu\"\n+\n+TraceEvent=Trc_JITServerUnloadClasses        Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d clientSessionData=%p clientUID=%llu will process a list of %llu unloaded classes\"\n+TraceEvent=Trc_JITServerFreeCHTable          Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d clientSessionData=%p clientUID=%llu will free CHTable\"\n \n TraceEvent=Trc_JITServerStreamFailure                Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d (%s) stream failure (compiling %s @ %s): %s\"\n TraceEvent=Trc_JITServerStreamVersionIncompatible    Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d (%s) stream version incompatible (compiling %s @ %s): %s\"\n TraceEvent=Trc_JITServerStreamMessageTypeMismatch    Overhead=1 Level=1 Test Template=\"JITServer: compThreadID=%d (%s) stream message type mismatch (compiling %s @ %s): %s\"", "originalCommit": "94b2ad25ef582095cb09af5b1790725da863f379", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUwMjQwNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9737#discussion_r433502407", "bodyText": "I think the trace point IDs of existing tracepoints will change in this case. I didn't find the existing code that consumes these IDs. So far all the new JITServer tracepoints have been added at the end of  j9jit.tdf which wouldn't affect the existing Non-JITServer tracepoint IDs. We're still rearranging the JITServer related tracepoints. Thanks for pointing this out. It's very good to keep it in mind when making the changes later on.", "author": "a7ehuo", "createdAt": "2020-06-01T21:33:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ3MTI2NQ=="}], "type": "inlineReview"}, {"oid": "34aaea73511ee5a68bc7d3a21dea64e4c7f865b3", "url": "https://github.com/eclipse-openj9/openj9/commit/34aaea73511ee5a68bc7d3a21dea64e4c7f865b3", "message": "Add trace points for JITServer\n\nAdd the second set of trace points for JITServer.\n\nImplements #9482\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>", "committedDate": "2020-06-02T14:36:14Z", "type": "commit"}, {"oid": "34aaea73511ee5a68bc7d3a21dea64e4c7f865b3", "url": "https://github.com/eclipse-openj9/openj9/commit/34aaea73511ee5a68bc7d3a21dea64e4c7f865b3", "message": "Add trace points for JITServer\n\nAdd the second set of trace points for JITServer.\n\nImplements #9482\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>", "committedDate": "2020-06-02T14:36:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAzNDkzNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9737#discussion_r434034937", "bodyText": "This TODO may belong to another PR.", "author": "mpirvu", "createdAt": "2020-06-02T17:04:24Z", "path": "runtime/compiler/control/JITServerCompilationThread.cpp", "diffHunk": "@@ -455,6 +476,12 @@ TR::CompilationInfoPerThreadRemote::processEntry(TR_MethodToBeCompiled &entry, J\n       // Update the expecting sequence number. This will allow subsequent\n       // threads to pass through once we've released the sequencing monitor.\n       TR_ASSERT(seqNo == clientSession->getExpectedSeqNo(), \"Unexpected seqNo=%u expected=%u\\n\", seqNo, clientSession->getExpectedSeqNo());\n+\n+      //TODO: Might need to set the expectedSeqNo as (seqNo+1) instead of (expectedSeqNo+1)", "originalCommit": "34aaea73511ee5a68bc7d3a21dea64e4c7f865b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAzOTg2MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9737#discussion_r434039861", "bodyText": "I plan to remove in #9763 next.", "author": "a7ehuo", "createdAt": "2020-06-02T17:12:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAzNDkzNw=="}], "type": "inlineReview"}]}