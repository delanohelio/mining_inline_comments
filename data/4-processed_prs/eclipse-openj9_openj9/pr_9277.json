{"pr_number": 9277, "pr_title": "Disable JProfiling and JitProfiling for JITServer", "pr_createdAt": "2020-04-17T20:23:27Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/9277", "timeline": [{"oid": "abd0dce5dcf40f6305afc93c48e8d765000cd368", "url": "https://github.com/eclipse-openj9/openj9/commit/abd0dce5dcf40f6305afc93c48e8d765000cd368", "message": "Disable JProfiling and JitProfiling for JITServer\n\nJProfiling and JitProfiling are not supported by JITServer.\nJProfiling is disabled by setting an option,\nbut for JitProfiling need to ensure that `TR_PersistentProfileInfo`\nrecords do not get created and set pointers to them to NULL\non the server, if they do get created.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-04-17T21:24:43Z", "type": "forcePushed"}, {"oid": "0978498444b103b0c7776e6b3c7ef20bf602355b", "url": "https://github.com/eclipse-openj9/openj9/commit/0978498444b103b0c7776e6b3c7ef20bf602355b", "message": "Disable JProfiling and JitProfiling for JITServer\n\nJProfiling and JitProfiling are not supported by JITServer.\nJProfiling is disabled by setting an option,\nbut for JitProfiling need to ensure that `TR_PersistentProfileInfo`\nrecords do not get created and set pointers to them to NULL\non the server, if they do get created.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-04-17T21:27:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ4NjYzMQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9277#discussion_r410486631", "bodyText": "Below, we check for _methodInfo->isProfilingDisabled()\nThis is set in the constructor\nTR_PersistentMethodInfo::TR_PersistentMethodInfo(TR::Compilation *comp)\n{\n...\n  if (comp->getOption(TR_DisableProfiling))\n      {\n      setDisableProfiling();\n      }\n...\n}\n\nSo, if we disabled profiling we don't need anything else in this method.", "author": "mpirvu", "createdAt": "2020-04-17T21:49:40Z", "path": "runtime/compiler/control/J9Recompilation.cpp", "diffHunk": "@@ -341,6 +349,14 @@ J9::Recompilation::endOfCompilation()\n bool\n J9::Recompilation::switchToProfiling(uint32_t f, uint32_t c)\n    {\n+   // JITServer doesn't support JitProfiling\n+#if defined(J9VM_OPT_JITSERVER)", "originalCommit": "0978498444b103b0c7776e6b3c7ef20bf602355b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ5MTk1NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9277#discussion_r410491955", "bodyText": "I scanned the code and as far as I can tell optimizationPlan->insertInstrumentation() is false if getOption(TR_DisableProfiling) is true. Thus, we don't need the check on JITServer::SERVER or JITServer::CLIENT", "author": "mpirvu", "createdAt": "2020-04-17T22:04:00Z", "path": "runtime/compiler/control/J9Recompilation.cpp", "diffHunk": "@@ -126,10 +126,18 @@ J9::Recompilation::setupMethodInfo()\n \n    // TR_Controller is being used and has provided a compilation plan.  Use it to setup the compilation\n    //\n+   // JITServer does not support JitProfiling\n+   bool performProfiling = (optimizationPlan->insertInstrumentation() != 0);", "originalCommit": "0978498444b103b0c7776e6b3c7ef20bf602355b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQ5NDkzNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9277#discussion_r410494935", "bodyText": "I would use do this in J9Options.cpp in J9::Options::setupJITServerOptions()\nAlso add  self()->setOption(TR_EnableJProfiling, false); as I don't see it.", "author": "mpirvu", "createdAt": "2020-04-17T22:13:30Z", "path": "runtime/compiler/control/rossa.cpp", "diffHunk": "@@ -1586,6 +1586,14 @@ onLoadInternal(\n       ((TR_JitPrivateConfig*)(jitConfig->privateConfig))->iProfiler = NULL;\n       }\n \n+#if defined(J9VM_OPT_JITSERVER)\n+   // JITServer doesn't support JProfiling\n+   if (persistentMemory->getPersistentInfo()->getRemoteCompilationMode() == JITServer::CLIENT\n+       || persistentMemory->getPersistentInfo()->getRemoteCompilationMode() == JITServer::SERVER)\n+      {\n+      TR::Options::getCmdLineOptions()->setOption(TR_DisableJProfilerThread);", "originalCommit": "0978498444b103b0c7776e6b3c7ef20bf602355b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7cd89d4e4a2c2f1b465e0718bc3f0dbe90f47314", "url": "https://github.com/eclipse-openj9/openj9/commit/7cd89d4e4a2c2f1b465e0718bc3f0dbe90f47314", "message": "Try to simplify the commit\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-04-24T20:31:56Z", "type": "forcePushed"}, {"oid": "f7f046275553d3bf719cb9d0c48a8f29be338f15", "url": "https://github.com/eclipse-openj9/openj9/commit/f7f046275553d3bf719cb9d0c48a8f29be338f15", "message": "Try to simplify the commit\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-04-24T20:32:46Z", "type": "forcePushed"}, {"oid": "6ce4d60de6ac3614699ef9f6ef1d0c4303fb0719", "url": "https://github.com/eclipse-openj9/openj9/commit/6ce4d60de6ac3614699ef9f6ef1d0c4303fb0719", "message": "Disable JProfiling and JitProfiling for JITServer\n\nJProfiling and JitProfiling are not supported by JITServer.\nJProfiling is disabled by setting an option,\nbut for JitProfiling need to ensure that `TR_PersistentProfileInfo`\nrecords do not get created and set pointers to them to NULL\non the server, if they do get created.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-04-24T21:18:18Z", "type": "forcePushed"}, {"oid": "389fa38d601a2cd06d3ad665e79546ded21208ba", "url": "https://github.com/eclipse-openj9/openj9/commit/389fa38d601a2cd06d3ad665e79546ded21208ba", "message": "Disable JProfiling and JitProfiling for JITServer\n\nJProfiling and JitProfiling are not supported by JITServer.\nJProfiling is disabled by setting an option,\nbut for JitProfiling need to ensure that `TR_PersistentProfileInfo`\nrecords do not get created and set pointers to them to NULL\non the server, if they do get created.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-04-24T21:25:54Z", "type": "forcePushed"}, {"oid": "aafdf81c440d71ca5ccbda9e1fa5411ac3946895", "url": "https://github.com/eclipse-openj9/openj9/commit/aafdf81c440d71ca5ccbda9e1fa5411ac3946895", "message": "Disable JProfiling and JitProfiling for JITServer\n\nJProfiling and JitProfiling are not supported by JITServer.\nJProfiling is disabled by setting an option,\nbut for JitProfiling need to ensure that `TR_PersistentProfileInfo`\nrecords do not get created and set pointers to them to NULL\non the server, if they do get created.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-04-27T16:02:46Z", "type": "commit"}, {"oid": "aafdf81c440d71ca5ccbda9e1fa5411ac3946895", "url": "https://github.com/eclipse-openj9/openj9/commit/aafdf81c440d71ca5ccbda9e1fa5411ac3946895", "message": "Disable JProfiling and JitProfiling for JITServer\n\nJProfiling and JitProfiling are not supported by JITServer.\nJProfiling is disabled by setting an option,\nbut for JitProfiling need to ensure that `TR_PersistentProfileInfo`\nrecords do not get created and set pointers to them to NULL\non the server, if they do get created.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-04-27T16:02:46Z", "type": "forcePushed"}]}