{"pr_number": 11203, "pr_title": "Enable the check for sealed classes for Java 16", "pr_createdAt": "2020-11-17T05:33:50Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/11203", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE1NzI2MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/11203#discussion_r525157260", "bodyText": "59 is Java 15, correct?  Shouldn't this be >59 (Java 16) then?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\tif (_classFile->majorVersion >= 59) {\n          \n          \n            \n            \t\t\tif (_classFile->majorVersion > 59) {", "author": "DanHeidinga", "createdAt": "2020-11-17T13:36:44Z", "path": "runtime/bcutil/ClassFileOracle.cpp", "diffHunk": "@@ -502,9 +502,8 @@ ClassFileOracle::walkAttributes()\n \t\t\tbreak;\n \t\t}\n \t\tcase CFR_ATTRIBUTE_PermittedSubclasses: {\n-\t\t\t/* PermittedSubclasses verification is for Java 15 preview only. Don't record the attribute for other class versions\n-\t\t\t * since it may be corrupt. */\n-\t\t\tif ((59 == _classFile->majorVersion) && (0 < _classFile->minorVersion)) {\n+\t\t\t/* PermittedSubclasses verification is for Java version >= 15 */\n+\t\t\tif (_classFile->majorVersion >= 59) {", "originalCommit": "731f73fac39a032ef302ff526481e59efb4354de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTIyODAyMQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11203#discussion_r525228021", "bodyText": "Agreed and updated as suggested above (I previously thought it should include 59 given it was implemented in Java 15).", "author": "ChengJin01", "createdAt": "2020-11-17T15:07:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE1NzI2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE1NzQ2Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/11203#discussion_r525157466", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t/* PermittedSubclasses verification is for Java version >= 15 */\n          \n          \n            \n            \t\t\tif (classfile->majorVersion >= 59) {\n          \n          \n            \n            \t\t\t/* PermittedSubclasses verification is for Java version > 15 */\n          \n          \n            \n            \t\t\tif (classfile->majorVersion > 59) {", "author": "DanHeidinga", "createdAt": "2020-11-17T13:37:02Z", "path": "runtime/bcutil/cfreader.c", "diffHunk": "@@ -2376,8 +2376,8 @@ checkAttributes(J9PortLibrary* portLib, J9CfrClassFile* classfile, J9CfrAttribut\n \t\t\tbreak;\n \n \t\tcase CFR_ATTRIBUTE_PermittedSubclasses:\n-\t\t\t/* PermittedSubclasses verification is for Java 15 preview only. */\n-\t\t\tif ((59 == classfile->majorVersion) && (0 < classfile->minorVersion)) {\n+\t\t\t/* PermittedSubclasses verification is for Java version >= 15 */\n+\t\t\tif (classfile->majorVersion >= 59) {", "originalCommit": "731f73fac39a032ef302ff526481e59efb4354de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTIyODIxNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11203#discussion_r525228215", "bodyText": "Agreed and updated as suggested above.", "author": "ChengJin01", "createdAt": "2020-11-17T15:07:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE1NzQ2Ng=="}], "type": "inlineReview"}, {"oid": "fede363358640bd92eec2cee8a727e493ba443ae", "url": "https://github.com/eclipse-openj9/openj9/commit/fede363358640bd92eec2cee8a727e493ba443ae", "message": "Enable the check for sealed classes for Java 16\n\nThe change is enable the check for sealed classes\nfor Java 16 during the static verification.\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-11-17T15:06:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTIzNTA2OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11203#discussion_r525235069", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\tif (_classFile->majorVersion > 59) {\n          \n          \n            \n            \t\t\tif ((_classFile->majorVersion > 59) \n          \n          \n            \n            \t\t\t|| ((59 == _classFile->majorVersion) && (0 < _classFile->minorVersion))\n          \n          \n            \n            \t\t\t) {\n          \n      \n    \n    \n  \n\nSorry, I spoke too quick.  We need to keep both the check for the preview version for the next release as that release includes jdk15.  Something like the above will cover us.\nNeeds to be applied both here and below", "author": "DanHeidinga", "createdAt": "2020-11-17T15:15:52Z", "path": "runtime/bcutil/ClassFileOracle.cpp", "diffHunk": "@@ -502,9 +502,8 @@ ClassFileOracle::walkAttributes()\n \t\t\tbreak;\n \t\t}\n \t\tcase CFR_ATTRIBUTE_PermittedSubclasses: {\n-\t\t\t/* PermittedSubclasses verification is for Java 15 preview only. Don't record the attribute for other class versions\n-\t\t\t * since it may be corrupt. */\n-\t\t\tif ((59 == _classFile->majorVersion) && (0 < _classFile->minorVersion)) {\n+\t\t\t/* PermittedSubclasses verification is for Java version > 15 */\n+\t\t\tif (_classFile->majorVersion > 59) {", "originalCommit": "fede363358640bd92eec2cee8a727e493ba443ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI1MDQwNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/11203#discussion_r525250406", "bodyText": "Updated here and the same check in cfreader.c", "author": "ChengJin01", "createdAt": "2020-11-17T15:29:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTIzNTA2OQ=="}], "type": "inlineReview"}, {"oid": "80c2f5beaf237a0f47349fbc1fbe33886c9393dc", "url": "https://github.com/eclipse-openj9/openj9/commit/80c2f5beaf237a0f47349fbc1fbe33886c9393dc", "message": "Enable the check for sealed classes for Java 16\n\nThe change is enable the check for sealed classes\nfor Java 16 during the static verification.\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-11-17T15:27:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI3Mzk4Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/11203#discussion_r525273983", "bodyText": "Please dont use 0 < - it just makes things harder to read.", "author": "gacholio", "createdAt": "2020-11-17T15:55:06Z", "path": "runtime/bcutil/ClassFileOracle.cpp", "diffHunk": "@@ -502,9 +502,10 @@ ClassFileOracle::walkAttributes()\n \t\t\tbreak;\n \t\t}\n \t\tcase CFR_ATTRIBUTE_PermittedSubclasses: {\n-\t\t\t/* PermittedSubclasses verification is for Java 15 preview only. Don't record the attribute for other class versions\n-\t\t\t * since it may be corrupt. */\n-\t\t\tif ((59 == _classFile->majorVersion) && (0 < _classFile->minorVersion)) {\n+\t\t\t/* PermittedSubclasses verification is for Java version >= 15 */\n+\t\t\tif ((classfile->majorVersion > 59)\n+\t\t\t|| ((59 == classfile->majorVersion) && (0 < classfile->minorVersion))", "originalCommit": "80c2f5beaf237a0f47349fbc1fbe33886c9393dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI4ODU5Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/11203#discussion_r525288596", "bodyText": "Isn't this check a very long winded way of saying >= 59 ? Minor version is unsigned, so it's always going to be >= 0.", "author": "gacholio", "createdAt": "2020-11-17T16:13:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI3Mzk4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI5MzAwNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/11203#discussion_r525293006", "bodyText": "For a preview feature, the minor version has to have all bits set:\n\nA class file denotes that it depends on the preview features of Java SE $N by having a major_version item that corresponds to Java SE $N and a minor_version item that has all 16 bits set. For example, a class file that depends on the preview features of Java SE 14 would have version 58.65535.\n\nNot sure why we used 0 < to start with.", "author": "DanHeidinga", "createdAt": "2020-11-17T16:19:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI3Mzk4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI5NjQ5Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/11203#discussion_r525296492", "bodyText": "My comment about the code stands - it's not doing anything more than >= 59 would accomplish.", "author": "gacholio", "createdAt": "2020-11-17T16:23:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI3Mzk4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI5OTI2OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11203#discussion_r525299269", "bodyText": "Should the check be major == 59 and minor == 65535?", "author": "gacholio", "createdAt": "2020-11-17T16:27:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI3Mzk4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTMwMjM5OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/11203#discussion_r525302398", "bodyText": "That's a better check.  The attribute isn't valid in JDK15 by default - only in these specially marked classes", "author": "DanHeidinga", "createdAt": "2020-11-17T16:30:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI3Mzk4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM0MzY4NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11203#discussion_r525343685", "bodyText": "Updated as suggested by GAC.", "author": "ChengJin01", "createdAt": "2020-11-17T17:20:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI3Mzk4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI3NDIxNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/11203#discussion_r525274214", "bodyText": "Same comment as above.", "author": "gacholio", "createdAt": "2020-11-17T15:55:24Z", "path": "runtime/bcutil/cfreader.c", "diffHunk": "@@ -2376,8 +2376,10 @@ checkAttributes(J9PortLibrary* portLib, J9CfrClassFile* classfile, J9CfrAttribut\n \t\t\tbreak;\n \n \t\tcase CFR_ATTRIBUTE_PermittedSubclasses:\n-\t\t\t/* PermittedSubclasses verification is for Java 15 preview only. */\n-\t\t\tif ((59 == classfile->majorVersion) && (0 < classfile->minorVersion)) {\n+\t\t\t/* PermittedSubclasses verification is for Java version >= 15 */\n+\t\t\tif ((classfile->majorVersion > 59) \n+\t\t\t|| ((59 == classfile->majorVersion) && (0 < classfile->minorVersion))", "originalCommit": "80c2f5beaf237a0f47349fbc1fbe33886c9393dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTM0Mzk2Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/11203#discussion_r525343962", "bodyText": "Updated as suggested above.", "author": "ChengJin01", "createdAt": "2020-11-17T17:21:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI3NDIxNA=="}], "type": "inlineReview"}, {"oid": "daf16db2240e0a475299608b3fe0dfc045b6c86a", "url": "https://github.com/eclipse-openj9/openj9/commit/daf16db2240e0a475299608b3fe0dfc045b6c86a", "message": "Enable the check for sealed classes for Java 16\n\nThe change is enable the check for sealed classes\nfor Java 16 during the static verification.\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-11-17T17:19:28Z", "type": "forcePushed"}, {"oid": "76390995ec1d05ff7fb56e6da08833d2312b983a", "url": "https://github.com/eclipse-openj9/openj9/commit/76390995ec1d05ff7fb56e6da08833d2312b983a", "message": "Enable the check for sealed classes for Java 16\n\nThe change is enable the check for sealed classes\nfor Java 16 during the static verification.\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-11-17T17:51:09Z", "type": "commit"}, {"oid": "76390995ec1d05ff7fb56e6da08833d2312b983a", "url": "https://github.com/eclipse-openj9/openj9/commit/76390995ec1d05ff7fb56e6da08833d2312b983a", "message": "Enable the check for sealed classes for Java 16\n\nThe change is enable the check for sealed classes\nfor Java 16 during the static verification.\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-11-17T17:51:09Z", "type": "forcePushed"}]}