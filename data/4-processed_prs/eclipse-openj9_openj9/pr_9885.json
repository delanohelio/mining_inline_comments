{"pr_number": 9885, "pr_title": "Close timing hole in System.exit", "pr_createdAt": "2020-06-15T15:50:05Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/9885", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg5ODA5Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9885#discussion_r440898093", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t * so setting the flag again below is harmless.\n          \n          \n            \n            \t\t\t * so setting the `J9_RUNTIME_EXIT_STARTED` flag again below is harmless.", "author": "DanHeidinga", "createdAt": "2020-06-16T14:32:32Z", "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -506,22 +506,30 @@ void OMRNORETURN exitJavaVM(J9VMThread * vmThread, IDATA rc)\n \t\t\tomrthread_monitor_enter(mutex);\n \t\t}\n \n-\t\t/* CLEANUP indicates that the VM is running the exit hooks/finalizers on exit - exit\n-\t\t * must be allowed in this case. CLEANUP will only ever be set once EXIT_STARTED has\n-\t\t * been set, so setting the flag again below is harmless.\n-\t\t */\n-\t\tif (J9_RUNTIME_EXIT_STARTED == (vm->runtimeFlags & (J9_RUNTIME_EXIT_STARTED | J9_RUNTIME_CLEANUP))) {\n-\t\t\tif (NULL != mutex) {\n-\t\t\t\tomrthread_monitor_exit(mutex);\n-\t\t\t}\n+\t\tif (J9_ARE_ANY_BITS_SET(vm->runtimeFlags, J9_RUNTIME_EXIT_STARTED)) {\n+\t\t\t/* CLEANUP indicates that the VM is running the exit hooks/finalizers\n+\t\t\t * on exit - exit must be allowed in this case, but only from a finalizer\n+\t\t\t * thread (for simplicity, just check for a system thread as no other\n+\t\t\t * VM-owned threads will be attempting exit).\n+\t\t\t *\n+\t\t\t * CLEANUP will only ever be set once EXIT_STARTED has been set,\n+\t\t\t * so setting the flag again below is harmless.", "originalCommit": "17661d574ccce5be8e7bfc5253ae77e76c5b3527", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg5ODQ5MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9885#discussion_r440898490", "bodyText": "Mostly nitpick:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\tif (J9_ARE_NO_BITS_SET(vmThread->privateFlags, J9_PRIVATE_FLAGS_SYSTEM_THREAD) ||\n          \n          \n            \n            \t\t\t    J9_ARE_NO_BITS_SET(vm->runtimeFlags, J9_RUNTIME_CLEANUP)\n          \n          \n            \n            \t\t\tif (J9_ARE_NO_BITS_SET(vmThread->privateFlags, J9_PRIVATE_FLAGS_SYSTEM_THREAD)\n          \n          \n            \n            \t\t\t|| J9_ARE_NO_BITS_SET(vm->runtimeFlags, J9_RUNTIME_CLEANUP)", "author": "DanHeidinga", "createdAt": "2020-06-16T14:33:02Z", "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -506,22 +506,30 @@ void OMRNORETURN exitJavaVM(J9VMThread * vmThread, IDATA rc)\n \t\t\tomrthread_monitor_enter(mutex);\n \t\t}\n \n-\t\t/* CLEANUP indicates that the VM is running the exit hooks/finalizers on exit - exit\n-\t\t * must be allowed in this case. CLEANUP will only ever be set once EXIT_STARTED has\n-\t\t * been set, so setting the flag again below is harmless.\n-\t\t */\n-\t\tif (J9_RUNTIME_EXIT_STARTED == (vm->runtimeFlags & (J9_RUNTIME_EXIT_STARTED | J9_RUNTIME_CLEANUP))) {\n-\t\t\tif (NULL != mutex) {\n-\t\t\t\tomrthread_monitor_exit(mutex);\n-\t\t\t}\n+\t\tif (J9_ARE_ANY_BITS_SET(vm->runtimeFlags, J9_RUNTIME_EXIT_STARTED)) {\n+\t\t\t/* CLEANUP indicates that the VM is running the exit hooks/finalizers\n+\t\t\t * on exit - exit must be allowed in this case, but only from a finalizer\n+\t\t\t * thread (for simplicity, just check for a system thread as no other\n+\t\t\t * VM-owned threads will be attempting exit).\n+\t\t\t *\n+\t\t\t * CLEANUP will only ever be set once EXIT_STARTED has been set,\n+\t\t\t * so setting the flag again below is harmless.\n+\t\t\t */\n+\t\t\tif (J9_ARE_NO_BITS_SET(vmThread->privateFlags, J9_PRIVATE_FLAGS_SYSTEM_THREAD) ||\n+\t\t\t    J9_ARE_NO_BITS_SET(vm->runtimeFlags, J9_RUNTIME_CLEANUP)", "originalCommit": "17661d574ccce5be8e7bfc5253ae77e76c5b3527", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg5ODg2Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/9885#discussion_r440898862", "bodyText": "Do we not have a better way to ID finalizer threads?", "author": "DanHeidinga", "createdAt": "2020-06-16T14:33:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg5ODQ5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDkxOTE0MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9885#discussion_r440919140", "bodyText": "No, there can be multiple abandoned threads - the GC only records the active one.", "author": "gacholio", "createdAt": "2020-06-16T14:59:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg5ODQ5MA=="}], "type": "inlineReview"}, {"oid": "682594114f166e68f54da493915aba72b1bd02dc", "url": "https://github.com/eclipse-openj9/openj9/commit/682594114f166e68f54da493915aba72b1bd02dc", "message": "Close timing hole in System.exit\n\nillegally be allowed to call System.exit while the VM is being\ndestroyed.\n\n[ci skip]\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>", "committedDate": "2020-06-16T15:05:48Z", "type": "commit"}, {"oid": "682594114f166e68f54da493915aba72b1bd02dc", "url": "https://github.com/eclipse-openj9/openj9/commit/682594114f166e68f54da493915aba72b1bd02dc", "message": "Close timing hole in System.exit\n\nillegally be allowed to call System.exit while the VM is being\ndestroyed.\n\n[ci skip]\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>", "committedDate": "2020-06-16T15:05:48Z", "type": "forcePushed"}]}