{"pr_number": 10563, "pr_title": "Capture the errors in enum_const_value of RuntimeVisibleAnnotations", "pr_createdAt": "2020-09-10T15:24:45Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10563", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ1NDMyMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10563#discussion_r486454322", "bodyText": "Please format these properly (space after if) and don't use ! for zero tests in new code.", "author": "gacholio", "createdAt": "2020-09-10T15:55:29Z", "path": "runtime/bcutil/cfreader.c", "diffHunk": "@@ -3470,15 +3481,30 @@ readAnnotationElement(J9CfrClassFile * classfile, J9CfrAnnotationElement ** pAnn\n \t\tbreak;\n \t\t\t\n \tcase 'e':\n+\t{\n+\t\tJ9CfrConstantPoolInfo* cpBase = classfile->constantPool;\n+\t\tU_16 cpCount = classfile->constantPoolCount;\n+\t\tU_16 typeNameIndex = 0;\n+\t\tU_16 constNameIndex = 0;\n+\n \t\tif (!ALLOC_CAST(element, J9CfrAnnotationElementEnum, J9CfrAnnotationElement)) {\n \t\t\treturn -2;\n \t\t}\n \n \t\tCHECK_EOF(4);\n \t\tNEXT_U16(((J9CfrAnnotationElementEnum *)element)->typeNameIndex, index);\n \t\tNEXT_U16(((J9CfrAnnotationElementEnum *)element)->constNameIndex, index);\n+\t\t\n+\t\ttypeNameIndex = ((J9CfrAnnotationElementEnum *)element)->typeNameIndex;\n+\t\tconstNameIndex = ((J9CfrAnnotationElementEnum *)element)->constNameIndex;\n+\t\tif(!typeNameIndex || (typeNameIndex >= cpCount) || !constNameIndex || (constNameIndex >= cpCount)) {", "originalCommit": "6c3629eac201fbd7eeee205df78d097ddf176d5d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ1ODA2NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10563#discussion_r486458065", "bodyText": "Fixed as suggested above.", "author": "ChengJin01", "createdAt": "2020-09-10T16:00:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ1NDMyMg=="}], "type": "inlineReview"}, {"oid": "2e3c95af8a6c35f9b03cff1a3f2a15564c48c79b", "url": "https://github.com/eclipse-openj9/openj9/commit/2e3c95af8a6c35f9b03cff1a3f2a15564c48c79b", "message": "Capture the errors in enum_const_value of RuntimeVisibleAnnotations\n\nThe change is to capture the errors specific to the index\nto the constant pool set in enum_const_value of the\nRuntimeVisibleAnnotations attribute.\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-09-10T15:59:06Z", "type": "forcePushed"}, {"oid": "034442a0fcbd9e533b8a4674bab34c04807d48bc", "url": "https://github.com/eclipse-openj9/openj9/commit/034442a0fcbd9e533b8a4674bab34c04807d48bc", "message": "Capture the errors in enum_const_value of RuntimeVisibleAnnotations\n\nThe change is to capture the errors specific to the index\nto the constant pool set in enum_const_value of the\nRuntimeVisibleAnnotations attribute.\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-09-10T16:01:51Z", "type": "commit"}, {"oid": "034442a0fcbd9e533b8a4674bab34c04807d48bc", "url": "https://github.com/eclipse-openj9/openj9/commit/034442a0fcbd9e533b8a4674bab34c04807d48bc", "message": "Capture the errors in enum_const_value of RuntimeVisibleAnnotations\n\nThe change is to capture the errors specific to the index\nto the constant pool set in enum_const_value of the\nRuntimeVisibleAnnotations attribute.\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-09-10T16:01:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUwMTUzMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10563#discussion_r486501533", "bodyText": "Does this behaviour apply across all supported JDK levels - 8, 11 & 15?  Does the RI report the errors for these cases in all releases?", "author": "DanHeidinga", "createdAt": "2020-09-10T17:08:29Z", "path": "runtime/bcutil/cfreader.c", "diffHunk": "@@ -448,6 +448,17 @@ readAttributes(J9CfrClassFile * classfile, J9CfrAttribute *** pAttributes, U_32\n \t\t\t\tU_32 cursor = 0;\n \t\t\t\tTrc_BCU_MalformedAnnotation(address);\n \n+\t\t\t\t/* Capture the errors with type_name_index & const_name_index in enum_const_value against the VM Spec */\n+\t\t\t\tif (BCT_ERR_INVALID_ANNOTATION_BAD_CP_INDEX_OUT_OF_RANGE == result) {\n+\t\t\t\t\terrorCode = J9NLS_CFR_ERR_BAD_INDEX__ID;\n+\t\t\t\t\toffset = address;\n+\t\t\t\t\tgoto _errorFound;\n+\t\t\t\t} else if (BCT_ERR_INVALID_ANNOTATION_BAD_CP_UTF8_STRING == result) {\n+\t\t\t\t\terrorCode = J9NLS_CFR_ERR_BAD_NAME_INDEX__ID;\n+\t\t\t\t\toffset = address;\n+\t\t\t\t\tgoto _errorFound;", "originalCommit": "034442a0fcbd9e533b8a4674bab34c04807d48bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjU2NzUyMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10563#discussion_r486567523", "bodyText": "The rules for element_value  in the Spec have been there since Java 7 as follows:\n4.7.16 The RuntimeVisibleAnnotations attribute\n4.7.16.1 The element_value structure\nenum_const_value\nThe enum_const_value item is used if the tag item is e.\nThe enum_const_value item consists of the following two items:\ntype_name_index\nThe value of the type_name_index item must be a valid index into the constant_pool table. \nThe constant_pool entry at that index must be a CONSTANT_Utf8_info structure (\u00a74.4.7) \nrepresenting a valid field descriptor (\u00a74.3.2) that denotes the internal form of the binary name \n(\u00a74.2.1) of the type of the enum constant represented by this element_value structure.\nconst_name_index\nThe value of the const_name_index item must be a valid index into the constant_pool table. \nThe constant_pool entry at that index must be a CONSTANT_Utf8_info structure (\u00a74.4.7) \nrepresenting the simple name of the enum constant represented by this element_value structure.\n\nGiven the failing test case plus part of test framework code needs to be modified to the appropriate class version supported by the JDK, I can't simply verify it on Hotspot Java 8 and 11 but it works with Hotspot Java 15.\n$ jdk15_hotspot/bin/java -version\nopenjdk version \"15\" 2020-09-15\nOpenJDK Runtime Environment (build 15+36-1562)\nOpenJDK 64-Bit Server VM (build 15+36-1562, mixed mode, sharing)\n\ntest output (PASSED)\njava.lang.annotation.AnnotationFormatError: java.lang.IllegalArgumentException: \nConstant pool index out of bounds", "author": "ChengJin01", "createdAt": "2020-09-10T18:56:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUwMTUzMw=="}], "type": "inlineReview"}]}