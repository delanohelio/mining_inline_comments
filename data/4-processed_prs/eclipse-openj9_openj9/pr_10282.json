{"pr_number": 10282, "pr_title": "Adding Injection of Interfaces and IdentityObject Interface", "pr_createdAt": "2020-07-29T15:01:02Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10282", "timeline": [{"oid": "1f9081cc4d4ec0ed03d12ba9e82f36e93214cf63", "url": "https://github.com/eclipse-openj9/openj9/commit/1f9081cc4d4ec0ed03d12ba9e82f36e93214cf63", "message": "temp", "committedDate": "2020-08-26T15:40:50Z", "type": "forcePushed"}, {"oid": "21b670d3187c8ff16f2156d2dff4dafcb32bd624", "url": "https://github.com/eclipse-openj9/openj9/commit/21b670d3187c8ff16f2156d2dff4dafcb32bd624", "message": "temp", "committedDate": "2020-08-27T00:47:05Z", "type": "forcePushed"}, {"oid": "ae04a99a6306774118c6cef390b01a9588ad077a", "url": "https://github.com/eclipse-openj9/openj9/commit/ae04a99a6306774118c6cef390b01a9588ad077a", "message": "Adding injection of interfaces\n\nAdding ability to inject interfaces to a class on top of interfaces\nalready defined in the class file.\n\nInjects IdentityObject interface to all objects which are not\nValue Types if the object does not have it to begin with.\n\nInjecting interfaces has the following assumptions:\n- interfaces to be injected do not already exist in the class file\n- IdentityObject does not need to be explicitly injected", "committedDate": "2020-08-31T15:57:57Z", "type": "forcePushed"}, {"oid": "b15280a294ffb1a453b19efcc52c58bca022485b", "url": "https://github.com/eclipse-openj9/openj9/commit/b15280a294ffb1a453b19efcc52c58bca022485b", "message": "Removed optimization to allow debugging", "committedDate": "2020-09-09T13:29:00Z", "type": "forcePushed"}, {"oid": "b65691a702870445e48c8ba695991c68abea63fe", "url": "https://github.com/eclipse-openj9/openj9/commit/b65691a702870445e48c8ba695991c68abea63fe", "message": "Added jitHelpers for store and load\n\nAdded jitHelpers for loading and storing flattenable array\nelement with a slow and fast variant.\n-old_fast-jitLoadFlattenableArrayElement: Attempts to use fast\npath to load array element. If it fails calls the slow variant.\n-old_slow_jitLoadFlattenableArrayElement: Proceeds thorugh slow\npath for loading, throwing appropriate exceptions when needed.\n-old_fast_jitStoreFlattenableArrayElement: Attempts to use fast\npath to store value into array. If it fails, calls the slow\\\nvariant.\n-old_slow_jitStoreFlattenableArrayElement: Proceeds through\nsllow path for storing, throws appropriate exceptions when\nneeded.\n\nMoved ByteCodeInterpreter helper to  VMHelpers to check if\nstoring object in an array is allowed. Replaced occurence\nin ByteCodeInterpreter to new version.\n-objectArrayStoreAllowed\n\nAdded ValueTypeHelpers loadFlattenableArrayElement and\nstoreFlattenableArrayElement which perform aaload and\naastore functions respectively. Both handle flattened and\nunflattened cases. Both contain an option for either a fast\nor a slow variant.\n-loadFlattenableArrayElement: Loads flattenable array element\n-storeFlattenableArrayElement: Stores flattenable array element\n-loadFlattenableArrayElement: c function that initializes\nrequired objects and calls loadFlattenableArrayElement\n-storeFlattenableArrayElement: c function that initializes\nrequired objects and calls storeFlattenableArrayElement\n\nReplaced existing code in aaload and aastore functions in\nByteCodeInterpreter.hpp with calls to loadFlattenableArrayElement\nand storeFlattenableArrayElement. Functionality remains the same.\n\nRelated to: https://github.com/eclipse/openj9/issues/9627\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>", "committedDate": "2020-09-10T19:14:54Z", "type": "forcePushed"}, {"oid": "df7585b634ab27f9032ac9e626a12c94e2cde659", "url": "https://github.com/eclipse-openj9/openj9/commit/df7585b634ab27f9032ac9e626a12c94e2cde659", "message": "tmep", "committedDate": "2020-09-14T19:27:46Z", "type": "forcePushed"}, {"oid": "e1f984342ddb63eebb69e02cde494c3807dc272b", "url": "https://github.com/eclipse-openj9/openj9/commit/e1f984342ddb63eebb69e02cde494c3807dc272b", "message": "tmep", "committedDate": "2020-09-15T00:17:38Z", "type": "forcePushed"}, {"oid": "fa1bfb8339634419e52e21a15e12a2ef431c094e", "url": "https://github.com/eclipse-openj9/openj9/commit/fa1bfb8339634419e52e21a15e12a2ef431c094e", "message": "tmep", "committedDate": "2020-09-15T00:42:25Z", "type": "forcePushed"}, {"oid": "1f10642c942fd4392103a96f2973dc6458c220d3", "url": "https://github.com/eclipse-openj9/openj9/commit/1f10642c942fd4392103a96f2973dc6458c220d3", "message": "tmep", "committedDate": "2020-09-16T13:57:15Z", "type": "forcePushed"}, {"oid": "c18ddff6af342e224d0285621aa767cf322199f8", "url": "https://github.com/eclipse-openj9/openj9/commit/c18ddff6af342e224d0285621aa767cf322199f8", "message": "Adding Injection of Interfaces and IdentityObject Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- Interfaces to be injected can be specified with the new\nfunction setInterfacesToInject in ROMClassCreationContext.\n\nAdded a new interface IdentityObject which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>", "committedDate": "2020-09-16T20:23:47Z", "type": "forcePushed"}, {"oid": "691de960576d711bdd5002d9c1faa6ee9f6c13fa", "url": "https://github.com/eclipse-openj9/openj9/commit/691de960576d711bdd5002d9c1faa6ee9f6c13fa", "message": "Adding Injection of Interfaces and IdentityObject Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- Interfaces to be injected can be specified with the new\nfunction setInterfacesToInject in ROMClassCreationContext.\n\nAdded a new interface IdentityObject which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>", "committedDate": "2020-09-17T21:02:26Z", "type": "forcePushed"}, {"oid": "804970e36f74c070be8c1eedcf12a7dcfce2f34f", "url": "https://github.com/eclipse-openj9/openj9/commit/804970e36f74c070be8c1eedcf12a7dcfce2f34f", "message": "pass to classfilewriter", "committedDate": "2020-09-21T19:05:16Z", "type": "forcePushed"}, {"oid": "647708b94568a026dba88360302c5e7a18d2c5fd", "url": "https://github.com/eclipse-openj9/openj9/commit/647708b94568a026dba88360302c5e7a18d2c5fd", "message": "dummy interface", "committedDate": "2020-09-21T01:49:04Z", "type": "forcePushed"}, {"oid": "7a9a39b4fcae7a396bed437a299252c1c2f5bbc9", "url": "https://github.com/eclipse-openj9/openj9/commit/7a9a39b4fcae7a396bed437a299252c1c2f5bbc9", "message": "passing to classfilewriter", "committedDate": "2020-09-22T13:33:16Z", "type": "forcePushed"}, {"oid": "d939735a31f8492f04bb42f2d795528b169cd77f", "url": "https://github.com/eclipse-openj9/openj9/commit/d939735a31f8492f04bb42f2d795528b169cd77f", "message": "memory fix", "committedDate": "2020-09-23T17:02:25Z", "type": "forcePushed"}, {"oid": "ce37f56b4db41478d7687617c3533554b3bcd5d5", "url": "https://github.com/eclipse-openj9/openj9/commit/ce37f56b4db41478d7687617c3533554b3bcd5d5", "message": "memory fix", "committedDate": "2020-09-24T20:38:02Z", "type": "forcePushed"}, {"oid": "46b53c4e61e988f0c9b54e528f7e658e463ed3ac", "url": "https://github.com/eclipse-openj9/openj9/commit/46b53c4e61e988f0c9b54e528f7e658e463ed3ac", "message": "memory fix", "committedDate": "2020-09-25T03:00:57Z", "type": "forcePushed"}, {"oid": "1a66987031e265095e9255854ede8106d5f57279", "url": "https://github.com/eclipse-openj9/openj9/commit/1a66987031e265095e9255854ede8106d5f57279", "message": "memory fix", "committedDate": "2020-09-28T15:09:06Z", "type": "forcePushed"}, {"oid": "be9babe6e7fd085efaab333319d84091abfacbe6", "url": "https://github.com/eclipse-openj9/openj9/commit/be9babe6e7fd085efaab333319d84091abfacbe6", "message": "Turned J9UTF8's to static, added initialization bool", "committedDate": "2020-09-28T19:53:54Z", "type": "forcePushed"}, {"oid": "b97870a6b41588ae35a9b985486d5775f49b9aab", "url": "https://github.com/eclipse-openj9/openj9/commit/b97870a6b41588ae35a9b985486d5775f49b9aab", "message": "Turned J9UTF8's to static, added initialization bool", "committedDate": "2020-09-29T21:11:46Z", "type": "forcePushed"}, {"oid": "ef216dcc7db88b654838996f4ece5d0d9540f5a5", "url": "https://github.com/eclipse-openj9/openj9/commit/ef216dcc7db88b654838996f4ece5d0d9540f5a5", "message": "Fixed ClassFileWriter", "committedDate": "2020-10-01T15:27:36Z", "type": "forcePushed"}, {"oid": "9e7b71068743350d0c44f1ec657e5c96d56b3909", "url": "https://github.com/eclipse-openj9/openj9/commit/9e7b71068743350d0c44f1ec657e5c96d56b3909", "message": "Fixed ClassFileWriter", "committedDate": "2020-10-01T20:04:23Z", "type": "forcePushed"}, {"oid": "fd75700658ae0317708f64b61368af89f01c5265", "url": "https://github.com/eclipse-openj9/openj9/commit/fd75700658ae0317708f64b61368af89f01c5265", "message": "fix static allocation", "committedDate": "2020-10-05T17:23:23Z", "type": "forcePushed"}, {"oid": "ea412e564af644f09399fb172d5c73db37acc305", "url": "https://github.com/eclipse-openj9/openj9/commit/ea412e564af644f09399fb172d5c73db37acc305", "message": "fix static allocation", "committedDate": "2020-10-05T18:49:15Z", "type": "forcePushed"}, {"oid": "78541118718b711fd2ea345cb1a4d1b63947b3dc", "url": "https://github.com/eclipse-openj9/openj9/commit/78541118718b711fd2ea345cb1a4d1b63947b3dc", "message": "changed to singleton injection array", "committedDate": "2020-10-08T20:50:58Z", "type": "forcePushed"}, {"oid": "20751ba8afcb96b19d7beef272e0e567e3d60c76", "url": "https://github.com/eclipse-openj9/openj9/commit/20751ba8afcb96b19d7beef272e0e567e3d60c76", "message": "changed to singleton injection array", "committedDate": "2020-10-09T18:42:14Z", "type": "forcePushed"}, {"oid": "3b6ee2c4929af5c5e7058caa79584d08a7d3f8a6", "url": "https://github.com/eclipse-openj9/openj9/commit/3b6ee2c4929af5c5e7058caa79584d08a7d3f8a6", "message": "changed to singleton injection array", "committedDate": "2020-10-13T19:03:53Z", "type": "forcePushed"}, {"oid": "57018be2fff1e7cade914b2c2bcbca2dfa63cc4f", "url": "https://github.com/eclipse-openj9/openj9/commit/57018be2fff1e7cade914b2c2bcbca2dfa63cc4f", "message": "changed to singleton injection array", "committedDate": "2020-10-16T20:15:19Z", "type": "forcePushed"}, {"oid": "f5b612947b48ae5e600b0a0398ee59ab6f1a1321", "url": "https://github.com/eclipse-openj9/openj9/commit/f5b612947b48ae5e600b0a0398ee59ab6f1a1321", "message": "Adding Injection of Interfaces and IdentityObject Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityObject which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>", "committedDate": "2020-10-19T16:17:41Z", "type": "forcePushed"}, {"oid": "3db96308e599ea030eb69b3ef857182923b88576", "url": "https://github.com/eclipse-openj9/openj9/commit/3db96308e599ea030eb69b3ef857182923b88576", "message": "Adding Injection of Interfaces and IdentityObject Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityObject which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>", "committedDate": "2020-10-19T18:41:12Z", "type": "forcePushed"}, {"oid": "54613c5467280cd710b8111609c044136837bd2c", "url": "https://github.com/eclipse-openj9/openj9/commit/54613c5467280cd710b8111609c044136837bd2c", "message": "Adding Injection of Interfaces and IdentityObject Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityObject which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>", "committedDate": "2020-10-19T18:58:14Z", "type": "forcePushed"}, {"oid": "3100f7b706422ee3852e828163555ceffd90bb3b", "url": "https://github.com/eclipse-openj9/openj9/commit/3100f7b706422ee3852e828163555ceffd90bb3b", "message": "Adding Injection of Interfaces and IdentityObject Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityObject which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>", "committedDate": "2020-10-19T19:19:35Z", "type": "forcePushed"}, {"oid": "92d803d4f2569e2a83b8b2a6085189d5fc70729c", "url": "https://github.com/eclipse-openj9/openj9/commit/92d803d4f2569e2a83b8b2a6085189d5fc70729c", "message": "Adding Injection of Interfaces and IdentityObject Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityObject which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>", "committedDate": "2020-10-19T21:15:29Z", "type": "forcePushed"}, {"oid": "3a48f7eefef6345d4499a12c29afb3a086a7da61", "url": "https://github.com/eclipse-openj9/openj9/commit/3a48f7eefef6345d4499a12c29afb3a086a7da61", "message": "Adding Injection of Interfaces and IdentityObject Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityObject which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>", "committedDate": "2020-10-20T13:53:25Z", "type": "forcePushed"}, {"oid": "edac384f4db63f09f7ff6abcc763b9739fb98471", "url": "https://github.com/eclipse-openj9/openj9/commit/edac384f4db63f09f7ff6abcc763b9739fb98471", "message": "Adding Injection of Interfaces and IdentityObject Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityObject which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>", "committedDate": "2020-10-20T18:58:03Z", "type": "forcePushed"}, {"oid": "d844b6dcdc28edff73d9c6125255b8263a345c96", "url": "https://github.com/eclipse-openj9/openj9/commit/d844b6dcdc28edff73d9c6125255b8263a345c96", "message": "Adding Injection of Interfaces and IdentityObject Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityObject which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>", "committedDate": "2020-10-20T19:01:04Z", "type": "forcePushed"}, {"oid": "f3fe2b0a117deca8e45f54358e2fca94e441b362", "url": "https://github.com/eclipse-openj9/openj9/commit/f3fe2b0a117deca8e45f54358e2fca94e441b362", "message": "Adding Injection of Interfaces and IdentityObject Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityObject which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>", "committedDate": "2020-10-20T19:35:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTMzMTAxNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r509331015", "bodyText": "@tajila\nShould I add a boolean to represent injection, or is it fine to continue to check if injection is needed by doing _injectionInfo->numOfInterfaces > 0?", "author": "OussamaSaoudi", "createdAt": "2020-10-21T14:22:14Z", "path": "runtime/bcutil/ROMClassBuilder.hpp", "diffHunk": "@@ -37,6 +37,12 @@\n #include \"ClassFileParser.hpp\"  /* included to obtain definition of VerifyClassFunction */\n #include \"StringInternTable.hpp\"\n \n+#define MAX_INTERFACE_INJECTION 2\n+typedef struct InjectionInfo{\n+\tJ9UTF8 *interfaces[MAX_INTERFACE_INJECTION];\n+\tU_16 numOfInterfaces;\n+} InjectionInfo;", "originalCommit": "f3fe2b0a117deca8e45f54358e2fca94e441b362", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM0Mzc4Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r509343782", "bodyText": "_injectionInfo->numOfInterfaces > 0 is fine", "author": "tajila", "createdAt": "2020-10-21T14:37:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTMzMTAxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTMzOTM1MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r509339350", "bodyText": "Would this cause an issue if J9VM_OPT_VALHALLA_VALUE_TYPES is not defined?", "author": "OussamaSaoudi", "createdAt": "2020-10-21T14:31:47Z", "path": "runtime/oti/vmconstantpool.xml", "diffHunk": "@@ -31,6 +31,8 @@ SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-excepti\n \t<classref name=\"java/lang/InstantiationError\"/>\n \t<classref name=\"java/lang/UnsatisfiedLinkError\"/>\n \t<classref name=\"java/lang/InternalError\"/>\n+\t<classref name=\"java/lang/IdentityObject\"/>", "originalCommit": "f3fe2b0a117deca8e45f54358e2fca94e441b362", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM0MzM0Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r509343346", "bodyText": "yes, you can add flags see \t<classref name=\"java/lang/invoke/FilterArgumentsHandle\" flags=\"opt_methodHandle\"/>", "author": "tajila", "createdAt": "2020-10-21T14:36:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTMzOTM1MA=="}], "type": "inlineReview"}, {"oid": "9f7d2611e4605e90d1a88ff8aff883ba6a2d5413", "url": "https://github.com/eclipse-openj9/openj9/commit/9f7d2611e4605e90d1a88ff8aff883ba6a2d5413", "message": "Adding Injection of Interfaces and IdentityObject Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityObject which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>", "committedDate": "2020-10-21T14:33:07Z", "type": "forcePushed"}, {"oid": "0818464c83e22d53d2dfee8d49916cf409209b7c", "url": "https://github.com/eclipse-openj9/openj9/commit/0818464c83e22d53d2dfee8d49916cf409209b7c", "message": "Adding Injection of Interfaces and IdentityObject Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityObject which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>", "committedDate": "2020-10-21T15:32:10Z", "type": "forcePushed"}, {"oid": "2a63e75a7546c6129c01c137e35ab11b2baa1ab5", "url": "https://github.com/eclipse-openj9/openj9/commit/2a63e75a7546c6129c01c137e35ab11b2baa1ab5", "message": "Adding Injection of Interfaces and IdentityObject Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityObject which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>", "committedDate": "2020-10-21T16:35:52Z", "type": "forcePushed"}, {"oid": "2a63e75a7546c6129c01c137e35ab11b2baa1ab5", "url": "https://github.com/eclipse-openj9/openj9/commit/2a63e75a7546c6129c01c137e35ab11b2baa1ab5", "message": "Adding Injection of Interfaces and IdentityObject Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityObject which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>", "committedDate": "2020-10-21T16:35:52Z", "type": "forcePushed"}, {"oid": "2a80328443fa5124658aee0dcb798ea9bc97f637", "url": "https://github.com/eclipse-openj9/openj9/commit/2a80328443fa5124658aee0dcb798ea9bc97f637", "message": "removed Dummy Interface", "committedDate": "2020-10-30T22:58:32Z", "type": "forcePushed"}, {"oid": "3e271c1a89fa16f15606c59fa3d74c7ce18103fa", "url": "https://github.com/eclipse-openj9/openj9/commit/3e271c1a89fa16f15606c59fa3d74c7ce18103fa", "message": "Adding Injection of Interfaces and IdentityObject Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityObject which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>", "committedDate": "2020-10-30T22:57:55Z", "type": "forcePushed"}, {"oid": "3f8b234cec562737f28dd512d848513c238a8c81", "url": "https://github.com/eclipse-openj9/openj9/commit/3f8b234cec562737f28dd512d848513c238a8c81", "message": "Adding Injection of Interfaces and IdentityObject Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityObject which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>", "committedDate": "2020-11-03T14:36:39Z", "type": "forcePushed"}, {"oid": "b9cbbe2ac8523cb4f3383733d13ee5707578792e", "url": "https://github.com/eclipse-openj9/openj9/commit/b9cbbe2ac8523cb4f3383733d13ee5707578792e", "message": "remove dummyobject", "committedDate": "2020-11-04T14:57:28Z", "type": "forcePushed"}, {"oid": "7286ab7e77bec67a029b4256ad4e5008c2f0f931", "url": "https://github.com/eclipse-openj9/openj9/commit/7286ab7e77bec67a029b4256ad4e5008c2f0f931", "message": "Adding Injection of Interfaces and IdentityObject Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityObject which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>", "committedDate": "2020-11-05T17:56:05Z", "type": "forcePushed"}, {"oid": "e1d9db5cfd6acd190c8825c976a1b0d8db449bc0", "url": "https://github.com/eclipse-openj9/openj9/commit/e1d9db5cfd6acd190c8825c976a1b0d8db449bc0", "message": "Adding Injection of Interfaces and IdentityObject Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityObject which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>", "committedDate": "2020-11-05T19:12:51Z", "type": "forcePushed"}, {"oid": "0ae7b5592728ca6b8ccd1af13003e946b2a507c7", "url": "https://github.com/eclipse-openj9/openj9/commit/0ae7b5592728ca6b8ccd1af13003e946b2a507c7", "message": "Adding Injection of Interfaces and IdentityObject Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityObject which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>", "committedDate": "2020-11-06T20:01:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI4Mjg2Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r525282862", "bodyText": "for consistency please change all IdentityObject -> IdentityInterface", "author": "tajila", "createdAt": "2020-11-17T16:06:11Z", "path": "runtime/bcutil/ClassFileOracle.cpp", "diffHunk": "@@ -656,6 +660,9 @@ class ClassFileOracle::InterfaceVisitor : public ClassFileOracle::ConstantPoolIn\n \tInterfaceVisitor(ClassFileOracle *classFileOracle, ConstantPoolMap *constantPoolMap) :\n \t\t_classFileOracle(classFileOracle),\n \t\t_constantPoolMap(constantPoolMap),\n+#if defined(J9VM_OPT_VALHALLA_VALUE_TYPES)\n+\t\t_wasIdentityObjectSeen(false),", "originalCommit": "0ae7b5592728ca6b8ccd1af13003e946b2a507c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI4NzE3Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r525287172", "bodyText": "the actual name hasn't been determined yet", "author": "tajila", "createdAt": "2020-11-17T16:11:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI4Mjg2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI4NDA0NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r525284044", "bodyText": "No longer true, InlineObject is not in the current plans", "author": "tajila", "createdAt": "2020-11-17T16:07:41Z", "path": "runtime/bcutil/ClassFileOracle.cpp", "diffHunk": "@@ -693,9 +714,24 @@ ClassFileOracle::walkInterfaces()\n \tROMClassVerbosePhase v(_context, ClassFileInterfacesAnalysis);\n \n \tInterfaceVisitor interfaceVisitor(this, _constantPoolMap);\n-\tinterfacesDo(&interfaceVisitor);\n+\tinterfacesDo(&interfaceVisitor, 0);\n \t_isCloneable = interfaceVisitor.wasCloneableSeen();\n \t_isSerializable = interfaceVisitor.wasSerializableSeen();\n+#if defined(J9VM_OPT_VALHALLA_VALUE_TYPES)\n+\t/* TODO current prototype still uses the flag, this will be updated to", "originalCommit": "0ae7b5592728ca6b8ccd1af13003e946b2a507c7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI4NTIzMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r525285230", "bodyText": "Update the comment to describe how numOfInjectedInterfaces is being used", "author": "tajila", "createdAt": "2020-11-17T16:09:13Z", "path": "runtime/bcutil/ClassFileOracle.hpp", "diffHunk": "@@ -813,13 +813,16 @@ class RecordComponentIterator\n \t/*\n \t * Iterate over the constant pool indices corresponding to interface names (UTF8s).", "originalCommit": "0ae7b5592728ca6b8ccd1af13003e946b2a507c7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI4ODI0Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r525288243", "bodyText": "there is no need for both _injectedInterfaces and _numOfInjectedInterfaces", "author": "tajila", "createdAt": "2020-11-17T16:13:05Z", "path": "runtime/bcutil/ClassFileWriter.hpp", "diffHunk": "@@ -74,6 +74,8 @@ class ClassFileWriter {\n \tbool _isAnon;\n \tJ9UTF8* _anonClassName;\n \tJ9UTF8* _originalClassName;\n+\tbool _injectedInterfaces;", "originalCommit": "0ae7b5592728ca6b8ccd1af13003e946b2a507c7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI5MTI1Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r525291256", "bodyText": "instead of doings you could just check if (cpIndex > classFileMaxCPIndex), if so then skip the check", "author": "tajila", "createdAt": "2020-11-17T16:16:57Z", "path": "runtime/bcutil/ComparingCursor.cpp", "diffHunk": "@@ -212,10 +212,16 @@ ComparingCursor::writeSRP(UDATA srpKey, DataType dataType)\n \t\t\t\t\tmarkUnEqual();\n \t\t\t\t} else {\n \t\t\t\t\tU_16 cpIndex = _srpKeyProducer->mapKeyToCfrConstantPoolIndex(srpKey);\n-\n-\t\t\t\t\tif ( J9UTF8_LENGTH(utf8) != _classFileOracle->getUTF8Length(cpIndex) ) {\n+\t\t\t\t\tbool isInjected = false;", "originalCommit": "0ae7b5592728ca6b8ccd1af13003e946b2a507c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQzMDM1NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r526430354", "bodyText": "Just to confirm, is classFileMaxCPIndex == ConstantPoolCount?", "author": "OussamaSaoudi", "createdAt": "2020-11-18T21:24:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI5MTI1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI5MjEwMQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r525292101", "bodyText": "rename to InterfaceInjectionInfo *_interfaceInjectionInfo; for clarity", "author": "tajila", "createdAt": "2020-11-17T16:18:00Z", "path": "runtime/bcutil/ROMClassBuilder.hpp", "diffHunk": "@@ -121,8 +127,10 @@ class ROMClassBuilder\n \tUDATA _anonClassNameBufferSize;\n \tU_8 *_bufferManagerBuffer;\n \tStringInternTable _stringInternTable;\n+\tInjectionInfo *_injectionInfo;", "originalCommit": "0ae7b5592728ca6b8ccd1af13003e946b2a507c7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTMwOTkyMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r525309922", "bodyText": "formatting InjectionInfo {", "author": "tajila", "createdAt": "2020-11-17T16:39:39Z", "path": "runtime/bcutil/ROMClassBuilder.hpp", "diffHunk": "@@ -37,6 +37,12 @@\n #include \"ClassFileParser.hpp\"  /* included to obtain definition of VerifyClassFunction */\n #include \"StringInternTable.hpp\"\n \n+#define MAX_INTERFACE_INJECTION 1\n+typedef struct InjectionInfo{", "originalCommit": "0ae7b5592728ca6b8ccd1af13003e946b2a507c7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTMxMTMxMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r525311313", "bodyText": "i think you can avaoid the allocation all together by just declaring it as an inline struct", "author": "tajila", "createdAt": "2020-11-17T16:41:04Z", "path": "runtime/bcutil/ROMClassBuilder.cpp", "diffHunk": "@@ -248,7 +252,31 @@ ROMClassBuilder::buildROMClass(ROMClassCreationContext *context)\n \tcontext->recordLoadEnd(result);\n \treturn result;\n }\n+BuildResult\n+ROMClassBuilder::injectInterfaces(ClassFileOracle *classFileOracle)\n+{\n+\tPORT_ACCESS_FROM_PORT(_portLibrary);\n+\tif (NULL == _injectionInfo) {\n+\t\t_injectionInfo = (InjectionInfo *) j9mem_allocate_memory(sizeof(InjectionInfo), J9MEM_CATEGORY_CLASSES);", "originalCommit": "0ae7b5592728ca6b8ccd1af13003e946b2a507c7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "74dafc27deba8ea7f577163bb48c905bb77e2f96", "url": "https://github.com/eclipse-openj9/openj9/commit/74dafc27deba8ea7f577163bb48c905bb77e2f96", "message": "changed _injectedInterfaces in ClassFileWriter to use optionalFlags instead of extraModifiers", "committedDate": "2020-11-18T17:06:42Z", "type": "forcePushed"}, {"oid": "f0479dbd93a9c4bdfa3a35f47fe60519633c0bf9", "url": "https://github.com/eclipse-openj9/openj9/commit/f0479dbd93a9c4bdfa3a35f47fe60519633c0bf9", "message": "Adding Injection of Interfaces and IdentityObject Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityObject which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>", "committedDate": "2020-11-18T21:17:16Z", "type": "forcePushed"}, {"oid": "a4a963f00f7f9da9390737ee069361f88d1cf8bf", "url": "https://github.com/eclipse-openj9/openj9/commit/a4a963f00f7f9da9390737ee069361f88d1cf8bf", "message": "Adding Injection of Interfaces and IdentityObject Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityObject which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>", "committedDate": "2020-11-19T17:47:10Z", "type": "forcePushed"}, {"oid": "10ac63984cf072c71a0de0dd86e3a262d43537b1", "url": "https://github.com/eclipse-openj9/openj9/commit/10ac63984cf072c71a0de0dd86e3a262d43537b1", "message": "Adding Injection of Interfaces and IdentityObject Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityObject which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>", "committedDate": "2020-11-19T20:02:07Z", "type": "forcePushed"}, {"oid": "9f400b00e226916325d1428b38be270bc68e4932", "url": "https://github.com/eclipse-openj9/openj9/commit/9f400b00e226916325d1428b38be270bc68e4932", "message": "Adding Injection of Interfaces and IdentityObject Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityObject which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>", "committedDate": "2020-11-23T20:11:56Z", "type": "forcePushed"}, {"oid": "a4a963f00f7f9da9390737ee069361f88d1cf8bf", "url": "https://github.com/eclipse-openj9/openj9/commit/a4a963f00f7f9da9390737ee069361f88d1cf8bf", "message": "Adding Injection of Interfaces and IdentityObject Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityObject which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>", "committedDate": "2020-11-19T17:47:10Z", "type": "forcePushed"}, {"oid": "9f400b00e226916325d1428b38be270bc68e4932", "url": "https://github.com/eclipse-openj9/openj9/commit/9f400b00e226916325d1428b38be270bc68e4932", "message": "Adding Injection of Interfaces and IdentityObject Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityObject which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>", "committedDate": "2020-11-23T20:11:56Z", "type": "forcePushed"}, {"oid": "15afa91e4682160f4cf9229db568bae9ca74fd3b", "url": "https://github.com/eclipse-openj9/openj9/commit/15afa91e4682160f4cf9229db568bae9ca74fd3b", "message": "Adding Injection of Interfaces and IdentityObject Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityObject which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>", "committedDate": "2021-01-04T17:49:02Z", "type": "forcePushed"}, {"oid": "6a24bed1e81216dc7b7c0e08f2a2bacda6f998f7", "url": "https://github.com/eclipse-openj9/openj9/commit/6a24bed1e81216dc7b7c0e08f2a2bacda6f998f7", "message": "Adding Injection of Interfaces and IdentityObject Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityObject which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>", "committedDate": "2021-01-04T19:28:31Z", "type": "forcePushed"}, {"oid": "351cfbca1c6c6217f2122b7212acebb01e9d88c7", "url": "https://github.com/eclipse-openj9/openj9/commit/351cfbca1c6c6217f2122b7212acebb01e9d88c7", "message": "Adding Injection of Interfaces and IdentityObject Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityObject which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>", "committedDate": "2021-01-04T19:36:05Z", "type": "forcePushed"}, {"oid": "921c0842c1d22c240269580cd7e338b982621440", "url": "https://github.com/eclipse-openj9/openj9/commit/921c0842c1d22c240269580cd7e338b982621440", "message": "Adding Injection of Interfaces and IdentityObject Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityObject which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>", "committedDate": "2021-01-04T21:28:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3NDg5Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r551674892", "bodyText": "needs ifdef", "author": "tajila", "createdAt": "2021-01-05T02:04:06Z", "path": "runtime/bcutil/ClassFileWriter.cpp", "diffHunk": "@@ -78,6 +78,10 @@ ClassFileWriter::analyzeROMClass()\n \t\treturn;\n \t}\n \n+\tif (J9_ARE_ALL_BITS_SET(_romClass->optionalFlags,J9_ROMCLASS_OPTINFO_INJECTED_INTERFACE_INFO)) {", "originalCommit": "921c0842c1d22c240269580cd7e338b982621440", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3NDk3NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r551674975", "bodyText": "needs ifdef", "author": "tajila", "createdAt": "2021-01-05T02:04:26Z", "path": "runtime/bcutil/ClassFileOracle.hpp", "diffHunk": "@@ -812,14 +812,19 @@ class RecordComponentIterator\n \n \t/*\n \t * Iterate over the constant pool indices corresponding to interface names (UTF8s).\n+\t * Also iterates over the injected interface names (UTF8s) in the \"extra\" cp slots.\n+\t * numOfInjectedInterfaces represents the number of extra slots containing the UTF8s.\n \t */\n-\tvoid interfacesDo(ConstantPoolIndexVisitor *visitor)\n+\tvoid interfacesDo(ConstantPoolIndexVisitor *visitor, U_16 numOfInjectedInterfaces)", "originalCommit": "921c0842c1d22c240269580cd7e338b982621440", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3NTAwNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r551675007", "bodyText": "same here", "author": "tajila", "createdAt": "2021-01-05T02:04:32Z", "path": "runtime/bcutil/ClassFileOracle.hpp", "diffHunk": "@@ -812,14 +812,19 @@ class RecordComponentIterator\n \n \t/*\n \t * Iterate over the constant pool indices corresponding to interface names (UTF8s).\n+\t * Also iterates over the injected interface names (UTF8s) in the \"extra\" cp slots.\n+\t * numOfInjectedInterfaces represents the number of extra slots containing the UTF8s.\n \t */\n-\tvoid interfacesDo(ConstantPoolIndexVisitor *visitor)\n+\tvoid interfacesDo(ConstantPoolIndexVisitor *visitor, U_16 numOfInjectedInterfaces)\n \t{\n \t\tU_16 *end = _classFile->interfaces + getInterfacesCount();\n \t\tfor (U_16 *interface = _classFile->interfaces; interface != end; ++interface) {\n \t\t\t/* Each interface is a constantClass, use slot1 to get at the underlying UTF8 */\n \t\t\tvisitor->visitConstantPoolIndex(U_16(_classFile->constantPool[ *interface ].slot1));\n \t\t}\n+\t\tfor (int i = 0; i < numOfInjectedInterfaces; i++) {", "originalCommit": "921c0842c1d22c240269580cd7e338b982621440", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3NTA4NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r551675084", "bodyText": "same in this file", "author": "tajila", "createdAt": "2021-01-05T02:04:56Z", "path": "runtime/bcutil/ClassFileWriter.cpp", "diffHunk": "@@ -340,7 +344,7 @@ void\n ClassFileWriter::analyzeInterfaces()\n {\n \tJ9SRP * interfaceNames = J9ROMCLASS_INTERFACES(_romClass);\n-\tUDATA interfaceCount = _romClass->interfaceCount;\n+\tUDATA interfaceCount = _romClass->interfaceCount - _numOfInjectedInterfaces;", "originalCommit": "921c0842c1d22c240269580cd7e338b982621440", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3NTIwOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r551675208", "bodyText": "put a space after _romClass->optionalFlags,", "author": "tajila", "createdAt": "2021-01-05T02:05:18Z", "path": "runtime/bcutil/ClassFileWriter.cpp", "diffHunk": "@@ -78,6 +78,10 @@ ClassFileWriter::analyzeROMClass()\n \t\treturn;\n \t}\n \n+\tif (J9_ARE_ALL_BITS_SET(_romClass->optionalFlags,J9_ROMCLASS_OPTINFO_INJECTED_INTERFACE_INFO)) {", "originalCommit": "921c0842c1d22c240269580cd7e338b982621440", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3NTMzMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r551675333", "bodyText": "ifdef", "author": "tajila", "createdAt": "2021-01-05T02:05:51Z", "path": "runtime/bcutil/ClassFileWriter.hpp", "diffHunk": "@@ -74,6 +74,7 @@ class ClassFileWriter {\n \tbool _isAnon;\n \tJ9UTF8* _anonClassName;\n \tJ9UTF8* _originalClassName;\n+\tU_32 _numOfInjectedInterfaces;", "originalCommit": "921c0842c1d22c240269580cd7e338b982621440", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3NTUwNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r551675506", "bodyText": "space before 0 !=  is not needed", "author": "tajila", "createdAt": "2021-01-05T02:06:30Z", "path": "runtime/bcutil/ComparingCursor.cpp", "diffHunk": "@@ -212,10 +212,13 @@ ComparingCursor::writeSRP(UDATA srpKey, DataType dataType)\n \t\t\t\t\tmarkUnEqual();\n \t\t\t\t} else {\n \t\t\t\t\tU_16 cpIndex = _srpKeyProducer->mapKeyToCfrConstantPoolIndex(srpKey);\n+\t\t\t\t\tif ( cpIndex > _classFileOracle->getConstantPoolCount() ) {\n+\t\t\t\t\t\tbreak;\n+\t\t\t\t\t}\n \n \t\t\t\t\tif ( J9UTF8_LENGTH(utf8) != _classFileOracle->getUTF8Length(cpIndex) ) {\n \t\t\t\t\t\tmarkUnEqual();\n-\t\t\t\t\t} else if (0 != memcmp(J9UTF8_DATA(utf8), _classFileOracle->getUTF8Data(cpIndex), J9UTF8_LENGTH(utf8))) {\n+\t\t\t\t\t} else if ( 0 != memcmp(J9UTF8_DATA(utf8), _classFileOracle->getUTF8Data(cpIndex), J9UTF8_LENGTH(utf8)) ) {", "originalCommit": "921c0842c1d22c240269580cd7e338b982621440", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3NTU3Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r551675573", "bodyText": "space after  J9UTF8_LENGTH(utf8)) is not needed", "author": "tajila", "createdAt": "2021-01-05T02:06:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3NTUwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3NTc4Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r551675783", "bodyText": "ah I see the coding standard is different in this file", "author": "tajila", "createdAt": "2021-01-05T02:07:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3NTUwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3NTgxNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r551675816", "bodyText": "needs ifdef", "author": "tajila", "createdAt": "2021-01-05T02:07:36Z", "path": "runtime/bcutil/ComparingCursor.cpp", "diffHunk": "@@ -212,10 +212,13 @@ ComparingCursor::writeSRP(UDATA srpKey, DataType dataType)\n \t\t\t\t\tmarkUnEqual();\n \t\t\t\t} else {\n \t\t\t\t\tU_16 cpIndex = _srpKeyProducer->mapKeyToCfrConstantPoolIndex(srpKey);\n+\t\t\t\t\tif ( cpIndex > _classFileOracle->getConstantPoolCount() ) {", "originalCommit": "921c0842c1d22c240269580cd7e338b982621440", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3NjEyOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r551676129", "bodyText": "should this be >= ?", "author": "tajila", "createdAt": "2021-01-05T02:08:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3NTgxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3NjMyOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r551676329", "bodyText": "also add a comment indicating that cp index's aboive the cpCount are injected interfaces which should not be written into the classfile bytes", "author": "tajila", "createdAt": "2021-01-05T02:09:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3NTgxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3NjU3MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r551676571", "bodyText": "the if check is not needed, j9mem_free_memory is going to do a NULL check", "author": "tajila", "createdAt": "2021-01-05T02:10:20Z", "path": "runtime/bcutil/ROMClassBuilder.cpp", "diffHunk": "@@ -84,6 +85,9 @@ ROMClassBuilder::~ROMClassBuilder()\n \tj9mem_free_memory(_classFileBuffer);\n \tj9mem_free_memory(_bufferManagerBuffer);\n \tj9mem_free_memory(_anonClassNameBuffer);\n+\tif (NULL != _interfaceInjectionInfo) {", "originalCommit": "921c0842c1d22c240269580cd7e338b982621440", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3NjU5NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r551676595", "bodyText": "ifdef", "author": "tajila", "createdAt": "2021-01-05T02:10:25Z", "path": "runtime/bcutil/ROMClassBuilder.cpp", "diffHunk": "@@ -66,7 +66,8 @@ ROMClassBuilder::ROMClassBuilder(J9JavaVM *javaVM, J9PortLibrary *portLibrary, U\n \t_bufferManagerBuffer(NULL),\n \t_anonClassNameBuffer(NULL),\n \t_anonClassNameBufferSize(0),\n-\t_stringInternTable(javaVM, portLibrary, maxStringInternTableSize)\n+\t_stringInternTable(javaVM, portLibrary, maxStringInternTableSize),", "originalCommit": "921c0842c1d22c240269580cd7e338b982621440", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3NzM2MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r551677361", "bodyText": "this allocation can be avoided entirely since the number of interfaces is known statically", "author": "tajila", "createdAt": "2021-01-05T02:13:24Z", "path": "runtime/bcutil/ROMClassBuilder.cpp", "diffHunk": "@@ -248,7 +252,31 @@ ROMClassBuilder::buildROMClass(ROMClassCreationContext *context)\n \tcontext->recordLoadEnd(result);\n \treturn result;\n }\n+BuildResult\n+ROMClassBuilder::injectInterfaces(ClassFileOracle *classFileOracle)\n+{\n+\tPORT_ACCESS_FROM_PORT(_portLibrary);\n+\tif (NULL == _interfaceInjectionInfo) {\n+\t\t_interfaceInjectionInfo = (InterfaceInjectionInfo *) j9mem_allocate_memory(sizeof(InterfaceInjectionInfo), J9MEM_CATEGORY_CLASSES);", "originalCommit": "921c0842c1d22c240269580cd7e338b982621440", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3ODEwNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r551678105", "bodyText": "You can reuse the BuildResult result = OK above. In fact BuildResult res = handleAnonClassName is an error, there is no need to define multiple BuildResult", "author": "tajila", "createdAt": "2021-01-05T02:15:54Z", "path": "runtime/bcutil/ROMClassBuilder.cpp", "diffHunk": "@@ -457,13 +485,18 @@ ROMClassBuilder::prepareAndLaydown( BufferManager *bufferManager, ClassFileParse\n \t\treturn classFileOracle.getBuildResult();\n \t}\n \n-\tSRPKeyProducer srpKeyProducer(&classFileOracle);\n+\tBuildResult injectRes = injectInterfaces(&classFileOracle);", "originalCommit": "921c0842c1d22c240269580cd7e338b982621440", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3ODIzNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r551678236", "bodyText": "ifdef", "author": "tajila", "createdAt": "2021-01-05T02:16:19Z", "path": "runtime/bcutil/ROMClassBuilder.cpp", "diffHunk": "@@ -84,6 +85,9 @@ ROMClassBuilder::~ROMClassBuilder()\n \tj9mem_free_memory(_classFileBuffer);\n \tj9mem_free_memory(_bufferManagerBuffer);\n \tj9mem_free_memory(_anonClassNameBuffer);\n+\tif (NULL != _interfaceInjectionInfo) {", "originalCommit": "921c0842c1d22c240269580cd7e338b982621440", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3ODI2MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r551678260", "bodyText": "ifdef", "author": "tajila", "createdAt": "2021-01-05T02:16:25Z", "path": "runtime/bcutil/ROMClassBuilder.cpp", "diffHunk": "@@ -248,7 +252,31 @@ ROMClassBuilder::buildROMClass(ROMClassCreationContext *context)\n \tcontext->recordLoadEnd(result);\n \treturn result;\n }\n+BuildResult", "originalCommit": "921c0842c1d22c240269580cd7e338b982621440", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3ODM2NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r551678364", "bodyText": "ifdef", "author": "tajila", "createdAt": "2021-01-05T02:16:43Z", "path": "runtime/bcutil/ROMClassBuilder.cpp", "diffHunk": "@@ -457,13 +485,18 @@ ROMClassBuilder::prepareAndLaydown( BufferManager *bufferManager, ClassFileParse\n \t\treturn classFileOracle.getBuildResult();\n \t}\n \n-\tSRPKeyProducer srpKeyProducer(&classFileOracle);", "originalCommit": "921c0842c1d22c240269580cd7e338b982621440", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk2ODA2Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r552968067", "bodyText": "Should I create the ifdef for the SRPKeyProducer like the following:\n#if defined(J9VM_OPT_VALHALLA_VALUE_TYPES)\n\tSRPKeyProducer srpKeyProducer(&classFileOracle, &_interfaceInjectionInfo);\n#else\n\tSRPKeyProducer srpKeyProducer(&classFileOracle);\n#endif /* J9VM_OPT_VALHALLA_VALUE_TYPES */\n\nand similarly do ifdef and else for the constructor?", "author": "OussamaSaoudi", "createdAt": "2021-01-06T21:24:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3ODM2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk3MTAzNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r552971035", "bodyText": "Yes, like that.\nthe else should also of the comment:\n#else /* J9VM_OPT_VALHALLA_VALUE_TYPES */", "author": "tajila", "createdAt": "2021-01-06T21:31:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3ODM2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk3MzM3Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r552973377", "bodyText": "Do I want to be doing this with RomClassWriter and the Helper private class?", "author": "OussamaSaoudi", "createdAt": "2021-01-06T21:37:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3ODM2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAwMTI2MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r553001261", "bodyText": "Yes, for anything where you had to change the APIs", "author": "tajila", "createdAt": "2021-01-06T22:42:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3ODM2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3ODQ3MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r551678471", "bodyText": "ifdef", "author": "tajila", "createdAt": "2021-01-05T02:17:01Z", "path": "runtime/bcutil/ROMClassBuilder.hpp", "diffHunk": "@@ -121,8 +127,10 @@ class ROMClassBuilder\n \tUDATA _anonClassNameBufferSize;\n \tU_8 *_bufferManagerBuffer;\n \tStringInternTable _stringInternTable;\n+\tInterfaceInjectionInfo *_interfaceInjectionInfo;", "originalCommit": "921c0842c1d22c240269580cd7e338b982621440", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3OTQ1Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r551679457", "bodyText": "use IDENTITY_OBJECT_NAME instead", "author": "tajila", "createdAt": "2021-01-05T02:20:38Z", "path": "runtime/bcutil/ClassFileOracle.cpp", "diffHunk": "@@ -684,16 +691,30 @@ class ClassFileOracle::InterfaceVisitor : public ClassFileOracle::ConstantPoolIn\n \t\t\t_wasSerializableSeen = true;\n \t\t}\n #undef SERIALIZABLE_NAME\n+\n+#if defined(J9VM_OPT_VALHALLA_VALUE_TYPES)\n+#define JAVA_LANG_IDENTITYINTERFACE \"java/lang/IdentityInterface\"", "originalCommit": "921c0842c1d22c240269580cd7e338b982621440", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3OTUyNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r551679525", "bodyText": "use JAVA_LANG_IDENTITYINTERFACE instead", "author": "tajila", "createdAt": "2021-01-05T02:20:55Z", "path": "runtime/bcutil/ROMClassBuilder.cpp", "diffHunk": "@@ -248,7 +252,31 @@ ROMClassBuilder::buildROMClass(ROMClassCreationContext *context)\n \tcontext->recordLoadEnd(result);\n \treturn result;\n }\n+BuildResult\n+ROMClassBuilder::injectInterfaces(ClassFileOracle *classFileOracle)\n+{\n+\tPORT_ACCESS_FROM_PORT(_portLibrary);\n+\tif (NULL == _interfaceInjectionInfo) {\n+\t\t_interfaceInjectionInfo = (InterfaceInjectionInfo *) j9mem_allocate_memory(sizeof(InterfaceInjectionInfo), J9MEM_CATEGORY_CLASSES);\n+\t\tif (NULL == _interfaceInjectionInfo) {\n+\t\t\tBuildResult res = OutOfMemory;\n+\t\t\treturn res;\n+\t\t}\n+\t}\n+\tU_32 numOfInterfaces = 0;\n \n+#if defined(J9VM_OPT_VALHALLA_VALUE_TYPES)\n+\tif (classFileOracle->needsIdentityInterface()) {\n+#define JAVA_LANG_IDENTITYINTERFACE \"java/lang/IdentityInterface\"", "originalCommit": "921c0842c1d22c240269580cd7e338b982621440", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk3MDYxNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r552970615", "bodyText": "should be IDENTITY_OBJECT_NAME instead", "author": "tajila", "createdAt": "2021-01-06T21:30:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTY3OTUyNQ=="}], "type": "inlineReview"}, {"oid": "02b4ad45bf43751e51816e5cf054416294aa015c", "url": "https://github.com/eclipse-openj9/openj9/commit/02b4ad45bf43751e51816e5cf054416294aa015c", "message": "Adding Injection of Interfaces and IdentityObject Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityObject which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>", "committedDate": "2021-01-06T20:55:54Z", "type": "forcePushed"}, {"oid": "1351c2f77affeb7c5f5d4f1aea621acc37e03417", "url": "https://github.com/eclipse-openj9/openj9/commit/1351c2f77affeb7c5f5d4f1aea621acc37e03417", "message": "Adding Injection of Interfaces and IdentityObject Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityObject which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>", "committedDate": "2021-01-07T15:58:51Z", "type": "forcePushed"}, {"oid": "b6e57ef700d9820d24b9125ba96f9ef3f710f205", "url": "https://github.com/eclipse-openj9/openj9/commit/b6e57ef700d9820d24b9125ba96f9ef3f710f205", "message": "Adding Injection of Interfaces and IdentityObject Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityObject which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>", "committedDate": "2021-01-07T17:53:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDAwMzI4Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r554003283", "bodyText": "I dont think the preprocessor macros work for DDR code. @JasonFengJ9 can you confirm?", "author": "tajila", "createdAt": "2021-01-08T15:16:22Z", "path": "debugtools/DDR_VM/src/com/ibm/j9ddr/vm29/j9/OptInfo.java", "diffHunk": "@@ -27,6 +27,9 @@\n import static com.ibm.j9ddr.vm29.structure.J9NonbuilderConstants.J9_ROMCLASS_OPTINFO_ENCLOSING_METHOD;\n import static com.ibm.j9ddr.vm29.structure.J9NonbuilderConstants.J9_ROMCLASS_OPTINFO_GENERIC_SIGNATURE;\n import static com.ibm.j9ddr.vm29.structure.J9NonbuilderConstants.J9_ROMCLASS_OPTINFO_PERMITTEDSUBCLASSES_ATTRIBUTE;\n+/*[IF INLINE-TYPES]*/\n+import static com.ibm.j9ddr.vm29.structure.J9NonbuilderConstants.J9_ROMCLASS_OPTINFO_INJECTED_INTERFACE_INFO;", "originalCommit": "b6e57ef700d9820d24b9125ba96f9ef3f710f205", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDAwNDQxMQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r554004411", "bodyText": "You can define the flag unconditionally in j9nonbuilder.h", "author": "tajila", "createdAt": "2021-01-08T15:18:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDAwMzI4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDAxMTEzNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r554011134", "bodyText": "@tajila That's correct, JPP doesn't work for DDR code within debugtools folder.", "author": "JasonFengJ9", "createdAt": "2021-01-08T15:29:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDAwMzI4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDAwMzk1OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r554003958", "bodyText": "dont need ifdefs for flags", "author": "tajila", "createdAt": "2021-01-08T15:17:29Z", "path": "runtime/oti/cfr.h", "diffHunk": "@@ -948,6 +948,10 @@ typedef struct J9CfrClassFile {\n #define CFR_FOUND_CHARS_IN_EXTENDED_MUE_FORM 0x1\n #define CFR_FOUND_SEPARATOR_IN_MUE_FORM 0x2\n \n+#if defined(J9VM_OPT_VALHALLA_VALUE_TYPES)", "originalCommit": "b6e57ef700d9820d24b9125ba96f9ef3f710f205", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDAwNDA5OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r554004098", "bodyText": "dont need ifdefs for flags", "author": "tajila", "createdAt": "2021-01-08T15:17:41Z", "path": "runtime/oti/j9nonbuilder.h", "diffHunk": "@@ -252,6 +252,9 @@\n #define J9_ROMCLASS_OPTINFO_TYPE_ANNOTATION_INFO 0x400000\n #define J9_ROMCLASS_OPTINFO_RECORD_ATTRIBUTE 0x800000\n #define J9_ROMCLASS_OPTINFO_PERMITTEDSUBCLASSES_ATTRIBUTE 0x1000000\n+#if defined(J9VM_OPT_VALHALLA_VALUE_TYPES)", "originalCommit": "b6e57ef700d9820d24b9125ba96f9ef3f710f205", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDAwNDczNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r554004736", "bodyText": "look at openj9/debugtools/DDR_VM/src/com/ibm/j9ddr/vm29/pointer/helper/ValueTypeHelper.java you can use areValueTypesSupported to determine if VT is enabled for the core file", "author": "tajila", "createdAt": "2021-01-08T15:18:43Z", "path": "debugtools/DDR_VM/src/com/ibm/j9ddr/vm29/tools/ddrinteractive/RomClassWalker.java", "diffHunk": "@@ -702,7 +702,12 @@ void allSlotsInOptionalInfoDo() throws CorruptDataException\n \t\t\tpermittedSubclassAttributeDo(U32Pointer.cast(cursor.get()));\n \t\t\tcursor = cursor.add(1);\n \t\t}\n-\n+/*[IF INLINE-TYPES]*/\n+\t\tif (romClass.optionalFlags().allBitsIn(J9NonbuilderConstants.J9_ROMCLASS_OPTINFO_INJECTED_INTERFACE_INFO)) {", "originalCommit": "b6e57ef700d9820d24b9125ba96f9ef3f710f205", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "63a850076dfbbf46e10a9c84c4027d1f205b5875", "url": "https://github.com/eclipse-openj9/openj9/commit/63a850076dfbbf46e10a9c84c4027d1f205b5875", "message": "Adding Injection of Interfaces and IdentityObject Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityObject which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>\n\nsrpkeyproducer changes", "committedDate": "2021-01-11T16:24:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjU3NDU1OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r556574559", "bodyText": "space between if and (, same with ){", "author": "tajila", "createdAt": "2021-01-13T14:49:01Z", "path": "debugtools/DDR_VM/src/com/ibm/j9ddr/vm29/tools/ddrinteractive/RomClassWalker.java", "diffHunk": "@@ -702,7 +703,12 @@ void allSlotsInOptionalInfoDo() throws CorruptDataException\n \t\t\tpermittedSubclassAttributeDo(U32Pointer.cast(cursor.get()));\n \t\t\tcursor = cursor.add(1);\n \t\t}\n-\n+\t\tif(ValueTypeHelper.getValueTypeHelper().areValueTypesSupported()){", "originalCommit": "63a850076dfbbf46e10a9c84c4027d1f205b5875", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjU3ODYwMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r556578603", "bodyText": "dont need to define this here since its defined in cfr.h", "author": "tajila", "createdAt": "2021-01-13T14:53:59Z", "path": "runtime/bcutil/ClassFileOracle.cpp", "diffHunk": "@@ -684,16 +691,30 @@ class ClassFileOracle::InterfaceVisitor : public ClassFileOracle::ConstantPoolIn\n \t\t\t_wasSerializableSeen = true;\n \t\t}\n #undef SERIALIZABLE_NAME\n+\n+#if defined(J9VM_OPT_VALHALLA_VALUE_TYPES)\n+#define IDENTITY_OBJECT_NAME \"java/lang/IdentityInterface\"", "originalCommit": "63a850076dfbbf46e10a9c84c4027d1f205b5875", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjU3ODg3Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r556578877", "bodyText": "same here", "author": "tajila", "createdAt": "2021-01-13T14:54:19Z", "path": "runtime/bcutil/ROMClassBuilder.cpp", "diffHunk": "@@ -249,6 +249,21 @@ ROMClassBuilder::buildROMClass(ROMClassCreationContext *context)\n \treturn result;\n }\n \n+#if defined(J9VM_OPT_VALHALLA_VALUE_TYPES)\n+BuildResult\n+ROMClassBuilder::injectInterfaces(ClassFileOracle *classFileOracle)\n+{\n+\tU_32 numOfInterfaces = 0;\n+\tif (classFileOracle->needsIdentityInterface()) {\n+#define IDENTITY_OBJECT_NAME \"java/lang/IdentityInterface\"", "originalCommit": "63a850076dfbbf46e10a9c84c4027d1f205b5875", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7e0466f341b5fc6430c6ed9b4b0c0a4b9d95faf4", "url": "https://github.com/eclipse-openj9/openj9/commit/7e0466f341b5fc6430c6ed9b4b0c0a4b9d95faf4", "message": "Adding Injection of Interfaces and IdentityInterface Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityInterface which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nAdded testing to check that IdentityInterface is added to\nreference types and not abstract classes, valuetypes, or\njava/lang/Object.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>\n\nsrpkeyproducer changes", "committedDate": "2021-01-13T20:12:30Z", "type": "forcePushed"}, {"oid": "839f2642af2f1b9f5ad5cf414dd766100598a524", "url": "https://github.com/eclipse-openj9/openj9/commit/839f2642af2f1b9f5ad5cf414dd766100598a524", "message": "Adding Injection of Interfaces and IdentityInterface Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityInterface which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nAdded testing to check that IdentityInterface is added to\nreference types and not abstract classes, valuetypes, or\njava/lang/Object.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>\n\nsrpkeyproducer changes", "committedDate": "2021-01-13T20:17:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjgwNjQ2Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r556806467", "bodyText": "@tajila I created an abstract class here to check if it contains the IdentityInterface. Is there another way to test the abstract class, or is this fine? Would I want to populate the class with methods and fields, or simply leave it blank?", "author": "OussamaSaoudi", "createdAt": "2021-01-13T20:24:30Z", "path": "test/functional/Valhalla/src/org/openj9/test/lworld/ValueTypeTests.java", "diffHunk": "@@ -3029,7 +3030,41 @@ static public void testUnresolvedPutFieldUse() throws Throwable {\n \t\t\t}\n \t\t}\n \t}\n-\t\n+\n+\t@Test(priority = 1)\n+\tstatic public void testIdentityObjectOnValueType() throws Throwable {\n+\t\tString fields[] = {\"longField:J\"};\n+\t\tClass valueClass = ValueTypeGenerator.generateValueClass(\"testIdentityObjectOnValueType\", fields);\n+\t\tassertFalse(Arrays.asList(valueClass.getInterfaces()).contains(IdentityInterface.class));\n+\t}\n+\n+\t@Test(priority = 1)\n+\tstatic public void testIdentityObjectOnAbstract() throws Throwable {\n+\t\tassertFalse(Arrays.asList(AbstractClass.class.getInterfaces()).contains(IdentityInterface.class));\n+\t}\n+\tprivate static abstract class AbstractClass {", "originalCommit": "839f2642af2f1b9f5ad5cf414dd766100598a524", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjgwNjY2NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r556806664", "bodyText": "I have also made them priority = 1 since they don't rely on any other methods. Lmk if that should change.", "author": "OussamaSaoudi", "createdAt": "2021-01-13T20:25:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjgwNjQ2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTIwNDQzNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r561204435", "bodyText": "@tajila", "author": "OussamaSaoudi", "createdAt": "2021-01-20T19:03:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjgwNjQ2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTkwMTE2OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r561901169", "bodyText": "thats fine", "author": "tajila", "createdAt": "2021-01-21T13:59:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjgwNjQ2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTg5ODE2Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r561898167", "bodyText": "formatting with ){", "author": "tajila", "createdAt": "2021-01-21T13:55:26Z", "path": "debugtools/DDR_VM/src/com/ibm/j9ddr/vm29/tools/ddrinteractive/RomClassWalker.java", "diffHunk": "@@ -702,7 +703,12 @@ void allSlotsInOptionalInfoDo() throws CorruptDataException\n \t\t\tpermittedSubclassAttributeDo(U32Pointer.cast(cursor.get()));\n \t\t\tcursor = cursor.add(1);\n \t\t}\n-\n+\t\tif (ValueTypeHelper.getValueTypeHelper().areValueTypesSupported()){", "originalCommit": "839f2642af2f1b9f5ad5cf414dd766100598a524", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTkwMDk0Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r561900943", "bodyText": "naming: call this refClass", "author": "tajila", "createdAt": "2021-01-21T13:59:00Z", "path": "test/functional/Valhalla/src/org/openj9/test/lworld/ValueTypeTests.java", "diffHunk": "@@ -3029,7 +3030,41 @@ static public void testUnresolvedPutFieldUse() throws Throwable {\n \t\t\t}\n \t\t}\n \t}\n-\t\n+\n+\t@Test(priority = 1)\n+\tstatic public void testIdentityObjectOnValueType() throws Throwable {\n+\t\tString fields[] = {\"longField:J\"};\n+\t\tClass valueClass = ValueTypeGenerator.generateValueClass(\"testIdentityObjectOnValueType\", fields);\n+\t\tassertFalse(Arrays.asList(valueClass.getInterfaces()).contains(IdentityInterface.class));\n+\t}\n+\n+\t@Test(priority = 1)\n+\tstatic public void testIdentityObjectOnAbstract() throws Throwable {\n+\t\tassertFalse(Arrays.asList(AbstractClass.class.getInterfaces()).contains(IdentityInterface.class));\n+\t}\n+\tprivate static abstract class AbstractClass {\n+\t\tprivate int x;\n+\t\tprivate int y;\n+\t\tpublic int getX(){\n+\t\t\treturn x;\n+\t\t}\n+\t\tpublic int getY(){\n+\t\t\treturn y;\n+\t\t}\n+\t}\n+\n+\t@Test(priority = 1)\n+\tstatic public void testIdentityObjectOnJLObject() throws Throwable {\n+\t\tassertFalse(Arrays.asList(Object.class.getInterfaces()).contains(IdentityInterface.class));\n+\t}\n+\n+\t@Test(priority = 1)\n+\tstatic public void testIdentityObjectOnRef() throws Throwable {\n+\t\tString fields[] = {\"longField:J\"};\n+\t\tClass valueClass = ValueTypeGenerator.generateRefClass(\"testIdentityObjectOnRef\", fields);", "originalCommit": "839f2642af2f1b9f5ad5cf414dd766100598a524", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "eb47c02581385a9dd3eed3f38775244942a98129", "url": "https://github.com/eclipse-openj9/openj9/commit/eb47c02581385a9dd3eed3f38775244942a98129", "message": "Adding Injection of Interfaces and IdentityInterface Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityInterface which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nAdded testing to check that IdentityInterface is added to\nreference types and not abstract classes, valuetypes, or\njava/lang/Object.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>\n\nsrpkeyproducer changes", "committedDate": "2021-01-21T14:38:15Z", "type": "forcePushed"}, {"oid": "b29fe15df252a58ef40ad8a872c313a0cf1554e6", "url": "https://github.com/eclipse-openj9/openj9/commit/b29fe15df252a58ef40ad8a872c313a0cf1554e6", "message": "Adding Injection of Interfaces and IdentityInterface Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityInterface which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nAdded testing to check that IdentityInterface is added to\nreference types and not abstract classes, valuetypes, or\njava/lang/Object.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>\n\nsrpkeyproducer changes", "committedDate": "2021-01-21T14:39:54Z", "type": "forcePushed"}, {"oid": "007ef9f95da477bb5bcc0a2a7579696ae08e436a", "url": "https://github.com/eclipse-openj9/openj9/commit/007ef9f95da477bb5bcc0a2a7579696ae08e436a", "message": "Adding Injection of Interfaces and IdentityInterface Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityInterface which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nAdded testing to check that IdentityInterface is added to\nreference types and not abstract classes, valuetypes, or\njava/lang/Object.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>\n\nsrpkeyproducer changes", "committedDate": "2021-01-29T16:15:22Z", "type": "forcePushed"}, {"oid": "647fa4f4e620053c1a36687cd7c7fcf8d1577a49", "url": "https://github.com/eclipse-openj9/openj9/commit/647fa4f4e620053c1a36687cd7c7fcf8d1577a49", "message": "Adding Injection of Interfaces and IdentityInterface Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityInterface which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nAdded testing to check that IdentityInterface is added to\nreference types and not abstract classes, valuetypes, or\njava/lang/Object.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>\n\nsrpkeyproducer changes", "committedDate": "2021-02-01T17:57:15Z", "type": "forcePushed"}, {"oid": "796263508b2ea9425c9ea4ef09bbf45076fba781", "url": "https://github.com/eclipse-openj9/openj9/commit/796263508b2ea9425c9ea4ef09bbf45076fba781", "message": "Adding Injection of Interfaces and IdentityInterface Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityInterface which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nAdded testing to check that IdentityInterface is added to\nreference types and not abstract classes, valuetypes, or\njava/lang/Object.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>\n\nsrpkeyproducer changes", "committedDate": "2021-02-01T20:03:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODcxMDg5MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r568710891", "bodyText": "Why is this being force loaded earlier than it would be by the default loading of the vmconstantpool classes?\nIt would be good to add a comment to describe why it's necessary this early (if it is)", "author": "DanHeidinga", "createdAt": "2021-02-02T15:49:11Z", "path": "runtime/jcl/common/jclcinit.c", "diffHunk": "@@ -632,6 +635,12 @@ initializeRequiredClasses(J9VMThread *vmThread, char* dllName)\n \tif (NULL == objectClass) {\n \t\treturn 1;\n \t}\n+#if defined(J9VM_OPT_VALHALLA_VALUE_TYPES)\n+\tidentityInterfaceClass = vmFuncs->internalFindKnownClass(vmThread, J9VMCONSTANTPOOL_JAVALANGIDENTITYINTERFACE, J9_FINDKNOWNCLASS_FLAG_NON_FATAL);", "originalCommit": "796263508b2ea9425c9ea4ef09bbf45076fba781", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODcxNTE2MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r568715160", "bodyText": "@tajila Could you give some input?", "author": "OussamaSaoudi", "createdAt": "2021-02-02T15:54:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODcxMDg5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODc0MDY2MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r568740661", "bodyText": "The class needs to be loaded before the first non j.l.Object|interface|value type (JAVALANGJ9VMINTERNALS the second class) is loaded. The vmconstantpool classes are loaded later, after a few core classes have already be loaded.\nThe reason to do it explicitly is report a JVM internal failure should there be a problem loading the class, similar to j.l.Object", "author": "tajila", "createdAt": "2021-02-02T16:25:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODcxMDg5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODc0NDkzNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r568744937", "bodyText": "The loading of this class should be triggered by J9VMINTERNALS, so perhaps the explicit classload is not needed.", "author": "tajila", "createdAt": "2021-02-02T16:31:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODcxMDg5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTEwODczMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r569108732", "bodyText": "@OussamaSaoudi  can you make that change", "author": "tajila", "createdAt": "2021-02-03T03:35:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODcxMDg5MQ=="}], "type": "inlineReview"}, {"oid": "c8b434f767aeea0c5b4c6cfd11ea2fcec8e8f5d5", "url": "https://github.com/eclipse-openj9/openj9/commit/c8b434f767aeea0c5b4c6cfd11ea2fcec8e8f5d5", "message": "Adding Injection of Interfaces and IdentityInterface Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityInterface which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nAdded testing to check that IdentityInterface is added to\nreference types and not abstract classes, valuetypes, or\njava/lang/Object.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>\n\nsrpkeyproducer changes", "committedDate": "2021-02-03T15:08:55Z", "type": "forcePushed"}, {"oid": "38200858feca32e716a97e1b8ac4fb06911e5b3a", "url": "https://github.com/eclipse-openj9/openj9/commit/38200858feca32e716a97e1b8ac4fb06911e5b3a", "message": "Adding Injection of Interfaces and IdentityInterface Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityInterface which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nAdded testing to check that IdentityInterface is added to\nreference types and not abstract classes, valuetypes, or\njava/lang/Object.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>\n\nsrpkeyproducer changes", "committedDate": "2021-02-03T15:22:09Z", "type": "forcePushed"}, {"oid": "375cc6c4676290ea9f98b4092b425b59704ac5b3", "url": "https://github.com/eclipse-openj9/openj9/commit/375cc6c4676290ea9f98b4092b425b59704ac5b3", "message": "Adding Injection of Interfaces and IdentityInterface Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityInterface which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nAdded testing to check that IdentityInterface is added to\nreference types and not abstract classes, valuetypes, or\njava/lang/Object.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>\n\nsrpkeyproducer changes", "committedDate": "2021-02-03T15:23:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTUwNjQ0Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r569506442", "bodyText": "we dont need this anymore, since we arent explicitly loading it", "author": "tajila", "createdAt": "2021-02-03T15:27:14Z", "path": "runtime/oti/vmconstantpool.xml", "diffHunk": "@@ -31,6 +31,7 @@ SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-excepti\n \t<classref name=\"java/lang/InstantiationError\"/>\n \t<classref name=\"java/lang/UnsatisfiedLinkError\"/>\n \t<classref name=\"java/lang/InternalError\"/>\n+\t<classref name=\"java/lang/IdentityInterface\" flags=\"opt_valhallaValueTypes\"/>", "originalCommit": "375cc6c4676290ea9f98b4092b425b59704ac5b3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e010f60ce5c9bfa4a765708225582955f1b6d975", "url": "https://github.com/eclipse-openj9/openj9/commit/e010f60ce5c9bfa4a765708225582955f1b6d975", "message": "Adding Injection of Interfaces and IdentityInterface Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityInterface which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nAdded testing to check that IdentityInterface is added to\nreference types and not abstract classes, valuetypes, or\njava/lang/Object.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>\n\nsrpkeyproducer changes", "committedDate": "2021-02-03T15:57:13Z", "type": "forcePushed"}, {"oid": "d81541bdd0b0e5f4d7a81a3b7ca5aaaf8b3e3805", "url": "https://github.com/eclipse-openj9/openj9/commit/d81541bdd0b0e5f4d7a81a3b7ca5aaaf8b3e3805", "message": "Adding Injection of Interfaces and IdentityInterface Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityInterface which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nAdded testing to check that IdentityInterface is added to\nreference types and not abstract classes, valuetypes, or\njava/lang/Object.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>\n\nsrpkeyproducer changes", "committedDate": "2021-02-16T16:08:31Z", "type": "forcePushed"}, {"oid": "b86a0ab100c4af324a9cef553ee6be42762cd7bf", "url": "https://github.com/eclipse-openj9/openj9/commit/b86a0ab100c4af324a9cef553ee6be42762cd7bf", "message": "Adding Injection of Interfaces and IdentityInterface Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityInterface which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nAdded testing to check that IdentityInterface is added to\nreference types and not abstract classes, valuetypes, or\njava/lang/Object.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>\n\nsrpkeyproducer changes", "committedDate": "2021-02-16T18:40:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MDMzNzIwMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10282#discussion_r580337203", "bodyText": "@tajila", "author": "OussamaSaoudi", "createdAt": "2021-02-22T15:23:39Z", "path": "test/functional/Java8andUp/src_110_up/org/openj9/test/java/lang/Test_Class.java", "diffHunk": "@@ -446,6 +446,7 @@ public void test_getMethods_subtest6() throws Exception {\n \tClzImpl clzImpl = new ClzImpl();\n \tfor (Method method : clzImpl.getClass().getMethods()) {\n \t\tfor (Class<?> anInterface : method.getDeclaringClass().getInterfaces()) {\n+\t\t\tif (anInterface == IdentityInterface.class) continue;", "originalCommit": "b86a0ab100c4af324a9cef553ee6be42762cd7bf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c02fbad6e22d6b422ec7ea55f8d3e2bd83c73b45", "url": "https://github.com/eclipse-openj9/openj9/commit/c02fbad6e22d6b422ec7ea55f8d3e2bd83c73b45", "message": "Adding Injection of Interfaces and IdentityInterface Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityInterface which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nAdded testing to check that IdentityInterface is added to\nreference types and not abstract classes, valuetypes, or\njava/lang/Object.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>\n\nsrpkeyproducer changes", "committedDate": "2021-02-22T16:03:55Z", "type": "commit"}, {"oid": "c02fbad6e22d6b422ec7ea55f8d3e2bd83c73b45", "url": "https://github.com/eclipse-openj9/openj9/commit/c02fbad6e22d6b422ec7ea55f8d3e2bd83c73b45", "message": "Adding Injection of Interfaces and IdentityInterface Interface\n\nAdded a new JVM mechanism to inject an interfacae into a class.\n- interfaces to be injected must be specified in the injectInterfaces\nmethod in ROMClassBuilder.cpp\n- Max number of interfaces defined by MAX_INTERFACE_INJECTION\n\nAdded a new interface IdentityInterface which specifies all non\nValueType objects. This interface is automatically injected\ninto any class which is not a ValueType.\n\nAdded testing to check that IdentityInterface is added to\nreference types and not abstract classes, valuetypes, or\njava/lang/Object.\n\nComparingCursor.cpp writeSRP function has case for SRP_TO_UTF8\nto skip equality check with the classFile.\n\nAdded new SRP to OPTInfo to carry information of the number of\ninterfaced that are to be injected.\n\nSigned-off-by: Oussama Saoudi <oussama.saoudi@ibm.com>\n\nsrpkeyproducer changes", "committedDate": "2021-02-22T16:03:55Z", "type": "forcePushed"}]}