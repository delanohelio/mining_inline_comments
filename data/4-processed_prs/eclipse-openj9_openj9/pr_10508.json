{"pr_number": 10508, "pr_title": "Maintain CH table per JITServer client", "pr_createdAt": "2020-09-02T16:03:07Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10508", "timeline": [{"oid": "dbf5a7e085871c22bc5755a13031f4010501e2c8", "url": "https://github.com/eclipse-openj9/openj9/commit/dbf5a7e085871c22bc5755a13031f4010501e2c8", "message": "Maintain CH table per JITServer client instead of globally\n\nBefore this commit, server had one global CH table access\nto which was controlled by one global lock.\nThis is not ideal when multiple clients connect to the server\nbecause it leads to scalability issues due to lock contention\nand also one client might retrieve data that belongs to another client.\n\nThis commit replaces the global CH table with one created per client.\nLock contention is also removed as we now have one lock per client as\nwell.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-09-08T18:18:33Z", "type": "forcePushed"}, {"oid": "8a39749c7c5da7fd6fe0bddc66b3663e3c41a51a", "url": "https://github.com/eclipse-openj9/openj9/commit/8a39749c7c5da7fd6fe0bddc66b3663e3c41a51a", "message": "Maintain CH table per JITServer client instead of globally\n\nBefore this commit, server had one global CH table access\nto which was controlled by one global lock.\nThis is not ideal when multiple clients connect to the server\nbecause it leads to scalability issues due to lock contention\nand also one client might retrieve data that belongs to another client.\n\nThis commit replaces the global CH table with one created per client.\nLock contention is also removed as we now have one lock per client as\nwell.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-09-08T19:24:30Z", "type": "forcePushed"}, {"oid": "adacc61cfc364a66a065097bf64915ab72976ea9", "url": "https://github.com/eclipse-openj9/openj9/commit/adacc61cfc364a66a065097bf64915ab72976ea9", "message": "Maintain CH table per JITServer client instead of globally\n\nBefore this commit, server had one global CH table access\nto which was controlled by one global lock.\nThis is not ideal when multiple clients connect to the server\nbecause it leads to scalability issues due to lock contention\nand also one client might retrieve data that belongs to another client.\n\nThis commit replaces the global CH table with one created per client.\nLock contention is also removed as we now have one lock per client as\nwell.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-09-08T19:26:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE0OTA4OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#discussion_r485149089", "bodyText": "@mpirvu The includes in this file have some weird issues:\n\nIf I uncomment #if defined(J9VM_OPT_JITSERVER), then the code compiles but it compiles as if the environment variable is not set, i.e. none of the jitserver code in this file is compiled.\nIf I move PersistentInfo include to the top of the file, then compilation fails with \u2018getRemoteCompilationMode\u2019 was not declared in this scope message despite it being declared in J9PersistentInfo.hpp.\n\nI don't know what might be causing this as I think I modified make/cmake files correctly and everything else compiles without problems. This problem persists when I build a clean OpenJ9 sdk so it's not a stale build issue.", "author": "dmitry-ten", "createdAt": "2020-09-08T19:31:45Z", "path": "runtime/compiler/env/J9PersistentInfo.cpp", "diffHunk": "@@ -0,0 +1,51 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020, 2020 IBM Corp. and others\n+ *\n+ * This program and the accompanying materials are made available under\n+ * the terms of the Eclipse Public License 2.0 which accompanies this\n+ * distribution and is available at https://www.eclipse.org/legal/epl-2.0/\n+ * or the Apache License, Version 2.0 which accompanies this distribution and\n+ * is available at https://www.apache.org/licenses/LICENSE-2.0.\n+ *\n+ * This Source Code may also be made available under the following\n+ * Secondary Licenses when the conditions for such availability set\n+ * forth in the Eclipse Public License, v. 2.0 are satisfied: GNU\n+ * General Public License, version 2 with the GNU Classpath\n+ * Exception [1] and GNU General Public License, version 2 with the\n+ * OpenJDK Assembly Exception [2].\n+ *\n+ * [1] https://www.gnu.org/software/classpath/license.html\n+ * [2] http://openjdk.java.net/legal/assembly-exception.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-exception-2.0 OR LicenseRef-GPL-2.0 WITH Assembly-exception\n+ *******************************************************************************/\n+// #if defined(J9VM_OPT_JITSERVER)\n+#include \"control/CompilationThread.hpp\"\n+#include \"runtime/JITClientSession.hpp\"\n+// #endif\n+#include \"env/PersistentInfo.hpp\"", "originalCommit": "adacc61cfc364a66a065097bf64915ab72976ea9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTgxNTMxNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#discussion_r485815316", "bodyText": "From my diagnostic, even for other files J9VM_OPT_JITSERVER is not defined. What defines it is j9cfg.h, so we need to include this header file in all files that use JITServer code.\nIn most of the places it works because we include a header which includes another header, etc, which includes j9cfg.h", "author": "mpirvu", "createdAt": "2020-09-09T18:05:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE0OTA4OQ=="}], "type": "inlineReview"}, {"oid": "ca99164138432936c756a3500e5606f84c740849", "url": "https://github.com/eclipse-openj9/openj9/commit/ca99164138432936c756a3500e5606f84c740849", "message": "Maintain CH table per JITServer client instead of globally\n\nBefore this commit, server had one global CH table access\nto which was controlled by one global lock.\nThis is not ideal when multiple clients connect to the server\nbecause it leads to scalability issues due to lock contention\nand also one client might retrieve data that belongs to another client.\n\nThis commit replaces the global CH table with one created per client.\nLock contention is also removed as we now have one lock per client as\nwell.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-09-08T19:54:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTYwMTk0Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#discussion_r485601947", "bodyText": "Shouldn't this be J9PersistentInfo.hpp ?", "author": "mpirvu", "createdAt": "2020-09-09T13:15:55Z", "path": "runtime/compiler/env/J9PersistentInfo.cpp", "diffHunk": "@@ -0,0 +1,51 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020, 2020 IBM Corp. and others\n+ *\n+ * This program and the accompanying materials are made available under\n+ * the terms of the Eclipse Public License 2.0 which accompanies this\n+ * distribution and is available at https://www.eclipse.org/legal/epl-2.0/\n+ * or the Apache License, Version 2.0 which accompanies this distribution and\n+ * is available at https://www.apache.org/licenses/LICENSE-2.0.\n+ *\n+ * This Source Code may also be made available under the following\n+ * Secondary Licenses when the conditions for such availability set\n+ * forth in the Eclipse Public License, v. 2.0 are satisfied: GNU\n+ * General Public License, version 2 with the GNU Classpath\n+ * Exception [1] and GNU General Public License, version 2 with the\n+ * OpenJDK Assembly Exception [2].\n+ *\n+ * [1] https://www.gnu.org/software/classpath/license.html\n+ * [2] http://openjdk.java.net/legal/assembly-exception.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-exception-2.0 OR LicenseRef-GPL-2.0 WITH Assembly-exception\n+ *******************************************************************************/\n+// #if defined(J9VM_OPT_JITSERVER)\n+#include \"control/CompilationThread.hpp\"\n+#include \"runtime/JITClientSession.hpp\"\n+// #endif\n+#include \"env/PersistentInfo.hpp\"", "originalCommit": "ca99164138432936c756a3500e5606f84c740849", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTY0Mzk1OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#discussion_r485643958", "bodyText": "Well PersistentInfo.hpp includes J9PersistentInfo.hpp so that should be fine.\nIn all other instances of this include non-J9 version is used so I used it here as well.\nChanging it to J9 doesn't seem to have any effect.", "author": "dmitry-ten", "createdAt": "2020-09-09T14:11:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTYwMTk0Nw=="}], "type": "inlineReview"}, {"oid": "f80102380e90b91caca55ee5707b24b709d6ac77", "url": "https://github.com/eclipse-openj9/openj9/commit/f80102380e90b91caca55ee5707b24b709d6ac77", "message": "Maintain CH table per JITServer client instead of globally\n\nBefore this commit, server had one global CH table access\nto which was controlled by one global lock.\nThis is not ideal when multiple clients connect to the server\nbecause it leads to scalability issues due to lock contention\nand also one client might retrieve data that belongs to another client.\n\nThis commit replaces the global CH table with one created per client.\nLock contention is also removed as we now have one lock per client as\nwell.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-09-09T18:47:27Z", "type": "forcePushed"}, {"oid": "67ae9a357a82884837c892371b444b4639fd24c5", "url": "https://github.com/eclipse-openj9/openj9/commit/67ae9a357a82884837c892371b444b4639fd24c5", "message": "Maintain CH table per JITServer client instead of globally\n\nBefore this commit, server had one global CH table access\nto which was controlled by one global lock.\nThis is not ideal when multiple clients connect to the server\nbecause it leads to scalability issues due to lock contention\nand also one client might retrieve data that belongs to another client.\n\nThis commit replaces the global CH table with one created per client.\nLock contention is also removed as we now have one lock per client as\nwell.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-09-09T18:58:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk5NDc0Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#discussion_r485994743", "bodyText": "We typically arrange these filenames alphabetically, so we should put this new file after\nenv/J9ObjectModel.cpp", "author": "mpirvu", "createdAt": "2020-09-10T00:33:58Z", "path": "runtime/compiler/env/CMakeLists.txt", "diffHunk": "@@ -57,6 +57,7 @@ j9jit_files(\n \tenv/Startup.cpp\n \tenv/SystemSegmentProvider.cpp\n \tenv/VMJ9.cpp\n+\tenv/J9PersistentInfo.cpp", "originalCommit": "67ae9a357a82884837c892371b444b4639fd24c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ0NTEwNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#discussion_r486445106", "bodyText": "Done", "author": "dmitry-ten", "createdAt": "2020-09-10T15:42:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk5NDc0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk5OTU0NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#discussion_r485999545", "bodyText": "I don't see where this monitor is used.", "author": "mpirvu", "createdAt": "2020-09-10T00:51:48Z", "path": "runtime/compiler/env/JITServerPersistentCHTable.hpp", "diffHunk": "@@ -79,7 +82,8 @@ class JITServerPersistentCHTable : public TR_PersistentCHTable\n    void commitRemoves(const std::string &data);\n    void commitModifications(const std::string &data);\n \n-   PersistentUnorderedMap<TR_OpaqueClassBlock*, TR_PersistentClassInfo*> &getData();\n+   PersistentUnorderedMap<TR_OpaqueClassBlock*, TR_PersistentClassInfo*> _classMap;\n+   TR::Monitor *_classMapMonitor;", "originalCommit": "67ae9a357a82884837c892371b444b4639fd24c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ0NTE4NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#discussion_r486445184", "bodyText": "Fixed.", "author": "dmitry-ten", "createdAt": "2020-09-10T15:42:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk5OTU0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk5OTc4OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#discussion_r485999789", "bodyText": "Maybe we should give a different name to this function because there is another classMapMonitor in the client session and it can be confusing", "author": "mpirvu", "createdAt": "2020-09-10T00:52:47Z", "path": "runtime/compiler/env/JITServerPersistentCHTable.hpp", "diffHunk": "@@ -56,15 +56,18 @@ class JITServerPersistentCHTable : public TR_PersistentCHTable\n    TR_ALLOC(TR_Memory::PersistentCHTable)\n \n    JITServerPersistentCHTable(TR_PersistentMemory *);\n+   ~JITServerPersistentCHTable();\n \n-   bool isInitialized() { return !getData().empty(); } // needs CHTable mutex in hand\n+   bool isInitialized() { return !_classMap.empty(); } // needs CHTable monitor in hand\n    bool initializeCHTable(TR_J9VMBase *fej9, const std::string &rawData);\n    void doUpdate(TR_J9VMBase *fej9, const std::string &removeStr, const std::string &modifyStr);\n \n    virtual TR_PersistentClassInfo * findClassInfo(TR_OpaqueClassBlock * classId) override;\n    virtual TR_PersistentClassInfo * findClassInfoAfterLocking(TR_OpaqueClassBlock * classId, TR::Compilation *, bool returnClassInfoForAOT = false) override;\n    virtual TR_PersistentClassInfo * findClassInfoAfterLocking(TR_OpaqueClassBlock * classId, TR_FrontEnd *, bool returnClassInfoForAOT = false) override;\n \n+   TR::Monitor *getClassMapMonitor() { return _classMapMonitor; }", "originalCommit": "67ae9a357a82884837c892371b444b4639fd24c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ0NTMzNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#discussion_r486445335", "bodyText": "Changed to chTableMonitor", "author": "dmitry-ten", "createdAt": "2020-09-10T15:42:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk5OTc4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAwNjQwMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#discussion_r486006402", "bodyText": "clearCaches() must clear the CHTable as well.", "author": "mpirvu", "createdAt": "2020-09-10T01:18:00Z", "path": "runtime/compiler/runtime/JITClientSession.cpp", "diffHunk": "@@ -501,14 +507,6 @@ ClientSessionData::clearCaches()\n \n    _classChainDataMap.clear();", "originalCommit": "67ae9a357a82884837c892371b444b4639fd24c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQzMjQyNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#discussion_r486432426", "bodyText": "I clear the CHTable in ClientSessionData destructor, since it was previously cleared there.\nI will move it to clearCaches() if you'd prefer that.", "author": "dmitry-ten", "createdAt": "2020-09-10T15:24:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAwNjQwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcwMTgzMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#discussion_r486701833", "bodyText": "In case some message gets lost we have to clear all caches and start all over because that message may have carried important class unload and CHTable modification that needs to be applied. The client session data is not destroyed, just the caches are cleared, including the CHTable.", "author": "mpirvu", "createdAt": "2020-09-11T00:16:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAwNjQwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAwODg5Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#discussion_r486008892", "bodyText": "We need the acquire the new monitor that was created for the CHTable per client", "author": "mpirvu", "createdAt": "2020-09-10T01:27:15Z", "path": "runtime/compiler/env/VMJ9Server.cpp", "diffHunk": "@@ -1914,6 +1914,25 @@ TR_J9ServerVM::getObjectSizeClass(uintptr_t objectSize)\n    return 0;\n    }\n \n+bool\n+TR_J9ServerVM::acquireClassTableMutex()\n+   {\n+   // Acquire per-client class table lock\n+   TR::Monitor *classTableMonitor = _compInfoPT->getClientData()->getClassMapMonitor();", "originalCommit": "67ae9a357a82884837c892371b444b4639fd24c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQyOTI3Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#discussion_r486429272", "bodyText": "Yeah, this is an unexpected error. I first had the CH table monitor in client session but then I realized that it's better to have it inside server-side CH-table and moved it there. But I also changed the name from _classTableMonitor to _classMapMonitor without realizing that the monitor with such name already exists.", "author": "dmitry-ten", "createdAt": "2020-09-10T15:20:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAwODg5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAwOTA0NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#discussion_r486009044", "bodyText": "We need the release the new monitor that was created for the CHTable per client", "author": "mpirvu", "createdAt": "2020-09-10T01:27:52Z", "path": "runtime/compiler/env/VMJ9Server.cpp", "diffHunk": "@@ -1914,6 +1914,25 @@ TR_J9ServerVM::getObjectSizeClass(uintptr_t objectSize)\n    return 0;\n    }\n \n+bool\n+TR_J9ServerVM::acquireClassTableMutex()\n+   {\n+   // Acquire per-client class table lock\n+   TR::Monitor *classTableMonitor = _compInfoPT->getClientData()->getClassMapMonitor();\n+   TR_ASSERT_FATAL(classTableMonitor, \"CH table and its monitor must be initialized\");\n+   classTableMonitor->enter();\n+   return true;\n+   }\n+\n+void\n+TR_J9ServerVM::releaseClassTableMutex(bool releaseVMAccess)\n+   {\n+   // Release per-cient class table lock\n+   TR::Monitor *classTableMonitor = _compInfoPT->getClientData()->getClassMapMonitor();", "originalCommit": "67ae9a357a82884837c892371b444b4639fd24c5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAwOTk5OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#discussion_r486009999", "bodyText": "We can forward declare class JITServerPersistentCHTable and avoid this include.\nWe may need an include in the cpp file though", "author": "mpirvu", "createdAt": "2020-09-10T01:31:27Z", "path": "runtime/compiler/runtime/JITClientSession.hpp", "diffHunk": "@@ -27,6 +27,7 @@\n #include \"env/PersistentCollections.hpp\" // for PersistentUnorderedMap\n #include \"il/DataTypes.hpp\" // for DataType\n #include \"env/VMJ9.h\" // for TR_StaticFinalData\n+#include \"env/JITServerPersistentCHTable.hpp\"", "originalCommit": "67ae9a357a82884837c892371b444b4639fd24c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ0NTQ4Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#discussion_r486445482", "bodyText": "Done", "author": "dmitry-ten", "createdAt": "2020-09-10T15:42:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAwOTk5OQ=="}], "type": "inlineReview"}, {"oid": "ad825933876c82422a2572312d525031060588b1", "url": "https://github.com/eclipse-openj9/openj9/commit/ad825933876c82422a2572312d525031060588b1", "message": "Maintain CH table per JITServer client instead of globally\n\nBefore this commit, server had one global CH table access\nto which was controlled by one global lock.\nThis is not ideal when multiple clients connect to the server\nbecause it leads to scalability issues due to lock contention\nand also one client might retrieve data that belongs to another client.\n\nThis commit replaces the global CH table with one created per client.\nLock contention is also removed as we now have one lock per client as\nwell.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-09-10T15:39:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcwMDYzMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#discussion_r486700633", "bodyText": "I wonder I should we do if the monitor cannot be initialized. Maybe throw bad_alloc as if we couldn't allocate the memory.", "author": "mpirvu", "createdAt": "2020-09-11T00:12:38Z", "path": "runtime/compiler/env/JITServerPersistentCHTable.cpp", "diffHunk": "@@ -31,14 +31,23 @@\n \n \n JITServerPersistentCHTable::JITServerPersistentCHTable(TR_PersistentMemory *trMemory)\n-   : TR_PersistentCHTable(trMemory)\n+   : TR_PersistentCHTable(trMemory),\n+   _classMap(decltype(_classMap)::allocator_type(TR::Compiler->persistentAllocator()))\n    {\n+   _chTableMonitor = TR::Monitor::create(\"JIT-JITServerCHTableMonitor\");", "originalCommit": "ad825933876c82422a2572312d525031060588b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzEyNzk5MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#discussion_r487127991", "bodyText": "Probably.", "author": "dmitry-ten", "createdAt": "2020-09-11T15:38:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcwMDYzMw=="}], "type": "inlineReview"}, {"oid": "5e350ebbff75c434e90b18e0c505a1e2eb875371", "url": "https://github.com/eclipse-openj9/openj9/commit/5e350ebbff75c434e90b18e0c505a1e2eb875371", "message": "Maintain CH table per JITServer client instead of globally\n\nBefore this commit, server had one global CH table access\nto which was controlled by one global lock.\nThis is not ideal when multiple clients connect to the server\nbecause it leads to scalability issues due to lock contention\nand also one client might retrieve data that belongs to another client.\n\nThis commit replaces the global CH table with one created per client.\nLock contention is also removed as we now have one lock per client as\nwell.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-09-11T15:47:52Z", "type": "forcePushed"}, {"oid": "2e2f6bde20fb30eedb27ddc2c22dbc3cadd7e287", "url": "https://github.com/eclipse-openj9/openj9/commit/2e2f6bde20fb30eedb27ddc2c22dbc3cadd7e287", "message": "Maintain CH table per JITServer client instead of globally\n\nBefore this commit, server had one global CH table access\nto which was controlled by one global lock.\nThis is not ideal when multiple clients connect to the server\nbecause it leads to scalability issues due to lock contention\nand also one client might retrieve data that belongs to another client.\n\nThis commit replaces the global CH table with one created per client.\nLock contention is also removed as we now have one lock per client as\nwell.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-09-11T16:21:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE5MTUxNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#discussion_r487191516", "bodyText": "We need to set the _chTable to NULL after freeing it. The session may continue to live even after caches are cleared.", "author": "mpirvu", "createdAt": "2020-09-11T17:36:42Z", "path": "runtime/compiler/runtime/JITClientSession.cpp", "diffHunk": "@@ -501,17 +502,16 @@ ClientSessionData::clearCaches()\n \n    _classChainDataMap.clear();\n \n-   // Free CHTable \n-   for (auto& it : _chTableClassMap)\n-      {\n-      TR_PersistentClassInfo *classInfo = it.second;\n-      classInfo->removeSubClasses();\n-      jitPersistentFree(classInfo);\n-      }\n-   _chTableClassMap.clear();\n    _registeredJ2IThunksMap.clear();\n    _registeredInvokeExactJ2IThunksSet.clear();\n    _bClassUnloadingAttempt = false;\n+\n+   if (_chTable)\n+      {\n+      // Free CH table\n+      _chTable->~JITServerPersistentCHTable();\n+      jitPersistentFree(_chTable);\n+      }", "originalCommit": "2e2f6bde20fb30eedb27ddc2c22dbc3cadd7e287", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIwMDkzNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10508#discussion_r487200935", "bodyText": "Fixed", "author": "dmitry-ten", "createdAt": "2020-09-11T17:55:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE5MTUxNg=="}], "type": "inlineReview"}, {"oid": "c231a5c687903b033139d436bea37f85748fce61", "url": "https://github.com/eclipse-openj9/openj9/commit/c231a5c687903b033139d436bea37f85748fce61", "message": "Maintain CH table per JITServer client instead of globally\n\nBefore this commit, server had one global CH table access\nto which was controlled by one global lock.\nThis is not ideal when multiple clients connect to the server\nbecause it leads to scalability issues due to lock contention\nand also one client might retrieve data that belongs to another client.\n\nThis commit replaces the global CH table with one created per client.\nLock contention is also removed as we now have one lock per client as\nwell.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-09-11T17:53:33Z", "type": "commit"}, {"oid": "c231a5c687903b033139d436bea37f85748fce61", "url": "https://github.com/eclipse-openj9/openj9/commit/c231a5c687903b033139d436bea37f85748fce61", "message": "Maintain CH table per JITServer client instead of globally\n\nBefore this commit, server had one global CH table access\nto which was controlled by one global lock.\nThis is not ideal when multiple clients connect to the server\nbecause it leads to scalability issues due to lock contention\nand also one client might retrieve data that belongs to another client.\n\nThis commit replaces the global CH table with one created per client.\nLock contention is also removed as we now have one lock per client as\nwell.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-09-11T17:53:33Z", "type": "forcePushed"}]}