{"pr_number": 10396, "pr_title": "Report Monitor References in gc-end", "pr_createdAt": "2020-08-16T20:28:15Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10396", "timeline": [{"oid": "3268e0d62bfe89022ae8f3620ad0db980a9b8d43", "url": "https://github.com/eclipse-openj9/openj9/commit/3268e0d62bfe89022ae8f3620ad0db980a9b8d43", "message": "VGCL: report Monitor References\n\nReport Monitor References in following types of GC operations:\n\tmark,scavenge,mark increment, copy forward\n\nSigned-off-by: Enson Guo <enson.guo@ibm.com>", "committedDate": "2020-08-16T23:01:29Z", "type": "forcePushed"}, {"oid": "8737d4f893c881790f01bc9b41ef1635be8db1e1", "url": "https://github.com/eclipse-openj9/openj9/commit/8737d4f893c881790f01bc9b41ef1635be8db1e1", "message": "VGCL: report Monitor References\n\nReport Monitor References in following types of GC operations:\n\tmark,scavenge,mark increment, copy forward\n\nSigned-off-by: Enson Guo <enson.guo@ibm.com>", "committedDate": "2020-08-19T22:52:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUzNjQ0NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10396#discussion_r477536445", "bodyText": "Should this be += 1?", "author": "RSalman", "createdAt": "2020-08-26T19:24:48Z", "path": "runtime/gc_vlhgc/GlobalMarkingScheme.cpp", "diffHunk": "@@ -1192,8 +1192,10 @@ class MM_GlobalMarkingSchemeRootClearer : public MM_RootScanner\n \n \tvirtual void doMonitorReference(J9ObjectMonitor *objectMonitor, GC_HashTableIterator *monitorReferenceIterator) {\n \t\tJ9ThreadAbstractMonitor * monitor = (J9ThreadAbstractMonitor*)objectMonitor->monitor;\n+\t\tMM_EnvironmentVLHGC::getEnvironment(_env)->_markVLHGCStats._monitorReferenceCandidates = 1;", "originalCommit": "8737d4f893c881790f01bc9b41ef1635be8db1e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUzODMzMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10396#discussion_r477538333", "bodyText": "No need for new line here", "author": "RSalman", "createdAt": "2020-08-26T19:28:18Z", "path": "runtime/gc_stats/ScavengerJavaStats.cpp", "diffHunk": "@@ -65,4 +73,8 @@ MM_ScavengerJavaStats::mergeOwnableSynchronizerCounts(MM_ScavengerJavaStats *sta\n \t_ownableSynchronizerCandidates += statsToMerge->_ownableSynchronizerCandidates;\n \t_ownableSynchronizerTotalSurvived += statsToMerge->_ownableSynchronizerTotalSurvived;\n \t_ownableSynchronizerNurserySurvived += statsToMerge->_ownableSynchronizerNurserySurvived;\n+\n+\t_monitorReferenceCleared += statsToMerge->_monitorReferenceCleared;\n+\t_monitorReferenceCandidates += statsToMerge->_monitorReferenceCandidates;\n+", "originalCommit": "8737d4f893c881790f01bc9b41ef1635be8db1e1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e1d47f68d9bedb52f576ef40fca90c4f356c4930", "url": "https://github.com/eclipse-openj9/openj9/commit/e1d47f68d9bedb52f576ef40fca90c4f356c4930", "message": "VGCL: report Monitor References\n\nReport Monitor References in following types of GC operations:\n\tmark,scavenge,mark increment, copy forward\n\nSigned-off-by: Enson Guo <enson.guo@ibm.com>", "committedDate": "2020-08-26T19:44:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU1NTE0Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10396#discussion_r477555142", "bodyText": "Comments on the above 2 lines should not mention \"marking\", should be changed to say \"during scavenge\" or \"for the cycle\"", "author": "RSalman", "createdAt": "2020-08-26T19:59:47Z", "path": "runtime/gc_stats/ScavengerJavaStats.hpp", "diffHunk": "@@ -58,6 +58,9 @@ class MM_ScavengerJavaStats\n \tMM_ReferenceStats _softReferenceStats;  /**< Soft reference stats for the cycle */\n \tMM_ReferenceStats _phantomReferenceStats;  /**< Phantom reference stats for the cycle */\n \n+\tUDATA _monitorReferenceCleared; /**< The number of monitor references that have been cleared during marking */\n+\tUDATA _monitorReferenceCandidates; /**< The number of monitor references that have been visited in monitor table during marking */\n+", "originalCommit": "e1d47f68d9bedb52f576ef40fca90c4f356c4930", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU5MzQwNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10396#discussion_r478593404", "bodyText": "This piece of comment is \"copied\" from the definition of _stringConstantsCleared and repeated in several files. I realize this is only place '_monitorReferenceCleared' is defined but not _stringConstantsCleared . I assume you want to change from \"marking\" to  \"during scavenge\" because the difference in the nature of these operations. Do you mind explaining more?  Is It because in all other files they are marked and in ScavengerJavaStats.hpp they get scavenged?", "author": "gza060625", "createdAt": "2020-08-27T17:49:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU1NTE0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODYwNzQ3Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10396#discussion_r478607472", "bodyText": "ScavengerJavaStats is specific for Scavenger (as the name implies) and Scavenger is a copying collector as opposed to a marking collector. The other stat classes are specific to marking collectors, which is why the comment is valid there.", "author": "RSalman", "createdAt": "2020-08-27T18:15:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU1NTE0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU1NjUyOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10396#discussion_r477556528", "bodyText": "monitor ref clear should not be in this method", "author": "RSalman", "createdAt": "2020-08-26T20:02:22Z", "path": "runtime/gc_stats/ScavengerJavaStats.cpp", "diffHunk": "@@ -57,6 +62,9 @@ MM_ScavengerJavaStats::clearOwnableSynchronizerCounts()\n \t_ownableSynchronizerCandidates = 0;\n \t_ownableSynchronizerTotalSurvived = 0;\n \t_ownableSynchronizerNurserySurvived = 0;\n+\n+\t_monitorReferenceCleared = 0;\n+\t_monitorReferenceCandidates = 0;", "originalCommit": "e1d47f68d9bedb52f576ef40fca90c4f356c4930", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU2MDc2Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/10396#discussion_r477560766", "bodyText": "MM_ScavengerJavaStats::clear() is sufficient", "author": "RSalman", "createdAt": "2020-08-26T20:11:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU1NjUyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU2MzQyMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10396#discussion_r477563423", "bodyText": "Extra new line should be removed here", "author": "RSalman", "createdAt": "2020-08-26T20:16:22Z", "path": "runtime/gc_stats/MarkVLHGCStats.hpp", "diffHunk": "@@ -126,6 +132,10 @@ class MM_MarkVLHGCStats : public MM_MarkVLHGCStatsCore\n \t\t_stringConstantsCleared += statsToMerge->_stringConstantsCleared;\n \t\t_stringConstantsCandidates += statsToMerge->_stringConstantsCandidates;\n \n+", "originalCommit": "e1d47f68d9bedb52f576ef40fca90c4f356c4930", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU3MjgxOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10396#discussion_r477572818", "bodyText": "I would swap this line and line 311, var declaration/initialization should come first in a case like this", "author": "RSalman", "createdAt": "2020-08-26T20:34:36Z", "path": "runtime/gc_glue_java/MarkingSchemeRootClearer.cpp", "diffHunk": "@@ -306,9 +306,12 @@ MM_MarkingSchemeRootClearer::scanOwnableSynchronizerObjects(MM_EnvironmentBase *\n void\n MM_MarkingSchemeRootClearer::doMonitorReference(J9ObjectMonitor *objectMonitor, GC_HashTableIterator *monitorReferenceIterator)\n {\n+\t_env->getGCEnvironment()->_markJavaStats._monitorReferenceCandidates += 1;", "originalCommit": "e1d47f68d9bedb52f576ef40fca90c4f356c4930", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU5OTk4NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10396#discussion_r478599984", "bodyText": "For sure I could do the swap. I am just wondering if variable declaration/initialization always comes first.  @RSalman", "author": "gza060625", "createdAt": "2020-08-27T18:01:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU3MjgxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODYxMDE4Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10396#discussion_r478610182", "bodyText": "Yup, typically when the declared/init var scope is the entire function.", "author": "RSalman", "createdAt": "2020-08-27T18:20:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU3MjgxOA=="}], "type": "inlineReview"}, {"oid": "a271bc7c55d62937bb2561f8833ac4713ccd0303", "url": "https://github.com/eclipse-openj9/openj9/commit/a271bc7c55d62937bb2561f8833ac4713ccd0303", "message": "VGCL: report Monitor References\n\nReport Monitor References in following types of GC operations:\n\tmark,scavenge,mark increment, copy forward\n\nSigned-off-by: Enson Guo <enson.guo@ibm.com>", "committedDate": "2020-08-27T17:02:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg0MzkyNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10396#discussion_r479843925", "bodyText": "@RSalman Should I delete these two lines? type=\"scavenge\" works without them. I believe they are merged in here:\nhttps://github.com/eclipse/openj9/blob/ad023b2e405300e319bff32e728bd1cfef2defab/runtime/gc_glue_java/ScavengerDelegate.cpp#L227\nWould like to confirm with you.", "author": "gza060625", "createdAt": "2020-08-31T01:18:08Z", "path": "runtime/gc_stats/ScavengerJavaStats.cpp", "diffHunk": "@@ -65,4 +71,8 @@ MM_ScavengerJavaStats::mergeOwnableSynchronizerCounts(MM_ScavengerJavaStats *sta\n \t_ownableSynchronizerCandidates += statsToMerge->_ownableSynchronizerCandidates;\n \t_ownableSynchronizerTotalSurvived += statsToMerge->_ownableSynchronizerTotalSurvived;\n \t_ownableSynchronizerNurserySurvived += statsToMerge->_ownableSynchronizerNurserySurvived;\n+\n+\t// _monitorReferenceCleared += statsToMerge->_monitorReferenceCleared;\n+\t// _monitorReferenceCandidates += statsToMerge->_monitorReferenceCandidates;", "originalCommit": "ad023b2e405300e319bff32e728bd1cfef2defab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDYxOTAxMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10396#discussion_r480619010", "bodyText": "Yes, these lines shouldn't be here", "author": "RSalman", "createdAt": "2020-09-01T02:28:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg0MzkyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM1MDI4Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10396#discussion_r481350283", "bodyText": "Please remove surrounding new lines, that matches more with rest of the method formatting", "author": "RSalman", "createdAt": "2020-09-01T18:35:31Z", "path": "runtime/gc_glue_java/ScavengerRootClearer.hpp", "diffHunk": "@@ -188,12 +188,16 @@ class MM_ScavengerRootClearer : public MM_RootScanner\n \t\tbool const compressed = _extensions->compressObjectReferences();\n \t\tJ9ThreadAbstractMonitor * monitor = (J9ThreadAbstractMonitor*)objectMonitor->monitor;\n \t\tomrobjectptr_t objectPtr = (omrobjectptr_t )monitor->userData;\n+\n+\t\t_env->getGCEnvironment()->_scavengerJavaStats._monitorReferenceCandidates += 1;", "originalCommit": "43648b4bc636e6527511c94f6cd5c136644bc9f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM1MTIyMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10396#discussion_r481351220", "bodyText": "This new line should be removed", "author": "RSalman", "createdAt": "2020-09-01T18:37:12Z", "path": "runtime/gc_stats/ScavengerJavaStats.cpp", "diffHunk": "@@ -57,6 +62,7 @@ MM_ScavengerJavaStats::clearOwnableSynchronizerCounts()\n \t_ownableSynchronizerCandidates = 0;\n \t_ownableSynchronizerTotalSurvived = 0;\n \t_ownableSynchronizerNurserySurvived = 0;\n+", "originalCommit": "43648b4bc636e6527511c94f6cd5c136644bc9f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6d0cdeeb66da767c30ecd36c785f15f596bccc0f", "url": "https://github.com/eclipse-openj9/openj9/commit/6d0cdeeb66da767c30ecd36c785f15f596bccc0f", "message": "VGCL: report Monitor References\n\nReport Monitor References in following types of GC operations:\n\tmark,scavenge,mark increment, copy forward\n\nSigned-off-by: Enson Guo <enson.guo@ibm.com>", "committedDate": "2020-09-01T18:56:32Z", "type": "commit"}, {"oid": "6d0cdeeb66da767c30ecd36c785f15f596bccc0f", "url": "https://github.com/eclipse-openj9/openj9/commit/6d0cdeeb66da767c30ecd36c785f15f596bccc0f", "message": "VGCL: report Monitor References\n\nReport Monitor References in following types of GC operations:\n\tmark,scavenge,mark increment, copy forward\n\nSigned-off-by: Enson Guo <enson.guo@ibm.com>", "committedDate": "2020-09-01T18:56:32Z", "type": "forcePushed"}]}