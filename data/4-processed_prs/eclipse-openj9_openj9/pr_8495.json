{"pr_number": 8495, "pr_title": "JEP358 extended NPE message part 1 - result of this NPE", "pr_createdAt": "2020-02-04T15:54:26Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/8495", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDc2OTc3MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r374769770", "bodyText": "Might be better to simply pass _currentThread to the message helper and let it fetch the data that's required.\nAlso need to verify that every path here has not incremented the pc (I suspect this is already true).", "author": "gacholio", "createdAt": "2020-02-04T16:13:13Z", "path": "runtime/vm/BytecodeInterpreter.hpp", "diffHunk": "@@ -9621,6 +9623,13 @@ runMethodHandle: {\n \tVMStructHasBeenUpdated(REGISTER_ARGS);\n \tgoto throwCurrentException;\n \n+nullPointerWithExtendedMsg:\n+\tupdateVMStruct(REGISTER_ARGS);\n+\tprepareForExceptionThrow(_currentThread);\n+\tsetCurrentExceptionUTF(_currentThread, J9VMCONSTANTPOOL_JAVALANGNULLPOINTEREXCEPTION, getExtendedNPEMessage(_currentThread, *_pc, *(U_16*)(_pc + 1), J9_CP_FROM_METHOD(_literals)));", "originalCommit": "6c712e3c2b3cffafe3a085eb8defac7879b87325", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg1OTcwNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r374859707", "bodyText": "prepareForExceptionThrow(_currentThread) could update _currentThread->_pc, hence getExtendedNPEMessage() can't retrieve current _pc value via _currentThread.", "author": "JasonFengJ9", "createdAt": "2020-02-04T18:56:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDc2OTc3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTIyNjM3NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r379226375", "bodyText": "@gacholio @DanHeidinga this is ready for review.", "author": "JasonFengJ9", "createdAt": "2020-02-14T02:42:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDc2OTc3MA=="}], "type": "inlineReview"}, {"oid": "06eb85ebedd25c960783ca75117251c8ae4a59fc", "url": "https://github.com/eclipse-openj9/openj9/commit/06eb85ebedd25c960783ca75117251c8ae4a59fc", "message": "JEP358 extended NPE message part 1 - result of this NPE\n\nModified iterateStackTrace callback_func_t to return methodPC and\nRAM constantPool, also added an additional parameter to indicated the\nnumber of cache items;\nCreated two helper methods walkStackFramesWithSelectedFlags and\nsetWalkbackAfterWalkStackFrames to remove some code duplication;\nSpecified J9_STACKWALK_CACHE_CPS for NPE when JEP358 feature is enabled;\nJVM_GetExtendedNPEMessage is going to construct NPE extended message\non-demand;\nConstructing NPE message according to the bytecode itself for\naload/astore, arraylength, athrow, monitorenter/monitorexit;\nConstructing NPE message according to the bytecode and field index for\ngetfield/putfield;\nConstructing NPE message according to the bytecode and method index for\ninvokeinterface/invokespecial/invokevirtual;\nAdded a runtime flag J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG to\nspecify the command line option\n-XX:{+|-}ShowCodeDetailsInExceptionMessages;\nAdded NLS and trace messages.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>", "committedDate": "2020-02-13T22:17:38Z", "type": "forcePushed"}, {"oid": "ff1f62896f2d2faef7616a0390c87312acc1d607", "url": "https://github.com/eclipse-openj9/openj9/commit/ff1f62896f2d2faef7616a0390c87312acc1d607", "message": "JEP358 extended NPE message part 1 - result of this NPE\n\nModified iterateStackTrace callback_func_t to return methodPC and\nRAM constantPool, also added an additional parameter to indicated the\nnumber of cache items;\nCreated two helper methods walkStackFramesWithSelectedFlags and\nsetWalkbackAfterWalkStackFrames to remove some code duplication;\nSpecified J9_STACKWALK_CACHE_CPS for NPE when JEP358 feature is enabled;\nJVM_GetExtendedNPEMessage is going to construct NPE extended message\non-demand;\nConstructing NPE message according to the bytecode itself for\naload/astore, arraylength, athrow, monitorenter/monitorexit;\nConstructing NPE message according to the bytecode and field index for\ngetfield/putfield;\nConstructing NPE message according to the bytecode and method index for\ninvokeinterface/invokespecial/invokevirtual;\nAdded a runtime flag J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG to\nspecify the command line option\n-XX:{+|-}ShowCodeDetailsInExceptionMessages;\nAdded NLS and trace messages.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>", "committedDate": "2020-02-16T16:24:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg2MjAyNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r380862027", "bodyText": "The benefit of this being a local var is that we knew what it meant.  Better than seeing 0, 1.  Can you restore this as and make it const?", "author": "DanHeidinga", "createdAt": "2020-02-18T18:42:18Z", "path": "runtime/j9vm/j7vmi.c", "diffHunk": "@@ -1358,13 +1358,11 @@ jint JNICALL\n JVM_GetStackTraceDepth(JNIEnv* env, jobject throwable)\n {\n \tJ9VMThread* currentThread = (J9VMThread*) env;\n-\tJ9JavaVM * vm = currentThread->javaVM;\n-\tJ9InternalVMFunctions * vmfns = vm->internalVMFunctions;\n-\tjint numberOfFrames;\n-\tUDATA pruneConstructors = 0;", "originalCommit": "ff1f62896f2d2faef7616a0390c87312acc1d607", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA2Mjk1OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r381062959", "bodyText": "Got it, restored and made it const.", "author": "JasonFengJ9", "createdAt": "2020-02-19T03:45:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg2MjAyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg2MjUyMQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r380862521", "bodyText": "please add a new line to the end of the file", "author": "DanHeidinga", "createdAt": "2020-02-18T18:43:15Z", "path": "runtime/j9vm/j9scar.tdf", "diffHunk": "@@ -338,3 +338,8 @@ TraceEvent=Trc_SC_LoadSystemLibrary_LoadFailed NoEnv Overhead=1 Level=1 Template\n TraceEntry=Trc_SC_RegisterSignal_Entry Overhead=1 Level=1 Template=\"JVM_RegisterSignal(signal=%d, handler=%p)\"\n TraceExit=Trc_SC_RegisterSignal_Exit Overhead=1 Level=1 Template=\"JVM_RegisterSignal -- return old OS handler = %p\"\n TraceException=Trc_SC_RegisterSignal_FailedToRegisterHandler Overhead=1 Level=1 Template=\"Failed to register handler: OS signal value = %d, new signal handler = %p, old signal handler = %p\"\n+\n+TraceEntry=Trc_SC_GetExtendedNPEMessage_Entry Overhead=1 Level=3 Template=\"JVM_GetExtendedNPEMessage for throwableObj(%p)\"\n+TraceEntry=Trc_SC_GetExtendedNPEMessage_Entry2 Overhead=1 Level=1 Template=\"JVM_GetExtendedNPEMessage for throwableObj(%p)\"\n+TraceEvent=Trc_SC_GetExtendedNPEMessage_NULLMETHODPC Overhead=1 Level=1 Template=\"JVM_GetExtendedNPEMessage iterateStackTrace returns a NULL methodPC.\"\n+TraceExit=Trc_SC_GetExtendedNPEMessage_Exit Overhead=1 Level=3 Template=\"JVM_GetExtendedNPEMessage returns msgObjectRef(%p)\"", "originalCommit": "ff1f62896f2d2faef7616a0390c87312acc1d607", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA2MzAxMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r381063010", "bodyText": "Yeah, fixed.", "author": "JasonFengJ9", "createdAt": "2020-02-19T03:45:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg2MjUyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg2MzQ3Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r380863473", "bodyText": "Why are some of these level 3 vs 1?", "author": "DanHeidinga", "createdAt": "2020-02-18T18:45:03Z", "path": "runtime/j9vm/j9scar.tdf", "diffHunk": "@@ -338,3 +338,8 @@ TraceEvent=Trc_SC_LoadSystemLibrary_LoadFailed NoEnv Overhead=1 Level=1 Template\n TraceEntry=Trc_SC_RegisterSignal_Entry Overhead=1 Level=1 Template=\"JVM_RegisterSignal(signal=%d, handler=%p)\"\n TraceExit=Trc_SC_RegisterSignal_Exit Overhead=1 Level=1 Template=\"JVM_RegisterSignal -- return old OS handler = %p\"\n TraceException=Trc_SC_RegisterSignal_FailedToRegisterHandler Overhead=1 Level=1 Template=\"Failed to register handler: OS signal value = %d, new signal handler = %p, old signal handler = %p\"\n+\n+TraceEntry=Trc_SC_GetExtendedNPEMessage_Entry Overhead=1 Level=3 Template=\"JVM_GetExtendedNPEMessage for throwableObj(%p)\"\n+TraceEntry=Trc_SC_GetExtendedNPEMessage_Entry2 Overhead=1 Level=1 Template=\"JVM_GetExtendedNPEMessage for throwableObj(%p)\"", "originalCommit": "ff1f62896f2d2faef7616a0390c87312acc1d607", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA2NDE5Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r381064193", "bodyText": "Trc_SC_GetExtendedNPEMessage_Entry  is invoked for each JVM_GetExtendedNPEMessage(),\nTrc_SC_GetExtendedNPEMessage_Entry2 is invoked only when -XX:+ShowCodeDetailsInExceptionMessages is specified.\nThe thought was that Trc_SC_GetExtendedNPEMessage_Entry is the higher frequency tracepoint than Trc_SC_GetExtendedNPEMessage_Entry2.  The hot tracepoint is assigned with higher level, i.e., 3 while the lower frequency one is 1.", "author": "JasonFengJ9", "createdAt": "2020-02-19T03:51:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg2MzQ3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg2MzY2MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r380863661", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            TraceEvent=Trc_SC_GetExtendedNPEMessage_NULLMETHODPC Overhead=1 Level=1 Template=\"JVM_GetExtendedNPEMessage iterateStackTrace returns a NULL methodPC.\"\n          \n          \n            \n            TraceEvent=Trc_SC_GetExtendedNPEMessage_NullMethodPC Overhead=1 Level=1 Template=\"JVM_GetExtendedNPEMessage iterateStackTrace returns a NULL methodPC.\"", "author": "DanHeidinga", "createdAt": "2020-02-18T18:45:25Z", "path": "runtime/j9vm/j9scar.tdf", "diffHunk": "@@ -338,3 +338,8 @@ TraceEvent=Trc_SC_LoadSystemLibrary_LoadFailed NoEnv Overhead=1 Level=1 Template\n TraceEntry=Trc_SC_RegisterSignal_Entry Overhead=1 Level=1 Template=\"JVM_RegisterSignal(signal=%d, handler=%p)\"\n TraceExit=Trc_SC_RegisterSignal_Exit Overhead=1 Level=1 Template=\"JVM_RegisterSignal -- return old OS handler = %p\"\n TraceException=Trc_SC_RegisterSignal_FailedToRegisterHandler Overhead=1 Level=1 Template=\"Failed to register handler: OS signal value = %d, new signal handler = %p, old signal handler = %p\"\n+\n+TraceEntry=Trc_SC_GetExtendedNPEMessage_Entry Overhead=1 Level=3 Template=\"JVM_GetExtendedNPEMessage for throwableObj(%p)\"\n+TraceEntry=Trc_SC_GetExtendedNPEMessage_Entry2 Overhead=1 Level=1 Template=\"JVM_GetExtendedNPEMessage for throwableObj(%p)\"\n+TraceEvent=Trc_SC_GetExtendedNPEMessage_NULLMETHODPC Overhead=1 Level=1 Template=\"JVM_GetExtendedNPEMessage iterateStackTrace returns a NULL methodPC.\"", "originalCommit": "ff1f62896f2d2faef7616a0390c87312acc1d607", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA2MzExMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r381063112", "bodyText": "Fixed.", "author": "JasonFengJ9", "createdAt": "2020-02-19T03:46:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg2MzY2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg2OTM4NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r380869385", "bodyText": "I don't think these messages should be documented and we wouldn't want to use the message codes in the messages", "author": "DanHeidinga", "createdAt": "2020-02-18T18:56:10Z", "path": "runtime/nls/j9vm/j9vm.nls", "diffHunk": "@@ -1953,3 +1953,94 @@ J9NLS_VM_CLASS_RELATIONSHIP_INVALID.explanation=The specified child class fails\n J9NLS_VM_CLASS_RELATIONSHIP_INVALID.system_action=The JVM will throw a java/lang/VerifyError.\n J9NLS_VM_CLASS_RELATIONSHIP_INVALID.user_response=Ensure that all class relationships are valid.\n # END NON-TRANSLATABLE\n+", "originalCommit": "ff1f62896f2d2faef7616a0390c87312acc1d607", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA2MzIyOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r381063228", "bodyText": "Sure, removed these NLS messages and put them directly in exceptionsupport.c.", "author": "JasonFengJ9", "createdAt": "2020-02-19T03:46:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg2OTM4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg3MDAzNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r380870034", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            iterateStackTrace(J9VMThread * vmThread, j9object_t* exception,  UDATA  (*callback) (J9VMThread * vmThread, void * userData, U_8 *methodPC, J9ConstantPool *constantPool, J9ROMClass * romClass, J9ROMMethod * romMethod, J9UTF8 * fileName, UDATA lineNumber, J9ClassLoader* classLoader), void * userData, UDATA pruneConstructors, U_32 nbrCacheItems);\n          \n          \n            \n            iterateStackTrace(J9VMThread * vmThread, j9object_t* exception,  UDATA  (*callback) (J9VMThread * vmThread, void * userData, U_8 *methodPC, J9ConstantPool *constantPool, J9ROMClass * romClass, J9ROMMethod * romMethod, J9UTF8 * fileName, UDATA lineNumber, J9ClassLoader* classLoader), void * userData, UDATA pruneConstructors, U_32 numCacheItems);", "author": "DanHeidinga", "createdAt": "2020-02-18T18:57:17Z", "path": "runtime/oti/vm_api.h", "diffHunk": "@@ -554,10 +554,11 @@ internalExceptionDescribe(J9VMThread *vmThread);\n * @param lineNumber)\n * @param userData\n * @param pruneConstructors\n+* @param nbrCacheItems\n * @return UDATA\n */\n UDATA\n-iterateStackTrace(J9VMThread * vmThread, j9object_t* exception,  UDATA  (*callback) (J9VMThread * vmThread, void * userData, J9ROMClass * romClass, J9ROMMethod * romMethod, J9UTF8 * fileName, UDATA lineNumber, J9ClassLoader* classLoader), void * userData, UDATA pruneConstructors);\n+iterateStackTrace(J9VMThread * vmThread, j9object_t* exception,  UDATA  (*callback) (J9VMThread * vmThread, void * userData, U_8 *methodPC, J9ConstantPool *constantPool, J9ROMClass * romClass, J9ROMMethod * romMethod, J9UTF8 * fileName, UDATA lineNumber, J9ClassLoader* classLoader), void * userData, UDATA pruneConstructors, U_32 nbrCacheItems);", "originalCommit": "ff1f62896f2d2faef7616a0390c87312acc1d607", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA2NDI3MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r381064270", "bodyText": "Fixed.\n@DanHeidinga please have another look.", "author": "JasonFengJ9", "createdAt": "2020-02-19T03:52:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg3MDAzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU1NDQxMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r381554410", "bodyText": "Just realized that iterateStackTrace() can't depend on the incoming numCacheItems to find the cached constantPool, otherwise there is a possibility that some iterateStackTrace() calls might not correctly iterate the walkback when NPE extended message is enabled with additional J9_STACKWALK_CACHE_CPS.\nAdded a helper method isNPEMsgEnabled() to determine if the constantPool entry presents or not.\nPlease review.", "author": "JasonFengJ9", "createdAt": "2020-02-19T21:27:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg3MDAzNA=="}], "type": "inlineReview"}, {"oid": "d69ddc97e590804134d4d1dd0f8e3b8314536eb2", "url": "https://github.com/eclipse-openj9/openj9/commit/d69ddc97e590804134d4d1dd0f8e3b8314536eb2", "message": "JEP358 extended NPE message part 1 - result of this NPE\n\nModified iterateStackTrace callback_func_t to return methodPC and\nRAM constantPool, also added an additional parameter to indicated the\nnumber of cache items;\nCreated two helper methods walkStackFramesWithSelectedFlags and\nsetWalkbackAfterWalkStackFrames to remove some code duplication;\nSpecified J9_STACKWALK_CACHE_CPS for NPE when JEP358 feature is enabled;\nJVM_GetExtendedNPEMessage is going to construct NPE extended message\non-demand;\nConstructing NPE message according to the bytecode itself for\naload/astore, arraylength, athrow, monitorenter/monitorexit;\nConstructing NPE message according to the bytecode and field index for\ngetfield/putfield;\nConstructing NPE message according to the bytecode and method index for\ninvokeinterface/invokespecial/invokevirtual;\nAdded a runtime flag J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG to\nspecify the command line option\n-XX:{+|-}ShowCodeDetailsInExceptionMessages;\nAdded trace messages.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>", "committedDate": "2020-02-19T03:44:37Z", "type": "forcePushed"}, {"oid": "e35a31786487ee181011127eb86e545061480083", "url": "https://github.com/eclipse-openj9/openj9/commit/e35a31786487ee181011127eb86e545061480083", "message": "JEP358 extended NPE message part 1 - result of this NPE\n\nModified iterateStackTrace callback_func_t to return methodPC and\nRAM constantPool, also added an additional parameter to indicated the\nnumber of cache items;\nCreated two helper methods walkStackFramesWithSelectedFlags and\nsetWalkbackAfterWalkStackFrames to remove some code duplication;\nSpecified J9_STACKWALK_CACHE_CPS for NPE when JEP358 feature is enabled;\nJVM_GetExtendedNPEMessage is going to construct NPE extended message\non-demand;\nConstructing NPE message according to the bytecode itself for\naload/astore, arraylength, athrow, monitorenter/monitorexit;\nConstructing NPE message according to the bytecode and field index for\ngetfield/putfield;\nConstructing NPE message according to the bytecode and method index for\ninvokeinterface/invokespecial/invokevirtual;\nAdded a runtime flag J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG to\nspecify the command line option\n-XX:{+|-}ShowCodeDetailsInExceptionMessages;\nAdded trace messages.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>", "committedDate": "2020-02-19T03:50:46Z", "type": "forcePushed"}, {"oid": "4927cbb6901ec5233188abd6bea51a0d7e680470", "url": "https://github.com/eclipse-openj9/openj9/commit/4927cbb6901ec5233188abd6bea51a0d7e680470", "message": "JEP358 extended NPE message part 1 - result of this NPE\n\nModified iterateStackTrace callback_func_t to return methodPC and\nRAM constantPool;\nCreated two helper methods walkStackFramesWithSelectedFlags and\nsetWalkbackAfterWalkStackFrames to remove some code duplication;\nAdded a helper isNPEMsgEnabled to indicate if JEP358 is enabled for NPE;\nSpecified J9_STACKWALK_CACHE_CPS for NPE when JEP358 feature is enabled;\nJVM_GetExtendedNPEMessage is going to construct NPE extended message\non-demand;\nConstructing NPE message according to the bytecode itself for\naload/astore, arraylength, athrow, monitorenter/monitorexit;\nConstructing NPE message according to the bytecode and field index for\ngetfield/putfield;\nConstructing NPE message according to the bytecode and method index for\ninvokeinterface/invokespecial/invokevirtual;\nAdded a runtime flag J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG to\nspecify the command line option\n-XX:{+|-}ShowCodeDetailsInExceptionMessages;\nAdded trace messages.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>", "committedDate": "2020-02-19T21:20:57Z", "type": "forcePushed"}, {"oid": "f09497bd21932d79192fda0e71e59cba18c858d7", "url": "https://github.com/eclipse-openj9/openj9/commit/f09497bd21932d79192fda0e71e59cba18c858d7", "message": "JEP358 extended NPE message part 1 - result of this NPE\n\nModified iterateStackTrace callback_func_t to return methodPC and\nRAM constantPool;\nCreated two helper methods walkStackFramesWithSelectedFlags and\nsetWalkbackAfterWalkStackFrames to remove some code duplication;\nAdded a helper isNPEMsgEnabled to indicate if JEP358 is enabled for NPE;\nSpecified J9_STACKWALK_CACHE_CPS for NPE when JEP358 feature is enabled;\nJVM_GetExtendedNPEMessage is going to construct NPE extended message\non-demand;\nConstructing NPE message according to the bytecode itself for\naload/astore, arraylength, athrow, monitorenter/monitorexit;\nConstructing NPE message according to the bytecode and field index for\ngetfield/putfield;\nConstructing NPE message according to the bytecode and method index for\ninvokeinterface/invokespecial/invokevirtual;\nAdded a runtime flag J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG to\nspecify the command line option\n-XX:{+|-}ShowCodeDetailsInExceptionMessages;\nAdded trace messages.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>", "committedDate": "2020-02-24T15:22:24Z", "type": "forcePushed"}, {"oid": "a019c474a5188629460c8e02b62afc3acf99c16a", "url": "https://github.com/eclipse-openj9/openj9/commit/a019c474a5188629460c8e02b62afc3acf99c16a", "message": "JEP358 extended NPE message part 1 - result of this NPE\n\nAdded iterateStackTraceHelper to iterate the top stack only, and returns\nmethodPC and RAM constantPool;\nThere is no change to existing iterateStackTrace calls;\nCreated two helper methods walkStackFramesWithSelectedFlags and\nsetWalkbackAfterWalkStackFrames to remove some code duplication;\nAdded a helper isNPEMsgEnabled to indicate if JEP358 is enabled for NPE;\nSpecified J9_STACKWALK_CACHE_CPS for NPE when JEP358 feature is enabled;\nJVM_GetExtendedNPEMessage is going to construct NPE extended message\non-demand;\nConstructing NPE message according to the bytecode itself for\naload/astore, arraylength, athrow, monitorenter/monitorexit;\nConstructing NPE message according to the bytecode and field index for\ngetfield/putfield;\nConstructing NPE message according to the bytecode and method index for\ninvokeinterface/invokespecial/invokevirtual;\nAdded a runtime flag J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG to\nspecify the command line option\n-XX:{+|-}ShowCodeDetailsInExceptionMessages;\nAdded trace messages.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>", "committedDate": "2020-02-29T12:54:44Z", "type": "forcePushed"}, {"oid": "f50558cd2b9737b8f47beacf4616b2c2d0a96a22", "url": "https://github.com/eclipse-openj9/openj9/commit/f50558cd2b9737b8f47beacf4616b2c2d0a96a22", "message": "JEP358 extended NPE message part 1 - result of this NPE\n\nJVM_GetExtendedNPEMessage is updated to invoke vmFuncs\ngetExtendedNPEMessage() which gets first methodPC of the exception\nwalkback object then invoke j9bcv_verifyBytecodes() for message\ngeneration;\nVerifier functions j9bcv_verifyBytecodes() & verifyBytecodes() are\nmodified to take extra parameter and invoke getCompleteNPEMessage() to\ncompute extended NPE messages;\nAdded getCompleteNPEMessage() to compute NPE message according to the\nbytecode itself for aload/astore, arraylength, athrow,\nmonitorenter/monitorexit, the bytecode and field index for\ngetfield/putfield, the bytecode and method index for\ninvokeinterface/invokespecial/invokevirtual;\nAdded a runtime flag J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG to\nspecify the command line option\n-XX:{+|-}ShowCodeDetailsInExceptionMessages;\nAdded NLS and trace messages.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>", "committedDate": "2020-04-27T10:42:54Z", "type": "forcePushed"}, {"oid": "215e4f65894de847eab2cbb9915b599985ba847a", "url": "https://github.com/eclipse-openj9/openj9/commit/215e4f65894de847eab2cbb9915b599985ba847a", "message": "JEP358 extended NPE message part 1 - result of this NPE\n\nJVM_GetExtendedNPEMessage is updated to invoke vmFuncs\ngetExtendedNPEMessage() which gets first methodPC of the exception\nwalkback object then invoke j9bcv_verifyBytecodes() for message\ngeneration;\nVerifier functions j9bcv_verifyBytecodes() & verifyBytecodes() are\nmodified to take extra parameter and invoke getCompleteNPEMessage() to\ncompute extended NPE messages;\nAdded getCompleteNPEMessage() to compute NPE message according to the\nbytecode itself for aload/astore, arraylength, athrow,\nmonitorenter/monitorexit, the bytecode and field index for\ngetfield/putfield, the bytecode and method index for\ninvokeinterface/invokespecial/invokevirtual;\nAdded a runtime flag J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG to\nspecify the command line option\n-XX:{+|-}ShowCodeDetailsInExceptionMessages;\nAdded NLS and trace messages.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>", "committedDate": "2020-04-27T12:56:13Z", "type": "forcePushed"}, {"oid": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29", "url": "https://github.com/eclipse-openj9/openj9/commit/e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29", "message": "JEP358 extended NPE message part 1 - result of this NPE\n\nJVM_GetExtendedNPEMessage is updated to invoke iterateStackTrace() with\ngetStackTraceElementIterator to get the\nromClass/romMethod/bytecodeOffset of first frame of the exception object\nthen invoke j9bcv_verifyBytecodes() for message\ngeneration;\nVerifier functions j9bcv_verifyBytecodes() & verifyBytecodes() are\nmodified to take extra parameter and invoke getCompleteNPEMessage() to\ncompute extended NPE messages;\nAdded getCompleteNPEMessage() to compute NPE message according to the\nbytecode itself for aload/astore, arraylength, athrow,\nmonitorenter/monitorexit, the bytecode and field index for\ngetfield/putfield, the bytecode and method index for\ninvokeinterface/invokespecial/invokevirtual;\nAdded a runtime flag J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG to\nspecify the command line option\n-XX:{+|-}ShowCodeDetailsInExceptionMessages;\nAdded NLS and trace messages.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>", "committedDate": "2020-04-27T21:42:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjI2MTQ5OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r416261499", "bodyText": "Do not use ! on non-booleans - do the compare properly please, or create a boolean local.", "author": "gacholio", "createdAt": "2020-04-28T01:29:26Z", "path": "runtime/bcverify/bcverify.c", "diffHunk": "@@ -2404,15 +2397,20 @@ j9bcv_verifyBytecodes (J9PortLibrary * portLib, J9Class * clazz, J9ROMClass * ro\n \n \tromMethod = (J9ROMMethod *) J9ROMCLASS_ROMMETHODS(romClass);\n \n-\tif (verboseVerification) {\n+\tif (verboseVerification && !isNPEMsg) {", "originalCommit": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjI2MTU3NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r416261574", "bodyText": "Nevermind, I can't read.", "author": "gacholio", "createdAt": "2020-04-28T01:29:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjI2MTQ5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM4MjczMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417382733", "bodyText": "returning -> returned", "author": "gacholio", "createdAt": "2020-04-29T14:57:34Z", "path": "runtime/bcverify/rtverify.c", "diffHunk": "@@ -401,17 +400,187 @@ matchStack(J9BytecodeVerificationData * verifyData, J9BranchTargetStack *liveSta\n \tgoto _finished;\n }\n \n-\n-/* \n-\tWalk the bytecodes linearly and verify that the recorded stack maps match.\n-\n-\treturns BCV_SUCCESS on success\n-\treturns BCV_ERR_INTERNAL_ERROR on verification error\n-\treturns BCV_ERR_INSUFFICIENT_MEMORY on OOM\n+/**\n+* Return an extended NPE message.\n+*\n+* Note: the caller is responsible for freeing the returning string if it is not NULL.", "originalCommit": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3NDU3MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417474570", "bodyText": "fixed.", "author": "JasonFengJ9", "createdAt": "2020-04-29T17:07:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM4MjczMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM4MzI3Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417383276", "bodyText": "The \"part 2\" is confusing, and please don't mention \"another PR\".", "author": "gacholio", "createdAt": "2020-04-29T14:58:13Z", "path": "runtime/bcverify/rtverify.c", "diffHunk": "@@ -401,17 +400,187 @@ matchStack(J9BytecodeVerificationData * verifyData, J9BranchTargetStack *liveSta\n \tgoto _finished;\n }\n \n-\n-/* \n-\tWalk the bytecodes linearly and verify that the recorded stack maps match.\n-\n-\treturns BCV_SUCCESS on success\n-\treturns BCV_ERR_INTERNAL_ERROR on verification error\n-\treturns BCV_ERR_INSUFFICIENT_MEMORY on OOM\n+/**\n+* Return an extended NPE message.\n+*\n+* Note: the caller is responsible for freeing the returning string if it is not NULL.\n+*\n+* @param vmThread The current J9VMThread\n+* @param bcCurrentPtr The pointer to the bytecode being executed and caused the NPE\n+* @param romClass The romClass of the bytecode\n+* @param constantPool The J9RomClass constant pool for the romClass\n+* @param npeCauseMsg The extended NPE message part 2 (to be provided by another PR)", "originalCommit": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3NDY2MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417474661", "bodyText": "fixed.", "author": "JasonFengJ9", "createdAt": "2020-04-29T17:08:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM4MzI3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM4ODA3Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417388072", "bodyText": "Looks like you've lost the comment for verifyBytecodes.", "author": "gacholio", "createdAt": "2020-04-29T15:04:36Z", "path": "runtime/bcverify/rtverify.c", "diffHunk": "@@ -401,17 +400,187 @@ matchStack(J9BytecodeVerificationData * verifyData, J9BranchTargetStack *liveSta\n \tgoto _finished;\n }\n \n-\n-/* \n-\tWalk the bytecodes linearly and verify that the recorded stack maps match.\n-\n-\treturns BCV_SUCCESS on success\n-\treturns BCV_ERR_INTERNAL_ERROR on verification error\n-\treturns BCV_ERR_INSUFFICIENT_MEMORY on OOM", "originalCommit": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM5MjkxMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417392912", "bodyText": "Nevermind, I see it in the header now.", "author": "gacholio", "createdAt": "2020-04-29T15:11:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM4ODA3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM4ODg1OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417388859", "bodyText": "Why >= ? Should this not be == ?", "author": "gacholio", "createdAt": "2020-04-29T15:05:45Z", "path": "runtime/bcverify/rtverify.c", "diffHunk": "@@ -526,6 +714,11 @@ verifyBytecodes (J9BytecodeVerificationData * verifyData)\n \n \t/* walk the bytecodes linearly */\n \twhile (pc < length) {\n+\t\tif (isNPEMsg && pc >= npePC) {", "originalCommit": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ0MTk1OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417441959", "bodyText": "There are cases that the pc might be increased beyond npePC such as the case of JBinvokeinterface2 right before the bytecode at npePC. https://github.com/eclipse/openj9/blob/9edff1b76ed55c0e40efb801dc83bc0a5b7c0a24/runtime/bcverify/rtverify.c#L623 increases current pc by 5 hence more than npePC.", "author": "JasonFengJ9", "createdAt": "2020-04-29T16:18:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM4ODg1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM4OTgwMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417389802", "bodyText": "Blank line please.", "author": "gacholio", "createdAt": "2020-04-29T15:07:02Z", "path": "runtime/j9vm/javanextvmi.c", "diffHunk": "@@ -32,10 +36,87 @@ JVM_InitializeFromArchive(JNIEnv *env, jclass clz)\n #endif /* JAVA_SPEC_VERSION >= 11 */\n \n #if JAVA_SPEC_VERSION >= 14\n+typedef struct GetStackTraceElementUserData {\n+\tJ9ROMClass *romClass;\n+\tJ9ROMMethod *romMethod;\n+\tUDATA bytecodeOffset;\n+} GetStackTraceElementUserData;", "originalCommit": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3NDc4Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417474787", "bodyText": "added.", "author": "JasonFengJ9", "createdAt": "2020-04-29T17:08:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM4OTgwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM4OTg2MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417389860", "bodyText": "Blank line please.", "author": "gacholio", "createdAt": "2020-04-29T15:07:09Z", "path": "runtime/j9vm/javanextvmi.c", "diffHunk": "@@ -32,10 +36,87 @@ JVM_InitializeFromArchive(JNIEnv *env, jclass clz)\n #endif /* JAVA_SPEC_VERSION >= 11 */\n \n #if JAVA_SPEC_VERSION >= 14\n+typedef struct GetStackTraceElementUserData {\n+\tJ9ROMClass *romClass;\n+\tJ9ROMMethod *romMethod;\n+\tUDATA bytecodeOffset;\n+} GetStackTraceElementUserData;\n+static UDATA\n+getStackTraceElementIterator(J9VMThread *vmThread, void *voidUserData, UDATA bytecodeOffset, J9ROMClass *romClass, J9ROMMethod *romMethod, J9UTF8 *fileName, UDATA lineNumber, J9ClassLoader *classLoader)\n+{\n+\tGetStackTraceElementUserData *userData = voidUserData;\n+\n+\t/* We are done, only first stack frame is needed. */\n+\tuserData->romClass = romClass;\n+\tuserData->romMethod = romMethod;\n+\tuserData->bytecodeOffset = bytecodeOffset;\n+\n+\treturn FALSE;\n+}", "originalCommit": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3NDkwOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417474909", "bodyText": "Added.", "author": "JasonFengJ9", "createdAt": "2020-04-29T17:08:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM4OTg2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM5MDgxMQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417390811", "bodyText": "Comment seems misplaced.", "author": "gacholio", "createdAt": "2020-04-29T15:08:31Z", "path": "runtime/j9vm/javanextvmi.c", "diffHunk": "@@ -32,10 +36,87 @@ JVM_InitializeFromArchive(JNIEnv *env, jclass clz)\n #endif /* JAVA_SPEC_VERSION >= 11 */\n \n #if JAVA_SPEC_VERSION >= 14\n+typedef struct GetStackTraceElementUserData {\n+\tJ9ROMClass *romClass;\n+\tJ9ROMMethod *romMethod;\n+\tUDATA bytecodeOffset;\n+} GetStackTraceElementUserData;\n+static UDATA\n+getStackTraceElementIterator(J9VMThread *vmThread, void *voidUserData, UDATA bytecodeOffset, J9ROMClass *romClass, J9ROMMethod *romMethod, J9UTF8 *fileName, UDATA lineNumber, J9ClassLoader *classLoader)\n+{\n+\tGetStackTraceElementUserData *userData = voidUserData;\n+\n+\t/* We are done, only first stack frame is needed. */\n+\tuserData->romClass = romClass;\n+\tuserData->romMethod = romMethod;\n+\tuserData->bytecodeOffset = bytecodeOffset;\n+\n+\treturn FALSE;\n+}\n+static void cfdumpBytecodePrintFunction(void *userData, char *format, ...)\n+{\n+\tPORT_ACCESS_FROM_PORT((J9PortLibrary*)userData);\n+\tva_list args;\n+\tchar outputBuffer[512] = {0};\n+\n+\tva_start(args, format);\n+\tj9str_vprintf(outputBuffer, 512, format, args);\n+\tva_end(args);\n+\tj9tty_printf(PORTLIB, \"%s\", outputBuffer);\n+}\n+\n JNIEXPORT jstring JNICALL\n JVM_GetExtendedNPEMessage(JNIEnv *env, jthrowable throwableObj)\n {\n-\t/* Returning NULL to allow JDK14 compilation, https://github.com/eclipse/openj9/issues/7500 */\n-\treturn NULL;\n+\tJ9VMThread *vmThread = (J9VMThread *)env;\n+\tJ9JavaVM *vm = vmThread->javaVM;\n+\tjobject msgObjectRef = NULL;\n+\t\n+\tTrc_SC_GetExtendedNPEMessage_Entry(vmThread, throwableObj);\n+\tif (J9_ARE_ANY_BITS_SET(vm->extendedRuntimeFlags2, J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG)) {\n+\t\tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+\t\tchar *npeMsg = NULL;\n+\t\tGetStackTraceElementUserData userData = {0}; /* only first frame is needed */", "originalCommit": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3NTUwOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417475508", "bodyText": "Removed. (there is already such a comment in getStackTraceElementIterator)", "author": "JasonFengJ9", "createdAt": "2020-04-29T17:09:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM5MDgxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM5MTc0Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417391746", "bodyText": "This needs to be null-checked.", "author": "gacholio", "createdAt": "2020-04-29T15:09:42Z", "path": "runtime/j9vm/javanextvmi.c", "diffHunk": "@@ -32,10 +36,87 @@ JVM_InitializeFromArchive(JNIEnv *env, jclass clz)\n #endif /* JAVA_SPEC_VERSION >= 11 */\n \n #if JAVA_SPEC_VERSION >= 14\n+typedef struct GetStackTraceElementUserData {\n+\tJ9ROMClass *romClass;\n+\tJ9ROMMethod *romMethod;\n+\tUDATA bytecodeOffset;\n+} GetStackTraceElementUserData;\n+static UDATA\n+getStackTraceElementIterator(J9VMThread *vmThread, void *voidUserData, UDATA bytecodeOffset, J9ROMClass *romClass, J9ROMMethod *romMethod, J9UTF8 *fileName, UDATA lineNumber, J9ClassLoader *classLoader)\n+{\n+\tGetStackTraceElementUserData *userData = voidUserData;\n+\n+\t/* We are done, only first stack frame is needed. */\n+\tuserData->romClass = romClass;\n+\tuserData->romMethod = romMethod;\n+\tuserData->bytecodeOffset = bytecodeOffset;\n+\n+\treturn FALSE;\n+}\n+static void cfdumpBytecodePrintFunction(void *userData, char *format, ...)\n+{\n+\tPORT_ACCESS_FROM_PORT((J9PortLibrary*)userData);\n+\tva_list args;\n+\tchar outputBuffer[512] = {0};\n+\n+\tva_start(args, format);\n+\tj9str_vprintf(outputBuffer, 512, format, args);\n+\tva_end(args);\n+\tj9tty_printf(PORTLIB, \"%s\", outputBuffer);\n+}\n+\n JNIEXPORT jstring JNICALL\n JVM_GetExtendedNPEMessage(JNIEnv *env, jthrowable throwableObj)\n {\n-\t/* Returning NULL to allow JDK14 compilation, https://github.com/eclipse/openj9/issues/7500 */\n-\treturn NULL;\n+\tJ9VMThread *vmThread = (J9VMThread *)env;\n+\tJ9JavaVM *vm = vmThread->javaVM;\n+\tjobject msgObjectRef = NULL;\n+\t\n+\tTrc_SC_GetExtendedNPEMessage_Entry(vmThread, throwableObj);\n+\tif (J9_ARE_ANY_BITS_SET(vm->extendedRuntimeFlags2, J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG)) {\n+\t\tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+\t\tchar *npeMsg = NULL;\n+\t\tGetStackTraceElementUserData userData = {0}; /* only first frame is needed */\n+\t\t\n+\t\tTrc_SC_GetExtendedNPEMessage_Entry2(vmThread, throwableObj);\n+\t\tvmFuncs->internalEnterVMFromJNI(vmThread);\n+\t\tuserData.bytecodeOffset = UDATA_MAX;\n+\t\tvmFuncs->iterateStackTrace(vmThread, (j9object_t*)throwableObj, getStackTraceElementIterator, &userData, FALSE);\n+\t\tif ((NULL != userData.romClass) && (NULL != userData.romMethod) && (UDATA_MAX != userData.bytecodeOffset)) {\n+\t\t\tJ9BytecodeVerificationData *bcvd = vm->bytecodeVerificationData;", "originalCommit": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3NTYzMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417475633", "bodyText": "Fixed.", "author": "JasonFengJ9", "createdAt": "2020-04-29T17:09:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM5MTc0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM5NzIwNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417397204", "bodyText": "This should move a bit further out - if the internal string allocation fails, you should also set this. Suggest moving to after the memory free.", "author": "gacholio", "createdAt": "2020-04-29T15:16:49Z", "path": "runtime/j9vm/javanextvmi.c", "diffHunk": "@@ -32,10 +36,87 @@ JVM_InitializeFromArchive(JNIEnv *env, jclass clz)\n #endif /* JAVA_SPEC_VERSION >= 11 */\n \n #if JAVA_SPEC_VERSION >= 14\n+typedef struct GetStackTraceElementUserData {\n+\tJ9ROMClass *romClass;\n+\tJ9ROMMethod *romMethod;\n+\tUDATA bytecodeOffset;\n+} GetStackTraceElementUserData;\n+static UDATA\n+getStackTraceElementIterator(J9VMThread *vmThread, void *voidUserData, UDATA bytecodeOffset, J9ROMClass *romClass, J9ROMMethod *romMethod, J9UTF8 *fileName, UDATA lineNumber, J9ClassLoader *classLoader)\n+{\n+\tGetStackTraceElementUserData *userData = voidUserData;\n+\n+\t/* We are done, only first stack frame is needed. */\n+\tuserData->romClass = romClass;\n+\tuserData->romMethod = romMethod;\n+\tuserData->bytecodeOffset = bytecodeOffset;\n+\n+\treturn FALSE;\n+}\n+static void cfdumpBytecodePrintFunction(void *userData, char *format, ...)\n+{\n+\tPORT_ACCESS_FROM_PORT((J9PortLibrary*)userData);\n+\tva_list args;\n+\tchar outputBuffer[512] = {0};\n+\n+\tva_start(args, format);\n+\tj9str_vprintf(outputBuffer, 512, format, args);\n+\tva_end(args);\n+\tj9tty_printf(PORTLIB, \"%s\", outputBuffer);\n+}\n+\n JNIEXPORT jstring JNICALL\n JVM_GetExtendedNPEMessage(JNIEnv *env, jthrowable throwableObj)\n {\n-\t/* Returning NULL to allow JDK14 compilation, https://github.com/eclipse/openj9/issues/7500 */\n-\treturn NULL;\n+\tJ9VMThread *vmThread = (J9VMThread *)env;\n+\tJ9JavaVM *vm = vmThread->javaVM;\n+\tjobject msgObjectRef = NULL;\n+\t\n+\tTrc_SC_GetExtendedNPEMessage_Entry(vmThread, throwableObj);\n+\tif (J9_ARE_ANY_BITS_SET(vm->extendedRuntimeFlags2, J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG)) {\n+\t\tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+\t\tchar *npeMsg = NULL;\n+\t\tGetStackTraceElementUserData userData = {0}; /* only first frame is needed */\n+\t\t\n+\t\tTrc_SC_GetExtendedNPEMessage_Entry2(vmThread, throwableObj);\n+\t\tvmFuncs->internalEnterVMFromJNI(vmThread);\n+\t\tuserData.bytecodeOffset = UDATA_MAX;\n+\t\tvmFuncs->iterateStackTrace(vmThread, (j9object_t*)throwableObj, getStackTraceElementIterator, &userData, FALSE);\n+\t\tif ((NULL != userData.romClass) && (NULL != userData.romMethod) && (UDATA_MAX != userData.bytecodeOffset)) {\n+\t\t\tJ9BytecodeVerificationData *bcvd = vm->bytecodeVerificationData;\n+\n+\t\t\tif (TrcEnabled_Trc_SC_GetExtendedNPEMessage_Dump_Bytecode) {\n+\t\t\t\tPORT_ACCESS_FROM_VMC(vmThread);\n+\t\t\t\tU_8 *bytecodes = J9_BYTECODE_START_FROM_ROM_METHOD(userData.romMethod);\n+\t\t\t\tU_32 flags = 0;\n+\n+#ifdef J9VM_ENV_LITTLE_ENDIAN\n+\t\t\t\tflags |= BCT_LittleEndianOutput;\n+#else\n+\t\t\t\tflags |= BCT_BigEndianOutput;\n+#endif\n+\t\t\t\tj9bcutil_dumpBytecodes(PORTLIB, userData.romClass, bytecodes, 0, userData.bytecodeOffset, flags, (void *)cfdumpBytecodePrintFunction, PORTLIB, \"\");\n+\t\t\t}\n+\t\t\tbcvd->vmStruct = vmThread;\n+\t\t\tj9bcv_verifyBytecodes(vm->portLibrary, NULL, userData.romClass, bcvd, userData.romMethod, userData.bytecodeOffset, &npeMsg);\n+\t\t\tif (NULL != npeMsg) {\n+\t\t\t\tPORT_ACCESS_FROM_VMC(vmThread);\n+\t\t\t\tj9object_t msgObject = vm->memoryManagerFunctions->j9gc_createJavaLangString(vmThread, (U_8 *)npeMsg, strlen(npeMsg), 0);\n+\t\t\t\tif (NULL != msgObject) {\n+\t\t\t\t\tmsgObjectRef = vmFuncs->j9jni_createLocalRef(env, msgObject);\n+\t\t\t\t\tif (NULL == msgObjectRef) {", "originalCommit": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3NTgwOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417475809", "bodyText": "Agreed.", "author": "JasonFengJ9", "createdAt": "2020-04-29T17:09:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM5NzIwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM5OTQ1NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417399454", "bodyText": "What is the purpose of this? It's controlled by a tracepoint, which is very odd.\nIf this was just debug, I suggest you remove it as it's going to link in unnecessary code.", "author": "gacholio", "createdAt": "2020-04-29T15:19:48Z", "path": "runtime/j9vm/javanextvmi.c", "diffHunk": "@@ -32,10 +36,87 @@ JVM_InitializeFromArchive(JNIEnv *env, jclass clz)\n #endif /* JAVA_SPEC_VERSION >= 11 */\n \n #if JAVA_SPEC_VERSION >= 14\n+typedef struct GetStackTraceElementUserData {\n+\tJ9ROMClass *romClass;\n+\tJ9ROMMethod *romMethod;\n+\tUDATA bytecodeOffset;\n+} GetStackTraceElementUserData;\n+static UDATA\n+getStackTraceElementIterator(J9VMThread *vmThread, void *voidUserData, UDATA bytecodeOffset, J9ROMClass *romClass, J9ROMMethod *romMethod, J9UTF8 *fileName, UDATA lineNumber, J9ClassLoader *classLoader)\n+{\n+\tGetStackTraceElementUserData *userData = voidUserData;\n+\n+\t/* We are done, only first stack frame is needed. */\n+\tuserData->romClass = romClass;\n+\tuserData->romMethod = romMethod;\n+\tuserData->bytecodeOffset = bytecodeOffset;\n+\n+\treturn FALSE;\n+}\n+static void cfdumpBytecodePrintFunction(void *userData, char *format, ...)", "originalCommit": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ0NDY5Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417444697", "bodyText": "It is used by the trace point to dump the bytecode. Removing it won't compile unless the trace point is removed as well.\nI can decorate the trace point along with this function with a debug define if the extra code is a concern.", "author": "JasonFengJ9", "createdAt": "2020-04-29T16:22:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM5OTQ1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ1MDUwNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417450505", "bodyText": "Please eliminate the tracepoint - this isn't the way to do debug.\nAlso please do wrap this in a debug define (I would just output the stuff always if debug is defined, no need for tracepoint).", "author": "gacholio", "createdAt": "2020-04-29T16:31:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM5OTQ1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3NDM3Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417474373", "bodyText": "Sure, removed the tracepoint and wrapped it with DEBUG_BCV (reuse the one in bcverify.c).", "author": "JasonFengJ9", "createdAt": "2020-04-29T17:07:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM5OTQ1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3MzU1NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417473555", "bodyText": "Please bracket the >=", "author": "gacholio", "createdAt": "2020-04-29T17:06:21Z", "path": "runtime/bcverify/rtverify.c", "diffHunk": "@@ -526,6 +714,11 @@ verifyBytecodes (J9BytecodeVerificationData * verifyData)\n \n \t/* walk the bytecodes linearly */\n \twhile (pc < length) {\n+\t\tif (isNPEMsg && pc >= npePC) {", "originalCommit": "e2728f60f91ad721c7a41ba4d2c88dcd8bb08b29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3NzkwNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417477907", "bodyText": "Added.", "author": "JasonFengJ9", "createdAt": "2020-04-29T17:13:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3MzU1NQ=="}], "type": "inlineReview"}, {"oid": "585a6ae2c445a967f58a4007ffe96e0feccffe4e", "url": "https://github.com/eclipse-openj9/openj9/commit/585a6ae2c445a967f58a4007ffe96e0feccffe4e", "message": "JEP358 extended NPE message part 1 - result of this NPE\n\nJVM_GetExtendedNPEMessage is updated to invoke iterateStackTrace() with\ngetStackTraceElementIterator to get the\nromClass/romMethod/bytecodeOffset of first frame of the exception object\nthen invoke j9bcv_verifyBytecodes() for message\ngeneration;\nVerifier functions j9bcv_verifyBytecodes() & verifyBytecodes() are\nmodified to take extra parameter and invoke getCompleteNPEMessage() to\ncompute extended NPE messages;\nAdded getCompleteNPEMessage() to compute NPE message according to the\nbytecode itself for aload/astore, arraylength, athrow,\nmonitorenter/monitorexit, the bytecode and field index for\ngetfield/putfield, the bytecode and method index for\ninvokeinterface/invokespecial/invokevirtual;\nAdded a runtime flag J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG to\nspecify the command line option\n-XX:{+|-}ShowCodeDetailsInExceptionMessages;\nAdded NLS and trace messages.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>", "committedDate": "2020-04-29T17:05:38Z", "type": "forcePushed"}, {"oid": "c5537048efbeb7c497be079f933a740562f7c454", "url": "https://github.com/eclipse-openj9/openj9/commit/c5537048efbeb7c497be079f933a740562f7c454", "message": "JEP358 extended NPE message part 1 - result of this NPE\n\nJVM_GetExtendedNPEMessage is updated to invoke iterateStackTrace() with\ngetStackTraceElementIterator to get the\nromClass/romMethod/bytecodeOffset of first frame of the exception object\nthen invoke j9bcv_verifyBytecodes() for message\ngeneration;\nVerifier functions j9bcv_verifyBytecodes() & verifyBytecodes() are\nmodified to take extra parameter and invoke getCompleteNPEMessage() to\ncompute extended NPE messages;\nAdded getCompleteNPEMessage() to compute NPE message according to the\nbytecode itself for aload/astore, arraylength, athrow,\nmonitorenter/monitorexit, the bytecode and field index for\ngetfield/putfield, the bytecode and method index for\ninvokeinterface/invokespecial/invokevirtual;\nAdded a runtime flag J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG to\nspecify the command line option\n-XX:{+|-}ShowCodeDetailsInExceptionMessages;\nAdded NLS and trace messages.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>", "committedDate": "2020-04-29T17:12:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzUxMDU1Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417510557", "bodyText": "Please use #if defined rather than #ifdef, and please comment the else and endif directives (for all ifdefs in this file and any others you may have added).", "author": "gacholio", "createdAt": "2020-04-29T18:05:42Z", "path": "runtime/j9vm/javanextvmi.c", "diffHunk": "@@ -32,10 +40,96 @@ JVM_InitializeFromArchive(JNIEnv *env, jclass clz)\n #endif /* JAVA_SPEC_VERSION >= 11 */\n \n #if JAVA_SPEC_VERSION >= 14\n+typedef struct GetStackTraceElementUserData {\n+\tJ9ROMClass *romClass;\n+\tJ9ROMMethod *romMethod;\n+\tUDATA bytecodeOffset;\n+} GetStackTraceElementUserData;\n+\n+static UDATA\n+getStackTraceElementIterator(J9VMThread *vmThread, void *voidUserData, UDATA bytecodeOffset, J9ROMClass *romClass, J9ROMMethod *romMethod, J9UTF8 *fileName, UDATA lineNumber, J9ClassLoader *classLoader)\n+{\n+\tGetStackTraceElementUserData *userData = voidUserData;\n+\n+\t/* We are done, only first stack frame is needed. */\n+\tuserData->romClass = romClass;\n+\tuserData->romMethod = romMethod;\n+\tuserData->bytecodeOffset = bytecodeOffset;\n+\n+\treturn FALSE;\n+}\n+\n+#ifdef DEBUG_BCV\n+static void cfdumpBytecodePrintFunction(void *userData, char *format, ...)\n+{\n+\tPORT_ACCESS_FROM_PORT((J9PortLibrary*)userData);\n+\tva_list args;\n+\tchar outputBuffer[512] = {0};\n+\n+\tva_start(args, format);\n+\tj9str_vprintf(outputBuffer, 512, format, args);\n+\tva_end(args);\n+\tj9tty_printf(PORTLIB, \"%s\", outputBuffer);\n+}\n+#endif\n+\n JNIEXPORT jstring JNICALL\n JVM_GetExtendedNPEMessage(JNIEnv *env, jthrowable throwableObj)\n {\n-\t/* Returning NULL to allow JDK14 compilation, https://github.com/eclipse/openj9/issues/7500 */\n-\treturn NULL;\n+\tJ9VMThread *vmThread = (J9VMThread *)env;\n+\tJ9JavaVM *vm = vmThread->javaVM;\n+\tjobject msgObjectRef = NULL;\n+\t\n+\tTrc_SC_GetExtendedNPEMessage_Entry(vmThread, throwableObj);\n+\tif (J9_ARE_ANY_BITS_SET(vm->extendedRuntimeFlags2, J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG)) {\n+\t\tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+\t\tchar *npeMsg = NULL;\n+\t\tGetStackTraceElementUserData userData = {0};\n+\t\tJ9BytecodeVerificationData *bcvd = vm->bytecodeVerificationData;\n+\t\t\n+\t\tTrc_SC_GetExtendedNPEMessage_Entry2(vmThread, throwableObj);\n+\t\tvmFuncs->internalEnterVMFromJNI(vmThread);\n+\t\tuserData.bytecodeOffset = UDATA_MAX;\n+\t\tvmFuncs->iterateStackTrace(vmThread, (j9object_t*)throwableObj, getStackTraceElementIterator, &userData, FALSE);\n+\t\tif ((NULL != userData.romClass)\n+\t\t\t&& (NULL != userData.romMethod)\n+\t\t\t&& (UDATA_MAX != userData.bytecodeOffset)\n+\t\t\t&& (NULL != bcvd)\n+\t\t) {\n+#ifdef DEBUG_BCV", "originalCommit": "c5537048efbeb7c497be079f933a740562f7c454", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzUyMzYzNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r417523635", "bodyText": "Fixed.", "author": "JasonFengJ9", "createdAt": "2020-04-29T18:28:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzUxMDU1Nw=="}], "type": "inlineReview"}, {"oid": "095c2661048901cde9506ae381c8f0016cc58f1e", "url": "https://github.com/eclipse-openj9/openj9/commit/095c2661048901cde9506ae381c8f0016cc58f1e", "message": "JEP358 extended NPE message part 1 - result of this NPE\n\nJVM_GetExtendedNPEMessage is updated to invoke iterateStackTrace() with\ngetStackTraceElementIterator to get the\nromClass/romMethod/bytecodeOffset of first frame of the exception object\nthen invoke j9bcv_verifyBytecodes() for message\ngeneration;\nVerifier functions j9bcv_verifyBytecodes() & verifyBytecodes() are\nmodified to take extra parameter and invoke getCompleteNPEMessage() to\ncompute extended NPE messages;\nAdded getCompleteNPEMessage() to compute NPE message according to the\nbytecode itself for aload/astore, arraylength, athrow,\nmonitorenter/monitorexit, the bytecode and field index for\ngetfield/putfield, the bytecode and method index for\ninvokeinterface/invokespecial/invokevirtual;\nAdded a runtime flag J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG to\nspecify the command line option\n-XX:{+|-}ShowCodeDetailsInExceptionMessages;\nAdded NLS and trace messages.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>", "committedDate": "2020-04-29T18:27:06Z", "type": "forcePushed"}, {"oid": "3ce5b5a94ae6e15778db31993b1eb9fae4477e6d", "url": "https://github.com/eclipse-openj9/openj9/commit/3ce5b5a94ae6e15778db31993b1eb9fae4477e6d", "message": "JEP358 extended NPE message part 1 - result of this NPE\n\nJVM_GetExtendedNPEMessage is updated to invoke iterateStackTrace() with\ngetStackTraceElementIterator to get the\nromClass/romMethod/bytecodeOffset of first frame of the exception object\nthen invoke j9bcv_verifyBytecodes() for message\ngeneration;\nVerifier functions j9bcv_verifyBytecodes() & verifyBytecodes() are\nmodified to take extra parameter and invoke getCompleteNPEMessage() to\ncompute extended NPE messages;\nAdded getCompleteNPEMessage() to compute NPE message according to the\nbytecode itself for aload/astore, arraylength, athrow,\nmonitorenter/monitorexit, the bytecode and field index for\ngetfield/putfield, the bytecode and method index for\ninvokeinterface/invokespecial/invokevirtual;\nAdded a runtime flag J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG to\nspecify the command line option\n-XX:{+|-}ShowCodeDetailsInExceptionMessages;\nAdded NLS and trace messages.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>", "committedDate": "2020-05-04T22:06:34Z", "type": "forcePushed"}, {"oid": "a01d8f6841134860a831cd60a7a8c72028740871", "url": "https://github.com/eclipse-openj9/openj9/commit/a01d8f6841134860a831cd60a7a8c72028740871", "message": "JEP358 extended NPE message part 1 - result of this NPE\n\nJVM_GetExtendedNPEMessage is updated to invoke iterateStackTrace() with\ngetStackTraceElementIterator to get the\nromClass/romMethod/bytecodeOffset of first frame of the exception object\nthen invoke getCompleteNPEMessage() for message\ngeneration;\nAdded getCompleteNPEMessage() to compute NPE message according to the\nbytecode itself for aload/astore, arraylength, athrow,\nmonitorenter/monitorexit, the bytecode and field index for\ngetfield/putfield, the bytecode and method index for\ninvokeinterface/invokespecial/invokevirtual;\nAdded a runtime flag J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG to\nspecify the command line option\n-XX:{+|-}ShowCodeDetailsInExceptionMessages;\nAdded trace messages.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>", "committedDate": "2020-05-13T10:42:48Z", "type": "forcePushed"}, {"oid": "b7c3b3bd0721e0b9c3e35cda73780d5110ebe335", "url": "https://github.com/eclipse-openj9/openj9/commit/b7c3b3bd0721e0b9c3e35cda73780d5110ebe335", "message": "JEP358 extended NPE message part 1 - result of this NPE\n\nJVM_GetExtendedNPEMessage is updated to invoke iterateStackTrace() with\ngetStackTraceElementIterator to get the\nromClass/romMethod/bytecodeOffset of first frame of the exception object\nthen invoke getCompleteNPEMessage() for message\ngeneration;\nAdded getCompleteNPEMessage() to compute NPE message according to the\nbytecode itself for aload/astore, arraylength, athrow,\nmonitorenter/monitorexit, the bytecode and field index for\ngetfield/putfield, the bytecode and method index for\ninvokeinterface/invokespecial/invokevirtual;\nAdded a runtime flag J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG to\nspecify the command line option\n-XX:{+|-}ShowCodeDetailsInExceptionMessages;\nAdded trace messages.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>", "committedDate": "2020-05-14T02:54:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4NTk2Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r424885962", "bodyText": "I thought we had a macro for unwrapping jobjects but I can't find it now.  @gacholio do you know what I'm looking for?", "author": "DanHeidinga", "createdAt": "2020-05-14T05:53:19Z", "path": "runtime/j9vm/javanextvmi.c", "diffHunk": "@@ -32,10 +40,93 @@ JVM_InitializeFromArchive(JNIEnv *env, jclass clz)\n #endif /* JAVA_SPEC_VERSION >= 11 */\n \n #if JAVA_SPEC_VERSION >= 14\n+typedef struct GetStackTraceElementUserData {\n+\tJ9ROMClass *romClass;\n+\tJ9ROMMethod *romMethod;\n+\tUDATA bytecodeOffset;\n+} GetStackTraceElementUserData;\n+\n+static UDATA\n+getStackTraceElementIterator(J9VMThread *vmThread, void *voidUserData, UDATA bytecodeOffset, J9ROMClass *romClass, J9ROMMethod *romMethod, J9UTF8 *fileName, UDATA lineNumber, J9ClassLoader *classLoader, J9Class* ramClass)\n+{\n+\tGetStackTraceElementUserData *userData = voidUserData;\n+\n+\t/* We are done, only first stack frame is needed. */\n+\tuserData->romClass = romClass;\n+\tuserData->romMethod = romMethod;\n+\tuserData->bytecodeOffset = bytecodeOffset;\n+\n+\treturn FALSE;\n+}\n+\n+#if defined(DEBUG_BCV)\n+static void cfdumpBytecodePrintFunction(void *userData, char *format, ...)\n+{\n+\tPORT_ACCESS_FROM_PORT((J9PortLibrary*)userData);\n+\tva_list args;\n+\tchar outputBuffer[512] = {0};\n+\n+\tva_start(args, format);\n+\tj9str_vprintf(outputBuffer, 512, format, args);\n+\tva_end(args);\n+\tj9tty_printf(PORTLIB, \"%s\", outputBuffer);\n+}\n+#endif /* defined(DEBUG_BCV) */\n+\n JNIEXPORT jstring JNICALL\n JVM_GetExtendedNPEMessage(JNIEnv *env, jthrowable throwableObj)\n {\n-\t/* Returning NULL to allow JDK14 compilation, https://github.com/eclipse/openj9/issues/7500 */\n-\treturn NULL;\n+\tJ9VMThread *vmThread = (J9VMThread *)env;\n+\tJ9JavaVM *vm = vmThread->javaVM;\n+\tjobject msgObjectRef = NULL;\n+\t\n+\tTrc_SC_GetExtendedNPEMessage_Entry(vmThread, throwableObj);\n+\tif (J9_ARE_ANY_BITS_SET(vm->extendedRuntimeFlags2, J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG)) {\n+\t\tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+\t\tchar *npeMsg = NULL;\n+\t\tGetStackTraceElementUserData userData = {0};\n+\t\t\n+\t\tTrc_SC_GetExtendedNPEMessage_Entry2(vmThread, throwableObj);\n+\t\tvmFuncs->internalEnterVMFromJNI(vmThread);\n+\t\tuserData.bytecodeOffset = UDATA_MAX;\n+\t\tvmFuncs->iterateStackTrace(vmThread, (j9object_t*)throwableObj, getStackTraceElementIterator, &userData, FALSE);", "originalCommit": "b7c3b3bd0721e0b9c3e35cda73780d5110ebe335", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA2MjQxOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r425062419", "bodyText": "@DanHeidinga is it #define J9_JNI_UNWRAP_REFERENCE(o)  (*(j9object_t*)(o))? iterateStackTrace() expects j9object_t* exception though.", "author": "JasonFengJ9", "createdAt": "2020-05-14T11:22:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4NTk2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTEwMjEyNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r425102124", "bodyText": "Thanks @DanHeidinga, the PR has been updated, please have another look.", "author": "JasonFengJ9", "createdAt": "2020-05-14T12:37:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4NTk2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4NjkwNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r424886905", "bodyText": "I'd rather keep throwing the NPE without the extra message here.  It's the application error that's the root cause.\nOtherwise, the OOM should have the NPE as its cause", "author": "DanHeidinga", "createdAt": "2020-05-14T05:56:22Z", "path": "runtime/j9vm/javanextvmi.c", "diffHunk": "@@ -32,10 +40,93 @@ JVM_InitializeFromArchive(JNIEnv *env, jclass clz)\n #endif /* JAVA_SPEC_VERSION >= 11 */\n \n #if JAVA_SPEC_VERSION >= 14\n+typedef struct GetStackTraceElementUserData {\n+\tJ9ROMClass *romClass;\n+\tJ9ROMMethod *romMethod;\n+\tUDATA bytecodeOffset;\n+} GetStackTraceElementUserData;\n+\n+static UDATA\n+getStackTraceElementIterator(J9VMThread *vmThread, void *voidUserData, UDATA bytecodeOffset, J9ROMClass *romClass, J9ROMMethod *romMethod, J9UTF8 *fileName, UDATA lineNumber, J9ClassLoader *classLoader, J9Class* ramClass)\n+{\n+\tGetStackTraceElementUserData *userData = voidUserData;\n+\n+\t/* We are done, only first stack frame is needed. */\n+\tuserData->romClass = romClass;\n+\tuserData->romMethod = romMethod;\n+\tuserData->bytecodeOffset = bytecodeOffset;\n+\n+\treturn FALSE;\n+}\n+\n+#if defined(DEBUG_BCV)\n+static void cfdumpBytecodePrintFunction(void *userData, char *format, ...)\n+{\n+\tPORT_ACCESS_FROM_PORT((J9PortLibrary*)userData);\n+\tva_list args;\n+\tchar outputBuffer[512] = {0};\n+\n+\tva_start(args, format);\n+\tj9str_vprintf(outputBuffer, 512, format, args);\n+\tva_end(args);\n+\tj9tty_printf(PORTLIB, \"%s\", outputBuffer);\n+}\n+#endif /* defined(DEBUG_BCV) */\n+\n JNIEXPORT jstring JNICALL\n JVM_GetExtendedNPEMessage(JNIEnv *env, jthrowable throwableObj)\n {\n-\t/* Returning NULL to allow JDK14 compilation, https://github.com/eclipse/openj9/issues/7500 */\n-\treturn NULL;\n+\tJ9VMThread *vmThread = (J9VMThread *)env;\n+\tJ9JavaVM *vm = vmThread->javaVM;\n+\tjobject msgObjectRef = NULL;\n+\t\n+\tTrc_SC_GetExtendedNPEMessage_Entry(vmThread, throwableObj);\n+\tif (J9_ARE_ANY_BITS_SET(vm->extendedRuntimeFlags2, J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG)) {\n+\t\tJ9InternalVMFunctions const * const vmFuncs = vm->internalVMFunctions;\n+\t\tchar *npeMsg = NULL;\n+\t\tGetStackTraceElementUserData userData = {0};\n+\t\t\n+\t\tTrc_SC_GetExtendedNPEMessage_Entry2(vmThread, throwableObj);\n+\t\tvmFuncs->internalEnterVMFromJNI(vmThread);\n+\t\tuserData.bytecodeOffset = UDATA_MAX;\n+\t\tvmFuncs->iterateStackTrace(vmThread, (j9object_t*)throwableObj, getStackTraceElementIterator, &userData, FALSE);\n+\t\tif ((NULL != userData.romClass)\n+\t\t\t&& (NULL != userData.romMethod)\n+\t\t\t&& (UDATA_MAX != userData.bytecodeOffset)\n+\t\t) {\n+#if defined(DEBUG_BCV)\n+\t\t\t{\n+\t\t\t\tPORT_ACCESS_FROM_VMC(vmThread);\n+\t\t\t\tU_8 *bytecodes = J9_BYTECODE_START_FROM_ROM_METHOD(userData.romMethod);\n+\t\t\t\tU_32 flags = 0;\n+\n+#if defined(J9VM_ENV_LITTLE_ENDIAN)\n+\t\t\t\tflags |= BCT_LittleEndianOutput;\n+#else /* defined(J9VM_ENV_LITTLE_ENDIAN) */\n+\t\t\t\tflags |= BCT_BigEndianOutput;\n+#endif /* defined(J9VM_ENV_LITTLE_ENDIAN) */\n+\t\t\t\tj9bcutil_dumpBytecodes(PORTLIB, userData.romClass, bytecodes, 0, userData.bytecodeOffset, flags, (void *)cfdumpBytecodePrintFunction, PORTLIB, \"\");\n+\t\t\t}\n+#endif /* defined(DEBUG_BCV) */\n+\t\t\tnpeMsg = vmFuncs->getCompleteNPEMessage(vmThread, J9_BYTECODE_START_FROM_ROM_METHOD(userData.romMethod) + userData.bytecodeOffset, userData.romClass, npeMsg);\n+\t\t\tif (NULL != npeMsg) {\n+\t\t\t\tPORT_ACCESS_FROM_VMC(vmThread);\n+\t\t\t\tj9object_t msgObject = vm->memoryManagerFunctions->j9gc_createJavaLangString(vmThread, (U_8 *)npeMsg, strlen(npeMsg), 0);\n+\t\t\t\tif (NULL != msgObject) {\n+\t\t\t\t\tmsgObjectRef = vmFuncs->j9jni_createLocalRef(env, msgObject);\n+\t\t\t\t}\n+\t\t\t\tj9mem_free_memory(npeMsg);\n+\t\t\t\tif (NULL == msgObjectRef) {\n+\t\t\t\t\tvmFuncs->setNativeOutOfMemoryError(vmThread, 0, 0);", "originalCommit": "b7c3b3bd0721e0b9c3e35cda73780d5110ebe335", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA2MjYwNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r425062604", "bodyText": "Agreed, throwing the NPE instead and removed OOM.", "author": "JasonFengJ9", "createdAt": "2020-05-14T11:22:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4NjkwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4NzY0OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r424887648", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            {\n          \n          \n            \n            \n          \n          \n            \n            \tchar *npeMsg = NULL;\n          \n          \n            \n            {\n          \n          \n            \n            \tchar *npeMsg = NULL;", "author": "DanHeidinga", "createdAt": "2020-05-14T05:58:49Z", "path": "runtime/vm/ExtendedMessageNPE.cpp", "diffHunk": "@@ -0,0 +1,201 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020, 2020 IBM Corp. and others\n+ *\n+ * This program and the accompanying materials are made available under\n+ * the terms of the Eclipse Public License 2.0 which accompanies this\n+ * distribution and is available at https://www.eclipse.org/legal/epl-2.0/\n+ * or the Apache License, Version 2.0 which accompanies this distribution and\n+ * is available at https://www.apache.org/licenses/LICENSE-2.0.\n+ *\n+ * This Source Code may also be made available under the following\n+ * Secondary Licenses when the conditions for such availability set\n+ * forth in the Eclipse Public License, v. 2.0 are satisfied: GNU\n+ * General Public License, version 2 with the GNU Classpath\n+ * Exception [1] and GNU General Public License, version 2 with the\n+ * OpenJDK Assembly Exception [2].\n+ *\n+ * [1] https://www.gnu.org/software/classpath/license.html\n+ * [2] http://openjdk.java.net/legal/assembly-exception.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-exception-2.0 OR LicenseRef-GPL-2.0 WITH Assembly-exception\n+ *******************************************************************************/\n+\n+#include \"cfreader.h\"\n+#include \"stackwalk.h\"\n+#include \"ut_j9vm.h\"\n+\n+extern \"C\" {\n+\n+char*\n+getCompleteNPEMessage(J9VMThread *vmThread, U_8 *bcCurrentPtr, J9ROMClass *romClass, const char *npeCauseMsg)\n+{\n+\n+\tchar *npeMsg = NULL;", "originalCommit": "b7c3b3bd0721e0b9c3e35cda73780d5110ebe335", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA2MjY5MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r425062690", "bodyText": "Fixed.", "author": "JasonFengJ9", "createdAt": "2020-05-14T11:22:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4NzY0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4ODI0Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r424888246", "bodyText": "I'm not clear why this is using defines rather than the string directly?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            #define VM_NPE_ALOAD \"Cannot load from %s array\"\n          \n          \n            \n            \t\t\tnlsMessage = VM_NPE_ALOAD;\n          \n          \n            \n            #undef VM_NPE_ALOAD\n          \n          \n            \n            \t\t\tnlsMessage = \"Cannot load from %s array\";", "author": "DanHeidinga", "createdAt": "2020-05-14T06:00:38Z", "path": "runtime/vm/ExtendedMessageNPE.cpp", "diffHunk": "@@ -0,0 +1,201 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020, 2020 IBM Corp. and others\n+ *\n+ * This program and the accompanying materials are made available under\n+ * the terms of the Eclipse Public License 2.0 which accompanies this\n+ * distribution and is available at https://www.eclipse.org/legal/epl-2.0/\n+ * or the Apache License, Version 2.0 which accompanies this distribution and\n+ * is available at https://www.apache.org/licenses/LICENSE-2.0.\n+ *\n+ * This Source Code may also be made available under the following\n+ * Secondary Licenses when the conditions for such availability set\n+ * forth in the Eclipse Public License, v. 2.0 are satisfied: GNU\n+ * General Public License, version 2 with the GNU Classpath\n+ * Exception [1] and GNU General Public License, version 2 with the\n+ * OpenJDK Assembly Exception [2].\n+ *\n+ * [1] https://www.gnu.org/software/classpath/license.html\n+ * [2] http://openjdk.java.net/legal/assembly-exception.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-exception-2.0 OR LicenseRef-GPL-2.0 WITH Assembly-exception\n+ *******************************************************************************/\n+\n+#include \"cfreader.h\"\n+#include \"stackwalk.h\"\n+#include \"ut_j9vm.h\"\n+\n+extern \"C\" {\n+\n+char*\n+getCompleteNPEMessage(J9VMThread *vmThread, U_8 *bcCurrentPtr, J9ROMClass *romClass, const char *npeCauseMsg)\n+{\n+\n+\tchar *npeMsg = NULL;\n+\tUDATA msgLen = 0;\n+\tconst char *nlsMessage = NULL;\n+\tU_8 bcCurrent = *bcCurrentPtr;\n+\n+\tPORT_ACCESS_FROM_VMC(vmThread);\n+\tTrc_VM_GetCompleteNPEMessage_Entry(vmThread, bcCurrentPtr, bcCurrent, romClass, npeCauseMsg);\n+\tif (((bcCurrent >= JBiaload) && (bcCurrent <= JBsaload))\n+\t\t|| ((bcCurrent >= JBiastore) && (bcCurrent <= JBsastore))\n+\t) {\n+\t\tconst char *elementType = NULL;\n+\t\tswitch (bcCurrent) {\n+\t\tcase JBiaload: /* FALLTHROUGH */\n+\t\tcase JBiastore:\n+\t\t\telementType = \"int\";\n+\t\t\tbreak;\n+\t\tcase JBlaload: /* FALLTHROUGH */\n+\t\tcase JBlastore:\n+\t\t\telementType = \"long\";\n+\t\t\tbreak;\n+\t\tcase JBfaload: /* FALLTHROUGH */\n+\t\tcase JBfastore:\n+\t\t\telementType = \"float\";\n+\t\t\tbreak;\n+\t\tcase JBdaload: /* FALLTHROUGH */\n+\t\tcase JBdastore:\n+\t\t\telementType = \"double\";\n+\t\t\tbreak;\n+\t\tcase JBaaload: /* FALLTHROUGH */\n+\t\tcase JBaastore:\n+\t\t\telementType = \"object\";\n+\t\t\tbreak;\n+\t\tcase JBbaload: /* FALLTHROUGH */\n+\t\tcase JBbastore:\n+\t\t\telementType = \"byte/boolean\";\n+\t\t\tbreak;\n+\t\tcase JBcaload: /* FALLTHROUGH */\n+\t\tcase JBcastore:\n+\t\t\telementType = \"char\";\n+\t\t\tbreak;\n+\t\tcase JBsaload: /* FALLTHROUGH */\n+\t\tcase JBsastore:\n+\t\t\telementType = \"short\";\n+\t\t\tbreak;\n+\t\tdefault:\n+\t\t\tTrc_VM_GetCompleteNPEMessage_Unreachable(vmThread, bcCurrent);\n+\t\t}\n+\t\tif ((bcCurrent >= JBiaload) && (bcCurrent <= JBsaload)) {\n+#define VM_NPE_ALOAD \"Cannot load from %s array\"\n+\t\t\tnlsMessage = VM_NPE_ALOAD;\n+#undef VM_NPE_ALOAD", "originalCommit": "b7c3b3bd0721e0b9c3e35cda73780d5110ebe335", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA2MjgzNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r425062834", "bodyText": "It was from an earlier commit in which there were multiple references to the string.\nFixed.", "author": "JasonFengJ9", "createdAt": "2020-05-14T11:22:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4ODI0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4ODQxOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r424888419", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            #define VM_NPE_ASTORE \"Cannot store to %s array\"\n          \n          \n            \n            \t\t\tnlsMessage = VM_NPE_ASTORE;\n          \n          \n            \n            #undef VM_NPE_ASTORE\n          \n          \n            \n            \t\t\tnlsMessage = \"Cannot store to %s array\";", "author": "DanHeidinga", "createdAt": "2020-05-14T06:00:59Z", "path": "runtime/vm/ExtendedMessageNPE.cpp", "diffHunk": "@@ -0,0 +1,201 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020, 2020 IBM Corp. and others\n+ *\n+ * This program and the accompanying materials are made available under\n+ * the terms of the Eclipse Public License 2.0 which accompanies this\n+ * distribution and is available at https://www.eclipse.org/legal/epl-2.0/\n+ * or the Apache License, Version 2.0 which accompanies this distribution and\n+ * is available at https://www.apache.org/licenses/LICENSE-2.0.\n+ *\n+ * This Source Code may also be made available under the following\n+ * Secondary Licenses when the conditions for such availability set\n+ * forth in the Eclipse Public License, v. 2.0 are satisfied: GNU\n+ * General Public License, version 2 with the GNU Classpath\n+ * Exception [1] and GNU General Public License, version 2 with the\n+ * OpenJDK Assembly Exception [2].\n+ *\n+ * [1] https://www.gnu.org/software/classpath/license.html\n+ * [2] http://openjdk.java.net/legal/assembly-exception.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-exception-2.0 OR LicenseRef-GPL-2.0 WITH Assembly-exception\n+ *******************************************************************************/\n+\n+#include \"cfreader.h\"\n+#include \"stackwalk.h\"\n+#include \"ut_j9vm.h\"\n+\n+extern \"C\" {\n+\n+char*\n+getCompleteNPEMessage(J9VMThread *vmThread, U_8 *bcCurrentPtr, J9ROMClass *romClass, const char *npeCauseMsg)\n+{\n+\n+\tchar *npeMsg = NULL;\n+\tUDATA msgLen = 0;\n+\tconst char *nlsMessage = NULL;\n+\tU_8 bcCurrent = *bcCurrentPtr;\n+\n+\tPORT_ACCESS_FROM_VMC(vmThread);\n+\tTrc_VM_GetCompleteNPEMessage_Entry(vmThread, bcCurrentPtr, bcCurrent, romClass, npeCauseMsg);\n+\tif (((bcCurrent >= JBiaload) && (bcCurrent <= JBsaload))\n+\t\t|| ((bcCurrent >= JBiastore) && (bcCurrent <= JBsastore))\n+\t) {\n+\t\tconst char *elementType = NULL;\n+\t\tswitch (bcCurrent) {\n+\t\tcase JBiaload: /* FALLTHROUGH */\n+\t\tcase JBiastore:\n+\t\t\telementType = \"int\";\n+\t\t\tbreak;\n+\t\tcase JBlaload: /* FALLTHROUGH */\n+\t\tcase JBlastore:\n+\t\t\telementType = \"long\";\n+\t\t\tbreak;\n+\t\tcase JBfaload: /* FALLTHROUGH */\n+\t\tcase JBfastore:\n+\t\t\telementType = \"float\";\n+\t\t\tbreak;\n+\t\tcase JBdaload: /* FALLTHROUGH */\n+\t\tcase JBdastore:\n+\t\t\telementType = \"double\";\n+\t\t\tbreak;\n+\t\tcase JBaaload: /* FALLTHROUGH */\n+\t\tcase JBaastore:\n+\t\t\telementType = \"object\";\n+\t\t\tbreak;\n+\t\tcase JBbaload: /* FALLTHROUGH */\n+\t\tcase JBbastore:\n+\t\t\telementType = \"byte/boolean\";\n+\t\t\tbreak;\n+\t\tcase JBcaload: /* FALLTHROUGH */\n+\t\tcase JBcastore:\n+\t\t\telementType = \"char\";\n+\t\t\tbreak;\n+\t\tcase JBsaload: /* FALLTHROUGH */\n+\t\tcase JBsastore:\n+\t\t\telementType = \"short\";\n+\t\t\tbreak;\n+\t\tdefault:\n+\t\t\tTrc_VM_GetCompleteNPEMessage_Unreachable(vmThread, bcCurrent);\n+\t\t}\n+\t\tif ((bcCurrent >= JBiaload) && (bcCurrent <= JBsaload)) {\n+#define VM_NPE_ALOAD \"Cannot load from %s array\"\n+\t\t\tnlsMessage = VM_NPE_ALOAD;\n+#undef VM_NPE_ALOAD\n+\t\t} else {\n+#define VM_NPE_ASTORE \"Cannot store to %s array\"\n+\t\t\tnlsMessage = VM_NPE_ASTORE;\n+#undef VM_NPE_ASTORE", "originalCommit": "b7c3b3bd0721e0b9c3e35cda73780d5110ebe335", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA2MjkxNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r425062916", "bodyText": "Fixed.", "author": "JasonFengJ9", "createdAt": "2020-05-14T11:23:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4ODQxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4OTI3Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r424889272", "bodyText": "I'm unclear on why a define is preferable to local variable here.  The local seems to have less \"noise\" when reading the code\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tcase JBarraylength:\n          \n          \n            \n            #define VM_NPE_ARRAYLENGTH \"Cannot read the array length\"\n          \n          \n            \n            \t\t\tmsgLen = j9str_printf(PORTLIB, NULL, 0, VM_NPE_ARRAYLENGTH);\n          \n          \n            \n            \t\t\tnpeMsg = (char *)j9mem_allocate_memory(msgLen + 1, OMRMEM_CATEGORY_VM);\n          \n          \n            \n            \t\t\tj9str_printf(PORTLIB, npeMsg, msgLen, VM_NPE_ARRAYLENGTH);\n          \n          \n            \n            #undef VM_NPE_ARRAYLENGTH\n          \n          \n            \n            \t\tcase JBarraylength:\n          \n          \n            \n            \t\t\tconst char *VM_NPE_ARRAYLENGTH = \"Cannot read the array length\";\n          \n          \n            \n            \t\t\tmsgLen = j9str_printf(PORTLIB, NULL, 0, VM_NPE_ARRAYLENGTH);\n          \n          \n            \n            \t\t\tnpeMsg = (char *)j9mem_allocate_memory(msgLen + 1, OMRMEM_CATEGORY_VM);\n          \n          \n            \n            \t\t\tj9str_printf(PORTLIB, npeMsg, msgLen, VM_NPE_ARRAYLENGTH);", "author": "DanHeidinga", "createdAt": "2020-05-14T06:03:48Z", "path": "runtime/vm/ExtendedMessageNPE.cpp", "diffHunk": "@@ -0,0 +1,201 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020, 2020 IBM Corp. and others\n+ *\n+ * This program and the accompanying materials are made available under\n+ * the terms of the Eclipse Public License 2.0 which accompanies this\n+ * distribution and is available at https://www.eclipse.org/legal/epl-2.0/\n+ * or the Apache License, Version 2.0 which accompanies this distribution and\n+ * is available at https://www.apache.org/licenses/LICENSE-2.0.\n+ *\n+ * This Source Code may also be made available under the following\n+ * Secondary Licenses when the conditions for such availability set\n+ * forth in the Eclipse Public License, v. 2.0 are satisfied: GNU\n+ * General Public License, version 2 with the GNU Classpath\n+ * Exception [1] and GNU General Public License, version 2 with the\n+ * OpenJDK Assembly Exception [2].\n+ *\n+ * [1] https://www.gnu.org/software/classpath/license.html\n+ * [2] http://openjdk.java.net/legal/assembly-exception.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-exception-2.0 OR LicenseRef-GPL-2.0 WITH Assembly-exception\n+ *******************************************************************************/\n+\n+#include \"cfreader.h\"\n+#include \"stackwalk.h\"\n+#include \"ut_j9vm.h\"\n+\n+extern \"C\" {\n+\n+char*\n+getCompleteNPEMessage(J9VMThread *vmThread, U_8 *bcCurrentPtr, J9ROMClass *romClass, const char *npeCauseMsg)\n+{\n+\n+\tchar *npeMsg = NULL;\n+\tUDATA msgLen = 0;\n+\tconst char *nlsMessage = NULL;\n+\tU_8 bcCurrent = *bcCurrentPtr;\n+\n+\tPORT_ACCESS_FROM_VMC(vmThread);\n+\tTrc_VM_GetCompleteNPEMessage_Entry(vmThread, bcCurrentPtr, bcCurrent, romClass, npeCauseMsg);\n+\tif (((bcCurrent >= JBiaload) && (bcCurrent <= JBsaload))\n+\t\t|| ((bcCurrent >= JBiastore) && (bcCurrent <= JBsastore))\n+\t) {\n+\t\tconst char *elementType = NULL;\n+\t\tswitch (bcCurrent) {\n+\t\tcase JBiaload: /* FALLTHROUGH */\n+\t\tcase JBiastore:\n+\t\t\telementType = \"int\";\n+\t\t\tbreak;\n+\t\tcase JBlaload: /* FALLTHROUGH */\n+\t\tcase JBlastore:\n+\t\t\telementType = \"long\";\n+\t\t\tbreak;\n+\t\tcase JBfaload: /* FALLTHROUGH */\n+\t\tcase JBfastore:\n+\t\t\telementType = \"float\";\n+\t\t\tbreak;\n+\t\tcase JBdaload: /* FALLTHROUGH */\n+\t\tcase JBdastore:\n+\t\t\telementType = \"double\";\n+\t\t\tbreak;\n+\t\tcase JBaaload: /* FALLTHROUGH */\n+\t\tcase JBaastore:\n+\t\t\telementType = \"object\";\n+\t\t\tbreak;\n+\t\tcase JBbaload: /* FALLTHROUGH */\n+\t\tcase JBbastore:\n+\t\t\telementType = \"byte/boolean\";\n+\t\t\tbreak;\n+\t\tcase JBcaload: /* FALLTHROUGH */\n+\t\tcase JBcastore:\n+\t\t\telementType = \"char\";\n+\t\t\tbreak;\n+\t\tcase JBsaload: /* FALLTHROUGH */\n+\t\tcase JBsastore:\n+\t\t\telementType = \"short\";\n+\t\t\tbreak;\n+\t\tdefault:\n+\t\t\tTrc_VM_GetCompleteNPEMessage_Unreachable(vmThread, bcCurrent);\n+\t\t}\n+\t\tif ((bcCurrent >= JBiaload) && (bcCurrent <= JBsaload)) {\n+#define VM_NPE_ALOAD \"Cannot load from %s array\"\n+\t\t\tnlsMessage = VM_NPE_ALOAD;\n+#undef VM_NPE_ALOAD\n+\t\t} else {\n+#define VM_NPE_ASTORE \"Cannot store to %s array\"\n+\t\t\tnlsMessage = VM_NPE_ASTORE;\n+#undef VM_NPE_ASTORE\n+\t\t}\n+\t\tmsgLen = j9str_printf(PORTLIB, NULL, 0, nlsMessage, elementType);\n+\t\t/* msg NULL check omitted since str_printf accepts NULL (as above) */\n+\t\tnpeMsg = (char *)j9mem_allocate_memory(msgLen + 1, OMRMEM_CATEGORY_VM);\n+\t\tj9str_printf(PORTLIB, npeMsg, msgLen, nlsMessage, elementType);\n+\t} else {\n+\t\tswitch (bcCurrent) {\n+\t\tcase JBarraylength:\n+#define VM_NPE_ARRAYLENGTH \"Cannot read the array length\"\n+\t\t\tmsgLen = j9str_printf(PORTLIB, NULL, 0, VM_NPE_ARRAYLENGTH);\n+\t\t\tnpeMsg = (char *)j9mem_allocate_memory(msgLen + 1, OMRMEM_CATEGORY_VM);\n+\t\t\tj9str_printf(PORTLIB, npeMsg, msgLen, VM_NPE_ARRAYLENGTH);\n+#undef VM_NPE_ARRAYLENGTH", "originalCommit": "b7c3b3bd0721e0b9c3e35cda73780d5110ebe335", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA2MzU2Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r425063566", "bodyText": "This comes from the thought (and becomes a habit later) in early days that the defines save the memory defining local variables. It is negligible and probably covered by compiler optimization already.\nAgreed, the local reads better.", "author": "JasonFengJ9", "createdAt": "2020-05-14T11:24:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4OTI3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTEwMjE1NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r425102155", "bodyText": "Make the local const and it shouldn't matter", "author": "DanHeidinga", "createdAt": "2020-05-14T12:37:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4OTI3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg5MDQwOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r424890409", "bodyText": "The locals can be declared at first use as this is a cpp file.  Saves initializing them to null and shortens the life time they need to be reasoned about", "author": "DanHeidinga", "createdAt": "2020-05-14T06:07:32Z", "path": "runtime/vm/ExtendedMessageNPE.cpp", "diffHunk": "@@ -0,0 +1,201 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020, 2020 IBM Corp. and others\n+ *\n+ * This program and the accompanying materials are made available under\n+ * the terms of the Eclipse Public License 2.0 which accompanies this\n+ * distribution and is available at https://www.eclipse.org/legal/epl-2.0/\n+ * or the Apache License, Version 2.0 which accompanies this distribution and\n+ * is available at https://www.apache.org/licenses/LICENSE-2.0.\n+ *\n+ * This Source Code may also be made available under the following\n+ * Secondary Licenses when the conditions for such availability set\n+ * forth in the Eclipse Public License, v. 2.0 are satisfied: GNU\n+ * General Public License, version 2 with the GNU Classpath\n+ * Exception [1] and GNU General Public License, version 2 with the\n+ * OpenJDK Assembly Exception [2].\n+ *\n+ * [1] https://www.gnu.org/software/classpath/license.html\n+ * [2] http://openjdk.java.net/legal/assembly-exception.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-exception-2.0 OR LicenseRef-GPL-2.0 WITH Assembly-exception\n+ *******************************************************************************/\n+\n+#include \"cfreader.h\"\n+#include \"stackwalk.h\"\n+#include \"ut_j9vm.h\"\n+\n+extern \"C\" {\n+\n+char*\n+getCompleteNPEMessage(J9VMThread *vmThread, U_8 *bcCurrentPtr, J9ROMClass *romClass, const char *npeCauseMsg)\n+{\n+\n+\tchar *npeMsg = NULL;\n+\tUDATA msgLen = 0;\n+\tconst char *nlsMessage = NULL;\n+\tU_8 bcCurrent = *bcCurrentPtr;\n+\n+\tPORT_ACCESS_FROM_VMC(vmThread);\n+\tTrc_VM_GetCompleteNPEMessage_Entry(vmThread, bcCurrentPtr, bcCurrent, romClass, npeCauseMsg);\n+\tif (((bcCurrent >= JBiaload) && (bcCurrent <= JBsaload))\n+\t\t|| ((bcCurrent >= JBiastore) && (bcCurrent <= JBsastore))\n+\t) {\n+\t\tconst char *elementType = NULL;\n+\t\tswitch (bcCurrent) {\n+\t\tcase JBiaload: /* FALLTHROUGH */\n+\t\tcase JBiastore:\n+\t\t\telementType = \"int\";\n+\t\t\tbreak;\n+\t\tcase JBlaload: /* FALLTHROUGH */\n+\t\tcase JBlastore:\n+\t\t\telementType = \"long\";\n+\t\t\tbreak;\n+\t\tcase JBfaload: /* FALLTHROUGH */\n+\t\tcase JBfastore:\n+\t\t\telementType = \"float\";\n+\t\t\tbreak;\n+\t\tcase JBdaload: /* FALLTHROUGH */\n+\t\tcase JBdastore:\n+\t\t\telementType = \"double\";\n+\t\t\tbreak;\n+\t\tcase JBaaload: /* FALLTHROUGH */\n+\t\tcase JBaastore:\n+\t\t\telementType = \"object\";\n+\t\t\tbreak;\n+\t\tcase JBbaload: /* FALLTHROUGH */\n+\t\tcase JBbastore:\n+\t\t\telementType = \"byte/boolean\";\n+\t\t\tbreak;\n+\t\tcase JBcaload: /* FALLTHROUGH */\n+\t\tcase JBcastore:\n+\t\t\telementType = \"char\";\n+\t\t\tbreak;\n+\t\tcase JBsaload: /* FALLTHROUGH */\n+\t\tcase JBsastore:\n+\t\t\telementType = \"short\";\n+\t\t\tbreak;\n+\t\tdefault:\n+\t\t\tTrc_VM_GetCompleteNPEMessage_Unreachable(vmThread, bcCurrent);\n+\t\t}\n+\t\tif ((bcCurrent >= JBiaload) && (bcCurrent <= JBsaload)) {\n+#define VM_NPE_ALOAD \"Cannot load from %s array\"\n+\t\t\tnlsMessage = VM_NPE_ALOAD;\n+#undef VM_NPE_ALOAD\n+\t\t} else {\n+#define VM_NPE_ASTORE \"Cannot store to %s array\"\n+\t\t\tnlsMessage = VM_NPE_ASTORE;\n+#undef VM_NPE_ASTORE\n+\t\t}\n+\t\tmsgLen = j9str_printf(PORTLIB, NULL, 0, nlsMessage, elementType);\n+\t\t/* msg NULL check omitted since str_printf accepts NULL (as above) */\n+\t\tnpeMsg = (char *)j9mem_allocate_memory(msgLen + 1, OMRMEM_CATEGORY_VM);\n+\t\tj9str_printf(PORTLIB, npeMsg, msgLen, nlsMessage, elementType);\n+\t} else {\n+\t\tswitch (bcCurrent) {\n+\t\tcase JBarraylength:\n+#define VM_NPE_ARRAYLENGTH \"Cannot read the array length\"\n+\t\t\tmsgLen = j9str_printf(PORTLIB, NULL, 0, VM_NPE_ARRAYLENGTH);\n+\t\t\tnpeMsg = (char *)j9mem_allocate_memory(msgLen + 1, OMRMEM_CATEGORY_VM);\n+\t\t\tj9str_printf(PORTLIB, npeMsg, msgLen, VM_NPE_ARRAYLENGTH);\n+#undef VM_NPE_ARRAYLENGTH\n+\t\t\tbreak;\n+\t\tcase JBathrow:\n+#define VM_NPE_ATHROW \"Cannot throw exception\"\n+\t\t\tmsgLen = j9str_printf(PORTLIB, NULL, 0, VM_NPE_ATHROW);\n+\t\t\tnpeMsg = (char *)j9mem_allocate_memory(msgLen + 1, OMRMEM_CATEGORY_VM);\n+\t\t\tj9str_printf(PORTLIB, npeMsg, msgLen, VM_NPE_ATHROW);\n+#undef VM_NPE_ATHROW\n+\t\t\tbreak;\n+\t\tcase JBmonitorenter:\n+#define VM_NPE_MONITORENTER \"Cannot enter synchronized block\"\n+\t\t\tmsgLen = j9str_printf(PORTLIB, NULL, 0, VM_NPE_MONITORENTER);\n+\t\t\tnpeMsg = (char *)j9mem_allocate_memory(msgLen+ 1, OMRMEM_CATEGORY_VM);\n+\t\t\tj9str_printf(PORTLIB, npeMsg, msgLen, VM_NPE_MONITORENTER);\n+#undef VM_NPE_MONITORENTER\n+\t\t\tbreak;\n+\t\tcase JBmonitorexit:\n+#define VM_NPE_MONITOREXIT \"Cannot exit synchronized block\"\n+\t\t\tmsgLen = j9str_printf(PORTLIB, NULL, 0, VM_NPE_MONITOREXIT);\n+\t\t\tnpeMsg = (char *)j9mem_allocate_memory(msgLen + 1, OMRMEM_CATEGORY_VM);\n+\t\t\tj9str_printf(PORTLIB, npeMsg, msgLen, VM_NPE_MONITOREXIT);\n+#undef VM_NPE_MONITOREXIT\n+\t\t\tbreak;\n+\t\tcase JBgetfield: /* FALLTHROUGH */\n+\t\tcase JBputfield:\n+\t\t\t{\n+\t\t\t\tU_16 index = PARAM_16(bcCurrentPtr, 1);\n+\t\t\t\tUDATA cpType = J9_CP_TYPE(J9ROMCLASS_CPSHAPEDESCRIPTION(romClass), index);\n+\n+\t\t\t\tTrc_VM_GetCompleteNPEMessage_Field_Index(vmThread, index);\n+\t\t\t\tif (J9CPTYPE_FIELD == cpType) {\n+\t\t\t\t\tJ9ROMConstantPoolItem *constantPool = J9_ROM_CP_FROM_ROM_CLASS(romClass);\n+\t\t\t\t\tJ9ROMConstantPoolItem *cpItem = constantPool + index;\n+\t\t\t\t\tJ9ROMNameAndSignature *nameAndSig = J9ROMFIELDREF_NAMEANDSIGNATURE((J9ROMFieldRef *) cpItem);\n+\t\t\t\t\tJ9UTF8 *name = J9ROMNAMEANDSIGNATURE_NAME(nameAndSig);\n+\n+\t\t\t\t\tif (JBputfield == bcCurrent) {\n+#define VM_NPE_PUTFIELD \"Cannot assign field \\\"%2$.*1$s\\\"\"\n+\t\t\t\t\t\tnlsMessage = VM_NPE_PUTFIELD;\n+#undef VM_NPE_PUTFIELD\n+\t\t\t\t\t} else {\n+#define VM_NPE_GETFIELD \"Cannot read field \\\"%2$.*1$s\\\"\"\n+\t\t\t\t\t\tnlsMessage = VM_NPE_GETFIELD;\n+#undef VM_NPE_GETFIELD\n+\t\t\t\t\t}\n+\t\t\t\t\tmsgLen = j9str_printf(PORTLIB, NULL, 0, nlsMessage, J9UTF8_LENGTH(name), J9UTF8_DATA(name));\n+\t\t\t\t\tnpeMsg = (char *)j9mem_allocate_memory(msgLen + 1, OMRMEM_CATEGORY_VM);\n+\t\t\t\t\tj9str_printf(PORTLIB, npeMsg, msgLen, nlsMessage, J9UTF8_LENGTH(name), J9UTF8_DATA(name));\n+\t\t\t\t} else {\n+\t\t\t\t\tTrc_VM_GetCompleteNPEMessage_UnexpectedCPType(vmThread, cpType, bcCurrent);\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\tbreak;\n+\t\tcase JBinvokehandle: /* FALLTHROUGH */\n+\t\tcase JBinvokehandlegeneric: /* FALLTHROUGH */\n+\t\tcase JBinvokeinterface2: /* FALLTHROUGH */\n+\t\tcase JBinvokeinterface: /* FALLTHROUGH */\n+\t\tcase JBinvokespecial: /* FALLTHROUGH */\n+\t\tcase JBinvokedynamic: /* FALLTHROUGH */\n+\t\tcase JBinvokevirtual: /* FALLTHROUGH */\n+\t\tcase JBinvokestatic:\n+\t\t\t{\n+\t\t\t\tU_16 index = 0;\n+\t\t\t\tJ9ROMNameAndSignature *nameAndSig = NULL;\n+\t\t\t\tJ9UTF8 *sig = NULL;\n+\t\t\t\tJ9UTF8 *name = NULL;\n+\t\t\t\tJ9UTF8 *definingUTF = NULL;\n+\t\t\t\tJ9ROMMethodRef *romMethodRef = NULL;\n+\t\t\t\tJ9ROMConstantPoolItem *constantPool = J9_ROM_CP_FROM_ROM_CLASS(romClass);\n+\n+\t\t\t\tif (JBinvokeinterface2 == bcCurrent) {\n+\t\t\t\t\tindex = PARAM_16(bcCurrentPtr + 2, 1); /* get JBinvokeinterface instead */\n+\t\t\t\t} else {\n+\t\t\t\t\tindex = PARAM_16(bcCurrentPtr, 1);\n+\t\t\t\t}\n+\t\t\t\tTrc_VM_GetCompleteNPEMessage_Invoke_Index(vmThread, index);\n+\t\t\t\tromMethodRef = (J9ROMMethodRef *)&constantPool[index];\n+\t\t\t\tnameAndSig = J9ROMMETHODREF_NAMEANDSIGNATURE(romMethodRef);\n+\t\t\t\tsig = J9ROMNAMEANDSIGNATURE_SIGNATURE(nameAndSig);\n+\t\t\t\tname = J9ROMNAMEANDSIGNATURE_NAME(nameAndSig);", "originalCommit": "b7c3b3bd0721e0b9c3e35cda73780d5110ebe335", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA2NjA3OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r425066079", "bodyText": "Yeah, should use this advantage, updated.", "author": "JasonFengJ9", "createdAt": "2020-05-14T11:29:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg5MDQwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg5MjQ4MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r424892481", "bodyText": "Can you set methodPC = UDATA_MAX; here or before this if statement so the else clauses aren't needed?", "author": "DanHeidinga", "createdAt": "2020-05-14T06:13:28Z", "path": "runtime/vm/exceptiondescribe.c", "diffHunk": "@@ -319,7 +319,7 @@ iterateStackTrace(J9VMThread * vmThread, j9object_t* exception, callback_func_t\n \t\t\t\t\t}\n \t\t\t\t\tif (inlineDepth == 0) {", "originalCommit": "b7c3b3bd0721e0b9c3e35cda73780d5110ebe335", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA2NTk2MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r425065960", "bodyText": "There are still a few references of methodPC expecting a valid value:\nLine 346\nromClass = findROMClassFromPC(vmThread, methodPC, &classLoader);,\nLine 370\nif ((methodPC >= (UDATA)possibleMethod) && (methodPC < (UDATA)J9_BYTECODE_END_FROM_ROM_METHOD(possibleMethod))) {\nLine 381\nromMethod = findROMMethodInROMClass(vmThread, romClass, methodPC);\nIt doesn't seem there is a good place to set methodPC = UDATA_MAX; beforehand and save later duplicates.", "author": "JasonFengJ9", "createdAt": "2020-05-14T11:29:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg5MjQ4MQ=="}], "type": "inlineReview"}, {"oid": "45c650feaffe8a8b2fce83fcef41a366a031fd19", "url": "https://github.com/eclipse-openj9/openj9/commit/45c650feaffe8a8b2fce83fcef41a366a031fd19", "message": "JEP358 extended NPE message part 1 - result of this NPE\n\nJVM_GetExtendedNPEMessage is updated to invoke iterateStackTrace() with\ngetStackTraceElementIterator to get the\nromClass/romMethod/bytecodeOffset of first frame of the exception object\nthen invoke getCompleteNPEMessage() for message\ngeneration;\nAdded getCompleteNPEMessage() to compute NPE message according to the\nbytecode itself for aload/astore, arraylength, athrow,\nmonitorenter/monitorexit, the bytecode and field index for\ngetfield/putfield, the bytecode and method index for\ninvokeinterface/invokespecial/invokevirtual;\nAdded a runtime flag J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG to\nspecify the command line option\n-XX:{+|-}ShowCodeDetailsInExceptionMessages;\nAdded trace messages.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>", "committedDate": "2020-05-14T11:20:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTEwNTkxNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r425105917", "bodyText": "Can you add the new parameter to the @param list above?", "author": "DanHeidinga", "createdAt": "2020-05-14T12:43:36Z", "path": "runtime/oti/vm_api.h", "diffHunk": "@@ -558,7 +558,7 @@ internalExceptionDescribe(J9VMThread *vmThread);\n * @return UDATA\n */\n UDATA\n-iterateStackTrace(J9VMThread * vmThread, j9object_t* exception,  UDATA  (*callback) (J9VMThread * vmThread, void * userData, J9ROMClass * romClass, J9ROMMethod * romMethod, J9UTF8 * fileName, UDATA lineNumber, J9ClassLoader* classLoader, J9Class* ramClass), void * userData, UDATA pruneConstructors);\n+iterateStackTrace(J9VMThread * vmThread, j9object_t* exception,  UDATA  (*callback) (J9VMThread * vmThread, void * userData, UDATA bytecodeOffset, J9ROMClass * romClass, J9ROMMethod * romMethod, J9UTF8 * fileName, UDATA lineNumber, J9ClassLoader* classLoader, J9Class* ramClass), void * userData, UDATA pruneConstructors);", "originalCommit": "45c650feaffe8a8b2fce83fcef41a366a031fd19", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI1MzM3MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r425253371", "bodyText": "Oops, missed this, will add it.", "author": "JasonFengJ9", "createdAt": "2020-05-14T16:04:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTEwNTkxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI2MzgwOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8495#discussion_r425263809", "bodyText": "Renamed method to romMethod, added bytecodeOffset, romClass, and classLoader.", "author": "JasonFengJ9", "createdAt": "2020-05-14T16:19:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTEwNTkxNw=="}], "type": "inlineReview"}, {"oid": "37ae6fb61064a0075a6e427cd1de94b4289cac9a", "url": "https://github.com/eclipse-openj9/openj9/commit/37ae6fb61064a0075a6e427cd1de94b4289cac9a", "message": "JEP358 extended NPE message part 1 - result of this NPE\n\nJVM_GetExtendedNPEMessage is updated to invoke iterateStackTrace() with\ngetStackTraceElementIterator to get the\nromClass/romMethod/bytecodeOffset of first frame of the exception object\nthen invoke getCompleteNPEMessage() for message\ngeneration;\nAdded getCompleteNPEMessage() to compute NPE message according to the\nbytecode itself for aload/astore, arraylength, athrow,\nmonitorenter/monitorexit, the bytecode and field index for\ngetfield/putfield, the bytecode and method index for\ninvokeinterface/invokespecial/invokevirtual;\nAdded a runtime flag J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG to\nspecify the command line option\n-XX:{+|-}ShowCodeDetailsInExceptionMessages;\nAdded trace messages.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>", "committedDate": "2020-05-14T16:13:09Z", "type": "forcePushed"}, {"oid": "8744afea364f6a4ef136ca814b3a82df670f08d9", "url": "https://github.com/eclipse-openj9/openj9/commit/8744afea364f6a4ef136ca814b3a82df670f08d9", "message": "JEP358 extended NPE message part 1 - result of this NPE\n\nJVM_GetExtendedNPEMessage is updated to invoke iterateStackTrace() with\ngetStackTraceElementIterator to get the\nromClass/romMethod/bytecodeOffset of first frame of the exception object\nthen invoke getCompleteNPEMessage() for message\ngeneration;\nAdded getCompleteNPEMessage() to compute NPE message according to the\nbytecode itself for aload/astore, arraylength, athrow,\nmonitorenter/monitorexit, the bytecode and field index for\ngetfield/putfield, the bytecode and method index for\ninvokeinterface/invokespecial/invokevirtual;\nAdded a runtime flag J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG to\nspecify the command line option\n-XX:{+|-}ShowCodeDetailsInExceptionMessages;\nAdded trace messages.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>", "committedDate": "2020-05-15T01:28:06Z", "type": "commit"}, {"oid": "8744afea364f6a4ef136ca814b3a82df670f08d9", "url": "https://github.com/eclipse-openj9/openj9/commit/8744afea364f6a4ef136ca814b3a82df670f08d9", "message": "JEP358 extended NPE message part 1 - result of this NPE\n\nJVM_GetExtendedNPEMessage is updated to invoke iterateStackTrace() with\ngetStackTraceElementIterator to get the\nromClass/romMethod/bytecodeOffset of first frame of the exception object\nthen invoke getCompleteNPEMessage() for message\ngeneration;\nAdded getCompleteNPEMessage() to compute NPE message according to the\nbytecode itself for aload/astore, arraylength, athrow,\nmonitorenter/monitorexit, the bytecode and field index for\ngetfield/putfield, the bytecode and method index for\ninvokeinterface/invokespecial/invokevirtual;\nAdded a runtime flag J9_EXTENDED_RUNTIME2_SHOW_EXTENDED_NPEMSG to\nspecify the command line option\n-XX:{+|-}ShowCodeDetailsInExceptionMessages;\nAdded trace messages.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>", "committedDate": "2020-05-15T01:28:06Z", "type": "forcePushed"}]}