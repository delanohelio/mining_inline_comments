{"pr_number": 10006, "pr_title": "Fix Class Chain Validation Caching", "pr_createdAt": "2020-06-24T18:58:30Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10006", "timeline": [{"oid": "3003823b70d28805375dfc412d72b8d13c28714c", "url": "https://github.com/eclipse-openj9/openj9/commit/3003823b70d28805375dfc412d72b8d13c28714c", "message": "Add automatic conversion\n\nAdd automatic conversion operator to TR::PersistentAllocator in order to\nallow it to be used with STL Containers.\n\nSigned-off-by: Irwin D'Souza <dsouzai.gh@gmail.com>", "committedDate": "2020-06-24T19:02:22Z", "type": "commit"}, {"oid": "819f3f1c9fe1ceeb77412d7d1acd365f35611808", "url": "https://github.com/eclipse-openj9/openj9/commit/819f3f1c9fe1ceeb77412d7d1acd365f35611808", "message": "Add ability to collect subclasses\n\nExisting code can only vist and collect subclasses during a compilation\nbecause the structures require a TR_Memory. This commit provides the\nability to colect subclasses using STL Containers as well as Persistent\nMemory.\n\nSigned-off-by: Irwin D'Souza <dsouzai.gh@gmail.com>", "committedDate": "2020-06-24T19:02:41Z", "type": "commit"}, {"oid": "cf5065d17d6880cd4bd988d23d91ca6490008e07", "url": "https://github.com/eclipse-openj9/openj9/commit/cf5065d17d6880cd4bd988d23d91ca6490008e07", "message": "Reset cached CCV Result on class redefinition\n\nSigned-off-by: Irwin D'Souza <dsouzai.gh@gmail.com>", "committedDate": "2020-06-24T19:03:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc3NTc3Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10006#discussion_r447775772", "bodyText": "Why is the test on allowRecompilation needed? Since the test is on the global options object we could do one test during bootstrap and disable CCV completely if it depends on recompilation being enabled.", "author": "mpirvu", "createdAt": "2020-06-30T15:30:13Z", "path": "runtime/compiler/env/J9SharedCache.cpp", "diffHunk": "@@ -100,47 +100,33 @@ TR_YesNoMaybe TR_J9SharedCache::isSharedCacheDisabledBecauseFull(TR::Compilation\n    return _sharedCacheDisabledBecauseFull;\n    }\n \n-bool\n-TR_J9SharedCache::initCCVCaching()\n+CCVResult\n+TR_J9SharedCache::getCachedCCVResult(TR_J9VMBase *fej9, TR::CompilationInfo *compInfo, TR_OpaqueClassBlock *clazz)\n    {\n-   if (!_classChainValidationMutex)\n+   if (TR::Options::getCmdLineOptions()->allowRecompilation()", "originalCommit": "cf5065d17d6880cd4bd988d23d91ca6490008e07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAzNDQ4MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10006#discussion_r449034480", "bodyText": "I did add the test in bootstrap here\nhttps://github.com/eclipse/openj9/blob/cf5065d17d6880cd4bd988d23d91ca6490008e07/runtime/compiler/control/DLLMain.cpp#L438-L444\nbut I suppose this was an additional test just in case it's possible for recomp to get disabled at runtime.", "author": "dsouzai", "createdAt": "2020-07-02T14:16:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc3NTc3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc3ODk3MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10006#discussion_r447778970", "bodyText": "Is there something to be gained from making these methods static?\nfej9 and compInfo are cached inside the J9SharedCache object so you could avoid passing these parameters.", "author": "mpirvu", "createdAt": "2020-06-30T15:34:45Z", "path": "runtime/compiler/env/J9SharedCache.hpp", "diffHunk": "@@ -256,18 +243,26 @@ class TR_J9SharedCache : public TR_SharedCache\n \n    /**\n     * @brief Gets the cached result of a prior class chain validation\n-    * @param classOffsetInCache Offset into the SCC of the class to be validated\n-    * @return The CCVResult stored in the map; CCVResult::notYetValidated if result does not exist.\n+    *\n+    * @param fej9 TR_J9VMBase object\n+    * @param compInfo TR::CompilationInfo object\n+    * @param clazz The class to be validated\n+    *\n+    * @return The cached CCVResult; CCVResult::notYetValidated if result does not exist.\n     */\n-   static CCVResult getCachedCCVResult(uintptr_t classOffsetInCache);\n+   static CCVResult getCachedCCVResult(TR_J9VMBase *fej9, TR::CompilationInfo *compInfo, TR_OpaqueClassBlock *clazz);\n \n    /**\n     * @brief Caches the result of a class chain validation\n-    * @param classOffsetInCache Offset into the SCC of the class to be validated\n+    *\n+    * @param fej9 TR_J9VMBase object\n+    * @param compInfo TR::CompilationInfo object\n+    * @param clazz The class to be validated\n     * @param result The result represented as a CCVResult\n-    * @return The result of the insertion.\n+    *\n+    * @return The result of the insertion\n     */\n-   static bool cacheCCVResult(uintptr_t classOffsetInCache, CCVResult result);\n+   static bool cacheCCVResult(TR_J9VMBase *fej9, TR::CompilationInfo *compInfo, TR_OpaqueClassBlock *clazz, CCVResult result);", "originalCommit": "cf5065d17d6880cd4bd988d23d91ca6490008e07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA0MTgzMQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10006#discussion_r449041831", "bodyText": "I don't think so; I'll make them regular methods.", "author": "dsouzai", "createdAt": "2020-07-02T14:26:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc3ODk3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc4MDk2OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10006#discussion_r447780969", "bodyText": "Is classInfo guaranteed to exist here?", "author": "mpirvu", "createdAt": "2020-06-30T15:37:31Z", "path": "runtime/compiler/env/J9SharedCache.cpp", "diffHunk": "@@ -100,47 +100,33 @@ TR_YesNoMaybe TR_J9SharedCache::isSharedCacheDisabledBecauseFull(TR::Compilation\n    return _sharedCacheDisabledBecauseFull;\n    }\n \n-bool\n-TR_J9SharedCache::initCCVCaching()\n+CCVResult\n+TR_J9SharedCache::getCachedCCVResult(TR_J9VMBase *fej9, TR::CompilationInfo *compInfo, TR_OpaqueClassBlock *clazz)\n    {\n-   if (!_classChainValidationMutex)\n+   if (TR::Options::getCmdLineOptions()->allowRecompilation()\n+       && !TR::Options::getCmdLineOptions()->getOption(TR_DisableCHOpts))\n       {\n-      if (!(_classChainValidationMutex = TR::Monitor::create(\"JIT-ClassChainValidationMutex\")))\n-         return false;\n+      TR::ClassTableCriticalSection cacheResult(fej9);\n+      TR_PersistentCHTable *table = compInfo->getPersistentInfo()->getPersistentCHTable();\n+      TR_PersistentClassInfo *classInfo = table->findClassInfo(clazz);", "originalCommit": "cf5065d17d6880cd4bd988d23d91ca6490008e07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAzNjEwMQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10006#discussion_r449036101", "bodyText": "I think so; in the PersistentCHTable code, I see a similar pattern, where if the CH Table is enabled, the classInfo must exist.", "author": "dsouzai", "createdAt": "2020-07-02T14:19:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc4MDk2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc4MTE2NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10006#discussion_r447781165", "bodyText": "Is classInfo guaranteed to exist here?", "author": "mpirvu", "createdAt": "2020-06-30T15:37:48Z", "path": "runtime/compiler/env/J9SharedCache.cpp", "diffHunk": "@@ -100,47 +100,33 @@ TR_YesNoMaybe TR_J9SharedCache::isSharedCacheDisabledBecauseFull(TR::Compilation\n    return _sharedCacheDisabledBecauseFull;\n    }\n \n-bool\n-TR_J9SharedCache::initCCVCaching()\n+CCVResult\n+TR_J9SharedCache::getCachedCCVResult(TR_J9VMBase *fej9, TR::CompilationInfo *compInfo, TR_OpaqueClassBlock *clazz)\n    {\n-   if (!_classChainValidationMutex)\n+   if (TR::Options::getCmdLineOptions()->allowRecompilation()\n+       && !TR::Options::getCmdLineOptions()->getOption(TR_DisableCHOpts))\n       {\n-      if (!(_classChainValidationMutex = TR::Monitor::create(\"JIT-ClassChainValidationMutex\")))\n-         return false;\n+      TR::ClassTableCriticalSection cacheResult(fej9);\n+      TR_PersistentCHTable *table = compInfo->getPersistentInfo()->getPersistentCHTable();\n+      TR_PersistentClassInfo *classInfo = table->findClassInfo(clazz);\n+      return classInfo->getCCVResult();\n       }\n-\n-   if (!_ccvMap)\n-      {\n-      void *storage = jitPersistentAlloc(sizeof(CCVMap));\n-      if (!storage)\n-         return false;\n-\n-      _ccvMap = new (storage) CCVMap(CCVComparator(), getPersistentAllocator());\n-      }\n-\n-   return true;\n-   }\n-\n-TR_J9SharedCache::CCVResult\n-TR_J9SharedCache::getCachedCCVResult(uintptr_t classOffsetInCache)\n-   {\n-   OMR::CriticalSection getCachedResult(_classChainValidationMutex);\n-\n-   auto iter = _ccvMap->find(classOffsetInCache);\n-   if (iter == _ccvMap->end())\n-      return CCVResult::notYetValidated;\n-   else\n-      return iter->second;\n+   return CCVResult::notYetValidated;\n    }\n \n bool\n-TR_J9SharedCache::cacheCCVResult(uintptr_t classOffsetInCache, CCVResult result)\n+TR_J9SharedCache::cacheCCVResult(TR_J9VMBase *fej9, TR::CompilationInfo *compInfo, TR_OpaqueClassBlock *clazz, CCVResult result)\n    {\n-   OMR::CriticalSection cacheResult(_classChainValidationMutex);\n-\n-   auto res = _ccvMap->insert(std::make_pair(classOffsetInCache, result));\n-\n-   return res.second;\n+   if (TR::Options::getCmdLineOptions()->allowRecompilation()\n+       && !TR::Options::getCmdLineOptions()->getOption(TR_DisableCHOpts))\n+      {\n+      TR::ClassTableCriticalSection cacheResult(fej9);\n+      TR_PersistentCHTable *table = compInfo->getPersistentInfo()->getPersistentCHTable();\n+      TR_PersistentClassInfo *classInfo = table->findClassInfo(clazz);\n+      classInfo->setCCVResult(result);", "originalCommit": "cf5065d17d6880cd4bd988d23d91ca6490008e07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAzNjI4OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10006#discussion_r449036288", "bodyText": "Same comment as above.", "author": "dsouzai", "createdAt": "2020-07-02T14:19:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc4MTE2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgyNjQzNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10006#discussion_r447826437", "bodyText": "This is going to increase the size of each entry in the CHTable. We should encode it on 8-bits.\nAlso, maybe a add an inline comment for this field. CCV is not very descriptive.", "author": "mpirvu", "createdAt": "2020-06-30T16:39:50Z", "path": "runtime/compiler/runtime/RuntimeAssumptions.hpp", "diffHunk": "@@ -180,6 +193,7 @@ class TR_PersistentClassInfo : public TR_Link0<TR_PersistentClassInfo>\n    int32_t                             _nameLength;\n    flags8_t                            _flags;\n    flags8_t                            _shouldNotBeNewlyExtended; // one bit for each possible compilation thread\n+   CCVResult                           _ccvResult;", "originalCommit": "cf5065d17d6880cd4bd988d23d91ca6490008e07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAzODAyNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10006#discussion_r449038024", "bodyText": "I think because the enum only has 3 values, it does get allocated only 8 bits by the compiler; however, I can make it explicitly 8 bits.", "author": "dsouzai", "createdAt": "2020-07-02T14:21:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgyNjQzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgyNjU5Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/10006#discussion_r447826596", "bodyText": "This could me marked as const", "author": "mpirvu", "createdAt": "2020-06-30T16:40:05Z", "path": "runtime/compiler/runtime/RuntimeAssumptions.hpp", "diffHunk": "@@ -147,6 +157,9 @@ class TR_PersistentClassInfo : public TR_Link0<TR_PersistentClassInfo>\n    int32_t getNameLength()                       { return _nameLength; }\n    virtual void setNameLength(int32_t length)            { _nameLength = length; }\n \n+   void setCCVResult(CCVResult result) { _ccvResult = result; }\n+   CCVResult getCCVResult() { return _ccvResult; }", "originalCommit": "cf5065d17d6880cd4bd988d23d91ca6490008e07", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgyOTE0Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/10006#discussion_r447829146", "bodyText": "Could we use scratch memory instead of persistent for this temporary?", "author": "mpirvu", "createdAt": "2020-06-30T16:43:53Z", "path": "runtime/compiler/env/PersistentCHTable.cpp", "diffHunk": "@@ -713,3 +713,45 @@ TR_PersistentCHTable::classGotLoaded(\n       }\n    return clazz;\n    }\n+\n+void\n+TR_PersistentCHTable::collectAllSubClasses(TR_PersistentClassInfo *clazz, ClassList &classList, TR_J9VMBase *fej9, bool locked)\n+   {\n+   TR::ClassTableCriticalSection collectSubClasses(fej9, locked);\n+\n+   VisitTracker<> marked(TR::Compiler->persistentAllocator());\n+\n+   collectAllSubClassesLocked(clazz, classList, marked);\n+   }\n+\n+void\n+TR_PersistentCHTable::collectAllSubClassesLocked(TR_PersistentClassInfo *clazz, ClassList &classList, VisitTracker<> &marked)\n+   {\n+   for (auto subClass = clazz->getFirstSubclass(); subClass; subClass = subClass->getNext())\n+      {\n+      if (!subClass->getClassInfo()->hasBeenVisited())\n+         {\n+         TR_PersistentClassInfo *sc = subClass->getClassInfo();\n+         classList.push_front(sc);\n+         marked.visit(sc);\n+         collectAllSubClassesLocked(sc, classList, marked);\n+         }\n+      }\n+   }\n+\n+void\n+TR_PersistentCHTable::resetCachedCCVResult(TR_J9VMBase *fej9, TR_OpaqueClassBlock *clazz)\n+   {\n+   TR::ClassTableCriticalSection collectSubClasses(fej9);\n+\n+   ClassList classList(TR::Compiler->persistentAllocator());", "originalCommit": "cf5065d17d6880cd4bd988d23d91ca6490008e07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAzNzAxNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10006#discussion_r449037015", "bodyText": "No, because this method runs outside of a compilation; it only runs when HCR causes the JIT hook jitClassesRedefined to get invoked.", "author": "dsouzai", "createdAt": "2020-07-02T14:20:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgyOTE0Ng=="}], "type": "inlineReview"}, {"oid": "34fe2f57f167d0a9fcc07b033f966145d26bf6eb", "url": "https://github.com/eclipse-openj9/openj9/commit/34fe2f57f167d0a9fcc07b033f966145d26bf6eb", "message": "Reset cached CCV Result on class redefinition\n\nSigned-off-by: Irwin D'Souza <dsouzai.gh@gmail.com>", "committedDate": "2020-07-02T18:21:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk1NzE3Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10006#discussion_r450957177", "bodyText": "Does something like this work on all platforms: enum CCVResults : uint8_t\nThis would eliminate the need for casting.", "author": "mpirvu", "createdAt": "2020-07-07T15:34:36Z", "path": "runtime/compiler/runtime/RuntimeAssumptions.hpp", "diffHunk": "@@ -45,6 +45,16 @@ class TR_PreXRecompile;\n class TR_RedefinedClassPicSite;\n class TR_UnloadedClassPicSite;\n \n+/**\n+ * @brief Enum to describe the result of a Class Chain Validation (CCV).\n+ */\n+enum CCVResult", "originalCommit": "34fe2f57f167d0a9fcc07b033f966145d26bf6eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA3Mjk5OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10006#discussion_r451072998", "bodyText": "I tried it out; it didn't work. The compiler will accept the syntax, but it will complain about invalid conversion without the casts.", "author": "dsouzai", "createdAt": "2020-07-07T18:49:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk1NzE3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA4ODk3OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10006#discussion_r451088979", "bodyText": "I am curious, on which platform it didn't work? We use this for JITServer code compiled with gcc", "author": "mpirvu", "createdAt": "2020-07-07T19:20:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk1NzE3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTExODk0OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10006#discussion_r451118949", "bodyText": "diff --git a/runtime/compiler/runtime/RuntimeAssumptions.hpp b/runtime/compiler/runtime/RuntimeAssumptions.hpp\nindex 293b1333fd..176b02d3c4 100644\n--- a/runtime/compiler/runtime/RuntimeAssumptions.hpp\n+++ b/runtime/compiler/runtime/RuntimeAssumptions.hpp\n@@ -48,7 +48,7 @@ class TR_UnloadedClassPicSite;\n /**\n  * @brief Enum to describe the result of a Class Chain Validation (CCV).\n  */\n-enum CCVResult\n+enum CCVResult : uint8_t\n    {\n    notYetValidated,\n    success,\n@@ -160,8 +160,8 @@ class TR_PersistentClassInfo : public TR_Link0<TR_PersistentClassInfo>\n    int32_t getNameLength()                       { return _nameLength; }\n    virtual void setNameLength(int32_t length)            { _nameLength = length; }\n \n-   void setCCVResult(CCVResult result) { _ccvResult = static_cast<uint8_t>(result); }\n-   CCVResult getCCVResult() const { return static_cast<CCVResult>(_ccvResult); }\n+   void setCCVResult(CCVResult result) { _ccvResult = result; }\n+   CCVResult getCCVResult() const { return _ccvResult; }\n \n    private:\n\nIn file included from /root/jit/compiler/env/J9SharedCache.hpp:34:0,\n                 from /root/jit/compiler/env/VMJ9.h:45,\n                 from /root/jit/compiler/compile/AOTClassInfo.hpp:29,\n                 from /root/jit/compiler/compile/J9Compilation.hpp:43,\n                 from /root/jit/compiler/compile/Compilation.hpp:26,\n                 from /root/jit/omr/compiler/codegen/OMRCodeGenerator.hpp:45,\n                 from /root/jit/omr/compiler/x/codegen/OMRCodeGenerator.hpp:34,\n                 from /root/jit/omr/compiler/x/amd64/codegen/OMRCodeGenerator.hpp:36,\n                 from /root/jit/compiler/codegen/J9CodeGenerator.hpp:36,\n                 from /root/jit/compiler/x/codegen/J9CodeGenerator.hpp:26,\n                 from /root/jit/compiler/x/amd64/codegen/J9CodeGenerator.hpp:41,\n                 from /root/jit/compiler/codegen/CodeGenGC.cpp:32:\n/root/jit/compiler/runtime/RuntimeAssumptions.hpp: In member function 'CCVResult TR_PersistentClassInfo::getCCVResult() const':\n/root/jit/compiler/runtime/RuntimeAssumptions.hpp:164:44: error: invalid conversion from 'uint8_t {aka unsigned char}' to 'CCVResult' [-fpermissive]\n    CCVResult getCCVResult() const { return _ccvResult; }\n                                            ^~~~~~~~~~\n\nroot@ba22b76deb8d:~/jit# gcc --version\ngcc (GCC) 7.3.0\nCopyright (C) 2017 Free Software Foundation, Inc.\nThis is free software; see the source for copying conditions.  There is NO\nwarranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.", "author": "dsouzai", "createdAt": "2020-07-07T20:18:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk1NzE3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTEzMjIzMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10006#discussion_r451132232", "bodyText": "What is the declaration of _ccvResult above? The compiler complains that about a conversion from uint8_t to CCVResult, but we should already have:\nCCVResult _ccvResult;", "author": "mpirvu", "createdAt": "2020-07-07T20:44:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk1NzE3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTEzNjM5Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/10006#discussion_r451136396", "bodyText": "oh, _ccvResult is a uint8_t. I guess that's why there's a problem?", "author": "dsouzai", "createdAt": "2020-07-07T20:53:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk1NzE3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTEzNzE0NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10006#discussion_r451137145", "bodyText": "yeah looks like changing _ccvResult to CCVResult fixes the build issue.", "author": "dsouzai", "createdAt": "2020-07-07T20:54:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk1NzE3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTEzNzMyNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10006#discussion_r451137326", "bodyText": "I will have to try on other platforms though before making the change here.", "author": "dsouzai", "createdAt": "2020-07-07T20:54:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk1NzE3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTYxMjExOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10006#discussion_r451612119", "bodyText": "Changes made.", "author": "dsouzai", "createdAt": "2020-07-08T14:59:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk1NzE3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk1OTgxOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10006#discussion_r450959818", "bodyText": "const should stay after the name of the function to indicate that the function does not change the object it operates on.", "author": "mpirvu", "createdAt": "2020-07-07T15:38:38Z", "path": "runtime/compiler/runtime/RuntimeAssumptions.hpp", "diffHunk": "@@ -147,6 +160,9 @@ class TR_PersistentClassInfo : public TR_Link0<TR_PersistentClassInfo>\n    int32_t getNameLength()                       { return _nameLength; }\n    virtual void setNameLength(int32_t length)            { _nameLength = length; }\n \n+   void setCCVResult(CCVResult result) { _ccvResult = static_cast<uint8_t>(result); }\n+   const CCVResult getCCVResult() { return static_cast<CCVResult>(_ccvResult); }", "originalCommit": "34fe2f57f167d0a9fcc07b033f966145d26bf6eb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f49710a67b42d774938a9bf98b709baa56021bca", "url": "https://github.com/eclipse-openj9/openj9/commit/f49710a67b42d774938a9bf98b709baa56021bca", "message": "Reset cached CCV Result on class redefinition\n\nSigned-off-by: Irwin D'Souza <dsouzai.gh@gmail.com>", "committedDate": "2020-07-07T18:57:31Z", "type": "forcePushed"}, {"oid": "423cb8bfdc22b358b5392f8994919272aed0c5b8", "url": "https://github.com/eclipse-openj9/openj9/commit/423cb8bfdc22b358b5392f8994919272aed0c5b8", "message": "Use Persistent CH Table for CCV Caching\n\nPrior to this commit, if Class Chain Validation Caching was enabled, the\nresult was cached using the offset of the ROM Class of the RAM Class to\nbe validated. However, this is not functionally correct. It is possible\nfor two J9Classes to have completely different class hierarchies and yet\nhave the same ROM Class; that is, even though two J9Classes have the\nsame J9ROMClass, one or more of their super classes may not have the\nsame J9ROMClass as the other. Thus, the class chains of these two\nclasses would be completely different. If the result of the class chain\nvalidation is cached using the J9ROMClass, the validation may\nincorrectly succeed.\n\nAdditionally, if a class gets redefined for any reason, the cached CCV\nresult for it AND all of its subclasses must be reset.\n\nFor these two reasons, the CCV Result is cached in the Persistent CH\nTable. This allows the result to be keyed against the J9Class, and also\nprovides the means to reset the cached value should the hierarchy\nchange. The consequence of doing so, however, is that CCV Caching is now\ndependant on the CHTable not being disabled.\n\nSigned-off-by: Irwin D'Souza <dsouzai.gh@gmail.com>", "committedDate": "2020-07-08T14:57:47Z", "type": "commit"}, {"oid": "d6e29552433971ce2c026b069beb3ed4d8a708f6", "url": "https://github.com/eclipse-openj9/openj9/commit/d6e29552433971ce2c026b069beb3ed4d8a708f6", "message": "Disable CCV Sharing if CHTable is not used\n\nSigned-off-by: Irwin D'Souza <dsouzai.gh@gmail.com>", "committedDate": "2020-07-08T14:57:51Z", "type": "commit"}, {"oid": "18f5bbd7a6437506eae233fe2edf82647a60b945", "url": "https://github.com/eclipse-openj9/openj9/commit/18f5bbd7a6437506eae233fe2edf82647a60b945", "message": "Reset cached CCV Result on class redefinition\n\nSigned-off-by: Irwin D'Souza <dsouzai.gh@gmail.com>", "committedDate": "2020-07-08T14:57:51Z", "type": "commit"}, {"oid": "18f5bbd7a6437506eae233fe2edf82647a60b945", "url": "https://github.com/eclipse-openj9/openj9/commit/18f5bbd7a6437506eae233fe2edf82647a60b945", "message": "Reset cached CCV Result on class redefinition\n\nSigned-off-by: Irwin D'Souza <dsouzai.gh@gmail.com>", "committedDate": "2020-07-08T14:57:51Z", "type": "forcePushed"}]}