{"pr_number": 11189, "pr_title": "Purge JITServer caches sooner when memory is low", "pr_createdAt": "2020-11-16T12:39:09Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/11189", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ4Njk5Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/11189#discussion_r524486996", "bodyText": "Please add a leading underscore to this variable", "author": "mpirvu", "createdAt": "2020-11-16T18:34:19Z", "path": "runtime/compiler/runtime/JITClientSession.hpp", "diffHunk": "@@ -526,9 +526,11 @@ class ClientSessionHT\n    PersistentUnorderedMap<uint64_t, ClientSessionData*> _clientSessionMap;\n \n    uint64_t _timeOfLastPurge;\n+   TR::CompilationInfo *compInfo;", "originalCommit": "8757fa378a9d13ee2d5bc3460caa68e1aaed2813", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ4NzY3NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11189#discussion_r524487675", "bodyText": "Let's group OLD_AGE and OLD_AGE_UNDER_LOW_MEMORY", "author": "mpirvu", "createdAt": "2020-11-16T18:35:30Z", "path": "runtime/compiler/runtime/JITClientSession.cpp", "diffHunk": "@@ -680,8 +680,10 @@ ClientSessionHT::allocate()\n    }\n \n ClientSessionHT::ClientSessionHT() : _clientSessionMap(decltype(_clientSessionMap)::allocator_type(TR::Compiler->persistentAllocator())),\n-                                     TIME_BETWEEN_PURGES(1000*60*30), // JITServer TODO: this must come from options\n-                                     OLD_AGE(1000*60*1000) // 1000 minutes\n+                                     TIME_BETWEEN_PURGES(1000*60*1), // JITServer TODO: this must come from options\n+                                     OLD_AGE(1000*60*1000), // 1000 minutes\n+                                     compInfo(TR::CompilationController::getCompilationInfo()),", "originalCommit": "8757fa378a9d13ee2d5bc3460caa68e1aaed2813", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ4OTc5OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11189#discussion_r524489799", "bodyText": "This code should be moved under the following if statement (where lowMemory is used) so that we don't execute it for nothing.", "author": "mpirvu", "createdAt": "2020-11-16T18:39:03Z", "path": "runtime/compiler/runtime/JITClientSession.cpp", "diffHunk": "@@ -786,20 +788,44 @@ ClientSessionHT::purgeOldDataIfNeeded()\n    {\n    PORT_ACCESS_FROM_PORT(TR::Compiler->portLib);\n    int64_t crtTime = j9time_current_time_millis();\n+   bool incomplete;\n+   bool lowMemory = false;\n+   uint64_t freePhysicalMemory = compInfo->computeAndCacheFreePhysicalMemory(incomplete, 20); //check if memory is free\n+   if (freePhysicalMemory != OMRPORT_MEMINFO_NOT_AVAILABLE && !incomplete)\n+      {\n+      if (freePhysicalMemory < TR::Options::getSafeReservePhysicalMemoryValue())\n+         {\n+         lowMemory = true;\n+         }\n+      }", "originalCommit": "8757fa378a9d13ee2d5bc3460caa68e1aaed2813", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ5MTYxMQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11189#discussion_r524491611", "bodyText": "To avoid duplicating the code you have a variable oldAge that receives either OLD_AGE or OLD_AGE_UNDER_LOW_MEMORY depending on the situation.", "author": "mpirvu", "createdAt": "2020-11-16T18:41:45Z", "path": "runtime/compiler/runtime/JITClientSession.cpp", "diffHunk": "@@ -786,20 +788,44 @@ ClientSessionHT::purgeOldDataIfNeeded()\n    {\n    PORT_ACCESS_FROM_PORT(TR::Compiler->portLib);\n    int64_t crtTime = j9time_current_time_millis();\n+   bool incomplete;\n+   bool lowMemory = false;\n+   uint64_t freePhysicalMemory = compInfo->computeAndCacheFreePhysicalMemory(incomplete, 20); //check if memory is free\n+   if (freePhysicalMemory != OMRPORT_MEMINFO_NOT_AVAILABLE && !incomplete)\n+      {\n+      if (freePhysicalMemory < TR::Options::getSafeReservePhysicalMemoryValue())\n+         {\n+         lowMemory = true;\n+         }\n+      }\n    if (crtTime - _timeOfLastPurge > TIME_BETWEEN_PURGES)\n       {\n       // Time for a purge operation.\n       // Scan the entire table and delete old elements that are not in use\n       for (auto iter = _clientSessionMap.begin(); iter != _clientSessionMap.end(); ++iter)\n          {\n          TR_ASSERT(iter->second->getInUse() >= 0, \"_inUse=%d must be positive\\n\", iter->second->getInUse());\n-         if (iter->second->getInUse() == 0 &&\n-             crtTime - iter->second->getTimeOflastAccess() > OLD_AGE)\n+         if(!lowMemory)", "originalCommit": "8757fa378a9d13ee2d5bc3460caa68e1aaed2813", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "44d94252cb3fdd3801b5e7b12e889c33ddb1c005", "url": "https://github.com/eclipse-openj9/openj9/commit/44d94252cb3fdd3801b5e7b12e889c33ddb1c005", "message": "WIP: Added OLD_AGE_UNDER_LOW_MEMORY to purge caches sooner\n\nAdded variable OLD_AGE_UNDER_LOW_MEMORY to purge the Client cache at the server sooner\nwhen memory is low. If a client didn't issue a request in more than 5 mins and memory is low, its\ncache will be purged from the server. I also added option oldAge for OLD_AGE and TimeBetweenPurges\nfor TIME_BETWEEN_PURGES. They can be specified using -xjit option.\nissue: #11161\n\nSigned-off-by: Eman Elsabban <eman.elsaban1@gmail.com>", "committedDate": "2020-11-16T21:07:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDc3NzQ4Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/11189#discussion_r524777486", "bodyText": "Since this is used only for JITServer we need to protect these lines with ifdef", "author": "mpirvu", "createdAt": "2020-11-16T23:57:40Z", "path": "runtime/compiler/control/J9Options.cpp", "diffHunk": "@@ -122,6 +122,8 @@ int32_t J9::Options::_bigAppSampleThresholdAdjust = 3; //amount to shift the hot\n int32_t J9::Options::_availableCPUPercentage = 100;\n int32_t J9::Options::_cpuCompTimeExpensiveThreshold = 4000;\n uintptr_t J9::Options::_compThreadAffinityMask = 0;\n+int64_t J9::Options::_oldAge = 1000*60*1000; // 1000 minutes", "originalCommit": "44d94252cb3fdd3801b5e7b12e889c33ddb1c005", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDc4MDIxNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/11189#discussion_r524780217", "bodyText": "oldAge is not used hen memory is low. We need to options here one that corresponds to OLD_AGE and another one that corresponds to OLD_AGE_UNDER_LOW_MEMORY", "author": "mpirvu", "createdAt": "2020-11-17T00:00:27Z", "path": "runtime/compiler/control/J9Options.cpp", "diffHunk": "@@ -903,6 +905,8 @@ TR::OptionTable OMR::Options::_feOptions[] = {\n         TR::Options::setStaticNumeric, (intptr_t)&TR::Options::_numDLTBufferMatchesToEagerlyIssueCompReq, 0, \"F%d\", NOT_IN_SUBSET},\n    {\"numInterpCompReqToExitIdleMode=\", \"M<nnn>\\tNumber of first time comp. req. that takes the JIT out of idle mode\",\n         TR::Options::setStaticNumeric, (intptr_t)&TR::Options::_numFirstTimeCompilationsToExitIdleMode, 0, \"F%d\", NOT_IN_SUBSET },\n+   {\"oldAge=\", \" \\tDefines what an old entry means when memory is low\", ", "originalCommit": "44d94252cb3fdd3801b5e7b12e889c33ddb1c005", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDc4MTYxMQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11189#discussion_r524781611", "bodyText": "Let's put OLD_AGE and OLD_AGE_UNDER_LOW_MEMORY one after another because they are related", "author": "mpirvu", "createdAt": "2020-11-17T00:01:54Z", "path": "runtime/compiler/runtime/JITClientSession.cpp", "diffHunk": "@@ -680,8 +680,10 @@ ClientSessionHT::allocate()\n    }\n \n ClientSessionHT::ClientSessionHT() : _clientSessionMap(decltype(_clientSessionMap)::allocator_type(TR::Compiler->persistentAllocator())),\n-                                     TIME_BETWEEN_PURGES(1000*60*30), // JITServer TODO: this must come from options\n-                                     OLD_AGE(1000*60*1000) // 1000 minutes\n+                                     TIME_BETWEEN_PURGES(TR::Options::_timeBetweenPurges), // JITServer TODO: this must come from options\n+                                     OLD_AGE(TR::Options::_oldAge), // 1000 minutes", "originalCommit": "44d94252cb3fdd3801b5e7b12e889c33ddb1c005", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDc4MzkwNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/11189#discussion_r524783907", "bodyText": "The value for OLD_AGE_UNDER_LOW_MEMORY should also come from a JIT option.", "author": "mpirvu", "createdAt": "2020-11-17T00:04:12Z", "path": "runtime/compiler/runtime/JITClientSession.cpp", "diffHunk": "@@ -680,8 +680,10 @@ ClientSessionHT::allocate()\n    }\n \n ClientSessionHT::ClientSessionHT() : _clientSessionMap(decltype(_clientSessionMap)::allocator_type(TR::Compiler->persistentAllocator())),\n-                                     TIME_BETWEEN_PURGES(1000*60*30), // JITServer TODO: this must come from options\n-                                     OLD_AGE(1000*60*1000) // 1000 minutes\n+                                     TIME_BETWEEN_PURGES(TR::Options::_timeBetweenPurges), // JITServer TODO: this must come from options\n+                                     OLD_AGE(TR::Options::_oldAge), // 1000 minutes\n+                                     _compInfo(TR::CompilationController::getCompilationInfo()),\n+                                     OLD_AGE_UNDER_LOW_MEMORY(1000*60*5) // 5 minutes", "originalCommit": "44d94252cb3fdd3801b5e7b12e889c33ddb1c005", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDgxNTQzMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/11189#discussion_r524815430", "bodyText": "We can omit the last parameter of this call to use the default value of 500 ms.", "author": "mpirvu", "createdAt": "2020-11-17T00:58:08Z", "path": "runtime/compiler/runtime/JITClientSession.cpp", "diffHunk": "@@ -786,15 +788,26 @@ ClientSessionHT::purgeOldDataIfNeeded()\n    {\n    PORT_ACCESS_FROM_PORT(TR::Compiler->portLib);\n    int64_t crtTime = j9time_current_time_millis();\n+   bool incomplete;\n+   int64_t oldAge = OLD_AGE;\n+\n    if (crtTime - _timeOfLastPurge > TIME_BETWEEN_PURGES)\n       {\n+      uint64_t freePhysicalMemory = _compInfo->computeAndCacheFreePhysicalMemory(incomplete, 20); //check if memory is free", "originalCommit": "44d94252cb3fdd3801b5e7b12e889c33ddb1c005", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDgxNjAyMQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11189#discussion_r524816021", "bodyText": "Maybe change the message here to also show how old the data was", "author": "mpirvu", "createdAt": "2020-11-17T00:59:47Z", "path": "runtime/compiler/runtime/JITClientSession.cpp", "diffHunk": "@@ -786,15 +788,26 @@ ClientSessionHT::purgeOldDataIfNeeded()\n    {\n    PORT_ACCESS_FROM_PORT(TR::Compiler->portLib);\n    int64_t crtTime = j9time_current_time_millis();\n+   bool incomplete;\n+   int64_t oldAge = OLD_AGE;\n+\n    if (crtTime - _timeOfLastPurge > TIME_BETWEEN_PURGES)\n       {\n+      uint64_t freePhysicalMemory = _compInfo->computeAndCacheFreePhysicalMemory(incomplete, 20); //check if memory is free\n+      if (freePhysicalMemory != OMRPORT_MEMINFO_NOT_AVAILABLE && !incomplete)\n+         {\n+         if (freePhysicalMemory < TR::Options::getSafeReservePhysicalMemoryValue())\n+            {\n+            oldAge = OLD_AGE_UNDER_LOW_MEMORY; //memory is low\n+            }\n+         }\n       // Time for a purge operation.\n       // Scan the entire table and delete old elements that are not in use\n       for (auto iter = _clientSessionMap.begin(); iter != _clientSessionMap.end(); ++iter)\n          {\n          TR_ASSERT(iter->second->getInUse() >= 0, \"_inUse=%d must be positive\\n\", iter->second->getInUse());\n          if (iter->second->getInUse() == 0 &&\n-             crtTime - iter->second->getTimeOflastAccess() > OLD_AGE)\n+            crtTime - iter->second->getTimeOflastAccess() > oldAge)\n             {\n             if (TR::Options::getVerboseOption(TR_VerboseJITServer))\n                TR_VerboseLog::writeLineLocked(TR_Vlog_JITServer, \"Server will purge session data for clientUID %llu\", (unsigned long long)iter->first);", "originalCommit": "44d94252cb3fdd3801b5e7b12e889c33ddb1c005", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5af333d558c8505db23df8d83106988653095b67", "url": "https://github.com/eclipse-openj9/openj9/commit/5af333d558c8505db23df8d83106988653095b67", "message": "WIP: Added OLD_AGE_UNDER_LOW_MEMORY to purge caches sooner\n\nAdded variable OLD_AGE_UNDER_LOW_MEMORY to purge the Client cache at the server sooner\nwhen memory is low. If a client didn't issue a request in more than 5 mins and memory is low, its\ncache will be purged from the server. I also added option oldAge for OLD_AGE and TimeBetweenPurges\nfor TIME_BETWEEN_PURGES. They can be specified using -xjit option.\nissue: #11161\n\nSigned-off-by: Eman Elsabban <eman.elsaban1@gmail.com>", "committedDate": "2020-11-17T15:49:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ0OTg0NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/11189#discussion_r525449844", "bodyText": "#if defined(J9VM_OPT_JITSERVER) needed here as well", "author": "mpirvu", "createdAt": "2020-11-17T19:47:24Z", "path": "runtime/compiler/control/J9Options.hpp", "diffHunk": "@@ -257,6 +257,9 @@ class OMR_EXTENSIBLE Options : public OMR::OptionsConnector\n    static int32_t _TLHPrefetchBoundaryLineCount;\n    static int32_t _TLHPrefetchTLHEndLineCount;\n    static int32_t _numFirstTimeCompilationsToExitIdleMode; // use large number to disable the feature\n+   static int64_t _oldAge;", "originalCommit": "5af333d558c8505db23df8d83106988653095b67", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ1MDg2MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11189#discussion_r525450861", "bodyText": "Please remove the TODO comment", "author": "mpirvu", "createdAt": "2020-11-17T19:48:15Z", "path": "runtime/compiler/runtime/JITClientSession.cpp", "diffHunk": "@@ -680,8 +680,10 @@ ClientSessionHT::allocate()\n    }\n \n ClientSessionHT::ClientSessionHT() : _clientSessionMap(decltype(_clientSessionMap)::allocator_type(TR::Compiler->persistentAllocator())),\n-                                     TIME_BETWEEN_PURGES(1000*60*30), // JITServer TODO: this must come from options\n-                                     OLD_AGE(1000*60*1000) // 1000 minutes\n+                                     TIME_BETWEEN_PURGES(TR::Options::_timeBetweenPurges), // JITServer TODO: this must come from options", "originalCommit": "5af333d558c8505db23df8d83106988653095b67", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTUxNDE2Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/11189#discussion_r525514162", "bodyText": "I think we need to provide a bit of context for someone that reads the help for this option:\n\"Defines what an old JITServer cache entry means\"\nSimilarly below.", "author": "mpirvu", "createdAt": "2020-11-17T20:47:29Z", "path": "runtime/compiler/control/J9Options.cpp", "diffHunk": "@@ -903,6 +908,12 @@ TR::OptionTable OMR::Options::_feOptions[] = {\n         TR::Options::setStaticNumeric, (intptr_t)&TR::Options::_numDLTBufferMatchesToEagerlyIssueCompReq, 0, \"F%d\", NOT_IN_SUBSET},\n    {\"numInterpCompReqToExitIdleMode=\", \"M<nnn>\\tNumber of first time comp. req. that takes the JIT out of idle mode\",\n         TR::Options::setStaticNumeric, (intptr_t)&TR::Options::_numFirstTimeCompilationsToExitIdleMode, 0, \"F%d\", NOT_IN_SUBSET },\n+#if defined(J9VM_OPT_JITSERVER)\n+   {\"oldAge=\", \" \\tDefines what an old entry means\", ", "originalCommit": "5af333d558c8505db23df8d83106988653095b67", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "390f344044b6db3869433992844bba4f44e06176", "url": "https://github.com/eclipse-openj9/openj9/commit/390f344044b6db3869433992844bba4f44e06176", "message": "WIP: Added OLD_AGE_UNDER_LOW_MEMORY to purge caches sooner\n\nAdded variable OLD_AGE_UNDER_LOW_MEMORY to purge the Client cache at the server sooner\nwhen memory is low. If a client didn't issue a request in more than 5 mins and memory is low, its\ncache will be purged from the server. I also added option oldAge for OLD_AGE and TimeBetweenPurges\nfor TIME_BETWEEN_PURGES. They can be specified using -xjit option.\nissue: #11161\n\nSigned-off-by: Eman Elsabban <eman.elsaban1@gmail.com>", "committedDate": "2020-11-17T21:17:16Z", "type": "commit"}, {"oid": "390f344044b6db3869433992844bba4f44e06176", "url": "https://github.com/eclipse-openj9/openj9/commit/390f344044b6db3869433992844bba4f44e06176", "message": "WIP: Added OLD_AGE_UNDER_LOW_MEMORY to purge caches sooner\n\nAdded variable OLD_AGE_UNDER_LOW_MEMORY to purge the Client cache at the server sooner\nwhen memory is low. If a client didn't issue a request in more than 5 mins and memory is low, its\ncache will be purged from the server. I also added option oldAge for OLD_AGE and TimeBetweenPurges\nfor TIME_BETWEEN_PURGES. They can be specified using -xjit option.\nissue: #11161\n\nSigned-off-by: Eman Elsabban <eman.elsaban1@gmail.com>", "committedDate": "2020-11-17T21:17:16Z", "type": "forcePushed"}]}