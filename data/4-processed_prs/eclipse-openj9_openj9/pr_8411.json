{"pr_number": 8411, "pr_title": "Fix jniGetPrimitiveArrayCritical in the case of empty arraylets", "pr_createdAt": "2020-01-24T23:33:31Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/8411", "timeline": [{"oid": "dfd60d5e2bf1c3ccf7f4955fad0cb3f45d0194b1", "url": "https://github.com/eclipse-openj9/openj9/commit/dfd60d5e2bf1c3ccf7f4955fad0cb3f45d0194b1", "message": "Fix jniGetPrimitiveArrayCritical in the case of empty arraylets\n\nEmpty arraylets are treated as discontiguous arraylets. But since\nthey are empty there's no need to copy them in the critical section,\nhowever, jniGetPrimitiveArrayCritical callers expects not NULL\nvalues; therefore, in case of empty arraylets we advance the\npointer ahead of the header and return that address.\n\nThis fixes: https://github.com/eclipse/openj9/issues/8386\n\nSigned-off-by: Igor Braga <higorb1@gmail.com>", "committedDate": "2020-01-24T23:34:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg4MTAzNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8411#discussion_r371881034", "bodyText": "I think it should be &indexableObjectModel->getArrayoidPointer(arrayObject) instead of just arrayObject.\nWe go one (the only, empty) arroyid slot past the beginning of the arroyoid, to get to the end of the object.", "author": "amicic", "createdAt": "2020-01-28T15:40:48Z", "path": "runtime/gc_vlhgc/VLHGCAccessBarrier.cpp", "diffHunk": "@@ -314,7 +314,10 @@ MM_VLHGCAccessBarrier::jniGetPrimitiveArrayCritical(J9VMThread* vmThread, jarray\n \t\t\t\tGC_SlotObject objectSlot(env->getOmrVM(), &indexableObjectModel->getArrayoidPointer(arrayObject)[0]);\n \t\t\t\tdata = objectSlot.readReferenceFromSlot();\n \t\t\t} else {\n-\t\t\t\t/* Possible to reach here if arraylet leaf has one leaf and no elements in it */\n+\t\t\t\t/* Possible to reach here if arraylet leaf has one leaf and no elements in it.\n+\t\t\t\t * Even though there are no elements in it the caller expects a non NULL value\n+\t\t\t\t * therefore we just return the address after the object header. */\n+\t\t\t\tdata = (void *)GC_SlotObject::addToSlotAddress((fomrobject_t*)arrayObject, 1, env->compressObjectReferences());", "originalCommit": "dfd60d5e2bf1c3ccf7f4955fad0cb3f45d0194b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg4NDE4NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8411#discussion_r371884185", "bodyText": "You can store arroyid pointer (or ObjectSlot based on it) into a local at the beginning of 'if double mapping' block, since it's being referenced a few times.", "author": "amicic", "createdAt": "2020-01-28T15:45:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg4MTAzNA=="}], "type": "inlineReview"}, {"oid": "613be1e32b4d4d883808ffcafa97a8bebfc2aec8", "url": "https://github.com/eclipse-openj9/openj9/commit/613be1e32b4d4d883808ffcafa97a8bebfc2aec8", "message": "Fix jniGetPrimitiveArrayCritical in the case of empty arraylets\n\nEmpty arraylets are treated as discontiguous arraylets. But since\nthey are empty there's no need to copy them in the critical section,\nhowever, jniGetPrimitiveArrayCritical callers expects not NULL\nvalues; therefore, in case of empty arraylets we advance the\npointer ahead of the header and return that address.\n\nThis fixes: https://github.com/eclipse/openj9/issues/8386\n\nSigned-off-by: Igor Braga <higorb1@gmail.com>", "committedDate": "2020-01-28T16:06:35Z", "type": "commit"}, {"oid": "613be1e32b4d4d883808ffcafa97a8bebfc2aec8", "url": "https://github.com/eclipse-openj9/openj9/commit/613be1e32b4d4d883808ffcafa97a8bebfc2aec8", "message": "Fix jniGetPrimitiveArrayCritical in the case of empty arraylets\n\nEmpty arraylets are treated as discontiguous arraylets. But since\nthey are empty there's no need to copy them in the critical section,\nhowever, jniGetPrimitiveArrayCritical callers expects not NULL\nvalues; therefore, in case of empty arraylets we advance the\npointer ahead of the header and return that address.\n\nThis fixes: https://github.com/eclipse/openj9/issues/8386\n\nSigned-off-by: Igor Braga <higorb1@gmail.com>", "committedDate": "2020-01-28T16:06:35Z", "type": "forcePushed"}]}