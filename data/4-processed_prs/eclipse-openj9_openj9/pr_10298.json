{"pr_number": 10298, "pr_title": "Consolidate AOT Relocation Records", "pr_createdAt": "2020-07-30T15:07:13Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10298", "timeline": [{"oid": "5519f9b122fd1f257c5b41769caa59a31290145a", "url": "https://github.com/eclipse-openj9/openj9/commit/5519f9b122fd1f257c5b41769caa59a31290145a", "message": "Consolidate TR_ValidateClassByName\n\nRemove the duplicated code that writes the TR_ValidateClassByName\nrelocation header information,and consolidate it in one canonical\nlocation.\n\nSigned-off-by: Irwin D'Souza <dsouzai.gh@gmail.com>", "committedDate": "2020-07-28T20:05:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU4ODMzMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10298#discussion_r471588330", "bodyText": "should this be setIsStatic ?", "author": "mstoodle", "createdAt": "2020-08-17T16:14:38Z", "path": "runtime/compiler/codegen/J9AheadOfTimeCompile.cpp", "diffHunk": "@@ -611,6 +611,19 @@ J9::AheadOfTimeCompile::initializeCommonAOTRelocationHeader(TR::IteratedExternal\n          }\n          break;\n \n+      case TR_ValidateDefiningClassFromCP:\n+         {\n+         TR_RelocationRecordValidateDefiningClassFromCP *dcpRecord = reinterpret_cast<TR_RelocationRecordValidateDefiningClassFromCP *>(reloRecord);\n+\n+         TR::DefiningClassFromCPRecord *svmRecord = reinterpret_cast<TR::DefiningClassFromCPRecord *>(relocation->getTargetAddress());\n+\n+         dcpRecord->setiSStatic(reloTarget, svmRecord->_isStatic);", "originalCommit": "4971085e43b142335d3a88c5667d9c157b6ed05f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc0MjQ5NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10298#discussion_r471742494", "bodyText": "Heh yeah it should; good catch. Fixed in 10a0d9d.", "author": "dsouzai", "createdAt": "2020-08-17T19:59:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU4ODMzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU4ODc2Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/10298#discussion_r471588766", "bodyText": "similarly here setIsStatic ?", "author": "mstoodle", "createdAt": "2020-08-17T16:15:21Z", "path": "runtime/compiler/runtime/RelocationRecord.cpp", "diffHunk": "@@ -3520,26 +3520,77 @@ TR_RelocationRecordValidateClassFromCP::cpIndex(TR_RelocationTarget *reloTarget)\n int32_t\n TR_RelocationRecordValidateDefiningClassFromCP::applyRelocation(TR_RelocationRuntime *reloRuntime, TR_RelocationTarget *reloTarget, uint8_t *reloLocation)\n    {\n-   uint16_t classID = reloTarget->loadUnsigned16b((uint8_t *) &((TR_RelocationRecordValidateDefiningClassFromCPBinaryTemplate *)_record)->_classID);\n-   uint16_t beholderID = reloTarget->loadUnsigned16b((uint8_t *) &((TR_RelocationRecordValidateDefiningClassFromCPBinaryTemplate *)_record)->_beholderID);\n-   uint32_t cpIndex = reloTarget->loadUnsigned32b((uint8_t *) &((TR_RelocationRecordValidateDefiningClassFromCPBinaryTemplate *)_record)->_cpIndex);\n-   bool isStatic = (bool)reloTarget->loadUnsigned8b((uint8_t *) &((TR_RelocationRecordValidateDefiningClassFromCPBinaryTemplate *)_record)->_isStatic);\n-\n-   if (reloRuntime->reloLogger()->logEnabled())\n-      {\n-      reloRuntime->reloLogger()->printf(\"%s\\n\", name());\n-      reloRuntime->reloLogger()->printf(\"\\tapplyRelocation: classID %d\\n\", classID);\n-      reloRuntime->reloLogger()->printf(\"\\tapplyRelocation: beholderID %d\\n\", beholderID);\n-      reloRuntime->reloLogger()->printf(\"\\tapplyRelocation: cpIndex %d\\n\", cpIndex);\n-      reloRuntime->reloLogger()->printf(\"\\tapplyRelocation: isStatic %s\\n\", isStatic ? \"true\" : \"false\");\n-      }\n+   uint16_t classID = this->classID(reloTarget);\n+   uint16_t beholderID = this->beholderID(reloTarget);\n+   uint32_t cpIndex = this->cpIndex(reloTarget);\n+   bool isStatic = this->isStatic(reloTarget);\n \n    if (reloRuntime->comp()->getSymbolValidationManager()->validateDefiningClassFromCPRecord(classID, beholderID, cpIndex, isStatic))\n       return 0;\n    else\n       return compilationAotClassReloFailure;\n    }\n \n+void\n+TR_RelocationRecordValidateDefiningClassFromCP::print(TR_RelocationRuntime *reloRuntime)\n+   {\n+   TR_RelocationTarget *reloTarget = reloRuntime->reloTarget();\n+   TR_RelocationRuntimeLogger *reloLogger = reloRuntime->reloLogger();\n+   TR_RelocationRecord::print(reloRuntime);\n+   reloLogger->printf(\"\\tisStatic %s\\n\", isStatic(reloTarget) ? \"true\" : \"false\");\n+   reloLogger->printf(\"\\tclassID %d\\n\", classID(reloTarget));\n+   reloLogger->printf(\"\\tbeholderID %d\\n\", beholderID(reloTarget));\n+   reloLogger->printf(\"\\tcpindex %d\\n\", cpIndex(reloTarget));\n+   }\n+\n+void\n+TR_RelocationRecordValidateDefiningClassFromCP::setiSStatic(TR_RelocationTarget *reloTarget, bool isStatic)", "originalCommit": "4971085e43b142335d3a88c5667d9c157b6ed05f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc0MjU0Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10298#discussion_r471742542", "bodyText": "Fixed in 10a0d9d.", "author": "dsouzai", "createdAt": "2020-08-17T19:59:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU4ODc2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU4ODk4Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10298#discussion_r471588983", "bodyText": "last one :) . setIsStatic()", "author": "mstoodle", "createdAt": "2020-08-17T16:15:45Z", "path": "runtime/compiler/runtime/RelocationRecord.hpp", "diffHunk": "@@ -1491,6 +1491,20 @@ class TR_RelocationRecordValidateDefiningClassFromCP : public TR_RelocationRecor\n       virtual int32_t bytesInHeaderAndPayload() { return sizeof(TR_RelocationRecordValidateDefiningClassFromCPBinaryTemplate); }\n       virtual void preparePrivateData(TR_RelocationRuntime *reloRuntime, TR_RelocationTarget *reloTarget) {}\n       virtual int32_t applyRelocation(TR_RelocationRuntime *reloRuntime, TR_RelocationTarget *reloTarget, uint8_t *reloLocation);\n+\n+      virtual void print(TR_RelocationRuntime *reloRuntime);\n+\n+      void setiSStatic(TR_RelocationTarget *reloTarget, bool isStatic);", "originalCommit": "4971085e43b142335d3a88c5667d9c157b6ed05f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc0MjU4Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10298#discussion_r471742583", "bodyText": "Fixed in 10a0d9d.", "author": "dsouzai", "createdAt": "2020-08-17T19:59:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU4ODk4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU5MDc2OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10298#discussion_r471590769", "bodyText": "Given the number of places these two are called, I would probably have just spelled out ClassLoader so others don't have to think about what \"CL\" should stand for.", "author": "mstoodle", "createdAt": "2020-08-17T16:18:55Z", "path": "runtime/compiler/runtime/RelocationRecord.hpp", "diffHunk": "@@ -1445,6 +1445,17 @@ class TR_RelocationRecordValidateProfiledClass : public TR_RelocationRecord\n       virtual int32_t bytesInHeaderAndPayload() { return sizeof(TR_RelocationRecordValidateProfiledClassBinaryTemplate); }\n       virtual void preparePrivateData(TR_RelocationRuntime *reloRuntime, TR_RelocationTarget *reloTarget) {}\n       virtual int32_t applyRelocation(TR_RelocationRuntime *reloRuntime, TR_RelocationTarget *reloTarget, uint8_t *reloLocation);\n+\n+      virtual void print(TR_RelocationRuntime *reloRuntime);\n+\n+      void setClassID(TR_RelocationTarget *reloTarget, uint16_t classID);\n+      uint16_t classID(TR_RelocationTarget *reloTarget);\n+\n+      void setClassChainOffset(TR_RelocationTarget *reloTarget, uintptr_t classChainOffset);\n+      uintptr_t classChainOffset(TR_RelocationTarget *reloTarget);\n+\n+      void setClassChainOffsetForCL(TR_RelocationTarget *reloTarget, uintptr_t classChainOffsetForCL);", "originalCommit": "e2b04448449ebc25b953e3b57e60a002d86c67b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc0MjE4Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10298#discussion_r471742182", "bodyText": "I added the full form of CL in 4fef701 since it's probably better to be explicit.", "author": "dsouzai", "createdAt": "2020-08-17T19:58:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU5MDc2OQ=="}], "type": "inlineReview"}, {"oid": "4fef70154a406826c772815ecf8e1433c45a4239", "url": "https://github.com/eclipse-openj9/openj9/commit/4fef70154a406826c772815ecf8e1433c45a4239", "message": "Consolidate TR_ValidateProfiledClass\n\nRemove the duplicated code that writes the TR_ValidateProfiledClass\nrelocation header information,and consolidate it in one canonical\nlocation.\n\nSigned-off-by: Irwin D'Souza <dsouzai.gh@gmail.com>", "committedDate": "2020-08-17T19:56:01Z", "type": "commit"}, {"oid": "e87a128a07a2f9862a96379adf8c10c9d34b6f88", "url": "https://github.com/eclipse-openj9/openj9/commit/e87a128a07a2f9862a96379adf8c10c9d34b6f88", "message": "Consolidate TR_ValidateClassFromCP\n\nRemove the duplicated code that writes the TR_ValidateClassFromCP\nrelocation header information,and consolidate it in one canonical\nlocation.\n\nSigned-off-by: Irwin D'Souza <dsouzai.gh@gmail.com>", "committedDate": "2020-08-17T19:56:02Z", "type": "commit"}, {"oid": "0cfc524a38c1858d5331f464c7dc4f766623ce75", "url": "https://github.com/eclipse-openj9/openj9/commit/0cfc524a38c1858d5331f464c7dc4f766623ce75", "message": "Consolidate TR_ValidateDefiningClassFromCP\n\nRemove the duplicated code that writes the\nTR_ValidateDefiningClassFromCP relocation header information,\nand consolidate it in one canonical location.\n\nSigned-off-by: Irwin D'Souza <dsouzai.gh@gmail.com>", "committedDate": "2020-08-17T19:56:02Z", "type": "commit"}, {"oid": "10a0d9da2b8910f8be1e86aed05ae3bad0d7211c", "url": "https://github.com/eclipse-openj9/openj9/commit/10a0d9da2b8910f8be1e86aed05ae3bad0d7211c", "message": "Consolidate TR_ValidateStaticClassFromCP\n\nRemove the duplicated code that writes the\nTR_ValidateStaticClassFromCP relocation header information,\nand consolidate it in one canonical location.\n\nSigned-off-by: Irwin D'Souza <dsouzai.gh@gmail.com>", "committedDate": "2020-08-17T19:56:02Z", "type": "commit"}, {"oid": "c4aa527ac74b9d6a61a9d7dbdd82e7b69eeadd94", "url": "https://github.com/eclipse-openj9/openj9/commit/c4aa527ac74b9d6a61a9d7dbdd82e7b69eeadd94", "message": "Consolidate TR_ValidateArrayClassFromComponentClass\n\nRemove the duplicated code that writes the\nTR_ValidateArrayClassFromComponentClass relocation header\ninformation, and consolidate it in one canonical location.\n\nSigned-off-by: Irwin D'Souza <dsouzai.gh@gmail.com>", "committedDate": "2020-08-17T19:56:02Z", "type": "commit"}, {"oid": "23260bfdd8c57d632a6eb7b748946d7575160556", "url": "https://github.com/eclipse-openj9/openj9/commit/23260bfdd8c57d632a6eb7b748946d7575160556", "message": "Consolidate TR_ValidateSuperClassFromClass\n\nRemove the duplicated code that writes the\nTR_ValidateSuperClassFromClass relocation header\ninformation, and consolidate it in one canonical location.\n\nSigned-off-by: Irwin D'Souza <dsouzai.gh@gmail.com>", "committedDate": "2020-08-17T19:56:02Z", "type": "commit"}, {"oid": "d24f37f6735870c6592b941927d753264acfaa10", "url": "https://github.com/eclipse-openj9/openj9/commit/d24f37f6735870c6592b941927d753264acfaa10", "message": "Consolidate TR_ValidateClassInstanceOfClass\n\nRemove the duplicated code that writes the\nTR_ValidateClassInstanceOfClass relocation header\ninformation, and consolidate it in one canonical location.\n\nSigned-off-by: Irwin D'Souza <dsouzai.gh@gmail.com>", "committedDate": "2020-08-17T19:56:02Z", "type": "commit"}, {"oid": "fa20af01d0f54a6d470ed5f2346c49b65adce61a", "url": "https://github.com/eclipse-openj9/openj9/commit/fa20af01d0f54a6d470ed5f2346c49b65adce61a", "message": "Consolidate TR_ValidateSystemClassByName\n\nRemove the duplicated code that writes the\nTR_ValidateSystemClassByName relocation header\ninformation, and consolidate it in one canonical location.\n\nSigned-off-by: Irwin D'Souza <dsouzai.gh@gmail.com>", "committedDate": "2020-08-17T19:56:02Z", "type": "commit"}, {"oid": "fa20af01d0f54a6d470ed5f2346c49b65adce61a", "url": "https://github.com/eclipse-openj9/openj9/commit/fa20af01d0f54a6d470ed5f2346c49b65adce61a", "message": "Consolidate TR_ValidateSystemClassByName\n\nRemove the duplicated code that writes the\nTR_ValidateSystemClassByName relocation header\ninformation, and consolidate it in one canonical location.\n\nSigned-off-by: Irwin D'Souza <dsouzai.gh@gmail.com>", "committedDate": "2020-08-17T19:56:02Z", "type": "forcePushed"}]}