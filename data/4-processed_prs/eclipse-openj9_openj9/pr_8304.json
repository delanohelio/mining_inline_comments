{"pr_number": 8304, "pr_title": "AArch64: Save parameters to the stack in FSD mode", "pr_createdAt": "2020-01-15T06:24:32Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/8304", "timeline": [{"oid": "af9d74506570cc6572e780254661e621e8a71a1a", "url": "https://github.com/eclipse-openj9/openj9/commit/af9d74506570cc6572e780254661e621e8a71a1a", "message": "AArch64: Save parameters to the stack in FSD mode\n\nIn the method prologue, we need to save parameters passed\nin linkage registers to the stack when in FSD mode as other platforms do.\nThis commit adds `saveParametersToStack` function to PrivateLinkage class\nfor this purpose.\nThis commit modifies `copyParametersToHomeLocation` function not to\nsave parameter if parms are saved by `saveParametersToStack`.\n\nSigned-off-by: Akira Saitoh <saiaki@jp.ibm.com>", "committedDate": "2020-01-15T06:13:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzIxMzA5NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8304#discussion_r367213094", "bodyText": "Do you need to execute this loop with parmIterator when parmsHaveBeenStored is true?", "author": "knn-k", "createdAt": "2020-01-16T03:16:19Z", "path": "runtime/compiler/aarch64/codegen/ARM64PrivateLinkage.cpp", "diffHunk": "@@ -1353,6 +1358,55 @@ J9::ARM64::PrivateLinkage::copyParametersToHomeLocation(TR::Instruction *cursor)\n    return cursor;\n    }\n \n+/**\n+ * A more optimal implementation of this function will be required when GRA is enabled.\n+ * See OpenJ9 issue #6657.  Also consider merging with loadStackParametersToLinkageRegisters.\n+ */\n+TR::Instruction *\n+J9::ARM64::PrivateLinkage::copyParametersToHomeLocation(TR::Instruction *cursor, bool parmsHaveBeenStored)\n+   {\n+   TR::Machine *machine = cg()->machine();\n+   TR::ARM64LinkageProperties& properties = getProperties();\n+   TR::RealRegister *javaSP = machine->getRealRegister(properties.getStackPointerRegister());       // x20\n+\n+   TR::ResolvedMethodSymbol *bodySymbol = comp()->getJittedMethodSymbol();\n+   ListIterator<TR::ParameterSymbol> parmIterator(&(bodySymbol->getParameterList()));\n+   TR::ParameterSymbol *parmCursor;\n+\n+   // Store to stack all parameters passed in linkage registers\n+   //\n+   for (parmCursor = parmIterator.getFirst();\n+        parmCursor != NULL;\n+        parmCursor = parmIterator.getNext())\n+      {\n+      if (parmCursor->isParmPassedInRegister())\n+         {\n+         if (!parmsHaveBeenStored)", "originalCommit": "af9d74506570cc6572e780254661e621e8a71a1a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzIyNjUwMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/8304#discussion_r367226502", "bodyText": "I think that we will add more logic inside this loop when implementing GRA. Please see x version: https://github.com/eclipse/openj9/blob/99a64d22d23429b6cced01f7757b86cdea0baa9c/runtime/compiler/x/codegen/X86PrivateLinkage.cpp#L252-L337", "author": "Akira1Saitoh", "createdAt": "2020-01-16T04:32:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzIxMzA5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzIzMDQ3Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/8304#discussion_r367230476", "bodyText": "OK, I understand.", "author": "knn-k", "createdAt": "2020-01-16T04:55:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzIxMzA5NA=="}], "type": "inlineReview"}]}