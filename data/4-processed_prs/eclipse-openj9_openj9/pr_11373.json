{"pr_number": 11373, "pr_title": "Check class initialization status in reusing iprofiling data", "pr_createdAt": "2020-12-04T21:38:32Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/11373", "timeline": [{"oid": "a38290bc96fdb8f664315f09d7307dc4c10933af", "url": "https://github.com/eclipse-openj9/openj9/commit/a38290bc96fdb8f664315f09d7307dc4c10933af", "message": "Only load initialized class from SCC into iprofiler data\n\nProfiled class from last run might not get used in the second run. If\nwe don't check its initialization status, the profiling data might\nbe inconsistent with the class hierarchy, resulting in bad inlining\ndecision or even wrong optimization.\n\nSigned-off-by: Liqun Liu <liqunl@ca.ibm.com>", "committedDate": "2020-12-07T18:18:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzczMDAxMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/11373#discussion_r537730013", "bodyText": "Could you add a comment here describing why we're excluding interface classes.", "author": "dsouzai", "createdAt": "2020-12-07T18:26:42Z", "path": "runtime/compiler/runtime/RelocationRecord.cpp", "diffHunk": "@@ -2272,6 +2272,13 @@ TR_RelocationRecordInlinedMethod::inlinedSiteCanBeActivated(TR_RelocationRuntime\n       return false;\n       }\n \n+   TR_OpaqueClassBlock *classOfMethod = (TR_OpaqueClassBlock*)J9_CLASS_FROM_METHOD(currentMethod);\n+   if (!reloRuntime->fej9()->isInterfaceClass(classOfMethod) && !reloRuntime->fej9()->isClassInitialized(classOfMethod))", "originalCommit": "a38290bc96fdb8f664315f09d7307dc4c10933af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzczMTkxMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/11373#discussion_r537731912", "bodyText": "Might be worth adding a comment here about why this is necessary (basically what it results in the optimizer) and also why we're ok with having the ith entry being NULL (essentially just a brief summary of Marius' comments).", "author": "dsouzai", "createdAt": "2020-12-07T18:29:33Z", "path": "runtime/compiler/runtime/IProfiler.cpp", "diffHunk": "@@ -3153,7 +3153,7 @@ TR_IPBCDataCallGraph::loadFromPersistentCopy(TR_IPBCDataStorageHeader * storage,\n          if (comp->fej9()->sharedCache()->isROMClassOffsetInSharedCache(csInfoClazzOffset, &romClass))\n             ramClass = ((TR_J9VM *)comp->fej9())->matchRAMclassFromROMclass((J9ROMClass *)romClass, comp);\n \n-         if (ramClass)\n+         if (ramClass && comp->fej9()->isClassInitialized((TR_OpaqueClassBlock*)ramClass))", "originalCommit": "a38290bc96fdb8f664315f09d7307dc4c10933af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "da312a63a1efdbc17c9d0b06ae29e9002834ce35", "url": "https://github.com/eclipse-openj9/openj9/commit/da312a63a1efdbc17c9d0b06ae29e9002834ce35", "message": "Only load initialized class from SCC into iprofiler data\n\nProfiled class from last run might not get used in the second run. If\nwe don't check its initialization status, the profiling data might\nbe inconsistent with the class hierarchy, resulting in bad inlining\ndecision or even wrong optimization.\n\nSigned-off-by: Liqun Liu <liqunl@ca.ibm.com>", "committedDate": "2020-12-08T02:27:10Z", "type": "commit"}, {"oid": "da312a63a1efdbc17c9d0b06ae29e9002834ce35", "url": "https://github.com/eclipse-openj9/openj9/commit/da312a63a1efdbc17c9d0b06ae29e9002834ce35", "message": "Only load initialized class from SCC into iprofiler data\n\nProfiled class from last run might not get used in the second run. If\nwe don't check its initialization status, the profiling data might\nbe inconsistent with the class hierarchy, resulting in bad inlining\ndecision or even wrong optimization.\n\nSigned-off-by: Liqun Liu <liqunl@ca.ibm.com>", "committedDate": "2020-12-08T02:27:10Z", "type": "forcePushed"}]}