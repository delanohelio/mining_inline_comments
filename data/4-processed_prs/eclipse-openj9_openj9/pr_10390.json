{"pr_number": 10390, "pr_title": "Handle new CPU enum types inside J9CPU.cpp", "pr_createdAt": "2020-08-14T14:59:04Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10390", "timeline": [{"oid": "86e45fe39ac8879fb13cf34d204ea92de83c3350", "url": "https://github.com/eclipse-openj9/openj9/commit/86e45fe39ac8879fb13cf34d204ea92de83c3350", "message": "Handle new CPU enum types in test routine\n\nSigned-off-by: Dhruv Chopra <Dhruv.C.Chopra@ibm.com>", "committedDate": "2020-08-14T14:52:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU1MzQzMQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10390#discussion_r471553431", "bodyText": "_supportedArch is supposed to be set by the old implementation. If you are going to set _supportedArch using the new implementation, the tests (old implementation against new implementation) will always pass. This change will invalidate the test because now it's checking new implementation against itself.", "author": "harryyu1994", "createdAt": "2020-08-17T15:21:30Z", "path": "runtime/compiler/z/env/J9CPU.cpp", "diffHunk": "@@ -50,19 +50,42 @@ J9::Z::CPU::applyUserOptions()\n    OMRPORT_ACCESS_FROM_OMRPORT(TR::Compiler->omrPortLib);\n \n    if (_processorDescription.processor >= OMR_PROCESSOR_S390_Z10 && TR::Options::getCmdLineOptions()->getOption(TR_DisableZ10))\n-      _processorDescription.processor = OMR_PROCESSOR_S390_FIRST;\n+      {\n+      // Z10 is the minimum supported architecture for the OpenJ9 on Z. So instead of reducing the architecture to Z9 here,\n+      // we go down to Unknown.\n+      _supportedArch = Unknown;\n+      _processorDescription.processor = OMR_PROCESSOR_S390_UNKNOWN;\n+      }\n    else if (_processorDescription.processor >= OMR_PROCESSOR_S390_Z196 && TR::Options::getCmdLineOptions()->getOption(TR_DisableZ196))\n+      {\n+      _supportedArch = z10;", "originalCommit": "9c9eebbad1d69bf7f29c964d3f6f47dba1874281", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU1NjQ2OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10390#discussion_r471556468", "bodyText": "please add _supportedArch in J9::Z::CPU::initializeS390ProcessorFeatures() instead of J9::Z::CPU::applyUserOptions(). J9::Z::CPU::initializeS390ProcessorFeatures() sets _supportedArch based on the old implementation (j9port) and J9::Z::CPU::applyUserOptions() sets _processorDescription based on the new implementation (omrport).", "author": "harryyu1994", "createdAt": "2020-08-17T15:25:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU1MzQzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU2MDk4Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10390#discussion_r471560983", "bodyText": "_supportedArch and J9::Z::CPU::initializeS390ProcessorFeatures() will go away when the old processor detection implementation gets removed. But for now the best thing to do is to not invalidate the tests by applying the new changes to both old and new implementation.", "author": "harryyu1994", "createdAt": "2020-08-17T15:32:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU1MzQzMQ=="}], "type": "inlineReview"}, {"oid": "86e45fe39ac8879fb13cf34d204ea92de83c3350", "url": "https://github.com/eclipse-openj9/openj9/commit/86e45fe39ac8879fb13cf34d204ea92de83c3350", "message": "Handle new CPU enum types in test routine\n\nSigned-off-by: Dhruv Chopra <Dhruv.C.Chopra@ibm.com>", "committedDate": "2020-08-14T14:52:34Z", "type": "forcePushed"}]}