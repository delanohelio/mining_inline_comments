{"pr_number": 10408, "pr_title": "Fix incorrect signature in _classByNameMap cache", "pr_createdAt": "2020-08-18T17:00:42Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10408", "timeline": [{"oid": "4850bf8e0011b5e982a32252fa5f50eaac5c0a45", "url": "https://github.com/eclipse-openj9/openj9/commit/4850bf8e0011b5e982a32252fa5f50eaac5c0a45", "message": "Fix bugs in _classByNameMap cache\n\n- _classByNameMap was using the signature of a class as part of the key,\nbut when deleting from the cache, the name of a class was used, which is slightly different.\nBecause of that most unloaded classes were not removed from the cache,\ncausing segfaults. This commit fixes the issue by transforming\nthe name into signature before deleting and renaming the cache\nappropriately.\n- Class loaders of the referencing constant pool and the actual\nresulting class\nwere assumed to be the same but that it is not always the case.\nThis commit adds code to use the correct class loader during\ncaching.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-08-18T17:42:40Z", "type": "forcePushed"}, {"oid": "a317943ec85950f8544cedf37198e68cd97b9ccb", "url": "https://github.com/eclipse-openj9/openj9/commit/a317943ec85950f8544cedf37198e68cd97b9ccb", "message": "Fix bugs in _classByNameMap cache\n\n- _classByNameMap was using the signature of a class as part of the key,\nbut when deleting from the cache, the name of a class was used, which is slightly different.\nBecause of that most unloaded classes were not removed from the cache,\ncausing segfaults. This commit fixes the issue by transforming\nthe name into signature before deleting and renaming the cache\nappropriately.\n- Class loaders of the referencing constant pool and the actual\nresulting class\nwere assumed to be the same but that it is not always the case.\nThis commit adds code to use the correct class loader during\ncaching.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-08-18T19:18:42Z", "type": "forcePushed"}, {"oid": "d6647ae11ec31915ef838e17693afc918bdcee35", "url": "https://github.com/eclipse-openj9/openj9/commit/d6647ae11ec31915ef838e17693afc918bdcee35", "message": "Fix bugs in _classByNameMap cache\n\n- _classByNameMap was using the signature of a class as part of the key,\nbut when deleting from the cache, the name of a class was used, which is slightly different.\nBecause of that most unloaded classes were not removed from the cache,\ncausing segfaults. This commit fixes the issue by transforming\nthe name into signature before deleting and renaming the cache\nappropriately.\n- Class loaders of the referencing constant pool and the actual\nresulting class\nwere assumed to be the same but that it is not always the case.\nThis commit adds code to use the correct class loader during\ncaching.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-08-18T19:20:51Z", "type": "forcePushed"}, {"oid": "010d20f257fd00895a9476b21505753db2a52ad1", "url": "https://github.com/eclipse-openj9/openj9/commit/010d20f257fd00895a9476b21505753db2a52ad1", "message": "Fix bugs in _classByNameMap cache\n\n- _classByNameMap was using the signature of a class as part of the key,\nbut when deleting from the cache, the name of a class was used, which is slightly different.\nBecause of that most unloaded classes were not removed from the cache,\ncausing segfaults. This commit fixes the issue by transforming\nthe name into signature before deleting and renaming the cache\nappropriately.\n- Class loaders of the referencing constant pool and the actual\nresulting class\nwere assumed to be the same but that it is not always the case.\nThis commit adds code to use the correct class loader during\ncaching.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-08-18T19:55:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU0NzQxNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10408#discussion_r472547415", "bodyText": "This allocation of an array of 'dynamic' and unknown length (potentially very large) increases the chances of a stack overflow. Maybe allocate a std::string of right length and then copy the desired data into the buffer of the string:\nsize_t bufferLength = (className[0] == '[' ? sigLen : sigLen + 2);\nstd::string sigStr(bufferLength, 0);\nif (className[0] == '[')\n   {\n   memcpy(&sigStr[0], className, sigLen);\n   }\nelse\n   {\n   sigStr[0] = 'L';\n   memcpy(&sigStr[1], className, sigLen);\n   sigStr[sigLen+1]=';';\n   }", "author": "mpirvu", "createdAt": "2020-08-18T23:25:10Z", "path": "runtime/compiler/runtime/JITClientSession.cpp", "diffHunk": "@@ -146,9 +147,28 @@ ClientSessionData::processUnloadedClasses(const std::vector<TR_OpaqueClassBlock*\n          J9ROMClass *romClass = it->second._romClass;\n \n          J9UTF8 *clazzName = NNSRP_GET(romClass->className, J9UTF8 *);\n-         std::string className((const char *)clazzName->data, (int32_t)clazzName->length);\n+         char *className = (char *) clazzName->data;\n+         int32_t sigLen = (int32_t) clazzName->length;\n+\n+         // copy of classNameToSignature method which can't be used\n+         // here because compilation object hasn't been initialized yet\n+         char sig[sigLen + 3];", "originalCommit": "010d20f257fd00895a9476b21505753db2a52ad1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA4NDg2Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10408#discussion_r473084862", "bodyText": "I tried that at first but the string wasn't being initialized properly.\nHm, maybe it will work with this constructor though.", "author": "dmitry-ten", "createdAt": "2020-08-19T14:44:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU0NzQxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU0NzY1NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10408#discussion_r472547655", "bodyText": "We don't need to terminate the string with NULL.", "author": "mpirvu", "createdAt": "2020-08-18T23:25:48Z", "path": "runtime/compiler/runtime/JITClientSession.cpp", "diffHunk": "@@ -146,9 +147,28 @@ ClientSessionData::processUnloadedClasses(const std::vector<TR_OpaqueClassBlock*\n          J9ROMClass *romClass = it->second._romClass;\n \n          J9UTF8 *clazzName = NNSRP_GET(romClass->className, J9UTF8 *);\n-         std::string className((const char *)clazzName->data, (int32_t)clazzName->length);\n+         char *className = (char *) clazzName->data;\n+         int32_t sigLen = (int32_t) clazzName->length;\n+\n+         // copy of classNameToSignature method which can't be used\n+         // here because compilation object hasn't been initialized yet\n+         char sig[sigLen + 3];\n+         if (className[0] == '[')\n+            {\n+            memcpy(sig, className, sigLen);\n+            }\n+         else\n+            {\n+            sigLen += 2;\n+            sig[0] = 'L';\n+            memcpy(sig + 1, className, sigLen - 2);\n+            sig[sigLen-1]=';';\n+            }\n+         sig[sigLen] = 0;", "originalCommit": "010d20f257fd00895a9476b21505753db2a52ad1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA4NTAxMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10408#discussion_r473085010", "bodyText": "True.", "author": "dmitry-ten", "createdAt": "2020-08-19T14:44:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU0NzY1NQ=="}], "type": "inlineReview"}, {"oid": "74c47d3a7150542884c041f2df3b765eb588c744", "url": "https://github.com/eclipse-openj9/openj9/commit/74c47d3a7150542884c041f2df3b765eb588c744", "message": "Fix incorrect signature in _classByNameMap cache\n\n_classByNameMap was using the signature of a class as part of the key,\nbut when deleting from the cache, the name of a class was used, which is slightly different.\nBecause of that most unloaded classes were not removed from the cache,\ncausing segfaults. This commit fixes the issue by transforming\nthe name into signature before deleting and renaming the cache\nappropriately.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-08-19T17:06:52Z", "type": "commit"}, {"oid": "74c47d3a7150542884c041f2df3b765eb588c744", "url": "https://github.com/eclipse-openj9/openj9/commit/74c47d3a7150542884c041f2df3b765eb588c744", "message": "Fix incorrect signature in _classByNameMap cache\n\n_classByNameMap was using the signature of a class as part of the key,\nbut when deleting from the cache, the name of a class was used, which is slightly different.\nBecause of that most unloaded classes were not removed from the cache,\ncausing segfaults. This commit fixes the issue by transforming\nthe name into signature before deleting and renaming the cache\nappropriately.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-08-19T17:06:52Z", "type": "forcePushed"}]}