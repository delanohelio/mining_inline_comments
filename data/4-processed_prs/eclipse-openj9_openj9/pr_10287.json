{"pr_number": 10287, "pr_title": "Fix sysinfo_test_get_cwd3 to handle symlinks", "pr_createdAt": "2020-07-29T18:39:43Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10287", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUxNDE5Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10287#discussion_r462514192", "bodyText": "OSX appears to have a similar issue with /tmp being /private/tmp handled above by:\n#if defined(OSX)\n\tconst char *utf8 = \"/private/tmp/j9sysinfo_test_get_cwd3/\";\n#else /* defined(OSX) */\n\nCan this be adapted for Z to always use /SYSTEM/tmp/j9sysinfo_test_get_cwd3/?", "author": "DanHeidinga", "createdAt": "2020-07-29T18:50:02Z", "path": "runtime/tests/port/si.c", "diffHunk": "@@ -1892,10 +1892,22 @@ j9sysinfo_test_get_cwd3(struct J9PortLibrary *portLibrary)\n \t} else {\n \t\toutputComment(PORTLIB, \"CWD = %s\\n\", buffer);\n \t}\n-\n-\trc = memcmp(utf8, buffer, strlen(buffer));\n-\tif (0 != rc) {\n-\t\toutputErrorMessage(PORTTEST_ERROR_ARGS, \"invalid directory rc: %d\\n\", rc);\n+\t\n+\t\n+\t{\n+\t\tchar *cmpBuffer = buffer;\n+#if defined(J9ZOS390)\n+\t\t/* On z/OS, the /tmp directory is typically found in /SYSTEM. */", "originalCommit": "dc9120f8ef86f1e967b842bb371b423eabd67fb4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU3MDg3NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10287#discussion_r462570874", "bodyText": "It doesn't work on the older machines, but I can do what Keith is suggesting.", "author": "pshipton", "createdAt": "2020-07-29T20:32:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUxNDE5Mg=="}], "type": "inlineReview"}, {"oid": "e434bbe38c97374ef234c6ad35693b8e0ff69a13", "url": "https://github.com/eclipse-openj9/openj9/commit/e434bbe38c97374ef234c6ad35693b8e0ff69a13", "message": "Fix sysinfo_test_get_cwd3 to handle symlinks\n\nOn z/OS the /tmp directory is typically found under /SYSTEM. On OSX,\nunder /private. Rather than hard coding assumptions, update the test to\ndetermine the location of /tmp dynamically.\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-07-29T21:32:45Z", "type": "forcePushed"}, {"oid": "802938537dd80b95cad44b1eef66586c7ce2ab8a", "url": "https://github.com/eclipse-openj9/openj9/commit/802938537dd80b95cad44b1eef66586c7ce2ab8a", "message": "Fix sysinfo_test_get_cwd3 to handle symlinks\n\nOn z/OS the /tmp directory is typically found under /SYSTEM. On OSX,\nunder /private. Rather than hard coding assumptions, update the test to\ndetermine the location of /tmp dynamically.\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-07-30T02:34:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcwNDI0OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10287#discussion_r462704248", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \tj9sysinfo_get_cwd(cmpbuf, EsMaxPath);\n          \n          \n            \n            \trc = j9sysinfo_get_cwd(cmpbuf, EsMaxPath);", "author": "DanHeidinga", "createdAt": "2020-07-30T02:55:21Z", "path": "runtime/tests/port/si.c", "diffHunk": "@@ -1855,17 +1858,40 @@ j9sysinfo_test_get_cwd3(struct J9PortLibrary *portLibrary)\n \t\t\toutputErrorMessage(PORTTEST_ERROR_ARGS, \"error failed to change current directory rc: %d\\n\", rc);\n \t}\n #else /* defined(WIN32) */\n-#if defined(OSX)\n-\tconst char *utf8 = \"/private/tmp/j9sysinfo_test_get_cwd3/\";\n-#else /* defined(OSX) */\n-\tconst char *utf8 = \"/tmp/j9sysinfo_test_get_cwd3/\";\n-#endif /* defined(OSX) */\n+\tconst char *tmp = \"/tmp/\";\n+\tconst char *utf8 = \"j9sysinfo_test_get_cwd3/\";\n \n \treportTestEntry(portLibrary, testName);\n \n \torig_cwd = (char*)j9mem_allocate_memory( EsMaxPath, OMRMEM_CATEGORY_PORT_LIBRARY );\n \tj9sysinfo_get_cwd(orig_cwd, EsMaxPath);\n \n+\t/* /tmp may be a symlink or similar, get it's actual path first */\n+#if defined(J9ZOS390)\n+\trc = atoe_chdir(tmp);\n+#else /* defined(J9ZOS390) */\n+\trc = chdir(tmp);\n+#endif /* defined(J9ZOS390) */\n+\tif (0 != rc) {\n+\t\toutputErrorMessage(PORTTEST_ERROR_ARGS, \"cd %s failed rc: %d\\n\", tmp, rc);\n+\t} else {\n+\t\toutputComment(portLibrary, \"cd %s\\n\", tmp);\n+\t}\n+\t\n+\tcmpbuf = (char*)j9mem_allocate_memory( EsMaxPath, OMRMEM_CATEGORY_PORT_LIBRARY );\n+\n+\tj9sysinfo_get_cwd(cmpbuf, EsMaxPath);", "originalCommit": "802938537dd80b95cad44b1eef66586c7ce2ab8a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcyNDA2MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10287#discussion_r462724060", "bodyText": "Updated", "author": "pshipton", "createdAt": "2020-07-30T04:14:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcwNDI0OA=="}], "type": "inlineReview"}, {"oid": "6772cda75a82f4915bc49ea7afef7b5f5f63bdc2", "url": "https://github.com/eclipse-openj9/openj9/commit/6772cda75a82f4915bc49ea7afef7b5f5f63bdc2", "message": "Fix sysinfo_test_get_cwd3 to handle symlinks\n\nOn z/OS the /tmp directory is typically found under /SYSTEM. On OSX,\nunder /private. Rather than hard coding assumptions, update the test to\ndetermine the location of /tmp dynamically.\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-07-30T04:14:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAzNDkyNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10287#discussion_r463034926", "bodyText": "The test cannot continue; suggest goto cleanup; (adding that label and appropriate actions).", "author": "keithc-ca", "createdAt": "2020-07-30T14:24:55Z", "path": "runtime/tests/port/si.c", "diffHunk": "@@ -1855,17 +1858,40 @@ j9sysinfo_test_get_cwd3(struct J9PortLibrary *portLibrary)\n \t\t\toutputErrorMessage(PORTTEST_ERROR_ARGS, \"error failed to change current directory rc: %d\\n\", rc);\n \t}\n #else /* defined(WIN32) */\n-#if defined(OSX)\n-\tconst char *utf8 = \"/private/tmp/j9sysinfo_test_get_cwd3/\";\n-#else /* defined(OSX) */\n-\tconst char *utf8 = \"/tmp/j9sysinfo_test_get_cwd3/\";\n-#endif /* defined(OSX) */\n+\tconst char *tmp = \"/tmp/\";\n+\tconst char *utf8 = \"j9sysinfo_test_get_cwd3/\";\n \n \treportTestEntry(portLibrary, testName);\n \n \torig_cwd = (char*)j9mem_allocate_memory( EsMaxPath, OMRMEM_CATEGORY_PORT_LIBRARY );\n \tj9sysinfo_get_cwd(orig_cwd, EsMaxPath);\n \n+\t/* /tmp may be a symlink or similar, get it's actual path first */\n+#if defined(J9ZOS390)\n+\trc = atoe_chdir(tmp);\n+#else /* defined(J9ZOS390) */\n+\trc = chdir(tmp);\n+#endif /* defined(J9ZOS390) */\n+\tif (0 != rc) {\n+\t\toutputErrorMessage(PORTTEST_ERROR_ARGS, \"cd %s failed rc: %d\\n\", tmp, rc);", "originalCommit": "6772cda75a82f4915bc49ea7afef7b5f5f63bdc2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAzNTE5Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10287#discussion_r463035192", "bodyText": "goto cleanup;", "author": "keithc-ca", "createdAt": "2020-07-30T14:25:14Z", "path": "runtime/tests/port/si.c", "diffHunk": "@@ -1855,17 +1858,40 @@ j9sysinfo_test_get_cwd3(struct J9PortLibrary *portLibrary)\n \t\t\toutputErrorMessage(PORTTEST_ERROR_ARGS, \"error failed to change current directory rc: %d\\n\", rc);\n \t}\n #else /* defined(WIN32) */\n-#if defined(OSX)\n-\tconst char *utf8 = \"/private/tmp/j9sysinfo_test_get_cwd3/\";\n-#else /* defined(OSX) */\n-\tconst char *utf8 = \"/tmp/j9sysinfo_test_get_cwd3/\";\n-#endif /* defined(OSX) */\n+\tconst char *tmp = \"/tmp/\";\n+\tconst char *utf8 = \"j9sysinfo_test_get_cwd3/\";\n \n \treportTestEntry(portLibrary, testName);\n \n \torig_cwd = (char*)j9mem_allocate_memory( EsMaxPath, OMRMEM_CATEGORY_PORT_LIBRARY );\n \tj9sysinfo_get_cwd(orig_cwd, EsMaxPath);\n \n+\t/* /tmp may be a symlink or similar, get it's actual path first */\n+#if defined(J9ZOS390)\n+\trc = atoe_chdir(tmp);\n+#else /* defined(J9ZOS390) */\n+\trc = chdir(tmp);\n+#endif /* defined(J9ZOS390) */\n+\tif (0 != rc) {\n+\t\toutputErrorMessage(PORTTEST_ERROR_ARGS, \"cd %s failed rc: %d\\n\", tmp, rc);\n+\t} else {\n+\t\toutputComment(portLibrary, \"cd %s\\n\", tmp);\n+\t}\n+\t\n+\tcmpbuf = (char*)j9mem_allocate_memory( EsMaxPath, OMRMEM_CATEGORY_PORT_LIBRARY );\n+\n+\trc = j9sysinfo_get_cwd(cmpbuf, EsMaxPath);\n+\tif (0 != rc) {\n+\t\toutputErrorMessage(PORTTEST_ERROR_ARGS, \"error failed to get current working directory rc: %d\\n\", rc);", "originalCommit": "6772cda75a82f4915bc49ea7afef7b5f5f63bdc2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAzNjE4Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/10287#discussion_r463036186", "bodyText": "What if strlen(cmpbuf) == 0?", "author": "keithc-ca", "createdAt": "2020-07-30T14:26:30Z", "path": "runtime/tests/port/si.c", "diffHunk": "@@ -1855,17 +1858,40 @@ j9sysinfo_test_get_cwd3(struct J9PortLibrary *portLibrary)\n \t\t\toutputErrorMessage(PORTTEST_ERROR_ARGS, \"error failed to change current directory rc: %d\\n\", rc);\n \t}\n #else /* defined(WIN32) */\n-#if defined(OSX)\n-\tconst char *utf8 = \"/private/tmp/j9sysinfo_test_get_cwd3/\";\n-#else /* defined(OSX) */\n-\tconst char *utf8 = \"/tmp/j9sysinfo_test_get_cwd3/\";\n-#endif /* defined(OSX) */\n+\tconst char *tmp = \"/tmp/\";\n+\tconst char *utf8 = \"j9sysinfo_test_get_cwd3/\";\n \n \treportTestEntry(portLibrary, testName);\n \n \torig_cwd = (char*)j9mem_allocate_memory( EsMaxPath, OMRMEM_CATEGORY_PORT_LIBRARY );\n \tj9sysinfo_get_cwd(orig_cwd, EsMaxPath);\n \n+\t/* /tmp may be a symlink or similar, get it's actual path first */\n+#if defined(J9ZOS390)\n+\trc = atoe_chdir(tmp);\n+#else /* defined(J9ZOS390) */\n+\trc = chdir(tmp);\n+#endif /* defined(J9ZOS390) */\n+\tif (0 != rc) {\n+\t\toutputErrorMessage(PORTTEST_ERROR_ARGS, \"cd %s failed rc: %d\\n\", tmp, rc);\n+\t} else {\n+\t\toutputComment(portLibrary, \"cd %s\\n\", tmp);\n+\t}\n+\t\n+\tcmpbuf = (char*)j9mem_allocate_memory( EsMaxPath, OMRMEM_CATEGORY_PORT_LIBRARY );\n+\n+\trc = j9sysinfo_get_cwd(cmpbuf, EsMaxPath);\n+\tif (0 != rc) {\n+\t\toutputErrorMessage(PORTTEST_ERROR_ARGS, \"error failed to get current working directory rc: %d\\n\", rc);\n+\t} else {\n+\t\toutputComment(PORTLIB, \"CWD = %s\\n\", cmpbuf);\n+\t}\n+\tif ('/' != cmpbuf[strlen(cmpbuf) - 1]) {", "originalCommit": "6772cda75a82f4915bc49ea7afef7b5f5f63bdc2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAzNzgxNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10287#discussion_r463037816", "bodyText": "It would help if this message included the actual and expected directories.", "author": "keithc-ca", "createdAt": "2020-07-30T14:28:42Z", "path": "runtime/tests/port/si.c", "diffHunk": "@@ -1893,7 +1919,7 @@ j9sysinfo_test_get_cwd3(struct J9PortLibrary *portLibrary)\n \t\toutputComment(PORTLIB, \"CWD = %s\\n\", buffer);\n \t}\n \n-\trc = memcmp(utf8, buffer, strlen(buffer));\n+\trc = memcmp(cmpbuf, buffer, strlen(buffer));\n \tif (0 != rc) {\n \t\toutputErrorMessage(PORTTEST_ERROR_ARGS, \"invalid directory rc: %d\\n\", rc);", "originalCommit": "6772cda75a82f4915bc49ea7afef7b5f5f63bdc2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA5MDc5Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10287#discussion_r463090793", "bodyText": "They are printed by previous statements.", "author": "pshipton", "createdAt": "2020-07-30T15:42:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAzNzgxNg=="}], "type": "inlineReview"}, {"oid": "dcf3d66291f6b62d53975bb9b2633f018721a055", "url": "https://github.com/eclipse-openj9/openj9/commit/dcf3d66291f6b62d53975bb9b2633f018721a055", "message": "Fix sysinfo_test_get_cwd3 to handle symlinks\n\nOn z/OS the /tmp directory is typically found under /SYSTEM. On OSX,\nunder /private. Rather than hard coding assumptions, update the test to\ndetermine the location of /tmp dynamically.\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-07-30T16:21:34Z", "type": "commit"}, {"oid": "dcf3d66291f6b62d53975bb9b2633f018721a055", "url": "https://github.com/eclipse-openj9/openj9/commit/dcf3d66291f6b62d53975bb9b2633f018721a055", "message": "Fix sysinfo_test_get_cwd3 to handle symlinks\n\nOn z/OS the /tmp directory is typically found under /SYSTEM. On OSX,\nunder /private. Rather than hard coding assumptions, update the test to\ndetermine the location of /tmp dynamically.\n\nSigned-off-by: Peter Shipton <Peter_Shipton@ca.ibm.com>", "committedDate": "2020-07-30T16:21:34Z", "type": "forcePushed"}]}