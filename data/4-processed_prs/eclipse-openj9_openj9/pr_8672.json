{"pr_number": 8672, "pr_title": "AArch64: Fix for monitorEnter/monitorExit snippets", "pr_createdAt": "2020-02-27T05:22:39Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/8672", "timeline": [{"oid": "05d9de855c59a2ea9ea91f5dd3bc1a0359f43a46", "url": "https://github.com/eclipse-openj9/openj9/commit/05d9de855c59a2ea9ea91f5dd3bc1a0359f43a46", "message": "AArch64: Fix for monitorEnter/monitorExit snippets\n\nThis code fixes the code generation of monitorEnter/monitorExit\nsnippets for AArch64.  Encoding of the immediate value for the\nandimmx instruction was wrong.\n\nAlso fixing some typos.\n\nSigned-off-by: KONNO Kazuhiro <konno@jp.ibm.com>", "committedDate": "2020-02-27T05:55:26Z", "type": "forcePushed"}, {"oid": "22faf7971cc3c008442f256274c8e97ae12a1044", "url": "https://github.com/eclipse-openj9/openj9/commit/22faf7971cc3c008442f256274c8e97ae12a1044", "message": "AArch64: Fix for monitorEnter/monitorExit snippets\n\nThis code fixes the code generation of monitorEnter/monitorExit\nsnippets for AArch64.  Encoding of the immediate value for the\nandimmx instruction was wrong.\n\nAlso fixing some typos.\n\nSigned-off-by: KONNO Kazuhiro <konno@jp.ibm.com>", "committedDate": "2020-02-27T07:39:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ1NTA3MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8672#discussion_r385455071", "bodyText": "ppc uses ~OBJECT_HEADER_LOCK_RECURSION_MASK which is ~0xF8 for masking.\nhttps://github.com/eclipse/openj9/blob/944f9dd6edf869c6409db6ba367a360cad0dbee7/runtime/compiler/p/codegen/J9TreeEvaluator.cpp#L5925-L5948", "author": "Akira1Saitoh", "createdAt": "2020-02-28T00:54:54Z", "path": "runtime/compiler/aarch64/codegen/J9ARM64Snippet.cpp", "diffHunk": "@@ -74,7 +74,7 @@ TR::ARM64MonitorEnterSnippet::emitSnippetBody()\n    *(int32_t *)buffer = TR::InstOpCode::getOpCodeBinaryEncoding(TR::InstOpCode::andimmx);\n    tempReg->setRegisterFieldRD((uint32_t *)buffer);\n    dataReg->setRegisterFieldRN((uint32_t *)buffer);\n-   *(int32_t *)buffer |= 0x196000; // immr=25, imms=24 for 0xFFFFFF80\n+   *(int32_t *)buffer |= 0x79E000; // immr=57, imms=56 for 0xFFFFFFFFFFFFFF80", "originalCommit": "22faf7971cc3c008442f256274c8e97ae12a1044", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ4MzExMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8672#discussion_r385483110", "bodyText": "Thank you for pointing that out.\nThe monitorExit side has to use ~OBJECT_HEADER_LOCK_RECURSION_MASK (= ~0xF8) while the monitorEnter side uses ~0x7F.\nUpdated the code.", "author": "knn-k", "createdAt": "2020-02-28T02:49:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ1NTA3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ4NzgzNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8672#discussion_r385487834", "bodyText": "In monitorEnter, 32-bit ARM uses ~(OBJECT_HEADER_LOCK_BITS_MASK - OBJECT_HEADER_LOCK_LAST_RECURSION_BIT), which is ~0x7F.\nPower uses LOCK_THREAD_PTR_AND_UPPER_COUNT_BIT_MASK there, which is defined as (LOCK_THREAD_PTR_MASK | OBJECT_HEADER_LOCK_LAST_RECURSION_BIT) = ~0xFF | 0x80.\nIt is confusing, but both resulting in the same mask value.", "author": "knn-k", "createdAt": "2020-02-28T03:12:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ1NTA3MQ=="}], "type": "inlineReview"}, {"oid": "9746a65575bd6995b065ed386bacbfa6cc3d1a26", "url": "https://github.com/eclipse-openj9/openj9/commit/9746a65575bd6995b065ed386bacbfa6cc3d1a26", "message": "AArch64: Fix for monitorEnter/monitorExit snippets\n\nThis code fixes the code generation of monitorEnter/monitorExit\nsnippets for AArch64.\n\n- Encoding of the immediate value for the andimmx instruction was wrong\n- The mask used in monitorExit was wrong\n\nAlso fixing some typos.\n\nSigned-off-by: KONNO Kazuhiro <konno@jp.ibm.com>", "committedDate": "2020-02-28T02:40:09Z", "type": "forcePushed"}, {"oid": "60400e1625624be9cb5b847b131ea3c6e921f4c3", "url": "https://github.com/eclipse-openj9/openj9/commit/60400e1625624be9cb5b847b131ea3c6e921f4c3", "message": "AArch64: Fix for monitorEnter/monitorExit snippets\n\nThis code fixes the code generation of monitorEnter/monitorExit\nsnippets for AArch64.\n\n- Encoding of the immediate value for the andimmx instruction was wrong\n- The mask used in monitorExit was wrong\n\nAlso fixing some typos.\n\nSigned-off-by: KONNO Kazuhiro <konno@jp.ibm.com>", "committedDate": "2020-02-28T02:51:02Z", "type": "commit"}, {"oid": "60400e1625624be9cb5b847b131ea3c6e921f4c3", "url": "https://github.com/eclipse-openj9/openj9/commit/60400e1625624be9cb5b847b131ea3c6e921f4c3", "message": "AArch64: Fix for monitorEnter/monitorExit snippets\n\nThis code fixes the code generation of monitorEnter/monitorExit\nsnippets for AArch64.\n\n- Encoding of the immediate value for the andimmx instruction was wrong\n- The mask used in monitorExit was wrong\n\nAlso fixing some typos.\n\nSigned-off-by: KONNO Kazuhiro <konno@jp.ibm.com>", "committedDate": "2020-02-28T02:51:02Z", "type": "forcePushed"}]}