{"pr_number": 9973, "pr_title": "Do not enter class segment mutex inside read mutex", "pr_createdAt": "2020-06-22T15:24:14Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/9973", "timeline": [{"oid": "e6ab26f6599b7db8b51767312d4dc13a60f1ebf1", "url": "https://github.com/eclipse-openj9/openj9/commit/e6ab26f6599b7db8b51767312d4dc13a60f1ebf1", "message": "Do not enter class segment mutex inside read mutex\n\nWe always update the romclass segment at the end of\nSH_CacheMap:findROMClass() if a class is returned. There is no \nneed to update romclass segment in other places in findROMClass().\n\nFixes #9893\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>", "committedDate": "2020-06-22T15:25:02Z", "type": "forcePushed"}, {"oid": "7934efe4b73b20b6294bb2f502f00e0e98255538", "url": "https://github.com/eclipse-openj9/openj9/commit/7934efe4b73b20b6294bb2f502f00e0e98255538", "message": "Do not enter class segment mutex inside read mutex\n\nWe always update the romclass segment at the end of\nSH_CacheMap:findROMClass() if a class is returned. There is no \nneed to update romclass segment in other places in findROMClass().\n\nFixes #9893\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>", "committedDate": "2020-06-22T15:26:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcyMDE5NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9973#discussion_r443720194", "bodyText": "Since the code is modified, the constant here and the next change should be on the left.", "author": "pshipton", "createdAt": "2020-06-22T17:35:02Z", "path": "runtime/shared_common/CacheMap.cpp", "diffHunk": "@@ -1775,21 +1774,8 @@ SH_CacheMap::runEntryPointChecks(J9VMThread* currentThread, void* address, const\n \t\t\t}\n \t\t}\n \t}\n-\t\n-\tif (!hasClassSegmentMutex) {\n-\t\tif (acquireClassSegmentMutex) {\n-\t\t\tTrc_SHR_Assert_False(_ccHead->hasWriteMutex(currentThread));\n-\t\t\tenterLocalMutex(currentThread, currentThread->javaVM->classMemorySegments->segmentMutex, \"class segment mutex\", \"CM runEntryPointChecks\");\n-\t\t\tclassSegmentMutexAcquired = true;\n-\t\t\thasClassSegmentMutex = true;\n-\t\t}\n-\t}\n-\titemsAdded = refreshHashtables(currentThread, hasClassSegmentMutex);\n-\tif (classSegmentMutexAcquired) {\n-\t\texitLocalMutex(currentThread, currentThread->javaVM->classMemorySegments->segmentMutex, \"class segment mutex\", \"CM runEntryPointChecks\");\n-\t}\n \n-\tif (-1 == itemsAdded) {\n+\tif ((itemsAdded = refreshHashtables(currentThread, hasClassSegmentMutex)) == -1) {", "originalCommit": "7934efe4b73b20b6294bb2f502f00e0e98255538", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzczMTI2Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9973#discussion_r443731267", "bodyText": "Fixed.", "author": "hangshao0", "createdAt": "2020-06-22T17:55:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcyMDE5NA=="}], "type": "inlineReview"}, {"oid": "dce7cb330206829e92f5fa623fb324ffb6fcdaf7", "url": "https://github.com/eclipse-openj9/openj9/commit/dce7cb330206829e92f5fa623fb324ffb6fcdaf7", "message": "Do not enter class segment mutex inside read mutex\n\nWe always update the romclass segment at the end of\nSH_CacheMap:findROMClass() if a class is returned. There is no \nneed to update romclass segment in other places in findROMClass().\n\nFixes #9893\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>", "committedDate": "2020-06-22T17:54:37Z", "type": "commit"}, {"oid": "dce7cb330206829e92f5fa623fb324ffb6fcdaf7", "url": "https://github.com/eclipse-openj9/openj9/commit/dce7cb330206829e92f5fa623fb324ffb6fcdaf7", "message": "Do not enter class segment mutex inside read mutex\n\nWe always update the romclass segment at the end of\nSH_CacheMap:findROMClass() if a class is returned. There is no \nneed to update romclass segment in other places in findROMClass().\n\nFixes #9893\n\nSigned-off-by: Hang Shao <hangshao@ca.ibm.com>", "committedDate": "2020-06-22T17:54:37Z", "type": "forcePushed"}]}