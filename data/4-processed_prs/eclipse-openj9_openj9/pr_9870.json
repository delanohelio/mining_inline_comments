{"pr_number": 9870, "pr_title": "Modified printJITServerMsgStats to print at shutdown on server", "pr_createdAt": "2020-06-12T21:27:06Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/9870", "timeline": [{"oid": "7501f63bbddb3f95c219403577ea49afe245a439", "url": "https://github.com/eclipse-openj9/openj9/commit/7501f63bbddb3f95c219403577ea49afe245a439", "message": "Modified printJITServerMsgStats to print at shutdown on server\n\nTo trigger the jitDump use the option -Xdump:jit:events=user from the server side\nand then run the Java client and then  kill -3 <pidof jitserver>. This will print\nthe message stats received by the server at shutdown.\nissue: #9708\n\nSigned-off-by: Eman Elsabban <eman.elsaban1@gmail.com>", "committedDate": "2020-06-12T21:28:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU4MjM3OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9870#discussion_r441582379", "bodyText": "If MESSAGE_SIZE_STATS is not defined, the for loop above will go over all the messages, but print nothing and at the very end it will print \"Total number of messages: 0\"\nI would include the for loop and this last printf message into the block protected by ifdef.\nAlso, add a comment to the #endif so that we know what should be paired with:\n#if defined(MESSAGE_SIZE_STATS)\n...\n#endif // defined(MESSAGE_SIZE_STATS)", "author": "mpirvu", "createdAt": "2020-06-17T14:19:51Z", "path": "runtime/compiler/control/JITServerHelpers.cpp", "diffHunk": "@@ -121,33 +121,56 @@ JITServerHelpers::insertIntoOOSequenceEntryList(ClientSessionData *clientData, T\n    }\n \n void\n-JITServerHelpers::printJITServerMsgStats(J9JITConfig *jitConfig)\n+JITServerHelpers::printJITServerMsgStats(J9JITConfig *jitConfig, TR::CompilationInfo *compInfo)\n    {\n-   int totalMsgCount = 0;\t   \n+   unsigned totalMsgCount = 0;\t   \n    PORT_ACCESS_FROM_JITCONFIG(jitConfig);\n    j9tty_printf(PORTLIB, \"JITServer Message Type Statistics:\\n\");\n    j9tty_printf(PORTLIB, \"Type# #called\");\n-#ifdef MESSAGE_SIZE_STATS\n+#ifdef MESSAGE_SIZE_STATS  \n    j9tty_printf(PORTLIB, \"\\t\\tMax\\t\\tMin\\t\\tMean\\t\\tStdDev\\t\\tSum\");\n #endif\n    j9tty_printf(PORTLIB, \"\\t\\tTypeName\\n\");\n-   for (int i = 0; i < JITServer::MessageType_ARRAYSIZE; ++i)\n+   if (compInfo->getPersistentInfo()->getRemoteCompilationMode() == JITServer::CLIENT)\n       {\n-      if (JITServerHelpers::serverMsgTypeCount[i] > 0)\n+      for (int i = 0; i < JITServer::MessageType_ARRAYSIZE; ++i)\n          {\n-         j9tty_printf(PORTLIB, \"#%04d %7u\", i, JITServerHelpers::serverMsgTypeCount[i]);\n+         if (JITServerHelpers::serverMsgTypeCount[i] > 0)\n+            {\n+            j9tty_printf(PORTLIB, \"#%04d %7u\", i, JITServerHelpers::serverMsgTypeCount[i]);\n #ifdef MESSAGE_SIZE_STATS            \n-         j9tty_printf(PORTLIB, \"\\t%f\\t%f\\t%f\\t%f\\t%f\", JITServer::CommunicationStream::collectMsgStat[i].maxVal(), \n+            j9tty_printf(PORTLIB, \"\\t%f\\t%f\\t%f\\t%f\\t%f\", JITServer::CommunicationStream::collectMsgStat[i].maxVal(), \n                      JITServer::CommunicationStream::collectMsgStat[i].minVal(), JITServer::CommunicationStream::collectMsgStat[i].mean(),\n                      JITServer::CommunicationStream::collectMsgStat[i].stddev(), JITServer::CommunicationStream::collectMsgStat[i].sum());\n #endif\n-         j9tty_printf(PORTLIB, \"\\t\\t%s\\n\", JITServer::messageNames[i]);\n-         totalMsgCount += JITServerHelpers::serverMsgTypeCount[i];\n+            j9tty_printf(PORTLIB, \"\\t\\t%s\\n\", JITServer::messageNames[i]);\n+            totalMsgCount += JITServerHelpers::serverMsgTypeCount[i];\n+            }\n          }\n+      if (JITServerHelpers::serverMsgTypeCount[0])\n+         j9tty_printf(PORTLIB, \"Total number of messages: %d. Average number of messages per compilation:%f\\n\", totalMsgCount, totalMsgCount/float(JITServerHelpers::serverMsgTypeCount[0]));\n       }\n-   if (JITServerHelpers::serverMsgTypeCount[0])\n-       j9tty_printf(PORTLIB, \"Total number of messages: %d. Average number of messages per compilation:%f\\n\", totalMsgCount, totalMsgCount/float(JITServerHelpers::serverMsgTypeCount[0]));\n+   else if (compInfo->getPersistentInfo()->getRemoteCompilationMode() == JITServer::SERVER)\n+      {\n+      // to print in server, run ./jitserver -Xdump:jit:events=user\n+      // then kill -3 <pidof jitserver>\n+      for (int i = 0; i < JITServer::MessageType_ARRAYSIZE; ++i)\n+         {\n+#ifdef MESSAGE_SIZE_STATS  \n+         if (JITServer::CommunicationStream::collectMsgStat[i].samples() > 0)\n+            { \n+            j9tty_printf(PORTLIB, \"#%04d %7u\", i, JITServer::CommunicationStream::collectMsgStat[i].samples());            \n+            j9tty_printf(PORTLIB, \"\\t%f\\t%f\\t%f\\t%f\\t%f\", JITServer::CommunicationStream::collectMsgStat[i].maxVal(), \n+                     JITServer::CommunicationStream::collectMsgStat[i].minVal(), JITServer::CommunicationStream::collectMsgStat[i].mean(),\n+                     JITServer::CommunicationStream::collectMsgStat[i].stddev(), JITServer::CommunicationStream::collectMsgStat[i].sum());\n \n+            j9tty_printf(PORTLIB, \"\\t\\t%s\\n\", JITServer::messageNames[i]);\n+            totalMsgCount += JITServer::CommunicationStream::collectMsgStat[i].samples();\n+#endif\n+            }\n+         }\n+      j9tty_printf(PORTLIB, \"Total number of messages: %u\\n\", totalMsgCount);", "originalCommit": "7501f63bbddb3f95c219403577ea49afe245a439", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "facc2a4f131c7ed906ed67bbf98f722c0cec73c7", "url": "https://github.com/eclipse-openj9/openj9/commit/facc2a4f131c7ed906ed67bbf98f722c0cec73c7", "message": "Modified printJITServerMsgStats to print at shutdown on server\n\nTo trigger the jitDump use the option -Xdump:jit:events=user from the server side\nand then run the Java client and then  kill -3 <pidof jitserver>. This will print\nthe message stats received by the server at shutdown.\nissue: #9708\n\nSigned-off-by: Eman Elsabban <eman.elsaban1@gmail.com>", "committedDate": "2020-06-17T15:36:08Z", "type": "commit"}, {"oid": "facc2a4f131c7ed906ed67bbf98f722c0cec73c7", "url": "https://github.com/eclipse-openj9/openj9/commit/facc2a4f131c7ed906ed67bbf98f722c0cec73c7", "message": "Modified printJITServerMsgStats to print at shutdown on server\n\nTo trigger the jitDump use the option -Xdump:jit:events=user from the server side\nand then run the Java client and then  kill -3 <pidof jitserver>. This will print\nthe message stats received by the server at shutdown.\nissue: #9708\n\nSigned-off-by: Eman Elsabban <eman.elsaban1@gmail.com>", "committedDate": "2020-06-17T15:36:08Z", "type": "forcePushed"}]}