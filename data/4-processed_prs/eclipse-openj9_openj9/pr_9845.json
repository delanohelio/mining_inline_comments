{"pr_number": 9845, "pr_title": "Ensure enough space is allocated for the unique cache id", "pr_createdAt": "2020-06-10T22:15:35Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/9845", "timeline": [{"oid": "d221f0258f29e1ebd0a4b0f8984a8a3346aa5450", "url": "https://github.com/eclipse-openj9/openj9/commit/d221f0258f29e1ebd0a4b0f8984a8a3346aa5450", "message": "Don't compute the cache unique id for layer 0\n\n* fix J9SHR_UNIQUE_CACHE_ID_BUFSIZE - it was too small\n\n* use a format with fixed field widths so the length of the unique id\n  does not depend on things like the length of the lower layer cache\n  file\n\n* use return value of generateCacheUniqueID() instead of using strlen()\n\nSigned-off-by: Keith W. Campbell <keithc@ca.ibm.com>", "committedDate": "2020-06-16T17:57:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA1OTc5Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/9845#discussion_r441059796", "bodyText": "\"We don't need to compute the cache id for layer 0\" should be:\n\"We don't need to compute the cache id for the top layer\".\nThe cache ID is needed only by its higher layer. Top layer does not have a higher layer, so no need to compute cache id for the top layer.", "author": "hangshao0", "createdAt": "2020-06-16T18:30:49Z", "path": "runtime/shared_common/CompositeCache.cpp", "diffHunk": "@@ -1711,7 +1711,8 @@ SH_CompositeCacheImpl::startup(J9VMThread* currentThread, J9SharedClassPreinitCo\n \t}\n \tif (rc == CC_STARTUP_OK) {\n \t\t_started = true;\n-\t\tif (NULL == cacheMemory) {\n+\t\t/* We don't need to compute the cache id for layer 0. */", "originalCommit": "d221f0258f29e1ebd0a4b0f8984a8a3346aa5450", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA2NDQ3NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9845#discussion_r441064474", "bodyText": "Your earlier comments left me with the understanding that a layer stores the unique id of the layer below it. A layer 0 cache has no layers below it and so doesn't need to compute or store an id. At one point I had the test 0 != _layer, but changed it after re-reading your advice to test NULL != _previous.", "author": "keithc-ca", "createdAt": "2020-06-16T18:38:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA1OTc5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA2OTA0Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/9845#discussion_r441069046", "bodyText": "a layer stores the unique id of the below it. A layer 0 cache has no layers below it\n\nThis is correct.\n\nso doesn't need to compute or store an id.\n\nThe layer 0 does not store an id. But the cache id of layer 0 may need to be computed.\nIf there is a layer 1, the cache unique ID of layer 0 needs to be computed, and stored in layer 1.\nIf there is no layer 1, layer 0 is the top layer. There is no need to compute or stored id of layer 0.", "author": "hangshao0", "createdAt": "2020-06-16T18:47:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA1OTc5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA2MTExOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9845#discussion_r441061119", "bodyText": "J9SHR_UNIQUE_CACHE_ID_BUFSIZE or J9SHR_CACHE_UNIQUE_ID_BUFSIZE ? The function name is generateCacheUniqueID", "author": "hangshao0", "createdAt": "2020-06-16T18:33:09Z", "path": "runtime/shared_common/CacheMap.hpp", "diffHunk": "@@ -39,7 +39,18 @@\n #define CM_CACHE_CORRUPT -2\n #define CM_CACHE_STORE_PREREQ_ID_FAILED -3\n \n-#define J9SHR_UNIQUE_CACHE_ID_BUFSIZE  (J9SH_MAXPATH + 35)\n+/*\n+ * The maximum width of the hexadecimal representation of a value of type 'T'.\n+ */\n+#define J9HEX_WIDTH(T) (2 * sizeof(T))\n+\n+/*\n+ * A unique cache id is a path followed by six hexadecimal values,\n+ * the first two of which express 64-bits values and the remaining\n+ * four express UDATA values. Additionally, there are six separator\n+ * characters and a terminating NUL character.\n+ */\n+#define J9SHR_UNIQUE_CACHE_ID_BUFSIZE (J9SH_MAXPATH + (2 * J9HEX_WIDTH(U_64)) + (4 * J9HEX_WIDTH(UDATA)) + 6 + 1)", "originalCommit": "d221f0258f29e1ebd0a4b0f8984a8a3346aa5450", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA2NDcxMQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9845#discussion_r441064711", "bodyText": "I didn't change the name of the macro, just its value.", "author": "keithc-ca", "createdAt": "2020-06-16T18:39:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA2MTExOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA2NjMzMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/9845#discussion_r441066332", "bodyText": "Ah, I see.", "author": "hangshao0", "createdAt": "2020-06-16T18:42:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA2MTExOQ=="}], "type": "inlineReview"}, {"oid": "773f6c86d99df63c98f71c0d368eccbdf7d613be", "url": "https://github.com/eclipse-openj9/openj9/commit/773f6c86d99df63c98f71c0d368eccbdf7d613be", "message": "Don't compute the cache unique id for the top layer\n\n* fix J9SHR_UNIQUE_CACHE_ID_BUFSIZE - it was too small\n\n* use a format with fixed field widths so the length of the unique id\n  does not depend on things like the length of the lower layer cache\n  file\n\n* use return value of generateCacheUniqueID() instead of using strlen()\n\nSigned-off-by: Keith W. Campbell <keithc@ca.ibm.com>", "committedDate": "2020-06-16T18:54:14Z", "type": "commit"}, {"oid": "773f6c86d99df63c98f71c0d368eccbdf7d613be", "url": "https://github.com/eclipse-openj9/openj9/commit/773f6c86d99df63c98f71c0d368eccbdf7d613be", "message": "Don't compute the cache unique id for the top layer\n\n* fix J9SHR_UNIQUE_CACHE_ID_BUFSIZE - it was too small\n\n* use a format with fixed field widths so the length of the unique id\n  does not depend on things like the length of the lower layer cache\n  file\n\n* use return value of generateCacheUniqueID() instead of using strlen()\n\nSigned-off-by: Keith W. Campbell <keithc@ca.ibm.com>", "committedDate": "2020-06-16T18:54:14Z", "type": "forcePushed"}]}