{"pr_number": 10697, "pr_title": "Mask off unused cpu features", "pr_createdAt": "2020-09-24T21:51:28Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10697", "timeline": [{"oid": "9ffc98d69b92f8db48584e3c87514bce5c15240b", "url": "https://github.com/eclipse-openj9/openj9/commit/9ffc98d69b92f8db48584e3c87514bce5c15240b", "message": "Add mechanisms to disable unexploited features\n\nThe mechanism will assert if it detects usage of a disabled feature.\nThis will effectively prevent us from accidentally disabling an exploited feature.\n\nIssue: #10683\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-09-24T21:54:02Z", "type": "forcePushed"}, {"oid": "a88e0ca505e5018dd8444af19e64e590f64c7299", "url": "https://github.com/eclipse-openj9/openj9/commit/a88e0ca505e5018dd8444af19e64e590f64c7299", "message": "Add mechanisms to disable unexploited features\n\nThe mechanism will assert if it detects usage of a disabled feature.\nThis will effectively prevent us from accidentally disabling an exploited feature.\n\nIssue: #10683\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-09-24T22:09:27Z", "type": "forcePushed"}, {"oid": "50ed62f16bb8626dd3ab60ee1e4ced193a730471", "url": "https://github.com/eclipse-openj9/openj9/commit/50ed62f16bb8626dd3ab60ee1e4ced193a730471", "message": "Add mechanisms to disable unexploited features\n\nThe mechanism will assert if it detects usage of a disabled feature.\nThis will effectively prevent us from accidentally disabling an exploited feature.\n\nIssue: #10683\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-09-25T16:22:49Z", "type": "forcePushed"}, {"oid": "8506493ffd1add6653155ae371d918c87d9b3c75", "url": "https://github.com/eclipse-openj9/openj9/commit/8506493ffd1add6653155ae371d918c87d9b3c75", "message": "Add mechanisms to disable unexploited features\n\nThe mechanism will assert if it detects usage of a disabled feature.\nThis will effectively prevent us from accidentally disabling an exploited feature.\n\nIssue: #10683\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-09-25T16:30:30Z", "type": "forcePushed"}, {"oid": "bac0108e169bab31c6dc8656ee2bc95c4a3f78cc", "url": "https://github.com/eclipse-openj9/openj9/commit/bac0108e169bab31c6dc8656ee2bc95c4a3f78cc", "message": "Add mechanisms to disable unexploited features\n\nThe mechanism will assert if it detects usage of a disabled feature.\nThis will effectively prevent us from accidentally disabling an exploited feature.\n\nIssue: #10683\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-09-25T16:32:39Z", "type": "forcePushed"}, {"oid": "cdb8776994e1e658ae1e04aa0f3c75233332fe9e", "url": "https://github.com/eclipse-openj9/openj9/commit/cdb8776994e1e658ae1e04aa0f3c75233332fe9e", "message": "Add mechanisms to disable unexploited features\n\nThe mechanism will assert if it detects usage of a disabled feature.\nThis will effectively prevent us from accidentally disabling an exploited feature.\n\nIssue: #10683\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-09-25T16:35:27Z", "type": "forcePushed"}, {"oid": "c7db8e200d4a3ad1acbfed9b5eae08b2295e4ad7", "url": "https://github.com/eclipse-openj9/openj9/commit/c7db8e200d4a3ad1acbfed9b5eae08b2295e4ad7", "message": "Add mechanisms to disable unexploited features\n\nThe mechanism will assert if it detects usage of a disabled feature.\nThis will effectively prevent us from accidentally disabling an exploited feature.\n\nIssue: #10683\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-09-25T16:46:34Z", "type": "forcePushed"}, {"oid": "e93094b4c40471d60b6cc7c298b89135d5313b36", "url": "https://github.com/eclipse-openj9/openj9/commit/e93094b4c40471d60b6cc7c298b89135d5313b36", "message": "Add mechanisms to disable unexploited features\n\nThe mechanism will assert if it detects usage of a disabled feature.\nThis will effectively prevent us from accidentally disabling an exploited feature.\n\nIssue: #10683\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-09-25T17:36:49Z", "type": "forcePushed"}, {"oid": "004837e78c4f68458393343216356d4a97875778", "url": "https://github.com/eclipse-openj9/openj9/commit/004837e78c4f68458393343216356d4a97875778", "message": "Add mechanisms to disable unexploited features\n\nThe mechanism will assert if it detects usage of a disabled feature.\nThis will effectively prevent us from accidentally disabling an exploited feature.\n\nIssue: #10683\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-09-25T17:52:57Z", "type": "forcePushed"}, {"oid": "a06f0872f6a190b29270a79eccd9d5ae82f12ea8", "url": "https://github.com/eclipse-openj9/openj9/commit/a06f0872f6a190b29270a79eccd9d5ae82f12ea8", "message": "Add mechanisms to disable unexploited features\n\nThe mechanism will assert if it detects usage of a disabled feature.\nThis will effectively prevent us from accidentally disabling an exploited feature.\n\nIssue: #10683\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-09-25T17:57:28Z", "type": "forcePushed"}, {"oid": "599bf6fcdca3bb851351f26d2129d4368ea18a8b", "url": "https://github.com/eclipse-openj9/openj9/commit/599bf6fcdca3bb851351f26d2129d4368ea18a8b", "message": "debug 2", "committedDate": "2020-09-25T21:25:26Z", "type": "forcePushed"}, {"oid": "4d0b3066a6acf617b548cdf12fcd71d3371f93f8", "url": "https://github.com/eclipse-openj9/openj9/commit/4d0b3066a6acf617b548cdf12fcd71d3371f93f8", "message": "debug 2", "committedDate": "2020-09-25T21:28:38Z", "type": "forcePushed"}, {"oid": "baa95b00b9a398521f4a3dd35e84886257a9b7f7", "url": "https://github.com/eclipse-openj9/openj9/commit/baa95b00b9a398521f4a3dd35e84886257a9b7f7", "message": "Remove redundant cpu detection assertion tests\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-09-25T21:28:38Z", "type": "forcePushed"}, {"oid": "a251381bde18f953f5dd9007b68712d573ac6c92", "url": "https://github.com/eclipse-openj9/openj9/commit/a251381bde18f953f5dd9007b68712d573ac6c92", "message": "Remove redundant cpu detection assertion tests\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-09-26T00:05:32Z", "type": "forcePushed"}, {"oid": "dcaa137269b609bef309c9c917e70bb120657c1b", "url": "https://github.com/eclipse-openj9/openj9/commit/dcaa137269b609bef309c9c917e70bb120657c1b", "message": "Add mechanisms to disable unused cpu features\n\nThe mechanism will assert if it detects usage of a disabled feature.\nThis will effectively prevent us from accidentally disabling an exploited feature.\n\nIssue: #10683\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-09-28T19:10:51Z", "type": "forcePushed"}, {"oid": "6e33cf97cd15799432c6b23ec0f86a9d5a4f6612", "url": "https://github.com/eclipse-openj9/openj9/commit/6e33cf97cd15799432c6b23ec0f86a9d5a4f6612", "message": "Add mechanisms to disable unused cpu features\n\nThe mechanism will assert if it detects usage of a disabled feature.\nThis will effectively prevent us from accidentally disabling an exploited feature.\n\nIssue: #10683\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-09-28T20:04:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMxODYwNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10697#discussion_r496318606", "bodyText": "I would like some comments on the meaning of the parameters and what this function is supposed to do", "author": "mpirvu", "createdAt": "2020-09-29T01:13:21Z", "path": "runtime/compiler/env/J9CPU.hpp", "diffHunk": "@@ -45,12 +45,17 @@ class OMR_EXTENSIBLE CPU : public OMR::CPUConnector\n    CPU() : OMR::CPUConnector() {}\n    CPU(const OMRProcessorDesc& processorDescription) : OMR::CPUConnector(processorDescription) {}\n \n+   static OMRProcessorDesc _featureMasks;\n+   static bool _shouldUseFeatureMasks; \n+   static void applyFeatureMasks(OMRProcessorDesc& processorDescription, const uint32_t* enabledFeatures, size_t size); ", "originalCommit": "6e33cf97cd15799432c6b23ec0f86a9d5a4f6612", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMxODYxMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10697#discussion_r496318613", "bodyText": "In c++ initializing all elements wit 0 can be done with array[10] = {0} or even array[10]={}", "author": "mpirvu", "createdAt": "2020-09-29T01:13:22Z", "path": "runtime/compiler/env/J9CPU.cpp", "diffHunk": "@@ -28,8 +28,9 @@\n #include \"env/CompilerEnv.hpp\"\n #include \"env/CPU.hpp\"\n #include \"env/VMJ9.h\"\n-#include \"j9.h\"\n-#include \"j9port.h\"\n+\n+OMRProcessorDesc J9::CPU::_featureMasks = {OMR_PROCESSOR_UNDEFINED, OMR_PROCESSOR_UNDEFINED, {0, 0, 0, 0, 0}};", "originalCommit": "6e33cf97cd15799432c6b23ec0f86a9d5a4f6612", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMyMjYwNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10697#discussion_r496322604", "bodyText": "Note that statics are risky for multiple compilation threads and they usually don't work with JITServer", "author": "mpirvu", "createdAt": "2020-09-29T01:28:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMxODYxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMyMjAwNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10697#discussion_r496322006", "bodyText": "Since _featureMasks are reset and created in this routine just to be copied over to processorDescription why don't we declare the _featureMasks as a local in this function?", "author": "mpirvu", "createdAt": "2020-09-29T01:25:38Z", "path": "runtime/compiler/env/J9CPU.cpp", "diffHunk": "@@ -43,3 +44,29 @@ J9::CPU::getProcessorDescription()\n #endif /* defined(J9VM_OPT_JITSERVER) */\n    return _processorDescription;\n    }\n+\n+void\n+J9::CPU::applyFeatureMasks(OMRProcessorDesc& processorDescription, const uint32_t* enabledFeatures, size_t size)\n+   {\n+   OMRPORT_ACCESS_FROM_OMRPORT(TR::Compiler->omrPortLib);\n+   memset(_featureMasks.features, 0, OMRPORT_SYSINFO_FEATURES_SIZE*sizeof(uint32_t));", "originalCommit": "6e33cf97cd15799432c6b23ec0f86a9d5a4f6612", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc5Nzc3MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10697#discussion_r496797770", "bodyText": "The reason we don't declare _featureMasks as a local in this function is because _featureMasks will be repeatedly used by supportsFeature() to detect query to unused features (which is an illegal action).", "author": "harryyu1994", "createdAt": "2020-09-29T15:10:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMyMjAwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMyNTExOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10697#discussion_r496325119", "bodyText": "Note: if applyFeatureMasks can be executed by multiple threads, you cannot expect the features you set previously to remain set in the presence of multiple compilation threads.", "author": "mpirvu", "createdAt": "2020-09-29T01:37:28Z", "path": "runtime/compiler/env/J9CPU.cpp", "diffHunk": "@@ -43,3 +44,29 @@ J9::CPU::getProcessorDescription()\n #endif /* defined(J9VM_OPT_JITSERVER) */\n    return _processorDescription;\n    }\n+\n+void\n+J9::CPU::applyFeatureMasks(OMRProcessorDesc& processorDescription, const uint32_t* enabledFeatures, size_t size)\n+   {\n+   OMRPORT_ACCESS_FROM_OMRPORT(TR::Compiler->omrPortLib);\n+   memset(_featureMasks.features, 0, OMRPORT_SYSINFO_FEATURES_SIZE*sizeof(uint32_t));\n+   for (size_t i = 0; i < size; i++)\n+      {\n+      omrsysinfo_processor_set_feature(&_featureMasks, enabledFeatures[i], TRUE);\n+      }\n+   _shouldUseFeatureMasks = true;\n+   \n+   for (size_t i = 0; i < OMRPORT_SYSINFO_FEATURES_SIZE; i++)\n+      {\n+      processorDescription.features[i] &= _featureMasks.features[i];\n+      }\n+   }\n+\n+bool\n+J9::CPU::supportsFeature(uint32_t feature)\n+   {\n+   OMRPORT_ACCESS_FROM_OMRPORT(TR::Compiler->omrPortLib);\n+   if (_shouldUseFeatureMasks)\n+      TR_ASSERT_FATAL(TRUE == omrsysinfo_processor_has_feature(&_featureMasks, feature), \"new feature usage detected, please enable feature %d in TR::CPU::applyUserOptions()\\n\", feature);", "originalCommit": "6e33cf97cd15799432c6b23ec0f86a9d5a4f6612", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjgwMzQ3Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10697#discussion_r496803473", "bodyText": "applyFeatureMasks is supposed to be only executed once through applyUserOptions() on the TR::Compiler->target.cpu singleton. It's a helper function for applyUserOptions() and should not be used by the user directly.\nI don't like the design either but I have yet to come up with a better design.", "author": "harryyu1994", "createdAt": "2020-09-29T15:17:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMyNTExOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjgxMDc3MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10697#discussion_r496810770", "bodyText": "Maybe I should make _featureMasks into a member field for cpu. That way each cpu has their own _featureMasks which could make more sense. applyUserOptions() is executed once for each newly created cpu object post initialization.", "author": "harryyu1994", "createdAt": "2020-09-29T15:24:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMyNTExOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjgyMjc5MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10697#discussion_r496822791", "bodyText": "actually don't think _featureMasks into a member field is a good idea. Also I should separate out the static initialization of _featureMasks from applyUserOptions(). Initialization of _featureMasks should only happen once for the entire JVM while applyUserOptions() is performed on each cpu object.", "author": "harryyu1994", "createdAt": "2020-09-29T15:36:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjMyNTExOQ=="}], "type": "inlineReview"}, {"oid": "f409a7cb3b383c5a20e8a90d0949ae31f2e3b7f2", "url": "https://github.com/eclipse-openj9/openj9/commit/f409a7cb3b383c5a20e8a90d0949ae31f2e3b7f2", "message": "more changes", "committedDate": "2020-09-30T16:13:17Z", "type": "forcePushed"}, {"oid": "642f328ba6fe499c95dee7f6cea7a88f6a598a0b", "url": "https://github.com/eclipse-openj9/openj9/commit/642f328ba6fe499c95dee7f6cea7a88f6a598a0b", "message": "more changes", "committedDate": "2020-09-30T16:37:28Z", "type": "forcePushed"}, {"oid": "a5983ee192ab5fd4559d6297be3af811597ec2a4", "url": "https://github.com/eclipse-openj9/openj9/commit/a5983ee192ab5fd4559d6297be3af811597ec2a4", "message": "Remove redundant cpu detection assertion tests\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-09-30T21:02:40Z", "type": "commit"}, {"oid": "0e3403761cdabd011e9697838c4bdb9cc66eeb10", "url": "https://github.com/eclipse-openj9/openj9/commit/0e3403761cdabd011e9697838c4bdb9cc66eeb10", "message": "Add mechanisms to disable unused cpu features\n\nThe mechanism will assert if it detects usage of a disabled feature.\nThis will effectively prevent us from accidentally disabling an exploited feature.\n\nIssue: #10683\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-09-30T21:03:48Z", "type": "forcePushed"}, {"oid": "93de6d4c9b641e89f7e18b4a27eae03805e70e9b", "url": "https://github.com/eclipse-openj9/openj9/commit/93de6d4c9b641e89f7e18b4a27eae03805e70e9b", "message": "Add various improvements to TR::CPU class\n\n- Eliminate `applyUserOptions()`.\n  - Disassociate the options from `TR::CPU`.\n  - Issue with `applyUserOptions()` is that the options are not initialized when `TR::CPU` is initialized which means if the user calls `applyUserOptions()` at the incorrect place the options queries that it contains will either crash the program or not take effect. I want to eliminate this risk of incorrect usage.\n- Introduce new API called `TR::CPU::customize(OMRProcessorDesc processorDescription)`\n  - it's a static factory method that takes in an `OMRProcessorDesc` from user and output a `TR::CPU` object\n  - The design is that we do not give user to ability to modify the fields of TR::CPU object in place. You will need to go through a factory method to change TR::CPU. This makes it easier for us to keep track where TR::CPU is modified and eliminate any unintentional illegal TR::CPU modifications from user which can be disastrous.\n- Introduce new API called `TR::CPU::enableFeatureMasks()`\n  - You can turn on \"featureMasks\" support using this API\n  - Once \"featureMasks\" support is turned on, we will mask out all cpu features that are not used by the current compiler from the OMRProcessorDesc struct in TR::CPU which allows to do CPU compatibility checks for AOT more correctly\n  - For each platform, we keep track of the utilized cpu features inside `TR::CPU::enableFeatureMasks()`\n  - If developer utilizes a previously unused feature, they need to add it to `TR::CPU::enableFeatureMasks()`\n  - We have assert tests in place to detect queries to unused feature\n    - The purpose of this detection is to minimize the risk of masking out cpu features that are being used.\n- Guard cpu feature tests against old version cpu feature detection on x86 with an environment variable.\n- Summary of current design:\n  - `TR::CPU::detect(omrPortLib)`: static factory method that gives you the TR::CPU object based on port library\n  - `TR::CPU::customize(processorDescription)`: static factory method that gives you the TR::CPU object based on a processorDescription provided by user\n\nIssue: #10683\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-10-01T15:34:31Z", "type": "forcePushed"}, {"oid": "3da62521c64fb20d3e3e48ca3bc21d8bf278c07c", "url": "https://github.com/eclipse-openj9/openj9/commit/3da62521c64fb20d3e3e48ca3bc21d8bf278c07c", "message": "Add various improvements to TR::CPU class\n\n- Eliminate `applyUserOptions()`.\n  - Disassociate the options from `TR::CPU`.\n  - Issue with `applyUserOptions()` is that the options are not initialized when\n    `TR::CPU` is initialized which means if the user calls `applyUserOptions()`\n    at the incorrect place the options queries that it contains will either crash\n    the program or not take effect. I want to eliminate this risk of incorrect usage.\n- Introduce new API called `TR::CPU::customize(OMRProcessorDesc processorDescription)`\n  - it's a static factory method that takes in an `OMRProcessorDesc` from user and\n    output a `TR::CPU` object\n  - The design is that we do not give user to ability to modify the fields of TR::CPU\n    object in place. You will need to go through a factory method to change TR::CPU.\n    This makes it easier for us to keep track where TR::CPU is modified and eliminate\n    any unintentional illegal TR::CPU modifications from user which can be disastrous.\n- Introduce new API called `TR::CPU::enableFeatureMasks()`\n  - You can turn on \"featureMasks\" support using this API\n  - Once \"featureMasks\" support is turned on, we will mask out all cpu features that\n    are not used by the current compiler from the OMRProcessorDesc struct in TR::CPU\n    which allows to do CPU compatibility checks for AOT more correctly\n  - For each platform, we keep track of the utilized cpu features inside\n    `TR::CPU::enableFeatureMasks()`\n  - If developer utilizes a previously unused feature, they need to add it to\n    `TR::CPU::enableFeatureMasks()`\n  - We have assert tests in place to detect queries to unused feature\n    - The purpose of this detection is to minimize the risk of masking out cpu\n      features that are being used.\n- Guard cpu feature tests against old version cpu feature detection on x86 with an\n  environment variable.\n- Summary of current design:\n  - `TR::CPU::detect(omrPortLib)`: static factory method that gives you the TR::CPU\n    object based on port library\n  - `TR::CPU::customize(processorDescription)`: static factory method that gives you\n    the TR::CPU object based on a processorDescription provided by user\n\nIssue: #10683\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-10-01T15:38:40Z", "type": "commit"}, {"oid": "3da62521c64fb20d3e3e48ca3bc21d8bf278c07c", "url": "https://github.com/eclipse-openj9/openj9/commit/3da62521c64fb20d3e3e48ca3bc21d8bf278c07c", "message": "Add various improvements to TR::CPU class\n\n- Eliminate `applyUserOptions()`.\n  - Disassociate the options from `TR::CPU`.\n  - Issue with `applyUserOptions()` is that the options are not initialized when\n    `TR::CPU` is initialized which means if the user calls `applyUserOptions()`\n    at the incorrect place the options queries that it contains will either crash\n    the program or not take effect. I want to eliminate this risk of incorrect usage.\n- Introduce new API called `TR::CPU::customize(OMRProcessorDesc processorDescription)`\n  - it's a static factory method that takes in an `OMRProcessorDesc` from user and\n    output a `TR::CPU` object\n  - The design is that we do not give user to ability to modify the fields of TR::CPU\n    object in place. You will need to go through a factory method to change TR::CPU.\n    This makes it easier for us to keep track where TR::CPU is modified and eliminate\n    any unintentional illegal TR::CPU modifications from user which can be disastrous.\n- Introduce new API called `TR::CPU::enableFeatureMasks()`\n  - You can turn on \"featureMasks\" support using this API\n  - Once \"featureMasks\" support is turned on, we will mask out all cpu features that\n    are not used by the current compiler from the OMRProcessorDesc struct in TR::CPU\n    which allows to do CPU compatibility checks for AOT more correctly\n  - For each platform, we keep track of the utilized cpu features inside\n    `TR::CPU::enableFeatureMasks()`\n  - If developer utilizes a previously unused feature, they need to add it to\n    `TR::CPU::enableFeatureMasks()`\n  - We have assert tests in place to detect queries to unused feature\n    - The purpose of this detection is to minimize the risk of masking out cpu\n      features that are being used.\n- Guard cpu feature tests against old version cpu feature detection on x86 with an\n  environment variable.\n- Summary of current design:\n  - `TR::CPU::detect(omrPortLib)`: static factory method that gives you the TR::CPU\n    object based on port library\n  - `TR::CPU::customize(processorDescription)`: static factory method that gives you\n    the TR::CPU object based on a processorDescription provided by user\n\nIssue: #10683\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-10-01T15:38:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc2NjQ5NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10697#discussion_r499766495", "bodyText": "A better name for this is _supportedFeatureMasks", "author": "mpirvu", "createdAt": "2020-10-05T17:43:15Z", "path": "runtime/compiler/env/J9CPU.hpp", "diffHunk": "@@ -45,12 +45,43 @@ class OMR_EXTENSIBLE CPU : public OMR::CPUConnector\n    CPU() : OMR::CPUConnector() {}\n    CPU(const OMRProcessorDesc& processorDescription) : OMR::CPUConnector(processorDescription) {}\n \n+   /**\n+    * @brief Contain the list of processor features utlizied by the compiler, initialized via TR::CPU::initializeFeatureMasks()\n+    */\n+   static OMRProcessorDesc _featureMasks;", "originalCommit": "3da62521c64fb20d3e3e48ca3bc21d8bf278c07c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg0ODk5NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10697#discussion_r499848994", "bodyText": "This is not ideal. JITServer should obey exactly what the client tells it to do and not add any customization of its own.", "author": "mpirvu", "createdAt": "2020-10-05T20:20:20Z", "path": "runtime/compiler/control/CompilationThread.cpp", "diffHunk": "@@ -8514,7 +8514,7 @@ TR::CompilationInfoPerThreadBase::wrappedCompile(J9PortLibrary *portLib, void *\n          if (that->_methodBeingCompiled->isOutOfProcessCompReq())\n             {\n             OMRProcessorDesc JITClientProcessorDesc = TR::Compiler->target.cpu.getProcessorDescription();\n-            target.cpu = TR::CPU(JITClientProcessorDesc);\n+            target.cpu = TR::CPU::customize(JITClientProcessorDesc);", "originalCommit": "d90a2b1094af1e1ddd44002d720b3e78e001059d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg1MjU1OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10697#discussion_r499852559", "bodyText": "All customizations are contained in the input parameter JITClientProcessorDesc. JITServer is not doing anything extra.TR::CPU::customize() is essentially just a wrapped function guarding the constructor. The _featureMasks should be the same on JITClient and JITServer. It's a codebase setting that both JITClient and JITServer must be consistent with, therefore _featureMasks is not changing anything client wants.", "author": "harryyu1994", "createdAt": "2020-10-05T20:27:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg0ODk5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg1Njc3Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10697#discussion_r499856777", "bodyText": "The intent of _featureMasks is never to modify anything, it's a mask to turn off unnecessary bits so that we can do the compatibility check.\nFor example:\n            feature:           A B C D\n   underlying feature:      0b 1 0 0 1\nfeature mask:               0b  0 0 1 1\n(our compiler only uses feature C and D)\n      after applying mask:   0b 0 0 0 1\nWiping off feature A does not equal to disabling feature A. A is never used by our compiler so wiping it off has no effect.\nMaybe I should change the function names detect() and customize to just createCPU(). They just generate TR::CPU object for you based on different input.", "author": "harryyu1994", "createdAt": "2020-10-05T20:35:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg0ODk5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg1OTE1MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10697#discussion_r499859151", "bodyText": "target.cpu = TR::CPU::customize(JITClientProcessorDesc);\nmeans target.cpu has been customized to JITClientProcessorDesc.", "author": "harryyu1994", "createdAt": "2020-10-05T20:39:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg0ODk5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkwMTg4OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10697#discussion_r499901888", "bodyText": "ok. Thanks for the explanation. Maybe you should add as a comment:\n// Customize target.cpu based on the processor description fetched from the client\ntarget.cpu = TR::CPU::customize(JITClientProcessorDesc);", "author": "mpirvu", "createdAt": "2020-10-05T22:15:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg0ODk5NA=="}], "type": "inlineReview"}, {"oid": "a0a31bce37df45bf95e4d870a65887143b393e58", "url": "https://github.com/eclipse-openj9/openj9/commit/a0a31bce37df45bf95e4d870a65887143b393e58", "message": "Mark TR::CPU constructors protected\n\nForce users to use factory methods (\"TR::CPU::detect()\" and \"TR::CPU::customize()\")\nto construct TR::CPU() objects\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-10-05T21:14:06Z", "type": "forcePushed"}, {"oid": "2a5d0b883a72720f016b848ae8bfad36c1df1d3c", "url": "https://github.com/eclipse-openj9/openj9/commit/2a5d0b883a72720f016b848ae8bfad36c1df1d3c", "message": "Use TR::CPU factory methods instead of TR::CPU constructors\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-10-05T21:21:26Z", "type": "forcePushed"}, {"oid": "bd12a39886cf2a1d7f88dc70ee940c48f07d05aa", "url": "https://github.com/eclipse-openj9/openj9/commit/bd12a39886cf2a1d7f88dc70ee940c48f07d05aa", "message": "Rename _featureMasks to _supportedFeatureMasks\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-10-05T21:31:40Z", "type": "forcePushed"}, {"oid": "d32765bb793f9d50793f0667429bc5358be68f78", "url": "https://github.com/eclipse-openj9/openj9/commit/d32765bb793f9d50793f0667429bc5358be68f78", "message": "Rename _featureMasks to _supportedFeatureMasks\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-10-05T21:36:19Z", "type": "forcePushed"}, {"oid": "84d0268ca7c4cd377ed156477be6ea3442709063", "url": "https://github.com/eclipse-openj9/openj9/commit/84d0268ca7c4cd377ed156477be6ea3442709063", "message": "Rename _featureMasks to _supportedFeatureMasks\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-10-05T22:18:15Z", "type": "commit"}, {"oid": "eb132e7bad49d320de299e9582ef5188373ba562", "url": "https://github.com/eclipse-openj9/openj9/commit/eb132e7bad49d320de299e9582ef5188373ba562", "message": "Use TR::CPU factory methods instead of TR::CPU constructors\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-10-05T22:18:27Z", "type": "commit"}, {"oid": "eb132e7bad49d320de299e9582ef5188373ba562", "url": "https://github.com/eclipse-openj9/openj9/commit/eb132e7bad49d320de299e9582ef5188373ba562", "message": "Use TR::CPU factory methods instead of TR::CPU constructors\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-10-05T22:18:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkxNDg2Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10697#discussion_r499914862", "bodyText": "Typos: \"Contain\" --> \"Contains\", \"utlizied\" --> \"utilizied\"", "author": "mpirvu", "createdAt": "2020-10-05T22:53:46Z", "path": "runtime/compiler/env/J9CPU.hpp", "diffHunk": "@@ -45,12 +45,43 @@ class OMR_EXTENSIBLE CPU : public OMR::CPUConnector\n    CPU() : OMR::CPUConnector() {}\n    CPU(const OMRProcessorDesc& processorDescription) : OMR::CPUConnector(processorDescription) {}\n \n+   /**\n+    * @brief Contain the list of processor features utlizied by the compiler, initialized via TR::CPU::initializeFeatureMasks()", "originalCommit": "eb132e7bad49d320de299e9582ef5188373ba562", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkxNTExMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10697#discussion_r499915113", "bodyText": "Maybe replace \"utilizied\" with \"exploited\"", "author": "mpirvu", "createdAt": "2020-10-05T22:54:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkxNDg2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkxNjE3Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10697#discussion_r499916177", "bodyText": "I would replace \"Disable\" with \"Sets\".\nDo we actually look at user options? I thought this was done in another part of the code which you showed it to me.", "author": "mpirvu", "createdAt": "2020-10-05T22:57:55Z", "path": "runtime/compiler/env/J9CPU.hpp", "diffHunk": "@@ -45,12 +45,43 @@ class OMR_EXTENSIBLE CPU : public OMR::CPUConnector\n    CPU() : OMR::CPUConnector() {}\n    CPU(const OMRProcessorDesc& processorDescription) : OMR::CPUConnector(processorDescription) {}\n \n+   /**\n+    * @brief Contain the list of processor features utlizied by the compiler, initialized via TR::CPU::initializeFeatureMasks()\n+    */\n+   static OMRProcessorDesc _supportedFeatureMasks;\n+\n+   /**\n+    * @brief _isSupportedFeatureMasksEnabled tells you whether _supportedFeatureMasks was used for masking out unused processor features\n+    */\n+   static bool _isSupportedFeatureMasksEnabled;\n+\n public:\n \n+   /** \n+    * @brief Returns the processor type and features that will be used by JIT and AOT compilations\n+    * @param[in] omrPortLib : the port library\n+    * @return TR::CPU\n+    */\n+   static TR::CPU detect(OMRPortLibrary * const omrPortLib);\n+\n+   /** \n+    * @brief Disable processor features based on input processor description, user options and whether they are utilized by the compiler", "originalCommit": "eb132e7bad49d320de299e9582ef5188373ba562", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTk1ODY2Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/10697#discussion_r499958666", "bodyText": "We do not look at user options in \"TR::CPU::customize()\". And I agree that we should replace \"disable\" with \"set\".\nprocessor description contains two piece of information 1. processor type 2. processor features.\nThe only case that we disable processor features is on Z, when you downgrade your processor from say z14 to z10, there are a couple of features you need to disable. TR::CPU::customize() will automatically do it for you. a z10 cpu type with z14 feature set won't make sense to the compiler.\nThat's the only case.", "author": "harryyu1994", "createdAt": "2020-10-06T01:33:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkxNjE3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTk2MDkyMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10697#discussion_r499960920", "bodyText": "Description on these two has been changed to:\n  /** \n    * @brief A factory method used to construct an CPU object based on the underlying hardware\n    * @param[in] omrPortLib : the port library\n    * @return TR::CPU\n    */\n   static TR::CPU detect(OMRPortLibrary * const omrPortLib);\n\n   /** \n    * @brief A factory method used to construct an CPU object based on user customized processorDescription\n    * @param[in] OMRProcessorDesc : the processor description\n    * @return TR::CPU\n    */\n   static TR::CPU customize(OMRProcessorDesc processorDescription);", "author": "harryyu1994", "createdAt": "2020-10-06T01:43:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkxNjE3Nw=="}], "type": "inlineReview"}, {"oid": "fb73d08eb5233cb5e754d354b0855d25e69f84b9", "url": "https://github.com/eclipse-openj9/openj9/commit/fb73d08eb5233cb5e754d354b0855d25e69f84b9", "message": "Add descriptions for TR::CPU::detect() and TR::CPU::customize()\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-10-06T18:13:00Z", "type": "forcePushed"}, {"oid": "e24c54850b57e9eae7b040332f13cd0d499e5cc2", "url": "https://github.com/eclipse-openj9/openj9/commit/e24c54850b57e9eae7b040332f13cd0d499e5cc2", "message": "Add descriptions for TR::CPU::detect() and TR::CPU::customize()\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-10-06T18:19:39Z", "type": "forcePushed"}, {"oid": "c7b487f48799ad4c4427907690cfb94603d4a16f", "url": "https://github.com/eclipse-openj9/openj9/commit/c7b487f48799ad4c4427907690cfb94603d4a16f", "message": "Add descriptions for TR::CPU::detect() and TR::CPU::customize()\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-10-06T18:56:02Z", "type": "forcePushed"}, {"oid": "e6c0fba3c4ace8f7a4c90d4367fe273eaa2ffe71", "url": "https://github.com/eclipse-openj9/openj9/commit/e6c0fba3c4ace8f7a4c90d4367fe273eaa2ffe71", "message": "Add descriptions for TR::CPU::detect() and TR::CPU::customize()\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-10-06T18:57:32Z", "type": "commit"}, {"oid": "e6c0fba3c4ace8f7a4c90d4367fe273eaa2ffe71", "url": "https://github.com/eclipse-openj9/openj9/commit/e6c0fba3c4ace8f7a4c90d4367fe273eaa2ffe71", "message": "Add descriptions for TR::CPU::detect() and TR::CPU::customize()\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-10-06T18:57:32Z", "type": "forcePushed"}]}