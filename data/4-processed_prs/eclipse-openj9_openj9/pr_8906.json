{"pr_number": 8906, "pr_title": "Runtime compressed refs work", "pr_createdAt": "2020-03-18T17:37:48Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/8906", "timeline": [{"oid": "94978cf7325ee26ba299a45db541afb2f6b0048b", "url": "https://github.com/eclipse-openj9/openj9/commit/94978cf7325ee26ba299a45db541afb2f6b0048b", "message": "Runtime compressed refs work\n\nCorrectly store the alternateLockword when inflating a monitor. The\nfield is typed as j9objectmonitor_t, but must be treated like object\nlockwords (store U32 or UDATA, not j9objectmonitor_t).\n\n[ci skip]\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>", "committedDate": "2020-03-18T17:22:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUzNDE1OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8906#discussion_r394534158", "bodyText": "I assume this is required because of the use of J9_LOAD_LOCKWORD... macros?\nLike: https://github.com/eclipse/openj9/blob/51d9fc6a3da153f5b22a30dce3dc661574f5acce/runtime/util/moninfo.c#L70", "author": "DanHeidinga", "createdAt": "2020-03-18T17:51:10Z", "path": "runtime/vm/monhelpers.c", "diffHunk": "@@ -257,7 +257,7 @@ objectMonitorInflate(J9VMThread* vmStruct, j9object_t object, UDATA lock)\n \t((J9ThreadAbstractMonitor*)monitor)->count = J9_FLATLOCK_COUNT(lock);\t\n \n \tif (!LN_HAS_LOCKWORD(vmStruct,object)) {\n-\t\tobjectMonitor->alternateLockword = (j9objectmonitor_t)((UDATA)objectMonitor | OBJECT_HEADER_LOCK_INFLATED);\n+\t\tJ9_STORE_LOCKWORD(vmStruct, &objectMonitor->alternateLockword, (j9objectmonitor_t)((UDATA)objectMonitor | OBJECT_HEADER_LOCK_INFLATED));", "originalCommit": "94978cf7325ee26ba299a45db541afb2f6b0048b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUzODc2Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/8906#discussion_r394538762", "bodyText": "Yes, the lockword location is treated as if it were in the object, so the load/store macros must always be used. Again, this works on X because of endian.", "author": "gacholio", "createdAt": "2020-03-18T17:58:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUzNDE1OA=="}], "type": "inlineReview"}]}