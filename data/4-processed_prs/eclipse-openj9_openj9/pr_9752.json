{"pr_number": 9752, "pr_title": "Collect stats about sizes of different types of messages sent in JITServer", "pr_createdAt": "2020-05-31T19:37:32Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/9752", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI3OTE2NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9752#discussion_r433279164", "bodyText": "This implementation prints something for every message that is received.\nWhat we want is to collect these stats and print them once, at shutdown, much like we print stats about the number of messages by type", "author": "mpirvu", "createdAt": "2020-06-01T14:48:07Z", "path": "runtime/compiler/net/CommunicationStream.cpp", "diffHunk": "@@ -73,6 +73,13 @@ CommunicationStream::readMessage(Message &msg)\n \n    // rebuild the message\n    msg.deserialize();\n+\n+   // collect message size\n+#ifdef STATS\n+   static TR_Stats statMsgSize[MessageType_ARRAYSIZE];\n+   statMsgSize[int(msg.type())].update(messageSize);\n+   statMsgSize[int(msg.type())].report(stderr);", "originalCommit": "3f3f1d5d39903586e8b89fafd0af8b794277ede4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "47a3acd443a250b23946234cc5695a133130bea5", "url": "https://github.com/eclipse-openj9/openj9/commit/47a3acd443a250b23946234cc5695a133130bea5", "message": "Collect stats about sizes of different types of messages sent\n\nI'm keeping track of the size of different types of messages sent using msg.type()\nand I'm using the class TR_Stats to store avg,min,max and stddev of every type of message.\nissue: #9708\n\nSigned-off-by: Eman Elsabban <eman.elsaban1@gmail.com>", "committedDate": "2020-06-02T19:15:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY5NzI4MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9752#discussion_r434697281", "bodyText": "better called updateMsgSizeStats", "author": "mpirvu", "createdAt": "2020-06-03T16:25:19Z", "path": "runtime/compiler/control/CompilationRuntime.hpp", "diffHunk": "@@ -744,6 +744,9 @@ class CompilationInfo\n \n    int32_t getQueueWeight() const { return _queueWeight; }\n    void increaseQueueWeightBy(uint8_t w) { _queueWeight += (int32_t)w; }\n+   TR_Stats *getStatMsgSize() {return _statMsgSize; }\n+   //void setStatMsgSize(TR_Stats *msgSizeArray){ for(int i = 0; i < 243; i++{ _statMsgSize[i] = msgSizeArray[i];}\n+   void setMsgSize(int typeVal, double val){ _statMsgSize[typeVal].update(val); }", "originalCommit": "47a3acd443a250b23946234cc5695a133130bea5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcwMzc0NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9752#discussion_r434703745", "bodyText": "Avoid hardcoded numbers. I think this should be JITServer::MessageType_ARRAYSIZE", "author": "mpirvu", "createdAt": "2020-06-03T16:35:27Z", "path": "runtime/compiler/control/CompilationRuntime.hpp", "diffHunk": "@@ -1142,6 +1145,7 @@ class CompilationInfo\n    uint64_t               _lastCompilationsShouldBeInterruptedTime; // RAS\n // statistics\n    int32_t                _statsOptLevels[numHotnessLevels]; // will be zeroed with memset\n+   TR_Stats               _statMsgSize[243];", "originalCommit": "47a3acd443a250b23946234cc5695a133130bea5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcwNDc4OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9752#discussion_r434704789", "bodyText": "Also, since this takes quite a bit of space we probably want some #ifdef to not include the code by default.", "author": "mpirvu", "createdAt": "2020-06-03T16:37:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcwMzc0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcwNjc4NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9752#discussion_r434706785", "bodyText": "These two lines can be combined into one.", "author": "mpirvu", "createdAt": "2020-06-03T16:40:20Z", "path": "runtime/compiler/control/JITServerHelpers.cpp", "diffHunk": "@@ -118,18 +120,22 @@ JITServerHelpers::insertIntoOOSequenceEntryList(ClientSessionData *clientData, T\n    }\n \n void\n-JITServerHelpers::printJITServerMsgStats(J9JITConfig *jitConfig)\n+JITServerHelpers::printJITServerMsgStats(J9JITConfig *jitConfig, TR::CompilationInfo *compInfo)\n    {\n+   //TR::CompilationInfo *compInfo;   \n+   TR_Stats *receiveStatMsg;\n+   receiveStatMsg = compInfo->getStatMsgSize();   ", "originalCommit": "47a3acd443a250b23946234cc5695a133130bea5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc0MTk4OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9752#discussion_r434741988", "bodyText": "compInfo is not initialized here. This could lead to crashes", "author": "mpirvu", "createdAt": "2020-06-03T17:39:11Z", "path": "runtime/compiler/net/CommunicationStream.cpp", "diffHunk": "@@ -73,6 +73,20 @@ CommunicationStream::readMessage(Message &msg)\n \n    // rebuild the message\n    msg.deserialize();\n+\n+   // collect message size\n+/*#ifdef STATS\n+   static TR_Stats statMsgSize[MessageType_ARRAYSIZE];\n+   statMsgSize[int(msg.type())].update(messageSize);\n+   statMsgSize[int(msg.type())].report(stderr);\n+#endif*/\n+   TR::CompilationInfo *compInfo;\n+   static TR_Stats collectMsgStat[MessageType_ARRAYSIZE];\n+   collectMsgStat[int(msg.type())].update(messageSize); //I dont need it anymore since I pass the type and size\n+   //compInfo->setStatMsgSize(collectMsgStat);\n+   compInfo->setMsgSize(int(msg.type()), messageSize);", "originalCommit": "47a3acd443a250b23946234cc5695a133130bea5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc1NzI1Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9752#discussion_r434757253", "bodyText": "Since you don't have easy access to compInfo from communicationStream it may be better to define that TR_Stats collectMsgStat[MessageType_ARRAYSIZE]; as a static field in CommunicationStream class.", "author": "mpirvu", "createdAt": "2020-06-03T18:05:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc0MTk4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc0Mjc1OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9752#discussion_r434742758", "bodyText": "These two lines have no purpose now that you moved the stats into compInfo", "author": "mpirvu", "createdAt": "2020-06-03T17:40:31Z", "path": "runtime/compiler/net/CommunicationStream.cpp", "diffHunk": "@@ -73,6 +73,20 @@ CommunicationStream::readMessage(Message &msg)\n \n    // rebuild the message\n    msg.deserialize();\n+\n+   // collect message size\n+/*#ifdef STATS\n+   static TR_Stats statMsgSize[MessageType_ARRAYSIZE];\n+   statMsgSize[int(msg.type())].update(messageSize);\n+   statMsgSize[int(msg.type())].report(stderr);\n+#endif*/\n+   TR::CompilationInfo *compInfo;\n+   static TR_Stats collectMsgStat[MessageType_ARRAYSIZE];\n+   collectMsgStat[int(msg.type())].update(messageSize); //I dont need it anymore since I pass the type and size", "originalCommit": "47a3acd443a250b23946234cc5695a133130bea5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "015cf33de7d99a594133d3b0ba5c212ef2e872d5", "url": "https://github.com/eclipse-openj9/openj9/commit/015cf33de7d99a594133d3b0ba5c212ef2e872d5", "message": "Collect stats about sizes of different types of messages sent\n\nI'm keeping track of the size of different types of messages sent using msg.type()\nand I'm using the class TR_Stats to store avg,min,max and stddev of every type of message.\nI declared a static array in CommunicationStream.hpp and I'm using that to store in.\nissue: #9708\n\nSigned-off-by: Eman Elsabban <eman.elsaban1@gmail.com>", "committedDate": "2020-06-04T15:15:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTkwNTE3Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/9752#discussion_r435905172", "bodyText": "Let's eliminate this extra line", "author": "mpirvu", "createdAt": "2020-06-05T13:00:53Z", "path": "runtime/compiler/control/CompilationThread.cpp", "diffHunk": "@@ -3195,6 +3195,7 @@ void TR::CompilationInfo::stopCompilationThreads()\n \n       fprintf(stderr, \"Compilation queue peak size = %d\\n\", getPeakMethodQueueSize());\n       fprintf(stderr, \"Compilation queue size at shutdown = %d\\n\", getMethodQueueSize());\n+", "originalCommit": "015cf33de7d99a594133d3b0ba5c212ef2e872d5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTkwNTQ2OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9752#discussion_r435905468", "bodyText": "Let's eliminate these extra spaces after the curly bracket", "author": "mpirvu", "createdAt": "2020-06-05T13:01:30Z", "path": "runtime/compiler/control/JITServerHelpers.cpp", "diffHunk": "@@ -119,16 +122,18 @@ JITServerHelpers::insertIntoOOSequenceEntryList(ClientSessionData *clientData, T\n \n void\n JITServerHelpers::printJITServerMsgStats(J9JITConfig *jitConfig)\n-   {\n+   {     ", "originalCommit": "015cf33de7d99a594133d3b0ba5c212ef2e872d5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "25e35991246e2b69394987b592976568a79165ac", "url": "https://github.com/eclipse-openj9/openj9/commit/25e35991246e2b69394987b592976568a79165ac", "message": "Collect stats about sizes of different types of messages sent\n\nI'm keeping track of the size of different types of messages sent using msg.type()\nand I'm using the class TR_Stats to store avg,min,max and stddev of every type of message.\nI declared a static array in CommunicationStream.hpp and I'm using that to store in.\nissue: #9708\n\nSigned-off-by: Eman Elsabban <eman.elsaban1@gmail.com>", "committedDate": "2020-06-05T13:20:31Z", "type": "forcePushed"}, {"oid": "bc03e037ac7dc8b015a7add334a1b01a2d16db2f", "url": "https://github.com/eclipse-openj9/openj9/commit/bc03e037ac7dc8b015a7add334a1b01a2d16db2f", "message": "Collect stats about sizes of different types of messages sent\n\nI'm keeping track of the size of different types of messages sent using msg.type()\nand I'm using the class TR_Stats to store avg,min,max and stddev of every type of message.\nI declared a static array in CommunicationStream.hpp and I'm using that to store in.\nissue: #9708\n\nSigned-off-by: Eman Elsabban <eman.elsaban1@gmail.com>", "committedDate": "2020-06-05T14:13:50Z", "type": "forcePushed"}, {"oid": "a5cd649483d63e7267e256cffaa333039936bc29", "url": "https://github.com/eclipse-openj9/openj9/commit/a5cd649483d63e7267e256cffaa333039936bc29", "message": "Collect stats about sizes of different types of messages sent\n\nI'm keeping track of the size of different types of messages sent using msg.type()\nand I'm using the class TR_Stats to store avg,min,max and stddev of every type of message.\nI declared a static array in CommunicationStream.hpp and I'm using that to store in.\nissue: #9708\n\nSigned-off-by: Eman Elsabban <eman.elsaban1@gmail.com>", "committedDate": "2020-06-05T15:03:39Z", "type": "commit"}, {"oid": "a5cd649483d63e7267e256cffaa333039936bc29", "url": "https://github.com/eclipse-openj9/openj9/commit/a5cd649483d63e7267e256cffaa333039936bc29", "message": "Collect stats about sizes of different types of messages sent\n\nI'm keeping track of the size of different types of messages sent using msg.type()\nand I'm using the class TR_Stats to store avg,min,max and stddev of every type of message.\nI declared a static array in CommunicationStream.hpp and I'm using that to store in.\nissue: #9708\n\nSigned-off-by: Eman Elsabban <eman.elsaban1@gmail.com>", "committedDate": "2020-06-05T15:03:39Z", "type": "forcePushed"}]}