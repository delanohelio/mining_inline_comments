{"pr_number": 8978, "pr_title": "Optimize IProfiler fan-in info serialization", "pr_createdAt": "2020-03-25T16:25:57Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/8978", "timeline": [{"oid": "18fcd56a476fe3a726f9bc1a6da216fb66aefae0", "url": "https://github.com/eclipse-openj9/openj9/commit/18fcd56a476fe3a726f9bc1a6da216fb66aefae0", "message": "Optimize IProfiler fan-in info serialization\n\nPreviously, serializing `TR_IPMethodHashTableEntry` to\n`TR_ContiguousIPMethodHashTableEntry` required memsetting\nthe contiguous entry to 0 on the client, so when\nthe next element in the serialized array of callers is NULL,\nserver would know that it reached the end.\n\nThis commit adds `_callerCount` field to the contiguous entry,\nso that client doesn't have to perform a memset since server\nis informed how many callers are present.\n\nSigned-off-by: dmitry-ten <candalistic@gmail.com>", "committedDate": "2020-03-25T16:26:21Z", "type": "forcePushed"}, {"oid": "e8f33c494e2236f920417eb9421aba414583ab79", "url": "https://github.com/eclipse-openj9/openj9/commit/e8f33c494e2236f920417eb9421aba414583ab79", "message": "Optimize IProfiler fan-in info serialization\n\nPreviously, serializing `TR_IPMethodHashTableEntry` to\n`TR_ContiguousIPMethodHashTableEntry` required memsetting\nthe contiguous entry to 0 on the client, so when\nthe next element in the serialized array of callers is NULL,\nserver would know that it reached the end.\n\nThis commit adds `_callerCount` field to the contiguous entry,\nso that client doesn't have to perform a memset since server\nis informed how many callers are present.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-03-25T16:28:13Z", "type": "forcePushed"}, {"oid": "c53986ccaf0546987daecaeba2a9acbb3f1fb13c", "url": "https://github.com/eclipse-openj9/openj9/commit/c53986ccaf0546987daecaeba2a9acbb3f1fb13c", "message": "Optimize IProfiler fan-in info serialization\n\nPreviously, serializing `TR_IPMethodHashTableEntry` to\n`TR_ContiguousIPMethodHashTableEntry` required memsetting\nthe contiguous entry to 0 on the client, so when\nthe next element in the serialized array of callers is NULL,\nserver would know that it reached the end.\n\nThis commit adds `_callerCount` field to the contiguous entry,\nso that client doesn't have to perform a memset since server\nis informed how many callers are present.\n\nAlso modify serialization function for method entries to remove\none round of copying.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-03-26T19:50:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUyODIzOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8978#discussion_r399528238", "bodyText": "Small tweak: take this increment out of the for loop and at the end just add serialEntry->_callerCount=callerIdx;", "author": "mpirvu", "createdAt": "2020-03-27T20:44:00Z", "path": "runtime/compiler/runtime/JITServerIProfiler.cpp", "diffHunk": "@@ -91,26 +88,25 @@ JITServerIProfiler::deserializeMethodEntry(TR_ContiguousIPMethodHashTableEntry *\n    return entry;\n    }\n \n-TR_ContiguousIPMethodHashTableEntry\n-TR_ContiguousIPMethodHashTableEntry::serialize(TR_IPMethodHashTableEntry *entry)\n+void\n+TR_ContiguousIPMethodHashTableEntry::serialize(TR_IPMethodHashTableEntry *entry, TR_ContiguousIPMethodHashTableEntry *serialEntry)\n    {\n-   TR_ContiguousIPMethodHashTableEntry serialEntry;\n-   memset(&serialEntry, 0, sizeof(TR_ContiguousIPMethodHashTableEntry));\n-   serialEntry._method = entry->_method;\n-   serialEntry._otherBucket = entry->_otherBucket;\n+   serialEntry->_method = entry->_method;\n+   serialEntry->_otherBucket = entry->_otherBucket;\n+   serialEntry->_callerCount = 0;\n \n    size_t callerIdx = 0;\n    for (TR_IPMethodData *caller = &entry->_caller; caller; caller = caller->next)\n       {\n       if (callerIdx >= TR_IPMethodHashTableEntry::MAX_IPMETHOD_CALLERS)\n          break;\n-      auto &serialCaller = serialEntry._callers[callerIdx];\n+      auto &serialCaller = serialEntry->_callers[callerIdx];\n       serialCaller._method = caller->getMethod();\n       serialCaller._pcIndex = caller->getPCIndex();\n       serialCaller._weight = caller->getWeight();\n+      serialEntry->_callerCount++;", "originalCommit": "c53986ccaf0546987daecaeba2a9acbb3f1fb13c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUyOTMwMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/8978#discussion_r399529302", "bodyText": "reserve will not work here because the size of the string is not adjusted. We need to do std::string entryStr(sizeof(TR_ContiguousIPMethodHashTableEntry), 0)\nAn alternative is to resize the string before calling serialize:\nentryStr.resize(sizeof(TR_ContiguousIPMethodHashTableEntry))` which fills it with 0 as well\nWe could also another resize after the string is filled because we know how many entries are stored. This will limit the amount of empty data transferred to and from network.", "author": "mpirvu", "createdAt": "2020-03-27T20:46:32Z", "path": "runtime/compiler/runtime/JITServerIProfiler.cpp", "diffHunk": "@@ -803,8 +799,11 @@ JITClientIProfiler::serializeIProfilerMethodEntry(TR_OpaqueMethodBlock *omb)\n    auto entry = findOrCreateMethodEntry(NULL, (J9Method *) omb, false);\n    if (entry)\n       {\n-      auto serialEntry = TR_ContiguousIPMethodHashTableEntry::serialize(entry);\n-      std::string entryStr((char *) &serialEntry, sizeof(TR_ContiguousIPMethodHashTableEntry));\n+      std::string entryStr;\n+      entryStr.reserve(sizeof(TR_ContiguousIPMethodHashTableEntry));", "originalCommit": "c53986ccaf0546987daecaeba2a9acbb3f1fb13c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM1NTQ0NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8978#discussion_r400355445", "bodyText": "Ok, used a different constructor", "author": "dmitry-ten", "createdAt": "2020-03-30T17:10:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUyOTMwMg=="}], "type": "inlineReview"}, {"oid": "63fa0af40c8bab904b2d323b535f534a592225a6", "url": "https://github.com/eclipse-openj9/openj9/commit/63fa0af40c8bab904b2d323b535f534a592225a6", "message": "Optimize IProfiler fan-in info serialization\n\nPreviously, serializing `TR_IPMethodHashTableEntry` to\n`TR_ContiguousIPMethodHashTableEntry` required memsetting\nthe contiguous entry to 0 on the client, so when\nthe next element in the serialized array of callers is NULL,\nserver would know that it reached the end.\n\nThis commit adds `_callerCount` field to the contiguous entry,\nso that client doesn't have to perform a memset since server\nis informed how many callers are present.\n\nAlso modify serialization function for method entries to remove\none round of copying.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-03-30T17:10:01Z", "type": "forcePushed"}, {"oid": "d2d1addb33f6055b3437e3a533cb38aac01dc8dd", "url": "https://github.com/eclipse-openj9/openj9/commit/d2d1addb33f6055b3437e3a533cb38aac01dc8dd", "message": "Optimize IProfiler fan-in info serialization\n\nPreviously, serializing `TR_IPMethodHashTableEntry` to\n`TR_ContiguousIPMethodHashTableEntry` required memsetting\nthe contiguous entry to 0 on the client, so when\nthe next element in the serialized array of callers is NULL,\nserver would know that it reached the end.\n\nThis commit adds `_callerCount` field to the contiguous entry,\nso that client doesn't have to perform a memset since server\nis informed how many callers are present.\n\nAlso modify serialization function for method entries to remove\none round of copying.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-03-30T17:11:30Z", "type": "forcePushed"}, {"oid": "6e35c3f34c83476eee854dedd7c94a1e2266431a", "url": "https://github.com/eclipse-openj9/openj9/commit/6e35c3f34c83476eee854dedd7c94a1e2266431a", "message": "Optimize IProfiler fan-in info serialization\n\nPreviously, serializing `TR_IPMethodHashTableEntry` to\n`TR_ContiguousIPMethodHashTableEntry` required memsetting\nthe contiguous entry to 0 on the client, so when\nthe next element in the serialized array of callers is NULL,\nserver would know that it reached the end.\n\nThis commit adds `_callerCount` field to the contiguous entry,\nso that client doesn't have to perform a memset since server\nis informed how many callers are present.\n\nAlso modify serialization function for method entries to remove\none round of copying.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-03-30T17:12:13Z", "type": "commit"}, {"oid": "6e35c3f34c83476eee854dedd7c94a1e2266431a", "url": "https://github.com/eclipse-openj9/openj9/commit/6e35c3f34c83476eee854dedd7c94a1e2266431a", "message": "Optimize IProfiler fan-in info serialization\n\nPreviously, serializing `TR_IPMethodHashTableEntry` to\n`TR_ContiguousIPMethodHashTableEntry` required memsetting\nthe contiguous entry to 0 on the client, so when\nthe next element in the serialized array of callers is NULL,\nserver would know that it reached the end.\n\nThis commit adds `_callerCount` field to the contiguous entry,\nso that client doesn't have to perform a memset since server\nis informed how many callers are present.\n\nAlso modify serialization function for method entries to remove\none round of copying.\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-03-30T17:12:13Z", "type": "forcePushed"}]}