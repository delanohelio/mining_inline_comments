{"pr_number": 10186, "pr_title": "JEP 360: cfdumper support", "pr_createdAt": "2020-07-16T22:26:39Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10186", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODEyMjg2Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10186#discussion_r458122862", "bodyText": "Please use J9ROMCLASS_IS_SEALED at every possible location rather than testing the bit directly.", "author": "gacholio", "createdAt": "2020-07-21T14:04:52Z", "path": "runtime/bcutil/ClassFileWriter.cpp", "diffHunk": "@@ -957,6 +968,9 @@ ClassFileWriter::writeAttributes()\n \tif (J9_ARE_ANY_BITS_SET(_romClass->extraModifiers, J9AccRecord)) {\n \t\tattributesCount += 1;\n \t}\n+\tif (J9_ARE_ANY_BITS_SET(_romClass->extraModifiers, J9AccSealed)) {", "originalCommit": "60e43a14ec59dfe4c7a7504b42f9e2df1f4d63c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODEyNDMxMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10186#discussion_r458124313", "bodyText": "J9UTF8_EQUALS could be used here.", "author": "gacholio", "createdAt": "2020-07-21T14:06:43Z", "path": "runtime/bcutil/ClassFileWriter.cpp", "diffHunk": "@@ -1085,6 +1099,34 @@ ClassFileWriter::writeAttributes()\n \tif (J9_ARE_ANY_BITS_SET(_romClass->extraModifiers, J9AccRecord)) {\n \t\twriteRecordAttribute();\n \t}\n+\n+\t/* write PermittedSubclasses attribute */\n+\tif (J9_ARE_ANY_BITS_SET(_romClass->extraModifiers, J9AccSealed)) {\n+\t\tU_32 *permittedSubclassesCountPtr = getNumberOfPermittedSubclassesPtr(_romClass);\n+\t\twriteAttributeHeader((J9UTF8 *) &PERMITTED_SUBCLASSES, sizeof(U_16) + (*permittedSubclassesCountPtr * sizeof(U_16)));\n+\n+\t\twriteU16(*permittedSubclassesCountPtr);\n+\n+\t\tfor (U_32 i = 0; i < *permittedSubclassesCountPtr; i++) {\n+\t\t\tJ9UTF8* permittedSubclassNameUtf8 = permittedSubclassesNameAtIndex(permittedSubclassesCountPtr, i);\n+\n+\t\t\t/* CONSTANT_Class_info index should be written. Find class entry that references the subclass name in constant pool. */\n+\t\t\tJ9HashTableState hashTableState;\n+\t\t\tHashTableEntry * entry = (HashTableEntry *) hashTableStartDo(_cpHashTable, &hashTableState);\n+\t\t\twhile (NULL != entry) {\n+\t\t\t\tif (CFR_CONSTANT_Class == entry->cpType) {\n+\t\t\t\t\tJ9UTF8* classNameCandidate = (J9UTF8*)entry->address;\n+\t\t\t\t\tif (J9UTF8_DATA_EQUALS(J9UTF8_DATA(classNameCandidate), J9UTF8_LENGTH(classNameCandidate), ", "originalCommit": "60e43a14ec59dfe4c7a7504b42f9e2df1f4d63c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODEyNjE3Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/10186#discussion_r458126176", "bodyText": "Is the string guaranteed to be nul-terminated? I see this pattern repeated throughout the code, so maybe it is.", "author": "gacholio", "createdAt": "2020-07-21T14:09:18Z", "path": "runtime/cfdumper/main.c", "diffHunk": "@@ -907,6 +907,16 @@ static void dumpAttribute(J9CfrClassFile* classfile, J9CfrAttribute* attrib, U_3\n \t\t\t}\n \t\t\tbreak;\n \n+\t\tcase CFR_ATTRIBUTE_PermittedSubclasses:\n+\t\t\tfor(i = 0; i < ((J9CfrAttributePermittedSubclasses*)attrib)->numberOfClasses; i++) {\n+\t\t\t\tU_16 classIndex = ((J9CfrAttributePermittedSubclasses*)attrib)->classes[i];\n+\t\t\t\tU_16 nameIndex = classfile->constantPool[classIndex].slot1;\n+\n+\t\t\t\tfor(j = 0; j < tabLevel + 1; j++) j9tty_printf( PORTLIB, \"  \");\n+\t\t\t\tj9tty_printf( PORTLIB, \"PermittedSubclass class index, name: %i, %i -> %s\\n\", classIndex, nameIndex, classfile->constantPool[nameIndex].bytes);", "originalCommit": "60e43a14ec59dfe4c7a7504b42f9e2df1f4d63c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODEyODI1Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/10186#discussion_r458128256", "bodyText": "Explicit '\\0 != check please.", "author": "gacholio", "createdAt": "2020-07-21T14:12:11Z", "path": "runtime/cfdumper/main.c", "diffHunk": "@@ -998,6 +1008,35 @@ static void printClassFile(J9CfrClassFile* classfile)\n \t\t}\n \t}\n \n+\t/* JEP 360: sealed class permits list */\n+\tif(classfile->j9Flags & CFR_J9FLAG_IS_SEALED) {\n+\t\t/* find PermittedSubclasses attribute */\n+\t\tfor (i = 0; i < classfile->attributesCount; i++) {\n+\t\t\tif (CFR_ATTRIBUTE_PermittedSubclasses == classfile->attributes[i]->tag) {\n+\t\t\t\t/* found attribute, print permitted subclasses */\n+\t\t\t\tj9tty_printf( PORTLIB, \" permits \");\n+\n+\t\t\t\tfor (j = 0; j < ((J9CfrAttributePermittedSubclasses*)classfile->attributes[i])->numberOfClasses; j++) {\n+\t\t\t\t\t/* class index */\n+\t\t\t\t\tindex = ((J9CfrAttributePermittedSubclasses*)classfile->attributes[i])->classes[j];\n+\t\t\t\t\t/* class name index */\n+\t\t\t\t\tindex = classfile->constantPool[index].slot1;\n+\t\t\t\t\tstring = classfile->constantPool[index].bytes;\n+\n+\t\t\t\t\tk = 0;\n+\t\t\t\t\twhile(string[k])", "originalCommit": "60e43a14ec59dfe4c7a7504b42f9e2df1f4d63c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODEyODM3OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10186#discussion_r458128379", "bodyText": "Spacing.", "author": "gacholio", "createdAt": "2020-07-21T14:12:22Z", "path": "runtime/cfdumper/main.c", "diffHunk": "@@ -998,6 +1008,35 @@ static void printClassFile(J9CfrClassFile* classfile)\n \t\t}\n \t}\n \n+\t/* JEP 360: sealed class permits list */\n+\tif(classfile->j9Flags & CFR_J9FLAG_IS_SEALED) {\n+\t\t/* find PermittedSubclasses attribute */\n+\t\tfor (i = 0; i < classfile->attributesCount; i++) {\n+\t\t\tif (CFR_ATTRIBUTE_PermittedSubclasses == classfile->attributes[i]->tag) {\n+\t\t\t\t/* found attribute, print permitted subclasses */\n+\t\t\t\tj9tty_printf( PORTLIB, \" permits \");\n+\n+\t\t\t\tfor (j = 0; j < ((J9CfrAttributePermittedSubclasses*)classfile->attributes[i])->numberOfClasses; j++) {\n+\t\t\t\t\t/* class index */\n+\t\t\t\t\tindex = ((J9CfrAttributePermittedSubclasses*)classfile->attributes[i])->classes[j];\n+\t\t\t\t\t/* class name index */\n+\t\t\t\t\tindex = classfile->constantPool[index].slot1;\n+\t\t\t\t\tstring = classfile->constantPool[index].bytes;\n+\n+\t\t\t\t\tk = 0;\n+\t\t\t\t\twhile(string[k])\n+\t\t\t\t\t{\n+\t\t\t\t\t\tj9tty_printf( PORTLIB, \"%c\", (string[k] == '/')?'.':string[k]);", "originalCommit": "60e43a14ec59dfe4c7a7504b42f9e2df1f4d63c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMyOTY5MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10186#discussion_r458329691", "bodyText": "Please add spaces around the ? and :", "author": "gacholio", "createdAt": "2020-07-21T19:15:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODEyODM3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODEyODc4MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10186#discussion_r458128781", "bodyText": "Brace on preceding line", "author": "gacholio", "createdAt": "2020-07-21T14:12:53Z", "path": "runtime/cfdumper/main.c", "diffHunk": "@@ -998,6 +1008,35 @@ static void printClassFile(J9CfrClassFile* classfile)\n \t\t}\n \t}\n \n+\t/* JEP 360: sealed class permits list */\n+\tif(classfile->j9Flags & CFR_J9FLAG_IS_SEALED) {\n+\t\t/* find PermittedSubclasses attribute */\n+\t\tfor (i = 0; i < classfile->attributesCount; i++) {\n+\t\t\tif (CFR_ATTRIBUTE_PermittedSubclasses == classfile->attributes[i]->tag) {\n+\t\t\t\t/* found attribute, print permitted subclasses */\n+\t\t\t\tj9tty_printf( PORTLIB, \" permits \");\n+\n+\t\t\t\tfor (j = 0; j < ((J9CfrAttributePermittedSubclasses*)classfile->attributes[i])->numberOfClasses; j++) {\n+\t\t\t\t\t/* class index */\n+\t\t\t\t\tindex = ((J9CfrAttributePermittedSubclasses*)classfile->attributes[i])->classes[j];\n+\t\t\t\t\t/* class name index */\n+\t\t\t\t\tindex = classfile->constantPool[index].slot1;\n+\t\t\t\t\tstring = classfile->constantPool[index].bytes;\n+\n+\t\t\t\t\tk = 0;\n+\t\t\t\t\twhile(string[k])\n+\t\t\t\t\t{", "originalCommit": "60e43a14ec59dfe4c7a7504b42f9e2df1f4d63c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODEyOTE3OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10186#discussion_r458129178", "bodyText": "Please bracket the addition, and use braces.", "author": "gacholio", "createdAt": "2020-07-21T14:13:25Z", "path": "runtime/cfdumper/main.c", "diffHunk": "@@ -998,6 +1008,35 @@ static void printClassFile(J9CfrClassFile* classfile)\n \t\t}\n \t}\n \n+\t/* JEP 360: sealed class permits list */\n+\tif(classfile->j9Flags & CFR_J9FLAG_IS_SEALED) {\n+\t\t/* find PermittedSubclasses attribute */\n+\t\tfor (i = 0; i < classfile->attributesCount; i++) {\n+\t\t\tif (CFR_ATTRIBUTE_PermittedSubclasses == classfile->attributes[i]->tag) {\n+\t\t\t\t/* found attribute, print permitted subclasses */\n+\t\t\t\tj9tty_printf( PORTLIB, \" permits \");\n+\n+\t\t\t\tfor (j = 0; j < ((J9CfrAttributePermittedSubclasses*)classfile->attributes[i])->numberOfClasses; j++) {\n+\t\t\t\t\t/* class index */\n+\t\t\t\t\tindex = ((J9CfrAttributePermittedSubclasses*)classfile->attributes[i])->classes[j];\n+\t\t\t\t\t/* class name index */\n+\t\t\t\t\tindex = classfile->constantPool[index].slot1;\n+\t\t\t\t\tstring = classfile->constantPool[index].bytes;\n+\n+\t\t\t\t\tk = 0;\n+\t\t\t\t\twhile(string[k])\n+\t\t\t\t\t{\n+\t\t\t\t\t\tj9tty_printf( PORTLIB, \"%c\", (string[k] == '/')?'.':string[k]);\n+\t\t\t\t\t\tk++;\n+\t\t\t\t\t}\n+\t\t\t\t\tif (j + 1 != ((J9CfrAttributePermittedSubclasses*)classfile->attributes[i])->numberOfClasses) j9tty_printf( PORTLIB, \", \");", "originalCommit": "60e43a14ec59dfe4c7a7504b42f9e2df1f4d63c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMyOTMwNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10186#discussion_r458329304", "bodyText": "I would like the brackets around the addition, please - the rest doesn't matter.", "author": "gacholio", "createdAt": "2020-07-21T19:14:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODEyOTE3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMzNjEyMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10186#discussion_r458336122", "bodyText": "updated.", "author": "theresa-m", "createdAt": "2020-07-21T19:27:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODEyOTE3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUwNzc5Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10186#discussion_r458507793", "bodyText": "I'm not seeing the change.", "author": "gacholio", "createdAt": "2020-07-22T03:10:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODEyOTE3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODUzNjU1MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10186#discussion_r458536551", "bodyText": "I think I misread the change you wanted. Should be there now.", "author": "theresa-m", "createdAt": "2020-07-22T05:06:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODEyOTE3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODEyOTQ3Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10186#discussion_r458129477", "bodyText": "Function name on new line", "author": "gacholio", "createdAt": "2020-07-21T14:13:51Z", "path": "runtime/util/romclasswalk.c", "diffHunk": "@@ -763,6 +763,32 @@ static void allSlotsInRecordDo(J9ROMClass* romClass, U_32* recordPointer, J9ROMC\n \tcallbacks->sectionCallback(romClass, recordPointer, (UDATA)cursor - (UDATA)recordPointer, \"recordInfo\", userData);\n }\n \n+static void allSlotsInPermittedSubclassesDo(J9ROMClass* romClass, U_32* permittedSubclassesPointer, J9ROMClassWalkCallbacks* callbacks, void* userData) {", "originalCommit": "60e43a14ec59dfe4c7a7504b42f9e2df1f4d63c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "26d7b95983828ee441db100d5e0509e93c0edd2c", "url": "https://github.com/eclipse-openj9/openj9/commit/26d7b95983828ee441db100d5e0509e93c0edd2c", "message": "JEP 360: cfdumper support\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-07-21T19:08:49Z", "type": "forcePushed"}, {"oid": "71b3f664e4f4e3256c5d346e6b5ff500317983c1", "url": "https://github.com/eclipse-openj9/openj9/commit/71b3f664e4f4e3256c5d346e6b5ff500317983c1", "message": "JEP 360: cfdumper support\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-07-21T19:10:08Z", "type": "forcePushed"}, {"oid": "90cac047ad51ee327818fac191d339f47d2cb469", "url": "https://github.com/eclipse-openj9/openj9/commit/90cac047ad51ee327818fac191d339f47d2cb469", "message": "JEP 360: cfdumper support\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-07-21T19:11:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMzMDExNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10186#discussion_r458330117", "bodyText": "Brace on new line please.", "author": "gacholio", "createdAt": "2020-07-21T19:16:11Z", "path": "runtime/util/romclasswalk.c", "diffHunk": "@@ -763,6 +763,33 @@ static void allSlotsInRecordDo(J9ROMClass* romClass, U_32* recordPointer, J9ROMC\n \tcallbacks->sectionCallback(romClass, recordPointer, (UDATA)cursor - (UDATA)recordPointer, \"recordInfo\", userData);\n }\n \n+static void \n+allSlotsInPermittedSubclassesDo(J9ROMClass* romClass, U_32* permittedSubclassesPointer, J9ROMClassWalkCallbacks* callbacks, void* userData) {", "originalCommit": "90cac047ad51ee327818fac191d339f47d2cb469", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5eb1093e3b9b6c3f48cb8771e684d1676f9a47ee", "url": "https://github.com/eclipse-openj9/openj9/commit/5eb1093e3b9b6c3f48cb8771e684d1676f9a47ee", "message": "JEP 360: cfdumper support\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-07-21T19:24:24Z", "type": "forcePushed"}, {"oid": "589b3fca5f85cf76be1206ce045280c10e06816d", "url": "https://github.com/eclipse-openj9/openj9/commit/589b3fca5f85cf76be1206ce045280c10e06816d", "message": "JEP 360: cfdumper support\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-07-22T05:05:15Z", "type": "commit"}, {"oid": "589b3fca5f85cf76be1206ce045280c10e06816d", "url": "https://github.com/eclipse-openj9/openj9/commit/589b3fca5f85cf76be1206ce045280c10e06816d", "message": "JEP 360: cfdumper support\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-07-22T05:05:15Z", "type": "forcePushed"}]}