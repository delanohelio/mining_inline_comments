{"pr_number": 9902, "pr_title": "Improve group caching of resolved methods", "pr_createdAt": "2020-06-16T16:30:54Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/9902", "timeline": [{"oid": "4ae073ec74e7621b15d662187c45f2d413c13613", "url": "https://github.com/eclipse-openj9/openj9/commit/4ae073ec74e7621b15d662187c45f2d413c13613", "message": "Improve group caching of resolved methods\n\nWe already perform caching of method's callees during inlining\nin one message. This commit builds on that strategy in the following\nways:\n- Group cache all callees of the method being compiled during ILGen\n- Since callees are cached right before they are used, we could\ncache even unresolved methods, not having to worry about them becoming\nresolved in-between calls. Thus, every cached unresolved method entry\nnow has a `time-to-live`, which is set at the moment of caching.\nWhen `ttl` expires, the entry is deleted from cache.\n- Cache interface methods during group caching\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-06-16T16:31:02Z", "type": "forcePushed"}, {"oid": "b49d74cbaa25cb4b3b0fc43a499ed22abd39270a", "url": "https://github.com/eclipse-openj9/openj9/commit/b49d74cbaa25cb4b3b0fc43a499ed22abd39270a", "message": "Improve group caching of resolved methods\n\nWe already perform caching of method's callees during inlining\nin one message. This commit builds on that strategy in the following\nways:\n- Group cache all callees of the method being compiled during ILGen\n- Since callees are cached right before they are used, we could\ncache even unresolved methods, not having to worry about them becoming\nresolved in-between calls. Thus, every cached unresolved method entry\nnow has a `time-to-live`, which is set at the moment of caching.\nWhen `ttl` expires, the entry is deleted from cache.\n- Cache interface methods during group caching\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-06-16T16:34:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA2MDg0OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9902#discussion_r441060849", "bodyText": "To avoid bugs, let's change the test to if (methodCacheEntry.ttlForUnresolved <= 0)", "author": "mpirvu", "createdAt": "2020-06-16T18:32:42Z", "path": "runtime/compiler/control/JITServerCompilationThread.cpp", "diffHunk": "@@ -1024,8 +1028,16 @@ TR::CompilationInfoPerThreadRemote::getCachedResolvedMethod(TR_ResolvedMethodKey\n       auto comp = getCompilation();\n       TR_OpaqueMethodBlock *method = methodCacheEntry.method;\n \n+      // if method == NULL, cached unresolved method\n       if (!method)\n+         {\n+         // decrement time-to-live of this unresolved entry\n+         methodCacheEntry.ttlForUnresolved--;\n+\n+         if (methodCacheEntry.ttlForUnresolved == 0)", "originalCommit": "b49d74cbaa25cb4b3b0fc43a499ed22abd39270a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA2MjgzMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9902#discussion_r441062833", "bodyText": "Maybe expand the comment to something like: \"method==NULL means we have cached an unresolved method; purge the cache entry if the time-to-live for this entry has expired\"", "author": "mpirvu", "createdAt": "2020-06-16T18:36:03Z", "path": "runtime/compiler/control/JITServerCompilationThread.cpp", "diffHunk": "@@ -1024,8 +1028,16 @@ TR::CompilationInfoPerThreadRemote::getCachedResolvedMethod(TR_ResolvedMethodKey\n       auto comp = getCompilation();\n       TR_OpaqueMethodBlock *method = methodCacheEntry.method;\n \n+      // if method == NULL, cached unresolved method", "originalCommit": "b49d74cbaa25cb4b3b0fc43a499ed22abd39270a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA2NDI1MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9902#discussion_r441064251", "bodyText": "The original code seems to allow unresolved entries into the cache (method==NULL). This new implementation seems to be deleting from the cache such entries that were are added with a default ttl=-1.\nIt's true that we add more entries in walker and J9EstimateCodeSize, but is there room for improvement? Should the default value of TTL be larger?", "author": "mpirvu", "createdAt": "2020-06-16T18:38:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA2MjgzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY1MTAwNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/9902#discussion_r441651006", "bodyText": "This implementation will not purge entries with ttl=-1 at all, but I talk about this problem in the comment below.", "author": "dmitry-ten", "createdAt": "2020-06-17T15:52:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA2MjgzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA3NDUxMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9902#discussion_r441074510", "bodyText": "Above, at step 3. maybe we should add & to those 3 local vectors to make them references. Don't know if it's make a difference, but it doesn't hurt.", "author": "mpirvu", "createdAt": "2020-06-16T18:57:15Z", "path": "runtime/compiler/env/j9methodServer.cpp", "diffHunk": "@@ -1871,8 +1876,7 @@ TR_ResolvedJ9JITServerMethod::cacheResolvedMethodsCallees()\n       TR_ResolvedMethodType type = methodTypes[i];\n       TR_ResolvedMethod *resolvedMethod;\n       TR_ResolvedMethodKey key = compInfoPT->getResolvedMethodKey(type, (TR_OpaqueClassBlock *) _ramClass, cpIndices[i]);\n-      if (std::get<0>(methodInfos[i]).remoteMirror &&\n-         !compInfoPT->getCachedResolvedMethod(\n+      if (!compInfoPT->getCachedResolvedMethod(", "originalCommit": "b49d74cbaa25cb4b3b0fc43a499ed22abd39270a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY1NjAyNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9902#discussion_r441656027", "bodyText": "I thought that auto deduces references, but apparently it doesn't. Added it.", "author": "dmitry-ten", "createdAt": "2020-06-17T15:59:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA3NDUxMA=="}], "type": "inlineReview"}, {"oid": "e8ff98f9a1714622b58a18fb1b9bae27cc6a6fc3", "url": "https://github.com/eclipse-openj9/openj9/commit/e8ff98f9a1714622b58a18fb1b9bae27cc6a6fc3", "message": "Improve group caching of resolved methods\n\nWe already perform caching of method's callees during inlining\nin one message. This commit builds on that strategy in the following\nways:\n- Group cache all callees of the method being compiled during ILGen\n- Since callees are cached right before they are used, we could\ncache even unresolved methods, not having to worry about them becoming\nresolved in-between calls. Thus, every cached unresolved method entry\nnow has a `time-to-live`, which is set at the moment of caching.\nWhen `ttl` expires, the entry is deleted from cache.\n- Cache interface methods during group caching\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-06-17T16:02:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg1NDAzMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/9902#discussion_r441854032", "bodyText": "Typo: putge --> purge", "author": "mpirvu", "createdAt": "2020-06-17T21:50:04Z", "path": "runtime/compiler/control/JITServerCompilationThread.cpp", "diffHunk": "@@ -1024,8 +1028,17 @@ TR::CompilationInfoPerThreadRemote::getCachedResolvedMethod(TR_ResolvedMethodKey\n       auto comp = getCompilation();\n       TR_OpaqueMethodBlock *method = methodCacheEntry.method;\n \n+      // if method == NULL means we have cached an unresolved method;\n+      // putge the cached entry if time-to-live has expired.", "originalCommit": "e8ff98f9a1714622b58a18fb1b9bae27cc6a6fc3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcyMjgyOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9902#discussion_r443722829", "bodyText": "Fixed", "author": "dmitry-ten", "createdAt": "2020-06-22T17:40:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg1NDAzMg=="}], "type": "inlineReview"}, {"oid": "7c2b4d40551cb5729d6463fb7b2443f81ec068db", "url": "https://github.com/eclipse-openj9/openj9/commit/7c2b4d40551cb5729d6463fb7b2443f81ec068db", "message": "Improve group caching of resolved methods\n\nWe already perform caching of method's callees during inlining\nin one message. This commit builds on that strategy in the following\nways:\n- Group cache all callees of the method being compiled during ILGen\n- Since callees are cached right before they are used, we could\ncache even unresolved methods, not having to worry about them becoming\nresolved in-between calls. Thus, every cached unresolved method entry\nnow has a `time-to-live`, which is set at the moment of caching.\nWhen `ttl` expires, the entry is deleted from cache.\n- Cache interface methods during group caching\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-06-18T17:07:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcxMjM0MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9902#discussion_r443712341", "bodyText": "This needs to be protected by #if defined(J9VM_OPT_JITSERVER)", "author": "mpirvu", "createdAt": "2020-06-22T17:20:17Z", "path": "runtime/compiler/ilgen/Walker.cpp", "diffHunk": "@@ -48,6 +48,7 @@\n #include \"ilgen/J9ByteCodeIlGenerator.hpp\"\n #include \"infra/Bit.hpp\"               //for trailingZeroes\n #include \"env/JSR292Methods.h\"\n+#include \"env/j9methodServer.hpp\"", "originalCommit": "7c2b4d40551cb5729d6463fb7b2443f81ec068db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcyMjc1Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/9902#discussion_r443722756", "bodyText": "Added it.", "author": "dmitry-ten", "createdAt": "2020-06-22T17:39:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcxMjM0MQ=="}], "type": "inlineReview"}, {"oid": "f759082311e623f2429fd5979a6e788fe5dd44cc", "url": "https://github.com/eclipse-openj9/openj9/commit/f759082311e623f2429fd5979a6e788fe5dd44cc", "message": "Improve group caching of resolved methods\n\nWe already perform caching of method's callees during inlining\nin one message. This commit builds on that strategy in the following\nways:\n- Group cache all callees of the method being compiled during ILGen\n- Since callees are cached right before they are used, we could\ncache even unresolved methods, not having to worry about them becoming\nresolved in-between calls. Thus, every cached unresolved method entry\nnow has a `time-to-live`, which is set at the moment of caching.\nWhen `ttl` expires, the entry is deleted from cache.\n- Cache interface methods during group caching\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-06-22T17:33:04Z", "type": "forcePushed"}, {"oid": "a63bad837310865ff494996a1be301c5f8634e86", "url": "https://github.com/eclipse-openj9/openj9/commit/a63bad837310865ff494996a1be301c5f8634e86", "message": "Improve group caching of resolved methods\n\nWe already perform caching of method's callees during inlining\nin one message. This commit builds on that strategy in the following\nways:\n- Group cache all callees of the method being compiled during ILGen\n- Since callees are cached right before they are used, we could\ncache even unresolved methods, not having to worry about them becoming\nresolved in-between calls. Thus, every cached unresolved method entry\nnow has a `time-to-live`, which is set at the moment of caching.\nWhen `ttl` expires, the entry is deleted from cache.\n- Cache interface methods during group caching\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-06-22T17:34:49Z", "type": "forcePushed"}, {"oid": "be088bc76a3629692227a8e3e73f03ff6d1886b1", "url": "https://github.com/eclipse-openj9/openj9/commit/be088bc76a3629692227a8e3e73f03ff6d1886b1", "message": "Improve group caching of resolved methods\n\nWe already perform caching of method's callees during inlining\nin one message. This commit builds on that strategy in the following\nways:\n- Group cache all callees of the method being compiled during ILGen\n- Since callees are cached right before they are used, we could\ncache even unresolved methods, not having to worry about them becoming\nresolved in-between calls. Thus, every cached unresolved method entry\nnow has a `time-to-live`, which is set at the moment of caching.\nWhen `ttl` expires, the entry is deleted from cache.\n- Cache interface methods during group caching\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-06-22T17:39:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc4MjEwMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9902#discussion_r443782100", "bodyText": "jitGetImproperInterfaceMethodFromCP takes vTableOffset as a pointer to UDATA, but the local above is declared to be uint32_t vTableOffset = 0;\nI think this is dangerous in that jitGetImproperInterfaceMethodFromCP may copy a 64-bit entity and silently corrupt the stack around  vTableOffset local.\nWe need to declare vTableOffset as UDATA and if we really have to, cast that into a uint32_t when storing into vTableOffsets vector (assuming the offset is never exceeding 32-bit)", "author": "mpirvu", "createdAt": "2020-06-22T19:36:54Z", "path": "runtime/compiler/control/JITClientCompilationThread.cpp", "diffHunk": "@@ -1806,6 +1806,17 @@ handleServerMessage(JITServer::ClientStream *client, TR_J9VM *fe, JITServer::Mes\n                   if (ramMethod) createMethod = true;\n                   break;\n                   }\n+               case TR_ResolvedMethodType::ImproperInterface:\n+                  {\n+                  TR::VMAccessCriticalSection getResolvedHandleMethod(fe);\n+                  ramMethod = jitGetImproperInterfaceMethodFromCP(\n+                     fe->vmThread(),\n+                     owningMethod->cp(),\n+                     cpIndex,\n+                     reinterpret_cast<UDATA *>(&vTableOffset));", "originalCommit": "be088bc76a3629692227a8e3e73f03ff6d1886b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzgxNjcwNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9902#discussion_r443816707", "bodyText": "I implemented what you said above. On my machine it compiles without casting to uint32_t but I'm not certain that it will work on all platforms.\nIn the below example it's simply cast to uint32_t:\nhttps://github.com/eclipse/openj9/blob/e006f8232bb7f1273c776a451ea8330bd7f224bb/runtime/compiler/env/j9method.cpp#L6491", "author": "dmitry-ten", "createdAt": "2020-06-22T20:47:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc4MjEwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzkxNzE5NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9902#discussion_r443917195", "bodyText": "Could you please repeat the same trick for TR_ResolvedJ9Method::getVirtualMethod above?", "author": "mpirvu", "createdAt": "2020-06-23T01:54:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc4MjEwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMzMzA0Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9902#discussion_r444333043", "bodyText": "Done.", "author": "dmitry-ten", "createdAt": "2020-06-23T15:57:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc4MjEwMA=="}], "type": "inlineReview"}, {"oid": "33fe6f1d23c997a71de35f80e819a519972cfe7a", "url": "https://github.com/eclipse-openj9/openj9/commit/33fe6f1d23c997a71de35f80e819a519972cfe7a", "message": "Improve group caching of resolved methods\n\nWe already perform caching of method's callees during inlining\nin one message. This commit builds on that strategy in the following\nways:\n- Group cache all callees of the method being compiled during ILGen\n- Since callees are cached right before they are used, we could\ncache even unresolved methods, not having to worry about them becoming\nresolved in-between calls. Thus, every cached unresolved method entry\nnow has a `time-to-live`, which is set at the moment of caching.\nWhen `ttl` expires, the entry is deleted from cache.\n- Cache interface methods during group caching\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-06-22T20:44:23Z", "type": "forcePushed"}, {"oid": "1e8dc95174f3a12b858f311e48276f7e7d74e34c", "url": "https://github.com/eclipse-openj9/openj9/commit/1e8dc95174f3a12b858f311e48276f7e7d74e34c", "message": "Improve group caching of resolved methods\n\nWe already perform caching of method's callees during inlining\nin one message. This commit builds on that strategy in the following\nways:\n- Group cache all callees of the method being compiled during ILGen\n- Since callees are cached right before they are used, we could\ncache even unresolved methods, not having to worry about them becoming\nresolved in-between calls. Thus, every cached unresolved method entry\nnow has a `time-to-live`, which is set at the moment of caching.\nWhen `ttl` expires, the entry is deleted from cache.\n- Cache interface methods during group caching\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-06-23T15:55:22Z", "type": "commit"}, {"oid": "1e8dc95174f3a12b858f311e48276f7e7d74e34c", "url": "https://github.com/eclipse-openj9/openj9/commit/1e8dc95174f3a12b858f311e48276f7e7d74e34c", "message": "Improve group caching of resolved methods\n\nWe already perform caching of method's callees during inlining\nin one message. This commit builds on that strategy in the following\nways:\n- Group cache all callees of the method being compiled during ILGen\n- Since callees are cached right before they are used, we could\ncache even unresolved methods, not having to worry about them becoming\nresolved in-between calls. Thus, every cached unresolved method entry\nnow has a `time-to-live`, which is set at the moment of caching.\nWhen `ttl` expires, the entry is deleted from cache.\n- Cache interface methods during group caching\n\nSigned-off-by: Dmitry Ten <Dmitry.Ten@ibm.com>", "committedDate": "2020-06-23T15:55:22Z", "type": "forcePushed"}]}