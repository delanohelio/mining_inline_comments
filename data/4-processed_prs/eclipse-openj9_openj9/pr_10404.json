{"pr_number": 10404, "pr_title": "Use flexible array member for J9UTF8", "pr_createdAt": "2020-08-18T02:31:11Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10404", "timeline": [{"oid": "c2cfee1ed266de78c729dc275e911bea63ebad9e", "url": "https://github.com/eclipse-openj9/openj9/commit/c2cfee1ed266de78c729dc275e911bea63ebad9e", "message": "Use flexible array member for J9UTF8\n\nAlso fix all direct uses of J9UTF8 fields to use the access macros.\n\nFixes: #10244\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>", "committedDate": "2020-08-18T02:35:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE0OTQ0NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10404#discussion_r472149444", "bodyText": "This should disable the warning only for the following struct declaration:\n#pragma warning(push)\n#pragma warning(disable : 4200)\n\nand restore the warning after the declaration:\n#pragma warning(pop)", "author": "keithc-ca", "createdAt": "2020-08-18T12:41:06Z", "path": "runtime/oti/j9nonbuilder.h", "diffHunk": "@@ -3218,9 +3218,12 @@ typedef struct J9ClassLoader {\n #define J9CLASSLOADER_SET_CLASSLOADEROBJECT(vmThread, object, value) J9VMTHREAD_JAVAVM(vmThread)->memoryManagerFunctions->j9gc_objaccess_storeObjectToInternalVMSlot((vmThread), (j9object_t*)&((object)->classLoaderObject), (value))\n #define TMP_J9CLASSLOADER_CLASSLOADEROBJECT(object) ((object)->classLoaderObject)\n \n+#if defined(_MSC_VER)\n+#pragma warning(disable : 4200)", "originalCommit": "c2cfee1ed266de78c729dc275e911bea63ebad9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjIwNjgwNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10404#discussion_r472206804", "bodyText": "If you would prefer to disable that warning globally (#10244 (comment)), then this is not the place to do it.", "author": "keithc-ca", "createdAt": "2020-08-18T13:42:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE0OTQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI3MjE0Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/10404#discussion_r472272146", "bodyText": "I'll make this change for now (note I copied this from OMR, which does not push/pop, so you may want to suggest the same there). We can remove it later if we opt for the global warning disable.", "author": "gacholio", "createdAt": "2020-08-18T15:11:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE0OTQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMwNzgyOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10404#discussion_r472307828", "bodyText": "OMR isn't consistent: Some places it uses #pragma warning(default:N), some places it says #pragma warning(pop) and some places neither appears. I created eclipse/omr#5478 to track improving things.", "author": "keithc-ca", "createdAt": "2020-08-18T16:01:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE0OTQ0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE1Mjc4Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10404#discussion_r472152787", "bodyText": "Why the + 1? The characters in J9UTF8 are not expected to be nul-terminated.", "author": "keithc-ca", "createdAt": "2020-08-18T12:44:38Z", "path": "runtime/shared_common/shrinit.cpp", "diffHunk": "@@ -3397,7 +3397,7 @@ j9shr_init(J9JavaVM *vm, UDATA loadFlags, UDATA* nonfatal)\n \n \tcmBytes = SH_CacheMap::getRequiredConstrBytes(false);\n \tnameBytes = (strlen(modifiedCacheNamePtr)+1) * sizeof(char);\n-\tmodContextBytes = modContext ? ((strlen(modContext) * sizeof(char)) + sizeof(J9UTF8)) : 0;\n+\tmodContextBytes = modContext ? (((strlen(modContext) + 1) * sizeof(char)) + sizeof(J9UTF8)) : 0;", "originalCommit": "c2cfee1ed266de78c729dc275e911bea63ebad9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI3MTU2MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10404#discussion_r472271561", "bodyText": "For whatever reason, the code below is using strcpy to copy the name, so it is terminating it. This was hidden before by the fact that sizeof(J9UTF8) included two extra bytes.", "author": "gacholio", "createdAt": "2020-08-18T15:10:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE1Mjc4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI5NjgwOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10404#discussion_r472296809", "bodyText": "Ideally we would fix all the places that (needlessly) allocate room for terminators, but this isn't the time for that.", "author": "keithc-ca", "createdAt": "2020-08-18T15:45:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE1Mjc4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMwMDM3MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10404#discussion_r472300371", "bodyText": "Those terminators are a cheap way to make the strings easy to work with in the debugger.  The null byte is low overhead for some easier debug-ability and better C string interop.", "author": "DanHeidinga", "createdAt": "2020-08-18T15:50:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE1Mjc4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMzMDI2Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10404#discussion_r472330263", "bodyText": "That just inverts the issue into one where terminators are added where they're currently missing.", "author": "keithc-ca", "createdAt": "2020-08-18T16:35:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE1Mjc4Nw=="}], "type": "inlineReview"}, {"oid": "8f96e70f70c87647c15e5fd8bfef99cb9b1d78f7", "url": "https://github.com/eclipse-openj9/openj9/commit/8f96e70f70c87647c15e5fd8bfef99cb9b1d78f7", "message": "Use flexible array member for J9UTF8\n\nAlso fix all direct uses of J9UTF8 fields to use the access macros.\n\nFixes: #10244\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>", "committedDate": "2020-08-18T15:13:42Z", "type": "forcePushed"}, {"oid": "54317f6d17c50f901afe9bd5d2d9dacd6e9ee652", "url": "https://github.com/eclipse-openj9/openj9/commit/54317f6d17c50f901afe9bd5d2d9dacd6e9ee652", "message": "Use flexible array member for J9UTF8\n\nAlso fix all direct uses of J9UTF8 fields to use the access macros.\n\nFixes: #10244\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>", "committedDate": "2020-08-18T16:34:41Z", "type": "commit"}, {"oid": "54317f6d17c50f901afe9bd5d2d9dacd6e9ee652", "url": "https://github.com/eclipse-openj9/openj9/commit/54317f6d17c50f901afe9bd5d2d9dacd6e9ee652", "message": "Use flexible array member for J9UTF8\n\nAlso fix all direct uses of J9UTF8 fields to use the access macros.\n\nFixes: #10244\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>", "committedDate": "2020-08-18T16:34:41Z", "type": "forcePushed"}]}