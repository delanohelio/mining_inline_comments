{"pr_number": 9802, "pr_title": "Map symrefs in OSR liveness to those in current trees in creating calls to eaEscapeHelper", "pr_createdAt": "2020-06-04T16:37:09Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/9802", "timeline": [{"oid": "ef46d01b28ce6cee394a17c23b73d1e8c526ecb7", "url": "https://github.com/eclipse-openj9/openj9/commit/ef46d01b28ce6cee394a17c23b73d1e8c526ecb7", "message": "Supply a memory region to OSRCompilationData::buildDefiningMap\n\nThe OSRCompilationData::buildDefiningMap method now takes a TR_Region\nargument to allow the caller to restrict the duration of the\nDefiningMaps that are built - a StackRegion suffices for the purposes\nof PreEscapeAnalysis.  After finishing with it, added a call to\nOSRCompilationData::clearDefiningMap to discard the DefiningMaps.\n\nSigned-off-by:  Henry Zongaro <zongaro@ca.ibm.com>", "committedDate": "2020-06-04T16:43:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc5NTk5Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/9802#discussion_r438795992", "bodyText": "Can you please add a comment to explain why we need the map and how this analysis will not be sound, in general, without it. Since we have the env var to revert people may wonder/forget why it is there and it is an easily overlooked problem.", "author": "andrewcraik", "createdAt": "2020-06-11T13:45:55Z", "path": "runtime/compiler/optimizer/EscapeAnalysisTools.cpp", "diffHunk": "@@ -62,44 +62,84 @@ void TR_EscapeAnalysisTools::insertFakeEscapeForOSR(TR::Block *block, TR::Node *\n    int32_t byteCodeIndex = bci.getByteCodeIndex();\n    TR_OSRCompilationData *osrCompilationData = _comp->getOSRCompilationData();\n \n+   TR_OSRMethodData *osrMethodData  = _comp->getOSRCompilationData()->getOSRMethodDataArray()[inlinedIndex + 1];", "originalCommit": "ef46d01b28ce6cee394a17c23b73d1e8c526ecb7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgyMTczNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9802#discussion_r438821735", "bodyText": "Added a comment in commit 76b9e2c", "author": "hzongaro", "createdAt": "2020-06-11T14:19:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc5NTk5Mg=="}], "type": "inlineReview"}, {"oid": "76b9e2c7de823623969f22afd69aa3b234ed4c26", "url": "https://github.com/eclipse-openj9/openj9/commit/76b9e2c7de823623969f22afd69aa3b234ed4c26", "message": "Use map of symrefs in OSR liveness data to those in current trees\n\nEscapeAnalysisTools relied upon OSR liveness data to supply arguments\nto calls to eaEscapeHelper in OSR induce blocks.  This enables more stack\nallocation of objects under OSR.  However, after various transformations\nhave been applied to the trees, the liveness data cannot be relied upon\ndirectly.\n\nInstead, Pre-EscapeAnalysis must request a DefiningMap from the\nOSRCompilationData, which provides a map from the symbol references that\nexisted at the point of OSR liveness analysis to the definitions that\nexist in the trees at the current point in the compilation.\n\nFor each of the relevant auto and pending push symrefs from the liveness\ndata at the induce block, EscapeAnalysisTools::processSymbolReferences\nwill add the defining symrefs mapped to by the original symref to the\ncall to eaEscapeHelper that it inserts.\n\nThe use of the DefiningMap can be disabled by setting the environment\nvariable TR_DisableEAEscapeHelperDefiningMap.\n\nCo-authored-by:  Yi Zhang <yizhang@ca.ibm.com>\n\nSigned-off-by:  Henry Zongaro <zongaro@ca.ibm.com>", "committedDate": "2020-06-11T14:16:07Z", "type": "commit"}, {"oid": "8b68db1a8002832f7ec27f4e7019a0412a87a1cb", "url": "https://github.com/eclipse-openj9/openj9/commit/8b68db1a8002832f7ec27f4e7019a0412a87a1cb", "message": "Supply a memory region to OSRCompilationData::buildDefiningMap\n\nThe OSRCompilationData::buildDefiningMap method now takes a TR_Region\nargument to allow the caller to restrict the duration of the\nDefiningMaps that are built - a StackRegion suffices for the purposes\nof PreEscapeAnalysis.  After finishing with it, added a call to\nOSRCompilationData::clearDefiningMap to discard the DefiningMaps.\n\nSigned-off-by:  Henry Zongaro <zongaro@ca.ibm.com>", "committedDate": "2020-06-11T14:16:20Z", "type": "commit"}, {"oid": "8b68db1a8002832f7ec27f4e7019a0412a87a1cb", "url": "https://github.com/eclipse-openj9/openj9/commit/8b68db1a8002832f7ec27f4e7019a0412a87a1cb", "message": "Supply a memory region to OSRCompilationData::buildDefiningMap\n\nThe OSRCompilationData::buildDefiningMap method now takes a TR_Region\nargument to allow the caller to restrict the duration of the\nDefiningMaps that are built - a StackRegion suffices for the purposes\nof PreEscapeAnalysis.  After finishing with it, added a call to\nOSRCompilationData::clearDefiningMap to discard the DefiningMaps.\n\nSigned-off-by:  Henry Zongaro <zongaro@ca.ibm.com>", "committedDate": "2020-06-11T14:16:20Z", "type": "forcePushed"}]}