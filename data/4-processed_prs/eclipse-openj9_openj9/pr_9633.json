{"pr_number": 9633, "pr_title": "Change where J9Method_HT, and DLT_Record Tables are cleaned", "pr_createdAt": "2020-05-20T18:43:56Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/9633", "timeline": [{"oid": "c7667698e7e98af70d15ef744e5f4c15725a24b6", "url": "https://github.com/eclipse-openj9/openj9/commit/c7667698e7e98af70d15ef744e5f4c15725a24b6", "message": "Clean up J9Method_HT, and DLT_Record Tables During jitHookClassLoadersUnload Hook\n\nRather than cleaning up the J9Method_HT, and DLT_Record Tables during the jitHookClassLoaderUnload it should be cleaned up during the jitHookClassLoadersUnload hook.\n\nAlso, since dying classes and class-loaders are marked by the GC during class unloading we can also remove the j9classloader argument.\n\nSigned-off-by: AlenBadel <Alen.Badel@ibm.com>", "committedDate": "2020-05-20T18:44:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQyMTUxNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9633#discussion_r428421515", "bodyText": "Don't hardcode 0x2 here as we'll miss it if we every re-order the flags.   There should be a named constant that can be used instead", "author": "DanHeidinga", "createdAt": "2020-05-21T03:11:04Z", "path": "runtime/compiler/control/CompilationThread.cpp", "diffHunk": "@@ -2993,15 +2993,17 @@ void TR::CompilationInfo::insertDLTRecord(J9Method *method, int32_t bcIndex, voi\n    }\n    }\n \n-void TR::CompilationInfo::cleanDLTRecordOnUnload(J9ClassLoader *classloader)\n+void TR::CompilationInfo::cleanDLTRecordOnUnload()\n    {\n    for (int32_t i=0; i<DLT_HASHSIZE; i++)\n       {\n       struct DLT_record *prev=NULL, *curr=_dltHash[i], *next;\n       while (curr != NULL)\n          {\n+         J9Class *clazz = J9_CLASS_FROM_METHOD(curr->_method);\n          next = curr->_next;\n-         if (J9_CLASS_FROM_METHOD(curr->_method)->classLoader == classloader)\n+         if ( J9_ARE_ALL_BITS_SET(clazz->classLoader->gcFlags, 0x2)", "originalCommit": "c7667698e7e98af70d15ef744e5f4c15725a24b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY2OTU5Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9633#discussion_r428669597", "bodyText": "We could either,\nMove the original defines on the GC side to somewhere central.\nhttps://github.com/eclipse/openj9/blob/29cc3dba911e30df27e2856c50f6b9ea78508fe3/runtime/gc_include/j9modron.h#L179-L185\nOr, we could just define J9_GC_CLASS_LOADER_DEAD in CompilationThread.\nWould you have a preference?", "author": "AlenBadel", "createdAt": "2020-05-21T14:00:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQyMTUxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODcyOTYzMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9633#discussion_r428729630", "bodyText": "Why not include j9modron.h directly?", "author": "DanHeidinga", "createdAt": "2020-05-21T15:31:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQyMTUxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgzODI3OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9633#discussion_r428838279", "bodyText": "My apologies, I thought I tried earlier and got some re-definition errors.\nIncluded J9modron.h directly. See AlenBadel@5095b2f", "author": "AlenBadel", "createdAt": "2020-05-21T18:35:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQyMTUxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQyMTY0Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9633#discussion_r428421647", "bodyText": "Same concern here - magic numbers are painful when evolving the code", "author": "DanHeidinga", "createdAt": "2020-05-21T03:11:41Z", "path": "runtime/compiler/control/CompilationThread.cpp", "diffHunk": "@@ -12662,8 +12663,9 @@ void J9Method_HT::onClassUnloading(J9ClassLoader *j9classLoader)\n       HT_Entry *prev = NULL;\n       while (entry)\n          {\n-         if (NULL == entry->_j9method\n-            || J9_CLASS_FROM_METHOD(entry->_j9method)->classLoader == j9classLoader)\n+         J9Class *clazz = J9_CLASS_FROM_METHOD(entry->_j9method);\n+         if ( J9_ARE_ALL_BITS_SET(clazz->classLoader->gcFlags, 0x2)", "originalCommit": "c7667698e7e98af70d15ef744e5f4c15725a24b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgzODQzNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/9633#discussion_r428838436", "bodyText": "Included J9modron.h directly. See AlenBadel@5095b2f", "author": "AlenBadel", "createdAt": "2020-05-21T18:35:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQyMTY0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQyMjAyMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9633#discussion_r428422020", "bodyText": "I don't understand the indentation here.  Why is compInfo->.... more deeply nested than the variable declaration above?", "author": "DanHeidinga", "createdAt": "2020-05-21T03:13:18Z", "path": "runtime/compiler/control/HookedByTheJit.cpp", "diffHunk": "@@ -2180,6 +2175,19 @@ static void jitHookClassLoaderUnload(J9HookInterface * * hookInterface, UDATA ev\n \n #endif /* defined (J9VM_GC_DYNAMIC_CLASS_UNLOADING)*/\n \n+#if defined(J9VM_GC_DYNAMIC_CLASS_UNLOADING) && defined(J9VM_JIT_DYNAMIC_LOOP_TRANSFER)\n+static void jitHookClassLoadersUnload(J9HookInterface * * hookInterface, UDATA eventNum, void * eventData, void * userData)\n+   {\n+   J9VMClassUnloadEvent * unloadedEvent = (J9VMClassUnloadEvent *)eventData;\n+   J9VMThread * vmThread = unloadedEvent->currentThread;\n+   J9JITConfig * jitConfig = vmThread->javaVM->jitConfig;\n+   TR::CompilationInfo * compInfo = TR::CompilationInfo::get(jitConfig);\n+      compInfo->cleanDLTRecordOnUnload();\n+      if (compInfo->getDLT_HT())\n+         compInfo->getDLT_HT()->onClassUnloading();", "originalCommit": "c7667698e7e98af70d15ef744e5f4c15725a24b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY4NTUzNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/9633#discussion_r428685536", "bodyText": "Thanks for catching that.\nSee: 72c265f", "author": "AlenBadel", "createdAt": "2020-05-21T14:26:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQyMjAyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQyMjY3Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9633#discussion_r428422673", "bodyText": "It would be good to add a comment here that the class specific check is required to handle vm anonymous classes which have a lifecycle independent of their classloader.  I had to double check the code when looking for how anon classes are handled so being explicit here would help.\nSame with the code above", "author": "DanHeidinga", "createdAt": "2020-05-21T03:16:10Z", "path": "runtime/compiler/control/CompilationThread.cpp", "diffHunk": "@@ -12662,8 +12663,9 @@ void J9Method_HT::onClassUnloading(J9ClassLoader *j9classLoader)\n       HT_Entry *prev = NULL;\n       while (entry)\n          {\n-         if (NULL == entry->_j9method\n-            || J9_CLASS_FROM_METHOD(entry->_j9method)->classLoader == j9classLoader)\n+         J9Class *clazz = J9_CLASS_FROM_METHOD(entry->_j9method);\n+         if ( J9_ARE_ALL_BITS_SET(clazz->classLoader->gcFlags, 0x2)\n+            || (J9CLASS_FLAGS(clazz) & J9AccClassDying) )", "originalCommit": "c7667698e7e98af70d15ef744e5f4c15725a24b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY4NTAxNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9633#discussion_r428685015", "bodyText": "I agree. Thanks!\nSee: 72c265f", "author": "AlenBadel", "createdAt": "2020-05-21T14:25:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQyMjY3Mw=="}], "type": "inlineReview"}, {"oid": "72c265fb0373f36991c94532768c471b29665784", "url": "https://github.com/eclipse-openj9/openj9/commit/72c265fb0373f36991c94532768c471b29665784", "message": "Add Comments", "committedDate": "2020-05-21T14:25:04Z", "type": "forcePushed"}, {"oid": "9aac7d987c60db898727199409f746df31744b87", "url": "https://github.com/eclipse-openj9/openj9/commit/9aac7d987c60db898727199409f746df31744b87", "message": "Clean up J9Method_HT, and DLT_Record Tables During jitHookClassLoadersUnload Hook\n\nRather than cleaning up the J9Method_HT, and DLT_Record Tables during the jitHookClassLoaderUnload it should be cleaned up during the jitHookClassLoadersUnload hook.\n\nAlso, since dying classes and class-loaders are marked by the GC during class unloading we can also remove the j9classloader argument.\n\nSigned-off-by: AlenBadel <Alen.Badel@ibm.com>", "committedDate": "2020-05-21T18:38:16Z", "type": "commit"}, {"oid": "9aac7d987c60db898727199409f746df31744b87", "url": "https://github.com/eclipse-openj9/openj9/commit/9aac7d987c60db898727199409f746df31744b87", "message": "Clean up J9Method_HT, and DLT_Record Tables During jitHookClassLoadersUnload Hook\n\nRather than cleaning up the J9Method_HT, and DLT_Record Tables during the jitHookClassLoaderUnload it should be cleaned up during the jitHookClassLoadersUnload hook.\n\nAlso, since dying classes and class-loaders are marked by the GC during class unloading we can also remove the j9classloader argument.\n\nSigned-off-by: AlenBadel <Alen.Badel@ibm.com>", "committedDate": "2020-05-21T18:38:16Z", "type": "forcePushed"}]}