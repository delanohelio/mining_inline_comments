{"pr_number": 10748, "pr_title": "JITServer: Eliminate cpu.getProcessorDescription() remote override", "pr_createdAt": "2020-09-29T23:57:22Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10748", "timeline": [{"oid": "0be0079ed6c5de2859c4f9c6ffe949ae89f478d7", "url": "https://github.com/eclipse-openj9/openj9/commit/0be0079ed6c5de2859c4f9c6ffe949ae89f478d7", "message": "JITServer: Eliminate cpu.getProcessorDescription() remote override\n\nThere is only one place in the entire codebase where it makes sense to grab processor description from the client.\nThere is no need to do a remote override for this method unlike the other methods that get called in many places in the codebase.\nEliminate the remote call to client in getProcessorDescription to avoid any confusions and make the code a little bit faster.\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-09-29T23:58:03Z", "type": "forcePushed"}, {"oid": "9a6fb4804a6ce439b65744c9a1e2dfce5d47f62e", "url": "https://github.com/eclipse-openj9/openj9/commit/9a6fb4804a6ce439b65744c9a1e2dfce5d47f62e", "message": "JITServer: Eliminate cpu.getProcessorDescription() remote override\n\nThere is only one place in the entire codebase where it makes sense to grab processor description from the client.\nThere is no need to do a remote override for this method unlike the other methods that get called in many places in the codebase.\nEliminate the remote call to client in getProcessorDescription to avoid any confusions and make the code a little bit faster.\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-09-30T00:00:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg1NjExOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10748#discussion_r499856118", "bodyText": "that is a CompilationInfoPerThreadBase and you should be able to obtain the client data from there.", "author": "mpirvu", "createdAt": "2020-10-05T20:33:59Z", "path": "runtime/compiler/control/CompilationThread.cpp", "diffHunk": "@@ -8513,7 +8513,7 @@ TR::CompilationInfoPerThreadBase::wrappedCompile(J9PortLibrary *portLib, void *\n #if defined(J9VM_OPT_JITSERVER)\n          if (that->_methodBeingCompiled->isOutOfProcessCompReq())\n             {\n-            OMRProcessorDesc JITClientProcessorDesc = TR::Compiler->target.cpu.getProcessorDescription();\n+            OMRProcessorDesc JITClientProcessorDesc = that->_methodBeingCompiled->_compInfoPT->getClientData()->getOrCacheVMInfo(that->_methodBeingCompiled->_stream)->_processorDescription;", "originalCommit": "9a6fb4804a6ce439b65744c9a1e2dfce5d47f62e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg1OTgwNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10748#discussion_r499859805", "bodyText": "Since this path is never supposed to be taken, you could transform this assert into a fatal one without the risk of adding extra overhead.", "author": "mpirvu", "createdAt": "2020-10-05T20:41:09Z", "path": "runtime/compiler/env/J9CPU.cpp", "diffHunk": "@@ -24,22 +24,19 @@\n #pragma csect(STATIC,\"J9J9CPU#S\")\n #pragma csect(TEST,\"J9J9CPU#T\")\n \n-#include \"control/CompilationRuntime.hpp\"\n-#include \"env/CompilerEnv.hpp\"\n #include \"env/CPU.hpp\"\n-#include \"env/VMJ9.h\"\n-#include \"j9.h\"\n-#include \"j9port.h\"\n+#include \"infra/Assert.hpp\"                         // for TR_ASSERT\n \n-OMRProcessorDesc\n-J9::CPU::getProcessorDescription()\n+const char *\n+J9::CPU::getProcessorVendorId() \n    {\n-#if defined(J9VM_OPT_JITSERVER)\n-   if (auto stream = TR::CompilationInfo::getStream())\n-      {\n-      auto *vmInfo = TR::compInfoPT->getClientData()->getOrCacheVMInfo(stream);\n-      return vmInfo->_processorDescription;\n-      }\n-#endif /* defined(J9VM_OPT_JITSERVER) */\n-   return _processorDescription;\n+   TR_ASSERT(false, \"Vendor ID not defined for this platform!\");", "originalCommit": "9a6fb4804a6ce439b65744c9a1e2dfce5d47f62e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg1OTk3Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10748#discussion_r499859977", "bodyText": "Same comment as above", "author": "mpirvu", "createdAt": "2020-10-05T20:41:29Z", "path": "runtime/compiler/env/J9CPU.cpp", "diffHunk": "@@ -24,22 +24,19 @@\n #pragma csect(STATIC,\"J9J9CPU#S\")\n #pragma csect(TEST,\"J9J9CPU#T\")\n \n-#include \"control/CompilationRuntime.hpp\"\n-#include \"env/CompilerEnv.hpp\"\n #include \"env/CPU.hpp\"\n-#include \"env/VMJ9.h\"\n-#include \"j9.h\"\n-#include \"j9port.h\"\n+#include \"infra/Assert.hpp\"                         // for TR_ASSERT\n \n-OMRProcessorDesc\n-J9::CPU::getProcessorDescription()\n+const char *\n+J9::CPU::getProcessorVendorId() \n    {\n-#if defined(J9VM_OPT_JITSERVER)\n-   if (auto stream = TR::CompilationInfo::getStream())\n-      {\n-      auto *vmInfo = TR::compInfoPT->getClientData()->getOrCacheVMInfo(stream);\n-      return vmInfo->_processorDescription;\n-      }\n-#endif /* defined(J9VM_OPT_JITSERVER) */\n-   return _processorDescription;\n+   TR_ASSERT(false, \"Vendor ID not defined for this platform!\");\n+   return NULL;\n+   }\n+\n+uint32_t \n+J9::CPU::getProcessorSignature()\n+   {\n+   TR_ASSERT(false, \"Processor Signature not defined for this platform!\"); ", "originalCommit": "9a6fb4804a6ce439b65744c9a1e2dfce5d47f62e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "31d000a2fd113803c59483f3574d9bd66859d453", "url": "https://github.com/eclipse-openj9/openj9/commit/31d000a2fd113803c59483f3574d9bd66859d453", "message": "JITServer: Eliminate cpu.getProcessorDescription() remote override\n\nThere is only one place in the entire codebase where it makes sense to grab processor description from the client.\nThere is no need to do a remote override for this method unlike the other methods that get called in many places in the codebase.\nEliminate the remote call to client in getProcessorDescription to avoid any confusions and make the code a little bit faster.\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-10-05T22:05:47Z", "type": "forcePushed"}, {"oid": "9986ea8d69cb7c895990ade2687c872e5a6cced8", "url": "https://github.com/eclipse-openj9/openj9/commit/9986ea8d69cb7c895990ade2687c872e5a6cced8", "message": "JITServer: Eliminate cpu.getProcessorDescription() remote override\n\nThere is only one place in the entire codebase where it makes sense to grab processor description from the client.\nThere is no need to do a remote override for this method unlike the other methods that get called in many places in the codebase.\nEliminate the remote call to client in getProcessorDescription to avoid any confusions and make the code a little bit faster.\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-10-07T15:30:04Z", "type": "forcePushed"}, {"oid": "36fe929d9c478aecb6556bddbe71b9b671d90d0f", "url": "https://github.com/eclipse-openj9/openj9/commit/36fe929d9c478aecb6556bddbe71b9b671d90d0f", "message": "JITServer: Eliminate cpu.getProcessorDescription() remote override\n\nThere is only one place in the entire codebase where it makes sense to grab processor description from the client.\nThere is no need to do a remote override for this method unlike the other methods that get called in many places in the codebase.\nEliminate the remote call to client in getProcessorDescription to avoid any confusions and make the code a little bit faster.\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-10-07T15:34:38Z", "type": "forcePushed"}, {"oid": "4ca88e951384844ede5fb54211da26846dda3733", "url": "https://github.com/eclipse-openj9/openj9/commit/4ca88e951384844ede5fb54211da26846dda3733", "message": "JITServer: Eliminate cpu.getProcessorDescription() remote override\n\nThere is only one place in the entire codebase where it makes sense to grab processor description from the client.\nThere is no need to do a remote override for this method unlike the other methods that get called in many places in the codebase.\nEliminate the remote call to client in getProcessorDescription to avoid any confusions and make the code a little bit faster.\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-10-07T16:21:42Z", "type": "commit"}, {"oid": "4ca88e951384844ede5fb54211da26846dda3733", "url": "https://github.com/eclipse-openj9/openj9/commit/4ca88e951384844ede5fb54211da26846dda3733", "message": "JITServer: Eliminate cpu.getProcessorDescription() remote override\n\nThere is only one place in the entire codebase where it makes sense to grab processor description from the client.\nThere is no need to do a remote override for this method unlike the other methods that get called in many places in the codebase.\nEliminate the remote call to client in getProcessorDescription to avoid any confusions and make the code a little bit faster.\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-10-07T16:21:42Z", "type": "forcePushed"}]}