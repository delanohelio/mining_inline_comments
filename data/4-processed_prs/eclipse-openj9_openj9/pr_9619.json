{"pr_number": 9619, "pr_title": "CMake: update the way we handle appending the \"29\" suffix on libs", "pr_createdAt": "2020-05-20T01:58:56Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/9619", "timeline": [{"oid": "30b19c8b5744ef0b3c7b2c9fac0570e2085a7469", "url": "https://github.com/eclipse-openj9/openj9/commit/30b19c8b5744ef0b3c7b2c9fac0570e2085a7469", "message": "CMake: update the way we handle appending the \"29\" suffix on libs\n\nOld method of updating CMAKE_SHARED_LIBRARY_SUFFIX was clunky and\nproblematic. However now that we have j9vm_add_library, it provides\nus an easy place to implement the desired behaviour.\n\nNote: the NO_VERSION_SUFFIX corresponds to\n<artifact ... appendrelease=\"false\"> in uma\n\nSigned-off-by: Devin Nakamura <devinn@ca.ibm.com>", "committedDate": "2020-05-20T02:21:15Z", "type": "forcePushed"}, {"oid": "e846aa3ddce9aa196ada5571e2ea58755c3d62a7", "url": "https://github.com/eclipse-openj9/openj9/commit/e846aa3ddce9aa196ada5571e2ea58755c3d62a7", "message": "CMake: update the way we handle appending the \"29\" suffix on libs\n\nOld method of updating CMAKE_SHARED_LIBRARY_SUFFIX was clunky and\nproblematic. However now that we have j9vm_add_library, it provides\nus an easy place to implement the desired behaviour.\n\nNote: the NO_VERSION_SUFFIX corresponds to\n<artifact ... appendrelease=\"false\"> in uma\n\nSigned-off-by: Devin Nakamura <devinn@ca.ibm.com>", "committedDate": "2020-05-20T14:22:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkyODM3OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9619#discussion_r428928379", "bodyText": "typo: arroung -> around", "author": "keithc-ca", "createdAt": "2020-05-21T21:33:50Z", "path": "runtime/cmake/J9vmTargetSupport.cmake", "diffHunk": "@@ -20,15 +20,50 @@\n # SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-exception-2.0 OR LicenseRef-GPL-2.0 WITH Assembly-exception\n ################################################################################\n \n+if(J9VM_TARGET_SUPPORT)\n+\treturn()\n+endif()\n+set(J9VM_TARGET_SUPPORT 1)\n+\n include(OmrTargetSupport)\n \n-# Currently j9vm_add_library and j9vm_add_executable just call\n-# omr_add_library and omr_add_executable, but have them so that we can add\n-# functionality in the future, without having to hunt down all the \n-# add_library/add_executable calls.\n+# Currently j9vm_add_library and j9vm_add_executable are wrappers arroung", "originalCommit": "e846aa3ddce9aa196ada5571e2ea58755c3d62a7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkyOTIwMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/9619#discussion_r428929202", "bodyText": "For libraries other than shared libraries this loses OUTPUT_NAME if specified.", "author": "keithc-ca", "createdAt": "2020-05-21T21:35:14Z", "path": "runtime/cmake/J9vmTargetSupport.cmake", "diffHunk": "@@ -20,15 +20,50 @@\n # SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-exception-2.0 OR LicenseRef-GPL-2.0 WITH Assembly-exception\n ################################################################################\n \n+if(J9VM_TARGET_SUPPORT)\n+\treturn()\n+endif()\n+set(J9VM_TARGET_SUPPORT 1)\n+\n include(OmrTargetSupport)\n \n-# Currently j9vm_add_library and j9vm_add_executable just call\n-# omr_add_library and omr_add_executable, but have them so that we can add\n-# functionality in the future, without having to hunt down all the \n-# add_library/add_executable calls.\n+# Currently j9vm_add_library and j9vm_add_executable are wrappers arroung\n+# omr_add_library and omr_add_executable. Here we only document the additional\n+# functionality provided. For full information see cmake/moudles/OmrTargetSupport.cmake\n+# from omr\n+\n+# j9vm_add_library(<target_name> <library_type> [options ...] [source ...] )\n+#  NO_VERSION_SUFFIX  - Don't append a version suffix  (eg 29) on the output file name.\n+#                       Note: Only applies to SHARED libraries\n+function(j9vm_add_library name type)\n+\tset(options NO_VERSION_SUFFIX)\n+\tset(oneValueArgs OUTPUT_NAME)\n+\tset(multiValueArgs)\n+\tcmake_parse_arguments(opt \"${options}\" \"${oneValueArgs}\" \"${multiValueArgs}\" ${ARGN})\n+\n+\t# Check if we need to append a version suffix eg '29'\n+\tset(output_name_args)\n+\tif(type STREQUAL \"SHARED\")", "originalCommit": "e846aa3ddce9aa196ada5571e2ea58755c3d62a7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkyOTc2NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9619#discussion_r428929765", "bodyText": "If OUTPUT_NAME is explicitly specified, I don't think the version suffix should be added even if NO_VERSION_SUFFIX was not specified.", "author": "keithc-ca", "createdAt": "2020-05-21T21:36:21Z", "path": "runtime/cmake/J9vmTargetSupport.cmake", "diffHunk": "@@ -20,15 +20,50 @@\n # SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-exception-2.0 OR LicenseRef-GPL-2.0 WITH Assembly-exception\n ################################################################################\n \n+if(J9VM_TARGET_SUPPORT)\n+\treturn()\n+endif()\n+set(J9VM_TARGET_SUPPORT 1)\n+\n include(OmrTargetSupport)\n \n-# Currently j9vm_add_library and j9vm_add_executable just call\n-# omr_add_library and omr_add_executable, but have them so that we can add\n-# functionality in the future, without having to hunt down all the \n-# add_library/add_executable calls.\n+# Currently j9vm_add_library and j9vm_add_executable are wrappers arroung\n+# omr_add_library and omr_add_executable. Here we only document the additional\n+# functionality provided. For full information see cmake/moudles/OmrTargetSupport.cmake\n+# from omr\n+\n+# j9vm_add_library(<target_name> <library_type> [options ...] [source ...] )\n+#  NO_VERSION_SUFFIX  - Don't append a version suffix  (eg 29) on the output file name.\n+#                       Note: Only applies to SHARED libraries\n+function(j9vm_add_library name type)\n+\tset(options NO_VERSION_SUFFIX)\n+\tset(oneValueArgs OUTPUT_NAME)\n+\tset(multiValueArgs)\n+\tcmake_parse_arguments(opt \"${options}\" \"${oneValueArgs}\" \"${multiValueArgs}\" ${ARGN})\n+\n+\t# Check if we need to append a version suffix eg '29'\n+\tset(output_name_args)\n+\tif(type STREQUAL \"SHARED\")\n+\t\t# If OUTPUT_NAME is specified, use that as the starting name\n+\t\t# otherwise the name of the cmake target is our starting point\n+\t\tif(opt_OUTPUT_NAME)\n+\t\t\tset(output_name \"${opt_OUTPUT_NAME}\")\n+\t\telse()\n+\t\t\tset(output_name \"${name}\")\n+\t\tendif()\n+\n+\t\t# Default to appending a version suffix, unless we are told not to\n+\t\tif(NOT opt_NO_VERSION_SUFFIX)", "originalCommit": "e846aa3ddce9aa196ada5571e2ea58755c3d62a7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkzMzAxOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9619#discussion_r428933018", "bodyText": "typo: moudles -> modules", "author": "keithc-ca", "createdAt": "2020-05-21T21:43:52Z", "path": "runtime/cmake/J9vmTargetSupport.cmake", "diffHunk": "@@ -20,15 +20,50 @@\n # SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-exception-2.0 OR LicenseRef-GPL-2.0 WITH Assembly-exception\n ################################################################################\n \n+if(J9VM_TARGET_SUPPORT)\n+\treturn()\n+endif()\n+set(J9VM_TARGET_SUPPORT 1)\n+\n include(OmrTargetSupport)\n \n-# Currently j9vm_add_library and j9vm_add_executable just call\n-# omr_add_library and omr_add_executable, but have them so that we can add\n-# functionality in the future, without having to hunt down all the \n-# add_library/add_executable calls.\n+# Currently j9vm_add_library and j9vm_add_executable are wrappers arroung\n+# omr_add_library and omr_add_executable. Here we only document the additional\n+# functionality provided. For full information see cmake/moudles/OmrTargetSupport.cmake", "originalCommit": "e846aa3ddce9aa196ada5571e2ea58755c3d62a7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "78571f54f2a3b7866ab06274298a43907b35bb0b", "url": "https://github.com/eclipse-openj9/openj9/commit/78571f54f2a3b7866ab06274298a43907b35bb0b", "message": "CMake: update the way we handle appending the \"29\" suffix on libs\n\nOld method of updating CMAKE_SHARED_LIBRARY_SUFFIX was clunky and\nproblematic. Now version suffix is explicity added by using the\nOUTPUT_NAME parameter of j9vm_add_library.\n\nSigned-off-by: Devin Nakamura <devinn@ca.ibm.com>", "committedDate": "2020-05-22T18:09:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM5NTEyNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9619#discussion_r429395127", "bodyText": "This should be j9trc${J9VM_VERSION_SUFFIX}.", "author": "keithc-ca", "createdAt": "2020-05-22T18:27:52Z", "path": "runtime/rastrace/CMakeLists.txt", "diffHunk": "@@ -26,6 +26,7 @@ add_tracegen(j9trc_aux.tdf)\n add_tracegen(mt.tdf)\n \n j9vm_add_library(j9trc SHARED\n+\tOUTPUT_NAME j9trc", "originalCommit": "78571f54f2a3b7866ab06274298a43907b35bb0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQwMTQ2OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9619#discussion_r429401468", "bodyText": "The lines above should be removed:\n# Don't append version suffix.\nset(CMAKE_SHARED_LIBRARY_SUFFIX ${J9VM_OLD_SHARED_SUFFIX})", "author": "keithc-ca", "createdAt": "2020-05-22T18:43:36Z", "path": "runtime/redirector/CMakeLists.txt", "diffHunk": "@@ -28,7 +28,10 @@ set_source_files_properties(\"${CMAKE_CURRENT_BINARY_DIR}/generated.c\" PROPERTIES\n ################################################################################\n # Redirector\n ################################################################################\n-j9vm_add_library(jvm_redirect SHARED\n+j9vm_add_library(jvm_redirect", "originalCommit": "78571f54f2a3b7866ab06274298a43907b35bb0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQwMjc0NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9619#discussion_r429402745", "bodyText": "The lines above should be removed:\n#re-enable version num suffix\nset(CMAKE_SHARED_LIBRARY_SUFFIX ${J9VM_SHARED_LIBRARY_SUFFIX})", "author": "keithc-ca", "createdAt": "2020-05-22T18:46:52Z", "path": "runtime/tests/thread/CMakeLists.txt", "diffHunk": "@@ -45,6 +45,7 @@ target_link_libraries(thread_cutest_harness\n \n \n j9vm_add_library(j9thrtestnatives SHARED\n+\tOUTPUT_NAME j9thrtestnatives${J9VM_VERSION_SUFFIX}", "originalCommit": "78571f54f2a3b7866ab06274298a43907b35bb0b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b1cd05a220b1354ad6887959da82f0fed8f545bd", "url": "https://github.com/eclipse-openj9/openj9/commit/b1cd05a220b1354ad6887959da82f0fed8f545bd", "message": "CMake: update the way we handle appending the \"29\" suffix on libs\n\nOld method of updating CMAKE_SHARED_LIBRARY_SUFFIX was clunky and\nproblematic. Now version suffix is explicity added by using the\nOUTPUT_NAME parameter of j9vm_add_library.\n\nSigned-off-by: Devin Nakamura <devinn@ca.ibm.com>", "committedDate": "2020-05-22T18:56:25Z", "type": "commit"}, {"oid": "b1cd05a220b1354ad6887959da82f0fed8f545bd", "url": "https://github.com/eclipse-openj9/openj9/commit/b1cd05a220b1354ad6887959da82f0fed8f545bd", "message": "CMake: update the way we handle appending the \"29\" suffix on libs\n\nOld method of updating CMAKE_SHARED_LIBRARY_SUFFIX was clunky and\nproblematic. Now version suffix is explicity added by using the\nOUTPUT_NAME parameter of j9vm_add_library.\n\nSigned-off-by: Devin Nakamura <devinn@ca.ibm.com>", "committedDate": "2020-05-22T18:56:25Z", "type": "forcePushed"}]}