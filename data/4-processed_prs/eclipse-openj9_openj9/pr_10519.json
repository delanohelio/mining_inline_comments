{"pr_number": 10519, "pr_title": "Exploit prefixed instruction in IPIC sequence on POWER10", "pr_createdAt": "2020-09-03T17:57:30Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10519", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzMwODY4MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10519#discussion_r483308681", "bodyText": "Should not it be shift left by 14, not 16 ?", "author": "gita-omr", "createdAt": "2020-09-03T23:40:47Z", "path": "runtime/compiler/runtime/Trampoline.cpp", "diffHunk": "@@ -480,25 +480,36 @@ bool ppcCodePatching(void *method, void *callSite, void *currentPC, void *curren\n \n          oldBits = *(int32_t *)((uint8_t *)callSite - encodingStartOffset);     // The load of the first IPIC cache slot or rldimi\n #if defined(TR_TARGET_64BIT)\n-         if (((oldBits>>26) & 0x0000003F) != 30)\n+         if (TR::Compiler->target.cpu.isAtLeast(OMR_PROCESSOR_PPC_P10))\n             {\n-            // PTOC was used, oldBits is ld\n-            currentDistance = oldBits<<16>>16;\n-            if (((oldBits>>16) & 0x0000001F) == 12)\n-               {\n-               oldBits = *(int32_t *)((uint8_t *)callSite - encodingStartOffset - 4);\n-               currentDistance += oldBits<<16;\n-               }\n-            patchAddr = *(uint8_t **)(*(intptr_t *)extra + currentDistance);\n+            // oldBits is the latter half of paddi\n+            distance = ((*(int32_t *)((uint8_t *)callSite - encodingStartOffset - 4)) & 0x0003FFFF) << 16;", "originalCommit": "fcd9772caa2b5650cd593722e4619d49caf0f528", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzczNTI3NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10519#discussion_r483735274", "bodyText": "no, it should be shift left by 16.  the 34-bit offset is composed of  (top-18-bit << 16) |  (bottom-16-bit).  shift left by 14 will overlap two bits, and the whole offset will be 32bit at most.\nyour comment did remind me of the possibility of losing bits, if the shift is conducted on a 32-bit type.  so, i type-cast the 18-bit to intptr_t in order to not lose bits possibly.  in reality, it cannot happen though (since this particular offset must be positive and less than this particular method compiled length).  amend this commit as below.", "author": "zl-wang", "createdAt": "2020-09-04T16:35:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzMwODY4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTY4MjEwMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10519#discussion_r485682103", "bodyText": "You are right. But perhaps breaking it into two statements: getting the upper word of the instruction and then shifting it would've been more clear, or providing a comment.", "author": "gita-omr", "createdAt": "2020-09-09T15:00:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzMwODY4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc0MzQxMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10519#discussion_r485743412", "bodyText": "Done", "author": "zl-wang", "createdAt": "2020-09-09T16:19:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzMwODY4MQ=="}], "type": "inlineReview"}, {"oid": "50ba021366e5ab23b4f275a0753912d611cccc39", "url": "https://github.com/eclipse-openj9/openj9/commit/50ba021366e5ab23b4f275a0753912d611cccc39", "message": "Exploit prefixed instruction in IPIC sequence on POWER10\n\nPreviously, either pTOC entry or long sequence are used in gettting\nthe snippet address. Prefixed instruction can be used for the same\npurpose nicely on P10 without pTOC.\n\nCorrespondingly, interface snippet emitting needs to change. In\nparticular, CallSitePatching needs to be adjusted as well.\n\nType-casting for the top 18-bit offset to avoid potential loss of bits.\n\nSigned-off-by: Julian Wang <zlwang@ca.ibm.com>", "committedDate": "2020-09-04T19:00:08Z", "type": "forcePushed"}, {"oid": "a4e4f2ef09e43426ff47167b3c6bf7f36b1430d8", "url": "https://github.com/eclipse-openj9/openj9/commit/a4e4f2ef09e43426ff47167b3c6bf7f36b1430d8", "message": "Exploit prefixed instruction in IPIC sequence on POWER10\n\nPreviously, either pTOC entry or long sequence are used in gettting\nthe snippet address. Prefixed instruction can be used for the same\npurpose nicely on P10 without pTOC.\n\nCorrespondingly, interface snippet emitting needs to change. In\nparticular, CallSitePatching needs to be adjusted as well.\n\nType-casting for the top 18-bit offset to avoid potential loss of bits.\n\nSplit the code to make it clearer.\n\nSigned-off-by: Julian Wang <zlwang@ca.ibm.com>", "committedDate": "2020-09-09T18:33:19Z", "type": "forcePushed"}, {"oid": "a4e4f2ef09e43426ff47167b3c6bf7f36b1430d8", "url": "https://github.com/eclipse-openj9/openj9/commit/a4e4f2ef09e43426ff47167b3c6bf7f36b1430d8", "message": "Exploit prefixed instruction in IPIC sequence on POWER10\n\nPreviously, either pTOC entry or long sequence are used in gettting\nthe snippet address. Prefixed instruction can be used for the same\npurpose nicely on P10 without pTOC.\n\nCorrespondingly, interface snippet emitting needs to change. In\nparticular, CallSitePatching needs to be adjusted as well.\n\nType-casting for the top 18-bit offset to avoid potential loss of bits.\n\nSplit the code to make it clearer.\n\nSigned-off-by: Julian Wang <zlwang@ca.ibm.com>", "committedDate": "2020-09-09T18:33:19Z", "type": "commit"}]}