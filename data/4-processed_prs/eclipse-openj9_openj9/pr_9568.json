{"pr_number": 9568, "pr_title": "Resolve classref in checkcast if Qtype", "pr_createdAt": "2020-05-14T19:52:48Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/9568", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM5MjM3Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9568#discussion_r425392373", "bodyText": "@cathyzhyi Is this helper fine?", "author": "tajila", "createdAt": "2020-05-14T19:53:17Z", "path": "runtime/oti/j9nonbuilder.h", "diffHunk": "@@ -4535,6 +4535,7 @@ typedef struct J9InternalVMFunctions {\n #endif /* J9VM_OPT_JITSERVER */\n \tIDATA ( *createJoinableThreadWithCategory)(omrthread_t* handle, UDATA stacksize, UDATA priority, UDATA suspend, omrthread_entrypoint_t entrypoint, void* entryarg, U_32 category) ;\n \tBOOLEAN ( *valueTypeCapableAcmp)(struct J9VMThread *currentThread, j9object_t lhs, j9object_t rhs) ;\n+\tBOOLEAN ( *isClassRefQtypeHelper)(struct J9Class *cpContextClass, U_16 cpIndex) ;", "originalCommit": "e4476f0740986b53ecac8ae32c5e470a6c87829b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQzMjI0MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9568#discussion_r425432240", "bodyText": "Yes, it works for us. Thanks!", "author": "cathyzhyi", "createdAt": "2020-05-14T21:09:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM5MjM3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQ1NDA2NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9568#discussion_r425454064", "bodyText": "I'd rather this wasn't named \"helper\" - I don't think there would be a conflict with the inline C++ version.", "author": "gacholio", "createdAt": "2020-05-14T21:57:16Z", "path": "runtime/vm/ValueTypeHelpers.cpp", "diffHunk": "@@ -63,4 +63,10 @@ valueTypeCapableAcmp(J9VMThread *currentThread, j9object_t lhs, j9object_t rhs)\n \tMM_ObjectAccessBarrierAPI objectAccessBarrier(currentThread);\n \treturn VM_ValueTypeHelpers::acmp(currentThread, objectAccessBarrier, lhs, rhs);\n }\n+\n+BOOLEAN\n+isClassRefQtypeHelper(J9Class *cpContextClass, U_16 cpIndex)", "originalCommit": "e4476f0740986b53ecac8ae32c5e470a6c87829b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTUyNTg5NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9568#discussion_r425525895", "bodyText": "Is there a verifier constraint that the length will never be 0?", "author": "gacholio", "createdAt": "2020-05-15T02:05:09Z", "path": "runtime/vm/ValueTypeHelpers.hpp", "diffHunk": "@@ -236,6 +236,24 @@ class VM_ValueTypeHelpers {\n \t\treturn acmpResult;\n \t}\n \n+\tstatic VMINLINE bool\n+\tisClassRefQtype(J9ConstantPool *ramCP, U_16 cpIndex)\n+\t{\n+\t\tJ9ROMStringRef *romStringRef = (J9ROMStringRef *)&ramCP->romConstantPool[cpIndex];\n+\t\tJ9UTF8 *classNameWrapper = J9ROMSTRINGREF_UTF8DATA(romStringRef);\n+\t\tU_16 classNameLength = J9UTF8_LENGTH(classNameWrapper);", "originalCommit": "e4476f0740986b53ecac8ae32c5e470a6c87829b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTc4NjUxOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9568#discussion_r425786518", "bodyText": "yes checkNameImpl via bcvCheckClassName verifies that name length is not zero", "author": "tajila", "createdAt": "2020-05-15T13:03:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTUyNTg5NQ=="}], "type": "inlineReview"}, {"oid": "eabb7d09cf94ec0eea0d4c572013b00b0ad4c940", "url": "https://github.com/eclipse-openj9/openj9/commit/eabb7d09cf94ec0eea0d4c572013b00b0ad4c940", "message": "Resolve classref in checkcast if Qtype\n\nCurrently, if the receiver for a checkcast is NULL the VM does not\nbother resolve the classref and the checkcast test passes. With VTs this\nbehaviour is not allowed as NULL cannot be assigned to VTs. VTs will\nalways have Qsignatures, therefore, if the classref oin a checkcast has\na qsignature it must be resolved, regardless of what the receiver is.\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>", "committedDate": "2020-05-15T13:03:48Z", "type": "commit"}, {"oid": "eabb7d09cf94ec0eea0d4c572013b00b0ad4c940", "url": "https://github.com/eclipse-openj9/openj9/commit/eabb7d09cf94ec0eea0d4c572013b00b0ad4c940", "message": "Resolve classref in checkcast if Qtype\n\nCurrently, if the receiver for a checkcast is NULL the VM does not\nbother resolve the classref and the checkcast test passes. With VTs this\nbehaviour is not allowed as NULL cannot be assigned to VTs. VTs will\nalways have Qsignatures, therefore, if the classref oin a checkcast has\na qsignature it must be resolved, regardless of what the receiver is.\n\nSigned-off-by: Tobi Ajila <atobia@ca.ibm.com>", "committedDate": "2020-05-15T13:03:48Z", "type": "forcePushed"}]}