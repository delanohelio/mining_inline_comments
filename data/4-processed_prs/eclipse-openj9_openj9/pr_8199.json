{"pr_number": 8199, "pr_title": "Use compiler-local target environment", "pr_createdAt": "2020-01-03T19:16:48Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/8199", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg3NzY5MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8199#discussion_r364877691", "bodyText": "@0xdaryl @knn-k FYI I'm not sure why we have architecture guards for this. I'm sure ARM/AArch64 could benefit.", "author": "fjeremic", "createdAt": "2020-01-09T17:50:45Z", "path": "runtime/compiler/codegen/CodeGenGC.cpp", "diffHunk": "@@ -378,7 +378,7 @@ J9::CodeGenerator::createStackAtlas()\n             localObjectsFound = true;\n             int32_t localObjectAlignment = comp->fej9()->getLocalObjectAlignmentInBytes();\n             if (localObjectAlignment > stackSlotSize &&\n-                (TR::Compiler->target.cpu.isX86() || TR::Compiler->target.cpu.isPower() || TR::Compiler->target.cpu.isZ()))\n+                (comp->target().cpu.isX86() || comp->target().cpu.isPower() || comp->target().cpu.isZ()))", "originalCommit": "b68bd81fc15387f2c174fb35c0e8d282124f75c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg3OTA4Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/8199#discussion_r364879086", "bodyText": "This is pretty scary looking code in idiom recognition...", "author": "fjeremic", "createdAt": "2020-01-09T17:54:00Z", "path": "runtime/compiler/optimizer/IdiomTransformations.cpp", "diffHunk": "@@ -4712,7 +4712,7 @@ makeCopyingTRTOInduction1Graph(TR::Compilation *c, int32_t ctrl, int32_t pattern\n    tgt->setMinCounts(1, 1, 1);  // minimum ifCount, indirectLoadCount, indirectStoreCount\n    tgt->setHotness(warm, false);\n    static char *versionLengthStr = feGetEnv(\"TR_CopyingTRTOInduction1Graph_versionLength\");\n-   static int   versionLength = versionLengthStr ? atoi(versionLengthStr) : (TR::Compiler->target.cpu.isPower() ? 0 : 8);\n+   static int   versionLength = versionLengthStr ? atoi(versionLengthStr) : (c->target().cpu.isPower() ? 0 : 8);\n    tgt->setVersionLength(versionLength);   // depending on each architecture", "originalCommit": "b68bd81fc15387f2c174fb35c0e8d282124f75c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg3OTc2Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/8199#discussion_r364879766", "bodyText": "Do these have to use self()? The one right below just calls comp()", "author": "fjeremic", "createdAt": "2020-01-09T17:55:32Z", "path": "runtime/compiler/p/codegen/J9CodeGenerator.cpp", "diffHunk": "@@ -728,9 +728,9 @@ J9::Power::CodeGenerator::insertPrefetchIfNecessary(TR::Node *node, TR::Register\n       }\n    else if (node->getOpCodeValue() == TR::awrtbari &&\n             comp()->getMethodHotness() >= scorching &&\n-            TR::Compiler->target.cpu.id() >= TR_PPCp6 &&\n-              (TR::Compiler->target.is32Bit() ||\n-                (TR::Compiler->target.is64Bit() &&\n+            self()->comp()->target().cpu.id() >= TR_PPCp6 &&\n+              (self()->comp()->target().is32Bit() ||\n+                (self()->comp()->target().is64Bit() &&\n                  comp()->useCompressedPointers() &&", "originalCommit": "b68bd81fc15387f2c174fb35c0e8d282124f75c3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg4MTg3Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8199#discussion_r364881873", "bodyText": "\ud83e\udd37\u200d\u2642 not sure, in an extensible class I always use self() just in case.", "author": "dsouzai", "createdAt": "2020-01-09T18:00:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg3OTc2Ng=="}], "type": "inlineReview"}, {"oid": "50564e70ea4eb51cd6f24423e3912c70f374d68c", "url": "https://github.com/eclipse-openj9/openj9/commit/50564e70ea4eb51cd6f24423e3912c70f374d68c", "message": "Update copyrights\n\nSigned-off-by: Irwin D'Souza <dsouzai.gh@gmail.com>", "committedDate": "2020-01-09T21:08:13Z", "type": "forcePushed"}, {"oid": "20b95129485f285935da74a77b3a6f48b7a83362", "url": "https://github.com/eclipse-openj9/openj9/commit/20b95129485f285935da74a77b3a6f48b7a83362", "message": "Add TR::Compilation parameter\n\nIn order to facilitate the use of the compiler local target environment\nrather than the global target environment, this commit modifies the\nparameter list of a couple of static methods to take a\nTR::Compilation pointer.\n\nSigned-off-by: Irwin D'Souza <dsouzai.gh@gmail.com>", "committedDate": "2020-01-10T19:53:01Z", "type": "commit"}, {"oid": "fb7b8da08527e52ba78a9a14fd33beff0ff66e13", "url": "https://github.com/eclipse-openj9/openj9/commit/fb7b8da08527e52ba78a9a14fd33beff0ff66e13", "message": "Use compiler local target environment\n\nSigned-off-by: Irwin D'Souza <dsouzai.gh@gmail.com>", "committedDate": "2020-01-10T19:53:47Z", "type": "commit"}, {"oid": "bcbc48207755785a728b869e8a02623ed7bf8c4a", "url": "https://github.com/eclipse-openj9/openj9/commit/bcbc48207755785a728b869e8a02623ed7bf8c4a", "message": "Remove unnecessary queries of target environment\n\nSigned-off-by: Irwin D'Souza <dsouzai.gh@gmail.com>", "committedDate": "2020-01-10T19:53:47Z", "type": "commit"}, {"oid": "382887f2d47cc36ed9c92e41c7b69161ec3b8a7c", "url": "https://github.com/eclipse-openj9/openj9/commit/382887f2d47cc36ed9c92e41c7b69161ec3b8a7c", "message": "Remove #if 0 guarded code\n\nSigned-off-by: Irwin D'Souza <dsouzai.gh@gmail.com>", "committedDate": "2020-01-10T19:53:47Z", "type": "commit"}, {"oid": "4df859b99a86a0e820b4cf5d0e3d6b454016db53", "url": "https://github.com/eclipse-openj9/openj9/commit/4df859b99a86a0e820b4cf5d0e3d6b454016db53", "message": "Update copyrights\n\nSigned-off-by: Irwin D'Souza <dsouzai.gh@gmail.com>", "committedDate": "2020-01-10T19:53:48Z", "type": "commit"}, {"oid": "4df859b99a86a0e820b4cf5d0e3d6b454016db53", "url": "https://github.com/eclipse-openj9/openj9/commit/4df859b99a86a0e820b4cf5d0e3d6b454016db53", "message": "Update copyrights\n\nSigned-off-by: Irwin D'Souza <dsouzai.gh@gmail.com>", "committedDate": "2020-01-10T19:53:48Z", "type": "forcePushed"}]}