{"pr_number": 10257, "pr_title": "Exit MemMonitor before jniCheckFatalErrorNLS() if not JNICHK_NONFATAL", "pr_createdAt": "2020-07-27T14:56:28Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10257", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk2NDU2NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10257#discussion_r460964564", "bodyText": "Please use the any bits macro here.", "author": "gacholio", "createdAt": "2020-07-27T15:12:59Z", "path": "runtime/jnichk/jnicmem.c", "diffHunk": "@@ -122,6 +126,9 @@ jniCheckMemoryInit(J9JavaVM* javaVM)\n \tPORT_ACCESS_FROM_JAVAVM(javaVM);\n \n \tomrthread_monitor_t globalMonitor = omrthread_global_monitor();\n+\tif (0 == (javaVM->checkJNIData.options & JNICHK_NONFATAL)) {", "originalCommit": "f4772552f3d8467a1e412865e4a3b82c2cdc1e1f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk4NDk3Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10257#discussion_r460984977", "bodyText": "Yeah, replace it with J9_ARE_NO_BITS_SET.\nPlease have another look.", "author": "JasonFengJ9", "createdAt": "2020-07-27T15:41:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk2NDU2NA=="}], "type": "inlineReview"}, {"oid": "1f3b3e5ed72fb3983ad9e173fdf05a19410a9347", "url": "https://github.com/eclipse-openj9/openj9/commit/1f3b3e5ed72fb3983ad9e173fdf05a19410a9347", "message": "Exit MemMonitor before jniCheckFatalErrorNLS() if not JNICHK_NONFATAL\n\nThis fixes a hang scenario:\nOne thread holds VM access and attempts to enter MemMonitor;\nAnother thread already entered MemMonitor, exitJavaVM() due to\nfatalError(), and acquireExclusiveVMAccessFromExternalThread() but can't\nacquire exclusive VM access because last thread holds the VM access\nwhich can't proceed either since this thread holds MemMonitor, hence\ndeadlock.\nThis PR exits MemMonitor before invoking\njniCheckFatalErrorNLS()/fatalError() to avoid the hang scenario above.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>", "committedDate": "2020-07-27T15:40:50Z", "type": "commit"}, {"oid": "1f3b3e5ed72fb3983ad9e173fdf05a19410a9347", "url": "https://github.com/eclipse-openj9/openj9/commit/1f3b3e5ed72fb3983ad9e173fdf05a19410a9347", "message": "Exit MemMonitor before jniCheckFatalErrorNLS() if not JNICHK_NONFATAL\n\nThis fixes a hang scenario:\nOne thread holds VM access and attempts to enter MemMonitor;\nAnother thread already entered MemMonitor, exitJavaVM() due to\nfatalError(), and acquireExclusiveVMAccessFromExternalThread() but can't\nacquire exclusive VM access because last thread holds the VM access\nwhich can't proceed either since this thread holds MemMonitor, hence\ndeadlock.\nThis PR exits MemMonitor before invoking\njniCheckFatalErrorNLS()/fatalError() to avoid the hang scenario above.\n\nSigned-off-by: Jason Feng <fengj@ca.ibm.com>", "committedDate": "2020-07-27T15:40:50Z", "type": "forcePushed"}]}