{"pr_number": 9067, "pr_title": "Move FrontEnd containesZeroOrOneConcreteClass into ClassEnv", "pr_createdAt": "2020-04-01T13:16:56Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/9067", "timeline": [{"oid": "67e5393b7cc22376d5eb68145e8e5af57a60f404", "url": "https://github.com/eclipse-openj9/openj9/commit/67e5393b7cc22376d5eb68145e8e5af57a60f404", "message": "Move FrontEnd noMultipleConcreteClasses into ClassEnv\n\nFrontEnd is depreciated, thus moving numConcreteClass\nfrontend query into ClassEnv\n\nSigned-off-by: Chris Chong <Zichun.Chong@ibm.com>", "committedDate": "2020-04-01T13:47:02Z", "type": "forcePushed"}, {"oid": "72a8c8b0d33e07aa62c691826af35dd520e87094", "url": "https://github.com/eclipse-openj9/openj9/commit/72a8c8b0d33e07aa62c691826af35dd520e87094", "message": "Move FrontEnd noMultipleConcreteClasses into ClassEnv\n\nOMR FrontEnd is depreciated\nThus removing noMultipleConcreteClasses frontend query, and\nmove it to ClassEnv\n\nSigned-off-by: Chris Chong <Zichun.Chong@ibm.com>", "committedDate": "2020-04-01T14:18:09Z", "type": "forcePushed"}, {"oid": "2823d78ac17b00b2a14a7f79fe8f989a705f96c4", "url": "https://github.com/eclipse-openj9/openj9/commit/2823d78ac17b00b2a14a7f79fe8f989a705f96c4", "message": "Move FrontEnd noMultipleConcreteClasses into ClassEnv\n\nOMR FrontEnd is depreciated\nThus removing noMultipleConcreteClasses frontend query, and\nmove it to ClassEnv\n\nSigned-off-by: Chris Chong <Zichun.Chong@ibm.com>", "committedDate": "2020-04-01T19:03:35Z", "type": "forcePushed"}, {"oid": "8309612c33ca70889ebea3ceca695805168cff2b", "url": "https://github.com/eclipse-openj9/openj9/commit/8309612c33ca70889ebea3ceca695805168cff2b", "message": "Move FrontEnd noMultipleConcreteClasses into ClassEnv\n\nOMR FrontEnd is depreciated\nThus removing noMultipleConcreteClasses frontend query, and\nmove it to ClassEnv\nAlso rename the function to containesZeroOrOneConcreteClass\n\nSigned-off-by: Chris Chong <Zichun.Chong@ibm.com>", "committedDate": "2020-04-02T14:53:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYyNzk2OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9067#discussion_r402627968", "bodyText": "You need to include the header file with the definition of TR_PersistentClassInfo", "author": "mpirvu", "createdAt": "2020-04-02T22:17:24Z", "path": "runtime/compiler/env/J9ClassEnv.cpp", "diffHunk": "@@ -38,6 +38,8 @@\n #include \"j9fieldsInfo.h\"\n #include \"rommeth.h\"\n \n+class TR_PersistentClassInfo;", "originalCommit": "8309612c33ca70889ebea3ceca695805168cff2b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA1MTA4OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9067#discussion_r403051089", "bodyText": "Okay, TR_PersistentClassInfo is defined in RuntimeAssumptions.hpp, added below line in this file.\n#include \"runtime/RuntimeAssumptions.hpp\"", "author": "chrisc66", "createdAt": "2020-04-03T14:36:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYyNzk2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYyODU4MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9067#discussion_r402628580", "bodyText": "typo: caches --> cached", "author": "mpirvu", "createdAt": "2020-04-02T22:18:53Z", "path": "runtime/compiler/env/J9ClassEnv.cpp", "diffHunk": "@@ -642,3 +644,57 @@ J9::ClassEnv::isValueTypeClass(TR_OpaqueClassBlock *clazz)\n    J9Class *j9class = reinterpret_cast<J9Class*>(clazz);\n    return J9_IS_J9CLASS_VALUETYPE(j9class);\n    }\n+\n+bool \n+J9::ClassEnv::containesZeroOrOneConcreteClass(TR::Compilation *comp, List<TR_PersistentClassInfo>* subClasses)\n+   {\n+   int count = 0;\n+#if defined(J9VM_OPT_JITSERVER)\n+   ListIterator<TR_PersistentClassInfo> j(subClasses);\n+   TR_ScratchList<TR_PersistentClassInfo> subClassesNotCached(comp->trMemory());\n+   \n+   // Process classes caches at the server first", "originalCommit": "8309612c33ca70889ebea3ceca695805168cff2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYyOTIwOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9067#discussion_r402629208", "bodyText": "Please take TR::compInfoPT->getClientData() outside the loop by storing it in a local variable. That TR::compInfoPT is accessing thread local storage which is expensive to get to.", "author": "mpirvu", "createdAt": "2020-04-02T22:20:21Z", "path": "runtime/compiler/env/J9ClassEnv.cpp", "diffHunk": "@@ -642,3 +644,57 @@ J9::ClassEnv::isValueTypeClass(TR_OpaqueClassBlock *clazz)\n    J9Class *j9class = reinterpret_cast<J9Class*>(clazz);\n    return J9_IS_J9CLASS_VALUETYPE(j9class);\n    }\n+\n+bool \n+J9::ClassEnv::containesZeroOrOneConcreteClass(TR::Compilation *comp, List<TR_PersistentClassInfo>* subClasses)\n+   {\n+   int count = 0;\n+#if defined(J9VM_OPT_JITSERVER)\n+   ListIterator<TR_PersistentClassInfo> j(subClasses);\n+   TR_ScratchList<TR_PersistentClassInfo> subClassesNotCached(comp->trMemory());\n+   \n+   // Process classes caches at the server first\n+   for (TR_PersistentClassInfo *ptClassInfo = j.getFirst(); ptClassInfo; ptClassInfo = j.getNext())\n+      {\n+      TR_OpaqueClassBlock *clazz = ptClassInfo->getClassId();\n+      J9Class *j9clazz = TR::Compiler->cls.convertClassOffsetToClassPtr(clazz);\n+      auto romClass = JITServerHelpers::getRemoteROMClassIfCached(TR::compInfoPT->getClientData(), j9clazz);", "originalCommit": "8309612c33ca70889ebea3ceca695805168cff2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0d29001b43f44501c642f566b739cbb6baa76805", "url": "https://github.com/eclipse-openj9/openj9/commit/0d29001b43f44501c642f566b739cbb6baa76805", "message": "Move FrontEnd noMultipleConcreteClasses into ClassEnv\n\nOMR FrontEnd is depreciated\nThus removing noMultipleConcreteClasses frontend query, and\nmove it to ClassEnv\nAlso rename the function to containesZeroOrOneConcreteClass\n\nSigned-off-by: Chris Chong <Zichun.Chong@ibm.com>", "committedDate": "2020-04-03T15:21:05Z", "type": "forcePushed"}, {"oid": "a49057255cbcae4e22e431b332991037fba0a4ec", "url": "https://github.com/eclipse-openj9/openj9/commit/a49057255cbcae4e22e431b332991037fba0a4ec", "message": "Move FrontEnd noMultipleConcreteClasses into ClassEnv\n\nOMR FrontEnd is depreciated\nThus removing noMultipleConcreteClasses frontend query, and\nmove it to ClassEnv\nAlso rename the function to containesZeroOrOneConcreteClass\n\nSigned-off-by: Chris Chong <Zichun.Chong@ibm.com>", "committedDate": "2020-04-04T02:59:00Z", "type": "commit"}, {"oid": "a49057255cbcae4e22e431b332991037fba0a4ec", "url": "https://github.com/eclipse-openj9/openj9/commit/a49057255cbcae4e22e431b332991037fba0a4ec", "message": "Move FrontEnd noMultipleConcreteClasses into ClassEnv\n\nOMR FrontEnd is depreciated\nThus removing noMultipleConcreteClasses frontend query, and\nmove it to ClassEnv\nAlso rename the function to containesZeroOrOneConcreteClass\n\nSigned-off-by: Chris Chong <Zichun.Chong@ibm.com>", "committedDate": "2020-04-04T02:59:00Z", "type": "forcePushed"}]}