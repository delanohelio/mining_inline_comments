{"pr_number": 9763, "pr_title": "Update numActiveThreads at the proper location at the server", "pr_createdAt": "2020-06-01T23:05:17Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/9763", "timeline": [{"oid": "d94767cab6e04057233f4277717e2d77eca810f2", "url": "https://github.com/eclipse-openj9/openj9/commit/d94767cab6e04057233f4277717e2d77eca810f2", "message": "Update numActiveThreads at the proper location at the server\n\nAs described in #9762, `_numActiveThreads` is not\nincremented when the thread is unloading the class\nor doing CHTable update. It could cause a race\ncondition when another thread is timed out\non waiting for the first thread to complete,\nthe second thread that\u2019s timed out will clear the\nclient session cache because `_numActiveThreads` is 0.\n\nFixes #9762, #9694\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>", "committedDate": "2020-06-01T23:08:22Z", "type": "forcePushed"}, {"oid": "8e42c3fe646089797ecf5dd5dbeae6b81cae3257", "url": "https://github.com/eclipse-openj9/openj9/commit/8e42c3fe646089797ecf5dd5dbeae6b81cae3257", "message": "Update numActiveThreads at the proper location at the server\n\nAs described in #9762, `_numActiveThreads` is not\nincremented when the thread is unloading the class\nor doing CHTable update. It could cause a race\ncondition when another thread is timed out\non waiting for the first thread to complete,\nthe second thread that\u2019s timed out will clear the\nclient session cache because `_numActiveThreads` is 0.\n\nFixes #9762, #9694\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>", "committedDate": "2020-06-03T00:56:11Z", "type": "forcePushed"}, {"oid": "7c77a963f149aea39fda8e8df6e84ee496d311f8", "url": "https://github.com/eclipse-openj9/openj9/commit/7c77a963f149aea39fda8e8df6e84ee496d311f8", "message": "Update numActiveThreads at the proper location at the server\n\nAs described in #9762, `_numActiveThreads` is not\nincremented when the thread is unloading the class\nor doing CHTable update. It could cause a race\ncondition when another thread is timed out\non waiting for the first thread to complete,\nthe second thread that\u2019s timed out will clear the\nclient session cache because `_numActiveThreads` is 0.\n\nFixes #9762, #9694\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>", "committedDate": "2020-06-03T01:06:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY1MjgxNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9763#discussion_r434652814", "bodyText": "Isn't this too early to increase the number of active threads? A thread that has to wait for its turn will see itself as an active thread and never clear the caches. In my mind the increment should be done after the thread has cleared the waitForMyTurn() routine.", "author": "mpirvu", "createdAt": "2020-06-03T15:25:08Z", "path": "runtime/compiler/control/JITServerCompilationThread.cpp", "diffHunk": "@@ -384,6 +384,8 @@ TR::CompilationInfoPerThreadRemote::processEntry(TR_MethodToBeCompiled &entry, J\n       //\n       clientSession->getSequencingMonitor()->enter();\n       clientSession->updateMaxReceivedSeqNo(seqNo);\n+      clientSession->incNumActiveThreads();", "originalCommit": "7c77a963f149aea39fda8e8df6e84ee496d311f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY4MTE0OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9763#discussion_r434681148", "bodyText": "Yes, you're right. It is too early. It should've been done right before the thread starts to do the class unloading etc as below.\n      clientSession->getSequencingMonitor()->enter();\n      clientSession->updateMaxReceivedSeqNo(seqNo);\n\n      if (seqNo > clientSession->getExpectedSeqNo()) // Out of order messages\n         {\n         ...\n         waitForMyTurn(clientSession, entry);\n         }\n      else if (seqNo < clientSession->getExpectedSeqNo())\n         {\n         ...\n         clientSession->getSequencingMonitor()->exit();\n         throw JITServer::StreamOOO();\n         }\n\n      clientSession->incNumActiveThreads(); <= Should be here \n\n      // We can release the sequencing monitor now because nobody with a\n      // larger sequence number can pass until I increment expectedSeqNo\n      clientSession->getSequencingMonitor()->exit();\n\n      // At this point I know that all preceeding requests have been processed\n      // and only one thread can ever be present in this section\n      if (!clientSession->cachesAreCleared())", "author": "a7ehuo", "createdAt": "2020-06-03T16:02:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY1MjgxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY1OTIyNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9763#discussion_r434659225", "bodyText": "This acts like a correction, but it's never executed because of the fatal assert above. Is the intent to transform the fatal assert into an simple assert?", "author": "mpirvu", "createdAt": "2020-06-03T15:33:34Z", "path": "runtime/compiler/control/JITServerCompilationThread.cpp", "diffHunk": "@@ -473,18 +477,23 @@ TR::CompilationInfoPerThreadRemote::processEntry(TR_MethodToBeCompiled &entry, J\n          }\n \n       clientSession->getSequencingMonitor()->enter();\n-      // Update the expecting sequence number. This will allow subsequent\n-      // threads to pass through once we've released the sequencing monitor.\n-      TR_ASSERT(seqNo == clientSession->getExpectedSeqNo(), \"Unexpected seqNo=%u expected=%u\\n\", seqNo, clientSession->getExpectedSeqNo());\n \n-      //TODO: Might need to set the expectedSeqNo as (seqNo+1) instead of (expectedSeqNo+1)\n       if (seqNo != clientSession->getExpectedSeqNo())\n+         {\n          Trc_JITServerUnexpectedSeqNo(compThread, getCompThreadId(), clientSession,\n                (unsigned long long)clientId, seqNo, clientSession->getExpectedSeqNo(), clientSession->getNumActiveThreads());\n \n+         TR_ASSERT_FATAL(false, \"compThreadID=%d clientSessionData=%p clientUID=%llu (seqNo=%u, expectedSeqNo=%u, numActiveThreads=%d) unexpected seqNo\",\n+               getCompThreadId(), clientSession, (unsigned long long)clientId,\n+               seqNo, clientSession->getExpectedSeqNo(), clientSession->getNumActiveThreads());\n+\n+         clientSession->setExpectedSeqNo(seqNo);", "originalCommit": "7c77a963f149aea39fda8e8df6e84ee496d311f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY4NTM3MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9763#discussion_r434685371", "bodyText": "I'm not sure if we should have a FATAL assert here to catch the issue in a release build, or make it a simple assert which means if the sequence of messages are not handled properly we might not catch it right away. But a simple assert is also less intrusive.", "author": "a7ehuo", "createdAt": "2020-06-03T16:07:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY1OTIyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDgxNjc2Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9763#discussion_r434816763", "bodyText": "If we can safely recover from a bug I prefer to have the soft assert.", "author": "mpirvu", "createdAt": "2020-06-03T19:53:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY1OTIyNQ=="}], "type": "inlineReview"}, {"oid": "6e73da994711adf4c1aed818688c17931bf692d3", "url": "https://github.com/eclipse-openj9/openj9/commit/6e73da994711adf4c1aed818688c17931bf692d3", "message": "Update numActiveThreads at the proper location at the server\n\nAs described in #9762, `_numActiveThreads` is not\nincremented when the thread is unloading the class\nor doing CHTable update. It could cause a race\ncondition when another thread is timed out\non waiting for the first thread to complete,\nthe second thread that\u2019s timed out will clear the\nclient session cache because `_numActiveThreads` is 0.\n\nFixes #9762, #9694\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>", "committedDate": "2020-06-03T19:49:58Z", "type": "commit"}, {"oid": "6e73da994711adf4c1aed818688c17931bf692d3", "url": "https://github.com/eclipse-openj9/openj9/commit/6e73da994711adf4c1aed818688c17931bf692d3", "message": "Update numActiveThreads at the proper location at the server\n\nAs described in #9762, `_numActiveThreads` is not\nincremented when the thread is unloading the class\nor doing CHTable update. It could cause a race\ncondition when another thread is timed out\non waiting for the first thread to complete,\nthe second thread that\u2019s timed out will clear the\nclient session cache because `_numActiveThreads` is 0.\n\nFixes #9762, #9694\n\nSigned-off-by: Annabelle Huo <Annabelle.Huo@ibm.com>", "committedDate": "2020-06-03T19:49:58Z", "type": "forcePushed"}]}