{"pr_number": 8976, "pr_title": "Implement monitor enter/exit for valuetypes", "pr_createdAt": "2020-03-25T15:18:43Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/8976", "timeline": [{"oid": "6aeba4761a8ab9a9ea83b560291f24d46a6a7fe3", "url": "https://github.com/eclipse-openj9/openj9/commit/6aeba4761a8ab9a9ea83b560291f24d46a6a7fe3", "message": "Implment monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>", "committedDate": "2020-03-25T15:22:21Z", "type": "forcePushed"}, {"oid": "c062fc3cf0a5e052405283c8e39ba2aef20c6d24", "url": "https://github.com/eclipse-openj9/openj9/commit/c062fc3cf0a5e052405283c8e39ba2aef20c6d24", "message": "Implment monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>", "committedDate": "2020-04-01T18:28:34Z", "type": "forcePushed"}, {"oid": "bd65ad82de988ee3d163c9a50f8bd3bc4d005a47", "url": "https://github.com/eclipse-openj9/openj9/commit/bd65ad82de988ee3d163c9a50f8bd3bc4d005a47", "message": "Implment monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>", "committedDate": "2020-04-01T19:29:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg5MzA1NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r401893054", "bodyText": "Wouldn't it be safer to say == TR_no?", "author": "andrewcraik", "createdAt": "2020-04-01T20:35:15Z", "path": "runtime/compiler/x/codegen/J9TreeEvaluator.cpp", "diffHunk": "@@ -4508,6 +4511,25 @@ void J9::X86::TreeEvaluator::transactionalMemoryJITMonitorEntry(TR::Node\n       cg->stopUsingRegister(counterReg);\n    }\n \n+void\n+J9::X86::TreeEvaluator::monitorEnterOrExitForValueTypeClass(\n+      TR::Node *node,\n+      TR::LabelSymbol *snippetLabel,\n+      TR::CodeGenerator *cg)\n+   {\n+   if (cg->isMonitorValueType(node) != TR_maybe)", "originalCommit": "bd65ad82de988ee3d163c9a50f8bd3bc4d005a47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkzNDQ5Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r401934492", "bodyText": "This method only handles the cases where it's unclear whether the monitor is value type or not. we need to generate extra checks in those cases. == TR_nois using existing sequence and == TR_yes is calling VM helper directly. Both of the later 2 cases wont be handled here.", "author": "cathyzhyi", "createdAt": "2020-04-01T21:57:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg5MzA1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk5MDkwNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r402990907", "bodyText": "Wouldn't this be better phrased as get the most abstract type the monitor may be operating on?", "author": "andrewcraik", "createdAt": "2020-04-03T13:06:20Z", "path": "runtime/compiler/codegen/J9CodeGenerator.hpp", "diffHunk": "@@ -298,21 +298,41 @@ class OMR_EXTENSIBLE CodeGenerator : public OMR::CodeGeneratorConnector\n    TR_BitVector *setLiveMonitors(TR_BitVector *v) {return (_liveMonitors = v);}\n \n public:\n+   /*\n+    * \\brief\n+    *    Get the class or the superclass of the monitor object.", "originalCommit": "bd65ad82de988ee3d163c9a50f8bd3bc4d005a47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzAxNzY1Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r403017656", "bodyText": "Do you mean the most concrete type the monitor may be operating on?", "author": "cathyzhyi", "createdAt": "2020-04-03T13:48:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk5MDkwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI2OTc4Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r403269786", "bodyText": "Depends on how you view it - it is the most specific type that could cover all possible types that could reach the monitor right?", "author": "andrewcraik", "createdAt": "2020-04-03T19:36:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk5MDkwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM0Njc5MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r403346791", "bodyText": "Yea, I got it. Changed the phrasing as suggested. Thanks!", "author": "cathyzhyi", "createdAt": "2020-04-03T21:32:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk5MDkwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk5MTc5MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r402991790", "bodyText": "Why is this unconditional? It is only true if value types are enabled right?", "author": "andrewcraik", "createdAt": "2020-04-03T13:07:50Z", "path": "runtime/compiler/x/codegen/J9TreeEvaluator.cpp", "diffHunk": "@@ -132,14 +132,17 @@ inline void generateLoadJ9Class(TR::Node* node, TR::Register* j9class, TR::Regis\n       switch (opValue)\n          {\n          case TR::checkcastAndNULLCHK:\n+         case TR::monent:", "originalCommit": "bd65ad82de988ee3d163c9a50f8bd3bc4d005a47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA0ODkxNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r403048915", "bodyText": "It looks like opValue couldn't be monent or monexit before (it would assert before). But now generateLoadJ9Class is called by monitorEnterOrExitForValueTypeClass which can pass in a monent or monexit node. So it can only get to these new cases if value types are enabled.", "author": "IBMJimmyk", "createdAt": "2020-04-03T14:33:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk5MTc5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ1NDQ1MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r404454451", "bodyText": "@cathyzhyi Could we add a fatal assert to capture that fact?", "author": "andrewcraik", "createdAt": "2020-04-06T23:46:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk5MTc5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ5MDQ3Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r404490473", "bodyText": "Added fatal assert as suggested.", "author": "cathyzhyi", "createdAt": "2020-04-07T01:52:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk5MTc5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk5MjU5MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r402992590", "bodyText": "Shouldn't this have the verb generate in the name?", "author": "andrewcraik", "createdAt": "2020-04-03T13:09:08Z", "path": "runtime/compiler/x/codegen/J9TreeEvaluator.cpp", "diffHunk": "@@ -4508,6 +4511,25 @@ void J9::X86::TreeEvaluator::transactionalMemoryJITMonitorEntry(TR::Node\n       cg->stopUsingRegister(counterReg);\n    }\n \n+void\n+J9::X86::TreeEvaluator::monitorEnterOrExitForValueTypeClass(", "originalCommit": "bd65ad82de988ee3d163c9a50f8bd3bc4d005a47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMzNTkxNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r403335914", "bodyText": "changed the name to generateCheckForValueTypeMonitorEnterOrExit.", "author": "cathyzhyi", "createdAt": "2020-04-03T21:06:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk5MjU5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk5MzAzMQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r402993031", "bodyText": "Why did this move?", "author": "andrewcraik", "createdAt": "2020-04-03T13:09:50Z", "path": "runtime/compiler/x/codegen/J9TreeEvaluator.cpp", "diffHunk": "@@ -4518,20 +4540,22 @@ J9::X86::TreeEvaluator::VMmonentEvaluator(\n    // appropriate excepting instruction we must make sure to reset the\n    // excepting instruction since our children may have set it.\n    //\n+   TR::Compilation *comp = cg->comp();\n+   TR_J9VMBase *fej9 = (TR_J9VMBase *)(cg->fe());\n    static const char *noInline = feGetEnv(\"TR_NoInlineMonitor\");\n-   static int32_t monEntCount = 0;\n    static const char *firstMonEnt = feGetEnv(\"TR_FirstMonEnt\");\n-   static const char *doCmpFirst = feGetEnv(\"TR_AddCMPBeforeCMPXCHG\");\n+   static int32_t monEntCount = 0;\n    bool reservingLock = false;\n    bool normalLockPreservingReservation = false;\n    bool dummyMethodMonitor = false;\n-   TR_J9VMBase *fej9 = (TR_J9VMBase *)(cg->fe());\n-   TR::Compilation *comp = cg->comp();\n+\n+   static const char *doCmpFirst = feGetEnv(\"TR_AddCMPBeforeCMPXCHG\");", "originalCommit": "bd65ad82de988ee3d163c9a50f8bd3bc4d005a47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzAzNTU3NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r403035575", "bodyText": "I rearranged so that the items that are common for monenter and monexit are in the same order.", "author": "cathyzhyi", "createdAt": "2020-04-03T14:14:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk5MzAzMQ=="}], "type": "inlineReview"}, {"oid": "67d252222c68be3cd6ad852cdcaec61ad750f68a", "url": "https://github.com/eclipse-openj9/openj9/commit/67d252222c68be3cd6ad852cdcaec61ad750f68a", "message": "Implment monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>", "committedDate": "2020-04-03T14:38:35Z", "type": "forcePushed"}, {"oid": "a11446a1baed9a11eaec0fd1376a92ed0a0bd3f3", "url": "https://github.com/eclipse-openj9/openj9/commit/a11446a1baed9a11eaec0fd1376a92ed0a0bd3f3", "message": "Implment monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>", "committedDate": "2020-04-03T21:02:50Z", "type": "forcePushed"}, {"oid": "b2849f7fbe0e88a7cbedf81e0191b8e68f074a7a", "url": "https://github.com/eclipse-openj9/openj9/commit/b2849f7fbe0e88a7cbedf81e0191b8e68f074a7a", "message": "Implment monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>", "committedDate": "2020-04-03T21:28:08Z", "type": "forcePushed"}, {"oid": "7b6017f73376fa3b529780f47f39597e10cc4e9d", "url": "https://github.com/eclipse-openj9/openj9/commit/7b6017f73376fa3b529780f47f39597e10cc4e9d", "message": "Implment monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>", "committedDate": "2020-04-03T21:33:00Z", "type": "forcePushed"}, {"oid": "ad67a9270d262397e4e4ccb9f1b0f13836851c1a", "url": "https://github.com/eclipse-openj9/openj9/commit/ad67a9270d262397e4e4ccb9f1b0f13836851c1a", "message": "Implment monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>", "committedDate": "2020-04-05T02:46:03Z", "type": "forcePushed"}, {"oid": "f9b7fd08ed6af62604f8b307341196ecc615296a", "url": "https://github.com/eclipse-openj9/openj9/commit/f9b7fd08ed6af62604f8b307341196ecc615296a", "message": "Implment monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>", "committedDate": "2020-04-07T01:49:21Z", "type": "forcePushed"}, {"oid": "f146f439b2e196c5ad946a905143bf956afcb9ff", "url": "https://github.com/eclipse-openj9/openj9/commit/f146f439b2e196c5ad946a905143bf956afcb9ff", "message": "Implment monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>", "committedDate": "2020-04-07T01:51:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxMzAzMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r404813033", "bodyText": "I don't think you need to call the MonitorTypeMap constructor explicitly here.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               _monitorMapping(MonitorTypeMap(std::less<ncount_t>(), MonitorMapAllocator(self()->comp()->trMemory()->heapMemoryRegion()))),\n          \n          \n            \n               _monitorMapping(std::less<ncount_t>(), MonitorMapAllocator(self()->comp()->trMemory()->heapMemoryRegion())),", "author": "Leonardo2718", "createdAt": "2020-04-07T13:34:53Z", "path": "runtime/compiler/codegen/J9CodeGenerator.cpp", "diffHunk": "@@ -78,7 +78,7 @@ J9::CodeGenerator::CodeGenerator() :\n    _liveMonitors(NULL),\n    _nodesSpineCheckedList(getTypedAllocator<TR::Node*>(TR::comp()->allocator())),\n    _jniCallSites(getTypedAllocator<TR_Pair<TR_ResolvedMethod,TR::Instruction> *>(TR::comp()->allocator())),\n-   _monitorMapping(self()->comp()->trMemory(), 256),\n+   _monitorMapping(MonitorTypeMap(std::less<ncount_t>(), MonitorMapAllocator(self()->comp()->trMemory()->heapMemoryRegion()))),", "originalCommit": "f146f439b2e196c5ad946a905143bf956afcb9ff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxNTI3OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r404815278", "bodyText": "I think it would cleaner to have\nauto monIt = _monitorMapping.find(monNode->getGlobalIndex());\nreturn monIt != _monitorMapping.end() ? (TR_OpaqueClassBlock *)*monIt : NULL", "author": "Leonardo2718", "createdAt": "2020-04-07T13:38:05Z", "path": "runtime/compiler/codegen/J9CodeGenerator.cpp", "diffHunk": "@@ -4980,15 +4978,36 @@ J9::CodeGenerator::generatePoisonNode(TR::Block *currentBlock, TR::SymbolReferen\n void\n J9::CodeGenerator::addMonClass(TR::Node* monNode, TR_OpaqueClassBlock* clazz)\n    {\n-   _monitorMapping.add(monNode);\n-   _monitorMapping.add(clazz);\n+   _monitorMapping[monNode->getGlobalIndex()] = clazz;\n    }\n \n TR_OpaqueClassBlock *\n J9::CodeGenerator::getMonClass(TR::Node* monNode)\n    {\n-   for (int i = 0; i < _monitorMapping.size(); i += 2)\n-      if (_monitorMapping[i] == monNode)\n-         return (TR_OpaqueClassBlock *) _monitorMapping[i+1];\n-   return 0;\n+   return _monitorMapping.find(monNode->getGlobalIndex()) != _monitorMapping.end() ?\n+            (TR_OpaqueClassBlock *) _monitorMapping[monNode->getGlobalIndex()] :\n+            NULL;", "originalCommit": "f146f439b2e196c5ad946a905143bf956afcb9ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg3NDU4NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r404874584", "bodyText": "yes, changed as suggested. Thanks!", "author": "cathyzhyi", "createdAt": "2020-04-07T14:55:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxNTI3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxNzYyNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r404817627", "bodyText": "For consistency\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                *    whether a monitor object is of value type\n          \n          \n            \n                *    Whether a monitor object is of value type", "author": "Leonardo2718", "createdAt": "2020-04-07T13:41:20Z", "path": "runtime/compiler/codegen/J9CodeGenerator.hpp", "diffHunk": "@@ -298,21 +298,41 @@ class OMR_EXTENSIBLE CodeGenerator : public OMR::CodeGeneratorConnector\n    TR_BitVector *setLiveMonitors(TR_BitVector *v) {return (_liveMonitors = v);}\n \n public:\n+   /*\n+    * \\brief\n+    *    Get the most abstract type the monitor may be operating on.\n+    *\n+    * \\note\n+    *    java.lang.Object is only returned when the monitor object is of type java.lang.Object but not any subclasses\n+    */\n+   TR_OpaqueClassBlock* getMonClass(TR::Node* monNode);\n \n-TR_OpaqueClassBlock* getMonClass(TR::Node* monNode);\n+   /*\n+    * \\brief\n+    *    whether a monitor object is of value type", "originalCommit": "f146f439b2e196c5ad946a905143bf956afcb9ff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxOTU0MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r404819540", "bodyText": "Would it be possible to make this a TR_ASSERT_FATAL?", "author": "Leonardo2718", "createdAt": "2020-04-07T13:43:59Z", "path": "runtime/compiler/x/codegen/J9TreeEvaluator.cpp", "diffHunk": "@@ -131,15 +131,19 @@ inline void generateLoadJ9Class(TR::Node* node, TR::Register* j9class, TR::Regis\n       {\n       switch (opValue)\n          {\n+         case TR::monent:\n+         case TR::monexit:\n+            TR_ASSERT_FATAL(TR::Compiler->om.areValueTypesEnabled(), \"monent and monexit evaluators should only call generateLoadJ9Class when value type is enabled\");\n          case TR::checkcastAndNULLCHK:\n             needsNULLCHK = true;\n             break;\n          case TR::icall: // TR_checkAssignable\n             return; // j9class register already holds j9class\n+         case TR::checkcast:\n+         case TR::instanceof:\n+            break;\n          default:\n-            TR_ASSERT(opValue == TR::checkcast ||\n-                      opValue == TR::instanceof,\n-                     \"Unexpected opCode for generateLoadJ9Class %s.\", node->getOpCode().getName());\n+            TR_ASSERT(false, \"Unexpected opCode for generateLoadJ9Class %s.\", node->getOpCode().getName());", "originalCommit": "f146f439b2e196c5ad946a905143bf956afcb9ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg3MzMxNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r404873317", "bodyText": "yes, changed to TR_ASSERT_FATAL", "author": "cathyzhyi", "createdAt": "2020-04-07T14:53:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgxOTU0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgyMjMxMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r404822313", "bodyText": "This could really be an auto, since it's clear what the type should be from the cast.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               TR_J9VMBase *fej9 = (TR_J9VMBase *)(cg->fe());\n          \n          \n            \n               auto fej9 = (TR_J9VMBase *)(cg->fe());", "author": "Leonardo2718", "createdAt": "2020-04-07T13:47:38Z", "path": "runtime/compiler/x/codegen/J9TreeEvaluator.cpp", "diffHunk": "@@ -4508,6 +4512,25 @@ void J9::X86::TreeEvaluator::transactionalMemoryJITMonitorEntry(TR::Node\n       cg->stopUsingRegister(counterReg);\n    }\n \n+void\n+J9::X86::TreeEvaluator::generateCheckForValueTypeMonitorEnterOrExit(\n+      TR::Node *node,\n+      TR::LabelSymbol *snippetLabel,\n+      TR::CodeGenerator *cg)\n+   {\n+   if (cg->isMonitorValueType(node) != TR_maybe)\n+      return;\n+   TR::Register *objectReg = cg->evaluate(node->getFirstChild());\n+   auto j9classReg = cg->allocateRegister();\n+   generateLoadJ9Class(node, j9classReg, objectReg, cg);\n+   TR_J9VMBase *fej9 = (TR_J9VMBase *)(cg->fe());", "originalCommit": "f146f439b2e196c5ad946a905143bf956afcb9ff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgyMzU0Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r404823546", "bodyText": "This static assert seems out of place.", "author": "Leonardo2718", "createdAt": "2020-04-07T13:49:14Z", "path": "runtime/compiler/x/codegen/J9TreeEvaluator.cpp", "diffHunk": "@@ -4508,6 +4512,25 @@ void J9::X86::TreeEvaluator::transactionalMemoryJITMonitorEntry(TR::Node\n       cg->stopUsingRegister(counterReg);\n    }\n \n+void\n+J9::X86::TreeEvaluator::generateCheckForValueTypeMonitorEnterOrExit(\n+      TR::Node *node,\n+      TR::LabelSymbol *snippetLabel,\n+      TR::CodeGenerator *cg)\n+   {\n+   if (cg->isMonitorValueType(node) != TR_maybe)\n+      return;\n+   TR::Register *objectReg = cg->evaluate(node->getFirstChild());\n+   auto j9classReg = cg->allocateRegister();\n+   generateLoadJ9Class(node, j9classReg, objectReg, cg);\n+   TR_J9VMBase *fej9 = (TR_J9VMBase *)(cg->fe());\n+   auto classFlagsMR = generateX86MemoryReference(j9classReg, (uintptr_t)(fej9->getOffsetOfClassFlags()), cg);\n+   static_assert((uint32_t) J9ClassIsValueType < USHRT_MAX, \"J9ClassIsValueType must be less than 16bits\");", "originalCommit": "f146f439b2e196c5ad946a905143bf956afcb9ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg1OTgwNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r404859804", "bodyText": "It's for the test instruction generated below to make sure a 2bytes width memory access is enough to test the bit", "author": "cathyzhyi", "createdAt": "2020-04-07T14:36:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgyMzU0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkxNjEzNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r404916135", "bodyText": "Ok, that makes sense. Maybe change the assert message then to something like \"Expecting J9ClassIsValueType to be less than 16 bits for use in test instruction\"?", "author": "Leonardo2718", "createdAt": "2020-04-07T15:47:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgyMzU0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkzNDI0Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r404934243", "bodyText": "changed as suggested", "author": "cathyzhyi", "createdAt": "2020-04-07T16:12:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgyMzU0Ng=="}], "type": "inlineReview"}, {"oid": "63c2ef5742f3d86cc594db6a5d79d951071a10c2", "url": "https://github.com/eclipse-openj9/openj9/commit/63c2ef5742f3d86cc594db6a5d79d951071a10c2", "message": "Implment monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>\nCo-Authored-By: Leonardo2718 <leonardo2718@protonmail.com>", "committedDate": "2020-04-07T14:53:09Z", "type": "forcePushed"}, {"oid": "f537291299dabbd758d73b944515282930d0ac8c", "url": "https://github.com/eclipse-openj9/openj9/commit/f537291299dabbd758d73b944515282930d0ac8c", "message": "Implement monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>\nCo-Authored-By: Leonardo2718 <leonardo2718@protonmail.com>", "committedDate": "2020-04-07T14:53:57Z", "type": "forcePushed"}, {"oid": "9b8c7785ec1e3b6284743be1ee918ef02b6bfadc", "url": "https://github.com/eclipse-openj9/openj9/commit/9b8c7785ec1e3b6284743be1ee918ef02b6bfadc", "message": "Implement monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>\nCo-Authored-By: Leonardo2718 <leonardo2718@protonmail.com>", "committedDate": "2020-04-07T16:10:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA1NjI1Mw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r405056253", "bodyText": "Sorry, I missed this earlier: you should avoid calling self() in constructors because it relies on undefined behaviour. You can use TR::comp() instead as is done to initialize other fields.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               _monitorMapping(std::less<ncount_t>(), MonitorMapAllocator(self()->comp()->trMemory()->heapMemoryRegion())),\n          \n          \n            \n               _monitorMapping(std::less<ncount_t>(), MonitorMapAllocator(TR::comp()->trMemory()->heapMemoryRegion())),", "author": "Leonardo2718", "createdAt": "2020-04-07T19:24:04Z", "path": "runtime/compiler/codegen/J9CodeGenerator.cpp", "diffHunk": "@@ -78,7 +78,7 @@ J9::CodeGenerator::CodeGenerator() :\n    _liveMonitors(NULL),\n    _nodesSpineCheckedList(getTypedAllocator<TR::Node*>(TR::comp()->allocator())),\n    _jniCallSites(getTypedAllocator<TR_Pair<TR_ResolvedMethod,TR::Instruction> *>(TR::comp()->allocator())),\n-   _monitorMapping(self()->comp()->trMemory(), 256),\n+   _monitorMapping(std::less<ncount_t>(), MonitorMapAllocator(self()->comp()->trMemory()->heapMemoryRegion())),", "originalCommit": "9b8c7785ec1e3b6284743be1ee918ef02b6bfadc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA2NjExMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r405066110", "bodyText": "fixed as suggested. thanks!", "author": "cathyzhyi", "createdAt": "2020-04-07T19:42:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA1NjI1Mw=="}], "type": "inlineReview"}, {"oid": "ac2a0a19731c9d7aee31e2a0abcf98eb30e6f122", "url": "https://github.com/eclipse-openj9/openj9/commit/ac2a0a19731c9d7aee31e2a0abcf98eb30e6f122", "message": "Implement monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>\nCo-Authored-By: Leonardo2718 <leonardo2718@protonmail.com>", "committedDate": "2020-04-07T19:40:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjE5NDA3OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r406194078", "bodyText": "Can you make these auto types explicit where reasonable eg TR:Register TR_J9VMBase etc", "author": "andrewcraik", "createdAt": "2020-04-09T13:14:19Z", "path": "runtime/compiler/x/codegen/J9TreeEvaluator.cpp", "diffHunk": "@@ -4508,6 +4512,25 @@ void J9::X86::TreeEvaluator::transactionalMemoryJITMonitorEntry(TR::Node\n       cg->stopUsingRegister(counterReg);\n    }\n \n+void\n+J9::X86::TreeEvaluator::generateCheckForValueTypeMonitorEnterOrExit(\n+      TR::Node *node,\n+      TR::LabelSymbol *snippetLabel,\n+      TR::CodeGenerator *cg)\n+   {\n+   if (cg->isMonitorValueType(node) != TR_maybe)\n+      return;\n+   TR::Register *objectReg = cg->evaluate(node->getFirstChild());\n+   auto j9classReg = cg->allocateRegister();", "originalCommit": "ac2a0a19731c9d7aee31e2a0abcf98eb30e6f122", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI1Njc1NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8976#discussion_r406256755", "bodyText": "done. Leo was suggesting using auto for the TR_J9VMBase case since the type is obvious from the checkcast.", "author": "cathyzhyi", "createdAt": "2020-04-09T14:43:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjE5NDA3OA=="}], "type": "inlineReview"}, {"oid": "3b7c96a1ec294e3655365c59b5ccb3d9c030ef1b", "url": "https://github.com/eclipse-openj9/openj9/commit/3b7c96a1ec294e3655365c59b5ccb3d9c030ef1b", "message": "Implement monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>\nCo-Authored-By: Leonardo2718 <leonardo2718@protonmail.com>", "committedDate": "2020-04-09T14:40:56Z", "type": "commit"}, {"oid": "3b7c96a1ec294e3655365c59b5ccb3d9c030ef1b", "url": "https://github.com/eclipse-openj9/openj9/commit/3b7c96a1ec294e3655365c59b5ccb3d9c030ef1b", "message": "Implement monitor enter/exit for valuetypes\n\nValuetype objects are identityless and monitor enter/exit on those\nobjects are supposed to throw IllegalMonitorStateException by\ncalling VM monitor enter/exit helper.\n\nMonitor operation assembly sequence are the following 3 forms:\n1. for monitor whose type is known to be value type call the VM helper\ndirectly\n2. for monitor whose type is known to be identity type use the existing\nassembly sequence\n3. for monitor whose type is unknown at compile time add a runtime check\nto the existing assembly sequence to detect whether the object is value\ntype at runtime\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>\nCo-Authored-By: Leonardo2718 <leonardo2718@protonmail.com>", "committedDate": "2020-04-09T14:40:56Z", "type": "forcePushed"}]}