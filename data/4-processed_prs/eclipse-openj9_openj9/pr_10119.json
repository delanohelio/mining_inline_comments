{"pr_number": 10119, "pr_title": "Duplicate PassThrough nodes when creating acmp fastpaths", "pr_createdAt": "2020-07-08T17:26:38Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10119", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTcxNzUzMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10119#discussion_r451717530", "bodyText": "Rahil @r30shah drew my attention to some code in JProfilingValue.cpp that copies register dependencies.  It calls both setLowGlobalRegisterNumber and setHighGlobalRegisterNumber on the PassThrough node -  I guess to handle the possibility of register pairs.  Should this do the same?", "author": "hzongaro", "createdAt": "2020-07-08T17:40:46Z", "path": "runtime/compiler/codegen/J9CodeGenerator.cpp", "diffHunk": "@@ -291,6 +291,14 @@ J9::CodeGenerator::fastpathAcmpHelper(TR::Node *node, TR::TreeTop *tt, const boo\n             TR::Node* temp = expectedDeps->getChild(i);\n             if (temp->getGlobalRegisterNumber() == depNode->getGlobalRegisterNumber())\n                continue;\n+            else if (temp->getOpCodeValue() == TR::PassThrough)\n+               {\n+               // PassThrough nodes cannot be commoned because doing so does not\n+               // actually anchor the child, causing it's lifetime to not be extended\n+               auto regnum = temp->getGlobalRegisterNumber();\n+               temp = TR::Node::create(TR::PassThrough,1, temp->getFirstChild());\n+               temp->setGlobalRegisterNumber(regnum);", "originalCommit": "11bd1bedcfd3632627d1b96a2ac9a20ac135d6c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTcyMjExMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10119#discussion_r451722110", "bodyText": "setGlobalRegisterNumber sets the High register for node to -1 which can lead to issues if your node needs register pair. If the node temp does not need register pair, current implementation works fine", "author": "r30shah", "createdAt": "2020-07-08T17:48:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTcxNzUzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc3MzUyMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10119#discussion_r451773522", "bodyText": "Fixed in force push.", "author": "Leonardo2718", "createdAt": "2020-07-08T19:22:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTcxNzUzMA=="}], "type": "inlineReview"}, {"oid": "59f3d5a262102e2216f0c0e1b1f8213b5dcf9c8c", "url": "https://github.com/eclipse-openj9/openj9/commit/59f3d5a262102e2216f0c0e1b1f8213b5dcf9c8c", "message": "Duplicate PassThrough nodes when creating acmp fastpaths\n\nPreviously, when inserting fastpaths for acmp in the JIT, PassThrough\nnodes under new GlRegDeps were commoned with nodes from existing\nGlRegDeps. This is incorrect because the commoned PassThrough does not\nanchor its child, which causes it's lifetime to not be extended up to\nthat code point.\n\nSigned-off-by: Leonardo Banderali <leonardo2718@protonmail.com>", "committedDate": "2020-07-08T19:21:36Z", "type": "forcePushed"}, {"oid": "ad1604a7a5f81dcec9221bd0618c83bbff0c598a", "url": "https://github.com/eclipse-openj9/openj9/commit/ad1604a7a5f81dcec9221bd0618c83bbff0c598a", "message": "Duplicate PassThrough nodes when creating acmp fastpaths\n\nPreviously, when inserting fastpaths for acmp in the JIT, PassThrough\nnodes under new GlRegDeps were commoned with nodes from existing\nGlRegDeps. This is incorrect because the commoned PassThrough does not\nanchor its child, which causes it's lifetime to not be extended up to\nthat code point.\n\nSigned-off-by: Leonardo Banderali <leonardo2718@protonmail.com>", "committedDate": "2020-07-08T19:26:02Z", "type": "commit"}, {"oid": "ad1604a7a5f81dcec9221bd0618c83bbff0c598a", "url": "https://github.com/eclipse-openj9/openj9/commit/ad1604a7a5f81dcec9221bd0618c83bbff0c598a", "message": "Duplicate PassThrough nodes when creating acmp fastpaths\n\nPreviously, when inserting fastpaths for acmp in the JIT, PassThrough\nnodes under new GlRegDeps were commoned with nodes from existing\nGlRegDeps. This is incorrect because the commoned PassThrough does not\nanchor its child, which causes it's lifetime to not be extended up to\nthat code point.\n\nSigned-off-by: Leonardo Banderali <leonardo2718@protonmail.com>", "committedDate": "2020-07-08T19:26:02Z", "type": "forcePushed"}]}