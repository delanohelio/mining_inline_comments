{"pr_number": 8529, "pr_title": "Disable Power arraycopy inlining for very long lengths", "pr_createdAt": "2020-02-07T20:48:50Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/8529", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYwMTI2MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8529#discussion_r376601260", "bodyText": "Is it worth adding a small comment why the upper range check is needed? Also will we handle the non-const case correctly?", "author": "fjeremic", "createdAt": "2020-02-07T20:50:39Z", "path": "runtime/compiler/p/codegen/J9TreeEvaluator.cpp", "diffHunk": "@@ -13611,7 +13611,7 @@ TR::Register *J9::Power::TreeEvaluator::arraycopyEvaluator(TR::Node *node, TR::C\n    if (node->isForwardArrayCopy() && lengthNode->getOpCode().isLoadConst())\n       {\n       len = (lengthNode->getType().isInt32() ? lengthNode->getInt() : lengthNode->getLongInt());\n-      if (len >= 0)\n+      if (len >= 0 && len < 0x100000000LL)", "originalCommit": "c88b6b596185a416408f65bd82d52672cb7885a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY4NTQ0NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8529#discussion_r376685444", "bodyText": "Added a comment in 6669a51.\nAs for the non-const (helper call) case, it definitely generates code that doesn't trigger any asserts, but I'm honestly not sure whether it would actually function with such a long length if it were executed as I don't know that anybody has ever bothered to test it. The issue being fixed here definitely shouldn't affect it since it's a helper and not generated by the codegen at all. Generally, AFAIK it's not possible to actually execute an arraycopy node in OpenJ9 that has such a long length as they only arise from the optimizer and are completely unreachable in practice, e.g. as a result of #8530.", "author": "aviansie-ben", "createdAt": "2020-02-08T04:07:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYwMTI2MA=="}], "type": "inlineReview"}, {"oid": "6669a51adbd7ed48a5cb3ad681b52368855aa7af", "url": "https://github.com/eclipse-openj9/openj9/commit/6669a51adbd7ed48a5cb3ad681b52368855aa7af", "message": "Disable Power arraycopy inlining for very long lengths\n\nAs it turns out, the code for performing an arraycopy inline on Power is\ncurrently broken for certain very long byte lengths. While this usually\ndoesn't matter, since the maximum length is bounded by the fact that\nJava uses ints to represent array indices, it's possible for the\noptimizer to create arraycopy nodes with very long lengths on\nunreachable paths.\n\nAs part of the ongoing refactor of the Power binary encoder, a number of\nnew asserts are being added that catch any out of range immediates.\nThese asserts trigger on code generated for such arraycopy nodes even\nthough they're unreachable, since the code generated is nonsense.\n\nThis has been corrected by completely disabling arraycopy inlining on\nPower for arraycopy nodes with lengths that do not fit in a 32-bit\ninteger.\n\nSigned-off-by: Ben Thomas <ben@benthomas.ca>", "committedDate": "2020-02-08T03:58:50Z", "type": "commit"}, {"oid": "6669a51adbd7ed48a5cb3ad681b52368855aa7af", "url": "https://github.com/eclipse-openj9/openj9/commit/6669a51adbd7ed48a5cb3ad681b52368855aa7af", "message": "Disable Power arraycopy inlining for very long lengths\n\nAs it turns out, the code for performing an arraycopy inline on Power is\ncurrently broken for certain very long byte lengths. While this usually\ndoesn't matter, since the maximum length is bounded by the fact that\nJava uses ints to represent array indices, it's possible for the\noptimizer to create arraycopy nodes with very long lengths on\nunreachable paths.\n\nAs part of the ongoing refactor of the Power binary encoder, a number of\nnew asserts are being added that catch any out of range immediates.\nThese asserts trigger on code generated for such arraycopy nodes even\nthough they're unreachable, since the code generated is nonsense.\n\nThis has been corrected by completely disabling arraycopy inlining on\nPower for arraycopy nodes with lengths that do not fit in a 32-bit\ninteger.\n\nSigned-off-by: Ben Thomas <ben@benthomas.ca>", "committedDate": "2020-02-08T03:58:50Z", "type": "forcePushed"}, {"oid": "d7afcfa6a3d8de5e757a6c27b3118f983dcf80c5", "url": "https://github.com/eclipse-openj9/openj9/commit/d7afcfa6a3d8de5e757a6c27b3118f983dcf80c5", "message": "Disable Power arraycopy inlining for all long lengths\n\nPreviously, the arraycopy inlining on Power was disabled for lengths\nexceeding 256 bytes, but only in OMR's evaluator for 3-child arraycopy\nnodes. However, as it turns out, our current inlining is suboptimal for\nlong lengths. To improve performance, this maximum length has now been\napplied to the OpenJ9 ICF version of arraycopy inlining for 5-child\narraycopy nodes as well.\n\nSigned-off-by: Ben Thomas <ben@benthomas.ca>", "committedDate": "2020-02-11T21:32:59Z", "type": "commit"}]}