{"pr_number": 9421, "pr_title": "Replace CPU APIs on x86", "pr_createdAt": "2020-04-30T20:04:40Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/9421", "timeline": [{"oid": "1d1984e7d2b6ec6b3664f4addba8b223415b8526", "url": "https://github.com/eclipse-openj9/openj9/commit/1d1984e7d2b6ec6b3664f4addba8b223415b8526", "message": "Replace old processor APIs with new APIs from the CPU class\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-04-30T22:22:30Z", "type": "forcePushed"}, {"oid": "b1da9d6265d395ec60b185d1d697994008950f21", "url": "https://github.com/eclipse-openj9/openj9/commit/b1da9d6265d395ec60b185d1d697994008950f21", "message": "Replace old processor APIs with new APIs from the CPU class\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-04-30T22:26:25Z", "type": "forcePushed"}, {"oid": "03e7481aff4c1c6604fb095e5750df4f30a033ea", "url": "https://github.com/eclipse-openj9/openj9/commit/03e7481aff4c1c6604fb095e5750df4f30a033ea", "message": "Add cg pointer to TR_X86OpCode\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-05-01T21:49:43Z", "type": "forcePushed"}, {"oid": "72d1cb40d2187e4536a8d4839fe0bef2836b05ac", "url": "https://github.com/eclipse-openj9/openj9/commit/72d1cb40d2187e4536a8d4839fe0bef2836b05ac", "message": "Add cg pointer to emitSharedBody\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-05-01T22:54:48Z", "type": "forcePushed"}, {"oid": "f1b777da57dae825a35fa92aa8c9ae9a53457996", "url": "https://github.com/eclipse-openj9/openj9/commit/f1b777da57dae825a35fa92aa8c9ae9a53457996", "message": "Add cg pointer to emitSharedBody\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-05-02T01:46:27Z", "type": "forcePushed"}, {"oid": "b636af0454899e737b39078affe2a94b9777e6a1", "url": "https://github.com/eclipse-openj9/openj9/commit/b636af0454899e737b39078affe2a94b9777e6a1", "message": "Add cg pointer to TR_X86OpCode\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-05-02T02:05:12Z", "type": "forcePushed"}, {"oid": "581546ba01c46d330437476eda9f474adbd76447", "url": "https://github.com/eclipse-openj9/openj9/commit/581546ba01c46d330437476eda9f474adbd76447", "message": "Add assert tests\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-05-05T17:00:07Z", "type": "forcePushed"}, {"oid": "1601cf49dd71f6a685287395a1bcb7bb49840159", "url": "https://github.com/eclipse-openj9/openj9/commit/1601cf49dd71f6a685287395a1bcb7bb49840159", "message": "Replace old x86 processor APIs with new APIs from the CPU class\n\n- Replace old processor APIs with new APIs from the CPU class\n- Replace TR::Compiler target with per comp target\n\ndepends on: eclipse/omr#5151\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-05-13T17:28:28Z", "type": "forcePushed"}, {"oid": "99e01daee5f227cc42e49cb2042297b27937bfbd", "url": "https://github.com/eclipse-openj9/openj9/commit/99e01daee5f227cc42e49cb2042297b27937bfbd", "message": "Replace old x86 processor APIs with new APIs from the CPU class\n\n- Replace old processor APIs with new APIs from the CPU class\n- Replace TR::Compiler target with per comp target\n\ndepends on: eclipse/omr#5151\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-05-14T17:03:56Z", "type": "forcePushed"}, {"oid": "2d95d2880ffb436704deda1ae23d372e6514e159", "url": "https://github.com/eclipse-openj9/openj9/commit/2d95d2880ffb436704deda1ae23d372e6514e159", "message": "Replace old x86 processor APIs with new APIs from the CPU class\n\n- Replace old processor APIs with new APIs from the CPU class\n- Replace TR::Compiler target with per comp target\n\ndepends on: eclipse/omr#5151\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-05-15T04:31:50Z", "type": "forcePushed"}, {"oid": "58439ee59067a026de346f6fbbbc0bdeffd6b766", "url": "https://github.com/eclipse-openj9/openj9/commit/58439ee59067a026de346f6fbbbc0bdeffd6b766", "message": "Replace old x86 processor APIs with new APIs from the CPU class\n\n- Replace old processor APIs with new APIs from the CPU class\n- Replace TR::Compiler target with per comp target\n\ndepends on: eclipse/omr#5151\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-05-15T05:29:18Z", "type": "forcePushed"}, {"oid": "126b6ac0349d27d4202820fdf62520e689f88639", "url": "https://github.com/eclipse-openj9/openj9/commit/126b6ac0349d27d4202820fdf62520e689f88639", "message": "Replace old x86 processor APIs with new APIs from the CPU class\n\n- Replace old processor APIs with new APIs from the CPU class\n- Replace TR::Compiler target with per comp target\n\ndepends on: eclipse/omr#5151\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-05-19T19:09:01Z", "type": "forcePushed"}, {"oid": "cfb66573b3c42709f42a6ef8a99c5a3ec69ba21c", "url": "https://github.com/eclipse-openj9/openj9/commit/cfb66573b3c42709f42a6ef8a99c5a3ec69ba21c", "message": "Replace old x86 processor APIs with new APIs from the CPU class\n\n- Replace old processor APIs with new APIs from the CPU class\n- Replace TR::Compiler target with per comp target\n\ndepends on: eclipse/omr#5151\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-05-20T01:34:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIyMjk5NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9421#discussion_r428222995", "bodyText": "So compatibility requires a perfect match?", "author": "mpirvu", "createdAt": "2020-05-20T18:31:55Z", "path": "runtime/compiler/aarch64/env/J9CPU.cpp", "diffHunk": "@@ -39,7 +39,7 @@ CPU::getProcessorFeatureFlags()\n bool\n CPU::isCompatible(TR_Processor processorSignature, TR_ProcessorFeatureFlags processorFeatureFlags)\n    {\n-   return self()->is(processorSignature);\n+   return self()->id() == processorSignature;", "originalCommit": "cfb66573b3c42709f42a6ef8a99c5a3ec69ba21c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI0ODg4Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/9421#discussion_r428248886", "bodyText": "This is aarch64 and that's how they implemented the compatibility.", "author": "harryyu1994", "createdAt": "2020-05-20T19:12:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIyMjk5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI1Njk4OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9421#discussion_r428256988", "bodyText": "What we are doing here is just to remove the old is() api. The compatibility functions will be re-written in a separate PR.\nThe reason we can't just change the compatibility function to use the new API now is because it is shared across all the platforms. Once all the platforms have the new api's then we can proceed to make them use the new api's.\nself()->is(processorSignature) is equivalent to self()->id() == processorSignature and that's the old api.", "author": "harryyu1994", "createdAt": "2020-05-20T19:27:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIyMjk5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIyNTg4MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9421#discussion_r428225880", "bodyText": "I've just looked at a proposed PR that replaces TR::Compiler->target.cpu.id() >= TR_PPCp7; with TR::Compiler->target.cpu.isAtLeast(TR_PPCp7);\nThis PR seems to be doing the opposite", "author": "mpirvu", "createdAt": "2020-05-20T18:35:07Z", "path": "runtime/compiler/p/env/J9CPU.cpp", "diffHunk": "@@ -93,7 +93,7 @@ CPU::hasPopulationCountInstruction()\n #if defined(J9OS_I5)\n    return false;\n #else\n-   return TR::Compiler->target.cpu.isAtLeast(TR_PPCp7);\n+   return TR::Compiler->target.cpu.id() >= TR_PPCp7;", "originalCommit": "cfb66573b3c42709f42a6ef8a99c5a3ec69ba21c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI0NjkzNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9421#discussion_r428246935", "bodyText": "isAtLeast() takes in an enum, we have a new api isAtLeast() that takes in the new processor enum type and an old api isAtLeast() that takes in the old processor enum type. Certain compilers with certain platform don't seem to distinguish between enums so they will treat the two as the same function and complain there is a function name clash. To solve this, I need to get rid of the old isAtLeast() api. And this was the one of the only places that still uses the old api. So this change is to remove the old api and make sure it doesn't break the build.\nOnce that PR is merged, this change will get overwritten by the Power changes.", "author": "harryyu1994", "createdAt": "2020-05-20T19:09:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIyNTg4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIzMjQ4MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9421#discussion_r428232480", "bodyText": "Do we have comp() object somewhere handy so that we can avoid the TLS lookup?", "author": "mpirvu", "createdAt": "2020-05-20T18:43:33Z", "path": "runtime/compiler/x/codegen/AllocPrefetchSnippet.cpp", "diffHunk": "@@ -232,8 +232,9 @@ uint8_t* TR::X86AllocPrefetchSnippet::emitSharedBody(uint8_t* prefetchSnippetBuf\n    //\n    for (int32_t lineOffset = 0; lineOffset < numLines; ++lineOffset)\n       {\n+      TR_ASSERT(TR::CodeGenerator::getX86ProcessorInfo().isAMD15h() == TR::comp()->target().cpu.is(OMR_PROCESSOR_X86_AMDFAMILY15H), \"OMR_PROCESSOR_X86_AMDFAMILY15H\\n\");\n       prefetchSnippetBuffer[0] = 0x0F;\n-      if (cpuInfo.isAMD15h())\n+      if (TR::comp()->target().cpu.is(OMR_PROCESSOR_X86_AMDFAMILY15H))", "originalCommit": "cfb66573b3c42709f42a6ef8a99c5a3ec69ba21c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI0ODU2MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9421#discussion_r428248560", "bodyText": "Its caller has a cg pointer that can be passed to this function. I'll make that change.\nvoid TR::createCCPreLoadedCode(uint8_t *CCPreLoadedCodeBase, uint8_t *CCPreLoadedCodeTop, void ** CCPreLoadedCodeTable, TR::CodeGenerator *cg)\n   {\n   uint8_t *cursor = CCPreLoadedCodeBase;\n\n   CCPreLoadedCodeTable[TR_CCPreLoadedCode::TR_AllocPrefetch] = static_cast<void *>(cursor);\n   if (cg->comp()->target().is64Bit())\n      cursor = TR::X86AllocPrefetchSnippet::emitSharedBody<TR::HeapTypes::ZeroedHeap, true>(cursor);\n   else\n      cursor = TR::X86AllocPrefetchSnippet::emitSharedBody<TR::HeapTypes::ZeroedHeap, false>(cursor);\n\n   cursor = static_cast<uint8_t *>( TR::alignAllocation<32>(cursor) );\n\n   CCPreLoadedCodeTable[TR_CCPreLoadedCode::TR_NonZeroAllocPrefetch] = static_cast<void *>(cursor);\n   if (cg->comp()->target().is64Bit())\n      cursor = TR::X86AllocPrefetchSnippet::emitSharedBody<TR::HeapTypes::NonZeroedHeap, true>(cursor);\n   else\n      cursor = TR::X86AllocPrefetchSnippet::emitSharedBody<TR::HeapTypes::NonZeroedHeap, false>(cursor);\n\n   cursor = static_cast<uint8_t *>( TR::alignAllocation<32>(cursor) );\n\n   TR_ASSERT(cursor == CCPreLoadedCodeTop, \"The expected and actual sizes of the emitted code differ. cursor = %p, CCPreLoadedCodeTop = %p\", cursor, CCPreLoadedCodeTop);\n   }", "author": "harryyu1994", "createdAt": "2020-05-20T19:11:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIzMjQ4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIzNDI3NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9421#discussion_r428234274", "bodyText": "These asserts will go away as far I understand, so we could replace them with TR_ASSERT_FATAL without worrying about extra overhead forever.", "author": "mpirvu", "createdAt": "2020-05-20T18:46:40Z", "path": "runtime/compiler/x/codegen/J9CodeGenerator.cpp", "diffHunk": "@@ -85,19 +85,23 @@ J9::X86::CodeGenerator::CodeGenerator() :\n    cg->setSupportsPartialInlineOfMethodHooks();\n    cg->setSupportsInliningOfTypeCoersionMethods();\n    cg->setSupportsNewInstanceImplOpt();\n-   if (cg->getX86ProcessorInfo().supportsSSE4_1() &&\n+   \n+   TR_ASSERT(cg->comp()->target().cpu.supportsFeature(OMR_FEATURE_X86_SSE4_1) == cg->getX86ProcessorInfo().supportsSSE4_1(), \"supportsSSE4_1() failed\\n\");", "originalCommit": "cfb66573b3c42709f42a6ef8a99c5a3ec69ba21c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIzNTEwOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9421#discussion_r428235109", "bodyText": "I see that we have comp already available, so cg->comp() could be replaced by comp", "author": "mpirvu", "createdAt": "2020-05-20T18:48:07Z", "path": "runtime/compiler/x/codegen/J9CodeGenerator.cpp", "diffHunk": "@@ -85,19 +85,23 @@ J9::X86::CodeGenerator::CodeGenerator() :\n    cg->setSupportsPartialInlineOfMethodHooks();\n    cg->setSupportsInliningOfTypeCoersionMethods();\n    cg->setSupportsNewInstanceImplOpt();\n-   if (cg->getX86ProcessorInfo().supportsSSE4_1() &&\n+   \n+   TR_ASSERT(cg->comp()->target().cpu.supportsFeature(OMR_FEATURE_X86_SSE4_1) == cg->getX86ProcessorInfo().supportsSSE4_1(), \"supportsSSE4_1() failed\\n\");\n+   TR_ASSERT(cg->comp()->target().cpu.supportsFeature(OMR_FEATURE_X86_SSSE3) == cg->getX86ProcessorInfo().supportsSSSE3(), \"supportsSSSE3() failed\\n\");\n+   \n+   if (cg->comp()->target().cpu.supportsFeature(OMR_FEATURE_X86_SSE4_1) &&", "originalCommit": "cfb66573b3c42709f42a6ef8a99c5a3ec69ba21c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3d8642e148874fde885ff5753bfa17cac1390c99", "url": "https://github.com/eclipse-openj9/openj9/commit/3d8642e148874fde885ff5753bfa17cac1390c99", "message": "Replace old x86 processor APIs with new APIs from the CPU class\n\n- Replace old processor APIs with new APIs from the CPU class\n- Replace TR::Compiler target with per comp target\n\ndepends on: eclipse/omr#5151\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-05-21T02:58:02Z", "type": "forcePushed"}, {"oid": "02f50d075154947233ef389bed846eeeacb36a85", "url": "https://github.com/eclipse-openj9/openj9/commit/02f50d075154947233ef389bed846eeeacb36a85", "message": "Replace old x86 processor APIs with new APIs from the CPU class\n\n- Replace old processor APIs with new APIs from the CPU class\n- Replace TR::Compiler target with per comp target\n\ndepends on: eclipse/omr#5151\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-05-21T17:27:52Z", "type": "forcePushed"}, {"oid": "9bd8f427dca9a60e9a5be838b9e5688178cf0941", "url": "https://github.com/eclipse-openj9/openj9/commit/9bd8f427dca9a60e9a5be838b9e5688178cf0941", "message": "Replace old x86 processor APIs with new APIs from the CPU class\n\n- Replace old processor APIs with new APIs from the CPU class\n- Replace TR::Compiler target with per comp target\n\ndepends on: eclipse/omr#5151\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-05-25T22:11:11Z", "type": "forcePushed"}, {"oid": "7c4850550760280c9110580edec3884e2803abe0", "url": "https://github.com/eclipse-openj9/openj9/commit/7c4850550760280c9110580edec3884e2803abe0", "message": "Replace old x86 processor APIs with new APIs from the CPU class\n\n- Replace old processor APIs with new APIs from the CPU class\n- Replace TR::Compiler target with per comp target\n\ndepends on: eclipse/omr#5151\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-05-26T20:01:25Z", "type": "forcePushed"}, {"oid": "faa7becd20a6e78b5471507ff0eb89c64f614ad3", "url": "https://github.com/eclipse-openj9/openj9/commit/faa7becd20a6e78b5471507ff0eb89c64f614ad3", "message": "Replace old x86 processor APIs with new APIs from the CPU class\n\n- Replace old processor APIs with new APIs from the CPU class\n- Replace TR::Compiler target with per comp target\n\ndepends on: eclipse/omr#5151\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-05-28T20:14:30Z", "type": "forcePushed"}, {"oid": "163729e4ea1e7f8357523aff900e0fbe2e735a6f", "url": "https://github.com/eclipse-openj9/openj9/commit/163729e4ea1e7f8357523aff900e0fbe2e735a6f", "message": "Replace old x86 processor APIs with new APIs from the CPU class\n\n- Replace old processor APIs with new APIs from the CPU class\n- Replace TR::Compiler target with per comp target\n\ndepends on: eclipse/omr#5151\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-06-01T16:05:09Z", "type": "commit"}, {"oid": "163729e4ea1e7f8357523aff900e0fbe2e735a6f", "url": "https://github.com/eclipse-openj9/openj9/commit/163729e4ea1e7f8357523aff900e0fbe2e735a6f", "message": "Replace old x86 processor APIs with new APIs from the CPU class\n\n- Replace old processor APIs with new APIs from the CPU class\n- Replace TR::Compiler target with per comp target\n\ndepends on: eclipse/omr#5151\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-06-01T16:05:09Z", "type": "forcePushed"}]}