{"pr_number": 8293, "pr_title": "Add walkReferenceChain JITServer Support", "pr_createdAt": "2020-01-13T22:49:58Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/8293", "timeline": [{"oid": "06558bb4bd60127940518d6248df0b0b73c6b263", "url": "https://github.com/eclipse-openj9/openj9/commit/06558bb4bd60127940518d6248df0b0b73c6b263", "message": "Add walkReferenceChain JITServer Support\n\nThe purpose of this change is to avoid using object addresses on JITServer.\nUsing object addresses on JITServer creates problems when GC changes the object addresses. Instead, JITServer must use some kind of handle (a GlobalReference or some other GC root) to hold the object so that JITServer always has the valid object addresses.\n\nwalkReferenceChain is special in that it needs half of its information from the JITServer(TR::Node) and half of its information from JITClient(object address). During the walk, we need vmaccess so that GC doesn't move the object of interest. We can only have vmaccess on JITClient, which means we need to do walkReferenceChain on JITClient.\n\nThis change makes JITServer to generate the offsets information JITClient needed for the walk and passes to JITClient in the form of a vector.\n\nIssue: #8109\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-01-13T22:51:22Z", "type": "forcePushed"}, {"oid": "bd794e1eb31f064a60f156db8e308495605c6522", "url": "https://github.com/eclipse-openj9/openj9/commit/bd794e1eb31f064a60f156db8e308495605c6522", "message": "Add walkReferenceChain JITServer Support\n\nThe purpose of this change is to avoid using object addresses on JITServer.\nUsing object addresses on JITServer creates problems when GC changes the object addresses. Instead, JITServer must use some kind of handle (a GlobalReference or some other GC root) to hold the object so that JITServer always has the valid object addresses.\n\nwalkReferenceChain is special in that it needs half of its information from the JITServer(TR::Node) and half of its information from JITClient(object address). During the walk, we need vmaccess so that GC doesn't move the object of interest. We can only have vmaccess on JITClient, which means we need to do walkReferenceChain on JITClient.\n\nThis change makes JITServer to generate the offsets information JITClient needed for the walk and passes to JITClient in the form of a vector.\n\nIssue: #8109\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-01-13T22:56:04Z", "type": "forcePushed"}, {"oid": "b7f3a4c12c683df37270bbafc4fb3adb6a95231e", "url": "https://github.com/eclipse-openj9/openj9/commit/b7f3a4c12c683df37270bbafc4fb3adb6a95231e", "message": "Add walkReferenceChain JITServer Support\n\nThe purpose of this change is to avoid using object addresses on JITServer.\nUsing object addresses on JITServer creates problems when GC changes the object addresses. Instead, JITServer must use some kind of handle (a GlobalReference or some other GC root) to hold the object so that JITServer always has the valid object addresses.\n\nwalkReferenceChain is special in that it needs half of its information from the JITServer(TR::Node) and half of its information from JITClient(object address). During the walk, we need vmaccess so that GC doesn't move the object of interest. We can only have vmaccess on JITClient, which means we need to do walkReferenceChain on JITClient.\n\nThis change makes JITServer to generate the offsets information JITClient needed for the walk and passes to JITClient in the form of a vector.\n\nIssue: #8109\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-01-13T23:02:24Z", "type": "forcePushed"}, {"oid": "125fefcd709f8c11e1bf2b02a2dded3685bc15e9", "url": "https://github.com/eclipse-openj9/openj9/commit/125fefcd709f8c11e1bf2b02a2dded3685bc15e9", "message": "Add walkReferenceChain JITServer Support\n\nThe purpose of this change is to avoid using object addresses on JITServer.\nUsing object addresses on JITServer creates problems when GC changes the object addresses. Instead, JITServer must use some kind of handle (a GlobalReference or some other GC root) to hold the object so that JITServer always has the valid object addresses.\n\nwalkReferenceChain is special in that it needs half of its information from the JITServer(TR::Node) and half of its information from JITClient(object address). During the walk, we need vmaccess so that GC doesn't move the object of interest. We can only have vmaccess on JITClient, which means we need to do walkReferenceChain on JITClient.\n\nThis change makes JITServer to generate the offsets information JITClient needed for the walk and passes to JITClient in the form of a vector.\n\nIssue: #8109\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-01-13T23:07:57Z", "type": "forcePushed"}, {"oid": "287c142662bfec313c34dd6bb17480d1112ccbdc", "url": "https://github.com/eclipse-openj9/openj9/commit/287c142662bfec313c34dd6bb17480d1112ccbdc", "message": "Add walkReferenceChain JITServer Support\n\nThe purpose of this change is to avoid using object addresses on JITServer.\nUsing object addresses on JITServer creates problems when GC changes the object addresses. Instead, JITServer must use some kind of handle (a GlobalReference or some other GC root) to hold the object so that JITServer always has the valid object addresses.\n\nwalkReferenceChain is special in that it needs half of its information from the JITServer(TR::Node) and half of its information from JITClient(object address). During the walk, we need vmaccess so that GC doesn't move the object of interest. We can only have vmaccess on JITClient, which means we need to do walkReferenceChain on JITClient.\n\nThis change makes JITServer to generate the offsets information JITClient needed for the walk and passes to JITClient in the form of a vector.\n\nIssue: #8109\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-01-13T23:26:44Z", "type": "forcePushed"}, {"oid": "e837b41866bef19bc8685ee2e6946de25e171c56", "url": "https://github.com/eclipse-openj9/openj9/commit/e837b41866bef19bc8685ee2e6946de25e171c56", "message": "Add walkReferenceChain JITServer Support\n\nThe purpose of this change is to avoid using object addresses on JITServer.\nUsing object addresses on JITServer creates problems when GC changes the object addresses. Instead, JITServer must use some kind of handle (a GlobalReference or some other GC root) to hold the object so that JITServer always has the valid object addresses.\n\nwalkReferenceChain is special in that it needs half of its information from the JITServer(TR::Node) and half of its information from JITClient(object address). During the walk, we need vmaccess so that GC doesn't move the object of interest. We can only have vmaccess on JITClient, which means we need to do walkReferenceChain on JITClient.\n\nThis change makes JITServer to generate the offsets information JITClient needed for the walk and passes to JITClient in the form of a vector.\n\nIssue: #8109\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-01-13T23:34:34Z", "type": "forcePushed"}, {"oid": "38f42aed4df96118c3ef84e97eb7016eadefd84d", "url": "https://github.com/eclipse-openj9/openj9/commit/38f42aed4df96118c3ef84e97eb7016eadefd84d", "message": "Add walkReferenceChain JITServer Support\n\nThe purpose of this change is to avoid using object addresses on JITServer.\nUsing object addresses on JITServer creates problems when GC changes the object addresses. Instead, JITServer must use some kind of handle (a GlobalReference or some other GC root) to hold the object so that JITServer always has the valid object addresses.\n\nwalkReferenceChain is special in that it needs half of its information from the JITServer(TR::Node) and half of its information from JITClient(object address). During the walk, we need vmaccess so that GC doesn't move the object of interest. We can only have vmaccess on JITClient, which means we need to do walkReferenceChain on JITClient.\n\nThis change makes JITServer to generate the offsets information JITClient needed for the walk and passes to JITClient in the form of a vector.\n\nIssue: #8109\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-01-13T23:39:53Z", "type": "forcePushed"}, {"oid": "6f373ca457c05e815f641a04207aacc8328f290f", "url": "https://github.com/eclipse-openj9/openj9/commit/6f373ca457c05e815f641a04207aacc8328f290f", "message": "Add walkReferenceChain JITServer Support\n\nThe purpose of this change is to avoid using object addresses on JITServer.\nUsing object addresses on JITServer creates problems when GC changes the object addresses. Instead, JITServer must use some kind of handle (a GlobalReference or some other GC root) to hold the object so that JITServer always has the valid object addresses.\n\nwalkReferenceChain is special in that it needs half of its information from the JITServer(TR::Node) and half of its information from JITClient(object address). During the walk, we need vmaccess so that GC doesn't move the object of interest. We can only have vmaccess on JITClient, which means we need to do walkReferenceChain on JITClient.\n\nThis change makes JITServer to generate the offsets information JITClient needed for the walk and passes to JITClient in the form of a vector.\n\nIssue: #8109\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-01-13T23:58:40Z", "type": "forcePushed"}, {"oid": "b3eb10f29428ae7e91cbfba4100199c10084ef69", "url": "https://github.com/eclipse-openj9/openj9/commit/b3eb10f29428ae7e91cbfba4100199c10084ef69", "message": "Add walkReferenceChain JITServer Support\n\nThe purpose of this change is to avoid using object addresses on JITServer.\nUsing object addresses on JITServer creates problems when GC changes the object addresses. Instead, JITServer must use some kind of handle (a GlobalReference or some other GC root) to hold the object so that JITServer always has the valid object addresses.\n\nwalkReferenceChain is special in that it needs half of its information from the JITServer(TR::Node) and half of its information from JITClient(object address). During the walk, we need vmaccess so that GC doesn't move the object of interest. We can only have vmaccess on JITClient, which means we need to do walkReferenceChain on JITClient.\n\nThis change makes JITServer to generate the offsets information JITClient needed for the walk and passes to JITClient in the form of a vector.\n\nIssue: #8109\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-01-14T16:13:32Z", "type": "commit"}, {"oid": "b3eb10f29428ae7e91cbfba4100199c10084ef69", "url": "https://github.com/eclipse-openj9/openj9/commit/b3eb10f29428ae7e91cbfba4100199c10084ef69", "message": "Add walkReferenceChain JITServer Support\n\nThe purpose of this change is to avoid using object addresses on JITServer.\nUsing object addresses on JITServer creates problems when GC changes the object addresses. Instead, JITServer must use some kind of handle (a GlobalReference or some other GC root) to hold the object so that JITServer always has the valid object addresses.\n\nwalkReferenceChain is special in that it needs half of its information from the JITServer(TR::Node) and half of its information from JITClient(object address). During the walk, we need vmaccess so that GC doesn't move the object of interest. We can only have vmaccess on JITClient, which means we need to do walkReferenceChain on JITClient.\n\nThis change makes JITServer to generate the offsets information JITClient needed for the walk and passes to JITClient in the form of a vector.\n\nIssue: #8109\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-01-14T16:13:32Z", "type": "forcePushed"}, {"oid": "1988428a74712cb18e3502185d0aafcac5537a5a", "url": "https://github.com/eclipse-openj9/openj9/commit/1988428a74712cb18e3502185d0aafcac5537a5a", "message": "Read globalreference after acquire vmaccess\n\nAfter JITClient receives the globalreference from JITServer, we need to obtain vmaccess before we dereference it.\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-01-14T16:31:20Z", "type": "commit"}, {"oid": "d4756331210ee9f4a807ee9323ab4b31847ac564", "url": "https://github.com/eclipse-openj9/openj9/commit/d4756331210ee9f4a807ee9323ab4b31847ac564", "message": "Update all JITServer walkReferenceChain\n\nThere are 4 instances where JITServer incorrectly uses the walkReferenceChain routine. Update them to the new implementation.\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-01-14T16:56:30Z", "type": "commit"}, {"oid": "ff14e563e3121313b83b17285d35983dc6da9f60", "url": "https://github.com/eclipse-openj9/openj9/commit/ff14e563e3121313b83b17285d35983dc6da9f60", "message": "Remove JITServer runFEMacro_derefUintptrjPtr API\n\nThis messageType has been eliminated by the JITServer walkReferenceChain routine.\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-01-14T18:42:05Z", "type": "forcePushed"}, {"oid": "42f4a748a46397408589bc97b375c2ca7f0203e3", "url": "https://github.com/eclipse-openj9/openj9/commit/42f4a748a46397408589bc97b375c2ca7f0203e3", "message": "Remove JITServer runFEMacro_derefUintptrjPtr API\n\nThis messageType has been eliminated by the JITServer walkReferenceChain routine.\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-01-14T18:53:41Z", "type": "commit"}, {"oid": "42f4a748a46397408589bc97b375c2ca7f0203e3", "url": "https://github.com/eclipse-openj9/openj9/commit/42f4a748a46397408589bc97b375c2ca7f0203e3", "message": "Remove JITServer runFEMacro_derefUintptrjPtr API\n\nThis messageType has been eliminated by the JITServer walkReferenceChain routine.\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-01-14T18:53:41Z", "type": "forcePushed"}, {"oid": "43692796317cded59420aec08263ded1034f8eaa", "url": "https://github.com/eclipse-openj9/openj9/commit/43692796317cded59420aec08263ded1034f8eaa", "message": "Remove the JITServer LocalGCCounter hack\n\nNow that walkReferenceChain is handled properly on JITServer and JITClient, the LocalGCCOunter hack, which does not cover all cases and not an efficient workaround, should be removed.\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-01-14T19:02:55Z", "type": "commit"}, {"oid": "4c6ddf7d6153bced67e980a82a42c575c695082c", "url": "https://github.com/eclipse-openj9/openj9/commit/4c6ddf7d6153bced67e980a82a42c575c695082c", "message": "Fix copyright issues\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-01-14T19:03:10Z", "type": "commit"}, {"oid": "4c6ddf7d6153bced67e980a82a42c575c695082c", "url": "https://github.com/eclipse-openj9/openj9/commit/4c6ddf7d6153bced67e980a82a42c575c695082c", "message": "Fix copyright issues\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-01-14T19:03:10Z", "type": "forcePushed"}, {"oid": "73d4106211bcd3f38c97678e8c59e21f3fdc13c9", "url": "https://github.com/eclipse-openj9/openj9/commit/73d4106211bcd3f38c97678e8c59e21f3fdc13c9", "message": "Incrementing version number\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-01-14T19:19:25Z", "type": "commit"}, {"oid": "fed1f064f2cd1063e69cf98bbb96f140776324c1", "url": "https://github.com/eclipse-openj9/openj9/commit/fed1f064f2cd1063e69cf98bbb96f140776324c1", "message": "Add runFEMacro JITServer Support\n\nThis change handles the following 3 methods for JITServer:\n1. java_lang_invoke_FilterArgumentsWithCombinerHandle_numSuffixArgs\n2. java_lang_invoke_FilterArgumentsWithCombinerHandle_filterPosition\n3. java_lang_invoke_FilterArgumentsWithCombinerHandle_argumentIndices\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-01-14T20:57:12Z", "type": "forcePushed"}, {"oid": "b20baef75c226f4862ba3418aa5d5d74483c9cb6", "url": "https://github.com/eclipse-openj9/openj9/commit/b20baef75c226f4862ba3418aa5d5d74483c9cb6", "message": "Add runFEMacro JITServer Support\n\nThis change handles the following 3 methods for JITServer:\n1. java_lang_invoke_FilterArgumentsWithCombinerHandle_numSuffixArgs\n2. java_lang_invoke_FilterArgumentsWithCombinerHandle_filterPosition\n3. java_lang_invoke_FilterArgumentsWithCombinerHandle_argumentIndices\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-01-14T21:01:31Z", "type": "forcePushed"}, {"oid": "2bac4a756d16934bb44f0bb64d46953d98daeeca", "url": "https://github.com/eclipse-openj9/openj9/commit/2bac4a756d16934bb44f0bb64d46953d98daeeca", "message": "Add runFEMacro JITServer Support\n\nThis change handles the following 3 methods for JITServer:\n1. java_lang_invoke_FilterArgumentsWithCombinerHandle_numSuffixArgs\n2. java_lang_invoke_FilterArgumentsWithCombinerHandle_filterPosition\n3. java_lang_invoke_FilterArgumentsWithCombinerHandle_argumentIndices\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-01-14T21:09:09Z", "type": "commit"}, {"oid": "2bac4a756d16934bb44f0bb64d46953d98daeeca", "url": "https://github.com/eclipse-openj9/openj9/commit/2bac4a756d16934bb44f0bb64d46953d98daeeca", "message": "Add runFEMacro JITServer Support\n\nThis change handles the following 3 methods for JITServer:\n1. java_lang_invoke_FilterArgumentsWithCombinerHandle_numSuffixArgs\n2. java_lang_invoke_FilterArgumentsWithCombinerHandle_filterPosition\n3. java_lang_invoke_FilterArgumentsWithCombinerHandle_argumentIndices\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-01-14T21:09:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU1MzgzMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/8293#discussion_r366553832", "bodyText": "Maybe use a const reference here  (const std::vector<uintptrj_t> &listOfOffsets)", "author": "mpirvu", "createdAt": "2020-01-14T20:22:22Z", "path": "runtime/compiler/control/JITClientCompilationThread.cpp", "diffHunk": "@@ -2063,26 +2049,13 @@ handleServerMessage(JITServer::ClientStream *client, TR_J9VM *fe, JITServer::Mes\n          client->write(response, ptr);\n          }\n          break;\n-      case MessageType::runFEMacro_derefUintptrjPtr:\n-         {\n-         TR::VMAccessCriticalSection deref(fe);\n-         compInfoPT->updateLastLocalGCCounter();\n-         client->write(response, *std::get<0>(client->getRecvData<uintptrj_t*>()));\n-         }\n-         break;\n       case MessageType::runFEMacro_invokeILGenMacrosInvokeExactAndFixup:\n          {\n-         auto recv = client->getRecvData<uintptrj_t>();\n+         auto recv = client->getRecvData<uintptrj_t*, std::vector<uintptrj_t> >();\n          TR::VMAccessCriticalSection invokeILGenMacrosInvokeExactAndFixup(fe);\n-\n-         if (compInfoPT->getLastLocalGCCounter() != compInfoPT->getCompilationInfo()->getLocalGCCounter())\n-            {\n-            // GC happened, fail compilation\n-            auto comp = compInfoPT->getCompilation();\n-            comp->failCompilation<TR::CompilationInterrupted>(\"Compilation interrupted due to GC\");\n-            }\n-\n-         uintptrj_t methodHandle = std::get<0>(recv);\n+         uintptrj_t receiverHandle = *std::get<0>(recv);\n+         std::vector<uintptrj_t> listOfOffsets = std::get<1>(recv);", "originalCommit": "73d4106211bcd3f38c97678e8c59e21f3fdc13c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU2MTg2NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8293#discussion_r366561865", "bodyText": "I would delete blah", "author": "mpirvu", "createdAt": "2020-01-14T20:41:46Z", "path": "runtime/compiler/env/j9method.cpp", "diffHunk": "@@ -9200,3 +9201,45 @@ TR_J9ByteCodeIlGenerator::walkReferenceChain(TR::Node *node, uintptrj_t receiver\n \n    return result;\n    }\n+\n+\n+#if defined(JITSERVER_SUPPORT)\n+void\n+TR_J9ByteCodeIlGenerator::packReferenceChainOffsets(TR::Node *node, std::vector<uintptrj_t>& listOfOffsets)\n+   {\n+   if (node->getOpCode().isLoadDirect() && node->getType() == TR::Address)\n+      {\n+      TR_ASSERT(node->getSymbolReference()->getCPIndex() == 0, \"walkReferenceChain expecting aload of 'this'; found aload of %s\", comp()->getDebug()->getName(node->getSymbolReference()));\n+      return;\n+      }\n+   else if (node->getOpCode().isLoadIndirect() && node->getType() == TR::Address)\n+      {\n+      TR::SymbolReference *symRef = node->getSymbolReference();\n+      if (symRef->isUnresolved())\n+         {\n+         if (comp()->getOption(TR_TraceILGen))\n+            traceMsg(comp(), \"  walkReferenceChain hit unresolved symref %s; aborting\\n\", symRef->getName(comp()->getDebug()));\n+         comp()->failCompilation<TR::ILGenFailure>(\"Symbol reference is unresolved\");\n+         }\n+      TR::Symbol *sym = symRef->getSymbol();\n+      TR_ASSERT(sym->isShadow() && symRef->getCPIndex() > 0, \"walkReferenceChain expecting field load; found load of %s\", comp()->getDebug()->getName(symRef));\n+      uintptrj_t fieldOffset = symRef->getOffset() - TR::Compiler->om.objectHeaderSizeInBytes(); // blah", "originalCommit": "73d4106211bcd3f38c97678e8c59e21f3fdc13c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA5NTY4MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8293#discussion_r367095681", "bodyText": "listOfOffsets should be be const because it is only read", "author": "mpirvu", "createdAt": "2020-01-15T20:40:03Z", "path": "runtime/compiler/control/JITServerHelpers.cpp", "diffHunk": "@@ -549,3 +550,16 @@ JITServerHelpers::isAddressInROMClass(const void *address, const J9ROMClass *rom\n    {\n    return ((address >= romClass) && (address < (((uint8_t*) romClass) + romClass->romSize)));\n    }\n+\n+\n+uintptrj_t\n+JITServerHelpers::walkReferenceChainWithOffsets(TR_J9VM * fe, std::vector<uintptrj_t>& listOfOffsets, uintptrj_t receiver)", "originalCommit": "2bac4a756d16934bb44f0bb64d46953d98daeeca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzIwNjI2Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8293#discussion_r367206267", "bodyText": "listOfOffsets could be marked const", "author": "mpirvu", "createdAt": "2020-01-16T02:40:33Z", "path": "runtime/compiler/control/JITServerHelpers.cpp", "diffHunk": "@@ -549,3 +550,16 @@ JITServerHelpers::isAddressInROMClass(const void *address, const J9ROMClass *rom\n    {\n    return ((address >= romClass) && (address < (((uint8_t*) romClass) + romClass->romSize)));\n    }\n+\n+\n+uintptrj_t\n+JITServerHelpers::walkReferenceChainWithOffsets(TR_J9VM * fe, std::vector<uintptrj_t>& listOfOffsets, uintptrj_t receiver)", "originalCommit": "73d4106211bcd3f38c97678e8c59e21f3fdc13c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzIxMTUxNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8293#discussion_r367211517", "bodyText": "Maybe use a const reference for the string extracted from the message", "author": "mpirvu", "createdAt": "2020-01-16T03:07:19Z", "path": "runtime/compiler/env/j9method.cpp", "diffHunk": "@@ -7789,11 +7790,13 @@ TR_J9ByteCodeIlGenerator::runFEMacro(TR::SymbolReference *symRef)\n #if defined(JITSERVER_SUPPORT)\n          if (comp()->isOutOfProcessCompilation())\n             {\n+            std::vector<uintptrj_t> listOfOffsets;\n+            if (!returnFromArchetype)\n+               {\n+               packReferenceChainOffsets(methodHandleExpression, listOfOffsets);\n+               }\n             auto stream = TR::CompilationInfo::getStream();\n-            stream->write(JITServer::MessageType::runFEMacro_derefUintptrjPtr, thunkDetails->getHandleRef());\n-            receiverHandle = std::get<0>(stream->read<uintptrj_t>());\n-            methodHandle = returnFromArchetype ? receiverHandle : walkReferenceChain(methodHandleExpression, receiverHandle);\n-            stream->write(JITServer::MessageType::runFEMacro_invokeILGenMacrosInvokeExactAndFixup, methodHandle);\n+            stream->write(JITServer::MessageType::runFEMacro_invokeILGenMacrosInvokeExactAndFixup, thunkDetails->getHandleRef(), listOfOffsets);\n             auto recv = stream->read<std::string>();\n             std::string methodDescriptorString = std::get<0>(recv);", "originalCommit": "2bac4a756d16934bb44f0bb64d46953d98daeeca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzIzMTk4Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8293#discussion_r367231987", "bodyText": "Again, let's use a const reference here", "author": "mpirvu", "createdAt": "2020-01-16T05:03:55Z", "path": "runtime/compiler/control/JITClientCompilationThread.cpp", "diffHunk": "@@ -2373,17 +2389,13 @@ handleServerMessage(JITServer::ClientStream *client, TR_J9VM *fe, JITServer::Mes\n          client->write(response, permuteLength, argIndices);\n          }\n          break;\n-      case MessageType::runFEMacro_invokeILGenMacros:\n+      case MessageType::runFEMacro_invokeILGenMacrosParameterCount:\n          {\n-         if (compInfoPT->getLastLocalGCCounter() != compInfoPT->getCompilationInfo()->getLocalGCCounter())\n-            {\n-            // GC happened, fail compilation\n-            auto comp = compInfoPT->getCompilation();\n-            comp->failCompilation<TR::CompilationInterrupted>(\"Compilation interrupted due to GC\");\n-            }\n-\n-         uintptrj_t methodHandle = std::get<0>(client->getRecvData<uintptrj_t>());\n-         TR::VMAccessCriticalSection invokeILGenMacros(fe);\n+         auto recv = client->getRecvData<uintptrj_t*, std::vector<uintptrj_t> >();\n+         TR::VMAccessCriticalSection invokeILGenMacrosParameterCount(fe);\n+         uintptrj_t receiverHandle = *std::get<0>(recv);\n+         std::vector<uintptrj_t> listOfOffsets = std::get<1>(recv);", "originalCommit": "2bac4a756d16934bb44f0bb64d46953d98daeeca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzIzMjA4NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/8293#discussion_r367232085", "bodyText": "Again, let's use a const reference here", "author": "mpirvu", "createdAt": "2020-01-16T05:04:30Z", "path": "runtime/compiler/control/JITClientCompilationThread.cpp", "diffHunk": "@@ -2392,7 +2404,29 @@ handleServerMessage(JITServer::ClientStream *client, TR_J9VM *fe, JITServer::Mes\n          client->write(response, parameterCount);\n          }\n          break;\n-\n+      case MessageType::runFEMacro_invokeILGenMacrosArrayLength:\n+         {\n+         auto recv = client->getRecvData<uintptrj_t*, std::vector<uintptrj_t> >();\n+         TR::VMAccessCriticalSection invokeILGenMacrosArrayLength(fe);\n+         uintptrj_t receiverHandle = *std::get<0>(recv);\n+         std::vector<uintptrj_t> listOfOffsets = std::get<1>(recv);", "originalCommit": "2bac4a756d16934bb44f0bb64d46953d98daeeca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzIzMjExNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/8293#discussion_r367232117", "bodyText": "Again, let's use a const reference here", "author": "mpirvu", "createdAt": "2020-01-16T05:04:40Z", "path": "runtime/compiler/control/JITClientCompilationThread.cpp", "diffHunk": "@@ -2392,7 +2404,29 @@ handleServerMessage(JITServer::ClientStream *client, TR_J9VM *fe, JITServer::Mes\n          client->write(response, parameterCount);\n          }\n          break;\n-\n+      case MessageType::runFEMacro_invokeILGenMacrosArrayLength:\n+         {\n+         auto recv = client->getRecvData<uintptrj_t*, std::vector<uintptrj_t> >();\n+         TR::VMAccessCriticalSection invokeILGenMacrosArrayLength(fe);\n+         uintptrj_t receiverHandle = *std::get<0>(recv);\n+         std::vector<uintptrj_t> listOfOffsets = std::get<1>(recv);\n+         uintptrj_t array = JITServerHelpers::walkReferenceChainWithOffsets(fe, listOfOffsets, receiverHandle);\n+         int32_t arrayLength = (int32_t)fe->getArrayLengthInElements(array);\n+         client->write(response, arrayLength);\n+         }\n+         break;\n+      case MessageType::runFEMacro_invokeILGenMacrosGetField:\n+         {\n+         auto recv = client->getRecvData<uintptrj_t*, uintptrj_t, std::vector<uintptrj_t> >();\n+         TR::VMAccessCriticalSection invokeILGenMacrosGetField(fe);\n+         uintptrj_t receiverHandle = *std::get<0>(recv);\n+         uintptrj_t fieldOffset = std::get<1>(recv);\n+         std::vector<uintptrj_t> listOfOffsets = std::get<2>(recv);", "originalCommit": "2bac4a756d16934bb44f0bb64d46953d98daeeca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c963b8c885395d8f89b693416870dcc548523a1f", "url": "https://github.com/eclipse-openj9/openj9/commit/c963b8c885395d8f89b693416870dcc548523a1f", "message": "Make listOfOffsets const vector reference\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-01-16T16:31:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUzOTgzOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/8293#discussion_r367539838", "bodyText": "I believe that getIn32FieldAt requires VM access in hand. same for getInt64FieldAt below", "author": "mpirvu", "createdAt": "2020-01-16T17:03:16Z", "path": "runtime/compiler/control/JITClientCompilationThread.cpp", "diffHunk": "@@ -656,13 +656,6 @@ handleServerMessage(JITServer::ClientStream *client, TR_J9VM *fe, JITServer::Mes\n          break;\n       case MessageType::VM_getInt32FieldAt:\n          {\n-         if (compInfoPT->getLastLocalGCCounter() != compInfoPT->getCompilationInfo()->getLocalGCCounter())\n-            {\n-            // GC happened, fail compilation\n-            auto comp = compInfoPT->getCompilation();\n-            comp->failCompilation<TR::CompilationInterrupted>(\"Compilation interrupted due to GC\");\n-            }\n-\n          auto recv = client->getRecvData<uintptrj_t, uintptrj_t>();\n          uintptrj_t objectPointer = std::get<0>(recv);\n          uintptrj_t fieldOffset = std::get<1>(recv);", "originalCommit": "c963b8c885395d8f89b693416870dcc548523a1f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU0MTk0Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/8293#discussion_r367541942", "bodyText": "fe->getArrayLengthInElements assumes VM access is already held, but I don't think the client will have it here, so we need to acquire is briefly", "author": "mpirvu", "createdAt": "2020-01-16T17:07:19Z", "path": "runtime/compiler/control/JITClientCompilationThread.cpp", "diffHunk": "@@ -699,13 +692,6 @@ handleServerMessage(JITServer::ClientStream *client, TR_J9VM *fe, JITServer::Mes\n          break;\n       case MessageType::VM_getArrayLengthInElements:\n          {\n-         if (compInfoPT->getLastLocalGCCounter() != compInfoPT->getCompilationInfo()->getLocalGCCounter())\n-            {\n-            // GC happened, fail compilation\n-            auto comp = compInfoPT->getCompilation();\n-            comp->failCompilation<TR::CompilationInterrupted>(\"Compilation interrupted due to GC\");\n-            }\n-\n          uintptrj_t objectPointer = std::get<0>(client->getRecvData<uintptrj_t>());\n          client->write(response, fe->getArrayLengthInElements(objectPointer));", "originalCommit": "c963b8c885395d8f89b693416870dcc548523a1f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cd54e6009d7fc5f59cbf541022d8be29d090e0a6", "url": "https://github.com/eclipse-openj9/openj9/commit/cd54e6009d7fc5f59cbf541022d8be29d090e0a6", "message": "Acquire VMAccess for various JITClient APIs\n\nSigned-off-by: Harry Yu <harryyu1994@gmail.com>", "committedDate": "2020-01-16T19:05:08Z", "type": "commit"}]}