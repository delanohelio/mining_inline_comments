{"pr_number": 11317, "pr_title": "Update how Eden size is reported at gc-start and gc-end", "pr_createdAt": "2020-12-01T15:11:08Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/11317", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQ2NDM2NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/11317#discussion_r536464364", "bodyText": "Remove gcStart/gcEnd dependency", "author": "bragaigor", "createdAt": "2020-12-05T00:46:18Z", "path": "runtime/gc_vlhgc/IncrementalGenerationalGC.cpp", "diffHunk": "@@ -2101,6 +2101,9 @@ MM_IncrementalGenerationalGC::exportStats(MM_EnvironmentVLHGC *env, MM_Collectio\n \t\t/* numaNodes is just used as indication to verbose GC that stats we collected are valid and indeed should be reported */\n \t\tstats->_numaNodes = _extensions->_numaManager.getAffinityLeaderCount();\n \t\tUDATA regionSize = _regionManager->getRegionSize();\n+\t\tUDATA allocateEdenTotal = 0;\n+\t\tstats->_edenHeapSize = getCurrentEdenSizeInBytes(env);\n+\t\tbool isGCend = stats->_startTime > stats->_endTime;", "originalCommit": "c20642fe6efa56460a65eb7b5761cb45590f5762", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b161545c3904d2df6018a9546b5e01b19d858880", "url": "https://github.com/eclipse-openj9/openj9/commit/b161545c3904d2df6018a9546b5e01b19d858880", "message": "Update how Eden size is reported at gc-start and gc-end\n\nFix how Eden size is reported at gc-start and gc-end\nin balanced GC policy. Make it consistent with reporting\nMM_HeapRegionManagerVLHGC::getHeapMemorySnapshot().\n\nSigned-off-by: Igor Braga <higorb1@gmail.com>", "committedDate": "2020-12-05T01:52:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQyNzYzMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/11317#discussion_r539427633", "bodyText": "we still need to update allocateEdenTotal, even for arraylet (age 0) region", "author": "amicic", "createdAt": "2020-12-09T15:56:44Z", "path": "runtime/gc_vlhgc/IncrementalGenerationalGC.cpp", "diffHunk": "@@ -2111,23 +2113,20 @@ MM_IncrementalGenerationalGC::exportStats(MM_EnvironmentVLHGC *env, MM_Collectio\n \t\t\t\tif (region->containsObjects()) {\n \t\t\t\t\tMM_MemoryPoolBumpPointer *memoryPool = (MM_MemoryPoolBumpPointer *)region->getMemoryPool();\n \t\t\t\t\tAssert_MM_true(NULL != memoryPool);\n-\t\t\t\t\t/* for Eden region containing objects Allocation Age must be smaller then amount allocated since last PGC */\n-\t\t\t\t\tif (region->getAllocationAge() <= _allocatedSinceLastPGC) {\n-\t\t\t\t\t\tstats->_edenHeapSize += regionSize;\n+\t\t\t\t\t/* Eden region containing objects, Allocation Age must be smaller then amount allocated since last PGC,\n+\t\t\t\t\t * more accurately, its logical age must be equal to zero */\n+\t\t\t\t\tif (0 == region->getLogicalAge()) {\n \t\t\t\t\t\t/* region is not collected yet, so getActualFreeMemorySize might not be accurate - using getAllocatableBytes instead */\n \t\t\t\t\t\tUDATA size = memoryPool->getAllocatableBytes();\n \t\t\t\t\t\tstats->_edenFreeHeapSize += size;\n \t\t\t\t\t\tusedMemory = regionSize - size;\n+\t\t\t\t\t\tallocateEdenTotal += regionSize;\n \t\t\t\t\t} else {\n \t\t\t\t\t\tusedMemory = regionSize - memoryPool->getFreeMemoryAndDarkMatterBytes();\n \t\t\t\t\t}\n \t\t\t\t} else {\n \t\t\t\t\tAssert_MM_true(region->isArrayletLeaf());\n \t\t\t\t\tusedMemory = regionSize;\n-\t\t\t\t\t/* for Eden arraylet leaf Allocation Age must be smaller then amount allocated since last PGC */\n-\t\t\t\t\tif (region->getAllocationAge() <= _allocatedSinceLastPGC) {\n-\t\t\t\t\t\tstats->_edenHeapSize += regionSize;", "originalCommit": "b161545c3904d2df6018a9546b5e01b19d858880", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ0OTIxMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/11317#discussion_r539449212", "bodyText": "I prefer to use the old age condition (it's more generic), which might work better after reordering in #11378", "author": "amicic", "createdAt": "2020-12-09T16:22:18Z", "path": "runtime/gc_vlhgc/IncrementalGenerationalGC.cpp", "diffHunk": "@@ -2111,23 +2113,20 @@ MM_IncrementalGenerationalGC::exportStats(MM_EnvironmentVLHGC *env, MM_Collectio\n \t\t\t\tif (region->containsObjects()) {\n \t\t\t\t\tMM_MemoryPoolBumpPointer *memoryPool = (MM_MemoryPoolBumpPointer *)region->getMemoryPool();\n \t\t\t\t\tAssert_MM_true(NULL != memoryPool);\n-\t\t\t\t\t/* for Eden region containing objects Allocation Age must be smaller then amount allocated since last PGC */\n-\t\t\t\t\tif (region->getAllocationAge() <= _allocatedSinceLastPGC) {\n-\t\t\t\t\t\tstats->_edenHeapSize += regionSize;\n+\t\t\t\t\t/* Eden region containing objects, Allocation Age must be smaller then amount allocated since last PGC,\n+\t\t\t\t\t * more accurately, its logical age must be equal to zero */\n+\t\t\t\t\tif (0 == region->getLogicalAge()) {", "originalCommit": "b161545c3904d2df6018a9546b5e01b19d858880", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1d19a16284c9b7b666c3730d223b1cdbabb6ecba", "url": "https://github.com/eclipse-openj9/openj9/commit/1d19a16284c9b7b666c3730d223b1cdbabb6ecba", "message": "Reorder how/when taxation threshold and regions' age are updated\n\nSigned-off-by: Igor Braga <higorb1@gmail.com>", "committedDate": "2020-12-11T15:06:02Z", "type": "forcePushed"}, {"oid": "906af6d45fb292007c3eaa1a30e73dc2d50ecaec", "url": "https://github.com/eclipse-openj9/openj9/commit/906af6d45fb292007c3eaa1a30e73dc2d50ecaec", "message": "Update how Eden size is reported at gc-start and gc-end\n\nFix how Eden size is reported at gc-start and gc-end\nin balanced GC policy. Make it consistent with reporting\nMM_HeapRegionManagerVLHGC::getHeapMemorySnapshot().\n\nReorder how/when taxation threshold and regions' age are updated.\nInstead of updating region's age at the very end of a GC increment\nwe now update it at the end of GC increment but before we report\ngc-end. With the update of exportStats on how Eden is reported,\nwe now have total Eden size as being reported as\ngetCurrentEdenSizeInBytes() always while free eden size in bytes\ncontain the correct value, where at gc-start _edenFreeHeapSize is\nclose to zero and at gc-end it's equal to Eden heap size.\n\nSigned-off-by: Igor Braga <higorb1@gmail.com>", "committedDate": "2020-12-11T15:22:39Z", "type": "commit"}, {"oid": "906af6d45fb292007c3eaa1a30e73dc2d50ecaec", "url": "https://github.com/eclipse-openj9/openj9/commit/906af6d45fb292007c3eaa1a30e73dc2d50ecaec", "message": "Update how Eden size is reported at gc-start and gc-end\n\nFix how Eden size is reported at gc-start and gc-end\nin balanced GC policy. Make it consistent with reporting\nMM_HeapRegionManagerVLHGC::getHeapMemorySnapshot().\n\nReorder how/when taxation threshold and regions' age are updated.\nInstead of updating region's age at the very end of a GC increment\nwe now update it at the end of GC increment but before we report\ngc-end. With the update of exportStats on how Eden is reported,\nwe now have total Eden size as being reported as\ngetCurrentEdenSizeInBytes() always while free eden size in bytes\ncontain the correct value, where at gc-start _edenFreeHeapSize is\nclose to zero and at gc-end it's equal to Eden heap size.\n\nSigned-off-by: Igor Braga <higorb1@gmail.com>", "committedDate": "2020-12-11T15:22:39Z", "type": "forcePushed"}]}