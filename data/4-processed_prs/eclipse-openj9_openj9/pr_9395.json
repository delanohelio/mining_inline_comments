{"pr_number": 9395, "pr_title": "Concurrent Scavenger Ownable Synchronizer Fix", "pr_createdAt": "2020-04-28T23:44:54Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/9395", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzMxMzMxNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9395#discussion_r417313314", "bodyText": "please add extra pair of brackets (NULL != link)", "author": "dmitripivkine", "createdAt": "2020-04-29T13:28:17Z", "path": "runtime/gc_glue_java/ScavengerDelegate.cpp", "diffHunk": "@@ -604,12 +604,12 @@ MM_ScavengerDelegate::private_addOwnableSynchronizerObjectInList(MM_EnvironmentS\n \tomrobjectptr_t link = MM_GCExtensions::getExtensions(_extensions)->accessBarrier->isObjectInOwnableSynchronizerList(object);\n \t/* if isObjectInOwnableSynchronizerList() return NULL, it means the object isn't in OwnableSynchronizerList,\n \t * it could be the constructing object which would be added in the list after the construction finish later. ignore the object to avoid duplicated reference in the list.\n-\t * For concurrent scavenger, an object that doesn't finish constructing before the start of the STW phase will be added to the list after, during the concurrent phase.\n-\t * In this case, the object may already be added to the list. */\n-\tif (NULL != link && (!_extensions->isConcurrentScavengerEnabled() || (_extensions->isConcurrentScavengerEnabled() && !_extensions->scavenger->isObjectInNewSpace(link)))) {\n+\t * For concurrent scavenger, an object that doesn't finish constructing before the start of the STW phase will be added to the list after. As a result, the object may already\n+\t * be added to the list (non NULL link) when we scan it during the concurrent phase. We must not add it again here, so check link before proceeding */\n+\tif (NULL != link && (!_extensions->isConcurrentScavengerEnabled() || (_extensions->isConcurrentScavengerEnabled() && _extensions->scavenger->isObjectInEvacuateMemory(link)))) {", "originalCommit": "a75046219d9c3dd61a9dd5f43ce616475fc44314", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9e622b41b04336fd7c18d2e61a8fa53cf3295d83", "url": "https://github.com/eclipse-openj9/openj9/commit/9e622b41b04336fd7c18d2e61a8fa53cf3295d83", "message": "Concurrent Scavenger Ownable Synchronizer Fix\n\nFix corner case where Ownable Sync is duplicated in list. This occurs\nwhen Ownable object construction finishes much after allocation causing\nit to survive multiple scavengers and being tenured. The object will be\nadded by jit following the the STW phase, the concurrent phase will\nattempt to add it again, the `!isObjectInNewSpace(link)` condition would\nstop this in normal circumstances. However, since this object will be\nlinked to tenure, `!isObjectInNewSpace(link)` will not be a sufficient\ncheck (checks against survivor space) as the tenured Ownable will pass\nthe condition.\n\nSigned-off-by: Salman Rana <salman.rana@ibm.com>", "committedDate": "2020-04-29T17:54:23Z", "type": "commit"}, {"oid": "9e622b41b04336fd7c18d2e61a8fa53cf3295d83", "url": "https://github.com/eclipse-openj9/openj9/commit/9e622b41b04336fd7c18d2e61a8fa53cf3295d83", "message": "Concurrent Scavenger Ownable Synchronizer Fix\n\nFix corner case where Ownable Sync is duplicated in list. This occurs\nwhen Ownable object construction finishes much after allocation causing\nit to survive multiple scavengers and being tenured. The object will be\nadded by jit following the the STW phase, the concurrent phase will\nattempt to add it again, the `!isObjectInNewSpace(link)` condition would\nstop this in normal circumstances. However, since this object will be\nlinked to tenure, `!isObjectInNewSpace(link)` will not be a sufficient\ncheck (checks against survivor space) as the tenured Ownable will pass\nthe condition.\n\nSigned-off-by: Salman Rana <salman.rana@ibm.com>", "committedDate": "2020-04-29T17:54:23Z", "type": "forcePushed"}]}