{"pr_number": 11254, "pr_title": "Keep splitPostGRA stores in right block for acmp fast path", "pr_createdAt": "2020-11-24T03:59:08Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/11254", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc0OTgxNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/11254#discussion_r529749814", "bodyText": "Why we move the acmp call tree top just after node whose child is node? I think this routine can be simpler, what you need to do is move the acmp call helper at the end of the prevBlock . You might just need to get the last real tree-top and add it after it as you have just split the blocks I do not think we would have more than one exit edge from the prevBlock.", "author": "r30shah", "createdAt": "2020-11-24T17:24:14Z", "path": "runtime/compiler/codegen/J9CodeGenerator.cpp", "diffHunk": "@@ -251,6 +251,48 @@ J9::CodeGenerator::fastpathAcmpHelper(TR::Node *node, TR::TreeTop *tt, const boo\n    // next treetop and then at the current one\n    TR::Block* prevBlock = tt->getEnclosingBlock();\n    TR::Block* targetBlock = prevBlock->splitPostGRA(tt->getNextTreeTop(), cfg, true, NULL);\n+\n+   // Move call tree to end of block, along with any stores of the result of the call, if they're\n+   // not already at the end.  The call has to be split into its own block, but splitPostGRA above\n+   // might have left register stores and stores into temporaries that must stay with the previous block\n+   TR::TreeTop* prevBlockExit = prevBlock->getExit();\n+   TR::TreeTop* afterTT = tt->getNextTreeTop();\n+\n+   if (afterTT != prevBlockExit)\n+      {\n+      if (trace)\n+         {\n+         traceMsg(comp, \"Moving treetop containing node n%dn [%p] associated with acmp helper call to end of prevBlock in preparation of final block split\\n\", tt->getNode()->getGlobalIndex(), tt->getNode());\n+         }\n+\n+      // Remove TreeTop for call node\n+      tt->unlink(false);\n+      TR::TreeTop* callTreesTail = tt;\n+\n+      while (afterTT != prevBlockExit)\n+         {\n+         TR::TreeTop* nextTT = afterTT->getNextTreeTop();\n+         TR::ILOpCodes op = afterTT->getNode()->getOpCodeValue();\n+\n+         if ((op == TR::iRegStore || op == TR::istore) && afterTT->getNode()->getFirstChild() == node)", "originalCommit": "bd3aac0b531b17e22787e8f8cf484522859c8f3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTkxODc4MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11254#discussion_r529918781", "bodyText": "@r30shah Rahil, I'm not sure I'm understanding your comment, so let me show an example of what's happening.  Here are the trees after the call to splitPostGRA:\nn142n     treetop                                                                             \nn141n       icall  jitAcmpHelper[#99  helper Method] [flags 0x400 0x0 ]                       \nn139n         ==>aload\nn140n         ==>aload\nn340n     bRegStore ecx                                                                       \nn14n        ==>bloadi\nn343n     bRegStore edx                                                                       \nn31n        ==>bloadi\nn346n     bRegStore esi                                                                       \nn48n        ==>bloadi\nn349n     bRegStore eax                                                                       \nn65n        ==>bloadi\nn352n     bRegStore r14d                                                                      \nn82n        ==>bloadi\nn355n     istore  <temp slot 24>[#371  Auto] [flags 0x3 0x0 ]                                 \nn354n       b2i                                                                               \nn99n          ==>bloadi\nn359n     istore  <temp slot 25>[#372  Auto] [flags 0x3 0x0 ]                                 \nn358n       b2i                                                                               \nn116n         ==>bloadi\nn363n     istore  <temp slot 26>[#373  Auto] [flags 0x3 0x0 ]                                 \nn362n       b2i                                                                               \nn133n         ==>bloadi\nn366n     istore  <temp slot 27>[#374  Auto] [flags 0x3 0x0 ]                                 \nn141n       ==>icall\nn338n     BBEnd </block_2> ===== ()\n\nI'm trying to move the TR::TreeTops containing nodes n142n and n366n.  I hadn't wanted to make any assumptions about how many stores there might be for the value of the icall or whether they would appear after all of the other stores.", "author": "hzongaro", "createdAt": "2020-11-24T22:06:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc0OTgxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDAwNzU2MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11254#discussion_r530007561", "bodyText": "Okk, Sorry, now it is clear to me.  So far it seems good to me, let me give it another look.", "author": "r30shah", "createdAt": "2020-11-24T23:33:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc0OTgxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTkxOTgyMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/11254#discussion_r529919822", "bodyText": "I wonder if the diagram on the above should be updated with GlRegDeps() to  show how the register dependency looks like between the split blocks and some sort of annotation that mentions the call tree needs to be at the end of the block.\nhttps://github.com/eclipse/openj9/blob/bd3aac0b531b17e22787e8f8cf484522859c8f3f/runtime/compiler/codegen/J9CodeGenerator.cpp#L197-L219", "author": "a7ehuo", "createdAt": "2020-11-24T22:07:18Z", "path": "runtime/compiler/codegen/J9CodeGenerator.cpp", "diffHunk": "@@ -251,6 +251,48 @@ J9::CodeGenerator::fastpathAcmpHelper(TR::Node *node, TR::TreeTop *tt, const boo\n    // next treetop and then at the current one\n    TR::Block* prevBlock = tt->getEnclosingBlock();\n    TR::Block* targetBlock = prevBlock->splitPostGRA(tt->getNextTreeTop(), cfg, true, NULL);\n+\n+   // Move call tree to end of block, along with any stores of the result of the call, if they're", "originalCommit": "bd3aac0b531b17e22787e8f8cf484522859c8f3f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA2OTkzMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/11254#discussion_r530069930", "bodyText": "Thanks for suggesting that this should show the register dependencies; I'll do that.\nAs for showing that the call tree has to appear at the end of the block, the difficulty is that this diagram shows where the acmphelper call ends up after the call to split.  It's only at the end of the previous block just before the call split, so I would have to add another diagram showing the intermediate state.  I'm not sure it's worth it to add another diagram.  Thoughts?", "author": "hzongaro", "createdAt": "2020-11-25T02:36:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTkxOTgyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA3NDU0NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/11254#discussion_r530074544", "bodyText": "IMO a detailed explanation here before moving the treetops should suffice the intermediate state. Adding CFG diagram for intermediate state in the beginning would complicate. I have just reworded the  above comment,\nAs the block is split after the helper call node, it might be possible that as part of un-commoning, code to store nodes into registers or temp-slot is appended to the original block by splitPostGRA call. Move helper call treetop  to end of block, along with any stores resulting from un-commoning of the nodes in helper call tree so that it can be split into its own block", "author": "r30shah", "createdAt": "2020-11-25T02:51:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTkxOTgyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQ1OTgwNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/11254#discussion_r530459806", "bodyText": "A detailed explanation would do.", "author": "a7ehuo", "createdAt": "2020-11-25T15:31:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTkxOTgyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTkyODk0MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/11254#discussion_r529928941", "bodyText": "Should this trace be updated to differentiate from the trace message at line L265 to show this one is more specific to store nodes?", "author": "a7ehuo", "createdAt": "2020-11-24T22:16:04Z", "path": "runtime/compiler/codegen/J9CodeGenerator.cpp", "diffHunk": "@@ -251,6 +251,48 @@ J9::CodeGenerator::fastpathAcmpHelper(TR::Node *node, TR::TreeTop *tt, const boo\n    // next treetop and then at the current one\n    TR::Block* prevBlock = tt->getEnclosingBlock();\n    TR::Block* targetBlock = prevBlock->splitPostGRA(tt->getNextTreeTop(), cfg, true, NULL);\n+\n+   // Move call tree to end of block, along with any stores of the result of the call, if they're\n+   // not already at the end.  The call has to be split into its own block, but splitPostGRA above\n+   // might have left register stores and stores into temporaries that must stay with the previous block\n+   TR::TreeTop* prevBlockExit = prevBlock->getExit();\n+   TR::TreeTop* afterTT = tt->getNextTreeTop();\n+\n+   if (afterTT != prevBlockExit)\n+      {\n+      if (trace)\n+         {\n+         traceMsg(comp, \"Moving treetop containing node n%dn [%p] associated with acmp helper call to end of prevBlock in preparation of final block split\\n\", tt->getNode()->getGlobalIndex(), tt->getNode());\n+         }\n+\n+      // Remove TreeTop for call node\n+      tt->unlink(false);\n+      TR::TreeTop* callTreesTail = tt;\n+\n+      while (afterTT != prevBlockExit)\n+         {\n+         TR::TreeTop* nextTT = afterTT->getNextTreeTop();\n+         TR::ILOpCodes op = afterTT->getNode()->getOpCodeValue();\n+\n+         if ((op == TR::iRegStore || op == TR::istore) && afterTT->getNode()->getFirstChild() == node)\n+            {\n+            if (trace)\n+               {\n+               traceMsg(comp, \"Moving treetop containing node n%dn [%p] associated with acmp helper call to end of prevBlock in preparation of final block split\\n\", afterTT->getNode()->getGlobalIndex(), afterTT->getNode());", "originalCommit": "bd3aac0b531b17e22787e8f8cf484522859c8f3f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA4NDEzMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/11254#discussion_r530084132", "bodyText": "This is used as iterator mainly to walk through treetops. How about using iterTT?", "author": "r30shah", "createdAt": "2020-11-25T03:26:41Z", "path": "runtime/compiler/codegen/J9CodeGenerator.cpp", "diffHunk": "@@ -251,6 +251,48 @@ J9::CodeGenerator::fastpathAcmpHelper(TR::Node *node, TR::TreeTop *tt, const boo\n    // next treetop and then at the current one\n    TR::Block* prevBlock = tt->getEnclosingBlock();\n    TR::Block* targetBlock = prevBlock->splitPostGRA(tt->getNextTreeTop(), cfg, true, NULL);\n+\n+   // Move call tree to end of block, along with any stores of the result of the call, if they're\n+   // not already at the end.  The call has to be split into its own block, but splitPostGRA above\n+   // might have left register stores and stores into temporaries that must stay with the previous block\n+   TR::TreeTop* prevBlockExit = prevBlock->getExit();\n+   TR::TreeTop* afterTT = tt->getNextTreeTop();", "originalCommit": "bd3aac0b531b17e22787e8f8cf484522859c8f3f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA4NDQ2NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/11254#discussion_r530084464", "bodyText": "This  is the last real tree-top in the later created callBlock , may be we can rename this to reflect that.", "author": "r30shah", "createdAt": "2020-11-25T03:27:57Z", "path": "runtime/compiler/codegen/J9CodeGenerator.cpp", "diffHunk": "@@ -251,6 +251,48 @@ J9::CodeGenerator::fastpathAcmpHelper(TR::Node *node, TR::TreeTop *tt, const boo\n    // next treetop and then at the current one\n    TR::Block* prevBlock = tt->getEnclosingBlock();\n    TR::Block* targetBlock = prevBlock->splitPostGRA(tt->getNextTreeTop(), cfg, true, NULL);\n+\n+   // Move call tree to end of block, along with any stores of the result of the call, if they're\n+   // not already at the end.  The call has to be split into its own block, but splitPostGRA above\n+   // might have left register stores and stores into temporaries that must stay with the previous block\n+   TR::TreeTop* prevBlockExit = prevBlock->getExit();\n+   TR::TreeTop* afterTT = tt->getNextTreeTop();\n+\n+   if (afterTT != prevBlockExit)\n+      {\n+      if (trace)\n+         {\n+         traceMsg(comp, \"Moving treetop containing node n%dn [%p] associated with acmp helper call to end of prevBlock in preparation of final block split\\n\", tt->getNode()->getGlobalIndex(), tt->getNode());\n+         }\n+\n+      // Remove TreeTop for call node\n+      tt->unlink(false);\n+      TR::TreeTop* callTreesTail = tt;", "originalCommit": "bd3aac0b531b17e22787e8f8cf484522859c8f3f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ed8362321085059d28e7d7e0d1ee86d14f1e6362", "url": "https://github.com/eclipse-openj9/openj9/commit/ed8362321085059d28e7d7e0d1ee86d14f1e6362", "message": "Keep splitPostGRA stores in right block for acmp fast path\n\nWhen splitPostGRA splits a block, it might insert register stores and\nstores to temporaries at the end of the original block at the split\npoint.  When splitPostGRA is called for fastpathAcmpHelper, the original\nblock contains the acmp helper call that will still need to be moved\ninto a separate \"call\" block, while any register stores or temporary\nstores that do not involve the call to acmp helper will need to remain\nin the original block.  Move any treetops, register stores or stores\nfor the call to the acmp helper to the end of the original block so that\nthe trees associated with the call can be split into the new \"call\"\nblock without pulling any unrelated stores and register stores into the\nnew block.\n\nAlso, register dependencies that splitPostGRA adds to the end of the\n\"call\" block should always be copied to the ifacmpeq node that's\nadded to the end of the original block as that represents an edge to the\nsame \"target\" block.\n\nSigned-off-by:  Henry Zongaro <zongaro@ca.ibm.com>", "committedDate": "2020-11-26T16:07:49Z", "type": "commit"}, {"oid": "ed8362321085059d28e7d7e0d1ee86d14f1e6362", "url": "https://github.com/eclipse-openj9/openj9/commit/ed8362321085059d28e7d7e0d1ee86d14f1e6362", "message": "Keep splitPostGRA stores in right block for acmp fast path\n\nWhen splitPostGRA splits a block, it might insert register stores and\nstores to temporaries at the end of the original block at the split\npoint.  When splitPostGRA is called for fastpathAcmpHelper, the original\nblock contains the acmp helper call that will still need to be moved\ninto a separate \"call\" block, while any register stores or temporary\nstores that do not involve the call to acmp helper will need to remain\nin the original block.  Move any treetops, register stores or stores\nfor the call to the acmp helper to the end of the original block so that\nthe trees associated with the call can be split into the new \"call\"\nblock without pulling any unrelated stores and register stores into the\nnew block.\n\nAlso, register dependencies that splitPostGRA adds to the end of the\n\"call\" block should always be copied to the ifacmpeq node that's\nadded to the end of the original block as that represents an edge to the\nsame \"target\" block.\n\nSigned-off-by:  Henry Zongaro <zongaro@ca.ibm.com>", "committedDate": "2020-11-26T16:07:49Z", "type": "forcePushed"}]}