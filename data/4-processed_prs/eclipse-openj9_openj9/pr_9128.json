{"pr_number": 9128, "pr_title": "Special handling of checkcast to value type class", "pr_createdAt": "2020-04-05T18:12:56Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/9128", "timeline": [{"oid": "1299260b2b9dc05786c6b898500524bf276fb185", "url": "https://github.com/eclipse-openj9/openj9/commit/1299260b2b9dc05786c6b898500524bf276fb185", "message": "Special handling of checkcast to value type class\n\nCheckcast of null to value type class needs to throw\nNullPointerException.\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>", "committedDate": "2020-05-22T13:30:55Z", "type": "forcePushed"}, {"oid": "54c0d6a00a887be60e3e25c397f92a696ae6e74b", "url": "https://github.com/eclipse-openj9/openj9/commit/54c0d6a00a887be60e3e25c397f92a696ae6e74b", "message": "Special handling of checkcast to value type class\n\nCheckcast of null to value type class needs to throw\nNullPointerException.\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>", "committedDate": "2020-05-22T14:14:17Z", "type": "forcePushed"}, {"oid": "be25d5e30e4eef1cb0d691c3d9db6b52b6886275", "url": "https://github.com/eclipse-openj9/openj9/commit/be25d5e30e4eef1cb0d691c3d9db6b52b6886275", "message": "Special handling of checkcast to value type class\n\nCheckcast of null to value type class needs to throw\nNullPointerException.\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>", "committedDate": "2020-05-22T15:03:27Z", "type": "forcePushed"}, {"oid": "ab11e38b07fed3bbd5df235a44cc23fd6712e695", "url": "https://github.com/eclipse-openj9/openj9/commit/ab11e38b07fed3bbd5df235a44cc23fd6712e695", "message": "Special handling of checkcast to value type class\n\nCheckcast of null to value type class needs to throw\nNullPointerException.\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>", "committedDate": "2020-05-22T16:11:22Z", "type": "forcePushed"}, {"oid": "707067e564b5502088eaa7c60c48edfb700361ed", "url": "https://github.com/eclipse-openj9/openj9/commit/707067e564b5502088eaa7c60c48edfb700361ed", "message": "Special handling of checkcast to value type class\n\nCheckcast of null to value type class needs to throw\nNullPointerException.\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>", "committedDate": "2020-05-22T16:13:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM2NzIxMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9128#discussion_r429367213", "bodyText": "Given value types exist at the OMR level should we contribute the API to OMR and always return false in their implementation for the time being?", "author": "andrewcraik", "createdAt": "2020-05-22T17:22:26Z", "path": "runtime/compiler/env/J9ClassEnv.hpp", "diffHunk": "@@ -124,16 +124,31 @@ class OMR_EXTENSIBLE ClassEnv : public OMR::ClassEnvConnector\n    bool isString(TR::Compilation *comp, uintptr_t objectPointer);\n    bool jitStaticsAreSame(TR::Compilation *comp, TR_ResolvedMethod * method1, int32_t cpIndex1, TR_ResolvedMethod * method2, int32_t cpIndex2);\n    bool jitFieldsAreSame(TR::Compilation *comp, TR_ResolvedMethod * method1, int32_t cpIndex1, TR_ResolvedMethod * method2, int32_t cpIndex2, int32_t isStatic);\n+   /*\n+    * \\brief\n+    *    Tells whether a class reference entry in the constant pool represents a value type class.\n+    *\n+    * \\param cpContextClass\n+    *    The class whose constant pool contains the class reference entry being looked at. In another words,\n+    *    it's the class of the method referring to the class reference entry.\n+    *\n+    * \\param cpIndex\n+    *    The constant pool index of the class reference entry.\n+    *\n+    * \\note\n+    *    The class reference entry doesn't need to be resolved because the information is encoded in class name string\n+    */\n+   bool isClassRefValueType(TR_OpaqueClassBlock *cpContextClass, int32_t cpIndex, TR::Compilation * comp);", "originalCommit": "707067e564b5502088eaa7c60c48edfb700361ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQzNDk1Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/9128#discussion_r429434952", "bodyText": "I think this query is specific to constant pool entry which only exists in openj9.", "author": "cathyzhyi", "createdAt": "2020-05-22T20:12:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM2NzIxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM2ODA4Nw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9128#discussion_r429368087", "bodyText": "it seems wweird to say the the symbolReference isUnresovled and then as a question about it. A comment to explain this is probably warranted...", "author": "andrewcraik", "createdAt": "2020-05-22T17:24:24Z", "path": "runtime/compiler/ilgen/IlGenerator.cpp", "diffHunk": "@@ -564,7 +564,8 @@ TR_J9ByteCodeIlGenerator::genILFromByteCodes()\n \n       if (currNode->getOpCodeValue() == TR::checkcast\n           && currNode->getSecondChild()->getOpCodeValue() == TR::loadaddr\n-          && currNode->getSecondChild()->getSymbolReference()->isUnresolved())\n+          && currNode->getSecondChild()->getSymbolReference()->isUnresolved()\n+          && !TR::Compiler->cls.isClassRefValueType(method()->classOfMethod(), currNode->getSecondChild()->getSymbolReference()->getCPIndex(), comp()))", "originalCommit": "707067e564b5502088eaa7c60c48edfb700361ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ1NzI0OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9128#discussion_r429457249", "bodyText": "Added comments as suggested.", "author": "cathyzhyi", "createdAt": "2020-05-22T21:27:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM2ODA4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk3MjIzMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9128#discussion_r429972230", "bodyText": "Yi @cathyzhyi, I was looking at your adjusted comment.  Just so I'm clear on this, the class specified on CHECKCAST is required to be resolved only if the object is non-null and the class is not a value type.  If the class is a value type, it will never be resolved by the CHECKCAST.  Right?", "author": "hzongaro", "createdAt": "2020-05-25T14:46:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM2ODA4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA1MzU0NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9128#discussion_r430053545", "bodyText": "Hey Henry, @hzongaro the class reference can still be resolved by CHECKCAST if the object is not-null and is value type. The value type class is excluded from expansion because the resolve check is already inserted when calling loadClassObject. The expansion for unresolved case is needed for reference type because we want to avoid resolving the class when the object is null so can't just insert the resolve check in the mainline path for all cases as we do for value type.", "author": "cathyzhyi", "createdAt": "2020-05-25T19:23:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM2ODA4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA3NjIwNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9128#discussion_r430076207", "bodyText": "Thanks, Yi @cathyzhyi!  Now I see.\nI've followed through the logic more carefully now, and I'm wondering whether the name of unresolvedCheckcastTops should be changed to make it clear that not all the unresolved CHECKCASTs are included - only the ones that need to be expanded.  Maybe something like unexpandedUnresolvedCheckcastTops?  Or unresolvedCheckcastTopsNeedingNullGuard?  (I know those are kind of long names - I'm really good at names that are way too long.  :-)", "author": "hzongaro", "createdAt": "2020-05-25T21:15:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM2ODA4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE3ODM2MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9128#discussion_r431178360", "bodyText": "Thanks for the suggestion! Changed the variable name to unresolvedCheckcastTopsNeedingNullGuard", "author": "cathyzhyi", "createdAt": "2020-05-27T14:30:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM2ODA4Nw=="}], "type": "inlineReview"}, {"oid": "a584fb97300db9d687fccf21131938f7c6e6c48f", "url": "https://github.com/eclipse-openj9/openj9/commit/a584fb97300db9d687fccf21131938f7c6e6c48f", "message": "Special handling of checkcast to value type class\n\nCheckcast of null to value type class needs to throw\nNullPointerException.\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>", "committedDate": "2020-05-22T21:26:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk2NjMyNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9128#discussion_r429966324", "bodyText": "This is a bit of a nit, but nearly all the methods in this file that accept a pointer to a TR::Compilation have that in the first argument position.  It feels a little odd seeing it in the last position here, though I see enumerateFields is the same that way.", "author": "hzongaro", "createdAt": "2020-05-25T14:33:12Z", "path": "runtime/compiler/env/J9ClassEnv.hpp", "diffHunk": "@@ -124,16 +124,31 @@ class OMR_EXTENSIBLE ClassEnv : public OMR::ClassEnvConnector\n    bool isString(TR::Compilation *comp, uintptr_t objectPointer);\n    bool jitStaticsAreSame(TR::Compilation *comp, TR_ResolvedMethod * method1, int32_t cpIndex1, TR_ResolvedMethod * method2, int32_t cpIndex2);\n    bool jitFieldsAreSame(TR::Compilation *comp, TR_ResolvedMethod * method1, int32_t cpIndex1, TR_ResolvedMethod * method2, int32_t cpIndex2, int32_t isStatic);\n+   /*\n+    * \\brief\n+    *    Tells whether a class reference entry in the constant pool represents a value type class.\n+    *\n+    * \\param cpContextClass\n+    *    The class whose constant pool contains the class reference entry being looked at. In another words,\n+    *    it's the class of the method referring to the class reference entry.\n+    *\n+    * \\param cpIndex\n+    *    The constant pool index of the class reference entry.\n+    *\n+    * \\note\n+    *    The class reference entry doesn't need to be resolved because the information is encoded in class name string\n+    */\n+   bool isClassRefValueType(TR_OpaqueClassBlock *cpContextClass, int32_t cpIndex, TR::Compilation * comp);", "originalCommit": "a584fb97300db9d687fccf21131938f7c6e6c48f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA1MTU4Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/9128#discussion_r430051586", "bodyText": "thanks for pointing that out! Changed the TR::Compilation parm to be the first one.", "author": "cathyzhyi", "createdAt": "2020-05-25T19:13:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk2NjMyNA=="}], "type": "inlineReview"}, {"oid": "1ad95e48546e57627f6ee55bf8a5daaa9153078f", "url": "https://github.com/eclipse-openj9/openj9/commit/1ad95e48546e57627f6ee55bf8a5daaa9153078f", "message": "Special handling of checkcast to value type class\n\nCheckcast of null to value type class needs to throw\nNullPointerException.\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>", "committedDate": "2020-05-25T19:11:59Z", "type": "forcePushed"}, {"oid": "749f2eec4e1a7d4c5e11da48e6c418f25faa12b9", "url": "https://github.com/eclipse-openj9/openj9/commit/749f2eec4e1a7d4c5e11da48e6c418f25faa12b9", "message": "Special handling of checkcast to value type class\n\nCheckcast of null to value type class needs to throw\nNullPointerException.\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>", "committedDate": "2020-05-27T14:28:23Z", "type": "commit"}, {"oid": "749f2eec4e1a7d4c5e11da48e6c418f25faa12b9", "url": "https://github.com/eclipse-openj9/openj9/commit/749f2eec4e1a7d4c5e11da48e6c418f25faa12b9", "message": "Special handling of checkcast to value type class\n\nCheckcast of null to value type class needs to throw\nNullPointerException.\n\nSigned-off-by: Yi Zhang <yizhang@ca.ibm.com>", "committedDate": "2020-05-27T14:28:23Z", "type": "forcePushed"}]}