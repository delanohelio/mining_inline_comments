{"pr_number": 10943, "pr_title": "Fix the Chinese modules path issue in JVM initialization", "pr_createdAt": "2020-10-20T19:46:19Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/10943", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgzMDE2MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10943#discussion_r508830160", "bodyText": "The version check isn't needed here, this function is only called for Java 11+.", "author": "pshipton", "createdAt": "2020-10-20T20:49:47Z", "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -1448,6 +1431,81 @@ initializeClassPathEntry (J9JavaVM * javaVM, J9ClassPathEntry *cpEntry)\n \tcpEntry->extraInfo = NULL;\n \treturn CPE_TYPE_UNUSABLE;\n }\n+\n+IDATA\n+initializeModulesPathEntry(J9JavaVM * javaVM, J9ClassPathEntry *cpEntry)\n+{\n+\tPORT_ACCESS_FROM_JAVAVM(javaVM);\n+\tint32_t attr = 0;\n+#if defined(WIN32)\n+\tchar *convertedModulesPath = NULL;\n+\tIDATA convertedModulesPathLen = 0;\n+#endif /* defined(WIN32) */\n+\n+\t/* Start guessing. Is it a directory? */\n+\tattr = j9file_attr((char *)cpEntry->path);\n+\tif (EsIsDir == attr) {\n+\t\tcpEntry->type = CPE_TYPE_DIRECTORY;\n+\t\treturn CPE_TYPE_DIRECTORY;\n+\t}\n+\n+\tif ((EsIsFile == attr) && (J2SE_VERSION(javaVM) >= J2SE_V11)) {", "originalCommit": "4464ced0af3700acc7c63da90324feb39703b24c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg1NjAzNQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10943#discussion_r508856035", "bodyText": "Agreed and removed the check on java version as suggested.", "author": "ChengJin01", "createdAt": "2020-10-20T21:38:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgzMDE2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgzMTgxMQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/10943#discussion_r508831811", "bodyText": "This should be defined in the inner most scope.", "author": "pshipton", "createdAt": "2020-10-20T20:52:33Z", "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -1448,6 +1431,81 @@ initializeClassPathEntry (J9JavaVM * javaVM, J9ClassPathEntry *cpEntry)\n \tcpEntry->extraInfo = NULL;\n \treturn CPE_TYPE_UNUSABLE;\n }\n+\n+IDATA\n+initializeModulesPathEntry(J9JavaVM * javaVM, J9ClassPathEntry *cpEntry)\n+{\n+\tPORT_ACCESS_FROM_JAVAVM(javaVM);\n+\tint32_t attr = 0;\n+#if defined(WIN32)\n+\tchar *convertedModulesPath = NULL;\n+\tIDATA convertedModulesPathLen = 0;", "originalCommit": "4464ced0af3700acc7c63da90324feb39703b24c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg1NjEyNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10943#discussion_r508856124", "bodyText": "Fixed.", "author": "ChengJin01", "createdAt": "2020-10-20T21:38:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgzMTgxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgzMjkwOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10943#discussion_r508832908", "bodyText": "This isn't needed, j9str_convert() populates the buffer.", "author": "pshipton", "createdAt": "2020-10-20T20:54:38Z", "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -1448,6 +1431,81 @@ initializeClassPathEntry (J9JavaVM * javaVM, J9ClassPathEntry *cpEntry)\n \tcpEntry->extraInfo = NULL;\n \treturn CPE_TYPE_UNUSABLE;\n }\n+\n+IDATA\n+initializeModulesPathEntry(J9JavaVM * javaVM, J9ClassPathEntry *cpEntry)\n+{\n+\tPORT_ACCESS_FROM_JAVAVM(javaVM);\n+\tint32_t attr = 0;\n+#if defined(WIN32)\n+\tchar *convertedModulesPath = NULL;\n+\tIDATA convertedModulesPathLen = 0;\n+#endif /* defined(WIN32) */\n+\n+\t/* Start guessing. Is it a directory? */\n+\tattr = j9file_attr((char *)cpEntry->path);\n+\tif (EsIsDir == attr) {\n+\t\tcpEntry->type = CPE_TYPE_DIRECTORY;\n+\t\treturn CPE_TYPE_DIRECTORY;\n+\t}\n+\n+\tif ((EsIsFile == attr) && (J2SE_VERSION(javaVM) >= J2SE_V11)) {\n+\t\tJ9JImageIntf *jimageIntf = javaVM->jimageIntf;\n+\t\tif (NULL != jimageIntf) {\n+\t\t\tI_32 rc = 0;\n+\t\t\tUDATA jimageHandle = 0;\n+\t\t\tchar *modulesPath = (char *)cpEntry->path;\n+#if defined(WIN32)\n+\t\t\tIDATA modulesPathLen = cpEntry->pathLength;\n+\t\t\tconvertedModulesPathLen = j9str_convert(J9STR_CODE_MUTF8, J9STR_CODE_WINDEFAULTACP, modulesPath, modulesPathLen, NULL, 0);\n+\t\t\tif (convertedModulesPathLen > 0) {\n+\t\t\t\tconvertedModulesPath = j9mem_allocate_memory(convertedModulesPathLen + 1, OMRMEM_CATEGORY_VM);\n+\t\t\t\tif (convertedModulesPath != NULL) {\n+\t\t\t\t\tmemset(convertedModulesPath, 0, convertedModulesPathLen + 1);", "originalCommit": "4464ced0af3700acc7c63da90324feb39703b24c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg1NjI5MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10943#discussion_r508856290", "bodyText": "Agreed and removed memset() as suggested.", "author": "ChengJin01", "createdAt": "2020-10-20T21:39:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgzMjkwOA=="}], "type": "inlineReview"}, {"oid": "f940df03505c948030a723c17cc2956003968808", "url": "https://github.com/eclipse-openj9/openj9/commit/f940df03505c948030a723c17cc2956003968808", "message": "Fix the Chinese modules path issue in JVM initialization\n\nThe change is to convert the module path from UTF8 to\nthe platform encode setting on Windows to ensure it works\ncorrectly to open the jimage file.\n\nFixes: #10312\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-10-20T21:37:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODkyNDQ1OA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10943#discussion_r508924458", "bodyText": "Maybe this needs to be pathLength + 1 to include the terminating NULL, now that the memset has been removed.", "author": "pshipton", "createdAt": "2020-10-21T00:47:53Z", "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -1448,6 +1431,79 @@ initializeClassPathEntry (J9JavaVM * javaVM, J9ClassPathEntry *cpEntry)\n \tcpEntry->extraInfo = NULL;\n \treturn CPE_TYPE_UNUSABLE;\n }\n+\n+IDATA\n+initializeModulesPathEntry(J9JavaVM * javaVM, J9ClassPathEntry *cpEntry)\n+{\n+\tPORT_ACCESS_FROM_JAVAVM(javaVM);\n+\tint32_t attr = 0;\n+#if defined(WIN32)\n+\tchar *convertedModulesPath = NULL;\n+#endif /* defined(WIN32) */\n+\n+\t/* Start guessing. Is it a directory? */\n+\tattr = j9file_attr((char *)cpEntry->path);\n+\tif (EsIsDir == attr) {\n+\t\tcpEntry->type = CPE_TYPE_DIRECTORY;\n+\t\treturn CPE_TYPE_DIRECTORY;\n+\t}\n+\n+\tif (EsIsFile == attr) {\n+\t\tJ9JImageIntf *jimageIntf = javaVM->jimageIntf;\n+\t\tif (NULL != jimageIntf) {\n+\t\t\tI_32 rc = 0;\n+\t\t\tUDATA jimageHandle = 0;\n+\t\t\tchar *modulesPath = (char *)cpEntry->path;\n+#if defined(WIN32)\n+\t\t\tIDATA modulesPathLen = cpEntry->pathLength;", "originalCommit": "f940df03505c948030a723c17cc2956003968808", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODkyOTgyNg==", "url": "https://github.com/eclipse-openj9/openj9/pull/10943#discussion_r508929826", "bodyText": "Discussed with Cheng. He's going to explicitly null terminate convertedModulesPath, because adding 1 here assumes the input is null terminated and we can't assume that.", "author": "pshipton", "createdAt": "2020-10-21T01:08:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODkyNDQ1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODkyOTg5MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/10943#discussion_r508929890", "bodyText": "As discussed with Pete offline, I will double-check the updated code by compiling a build locally to see whether it works.\nif (convertedModulesPath != NULL) {\n\t convertedModulesPathLen = j9str_convert(J9STR_CODE_MUTF8, J9STR_CODE_WINDEFAULTACP, modulesPath, modulesPathLen, convertedModulesPath, convertedModulesPathLen);\n\t if (convertedModulesPathLen > 0) {\n\t convertedModulesPath[convertedModulesPathLen] = '\\0'; <------ set up the NULL at the end\n        modulesPath = convertedModulesPath;", "author": "ChengJin01", "createdAt": "2020-10-21T01:08:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODkyNDQ1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODk4MDEyNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/10943#discussion_r508980127", "bodyText": "Just verified the locally generated build with the code above which works good:\nC:\\JCHAU\\\u6d4b\u8bd5java>jdk11_openj9_win_fix_v5\\bin\\java   -version\nopenjdk version \"11.0.9-internal\" 2020-10-20\nOpenJDK Runtime Environment (build 11.0.9-internal+0-adhoc.Administrator.openj9-openjdk-jdk11master10082020)\nEclipse OpenJ9 VM (build vm_VMInitStages_init_class_path-5b7b7a29d, JRE 11 Windows 10 amd64-64-Bit Compressed References 20201020_000000 (JIT enabled, AOT enabled)\nOpenJ9   - 5b7b7a29d\nOMR      - b0a570300\nJCL      - cf49ddabb9 based on jdk-11.0.9+10)", "author": "ChengJin01", "createdAt": "2020-10-21T04:19:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODkyNDQ1OA=="}], "type": "inlineReview"}, {"oid": "f626b308ebe728cd5f722d0f8bbb78ab9e106040", "url": "https://github.com/eclipse-openj9/openj9/commit/f626b308ebe728cd5f722d0f8bbb78ab9e106040", "message": "Fix the Chinese modules path issue in JVM initialization\n\nThe change is to convert the module path from UTF8 to\nthe platform encode setting on Windows to ensure it works\ncorrectly to open the jimage file.\n\nFixes: #10312\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-10-21T04:23:08Z", "type": "commit"}, {"oid": "f626b308ebe728cd5f722d0f8bbb78ab9e106040", "url": "https://github.com/eclipse-openj9/openj9/commit/f626b308ebe728cd5f722d0f8bbb78ab9e106040", "message": "Fix the Chinese modules path issue in JVM initialization\n\nThe change is to convert the module path from UTF8 to\nthe platform encode setting on Windows to ensure it works\ncorrectly to open the jimage file.\n\nFixes: #10312\n\nSigned-off-by: Cheng Jin <jincheng@ca.ibm.com>", "committedDate": "2020-10-21T04:23:08Z", "type": "forcePushed"}]}