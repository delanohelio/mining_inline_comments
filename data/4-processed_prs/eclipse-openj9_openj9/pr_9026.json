{"pr_number": 9026, "pr_title": "Runtime compressed refs work", "pr_createdAt": "2020-03-30T16:35:23Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/9026", "timeline": [{"oid": "a8db4dc70a83933d964845e5b3725e72ed4834c3", "url": "https://github.com/eclipse-openj9/openj9/commit/a8db4dc70a83933d964845e5b3725e72ed4834c3", "message": "Runtime compressed refs work\n\nUpdate RAS code to properly handle mixed mode.\n\nThe issue was that AIX non-compressed was not copying the RAS structure\nto virtual memory, resulting in DDR taking forever (i.e. longer than the\ntest timeout) to find the RAS structure.\n\n[ci skip]\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>", "committedDate": "2020-03-30T16:55:20Z", "type": "forcePushed"}, {"oid": "a8b93a8358e09ba88cab2689ce47c2edeb3b40d0", "url": "https://github.com/eclipse-openj9/openj9/commit/a8b93a8358e09ba88cab2689ce47c2edeb3b40d0", "message": "Runtime compressed refs work\n\nUpdate RAS code to properly handle mixed mode.\n\nThe issue was that AIX non-compressed was not copying the RAS structure\nto virtual memory, resulting in DDR taking forever (i.e. longer than the\ntest timeout) to find the RAS structure.\n\nAlso fix some compile errors on windows (assuming fj9object_t == U_32\nwhen the compressed compile flag is on).\n\n[ci skip]\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>", "committedDate": "2020-03-30T19:19:05Z", "type": "forcePushed"}, {"oid": "72dc1d301d419545a99991cf809f591db4311f93", "url": "https://github.com/eclipse-openj9/openj9/commit/72dc1d301d419545a99991cf809f591db4311f93", "message": "Runtime compressed refs work\n\nUpdate RAS code to properly handle mixed mode.\n\nThe issue was that AIX non-compressed was not copying the RAS structure\nto virtual memory, resulting in DDR taking forever (i.e. longer than the\ntest timeout) to find the RAS structure.\n\nAlso fix some compile errors on windows (assuming fj9object_t == U_32\nwhen the compressed compile flag is on).\n\n[ci skip]\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>", "committedDate": "2020-03-30T19:54:26Z", "type": "forcePushed"}, {"oid": "ba8337248c6ccb1b28aec000fa2c6194d8f0ba40", "url": "https://github.com/eclipse-openj9/openj9/commit/ba8337248c6ccb1b28aec000fa2c6194d8f0ba40", "message": "Runtime compressed refs work\n\nUpdate RAS code to properly handle mixed mode.\n\nThe issue was that AIX non-compressed was not copying the RAS structure\nto virtual memory, resulting in DDR taking forever (i.e. longer than the\ntest timeout) to find the RAS structure.\n\nAlso fix some compile errors on windows (assuming fj9object_t == U_32\nwhen the compressed compile flag is on).\n\n[ci skip]\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>", "committedDate": "2020-03-30T22:31:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTExMTEwMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9026#discussion_r401111100", "bodyText": "Would it be better to change the definition of referenceSize to be a U_32?", "author": "DanHeidinga", "createdAt": "2020-03-31T18:05:12Z", "path": "runtime/vm/resolvefield.cpp", "diffHunk": "@@ -675,7 +675,7 @@ fieldOffsetsStartDo(J9JavaVM *vm, J9ROMClass *romClass, J9Class *superClazz, J9R\n \t\t */\n \t\tif ((LOCKWORD_NEEDED == lockwordNeeded)||(NO_LOCKWORD_NEEDED == lockwordNeeded)) {\n \t\t\tif ((NULL != superClazz) && ((UDATA)-1 != superClazz->lockOffset) && (0 == J9CLASS_DEPTH(superClazz))) {\n-\t\t\t\tU_32 newSuperSize = fieldInfo.getSuperclassFieldsSize() - referenceSize;\n+\t\t\t\tU_32 newSuperSize = fieldInfo.getSuperclassFieldsSize() - (U_32)referenceSize;", "originalCommit": "ba8337248c6ccb1b28aec000fa2c6194d8f0ba40", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEzODM1OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9026#discussion_r401138359", "bodyText": "It could probably be done, but this was the minimal change. It's used in a bunch of other places.", "author": "gacholio", "createdAt": "2020-03-31T18:50:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTExMTEwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEzOTcxOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9026#discussion_r401139719", "bodyText": "If you request the change below, I'll try this one as well. It should be safe when mixed with UDATA math.", "author": "gacholio", "createdAt": "2020-03-31T18:52:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTExMTEwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEyMTA5MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9026#discussion_r401121091", "bodyText": "Can this move this late?  Its being moved after the if (JNI_OK != configureRasDump(vm)) { call....", "author": "DanHeidinga", "createdAt": "2020-03-31T18:22:20Z", "path": "runtime/vm/jvminit.c", "diffHunk": "@@ -6096,6 +6088,12 @@ protectedInitializeJavaVM(J9PortLibrary* portLibrary, void * userData)\n \t}\n \n \t/* Must be done after the compressed/full determination has been made */\n+#ifdef J9VM_RAS_EYECATCHERS\n+\tJ9RASInitialize(vm);", "originalCommit": "ba8337248c6ccb1b28aec000fa2c6194d8f0ba40", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEzMTMyNA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9026#discussion_r401131324", "bodyText": "This seems like it would make early crashes harder to debug.", "author": "DanHeidinga", "createdAt": "2020-03-31T18:38:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEyMTA5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEzNzYyNw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9026#discussion_r401137627", "bodyText": "I think I understand the problem now - the major concern is whether other code will be trying to modify the vm->j9ras struct before this happens.", "author": "DanHeidinga", "createdAt": "2020-03-31T18:49:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEyMTA5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEzOTI1MA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9026#discussion_r401139250", "bodyText": "Simply put, the VM does not crash that early in the real world, so I'm not concerned about that - all platforms sanity passes with these changes.\nIt might be better to move the parsing up (rather than the rest of it down), but I think that had problems the last time I tried. If you want, I'll try it again.", "author": "gacholio", "createdAt": "2020-03-31T18:51:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEyMTA5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE0NDk2OQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9026#discussion_r401144969", "bodyText": "The final decision will depend on heap sizes as well so I don't now that moving the parsing up will help unless that includes the GC's parsing as well.\nI'm willing to accept this as is as I don't have a better suggestion", "author": "DanHeidinga", "createdAt": "2020-03-31T19:01:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEyMTA5MQ=="}], "type": "inlineReview"}, {"oid": "5e4701ef7a2b9d969c0b1eadfd41f020f485abbe", "url": "https://github.com/eclipse-openj9/openj9/commit/5e4701ef7a2b9d969c0b1eadfd41f020f485abbe", "message": "Runtime compressed refs work\n\nUpdate RAS code to properly handle mixed mode.\n\nThe issue was that AIX non-compressed was not copying the RAS structure\nto virtual memory, resulting in DDR taking forever (i.e. longer than the\ntest timeout) to find the RAS structure.\n\nAlso fix some compile errors on windows (assuming fj9object_t == U_32\nwhen the compressed compile flag is on).\n\n[ci skip]\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>", "committedDate": "2020-03-31T20:08:48Z", "type": "commit"}, {"oid": "5e4701ef7a2b9d969c0b1eadfd41f020f485abbe", "url": "https://github.com/eclipse-openj9/openj9/commit/5e4701ef7a2b9d969c0b1eadfd41f020f485abbe", "message": "Runtime compressed refs work\n\nUpdate RAS code to properly handle mixed mode.\n\nThe issue was that AIX non-compressed was not copying the RAS structure\nto virtual memory, resulting in DDR taking forever (i.e. longer than the\ntest timeout) to find the RAS structure.\n\nAlso fix some compile errors on windows (assuming fj9object_t == U_32\nwhen the compressed compile flag is on).\n\n[ci skip]\n\nSigned-off-by: Graham Chapman <graham_chapman@ca.ibm.com>", "committedDate": "2020-03-31T20:08:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU5MzM3NA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9026#discussion_r402593374", "bodyText": "I think this condition should be:\n\tif (!ALLOCATE_RAS_DATA_IN_SUBALLOCATOR && !J9JAVAVM_COMPRESS_OBJECT_REFERENCES(javaVM)) {\n\nI'll open a PR to fix this shortly.", "author": "keithc-ca", "createdAt": "2020-04-02T20:43:29Z", "path": "runtime/vm/rasdump.c", "diffHunk": "@@ -443,8 +445,8 @@ allocateRASStruct(J9JavaVM *javaVM)\n \t *\n \t * Compressed references: the RAS data is relocated to the JVM suballocator once the latter is created.\n \t */\n-#if !defined(USE_STATIC_RAS_STRUCT) && !defined(ALLOCATE_RAS_DATA_IN_SUBALLOCATOR)\n-\tif (!J9JAVAVM_COMPRESS_OBJECT_REFERENCES(javaVM)) {\n+#if !defined(USE_STATIC_RAS_STRUCT)\n+\tif (!(ALLOCATE_RAS_DATA_IN_SUBALLOCATOR && J9JAVAVM_COMPRESS_OBJECT_REFERENCES(javaVM))) {", "originalCommit": "5e4701ef7a2b9d969c0b1eadfd41f020f485abbe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4OTUwOQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9026#discussion_r402689509", "bodyText": "This is not correct - the original ifdef was the two platforms and compressed. The original code above was !ALLOCATE_IN_SUBALLOC, so the code above is correct (don't forget that this is not the first code change - look back before I made the previous mistake and you'll see what I mean).", "author": "gacholio", "createdAt": "2020-04-03T01:37:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU5MzM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzAyNTczMw==", "url": "https://github.com/eclipse-openj9/openj9/pull/9026#discussion_r403025733", "bodyText": "Yes, ALLOCATE_RAS_DATA_IN_SUBALLOCATOR replaces the first two terms of\n!defined(J9ZOS390) && !defined(J9ZTPF) && defined(OMR_GC_COMPRESSED_POINTERS)\n\nso code that tested defined(ALLOCATE_RAS_DATA_IN_SUBALLOCATOR) must instead test\nALLOCATE_RAS_DATA_IN_SUBALLOCATOR && J9JAVAVM_COMPRESS_OBJECT_REFERENCES(javaVM)\n\nso !defined(ALLOCATE_RAS_DATA_IN_SUBALLOCATOR) must become\n!(ALLOCATE_RAS_DATA_IN_SUBALLOCATOR && J9JAVAVM_COMPRESS_OBJECT_REFERENCES(javaVM))\n\nSorry for the interruption.", "author": "keithc-ca", "createdAt": "2020-04-03T13:59:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU5MzM3NA=="}], "type": "inlineReview"}]}