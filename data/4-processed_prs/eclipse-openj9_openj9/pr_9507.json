{"pr_number": 9507, "pr_title": "Java 14+: class transformation with records", "pr_createdAt": "2020-05-09T02:18:35Z", "pr_url": "https://github.com/eclipse-openj9/openj9/pull/9507", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ0MzU2Ng==", "url": "https://github.com/eclipse-openj9/openj9/pull/9507#discussion_r422443566", "bodyText": "Missing #endif comment here and the next one.", "author": "pshipton", "createdAt": "2020-05-09T02:34:03Z", "path": "runtime/util/hshelp.c", "diffHunk": "@@ -3171,6 +3171,48 @@ verifyMethodsAreSame(J9VMThread * currentThread, J9JVMTIClassPair * classPair, U\n \n }\n \n+#if (JAVA_SPEC_VERSION >= 14)\n+static jvmtiError\n+verifyRecordAttributesAreSame(J9ROMClass *originalROMClass, J9ROMClass *replacementROMClass)\n+{\n+\tjvmtiError rc = JVMTI_ERROR_NONE;\n+\n+\t/* Since retranformation is not allowed to change inheritance there's no need to consider \n+\t * one class being a record and one not. */\n+\tif (J9ROMCLASS_IS_RECORD(originalROMClass) && J9ROMCLASS_IS_RECORD(replacementROMClass)) {\n+\t\tU_32 originalNumberOfRecords = getNumberOfRecordComponents(originalROMClass);\n+\t\tU_32 replacementNumberOfRecords = getNumberOfRecordComponents(replacementROMClass);\n+\n+\t\tif (originalNumberOfRecords == replacementNumberOfRecords) {\n+\t\t\tif (originalNumberOfRecords > 0) {\n+\t\t\t\tJ9ROMRecordComponentShape* originalRecordComponent = NULL;\n+\t\t\t\tJ9ROMRecordComponentShape* replacementRecordComponent = NULL;\n+\t\t\t\tU_32 i = 0;\n+\n+\t\t\t\toriginalRecordComponent = recordComponentStartDo(originalROMClass);\n+\t\t\t\treplacementRecordComponent = recordComponentStartDo(replacementROMClass);\n+\t\t\t\tfor (; i < originalNumberOfRecords; i++) {\n+\t\t\t\t\t/* verify name and signature */\n+\t\t\t\t\tif (!NAME_AND_SIG_IDENTICAL(originalRecordComponent, replacementRecordComponent, \n+\t\t\t\t\t\tJ9ROMRECORDCOMPONENTSHAPE_NAME, J9ROMRECORDCOMPONENTSHAPE_SIGNATURE)) \n+\t\t\t\t\t{\n+\t\t\t\t\t\trc = JVMTI_ERROR_UNSUPPORTED_REDEFINITION_CLASS_ATTRIBUTE_CHANGED;\n+\t\t\t\t\t\tgoto done;\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\n+\n+\t\t\t}\n+\t\t} else {\n+\t\t\trc = JVMTI_ERROR_UNSUPPORTED_REDEFINITION_CLASS_ATTRIBUTE_CHANGED;\n+\t\t}\n+\t}\n+\n+done:\n+\treturn rc;\n+}\n+#endif", "originalCommit": "f6147b41ef3dce1b5b129fa7a266e11dc7a40566", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "82c42f798f60f2cf1bf4b99baf356cdac3e136fd", "url": "https://github.com/eclipse-openj9/openj9/commit/82c42f798f60f2cf1bf4b99baf356cdac3e136fd", "message": "Java 14+: class transformation with records\n\nThe Java Instrumentation API does not allow record attributes to be changed.\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-05-11T16:44:29Z", "type": "forcePushed"}, {"oid": "19907b298aeb902beb69e59c86038c95aacd5cd4", "url": "https://github.com/eclipse-openj9/openj9/commit/19907b298aeb902beb69e59c86038c95aacd5cd4", "message": "Java 14+: class transformation with records\n\nThe Java Instrumentation API does not allow record attributes to be changed.\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-05-11T16:46:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzIxNjIwMQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9507#discussion_r423216201", "bodyText": "This is commented - delete don't update :)", "author": "DanHeidinga", "createdAt": "2020-05-11T17:54:16Z", "path": "runtime/include/jvmti.h.m4", "diffHunk": "@@ -341,9 +341,9 @@ typedef enum jvmtiError {\n \tJVMTI_ERROR_NAMES_DONT_MATCH = 69,\n \tJVMTI_ERROR_UNSUPPORTED_REDEFINITION_CLASS_MODIFIERS_CHANGED = 70,\n \tJVMTI_ERROR_UNSUPPORTED_REDEFINITION_METHOD_MODIFIERS_CHANGED = 71,\n-/* #if defined(J9VM_OPT_VALHALLA_NESTMATES) */\n+/* #if defined(J9VM_OPT_VALHALLA_NESTMATES) || (JAVA_SPEC_VERSION >= 14) */", "originalCommit": "19907b298aeb902beb69e59c86038c95aacd5cd4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzIxNzcyOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9507#discussion_r423217728", "bodyText": "This should be updated to match the JDK version that brought this error in.  NESTMATES should be subsumed by the JDK release that added it", "author": "DanHeidinga", "createdAt": "2020-05-11T17:56:51Z", "path": "runtime/jvmti/jvmtiGeneral.c", "diffHunk": "@@ -65,9 +65,9 @@ static const J9JvmtiErrorMapping errorMap[] = {\n \t{ \"JVMTI_ERROR_NAMES_DONT_MATCH\" , 69 },\n \t{ \"JVMTI_ERROR_UNSUPPORTED_REDEFINITION_CLASS_MODIFIERS_CHANGED\" , 70 },\n \t{ \"JVMTI_ERROR_UNSUPPORTED_REDEFINITION_METHOD_MODIFIERS_CHANGED\" , 71 },\n-#if defined(J9VM_OPT_VALHALLA_NESTMATES)\n+#if defined(J9VM_OPT_VALHALLA_NESTMATES) || (JAVA_SPEC_VERSION >= 14)", "originalCommit": "19907b298aeb902beb69e59c86038c95aacd5cd4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc5MjkxOA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9507#discussion_r423792918", "bodyText": "This assumes that record components can't be reordered.  Is there a connonical order defined in the spec?  If not, how does the RI handle this?  Does it require that the order of the components is stable?", "author": "DanHeidinga", "createdAt": "2020-05-12T14:45:41Z", "path": "runtime/util/hshelp.c", "diffHunk": "@@ -3171,6 +3171,48 @@ verifyMethodsAreSame(J9VMThread * currentThread, J9JVMTIClassPair * classPair, U\n \n }\n \n+#if (JAVA_SPEC_VERSION >= 14)\n+static jvmtiError\n+verifyRecordAttributesAreSame(J9ROMClass *originalROMClass, J9ROMClass *replacementROMClass)\n+{\n+\tjvmtiError rc = JVMTI_ERROR_NONE;\n+\n+\t/* Since retranformation is not allowed to change inheritance there's no need to consider \n+\t * one class being a record and one not. */\n+\tif (J9ROMCLASS_IS_RECORD(originalROMClass) && J9ROMCLASS_IS_RECORD(replacementROMClass)) {\n+\t\tU_32 originalNumberOfRecords = getNumberOfRecordComponents(originalROMClass);\n+\t\tU_32 replacementNumberOfRecords = getNumberOfRecordComponents(replacementROMClass);\n+\n+\t\tif (originalNumberOfRecords == replacementNumberOfRecords) {\n+\t\t\tif (originalNumberOfRecords > 0) {\n+\t\t\t\tJ9ROMRecordComponentShape* originalRecordComponent = NULL;\n+\t\t\t\tJ9ROMRecordComponentShape* replacementRecordComponent = NULL;\n+\t\t\t\tU_32 i = 0;\n+\n+\t\t\t\toriginalRecordComponent = recordComponentStartDo(originalROMClass);\n+\t\t\t\treplacementRecordComponent = recordComponentStartDo(replacementROMClass);", "originalCommit": "19907b298aeb902beb69e59c86038c95aacd5cd4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk0MzUxMg==", "url": "https://github.com/eclipse-openj9/openj9/pull/9507#discussion_r423943512", "bodyText": "The spec requires that the order of record components be the same as the order in which they are declared. Since retransformation is not allowed to change fields the record components should be expected to maintain the same order.", "author": "theresa-m", "createdAt": "2020-05-12T18:24:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc5MjkxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAwOTEzMA==", "url": "https://github.com/eclipse-openj9/openj9/pull/9507#discussion_r424009130", "bodyText": "Sorry to unresolve this.  Can you add a comment to that effect into the code?  It'll save rediscovering that in the future", "author": "DanHeidinga", "createdAt": "2020-05-12T20:20:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc5MjkxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAxODk5NQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9507#discussion_r424018995", "bodyText": "yes. good idea.", "author": "theresa-m", "createdAt": "2020-05-12T20:39:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc5MjkxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc5MzM2Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/9507#discussion_r423793362", "bodyText": "Nitpick:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\t\tif (!NAME_AND_SIG_IDENTICAL(originalRecordComponent, replacementRecordComponent, \n          \n          \n            \n            \t\t\t\t\t\tJ9ROMRECORDCOMPONENTSHAPE_NAME, J9ROMRECORDCOMPONENTSHAPE_SIGNATURE)) \n          \n          \n            \n            \t\t\t\t\t{\n          \n          \n            \n            \t\t\t\t\tif (!NAME_AND_SIG_IDENTICAL(originalRecordComponent, replacementRecordComponent, \n          \n          \n            \n            \t\t\t\t\t\tJ9ROMRECORDCOMPONENTSHAPE_NAME, J9ROMRECORDCOMPONENTSHAPE_SIGNATURE)\n          \n          \n            \n            \t\t\t\t\t) {", "author": "DanHeidinga", "createdAt": "2020-05-12T14:46:14Z", "path": "runtime/util/hshelp.c", "diffHunk": "@@ -3171,6 +3171,48 @@ verifyMethodsAreSame(J9VMThread * currentThread, J9JVMTIClassPair * classPair, U\n \n }\n \n+#if (JAVA_SPEC_VERSION >= 14)\n+static jvmtiError\n+verifyRecordAttributesAreSame(J9ROMClass *originalROMClass, J9ROMClass *replacementROMClass)\n+{\n+\tjvmtiError rc = JVMTI_ERROR_NONE;\n+\n+\t/* Since retranformation is not allowed to change inheritance there's no need to consider \n+\t * one class being a record and one not. */\n+\tif (J9ROMCLASS_IS_RECORD(originalROMClass) && J9ROMCLASS_IS_RECORD(replacementROMClass)) {\n+\t\tU_32 originalNumberOfRecords = getNumberOfRecordComponents(originalROMClass);\n+\t\tU_32 replacementNumberOfRecords = getNumberOfRecordComponents(replacementROMClass);\n+\n+\t\tif (originalNumberOfRecords == replacementNumberOfRecords) {\n+\t\t\tif (originalNumberOfRecords > 0) {\n+\t\t\t\tJ9ROMRecordComponentShape* originalRecordComponent = NULL;\n+\t\t\t\tJ9ROMRecordComponentShape* replacementRecordComponent = NULL;\n+\t\t\t\tU_32 i = 0;\n+\n+\t\t\t\toriginalRecordComponent = recordComponentStartDo(originalROMClass);\n+\t\t\t\treplacementRecordComponent = recordComponentStartDo(replacementROMClass);\n+\t\t\t\tfor (; i < originalNumberOfRecords; i++) {\n+\t\t\t\t\t/* verify name and signature */\n+\t\t\t\t\tif (!NAME_AND_SIG_IDENTICAL(originalRecordComponent, replacementRecordComponent, \n+\t\t\t\t\t\tJ9ROMRECORDCOMPONENTSHAPE_NAME, J9ROMRECORDCOMPONENTSHAPE_SIGNATURE)) \n+\t\t\t\t\t{", "originalCommit": "19907b298aeb902beb69e59c86038c95aacd5cd4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc5NDM4MQ==", "url": "https://github.com/eclipse-openj9/openj9/pull/9507#discussion_r423794381", "bodyText": "nitpick - is there extra blank lines here?", "author": "DanHeidinga", "createdAt": "2020-05-12T14:47:29Z", "path": "runtime/util/hshelp.c", "diffHunk": "@@ -3171,6 +3171,48 @@ verifyMethodsAreSame(J9VMThread * currentThread, J9JVMTIClassPair * classPair, U\n \n }\n \n+#if (JAVA_SPEC_VERSION >= 14)\n+static jvmtiError\n+verifyRecordAttributesAreSame(J9ROMClass *originalROMClass, J9ROMClass *replacementROMClass)\n+{\n+\tjvmtiError rc = JVMTI_ERROR_NONE;\n+\n+\t/* Since retranformation is not allowed to change inheritance there's no need to consider \n+\t * one class being a record and one not. */\n+\tif (J9ROMCLASS_IS_RECORD(originalROMClass) && J9ROMCLASS_IS_RECORD(replacementROMClass)) {\n+\t\tU_32 originalNumberOfRecords = getNumberOfRecordComponents(originalROMClass);\n+\t\tU_32 replacementNumberOfRecords = getNumberOfRecordComponents(replacementROMClass);\n+\n+\t\tif (originalNumberOfRecords == replacementNumberOfRecords) {\n+\t\t\tif (originalNumberOfRecords > 0) {\n+\t\t\t\tJ9ROMRecordComponentShape* originalRecordComponent = NULL;\n+\t\t\t\tJ9ROMRecordComponentShape* replacementRecordComponent = NULL;\n+\t\t\t\tU_32 i = 0;\n+\n+\t\t\t\toriginalRecordComponent = recordComponentStartDo(originalROMClass);\n+\t\t\t\treplacementRecordComponent = recordComponentStartDo(replacementROMClass);\n+\t\t\t\tfor (; i < originalNumberOfRecords; i++) {\n+\t\t\t\t\t/* verify name and signature */\n+\t\t\t\t\tif (!NAME_AND_SIG_IDENTICAL(originalRecordComponent, replacementRecordComponent, \n+\t\t\t\t\t\tJ9ROMRECORDCOMPONENTSHAPE_NAME, J9ROMRECORDCOMPONENTSHAPE_SIGNATURE)) \n+\t\t\t\t\t{\n+\t\t\t\t\t\trc = JVMTI_ERROR_UNSUPPORTED_REDEFINITION_CLASS_ATTRIBUTE_CHANGED;\n+\t\t\t\t\t\tgoto done;\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\n+", "originalCommit": "19907b298aeb902beb69e59c86038c95aacd5cd4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "519a21990b53ec8c108b83a36d145266dd6be8e5", "url": "https://github.com/eclipse-openj9/openj9/commit/519a21990b53ec8c108b83a36d145266dd6be8e5", "message": "Review\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-05-12T18:38:18Z", "type": "forcePushed"}, {"oid": "381485d6319dcf8e72c94cc0eaf360bb5f724910", "url": "https://github.com/eclipse-openj9/openj9/commit/381485d6319dcf8e72c94cc0eaf360bb5f724910", "message": "Review\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-05-12T18:41:21Z", "type": "forcePushed"}, {"oid": "d5f45697339c3281516a72a7dc06e11c50d68411", "url": "https://github.com/eclipse-openj9/openj9/commit/d5f45697339c3281516a72a7dc06e11c50d68411", "message": "Review\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-05-12T19:34:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAwODY3Mg==", "url": "https://github.com/eclipse-openj9/openj9/pull/9507#discussion_r424008672", "bodyText": "nestmates was added in java 11.  This can be #ifdef'd on that version\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            #if defined(J9VM_OPT_VALHALLA_NESTMATES) || (JAVA_SPEC_VERSION >= 15)\n          \n          \n            \n            #if (JAVA_SPEC_VERSION >= 11)", "author": "DanHeidinga", "createdAt": "2020-05-12T20:19:31Z", "path": "runtime/jvmti/jvmtiGeneral.c", "diffHunk": "@@ -65,9 +65,9 @@ static const J9JvmtiErrorMapping errorMap[] = {\n \t{ \"JVMTI_ERROR_NAMES_DONT_MATCH\" , 69 },\n \t{ \"JVMTI_ERROR_UNSUPPORTED_REDEFINITION_CLASS_MODIFIERS_CHANGED\" , 70 },\n \t{ \"JVMTI_ERROR_UNSUPPORTED_REDEFINITION_METHOD_MODIFIERS_CHANGED\" , 71 },\n-#if defined(J9VM_OPT_VALHALLA_NESTMATES)\n+#if defined(J9VM_OPT_VALHALLA_NESTMATES) || (JAVA_SPEC_VERSION >= 15)", "originalCommit": "d5f45697339c3281516a72a7dc06e11c50d68411", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c9b8a1a35cd80eaf0e619d70a8aa9d232ee04a1a", "url": "https://github.com/eclipse-openj9/openj9/commit/c9b8a1a35cd80eaf0e619d70a8aa9d232ee04a1a", "message": "Review\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-05-12T20:50:17Z", "type": "forcePushed"}, {"oid": "6658adb204e0786dc70795d4514e45e8a764691d", "url": "https://github.com/eclipse-openj9/openj9/commit/6658adb204e0786dc70795d4514e45e8a764691d", "message": "Java 14+: class transformation with records\n\nThe Java Instrumentation API does not allow record attributes to be changed.\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-05-12T22:31:17Z", "type": "commit"}, {"oid": "6658adb204e0786dc70795d4514e45e8a764691d", "url": "https://github.com/eclipse-openj9/openj9/commit/6658adb204e0786dc70795d4514e45e8a764691d", "message": "Java 14+: class transformation with records\n\nThe Java Instrumentation API does not allow record attributes to be changed.\n\nSigned-off-by: Theresa Mammarella <Theresa.T.Mammarella@ibm.com>", "committedDate": "2020-05-12T22:31:17Z", "type": "forcePushed"}]}